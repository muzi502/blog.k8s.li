<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.2.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="从去年十一月底到现在一直在做在  VMware ESXi  上部署 超融合集群 的产品化工具，也是在最近完成了前后端的联调，五一节后开始进入测试阶段。为了测试不同的 VMware ESXi 版本和我们产品的兼容性，需要很频繁地在一些物理服务器（如戴尔、联想、惠普、浪潮、超微等）上安装 VMware ESXi OS。 之前一直都是登录 IPMI 管理页面，挂载远程的 ISO 文件手动安装。安装完成之">
<meta property="og:type" content="blog">
<meta property="og:title" content="使用 Redfish 自动化安装 ESXi OS">
<meta property="og:url" content="https://blog.k8s.li/redfish-esxi-os-installer.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="从去年十一月底到现在一直在做在  VMware ESXi  上部署 超融合集群 的产品化工具，也是在最近完成了前后端的联调，五一节后开始进入测试阶段。为了测试不同的 VMware ESXi 版本和我们产品的兼容性，需要很频繁地在一些物理服务器（如戴尔、联想、惠普、浪潮、超微等）上安装 VMware ESXi OS。 之前一直都是登录 IPMI 管理页面，挂载远程的 ISO 文件手动安装。安装完成之">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-01.png">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-06.png">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-04.png">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-05.png">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-02.png">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-03.png">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-esxi-os-installer-07.png">
<meta property="article:published_time" content="2022-04-29T16:00:00.000Z">
<meta property="article:modified_time" content="2022-04-29T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="ESXi">
<meta property="article:tag" content="Redfish">
<meta property="article:tag" content="Dell 服务器">
<meta property="article:tag" content="HPE 服务器">
<meta property="article:tag" content="Lenovo 服务器">
<meta property="article:tag" content="裸金属服务器">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-01.png">


<link rel="canonical" href="https://blog.k8s.li/redfish-esxi-os-installer.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/redfish-esxi-os-installer.html","path":"redfish-esxi-os-installer.html","title":"使用 Redfish 自动化安装 ESXi OS"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>使用 Redfish 自动化安装 ESXi OS | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">需求分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E8%B0%83%E7%A0%94"><span class="nav-number">2.</span> <span class="nav-text">技术调研</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PXE"><span class="nav-number">2.1.</span> <span class="nav-text">PXE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPMI-x2F-Redfish"><span class="nav-number">2.2.</span> <span class="nav-text">IPMI&#x2F;Redfish</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">安装流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%A1%AC%E4%BB%B6%E4%BF%A1%E6%81%AF"><span class="nav-number">3.1.</span> <span class="nav-text">获取硬件信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A1%AB%E5%86%99%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.2.</span> <span class="nav-text">填写配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90-inventory-%E6%96%87%E4%BB%B6"><span class="nav-number">3.3.</span> <span class="nav-text">生成 inventory 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A3%80%E6%9F%A5-Redfish-%E7%99%BB%E5%BD%95%E6%98%AF%E5%90%A6%E6%AD%A3%E5%B8%B8"><span class="nav-number">3.4.</span> <span class="nav-text">检查 Redfish 登录是否正常</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90-kickstart-%E6%96%87%E4%BB%B6"><span class="nav-number">3.5.</span> <span class="nav-text">生成 kickstart 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E6%96%B0%E6%9E%84%E5%BB%BA-ESXi-ISO"><span class="nav-number">3.6.</span> <span class="nav-text">重新构建 ESXi ISO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-redfish-%E5%BC%B9%E5%87%BA%E5%B7%B2%E6%9C%89%E7%9A%84-Virtual-Media"><span class="nav-number">3.7.</span> <span class="nav-text">通过 redfish 弹出已有的 Virtual Media</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-Redfish-%E6%8F%92%E5%85%A5-ISO"><span class="nav-number">3.8.</span> <span class="nav-text">通过 Redfish 插入 ISO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E5%90%AF%E5%8A%A8%E9%A1%B9%E4%B8%BA%E8%99%9A%E6%8B%9F%E5%85%89%E9%A9%B1"><span class="nav-number">3.9.</span> <span class="nav-text">设置启动项为虚拟光驱</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E5%90%AF%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">3.10.</span> <span class="nav-text">重启服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AD%89%E5%BE%85-ESXi-OS-%E5%AE%89%E8%A3%85%E5%AE%8C%E6%88%90"><span class="nav-number">3.11.</span> <span class="nav-text">等待 ESXi OS 安装完成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Makefile-%E5%B0%81%E8%A3%85"><span class="nav-number">4.</span> <span class="nav-text">Makefile 封装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#vars"><span class="nav-number">4.1.</span> <span class="nav-text">vars</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#target"><span class="nav-number">4.2.</span> <span class="nav-text">target</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jenkins-Job"><span class="nav-number">5.</span> <span class="nav-text">Jenkins Job</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Jenkinsfile"><span class="nav-number">5.1.</span> <span class="nav-text">Jenkinsfile</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">6.</span> <span class="nav-text">常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">6.1.</span> <span class="nav-text">硬件信息收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%82%E8%BD%BD-ISO-%E4%B9%8B%E5%89%8D%E5%85%88%E7%A1%AE%E4%BF%9D-ISO-%E5%AD%98%E5%9C%A8"><span class="nav-number">6.2.</span> <span class="nav-text">挂载 ISO 之前先确保 ISO 存在</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E7%8B%AC%E6%9E%84%E5%BB%BA-Kickstart-ISO"><span class="nav-number">6.3.</span> <span class="nav-text">单独构建 Kickstart ISO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-http-%E6%96%B9%E5%BC%8F%E8%AF%BB%E5%8F%96-kickstart"><span class="nav-number">6.4.</span> <span class="nav-text">通过 http 方式读取 kickstart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%AF%E6%8C%81%E5%85%B6%E4%BB%96-OS-%E7%9A%84%E5%AE%89%E8%A3%85"><span class="nav-number">6.5.</span> <span class="nav-text">支持其他 OS 的安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">7.</span> <span class="nav-text">参考</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redfish-%E7%9B%B8%E5%85%B3"><span class="nav-number">7.1.</span> <span class="nav-text">Redfish 相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VMware-ESXi-%E7%9B%B8%E5%85%B3"><span class="nav-number">7.2.</span> <span class="nav-text">VMware ESXi 相关</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">116</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">151</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail → mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/redfish-esxi-os-installer.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="使用 Redfish 自动化安装 ESXi OS | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          使用 Redfish 自动化安装 ESXi OS
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-30 2022-04-30T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2022-04-30T00:00:00+08:00">2022-04-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/redfish-esxi-os-installer.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="redfish-esxi-os-installer.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>26k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>24 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>从去年十一月底到现在一直在做在  <a target="_blank" rel="noopener" href="https://www.vmware.com/products/esxi-and-esx.html">VMware ESXi</a>  上部署 <a target="_blank" rel="noopener" href="https://www.smartx.com/smartx-hci/">超融合集群</a> 的产品化工具，也是在最近完成了前后端的联调，五一节后开始进入测试阶段。为了测试不同的 VMware ESXi 版本和我们产品的兼容性，需要很频繁地在一些物理服务器（如戴尔、联想、惠普、浪潮、超微等）上安装 VMware ESXi OS。</p>
<p>之前一直都是登录 IPMI 管理页面，挂载远程的 ISO 文件手动安装。安装完成之后还需要配置 ESXi 管理网络的 IP 地址。整体的安装流程比较繁琐，而且物理服务器每次重启和开机都十分耗时，对经常要安装 ESXi 的 QE 小伙伴来讲十分痛苦。</p>
<p>为了后续测试起来爽快一点，不用再为安装 ESXi OS 而烦恼，于是就基于 Redfish 快速实现了一套自动化安装 ESXi OS 的工具 <a target="_blank" rel="noopener" href="https://github.com/muzi502/redfish-esxi-os-installer">redfish-esxi-os-installer</a>。通过它我们内部的戴尔、联想、HPE 服务器安装 ESXi OS 只需要填写一个配置文件并选择需要安装的 ESXi ISO，运行一下 Jenkins Job 等待十几分钟就能自动安装好。原本需要一个多小时的工作量，现在只需要运行一下 Jenkins Job 帮助我们自动安装好 ESXi OS 啦 😂，真是爽歪歪。</p>
<p>五一假期刚开始，正好有时间抽空整理一下最近学到的东西，和大家分享一下这套自动化安装 ESXi OS 工具。</p>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><ul>
<li>支持服务器：联想&#x2F;戴尔&#x2F;HPE（超微和浪潮优先级不高，暂时不支持）；</li>
<li>一键自动化安装&#x2F;重装 ESXi OS，最好能配置好 Jenkins Job；</li>
<li>指定 ESXi OS 安装的物理盘：由于物理服务器有多块硬盘，ESXi OS 需要安装在指定的硬盘上。一般为 SATA DOM 盘。比如戴尔的 <a target="_blank" rel="noopener" href="https://downloads.dell.com/manuals/all-products/esuprt_solutions_int/esuprt_solutions_int_solutions_resources/servers-solution-resources_white-papers10_en-us.pdf">DELLBOSS</a>，联想的 <a target="_blank" rel="noopener" href="https://lenovopress.com/lp0769.pdf">ThinkSystem M.2</a> 。这类 DOM 盘的好处就在于不占用多余的 HBA 卡或 PCI 插槽，有点类似于家用台式机主板上的 M.2 硬盘位插槽；</li>
<li>指定网卡并配置静态 IP 地址：由于我们的物理服务器上有多块网卡，且不同的网卡有不同的网络用途，因此需要指定某块物理网卡为 ESXi 管理网络所使用的网卡。</li>
<li>为 ESXi 管理网路配置静态 IP、子网掩码、网关，便于部署好之后直接就能通过该 IP 访问 ESXi。而不是通过 DHCP 分配一个 IP，然后再登录 IPMI 管理页面手动查看 ESXi 的 IP；</li>
</ul>
<h2 id="技术调研"><a href="#技术调研" class="headerlink" title="技术调研"></a>技术调研</h2><p>目前市面上主流的裸金属服务器自动化安装 OS 的工具有 PXE 和 IPMI&#x2F;Redfish 两种。</p>
<h3 id="PXE"><a href="#PXE" class="headerlink" title="PXE"></a>PXE</h3><p>虽然内部也有 PXE 服务可用，但重启服务器和设置服务器的引导项为 PXE 启动仍然需要手动登录 IPMI 管理页面进行操作，无法做到自动重启和自动重装，仍有一定的工作量。而且 PXE 安装 OS 无法解决为每台服务器配置各自的安装盘和管理网络网卡及静态 IP 地址的问题，遂放弃。</p>
<h3 id="IPMI-x2F-Redfish"><a href="#IPMI-x2F-Redfish" class="headerlink" title="IPMI&#x2F;Redfish"></a>IPMI&#x2F;Redfish</h3><p><a target="_blank" rel="noopener" href="https://www.dmtf.org/standards/redfish">Redfish</a> 的概念和原理什么的就懒得介绍了，下面就直接剽窃一下官方的文档吧 😅：</p>
<blockquote>
<p><code>DMTF</code> 的 <code>Redfish®</code> 是一个标准 <code>API</code>，旨在为融合、混合 <code>IT</code> 和软件定义数据中心（<code>SDDC</code>）提供简单和安全管理。</p>
<p>在 <code>Redfish</code> 出现之前，现代数据中心环境中缺乏互操作管理标准。随着机构越来越青睐于大规模的解决方案，传统标准不足以成功管理大量简单的多节点服务器或混合基础设施。<code>IPMI</code> 是一种较早的带外管理标准，仅限于“最小公共集”命令集（例如，开机&#x2F;关机&#x2F;重启、温度值、文本控制台等），由于供应商扩展在所有平台上并不常见，导致了客户常用的功能集减少。许多用户开发了自己的紧密集成工具，但是也不得不依赖带内管理软件。</p>
<p>而对于企业级用户来说，设备都是上千台，其需要统一的管理界面，就要对接不同供应商的 <code>API</code>。当基本 <code>IPMI</code> 功能已经不太好满足大规模 <code>Scale-out</code> 环境时，如何以更便捷的方式调用服务器高级管理功能就是一个新的需求。</p>
<p>为了寻求一个基于广泛使用的工具来加快发展的现代接口，现如今，客户需要一个使用互联网和 <code>web</code> 服务环境中常见的协议、结构和安全模型定义的 <code>API</code>。</p>
<p><code>Redfish</code> 可扩展平台管理 <code>API</code>（<code>The Redfish Scalable Platforms Management API</code>）是一种新的规范，其使用 <code>RESTful</code> 接口语义来访问定义在模型格式中的数据，用于执行带外系统管理 （<code>out of band systems management</code>）。其适用于大规模的服务器，从独立的服务器到机架式和刀片式的服务器环境，而且也同样适用于大规模的云环境。</p>
<p><code>Redfish</code> 的第 <code>1</code> 版侧重于服务器，为 <code>IPMI-over-LAN</code> 提供了一个安全、多节点的替代品。随后的 <code>Redfish</code> 版本增加了对网络接口(例如 <code>NIC</code>、<code>CNA</code> 和 <code>FC HBA</code>)、<code>PCIe</code> 交换、本地存储、<code>NVDIMM</code>、多功能适配器和可组合性以及固件更新服务、软件更新推送方法和安全特权映射的管理。此外，<code>Redfish</code> 主机接口规范允许在操作系统上运行应用程序和工具，包括在启动前（固件）阶段-与 <code>Redfish</code> 管理服务沟通。</p>
<p>在定义 <code>Redfish</code> 标准时，协议与数据模型可分开并允许独立地修改。以模式为基础的数据模型是可伸缩和可扩展的，并且随着行业的发展，它将越来越具有人类可读性定义。</p>
</blockquote>
<p>通过 Redfish 我们可以对服务器进行挂载&#x2F;卸载 ISO、设置 BIOS 启动项、开机&#x2F;关机&#x2F;重启等操作。只需要使用一些特定的 ansible 模块，将它们缝合起来就能将整个流程跑通。</p>
<p>内部的服务器戴尔、联想、HPE 的较多，这三家厂商对 Redfish 支持的也比较完善。于是这个 ESXi OS 自动化安装工具 <a target="_blank" rel="noopener" href="https://github.com/muzi502/redfish-esxi-os-installer">redfish-esxi-os-installer</a> 就基于 Redfish 并结合 Jenkins 实现了一套自动化安装 ESXi OS 的方案，下面就详细介绍一下这套方案的安装流程和技术实现细节。</p>
<h2 id="安装流程"><a href="#安装流程" class="headerlink" title="安装流程"></a>安装流程</h2><ol>
<li>获取硬盘和网卡硬件设备信息</li>
<li>根据硬件设备信息填写配置文件</li>
<li>根据配置文件生成 ansible inventory 文件</li>
<li>根据配置文件为每台主机生成 kickstart 文件</li>
<li>将生成好的 kickstart 文件打包放到 ESXi ISO 当中</li>
<li>为每台主机重新构建一个 ESXi ISO 文件</li>
<li>通过 redfish 弹出已有的 ISO 镜像</li>
<li>通过 redfish 插入远程的 ISO 镜像</li>
<li>设置 one-boot 启动引导项为虚拟光驱</li>
<li>重启服务器到 ESXI ISO</li>
<li>ESXi installer 调用 Kickstart 脚本安装 OS</li>
<li>等待 ESXi OS 安装完成</li>
</ol>
<h3 id="获取硬件信息"><a href="#获取硬件信息" class="headerlink" title="获取硬件信息"></a>获取硬件信息</h3><p>该步骤主要是获取 ESXi OS 所要安装的硬盘和管理网络网卡设备信息。</p>
<h4 id="获取硬盘型号-x2F-序列号"><a href="#获取硬盘型号-x2F-序列号" class="headerlink" title="获取硬盘型号&#x2F;序列号"></a>获取硬盘型号&#x2F;序列号</h4><p>要指定 ESXi OS 安装的硬盘，可以通过硬盘型号或序列号的方式。如果当前服务器已经安装了 ESXi，登录到 ESXi 则可以查看到所安装硬盘的型号：</p>
<ul>
<li>比如这台戴尔的服务器 ESXi OS 安装的硬盘型号是 <code>DELLBOSS VD</code>（注意中间的空格不要省略）；</li>
</ul>
<p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-01.png" alt="img"></p>
<ul>
<li>比如这台联想服务器的 SATA DOM 盘型号为 <code>ThinkSystem M.2</code></li>
</ul>
<p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-06.png" alt="img"></p>
<ul>
<li>如果安装的是 Linux，可以通过 <a target="_blank" rel="noopener" href="https://www.smartmontools.org/">smartctl</a> 工具查看所要安装硬盘的型号即 <code>Device Model</code>，比如：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@esxi-debian-nas ~
╰─<span class="token comment"># smartctl -x /dev/sdb</span>
smartctl <span class="token number">6.6</span> <span class="token number">2017</span>-11-05 r4594 <span class="token punctuation">[</span>x86_64-linux-4.19.0-18-amd64<span class="token punctuation">]</span> <span class="token punctuation">(</span>local build<span class="token punctuation">)</span>
Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2002</span>-17, Bruce Allen, Christian Franke, www.smartmontools.org

<span class="token operator">==</span><span class="token operator">=</span> START OF INFORMATION SECTION <span class="token operator">==</span><span class="token operator">=</span>
Device Model:     HGST HUH721212ALE604
Serial Number:    5PJAMUHD
LU WWN Device Id: <span class="token number">5</span> 000cca 291e10521<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-04.png" alt="img"></p>
<p>如果有多块型号相同的硬盘，ESXi 会默认选择第一块，如果要指定某一块硬盘则使用 WWN 号的方式，获取 WWN ID 的命令如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@esxi-debian-nas ~
╰─<span class="token comment"># smartctl -x /dev/sdb | sed -n "s/LU WWN Device Id:/naa./p" | tr -d ' '</span>
naa.5000cca291e10521<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="获取网卡设备名-x2F-MAC-地址"><a href="#获取网卡设备名-x2F-MAC-地址" class="headerlink" title="获取网卡设备名&#x2F;MAC 地址"></a>获取网卡设备名&#x2F;MAC 地址</h4><ul>
<li>如果当前物理服务器已经安装了 ESXi，则登录 ESXi 主机查看 ESXi 默认的管理网络 vSwitch0 虚拟交换机所连接的物理网卡设备名，比如这台服务器网卡设备名为 <code>vmnic4</code></li>
</ul>
<p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-05.png" alt="img"></p>
<ul>
<li>另一种方式则是登录服务器的 IPMI 管理页面，查看对应网卡的 MAC 地址</li>
</ul>
<p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-02.png" alt="img"></p>
<h3 id="填写配置文件"><a href="#填写配置文件" class="headerlink" title="填写配置文件"></a>填写配置文件</h3><p>通过以上方式确定好 ESXi OS 所安装的硬盘型号或序列号，以及 ESXi 默认管理网络 vSwitch0 所关联的物理网卡设备名或 MAC 地址之后，我们就将这些配置参数填入到该配置文件当中。后面的工具会使用该配置为每台机器生成不同的 kickstart 文件，在 kickstart 文件中指定 ESXi OS 安装的硬盘，ESXi 管理网络所使用的网卡，以及设置静态 IP、子网掩码、网关、主机名等参数。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/config-example.yaml">config.yaml</a></li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">hosts</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">ipmi</span><span class="token punctuation">:</span>
    <span class="token key atrule">vendor</span><span class="token punctuation">:</span> lenovo                  <span class="token comment"># 服务器厂商名 [dell, lenovo, hpe]</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> 10.172.70.186          <span class="token comment"># IPMI IP 地址</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> username              <span class="token comment"># IPMI 用户名</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> password              <span class="token comment"># IPMI 密码</span>
  <span class="token key atrule">esxi</span><span class="token punctuation">:</span>
    <span class="token key atrule">esxi_disk</span><span class="token punctuation">:</span> ThinkSystem M.2      <span class="token comment"># ESXi OS 所安装硬盘的型号或序列号</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> password              <span class="token comment"># ESXi 的 root 用户密码</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> 10.172.69.86           <span class="token comment"># ESXi 管理网络 IP 地址</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 10.172.64.1            <span class="token comment"># ESXi 管理网络网关</span>
    <span class="token key atrule">netmask</span><span class="token punctuation">:</span> 255.255.240.0          <span class="token comment"># ESXi 管理网络子网掩码</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> esxi<span class="token punctuation">-</span>69<span class="token punctuation">-</span><span class="token number">86</span>            <span class="token comment"># ESXi 主机名（可选）</span>
    <span class="token key atrule">mgtnic</span><span class="token punctuation">:</span> vmnic4                  <span class="token comment"># ESXi 管理网络网卡名称或MAC 地址</span>

<span class="token punctuation">-</span> <span class="token key atrule">ipmi</span><span class="token punctuation">:</span>
    <span class="token key atrule">vendor</span><span class="token punctuation">:</span> dell
    <span class="token key atrule">address</span><span class="token punctuation">:</span> 10.172.18.191
    <span class="token key atrule">username</span><span class="token punctuation">:</span> username
    <span class="token key atrule">password</span><span class="token punctuation">:</span> password
  <span class="token key atrule">esxi</span><span class="token punctuation">:</span>
    <span class="token key atrule">esxi_disk</span><span class="token punctuation">:</span> DELLBOSS VD
    <span class="token key atrule">password</span><span class="token punctuation">:</span> password
    <span class="token key atrule">address</span><span class="token punctuation">:</span> 10.172.18.95
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 10.172.16.1
    <span class="token key atrule">netmask</span><span class="token punctuation">:</span> 255.255.240.0
    <span class="token key atrule">mgtnic</span><span class="token punctuation">:</span> B4<span class="token punctuation">:</span>96<span class="token punctuation">:</span>91<span class="token punctuation">:</span>A7<span class="token punctuation">:</span>3F<span class="token punctuation">:</span>D6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="生成-inventory-文件"><a href="#生成-inventory-文件" class="headerlink" title="生成 inventory 文件"></a>生成 inventory 文件</h3><p>在 <a target="_blank" rel="noopener" href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/tools.sh">tools.sh</a> 脚本中通过 <a target="_blank" rel="noopener" href="https://github.com/mikefarah/yq">yq</a> 命令行工具解析 <code>config.yaml</code> 配置文件，得到每台主机的配置信息，并根据该信息生成一个 ansible 的 inventory 文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">rendder_host_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token variable">$1</span>
    <span class="token assign-left variable">vendor</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].ipmi.vendor"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">os_disk</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.esxi_disk"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>"</span>
    <span class="token assign-left variable">esxi_mgtnic</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.mgtnic"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">esxi_address</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.address"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">esxi_gateway</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.gateway"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">esxi_netmask</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.netmask"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">esxi_password</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.password"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">ipmi_address</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].ipmi.address"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">ipmi_username</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].ipmi.username"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">ipmi_password</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].ipmi.password"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">esxi_hostname</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.hostname"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span> /dev/null <span class="token operator">||</span> <span class="token boolean">true</span><span class="token variable">)</span></span>"</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">function</span> <span class="token function-name function">gen_inventory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> <span class="token variable">$&#123;INVENTORY&#125;</span></span>
_hpe_

_dell_

_lenovo_

[all:children]
hpe
dell
lenovo
EOF</span>

    <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">0</span> `expr $<span class="token punctuation">&#123;</span>nums<span class="token punctuation">&#125;</span> - <span class="token number">1</span>`<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
        rendder_host_info <span class="token variable">$&#123;i&#125;</span>
        <span class="token assign-left variable">host_info</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;ipmi_address&#125;</span> username=<span class="token variable">$&#123;ipmi_username&#125;</span> password=<span class="token variable">$&#123;ipmi_password&#125;</span> esxi_address=<span class="token variable">$&#123;esxi_address&#125;</span> esxi_password=<span class="token variable">$&#123;esxi_password&#125;</span>"</span>
        <span class="token function">sed</span> -i <span class="token string">"/_<span class="token variable">$&#123;vendor&#125;</span>_/a <span class="token variable">$&#123;host_info&#125;</span>"</span> <span class="token variable">$&#123;INVENTORY&#125;</span>
    <span class="token keyword">done</span>
    <span class="token function">sed</span> -i <span class="token string">"s#^_dell_#[dell]#g;s#^_lenovo_#[lenovo]#g;s#_hpe_#[hpe]#g"</span> <span class="token variable">$&#123;INVENTORY&#125;</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"gen inventory success"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>生成后的 inventory 文件内容如下，根据不同的厂商名称进行分组</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">hpe</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">10.172.18.191 username</span><span class="token punctuation">=</span><span class="token value attr-value">username password=password esxi_address=10.172.18.95 esxi_password=password</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">dell</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">10.172.18.192 username</span><span class="token punctuation">=</span><span class="token value attr-value">username password=password esxi_address=10.172.18.96 esxi_password=password</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">lenovo</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">10.172.18.193 username</span><span class="token punctuation">=</span><span class="token value attr-value">username password=password esxi_address=10.172.18.97 esxi_password=password</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">all:children</span><span class="token punctuation">]</span></span>
hpe
dell
lenovo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="检查-Redfish-登录是否正常"><a href="#检查-Redfish-登录是否正常" class="headerlink" title="检查 Redfish 登录是否正常"></a>检查 Redfish 登录是否正常</h3><p>通过 Redfish 的 GetSystemInventory 命令获取服务器的 inventory 清单来检查登录 Redfish 是否正常，用户名或密码是否正确。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Getting system inventory
  <span class="token key atrule">community.general.redfish_info</span><span class="token punctuation">:</span>
    <span class="token key atrule">category</span><span class="token punctuation">:</span> Systems
    <span class="token key atrule">command</span><span class="token punctuation">:</span> GetSystemInventory
    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="生成-kickstart-文件"><a href="#生成-kickstart-文件" class="headerlink" title="生成 kickstart 文件"></a>生成 kickstart 文件</h3><p>在 <a href="">tools.sh</a> 同样使用 yq 命令行工具渲染配置文件，得到每台主机的配置信息，为每台主机生成一个特定的 kickstart 文件。</p>
<p>在 kickstart 文件中我们我们可以通过 <code>install --overwritevmfs --firstdisk=&quot;$&#123;ESXI_DISK&#125;&quot;</code> 配置 ESXi OS 安装在哪一块硬盘上；</p>
<p>通过 <code>network --bootproto=static</code> 为 ESXi 管理网络配置静态 IP、子网掩码、网关、主机名、物理网卡等参数。需要注意的是，如果使用 MAC 地址指定网卡，MAC 地址必须为大写，因此需要使用 tr 进行了一下大小写转换；</p>
<p>通过 <code>clearpart --alldrives --overwritevmfs</code> 可以清除所有硬盘上的分区，我们安装时一般是将它们全部清理掉，方便进行测试；</p>
<p>最后再开启 SSH 服务并开启 sshServer 的防火墙，方便后续测试使用；</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">gen_iso_ks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">ISO_KS</span><span class="token operator">=</span><span class="token variable">$1</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">ESXI_DISK</span><span class="token operator">=</span><span class="token variable">$&#123;os_disk&#125;</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">IP_ADDRESS</span><span class="token operator">=</span><span class="token variable">$&#123;esxi_address&#125;</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">NETMASK</span><span class="token operator">=</span><span class="token variable">$&#123;esxi_netmask&#125;</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">GATEWAY</span><span class="token operator">=</span><span class="token variable">$&#123;esxi_gateway&#125;</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">DNS_SERVER</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;GATEWAY&#125;</span>"</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">PASSWORD</span><span class="token operator">=</span><span class="token variable">$&#123;esxi_password&#125;</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable"><span class="token environment constant">HOSTNAME</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $<span class="token punctuation">&#123;</span>esxi_hostname<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">"s/null/esxi-<span class="token variable">$&#123;esxi_address<span class="token operator">/</span><span class="token operator">/</span>.<span class="token operator">/</span>-&#125;</span>/"</span><span class="token variable">)</span></span>"</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">MGTNIC</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $<span class="token punctuation">&#123;</span>esxi_mgtnic<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">'[a-z]'</span> <span class="token string">'[A-Z]'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/VMNIC/vmnic/g'</span><span class="token variable">)</span></span>
    <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> <span class="token variable">$&#123;ISO_KS&#125;</span></span>
vmaccepteula

# Set the root password for the DCUI and Tech Support Mode
rootpw <span class="token variable">$&#123;PASSWORD&#125;</span>

# Set the keyboard
keyboard 'US Default'

# wipe exisiting VMFS store # CAREFUL!
clearpart --alldrives --overwritevmfs

# Install on the first local disk available on machine
install --overwritevmfs --firstdisk="<span class="token variable">$&#123;ESXI_DISK&#125;</span>"

# Set the network to DHCP on the first network adapter
network --bootproto=static --hostname=<span class="token variable">$&#123;<span class="token environment constant">HOSTNAME</span>&#125;</span> --ip=<span class="token variable">$&#123;IP_ADDRESS&#125;</span> --gateway=<span class="token variable">$&#123;GATEWAY&#125;</span> --nameserver=<span class="token variable">$&#123;DNS_SERVER&#125;</span> --netmask=<span class="token variable">$&#123;NETMASK&#125;</span> --device="<span class="token variable">$&#123;MGTNIC&#125;</span>"

reboot

%firstboot --interpreter=busybox

# Enable SSH
vim-cmd hostsvc/enable_ssh
vim-cmd hostsvc/start_ssh
esxcli network firewall ruleset set --enabled=false --ruleset-id=sshServer
EOF</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="重新构建-ESXi-ISO"><a href="#重新构建-ESXi-ISO" class="headerlink" title="重新构建 ESXi ISO"></a>重新构建 ESXi ISO</h3><p>这一步的操作主要是修改 ESXi ISO 的启动项配置，配置 ks 文件的路径，主要是修改 ISO 文件里的 <code> boot.cfg</code> 和 <code>efi/boot/boot.cfg</code> 文件。在启动参数中加入 <code>ks=cdrom:/KS.CFG</code> 用于指定 ESXi OS 安装通过读取 kickstart 脚本的方式来完成。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> -i -e <span class="token string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> boot.cfg
<span class="token function">sed</span> -i -e <span class="token string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> efi/boot/boot.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>另外在 VMware 的 KB <a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/81166">Boot option to configure the size of ESXi system partitions (81166)</a> 中，提到过可以设置 <code>systemMediaSize=small</code> 来调整 VMFS-L 分区的大小。ESXi 7.0 版本之后会默认创建一个 VMFS-L 分区，如果 SATA DOM 盘比较小的话比如只有 128G，建议设置此参数。不然可能会导致安装完 ESXi OS 之后磁盘剩余的空间都被 VMFS-L 分区给占用，导致没有一个本地的数据存储可以使用。</p>
<p>修改好 ESXi 的启动配置之后，我们再使用 genisoimage 命令重新构建一个 ESXi ISO 文件，将构建好的 ISO 文件放到一个 http 文件服务的目录下，如 nginx 的 <code>/usr/share/nginx/html/iso</code>。后面将会通过 http 的方式将 ISO 挂载到服务器的虚拟光驱上。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">rebuild_esxi_iso</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">dest_iso_mount_dir</span><span class="token operator">=</span><span class="token variable">$1</span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">dest_iso_path</span><span class="token operator">=</span><span class="token variable">$2</span>
    <span class="token function">pushd</span> <span class="token variable">$&#123;dest_iso_mount_dir&#125;</span> <span class="token operator">></span> /dev/null
    <span class="token function">sed</span> -i -e <span class="token string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> boot.cfg
    <span class="token function">sed</span> -i -e <span class="token string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> efi/boot/boot.cfg
    genisoimage -J <span class="token punctuation">\</span>
                -R  <span class="token punctuation">\</span>
                -o <span class="token variable">$&#123;dest_iso_path&#125;</span> <span class="token punctuation">\</span>
                -relaxed-filenames <span class="token punctuation">\</span>
                -b isolinux.bin <span class="token punctuation">\</span>
                -c boot.cat <span class="token punctuation">\</span>
                -no-emul-boot <span class="token punctuation">\</span>
                -boot-load-size <span class="token number">4</span> <span class="token punctuation">\</span>
                -boot-info-table <span class="token punctuation">\</span>
                -eltorito-alt-boot <span class="token punctuation">\</span>
                -eltorito-boot efiboot.img <span class="token punctuation">\</span>
                -quiet --no-emul-boot <span class="token punctuation">\</span>
                <span class="token builtin class-name">.</span> <span class="token operator">></span> /dev/null
  <span class="token function">popd</span> <span class="token operator">></span> /dev/null
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>重新构建好 ESXi ISO 之后的 nginx 目录结构如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># tree /usr/share/nginx/html/iso/</span>
/usr/share/nginx/html/iso/
├── redfish
│   ├── <span class="token number">172.20</span>.18.191
│   │   └── VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="token comment"># 重新构建的 ISO</span>
│   ├── <span class="token number">172.20</span>.18.192
│   │   └── VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="token comment"># 重新构建的 ISO</span>
│   ├── <span class="token number">172.20</span>.18.193
│   │   └── VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="token comment"># 重新构建的 ISO</span>
│   └── <span class="token number">172.20</span>.70.186
│       └── VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="token comment"># 重新构建的 ISO</span>
├── VMware-VMvisor-Installer-6.7.0.update03-14320388.x86_64.iso <span class="token comment"># 原 ISO</span>
├── VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso         <span class="token comment"># 原 ISO</span>
└── VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso         <span class="token comment"># 原 ISO</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="通过-redfish-弹出已有的-Virtual-Media"><a href="#通过-redfish-弹出已有的-Virtual-Media" class="headerlink" title="通过 redfish 弹出已有的 Virtual Media"></a>通过 redfish 弹出已有的 Virtual Media</h3><p>redfish 插入&#x2F;弹出 ISO 操作有现成可用的 ansible 模块可以使用，不必重复造轮子。不同的服务器厂商调用的模块可能会有所不同，不过参数基本上是相同的。</p>
<p>如果当前服务器上已经挂载了一些其他的 ISO，要将他们全部弹出才行，不然在挂载 ISO 的时候会失败退出，并且也能避免多个 ISO 重启启动的时候引起冲突启动到另一个 ISO 中。</p>
<ul>
<li>联想服务器的 VirtualMediaEject 命令可以弹出所有的 ISO</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Lenovo <span class="token punctuation">|</span> Eject all Virtual Media
  <span class="token key atrule">community.general.xcc_redfish_command</span><span class="token punctuation">:</span>
    <span class="token key atrule">category</span><span class="token punctuation">:</span> Manager
    <span class="token key atrule">command</span><span class="token punctuation">:</span> VirtualMediaEject
    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>
    <span class="token key atrule">resource_id</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> inventory_hostname in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso
  <span class="token punctuation">-</span> umount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>戴尔和 HPE 服务器在弹出 ISO 的时候需要先知道原有 ISO 的 URL。因此先通过 <code>GetVirtualMedia</code> 命令获取到一个 ISO 的 URL 列表，然后再根据这个列表一一弹出。</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get virtual media details
  <span class="token key atrule">community.general.redfish_info</span><span class="token punctuation">:</span>
    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>
    <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"GetVirtualMedia"</span>
  <span class="token key atrule">register</span><span class="token punctuation">:</span> result
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso
  <span class="token punctuation">-</span> umount<span class="token punctuation">-</span>iso
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Eject virtual media
  <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>
    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>
    <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"VirtualMediaEject"</span>
    <span class="token key atrule">virtual_media</span><span class="token punctuation">:</span>
      <span class="token key atrule">image_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; item &#125;&#125;"</span>
  <span class="token key atrule">with_items</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; result.redfish_facts.virtual_media.entries[0][1] | selectattr('ConnectedVia', 'equalto','URI') | map(attribute='Image') | list &#125;&#125;"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso
  <span class="token punctuation">-</span> umount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在弹出一个 ISO 的时候需要先知道 ISO 的 URL，感觉有点奇葩 😂。更合理的应该是需要一个挂载点的标识，就像比 Linux 上的挂载点。在 umount 挂载的设备时，只需要知道挂载点即可，不需要知道挂载的设备是什么。在 ISSUE <a target="_blank" rel="noopener" href="https://github.com/ansible-collections/community.general/issues/3042">VirtualMediaEject should not require image_url </a> 中有大佬反馈过在弹出 ISO 的时候不应该需要 image url，不过被 maintainer 给否决了 😅。</p>
<blockquote>
<p>Yes, at least with the behavior we’ve implemented today the image URL is needed since the expectation is the user is specifying the image URL for the ISO to eject. I think we need to consider some things first before making changes.</p>
<p>If the image URL is not given, then what exactly should be ejected? All virtual media your example indicates? This seems a bit heavy handed in my opinion, but others might like this behavior. Redfish itself doesn’t support an “eject all” type of operation, and I suspect the script you’re referencing is either using OEM actions or is just looping on all slots and ejecting everything.</p>
<p>Should a user be allowed specify an alternative identifier (such as the “Id” of the virtual media instance) in order to control what slot is ejected?</p>
<p>Certainly would like opinions from others for desired behavior. I do like the idea of keeping the mandatory argument list as minimal as possible, but would like to agree upon the desired behavior first.</p>
</blockquote>
<h3 id="通过-Redfish-插入-ISO"><a href="#通过-Redfish-插入-ISO" class="headerlink" title="通过 Redfish 插入 ISO"></a>通过 Redfish 插入 ISO</h3><ul>
<li>联想服务器使用的是 <code>community.general.xcc_redfish_command</code> 模块，redfish 的 command 为 VirtualMediaInsert；</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Lenovo <span class="token punctuation">|</span> Insert <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> image_url <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> Virtual Media
  <span class="token key atrule">community.general.xcc_redfish_command</span><span class="token punctuation">:</span>
    <span class="token key atrule">category</span><span class="token punctuation">:</span> Manager
    <span class="token key atrule">command</span><span class="token punctuation">:</span> VirtualMediaInsert
    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>
    <span class="token key atrule">virtual_media</span><span class="token punctuation">:</span>
      <span class="token key atrule">image_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; image_url &#125;&#125;"</span>
      <span class="token key atrule">media_types</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> CD
        <span class="token punctuation">-</span> DVD
    <span class="token key atrule">resource_id</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> inventory_hostname in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>戴尔和 HPE 服务器挂载 ISO 使用的则是 <code>community.general.redfish_command</code> 模块，command 和联想的相同；</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Insert <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> image_url <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO as virtual media device
 <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>
   <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>
   <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>
   <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>
   <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>
   <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"VirtualMediaInsert"</span>
   <span class="token key atrule">virtual_media</span><span class="token punctuation">:</span>
     <span class="token key atrule">image_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; image_url &#125;&#125;"</span>
     <span class="token key atrule">media_types</span><span class="token punctuation">:</span>
       <span class="token punctuation">-</span> CD
       <span class="token punctuation">-</span> DVD
 <span class="token key atrule">when</span><span class="token punctuation">:</span>
 <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>
 <span class="token key atrule">tags</span><span class="token punctuation">:</span>
 <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>需要注意的是：如果使用 <code>community.general.redfish_command</code> 模块为联想的服务器挂载 ISO 会提示 4xx 错误，必须使用 <code>community.general.xcc_redfish_command</code> 模块才行。</p>
<h3 id="设置启动项为虚拟光驱"><a href="#设置启动项为虚拟光驱" class="headerlink" title="设置启动项为虚拟光驱"></a>设置启动项为虚拟光驱</h3><p>此过程是将服务器的启动项设置为虚拟光驱，不同厂商的服务器调用的 ansible 模块可能也会有所不同。</p>
<ul>
<li>联想和 HPE 服务器</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set one<span class="token punctuation">-</span>time boot device to <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> bootdevice <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>
    <span class="token key atrule">category</span><span class="token punctuation">:</span> Systems
    <span class="token key atrule">command</span><span class="token punctuation">:</span> SetOneTimeBoot
    <span class="token key atrule">bootdevice</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; bootdevice &#125;&#125;"</span>
    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">20</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'dell'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>戴尔服务器</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>  Dell <span class="token punctuation">|</span> set iDRAC attribute for one<span class="token punctuation">-</span>time boot from virtual CD
  <span class="token key atrule">community.general.idrac_redfish_config</span><span class="token punctuation">:</span>
    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>
    <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"SetManagerAttributes"</span>
    <span class="token key atrule">manager_attributes</span><span class="token punctuation">:</span>
      <span class="token key atrule">ServerBoot.1.BootOnce</span><span class="token punctuation">:</span> <span class="token string">"Enabled"</span>
      <span class="token key atrule">ServerBoot.1.FirstBootDevice</span><span class="token punctuation">:</span> <span class="token string">"VCD-DVD"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> inventory_hostname in groups<span class="token punctuation">[</span><span class="token string">'dell'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="重启服务器"><a href="#重启服务器" class="headerlink" title="重启服务器"></a>重启服务器</h3><p>重启服务器直接调用 <code>community.general.redfish_command</code> 模块就可以。不过需要注意的是，重启服务器之前要保证服务器当前状态为开启状态，因此调用一下 redfish 的 PowerOn 命令对服务器进行开机，如果已处于开机状态则无影响，然后再调用 PowerForceRestart 命令重启服务器。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all
  <span class="token key atrule">name</span><span class="token punctuation">:</span> Power Force Restart the host
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Turn system power on
    <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>
      <span class="token key atrule">category</span><span class="token punctuation">:</span> Systems
      <span class="token key atrule">command</span><span class="token punctuation">:</span> PowerOn
      <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>
      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Reboot system
    <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>
      <span class="token key atrule">category</span><span class="token punctuation">:</span> Systems
      <span class="token key atrule">command</span><span class="token punctuation">:</span> PowerForceRestart
      <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>
      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>
      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">20</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> reboot<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这里还有优化的空间，就是根据电源的状态决定是重启还是开机，不过有点麻烦懒得弄了 😅</p>
<h3 id="等待-ESXi-OS-安装完成"><a href="#等待-ESXi-OS-安装完成" class="headerlink" title="等待 ESXi OS 安装完成"></a>等待 ESXi OS 安装完成</h3><p>服务器重启之后，我们通过 govc 命令不断尝试连接 ESXi 主机，如果能够正常连接则说明 ESXi OS 已经安装完成了。一般情况下等待 15 分钟左右就能安装完成，期间需要重启服务器两次，每次重启大概需要 5 分钟左右，实际上 ESXi 进入安装页面到安装完成只需要 5 分钟左右，服务器开机自检占用的时间会稍微长一点。</p>
<p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-03.png" alt="image-20220428210819057"></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all
  <span class="token key atrule">name</span><span class="token punctuation">:</span> Wait for the ESXi OS installation to complete
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">vars</span><span class="token punctuation">:</span>
    <span class="token key atrule">esxi_username</span><span class="token punctuation">:</span> <span class="token string">"root"</span>
    <span class="token key atrule">govc_url</span><span class="token punctuation">:</span> <span class="token string">"https://&#123;&#123; esxi_username &#125;&#125;:&#123;&#123; esxi_password &#125;&#125;@&#123;&#123; esxi_address &#125;&#125;"</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"Wait for &#123;&#123; inventory_hostname &#125;&#125; install ESXi &#123;&#123; esxi_address &#125;&#125; host to be complete"</span>
    <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">"govc about -k=true -u=&#123;&#123; govc_url&#125;&#125;"</span>
    <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">60</span>
    <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token key atrule">register</span><span class="token punctuation">:</span> result
    <span class="token key atrule">until</span><span class="token punctuation">:</span> result.rc == 0
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> post<span class="token punctuation">-</span>check<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Makefile-封装"><a href="#Makefile-封装" class="headerlink" title="Makefile 封装"></a>Makefile 封装</h2><p>为了方便操作，将上述流程使用 Makefile 进行封装一下，如果不配置 Jenkins Job 的话，可以在本地填写好 <code>config.yaml</code> 配置文件，然后运行 make 命令来进行相关操作。</p>
<h3 id="vars"><a href="#vars" class="headerlink" title="vars"></a>vars</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">SRC_ISO_DIR     ?<span class="token operator">=</span> /usr/share/nginx/html/iso
HTTP_DIR        ?<span class="token operator">=</span> /usr/share/nginx/html/iso/redfish
HTTP_URL        ?<span class="token operator">=</span> http://172.20.17.20/iso/redfish
ESXI_ISO        ?<span class="token operator">=</span> VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso

SRC_ISO_DIR   <span class="token comment"># 原 ESXi ISO 的存放目录</span>
ESXI_ISO      <span class="token comment"># ESXi ISO 的文件名，如 VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso</span>
HTTP_DIR      <span class="token comment"># HTTP 服务器的静态文件存放目录，比如 /usr/share/nginx/html 或 /var/www/html</span>
              <span class="token comment"># 重新构建好的 ISO 文件将存放到这个目录当中</span>
HTTP_URL      <span class="token comment"># HTTP 服务器的 URL 地址，比如 http://172.20.29.171/iso/redfish</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="target"><a href="#target" class="headerlink" title="target"></a>target</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">make docke<span class="token punctuation">-</span>run  <span class="token comment"># 在 docker 容器里运行所有操作，好处就是不用再安装一堆 ansible 等工具的依赖</span>
make inventory  <span class="token comment"># 根据 config.yaml 配置文件生成 ansible 的 inventory 文件</span>
make pre<span class="token punctuation">-</span>check  <span class="token comment"># 检查生成的 inventory 文件是否正确，连接 redfish 是否正常</span>
make build<span class="token punctuation">-</span>iso  <span class="token comment"># 为每台主机生成 kickstart 文件并重新构建 ESXi OS ISO 文件</span>
make mount<span class="token punctuation">-</span>iso  <span class="token comment"># 将构建好的 ISO 文件通过 redfish 挂载到物理服务器的虚拟光驱，并设备启动项</span>
make reboot     <span class="token comment"># 重启服务器，进入到虚拟光驱启动 ESXi inatller</span>
make post<span class="token punctuation">-</span>check <span class="token comment"># 等待 ESXi OS 安装完成</span>
make install<span class="token punctuation">-</span>os <span class="token comment"># 运行 pre-check, mount-iso, reboot, post-check</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Jenkins-Job"><a href="#Jenkins-Job" class="headerlink" title="Jenkins Job"></a>Jenkins Job</h2><p>虽然在 Makefile 里封装了比较方便的命令操作，但是对于不太熟悉这套流程的使用人员来讲还是不够便捷。对于使用人员来讲不需要知道具体的流程是什么，因此还需要提供一个更为便捷的入口来使用这套工具，对外屏蔽掉技术实现的细节。</p>
<p>在我们内部，老牌 CI 工具 Jenkins 大叔十分受欢迎，使用的十分普遍。之前同事也常调侃：<code>我们内部的 Jenkins 虽然达不到人手一个的数量，但每个团队有两三个自己的 Jenkins 再正常不过了</code>🤣。因此提供了一个 Jenkins Job 来运行这套安装工具再完美不过了。这样使用人员就不用再 clone repo 代码，傻乎乎地运行一些 make 命令了，毕竟一个 Jenkins build 的按钮比 make 命令好好用得太多。</p>
<p>我们组的 Jenkins 比较特殊，是使用 kubernetes Pod 作为动态 Jenkins slave 节点，即每运行一个 Jenkins Job 就会根据定义的 Pod 模版创建一个 Pod 到指定的 Kubernetes 集群中，然后 Jenkinsfile 中定义的 stage 都会运行在这个 Pod 容器内。这些内容可以参考一下我之前写的 <a href="https://blog.k8s.li/jenkins-with-kubernetes.html">Jenkins 大叔与 kubernetes 船长手牵手 🧑‍🤝‍🧑</a>。</p>
<h3 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h3><p>如果你熟悉 Jenkins 的话，可以创建一个 Jenkins Job ，并在 Job 中设置好如下几个参数，并将这个 <a target="_blank" rel="noopener" href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/jenkins/Jenkinsfile">Jenkinsfile</a> 中的内容复制到 Jenkins Job 的配置中。</p>
<table>
<thead>
<tr>
<th>参数名</th>
<th>参数类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>esxi_iso</td>
<td>ArrayList</td>
<td>ESXi ISO 文件名列表</td>
</tr>
<tr>
<td>http_server</td>
<td>String</td>
<td>HTTP 服务器的 IP 地址</td>
</tr>
<tr>
<td>http_dir</td>
<td>String</td>
<td>HTTP 服务器的文件目录路径</td>
</tr>
<tr>
<td>config_yaml</td>
<td>Text</td>
<td>config.yaml 配置文件内容</td>
</tr>
</tbody></table>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// params of jenkins job
def ESXI_ISO <span class="token operator">=</span> params.esxi_iso
def CONFIG_YAML <span class="token operator">=</span> params.config_yaml
def HTTP_SERVER <span class="token operator">=</span> params.http_server

// default params <span class="token keyword">for</span> the job
def HTTP_DIR  <span class="token operator">=</span> params.http_dir ?: <span class="token string">"/usr/share/nginx/html"</span>
def SRC_ISO_DIR <span class="token operator">=</span> params.src_iso_dir ?: <span class="token string">"<span class="token variable">$&#123;HTTP_DIR&#125;</span>/iso"</span>
def DEST_ISO_DIR <span class="token operator">=</span> params.dest_iso_dir ?: <span class="token string">"<span class="token variable">$&#123;HTTP_DIR&#125;</span>/iso/redfish"</span>

def WORKSPACE <span class="token operator">=</span> env.WORKSPACE
def JOB_NAME <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;env.JOB_BASE_NAME&#125;</span>"</span>
def BUILD_NUMBER <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;env.BUILD_NUMBER&#125;</span>"</span>
def POD_NAME <span class="token operator">=</span> <span class="token string">"jenkins-<span class="token variable">$&#123;JOB_NAME&#125;</span>-<span class="token variable">$&#123;BUILD_NUMBER&#125;</span>"</span>
def POD_IMAGE <span class="token operator">=</span> params.pod_image ?: <span class="token string">"ghcr.io/muzi502/redfish-esxi-os-installer:v0.1.0-alpha.1"</span>
// Kubernetes pod template to run.
podTemplate<span class="token punctuation">(</span>
    cloud: <span class="token string">"kubernetes"</span>,
    namespace: <span class="token string">"default"</span>,
    name: POD_NAME,
    label: POD_NAME,
    yaml: <span class="token string">""</span>"
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: runner
    image: <span class="token variable">$&#123;POD_IMAGE&#125;</span>
    imagePullPolicy: Always
    tty: <span class="token boolean">true</span>
    volumeMounts:
    - name: http-dir
      mountPath: <span class="token variable">$&#123;HTTP_DIR&#125;</span>
    securityContext:
      privileged: <span class="token boolean">true</span>
    env:
    - name: ESXI_ISO
      value: <span class="token variable">$&#123;ESXI_ISO&#125;</span>
    - name: SRC_ISO_DIR
      value: <span class="token variable">$&#123;SRC_ISO_DIR&#125;</span>
    - name: HTTP_DIR
      value: <span class="token variable">$&#123;DEST_ISO_DIR&#125;</span>
    - name: HTTP_URL
      value: http://<span class="token variable">$&#123;HTTP_SERVER&#125;</span>/iso/redfish
  - name: jnlp
    args: <span class="token punctuation">[</span><span class="token string">"\<span class="token variable"><span class="token variable">$(</span>JENKINS_SECRET<span class="token variable">)</span></span>"</span>, <span class="token string">"\<span class="token variable"><span class="token variable">$(</span>JENKINS_NAME<span class="token variable">)</span></span>"</span><span class="token punctuation">]</span>
    image: <span class="token string">"jenkins/inbound-agent:4.11.2-4-alpine"</span>
    imagePullPolicy: IfNotPresent
  volumes:
  - name: http-dir
    nfs:
      server: <span class="token variable">$&#123;HTTP_SERVER&#125;</span>
      path: <span class="token variable">$&#123;HTTP_DIR&#125;</span>
<span class="token string">""</span>",
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    node<span class="token punctuation">(</span>POD_NAME<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        try <span class="token punctuation">&#123;</span>
            container<span class="token punctuation">(</span><span class="token string">"runner"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                writeFile file: <span class="token string">'config.yaml'</span>, text: <span class="token string">"<span class="token variable">$&#123;CONFIG_YAML&#125;</span>"</span>
                stage<span class="token punctuation">(</span><span class="token string">"Inventory"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">sh</span> <span class="token string">""</span>"
                    <span class="token function">cp</span> -rf /ansible/* <span class="token builtin class-name">.</span>
                    <span class="token function">make</span> inventory
                    <span class="token string">""</span>"
                <span class="token punctuation">&#125;</span>
                stage<span class="token punctuation">(</span><span class="token string">"Precheck"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">sh</span> <span class="token string">""</span>"
                    <span class="token function">make</span> pre-check
                    <span class="token string">""</span>"
                <span class="token punctuation">&#125;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>params.build_iso<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    stage<span class="token punctuation">(</span><span class="token string">"Build-iso"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                        <span class="token function">sh</span> <span class="token string">""</span>"
                        <span class="token function">make</span> build-iso
                        <span class="token string">""</span>"
                    <span class="token punctuation">&#125;</span>
                <span class="token punctuation">&#125;</span>
                stage<span class="token punctuation">(</span><span class="token string">"Mount-iso"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">sh</span> <span class="token string">""</span>"
                    <span class="token function">make</span> mount-iso
                    <span class="token string">""</span>"
                <span class="token punctuation">&#125;</span>
                stage<span class="token punctuation">(</span><span class="token string">"Reboot"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">sh</span> <span class="token string">""</span>"
                    <span class="token function">make</span> <span class="token function">reboot</span>
                    <span class="token function">sleep</span> <span class="token number">60</span>
                    <span class="token string">""</span>"
                <span class="token punctuation">&#125;</span>
                stage<span class="token punctuation">(</span><span class="token string">"Postcheck"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">sh</span> <span class="token string">""</span>"
                    <span class="token function">make</span> post-check
                    <span class="token string">""</span>"
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            stage<span class="token punctuation">(</span><span class="token string">"Success"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                MESSAGE <span class="token operator">=</span> <span class="token string">"【Succeed】Jenkins Job <span class="token variable">$&#123;JOB_NAME&#125;</span>-<span class="token variable">$&#123;BUILD_NUMBER&#125;</span> Link: <span class="token variable">$&#123;BUILD_URL&#125;</span>"</span>
                // slackSend<span class="token punctuation">(</span>channel: <span class="token string">'$&#123;SLACK_CHANNE&#125;'</span>, color: <span class="token string">'good'</span>, message: <span class="token string">"<span class="token variable">$&#123;MESSAGE&#125;</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> catch <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            MESSAGE <span class="token operator">=</span> <span class="token string">"【Failed】Jenkins Job <span class="token variable">$&#123;JOB_NAME&#125;</span>-<span class="token variable">$&#123;BUILD_NUMBER&#125;</span> Link: <span class="token variable">$&#123;BUILD_URL&#125;</span>"</span>
            // slackSend<span class="token punctuation">(</span>channel: <span class="token string">'$&#123;SLACK_CHANNE&#125;'</span>, color: <span class="token string">'warning'</span>, message: <span class="token string">"<span class="token variable">$&#123;MESSAGE&#125;</span>"</span><span class="token punctuation">)</span>
            throw e
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>或者参考 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/8424228/export-import-jobs-in-jenkins">Export&#x2F;import jobs in Jenkins</a> 将这个 <a target="_blank" rel="noopener" href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/jenkins/config.xml">Job</a> 的配置导入到 Jenkins 当中，并设置好上面提到的几个参数。</p>
<p><img data-src="https://p.k8s.li/2022-04-30-redfish-esxi-os-installer-07.png" alt="image-20220429201859704"></p>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="硬件信息收集"><a href="#硬件信息收集" class="headerlink" title="硬件信息收集"></a>硬件信息收集</h3><p>整体上该方案有一点不足的就是需要人为地确认 ESXi OS 安装硬盘的型号&#x2F;序列号，以及 ESXi 管理网络所使用的物理网卡。其实是可以通过 redfish 的 API 来统一地获取，然后再根据这些硬件设备信息进行选择，这样就不用登录到每一台物理服务器上进行查看了。</p>
<p>但考虑到实现成本，工作量会翻倍，而且我们的服务器都是固定的，只要人为确认一次就可以，下一次重装 ESXi OS 的时候只需要复制粘贴上一次的硬件配置即可，所以目前并没有打算做获取硬件信息的功能。</p>
<p>而且即便是将硬件信息获取出来，如果没有一个可视化的 Web UI 展示这些设备信息，也很难从一堆硬件数据中找出特定的设备，对这些数据进行 UI 展示工作量也会翻倍，因此暂时不再考虑这个功能了。</p>
<h3 id="挂载-ISO-之前先确保-ISO-存在"><a href="#挂载-ISO-之前先确保-ISO-存在" class="headerlink" title="挂载 ISO 之前先确保 ISO 存在"></a>挂载 ISO 之前先确保 ISO 存在</h3><p>有些服务器比如 HPE 在挂载一个不存在的 ISO 时并不会报错，当时我排查了好久才发现 😂，我一直以为是启动项设置的问题。因此在挂载 ISO 之前我们可以通过 curl 的方式检查一下 ISO 的 URL 是否正确，如果 404 不存在的话就报错退出。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all
  <span class="token key atrule">name</span><span class="token punctuation">:</span> Mount  <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> image_url <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Check <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> image_url <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO file exists
    <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">"curl -sI &#123;&#123; image_url &#125;&#125;"</span>
    <span class="token key atrule">register</span><span class="token punctuation">:</span> response
    <span class="token key atrule">failed_when</span><span class="token punctuation">:</span> <span class="token string">"'200 OK' not in response.stdout or '404 Not Found' in response.stdout"</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="单独构建-Kickstart-ISO"><a href="#单独构建-Kickstart-ISO" class="headerlink" title="单独构建 Kickstart ISO"></a>单独构建 Kickstart ISO</h3><p>目前的方案是为将 ESXi 的 kickstart 文件 KS.CFG 放到了 ESXi OS ISO 镜像里，由于每台主机的 kickstart 文件都不相同，这就需要为每台服务器构建一个 ISO 文件，如果机器数量比较多的话，可能会占用大量的磁盘存储空间，效率上会有些问题。也尝试过将 kickstart 文件单独放到一个 ISO 中，大体的思路如下：</p>
<ul>
<li>构建 kickstart ISO 文件，-V 参数指定 ISO 的 label 名称为 KS</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ genisoimage -o /tmp/ks.iso -V KS ks.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>修改 ESXi 启动配置，将 ks 文件路径通过 label 的方式指向刚才构建的 ISO</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sed</span> -i -e <span class="token string">'s#cdromBoot#ks=hd:KS:/ks.cfg systemMediaSize=small#g'</span> boot.cfg
$ <span class="token function">sed</span> -i -e <span class="token string">'s#cdromBoot#ks=hd:KS:/ks.cfg systemMediaSize=small#g'</span> efi/boot/boot.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>修改一下 playbook，插入两个 ISO</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Insert <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO as virtual media device
  <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>
    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>
    <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"VirtualMediaInsert"</span>
    <span class="token key atrule">virtual_media</span><span class="token punctuation">:</span>
      <span class="token key atrule">image_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; item &#125;&#125;"</span>
      <span class="token key atrule">media_types</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> CD
        <span class="token punctuation">-</span> DVD
  <span class="token key atrule">with_items</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">"&#123;&#123; esxi_iso_url &#125;&#125;"</span>
  <span class="token punctuation">-</span> <span class="token string">"&#123;&#123; ks_iso_url &#125;&#125;"</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>等这些都修改好之后我满怀期待地运行了 make mount-iso 命令等到奇迹的发生，没想到直接翻车了！不支持挂载两个 ISO，白白高兴一场，真气人 😡</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">TASK <span class="token punctuation">[</span>Insert <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO as virtual media device<span class="token punctuation">]</span> <span class="token important">******************************************************************************************</span>
<span class="token key atrule">changed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.191<span class="token punctuation">]</span> =<span class="token punctuation">></span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/VMware<span class="token punctuation">-</span>VMvisor<span class="token punctuation">-</span>Installer<span class="token punctuation">-</span>7.0U3d<span class="token punctuation">-</span>19482537.x86_64.iso)
<span class="token key atrule">changed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.192<span class="token punctuation">]</span> =<span class="token punctuation">></span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/VMware<span class="token punctuation">-</span>VMvisor<span class="token punctuation">-</span>Installer<span class="token punctuation">-</span>7.0U3d<span class="token punctuation">-</span>19482537.x86_64.iso)
<span class="token key atrule">changed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.193<span class="token punctuation">]</span> =<span class="token punctuation">></span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/VMware<span class="token punctuation">-</span>VMvisor<span class="token punctuation">-</span>Installer<span class="token punctuation">-</span>7.0U3d<span class="token punctuation">-</span>19482537.x86_64.iso)
<span class="token key atrule">failed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.193<span class="token punctuation">]</span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/10.172.18.193/ks.iso) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span><span class="token key atrule">"ansible_loop_var"</span><span class="token punctuation">:</span> <span class="token string">"item"</span><span class="token punctuation">,</span> <span class="token key atrule">"changed"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">"item"</span><span class="token punctuation">:</span> <span class="token string">"http://10.172.29.171/iso/redfish/10.172.18.193/ks.iso"</span><span class="token punctuation">,</span> <span class="token key atrule">"msg"</span><span class="token punctuation">:</span> <span class="token string">"Unable to find an available VirtualMedia resource supporting ['CD', 'DVD']"</span><span class="token punctuation">&#125;</span>
<span class="token key atrule">failed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.192<span class="token punctuation">]</span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/10.172.18.192/ks.iso) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span><span class="token key atrule">"ansible_loop_var"</span><span class="token punctuation">:</span> <span class="token string">"item"</span><span class="token punctuation">,</span> <span class="token key atrule">"changed"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">"item"</span><span class="token punctuation">:</span> <span class="token string">"http://10.172.29.171/iso/redfish/10.172.18.192/ks.iso"</span><span class="token punctuation">,</span> <span class="token key atrule">"msg"</span><span class="token punctuation">:</span> <span class="token string">"Unable to find an available VirtualMedia resource supporting ['CD', 'DVD']"</span><span class="token punctuation">&#125;</span>
<span class="token key atrule">failed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.191<span class="token punctuation">]</span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/10.172.18.191/ks.iso) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span><span class="token key atrule">"ansible_loop_var"</span><span class="token punctuation">:</span> <span class="token string">"item"</span><span class="token punctuation">,</span> <span class="token key atrule">"changed"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">"item"</span><span class="token punctuation">:</span> <span class="token string">"http://10.172.29.171/iso/redfish/10.172.18.191/ks.iso"</span><span class="token punctuation">,</span> <span class="token key atrule">"msg"</span><span class="token punctuation">:</span> <span class="token string">"Unable to find an available VirtualMedia resource supporting ['CD', 'DVD']"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>或许将 ISO 替换成软盘  floppy  的方式可能行得通，不过当我看了 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/11202706/create-a-virtual-floppy-image-without-mount">create-a-virtual-floppy-image-without-mount</a> 后直接把我整不会了，没想创建一个软盘文件到这么麻烦，还是直接放弃该方案吧 🌚。</p>
<p>多说一句，之所以想到使用软盘的方式是因为之前在玩 <a target="_blank" rel="noopener" href="https://github.com/hashicorp/packer">Packer</a> 的时候，研究过它就是将 kickstart 文件制作成一个软盘，插入到虚拟机中。虚拟机开机后通过 vCenter API 发送键盘输入，插入 kickstart 的路径，anaconda 执行自动化安装 OS。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating VM<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Customizing hardware<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Mounting ISO images<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding configuration parameters<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating floppy disk<span class="token punctuation">..</span>.
    vsphere-iso-base: Copying files flatly from floppy_files
    vsphere-iso-base: Done copying files from floppy_files
    vsphere-iso-base: Collecting paths from floppy_dirs
    vsphere-iso-base: Resulting paths from floppy_dirs <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>./kickstart/centos/http/<span class="token punctuation">]</span>
    vsphere-iso-base: Recursively copying <span class="token builtin class-name">:</span> ./kickstart/centos/http/
    vsphere-iso-base: Done copying paths from floppy_dirs
    vsphere-iso-base: Copying files from floppy_content
    vsphere-iso-base: Done copying files from floppy_content
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Uploading created floppy image
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding generated Floppy<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Set boot order temporary<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Power on VM<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting 15s <span class="token keyword">for</span> boot<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Typing boot command<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting <span class="token keyword">for</span> IP<span class="token punctuation">..</span>.

root@devbox-fedora:/root <span class="token comment"># scp 192.168.24.43:/vmfs/volumes/Packer/base-os-centos7/packer-tmp-created-floppy.flp .</span>
packer-tmp-created-floppy.flp                                                                                <span class="token number">100</span>% 1440KB  <span class="token number">89</span>.4MB/s   00:00
root@devbox-fedora:/root <span class="token comment"># mount packer-tmp-created-floppy.flp /mnt</span>
root@devbox-fedora:/root <span class="token comment"># readlink /dev/disk/by-label/packer</span>
<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/loop2
root@devbox-fedora:/root <span class="token comment"># df -h /mnt</span>
Filesystem      Size  Used Avail Use% Mounted on
/dev/loop2      <span class="token number">1</span>.4M   16K  <span class="token number">1</span>.4M   <span class="token number">2</span>% /mnt
root@devbox-fedora:/root <span class="token comment">#</span>
root@devbox-fedora:/root <span class="token comment"># ls /mnt</span>
HTTP
root@devbox-fedora:/root <span class="token comment"># ls /mnt/HTTP</span>
<span class="token number">7</span>
root@devbox-fedora:/root <span class="token comment"># ls /mnt/HTTP/7</span>
KS.CFG<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="通过-http-方式读取-kickstart"><a href="#通过-http-方式读取-kickstart" class="headerlink" title="通过 http 方式读取 kickstart"></a>通过 http 方式读取 kickstart</h3><p>不一定可行，在通过 http 方式读取 kickstart 文件之前，ESXi OS installer 需要有一个 IP 地址才行。如果服务器如果有多块网卡的话，就很难确定是否分配到一个 IP，使用默认 DHCP 的方式并不一定能获取到正确的 IP 地址。因此读取 kickstart 文件的方式还是建议使用 ISO 的方式，这样在安装 OS 时对网络环境无依赖，更稳定一些。</p>
<h3 id="支持其他-OS-的安装"><a href="#支持其他-OS-的安装" class="headerlink" title="支持其他 OS 的安装"></a>支持其他 OS 的安装</h3><p>目前该方案只支持 ESXi OS 的安装，其他 OS 的自动化安装其实原理是一样的。比如 CentOS 同样也是修改 kickstart 文件。如果要指定 OS 所安装的磁盘可以参考一下戴尔官方的一篇文档 <a target="_blank" rel="noopener" href="https://www.dell.com/support/kbdoc/zh-hk/000177584/automating-operating-system-deployment-to-dell-boss-techniques-for-different-operating-systems">Automating Operating System Deployment to Dell BOSS – Techniques for Different Operating Systems</a> 。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">%include /tmp/bootdisk.cfg
%pre
<span class="token comment"># Use DELLBOSS device for OS install if present.</span>
<span class="token assign-left variable">BOSS_DEV</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">find</span> /dev -name <span class="token string">"*DELLBOSS*"</span> -printf %P<span class="token string">"<span class="token entity" title="\n">\n</span>"</span> <span class="token operator">|</span> <span class="token function">egrep</span> -v -e part -e scsi<span class="token operator">|</span> <span class="token function">head</span> -1<span class="token variable">)</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> -n <span class="token string">"<span class="token variable">$BOSS_DEV</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> ignoredisk --only-use<span class="token operator">=</span><span class="token string">"<span class="token variable">$BOSS_DEV</span>"</span> <span class="token operator">></span> /tmp/bootdisk.cfg
<span class="token keyword">fi</span>
%end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果要为某块物理网卡配置 IP 地址，可以根据 MAC 地址找到对应的物理网卡，然后将静态 IP 配置写入到网卡配置文件当中。比如 CentOS 在 kickstart 中为某块物理网卡配置静态 IP，可以采用如下方式：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">MAC_ADDRESS 在生成 kickstart 文件的时候根据 config.yaml 动态修改的
<span class="token comment"># MAC_ADDRESS=B4:96:91:A7:3F:D6</span>

<span class="token comment"># 根据 MAC 地址获取到网卡设备的名称</span>
<span class="token assign-left variable">NIC</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> -l $<span class="token punctuation">&#123;</span>MAC_ADDRESS<span class="token punctuation">&#125;</span> /sys/class/net/*/address <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">'/'</span> <span class="token string">'&#123;print $5&#125;'</span><span class="token variable">)</span></span>

<span class="token comment"># 将网卡静态 IP 配置写入到文件当中</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /etc/sysconfig/network-scripts/ifcfg-<span class="token variable">$&#123;NIC&#125;</span></span>
TYPE=Ehternet
BOOTPROTO=static
DEFROUTE=yes
NAME=<span class="token variable">$&#123;NIC&#125;</span>
DEVICE=<span class="token variable">$&#123;NIC&#125;</span>
ONBOOT=yes
IPADDR=<span class="token variable">$&#123;IP&#125;</span>
NETMASK=<span class="token variable">$&#123;NETMASK&#125;</span>
GATEWAY=<span class="token variable">$&#123;GATEWAY&#125;</span>
EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于时间关系，在这里就不再进行深入讲解了，在这里只是提供一个方法和思路。至于 Debian&#x2F;Ubuntu 发行版，还是你们自己摸索吧，因为我工作中确实没有在物理服务器上安装这些发行版的场景，毕竟国内企业私有云环境中使用 CentOS&#x2F;RedHat 系列发行版的占绝大多数。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><h3 id="Redfish-相关"><a href="#Redfish-相关" class="headerlink" title="Redfish 相关"></a>Redfish 相关</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.dmtf.org/standards/redfish">DMTF’s Redfish</a></li>
<li><a target="_blank" rel="noopener" href="https://www.dmtf.org/sites/default/files/DSP2044%20Redfish%20%E7%99%BD%E7%9A%AE%E4%B9%A6%201.0.0.pdf">Redfish 白皮书</a></li>
<li><a target="_blank" rel="noopener" href="https://wsgzao.github.io/post/redfish/">Redfish 下一代数据中心管理标准详解和实践</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dell/redfish-ansible-module">redfish-ansible-module</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lenovo/python-redfish-lenovo">python-redfish-lenovo</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/community/general/xcc_redfish_command_module.html">xcc_redfish_command module</a></li>
<li><a target="_blank" rel="noopener" href="https://sysmgt.lenovofiles.com/help/index.jsp?topic=/com.lenovo.systems.management.xcc.doc/rest_api.html">Lenovo XClarity Controller Redfish REST API</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.esxi.upgrade.doc/GUID-61A14EBB-5CF3-43EE-87EF-DB8EC6D83698.html">Installation and Upgrade Script Commands</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hpe.com/psnow/doc/4AA6-1727ENW">Redfish API implementation on HPE servers with iLO RESTful API technical white paper</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ansible-collections/community.general/issues/3042">VirtualMediaEject should not require image_url </a></li>
</ul>
<h3 id="VMware-ESXi-相关"><a href="#VMware-ESXi-相关" class="headerlink" title="VMware ESXi 相关"></a>VMware ESXi 相关</h3><ul>
<li><a target="_blank" rel="noopener" href="https://communities.vmware.com/t5/ESXi-Discussions/Reducing-Esxi-7-VMFSL/td-p/2808955">Reducing Esxi 7 VMFSL</a></li>
<li><a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/1014953">Identifying disks when working with VMware ESXi (1014953)</a></li>
<li><a target="_blank" rel="noopener" href="https://downloads.dell.com/manuals/all-products/esuprt_solutions_int/esuprt_solutions_int_solutions_resources/servers-solution-resources_white-papers10_en-us.pdf">PowerEdge Boot Optimized Storage Solution BOSS - Dell</a></li>
<li><a target="_blank" rel="noopener" href="https://www.reddit.com/r/vmware/comments/2a5jv7/esxi_kickstart_script_to_grep_for_correct_lun/">ESXi Kickstart script to grep for correct LUN? (iSCSI, Boot from SAN)</a></li>
<li><a target="_blank" rel="noopener" href="https://www.dell.com/support/kbdoc/zh-hk/000177584/automating-operating-system-deployment-to-dell-boss-techniques-for-different-operating-systems">Automating Operating System Deployment to Dell BOSS – Techniques for Different Operating Systems</a></li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ESXi/" rel="tag"># ESXi</a>
              <a href="/tags/Redfish/" rel="tag"># Redfish</a>
              <a href="/tags/Dell-%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag"># Dell 服务器</a>
              <a href="/tags/HPE-%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag"># HPE 服务器</a>
              <a href="/tags/Lenovo-%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag"># Lenovo 服务器</a>
              <a href="/tags/%E8%A3%B8%E9%87%91%E5%B1%9E%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag"># 裸金属服务器</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/govc-usage.html" rel="prev" title="搬砖工具 govc 使用记录">
                  <i class="fa fa-chevron-left"></i> 搬砖工具 govc 使用记录
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/packer-vsphere-example.html" rel="next" title="使用 Packer 构建虚拟机镜像踩的坑">
                  使用 Packer 构建虚拟机镜像踩的坑 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">26:05</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
