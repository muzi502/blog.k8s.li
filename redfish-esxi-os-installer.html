<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.k8s.li').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="ä»å»å¹´åä¸€æœˆåº•åˆ°ç°åœ¨ä¸€ç›´åœ¨åšåœ¨  VMware ESXi  ä¸Šéƒ¨ç½² è¶…èåˆé›†ç¾¤ çš„äº§å“åŒ–å·¥å…·ï¼Œä¹Ÿæ˜¯åœ¨æœ€è¿‘å®Œæˆäº†å‰åç«¯çš„è”è°ƒï¼Œäº”ä¸€èŠ‚åå¼€å§‹è¿›å…¥æµ‹è¯•é˜¶æ®µã€‚ä¸ºäº†æµ‹è¯•ä¸åŒçš„ VMware ESXi ç‰ˆæœ¬å’Œæˆ‘ä»¬äº§å“çš„å…¼å®¹æ€§ï¼Œéœ€è¦å¾ˆé¢‘ç¹åœ°åœ¨ä¸€äº›ç‰©ç†æœåŠ¡å™¨ï¼ˆå¦‚æˆ´å°”ã€è”æƒ³ã€æƒ æ™®ã€æµªæ½®ã€è¶…å¾®ç­‰ï¼‰ä¸Šå®‰è£… VMware ESXi OSã€‚ ä¹‹å‰ä¸€ç›´éƒ½æ˜¯ç™»å½• IPMI ç®¡ç†é¡µé¢ï¼ŒæŒ‚è½½è¿œç¨‹çš„ ISO æ–‡ä»¶æ‰‹åŠ¨å®‰è£…ã€‚å®‰è£…å®Œæˆä¹‹">
<meta property="og:type" content="article">
<meta property="og:title" content="ä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OS">
<meta property="og:url" content="https://blog.k8s.li/redfish-esxi-os-installer.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="ä»å»å¹´åä¸€æœˆåº•åˆ°ç°åœ¨ä¸€ç›´åœ¨åšåœ¨  VMware ESXi  ä¸Šéƒ¨ç½² è¶…èåˆé›†ç¾¤ çš„äº§å“åŒ–å·¥å…·ï¼Œä¹Ÿæ˜¯åœ¨æœ€è¿‘å®Œæˆäº†å‰åç«¯çš„è”è°ƒï¼Œäº”ä¸€èŠ‚åå¼€å§‹è¿›å…¥æµ‹è¯•é˜¶æ®µã€‚ä¸ºäº†æµ‹è¯•ä¸åŒçš„ VMware ESXi ç‰ˆæœ¬å’Œæˆ‘ä»¬äº§å“çš„å…¼å®¹æ€§ï¼Œéœ€è¦å¾ˆé¢‘ç¹åœ°åœ¨ä¸€äº›ç‰©ç†æœåŠ¡å™¨ï¼ˆå¦‚æˆ´å°”ã€è”æƒ³ã€æƒ æ™®ã€æµªæ½®ã€è¶…å¾®ç­‰ï¼‰ä¸Šå®‰è£… VMware ESXi OSã€‚ ä¹‹å‰ä¸€ç›´éƒ½æ˜¯ç™»å½• IPMI ç®¡ç†é¡µé¢ï¼ŒæŒ‚è½½è¿œç¨‹çš„ ISO æ–‡ä»¶æ‰‹åŠ¨å®‰è£…ã€‚å®‰è£…å®Œæˆä¹‹">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-01.png">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-06.png">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-04.png">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-05.png">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-02.png">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-03.png">
<meta property="og:image" content="https://p.k8s.li/2022-04-30-redfish-esxi-os-installer-07.png">
<meta property="article:published_time" content="2022-04-29T16:00:00.000Z">
<meta property="article:modified_time" content="2022-04-29T16:00:00.000Z">
<meta property="article:author" content="æœ¨å­">
<meta property="article:tag" content="ESXi">
<meta property="article:tag" content="Redfish">
<meta property="article:tag" content="Dell æœåŠ¡å™¨">
<meta property="article:tag" content="HPE æœåŠ¡å™¨">
<meta property="article:tag" content="Lenovo æœåŠ¡å™¨">
<meta property="article:tag" content="è£¸é‡‘å±æœåŠ¡å™¨">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-01.png">

<link rel="canonical" href="https://blog.k8s.li/redfish-esxi-os-installer.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>ä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OS | Reimu's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Reimu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-desktop"></i>Home</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Books</a>

  </li>
        <li class="menu-item menu-item-kindle">

    <a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>

  </li>
        <li class="menu-item menu-item-friends">

    <a href="/friends.html" rel="section"><i class="fa fa-fw fa-link"></i>Friends</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about.html" rel="section"><i class="fa fa-fw fa-user-circle-o"></i>About</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/redfish-esxi-os-installer.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog.k8s.li/avatar.png">
      <meta itemprop="name" content="æœ¨å­">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          ä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OS
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-30 2022-04-30T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2022-04-30T00:00:00+08:00">2022-04-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/redfish-esxi-os-installer.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="redfish-esxi-os-installer.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>27k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>45 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>ä»å»å¹´åä¸€æœˆåº•åˆ°ç°åœ¨ä¸€ç›´åœ¨åšåœ¨  <a href="https://www.vmware.com/products/esxi-and-esx.html" target="_blank" rel="noopener">VMware ESXi</a>  ä¸Šéƒ¨ç½² <a href="https://www.smartx.com/smartx-hci/" target="_blank" rel="noopener">è¶…èåˆé›†ç¾¤</a> çš„äº§å“åŒ–å·¥å…·ï¼Œä¹Ÿæ˜¯åœ¨æœ€è¿‘å®Œæˆäº†å‰åç«¯çš„è”è°ƒï¼Œäº”ä¸€èŠ‚åå¼€å§‹è¿›å…¥æµ‹è¯•é˜¶æ®µã€‚ä¸ºäº†æµ‹è¯•ä¸åŒçš„ VMware ESXi ç‰ˆæœ¬å’Œæˆ‘ä»¬äº§å“çš„å…¼å®¹æ€§ï¼Œéœ€è¦å¾ˆé¢‘ç¹åœ°åœ¨ä¸€äº›ç‰©ç†æœåŠ¡å™¨ï¼ˆå¦‚æˆ´å°”ã€è”æƒ³ã€æƒ æ™®ã€æµªæ½®ã€è¶…å¾®ç­‰ï¼‰ä¸Šå®‰è£… VMware ESXi OSã€‚</p>
<p>ä¹‹å‰ä¸€ç›´éƒ½æ˜¯ç™»å½• IPMI ç®¡ç†é¡µé¢ï¼ŒæŒ‚è½½è¿œç¨‹çš„ ISO æ–‡ä»¶æ‰‹åŠ¨å®‰è£…ã€‚å®‰è£…å®Œæˆä¹‹åè¿˜éœ€è¦é…ç½® ESXi ç®¡ç†ç½‘ç»œçš„ IP åœ°å€ã€‚æ•´ä½“çš„å®‰è£…æµç¨‹æ¯”è¾ƒç¹çï¼Œè€Œä¸”ç‰©ç†æœåŠ¡å™¨æ¯æ¬¡é‡å¯å’Œå¼€æœºéƒ½ååˆ†è€—æ—¶ï¼Œå¯¹ç»å¸¸è¦å®‰è£… ESXi çš„ QE å°ä¼™ä¼´æ¥è®²ååˆ†ç—›è‹¦ã€‚</p>
<p>ä¸ºäº†åç»­æµ‹è¯•èµ·æ¥çˆ½å¿«ä¸€ç‚¹ï¼Œä¸ç”¨å†ä¸ºå®‰è£… ESXi OS è€Œçƒ¦æ¼ï¼Œäºæ˜¯å°±åŸºäº Redfish å¿«é€Ÿå®ç°äº†ä¸€å¥—è‡ªåŠ¨åŒ–å®‰è£… ESXi OS çš„å·¥å…· <a href="https://github.com/muzi502/redfish-esxi-os-installer" target="_blank" rel="noopener">redfish-esxi-os-installer</a>ã€‚é€šè¿‡å®ƒæˆ‘ä»¬å†…éƒ¨çš„æˆ´å°”ã€è”æƒ³ã€HPE æœåŠ¡å™¨å®‰è£… ESXi OS åªéœ€è¦å¡«å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶å¹¶é€‰æ‹©éœ€è¦å®‰è£…çš„ ESXi ISOï¼Œè¿è¡Œä¸€ä¸‹ Jenkins Job ç­‰å¾…åå‡ åˆ†é’Ÿå°±èƒ½è‡ªåŠ¨å®‰è£…å¥½ã€‚åŸæœ¬éœ€è¦ä¸€ä¸ªå¤šå°æ—¶çš„å·¥ä½œé‡ï¼Œç°åœ¨åªéœ€è¦è¿è¡Œä¸€ä¸‹ Jenkins Job å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨å®‰è£…å¥½ ESXi OS å•¦ ğŸ˜‚ï¼ŒçœŸæ˜¯çˆ½æ­ªæ­ªã€‚</p>
<p>äº”ä¸€å‡æœŸåˆšå¼€å§‹ï¼Œæ­£å¥½æœ‰æ—¶é—´æŠ½ç©ºæ•´ç†ä¸€ä¸‹æœ€è¿‘å­¦åˆ°çš„ä¸œè¥¿ï¼Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹è¿™å¥—è‡ªåŠ¨åŒ–å®‰è£… ESXi OS å·¥å…·ã€‚</p>
<h2 id="éœ€æ±‚åˆ†æ"><a href="#éœ€æ±‚åˆ†æ" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h2><ul>
<li>æ”¯æŒæœåŠ¡å™¨ï¼šè”æƒ³/æˆ´å°”/HPEï¼ˆè¶…å¾®å’Œæµªæ½®ä¼˜å…ˆçº§ä¸é«˜ï¼Œæš‚æ—¶ä¸æ”¯æŒï¼‰ï¼›</li>
<li>ä¸€é”®è‡ªåŠ¨åŒ–å®‰è£…/é‡è£… ESXi OSï¼Œæœ€å¥½èƒ½é…ç½®å¥½ Jenkins Jobï¼›</li>
<li>æŒ‡å®š ESXi OS å®‰è£…çš„ç‰©ç†ç›˜ï¼šç”±äºç‰©ç†æœåŠ¡å™¨æœ‰å¤šå—ç¡¬ç›˜ï¼ŒESXi OS éœ€è¦å®‰è£…åœ¨æŒ‡å®šçš„ç¡¬ç›˜ä¸Šã€‚ä¸€èˆ¬ä¸º SATA DOM ç›˜ã€‚æ¯”å¦‚æˆ´å°”çš„ <a href="https://downloads.dell.com/manuals/all-products/esuprt_solutions_int/esuprt_solutions_int_solutions_resources/servers-solution-resources_white-papers10_en-us.pdf" target="_blank" rel="noopener">DELLBOSS</a>ï¼Œè”æƒ³çš„ <a href="https://lenovopress.com/lp0769.pdf" target="_blank" rel="noopener">ThinkSystem M.2</a> ã€‚è¿™ç±» DOM ç›˜çš„å¥½å¤„å°±åœ¨äºä¸å ç”¨å¤šä½™çš„ HBA å¡æˆ– PCI æ’æ§½ï¼Œæœ‰ç‚¹ç±»ä¼¼äºå®¶ç”¨å°å¼æœºä¸»æ¿ä¸Šçš„ M.2 ç¡¬ç›˜ä½æ’æ§½ï¼›</li>
<li>æŒ‡å®šç½‘å¡å¹¶é…ç½®é™æ€ IP åœ°å€ï¼šç”±äºæˆ‘ä»¬çš„ç‰©ç†æœåŠ¡å™¨ä¸Šæœ‰å¤šå—ç½‘å¡ï¼Œä¸”ä¸åŒçš„ç½‘å¡æœ‰ä¸åŒçš„ç½‘ç»œç”¨é€”ï¼Œå› æ­¤éœ€è¦æŒ‡å®šæŸå—ç‰©ç†ç½‘å¡ä¸º ESXi ç®¡ç†ç½‘ç»œæ‰€ä½¿ç”¨çš„ç½‘å¡ã€‚</li>
<li>ä¸º ESXi ç®¡ç†ç½‘è·¯é…ç½®é™æ€ IPã€å­ç½‘æ©ç ã€ç½‘å…³ï¼Œä¾¿äºéƒ¨ç½²å¥½ä¹‹åç›´æ¥å°±èƒ½é€šè¿‡è¯¥ IP è®¿é—® ESXiã€‚è€Œä¸æ˜¯é€šè¿‡ DHCP åˆ†é…ä¸€ä¸ª IPï¼Œç„¶åå†ç™»å½• IPMI ç®¡ç†é¡µé¢æ‰‹åŠ¨æŸ¥çœ‹ ESXi çš„ IPï¼›</li>
</ul>
<h2 id="æŠ€æœ¯è°ƒç ”"><a href="#æŠ€æœ¯è°ƒç ”" class="headerlink" title="æŠ€æœ¯è°ƒç ”"></a>æŠ€æœ¯è°ƒç ”</h2><p>ç›®å‰å¸‚é¢ä¸Šä¸»æµçš„è£¸é‡‘å±æœåŠ¡å™¨è‡ªåŠ¨åŒ–å®‰è£… OS çš„å·¥å…·æœ‰ PXE å’Œ IPMI/Redfish ä¸¤ç§ã€‚</p>
<h3 id="PXE"><a href="#PXE" class="headerlink" title="PXE"></a>PXE</h3><p>è™½ç„¶å†…éƒ¨ä¹Ÿæœ‰ PXE æœåŠ¡å¯ç”¨ï¼Œä½†é‡å¯æœåŠ¡å™¨å’Œè®¾ç½®æœåŠ¡å™¨çš„å¼•å¯¼é¡¹ä¸º PXE å¯åŠ¨ä»ç„¶éœ€è¦æ‰‹åŠ¨ç™»å½• IPMI ç®¡ç†é¡µé¢è¿›è¡Œæ“ä½œï¼Œæ— æ³•åšåˆ°è‡ªåŠ¨é‡å¯å’Œè‡ªåŠ¨é‡è£…ï¼Œä»æœ‰ä¸€å®šçš„å·¥ä½œé‡ã€‚è€Œä¸” PXE å®‰è£… OS æ— æ³•è§£å†³ä¸ºæ¯å°æœåŠ¡å™¨é…ç½®å„è‡ªçš„å®‰è£…ç›˜å’Œç®¡ç†ç½‘ç»œç½‘å¡åŠé™æ€ IP åœ°å€çš„é—®é¢˜ï¼Œé‚æ”¾å¼ƒã€‚</p>
<h3 id="IPMI-Redfish"><a href="#IPMI-Redfish" class="headerlink" title="IPMI/Redfish"></a>IPMI/Redfish</h3><p><a href="https://www.dmtf.org/standards/redfish" target="_blank" rel="noopener">Redfish</a> çš„æ¦‚å¿µå’ŒåŸç†ä»€ä¹ˆçš„å°±æ‡’å¾—ä»‹ç»äº†ï¼Œä¸‹é¢å°±ç›´æ¥å‰½çªƒä¸€ä¸‹å®˜æ–¹çš„æ–‡æ¡£å§ ğŸ˜…ï¼š</p>
<blockquote>
<p><code>DMTF</code> çš„ <code>RedfishÂ®</code> æ˜¯ä¸€ä¸ªæ ‡å‡† <code>API</code>ï¼Œæ—¨åœ¨ä¸ºèåˆã€æ··åˆ <code>IT</code> å’Œè½¯ä»¶å®šä¹‰æ•°æ®ä¸­å¿ƒï¼ˆ<code>SDDC</code>ï¼‰æä¾›ç®€å•å’Œå®‰å…¨ç®¡ç†ã€‚</p>
<p>åœ¨ <code>Redfish</code> å‡ºç°ä¹‹å‰ï¼Œç°ä»£æ•°æ®ä¸­å¿ƒç¯å¢ƒä¸­ç¼ºä¹äº’æ“ä½œç®¡ç†æ ‡å‡†ã€‚éšç€æœºæ„è¶Šæ¥è¶Šé’çäºå¤§è§„æ¨¡çš„è§£å†³æ–¹æ¡ˆï¼Œä¼ ç»Ÿæ ‡å‡†ä¸è¶³ä»¥æˆåŠŸç®¡ç†å¤§é‡ç®€å•çš„å¤šèŠ‚ç‚¹æœåŠ¡å™¨æˆ–æ··åˆåŸºç¡€è®¾æ–½ã€‚<code>IPMI</code> æ˜¯ä¸€ç§è¾ƒæ—©çš„å¸¦å¤–ç®¡ç†æ ‡å‡†ï¼Œä»…é™äºâ€œæœ€å°å…¬å…±é›†â€å‘½ä»¤é›†ï¼ˆä¾‹å¦‚ï¼Œå¼€æœº/å…³æœº/é‡å¯ã€æ¸©åº¦å€¼ã€æ–‡æœ¬æ§åˆ¶å°ç­‰ï¼‰ï¼Œç”±äºä¾›åº”å•†æ‰©å±•åœ¨æ‰€æœ‰å¹³å°ä¸Šå¹¶ä¸å¸¸è§ï¼Œå¯¼è‡´äº†å®¢æˆ·å¸¸ç”¨çš„åŠŸèƒ½é›†å‡å°‘ã€‚è®¸å¤šç”¨æˆ·å¼€å‘äº†è‡ªå·±çš„ç´§å¯†é›†æˆå·¥å…·ï¼Œä½†æ˜¯ä¹Ÿä¸å¾—ä¸ä¾èµ–å¸¦å†…ç®¡ç†è½¯ä»¶ã€‚</p>
<p>è€Œå¯¹äºä¼ä¸šçº§ç”¨æˆ·æ¥è¯´ï¼Œè®¾å¤‡éƒ½æ˜¯ä¸Šåƒå°ï¼Œå…¶éœ€è¦ç»Ÿä¸€çš„ç®¡ç†ç•Œé¢ï¼Œå°±è¦å¯¹æ¥ä¸åŒä¾›åº”å•†çš„ <code>API</code>ã€‚å½“åŸºæœ¬ <code>IPMI</code> åŠŸèƒ½å·²ç»ä¸å¤ªå¥½æ»¡è¶³å¤§è§„æ¨¡ <code>Scale-out</code> ç¯å¢ƒæ—¶ï¼Œå¦‚ä½•ä»¥æ›´ä¾¿æ·çš„æ–¹å¼è°ƒç”¨æœåŠ¡å™¨é«˜çº§ç®¡ç†åŠŸèƒ½å°±æ˜¯ä¸€ä¸ªæ–°çš„éœ€æ±‚ã€‚</p>
<p>ä¸ºäº†å¯»æ±‚ä¸€ä¸ªåŸºäºå¹¿æ³›ä½¿ç”¨çš„å·¥å…·æ¥åŠ å¿«å‘å±•çš„ç°ä»£æ¥å£ï¼Œç°å¦‚ä»Šï¼Œå®¢æˆ·éœ€è¦ä¸€ä¸ªä½¿ç”¨äº’è”ç½‘å’Œ <code>web</code> æœåŠ¡ç¯å¢ƒä¸­å¸¸è§çš„åè®®ã€ç»“æ„å’Œå®‰å…¨æ¨¡å‹å®šä¹‰çš„ <code>API</code>ã€‚</p>
<p><code>Redfish</code> å¯æ‰©å±•å¹³å°ç®¡ç† <code>API</code>ï¼ˆ<code>The Redfish Scalable Platforms Management API</code>ï¼‰æ˜¯ä¸€ç§æ–°çš„è§„èŒƒï¼Œå…¶ä½¿ç”¨ <code>RESTful</code> æ¥å£è¯­ä¹‰æ¥è®¿é—®å®šä¹‰åœ¨æ¨¡å‹æ ¼å¼ä¸­çš„æ•°æ®ï¼Œç”¨äºæ‰§è¡Œå¸¦å¤–ç³»ç»Ÿç®¡ç† ï¼ˆ<code>out of band systems management</code>ï¼‰ã€‚å…¶é€‚ç”¨äºå¤§è§„æ¨¡çš„æœåŠ¡å™¨ï¼Œä»ç‹¬ç«‹çš„æœåŠ¡å™¨åˆ°æœºæ¶å¼å’Œåˆ€ç‰‡å¼çš„æœåŠ¡å™¨ç¯å¢ƒï¼Œè€Œä¸”ä¹ŸåŒæ ·é€‚ç”¨äºå¤§è§„æ¨¡çš„äº‘ç¯å¢ƒã€‚</p>
<p><code>Redfish</code> çš„ç¬¬ <code>1</code> ç‰ˆä¾§é‡äºæœåŠ¡å™¨ï¼Œä¸º <code>IPMI-over-LAN</code> æä¾›äº†ä¸€ä¸ªå®‰å…¨ã€å¤šèŠ‚ç‚¹çš„æ›¿ä»£å“ã€‚éšåçš„ <code>Redfish</code> ç‰ˆæœ¬å¢åŠ äº†å¯¹ç½‘ç»œæ¥å£(ä¾‹å¦‚ <code>NIC</code>ã€<code>CNA</code> å’Œ <code>FC HBA</code>)ã€<code>PCIe</code> äº¤æ¢ã€æœ¬åœ°å­˜å‚¨ã€<code>NVDIMM</code>ã€å¤šåŠŸèƒ½é€‚é…å™¨å’Œå¯ç»„åˆæ€§ä»¥åŠå›ºä»¶æ›´æ–°æœåŠ¡ã€è½¯ä»¶æ›´æ–°æ¨é€æ–¹æ³•å’Œå®‰å…¨ç‰¹æƒæ˜ å°„çš„ç®¡ç†ã€‚æ­¤å¤–ï¼Œ<code>Redfish</code> ä¸»æœºæ¥å£è§„èŒƒå…è®¸åœ¨æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œåº”ç”¨ç¨‹åºå’Œå·¥å…·ï¼ŒåŒ…æ‹¬åœ¨å¯åŠ¨å‰ï¼ˆå›ºä»¶ï¼‰é˜¶æ®µ-ä¸ <code>Redfish</code> ç®¡ç†æœåŠ¡æ²Ÿé€šã€‚</p>
<p>åœ¨å®šä¹‰ <code>Redfish</code> æ ‡å‡†æ—¶ï¼Œåè®®ä¸æ•°æ®æ¨¡å‹å¯åˆ†å¼€å¹¶å…è®¸ç‹¬ç«‹åœ°ä¿®æ”¹ã€‚ä»¥æ¨¡å¼ä¸ºåŸºç¡€çš„æ•°æ®æ¨¡å‹æ˜¯å¯ä¼¸ç¼©å’Œå¯æ‰©å±•çš„ï¼Œå¹¶ä¸”éšç€è¡Œä¸šçš„å‘å±•ï¼Œå®ƒå°†è¶Šæ¥è¶Šå…·æœ‰äººç±»å¯è¯»æ€§å®šä¹‰ã€‚</p>
</blockquote>
<p>é€šè¿‡ Redfish æˆ‘ä»¬å¯ä»¥å¯¹æœåŠ¡å™¨è¿›è¡ŒæŒ‚è½½/å¸è½½ ISOã€è®¾ç½® BIOS å¯åŠ¨é¡¹ã€å¼€æœº/å…³æœº/é‡å¯ç­‰æ“ä½œã€‚åªéœ€è¦ä½¿ç”¨ä¸€äº›ç‰¹å®šçš„ ansible æ¨¡å—ï¼Œå°†å®ƒä»¬ç¼åˆèµ·æ¥å°±èƒ½å°†æ•´ä¸ªæµç¨‹è·‘é€šã€‚</p>
<p>å†…éƒ¨çš„æœåŠ¡å™¨æˆ´å°”ã€è”æƒ³ã€HPE çš„è¾ƒå¤šï¼Œè¿™ä¸‰å®¶å‚å•†å¯¹ Redfish æ”¯æŒçš„ä¹Ÿæ¯”è¾ƒå®Œå–„ã€‚äºæ˜¯è¿™ä¸ª ESXi OS è‡ªåŠ¨åŒ–å®‰è£…å·¥å…· <a href="https://github.com/muzi502/redfish-esxi-os-installer" target="_blank" rel="noopener">redfish-esxi-os-installer</a> å°±åŸºäº Redfish å¹¶ç»“åˆ Jenkins å®ç°äº†ä¸€å¥—è‡ªåŠ¨åŒ–å®‰è£… ESXi OS çš„æ–¹æ¡ˆï¼Œä¸‹é¢å°±è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™å¥—æ–¹æ¡ˆçš„å®‰è£…æµç¨‹å’ŒæŠ€æœ¯å®ç°ç»†èŠ‚ã€‚</p>
<h2 id="å®‰è£…æµç¨‹"><a href="#å®‰è£…æµç¨‹" class="headerlink" title="å®‰è£…æµç¨‹"></a>å®‰è£…æµç¨‹</h2><ol>
<li>è·å–ç¡¬ç›˜å’Œç½‘å¡ç¡¬ä»¶è®¾å¤‡ä¿¡æ¯</li>
<li>æ ¹æ®ç¡¬ä»¶è®¾å¤‡ä¿¡æ¯å¡«å†™é…ç½®æ–‡ä»¶</li>
<li>æ ¹æ®é…ç½®æ–‡ä»¶ç”Ÿæˆ ansible inventory æ–‡ä»¶</li>
<li>æ ¹æ®é…ç½®æ–‡ä»¶ä¸ºæ¯å°ä¸»æœºç”Ÿæˆ kickstart æ–‡ä»¶</li>
<li>å°†ç”Ÿæˆå¥½çš„ kickstart æ–‡ä»¶æ‰“åŒ…æ”¾åˆ° ESXi ISO å½“ä¸­</li>
<li>ä¸ºæ¯å°ä¸»æœºé‡æ–°æ„å»ºä¸€ä¸ª ESXi ISO æ–‡ä»¶</li>
<li>é€šè¿‡ redfish å¼¹å‡ºå·²æœ‰çš„ ISO é•œåƒ</li>
<li>é€šè¿‡ redfish æ’å…¥è¿œç¨‹çš„ ISO é•œåƒ</li>
<li>è®¾ç½® one-boot å¯åŠ¨å¼•å¯¼é¡¹ä¸ºè™šæ‹Ÿå…‰é©±</li>
<li>é‡å¯æœåŠ¡å™¨åˆ° ESXI ISO</li>
<li>ESXi installer è°ƒç”¨ Kickstart è„šæœ¬å®‰è£… OS</li>
<li>ç­‰å¾… ESXi OS å®‰è£…å®Œæˆ</li>
</ol>
<h3 id="è·å–ç¡¬ä»¶ä¿¡æ¯"><a href="#è·å–ç¡¬ä»¶ä¿¡æ¯" class="headerlink" title="è·å–ç¡¬ä»¶ä¿¡æ¯"></a>è·å–ç¡¬ä»¶ä¿¡æ¯</h3><p>è¯¥æ­¥éª¤ä¸»è¦æ˜¯è·å– ESXi OS æ‰€è¦å®‰è£…çš„ç¡¬ç›˜å’Œç®¡ç†ç½‘ç»œç½‘å¡è®¾å¤‡ä¿¡æ¯ã€‚</p>
<h4 id="è·å–ç¡¬ç›˜å‹å·-åºåˆ—å·"><a href="#è·å–ç¡¬ç›˜å‹å·-åºåˆ—å·" class="headerlink" title="è·å–ç¡¬ç›˜å‹å·/åºåˆ—å·"></a>è·å–ç¡¬ç›˜å‹å·/åºåˆ—å·</h4><p>è¦æŒ‡å®š ESXi OS å®‰è£…çš„ç¡¬ç›˜ï¼Œå¯ä»¥é€šè¿‡ç¡¬ç›˜å‹å·æˆ–åºåˆ—å·çš„æ–¹å¼ã€‚å¦‚æœå½“å‰æœåŠ¡å™¨å·²ç»å®‰è£…äº† ESXiï¼Œç™»å½•åˆ° ESXi åˆ™å¯ä»¥æŸ¥çœ‹åˆ°æ‰€å®‰è£…ç¡¬ç›˜çš„å‹å·ï¼š</p>
<ul>
<li>æ¯”å¦‚è¿™å°æˆ´å°”çš„æœåŠ¡å™¨ ESXi OS å®‰è£…çš„ç¡¬ç›˜å‹å·æ˜¯ <code>DELLBOSS VD</code>ï¼ˆæ³¨æ„ä¸­é—´çš„ç©ºæ ¼ä¸è¦çœç•¥ï¼‰ï¼›</li>
</ul>
<p><img src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-01.png" alt="img"></p>
<ul>
<li>æ¯”å¦‚è¿™å°è”æƒ³æœåŠ¡å™¨çš„ SATA DOM ç›˜å‹å·ä¸º <code>ThinkSystem M.2</code></li>
</ul>
<p><img src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-06.png" alt="img"></p>
<ul>
<li>å¦‚æœå®‰è£…çš„æ˜¯ Linuxï¼Œå¯ä»¥é€šè¿‡ <a href="https://www.smartmontools.org/" target="_blank" rel="noopener">smartctl</a> å·¥å…·æŸ¥çœ‹æ‰€è¦å®‰è£…ç¡¬ç›˜çš„å‹å·å³ <code>Device Model</code>ï¼Œæ¯”å¦‚ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-nas ~</span><br><span class="line">â•°â”€<span class="comment"># smartctl -x /dev/sdb</span></span><br><span class="line">smartctl 6.6 2017-11-05 r4594 [x86_64-linux-4.19.0-18-amd64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-17, Bruce Allen, Christian Franke, www.smartmontools.org</span><br><span class="line"></span><br><span class="line">=== START OF INFORMATION SECTION ===</span><br><span class="line">Device Model:     HGST HUH721212ALE604</span><br><span class="line">Serial Number:    5PJAMUHD</span><br><span class="line">LU WWN Device Id: 5 000cca 291e10521</span><br></pre></td></tr></table></figure>

<p><img src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-04.png" alt="img"></p>
<p>å¦‚æœæœ‰å¤šå—å‹å·ç›¸åŒçš„ç¡¬ç›˜ï¼ŒESXi ä¼šé»˜è®¤é€‰æ‹©ç¬¬ä¸€å—ï¼Œå¦‚æœè¦æŒ‡å®šæŸä¸€å—ç¡¬ç›˜åˆ™ä½¿ç”¨ WWN å·çš„æ–¹å¼ï¼Œè·å– WWN ID çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-nas ~</span><br><span class="line">â•°â”€<span class="comment"># smartctl -x /dev/sdb | sed -n "s/LU WWN Device Id:/naa./p" | tr -d ' '</span></span><br><span class="line">naa.5000cca291e10521</span><br></pre></td></tr></table></figure>

<h4 id="è·å–ç½‘å¡è®¾å¤‡å-MAC-åœ°å€"><a href="#è·å–ç½‘å¡è®¾å¤‡å-MAC-åœ°å€" class="headerlink" title="è·å–ç½‘å¡è®¾å¤‡å/MAC åœ°å€"></a>è·å–ç½‘å¡è®¾å¤‡å/MAC åœ°å€</h4><ul>
<li>å¦‚æœå½“å‰ç‰©ç†æœåŠ¡å™¨å·²ç»å®‰è£…äº† ESXiï¼Œåˆ™ç™»å½• ESXi ä¸»æœºæŸ¥çœ‹ ESXi é»˜è®¤çš„ç®¡ç†ç½‘ç»œ vSwitch0 è™šæ‹Ÿäº¤æ¢æœºæ‰€è¿æ¥çš„ç‰©ç†ç½‘å¡è®¾å¤‡åï¼Œæ¯”å¦‚è¿™å°æœåŠ¡å™¨ç½‘å¡è®¾å¤‡åä¸º <code>vmnic4</code></li>
</ul>
<p><img src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-05.png" alt="img"></p>
<ul>
<li>å¦ä¸€ç§æ–¹å¼åˆ™æ˜¯ç™»å½•æœåŠ¡å™¨çš„ IPMI ç®¡ç†é¡µé¢ï¼ŒæŸ¥çœ‹å¯¹åº”ç½‘å¡çš„ MAC åœ°å€</li>
</ul>
<p><img src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-02.png" alt="img"></p>
<h3 id="å¡«å†™é…ç½®æ–‡ä»¶"><a href="#å¡«å†™é…ç½®æ–‡ä»¶" class="headerlink" title="å¡«å†™é…ç½®æ–‡ä»¶"></a>å¡«å†™é…ç½®æ–‡ä»¶</h3><p>é€šè¿‡ä»¥ä¸Šæ–¹å¼ç¡®å®šå¥½ ESXi OS æ‰€å®‰è£…çš„ç¡¬ç›˜å‹å·æˆ–åºåˆ—å·ï¼Œä»¥åŠ ESXi é»˜è®¤ç®¡ç†ç½‘ç»œ vSwitch0 æ‰€å…³è”çš„ç‰©ç†ç½‘å¡è®¾å¤‡åæˆ– MAC åœ°å€ä¹‹åï¼Œæˆ‘ä»¬å°±å°†è¿™äº›é…ç½®å‚æ•°å¡«å…¥åˆ°è¯¥é…ç½®æ–‡ä»¶å½“ä¸­ã€‚åé¢çš„å·¥å…·ä¼šä½¿ç”¨è¯¥é…ç½®ä¸ºæ¯å°æœºå™¨ç”Ÿæˆä¸åŒçš„ kickstart æ–‡ä»¶ï¼Œåœ¨ kickstart æ–‡ä»¶ä¸­æŒ‡å®š ESXi OS å®‰è£…çš„ç¡¬ç›˜ï¼ŒESXi ç®¡ç†ç½‘ç»œæ‰€ä½¿ç”¨çš„ç½‘å¡ï¼Œä»¥åŠè®¾ç½®é™æ€ IPã€å­ç½‘æ©ç ã€ç½‘å…³ã€ä¸»æœºåç­‰å‚æ•°ã€‚</p>
<ul>
<li><a href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/config-example.yaml" target="_blank" rel="noopener">config.yaml</a></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">hosts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">ipmi:</span></span><br><span class="line">    <span class="attr">vendor:</span> <span class="string">lenovo</span>                  <span class="comment"># æœåŠ¡å™¨å‚å•†å [dell, lenovo, hpe]</span></span><br><span class="line">    <span class="attr">address:</span> <span class="number">10.172</span><span class="number">.70</span><span class="number">.186</span>          <span class="comment"># IPMI IP åœ°å€</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">username</span>              <span class="comment"># IPMI ç”¨æˆ·å</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">password</span>              <span class="comment"># IPMI å¯†ç </span></span><br><span class="line">  <span class="attr">esxi:</span></span><br><span class="line">    <span class="attr">esxi_disk:</span> <span class="string">ThinkSystem</span> <span class="string">M.2</span>      <span class="comment"># ESXi OS æ‰€å®‰è£…ç¡¬ç›˜çš„å‹å·æˆ–åºåˆ—å·</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">password</span>              <span class="comment"># ESXi çš„ root ç”¨æˆ·å¯†ç </span></span><br><span class="line">    <span class="attr">address:</span> <span class="number">10.172</span><span class="number">.69</span><span class="number">.86</span>           <span class="comment"># ESXi ç®¡ç†ç½‘ç»œ IP åœ°å€</span></span><br><span class="line">    <span class="attr">gateway:</span> <span class="number">10.172</span><span class="number">.64</span><span class="number">.1</span>            <span class="comment"># ESXi ç®¡ç†ç½‘ç»œç½‘å…³</span></span><br><span class="line">    <span class="attr">netmask:</span> <span class="number">255.255</span><span class="number">.240</span><span class="number">.0</span>          <span class="comment"># ESXi ç®¡ç†ç½‘ç»œå­ç½‘æ©ç </span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">esxi-69-86</span>            <span class="comment"># ESXi ä¸»æœºåï¼ˆå¯é€‰ï¼‰</span></span><br><span class="line">    <span class="attr">mgtnic:</span> <span class="string">vmnic4</span>                  <span class="comment"># ESXi ç®¡ç†ç½‘ç»œç½‘å¡åç§°æˆ–MAC åœ°å€</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">ipmi:</span></span><br><span class="line">    <span class="attr">vendor:</span> <span class="string">dell</span></span><br><span class="line">    <span class="attr">address:</span> <span class="number">10.172</span><span class="number">.18</span><span class="number">.191</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">username</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">password</span></span><br><span class="line">  <span class="attr">esxi:</span></span><br><span class="line">    <span class="attr">esxi_disk:</span> <span class="string">DELLBOSS</span> <span class="string">VD</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">address:</span> <span class="number">10.172</span><span class="number">.18</span><span class="number">.95</span></span><br><span class="line">    <span class="attr">gateway:</span> <span class="number">10.172</span><span class="number">.16</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">netmask:</span> <span class="number">255.255</span><span class="number">.240</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">mgtnic:</span> <span class="string">B4:96:91:A7:3F:D6</span></span><br></pre></td></tr></table></figure>

<h3 id="ç”Ÿæˆ-inventory-æ–‡ä»¶"><a href="#ç”Ÿæˆ-inventory-æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆ inventory æ–‡ä»¶"></a>ç”Ÿæˆ inventory æ–‡ä»¶</h3><p>åœ¨ <a href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/tools.sh" target="_blank" rel="noopener">tools.sh</a> è„šæœ¬ä¸­é€šè¿‡ <a href="https://github.com/mikefarah/yq" target="_blank" rel="noopener">yq</a> å‘½ä»¤è¡Œå·¥å…·è§£æ <code>config.yaml</code> é…ç½®æ–‡ä»¶ï¼Œå¾—åˆ°æ¯å°ä¸»æœºçš„é…ç½®ä¿¡æ¯ï¼Œå¹¶æ ¹æ®è¯¥ä¿¡æ¯ç”Ÿæˆä¸€ä¸ª ansible çš„ inventory æ–‡ä»¶</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">rendder_host_info</span></span>()&#123;</span><br><span class="line">    <span class="built_in">local</span> index=<span class="variable">$1</span></span><br><span class="line">    vendor=$(yq -e <span class="built_in">eval</span> <span class="string">".hosts.[<span class="variable">$index</span>].ipmi.vendor"</span> <span class="variable">$&#123;CONFIG&#125;</span>)</span><br><span class="line">    os_disk=<span class="string">"<span class="variable">$(yq -e eval ".hosts.[$index].esxi.esxi_disk" $&#123;CONFIG&#125;)</span>"</span></span><br><span class="line">    esxi_mgtnic=$(yq -e <span class="built_in">eval</span> <span class="string">".hosts.[<span class="variable">$index</span>].esxi.mgtnic"</span> <span class="variable">$&#123;CONFIG&#125;</span>)</span><br><span class="line">    esxi_address=$(yq -e <span class="built_in">eval</span> <span class="string">".hosts.[<span class="variable">$index</span>].esxi.address"</span> <span class="variable">$&#123;CONFIG&#125;</span>)</span><br><span class="line">    esxi_gateway=$(yq -e <span class="built_in">eval</span> <span class="string">".hosts.[<span class="variable">$index</span>].esxi.gateway"</span> <span class="variable">$&#123;CONFIG&#125;</span>)</span><br><span class="line">    esxi_netmask=$(yq -e <span class="built_in">eval</span> <span class="string">".hosts.[<span class="variable">$index</span>].esxi.netmask"</span> <span class="variable">$&#123;CONFIG&#125;</span>)</span><br><span class="line">    esxi_password=$(yq -e <span class="built_in">eval</span> <span class="string">".hosts.[<span class="variable">$index</span>].esxi.password"</span> <span class="variable">$&#123;CONFIG&#125;</span>)</span><br><span class="line">    ipmi_address=$(yq -e <span class="built_in">eval</span> <span class="string">".hosts.[<span class="variable">$index</span>].ipmi.address"</span> <span class="variable">$&#123;CONFIG&#125;</span>)</span><br><span class="line">    ipmi_username=$(yq -e <span class="built_in">eval</span> <span class="string">".hosts.[<span class="variable">$index</span>].ipmi.username"</span> <span class="variable">$&#123;CONFIG&#125;</span>)</span><br><span class="line">    ipmi_password=$(yq -e <span class="built_in">eval</span> <span class="string">".hosts.[<span class="variable">$index</span>].ipmi.password"</span> <span class="variable">$&#123;CONFIG&#125;</span>)</span><br><span class="line">    esxi_hostname=<span class="string">"<span class="variable">$(yq -e eval ".hosts.[$index].esxi.hostname" $&#123;CONFIG&#125; 2&gt; /dev/null || true)</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">gen_inventory</span></span>()&#123;</span><br><span class="line">    cat &lt;&lt; EOF &gt; <span class="variable">$&#123;INVENTORY&#125;</span></span><br><span class="line">_hpe_</span><br><span class="line"></span><br><span class="line">_dell_</span><br><span class="line"></span><br><span class="line">_lenovo_</span><br><span class="line"></span><br><span class="line">[all:children]</span><br><span class="line">hpe</span><br><span class="line">dell</span><br><span class="line">lenovo</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> $(seq 0 `expr <span class="variable">$&#123;nums&#125;</span> - 1`); <span class="keyword">do</span></span><br><span class="line">        rendder_host_info <span class="variable">$&#123;i&#125;</span></span><br><span class="line">        host_info=<span class="string">"<span class="variable">$&#123;ipmi_address&#125;</span> username=<span class="variable">$&#123;ipmi_username&#125;</span> password=<span class="variable">$&#123;ipmi_password&#125;</span> esxi_address=<span class="variable">$&#123;esxi_address&#125;</span> esxi_password=<span class="variable">$&#123;esxi_password&#125;</span>"</span></span><br><span class="line">        sed -i <span class="string">"/_<span class="variable">$&#123;vendor&#125;</span>_/a <span class="variable">$&#123;host_info&#125;</span>"</span> <span class="variable">$&#123;INVENTORY&#125;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    sed -i <span class="string">"s#^_dell_#[dell]#g;s#^_lenovo_#[lenovo]#g;s#_hpe_#[hpe]#g"</span> <span class="variable">$&#123;INVENTORY&#125;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"gen inventory success"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”Ÿæˆåçš„ inventory æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼Œæ ¹æ®ä¸åŒçš„å‚å•†åç§°è¿›è¡Œåˆ†ç»„</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[hpe]</span></span><br><span class="line">10.172.18.191 username=username password=password esxi_address=10.172.18.95 esxi_password=password</span><br><span class="line"></span><br><span class="line"><span class="section">[dell]</span></span><br><span class="line">10.172.18.192 username=username password=password esxi_address=10.172.18.96 esxi_password=password</span><br><span class="line"></span><br><span class="line"><span class="section">[lenovo]</span></span><br><span class="line">10.172.18.193 username=username password=password esxi_address=10.172.18.97 esxi_password=password</span><br><span class="line"></span><br><span class="line"><span class="section">[all:children]</span></span><br><span class="line">hpe</span><br><span class="line">dell</span><br><span class="line">lenovo</span><br></pre></td></tr></table></figure>

<h3 id="æ£€æŸ¥-Redfish-ç™»å½•æ˜¯å¦æ­£å¸¸"><a href="#æ£€æŸ¥-Redfish-ç™»å½•æ˜¯å¦æ­£å¸¸" class="headerlink" title="æ£€æŸ¥ Redfish ç™»å½•æ˜¯å¦æ­£å¸¸"></a>æ£€æŸ¥ Redfish ç™»å½•æ˜¯å¦æ­£å¸¸</h3><p>é€šè¿‡ Redfish çš„ GetSystemInventory å‘½ä»¤è·å–æœåŠ¡å™¨çš„ inventory æ¸…å•æ¥æ£€æŸ¥ç™»å½• Redfish æ˜¯å¦æ­£å¸¸ï¼Œç”¨æˆ·åæˆ–å¯†ç æ˜¯å¦æ­£ç¡®ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Getting</span> <span class="string">system</span> <span class="string">inventory</span></span><br><span class="line">  <span class="attr">community.general.redfish_info:</span></span><br><span class="line">    <span class="attr">category:</span> <span class="string">Systems</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">GetSystemInventory</span></span><br><span class="line">    <span class="attr">baseuri:</span> <span class="string">"<span class="template-variable">&#123;&#123; baseuri &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">"<span class="template-variable">&#123;&#123; username &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">"<span class="template-variable">&#123;&#123; password &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure>

<h3 id="ç”Ÿæˆ-kickstart-æ–‡ä»¶"><a href="#ç”Ÿæˆ-kickstart-æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆ kickstart æ–‡ä»¶"></a>ç”Ÿæˆ kickstart æ–‡ä»¶</h3><p>åœ¨ <a href="">tools.sh</a> åŒæ ·ä½¿ç”¨ yq å‘½ä»¤è¡Œå·¥å…·æ¸²æŸ“é…ç½®æ–‡ä»¶ï¼Œå¾—åˆ°æ¯å°ä¸»æœºçš„é…ç½®ä¿¡æ¯ï¼Œä¸ºæ¯å°ä¸»æœºç”Ÿæˆä¸€ä¸ªç‰¹å®šçš„ kickstart æ–‡ä»¶ã€‚</p>
<p>åœ¨ kickstart æ–‡ä»¶ä¸­æˆ‘ä»¬æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>install --overwritevmfs --firstdisk=&quot;${ESXI_DISK}&quot;</code> é…ç½® ESXi OS å®‰è£…åœ¨å“ªä¸€å—ç¡¬ç›˜ä¸Šï¼›</p>
<p>é€šè¿‡ <code>network --bootproto=static</code> ä¸º ESXi ç®¡ç†ç½‘ç»œé…ç½®é™æ€ IPã€å­ç½‘æ©ç ã€ç½‘å…³ã€ä¸»æœºåã€ç‰©ç†ç½‘å¡ç­‰å‚æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½¿ç”¨ MAC åœ°å€æŒ‡å®šç½‘å¡ï¼ŒMAC åœ°å€å¿…é¡»ä¸ºå¤§å†™ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ tr è¿›è¡Œäº†ä¸€ä¸‹å¤§å°å†™è½¬æ¢ï¼›</p>
<p>é€šè¿‡ <code>clearpart --alldrives --overwritevmfs</code> å¯ä»¥æ¸…é™¤æ‰€æœ‰ç¡¬ç›˜ä¸Šçš„åˆ†åŒºï¼Œæˆ‘ä»¬å®‰è£…æ—¶ä¸€èˆ¬æ˜¯å°†å®ƒä»¬å…¨éƒ¨æ¸…ç†æ‰ï¼Œæ–¹ä¾¿è¿›è¡Œæµ‹è¯•ï¼›</p>
<p>æœ€åå†å¼€å¯ SSH æœåŠ¡å¹¶å¼€å¯ sshServer çš„é˜²ç«å¢™ï¼Œæ–¹ä¾¿åç»­æµ‹è¯•ä½¿ç”¨ï¼›</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">gen_iso_ks</span></span>()&#123;</span><br><span class="line">    <span class="built_in">local</span> ISO_KS=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> ESXI_DISK=<span class="variable">$&#123;os_disk&#125;</span></span><br><span class="line">    <span class="built_in">local</span> IP_ADDRESS=<span class="variable">$&#123;esxi_address&#125;</span></span><br><span class="line">    <span class="built_in">local</span> NETMASK=<span class="variable">$&#123;esxi_netmask&#125;</span></span><br><span class="line">    <span class="built_in">local</span> GATEWAY=<span class="variable">$&#123;esxi_gateway&#125;</span></span><br><span class="line">    <span class="built_in">local</span> DNS_SERVER=<span class="string">"<span class="variable">$&#123;GATEWAY&#125;</span>"</span></span><br><span class="line">    <span class="built_in">local</span> PASSWORD=<span class="variable">$&#123;esxi_password&#125;</span></span><br><span class="line">    <span class="built_in">local</span> HOSTNAME=<span class="string">"<span class="variable">$(echo $&#123;esxi_hostname&#125; | sed "s/null/esxi-$&#123;esxi_address//./-&#125;/")</span>"</span></span><br><span class="line">    <span class="built_in">local</span> MGTNIC=$(<span class="built_in">echo</span> <span class="variable">$&#123;esxi_mgtnic&#125;</span> | tr <span class="string">'[a-z]'</span> <span class="string">'[A-Z]'</span> | sed <span class="string">'s/VMNIC/vmnic/g'</span>)</span><br><span class="line">    cat &lt;&lt; EOF &gt; <span class="variable">$&#123;ISO_KS&#125;</span></span><br><span class="line">vmaccepteula</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the root password for the DCUI and Tech Support Mode</span></span><br><span class="line">rootpw <span class="variable">$&#123;PASSWORD&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the keyboard</span></span><br><span class="line">keyboard <span class="string">'US Default'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># wipe exisiting VMFS store # CAREFUL!</span></span><br><span class="line">clearpart --alldrives --overwritevmfs</span><br><span class="line"></span><br><span class="line"><span class="comment"># Install on the first local disk available on machine</span></span><br><span class="line">install --overwritevmfs --firstdisk=<span class="string">"<span class="variable">$&#123;ESXI_DISK&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the network to DHCP on the first network adapter</span></span><br><span class="line">network --bootproto=static --hostname=<span class="variable">$&#123;HOSTNAME&#125;</span> --ip=<span class="variable">$&#123;IP_ADDRESS&#125;</span> --gateway=<span class="variable">$&#123;GATEWAY&#125;</span> --nameserver=<span class="variable">$&#123;DNS_SERVER&#125;</span> --netmask=<span class="variable">$&#123;NETMASK&#125;</span> --device=<span class="string">"<span class="variable">$&#123;MGTNIC&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">reboot</span><br><span class="line"></span><br><span class="line">%firstboot --interpreter=busybox</span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable SSH</span></span><br><span class="line">vim-cmd hostsvc/enable_ssh</span><br><span class="line">vim-cmd hostsvc/start_ssh</span><br><span class="line">esxcli network firewall ruleset <span class="built_in">set</span> --enabled=<span class="literal">false</span> --ruleset-id=sshServer</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é‡æ–°æ„å»º-ESXi-ISO"><a href="#é‡æ–°æ„å»º-ESXi-ISO" class="headerlink" title="é‡æ–°æ„å»º ESXi ISO"></a>é‡æ–°æ„å»º ESXi ISO</h3><p>è¿™ä¸€æ­¥çš„æ“ä½œä¸»è¦æ˜¯ä¿®æ”¹ ESXi ISO çš„å¯åŠ¨é¡¹é…ç½®ï¼Œé…ç½® ks æ–‡ä»¶çš„è·¯å¾„ï¼Œä¸»è¦æ˜¯ä¿®æ”¹ ISO æ–‡ä»¶é‡Œçš„ <code>boot.cfg</code> å’Œ <code>efi/boot/boot.cfg</code> æ–‡ä»¶ã€‚åœ¨å¯åŠ¨å‚æ•°ä¸­åŠ å…¥ <code>ks=cdrom:/KS.CFG</code> ç”¨äºæŒ‡å®š ESXi OS å®‰è£…é€šè¿‡è¯»å– kickstart è„šæœ¬çš„æ–¹å¼æ¥å®Œæˆã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i -e <span class="string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> boot.cfg</span><br><span class="line">sed -i -e <span class="string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> efi/boot/boot.cfg</span><br></pre></td></tr></table></figure>

<p>å¦å¤–åœ¨ VMware çš„ KB <a href="https://kb.vmware.com/s/article/81166" target="_blank" rel="noopener">Boot option to configure the size of ESXi system partitions (81166)</a> ä¸­ï¼Œæåˆ°è¿‡å¯ä»¥è®¾ç½® <code>systemMediaSize=small</code> æ¥è°ƒæ•´ VMFS-L åˆ†åŒºçš„å¤§å°ã€‚ESXi 7.0 ç‰ˆæœ¬ä¹‹åä¼šé»˜è®¤åˆ›å»ºä¸€ä¸ª VMFS-L åˆ†åŒºï¼Œå¦‚æœ SATA DOM ç›˜æ¯”è¾ƒå°çš„è¯æ¯”å¦‚åªæœ‰ 128Gï¼Œå»ºè®®è®¾ç½®æ­¤å‚æ•°ã€‚ä¸ç„¶å¯èƒ½ä¼šå¯¼è‡´å®‰è£…å®Œ ESXi OS ä¹‹åç£ç›˜å‰©ä½™çš„ç©ºé—´éƒ½è¢« VMFS-L åˆ†åŒºç»™å ç”¨ï¼Œå¯¼è‡´æ²¡æœ‰ä¸€ä¸ªæœ¬åœ°çš„æ•°æ®å­˜å‚¨å¯ä»¥ä½¿ç”¨ã€‚</p>
<p>ä¿®æ”¹å¥½ ESXi çš„å¯åŠ¨é…ç½®ä¹‹åï¼Œæˆ‘ä»¬å†ä½¿ç”¨ genisoimage å‘½ä»¤é‡æ–°æ„å»ºä¸€ä¸ª ESXi ISO æ–‡ä»¶ï¼Œå°†æ„å»ºå¥½çš„ ISO æ–‡ä»¶æ”¾åˆ°ä¸€ä¸ª http æ–‡ä»¶æœåŠ¡çš„ç›®å½•ä¸‹ï¼Œå¦‚ nginx çš„ <code>/usr/share/nginx/html/iso</code>ã€‚åé¢å°†ä¼šé€šè¿‡ http çš„æ–¹å¼å°† ISO æŒ‚è½½åˆ°æœåŠ¡å™¨çš„è™šæ‹Ÿå…‰é©±ä¸Šã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">rebuild_esxi_iso</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> dest_iso_mount_dir=<span class="variable">$1</span></span><br><span class="line">    <span class="built_in">local</span> dest_iso_path=<span class="variable">$2</span></span><br><span class="line">    <span class="built_in">pushd</span> <span class="variable">$&#123;dest_iso_mount_dir&#125;</span> &gt; /dev/null</span><br><span class="line">    sed -i -e <span class="string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> boot.cfg</span><br><span class="line">    sed -i -e <span class="string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> efi/boot/boot.cfg</span><br><span class="line">    genisoimage -J \</span><br><span class="line">                -R  \</span><br><span class="line">                -o <span class="variable">$&#123;dest_iso_path&#125;</span> \</span><br><span class="line">                -relaxed-filenames \</span><br><span class="line">                -b isolinux.bin \</span><br><span class="line">                -c boot.cat \</span><br><span class="line">                -no-emul-boot \</span><br><span class="line">                -boot-load-size 4 \</span><br><span class="line">                -boot-info-table \</span><br><span class="line">                -eltorito-alt-boot \</span><br><span class="line">                -eltorito-boot efiboot.img \</span><br><span class="line">                -quiet --no-emul-boot \</span><br><span class="line">                . &gt; /dev/null</span><br><span class="line">  <span class="built_in">popd</span> &gt; /dev/null</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡æ–°æ„å»ºå¥½ ESXi ISO ä¹‹åçš„ nginx ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tree /usr/share/nginx/html/iso/</span></span><br><span class="line">/usr/share/nginx/html/iso/</span><br><span class="line">â”œâ”€â”€ redfish</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ 172.20.18.191</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="comment"># é‡æ–°æ„å»ºçš„ ISO</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ 172.20.18.192</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="comment"># é‡æ–°æ„å»ºçš„ ISO</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ 172.20.18.193</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="comment"># é‡æ–°æ„å»ºçš„ ISO</span></span><br><span class="line">â”‚Â Â  â””â”€â”€ 172.20.70.186</span><br><span class="line">â”‚Â Â      â””â”€â”€ VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="comment"># é‡æ–°æ„å»ºçš„ ISO</span></span><br><span class="line">â”œâ”€â”€ VMware-VMvisor-Installer-6.7.0.update03-14320388.x86_64.iso <span class="comment"># åŸ ISO</span></span><br><span class="line">â”œâ”€â”€ VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso         <span class="comment"># åŸ ISO</span></span><br><span class="line">â””â”€â”€ VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso         <span class="comment"># åŸ ISO</span></span><br></pre></td></tr></table></figure>

<h3 id="é€šè¿‡-redfish-å¼¹å‡ºå·²æœ‰çš„-Virtual-Media"><a href="#é€šè¿‡-redfish-å¼¹å‡ºå·²æœ‰çš„-Virtual-Media" class="headerlink" title="é€šè¿‡ redfish å¼¹å‡ºå·²æœ‰çš„ Virtual Media"></a>é€šè¿‡ redfish å¼¹å‡ºå·²æœ‰çš„ Virtual Media</h3><p>redfish æ’å…¥/å¼¹å‡º ISO æ“ä½œæœ‰ç°æˆå¯ç”¨çš„ ansible æ¨¡å—å¯ä»¥ä½¿ç”¨ï¼Œä¸å¿…é‡å¤é€ è½®å­ã€‚ä¸åŒçš„æœåŠ¡å™¨å‚å•†è°ƒç”¨çš„æ¨¡å—å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œä¸è¿‡å‚æ•°åŸºæœ¬ä¸Šæ˜¯ç›¸åŒçš„ã€‚</p>
<p>å¦‚æœå½“å‰æœåŠ¡å™¨ä¸Šå·²ç»æŒ‚è½½äº†ä¸€äº›å…¶ä»–çš„ ISOï¼Œè¦å°†ä»–ä»¬å…¨éƒ¨å¼¹å‡ºæ‰è¡Œï¼Œä¸ç„¶åœ¨æŒ‚è½½ ISO çš„æ—¶å€™ä¼šå¤±è´¥é€€å‡ºï¼Œå¹¶ä¸”ä¹Ÿèƒ½é¿å…å¤šä¸ª ISO é‡å¯å¯åŠ¨çš„æ—¶å€™å¼•èµ·å†²çªå¯åŠ¨åˆ°å¦ä¸€ä¸ª ISO ä¸­ã€‚</p>
<ul>
<li>è”æƒ³æœåŠ¡å™¨çš„ VirtualMediaEject å‘½ä»¤å¯ä»¥å¼¹å‡ºæ‰€æœ‰çš„ ISO</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Lenovo</span> <span class="string">|</span> <span class="string">Eject</span> <span class="string">all</span> <span class="string">Virtual</span> <span class="string">Media</span></span><br><span class="line">  <span class="attr">community.general.xcc_redfish_command:</span></span><br><span class="line">    <span class="attr">category:</span> <span class="string">Manager</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">VirtualMediaEject</span></span><br><span class="line">    <span class="attr">baseuri:</span> <span class="string">"<span class="template-variable">&#123;&#123; baseuri &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">"<span class="template-variable">&#123;&#123; username &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">"<span class="template-variable">&#123;&#123; password &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">resource_id:</span> <span class="string">"1"</span></span><br><span class="line">  <span class="attr">when:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">inventory_hostname</span> <span class="string">in</span> <span class="string">groups['lenovo']</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mount-iso</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">umount-iso</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æˆ´å°”å’Œ HPE æœåŠ¡å™¨åœ¨å¼¹å‡º ISO çš„æ—¶å€™éœ€è¦å…ˆçŸ¥é“åŸæœ‰ ISO çš„ URLã€‚å› æ­¤å…ˆé€šè¿‡ <code>GetVirtualMedia</code> å‘½ä»¤è·å–åˆ°ä¸€ä¸ª ISO çš„ URL åˆ—è¡¨ï¼Œç„¶åå†æ ¹æ®è¿™ä¸ªåˆ—è¡¨ä¸€ä¸€å¼¹å‡ºã€‚</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Get</span> <span class="string">virtual</span> <span class="string">media</span> <span class="string">details</span></span><br><span class="line">  <span class="attr">community.general.redfish_info:</span></span><br><span class="line">    <span class="attr">baseuri:</span> <span class="string">"<span class="template-variable">&#123;&#123; baseuri &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">"<span class="template-variable">&#123;&#123; username &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">"<span class="template-variable">&#123;&#123; password &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">category:</span> <span class="string">"Manager"</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">"GetVirtualMedia"</span></span><br><span class="line">  <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mount-iso</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">umount-iso</span></span><br><span class="line">  <span class="attr">when:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">inventory_hostname</span> <span class="string">not</span> <span class="string">in</span> <span class="string">groups['lenovo']</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Eject</span> <span class="string">virtual</span> <span class="string">media</span></span><br><span class="line">  <span class="attr">community.general.redfish_command:</span></span><br><span class="line">    <span class="attr">baseuri:</span> <span class="string">"<span class="template-variable">&#123;&#123; baseuri &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">"<span class="template-variable">&#123;&#123; username &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">"<span class="template-variable">&#123;&#123; password &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">category:</span> <span class="string">"Manager"</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">"VirtualMediaEject"</span></span><br><span class="line">    <span class="attr">virtual_media:</span></span><br><span class="line">      <span class="attr">image_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; item &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123; result.redfish_facts.virtual_media.entries[0][1] | selectattr('ConnectedVia', 'equalto','URI') | map(attribute='Image') | list &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">when:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">inventory_hostname</span> <span class="string">not</span> <span class="string">in</span> <span class="string">groups['lenovo']</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mount-iso</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">umount-iso</span></span><br></pre></td></tr></table></figure>

<p>åœ¨å¼¹å‡ºä¸€ä¸ª ISO çš„æ—¶å€™éœ€è¦å…ˆçŸ¥é“ ISO çš„ URLï¼Œæ„Ÿè§‰æœ‰ç‚¹å¥‡è‘© ğŸ˜‚ã€‚æ›´åˆç†çš„åº”è¯¥æ˜¯éœ€è¦ä¸€ä¸ªæŒ‚è½½ç‚¹çš„æ ‡è¯†ï¼Œå°±åƒæ¯” Linux ä¸Šçš„æŒ‚è½½ç‚¹ã€‚åœ¨ umount æŒ‚è½½çš„è®¾å¤‡æ—¶ï¼Œåªéœ€è¦çŸ¥é“æŒ‚è½½ç‚¹å³å¯ï¼Œä¸éœ€è¦çŸ¥é“æŒ‚è½½çš„è®¾å¤‡æ˜¯ä»€ä¹ˆã€‚åœ¨ ISSUE <a href="https://github.com/ansible-collections/community.general/issues/3042" target="_blank" rel="noopener">VirtualMediaEject should not require image_url </a> ä¸­æœ‰å¤§ä½¬åé¦ˆè¿‡åœ¨å¼¹å‡º ISO çš„æ—¶å€™ä¸åº”è¯¥éœ€è¦ image urlï¼Œä¸è¿‡è¢« maintainer ç»™å¦å†³äº† ğŸ˜…ã€‚</p>
<blockquote>
<p>Yes, at least with the behavior weâ€™ve implemented today the image URL is needed since the expectation is the user is specifying the image URL for the ISO to eject. I think we need to consider some things first before making changes.</p>
<p>If the image URL is not given, then what exactly should be ejected? All virtual media your example indicates? This seems a bit heavy handed in my opinion, but others might like this behavior. Redfish itself doesnâ€™t support an â€œeject allâ€ type of operation, and I suspect the script youâ€™re referencing is either using OEM actions or is just looping on all slots and ejecting everything.</p>
<p>Should a user be allowed specify an alternative identifier (such as the â€œIdâ€ of the virtual media instance) in order to control what slot is ejected?</p>
<p>Certainly would like opinions from others for desired behavior. I do like the idea of keeping the mandatory argument list as minimal as possible, but would like to agree upon the desired behavior first.</p>
</blockquote>
<h3 id="é€šè¿‡-Redfish-æ’å…¥-ISO"><a href="#é€šè¿‡-Redfish-æ’å…¥-ISO" class="headerlink" title="é€šè¿‡ Redfish æ’å…¥ ISO"></a>é€šè¿‡ Redfish æ’å…¥ ISO</h3><ul>
<li>è”æƒ³æœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯ <code>community.general.xcc_redfish_command</code> æ¨¡å—ï¼Œredfish çš„ command ä¸º VirtualMediaInsertï¼›</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Lenovo</span> <span class="string">|</span> <span class="string">Insert</span> <span class="string">&#123;&#123;</span> <span class="string">image_url</span> <span class="string">&#125;&#125;</span> <span class="string">Virtual</span> <span class="string">Media</span></span><br><span class="line">  <span class="attr">community.general.xcc_redfish_command:</span></span><br><span class="line">    <span class="attr">category:</span> <span class="string">Manager</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">VirtualMediaInsert</span></span><br><span class="line">    <span class="attr">baseuri:</span> <span class="string">"<span class="template-variable">&#123;&#123; baseuri &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">"<span class="template-variable">&#123;&#123; username &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">"<span class="template-variable">&#123;&#123; password &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">virtual_media:</span></span><br><span class="line">      <span class="attr">image_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; image_url &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">media_types:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">CD</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">DVD</span></span><br><span class="line">    <span class="attr">resource_id:</span> <span class="string">"1"</span></span><br><span class="line">  <span class="attr">when:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">inventory_hostname</span> <span class="string">in</span> <span class="string">groups['lenovo']</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mount-iso</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æˆ´å°”å’Œ HPE æœåŠ¡å™¨æŒ‚è½½ ISO ä½¿ç”¨çš„åˆ™æ˜¯ <code>community.general.redfish_command</code> æ¨¡å—ï¼Œcommand å’Œè”æƒ³çš„ç›¸åŒï¼›</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Insert</span> <span class="string">&#123;&#123;</span> <span class="string">image_url</span> <span class="string">&#125;&#125;</span> <span class="string">ISO</span> <span class="string">as</span> <span class="string">virtual</span> <span class="string">media</span> <span class="string">device</span></span><br><span class="line"> <span class="attr">community.general.redfish_command:</span></span><br><span class="line">   <span class="attr">baseuri:</span> <span class="string">"<span class="template-variable">&#123;&#123; baseuri &#125;&#125;</span>"</span></span><br><span class="line">   <span class="attr">username:</span> <span class="string">"<span class="template-variable">&#123;&#123; username &#125;&#125;</span>"</span></span><br><span class="line">   <span class="attr">password:</span> <span class="string">"<span class="template-variable">&#123;&#123; password &#125;&#125;</span>"</span></span><br><span class="line">   <span class="attr">category:</span> <span class="string">"Manager"</span></span><br><span class="line">   <span class="attr">command:</span> <span class="string">"VirtualMediaInsert"</span></span><br><span class="line">   <span class="attr">virtual_media:</span></span><br><span class="line">     <span class="attr">image_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; image_url &#125;&#125;</span>"</span></span><br><span class="line">     <span class="attr">media_types:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">CD</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">DVD</span></span><br><span class="line"> <span class="attr">when:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">inventory_hostname</span> <span class="string">not</span> <span class="string">in</span> <span class="string">groups['lenovo']</span></span><br><span class="line"> <span class="attr">tags:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">mount-iso</span></span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¦‚æœä½¿ç”¨ <code>community.general.redfish_command</code> æ¨¡å—ä¸ºè”æƒ³çš„æœåŠ¡å™¨æŒ‚è½½ ISO ä¼šæç¤º 4xx é”™è¯¯ï¼Œå¿…é¡»ä½¿ç”¨ <code>community.general.xcc_redfish_command</code> æ¨¡å—æ‰è¡Œã€‚</p>
<h3 id="è®¾ç½®å¯åŠ¨é¡¹ä¸ºè™šæ‹Ÿå…‰é©±"><a href="#è®¾ç½®å¯åŠ¨é¡¹ä¸ºè™šæ‹Ÿå…‰é©±" class="headerlink" title="è®¾ç½®å¯åŠ¨é¡¹ä¸ºè™šæ‹Ÿå…‰é©±"></a>è®¾ç½®å¯åŠ¨é¡¹ä¸ºè™šæ‹Ÿå…‰é©±</h3><p>æ­¤è¿‡ç¨‹æ˜¯å°†æœåŠ¡å™¨çš„å¯åŠ¨é¡¹è®¾ç½®ä¸ºè™šæ‹Ÿå…‰é©±ï¼Œä¸åŒå‚å•†çš„æœåŠ¡å™¨è°ƒç”¨çš„ ansible æ¨¡å—å¯èƒ½ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚</p>
<ul>
<li>è”æƒ³å’Œ HPE æœåŠ¡å™¨</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">one-time</span> <span class="string">boot</span> <span class="string">device</span> <span class="string">to</span> <span class="string">&#123;&#123;</span> <span class="string">bootdevice</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">community.general.redfish_command:</span></span><br><span class="line">    <span class="attr">category:</span> <span class="string">Systems</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">SetOneTimeBoot</span></span><br><span class="line">    <span class="attr">bootdevice:</span> <span class="string">"<span class="template-variable">&#123;&#123; bootdevice &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">baseuri:</span> <span class="string">"<span class="template-variable">&#123;&#123; baseuri &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">"<span class="template-variable">&#123;&#123; username &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">"<span class="template-variable">&#123;&#123; password &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">when:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">inventory_hostname</span> <span class="string">not</span> <span class="string">in</span> <span class="string">groups['dell']</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æˆ´å°”æœåŠ¡å™¨</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">Dell</span> <span class="string">|</span> <span class="string">set</span> <span class="string">iDRAC</span> <span class="string">attribute</span> <span class="string">for</span> <span class="string">one-time</span> <span class="string">boot</span> <span class="string">from</span> <span class="string">virtual</span> <span class="string">CD</span></span><br><span class="line">  <span class="attr">community.general.idrac_redfish_config:</span></span><br><span class="line">    <span class="attr">baseuri:</span> <span class="string">"<span class="template-variable">&#123;&#123; baseuri &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">"<span class="template-variable">&#123;&#123; username &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">"<span class="template-variable">&#123;&#123; password &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">category:</span> <span class="string">"Manager"</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">"SetManagerAttributes"</span></span><br><span class="line">    <span class="attr">manager_attributes:</span></span><br><span class="line">      <span class="attr">ServerBoot.1.BootOnce:</span> <span class="string">"Enabled"</span></span><br><span class="line">      <span class="attr">ServerBoot.1.FirstBootDevice:</span> <span class="string">"VCD-DVD"</span></span><br><span class="line">  <span class="attr">when:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">inventory_hostname</span> <span class="string">in</span> <span class="string">groups['dell']</span></span><br></pre></td></tr></table></figure>

<h3 id="é‡å¯æœåŠ¡å™¨"><a href="#é‡å¯æœåŠ¡å™¨" class="headerlink" title="é‡å¯æœåŠ¡å™¨"></a>é‡å¯æœåŠ¡å™¨</h3><p>é‡å¯æœåŠ¡å™¨ç›´æ¥è°ƒç”¨ <code>community.general.redfish_command</code> æ¨¡å—å°±å¯ä»¥ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé‡å¯æœåŠ¡å™¨ä¹‹å‰è¦ä¿è¯æœåŠ¡å™¨å½“å‰çŠ¶æ€ä¸ºå¼€å¯çŠ¶æ€ï¼Œå› æ­¤è°ƒç”¨ä¸€ä¸‹ redfish çš„ PowerOn å‘½ä»¤å¯¹æœåŠ¡å™¨è¿›è¡Œå¼€æœºï¼Œå¦‚æœå·²å¤„äºå¼€æœºçŠ¶æ€åˆ™æ— å½±å“ï¼Œç„¶åå†è°ƒç”¨ PowerForceRestart å‘½ä»¤é‡å¯æœåŠ¡å™¨ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">Power</span> <span class="string">Force</span> <span class="string">Restart</span> <span class="string">the</span> <span class="string">host</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Turn</span> <span class="string">system</span> <span class="string">power</span> <span class="string">on</span></span><br><span class="line">    <span class="attr">community.general.redfish_command:</span></span><br><span class="line">      <span class="attr">category:</span> <span class="string">Systems</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">PowerOn</span></span><br><span class="line">      <span class="attr">baseuri:</span> <span class="string">"<span class="template-variable">&#123;&#123; baseuri &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">"<span class="template-variable">&#123;&#123; username &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">"<span class="template-variable">&#123;&#123; password &#125;&#125;</span>"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Reboot</span> <span class="string">system</span></span><br><span class="line">    <span class="attr">community.general.redfish_command:</span></span><br><span class="line">      <span class="attr">category:</span> <span class="string">Systems</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">PowerForceRestart</span></span><br><span class="line">      <span class="attr">baseuri:</span> <span class="string">"<span class="template-variable">&#123;&#123; baseuri &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">"<span class="template-variable">&#123;&#123; username &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">"<span class="template-variable">&#123;&#123; password &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">timeout:</span> <span class="number">20</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">reboot</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè¿˜æœ‰ä¼˜åŒ–çš„ç©ºé—´ï¼Œå°±æ˜¯æ ¹æ®ç”µæºçš„çŠ¶æ€å†³å®šæ˜¯é‡å¯è¿˜æ˜¯å¼€æœºï¼Œä¸è¿‡æœ‰ç‚¹éº»çƒ¦æ‡’å¾—å¼„äº† ğŸ˜…</p>
<h3 id="ç­‰å¾…-ESXi-OS-å®‰è£…å®Œæˆ"><a href="#ç­‰å¾…-ESXi-OS-å®‰è£…å®Œæˆ" class="headerlink" title="ç­‰å¾… ESXi OS å®‰è£…å®Œæˆ"></a>ç­‰å¾… ESXi OS å®‰è£…å®Œæˆ</h3><p>æœåŠ¡å™¨é‡å¯ä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡ govc å‘½ä»¤ä¸æ–­å°è¯•è¿æ¥ ESXi ä¸»æœºï¼Œå¦‚æœèƒ½å¤Ÿæ­£å¸¸è¿æ¥åˆ™è¯´æ˜ ESXi OS å·²ç»å®‰è£…å®Œæˆäº†ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ç­‰å¾… 15 åˆ†é’Ÿå·¦å³å°±èƒ½å®‰è£…å®Œæˆï¼ŒæœŸé—´éœ€è¦é‡å¯æœåŠ¡å™¨ä¸¤æ¬¡ï¼Œæ¯æ¬¡é‡å¯å¤§æ¦‚éœ€è¦ 5 åˆ†é’Ÿå·¦å³ï¼Œå®é™…ä¸Š ESXi è¿›å…¥å®‰è£…é¡µé¢åˆ°å®‰è£…å®Œæˆåªéœ€è¦ 5 åˆ†é’Ÿå·¦å³ï¼ŒæœåŠ¡å™¨å¼€æœºè‡ªæ£€å ç”¨çš„æ—¶é—´ä¼šç¨å¾®é•¿ä¸€ç‚¹ã€‚</p>
<p><img src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-03.png" alt="image-20220428210819057"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">for</span> <span class="string">the</span> <span class="string">ESXi</span> <span class="string">OS</span> <span class="string">installation</span> <span class="string">to</span> <span class="string">complete</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">esxi_username:</span> <span class="string">"root"</span></span><br><span class="line">    <span class="attr">govc_url:</span> <span class="string">"https://<span class="template-variable">&#123;&#123; esxi_username &#125;&#125;</span>:<span class="template-variable">&#123;&#123; esxi_password &#125;&#125;</span>@<span class="template-variable">&#123;&#123; esxi_address &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"Wait for <span class="template-variable">&#123;&#123; inventory_hostname &#125;&#125;</span> install ESXi <span class="template-variable">&#123;&#123; esxi_address &#125;&#125;</span> host to be complete"</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">"govc about -k=true -u=<span class="template-variable">&#123;&#123; govc_url&#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">retries:</span> <span class="number">60</span></span><br><span class="line">    <span class="attr">delay:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">    <span class="attr">until:</span> <span class="string">result.rc</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">post-check</span></span><br></pre></td></tr></table></figure>

<h2 id="Makefile-å°è£…"><a href="#Makefile-å°è£…" class="headerlink" title="Makefile å°è£…"></a>Makefile å°è£…</h2><p>ä¸ºäº†æ–¹ä¾¿æ“ä½œï¼Œå°†ä¸Šè¿°æµç¨‹ä½¿ç”¨ Makefile è¿›è¡Œå°è£…ä¸€ä¸‹ï¼Œå¦‚æœä¸é…ç½® Jenkins Job çš„è¯ï¼Œå¯ä»¥åœ¨æœ¬åœ°å¡«å†™å¥½ <code>config.yaml</code> é…ç½®æ–‡ä»¶ï¼Œç„¶åè¿è¡Œ make å‘½ä»¤æ¥è¿›è¡Œç›¸å…³æ“ä½œã€‚</p>
<h3 id="vars"><a href="#vars" class="headerlink" title="vars"></a>vars</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SRC_ISO_DIR     ?= /usr/share/nginx/html/iso</span><br><span class="line">HTTP_DIR        ?= /usr/share/nginx/html/iso/redfish</span><br><span class="line">HTTP_URL        ?= http://172.20.17.20/iso/redfish</span><br><span class="line">ESXI_ISO        ?= VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso</span><br><span class="line"></span><br><span class="line">SRC_ISO_DIR   <span class="comment"># åŸ ESXi ISO çš„å­˜æ”¾ç›®å½•</span></span><br><span class="line">ESXI_ISO      <span class="comment"># ESXi ISO çš„æ–‡ä»¶åï¼Œå¦‚ VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso</span></span><br><span class="line">HTTP_DIR      <span class="comment"># HTTP æœåŠ¡å™¨çš„é™æ€æ–‡ä»¶å­˜æ”¾ç›®å½•ï¼Œæ¯”å¦‚ /usr/share/nginx/html æˆ– /var/www/html</span></span><br><span class="line">              <span class="comment"># é‡æ–°æ„å»ºå¥½çš„ ISO æ–‡ä»¶å°†å­˜æ”¾åˆ°è¿™ä¸ªç›®å½•å½“ä¸­</span></span><br><span class="line">HTTP_URL      <span class="comment"># HTTP æœåŠ¡å™¨çš„ URL åœ°å€ï¼Œæ¯”å¦‚ http://172.20.29.171/iso/redfish</span></span><br></pre></td></tr></table></figure>

<h3 id="target"><a href="#target" class="headerlink" title="target"></a>target</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">make</span> <span class="string">docke-run</span>  <span class="comment"># åœ¨ docker å®¹å™¨é‡Œè¿è¡Œæ‰€æœ‰æ“ä½œï¼Œå¥½å¤„å°±æ˜¯ä¸ç”¨å†å®‰è£…ä¸€å † ansible ç­‰å·¥å…·çš„ä¾èµ–</span></span><br><span class="line"><span class="string">make</span> <span class="string">inventory</span>  <span class="comment"># æ ¹æ® config.yaml é…ç½®æ–‡ä»¶ç”Ÿæˆ ansible çš„ inventory æ–‡ä»¶</span></span><br><span class="line"><span class="string">make</span> <span class="string">pre-check</span>  <span class="comment"># æ£€æŸ¥ç”Ÿæˆçš„ inventory æ–‡ä»¶æ˜¯å¦æ­£ç¡®ï¼Œè¿æ¥ redfish æ˜¯å¦æ­£å¸¸</span></span><br><span class="line"><span class="string">make</span> <span class="string">build-iso</span>  <span class="comment"># ä¸ºæ¯å°ä¸»æœºç”Ÿæˆ kickstart æ–‡ä»¶å¹¶é‡æ–°æ„å»º ESXi OS ISO æ–‡ä»¶</span></span><br><span class="line"><span class="string">make</span> <span class="string">mount-iso</span>  <span class="comment"># å°†æ„å»ºå¥½çš„ ISO æ–‡ä»¶é€šè¿‡ redfish æŒ‚è½½åˆ°ç‰©ç†æœåŠ¡å™¨çš„è™šæ‹Ÿå…‰é©±ï¼Œå¹¶è®¾å¤‡å¯åŠ¨é¡¹</span></span><br><span class="line"><span class="string">make</span> <span class="string">reboot</span>     <span class="comment"># é‡å¯æœåŠ¡å™¨ï¼Œè¿›å…¥åˆ°è™šæ‹Ÿå…‰é©±å¯åŠ¨ ESXi inatller</span></span><br><span class="line"><span class="string">make</span> <span class="string">post-check</span> <span class="comment"># ç­‰å¾… ESXi OS å®‰è£…å®Œæˆ</span></span><br><span class="line"><span class="string">make</span> <span class="string">install-os</span> <span class="comment"># è¿è¡Œ pre-check, mount-iso, reboot, post-check</span></span><br></pre></td></tr></table></figure>

<h2 id="Jenkins-Job"><a href="#Jenkins-Job" class="headerlink" title="Jenkins Job"></a>Jenkins Job</h2><p>è™½ç„¶åœ¨ Makefile é‡Œå°è£…äº†æ¯”è¾ƒæ–¹ä¾¿çš„å‘½ä»¤æ“ä½œï¼Œä½†æ˜¯å¯¹äºä¸å¤ªç†Ÿæ‚‰è¿™å¥—æµç¨‹çš„ä½¿ç”¨äººå‘˜æ¥è®²è¿˜æ˜¯ä¸å¤Ÿä¾¿æ·ã€‚å¯¹äºä½¿ç”¨äººå‘˜æ¥è®²ä¸éœ€è¦çŸ¥é“å…·ä½“çš„æµç¨‹æ˜¯ä»€ä¹ˆï¼Œå› æ­¤è¿˜éœ€è¦æä¾›ä¸€ä¸ªæ›´ä¸ºä¾¿æ·çš„å…¥å£æ¥ä½¿ç”¨è¿™å¥—å·¥å…·ï¼Œå¯¹å¤–å±è”½æ‰æŠ€æœ¯å®ç°çš„ç»†èŠ‚ã€‚</p>
<p>åœ¨æˆ‘ä»¬å†…éƒ¨ï¼Œè€ç‰Œ CI å·¥å…· Jenkins å¤§å”ååˆ†å—æ¬¢è¿ï¼Œä½¿ç”¨çš„ååˆ†æ™®éã€‚ä¹‹å‰åŒäº‹ä¹Ÿå¸¸è°ƒä¾ƒï¼š<code>æˆ‘ä»¬å†…éƒ¨çš„ Jenkins è™½ç„¶è¾¾ä¸åˆ°äººæ‰‹ä¸€ä¸ªçš„æ•°é‡ï¼Œä½†æ¯ä¸ªå›¢é˜Ÿæœ‰ä¸¤ä¸‰ä¸ªè‡ªå·±çš„ Jenkins å†æ­£å¸¸ä¸è¿‡äº†</code>ğŸ¤£ã€‚å› æ­¤æä¾›äº†ä¸€ä¸ª Jenkins Job æ¥è¿è¡Œè¿™å¥—å®‰è£…å·¥å…·å†å®Œç¾ä¸è¿‡äº†ã€‚è¿™æ ·ä½¿ç”¨äººå‘˜å°±ä¸ç”¨å† clone repo ä»£ç ï¼Œå‚»ä¹ä¹åœ°è¿è¡Œä¸€äº› make å‘½ä»¤äº†ï¼Œæ¯•ç«Ÿä¸€ä¸ª Jenkins build çš„æŒ‰é’®æ¯” make å‘½ä»¤å¥½å¥½ç”¨å¾—å¤ªå¤šã€‚</p>
<p>æˆ‘ä»¬ç»„çš„ Jenkins æ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯ä½¿ç”¨ kubernetes Pod ä½œä¸ºåŠ¨æ€ Jenkins slave èŠ‚ç‚¹ï¼Œå³æ¯è¿è¡Œä¸€ä¸ª Jenkins Job å°±ä¼šæ ¹æ®å®šä¹‰çš„ Pod æ¨¡ç‰ˆåˆ›å»ºä¸€ä¸ª Pod åˆ°æŒ‡å®šçš„ Kubernetes é›†ç¾¤ä¸­ï¼Œç„¶å Jenkinsfile ä¸­å®šä¹‰çš„ stage éƒ½ä¼šè¿è¡Œåœ¨è¿™ä¸ª Pod å®¹å™¨å†…ã€‚è¿™äº›å†…å®¹å¯ä»¥å‚è€ƒä¸€ä¸‹æˆ‘ä¹‹å‰å†™çš„ <a href="https://blog.k8s.li/jenkins-with-kubernetes.html">Jenkins å¤§å”ä¸ kubernetes èˆ¹é•¿æ‰‹ç‰µæ‰‹ ğŸ§‘â€ğŸ¤â€ğŸ§‘</a>ã€‚</p>
<h3 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h3><p>å¦‚æœä½ ç†Ÿæ‚‰ Jenkins çš„è¯ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ª Jenkins Job ï¼Œå¹¶åœ¨ Job ä¸­è®¾ç½®å¥½å¦‚ä¸‹å‡ ä¸ªå‚æ•°ï¼Œå¹¶å°†è¿™ä¸ª <a href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/jenkins/Jenkinsfile" target="_blank" rel="noopener">Jenkinsfile</a> ä¸­çš„å†…å®¹å¤åˆ¶åˆ° Jenkins Job çš„é…ç½®ä¸­ã€‚</p>
<table>
<thead>
<tr>
<th>å‚æ•°å</th>
<th>å‚æ•°ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>esxi_iso</td>
<td>ArrayList</td>
<td>ESXi ISO æ–‡ä»¶ååˆ—è¡¨</td>
</tr>
<tr>
<td>http_server</td>
<td>String</td>
<td>HTTP æœåŠ¡å™¨çš„ IP åœ°å€</td>
</tr>
<tr>
<td>http_dir</td>
<td>String</td>
<td>HTTP æœåŠ¡å™¨çš„æ–‡ä»¶ç›®å½•è·¯å¾„</td>
</tr>
<tr>
<td>config_yaml</td>
<td>Text</td>
<td>config.yaml é…ç½®æ–‡ä»¶å†…å®¹</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">// params of jenkins job</span><br><span class="line">def ESXI_ISO = params.esxi_iso</span><br><span class="line">def CONFIG_YAML = params.config_yaml</span><br><span class="line">def HTTP_SERVER = params.http_server</span><br><span class="line"></span><br><span class="line">// default params <span class="keyword">for</span> the job</span><br><span class="line">def HTTP_DIR  = params.http_dir ?: <span class="string">"/usr/share/nginx/html"</span></span><br><span class="line">def SRC_ISO_DIR = params.src_iso_dir ?: <span class="string">"<span class="variable">$&#123;HTTP_DIR&#125;</span>/iso"</span></span><br><span class="line">def DEST_ISO_DIR = params.dest_iso_dir ?: <span class="string">"<span class="variable">$&#123;HTTP_DIR&#125;</span>/iso/redfish"</span></span><br><span class="line"></span><br><span class="line">def WORKSPACE = env.WORKSPACE</span><br><span class="line">def JOB_NAME = <span class="string">"<span class="variable">$&#123;env.JOB_BASE_NAME&#125;</span>"</span></span><br><span class="line">def BUILD_NUMBER = <span class="string">"<span class="variable">$&#123;env.BUILD_NUMBER&#125;</span>"</span></span><br><span class="line">def POD_NAME = <span class="string">"jenkins-<span class="variable">$&#123;JOB_NAME&#125;</span>-<span class="variable">$&#123;BUILD_NUMBER&#125;</span>"</span></span><br><span class="line">def POD_IMAGE = params.pod_image ?: <span class="string">"ghcr.io/muzi502/redfish-esxi-os-installer:v0.1.0-alpha.1"</span></span><br><span class="line">// Kubernetes pod template to run.</span><br><span class="line">podTemplate(</span><br><span class="line">    cloud: <span class="string">"kubernetes"</span>,</span><br><span class="line">    namespace: <span class="string">"default"</span>,</span><br><span class="line">    name: POD_NAME,</span><br><span class="line">    label: POD_NAME,</span><br><span class="line">    yaml: <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: runner</span></span><br><span class="line"><span class="string">    image: <span class="variable">$&#123;POD_IMAGE&#125;</span></span></span><br><span class="line"><span class="string">    imagePullPolicy: Always</span></span><br><span class="line"><span class="string">    tty: true</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: http-dir</span></span><br><span class="line"><span class="string">      mountPath: <span class="variable">$&#123;HTTP_DIR&#125;</span></span></span><br><span class="line"><span class="string">    securityContext:</span></span><br><span class="line"><span class="string">      privileged: true</span></span><br><span class="line"><span class="string">    env:</span></span><br><span class="line"><span class="string">    - name: ESXI_ISO</span></span><br><span class="line"><span class="string">      value: <span class="variable">$&#123;ESXI_ISO&#125;</span></span></span><br><span class="line"><span class="string">    - name: SRC_ISO_DIR</span></span><br><span class="line"><span class="string">      value: <span class="variable">$&#123;SRC_ISO_DIR&#125;</span></span></span><br><span class="line"><span class="string">    - name: HTTP_DIR</span></span><br><span class="line"><span class="string">      value: <span class="variable">$&#123;DEST_ISO_DIR&#125;</span></span></span><br><span class="line"><span class="string">    - name: HTTP_URL</span></span><br><span class="line"><span class="string">      value: http://<span class="variable">$&#123;HTTP_SERVER&#125;</span>/iso/redfish</span></span><br><span class="line"><span class="string">  - name: jnlp</span></span><br><span class="line"><span class="string">    args: ["</span>\$(JENKINS_SECRET)<span class="string">", "</span>\$(JENKINS_NAME)<span class="string">"]</span></span><br><span class="line"><span class="string">    image: "</span>jenkins/inbound-agent:4.11.2-4-alpine<span class="string">"</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">  - name: http-dir</span></span><br><span class="line"><span class="string">    nfs:</span></span><br><span class="line"><span class="string">      server: <span class="variable">$&#123;HTTP_SERVER&#125;</span></span></span><br><span class="line"><span class="string">      path: <span class="variable">$&#123;HTTP_DIR&#125;</span></span></span><br><span class="line"><span class="string">"</span><span class="string">""</span>,</span><br><span class="line">) &#123;</span><br><span class="line">    node(POD_NAME) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            container(<span class="string">"runner"</span>) &#123;</span><br><span class="line">                writeFile file: <span class="string">'config.yaml'</span>, text: <span class="string">"<span class="variable">$&#123;CONFIG_YAML&#125;</span>"</span></span><br><span class="line">                stage(<span class="string">"Inventory"</span>) &#123;</span><br><span class="line">                    sh <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">                    cp -rf /ansible/* .</span></span><br><span class="line"><span class="string">                    make inventory</span></span><br><span class="line"><span class="string">                    "</span><span class="string">""</span></span><br><span class="line">                &#125;</span><br><span class="line">                stage(<span class="string">"Precheck"</span>) &#123;</span><br><span class="line">                    sh <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">                    make pre-check</span></span><br><span class="line"><span class="string">                    "</span><span class="string">""</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (params.build_iso) &#123;</span><br><span class="line">                    stage(<span class="string">"Build-iso"</span>) &#123;</span><br><span class="line">                        sh <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">                        make build-iso</span></span><br><span class="line"><span class="string">                        "</span><span class="string">""</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                stage(<span class="string">"Mount-iso"</span>) &#123;</span><br><span class="line">                    sh <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">                    make mount-iso</span></span><br><span class="line"><span class="string">                    "</span><span class="string">""</span></span><br><span class="line">                &#125;</span><br><span class="line">                stage(<span class="string">"Reboot"</span>) &#123;</span><br><span class="line">                    sh <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">                    make reboot</span></span><br><span class="line"><span class="string">                    sleep 60</span></span><br><span class="line"><span class="string">                    "</span><span class="string">""</span></span><br><span class="line">                &#125;</span><br><span class="line">                stage(<span class="string">"Postcheck"</span>) &#123;</span><br><span class="line">                    sh <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">                    make post-check</span></span><br><span class="line"><span class="string">                    "</span><span class="string">""</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            stage(<span class="string">"Success"</span>)&#123;</span><br><span class="line">                MESSAGE = <span class="string">"ã€Succeedã€‘Jenkins Job <span class="variable">$&#123;JOB_NAME&#125;</span>-<span class="variable">$&#123;BUILD_NUMBER&#125;</span> Link: <span class="variable">$&#123;BUILD_URL&#125;</span>"</span></span><br><span class="line">                // slackSend(channel: <span class="string">'$&#123;SLACK_CHANNE&#125;'</span>, color: <span class="string">'good'</span>, message: <span class="string">"<span class="variable">$&#123;MESSAGE&#125;</span>"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            MESSAGE = <span class="string">"ã€Failedã€‘Jenkins Job <span class="variable">$&#123;JOB_NAME&#125;</span>-<span class="variable">$&#123;BUILD_NUMBER&#125;</span> Link: <span class="variable">$&#123;BUILD_URL&#125;</span>"</span></span><br><span class="line">            // slackSend(channel: <span class="string">'$&#123;SLACK_CHANNE&#125;'</span>, color: <span class="string">'warning'</span>, message: <span class="string">"<span class="variable">$&#123;MESSAGE&#125;</span>"</span>)</span><br><span class="line">            throw e</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…å‚è€ƒ <a href="https://stackoverflow.com/questions/8424228/export-import-jobs-in-jenkins" target="_blank" rel="noopener">Export/import jobs in Jenkins</a> å°†è¿™ä¸ª <a href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/jenkins/config.xml" target="_blank" rel="noopener">Job</a> çš„é…ç½®å¯¼å…¥åˆ° Jenkins å½“ä¸­ï¼Œå¹¶è®¾ç½®å¥½ä¸Šé¢æåˆ°çš„å‡ ä¸ªå‚æ•°ã€‚</p>
<p><img src="https://p.k8s.li/2022-04-30-redfish-esxi-os-installer-07.png" alt="image-20220429201859704"></p>
<h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><h3 id="ç¡¬ä»¶ä¿¡æ¯æ”¶é›†"><a href="#ç¡¬ä»¶ä¿¡æ¯æ”¶é›†" class="headerlink" title="ç¡¬ä»¶ä¿¡æ¯æ”¶é›†"></a>ç¡¬ä»¶ä¿¡æ¯æ”¶é›†</h3><p>æ•´ä½“ä¸Šè¯¥æ–¹æ¡ˆæœ‰ä¸€ç‚¹ä¸è¶³çš„å°±æ˜¯éœ€è¦äººä¸ºåœ°ç¡®è®¤ ESXi OS å®‰è£…ç¡¬ç›˜çš„å‹å·/åºåˆ—å·ï¼Œä»¥åŠ ESXi ç®¡ç†ç½‘ç»œæ‰€ä½¿ç”¨çš„ç‰©ç†ç½‘å¡ã€‚å…¶å®æ˜¯å¯ä»¥é€šè¿‡ redfish çš„ API æ¥ç»Ÿä¸€åœ°è·å–ï¼Œç„¶åå†æ ¹æ®è¿™äº›ç¡¬ä»¶è®¾å¤‡ä¿¡æ¯è¿›è¡Œé€‰æ‹©ï¼Œè¿™æ ·å°±ä¸ç”¨ç™»å½•åˆ°æ¯ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šè¿›è¡ŒæŸ¥çœ‹äº†ã€‚</p>
<p>ä½†è€ƒè™‘åˆ°å®ç°æˆæœ¬ï¼Œå·¥ä½œé‡ä¼šç¿»å€ï¼Œè€Œä¸”æˆ‘ä»¬çš„æœåŠ¡å™¨éƒ½æ˜¯å›ºå®šçš„ï¼Œåªè¦äººä¸ºç¡®è®¤ä¸€æ¬¡å°±å¯ä»¥ï¼Œä¸‹ä¸€æ¬¡é‡è£… ESXi OS çš„æ—¶å€™åªéœ€è¦å¤åˆ¶ç²˜è´´ä¸Šä¸€æ¬¡çš„ç¡¬ä»¶é…ç½®å³å¯ï¼Œæ‰€ä»¥ç›®å‰å¹¶æ²¡æœ‰æ‰“ç®—åšè·å–ç¡¬ä»¶ä¿¡æ¯çš„åŠŸèƒ½ã€‚</p>
<p>è€Œä¸”å³ä¾¿æ˜¯å°†ç¡¬ä»¶ä¿¡æ¯è·å–å‡ºæ¥ï¼Œå¦‚æœæ²¡æœ‰ä¸€ä¸ªå¯è§†åŒ–çš„ Web UI å±•ç¤ºè¿™äº›è®¾å¤‡ä¿¡æ¯ï¼Œä¹Ÿå¾ˆéš¾ä»ä¸€å †ç¡¬ä»¶æ•°æ®ä¸­æ‰¾å‡ºç‰¹å®šçš„è®¾å¤‡ï¼Œå¯¹è¿™äº›æ•°æ®è¿›è¡Œ UI å±•ç¤ºå·¥ä½œé‡ä¹Ÿä¼šç¿»å€ï¼Œå› æ­¤æš‚æ—¶ä¸å†è€ƒè™‘è¿™ä¸ªåŠŸèƒ½äº†ã€‚</p>
<h3 id="æŒ‚è½½-ISO-ä¹‹å‰å…ˆç¡®ä¿-ISO-å­˜åœ¨"><a href="#æŒ‚è½½-ISO-ä¹‹å‰å…ˆç¡®ä¿-ISO-å­˜åœ¨" class="headerlink" title="æŒ‚è½½ ISO ä¹‹å‰å…ˆç¡®ä¿ ISO å­˜åœ¨"></a>æŒ‚è½½ ISO ä¹‹å‰å…ˆç¡®ä¿ ISO å­˜åœ¨</h3><p>æœ‰äº›æœåŠ¡å™¨æ¯”å¦‚ HPE åœ¨æŒ‚è½½ä¸€ä¸ªä¸å­˜åœ¨çš„ ISO æ—¶å¹¶ä¸ä¼šæŠ¥é”™ï¼Œå½“æ—¶æˆ‘æ’æŸ¥äº†å¥½ä¹…æ‰å‘ç° ğŸ˜‚ï¼Œæˆ‘ä¸€ç›´ä»¥ä¸ºæ˜¯å¯åŠ¨é¡¹è®¾ç½®çš„é—®é¢˜ã€‚å› æ­¤åœ¨æŒ‚è½½ ISO ä¹‹å‰æˆ‘ä»¬å¯ä»¥é€šè¿‡ curl çš„æ–¹å¼æ£€æŸ¥ä¸€ä¸‹ ISO çš„ URL æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœ 404 ä¸å­˜åœ¨çš„è¯å°±æŠ¥é”™é€€å‡ºã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">Mount</span>  <span class="string">&#123;&#123;</span> <span class="string">image_url</span> <span class="string">&#125;&#125;</span> <span class="string">ISO</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">&#123;&#123;</span> <span class="string">image_url</span> <span class="string">&#125;&#125;</span> <span class="string">ISO</span> <span class="string">file</span> <span class="string">exists</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">"curl -sI <span class="template-variable">&#123;&#123; image_url &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">response</span></span><br><span class="line">    <span class="attr">failed_when:</span> <span class="string">"'200 OK' not in response.stdout or '404 Not Found' in response.stdout"</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mount-iso</span></span><br></pre></td></tr></table></figure>

<h3 id="å•ç‹¬æ„å»º-Kickstart-ISO"><a href="#å•ç‹¬æ„å»º-Kickstart-ISO" class="headerlink" title="å•ç‹¬æ„å»º Kickstart ISO"></a>å•ç‹¬æ„å»º Kickstart ISO</h3><p>ç›®å‰çš„æ–¹æ¡ˆæ˜¯ä¸ºå°† ESXi çš„ kickstart æ–‡ä»¶ KS.CFG æ”¾åˆ°äº† ESXi OS ISO é•œåƒé‡Œï¼Œç”±äºæ¯å°ä¸»æœºçš„ kickstart æ–‡ä»¶éƒ½ä¸ç›¸åŒï¼Œè¿™å°±éœ€è¦ä¸ºæ¯å°æœåŠ¡å™¨æ„å»ºä¸€ä¸ª ISO æ–‡ä»¶ï¼Œå¦‚æœæœºå™¨æ•°é‡æ¯”è¾ƒå¤šçš„è¯ï¼Œå¯èƒ½ä¼šå ç”¨å¤§é‡çš„ç£ç›˜å­˜å‚¨ç©ºé—´ï¼Œæ•ˆç‡ä¸Šä¼šæœ‰äº›é—®é¢˜ã€‚ä¹Ÿå°è¯•è¿‡å°† kickstart æ–‡ä»¶å•ç‹¬æ”¾åˆ°ä¸€ä¸ª ISO ä¸­ï¼Œå¤§ä½“çš„æ€è·¯å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ„å»º kickstart ISO æ–‡ä»¶ï¼Œ-V å‚æ•°æŒ‡å®š ISO çš„ label åç§°ä¸º KS</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ genisoimage -o /tmp/ks.iso -V KS ks.cfg</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹ ESXi å¯åŠ¨é…ç½®ï¼Œå°† ks æ–‡ä»¶è·¯å¾„é€šè¿‡ label çš„æ–¹å¼æŒ‡å‘åˆšæ‰æ„å»ºçš„ ISO</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i -e <span class="string">'s#cdromBoot#ks=hd:KS:/ks.cfg systemMediaSize=small#g'</span> boot.cfg</span><br><span class="line">$ sed -i -e <span class="string">'s#cdromBoot#ks=hd:KS:/ks.cfg systemMediaSize=small#g'</span> efi/boot/boot.cfg</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹ä¸€ä¸‹ playbookï¼Œæ’å…¥ä¸¤ä¸ª ISO</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Insert</span> <span class="string">&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">ISO</span> <span class="string">as</span> <span class="string">virtual</span> <span class="string">media</span> <span class="string">device</span></span><br><span class="line">  <span class="attr">community.general.redfish_command:</span></span><br><span class="line">    <span class="attr">baseuri:</span> <span class="string">"<span class="template-variable">&#123;&#123; baseuri &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">"<span class="template-variable">&#123;&#123; username &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">"<span class="template-variable">&#123;&#123; password &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">category:</span> <span class="string">"Manager"</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">"VirtualMediaInsert"</span></span><br><span class="line">    <span class="attr">virtual_media:</span></span><br><span class="line">      <span class="attr">image_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; item &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">media_types:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">CD</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">DVD</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; esxi_iso_url &#125;&#125;</span>"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; ks_iso_url &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">when:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">inventory_hostname</span> <span class="string">not</span> <span class="string">in</span> <span class="string">groups['lenovo']</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mount-iso</span></span><br></pre></td></tr></table></figure>

<p>ç­‰è¿™äº›éƒ½ä¿®æ”¹å¥½ä¹‹åæˆ‘æ»¡æ€€æœŸå¾…åœ°è¿è¡Œäº† make mount-iso å‘½ä»¤ç­‰åˆ°å¥‡è¿¹çš„å‘ç”Ÿï¼Œæ²¡æƒ³åˆ°ç›´æ¥ç¿»è½¦äº†ï¼ä¸æ”¯æŒæŒ‚è½½ä¸¤ä¸ª ISOï¼Œç™½ç™½é«˜å…´ä¸€åœºï¼ŒçœŸæ°”äºº ğŸ˜¡</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">TASK</span> <span class="string">[Insert</span> <span class="string">&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">ISO</span> <span class="string">as</span> <span class="string">virtual</span> <span class="string">media</span> <span class="string">device]</span> <span class="string">******************************************************************************************</span></span><br><span class="line"><span class="attr">changed:</span> <span class="string">[10.172.18.191]</span> <span class="string">=&gt;</span> <span class="string">(item=http://10.172.29.171/iso/redfish/VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso)</span></span><br><span class="line"><span class="attr">changed:</span> <span class="string">[10.172.18.192]</span> <span class="string">=&gt;</span> <span class="string">(item=http://10.172.29.171/iso/redfish/VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso)</span></span><br><span class="line"><span class="attr">changed:</span> <span class="string">[10.172.18.193]</span> <span class="string">=&gt;</span> <span class="string">(item=http://10.172.29.171/iso/redfish/VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso)</span></span><br><span class="line"><span class="attr">failed:</span> <span class="string">[10.172.18.193]</span> <span class="string">(item=http://10.172.29.171/iso/redfish/10.172.18.193/ks.iso)</span> <span class="string">=&gt;</span> <span class="string">&#123;"ansible_loop_var":</span> <span class="string">"item"</span><span class="string">,</span> <span class="attr">"changed":</span> <span class="literal">false</span><span class="string">,</span> <span class="attr">"item":</span> <span class="string">"http://10.172.29.171/iso/redfish/10.172.18.193/ks.iso"</span><span class="string">,</span> <span class="attr">"msg":</span> <span class="string">"Unable to find an available VirtualMedia resource supporting ['CD', 'DVD']"</span><span class="string">&#125;</span></span><br><span class="line"><span class="attr">failed:</span> <span class="string">[10.172.18.192]</span> <span class="string">(item=http://10.172.29.171/iso/redfish/10.172.18.192/ks.iso)</span> <span class="string">=&gt;</span> <span class="string">&#123;"ansible_loop_var":</span> <span class="string">"item"</span><span class="string">,</span> <span class="attr">"changed":</span> <span class="literal">false</span><span class="string">,</span> <span class="attr">"item":</span> <span class="string">"http://10.172.29.171/iso/redfish/10.172.18.192/ks.iso"</span><span class="string">,</span> <span class="attr">"msg":</span> <span class="string">"Unable to find an available VirtualMedia resource supporting ['CD', 'DVD']"</span><span class="string">&#125;</span></span><br><span class="line"><span class="attr">failed:</span> <span class="string">[10.172.18.191]</span> <span class="string">(item=http://10.172.29.171/iso/redfish/10.172.18.191/ks.iso)</span> <span class="string">=&gt;</span> <span class="string">&#123;"ansible_loop_var":</span> <span class="string">"item"</span><span class="string">,</span> <span class="attr">"changed":</span> <span class="literal">false</span><span class="string">,</span> <span class="attr">"item":</span> <span class="string">"http://10.172.29.171/iso/redfish/10.172.18.191/ks.iso"</span><span class="string">,</span> <span class="attr">"msg":</span> <span class="string">"Unable to find an available VirtualMedia resource supporting ['CD', 'DVD']"</span><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>æˆ–è®¸å°† ISO æ›¿æ¢æˆè½¯ç›˜  floppy  çš„æ–¹å¼å¯èƒ½è¡Œå¾—é€šï¼Œä¸è¿‡å½“æˆ‘çœ‹äº† <a href="https://stackoverflow.com/questions/11202706/create-a-virtual-floppy-image-without-mount" target="_blank" rel="noopener">create-a-virtual-floppy-image-without-mount</a> åç›´æ¥æŠŠæˆ‘æ•´ä¸ä¼šäº†ï¼Œæ²¡æƒ³åˆ›å»ºä¸€ä¸ªè½¯ç›˜æ–‡ä»¶åˆ°è¿™ä¹ˆéº»çƒ¦ï¼Œè¿˜æ˜¯ç›´æ¥æ”¾å¼ƒè¯¥æ–¹æ¡ˆå§ ğŸŒšã€‚</p>
<p>å¤šè¯´ä¸€å¥ï¼Œä¹‹æ‰€ä»¥æƒ³åˆ°ä½¿ç”¨è½¯ç›˜çš„æ–¹å¼æ˜¯å› ä¸ºä¹‹å‰åœ¨ç© <a href="https://github.com/hashicorp/packer" target="_blank" rel="noopener">Packer</a> çš„æ—¶å€™ï¼Œç ”ç©¶è¿‡å®ƒå°±æ˜¯å°† kickstart æ–‡ä»¶åˆ¶ä½œæˆä¸€ä¸ªè½¯ç›˜ï¼Œæ’å…¥åˆ°è™šæ‹Ÿæœºä¸­ã€‚è™šæ‹Ÿæœºå¼€æœºåé€šè¿‡ vCenter API å‘é€é”®ç›˜è¾“å…¥ï¼Œæ’å…¥ kickstart çš„è·¯å¾„ï¼Œanaconda æ‰§è¡Œè‡ªåŠ¨åŒ–å®‰è£… OSã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">==&gt; vsphere-iso-base: Creating VM...</span><br><span class="line">==&gt; vsphere-iso-base: Customizing hardware...</span><br><span class="line">==&gt; vsphere-iso-base: Mounting ISO images...</span><br><span class="line">==&gt; vsphere-iso-base: Adding configuration parameters...</span><br><span class="line">==&gt; vsphere-iso-base: Creating floppy disk...</span><br><span class="line">    vsphere-iso-base: Copying files flatly from floppy_files</span><br><span class="line">    vsphere-iso-base: Done copying files from floppy_files</span><br><span class="line">    vsphere-iso-base: Collecting paths from floppy_dirs</span><br><span class="line">    vsphere-iso-base: Resulting paths from floppy_dirs : [./kickstart/centos/http/]</span><br><span class="line">    vsphere-iso-base: Recursively copying : ./kickstart/centos/http/</span><br><span class="line">    vsphere-iso-base: Done copying paths from floppy_dirs</span><br><span class="line">    vsphere-iso-base: Copying files from floppy_content</span><br><span class="line">    vsphere-iso-base: Done copying files from floppy_content</span><br><span class="line">==&gt; vsphere-iso-base: Uploading created floppy image</span><br><span class="line">==&gt; vsphere-iso-base: Adding generated Floppy...</span><br><span class="line">==&gt; vsphere-iso-base: Set boot order temporary...</span><br><span class="line">==&gt; vsphere-iso-base: Power on VM...</span><br><span class="line">==&gt; vsphere-iso-base: Waiting 15s <span class="keyword">for</span> boot...</span><br><span class="line">==&gt; vsphere-iso-base: Typing boot <span class="built_in">command</span>...</span><br><span class="line">==&gt; vsphere-iso-base: Waiting <span class="keyword">for</span> IP...</span><br><span class="line"></span><br><span class="line">root@devbox-fedora:/root <span class="comment"># scp 192.168.24.43:/vmfs/volumes/Packer/base-os-centos7/packer-tmp-created-floppy.flp .</span></span><br><span class="line">packer-tmp-created-floppy.flp                                                                                100% 1440KB  89.4MB/s   00:00</span><br><span class="line">root@devbox-fedora:/root <span class="comment"># mount packer-tmp-created-floppy.flp /mnt</span></span><br><span class="line">root@devbox-fedora:/root <span class="comment"># readlink /dev/disk/by-label/packer</span></span><br><span class="line">../../loop2</span><br><span class="line">root@devbox-fedora:/root <span class="comment"># df -h /mnt</span></span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/loop2      1.4M   16K  1.4M   2% /mnt</span><br><span class="line">root@devbox-fedora:/root <span class="comment">#</span></span><br><span class="line">root@devbox-fedora:/root <span class="comment"># ls /mnt</span></span><br><span class="line">HTTP</span><br><span class="line">root@devbox-fedora:/root <span class="comment"># ls /mnt/HTTP</span></span><br><span class="line">7</span><br><span class="line">root@devbox-fedora:/root <span class="comment"># ls /mnt/HTTP/7</span></span><br><span class="line">KS.CFG</span><br></pre></td></tr></table></figure>

<h3 id="é€šè¿‡-http-æ–¹å¼è¯»å–-kickstart"><a href="#é€šè¿‡-http-æ–¹å¼è¯»å–-kickstart" class="headerlink" title="é€šè¿‡ http æ–¹å¼è¯»å– kickstart"></a>é€šè¿‡ http æ–¹å¼è¯»å– kickstart</h3><p>ä¸ä¸€å®šå¯è¡Œï¼Œåœ¨é€šè¿‡ http æ–¹å¼è¯»å– kickstart æ–‡ä»¶ä¹‹å‰ï¼ŒESXi OS installer éœ€è¦æœ‰ä¸€ä¸ª IP åœ°å€æ‰è¡Œã€‚å¦‚æœæœåŠ¡å™¨å¦‚æœæœ‰å¤šå—ç½‘å¡çš„è¯ï¼Œå°±å¾ˆéš¾ç¡®å®šæ˜¯å¦åˆ†é…åˆ°ä¸€ä¸ª IPï¼Œä½¿ç”¨é»˜è®¤ DHCP çš„æ–¹å¼å¹¶ä¸ä¸€å®šèƒ½è·å–åˆ°æ­£ç¡®çš„ IP åœ°å€ã€‚å› æ­¤è¯»å– kickstart æ–‡ä»¶çš„æ–¹å¼è¿˜æ˜¯å»ºè®®ä½¿ç”¨ ISO çš„æ–¹å¼ï¼Œè¿™æ ·åœ¨å®‰è£… OS æ—¶å¯¹ç½‘ç»œç¯å¢ƒæ— ä¾èµ–ï¼Œæ›´ç¨³å®šä¸€äº›ã€‚</p>
<h3 id="æ”¯æŒå…¶ä»–-OS-çš„å®‰è£…"><a href="#æ”¯æŒå…¶ä»–-OS-çš„å®‰è£…" class="headerlink" title="æ”¯æŒå…¶ä»– OS çš„å®‰è£…"></a>æ”¯æŒå…¶ä»– OS çš„å®‰è£…</h3><p>ç›®å‰è¯¥æ–¹æ¡ˆåªæ”¯æŒ ESXi OS çš„å®‰è£…ï¼Œå…¶ä»– OS çš„è‡ªåŠ¨åŒ–å®‰è£…å…¶å®åŸç†æ˜¯ä¸€æ ·çš„ã€‚æ¯”å¦‚ CentOS åŒæ ·ä¹Ÿæ˜¯ä¿®æ”¹ kickstart æ–‡ä»¶ã€‚å¦‚æœè¦æŒ‡å®š OS æ‰€å®‰è£…çš„ç£ç›˜å¯ä»¥å‚è€ƒä¸€ä¸‹æˆ´å°”å®˜æ–¹çš„ä¸€ç¯‡æ–‡æ¡£ <a href="https://www.dell.com/support/kbdoc/zh-hk/000177584/automating-operating-system-deployment-to-dell-boss-techniques-for-different-operating-systems" target="_blank" rel="noopener">Automating Operating System Deployment to Dell BOSS â€“ Techniques for Different Operating Systems</a> ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">%include /tmp/bootdisk.cfg</span><br><span class="line">%pre</span><br><span class="line"><span class="comment"># Use DELLBOSS device for OS install if present.</span></span><br><span class="line">BOSS_DEV=$(find /dev -name <span class="string">"*DELLBOSS*"</span> -<span class="built_in">printf</span> %P<span class="string">"\n"</span> | egrep -v -e part -e scsi| head -1)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$BOSS_DEV</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> ignoredisk --only-use=<span class="string">"<span class="variable">$BOSS_DEV</span>"</span> &gt; /tmp/bootdisk.cfg</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¦ä¸ºæŸå—ç‰©ç†ç½‘å¡é…ç½® IP åœ°å€ï¼Œå¯ä»¥æ ¹æ® MAC åœ°å€æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†ç½‘å¡ï¼Œç„¶åå°†é™æ€ IP é…ç½®å†™å…¥åˆ°ç½‘å¡é…ç½®æ–‡ä»¶å½“ä¸­ã€‚æ¯”å¦‚ CentOS åœ¨ kickstart ä¸­ä¸ºæŸå—ç‰©ç†ç½‘å¡é…ç½®é™æ€ IPï¼Œå¯ä»¥é‡‡ç”¨å¦‚ä¸‹æ–¹å¼ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">MAC_ADDRESS åœ¨ç”Ÿæˆ kickstart æ–‡ä»¶çš„æ—¶å€™æ ¹æ® config.yaml åŠ¨æ€ä¿®æ”¹çš„</span><br><span class="line"><span class="comment"># MAC_ADDRESS=B4:96:91:A7:3F:D6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ® MAC åœ°å€è·å–åˆ°ç½‘å¡è®¾å¤‡çš„åç§°</span></span><br><span class="line">NIC=$(grep -l <span class="variable">$&#123;MAC_ADDRESS&#125;</span> /sys/class/net/*/address | awk -F<span class="string">'/'</span> <span class="string">'&#123;print $5&#125;'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†ç½‘å¡é™æ€ IP é…ç½®å†™å…¥åˆ°æ–‡ä»¶å½“ä¸­</span></span><br><span class="line">cat &lt;&lt; EOF &gt; /etc/sysconfig/network-scripts/ifcfg-<span class="variable">$&#123;NIC&#125;</span></span><br><span class="line">TYPE=Ehternet</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">NAME=<span class="variable">$&#123;NIC&#125;</span></span><br><span class="line">DEVICE=<span class="variable">$&#123;NIC&#125;</span></span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=<span class="variable">$&#123;IP&#125;</span></span><br><span class="line">NETMASK=<span class="variable">$&#123;NETMASK&#125;</span></span><br><span class="line">GATEWAY=<span class="variable">$&#123;GATEWAY&#125;</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>ç”±äºæ—¶é—´å…³ç³»ï¼Œåœ¨è¿™é‡Œå°±ä¸å†è¿›è¡Œæ·±å…¥è®²è§£äº†ï¼Œåœ¨è¿™é‡Œåªæ˜¯æä¾›ä¸€ä¸ªæ–¹æ³•å’Œæ€è·¯ã€‚è‡³äº Debian/Ubuntu å‘è¡Œç‰ˆï¼Œè¿˜æ˜¯ä½ ä»¬è‡ªå·±æ‘¸ç´¢å§ï¼Œå› ä¸ºæˆ‘å·¥ä½œä¸­ç¡®å®æ²¡æœ‰åœ¨ç‰©ç†æœåŠ¡å™¨ä¸Šå®‰è£…è¿™äº›å‘è¡Œç‰ˆçš„åœºæ™¯ï¼Œæ¯•ç«Ÿå›½å†…ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒä¸­ä½¿ç”¨ CentOS/RedHat ç³»åˆ—å‘è¡Œç‰ˆçš„å ç»å¤§å¤šæ•°ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><h3 id="Redfish-ç›¸å…³"><a href="#Redfish-ç›¸å…³" class="headerlink" title="Redfish ç›¸å…³"></a>Redfish ç›¸å…³</h3><ul>
<li><a href="https://www.dmtf.org/standards/redfish" target="_blank" rel="noopener">DMTFâ€™s Redfish</a></li>
<li><a href="https://www.dmtf.org/sites/default/files/DSP2044%20Redfish%20%E7%99%BD%E7%9A%AE%E4%B9%A6%201.0.0.pdf" target="_blank" rel="noopener">Redfish ç™½çš®ä¹¦</a></li>
<li><a href="https://wsgzao.github.io/post/redfish/" target="_blank" rel="noopener">Redfish ä¸‹ä¸€ä»£æ•°æ®ä¸­å¿ƒç®¡ç†æ ‡å‡†è¯¦è§£å’Œå®è·µ</a></li>
<li><a href="https://github.com/dell/redfish-ansible-module" target="_blank" rel="noopener">redfish-ansible-module</a></li>
<li><a href="https://github.com/lenovo/python-redfish-lenovo" target="_blank" rel="noopener">python-redfish-lenovo</a></li>
<li><a href="https://docs.ansible.com/ansible/latest/collections/community/general/xcc_redfish_command_module.html" target="_blank" rel="noopener">xcc_redfish_command module</a></li>
<li><a href="https://sysmgt.lenovofiles.com/help/index.jsp?topic=%2Fcom.lenovo.systems.management.xcc.doc%2Frest_api.html" target="_blank" rel="noopener">Lenovo XClarity Controller Redfish REST API</a></li>
<li><a href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.esxi.upgrade.doc/GUID-61A14EBB-5CF3-43EE-87EF-DB8EC6D83698.html" target="_blank" rel="noopener">Installation and Upgrade Script Commands</a></li>
<li><a href="https://www.hpe.com/psnow/doc/4AA6-1727ENW" target="_blank" rel="noopener">Redfish API implementation on HPE servers with iLO RESTful API technical white paper</a></li>
<li><a href="https://github.com/ansible-collections/community.general/issues/3042" target="_blank" rel="noopener">VirtualMediaEject should not require image_url </a></li>
</ul>
<h3 id="VMware-ESXi-ç›¸å…³"><a href="#VMware-ESXi-ç›¸å…³" class="headerlink" title="VMware ESXi ç›¸å…³"></a>VMware ESXi ç›¸å…³</h3><ul>
<li><a href="https://communities.vmware.com/t5/ESXi-Discussions/Reducing-Esxi-7-VMFSL/td-p/2808955" target="_blank" rel="noopener">Reducing Esxi 7 VMFSL</a></li>
<li><a href="https://kb.vmware.com/s/article/1014953" target="_blank" rel="noopener">Identifying disks when working with VMware ESXi (1014953)</a></li>
<li><a href="https://downloads.dell.com/manuals/all-products/esuprt_solutions_int/esuprt_solutions_int_solutions_resources/servers-solution-resources_white-papers10_en-us.pdf" target="_blank" rel="noopener">PowerEdge Boot Optimized Storage Solution BOSS - Dell</a></li>
<li><a href="https://www.reddit.com/r/vmware/comments/2a5jv7/esxi_kickstart_script_to_grep_for_correct_lun/" target="_blank" rel="noopener">ESXi Kickstart script to grep for correct LUN? (iSCSI, Boot from SAN)</a></li>
<li><a href="https://www.dell.com/support/kbdoc/zh-hk/000177584/automating-operating-system-deployment-to-dell-boss-techniques-for-different-operating-systems" target="_blank" rel="noopener">Automating Operating System Deployment to Dell BOSS â€“ Techniques for Different Operating Systems</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/ESXi/" rel="tag"><i class="fa fa-tag"></i> ESXi</a>
              <a href="/tags/Redfish/" rel="tag"><i class="fa fa-tag"></i> Redfish</a>
              <a href="/tags/Dell-%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag"><i class="fa fa-tag"></i> Dell æœåŠ¡å™¨</a>
              <a href="/tags/HPE-%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag"><i class="fa fa-tag"></i> HPE æœåŠ¡å™¨</a>
              <a href="/tags/Lenovo-%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag"><i class="fa fa-tag"></i> Lenovo æœåŠ¡å™¨</a>
              <a href="/tags/%E8%A3%B8%E9%87%91%E5%B1%9E%E6%9C%8D%E5%8A%A1%E5%99%A8/" rel="tag"><i class="fa fa-tag"></i> è£¸é‡‘å±æœåŠ¡å™¨</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/govc-usage.html" rel="prev" title="æ¬ç –å·¥å…· govc ä½¿ç”¨è®°å½•">
      <i class="fa fa-chevron-left"></i> æ¬ç –å·¥å…· govc ä½¿ç”¨è®°å½•
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#éœ€æ±‚åˆ†æ"><span class="nav-number">1.</span> <span class="nav-text">éœ€æ±‚åˆ†æ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æŠ€æœ¯è°ƒç ”"><span class="nav-number">2.</span> <span class="nav-text">æŠ€æœ¯è°ƒç ”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PXE"><span class="nav-number">2.1.</span> <span class="nav-text">PXE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPMI-Redfish"><span class="nav-number">2.2.</span> <span class="nav-text">IPMI&#x2F;Redfish</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å®‰è£…æµç¨‹"><span class="nav-number">3.</span> <span class="nav-text">å®‰è£…æµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#è·å–ç¡¬ä»¶ä¿¡æ¯"><span class="nav-number">3.1.</span> <span class="nav-text">è·å–ç¡¬ä»¶ä¿¡æ¯</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å¡«å†™é…ç½®æ–‡ä»¶"><span class="nav-number">3.2.</span> <span class="nav-text">å¡«å†™é…ç½®æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç”Ÿæˆ-inventory-æ–‡ä»¶"><span class="nav-number">3.3.</span> <span class="nav-text">ç”Ÿæˆ inventory æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ£€æŸ¥-Redfish-ç™»å½•æ˜¯å¦æ­£å¸¸"><span class="nav-number">3.4.</span> <span class="nav-text">æ£€æŸ¥ Redfish ç™»å½•æ˜¯å¦æ­£å¸¸</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç”Ÿæˆ-kickstart-æ–‡ä»¶"><span class="nav-number">3.5.</span> <span class="nav-text">ç”Ÿæˆ kickstart æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é‡æ–°æ„å»º-ESXi-ISO"><span class="nav-number">3.6.</span> <span class="nav-text">é‡æ–°æ„å»º ESXi ISO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é€šè¿‡-redfish-å¼¹å‡ºå·²æœ‰çš„-Virtual-Media"><span class="nav-number">3.7.</span> <span class="nav-text">é€šè¿‡ redfish å¼¹å‡ºå·²æœ‰çš„ Virtual Media</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é€šè¿‡-Redfish-æ’å…¥-ISO"><span class="nav-number">3.8.</span> <span class="nav-text">é€šè¿‡ Redfish æ’å…¥ ISO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è®¾ç½®å¯åŠ¨é¡¹ä¸ºè™šæ‹Ÿå…‰é©±"><span class="nav-number">3.9.</span> <span class="nav-text">è®¾ç½®å¯åŠ¨é¡¹ä¸ºè™šæ‹Ÿå…‰é©±</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é‡å¯æœåŠ¡å™¨"><span class="nav-number">3.10.</span> <span class="nav-text">é‡å¯æœåŠ¡å™¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç­‰å¾…-ESXi-OS-å®‰è£…å®Œæˆ"><span class="nav-number">3.11.</span> <span class="nav-text">ç­‰å¾… ESXi OS å®‰è£…å®Œæˆ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Makefile-å°è£…"><span class="nav-number">4.</span> <span class="nav-text">Makefile å°è£…</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#vars"><span class="nav-number">4.1.</span> <span class="nav-text">vars</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#target"><span class="nav-number">4.2.</span> <span class="nav-text">target</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jenkins-Job"><span class="nav-number">5.</span> <span class="nav-text">Jenkins Job</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Jenkinsfile"><span class="nav-number">5.1.</span> <span class="nav-text">Jenkinsfile</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¸¸è§é—®é¢˜"><span class="nav-number">6.</span> <span class="nav-text">å¸¸è§é—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ç¡¬ä»¶ä¿¡æ¯æ”¶é›†"><span class="nav-number">6.1.</span> <span class="nav-text">ç¡¬ä»¶ä¿¡æ¯æ”¶é›†</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æŒ‚è½½-ISO-ä¹‹å‰å…ˆç¡®ä¿-ISO-å­˜åœ¨"><span class="nav-number">6.2.</span> <span class="nav-text">æŒ‚è½½ ISO ä¹‹å‰å…ˆç¡®ä¿ ISO å­˜åœ¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å•ç‹¬æ„å»º-Kickstart-ISO"><span class="nav-number">6.3.</span> <span class="nav-text">å•ç‹¬æ„å»º Kickstart ISO</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é€šè¿‡-http-æ–¹å¼è¯»å–-kickstart"><span class="nav-number">6.4.</span> <span class="nav-text">é€šè¿‡ http æ–¹å¼è¯»å– kickstart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ”¯æŒå…¶ä»–-OS-çš„å®‰è£…"><span class="nav-number">6.5.</span> <span class="nav-text">æ”¯æŒå…¶ä»– OS çš„å®‰è£…</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">7.</span> <span class="nav-text">å‚è€ƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redfish-ç›¸å…³"><span class="nav-number">7.1.</span> <span class="nav-text">Redfish ç›¸å…³</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VMware-ESXi-ç›¸å…³"><span class="nav-number">7.2.</span> <span class="nav-text">VMware ESXi ç›¸å…³</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="æœ¨å­"
      src="https://blog.k8s.li/avatar.png">
  <p class="site-author-name" itemprop="name">æœ¨å­</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">115</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">147</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail â†’ mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tg.k8s.li/" title="Channel â†’ https:&#x2F;&#x2F;tg.k8s.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Channel</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2018 â€“ 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">æœ¨å­</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">47:31</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://muzi.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://blog.k8s.li/redfish-esxi-os-installer.html",
            identifier: "redfish-esxi-os-installer.html",
            title: "ä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OS"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://muzi.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
