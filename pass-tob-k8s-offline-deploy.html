<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.3.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="在企业私有云环境当中，出于对数据安全的考虑以及满足 网络安全等级保护 的要求，往往会对内部环境中的服务器做出严格的访问限制。一般来讲生产环境都会禁止访问外部网络，开发人员要访问生产环境也必须通过堡垒机或者其他方式进行安全审计登录。在这种无网（无法访问公网）的环境中，想要部署好一个 K8s 集群并不是一件轻松的事儿。市面上 K8s 部署工具也多不胜数，对于离线部署的支持情况也各不相同：    Ite">
<meta property="og:type" content="blog">
<meta property="og:title" content="万字长文详解 PaaS toB 场景下 K8s 离线部署方案">
<meta property="og:url" content="https://blog.k8s.li/pass-tob-k8s-offline-deploy.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="在企业私有云环境当中，出于对数据安全的考虑以及满足 网络安全等级保护 的要求，往往会对内部环境中的服务器做出严格的访问限制。一般来讲生产环境都会禁止访问外部网络，开发人员要访问生产环境也必须通过堡垒机或者其他方式进行安全审计登录。在这种无网（无法访问公网）的环境中，想要部署好一个 K8s 集群并不是一件轻松的事儿。市面上 K8s 部署工具也多不胜数，对于离线部署的支持情况也各不相同：    Ite">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/2021-08-31-pass-tob-k8s-offline-deploy-2.jpeg">
<meta property="og:image" content="https://p.k8s.li/2021-08-24-offline-deploy-k8s-1.png">
<meta property="article:published_time" content="2021-08-29T16:00:00.000Z">
<meta property="article:modified_time" content="2021-08-29T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="PaaS">
<meta property="article:tag" content="toB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/2021-08-31-pass-tob-k8s-offline-deploy-2.jpeg">


<link rel="canonical" href="https://blog.k8s.li/pass-tob-k8s-offline-deploy.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/pass-tob-k8s-offline-deploy.html","path":"pass-tob-k8s-offline-deploy.html","title":"万字长文详解 PaaS toB 场景下 K8s 离线部署方案"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>万字长文详解 PaaS toB 场景下 K8s 离线部署方案 | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A6%BB%E7%BA%BF%E8%B5%84%E6%BA%90"><span class="nav-number">1.</span> <span class="nav-text">离线资源</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OS-packages"><span class="nav-number">1.1.</span> <span class="nav-text">OS packages</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#files"><span class="nav-number">1.2.</span> <span class="nav-text">files</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#images"><span class="nav-number">1.3.</span> <span class="nav-text">images</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E5%B7%A5%E5%85%B7%E9%80%89%E6%8B%A9"><span class="nav-number">2.</span> <span class="nav-text">部署工具选择</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sealos-3"><span class="nav-number">2.1.</span> <span class="nav-text">sealos</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%B0%E5%9C%A8%E5%BC%80%E5%A7%8B-%EF%BF%A599-%EF%BF%A569-x2F-%E5%B9%B4"><span class="nav-number">2.2.</span> <span class="nav-text">现在开始 ￥99 ￥69&#x2F;年</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubekey-3"><span class="nav-number">2.3.</span> <span class="nav-text">kubekey</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubespray-1"><span class="nav-number">2.4.</span> <span class="nav-text">kubespray</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kubeplay"><span class="nav-number">3.</span> <span class="nav-text">kubeplay</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%8C%85%E6%96%B9%E5%BC%8F"><span class="nav-number">3.1.</span> <span class="nav-text">打包方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#compose"><span class="nav-number">3.2.</span> <span class="nav-text">compose</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#os-packages"><span class="nav-number">3.3.</span> <span class="nav-text">os-packages</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubespray-2"><span class="nav-number">3.4.</span> <span class="nav-text">kubespray</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%92%8C%E9%95%9C%E5%83%8F"><span class="nav-number">3.5.</span> <span class="nav-text">文件和镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubespray-files"><span class="nav-number">3.6.</span> <span class="nav-text">kubespray-files</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubespray-images"><span class="nav-number">3.7.</span> <span class="nav-text">kubespray-images</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubeplay-1"><span class="nav-number">3.8.</span> <span class="nav-text">kubeplay</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA"><span class="nav-number">3.9.</span> <span class="nav-text">构建</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B"><span class="nav-number">4.</span> <span class="nav-text">安装流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%8C%85%E7%BB%93%E6%9E%84"><span class="nav-number">4.1.</span> <span class="nav-text">安装包结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#compose-%E8%8A%82%E7%82%B9"><span class="nav-number">4.2.</span> <span class="nav-text">compose 节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubespray-3"><span class="nav-number">4.3.</span> <span class="nav-text">kubespray</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">5.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#kubeadm-%E8%AF%81%E4%B9%A6"><span class="nav-number">5.1.</span> <span class="nav-text">kubeadm 证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E7%BC%93%E5%AD%98"><span class="nav-number">5.2.</span> <span class="nav-text">镜像缓存</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB"><span class="nav-number">6.</span> <span class="nav-text">推荐阅读</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">119</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">153</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail → mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/pass-tob-k8s-offline-deploy.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="万字长文详解 PaaS toB 场景下 K8s 离线部署方案 | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          万字长文详解 PaaS toB 场景下 K8s 离线部署方案
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-30 2021-08-30T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2021-08-30T00:00:00+08:00">2021-08-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/pass-tob-k8s-offline-deploy.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="pass-tob-k8s-offline-deploy.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>54k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>49 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>在企业私有云环境当中，出于对数据安全的考虑以及满足 <a target="_blank" rel="noopener" href="http://www.djbh.net/">网络安全等级保护</a> 的要求，往往会对内部环境中的服务器做出严格的访问限制。一般来讲生产环境都会禁止访问外部网络，开发人员要访问生产环境也必须通过堡垒机或者其他方式进行安全审计登录。在这种无网（无法访问公网）的环境中，想要部署好一个 K8s 集群并不是一件轻松的事儿。市面上 K8s 部署工具也多不胜数，对于离线部署的支持情况也各不相同：</p>
<table>
<thead>
<tr>
<th align="center">Item</th>
<th align="center">Language</th>
<th align="center">Star</th>
<th align="center">Fork</th>
<th align="left">离线部署支持情况</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kops">kops</a></td>
<td align="center">Golang</td>
<td align="center">13.2k</td>
<td align="center">4.1k</td>
<td align="left">不支持</td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kubespray">kubespray</a></td>
<td align="center">Ansible</td>
<td align="center">11.1k</td>
<td align="center">4.7k</td>
<td align="left">支持，需自行构建安装包</td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/easzlab/kubeasz">kubeasz</a></td>
<td align="center">Ansible</td>
<td align="center">7.2k</td>
<td align="center">2.7k</td>
<td align="left">支持，需自行构建安装包</td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/fanux/sealos">sealos</a></td>
<td align="center">Golang</td>
<td align="center">4.1k</td>
<td align="center">790</td>
<td align="left">支持，需付费充值会员</td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/rancher/rke">RKE</a></td>
<td align="center">Golang</td>
<td align="center">2.5k</td>
<td align="center">480</td>
<td align="left">不支持，需自行安装 docker</td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/alibaba/sealer">sealer</a></td>
<td align="center">Golang</td>
<td align="center">503</td>
<td align="center">112</td>
<td align="left">支持，源自 <a target="_blank" rel="noopener" href="https://github.com/fanux/sealos">sealos</a></td>
</tr>
<tr>
<td align="center"><a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubekey">kubekey</a></td>
<td align="center">Golang</td>
<td align="center">471</td>
<td align="center">155</td>
<td align="left">部分支持，仅镜像可离线</td>
</tr>
</tbody></table>
<p>无网环境离线部署 K8s 往往是作为一个商业服务或者商业付费产品来出售（如 <a target="_blank" rel="noopener" href="https://www.sealyun.com/">sealos</a> ），很少有开源免费的解决方案；或者虽然提供了离线部署方案，但想要操作起来十分繁琐，很难顺畅地做到一键部署；又或者只支持部分离线部署，还有一部分资源需要在部署的时候通过公网获取。</p>
<p>针对上述问题，本文调研主流的 K8s 部署工具，并基于这些工具设计并实现一种从构建离线安装包到一键部署 K8s 集群全流程的解决方案，以满足在无网的环境中一键部署 K8s 集群的需求，比较适合基于 K8s 的 PaaS toB 产品使用。</p>
<h2 id="离线资源"><a href="#离线资源" class="headerlink" title="离线资源"></a>离线资源</h2><p>总体来讲部署一个 K8s 集群大致需要依赖如下三种资源：</p>
<ul>
<li>系统 OS 的 rpm&#x2F;deb 包：如 docker-ce、containerd、ipvsadm、conntrack 等；</li>
<li>二进制文件：如 kubelet、kubectl、kubeadm、crictl 等；</li>
<li>组件容器镜像：如 kube-apiserver、kube-proxy、coredns、calico、flannel 等；</li>
</ul>
<h3 id="OS-packages"><a href="#OS-packages" class="headerlink" title="OS packages"></a>OS packages</h3><p>这类属于 OS 系统层面的依赖，根据不同系统或者支持的功能需要使用相应的包管理器安装相应的依赖包，大致分为如下几种：</p>
<ul>
<li>kubernetes 组件依赖</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">- conntrack           <span class="token comment"># kube-proxy 依赖</span>
- ipset               <span class="token comment"># kube-proxy 使用 ipvs 模式需要</span>
- ipvsadm             <span class="token comment"># kube-proxy 使用 ipvs 模式需要</span>
- socat               <span class="token comment"># 用于 port forwarding</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/implementation-details/">Implementation details</a>:</p>
<p>[Error] if conntrack, ip, iptables, mount, nsenter commands are not present in the command path<br>[warning] if ebtables, ethtool, socat, tc, touch, crictl commands are not present in the command path</p>
</blockquote>
<ul>
<li>部署依赖</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">- ebtables            <span class="token comment"># kubeadm 依赖工具</span>
- <span class="token function">ethtool</span>             <span class="token comment"># kubeadm 依赖工具</span>
- chrony              <span class="token comment"># 时钟同步工具，部署前节点的时候必须一致，不然证书或者 CNI 插件会出现问题</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>CRI 容器运行运行时</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">- containerd.io       <span class="token comment"># 可单独安装/docker-ce 依赖</span>
- docker-ce           <span class="token comment"># docker-ce</span>
- libseccomp          <span class="token comment"># 安装 containerd 需要</span>
- nvidia-container-runtime <span class="token comment"># 支持 GPU 时需要依赖</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>存储客户端依赖</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">- nfs-utils/nfs-common <span class="token comment"># 创建基于 nfs 的 PV 需要</span>
- ceph-common          <span class="token comment"># ceph 客户端安装包，创建基于 ceph 的 pv 需要</span>
- lvm2                 <span class="token comment"># 创建基于 ceph 的 pv 需要</span>
- glusterfs-client     <span class="token comment"># 创建基于 glusterfs 的 pv 需要</span>
- glusterfs-common     <span class="token comment"># 创建基于 glusterfs 的 pv 需要</span>
- cifs-utils           <span class="token comment"># 创建基于 cifs 的 pv 需要</span>
- fuse                 <span class="token comment"># ceph 或者其他存储客户端依赖</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>想要解决上面这些依赖项十分棘手，也是离线部署场景下最难的一部分，至今并没有一个成熟的方案实现这些依赖的离线部署，基本上所有的 k8s 部署工具都没有提供这些包的离线安装方式。对于这些包的依赖，目前主要有避免安装这些依赖和制作离线源这两种解决方案。</p>
<h4 id="sealos"><a href="#sealos" class="headerlink" title="sealos"></a>sealos</h4><p>在 <a target="_blank" rel="noopener" href="https://github.com/fanux/sealos">sealos</a> 中就极力避免使用包管理器来安装依赖，比如安装 containerd 时的依赖 libseccomp 使用的是编译好的 .so 文件的方式。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">tar</span> <span class="token parameter variable">-tf</span> kube1.20.0.tar.gz
kube/
kube/lib64/
kube/lib64/README.md
kube/lib64/libseccomp.so.2
kube/lib64/libseccomp.so.2.3.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>安装 docker 使用的二进制的方式，但 docker 官方文档中也明确说明<strong>不建议使用二进制的方式来安装 docker</strong>，应该使用发行版自带的包管理器来安装。</p>
<blockquote>
<p>If you want to try Docker or use it in a testing environment, but you’re not on a supported platform, you can try installing from static binaries. <strong>If possible, you should use packages built for your operating system</strong>, and use your operating system’s package management system to manage Docker installation and upgrades.</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/binaries/">Install Docker Engine from binaries</a></p>
</blockquote>
<p>实际上任何部署工具都会对系统 rpm&#x2F;deb 包都会有不同程度上的依赖，有一部分依赖可以像 <a target="_blank" rel="noopener" href="https://github.com/fanux/sealos">sealos</a>  这样通过某种方式去规避掉。但并不是所有的依赖都能规避的，比如提供挂载 PV 需要依赖的存储客户端（nfs-common&#x2F;nfs-utils，lvm2，gluster-client）这些包，基本上是没有任何规避的途径，必须通过包管理器来安装才行。</p>
<p>当然如果这些前置的依赖项在部署工具之外手动解决或者让用户自行去解决，那么使用 <a target="_blank" rel="noopener" href="https://github.com/fanux/sealos">sealos</a>  这种轻量级的工具来部署 K8s 是比较合适的。但对于一些 PaaS toB 的产品而言，让用户自己去手动解决这些依赖恐怕不太好。站在客户的角度来考虑既然平台提供了这部分功能，就应该在部署的时候解决所有的依赖问题，而不是让我自己手动临时来解决。</p>
<h4 id="kubekey"><a href="#kubekey" class="headerlink" title="kubekey"></a>kubekey</h4><p>在 kubekey 中一些依赖项目则是要求用户自行安装，并没有提供离线安装的方式：</p>
<blockquote>
<ul>
<li>建议您使用干净的操作系统（不安装任何其他软件），否则可能会有冲突。</li>
<li>请确保每个节点的硬盘至少有 <strong>100G</strong>。</li>
<li>所有节点必须都能通过 <code>SSH</code> 访问。</li>
<li>所有节点时间同步。</li>
<li>所有节点都应使用 <code>sudo</code>&#x2F;<code>curl</code>&#x2F;<code>openssl</code>。</li>
</ul>
<p>KubeKey 能够同时安装 Kubernetes 和 KubeSphere。根据要安装的 Kubernetes 版本，需要安装的依赖项可能会不同。您可以参考下方列表，查看是否需要提前在您的节点上安装相关依赖项。</p>
<table>
<thead>
<tr>
<th align="left">依赖项</th>
<th align="left">Kubernetes 版本 ≥ 1.18</th>
<th align="left">Kubernetes 版本 &lt; 1.18</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>socat</code></td>
<td align="left">必须</td>
<td align="left">可选但建议</td>
</tr>
<tr>
<td align="left"><code>conntrack</code></td>
<td align="left">必须</td>
<td align="left">可选但建议</td>
</tr>
<tr>
<td align="left"><code>ebtables</code></td>
<td align="left">可选但建议</td>
<td align="left">可选但建议</td>
</tr>
<tr>
<td align="left"><code>ipset</code></td>
<td align="left">可选但建议</td>
<td align="left">可选但建议</td>
</tr>
</tbody></table>
<p>备注</p>
<ul>
<li>在离线环境中，您可以使用私有包、RPM 包（适用于 CentOS）或者 Deb 包（适用于 Debian）来安装这些依赖项。</li>
<li>建议您事先创建一个操作系统镜像文件，并且安装好所有相关依赖项。这样，您便可以直接使用该镜像文件在每台机器上安装操作系统，提高部署效率，也不用担心任何依赖项问题。</li>
</ul>
<p>您的集群必须有一个可用的容器运行时。在离线环境中创建集群之前，您必须手动安装 Docker 或其他容器运行时。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubekey#requirements-and-recommendations">Requirements and Recommendations</a></p>
</blockquote>
<h4 id="构建离线源"><a href="#构建离线源" class="headerlink" title="构建离线源"></a>构建离线源</h4><p>对于系统 rpm&#x2F;deb 包的依赖，我们还是踏踏实实地使用包管理器来安装这些包较为妥当，因此我们有必要为这些依赖的 rpm&#x2F;deb 包构建成离线源，部署的时候使用这个离线源来安装这些依赖。在 《<a href="https://blog.k8s.li/make-offline-mirrors.html">使用 docker build 制作 yum&#x2F;apt 离线源</a>》一文中曾分析过制作和使用离线源这么难的原因：</p>
<blockquote>
<p>作为平台部署工具的开发者，始终被离线部署这个难题困扰着。在线的容器镜像和二进制文件比较好解决，因为这些资源是与 OS 无关的，只要下载下来放到安装包里，部署的时候启动一个 HTTP 服务器和镜像仓库服务提供这些资源的下载即可。</p>
<p>但是对于 yum&#x2F;apt 之类的软件来讲并不那么简单：</p>
<ul>
<li>首先由于各个包之间的依赖关系比较复杂，并不能将它们直接下载下来；</li>
<li>其次即便下载下来之后也无法直接通过 yum&#x2F;apt 的方式安装指定的软件包，虽然也可以使用 scp 的方式将这些包复制到部署节点，通过 rpm 或 dpkg 的方式来安装上，但这样并不是很优雅，而且通用性能也不是很好；</li>
<li>最后需要适配的 Linux 发行版和包管理器种类也有多种，而且有些包的包名或者版本号在不同的包管理之间也相差甚大，无法做到统一管理。</li>
<li>离线源同时适配适配 ARM64 和 AMD64 有一定的难度</li>
</ul>
</blockquote>
<p>好在文中也给出了一个比较通用的解决方案，即通过 Dockerfile 来构建离线源，具体的实现细节可以翻看《<a href="https://blog.k8s.li/make-offline-mirrors.html">使用 docker build 制作 yum&#x2F;apt 离线源</a>》一文。使用这个方案可以解决 PaaS 或者 IaaS 层面的离线源制作的难题，同样也适用于我们部署 K8s 集群的场景，而且采用 Dockerfile 的方式来构建离线源可以完美地解决同时适配 arm64 和 amd64 的难题。</p>
<h3 id="files"><a href="#files" class="headerlink" title="files"></a>files</h3><p>一些部署过程中需要的二进制文件，如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">- kubelet
- kubeadm
- kubectl
- etcd            <span class="token comment"># systemd 方式部署 etcd 时需要的安装包</span>
- crictl          <span class="token comment"># k8s 官方的 CRI CLI 工具</span>
- calicoctl       <span class="token comment"># calico 的 CLI 工具</span>
- helm            <span class="token comment"># 安装 helm 需要的二进制安装包</span>
- nerdctl         <span class="token comment"># containerd 的 CLI 工具</span>
- cni-plugins     <span class="token comment"># CNI 插件</span>
- cuda            <span class="token comment"># GPU 依赖</span>
- nvidia_driver   <span class="token comment"># GPU 驱动</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="sealos-1"><a href="#sealos-1" class="headerlink" title="sealos"></a>sealos</h4><p>sealos 对二进制文件的处理比较好，全部打包在离线安装包里，部署的时候会分发到集群节点上，整个部署过程都无需访问公网。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">tar</span> <span class="token parameter variable">-tf</span> kube1.20.0.tar.gz
kube/bin/kubelet
kube/bin/kubectl
kube/bin/conntrack
kube/bin/kubeadm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="kubekey-1"><a href="#kubekey-1" class="headerlink" title="kubekey"></a>kubekey</h4><p>在 kubekey 的源码当中，是将所有二进制文件的 URL 硬编码在代码当中的。如果在部署的时候需要根据部署环境来修改二进制文件的下载地址，比如从内网 nginx 服务器上下载，就需要修改这部分源码把 <code>https://kubernetes-release.pek3b.qingstor.com</code> 修改成内网地址，比如 <code>http://172.20.0.25:8080/files</code> ，然而在部署的时候重新编译 kubekey 的代码又必须能访问公网才行，这就很僵硬。所以以目前开源的 kubekey 来看，是没有办法做到无网环境中愉快地部署 k8s 的，可能商业版的支持（猜测。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubekey/blob/master/pkg/kubernetes/preinstall/preinstall.go">kubekey&#x2F;blob&#x2F;master&#x2F;pkg&#x2F;kubernetes&#x2F;preinstall&#x2F;preinstall.go</a></li>
</ul>
<pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">&#x2F;&#x2F; FilesDownloadHTTP defines the kubernetes&#39; binaries that need to be downloaded in advance and downloads them.
func FilesDownloadHTTP(mgr *manager.Manager, filepath, version, arch string) error &#123;
	kkzone :&#x3D; os.Getenv(&quot;KKZONE&quot;)
	etcd :&#x3D; files.KubeBinary&#123;Name: &quot;etcd&quot;, Arch: arch, Version: kubekeyapiv1alpha1.DefaultEtcdVersion&#125;
	kubeadm :&#x3D; files.KubeBinary&#123;Name: &quot;kubeadm&quot;, Arch: arch, Version: version&#125;
	kubelet :&#x3D; files.KubeBinary&#123;Name: &quot;kubelet&quot;, Arch: arch, Version: version&#125;
	kubectl :&#x3D; files.KubeBinary&#123;Name: &quot;kubectl&quot;, Arch: arch, Version: version&#125;
	kubecni :&#x3D; files.KubeBinary&#123;Name: &quot;kubecni&quot;, Arch: arch, Version: kubekeyapiv1alpha1.DefaultCniVersion&#125;
	helm :&#x3D; files.KubeBinary&#123;Name: &quot;helm&quot;, Arch: arch, Version: kubekeyapiv1alpha1.DefaultHelmVersion&#125;

	etcd.Path &#x3D; fmt.Sprintf(&quot;%s&#x2F;etcd-%s-linux-%s.tar.gz&quot;, filepath, kubekeyapiv1alpha1.DefaultEtcdVersion, arch)
	kubeadm.Path &#x3D; fmt.Sprintf(&quot;%s&#x2F;kubeadm&quot;, filepath)
	kubelet.Path &#x3D; fmt.Sprintf(&quot;%s&#x2F;kubelet&quot;, filepath)
	kubectl.Path &#x3D; fmt.Sprintf(&quot;%s&#x2F;kubectl&quot;, filepath)
	kubecni.Path &#x3D; fmt.Sprintf(&quot;%s&#x2F;cni-plugins-linux-%s-%s.tgz&quot;, filepath, arch, kubekeyapiv1alpha1.DefaultCniVersion)
	helm.Path &#x3D; fmt.Sprintf(&quot;%s&#x2F;helm&quot;, filepath)

	if kkzone &#x3D;&#x3D; &quot;cn&quot; &#123;
		etcd.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;kubernetes-release.pek3b.qingstor.com&#x2F;etcd&#x2F;release&#x2F;download&#x2F;%s&#x2F;etcd-%s-linux-%s.tar.gz&quot;, etcd.Version, etcd.Version, etcd.Arch)
		kubeadm.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;kubernetes-release.pek3b.qingstor.com&#x2F;release&#x2F;%s&#x2F;bin&#x2F;linux&#x2F;%s&#x2F;kubeadm&quot;, kubeadm.Version, kubeadm.Arch)
		kubelet.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;kubernetes-release.pek3b.qingstor.com&#x2F;release&#x2F;%s&#x2F;bin&#x2F;linux&#x2F;%s&#x2F;kubelet&quot;, kubelet.Version, kubelet.Arch)
		kubectl.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;kubernetes-release.pek3b.qingstor.com&#x2F;release&#x2F;%s&#x2F;bin&#x2F;linux&#x2F;%s&#x2F;kubectl&quot;, kubectl.Version, kubectl.Arch)
		kubecni.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;containernetworking.pek3b.qingstor.com&#x2F;plugins&#x2F;releases&#x2F;download&#x2F;%s&#x2F;cni-plugins-linux-%s-%s.tgz&quot;, kubecni.Version, kubecni.Arch, kubecni.Version)
		helm.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;kubernetes-helm.pek3b.qingstor.com&#x2F;linux-%s&#x2F;%s&#x2F;helm&quot;, helm.Arch, helm.Version)
		helm.GetCmd &#x3D; mgr.DownloadCommand(helm.Path, helm.Url)
	&#125; else &#123;
		etcd.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;github.com&#x2F;coreos&#x2F;etcd&#x2F;releases&#x2F;download&#x2F;%s&#x2F;etcd-%s-linux-%s.tar.gz&quot;, etcd.Version, etcd.Version, etcd.Arch)
		kubeadm.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;%s&#x2F;bin&#x2F;linux&#x2F;%s&#x2F;kubeadm&quot;, kubeadm.Version, kubeadm.Arch)
		kubelet.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;%s&#x2F;bin&#x2F;linux&#x2F;%s&#x2F;kubelet&quot;, kubelet.Version, kubelet.Arch)
		kubectl.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;storage.googleapis.com&#x2F;kubernetes-release&#x2F;release&#x2F;%s&#x2F;bin&#x2F;linux&#x2F;%s&#x2F;kubectl&quot;, kubectl.Version, kubectl.Arch)
		kubecni.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;github.com&#x2F;containernetworking&#x2F;plugins&#x2F;releases&#x2F;download&#x2F;%s&#x2F;cni-plugins-linux-%s-%s.tgz&quot;, kubecni.Version, kubecni.Arch, kubecni.Version)
		helm.Url &#x3D; fmt.Sprintf(&quot;https:&#x2F;&#x2F;get.helm.sh&#x2F;helm-%s-linux-%s.tar.gz&quot;, helm.Version, helm.Arch)
		getCmd :&#x3D; mgr.DownloadCommand(fmt.Sprintf(&quot;%s&#x2F;helm-%s-linux-%s.tar.gz&quot;, filepath, helm.Version, helm.Arch), helm.Url)
		helm.GetCmd &#x3D; fmt.Sprintf(&quot;%s &amp;&amp; cd %s &amp;&amp; tar -zxf helm-%s-linux-%s.tar.gz &amp;&amp; mv linux-%s&#x2F;helm . &amp;&amp; rm -rf *linux-%s*&quot;, getCmd, filepath, helm.Version, helm.Arch, helm.Arch, helm.Arch)
	&#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>此外 kubekey 在安装 docker 时，是直接调用的 <a target="_blank" rel="noopener" href="https://get.docker.com/">docker 官方的脚本</a> 来安装，安装过程也必须访问公网才行。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubekey/blob/master/pkg/container-engine/docker/docker.go">kubekey&#x2F;blob&#x2F;master&#x2F;pkg&#x2F;container-engine&#x2F;docker&#x2F;docker.go</a></li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">installDockerOnNode</span><span class="token punctuation">(</span>mgr <span class="token operator">*</span>manager<span class="token punctuation">.</span>Manager<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">*</span>kubekeyapiv1alpha1<span class="token punctuation">.</span>HostCfg<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	dockerConfig<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">GenerateDockerConfig</span><span class="token punctuation">(</span>mgr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">&#125;</span>
	dockerConfigBase64 <span class="token operator">:=</span> base64<span class="token punctuation">.</span>StdEncoding<span class="token punctuation">.</span><span class="token function">EncodeToString</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span>dockerConfig<span class="token punctuation">)</span><span class="token punctuation">)</span>
	output<span class="token punctuation">,</span> err1 <span class="token operator">:=</span> mgr<span class="token punctuation">.</span>Runner<span class="token punctuation">.</span><span class="token function">ExecuteCmd</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"sudo -E /bin/sh -c \"if [ -z $(which docker) ] || [ ! -e /var/run/docker.sock ]; then curl https://kubernetes.pek3b.qingstor.com/tools/kubekey/docker-install.sh | sh &amp;&amp; systemctl enable docker; if [ ! -f /etc/docker/daemon.json ]; then mkdir -p /etc/docker &amp;&amp; echo %s | base64 -d > /etc/docker/daemon.json; fi; systemctl daemon-reload &amp;&amp; systemctl restart docker; fi\""</span><span class="token punctuation">,</span> dockerConfigBase64<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err1 <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token function">WithStack</span><span class="token punctuation">(</span>err1<span class="token punctuation">)</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"Failed to install docker:\n%s"</span><span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用 docker 官方的安装脚本来安装 docker 是有一个明显的问题就是：没有版本控制，不能指定 docker 的版本，每次安装的 docker 版本都是最新的 stable 版本。没有版本控制就会导致不同时间部署的集群或者加入的节点，docker 版本可能就不一样，在这里可能会埋下一些坑，可能会带来一定的维护成本或者将来升级时遇到问题。</p>
<p>编译过 kubernetes 组件的可能都知道 k8s 源码当中存在一个 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/build/dependencies.yaml">build&#x2F;dependencies.yaml</a> 的文件，里面记录的是 k8s 组件与其他组件 (如 docker, etcd, coredns, cni, pause) 所匹配的最佳版本。</p>
<blockquote>
<p>On each of your nodes, install the Docker for your Linux distribution as per <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/#server">Install Docker Engine</a>. You can find the latest validated version of Docker in this <a target="_blank" rel="noopener" href="https://git.k8s.io/kubernetes/build/dependencies.yaml">dependencies</a> file.</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/release-1.20/build/dependencies.yaml">kubernetes&#x2F;blob&#x2F;release-1.20&#x2F;build&#x2F;dependencies.yaml</a></li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">dependencies</span><span class="token punctuation">:</span>
  <span class="token comment"># zeitgeist (https://github.com/kubernetes-sigs/zeitgeist) was inspired by</span>
  <span class="token comment"># (and now replaces) the cmd/verifydependencies tool to verify external</span>
  <span class="token comment"># dependencies across the repo.</span>
  <span class="token comment">#</span>
  <span class="token comment"># The zeitgeist dependencies.yaml file format is intended to be</span>
  <span class="token comment"># backwards-compatible with the original tooling.</span>
  <span class="token comment">#</span>
  <span class="token comment"># In instances where the file format may change across versions, this meta</span>
  <span class="token comment"># dependency check exists to ensure we're pinned to a known good version.</span>
  <span class="token comment">#</span>
  <span class="token comment"># ref: https://github.com/kubernetes/kubernetes/pull/98845</span>

  <span class="token comment"># Docker</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"docker"</span>
    <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">19.03</span>
    <span class="token key atrule">refPaths</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> vendor/k8s.io/system<span class="token punctuation">-</span>validators/validators/docker_validator.go
      <span class="token key atrule">match</span><span class="token punctuation">:</span> latestValidatedDockerVersion<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>以 1.20.x 版本的 k8s 为例，它所依赖的 docker 版本为 19.03，而现在最新的 docker 版本如 20.10.8，并不是 K8s 官方所建议的最佳版本。总之，我们在部署 K8s 时，可以参考 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/build/dependencies.yaml">build&#x2F;dependencies.yaml</a> 来确定与 K8s 相关的组件应该选择哪一个最佳的版本，而不是随便装一个最新的版本就完事儿了。</p>
<h4 id="kubespray"><a href="#kubespray" class="headerlink" title="kubespray"></a>kubespray</h4><p>在 kubespray 中，所有二进制文件的 URL 都是通过变量的方式定义的，想要做到离线部署十分简单，只需要通过 ansible 变量优先级的特性，将它们在 group_vars 通过 overrides 的方式覆盖即可。比如这样：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Download URLs</span>
<span class="token key atrule">kubelet_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kube_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubelet"</span>
<span class="token key atrule">kubectl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kube_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubectl"</span>
<span class="token key atrule">kubeadm_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kube_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubeadm"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="images"><a href="#images" class="headerlink" title="images"></a>images</h3><p>一些如 kube-proxy、kube-apiserver、coredns、calico 组件镜像：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">k8s.gcr.io/kube-apiserver:v1.20.7
k8s.gcr.io/kube-controller-manager:v1.20.7
k8s.gcr.io/kube-proxy:v1.20.7
k8s.gcr.io/kube-registry-proxy:0.4
k8s.gcr.io/kube-scheduler:v1.20.7
k8s.gcr.io/pause:3.3
k8s.gcr.io/coredns:1.7.0
k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64:1.8.3
k8s.gcr.io/dns/k8s-dns-node-cache:1.17.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="sealos-2"><a href="#sealos-2" class="headerlink" title="sealos"></a>sealos</h4><p>sealos 将这些镜像使用 docker save 的方式打包成一个 tar 包，在部署的时候使用 docker&#x2F;ctr load 的方式将镜像导入到容器运行时的存储目录当中，源码如下：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/fanux/sealos/blob/develop/install/send.go">fanux&#x2F;sealos&#x2F;blob&#x2F;develop&#x2F;install&#x2F;send.go</a></li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// SendPackage is send new pkg to all nodes.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>u <span class="token operator">*</span>SealosUpgrade<span class="token punctuation">)</span> <span class="token function">SendPackage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	all <span class="token operator">:=</span> <span class="token function">append</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>Masters<span class="token punctuation">,</span> u<span class="token punctuation">.</span>Nodes<span class="token operator">...</span><span class="token punctuation">)</span>
	pkg <span class="token operator">:=</span> path<span class="token punctuation">.</span><span class="token function">Base</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span>NewPkgUrl<span class="token punctuation">)</span>
	<span class="token comment">// rm old sealos in package avoid old version problem. if sealos not exist in package then skip rm</span>
	<span class="token keyword">var</span> kubeHook <span class="token builtin">string</span>
	<span class="token keyword">if</span> <span class="token function">For120</span><span class="token punctuation">(</span>Version<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// TODO update need load modprobe -- br_netfilter modprobe -- bridge.</span>
		<span class="token comment">// https://github.com/fanux/cloud-kernel/issues/23</span>
		kubeHook <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"cd /root &amp;&amp; rm -rf kube &amp;&amp; tar zxvf %s  &amp;&amp; cd /root/kube/shell &amp;&amp; rm -f ../bin/sealos &amp;&amp; (ctr -n=k8s.io image import ../images/images.tar || true) &amp;&amp; cp -f ../bin/* /usr/bin/ "</span><span class="token punctuation">,</span> pkg<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		kubeHook <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"cd /root &amp;&amp; rm -rf kube &amp;&amp; tar zxvf %s  &amp;&amp; cd /root/kube/shell &amp;&amp; rm -f ../bin/sealos &amp;&amp; (docker load -i ../images/images.tar || true) &amp;&amp; cp -f ../bin/* /usr/bin/ "</span><span class="token punctuation">,</span> pkg<span class="token punctuation">)</span>

	<span class="token punctuation">&#125;</span>

	PkgUrl <span class="token operator">=</span> <span class="token function">SendPackage</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> all<span class="token punctuation">,</span> <span class="token string">"/root"</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>kubeHook<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用这种方式加载镜像有一个比较明显的限制就是 kube-apiserver 的 admission 准入控制中不能加入 <code>AlwaysPullImages</code> 参数。不然与这些镜像相关的 pod 重新调度或者重启之后会重新从源镜像仓库拉取镜像，在无网或者网络限制的环境中可能无法拉取镜像导致这些 Pod 启动失败，从而导致集群异常。</p>
<p>而在多租户场景下，出于安全的考虑  <code>AlwaysPullImages</code> 准入控制往往是要开启的。因此 sealos 可能并不适用于多租户或者对此有要求的环境中（最常见的就是 PaaS 平台）。</p>
<blockquote>
<p>该准入控制器会修改每一个新创建的 Pod 的镜像拉取策略为 Always 。 这在多租户集群中是有用的，这样用户就可以放心，他们的私有镜像只能被那些有凭证的人使用。 如果没有这个准入控制器，一旦镜像被拉取到节点上，任何用户的 Pod 都可以通过已了解到的镜像的名称（假设 Pod 被调度到正确的节点上）来使用它，而不需要对镜像进行任何授权检查。 当启用这个准入控制器时，总是在启动容器之前拉取镜像，这意味着需要有效的凭证。</p>
</blockquote>
<h4 id="kubekey-2"><a href="#kubekey-2" class="headerlink" title="kubekey"></a>kubekey</h4><p><a target="_blank" rel="noopener" href="https://kubesphere.io/docs/installing-on-linux/introduction/air-gapped-installation/">kubekey 官方的文档</a> 中有提到组件镜像离线部署的方式，不过十分繁琐(劝退 😂)，在 <a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubekey/issues/597">Offline installation is too troublesome #597</a> 中也有人吐槽这个问题。不过目前 kubekey 开发团队已经在重构这部分内容了，至于结果如何，只能等了。</p>
<h4 id="镜像仓库"><a href="#镜像仓库" class="headerlink" title="镜像仓库"></a>镜像仓库</h4><p>在私有云环境中，企业一般都会有自己的镜像仓库（比如 harbor ）用于存放业务组件镜像或者一些其他平台依赖的镜像。再加上 Docker Hub 自从去年开始就加入了 pull 镜像次数的限制，如果直接使用 Docker Hub 上面的镜像来部署集群，很有可能会因为 <a target="_blank" rel="noopener" href="https://www.docker.com/increase-rate-limit">429 toomanyrequests</a> 或者一些网络原因导致拉取镜像失败。因此对于 k8s 集群部署而言，建议使用内部自己的镜像仓库，而非公网上镜像仓库。如果没有的话可以使用 harbor 或者 docker registry 在本地部署一个镜像仓库。我们将部署依赖的镜像导入到已经存在的镜像仓库中，部署的时候从该镜像仓库拉取即可。</p>
<h2 id="部署工具选择"><a href="#部署工具选择" class="headerlink" title="部署工具选择"></a>部署工具选择</h2><p>上面简单梳理了一下部署 k8s 集群过程中所依赖的的在线资源，以及如何将它们制作成离线资源的一些分析。上面提及的部署工具各有各的优缺点，针对以下两种不同的场景可以选择不同的部署工具。</p>
<h3 id="sealos-3"><a href="#sealos-3" class="headerlink" title="sealos"></a>sealos</h3><p>如果仅仅是部署一个简单的 k8s 集群，对集群没有太多定制化的需求，那么使用 <a target="_blank" rel="noopener" href="https://github.com/fanux/sealos">sealos</a> 可能是最佳的选择，只不过它是收费的，<a target="_blank" rel="noopener" href="https://www.sealyun.com/">需要充值会员</a> 😂。</p>
<blockquote>
<h3 id="现在开始-￥99-￥69-x2F-年"><a href="#现在开始-￥99-￥69-x2F-年" class="headerlink" title="现在开始 ￥99 ￥69&#x2F;年"></a>现在开始 <del>￥99</del> ￥69&#x2F;年</h3><p>欢迎成为年费会员，任意下载所有版本软件包!</p>
<blockquote>
<p>@F-liuhui 离线包居然要收费？那还是开源项目吗？</p>
</blockquote>
<p>开源与付费不冲突，100% 开源 100% 付费</p>
<p><a target="_blank" rel="noopener" href="https://www.sealyun.com/">sealyun.com</a></p>
</blockquote>
<p>如果动手能力强的话，可以根据 selaos 离线安装包的目录结构使用 GitHub Actions 来构建，实现起来也不是很难。只不过砸别人饭碗的事儿还是不做为好，因此我们应该选择另一种方案来实现，这样也能避免一些商业纠纷问题。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">tar</span> <span class="token parameter variable">-tf</span> kube1.20.0.tar.gz
kube/
kube/lib64/
kube/lib64/README.md
kube/lib64/libseccomp.so.2
kube/lib64/libseccomp.so.2.3.1
kube/shell/
kube/shell/containerd.sh
kube/shell/init.sh
kube/shell/master.sh
kube/README.md
kube/bin/
kube/bin/kubelet
kube/bin/kubectl
kube/bin/conntrack
kube/bin/kubeadm
kube/bin/kubelet-pre-start.sh
kube/conf/
kube/conf/kubeadm.yaml
kube/conf/kubelet.service
kube/conf/calico.yaml
kube/conf/10-kubeadm.conf
kube/conf/net/
kube/conf/net/calico.yaml
kube/containerd/
kube/containerd/README.md
kube/containerd/cri-containerd-cni-linux-amd64.tar.gz
kube/images/
kube/images/images.tar
kube/images/README.md<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="kubekey-3"><a href="#kubekey-3" class="headerlink" title="kubekey"></a>kubekey</h3><p>由于 kubekey 部署时二进制文件需要公网获取，docker 无法离线部署以及需要手动安装一些前置依赖，没有办法做到完整的离线部署，因此离线部署的方案也就直接放弃掉了，抽空他们提个 Issue 或 PR 看看能否支持这部分 😅。</p>
<h3 id="kubespray-1"><a href="#kubespray-1" class="headerlink" title="kubespray"></a>kubespray</h3><p>如果想找一个即开源又免费的离线部署方案，或者对集群部署有特殊的要求，比如基于 K8s 的 PaaS toB 产品，需要在部署时安装平台本身需要的一些依赖（如存储客户端、GPU 驱动等）。那么不妨先看一下 kubernetes-sig 社区的 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kubespray">kubespray</a> 如何 🤔，主要的特性如下：</p>
<ul>
<li>支持的 10 种 CNI 插件</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">- cni-plugins v0.9.1
- calico v3.17.4
- canal <span class="token punctuation">(</span>given calico/flannel versions<span class="token punctuation">)</span>
- cilium v1.9.9
- flanneld v0.14.0
- kube-ovn v1.7.1
- kube-router v1.3.0
- multus v3.7.2
- ovn4nfv v1.1.0
- weave v2.8.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>支持 3 种容器运行时以及 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/kata-containers.md">Kata Containers</a> 还有 nvidia-gpu-device-plugin 等</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">- <span class="token function">docker</span> v20.10
- containerd v1.4.6
- cri-o v1.21<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>适配了 10 种 Linux 发行版，覆盖了绝大多数私有云场景</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">- Flatcar Container Linux by Kinvolk
- Debian Buster, Jessie, Stretch, Wheezy
- Ubuntu <span class="token number">16.04</span>, <span class="token number">18.04</span>, <span class="token number">20.04</span>
- CentOS/RHEL <span class="token number">7</span>, <span class="token number">8</span>
- Fedora <span class="token number">33</span>, <span class="token number">34</span>
- Fedora CoreOS <span class="token punctuation">(</span>see fcos Note<span class="token punctuation">)</span>
- openSUSE Leap <span class="token number">15</span>.x/Tumbleweed
- Oracle Linux <span class="token number">7</span>, <span class="token number">8</span>
- Alma Linux <span class="token number">8</span>
- Amazon Linux <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>丰富的插件和扩展</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">## 工具类</span>
- helm
- krew
- nerdctl

<span class="token comment">## 一些 controller 和 provisioner</span>
- ambassador: v1.5
- cephfs-provisioner v2.1.0-k8s1.11
- rbd-provisioner v2.1.1-k8s1.11
- cert-manager v0.16.1
- coredns v1.8.0
- ingress-nginx v0.43.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>依赖的文件和镜像支持离线部署 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/offline-environment.md">Offline environment</a></li>
</ul>
<p>kubespray 对所有的依赖资源都做到了离线下载的支持：比如所有依赖文件的 URL 都通过变量的方式来定义，而非 kubekey 那样硬编码在代码中；所有镜像的 repo 和 tag 都是通过变量的方式来定义。这样的好处就是在部署的时候可以根据客户环境的的镜像仓库地址和文件服务器的 URL 地址来填写相应的参数，无需通过公网来获取。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Registry overrides</span>
<span class="token key atrule">kube_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; registry_host &#125;&#125;"</span>
<span class="token key atrule">gcr_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; registry_host &#125;&#125;"</span>
<span class="token key atrule">docker_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; registry_host &#125;&#125;"</span>
<span class="token key atrule">quay_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; registry_host &#125;&#125;"</span>

<span class="token key atrule">kubeadm_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; files_repo &#125;&#125;/kubernetes/&#123;&#123; kube_version &#125;&#125;/kubeadm"</span>
<span class="token key atrule">kubectl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; files_repo &#125;&#125;/kubernetes/&#123;&#123; kube_version &#125;&#125;/kubectl"</span>
<span class="token key atrule">kubelet_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; files_repo &#125;&#125;/kubernetes/&#123;&#123; kube_version &#125;&#125;/kubelet"</span>
<span class="token comment"># etcd is optional if you **DON'T** use etcd_deployment=host</span>
<span class="token key atrule">etcd_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; files_repo &#125;&#125;/kubernetes/etcd/etcd-&#123;&#123; etcd_version &#125;&#125;-linux-amd64.tar.gz"</span>
<span class="token key atrule">cni_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; files_repo &#125;&#125;/kubernetes/cni/cni-plugins-linux-&#123;&#123; image_arch &#125;&#125;-&#123;&#123; cni_version &#125;&#125;.tgz"</span>
<span class="token key atrule">crictl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; files_repo &#125;&#125;/kubernetes/cri-tools/crictl-&#123;&#123; crictl_version &#125;&#125;-&#123;&#123; ansible_system | lower &#125;&#125;-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token comment"># If using Calico</span>
<span class="token key atrule">calicoctl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; files_repo &#125;&#125;/kubernetes/calico/&#123;&#123; calico_ctl_version &#125;&#125;/calicoctl-linux-&#123;&#123; image_arch &#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>和上述几种部署工具对比不难发现，kubespray 灵活性和可扩展性要领先其他工具（支持 10 种 CNI、10 种 Linux  发行版、3 种 CRI、以及多种插件和扩展）并在参数层面上做到了离线部署的支持。因此我们首先选用 kubespray 作为集群部署的底层工具。</p>
<p>还有一个问题就是 kubespray 虽然在参数配置上支持离线部署，但是从制作离线安装包到一键部署，目前为止还未有一个完整的实现方案。因此需要为 kubespray 设计一套从离线安装包的构建到集群一键部署的流程和方案，为此我们新建一个名为 <a target="_blank" rel="noopener" href="https://github.com/k8sli/kubeplay">kubeplay</a> 的 repo 来完成这部分内容。</p>
<p>另外值得一提的是 kubesphere 早期的版本 v2.x 使用也是 kubespray 部署的 k8s，至今 ks-installer 代码中仍残留着 <a target="_blank" rel="noopener" href="https://github.com/kubesphere/ks-installer/commits/master/roles/download/tasks">部分 kubespray 的代码</a> ，到了 3.0 的时候开始使用自研的 kubekey 来部署 K8s 了。</p>
<blockquote>
<p>基于 Ansible 的安装程序具有大量软件依赖性，例如 Python。KubeKey 是使用 Go 语言开发的，可以消除在各种环境中出现的问题，从而提高安装成功率。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubesphere/kubekey/blob/master/README_zh-CN.md">README_zh-CN.md</a></p>
</blockquote>
<p>不过 ansible 的依赖问题当时为什么没有考虑采用容器化的方式运行 kubespray 🤔，至于 ansible 的性能问题也不是没有优化的余地。</p>
<h2 id="kubeplay"><a href="#kubeplay" class="headerlink" title="kubeplay"></a><a target="_blank" rel="noopener" href="https://github.com/k8sli/kubeplay">kubeplay</a></h2><p>kubeplay 这个项目主要是实现 K8s 离线安装包的构建和一键部署功能，目前只适配了 kubespray，等到后面会适配一些其他部署工具如 kubekey。</p>
<h3 id="打包方式"><a href="#打包方式" class="headerlink" title="打包方式"></a>打包方式</h3><p>由于部署依赖的二进制文件和组件镜像大都存放在 GitHub 、Docker Hub、gcr.io（Google Container Registry）、quay.io 这些国外的平台上，在国内环境获取这些资源是有一定的网络限制。而 GitHub 托管的 runner 运行在国外的机房当中，可以很顺畅地获取这些资源。因此我们选择使用 GitHub Actions 来进行离线安装包的构建。</p>
<p>像 selos 那样将安装包存放在阿里云 OSS 上，在国内能十分顺畅地高速下载，收费也是理所当然。但我们的方案是 100% 开源 100% 免费，每个人都可以 fork 代码到自己的 repo，根据自己的需求进行构建。因此选择 GitHub 来构建和存放我们的安装包是最合适的选择，这样也不用去额外考虑安装包下载的问题。至于从 GitHub 上下载安装包慢的问题，那应该由使用者自行去解决，而非本方案所关心的问题。</p>
<blockquote>
<p>Q：如何摆脱网络的依赖来创建个 Docker 的 image 呢，我觉得这个是 Docker 用户自己的基本权利？</p>
<p>A：这个基本权利我觉得还是要问 GFW ，国外的开发人员是非常难理解有些他们认为跟水电一样普及的基础设施在某些地方还是很困难的。</p>
<p>此处引用 <a target="_blank" rel="noopener" href="http://dockone.io/article/722">DockOne 技术分享（二十四）：容器和 IaaS：谁动了谁的奶酪</a></p>
</blockquote>
<p>选择好的构建场所为 GitHub Actions 之后我们再将这些离线资源进行拆分，目的是为了实现各个离线资源之间的解耦，这样做灵活性更好一些，比如能够适配多种 OS、支持多个 k8s 版本等。主要拆分成如下几个模块。</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>Repo</th>
<th>用途</th>
<th>运行&#x2F;使用方式</th>
</tr>
</thead>
<tbody><tr>
<td>compose</td>
<td><a target="_blank" rel="noopener" href="https://github.com/k8sli/kubeplay">kubeplay</a></td>
<td>用于部署 nginx 和 registry 服务</td>
<td>nerdctl compose</td>
</tr>
<tr>
<td>os-tools</td>
<td><a target="_blank" rel="noopener" href="https://github.com/k8sli/kubeplay">kubeplay</a></td>
<td>部署 compose 时的一些依赖工具</td>
<td>二进制安装</td>
</tr>
<tr>
<td>os-packages</td>
<td><a target="_blank" rel="noopener" href="https://github.com/k8sli/os-packages">os-packages</a></td>
<td>提供 rpm&#x2F;deb 离线源</td>
<td>nginx 提供 http 方式下载</td>
</tr>
<tr>
<td>kubespray</td>
<td><a target="_blank" rel="noopener" href="https://github.com/k8sli/kubespray">kubespray</a></td>
<td>用于部署&#x2F;扩缩容 k8s 集群</td>
<td>容器或者 pod</td>
</tr>
<tr>
<td>kubespray-files</td>
<td><a target="_blank" rel="noopener" href="https://github.com/k8sli/kubespray">kubespray</a></td>
<td>提供二进制文件依赖</td>
<td>nginx 提供 http 方式下载</td>
</tr>
<tr>
<td>kubespray-images</td>
<td><a target="_blank" rel="noopener" href="https://github.com/k8sli/kubespray">kubespray</a></td>
<td>提供组件镜像</td>
<td>registry 提供镜像下载</td>
</tr>
</tbody></table>
<p>拆分完成之后，我们最终还是需要将它们组合成一个完成的离线安装包。为了减少维护成本，我们将每个模块的构建操作都放在 Dockerfile 中，即 <code>All in Dockerfile</code> 🤣。这样每个模块的 GitHub Actions 流水线最终交付的都是一个镜像，然后镜像都推送到  <code>ghcr.io</code> 上，这样就解决了模块间产物传递以及镜像缓存的问题。最终通过一个最终的 <a target="_blank" rel="noopener" href="https://github.com/k8sli/kubeplay/blob/main/Dockerfile">Dockerfile</a> 将这些模块的镜像全部 COPY 到一个镜像当中，只要打包这个最终的镜像为离线安装包即可；另一个好处就使用 buildx 构建这些离线资源就原生支持多 CPU 体系架构，能够同时适配 amd64 和 arm64 体系架构，这样 arm64 也能愉快地玩耍了，真是一举两得。</p>
<p>下面就详细讲解每个模块的功能以及是如何打包的：</p>
<h3 id="compose"><a href="#compose" class="headerlink" title="compose"></a>compose</h3><p>compose 模块里面主要运两个服务： 用于提供文件下载的 nginx 和组件镜像拉取的 registry。这两个我们依旧是容器化以类似 docker-compose 的方式来部署，而所依赖的也只有两个镜像和一些配置文件而已。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/k8sli/kubeplay/blob/main/compose.yaml">kubeplay&#x2F;blob&#x2F;main&#x2F;compose.yaml</a></li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.1'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">nginx</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.20<span class="token punctuation">-</span>alpine
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./resources/nginx<span class="token punctuation">:</span>/usr/share/nginx
      <span class="token punctuation">-</span> ./config/compose/certs/domain.crt<span class="token punctuation">:</span>/etc/nginx/conf.d/domain.crt
      <span class="token punctuation">-</span> ./config/compose/certs/domain.key<span class="token punctuation">:</span>/etc/nginx/conf.d/domain.key
      <span class="token punctuation">-</span> ./config/compose/nginx.conf<span class="token punctuation">:</span>/etc/nginx/conf.d/default.conf
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token comment"># 443 端口反向代理 registr 的 5000 端口，仅用于 pull 镜像</span>
      <span class="token punctuation">-</span> 443<span class="token punctuation">:</span><span class="token number">443</span>
      <span class="token punctuation">-</span> 8080<span class="token punctuation">:</span><span class="token number">8080</span>

  <span class="token key atrule">registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry<span class="token punctuation">:</span>2.7.1
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> registry
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./resources/registry<span class="token punctuation">:</span>/var/lib/registry
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token comment"># 只允许本地 5000 端口 push 镜像</span>
      <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span>5000<span class="token punctuation">:</span><span class="token number">5000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这两个镜像我们使用 skopeo copy 的方式保存为 tar 包，部署的时候 load 到容器运行时的存储中。</p>
<blockquote>
<p>Q：为什么要用 skopeo 而不是 docker？</p>
<p>A：因为 Dockerfile 构建过程中不支持运行 docker 命令 save 镜像</p>
</blockquote>
<ul>
<li>Dockerfile</li>
</ul>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> alpine:latest <span class="token keyword">as</span> downloader</span>
<span class="token instruction"><span class="token keyword">ARG</span> SKOPEO_VERSION=v1.4.0</span>
<span class="token instruction"><span class="token keyword">ARG</span> NGINX_VERSION=1.20-alpine</span>
<span class="token instruction"><span class="token keyword">ARG</span> RERGISRRY_VERSION=2.7.1</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /tools</span>
<span class="token instruction"><span class="token keyword">RUN</span> ARCH=$(uname -m | sed <span class="token string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) <span class="token operator">\</span>
    &amp;&amp; apk --no-cache add wget ca-certificates <span class="token operator">\</span>
    &amp;&amp; wget -q -k https://github.com/k8sli/skopeo/releases/download/v1.4.0/skopeo-linux-<span class="token variable">$&#123;ARCH&#125;</span> -O /tools/skopeo-linux-<span class="token variable">$&#123;ARCH&#125;</span> <span class="token operator">\</span>
    &amp;&amp; chmod a+x /tools/* <span class="token operator">\</span>
    &amp;&amp; ln -s /tools/skopeo-linux-<span class="token variable">$&#123;ARCH&#125;</span> /usr/bin/skopeo</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /images</span>
<span class="token instruction"><span class="token keyword">RUN</span> ARCH=$(uname -m | sed <span class="token string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) <span class="token operator">\</span>
    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=false --override-arch <span class="token variable">$&#123;ARCH&#125;</span> --additional-tag nginx:<span class="token variable">$&#123;NGINX_VERSION&#125;</span> <span class="token operator">\</span>
       docker://docker.io/library/nginx:<span class="token variable">$&#123;NGINX_VERSION&#125;</span> docker-archive:nginx-<span class="token variable">$&#123;NGINX_VERSION&#125;</span>.tar <span class="token operator">\</span>
    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=false --override-arch <span class="token variable">$&#123;ARCH&#125;</span> --additional-tag registry:<span class="token variable">$&#123;RERGISRRY_VERSION&#125;</span> <span class="token operator">\</span>
       docker://docker.io/library/registry:<span class="token variable">$&#123;RERGISRRY_VERSION&#125;</span> docker-archive:registry-<span class="token variable">$&#123;RERGISRRY_VERSION&#125;</span>.tar</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在部署的时候我们使用 nerdctl compose 的方式启动即可，使用方式有点类似于 docker-compose。</p>
<blockquote>
<p>Q: 为什么不用 docker 和 docker-compose</p>
<p>A：K8s 去 docker 是大势所趋，选择 containerd 更符合主流发展方向</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将镜像 load 进 containerd 存储</span>
$ <span class="token function">find</span> <span class="token variable">$&#123;IMAGES_DIR&#125;</span> <span class="token parameter variable">-type</span> f <span class="token parameter variable">-name</span> <span class="token string">'*.tar'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-L1</span> nerdctl load <span class="token parameter variable">-i</span>
<span class="token comment"># nerdctl compose 启动 nginx 和 registry</span>
$ nerdctl compose <span class="token parameter variable">-f</span> compose.yaml up<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="os-packages"><a href="#os-packages" class="headerlink" title="os-packages"></a>os-packages</h3><p>这部分是 rpm&#x2F;deb 离线源的构建，其详细的过程和原理可以参考我之前写的博客 《<a href="https://blog.k8s.li/make-offline-mirrors.html">使用 docker build 制作 yum&#x2F;apt 离线源</a>》，下面只列举一下 CentOS7 离线源的构建配置：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/k8sli/os-packages/blob/main/build/Dockerfile.os.centos7">Dockerfile</a></li>
</ul>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> centos:7.9.2009 <span class="token keyword">as</span> os-centos7</span>
<span class="token instruction"><span class="token keyword">ARG</span> OS_VERSION=7</span>
<span class="token instruction"><span class="token keyword">ARG</span> DOCKER_MIRROR_URL=<span class="token string">"https://download.docker.com"</span></span>
<span class="token instruction"><span class="token keyword">ARG</span> BUILD_TOOLS=<span class="token string">"yum-utils createrepo epel-release wget"</span></span>

<span class="token comment"># 安装构建工具，配置 docker 官方 yum 源</span>
<span class="token instruction"><span class="token keyword">RUN</span> yum install -q -y <span class="token variable">$&#123;BUILD_TOOLS&#125;</span> <span class="token operator">\</span>
    &amp;&amp; yum-config-manager --add-repo <span class="token variable">$&#123;DOCKER_MIRROR_URL&#125;</span>/linux/centos/docker-ce.repo <span class="token operator">\</span>
    &amp;&amp; yum makecache</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /centos/<span class="token variable">$OS_VERSION</span>/os</span>
<span class="token instruction"><span class="token keyword">COPY</span> packages.yaml .</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">mikefarah/yq:4.11.1</span></span> /usr/bin/yq /usr/bin/yq</span>

<span class="token comment"># 根据配置文件解析该 OS 需要构建的包，并获取这些包的下载 url</span>
<span class="token instruction"><span class="token keyword">RUN</span> yq eval <span class="token string">'.common[],.yum[],.centos7[],.kubespray.common[],.kubespray.yum[]'</span> packages.yaml > packages.list <span class="token operator">\</span>
    &amp;&amp; sort -u packages.list | xargs repotrack --urls | sort -u > packages.urls</span>

<span class="token comment"># 通过 wget 的方式下载 rpm 包，使用 createrepo 创建 repo 索引文件</span>
<span class="token instruction"><span class="token keyword">RUN</span> ARCH=$(uname -m) <span class="token operator">\</span>
    &amp;&amp; wget -q -x -P <span class="token variable">$&#123;ARCH&#125;</span> -i packages.urls <span class="token operator">\</span>
    &amp;&amp; createrepo -d <span class="token variable">$&#123;ARCH&#125;</span></span>

<span class="token comment"># 将构建的内容 COPY 成单独的一层</span>
<span class="token instruction"><span class="token keyword">FROM</span> scratch</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">os-centos7</span></span> /centos /centos</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/k8sli/os-packages/blob/main/packages.yaml">packages.yaml</a> 配置文件</li>
</ul>
<p>这个是需要安装包的配置文件，可以根据平台或者客户的一些要求配置上不同的包</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">kubespray</span><span class="token punctuation">:</span>
  <span class="token key atrule">common</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> curl
    <span class="token punctuation">-</span> rsync
    <span class="token punctuation">-</span> socat
    <span class="token punctuation">-</span> unzip
    <span class="token punctuation">-</span> e2fsprogs
    <span class="token punctuation">-</span> xfsprogs
    <span class="token punctuation">-</span> ebtables
    <span class="token punctuation">-</span> bash<span class="token punctuation">-</span>completion
    <span class="token punctuation">-</span> ipvsadm
    <span class="token punctuation">-</span> ipset
    <span class="token punctuation">-</span> conntrack

  <span class="token key atrule">yum</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> nss
    <span class="token punctuation">-</span> libselinux<span class="token punctuation">-</span>python
    <span class="token punctuation">-</span> device<span class="token punctuation">-</span>mapper<span class="token punctuation">-</span>libs
  <span class="token key atrule">apt</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> python<span class="token punctuation">-</span>apt
    <span class="token punctuation">-</span> python3<span class="token punctuation">-</span>apt
    <span class="token punctuation">-</span> aufs<span class="token punctuation">-</span>tools
    <span class="token punctuation">-</span> apt<span class="token punctuation">-</span>transport<span class="token punctuation">-</span>https
    <span class="token punctuation">-</span> software<span class="token punctuation">-</span>properties<span class="token punctuation">-</span>common

<span class="token key atrule">common</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> cifs<span class="token punctuation">-</span>utils
  <span class="token punctuation">-</span> lsof
  <span class="token punctuation">-</span> lvm2
  <span class="token punctuation">-</span> openssl
  <span class="token punctuation">-</span> sshpass
  <span class="token punctuation">-</span> vim
  <span class="token punctuation">-</span> wget
  <span class="token punctuation">-</span> ethtool
  <span class="token punctuation">-</span> net<span class="token punctuation">-</span>tools
  <span class="token punctuation">-</span> rsync
  <span class="token punctuation">-</span> chrony

<span class="token key atrule">yum</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> nfs<span class="token punctuation">-</span>utils
  <span class="token punctuation">-</span> yum<span class="token punctuation">-</span>utils
  <span class="token punctuation">-</span> createrepo
  <span class="token punctuation">-</span> epel<span class="token punctuation">-</span>release
  <span class="token punctuation">-</span> nc
  <span class="token punctuation">-</span> httpd<span class="token punctuation">-</span>tools

<span class="token key atrule">apt</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> nfs<span class="token punctuation">-</span>common
  <span class="token punctuation">-</span> apt<span class="token punctuation">-</span>transport<span class="token punctuation">-</span>https
  <span class="token punctuation">-</span> ca<span class="token punctuation">-</span>certificates
  <span class="token punctuation">-</span> gnupg
  <span class="token punctuation">-</span> lsb<span class="token punctuation">-</span>release
  <span class="token punctuation">-</span> aptitude
  <span class="token punctuation">-</span> dpkg<span class="token punctuation">-</span>dev
  <span class="token punctuation">-</span> gnupg2
  <span class="token punctuation">-</span> netcat
  <span class="token punctuation">-</span> apache2<span class="token punctuation">-</span>utils

<span class="token key atrule">centos7</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> containerd.io<span class="token punctuation">-</span>1.4.6

<span class="token key atrule">ubuntu</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> containerd.io=1.4.6<span class="token punctuation">-</span><span class="token number">1</span>

<span class="token key atrule">debian10</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> containerd.io=1.4.6<span class="token punctuation">-</span><span class="token number">1</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>对于 toB 产品，建议将下面这些常见的运维调试工具（如 tcpdump, strace, lsof, net-tools 等）也构建在离线源中。这样也不至于在客户的环境中排查问题的时候机器上连个 tcpdump 都没有，尤其是在无网的环境中，如果没有这些常用的运维工具，排查问题将会十分棘手。</p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">tools</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> bash<span class="token punctuation">-</span>completion
  <span class="token punctuation">-</span> chrony
  <span class="token punctuation">-</span> cifs<span class="token punctuation">-</span>utils
  <span class="token punctuation">-</span> curl
  <span class="token punctuation">-</span> dstat
  <span class="token punctuation">-</span> e2fsprogs
  <span class="token punctuation">-</span> ebtables
  <span class="token punctuation">-</span> expect
  <span class="token punctuation">-</span> gdb
  <span class="token punctuation">-</span> htop
  <span class="token punctuation">-</span> iftop
  <span class="token punctuation">-</span> iotop
  <span class="token punctuation">-</span> ipset
  <span class="token punctuation">-</span> ipvsadm
  <span class="token punctuation">-</span> jq
  <span class="token punctuation">-</span> lsof
  <span class="token punctuation">-</span> lvm2
  <span class="token punctuation">-</span> ncdu
  <span class="token punctuation">-</span> net<span class="token punctuation">-</span>tools
  <span class="token punctuation">-</span> nethogs
  <span class="token punctuation">-</span> nload
  <span class="token punctuation">-</span> ntpdate
  <span class="token punctuation">-</span> openssl
  <span class="token punctuation">-</span> pciutils
  <span class="token punctuation">-</span> psmisc
  <span class="token punctuation">-</span> rsync
  <span class="token punctuation">-</span> smartmontools
  <span class="token punctuation">-</span> socat
  <span class="token punctuation">-</span> sshpass
  <span class="token punctuation">-</span> strace
  <span class="token punctuation">-</span> sysstat
  <span class="token punctuation">-</span> tcpdump
  <span class="token punctuation">-</span> telnet
  <span class="token punctuation">-</span> tmux<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="kubespray-2"><a href="#kubespray-2" class="headerlink" title="kubespray"></a>kubespray</h3><p>kubespray 是部署 K8s 集群、增加节点、删除节点、移除集群等涉及对集群操作的主要工具。我们依旧采用容器化的方式运行 kubespray，主要有以下场景会用到 kubespray：</p>
<ul>
<li>在部署工具运行节点，使用 nerdctl 来运行 kubespray 容器部署  K8s 集群</li>
<li>K8s 集群部署完毕后，以 Job pod 的方式运行部署另一个 K8s 集群，实现多集群部署的基本能力</li>
<li>K8s 集群部署完毕后，以 Job pod 的方式运行 kubespray 对该集群集群节点进行扩缩容</li>
</ul>
<p>Job pod 方式对集群进行扩缩容的设计的是为了从一定程度上解决部署大规模集群时 ansible 性能问题。即我们一开始不必就部署一个上千节点的集群，而是先把一个规模较小的集群部署起来，然后通过创建批量的 Job 的方式运行 kubespray 再将集群慢慢扩容起来，比如扩容到上千台节点。</p>
<p>kubespray 官方的 Dockerfile 构建出来的镜像有 1.4GB，实在是太大了，因此我们需要优化一下，减少镜像大小</p>
<ul>
<li>kubespray BASE 镜像</li>
</ul>
<p>首先构建一个 base 镜像，对于不经常变动的内容我们把它封装在一个 base 镜像里，只有当相关依赖更新了才需要重新构建这个 base 镜像，<code>Dockerfile.base</code> 如下：</p>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> python:3 <span class="token keyword">as</span> builder</span>
<span class="token instruction"><span class="token keyword">ARG</span> KUBE_VERSION=v1.21.3</span>
<span class="token instruction"><span class="token keyword">COPY</span> requirements.txt requirements.txt</span>
<span class="token instruction"><span class="token keyword">COPY</span> tests/requirements.txt tests/requirements.txt</span>
<span class="token instruction"><span class="token keyword">RUN</span> echo <span class="token string">'shellcheck-py==0.7.2.1'</span> >> requirements.txt <span class="token operator">\</span>
    &amp;&amp; grep -E <span class="token string">'^yamllint|^ansible-lint'</span> tests/requirements.txt >> requirements.txt <span class="token operator">\</span>
    &amp;&amp; pip3 install --user -r requirements.txt</span>

<span class="token instruction"><span class="token keyword">RUN</span> ARCH=$(uname -m | sed <span class="token string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) <span class="token operator">\</span>
    &amp;&amp; wget -O /root/.local/bin/kubectl -q https://dl.k8s.io/<span class="token variable">$&#123;KUBE_VERSION&#125;</span>/bin/linux/<span class="token variable">$&#123;ARCH&#125;</span>/kubectl <span class="token operator">\</span>
	&amp;&amp; chmod a+x /root/.local/bin/kubectl</span>

<span class="token instruction"><span class="token keyword">FROM</span> python:3-slim</span>
<span class="token instruction"><span class="token keyword">RUN</span> DEBIAN_FRONTEND=noninteractive apt-get update -y -qq <span class="token operator">\</span>
    &amp;&amp; apt-get install -y -qq --no-install-recommends <span class="token operator">\</span>
        ca-certificates libssl-dev openssh-client sshpass curl gnupg2 rsync <span class="token operator">\</span>
        jq moreutils vim iputils-ping wget tcpdump xz-utils <span class="token operator">\</span>
    &amp;&amp; rm -rf /var/lib/apt/lists/*</span>

<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /root/.local /usr/local</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /kubespray</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a href="">kubespray 镜像</a></li>
</ul>
<p>FROM 的 base 镜像就使用我们刚刚构建好的镜像，相关依赖已经在 base 镜像中安装好了，这里构建的时候只需要把 repo 源码复制到 &#x2F;kubespray 目录下即可，内容如下：</p>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">ARG</span> BASE_IMAGE=ghcr.io/k8sli/kubespray-base</span>
<span class="token instruction"><span class="token keyword">ARG</span> BASE_IMAGE_VERSION=latest</span>
<span class="token instruction"><span class="token keyword">FROM</span> <span class="token variable">$BASE_IMAGE</span>:<span class="token variable">$BASE_IMAGE_VERSION</span></span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /kubespray</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>kubespray 集群部署入口 <code>run.sh</code></li>
</ul>
<p>将集群部署、增加节点、删除节点、删除集群等操作封装成一个入口的脚本，提供外部工具调用该脚本，不然外部调用的时候直接运行 <code>ansible-playbook</code> 命令实在是不太方便。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">TYPE</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">NODES</span><span class="token operator">=</span><span class="token variable">$2</span>

<span class="token assign-left variable">KUBE_ROOT</span><span class="token operator">=</span><span class="token string">"$(cd "<span class="token variable"><span class="token variable">$(</span><span class="token function">dirname</span> <span class="token string">"<span class="token variable">$0</span>"</span><span class="token variable">)</span></span>"</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">pwd</span><span class="token punctuation">)</span><span class="token string">"

: <span class="token variable">$&#123;TYPE<span class="token operator">:=</span>deploy-cluster&#125;</span>
: <span class="token variable">$&#123;ANSIBLE_FORKS<span class="token operator">:=</span>10&#125;</span>
: <span class="token variable">$&#123;BECOME_USER<span class="token operator">:=</span>root&#125;</span>
: <span class="token variable">$&#123;ANSIBLE_LOG_FORMAT<span class="token operator">:=</span>yaml&#125;</span>
: <span class="token variable">$&#123;INVENTORY<span class="token operator">:=</span>$&#123;KUBE_ROOT&#125;</span>/config/inventory&#125;
: <span class="token variable">$&#123;ENV_FILE<span class="token operator">:=</span>$&#123;KUBE_ROOT&#125;</span>/config/env.yml&#125;
: <span class="token variable">$&#123;INSTALL_STEPS_FILE<span class="token operator">:=</span>$&#123;KUBE_ROOT&#125;</span>/config/.install_steps&#125;

export ANSIBLE_STDOUT_CALLBACK=<span class="token variable">$&#123;ANSIBLE_LOG_FORMAT&#125;</span>
export ANSIBLE_ARGS="</span><span class="token parameter variable">-f</span> <span class="token variable">$&#123;ANSIBLE_FORKS&#125;</span> <span class="token parameter variable">--become</span> --become-user<span class="token operator">=</span><span class="token variable">$&#123;BECOME_USER&#125;</span> <span class="token parameter variable">-i</span> <span class="token variable">$&#123;INVENTORY&#125;</span> <span class="token parameter variable">-e</span> @<span class="token variable">$&#123;ENV_FILE&#125;</span><span class="token string">"

#
# Set logging colors
#

NORMAL_COL=<span class="token variable"><span class="token variable">$(</span>tput sgr0<span class="token variable">)</span></span>
RED_COL=<span class="token variable"><span class="token variable">$(</span>tput setaf <span class="token number">1</span><span class="token variable">)</span></span>
WHITE_COL=<span class="token variable"><span class="token variable">$(</span>tput setaf <span class="token number">7</span><span class="token variable">)</span></span>
GREEN_COL=<span class="token variable"><span class="token variable">$(</span>tput setaf <span class="token number">76</span><span class="token variable">)</span></span>
YELLOW_COL=<span class="token variable"><span class="token variable">$(</span>tput setaf <span class="token number">202</span><span class="token variable">)</span></span>

debuglog()&#123; printf "</span><span class="token variable">$&#123;WHITE_COL&#125;</span>%s<span class="token variable">$&#123;NORMAL_COL&#125;</span><span class="token punctuation">\</span>n<span class="token string">" "</span><span class="token variable">$@</span><span class="token string">"; &#125;
infolog()&#123; printf "</span><span class="token variable">$&#123;GREEN_COL&#125;</span>✔ %s<span class="token variable">$&#123;NORMAL_COL&#125;</span><span class="token punctuation">\</span>n<span class="token string">" "</span><span class="token variable">$@</span><span class="token string">"; &#125;
warnlog()&#123; printf "</span><span class="token variable">$&#123;YELLOW_COL&#125;</span>➜ %s<span class="token variable">$&#123;NORMAL_COL&#125;</span><span class="token punctuation">\</span>n<span class="token string">" "</span><span class="token variable">$@</span><span class="token string">"; &#125;
errorlog()&#123; printf "</span><span class="token variable">$&#123;RED_COL&#125;</span>✖ %s<span class="token variable">$&#123;NORMAL_COL&#125;</span><span class="token punctuation">\</span>n<span class="token string">" "</span><span class="token variable">$@</span><span class="token string">"; &#125;

set -eo pipefail

if [[ ! -f <span class="token variable">$&#123;INVENTORY&#125;</span> ]]; then
  errorlog "</span><span class="token variable">$&#123;INVENTORY&#125;</span> <span class="token function">file</span> is missing, please check the inventory <span class="token function">file</span> is exists<span class="token string">"
  exit 1
fi

deploy_cluster()&#123;
:
&#125;

main()&#123;
  case <span class="token variable">$TYPE</span> in
    deploy-cluster)
      infolog "</span><span class="token comment">#</span><span class="token comment">#####  start deploy kubernetes cluster  ######"</span>
      deploy_cluster
      infolog <span class="token string">"######  kubernetes cluster successfully installed  ######"</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
    remove-cluster<span class="token punctuation">)</span>
      infolog <span class="token string">"######  start remove kubernetes cluster  ######"</span>
      <span class="token keyword">if</span> ansible-playbook <span class="token variable">$&#123;ANSIBLE_ARGS&#125;</span> <span class="token variable">$&#123;KUBE_ROOT&#125;</span>/reset.yml <span class="token operator">></span>/dev/stdout <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/stderr<span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token function">rm</span> <span class="token parameter variable">-f</span> <span class="token variable">$&#123;INSTALL_STEP_FILE&#125;</span>
        infolog <span class="token string">"######  kubernetes cluster successfully removed ######"</span>
      <span class="token keyword">fi</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
    add-node<span class="token punctuation">)</span>
      check_nodename
      infolog <span class="token string">"######  start add worker to kubernetes cluster  ######"</span>
      ansible-playbook <span class="token variable">$&#123;ANSIBLE_ARGS&#125;</span> <span class="token parameter variable">--limit</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;NODES&#125;</span>"</span> <span class="token variable">$&#123;KUBE_ROOT&#125;</span>/playbooks/10-scale-nodes.yml <span class="token operator">></span>/dev/stdout <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/stderr
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
    remove-node<span class="token punctuation">)</span>
      check_nodename
      infolog <span class="token string">"######  start remove worker from kubernetes cluster  ######"</span>
      ansible-playbook <span class="token variable">$&#123;ANSIBLE_ARGS&#125;</span> <span class="token parameter variable">-e</span> <span class="token assign-left variable">node</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;NODES&#125;</span>"</span> <span class="token parameter variable">-e</span> <span class="token assign-left variable">reset_nodes</span><span class="token operator">=</span>true <span class="token variable">$&#123;KUBE_ROOT&#125;</span>/remove-node.yml <span class="token operator">></span>/dev/stdout <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/stderr
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
    *<span class="token punctuation">)</span>
      errorlog <span class="token string">"unknow [TYPE] parameter: <span class="token variable">$&#123;TYPE&#125;</span>"</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token keyword">esac</span>
<span class="token punctuation">&#125;</span>

main <span class="token string">"<span class="token variable">$@</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>分层部署 <a target="_blank" rel="noopener" href="https://github.com/k8sli/kubespray/tree/main/playbooks">playbooks</a></li>
</ul>
<p>不同于 kubespray 官方使用一个完整的 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kubespray/blob/master/cluster.yml">cluster.yaml</a> 来完成整个 K8s 集群的部署，我们在这里引入了分层部署的特性。即将集群部署分成若干个相互独立的 playbook，然后在各个 playbook 里引入我们增加的 roles 以及二开内容。这样的好处就是能和 kubespray 上游的代码保持相互独立，在 rebase 或者 cherry-pick 上游最新的代码能够避免出现冲突的现象。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">playbooks
├── 00-default-ssh-config.yml    <span class="token comment"># 配置 ssh 连接</span>
├── 01-cluster-bootstrap-os.yml  <span class="token comment"># 初始化集群节点</span>
├── 02-cluster-etcd.yml          <span class="token comment"># 部署 etcd 集群</span>
├── 03-cluster-kubernetes.yml    <span class="token comment"># 部署 k8s master 和 node</span>
├── 04-cluster-network.yml       <span class="token comment"># 部署 CNI 插件</span>
├── 05-cluster-apps.yml          <span class="token comment"># 部署一些 addon 组件如 coredns</span>
└── <span class="token number">10</span>-scale-nodes.yml           <span class="token comment"># 增删节点</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>分层部署的时候通过一个文件来记录已经部署成功的步骤，这样如果本次因为一些原因导致部署失败（如网络中断），那么下次重新部署的时候会跳过已经部署好的步骤，从失败的地方继续部署，以提升整体的部署效率。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function-name function">deploy_cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token function">touch</span> <span class="token variable">$&#123;INSTALL_STEPS_FILE&#125;</span>
  <span class="token assign-left variable">STEPS</span><span class="token operator">=</span><span class="token string">"00-default-ssh-config 01-cluster-bootstrap-os 02-cluster-etcd 03-cluster-kubernetes 04-cluster-network 05-cluster-apps"</span>
  <span class="token keyword">for</span> <span class="token for-or-select variable">step</span> <span class="token keyword">in</span> <span class="token variable">$&#123;STEPS&#125;</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> <span class="token operator">!</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">"<span class="token variable">$&#123;step&#125;</span>"</span> <span class="token variable">$&#123;INSTALL_STEPS_FILE&#125;</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      infolog <span class="token string">"start deploy <span class="token variable">$&#123;step&#125;</span>"</span>
      <span class="token keyword">if</span> ansible-playbook <span class="token variable">$&#123;ANSIBLE_ARGS&#125;</span> <span class="token variable">$&#123;KUBE_ROOT&#125;</span>/playbooks/<span class="token variable">$&#123;step&#125;</span>.yml<span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token builtin class-name">echo</span> <span class="token variable">$&#123;step&#125;</span> <span class="token operator">>></span> <span class="token variable">$&#123;INSTALL_STEPS_FILE&#125;</span>
        infolog <span class="token string">"<span class="token variable">$&#123;step&#125;</span> successfully installed"</span>
      <span class="token keyword">else</span>
        errorlog <span class="token string">"<span class="token variable">$&#123;step&#125;</span> installation failed"</span>
        <span class="token builtin class-name">exit</span> <span class="token number">1</span>
      <span class="token keyword">fi</span>
    <span class="token keyword">else</span>
      warnlog <span class="token string">"<span class="token variable">$&#123;step&#125;</span> is already installed, so skipped..."</span>
    <span class="token keyword">fi</span>
  <span class="token keyword">done</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="文件和镜像"><a href="#文件和镜像" class="headerlink" title="文件和镜像"></a>文件和镜像</h3><p>我们需要提取出 kubespray 部署的时候依赖的文件和镜像，生成一个文件列表和镜像列表，然后根据这些列表下载并构建到一个镜像里。</p>
<ul>
<li>文件</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Download URLs</span>
<span class="token key atrule">kubelet_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kube_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubelet"</span>
<span class="token key atrule">kubectl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kube_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubectl"</span>
<span class="token key atrule">kubeadm_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kube_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubeadm"</span>
<span class="token key atrule">etcd_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/coreos/etcd/releases/download/&#123;&#123; etcd_version &#125;&#125;/etcd-&#123;&#123; etcd_version &#125;&#125;-linux-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token key atrule">cni_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/containernetworking/plugins/releases/download/&#123;&#123; cni_version &#125;&#125;/cni-plugins-linux-&#123;&#123; image_arch &#125;&#125;-&#123;&#123; cni_version &#125;&#125;.tgz"</span>
<span class="token key atrule">calicoctl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/projectcalico/calicoctl/releases/download/&#123;&#123; calico_ctl_version &#125;&#125;/calicoctl-linux-&#123;&#123; image_arch &#125;&#125;"</span>
<span class="token key atrule">calico_crds_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/projectcalico/calico/archive/&#123;&#123; calico_version &#125;&#125;.tar.gz"</span>
<span class="token key atrule">crictl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/kubernetes-sigs/cri-tools/releases/download/&#123;&#123; crictl_version &#125;&#125;/crictl-&#123;&#123; crictl_version &#125;&#125;-&#123;&#123; ansible_system | lower &#125;&#125;-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token key atrule">helm_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/get.helm.sh/helm-&#123;&#123; helm_version &#125;&#125;-linux-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token key atrule">nerdctl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/containerd/nerdctl/releases/download/v&#123;&#123; nerdctl_version &#125;&#125;/nerdctl-&#123;&#123; nerdctl_version &#125;&#125;-&#123;&#123; ansible_system | lower &#125;&#125;-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token key atrule">patched_kubeadm_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/k8sli/kubernetes/releases/download/&#123;&#123; kubeadm_patch_version &#125;&#125;/kubeadm-linux-&#123;&#123; image_arch &#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在构建安装包的时候，将 download_url 变量设置为 <code>https://</code> ，在部署的时候将 <code>download_url</code> 设置为内网 文件服务器服务器的 URL，比如 <code>https://172.20.0.25:8080/files</code>，这样就可以实现文件构建和部署使用的统一，节省维护成本。</p>
<ul>
<li>镜像</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Define image repo and tag overwrite role/download/default/main.yml</span>
<span class="token key atrule">pod_infra_image_tag</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; pod_infra_version &#125;&#125;"</span>
<span class="token key atrule">pod_infra_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; kube_image_repo &#125;&#125;/pause"</span>

<span class="token key atrule">kube_proxy_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; kube_image_repo &#125;&#125;/kube-proxy"</span>
<span class="token key atrule">kube_apiserver_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; kube_image_repo &#125;&#125;/kube-apiserver"</span>
<span class="token key atrule">kube_scheduler_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; kube_image_repo &#125;&#125;/kube-scheduler"</span>
<span class="token key atrule">kube_controller_manager_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; kube_image_repo &#125;&#125;/kube-controller-manager"</span>

<span class="token key atrule">coredns_image_tag</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; coredns_version &#125;&#125;"</span>
<span class="token key atrule">dnsautoscaler_image_tag</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; dnsautoscaler_version &#125;&#125;"</span>
<span class="token key atrule">coredns_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; docker_image_repo &#125;&#125;/coredns"</span>
<span class="token key atrule">dnsautoscaler_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; kube_image_repo &#125;&#125;/cluster-proportional-autoscaler-&#123;&#123; image_arch &#125;&#125;"</span>

<span class="token comment"># Full image name for generate images list</span>
<span class="token key atrule">kube_proxy_image_name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; kube_proxy_image_repo &#125;&#125;:&#123;&#123; kube_version &#125;&#125;"</span>
<span class="token key atrule">kube_apiserver_image_name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; kube_apiserver_image_repo &#125;&#125;:&#123;&#123; kube_version &#125;&#125;"</span>
<span class="token key atrule">kube_scheduler_image_name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; kube_scheduler_image_repo &#125;&#125;:&#123;&#123; kube_version &#125;&#125;"</span>
<span class="token key atrule">kube_controller_manager_image_name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; kube_controller_manager_image_repo &#125;&#125;:&#123;&#123; kube_version &#125;&#125;"</span>
<span class="token key atrule">coredns_image_name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; coredns_image_repo &#125;&#125;:&#123;&#123; coredns_image_tag &#125;&#125;"</span>
<span class="token key atrule">dnsautoscaler_image_name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; dnsautoscaler_image_repo &#125;&#125;:&#123;&#123; dnsautoscaler_image_tag &#125;&#125;"</span>
<span class="token key atrule">nginx_image_name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; nginx_image_repo &#125;&#125;:&#123;&#123; nginx_image_tag &#125;&#125;"</span>
<span class="token key atrule">pod_infra_image_name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; pod_infra_image_repo &#125;&#125;:&#123;&#123; pod_infra_image_tag &#125;&#125;"</span>
<span class="token key atrule">calico_policy_image_name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; calico_policy_image_repo &#125;&#125;:&#123;&#123; calico_policy_image_tag &#125;&#125;"</span>
<span class="token key atrule">calico_cni_image_name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; calico_cni_image_repo &#125;&#125;:&#123;&#123; calico_cni_image_tag &#125;&#125;"</span>
<span class="token key atrule">calico_node_image_name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; calico_node_image_repo &#125;&#125;:&#123;&#123; calico_node_image_tag &#125;&#125;"</span>
<span class="token key atrule">flannel_image_name</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; flannel_image_repo &#125;&#125;:&#123;&#123; flannel_image_tag &#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>generate.sh</code> 列表生成脚本</li>
</ul>
<p>我们根据上面 group_vars 中定义的版本号和一些参数，使用脚本的方式自动生成一个文件列表和镜像列表，构建的时候根据这些列表来下载所需要的文件和镜像。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">set</span> <span class="token parameter variable">-eo</span> pipefail

<span class="token assign-left variable">SCRIPT_PATH</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">cd</span> <span class="token punctuation">$(</span>dirname $0<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>
<span class="token assign-left variable">REPO_PATH</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;SCRIPT_PATH<span class="token operator">%</span><span class="token operator">/</span>build&#125;</span>"</span>

<span class="token builtin class-name">:</span> <span class="token variable">$&#123;IMAGE_ARCH<span class="token operator">:=</span>"amd64"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;ANSIBLE_ARCHITECTURE<span class="token operator">:=</span>"x86_64"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;DOWNLOAD_YML<span class="token operator">:=</span>"config<span class="token operator">/</span>group_vars<span class="token operator">/</span>all<span class="token operator">/</span>download.yml"&#125;</span>

<span class="token comment"># ARCH used in convert &#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125; to &#123;&#123;arch&#125;&#125;</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$&#123;IMAGE_ARCH&#125;</span>"</span> <span class="token operator">!=</span> <span class="token string">"amd64"</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span><span class="token string">"-<span class="token variable">$&#123;IMAGE_ARCH&#125;</span>"</span><span class="token punctuation">;</span> <span class="token keyword">fi</span>

<span class="token function">cat</span> <span class="token operator">></span> /tmp/generate.sh <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
arch=<span class="token variable">$&#123;ARCH&#125;</span>
download_url=https:/
image_arch=<span class="token variable">$&#123;IMAGE_ARCH&#125;</span>
ansible_system=linux
ansible_architecture=<span class="token variable">$&#123;ANSIBLE_ARCHITECTURE&#125;</span>
registry_project=library
registry_domain=localhost
EOF</span>

<span class="token comment"># generate all component version by $DOWNLOAD_YML</span>
<span class="token function">grep</span> <span class="token string">'_version:'</span> <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;DOWNLOAD_YML&#125;</span> <span class="token punctuation">\</span>
<span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">' '</span> <span class="token operator">>></span> /tmp/generate.sh

<span class="token comment"># generate download files url list</span>
<span class="token function">grep</span> <span class="token string">'_download_url:'</span> <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;DOWNLOAD_YML&#125;</span> <span class="token punctuation">\</span>
<span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/: /=/g;s/ //g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g;s/|lower//g;s/^.*_url=/echo /g'</span> <span class="token operator">>></span> /tmp/generate.sh

<span class="token comment"># generate download images list</span>
<span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'_image_tag:|_image_repo:|_image_name:'</span> <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;DOWNLOAD_YML&#125;</span> <span class="token punctuation">\</span>
<span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">"s#&#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125;#&#123;&#123;arch&#125;&#125;#g"</span> <span class="token punctuation">\</span>
<span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token parameter variable">-d</span> <span class="token string">' '</span> <span class="token operator">>></span> /tmp/generate.sh

<span class="token function">grep</span> <span class="token string">'_image_name:'</span> <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;DOWNLOAD_YML&#125;</span> <span class="token punctuation">\</span>
<span class="token operator">|</span> <span class="token function">cut</span> <span class="token parameter variable">-d</span> <span class="token string">':'</span> <span class="token parameter variable">-f1</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/^/echo $/g'</span> <span class="token operator">>></span> /tmp/generate.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>为了同时支持 amd64 和 arm64 的 CPU 架构，需要为两种架构各自生成列表，需要特殊处理一下。在这里踩的一个坑就是不同的组件镜像的命名方法千差万别，大致可以分为如下四种情况：</p>
<ul>
<li>像 kube-apiserver 这些 k8s 组件的镜像，镜像名称和镜像 tag 是不需要加上 CPU 体系架构的；</li>
<li>cluster-proportional-autoscaler 的镜像则是在镜像的名称后面加上了 CPU 体系架构的名称如 cluster-proportional-autoscaler-amd64，cluster-proportional-autoscaler-arm64；</li>
<li>flannel 则是将 CPU 体系架构名称定义在镜像 tag 后面比如 <code>flannel:v0.14.0-amd64</code>；</li>
<li>还有 calico 更奇葩，amd64 架构的镜像不需要加体系架构的名称如 <code>calico/cni:v3.18.4</code>，而 arm64 的则必须要在镜像 tag 后面带上 CPU 体系架构比如 <code>calico/cni:v3.18.4-arm64</code>；</li>
</ul>
<p><img data-src="https://p.k8s.li/2021-08-31-pass-tob-k8s-offline-deploy-2.jpeg"></p>
<p>在这里需要强调一下，文件列表和镜像列表一定要使用自动化的方式来管理，切勿手动更新，这样能节省大量的维护成本，不然的话每次都手动去更新这些列表成本实在是太高了，而且特别容易出出错或者遗漏某个组件。</p>
<h3 id="kubespray-files"><a href="#kubespray-files" class="headerlink" title="kubespray-files"></a>kubespray-files</h3><p>我们将 kubespray 部署所依赖的二进制文件构建在一个名为 kubespray-files 的镜像当中：</p>
<ul>
<li>生成的文件列表</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">https://get.helm.sh/helm-v3.6.3-linux-amd64.tar.gz
https://github.com/containerd/nerdctl/releases/download/v0.8.1/nerdctl-0.8.1-linux-amd64.tar.gz
https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz
https://github.com/coreos/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz
https://github.com/k8sli/kubernetes/releases/download/v1.21.3-patch-1.0/kubeadm-linux-amd64
https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.21.0/crictl-v1.21.0-linux-amd64.tar.gz
https://github.com/projectcalico/calico/archive/v3.18.4.tar.gz
https://github.com/projectcalico/calicoctl/releases/download/v3.18.4/calicoctl-linux-amd64
https://storage.googleapis.com/kubernetes-release/release/v1.21.3/bin/linux/amd64/kubeadm
https://storage.googleapis.com/kubernetes-release/release/v1.21.3/bin/linux/amd64/kubectl
https://storage.googleapis.com/kubernetes-release/release/v1.21.3/bin/linux/amd64/kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Dockerfile</li>
</ul>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> alpine:latest <span class="token keyword">as</span> files</span>
<span class="token instruction"><span class="token keyword">RUN</span> apk --no-cache add wget ca-certificates</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /build</span>
<span class="token instruction"><span class="token keyword">COPY</span> build/kubespray-files/files_*.list /build/</span>
<span class="token instruction"><span class="token keyword">RUN</span> ARCH=$(uname -m | sed <span class="token string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) <span class="token operator">\</span>
    &amp;&amp; sed <span class="token string">'/#/d'</span> *<span class="token variable">$&#123;ARCH&#125;</span>.list > all_files.list <span class="token operator">\</span>
    &amp;&amp; wget -q -x -P /files -i all_files.list</span>

<span class="token instruction"><span class="token keyword">FROM</span> scratch</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">files</span></span> /files /files</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>构建后的目录结构，通过目录层级的方式保留原有的 URL 地址，维护和使用起来比较方便</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">files/
├── get.helm.sh
│   └── helm-v3.6.3-linux-amd64.tar.gz
├── github.com
│   ├── containerd
│   │   └── nerdctl
│   │       └── releases
│   │           └── download
│   │               └── v0.8.1
│   │                   └── nerdctl-0.8.1-linux-amd64.tar.gz
│   ├── containernetworking
│   │   └── plugins
│   │       └── releases
│   │           └── download
│   │               └── v0.9.1
│   │                   └── cni-plugins-linux-amd64-v0.9.1.tgz
│   ├── coreos
│   │   └── etcd
│   │       └── releases
│   │           └── download
│   │               └── v3.4.13
│   │                   └── etcd-v3.4.13-linux-amd64.tar.gz
│   ├── k8sli
│   │   └── kubernetes
│   │       └── releases
│   │           └── download
│   │               └── v1.21.3-patch-1.0
│   │                   └── kubeadm-linux-amd64
│   ├── kubernetes-sigs
│   │   └── cri-tools
│   │       └── releases
│   │           └── download
│   │               └── v1.21.0
│   │                   └── crictl-v1.21.0-linux-amd64.tar.gz
│   └── projectcalico
│       ├── calico
│       │   └── archive
│       │       └── v3.18.4.tar.gz
│       └── calicoctl
│           └── releases
│               └── download
│                   └── v3.18.4
│                       └── calicoctl-linux-amd64
└── storage.googleapis.com
    └── kubernetes-release
        └── release
            └── v1.21.3
                └── bin
                    └── linux
                        └── amd64
                            ├── kubeadm
                            ├── kubectl
                            └── kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="kubespray-images"><a href="#kubespray-images" class="headerlink" title="kubespray-images"></a>kubespray-images</h3><p>我们同样将 kubespray 部署所需要的组件镜像构建在一个名为 kubespray-images 的镜像当中：</p>
<ul>
<li>镜像列表</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">library/calico-cni:v3.18.4
library/calico-kube-controllers:v3.18.4
library/calico-node:v3.18.4
library/calico-pod2daemon-flexvol:v3.18.4
library/cluster-proportional-autoscaler-amd64:1.8.3
library/coredns:v1.8.0
library/flannel:v0.14.0-amd64
library/kube-apiserver:v1.21.3
library/kube-controller-manager:v1.21.3
library/kube-proxy:v1.21.3
library/kube-scheduler:v1.21.3
library/nginx:1.19
library/pause:3.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Dockerfile</li>
</ul>
<p>在 Dockerfile 里完成所有镜像的下载，并使用 《<a href="https://blog.k8s.li/skopeo-to-registry.html">如何使用 registry 存储的特性</a>》文中提到的骚操作，利用 registry 存储复用相同 layer 的特性，将 skopeo sync 下载的镜像转换成 registry 存储的结构。这样在部署的时候直接把这个 registry 存储目录挂载进 registry 容器的 <code>/var/lib/registry</code> 即可。特点是性能方面无论是构建和部署，都比常规使用 docker save 和 docker load 的方式要快至少 5 到 10 倍。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">FROM alpine:3.12 as images
ARG <span class="token assign-left variable">SKOPEO_VERSION</span><span class="token operator">=</span>v1.4.0
ARG <span class="token assign-left variable">YQ_VERSION</span><span class="token operator">=</span>v4.11.2
RUN <span class="token assign-left variable">ARCH</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-m</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/x86_64/amd64/;s/aarch64/arm64/'</span><span class="token variable">)</span></span> <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> apk --no-cache <span class="token function">add</span> <span class="token function">bash</span> <span class="token function">wget</span> ca-certificates <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">wget</span> <span class="token parameter variable">-q</span> <span class="token parameter variable">-k</span> https://github.com/mikefarah/yq/releases/download/<span class="token variable">$&#123;YQ_VERSION&#125;</span>/yq_linux_<span class="token variable">$&#123;ARCH&#125;</span> <span class="token parameter variable">-O</span> /usr/local/bin/yq <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">wget</span> <span class="token parameter variable">-q</span> <span class="token parameter variable">-k</span> https://github.com/k8sli/skopeo/releases/download/<span class="token variable">$&#123;SKOPEO_VERSION&#125;</span>/skopeo-linux-<span class="token variable">$&#123;ARCH&#125;</span> <span class="token parameter variable">-O</span> /usr/local/bin/skopeo <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">chmod</span> a+x /usr/local/bin/*

WORKDIR /build
COPY build/kubespray-images/*  /build/
RUN <span class="token assign-left variable">ARCH</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-m</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/x86_64/amd64/;s/aarch64/arm64/'</span><span class="token variable">)</span></span> <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token assign-left variable">IMAGE_ARCH</span><span class="token operator">=</span><span class="token variable">$&#123;ARCH&#125;</span> <span class="token function">bash</span> build.sh

FROM scratch
COPY <span class="token parameter variable">--from</span><span class="token operator">=</span>images /build/docker /docker<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>images_origin.yaml 镜像配置文件</li>
</ul>
<p>考虑到有将镜像导入到已经存在的镜像仓库中的场景，这里我们需要修改一下镜像仓库的 repo。因为 <code>library</code> 这个 repo 在 harbor 中是默认自带的，在导入到 harbor 的过程中也不需要创建一些额外的 project ，所以将所有镜像的 repo 全部统一为 <code>library</code> 更通用一些。</p>
<p>这里用一个 yaml 配置文件来记录原镜像地址和 library 镜像的地址的对应关系。比如上游的 <code>k8s.gcr.io/kube-apiserver</code> 映射为 <code>library/kube-apiserver</code>， <code>quay.io/calico/node</code> 映射为 <code>library/calico-node</code>。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token comment"># kubeadm core images</span>
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> k8s.gcr.io/kube<span class="token punctuation">-</span>apiserver
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/kube<span class="token punctuation">-</span>apiserver
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> k8s.gcr.io/kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> k8s.gcr.io/kube<span class="token punctuation">-</span>proxy
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/kube<span class="token punctuation">-</span>proxy
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> k8s.gcr.io/kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/kube<span class="token punctuation">-</span>scheduler
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> k8s.gcr.io/coredns/coredns
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/coredns
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> k8s.gcr.io/pause
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/pause

<span class="token comment"># kubernetes addons</span>
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> k8s.gcr.io/dns/k8s<span class="token punctuation">-</span>dns<span class="token punctuation">-</span>node<span class="token punctuation">-</span>cache
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/k8s<span class="token punctuation">-</span>dns<span class="token punctuation">-</span>node<span class="token punctuation">-</span>cache
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> k8s.gcr.io/cpa/cluster<span class="token punctuation">-</span>proportional<span class="token punctuation">-</span>autoscaler<span class="token punctuation">-</span>amd64
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/cluster<span class="token punctuation">-</span>proportional<span class="token punctuation">-</span>autoscaler<span class="token punctuation">-</span>amd64
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> k8s.gcr.io/cpa/cluster<span class="token punctuation">-</span>proportional<span class="token punctuation">-</span>autoscaler<span class="token punctuation">-</span>arm64
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/cluster<span class="token punctuation">-</span>proportional<span class="token punctuation">-</span>autoscaler<span class="token punctuation">-</span>arm64

<span class="token comment"># network plugin</span>
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> quay.io/calico/cni
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/calico<span class="token punctuation">-</span>cni
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> quay.io/calico/node
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/calico<span class="token punctuation">-</span>node
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> quay.io/calico/kube<span class="token punctuation">-</span>controllers
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> quay.io/calico/pod2daemon<span class="token punctuation">-</span>flexvol
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/calico<span class="token punctuation">-</span>pod2daemon<span class="token punctuation">-</span>flexvol

<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> quay.io/calico/typha
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/calico<span class="token punctuation">-</span>typha
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> quay.io/coreos/flannel
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/flannel


<span class="token comment"># nginx for daemonset and offline</span>
<span class="token punctuation">-</span> <span class="token key atrule">src</span><span class="token punctuation">:</span> docker.io/library/nginx
  <span class="token key atrule">dest</span><span class="token punctuation">:</span> library/nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="kubeplay-1"><a href="#kubeplay-1" class="headerlink" title="kubeplay"></a>kubeplay</h3><p>kubeplay 部署的代码主要是由一些 shell 脚本和配置文件构成，用于完成 nginx 服务和 registry 服务的部署，以及最后调用 kubespray 来完成集群部署。</p>
<ul>
<li>代码结构</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubeplay/
├── Dockerfile          <span class="token comment"># 构建完整安装包的 Dockerfile</span>
├── compose.yaml        <span class="token comment"># compose 启动配置 yaml 文件</span>
├── config
│   ├── compose
│   │   └── nginx.conf  <span class="token comment"># nginx 配置文件</span>
│   └── rootCA.cnf      <span class="token comment"># 生成镜像仓库证书用到的 openssl 配置文件</span>
├── config-sample.yaml  <span class="token comment"># 主配置文件</span>
├── install.sh          <span class="token comment"># 安装操作然后</span>
└── library             <span class="token comment"># 一些 shell 函数库</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Dockerfile</li>
</ul>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> alpine:latest <span class="token keyword">as</span> downloader</span>
<span class="token instruction"><span class="token keyword">ARG</span> SKOPEO_VERSION=v1.4.0</span>
<span class="token instruction"><span class="token keyword">ARG</span> YQ_VERSION=v4.11.2</span>
<span class="token instruction"><span class="token keyword">ARG</span> NERDCTL_VERSION=0.11.0</span>
<span class="token instruction"><span class="token keyword">ARG</span> NGINX_VERSION=1.20-alpine</span>
<span class="token instruction"><span class="token keyword">ARG</span> RERGISRRY_VERSION=2.7.1</span>
<span class="token instruction"><span class="token keyword">ARG</span> KUBESPRAY_VERSION=latest</span>
<span class="token instruction"><span class="token keyword">ARG</span> KUBESPRAY_IMAGE=ghcr.io/k8sli/kubespray</span>

<span class="token comment"># 下载部署时需要的工具，如 yq、skopeo、nerdctl-fullsss</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /tools</span>
<span class="token instruction"><span class="token keyword">RUN</span> ARCH=$(uname -m | sed <span class="token string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) <span class="token operator">\</span>
    &amp;&amp; apk --no-cache add wget ca-certificates <span class="token operator">\</span>
    &amp;&amp; wget -q -k https://github.com/mikefarah/yq/releases/download/<span class="token variable">$&#123;YQ_VERSION&#125;</span>/yq_linux_<span class="token variable">$&#123;ARCH&#125;</span>  -O /tools/yq-linux-<span class="token variable">$&#123;ARCH&#125;</span> <span class="token operator">\</span>
    &amp;&amp; wget -q -k https://github.com/k8sli/skopeo/releases/download/v1.4.0/skopeo-linux-<span class="token variable">$&#123;ARCH&#125;</span> -O /tools/skopeo-linux-<span class="token variable">$&#123;ARCH&#125;</span> <span class="token operator">\</span>
    &amp;&amp; wget -q -k https://github.com/containerd/nerdctl/releases/download/v<span class="token variable">$&#123;NERDCTL_VERSION&#125;</span>/nerdctl-full-<span class="token variable">$&#123;NERDCTL_VERSION&#125;</span>-linux-<span class="token variable">$&#123;ARCH&#125;</span>.tar.gz <span class="token operator">\</span>
    &amp;&amp; chmod a+x /tools/* <span class="token operator">\</span>
    &amp;&amp; ln -s /tools/skopeo-linux-<span class="token variable">$&#123;ARCH&#125;</span> /usr/bin/skopeo</span>

<span class="token comment"># 下载一些镜像，如 nginx、registry、kubespray</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /images</span>
<span class="token instruction"><span class="token keyword">RUN</span> ARCH=$(uname -m | sed <span class="token string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) <span class="token operator">\</span>
    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=false --override-arch <span class="token variable">$&#123;ARCH&#125;</span> --additional-tag nginx:<span class="token variable">$&#123;NGINX_VERSION&#125;</span> <span class="token operator">\</span>
       docker://docker.io/library/nginx:<span class="token variable">$&#123;NGINX_VERSION&#125;</span> docker-archive:nginx-<span class="token variable">$&#123;NGINX_VERSION&#125;</span>.tar <span class="token operator">\</span>
    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=false --override-arch <span class="token variable">$&#123;ARCH&#125;</span> --additional-tag registry:<span class="token variable">$&#123;RERGISRRY_VERSION&#125;</span> <span class="token operator">\</span>
       docker://docker.io/library/registry:<span class="token variable">$&#123;RERGISRRY_VERSION&#125;</span> docker-archive:registry-<span class="token variable">$&#123;RERGISRRY_VERSION&#125;</span>.tar <span class="token operator">\</span>
    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=false --override-arch <span class="token variable">$&#123;ARCH&#125;</span> --additional-tag kubespray:<span class="token variable">$&#123;KUBESPRAY_VERSION&#125;</span> <span class="token operator">\</span>
       docker://<span class="token variable">$&#123;KUBESPRAY_IMAGE&#125;</span>:<span class="token variable">$&#123;KUBESPRAY_VERSION&#125;</span> docker-archive:kubespray-<span class="token variable">$&#123;KUBESPRAY_VERSION&#125;</span>.tar</span>


<span class="token instruction"><span class="token keyword">FROM</span> scratch</span>
<span class="token instruction"><span class="token keyword">COPY</span> . .</span>
 <span class="token comment"># 将其它模块中的内容复制到 scratch 镜像中，构建的时候导出为 local 方式</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">downloader</span></span> /tools /resources/nginx/tools</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">downloader</span></span> /images /resources/images</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">$&#123;OS_PACKAGES_IMAGE&#125;:$&#123;OS_PACKAGE_REPO_TAG&#125;</span></span> / /resources/nginx</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">$&#123;KUBESPRAY_FILES_IMAGE&#125;:$&#123;KUBESPRAY_REPO_TAG&#125;</span></span> / /resources/nginx</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">$&#123;KUBESPRAY_IMAGES_IMAGE&#125;:$&#123;KUBESPRAY_REPO_TAG&#125;</span></span> / /resources/registry</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h3><p>由于最终的构建涉及多个模块和 repo，其流程比较复杂，详细的代码可参考源码 <a target="_blank" rel="noopener" href="https://github.com/k8sli/kubeplay/blob/main/.github/workflows/build.yaml">build.yaml</a> ，在这里只讲几个关键的部分</p>
<ul>
<li>checkout repo，将 kubespray 和 os-packages repo clone 到工作目录</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build-package</span><span class="token punctuation">:</span>
    <span class="token comment"># 以 tag 的事件触发构建流水线</span>
    <span class="token key atrule">if</span><span class="token punctuation">:</span> startsWith(github.ref<span class="token punctuation">,</span> 'refs/tags/')
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span><span class="token number">20.04</span>
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token comment"># fetch all git repo tag for define image tag</span>
          <span class="token key atrule">fetch-depth</span><span class="token punctuation">:</span> <span class="token number">0</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout kubespray repo
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">ref</span><span class="token punctuation">:</span> main
          <span class="token key atrule">fetch-depth</span><span class="token punctuation">:</span> <span class="token number">0</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> kubespray
          <span class="token key atrule">repository</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> github.repository_owner <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/kubespray

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout os<span class="token punctuation">-</span>packages repo
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">ref</span><span class="token punctuation">:</span> main
          <span class="token key atrule">fetch-depth</span><span class="token punctuation">:</span> <span class="token number">0</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> os<span class="token punctuation">-</span>packages
          <span class="token key atrule">repository</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> github.repository_owner <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/os<span class="token punctuation">-</span>packages<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>获取 kubespray 和 os-packages 的 repo tag，根据它来确定 os-packages, kubespray-files, kubespray-images 这个三个镜像的 tag，并生成一个 All in One 的 Dockerfile 用于完成后续安装包的构建。</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 获取一些组件的版本和变量传递给 Dockerfile</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Prepare for build images
  <span class="token key atrule">shell</span><span class="token punctuation">:</span> bash
  <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    git describe --tags --always | sed 's/^/IMAGE_TAG=/' >> $GITHUB_ENV</span>

    cd kubespray <span class="token important">&amp;&amp;</span> git describe <span class="token punctuation">-</span><span class="token punctuation">-</span>tags <span class="token punctuation">-</span><span class="token punctuation">-</span>always <span class="token punctuation">|</span> sed 's/^/KUBESPRAY_VERSION=/' <span class="token punctuation">></span><span class="token punctuation">></span> $GITHUB_ENV <span class="token important">&amp;&amp;</span> cd ..
    cd os<span class="token punctuation">-</span>packages <span class="token important">&amp;&amp;</span> git describe <span class="token punctuation">-</span><span class="token punctuation">-</span>tags <span class="token punctuation">-</span><span class="token punctuation">-</span>always <span class="token punctuation">|</span> sed 's/^/OS_PACKAGE_REPO_TAG=/' <span class="token punctuation">></span><span class="token punctuation">></span> $GITHUB_ENV <span class="token important">&amp;&amp;</span> cd ..
    cp <span class="token punctuation">-</span>rf kubespray/config config/kubespray <span class="token important">&amp;&amp;</span> rm <span class="token punctuation">-</span>rf kubespray os<span class="token punctuation">-</span>packages

    source $GITHUB_ENV
    echo "" <span class="token punctuation">></span><span class="token punctuation">></span> Dockerfile
    echo "COPY <span class="token punctuation">-</span><span class="token punctuation">-</span>from=$<span class="token punctuation">&#123;</span>OS_PACKAGES_IMAGE<span class="token punctuation">&#125;</span><span class="token punctuation">:</span>$<span class="token punctuation">&#123;</span>OS_PACKAGE_REPO_TAG<span class="token punctuation">&#125;</span> / /resources/nginx" <span class="token punctuation">></span><span class="token punctuation">></span> Dockerfile
    echo "COPY <span class="token punctuation">-</span><span class="token punctuation">-</span>from=$<span class="token punctuation">&#123;</span>KUBESPRAY_FILES_IMAGE<span class="token punctuation">&#125;</span><span class="token punctuation">:</span>$<span class="token punctuation">&#123;</span>KUBESPRAY_VERSION<span class="token punctuation">&#125;</span> / /resources/nginx" <span class="token punctuation">></span><span class="token punctuation">></span> Dockerfile
    echo "COPY <span class="token punctuation">-</span><span class="token punctuation">-</span>from=$<span class="token punctuation">&#123;</span>KUBESPRAY_IMAGES_IMAGE<span class="token punctuation">&#125;</span><span class="token punctuation">:</span>$<span class="token punctuation">&#123;</span>KUBESPRAY_VERSION<span class="token punctuation">&#125;</span> / /resources/registry" <span class="token punctuation">></span><span class="token punctuation">></span> Dockerfile

    <span class="token key atrule">sed -n 's|image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span><span class="token punctuation">|</span>NGINX_VERSION=<span class="token punctuation">|</span>p' compose.yaml <span class="token punctuation">|</span> tr <span class="token punctuation">-</span>d ' ' <span class="token punctuation">></span><span class="token punctuation">></span> $GITHUB_ENV
    <span class="token key atrule">sed -n 's|image</span><span class="token punctuation">:</span> registry<span class="token punctuation">:</span><span class="token punctuation">|</span>RERGISRRY_VERSION=<span class="token punctuation">|</span>p' compose.yaml <span class="token punctuation">|</span> tr <span class="token punctuation">-</span>d ' ' <span class="token punctuation">></span><span class="token punctuation">></span> $GITHUB_ENV<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>使用 <code>outputs: type=local,dest=./</code> 构建镜像到本地目录而非 push 到 registry</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build kubeplay image to local
  <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v2
  <span class="token key atrule">with</span><span class="token punctuation">:</span>
    <span class="token key atrule">context</span><span class="token punctuation">:</span> .
    <span class="token key atrule">file</span><span class="token punctuation">:</span> Dockerfile
    <span class="token key atrule">platforms</span><span class="token punctuation">:</span> linux/amd64<span class="token punctuation">,</span>linux/arm64
    <span class="token key atrule">build-args</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      NGINX_VERSION=$&#123;&#123; env.NGINX_VERSION &#125;&#125;
      RERGISRRY_VERSION=$&#123;&#123; env.RERGISRRY_VERSION &#125;&#125;
      KUBESPRAY_IMAGE=$&#123;&#123; env.KUBESPRAY_IMAGE &#125;&#125;
      KUBESPRAY_VERSION=$&#123;&#123; env.KUBESPRAY_VERSION &#125;&#125;</span>
    <span class="token key atrule">outputs</span><span class="token punctuation">:</span> type=local<span class="token punctuation">,</span>dest=./<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>打包并上传安装包到 GitHub release 存储</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Prepare for upload package
  <span class="token key atrule">shell</span><span class="token punctuation">:</span> bash
  <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    rm -rf linux_&#123;amd64,arm64&#125;/&#123;Dockerfile,LICENSE&#125;
    mv linux_amd64 kubeplay
    tar -I pigz -cf kubeplay-$&#123;IMAGE_TAG&#125;-linux-amd64.tar.gz kubeplay --remove-files
    mv linux_arm64 kubeplay
    tar -I pigz -cf kubeplay-$&#123;IMAGE_TAG&#125;-linux-arm64.tar.gz kubeplay --remove-files
    sha256sum kubeplay-$&#123;IMAGE_TAG&#125;-linux-&#123;amd64,arm64&#125;.tar.gz > sha256sum.txt</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Release and upload packages
  <span class="token key atrule">uses</span><span class="token punctuation">:</span> softprops/action<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>release@v1
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.GITHUB_TOKEN <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">with</span><span class="token punctuation">:</span>
    <span class="token key atrule">files</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      sha256sum.txt
      kubeplay-$&#123;&#123; env.IMAGE_TAG &#125;&#125;-linux-amd64.tar.gz
      kubeplay-$&#123;&#123; env.IMAGE_TAG &#125;&#125;-linux-arm64.tar.gz</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由此一个完整的离线安装包就构建完成了，接下来再讲一下安装流程</p>
<h2 id="安装流程"><a href="#安装流程" class="headerlink" title="安装流程"></a>安装流程</h2><p>在 <a target="_blank" rel="noopener" href="https://github.com/k8sli/kubeplay/releases">GitHub release 页面</a> 将我们的离线安装包下载到本地，需要根据 CPU 架构的类型选择相应的安装包。</p>
<p><img data-src="https://p.k8s.li/2021-08-24-offline-deploy-k8s-1.png" alt="image"></p>
<p>下载完成之后再将安装包通过 scp 或者其他方式上传到内网的部署节点上，部署的文档可参考 <a target="_blank" rel="noopener" href="https://github.com/k8sli/kubeplay">README</a> 。过程十分简单：只需要填写好 <code>config.yaml</code> 配置文件然后执行 <code>bash install.sh</code> 即可完成 K8s 集群的一键部署。</p>
<p>下面从源码而非 README 文档的角度来讲一下部署流程的实现细节</p>
<h3 id="安装包结构"><a href="#安装包结构" class="headerlink" title="安装包结构"></a>安装包结构</h3><ul>
<li>配置文件 <code>config.yaml</code></li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># nginx 端口和 registry 域名配置参数</span>
<span class="token key atrule">compose</span><span class="token punctuation">:</span>
  <span class="token comment"># Compose bootstrap node ip, default is local internal ip</span>
  <span class="token key atrule">internal_ip</span><span class="token punctuation">:</span> 172.20.0.25
  <span class="token comment"># Nginx http server bind port for download files and packages</span>
  <span class="token key atrule">nginx_http_port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token comment"># Registry domain for CRI runtime download images</span>
  <span class="token key atrule">registry_domain</span><span class="token punctuation">:</span> kube.registry.local

<span class="token comment"># kubespray 参数</span>
<span class="token key atrule">kubespray</span><span class="token punctuation">:</span>
  <span class="token comment"># Kubernetes version by default, only support v1.20.6</span>
  <span class="token key atrule">kube_version</span><span class="token punctuation">:</span> v1.21.3
  <span class="token comment"># For deploy HA cluster you must configure a external apiserver access ip</span>
  <span class="token key atrule">external_apiserver_access_ip</span><span class="token punctuation">:</span> 127.0.0.1
  <span class="token comment"># Set network plugin to calico with vxlan mode by default</span>
  <span class="token key atrule">kube_network_plugin</span><span class="token punctuation">:</span> calico
  <span class="token comment">#Container runtime, only support containerd if offline deploy</span>
  <span class="token key atrule">container_manager</span><span class="token punctuation">:</span> containerd
  <span class="token comment"># Now only support host if use containerd as CRI runtime</span>
  <span class="token key atrule">etcd_deployment_type</span><span class="token punctuation">:</span> host
  <span class="token comment"># Settings for etcd event server</span>
  <span class="token key atrule">etcd_events_cluster_setup</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">etcd_events_cluster_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token comment"># 集群节点 ssh 登录 inventory 配置</span>
<span class="token comment"># Cluster nodes inventory info</span>
<span class="token key atrule">inventory</span><span class="token punctuation">:</span>
  <span class="token key atrule">all</span><span class="token punctuation">:</span>
    <span class="token key atrule">vars</span><span class="token punctuation">:</span>
      <span class="token key atrule">ansible_port</span><span class="token punctuation">:</span> <span class="token number">22</span>
      <span class="token key atrule">ansible_user</span><span class="token punctuation">:</span> root
      <span class="token key atrule">ansible_ssh_pass</span><span class="token punctuation">:</span> Password
      <span class="token comment"># ansible_ssh_private_key_file: /kubespray/config/id_rsa</span>
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
      <span class="token key atrule">node1</span><span class="token punctuation">:</span>
        <span class="token key atrule">ansible_host</span><span class="token punctuation">:</span> 172.20.0.21
      <span class="token key atrule">node2</span><span class="token punctuation">:</span>
        <span class="token key atrule">ansible_host</span><span class="token punctuation">:</span> 172.20.0.22
      <span class="token key atrule">node3</span><span class="token punctuation">:</span>
        <span class="token key atrule">ansible_host</span><span class="token punctuation">:</span> 172.20.0.23
      <span class="token key atrule">node4</span><span class="token punctuation">:</span>
        <span class="token key atrule">ansible_host</span><span class="token punctuation">:</span> 172.20.0.24
    <span class="token key atrule">children</span><span class="token punctuation">:</span>
      <span class="token key atrule">kube_control_plane</span><span class="token punctuation">:</span>
        <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
          <span class="token key atrule">node1</span><span class="token punctuation">:</span>
          <span class="token key atrule">node2</span><span class="token punctuation">:</span>
          <span class="token key atrule">node3</span><span class="token punctuation">:</span>
      <span class="token key atrule">kube_node</span><span class="token punctuation">:</span>
        <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
          <span class="token key atrule">node1</span><span class="token punctuation">:</span>
          <span class="token key atrule">node2</span><span class="token punctuation">:</span>
          <span class="token key atrule">node3</span><span class="token punctuation">:</span>
          <span class="token key atrule">node4</span><span class="token punctuation">:</span>
      <span class="token key atrule">etcd</span><span class="token punctuation">:</span>
        <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
          <span class="token key atrule">node1</span><span class="token punctuation">:</span>
          <span class="token key atrule">node2</span><span class="token punctuation">:</span>
          <span class="token key atrule">node3</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s_cluster</span><span class="token punctuation">:</span>
        <span class="token key atrule">children</span><span class="token punctuation">:</span>
          <span class="token key atrule">kube_control_plane</span><span class="token punctuation">:</span>
          <span class="token key atrule">kube_node</span><span class="token punctuation">:</span>
      <span class="token key atrule">gpu</span><span class="token punctuation">:</span>
        <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
      <span class="token key atrule">calico_rr</span><span class="token punctuation">:</span>
        <span class="token key atrule">hosts</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>

<span class="token comment"># 一些默认的配置，一般情况下无需修改</span>
<span class="token comment">### Default parameters ###</span>
<span class="token comment">## This filed not need config, will auto update,</span>
<span class="token comment">## if no special requirement, do not modify these parameters.</span>
<span class="token key atrule">default</span><span class="token punctuation">:</span>
  <span class="token comment"># NTP server ip address or domain, default is internal_ip</span>
  <span class="token key atrule">ntp_server</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> internal_ip
  <span class="token comment"># Registry ip address, default is internal_ip</span>
  <span class="token key atrule">registry_ip</span><span class="token punctuation">:</span> internal_ip
  <span class="token comment"># Offline resource url for download files, default is internal_ip:nginx_http_port</span>
  <span class="token key atrule">offline_resources_url</span><span class="token punctuation">:</span> internal_ip<span class="token punctuation">:</span>nginx_http_port
  <span class="token comment"># Use nginx and registry provide all offline resources</span>
  <span class="token key atrule">offline_resources_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token comment"># Image repo in registry</span>
  <span class="token key atrule">image_repository</span><span class="token punctuation">:</span> library
  <span class="token comment"># Kubespray container image for deploy user cluster or scale</span>
  <span class="token key atrule">kubespray_image</span><span class="token punctuation">:</span> <span class="token string">"kubespray"</span>
  <span class="token comment"># Auto generate self-signed certificate for registry domain</span>
  <span class="token key atrule">generate_domain_crt</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token comment"># For nodes pull image, use 443 as default</span>
  <span class="token key atrule">registry_https_port</span><span class="token punctuation">:</span> <span class="token number">443</span>
  <span class="token comment"># For push image to this registry, use 5000 as default, and only bind at 127.0.0.1</span>
  <span class="token key atrule">registry_push_port</span><span class="token punctuation">:</span> <span class="token number">5000</span>
  <span class="token comment"># Set false to disable download all container images on all nodes</span>
  <span class="token key atrule">download_container</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>安装包目录</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubeplay/
<span class="token builtin class-name">.</span>
├── compose.yaml                 <span class="token comment"># compose 配置文件</span>
├── config
│   ├── compose
│   │   └── nginx.conf           <span class="token comment"># nginx 配置文件</span>
│   ├── kubespray
│   │   ├── env.yml
│   │   ├── group_vars           <span class="token comment"># kubespray group_vars  配置文件</span>
│   │   └── inventory.ini
│   └── rootCA.cnf               <span class="token comment"># openssl 配置文件</span>
├── config-sample.yaml           <span class="token comment"># 主配置文件</span>
├── install.sh                   <span class="token comment"># 安装包入口脚本</span>
├── library
└── resources                    <span class="token comment"># 所有离线资源</span>
    ├── images
    │   ├── kubespray-v2.16.tar  <span class="token comment"># kubespray 镜像</span>
    │   ├── nginx-1.20-alpine.tar<span class="token comment"># nginx 镜像</span>
    │   └── registry-2.7.1.tar   <span class="token comment"># registry 镜像</span>
    ├── nginx                    <span class="token comment"># rpm/deb 包以及一些二进制文件</span>
    │   ├── centos               <span class="token comment"># centos rpm 包</span>
    │   ├── debian               <span class="token comment"># debian deb 包</span>
    │   ├── files                <span class="token comment"># 一些二进制文件</span>
    │   ├── repos                <span class="token comment"># yum/apt 配置文件</span>
    │   ├── tools                <span class="token comment"># 一些部署时依赖的工具</span>
    │   └── ubuntu               <span class="token comment"># ubuntu deb 包</span>
    └── registry
        └── <span class="token function">docker</span>               <span class="token comment"># 组件镜像 registry 存储目录</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="compose-节点"><a href="#compose-节点" class="headerlink" title="compose 节点"></a>compose 节点</h3><p>需要单独划分出一个节点用户部署 nginx 和镜像仓库服务，并在该节点上运行 kubespray 来部署 K8s 集群。大致流程的代码如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function-name function">deploy_compose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">case</span> <span class="token variable">$&#123;ID&#125;</span> <span class="token keyword">in</span>
    Debian<span class="token operator">|</span>debian<span class="token punctuation">)</span>
      system::debian::config_repo
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
    CentOS<span class="token operator">|</span>centos<span class="token punctuation">)</span>
      system::centos::disable_selinux
      system::centos::config_repo
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
    Ubuntu<span class="token operator">|</span>ubuntu<span class="token punctuation">)</span>
      system::ubuntu::config_repo
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
    *<span class="token punctuation">)</span>
      errorlog <span class="token string">"Not support system: <span class="token variable">$&#123;ID&#125;</span>"</span>
      <span class="token builtin class-name">exit</span> <span class="token number">1</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token keyword">esac</span>
  system::disable_firewalld
  system::install_pkgs
  common::install_tools
  common::rudder_config
  common::update_hosts
  common::generate_domain_certs
  common::load_images
  common::compose_up
  common::health_check
  system::install_chrony
<span class="token punctuation">&#125;</span>

<span class="token function-name function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">case</span> <span class="token variable">$&#123;INSTALL_TYPE&#125;</span> <span class="token keyword">in</span>
    all<span class="token punctuation">)</span>
      deploy_compose
      common::push_kubespray_image
      common::run_kubespray <span class="token string">"bash /kubespray/run.sh deploy-cluster"</span>
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
    *<span class="token punctuation">)</span>
      echowarn <span class="token string">"unknow [TYPE] parameter: <span class="token variable">$&#123;INSTALL_TYPE&#125;</span>"</span>
      common::usage
      <span class="token punctuation">;</span><span class="token punctuation">;</span>
  <span class="token keyword">esac</span>
<span class="token punctuation">&#125;</span>

main <span class="token string">"<span class="token variable">$@</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>首先初始化节点，关闭防火墙和 <code>SELinux</code></li>
<li>配置部署节点 yum&#x2F;apt 离线源</li>
<li>安装一些部署依赖包，如 chrony、 libseccomp  等</li>
<li>安装一些工具如 yq, skopeo, kubectl 等</li>
<li>安装 nerdctl-full (containerd)</li>
<li>使用 nerdctl load -i 的方式导入 nginx, registry, kubespray 镜像</li>
<li>使用 yq 渲染配置文件，生成 kubespray 需要的 env 文件和 inventory 文件</li>
<li>生成镜像仓库域名证书并将自签证书添加到主机的 CA trust 信任当中</li>
<li>在 <code>/etc/hosts</code> 中添加镜像仓库域名 hosts 映射</li>
<li>使用 nerdctl compose 启动 nginx 和 registry 服务</li>
<li>部署时钟同步服务 chrony</li>
<li>检查各个服务的状态</li>
<li>最后使用 nerdctl run 启动 kubespray 容器来部署 k8s 集群</li>
</ul>
<h3 id="kubespray-3"><a href="#kubespray-3" class="headerlink" title="kubespray"></a>kubespray</h3><p>部署的流程上基本上和 kubespray 官方大体一致，只不过我们引入里分层部署的特性</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function-name function">deploy_cluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token function">touch</span> <span class="token variable">$&#123;INSTALL_STEPS_FILE&#125;</span>
  <span class="token assign-left variable">STEPS</span><span class="token operator">=</span><span class="token string">"00-default-ssh-config 01-cluster-bootstrap-os 02-cluster-etcd 03-cluster-kubernetes 04-cluster-network 05-cluster-apps"</span>
  <span class="token keyword">for</span> <span class="token for-or-select variable">step</span> <span class="token keyword">in</span> <span class="token variable">$&#123;STEPS&#125;</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token keyword">if</span> <span class="token operator">!</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">"<span class="token variable">$&#123;step&#125;</span>"</span> <span class="token variable">$&#123;INSTALL_STEPS_FILE&#125;</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
      infolog <span class="token string">"start deploy <span class="token variable">$&#123;step&#125;</span>"</span>
      <span class="token keyword">if</span> ansible-playbook <span class="token variable">$&#123;ANSIBLE_ARGS&#125;</span> <span class="token variable">$&#123;KUBE_ROOT&#125;</span>/playbooks/<span class="token variable">$&#123;step&#125;</span>.yml<span class="token punctuation">;</span> <span class="token keyword">then</span>
        <span class="token builtin class-name">echo</span> <span class="token variable">$&#123;step&#125;</span> <span class="token operator">>></span> <span class="token variable">$&#123;INSTALL_STEPS_FILE&#125;</span>
        infolog <span class="token string">"<span class="token variable">$&#123;step&#125;</span> successfully installed"</span>
      <span class="token keyword">else</span>
        errorlog <span class="token string">"<span class="token variable">$&#123;step&#125;</span> installation failed"</span>
        <span class="token builtin class-name">exit</span> <span class="token number">1</span>
      <span class="token keyword">fi</span>
    <span class="token keyword">else</span>
      warnlog <span class="token string">"<span class="token variable">$&#123;step&#125;</span> is already installed, so skipped..."</span>
    <span class="token keyword">fi</span>
  <span class="token keyword">done</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>配置堡垒机 ssh 登录（可选）</li>
<li>配置节点 yum&#x2F;apt 源为 nginx 服务提供的源</li>
<li>将自签的域名证书添加到主机的 CA trust 信任当中</li>
<li>在 <code>/etc/hosts</code> 中添加镜像仓库域名 hosts 映射</li>
<li>关闭防火墙，安装时钟同步服务，进行同步时钟</li>
<li>初始化集群节点，安装部署依赖</li>
<li>安装容器运行时，下载文件和组件镜像</li>
<li>部署 etcd 集群</li>
<li>部署 K8s 集群</li>
<li>部署 CNI 插件</li>
<li>安装一些额外的 addon 组件如 (coredns)</li>
</ul>
<p>至此整个打包和部署流程就完毕了，下面再讲几个打包&#x2F;部署常见的问题</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="kubeadm-证书"><a href="#kubeadm-证书" class="headerlink" title="kubeadm 证书"></a>kubeadm 证书</h3><p>通过修改 kubeadm 源码的方式将证书续命到 10 年，开启 <code>kubeadm_patch_enabled</code> 参数部署时就将 kubeadm 替换为修改后的 kubeadm。关于 kubeadm 的修改和构建和参考我之前写过的《<a href="https://blog.k8s.li/build-k8s-binary-by-github-actions.html">使用 GitHub Actions 编译 kubernetes 组件</a>》。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/k8sli/kubespray/blob/main/roles/cluster/download/tasks/main.yml">roles&#x2F;cluster&#x2F;download&#x2F;tasks&#x2F;main.yml</a></li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Relpace kubeadm binary file as patched version
  <span class="token key atrule">get_url</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; patched_kubeadm_download_url &#125;&#125;"</span>
    <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; bin_dir &#125;&#125;/kubeadm"</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> <span class="token number">0755</span>
    <span class="token key atrule">owner</span><span class="token punctuation">:</span> root
    <span class="token key atrule">group</span><span class="token punctuation">:</span> root
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> kubeadm
  <span class="token key atrule">when</span><span class="token punctuation">:</span> kubeadm_patch_enabled <span class="token punctuation">|</span> default(true) <span class="token punctuation">|</span> bool<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="镜像缓存"><a href="#镜像缓存" class="headerlink" title="镜像缓存"></a>镜像缓存</h3><p>os-packages, kubespray-base, kubespray-files, kubespray-images 这四个镜像在构建的时候都会采用 md5 值的方式校验是否需要重新构建镜像，这样能够大大提升 CI 的执行效率，下面以 kubespray-base 这个镜像为例介绍其原理和实现：</p>
<ul>
<li>在构建镜像前会有一个 md5 计算和校验的步骤，将与该镜像紧密相关的文件内容进行汇总并生成 md5 值，并将这个值得以 label 的方式保存在镜像的元数据信息当中。如果该值与上个最新的镜像中的 md5 值相等，那么就不需要重新构建该镜像，只需要进行 retag 即可。</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Prepare for build images
  <span class="token key atrule">shell</span><span class="token punctuation">:</span> bash
  <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    git describe --tags --always | sed 's/^/IMAGE_TAG=/' >> $GITHUB_ENV
    git branch --show-current | sed 's/^/BRANCH_NAME=/' >> $GITHUB_ENV
    git branch --show-current | sed 's/master/latest/;s/main/latest/;s/^/IMAGE_TAG_BY_BRANCH=/' >> $GITHUB_ENV
    sed -n 's/^kube_version: /KUBE_VERSION=/p' roles/kubespray-defaults/defaults/main.yaml >> $GITHUB_ENV
    cat build/kubespray-base/Dockerfile requirements.txt tests/requirements.txt .github/workflows/build.yaml \
    | md5sum | tr -d '\ -' | sed 's/^/BASE_MD5=md5-/' >> $GITHUB_ENV</span>

    source $GITHUB_ENV
    if skopeo inspect docker<span class="token punctuation">:</span>//$<span class="token punctuation">&#123;</span>BASE_IMAGE_REPO<span class="token punctuation">&#125;</span><span class="token punctuation">:</span>$<span class="token punctuation">&#123;</span>BRANCH_NAME<span class="token punctuation">&#125;</span> <span class="token punctuation">></span> mainfest.json; then
      jq <span class="token punctuation">-</span>r '.Labels.BASE_MD5' mainfest.json <span class="token punctuation">|</span> sed 's/^/LATEST_BASE_MD5=/' <span class="token punctuation">></span><span class="token punctuation">></span> $GITHUB_ENV
    else
      echo 'LATEST_BASE_MD5=null' <span class="token punctuation">></span><span class="token punctuation">></span> $GITHUB_ENV
    fi<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>如果当前 md5 的值与最新的 md5 值相等，就重新生成一个新的 Dockerfile 来进行镜像 retag 的操作。</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Replace Dockerfile if MD5 not update
  <span class="token key atrule">if</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.BASE_MD5 == env.LATEST_BASE_MD5 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    echo "FROM $&#123;&#123; env.BASE_IMAGE_REPO &#125;&#125;:$&#123;&#123; env.BASE_MD5 &#125;&#125;" > build/kubespray-base/Dockerfile</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>构建镜像并将 md5 值作为 labels 填充到镜像的元数据信息当中。</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build and push kubespray<span class="token punctuation">-</span>base images
  <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v2
  <span class="token key atrule">with</span><span class="token punctuation">:</span>
    <span class="token key atrule">context</span><span class="token punctuation">:</span> .
    <span class="token key atrule">push</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> github.event_name <span class="token tag">!=</span> 'pull_request' <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">file</span><span class="token punctuation">:</span> build/kubespray<span class="token punctuation">-</span>base/Dockerfile
    <span class="token key atrule">platforms</span><span class="token punctuation">:</span> linux/amd64<span class="token punctuation">,</span>linux/arm64
    <span class="token key atrule">cache-from</span><span class="token punctuation">:</span> type=local<span class="token punctuation">,</span>src=/tmp/.buildx<span class="token punctuation">-</span>cache
    <span class="token key atrule">cache-to</span><span class="token punctuation">:</span> type=local<span class="token punctuation">,</span>dest=/tmp/.buildx<span class="token punctuation">-</span>cache<span class="token punctuation">-</span>new
    <span class="token key atrule">build-args</span><span class="token punctuation">:</span> KUBE_VERSION=$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.KUBE_VERSION <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">labels</span><span class="token punctuation">:</span> BASE_MD5=$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.BASE_MD5 <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      $&#123;&#123; env.BASE_IMAGE_REPO &#125;&#125;:$&#123;&#123; env.IMAGE_TAG &#125;&#125;
      $&#123;&#123; env.BASE_IMAGE_REPO &#125;&#125;:$&#123;&#123; env.BASE_MD5 &#125;&#125;
      $&#123;&#123; env.BASE_IMAGE_REPO &#125;&#125;:$&#123;&#123; env.BRANCH_NAME &#125;&#125;
      $&#123;&#123; env.BASE_IMAGE_REPO &#125;&#125;:$&#123;&#123; env.IMAGE_TAG_BY_BRANCH &#125;&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用这种方式的好处就在于在不需要构建镜像的时候能大幅度提升 CI 的运行效率。</p>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul>
<li><a href="https://blog.k8s.li/pass-platform-release.html">云原生 PaaS 产品发布&amp;部署方案</a></li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/7hKkdBUXHFZt5q3KbpmU6Q">政采云基于 sealer 的私有化业务交付实践</a></li>
<li><a href="https://blog.k8s.li/make-offline-mirrors.html">使用 docker build 制作 yum&#x2F;apt 离线源</a></li>
<li><a href="https://blog.k8s.li/deploy-k8s-by-kubespray.html">使用 Kubespray 本地开发测试部署 kubernetes 集群</a></li>
<li><a href="https://blog.k8s.li/select-registry-images.html">什么？发布流水线中镜像“同步”速度又提升了 15 倍 ！</a></li>
<li><a href="https://blog.k8s.li/skopeo-to-registry.html">如何使用 registry 存储的特性</a></li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
              <a href="/tags/k8s/" rel="tag"># k8s</a>
              <a href="/tags/PaaS/" rel="tag"># PaaS</a>
              <a href="/tags/toB/" rel="tag"># toB</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/build-k8s-binary-by-github-actions.html" rel="prev" title="使用 GitHub Actions 编译 kubernetes 组件">
                  <i class="fa fa-chevron-left"></i> 使用 GitHub Actions 编译 kubernetes 组件
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/apcupsd-on-openwrt-with-esxi.html" rel="next" title="使用 apcupsd 完成 UPS 断电后 ESXi 稳妥关机方案">
                  使用 apcupsd 完成 UPS 断电后 ESXi 稳妥关机方案 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.8m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">26:36</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
