<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Reimu&#39;s blog</title>
  <icon>https://blog.k8s.li/icon.png</icon>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.k8s.li/"/>
  <updated>2022-02-27T16:00:00.000Z</updated>
  <id>https://blog.k8s.li/</id>
  
  <author>
    <name>æœ¨å­</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ä½¿ç”¨ kubectl è‡ªåŠ¨å½’æ¡£ argo workflow æ—¥å¿—</title>
    <link href="https://blog.k8s.li/archive-argo-workflow-log-by-kubectl.html"/>
    <id>https://blog.k8s.li/archive-argo-workflow-log-by-kubectl.html</id>
    <published>2022-02-27T16:00:00.000Z</published>
    <updated>2022-02-27T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>é¡¹ç›®ä¸Šä½¿ç”¨åˆ° <a href="https://github.com/argoproj/argo-workflows" target="_blank" rel="noopener">argo-workflow</a> ä½œä¸ºå·¥ä½œæµå¼•æ“æ¥ç¼–æ’è¿è¡Œä¸€äº› <a href="https://www.smartx.com/solution/virtualization/" target="_blank" rel="noopener">è¶…èåˆ</a> é›†ç¾¤éƒ¨ç½²ç›¸å…³çš„ä»»åŠ¡ï¼Œæ•´å¥—ç¯å¢ƒè¿è¡Œåœ¨ä¸€ä¸ªå•èŠ‚ç‚¹çš„ K3s ä¸Šã€‚ä¹‹æ‰€ä»¥é€‰æ‹© argo-workflow + K3s çš„æ­é…ä¸»è¦æ˜¯æƒ³å°½å¯èƒ½å°‘åœ°å ç”¨ç³»ç»Ÿèµ„æºï¼Œå› ä¸ºè¿™å¥—ç¯å¢ƒå°†æ¥ä¼šè¿è¡Œåœ¨å„ç§ç¡¬ä»¶é…ç½®ä¸åŒçš„ç¬”è®°æœ¬ç”µè„‘ä¸Š ğŸ˜‚ã€‚ç»¼åˆè°ƒç ”äº†ä¸€äº›å¸¸è§çš„ K8s éƒ¨ç½²å·¥å…·æœ€ç»ˆå°±é€‰æ‹©äº†ç³»ç»Ÿèµ„æºå ç”¨è¾ƒå°‘çš„ K3sã€‚</p><p>ç°åœ¨é¡¹ç›®çš„ä¸€ä¸ªéœ€æ±‚å°±æ˜¯åœ¨é›†ç¾¤éƒ¨ç½²å®Œæˆæˆ–å¤±è´¥ä¹‹åéœ€è¦å°† workflow çš„æ—¥å¿—å½’æ¡£ä¿å­˜ä¸‹æ¥ã€‚è™½ç„¶å¯ä»¥åœ¨ workflow çš„ spec å­—æ®µä¸­ä½¿ç”¨ <code>archiveLogs: true</code> æ¥è®© argo å¸®æˆ‘ä»¬è‡ªåŠ¨å½’æ¡£æ—¥å¿—ï¼Œä½†è¿™ä¸ªç‰¹æ€§ä¾èµ–äºä¸€ä¸ª S3 å¯¹è±¡å­˜å‚¨ <a href="https://argoproj.github.io/argo-workflows/configure-artifact-repository/" target="_blank" rel="noopener">Artifact Repository</a> ã€‚è¿™å°±æ„å‘³ç€è¿˜è¦å†éƒ¨ç½²ä¸€ä¸ªæ”¯æŒ S3 å¯¹è±¡å­˜å‚¨çš„ç»„ä»¶æ¯”å¦‚ <a href="https://min.io/" target="_blank" rel="noopener">Minio</a> ï¼Œç›´æ¥æŠŠæˆ‘ç»™æ•´ä¸ä¼šäº† ğŸŒš</p><p><img src="https://p.k8s.li/2021-08-31-pass-tob-k8s-offline-deploy-2.jpeg" alt=""></p><p>å…¶å®å˜›è¿™ä¸ªéœ€æ±‚å¾ˆç®€å•çš„ï¼Œæˆ‘å°±æƒ³ä¿å­˜ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶è€Œå·²ï¼Œä½ è¿˜å†è®©æˆ‘å®‰è£…ä¸€ä¸ª <a href="https://min.io/" target="_blank" rel="noopener">Minio</a>ï¼Œå®åœ¨æ˜¯å¤ªè¿‡åˆ†äº†ï¼æœ¬æ¥ç³»ç»Ÿçš„èµ„æºååˆ†æœ‰é™ï¼Œéœ€è¦å°½å¯èƒ½å‡å°‘å®‰è£…ä¸€äº›ä¸å¿…è¦ä¾èµ–ï¼Œä¸ºçš„å°±æ˜¯å°†èµ„æºåˆ©ç”¨ç‡å°†åˆ°æœ€ä½ã€‚ä½†ç°åœ¨ä¸ºäº†å½’æ¡£å­˜å‚¨ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶å‚¨è€Œå¤§åŠ¨å¹²æˆˆè£…ä¸€ä¸ª minio å®åœ¨æ˜¯ä¸åˆ’ç®—ã€‚è¿™å°±å¥½æ¯”ä½ è´¹äº†å¥½å¤§åŠŸå¤«éƒ¨ç½²ä¸€å¥— 3 èŠ‚ç‚¹çš„ kubernetes é›†ç¾¤ï¼Œç„¶è€Œå°±ä¸ºäº†è¿è¡Œä¸€ä¸ªé™æ€åšå®¢é‚£æ ·æ»‘ç¨½ ğŸ˜‚</p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Deployed my blog on Kubernetes <a href="https://t.co/XHXWLrmYO4" target="_blank" rel="noopener">pic.twitter.com/XHXWLrmYO4</a></p>&mdash; For DevOps Eyes Only (@dexhorthy) <a href="https://twitter.com/dexhorthy/status/856639005462417409?ref_src=twsrc%5Etfw" target="_blank" rel="noopener">April 24, 2017</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>å¯¹äºå’±è¿™ç§ <code>ç”¨ä¸èµ·</code> S3 å¯¹è±¡å­˜å‚¨çš„ç©·äººå®¶å­©å­ï¼Œè¿˜æ˜¯æƒ³ä¸€äº›å…¶ä»–åŠæ³•å§ï¼Œæ¯•ç«Ÿè‡ªå·±åŠ¨æ‰‹ä¸°è¡£è¶³é£Ÿã€‚</p><h2 id="kubectl"><a href="#kubectl" class="headerlink" title="kubectl"></a>kubectl</h2><p>å®ç°èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå¯¹äºå’±è¿™ç§ YAML å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œkubectl è‡ªç„¶å†ç†Ÿæ‚‰ä¸è¿‡äº†ã€‚æƒ³è¦è·å– workflow çš„æ—¥å¿—ï¼Œåªéœ€è¦é€šè¿‡ kubectl logs å‘½ä»¤è·å–å‡º workflow æ‰€åˆ›çš„ pod æ—¥å¿—å°±è¡Œäº†å‘€ï¼Œè¦ä»€ä¹ˆ S3 å¯¹è±¡å­˜å‚¨ ğŸ˜–</p><h3 id="ç­›é€‰-pod"><a href="#ç­›é€‰-pod" class="headerlink" title="ç­›é€‰ pod"></a>ç­›é€‰ pod</h3><p>å¯¹äºåŒä¸€ä¸ª workflow æ¥å°†ï¼Œæ¯ä¸ª stage æ‰€åˆ›å»ºå‡ºæ¥çš„ pod name æœ‰ä¸€å®šçš„è§„å¾‹ã€‚åœ¨å®šä¹‰ workflow çš„æ—¶å€™ï¼Œ<a href="https://argoproj.github.io/argo-workflows/fields/#objectmeta" target="_blank" rel="noopener">generateName</a> å‚æ•°é€šå¸¸ä½¿ç”¨ <code>${name}-</code> æ ¼å¼ã€‚ä»¥ <code>-</code> ä½œä¸ºåˆ†éš”ç¬¦ï¼Œæœ€åä¸€ä¸ªå­—æ®µæ˜¯éšæœºç”Ÿæˆçš„ä¸€ä¸ªæ•°å­— IDï¼Œå€’æ•°ç¬¬äºŒä¸ªå­—æ®µåˆ™æ˜¯ argo éšæœºç”Ÿæˆçš„ workflow IDï¼Œå‰©ä½™å‰é¢çš„å­—ç¬¦åˆ™æ˜¯æˆ‘ä»¬å®šä¹‰çš„ generateNameã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">argoproj.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Workflow</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">generateName:</span> <span class="string">archive-log-test-</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">archive-log-test-jzt8n-3498199655                          0/2     Completed   0               4m18s</span><br><span class="line">archive-log-test-jzt8n-3618624526                          0/2     Completed   0               4m8s</span><br><span class="line">archive-log-test-jzt8n-2123203324                          0/2     Completed   0               3m58s</span><br></pre></td></tr></table></figure><p>åœ¨ pod çš„ labels ä¸­åŒæ ·ä¹ŸåŒ…å«ç€è¯¥ workflow æ‰€å¯¹åº”çš„ IDï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ ¹æ®æ­¤ labels è¿‡æ»¤å‡ºè¯¥ workflow æ‰€åˆ›å»ºå‡ºæ¥çš„ podã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">workflows.argoproj.io/node-id:</span> <span class="string">archive-log-test-jzt8n-3498199655</span></span><br><span class="line">    <span class="attr">workflows.argoproj.io/node-name:</span> <span class="string">archive-log-test-jzt8n[0].list-default-running-pods</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">"2022-02-28T12:53:32Z"</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">workflows.argoproj.io/completed:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="attr">workflows.argoproj.io/workflow:</span> <span class="string">archive-log-test-jzt8n</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">archive-log-test-jzt8n-3498199655</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">ownerReferences:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">argoproj.io/v1alpha1</span></span><br><span class="line">    <span class="attr">blockOwnerDeletion:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Workflow</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">archive-log-test-jzt8n</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">e91df2cb-b567-4cf0-9be5-3dd6c72854cd</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">"1251330"</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">ce37a709-8236-445b-8d00-a7926fa18ed0</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>-l lables</code> è¿‡æ»¤å‡ºä¸€ä¸ª workflow æ‰€åˆ›å»ºçš„ podï¼›é€šè¿‡ <code>--sort-by</code> ä»¥åˆ›å»ºæ—¶é—´è¿›è¡Œæ’åºï¼›é€šè¿‡ <code>-o name</code> åªè¾“å‡º pod çš„ nameï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -l workflows.argoproj.io/workflow=archive-log-test-jzt8n --sort-by=<span class="string">'.metadata.creationTimestamp'</span> -o name</span><br><span class="line">pod/archive-log-test-jzt8n-3498199655</span><br><span class="line">pod/archive-log-test-jzt8n-3618624526</span><br><span class="line">pod/archive-log-test-jzt8n-2123203324</span><br></pre></td></tr></table></figure><h3 id="è·å–æ—¥å¿—"><a href="#è·å–æ—¥å¿—" class="headerlink" title="è·å–æ—¥å¿—"></a>è·å–æ—¥å¿—</h3><p>é€šè¿‡ä¸Šé¢çš„æ­¥éª¤æˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°ä¸€ä¸ª workflow æ‰€åˆ›å»ºçš„ pod åˆ—è¡¨ã€‚ç„¶åå†é€šè¿‡ kubectl logs å‘½ä»¤è·å– pod ä¸­ main å®¹å™¨çš„æ—¥å¿—ï¼Œä¸ºæ–¹ä¾¿åŒºåˆ†æ—¥å¿—çš„æ‰€å¯¹åº”çš„ workflow ï¼Œæˆ‘ä»¬å°±ä»¥ workflow çš„ ID ä¸ºå‰ç¼€åã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs archive-log-test-jzt8n-3618624526 -c main</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOG_PATH=/var/<span class="built_in">log</span></span><br><span class="line">NAME=archive-log-test-jzt8n</span><br><span class="line">kubectl get pods -l workflows.argoproj.io/workflow=<span class="variable">$&#123;NAME&#125;</span> \</span><br><span class="line">--sort-by=<span class="string">'.metadata.creationTimestamp'</span> -o name \</span><br><span class="line">| xargs -I &#123;&#125; -t kubectl logs &#123;&#125; -c main &gt;&gt; <span class="variable">$&#123;LOG_PATH&#125;</span>/<span class="variable">$&#123;NAME&#125;</span>.<span class="built_in">log</span></span><br></pre></td></tr></table></figure><h3 id="workflow"><a href="#workflow" class="headerlink" title="workflow"></a>workflow</h3><p>æ ¹æ® argo-workflow å®˜æ–¹æä¾›çš„ <a href="https://github.com/argoproj/argo-workflows/blob/master/examples/exit-handlers.yaml" target="_blank" rel="noopener"><strong>exit-handlers.yaml</strong></a> exampleï¼Œæˆ‘ä»¬å°±ç…§è‘«èŠ¦ç”»ç“¢æ“ä¸€ä¸ª workflow é€€å‡ºåè‡ªåŠ¨è°ƒç”¨ä½¿ç”¨ kubectl è·å– workflow æ—¥å¿—çš„ä¸€ä¸ª stepï¼Œå®šä¹‰çš„ exit-handler å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">exit-handler</span></span><br><span class="line">    <span class="attr">container:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">"kubectl"</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">lachlanevenson/k8s-kubectl:v1.23.2</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line">          <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-l</span> <span class="string">workflows.argoproj.io/workflow=$&#123;POD_NAME%-*&#125;</span> <span class="string">\</span></span><br><span class="line">          <span class="string">--sort-by=".metadata.creationTimestamp"</span> <span class="string">-o</span> <span class="string">name</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-v</span> <span class="string">$&#123;POD_NAME&#125;</span> <span class="string">\</span></span><br><span class="line">          <span class="string">|</span> <span class="string">xargs</span> <span class="string">-I</span> <span class="string">&#123;&#125;</span> <span class="string">-t</span> <span class="string">kubectl</span> <span class="string">logs</span> <span class="string">&#123;&#125;</span> <span class="string">-c</span> <span class="string">main</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;LOG_PATH&#125;/$&#123;POD_NAME%-*&#125;.log</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOG_PATH</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/var/log/workflow</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-datastore</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log/workflow</span></span><br><span class="line">    <span class="attr">retryStrategy:</span></span><br><span class="line">      <span class="attr">limit:</span> <span class="string">"5"</span></span><br><span class="line">      <span class="attr">retryPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line"><span class="attr">entrypoint:</span> <span class="string">archive-log-test</span></span><br><span class="line"><span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-datastore</span></span><br><span class="line">    <span class="attr">nfs:</span></span><br><span class="line">      <span class="attr">server:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data/workflow/log</span></span><br><span class="line"><span class="attr">onExit:</span> <span class="string">exit-handler</span></span><br></pre></td></tr></table></figure><p>å°†ä¸Šè¿°å®šä¹‰çš„ <code>exit-handler</code> å†…å®¹å¤åˆ¶ç²˜è´´åˆ°ä½ çš„ workflow spec é…ç½®ä¸­å°±å¯ä»¥ã€‚ç”±äºæ—¥å¿—éœ€è¦æŒä¹…åŒ–å­˜å‚¨ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ NFS å­˜å‚¨ï¼Œä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦æ¢æˆå…¶ä»–å­˜å‚¨ï¼Œåªéœ€è¦ä¿®æ”¹ä¸€ä¸‹ <code>volumes</code> é…ç½®å³å¯ã€‚</p><p>å®Œæ•´çš„ <a href="https://gist.github.com/muzi502/9b26c6854c509c42ecd7f7004436ca23" target="_blank" rel="noopener">workflow example</a> å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">argoproj.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Workflow</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">generateName:</span> <span class="string">archive-log-test-</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">templates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">archive-log-test</span></span><br><span class="line">      <span class="attr">steps:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">list-default-running-pods</span></span><br><span class="line">            <span class="attr">template:</span> <span class="string">kubectl</span></span><br><span class="line">            <span class="attr">arguments:</span></span><br><span class="line">              <span class="attr">parameters:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">namespace</span></span><br><span class="line">                  <span class="attr">value:</span> <span class="string">default</span></span><br><span class="line">        <span class="bullet">-</span> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">list-kube-system-running-pods</span></span><br><span class="line">            <span class="attr">template:</span> <span class="string">kubectl</span></span><br><span class="line">            <span class="attr">arguments:</span></span><br><span class="line">              <span class="attr">parameters:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">namespace</span></span><br><span class="line">                  <span class="attr">value:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubectl</span></span><br><span class="line">      <span class="attr">inputs:</span></span><br><span class="line">        <span class="attr">parameters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">namespace</span></span><br><span class="line">      <span class="attr">container:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"kubectl"</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">lachlanevenson/k8s-kubectl:v1.23.2</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line">            <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">--field-selector=status.phase=Running</span> <span class="string">-n</span> <span class="string">&#123;&#123;inputs.parameters.namespace&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">exit-handler</span></span><br><span class="line">      <span class="attr">container:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"kubectl"</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">lachlanevenson/k8s-kubectl:v1.23.2</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line">            <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-l</span> <span class="string">workflows.argoproj.io/workflow=$&#123;POD_NAME%-*&#125;</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--sort-by=".metadata.creationTimestamp"</span> <span class="string">-o</span> <span class="string">name</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-v</span> <span class="string">$&#123;POD_NAME&#125;</span> <span class="string">\</span></span><br><span class="line">            <span class="string">|</span> <span class="string">xargs</span> <span class="string">-I</span> <span class="string">&#123;&#125;</span> <span class="string">-t</span> <span class="string">kubectl</span> <span class="string">logs</span> <span class="string">&#123;&#125;</span> <span class="string">-c</span> <span class="string">main</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;LOG_PATH&#125;/$&#123;POD_NAME%-*&#125;.log</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOG_PATH</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">/var/log/workflow</span></span><br><span class="line">        <span class="attr">resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-datastore</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/var/log/workflow</span></span><br><span class="line">      <span class="attr">retryStrategy:</span></span><br><span class="line">        <span class="attr">limit:</span> <span class="string">"5"</span></span><br><span class="line">        <span class="attr">retryPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">  <span class="attr">entrypoint:</span> <span class="string">archive-log-test</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-datastore</span></span><br><span class="line">      <span class="attr">nfs:</span></span><br><span class="line">        <span class="attr">server:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/data/workflow/log</span></span><br><span class="line">  <span class="attr">onExit:</span> <span class="string">exit-handler</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;é¡¹ç›®ä¸Šä½¿ç”¨åˆ° &lt;a
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubectl" scheme="https://blog.k8s.li/tags/kubectl/"/>
    
      <category term="argo-workflow" scheme="https://blog.k8s.li/tags/argo-workflow/"/>
    
  </entry>
  
  <entry>
    <title>VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ</title>
    <link href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html"/>
    <id>https://blog.k8s.li/deploy-tanzu-k8s-cluster.html</id>
    <published>2022-02-05T16:00:00.000Z</published>
    <updated>2022-02-05T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰æ¥è§¦çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·å¤§å¤šæ•°éƒ½æ˜¯ä¾èµ–äº ssh è¿æ¥åˆ°å¾…éƒ¨ç½²çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œéƒ¨ç½²æ“ä½œï¼Œè¿™æ ·å°±è¦æ±‚éƒ¨ç½²å‰éœ€è¦æå‰å‡†å¤‡å¥½é›†ç¾¤èŠ‚ç‚¹ï¼Œä¸”è¦ä¿è¯è¿™äº›èŠ‚ç‚¹çš„ç½‘ç»œäº’é€šä»¥åŠæ—¶é’ŸåŒæ­¥ç­‰é—®é¢˜ã€‚ç±»ä¼¼äº kubespray æˆ–è€… kubekey è¿™äº›éƒ¨ç½²å·¥å…·æ˜¯ä¸ä¼šå»ç®¡è¿™äº›åº•å±‚çš„ IaaS èµ„æºçš„åˆ›å»ºï¼Œæ˜¯è¦è‡ªå·±æå‰å‡†å¤‡å¥½ã€‚ä½†æ˜¯åœ¨ä¸€äº›ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒä¸­ï¼Œä½¿ç”¨äº†å¦‚ <a href="https://docs.vmware.com/cn/VMware-vSphere/index.html" target="_blank" rel="noopener">VMware vShpere</a> æˆ– <a href="https://www.openstack.org/" target="_blank" rel="noopener">OpenStack</a> è¿™äº›è™šæ‹ŸåŒ–å¹³å°ï¼Œæ˜¯å¯ä»¥å°† K8s é›†ç¾¤éƒ¨ç½²ä¸ IaaS èµ„æºåˆ›å»ºè¿™ä¸¤æ­¥ç»Ÿä¸€èµ·æ¥çš„ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æ‰‹åŠ¨åˆ›å»ºå’Œé…ç½®è™šæ‹Ÿæœºè¿™äº›ç¹ççš„æ­¥éª¤ã€‚</p><p>ç›®å‰å°† IaaS èµ„æºåˆ›å»ºä¸ K8s é›†ç¾¤éƒ¨ç½²ç»“åˆèµ·æ¥ä¹Ÿæœ‰æ¯”è¾ƒæˆç†Ÿçš„æ–¹æ¡ˆï¼Œæ¯”å¦‚åŸºäº <a href="https://github.com/kubernetes-sigs/cluster-api" target="_blank" rel="noopener">cluster-api</a> é¡¹ç›®çš„ <a href="https://github.com/vmware-tanzu" target="_blank" rel="noopener">tanzu</a> ã€‚æœ¬æ–‡å°±ä»¥ <a href="https://github.com/vmware-tanzu/community-edition" target="_blank" rel="noopener">VMware Tanzu ç¤¾åŒºç‰ˆ</a> ä¸ºä¾‹åœ¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šï¼Œä»å®‰è£… ESXi OS åˆ°éƒ¨ç½²å®Œæˆ Tanzu Workload é›†ç¾¤ï¼Œæ¥ä½“éªŒä¸€ä¸‹è¿™ç§éƒ¨ç½²æ–¹æ¡ˆçš„ä¸ä¼—ä¸åŒä¹‹å¤„ã€‚</p><h2 id="éƒ¨ç½²æµç¨‹"><a href="#éƒ¨ç½²æµç¨‹" class="headerlink" title="éƒ¨ç½²æµç¨‹"></a>éƒ¨ç½²æµç¨‹</h2><ul><li>ä¸‹è½½ä¾èµ–æ–‡ä»¶</li><li>å®‰è£… govc ä¾èµ–</li><li>å®‰è£… ESXi OS</li><li>å®‰è£… vCenter</li><li>é…ç½® vCenter</li><li>åˆ›å»º bootstrap è™šæ‹Ÿæœº</li><li>åˆå§‹åŒ– bootstrap èŠ‚ç‚¹</li><li>éƒ¨ç½² Tanzu Manager é›†ç¾¤</li><li>éƒ¨ç½² Tanzu Workload é›†ç¾¤</li></ul><h3 id="åŠé€€ä¸‰è¿-ğŸ˜‚"><a href="#åŠé€€ä¸‰è¿-ğŸ˜‚" class="headerlink" title="åŠé€€ä¸‰è¿ ğŸ˜‚"></a>åŠé€€ä¸‰è¿ ğŸ˜‚</h3><ul><li>éœ€è¦æœ‰ä¸€ä¸ª <a href="https://customerconnect.vmware.com/login" target="_blank" rel="noopener">VMware çš„è´¦æˆ·</a> ç”¨äºä¸‹è½½ä¸€äº› ISO é•œåƒå’Œè™šæ‹Ÿæœºæ¨¡ç‰ˆ;</li><li>éœ€è¦æœ‰ä¸€å°ç‰©ç†æœåŠ¡å™¨ï¼Œæ¨èæœ€ä½é…ç½® 8C 32Gï¼Œè‡³å°‘ 256GB å­˜å‚¨ï¼›</li><li>éœ€è¦ä¸€å° DHCP æœåŠ¡å™¨ï¼Œç”±äºé»˜è®¤æ˜¯ä½¿ç”¨ DHCP è·å– IP æ¥åˆ†é…ç»™è™šæ‹Ÿæœºçš„ï¼Œå› æ­¤ ESXi æ‰€åœ¨çš„ VM Network  ç½‘ç»œä¸­å¿…é¡»æœ‰ä¸€å° DHCP æœåŠ¡å™¨ç”¨äºç»™è™šæ‹Ÿæœºåˆ†é… IPï¼›</li></ul><h3 id="ä¸‹è½½ä¾èµ–æ–‡ä»¶"><a href="#ä¸‹è½½ä¾èµ–æ–‡ä»¶" class="headerlink" title="ä¸‹è½½ä¾èµ–æ–‡ä»¶"></a>ä¸‹è½½ä¾èµ–æ–‡ä»¶</h3><p>æ•´ä¸ªéƒ¨ç½²æµç¨‹æ‰€éœ€è¦çš„ä¾æ–‡ä»¶èµ–å¦‚ä¸‹ï¼Œå¯ä»¥å…ˆå°†è¿™äº›ä¾èµ–ä¸‹è½½åˆ°æœ¬åœ°çš„æœºå™¨ä¸Šï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@devbox:/root/tanzu <span class="comment"># tree -sh</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ [  12M]  govc_Linux_x86_64.tar.gz</span><br><span class="line">â”œâ”€â”€ [ 895M]  photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</span><br><span class="line">â”œâ”€â”€ [ 225M]  photon-ova-4.0-c001795b80.ova</span><br><span class="line">â”œâ”€â”€ [ 170M]  tce-linux-amd64-v0.9.1.tar.gz</span><br><span class="line">â”œâ”€â”€ [ 9.0G]  VMware-VCSA-all-7.0.3-18778458.iso</span><br><span class="line">â””â”€â”€ [ 390M]  VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso</span><br></pre></td></tr></table></figure><table><thead><tr><th>æ–‡ä»¶</th><th>ç”¨é€”</th><th>ä¸‹è½½æ–¹å¼</th></tr></thead><tbody><tr><td><a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=ESXI70U2A&productId=974&rPId=46384" target="_blank" rel="noopener">VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso</a></td><td>å®‰è£… ESXi OS</td><td>VMware éœ€è´¦æˆ·</td></tr><tr><td><a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=VC70U3C&productId=974&rPId=83853" target="_blank" rel="noopener">VMware-VCSA-all-7.0.3-19234570.iso</a></td><td>å®‰è£… vCenter</td><td>VMware éœ€è´¦æˆ·</td></tr><tr><td><a href="https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova" target="_blank" rel="noopener">photon-ova-4.0-c001795b80.ova</a></td><td>bootstrap èŠ‚ç‚¹</td><td>VMware</td></tr><tr><td><a href="https://customerconnect.vmware.com/downloads/get-download?downloadGroup=TCE-090" target="_blank" rel="noopener">photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</a></td><td>tanzu é›†ç¾¤èŠ‚ç‚¹</td><td>VMware éœ€è´¦æˆ·</td></tr><tr><td><a href="https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz" target="_blank" rel="noopener">tce-linux-amd64-v0.9.1.tar.gz</a></td><td>tanzu ç¤¾åŒºç‰ˆ</td><td>GitHub release</td></tr><tr><td><a href="https://github.com/vmware/govmomi/releases/download/v0.27.3/govc_Linux_x86_64.tar.gz" target="_blank" rel="noopener">govc_Linux_x86_64.tar.gz</a></td><td>å®‰è£…/é…ç½® vCenter</td><td>GitHub release</td></tr></tbody></table><p>æ³¨æ„ ESXi å’Œ vCenter çš„ç‰ˆæœ¬æœ€å¥½æ˜¯ 7.0 åŠä»¥ä¸Šï¼Œæˆ‘åªåœ¨ ESXi 7.0.2 å’Œ vCenter 7.0.3 ä¸Šæµ‹è¯•è¿‡ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰äº›å·®å¼‚ï¼›å¦å¤– ESXi çš„ç‰ˆæœ¬ä¸å»ºè®®ä½¿ç”¨æœ€æ–°çš„ 7.0.3ï¼Œå› ä¸ºæœ‰æ¯”è¾ƒä¸¥é‡çš„ bugï¼Œå®˜æ–¹ä¹Ÿå»ºè®®ç”¨æˆ·ç”Ÿäº§ç¯å¢ƒä¸è¦ä½¿ç”¨è¯¥ç‰ˆæœ¬äº† <a href="https://kb.vmware.com/s/article/86287" target="_blank" rel="noopener">vSphere 7.0 Update 3 Critical Known Issues - Workarounds &amp; Fix (86287)</a> ã€‚</p><h3 id="å®‰è£…-govc-åŠä¾èµ–"><a href="#å®‰è£…-govc-åŠä¾èµ–" class="headerlink" title="å®‰è£… govc åŠä¾èµ–"></a>å®‰è£… govc åŠä¾èµ–</h3><p>åœ¨æœ¬åœ°æœºå™¨ä¸Šå®‰è£…å¥½ govc å’Œ jqï¼Œè¿™ä¸¤ä¸ªå·¥å…·åé¢åœ¨é…ç½® vCenter çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</p><ul><li>macOS</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install govc jq</span><br></pre></td></tr></table></figure><ul><li>Debian/Ubuntu</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tar -xf govc_Linux_x86_64.tar.gz -C /usr/<span class="built_in">local</span>/bin</span><br><span class="line">$ apt install jq -y</span><br></pre></td></tr></table></figure><ul><li>å…¶ä»– Linux å¯ä»¥åœ¨ govc å’Œ jq çš„ GitHub ä¸Šä¸‹è½½å¯¹åº”çš„å®‰è£…æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚</li></ul><h3 id="å®‰è£…-ESXi-OS"><a href="#å®‰è£…-ESXi-OS" class="headerlink" title="å®‰è£… ESXi OS"></a>å®‰è£… ESXi OS</h3><p>ESXi OS çš„å®‰è£…ç½‘ä¸Šæœ‰å¾ˆå¤šæ•™ç¨‹ï¼Œæ²¡æœ‰å¤ªå¤šå€¼å¾—è®²è§£çš„åœ°æ–¹ï¼Œå› æ­¤å°±å‚ç…§ä¸€ä¸‹å…¶ä»–å¤§ä½¬å†™çš„åšå®¢æˆ–è€…å®˜æ–¹çš„å®‰è£…æ–‡æ¡£ <a href="https://docs.vmware.com/cn/VMware-vSphere/7.0/vsphere-esxi-701-installation-setup-guide.pdf" target="_blank" rel="noopener">VMware ESXi å®‰è£…å’Œè®¾ç½®</a> æ¥å°±è¡Œï¼›éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼ŒESXi OS å®‰è£…æ—¶ VMFSL åˆ†åŒºå°†ä¼šå ç”¨å¤§é‡çš„å­˜å‚¨ç©ºé—´ï¼Œè¿™å°†ä¼šä½¿å¾— ESXi OS å®‰è£…æ‰€åœ¨çš„ç£ç›˜æœ€ç»ˆåˆ›å»ºå‡ºæ¥çš„ datastore æ¯”é¢„æœŸå°å¾ˆå¤šï¼Œè€Œä¸”è¿™ä¸ª VMFSL åˆ†åŒºåœ¨å®‰è£…å¥½ä¹‹åå°±å¾ˆéš¾å†åšè°ƒæ•´äº†ã€‚å› æ­¤å¦‚æœç£ç›˜å­˜å‚¨ç©ºé—´æ¯”è¾ƒç´§å¼ ï¼Œåœ¨å®‰è£… ESXi OS ä¹‹å‰å¯ä»¥è€ƒè™‘ä¸‹å¦‚ä½•å»æ‰è¿™ä¸ªåˆ†åŒºï¼›æˆ–è€…å’Œæˆ‘ä¸€æ ·å°† ESXI OS å®‰è£…åœ¨äº†ä¸€ä¸ª 16G çš„ USB Dom ç›˜ä¸Šï¼Œä¸è¿‡ç”Ÿäº§ç¯å¢ƒä¸å»ºè®®é‡‡ç”¨è¿™ç§æ–¹æ¡ˆ ğŸ˜‚ï¼ˆå…¶å®ä¸ªäººè§‰ç€å®‰è£…åœ¨ U ç›˜ä¸Šé—®é¢˜ä¸å¤§ï¼ŒESXi OS å¯åŠ¨ä¹‹åæ˜¯åŠ è½½åˆ°å†…å­˜ä¸­è¿è¡Œçš„ï¼Œä¸ä¼šå¯¹ U ç›˜æœ‰å¤§é‡çš„è¯»å†™æ“ä½œï¼Œåªä¸è¿‡åœ¨æœºæˆ¿ä¸­ U ç›˜è¢«äººä¸å°å¿ƒæ‹”èµ°å°±å‡‰äº†ã€‚</p><ul><li>è®¾ç½® govc ç¯å¢ƒå˜é‡</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ESXi èŠ‚ç‚¹çš„ IP</span></span><br><span class="line"><span class="built_in">export</span> ESXI_IP=<span class="string">"192.168.18.47"</span></span><br><span class="line"><span class="comment"># ESXi ç™»å½•çš„ç”¨æˆ·åï¼Œåˆæ¬¡å®‰è£…åé»˜è®¤ä¸º root</span></span><br><span class="line"><span class="built_in">export</span> GOVC_USERNAME=<span class="string">"root"</span></span><br><span class="line"><span class="comment"># åœ¨ ESXi å®‰è£…æ—¶è®¾ç½®çš„ root å¯†ç </span></span><br><span class="line"><span class="built_in">export</span> GOVC_PASSWORD=<span class="string">"admin@2022"</span></span><br><span class="line"><span class="comment"># å…è®¸ä¸å®‰å…¨çš„ SSL è¿æ¥</span></span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://<span class="variable">$&#123;ESXI_IP&#125;</span>"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=datastore1</span><br></pre></td></tr></table></figure><ul><li>æµ‹è¯• govc æ˜¯å¦èƒ½æ­£å¸¸è¿æ¥ ESXi ä¸»æœº</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Name:              localhost.local</span><br><span class="line">  Path:            /ha-datacenter/host/localhost/localhost</span><br><span class="line">  Manufacturer:    Dell</span><br><span class="line">  Logical CPUs:    20 CPUs @ 2394MHz</span><br><span class="line">  Processor <span class="built_in">type</span>:  Intel(R) Xeon(R) Silver 4210R CPU @ 2.40GHz</span><br><span class="line">  CPU usage:       579 MHz (1.2%)</span><br><span class="line">  Memory:          261765MB</span><br><span class="line">  Memory usage:    16457 MB (6.3%)</span><br><span class="line">  Boot time:       2022-02-02 11:53:59.630124 +0000 UTC</span><br><span class="line">  State:           connected</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…-vCenter"><a href="#å®‰è£…-vCenter" class="headerlink" title="å®‰è£… vCenter"></a>å®‰è£… vCenter</h3><p>æŒ‰ç…§ VMware å®˜æ–¹çš„ vCenter å®‰è£…æ–‡æ¡£ <a href="https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vcenter.install.doc/GUID-8DC3866D-5087-40A2-8067-1361A2AF95BD.html" target="_blank" rel="noopener">å…³äº vCenter Server å®‰è£…å’Œè®¾ç½®</a> æ¥å®‰è£…å®åœ¨æ˜¯è¿‡äºç¹çï¼Œå…¶å®å®˜æ–¹çš„ ISO å®‰è£…æ–¹å¼æ— éæ˜¯è¿è¡Œä¸€ä¸ª installer web æœåŠ¡ï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸Šé…ç½®å¥½ vCenter è™šæ‹Ÿæœºçš„å‚æ•°ï¼Œå†å°†å¡«å†™çš„é…ç½®ä¿¡æ¯åœ¨éƒ¨ç½² vcsa è™šæ‹Ÿæœºçš„æ—¶å€™æ³¨å…¥åˆ° ova çš„é…ç½®å‚æ•°ä¸­ã€‚</p><p>çŸ¥é“è¿™ä¸ªå®‰è£…è¿‡ç¨‹çš„åŸç†ä¹‹åæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±é…ç½® vCenter çš„å‚æ•°ä¿¡æ¯ï¼Œç„¶åé€šè¿‡ govc æ¥éƒ¨ç½² ovaï¼›è¿™æ¯”ä½¿ç”¨ UI çš„æ–¹å¼ç®€å•æ–¹ä¾¿å¾ˆå¤šï¼Œæœ€ç»ˆåªéœ€è¦å¡«å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¸€æ¡å‘½ä»¤å°±å¯ä»¥éƒ¨ç½²å®Œæˆå•¦ã€‚</p><ul><li>é¦–å…ˆæ˜¯æŒ‚è½½ vCenter çš„ ISOï¼Œæ‰¾åˆ° vcsa ova æ–‡ä»¶ï¼Œå®ƒæ˜¯ vCenter è™šæ‹Ÿæœºçš„æ¨¡ç‰ˆ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mount -o loop VMware-VCSA-all-7.0.3-18778458.iso /mnt</span><br><span class="line">$ ls /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova</span><br><span class="line">/mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova</span><br></pre></td></tr></table></figure><ul><li>æ ¹æ®è‡ªå·±çš„ç¯å¢ƒä¿¡æ¯ä¿®æ”¹ä¸‹é¢å®‰è£…è„šæœ¬ä¸­çš„ç›¸å…³é…ç½®ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">VCSA_OVA_FILE=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -o errexit</span><br><span class="line"><span class="built_in">set</span> -o nounset</span><br><span class="line"><span class="built_in">set</span> -o pipefail</span><br><span class="line"></span><br><span class="line"><span class="comment"># ESXi çš„ IP åœ°å€</span></span><br><span class="line"><span class="built_in">export</span> ESXI_IP=<span class="string">"192.168.18.47"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ESXi çš„ç”¨æˆ·å</span></span><br><span class="line"><span class="built_in">export</span> GOVC_USERNAME=<span class="string">"root"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ESXI çš„å¯†ç </span></span><br><span class="line"><span class="built_in">export</span> GOVC_PASSWORD=<span class="string">"admin@2020"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… vCenter è™šæ‹Ÿæœºä½¿ç”¨çš„ datastore åç§°</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=datastore1</span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://<span class="variable">$&#123;ESXI_IP&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter çš„ç™»å½•å¯†ç </span></span><br><span class="line">VM_PASSWORD=<span class="string">"admin@2020"</span></span><br><span class="line"><span class="comment"># vCenter çš„ IP åœ°å€</span></span><br><span class="line">VM_IP=192.168.20.92</span><br><span class="line"><span class="comment"># vCenter è™šæ‹Ÿæœºçš„åç§°</span></span><br><span class="line">VM_NAME=vCenter-Server-Appliance</span><br><span class="line"><span class="comment"># vCenter è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œ</span></span><br><span class="line">VM_NETWORK=<span class="string">"VM Network"</span></span><br><span class="line"><span class="comment"># DNS æœåŠ¡å™¨</span></span><br><span class="line">VM_DNS=<span class="string">"223.6.6.6"</span></span><br><span class="line"><span class="comment"># NTP æœåŠ¡å™¨</span></span><br><span class="line">VM_NTP=<span class="string">"0.pool.ntp.org"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">deploy_vcsa_vm</span></span>()&#123;</span><br><span class="line">    config=$(govc host.info -k -json | jq -r <span class="string">'.HostSystems[].Config'</span>)</span><br><span class="line">    gateway=$(jq -r <span class="string">'.Network.IpRouteConfig.DefaultGateway'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$config</span>"</span>)</span><br><span class="line">    route=$(jq -r <span class="string">'.Network.RouteTableInfo.IpRoute[] | select(.DeviceName == "vmk0") | select(.Gateway == "0.0.0.0")'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$config</span>"</span>)</span><br><span class="line">    prefix=$(jq -r <span class="string">'.PrefixLength'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$route</span>"</span>)</span><br><span class="line">    opts=(</span><br><span class="line">        cis.vmdir.password=<span class="variable">$&#123;VM_PASSWORD&#125;</span></span><br><span class="line">        cis.appliance.root.passwd=<span class="variable">$&#123;VM_PASSWORD&#125;</span></span><br><span class="line">        cis.appliance.root.shell=/bin/bash</span><br><span class="line">        cis.deployment.node.type=embedded</span><br><span class="line">        cis.vmdir.domain-name=vsphere.local</span><br><span class="line">        cis.vmdir.site-name=VCSA</span><br><span class="line">        cis.appliance.net.addr.family=ipv4</span><br><span class="line">        cis.appliance.ssh.enabled=True</span><br><span class="line">        cis.ceip_enabled=False</span><br><span class="line">        cis.deployment.autoconfig=True</span><br><span class="line">        cis.appliance.net.addr=<span class="variable">$&#123;VM_IP&#125;</span></span><br><span class="line">        cis.appliance.net.prefix=<span class="variable">$&#123;prefix&#125;</span></span><br><span class="line">        cis.appliance.net.dns.servers=<span class="variable">$&#123;VM_DNS&#125;</span></span><br><span class="line">        cis.appliance.net.gateway=<span class="variable">$gateway</span></span><br><span class="line">        cis.appliance.ntp.servers=<span class="string">"<span class="variable">$&#123;VM_NTP&#125;</span>"</span></span><br><span class="line">        cis.appliance.net.mode=static</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    props=$(<span class="built_in">printf</span> -- <span class="string">"guestinfo.%s\n"</span> <span class="string">"<span class="variable">$&#123;opts[@]&#125;</span>"</span> | jq --slurp -R <span class="string">'split("\n") | map(select(. != "")) | map(split("=")) | map(&#123;"Key": .[0], "Value": .[1]&#125;)'</span>)</span><br><span class="line"></span><br><span class="line">    cat &lt;&lt;EOF | govc import.<span class="variable">$&#123;VCSA_OVA_FILE##*.&#125;</span> -options - <span class="string">"<span class="variable">$&#123;VCSA_OVA_FILE&#125;</span>"</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span>,</span><br><span class="line">    <span class="string">"Deployment"</span>: <span class="string">"tiny"</span>,</span><br><span class="line">    <span class="string">"DiskProvisioning"</span>: <span class="string">"thin"</span>,</span><br><span class="line">    <span class="string">"IPProtocol"</span>: <span class="string">"IPv4"</span>,</span><br><span class="line">    <span class="string">"Annotation"</span>: <span class="string">"VMware vCenter Server Appliance"</span>,</span><br><span class="line">    <span class="string">"PowerOn"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"WaitForIP"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"InjectOvfEnv"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"NetworkMapping"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"Network 1"</span>,</span><br><span class="line">        <span class="string">"Network"</span>: <span class="string">"<span class="variable">$&#123;VM_NETWORK&#125;</span>"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"PropertyMapping"</span>: <span class="variable">$&#123;props&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">deploy_vcsa_vm</span><br><span class="line">govc vm.change -vm <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span> -g vmwarePhoton64Guest</span><br><span class="line">govc vm.power -on <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span></span><br><span class="line">govc vm.ip -a <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span></span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡è„šæœ¬å®‰è£… vCenterï¼ŒæŒ‡å®šç¬¬ä¸€å‚æ•°ä¸º OVA çš„ç»å¯¹è·¯å¾„ã€‚è¿è¡Œå®Œåå°†ä¼šè‡ªåŠ¨å°† ova å¯¼å…¥åˆ° vCenterï¼Œå¹¶å¯åŠ¨è™šæ‹Ÿæœºï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰§è¡Œè¯¥è„šæœ¬ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ vCenter ISO ä¸­ vcsa ova æ–‡ä»¶çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line">$ bash install-vcsa.sh /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova</span><br><span class="line"></span><br><span class="line">[03-02-22 18:40:19] Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk1.vmdk... OK</span><br><span class="line">[03-02-22 18:41:09] Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk... (29%, 52.5MiB/s)</span><br><span class="line">[03-02-22 18:43:08] Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk... OK</span><br><span class="line">[03-02-22 18:43:08] Injecting OVF environment...</span><br><span class="line">Powering on VirtualMachine:3... OK</span><br><span class="line">fe80::20c:29ff:fe03:2f80</span><br></pre></td></tr></table></figure><ul><li>è®¾ç½® vCenter ç™»å½•çš„ç¯å¢ƒå˜é‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ govc æ¥é…ç½® vCenterï¼Œé€šè¿‡æµè§ˆå™¨ Web UI çš„æ–¹å¼é…ç½®èµ·æ¥æ•ˆç‡æœ‰ç‚¹ä½ï¼Œä¸å¦‚ govc å‘½ä»¤ä¸€æŠŠæ¢­æ–¹ä¾¿ ğŸ˜‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://192.168.20.92"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_USERNAME=<span class="string">"administrator@vsphere.local"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_PASSWORD=<span class="string">"admin@2022"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=datastore1</span><br></pre></td></tr></table></figure><ul><li>è™šæ‹Ÿæœºå¯åŠ¨åå°†è‡ªåŠ¨è¿›è¡Œ vCenter çš„å®‰è£…é…ç½®ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ vCenter å®‰è£…å¥½ä¹‹åï¼Œä½¿ç”¨ govc about æŸ¥çœ‹ vCenter çš„ä¿¡æ¯ï¼Œå¦‚æœèƒ½æ­£ç¡®æˆ–æ¸ é“è¯´æ˜ vCenter å°±å®‰è£…å¥½äº†ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ govc about</span><br><span class="line">FullName:     VMware vCenter Server 7.0.3 build-18778458</span><br><span class="line">Name:         VMware vCenter Server</span><br><span class="line">Vendor:       VMware, Inc.</span><br><span class="line">Version:      7.0.3</span><br><span class="line">Build:        18778458</span><br><span class="line">OS <span class="built_in">type</span>:      linux-x64</span><br><span class="line">API <span class="built_in">type</span>:     VirtualCenter</span><br><span class="line">API version:  7.0.3.0</span><br><span class="line">Product ID:   vpx</span><br><span class="line">UUID:         0b49e119-e38f-4fbc-84a8-d7a0e548027d</span><br></pre></td></tr></table></figure><h3 id="é…ç½®-vCenter"><a href="#é…ç½®-vCenter" class="headerlink" title="é…ç½® vCenter"></a>é…ç½® vCenter</h3><p>è¿™ä¸€æ­¥éª¤ä¸»è¦æ˜¯é…ç½® vCenterï¼šåˆ›å»º Datacenterã€clusterã€folder ç­‰èµ„æºï¼Œå¹¶å°† ESXi ä¸»æœºæ·»åŠ åˆ° cluster ä¸­ï¼›</p><ul><li>é…ç½® vCenter</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º Datacenter æ•°æ®ä¸­å¿ƒ</span></span><br><span class="line">$ govc datacenter.create SH-IDC</span><br><span class="line"><span class="comment"># åˆ›å»º Cluster é›†ç¾¤</span></span><br><span class="line">$ govc cluster.create -dc=SH-IDC Tanzu-Cluster</span><br><span class="line"><span class="comment"># å°† ESXi ä¸»æœºæ·»åŠ åˆ° Cluster å½“ä¸­</span></span><br><span class="line">$ govc cluster.add -dc=SH-IDC -cluster=Tanzu-Cluster -hostname=192.168.18.47 --username=root -password=<span class="string">'admin@2020'</span> -noverify</span><br><span class="line"><span class="comment"># åˆ›å»º folderï¼Œç”¨äºå°† Tanzu çš„èŠ‚ç‚¹è™šæ‹Ÿæœºå­˜æ”¾åˆ°è¯¥æ–‡ä»¶å¤¹ä¸‹</span></span><br><span class="line">$ govc folder.create /SH-IDC/vm/Tanzu-node</span><br><span class="line"><span class="comment"># å¯¼å…¥ tanzu æ±²å–èŠ‚ç‚¹çš„è™šæ‹Ÿæœº ova æ¨¡ç‰ˆ</span></span><br><span class="line">$ govc import.ova -dc=<span class="string">'SH-IDC'</span> -ds=<span class="string">'datastore1'</span> photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</span><br><span class="line"><span class="comment"># å°†è™šæ‹Ÿæœºè½¬æ¢ä¸ºæ¨¡ç‰ˆï¼Œåç»­ tanzu é›†ç¾¤å°†ä»¥è¯¥æ¨¡ç‰ˆåˆ›å»ºè™šæ‹Ÿæœº</span></span><br><span class="line">$ govc vm.markastemplate photon-3-kube-v1.21.2</span><br></pre></td></tr></table></figure><h3 id="åˆå§‹åŒ–-bootstrap-èŠ‚ç‚¹"><a href="#åˆå§‹åŒ–-bootstrap-èŠ‚ç‚¹" class="headerlink" title="åˆå§‹åŒ– bootstrap èŠ‚ç‚¹"></a>åˆå§‹åŒ– bootstrap èŠ‚ç‚¹</h3><p>bootstrap èŠ‚ç‚¹èŠ‚ç‚¹æ˜¯ç”¨äºè¿è¡Œ tanzu éƒ¨ç½²å·¥å…·çš„èŠ‚ç‚¹ï¼Œå®˜æ–¹æ˜¯æ”¯æŒ Linux/macOS/Windows ä¸‰ç§æ“ä½œç³»ç»Ÿçš„ï¼Œä½†æœ‰ä¸€äº›æ¯”è¾ƒä¸¥æ ¼çš„è¦æ±‚ï¼š</p><table><thead><tr><th>Arch: x86; ARM is currently unsupported</th></tr></thead><tbody><tr><td>RAM: 6 GB</td></tr><tr><td>CPU: 2</td></tr><tr><td><a href="https://docs.docker.com/engine/install/" target="_blank" rel="noopener">Docker</a> Add your non-root user account to the docker user group. Create the group if it does not already exist. This lets the Tanzu CLI access the Docker socket, which is owned by the root user. For more information, see steps 1 to 4 in the <a href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user" target="_blank" rel="noopener">Manage Docker as a non-root user</a> procedure in the Docker documentation.</td></tr><tr><td><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/" target="_blank" rel="noopener">Kubectl</a></td></tr><tr><td>Latest version of Chrome, Firefox, Safari, Internet Explorer, or Edge</td></tr><tr><td>System time is synchronized with a Network Time Protocol (NTP) server.</td></tr><tr><td>Ensure your bootstrap machine is using <a href="https://man7.org/linux/man-pages/man7/cgroups.7.html" target="_blank" rel="noopener">cgroup v1</a>. For more information, see <a href="https://tanzucommunityedition.io/docs/latest/support-matrix/#check-and-set-the-cgroup" target="_blank" rel="noopener">Check and set the cgroup</a>.</td></tr></tbody></table><p>åœ¨è¿™é‡Œä¸ºäº†é¿å…è¿™äº›éº»çƒ¦çš„é…ç½®ï¼Œæˆ‘å°±ç›´æ¥ä½¿ç”¨çš„ VMware å®˜æ–¹çš„ <a href="https://github.com/vmware/photon/wiki/Downloading-Photon-OS#photon-os-40-rev2-binaries" target="_blank" rel="noopener">Photon OS 4.0 Rev2</a> ï¼Œä¸‹è½½ OVA æ ¼å¼çš„é•œåƒç›´æ¥å¯¼å…¥åˆ° ESXi ä¸»æœºå¯åŠ¨ä¸€å°è™šæ‹Ÿæœºå³å¯ï¼Œèƒ½èŠ‚çœä¸å°‘éº»çƒ¦çš„é…ç½®ï¼›è¿˜æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯åœ¨ä¸€å°å•ç‹¬çš„è™šæ‹Ÿæœºä¸Šè¿è¡Œ tanzu éƒ¨ç½²å·¥å…·ä¸ä¼šæ±¡æŸ“æœ¬åœ°çš„å¼€å‘ç¯å¢ƒã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova</span><br><span class="line"><span class="comment"># å¯¼å…¥ OVA è™šæ‹Ÿæœºæ¨¡ç‰ˆ</span></span><br><span class="line">$ govc import.ova -ds=<span class="string">'datastore1'</span> -name bootstrap-node photon-ova-4.0-c001795b80.ova</span><br><span class="line"><span class="comment"># ä¿®æ”¹ä¸€ä¸‹è™šæ‹Ÿæœºçš„é…ç½®ï¼Œè°ƒæ•´ä¸º 4C8G</span></span><br><span class="line">$ govc vm.change -c 4 -m 8192 -vm bootstrap-node</span><br><span class="line"><span class="comment"># å¼€å¯è™šæ‹Ÿæœº</span></span><br><span class="line">$ govc vm.power -on bootstrap-node</span><br><span class="line"><span class="comment"># æŸ¥çœ‹è™šæ‹Ÿæœºè·å–åˆ°çš„ IPv4 åœ°å€</span></span><br><span class="line">$ govc vm.ip -a -<span class="built_in">wait</span> 1m bootstrap-node</span><br><span class="line">$ ssh root@192.168.74.10</span><br><span class="line"><span class="comment"># å¯†ç é»˜è®¤ä¸º changemeï¼Œè¾“å…¥å®Œå¯†ç ä¹‹åæç¤ºåœ¨è¾“å…¥ä¸€é changemeï¼Œç„¶åå†ä¿®æ”¹æ–°çš„å¯†ç </span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># cat /etc/os-release</span></span><br><span class="line">NAME=<span class="string">"VMware Photon OS"</span></span><br><span class="line">VERSION=<span class="string">"4.0"</span></span><br><span class="line">ID=photon</span><br><span class="line">VERSION_ID=4.0</span><br><span class="line">PRETTY_NAME=<span class="string">"VMware Photon OS/Linux"</span></span><br><span class="line">ANSI_COLOR=<span class="string">"1;34"</span></span><br><span class="line">HOME_URL=<span class="string">"https://vmware.github.io/photon/"</span></span><br><span class="line">BUG_REPORT_URL=<span class="string">"https://github.com/vmware/photon/issues"</span></span><br></pre></td></tr></table></figure><ul><li>å®‰è£…éƒ¨ç½²æ—¶éœ€è¦çš„ä¸€äº›å·¥å…·ï¼ˆåˆ‡ï¼ŒPhoton OS é‡Œç«Ÿç„¶è¿ä¸ª tar å‘½ä»¤éƒ½æ²¡æœ‰ ğŸ˜ </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># tdnf install sudo tar -y</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># curl -LO https://dl.k8s.io/release/v1.21.2/bin/linux/amd64/kubectl</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨ dockerï¼Œbootstrap èŠ‚ç‚¹ä¼šä»¥ kind çš„æ–¹å¼è¿è¡Œä¸€ä¸ª K8s é›†ç¾¤ï¼Œéœ€è¦ç”¨åˆ° dockerã€‚è™½ç„¶å¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ k8s é›†ç¾¤ï¼Œä½†ä¸æ˜¯å¾ˆæ¨èï¼Œå› ä¸º cluster-api ä¾èµ– k8s çš„ç‰ˆæœ¬ï¼Œä¸èƒ½å¤ªé«˜ä¹Ÿä¸èƒ½å¤ªä½ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># systemctl enable docker --now</span></span><br></pre></td></tr></table></figure><ul><li>ä» <a href="https://github.com/vmware-tanzu/community-edition/releases/tag/v0.9.1" target="_blank" rel="noopener">vmware-tanzu/community-edition</a> ä¸‹è½½ tanzu ç¤¾åŒºç‰ˆçš„å®‰è£…åŒ…ï¼Œç„¶åè§£å‹åå®‰è£…ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># curl -LO  https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># tar -xf tce-linux-amd64-v0.9.1.tar.gz</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># cd tce-linux-amd64-v0.9.1/</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># bash install.sh</span></span><br></pre></td></tr></table></figure><p>ç„¶è€Œä¸å¹¸åœ°ç¿»è½¦äº†ï¼Œ install.sh è„šæœ¬ä¸­ç¦æ­¢ root ç”¨æˆ·è¿è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ ALLOW_INSTALL_AS_ROOT=</span><br><span class="line">+ [[ 0 -eq 0 ]]</span><br><span class="line">+ [[ <span class="string">''</span> != \t\r\u\e ]]</span><br><span class="line">+ <span class="built_in">echo</span> <span class="string">'Do not run this script as root'</span></span><br><span class="line">Do not run this script as root</span><br><span class="line">+ <span class="built_in">exit</span> 1</span><br></pre></td></tr></table></figure><p>æˆ‘å°±ååè¦ä»¥ root ç”¨æˆ·æ¥è¿è¡Œæ€ä¹ˆæƒ¹ ğŸ˜¡</p><p><img src="https://p.k8s.li/2022-01-22-deploy-tanzu-k8s-cluster-01.jpg" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sed å»æ‰ç¬¬ä¸€ä¸ª exit 1 å°±å¯ä»¥äº†</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># sed -i.bak "s/exit 1//" install.sh</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># bash install.sh</span></span><br></pre></td></tr></table></figure><p>å®‰è£…å¥½ä¹‹åä¼šè¾“å‡º <code>Installation complete!</code>ï¼ˆè®²çœŸå®˜æ–¹çš„ install.sh è„šæœ¬è¾“å‡ºå¾ˆä¸å‹å¥½ï¼Œæ±¡æŸ“æˆ‘çš„ terminal</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+ tanzu init</span><br><span class="line">| initializing âœ”  successfully initialized CLI</span><br><span class="line">++ tanzu plugin repo list</span><br><span class="line">++ grep tce</span><br><span class="line">+ TCE_REPO=</span><br><span class="line">+ [[ -z <span class="string">''</span> ]]</span><br><span class="line">+ tanzu plugin repo add --name tce --gcp-bucket-name tce-tanzu-cli-plugins --gcp-root-path artifacts</span><br><span class="line">++ tanzu plugin repo list</span><br><span class="line">++ grep core-admin</span><br><span class="line">+ TCE_REPO=</span><br><span class="line">+ [[ -z <span class="string">''</span> ]]</span><br><span class="line">+ tanzu plugin repo add --name core-admin --gcp-bucket-name tce-tanzu-cli-framework-admin --gcp-root-path artifacts-admin</span><br><span class="line">+ <span class="built_in">echo</span> <span class="string">'Installation complete!'</span></span><br><span class="line">Installation complete!</span><br></pre></td></tr></table></figure><h3 id="éƒ¨ç½²ç®¡ç†é›†ç¾¤"><a href="#éƒ¨ç½²ç®¡ç†é›†ç¾¤" class="headerlink" title="éƒ¨ç½²ç®¡ç†é›†ç¾¤"></a>éƒ¨ç½²ç®¡ç†é›†ç¾¤</h3><p>å…ˆæ˜¯éƒ¨ç½²ä¸€ä¸ª tanzu çš„ç®¡ç†é›†ç¾¤ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡ <a href="https://tanzucommunityedition.io/docs/latest/getting-started/" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a> æåˆ°çš„é€šè¿‡ Web UI çš„æ–¹å¼ã€‚ç›®å‰è¿™ä¸ª UI ç•Œé¢æ¯”è¾ƒæ‹‰å®ï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥è®©ç”¨æˆ·å¡«å†™ä¸€äº›é…ç½®å‚æ•°ï¼Œç„¶åè°ƒç”¨åå°çš„ tanzu å‘½ä»¤æ¥éƒ¨ç½²é›†ç¾¤ã€‚å¹¶æŠŠé›†ç¾¤éƒ¨ç½²çš„æ—¥å¿—å’Œè¿›åº¦å±•ç¤ºå‡ºæ¥ï¼›éƒ¨ç½²å®Œæˆä¹‹åï¼Œè¿™ä¸ª UI åˆä¸èƒ½ç®¡ç†è¿™äº›é›†ç¾¤ï¼Œåˆä¸æ”¯æŒéƒ¨ç½² workload é›†ç¾¤ï¼ˆ</p><p>å¦ä¸€ç§å°±æ˜¯é€šè¿‡ tanzu å‘½ä»¤æŒ‡å®šé…ç½®æ–‡ä»¶æ¥éƒ¨ç½²ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦é€šè¿‡æµè§ˆå™¨åœ¨ web é¡µé¢ä¸Šå‚»ä¹ä¹åœ°ç‚¹æ¥ç‚¹å»å¡«ä¸€äº›å‚æ•°ï¼Œåªéœ€è¦æå‰å¡«å†™å¥½ä¸€ä¸ª yaml æ ¼å¼çš„é…ç½®æ–‡ä»¶å³å¯ã€‚ä¸‹é¢æˆ‘ä»¬å°±é‡‡ç”¨ tanzu å‘½ä»¤æ¥éƒ¨ç½²é›†ç¾¤ï¼Œç®¡ç†é›†ç¾¤çš„é…ç½®æ–‡ä»¶æ¨¡ç‰ˆå¦‚ä¸‹ï¼š</p><ul><li>tanzu-mgt-cluster.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cluster Pod IP çš„ CIDR</span></span><br><span class="line"><span class="attr">CLUSTER_CIDR:</span> <span class="number">100.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/11</span></span><br><span class="line"><span class="comment"># Service çš„ CIDR</span></span><br><span class="line"><span class="attr">SERVICE_CIDR:</span> <span class="number">100.64</span><span class="number">.0</span><span class="number">.0</span><span class="string">/13</span></span><br><span class="line"><span class="comment"># é›†ç¾¤çš„åç§°</span></span><br><span class="line"><span class="attr">CLUSTER_NAME:</span> <span class="string">tanzu-control-plan</span></span><br><span class="line"><span class="comment"># é›†ç¾¤çš„ç±»å‹</span></span><br><span class="line"><span class="attr">CLUSTER_PLAN:</span> <span class="string">dev</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹çš„ arch</span></span><br><span class="line"><span class="attr">OS_ARCH:</span> <span class="string">amd64</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹çš„ OS åç§°</span></span><br><span class="line"><span class="attr">OS_NAME:</span> <span class="string">photon</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹ OS ç‰ˆæœ¬</span></span><br><span class="line"><span class="attr">OS_VERSION:</span> <span class="string">"3"</span></span><br><span class="line"><span class="comment"># åŸºç¡€è®¾æ–½èµ„æºçš„æä¾›æ–¹</span></span><br><span class="line"><span class="attr">INFRASTRUCTURE_PROVIDER:</span> <span class="string">vsphere</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤çš„ VIP</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_ENDPOINT:</span> <span class="number">192.168</span><span class="number">.75</span><span class="number">.194</span></span><br><span class="line"><span class="comment"># control-plan èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># control-plan èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_MEM_MIB:</span> <span class="string">"8192"</span></span><br><span class="line"><span class="comment"># control-plan èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_NUM_CPUS:</span> <span class="string">"4"</span></span><br><span class="line"><span class="comment"># work èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># work èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_MEM_MIB:</span> <span class="string">"4096"</span></span><br><span class="line"><span class="comment"># work èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_NUM_CPUS:</span> <span class="string">"2"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter çš„ Datacenter è·¯å¾„</span></span><br><span class="line"><span class="attr">VSPHERE_DATACENTER:</span> <span class="string">/SH-IDC</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„ Datastore è·¯å¾„</span></span><br><span class="line"><span class="attr">VSPHERE_DATASTORE:</span> <span class="string">/SH-IDC/datastore/datastore1</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="attr">VSPHERE_FOLDER:</span> <span class="string">/SH-IDC/vm/Tanzu-node</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œ</span></span><br><span class="line"><span class="attr">VSPHERE_NETWORK:</span> <span class="string">/SH-IDC/network/VM</span> <span class="string">Network</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºå…³è”çš„èµ„æºæ± </span></span><br><span class="line"><span class="attr">VSPHERE_RESOURCE_POOL:</span> <span class="string">/SH-IDC/host/Tanzu-Cluster/Resources</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter çš„ IP</span></span><br><span class="line"><span class="attr">VSPHERE_SERVER:</span> <span class="number">192.168</span><span class="number">.75</span><span class="number">.110</span></span><br><span class="line"><span class="comment"># vCenter çš„ç”¨æˆ·å</span></span><br><span class="line"><span class="attr">VSPHERE_USERNAME:</span> <span class="string">administrator@vsphere.local</span></span><br><span class="line"><span class="comment"># vCenter çš„å¯†ç ï¼Œä»¥ base64 ç¼–ç </span></span><br><span class="line"><span class="attr">VSPHERE_PASSWORD:</span> <span class="string">&lt;encoded:base64password&gt;</span></span><br><span class="line"><span class="comment"># vCenter çš„è¯ä¹¦æŒ‡çº¹ï¼Œå¯ä»¥é€šè¿‡ govc about.cert -json | jq -r '.ThumbprintSHA1' è·å–</span></span><br><span class="line"><span class="attr">VSPHERE_TLS_THUMBPRINT:</span> <span class="string">EB:F3:D8:7A:E8:3D:1A:59:B0:DE:73:96:DC:B9:5F:13:86:EF:B6:27</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºæ³¨å…¥çš„ ssh å…¬é’¥ï¼Œéœ€è¦ç”¨å®ƒæ¥ ssh ç™»å½•é›†ç¾¤èŠ‚ç‚¹</span></span><br><span class="line"><span class="attr">VSPHERE_SSH_AUTHORIZED_KEY:</span> <span class="string">ssh-rsa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€äº›é»˜è®¤å‚æ•°</span></span><br><span class="line"><span class="attr">AVI_ENABLE:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">IDENTITY_MANAGEMENT_TYPE:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">ENABLE_AUDIT_LOGGING:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">ENABLE_CEIP_PARTICIPATION:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">TKG_HTTP_PROXY_ENABLED:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">DEPLOY_TKG_ON_VSPHERE7:</span> <span class="string">"true"</span></span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ tanzu CLI éƒ¨ç½²ç®¡ç†é›†ç¾¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tanzu management-cluster create --file tanzu-mgt-cluster.yaml -v6</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœæ²¡æœ‰é…ç½® VSPHERE_TLS_THUMBPRINT ä¼šæœ‰ä¸€ä¸ªç¡®è®¤ vSphere thumbprint çš„äº¤äº’ï¼Œè¾“å…¥ Y å°±å¯ä»¥</span></span><br><span class="line">Validating the pre-requisites...</span><br><span class="line">Do you want to <span class="built_in">continue</span> with the vSphere thumbprint EB:F3:D8:7A:E8:3D:1A:59:B0:DE:73:96:DC:B9:5F:13:86:EF:B6:27 [y/N]: y</span><br></pre></td></tr></table></figure><h3 id="éƒ¨ç½²æ—¥å¿—"><a href="#éƒ¨ç½²æ—¥å¿—" class="headerlink" title="éƒ¨ç½²æ—¥å¿—"></a>éƒ¨ç½²æ—¥å¿—</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># tanzu management-cluster create --file tanzu-mgt-cluster.yaml -v 6</span></span><br><span class="line">compatibility file (/root/.config/tanzu/tkg/compatibility/tkg-compatibility.yaml) already exists, skipping download</span><br><span class="line">BOM files inside /root/.config/tanzu/tkg/bom already exists, skipping download</span><br><span class="line">CEIP Opt-in status: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Validating the pre-requisites...</span><br><span class="line"></span><br><span class="line">vSphere 7.0 Environment Detected.</span><br><span class="line"></span><br><span class="line">You have connected to a vSphere 7.0 environment <span class="built_in">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includes</span><br><span class="line">an integrated Tanzu Kubernetes Grid Service <span class="built_in">which</span> turns a vSphere cluster into a platform <span class="keyword">for</span> running Kubernetes workloads <span class="keyword">in</span> dedicated</span><br><span class="line">resource pools. Configuring Tanzu Kubernetes Grid Service is <span class="keyword">done</span> through vSphere HTML5 client.</span><br><span class="line"></span><br><span class="line">Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="keyword">in</span> vSphere 7.0 environments. Alternatively you may</span><br><span class="line">deploy a non-integrated Tanzu Kubernetes Grid instance on vSphere 7.0.</span><br><span class="line">Deploying TKG management cluster on vSphere 7.0 ...</span><br><span class="line">Identity Provider not configured. Some authentication features won<span class="string">'t work.</span></span><br><span class="line"><span class="string">Checking if VSPHERE_CONTROL_PLANE_ENDPOINT 192.168.20.94 is already in use</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Setting up management cluster...</span></span><br><span class="line"><span class="string">Validating configuration...</span></span><br><span class="line"><span class="string">Using infrastructure provider vsphere:v0.7.10</span></span><br><span class="line"><span class="string">Generating cluster configuration...</span></span><br><span class="line"><span class="string">Setting up bootstrapper...</span></span><br><span class="line"><span class="string">Fetching configuration for kind node image...</span></span><br><span class="line"><span class="string">kindConfig:</span></span><br><span class="line"><span class="string"> &amp;&#123;&#123;Cluster kind.x-k8s.io/v1alpha4&#125;  [&#123;  map[] [&#123;/var/run/docker.sock /var/run/docker.sock false false &#125;] [] [] []&#125;] &#123; 0  100.96.0.0/11 100.64.0.0/13 false &#125; map[] map[] [apiVersion: kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="string">kind: ClusterConfiguration</span></span><br><span class="line"><span class="string">imageRepository: projects.registry.vmware.com/tkg</span></span><br><span class="line"><span class="string">etcd:</span></span><br><span class="line"><span class="string">  local:</span></span><br><span class="line"><span class="string">    imageRepository: projects.registry.vmware.com/tkg</span></span><br><span class="line"><span class="string">    imageTag: v3.4.13_vmware.15</span></span><br><span class="line"><span class="string">dns:</span></span><br><span class="line"><span class="string">  type: CoreDNS</span></span><br><span class="line"><span class="string">  imageRepository: projects.registry.vmware.com/tkg</span></span><br><span class="line"><span class="string">  imageTag: v1.8.0_vmware.5] [] [] []&#125;</span></span><br><span class="line"><span class="string">Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span></span><br><span class="line"><span class="string">Creating cluster "tkg-kind-c7vj6kds0a6sf43e6210" ...</span></span><br><span class="line"><span class="string">Ensuring node image (projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1) ...</span></span><br><span class="line"><span class="string">Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 ...</span></span><br><span class="line"><span class="string">Preparing nodes ...</span></span><br><span class="line"><span class="string">Writing configuration ...</span></span><br><span class="line"><span class="string">Starting control-plane ...</span></span><br><span class="line"><span class="string">Installing CNI ...</span></span><br><span class="line"><span class="string">Installing StorageClass ...</span></span><br><span class="line"><span class="string">Waiting 2m0s for control-plane = Ready ...</span></span><br><span class="line"><span class="string">Ready after 19s</span></span><br><span class="line"><span class="string">Bootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOL</span></span><br><span class="line"><span class="string">Installing providers on bootstrapper...</span></span><br><span class="line"><span class="string">Fetching providers</span></span><br><span class="line"><span class="string">Installing cert-manager Version="v1.1.0"</span></span><br><span class="line"><span class="string">Waiting for cert-manager to be available...</span></span><br><span class="line"><span class="string">Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"</span></span><br><span class="line"><span class="string">Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"</span></span><br><span class="line"><span class="string">Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"</span></span><br><span class="line"><span class="string">Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"</span></span><br><span class="line"><span class="string">installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"</span></span><br><span class="line"><span class="string">Waiting for provider infrastructure-vsphere</span></span><br><span class="line"><span class="string">Waiting for provider control-plane-kubeadm</span></span><br><span class="line"><span class="string">Waiting for provider cluster-api</span></span><br><span class="line"><span class="string">Waiting for provider bootstrap-kubeadm</span></span><br><span class="line"><span class="string">Waiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and running</span></span><br><span class="line"><span class="string">pods are not yet running for deployment '</span>capi-kubeadm-control-plane-controller-manager<span class="string">' in namespace '</span>capi-kubeadm-control-plane-system<span class="string">', retrying</span></span><br><span class="line"><span class="string">Passed waiting on provider bootstrap-kubeadm after 25.205820854s</span></span><br><span class="line"><span class="string">pods are not yet running for deployment '</span>capi-controller-manager<span class="string">' in namespace '</span>capi-webhook-system<span class="string">', retrying</span></span><br><span class="line"><span class="string">Passed waiting on provider infrastructure-vsphere after 30.185406332s</span></span><br><span class="line"><span class="string">Passed waiting on provider cluster-api after 30.213216243s</span></span><br><span class="line"><span class="string">Success waiting on all providers.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Start creating management cluster...</span></span><br><span class="line"><span class="string">patch cluster object with operation status:</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"metadata": &#123;</span></span><br><span class="line"><span class="string">"annotations": &#123;</span></span><br><span class="line"><span class="string">"TKGOperationInfo" : "&#123;\"Operation\":\"Create\",\"OperationStartTimestamp\":\"2022-02-06 02:35:34.30219421 +0000 UTC\",\"OperationTimeout\":1800&#125;",</span></span><br><span class="line"><span class="string">"TKGOperationLastObservedTimestamp" : "2022-02-06 02:35:34.30219421 +0000 UTC"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">cluster control plane is still being initialized, retrying</span></span><br><span class="line"><span class="string">Getting secret for cluster</span></span><br><span class="line"><span class="string">Waiting for resource tanzu-control-plan-kubeconfig of type *v1.Secret to be up and running</span></span><br><span class="line"><span class="string">Saving management cluster kubeconfig into /root/.kube/config</span></span><br><span class="line"><span class="string">Installing providers on management cluster...</span></span><br><span class="line"><span class="string">Fetching providers</span></span><br><span class="line"><span class="string">Installing cert-manager Version="v1.1.0"</span></span><br><span class="line"><span class="string">Waiting for cert-manager to be available...</span></span><br><span class="line"><span class="string">Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"</span></span><br><span class="line"><span class="string">Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"</span></span><br><span class="line"><span class="string">Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"</span></span><br><span class="line"><span class="string">Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"</span></span><br><span class="line"><span class="string">installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"</span></span><br><span class="line"><span class="string">Waiting for provider control-plane-kubeadm</span></span><br><span class="line"><span class="string">Waiting for provider bootstrap-kubeadm</span></span><br><span class="line"><span class="string">Waiting for provider infrastructure-vsphere</span></span><br><span class="line"><span class="string">Waiting for provider cluster-api</span></span><br><span class="line"><span class="string">Waiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and running</span></span><br><span class="line"><span class="string">Passed waiting on provider control-plane-kubeadm after 10.046865402s</span></span><br><span class="line"><span class="string">Waiting for resource antrea-controller of type *v1.Deployment to be up and running</span></span><br><span class="line"><span class="string">Moving all Cluster API objects from bootstrap cluster to management cluster...</span></span><br><span class="line"><span class="string">Performing move...</span></span><br><span class="line"><span class="string">Discovering Cluster API objects</span></span><br><span class="line"><span class="string">Moving Cluster API objects Clusters=1</span></span><br><span class="line"><span class="string">Creating objects in the target cluster</span></span><br><span class="line"><span class="string">Deleting objects from the source cluster</span></span><br><span class="line"><span class="string">Waiting for additional components to be up and running...</span></span><br><span class="line"><span class="string">Waiting for packages to be up and running...</span></span><br><span class="line"><span class="string">Waiting for package: antrea</span></span><br><span class="line"><span class="string">Waiting for package: metrics-server</span></span><br><span class="line"><span class="string">Waiting for package: tanzu-addons-manager</span></span><br><span class="line"><span class="string">Waiting for package: vsphere-cpi</span></span><br><span class="line"><span class="string">Waiting for package: vsphere-csi</span></span><br><span class="line"><span class="string">Waiting for resource antrea of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource vsphere-cpi of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource vsphere-csi of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource metrics-server of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource tanzu-addons-manager of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Successfully reconciled package: antrea</span></span><br><span class="line"><span class="string">Successfully reconciled package: vsphere-csi</span></span><br><span class="line"><span class="string">Successfully reconciled package: metrics-server</span></span><br><span class="line"><span class="string">Context set for management cluster tanzu-control-plan as '</span>tanzu-control-plan-admin@tanzu-control-plan<span class="string">'.</span></span><br><span class="line"><span class="string">Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Management cluster created!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can now create your first workload cluster by running the following:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  tanzu cluster create [name] -f [file]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Some addons might be getting installed! Check their status by running the following:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  kubectl get apps -A</span></span><br></pre></td></tr></table></figure><ul><li>éƒ¨ç½²å®Œæˆä¹‹åï¼Œå°†ç®¡ç†é›†ç¾¤çš„ kubeconfig æ–‡ä»¶å¤åˆ¶åˆ° kubectl é»˜è®¤çš„ç›®å½•ä¸‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># cp $&#123;HOME&#125;/.kube-tkg/config $&#123;HOME&#125;/.kube/config</span></span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç®¡ç†é›†ç¾¤çš„ cluster èµ„æºä¿¡æ¯ï¼Œç®¡ç†é›†ç¾¤çš„ CR é»˜è®¤ä¿å­˜åœ¨äº† tkg-system namespace ä¸‹</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get cluster -A</span></span><br><span class="line">NAMESPACE    NAME                 PHASE</span><br><span class="line">tkg-system   tanzu-control-plan   Provisioned</span><br><span class="line"><span class="comment"># ç®¡ç†é›†ç¾¤çš„ machine èµ„æºä¿¡æ¯</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine -A</span></span><br><span class="line">NAMESPACE    NAME                                       PROVIDERID                                       PHASE         VERSION</span><br><span class="line">tkg-system   tanzu-control-plan-control-plane-gs4bl     vsphere://4239c450-f621-d78e-3c44-4ac8890c0cd3   Running       v1.21.2+vmware.1</span><br><span class="line">tkg-system   tanzu-control-plan-md-0-7cdc97c7c6-kxcnx   vsphere://4239d776-c04c-aacc-db12-3380542a6d03   Provisioned   v1.21.2+vmware.1</span><br><span class="line"><span class="comment"># è¿è¡Œçš„ç»„ä»¶çŠ¶æ€</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE                           NAME                                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">capi-kubeadm-bootstrap-system       capi-kubeadm-bootstrap-controller-manager-6494884869-wlzhx       2/2     Running   0          8m37s</span><br><span class="line">capi-kubeadm-control-plane-system   capi-kubeadm-control-plane-controller-manager-857d687b9d-tpznv   2/2     Running   0          8m35s</span><br><span class="line">capi-system                         capi-controller-manager-778bd4dfb9-tkvwg                         2/2     Running   0          8m41s</span><br><span class="line">capi-webhook-system                 capi-controller-manager-9995bdc94-svjm2                          2/2     Running   0          8m41s</span><br><span class="line">capi-webhook-system                 capi-kubeadm-bootstrap-controller-manager-68845b65f8-sllgv       2/2     Running   0          8m38s</span><br><span class="line">capi-webhook-system                 capi-kubeadm-control-plane-controller-manager-9847c6747-vvz6g    2/2     Running   0          8m35s</span><br><span class="line">capi-webhook-system                 capv-controller-manager-55bf67fbd5-4t46v                         2/2     Running   0          8m31s</span><br><span class="line">capv-system                         capv-controller-manager-587fbf697f-bbzs9                         2/2     Running   0          8m31s</span><br><span class="line">cert-manager                        cert-manager-77f6fb8fd5-8tq6n                                    1/1     Running   0          11m</span><br><span class="line">cert-manager                        cert-manager-cainjector-6bd4cff7bb-6vlzx                         1/1     Running   0          11m</span><br><span class="line">cert-manager                        cert-manager-webhook-fbfcb9d6c-qpkbc                             1/1     Running   0          11m</span><br><span class="line">kube-system                         antrea-agent-5m9d4                                               2/2     Running   0          6m</span><br><span class="line">kube-system                         antrea-agent-8mpr7                                               2/2     Running   0          5m40s</span><br><span class="line">kube-system                         antrea-controller-5bbcb98667-hklss                               1/1     Running   0          5m50s</span><br><span class="line">kube-system                         coredns-8dcb5c56b-ckvb7                                          1/1     Running   0          12m</span><br><span class="line">kube-system                         coredns-8dcb5c56b-d98hf                                          1/1     Running   0          12m</span><br><span class="line">kube-system                         etcd-tanzu-control-plan-control-plane-gs4bl                      1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-apiserver-tanzu-control-plan-control-plane-gs4bl            1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-controller-manager-tanzu-control-plan-control-plane-gs4bl   1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-proxy-d4wq4                                                 1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-proxy-nhkgg                                                 1/1     Running   0          11m</span><br><span class="line">kube-system                         kube-scheduler-tanzu-control-plan-control-plane-gs4bl            1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-vip-tanzu-control-plan-control-plane-gs4bl                  1/1     Running   0          12m</span><br><span class="line">kube-system                         metrics-server-59fcb9fcf-xjznj                                   1/1     Running   0          6m29s</span><br><span class="line">kube-system                         vsphere-cloud-controller-manager-kzffm                           1/1     Running   0          5m50s</span><br><span class="line">kube-system                         vsphere-csi-controller-74675c9488-q9h5c                          6/6     Running   0          6m31s</span><br><span class="line">kube-system                         vsphere-csi-node-dmvvr                                           3/3     Running   0          6m31s</span><br><span class="line">kube-system                         vsphere-csi-node-k6x98                                           3/3     Running   0          6m31s</span><br><span class="line">tkg-system                          kapp-controller-6499b8866-xnql7                                  1/1     Running   0          10m</span><br><span class="line">tkg-system                          tanzu-addons-controller-manager-657c587556-rpbjm                 1/1     Running   0          7m58s</span><br><span class="line">tkg-system                          tanzu-capabilities-controller-manager-6ff97656b8-cq7m7           1/1     Running   0          11m</span><br><span class="line">tkr-system                          tkr-controller-manager-6bc455b5d4-wm98s                          1/1     Running   0          10m</span><br></pre></td></tr></table></figure><h3 id="éƒ¨ç½²æµç¨‹-1"><a href="#éƒ¨ç½²æµç¨‹-1" class="headerlink" title="éƒ¨ç½²æµç¨‹"></a>éƒ¨ç½²æµç¨‹</h3><p>ç»“åˆ <a href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go" target="_blank" rel="noopener">tanzu çš„æºç </a> å’Œéƒ¨ç½²è¾“å‡ºçš„æ—¥å¿—æˆ‘ä»¬å¤§ä½“å¯ä»¥å¾—çŸ¥ï¼Œtanzu ç®¡ç†é›†ç¾¤éƒ¨ç½²å¤§è‡´åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// management cluster init step constants</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">StepConfigPrerequisite                 = <span class="string">"Configure prerequisite"</span></span><br><span class="line">StepValidateConfiguration              = <span class="string">"Validate configuration"</span></span><br><span class="line">StepGenerateClusterConfiguration       = <span class="string">"Generate cluster configuration"</span></span><br><span class="line">StepSetupBootstrapCluster              = <span class="string">"Setup bootstrap cluster"</span></span><br><span class="line">StepInstallProvidersOnBootstrapCluster = <span class="string">"Install providers on bootstrap cluster"</span></span><br><span class="line">StepCreateManagementCluster            = <span class="string">"Create management cluster"</span></span><br><span class="line">StepInstallProvidersOnRegionalCluster  = <span class="string">"Install providers on management cluster"</span></span><br><span class="line">StepMoveClusterAPIObjects              = <span class="string">"Move cluster-api objects from bootstrap cluster to management cluster"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// InitRegionSteps management cluster init step sequence</span></span><br><span class="line"><span class="keyword">var</span> InitRegionSteps = []<span class="keyword">string</span>&#123;</span><br><span class="line">StepConfigPrerequisite,</span><br><span class="line">StepValidateConfiguration,</span><br><span class="line">StepGenerateClusterConfiguration,</span><br><span class="line">StepSetupBootstrapCluster,</span><br><span class="line">StepInstallProvidersOnBootstrapCluster,</span><br><span class="line">StepCreateManagementCluster,</span><br><span class="line">StepInstallProvidersOnRegionalCluster,</span><br><span class="line">StepMoveClusterAPIObjects,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ConfigPrerequisite å‡†å¤‡é˜¶æ®µï¼Œä¼šä¸‹è½½ <code>tkg-compatibility</code> å’Œ <code>tkg-bom</code> é•œåƒï¼Œç”¨äºæ£€æŸ¥ç¯å¢ƒçš„å…¼å®¹æ€§ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Downloading TKG compatibility file from <span class="string">'projects.registry.vmware.com/tkg/framework-zshippable/tkg-compatibility'</span></span><br><span class="line">Downloading the TKG Bill of Materials (BOM) file from <span class="string">'projects.registry.vmware.com/tkg/tkg-bom:v1.4.0'</span></span><br><span class="line">Downloading the TKr Bill of Materials (BOM) file from <span class="string">'projects.registry.vmware.com/tkg/tkr-bom:v1.21.2_vmware.1-tkg.1'</span></span><br><span class="line">ERROR 2022/02/06 02:24:46 svType != tvType; key=release, st=map[string]interface &#123;&#125;, tt=&lt;nil&gt;, sv=map[version:], tv=&lt;nil&gt;</span><br><span class="line">CEIP Opt-in status: <span class="literal">false</span></span><br></pre></td></tr></table></figure><ul><li>ValidateConfiguration é…ç½®æ–‡ä»¶æ ¡éªŒï¼Œæ ¹æ®å¡«å†™çš„å‚æ•°æ ¡éªŒé…ç½®æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠæ£€æŸ¥ vCenter å½“ä¸­æœ‰æ— åŒ¹é…çš„è™šæ‹Ÿæœºæ¨¡ç‰ˆï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Validating the pre-requisites...</span><br><span class="line"></span><br><span class="line">vSphere 7.0 Environment Detected.</span><br><span class="line"></span><br><span class="line">You have connected to a vSphere 7.0 environment <span class="built_in">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includes</span><br><span class="line">an integrated Tanzu Kubernetes Grid Service <span class="built_in">which</span> turns a vSphere cluster into a platform <span class="keyword">for</span> running Kubernetes workloads <span class="keyword">in</span> dedicated</span><br><span class="line">resource pools. Configuring Tanzu Kubernetes Grid Service is <span class="keyword">done</span> through vSphere HTML5 client.</span><br><span class="line"></span><br><span class="line">Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="keyword">in</span> vSphere 7.0 environments. Alternatively you may</span><br><span class="line">deploy a non-integrated Tanzu Kubernetes Grid instance on vSphere 7.0.</span><br><span class="line">Deploying TKG management cluster on vSphere 7.0 ...</span><br><span class="line">Identity Provider not configured. Some authentication features won<span class="string">'t work.</span></span><br><span class="line"><span class="string">Checking if VSPHERE_CONTROL_PLANE_ENDPOINT 192.168.20.94 is already in use</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Setting up management cluster...</span></span><br><span class="line"><span class="string">Validating configuration...</span></span><br><span class="line"><span class="string">Using infrastructure provider vsphere:v0.7.10</span></span><br></pre></td></tr></table></figure><ul><li>GenerateClusterConfiguration ç”Ÿæˆé›†ç¾¤é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Generating cluster configuration...</span><br></pre></td></tr></table></figure><ul><li>SetupBootstrapCluster è®¾ç½® bootstrap é›†ç¾¤ï¼Œç›®å‰é»˜è®¤ä¸º kindã€‚ä¼šè¿è¡Œä¸€ä¸ª docker å®¹å™¨ï¼Œé‡Œé¢å¥—å¨ƒè¿è¡Œç€ä¸€ä¸ª k8s é›†ç¾¤ï¼›è¿™ä¸ª bootstrap k8s é›†ç¾¤åªæ˜¯ä¸´æ—¶è¿è¡Œ cluster-api æ¥éƒ¨ç½²ç®¡ç†é›†ç¾¤ç”¨çš„ï¼Œéƒ¨ç½²å®Œæˆä¹‹å bootstrap é›†ç¾¤ä¹Ÿå°±æ²¡ç”¨äº†ï¼Œä¼šè‡ªåŠ¨åˆ æ‰ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Setting up bootstrapper...</span><br><span class="line">Fetching configuration <span class="keyword">for</span> kind node image...</span><br><span class="line">kindConfig:</span><br><span class="line"> &amp;&#123;&#123;Cluster kind.x-k8s.io/v1alpha4&#125;  [&#123;  map[] [&#123;/var/run/docker.sock /var/run/docker.sock <span class="literal">false</span> <span class="literal">false</span> &#125;] [] [] []&#125;] &#123; 0  100.96.0.0/11 100.64.0.0/13 <span class="literal">false</span> &#125; map[] map[] [apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">imageRepository: projects.registry.vmware.com/tkg</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    imageRepository: projects.registry.vmware.com/tkg</span><br><span class="line">    imageTag: v3.4.13_vmware.15</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">  imageRepository: projects.registry.vmware.com/tkg</span><br><span class="line">  imageTag: v1.8.0_vmware.5] [] [] []&#125;</span><br><span class="line">Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span><br><span class="line">Creating cluster <span class="string">"tkg-kind-c7vj6kds0a6sf43e6210"</span> ...</span><br><span class="line">Ensuring node image (projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1) ...</span><br><span class="line">Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 ...</span><br><span class="line">Preparing nodes ...</span><br><span class="line">Writing configuration ...</span><br><span class="line">Starting control-plane ...</span><br><span class="line">Installing CNI ...</span><br><span class="line">Installing StorageClass ...</span><br><span class="line">Waiting 2m0s <span class="keyword">for</span> control-plane = Ready ...</span><br><span class="line">Ready after 19s</span><br><span class="line">Bootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOL</span><br></pre></td></tr></table></figure><ul><li>InstallProvidersOnBootstrapCluster åœ¨ bootstrap é›†ç¾¤ä¸Šå®‰è£… cluste-api ç›¸å…³ç»„ä»¶ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Installing providers on bootstrapper...</span><br><span class="line">Fetching providers</span><br><span class="line"><span class="comment"># å®‰è£… cert-manager ä¸»è¦æ˜¯ä¸ºäº†ç”Ÿæˆ k8s é›†ç¾¤éƒ¨ç½²æ‰€ä¾èµ–çš„é‚£ä¸€å †è¯ä¹¦</span></span><br><span class="line">Installing cert-manager Version=<span class="string">"v1.1.0"</span></span><br><span class="line">Waiting <span class="keyword">for</span> cert-manager to be available...</span><br><span class="line">Installing Provider=<span class="string">"cluster-api"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-system"</span></span><br><span class="line">Installing Provider=<span class="string">"bootstrap-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-bootstrap-system"</span></span><br><span class="line">Installing Provider=<span class="string">"control-plane-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-control-plane-system"</span></span><br><span class="line">Installing Provider=<span class="string">"infrastructure-vsphere"</span> Version=<span class="string">"v0.7.10"</span> TargetNamespace=<span class="string">"capv-system"</span></span><br><span class="line">installed  Component==<span class="string">"cluster-api"</span>  Type==<span class="string">"CoreProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"BootstrapProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"ControlPlaneProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"vsphere"</span>  Type==<span class="string">"InfrastructureProvider"</span>  Version==<span class="string">"v0.7.10"</span></span><br><span class="line">Waiting <span class="keyword">for</span> provider infrastructure-vsphere</span><br><span class="line">Waiting <span class="keyword">for</span> provider control-plane-kubeadm</span><br><span class="line">Waiting <span class="keyword">for</span> provider cluster-api</span><br><span class="line">Waiting <span class="keyword">for</span> provider bootstrap-kubeadm</span><br><span class="line">Passed waiting on provider infrastructure-vsphere after 30.185406332s</span><br><span class="line">Passed waiting on provider cluster-api after 30.213216243s</span><br><span class="line">Success waiting on all providers.</span><br></pre></td></tr></table></figure><ul><li>CreateManagementCluster åˆ›å»ºç®¡ç†é›†ç¾¤ï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯åˆ›å»ºè™šæ‹Ÿæœºã€åˆå§‹åŒ–èŠ‚ç‚¹ã€è¿è¡Œ kubeadm éƒ¨ç½² k8s é›†ç¾¤ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Start creating management cluster...</span><br><span class="line">patch cluster object with operation status:</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"metadata"</span>: &#123;</span><br><span class="line"><span class="string">"annotations"</span>: &#123;</span><br><span class="line"><span class="string">"TKGOperationInfo"</span> : <span class="string">"&#123;\"Operation\":\"Create\",\"OperationStartTimestamp\":\"2022-02-06 02:35:34.30219421 +0000 UTC\",\"OperationTimeout\":1800&#125;"</span>,</span><br><span class="line"><span class="string">"TKGOperationLastObservedTimestamp"</span> : <span class="string">"2022-02-06 02:35:34.30219421 +0000 UTC"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">cluster control plane is still being initialized, retrying</span><br><span class="line">Getting secret <span class="keyword">for</span> cluster</span><br><span class="line">Waiting <span class="keyword">for</span> resource tanzu-control-plan-kubeconfig of <span class="built_in">type</span> *v1.Secret to be up and running</span><br><span class="line">Saving management cluster kubeconfig into /root/.kube/config</span><br></pre></td></tr></table></figure><ul><li>InstallProvidersOnRegionalCluster åœ¨ç®¡ç†é›†ç¾¤ä¸Šå®‰è£… cluster-api ç›¸å…³ç»„ä»¶ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Installing providers on management cluster...</span><br><span class="line">Fetching providers</span><br><span class="line">Installing cert-manager Version=<span class="string">"v1.1.0"</span></span><br><span class="line">Waiting <span class="keyword">for</span> cert-manager to be available...</span><br><span class="line">Installing Provider=<span class="string">"cluster-api"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-system"</span></span><br><span class="line">Installing Provider=<span class="string">"bootstrap-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-bootstrap-system"</span></span><br><span class="line">Installing Provider=<span class="string">"control-plane-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-control-plane-system"</span></span><br><span class="line">Installing Provider=<span class="string">"infrastructure-vsphere"</span> Version=<span class="string">"v0.7.10"</span> TargetNamespace=<span class="string">"capv-system"</span></span><br><span class="line">installed  Component==<span class="string">"cluster-api"</span>  Type==<span class="string">"CoreProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"BootstrapProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"ControlPlaneProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"vsphere"</span>  Type==<span class="string">"InfrastructureProvider"</span>  Version==<span class="string">"v0.7.10"</span></span><br><span class="line">Waiting <span class="keyword">for</span> provider control-plane-kubeadm</span><br><span class="line">Waiting <span class="keyword">for</span> provider bootstrap-kubeadm</span><br><span class="line">Waiting <span class="keyword">for</span> provider infrastructure-vsphere</span><br><span class="line">Waiting <span class="keyword">for</span> provider cluster-api</span><br><span class="line">Waiting <span class="keyword">for</span> resource capv-controller-manager of <span class="built_in">type</span> *v1.Deployment to be up and running</span><br><span class="line">Passed waiting on provider infrastructure-vsphere after 20.091935635s</span><br><span class="line">Passed waiting on provider cluster-api after 20.109419304s</span><br><span class="line">Success waiting on all providers.</span><br><span class="line">Waiting <span class="keyword">for</span> the management cluster to get ready <span class="keyword">for</span> move...</span><br><span class="line">Waiting <span class="keyword">for</span> resource tanzu-control-plan of <span class="built_in">type</span> *v1alpha3.Cluster to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> resources <span class="built_in">type</span> *v1alpha3.MachineDeploymentList to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> resources <span class="built_in">type</span> *v1alpha3.MachineList to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> addons installation...</span><br><span class="line">Waiting <span class="keyword">for</span> resources <span class="built_in">type</span> *v1alpha3.ClusterResourceSetList to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> resource antrea-controller of <span class="built_in">type</span> *v1.Deployment to be up and running</span><br></pre></td></tr></table></figure><ul><li>MoveClusterAPIObjects å°† bootstrap é›†ç¾¤ä¸Š cluster-api ç›¸å…³çš„èµ„æºè½¬ç§»åˆ°ç®¡ç†é›†ç¾¤ä¸Šã€‚è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯ä¸ºäº†è¾¾åˆ° self-hosted è‡ªæ‰˜ç®¡çš„åŠŸèƒ½ï¼šå³ç®¡ç†é›†ç¾¤è‡ªèº«çš„æ‰©ç¼©å®¹ä¹Ÿæ˜¯é€šè¿‡ cluster-api æ¥å®Œæˆï¼Œè¿™æ ·å°±ä¸ç”¨å†ä¾èµ–å…ˆå‰çš„é‚£ä¸ª bootstrap é›†ç¾¤äº†ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Moving all Cluster API objects from bootstrap cluster to management cluster...</span><br><span class="line">Performing move...</span><br><span class="line">Discovering Cluster API objects</span><br><span class="line">Moving Cluster API objects Clusters=1</span><br><span class="line">Creating objects <span class="keyword">in</span> the target cluster</span><br><span class="line">Deleting objects from the <span class="built_in">source</span> cluster</span><br><span class="line">Context <span class="built_in">set</span> <span class="keyword">for</span> management cluster tanzu-control-plan as <span class="string">'tanzu-control-plan-admin@tanzu-control-plan'</span>.</span><br><span class="line">Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span><br><span class="line"></span><br><span class="line">Management cluster created!</span><br><span class="line"></span><br><span class="line">You can now create your first workload cluster by running the following:</span><br><span class="line"></span><br><span class="line">  tanzu cluster create [name] -f [file]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Some addons might be getting installed! Check their status by running the following:</span><br><span class="line"></span><br><span class="line">  kubectl get apps -A</span><br></pre></td></tr></table></figure><p>éƒ¨ç½²å®Œæˆåä¼šåˆ é™¤ bootstrap é›†ç¾¤ï¼Œå› ä¸º bootstrap é›†ç¾¤ä¸­çš„èµ„æºå·²ç»è½¬ç§»åˆ°äº†ç®¡ç†é›†ç¾¤ä¸­ï¼Œå®ƒç»§ç»­å­˜åœ¨çš„æ„ä¹‰ä¸å¤§ã€‚</p><h2 id="éƒ¨ç½²-workload-é›†ç¾¤"><a href="#éƒ¨ç½²-workload-é›†ç¾¤" class="headerlink" title="éƒ¨ç½² workload é›†ç¾¤"></a>éƒ¨ç½² workload é›†ç¾¤</h2><p>ä¸Šé¢æˆ‘ä»¬åªæ˜¯éƒ¨ç½²å¥½äº†ä¸€ä¸ª tanzu ç®¡ç†é›†ç¾¤ï¼Œæˆ‘ä»¬çœŸæ­£çš„å·¥ä½œè´Ÿè½½å¹¶ä¸é€‚åˆè¿è¡Œåœ¨è¿™ä¸ªé›†ç¾¤ä¸Šï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å†éƒ¨ç½²ä¸€ä¸ª workload é›†ç¾¤ï¼Œç±»ä¼¼äº k8s é›†ç¾¤ä¸­çš„ worker èŠ‚ç‚¹ã€‚éƒ¨ç½² workload é›†ç¾¤çš„æ—¶å€™ä¸å†ä¾èµ– bootstrap é›†ç¾¤ï¼Œè€Œæ˜¯ä½¿ç”¨ç®¡ç†é›†ç¾¤ã€‚</p><p>æ ¹æ®å®˜æ–¹æ–‡æ¡£ <a href="https://tanzucommunityedition.io/docs/latest/vsphere-wl-template/" target="_blank" rel="noopener">vSphere Workload Cluster Template</a> ä¸­ç»™å‡ºçš„æ¨¡ç‰ˆåˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç„¶åå†é€šè¿‡ tanzu å‘½ä»¤æ¥éƒ¨ç½²å³å¯ã€‚é…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cluster Pod IP çš„ CIDR</span></span><br><span class="line"><span class="attr">CLUSTER_CIDR:</span> <span class="number">100.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/11</span></span><br><span class="line"><span class="comment"># Service çš„ CIDR</span></span><br><span class="line"><span class="attr">SERVICE_CIDR:</span> <span class="number">100.64</span><span class="number">.0</span><span class="number">.0</span><span class="string">/13</span></span><br><span class="line"><span class="comment"># é›†ç¾¤çš„åç§°</span></span><br><span class="line"><span class="attr">CLUSTER_NAME:</span> <span class="string">tanzu-workload-cluster</span></span><br><span class="line"><span class="comment"># é›†ç¾¤çš„ç±»å‹</span></span><br><span class="line"><span class="attr">CLUSTER_PLAN:</span> <span class="string">dev</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹çš„ arch</span></span><br><span class="line"><span class="attr">OS_ARCH:</span> <span class="string">amd64</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹çš„ OS åç§°</span></span><br><span class="line"><span class="attr">OS_NAME:</span> <span class="string">photon</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹ OS ç‰ˆæœ¬</span></span><br><span class="line"><span class="attr">OS_VERSION:</span> <span class="string">"3"</span></span><br><span class="line"><span class="comment"># åŸºç¡€è®¾æ–½èµ„æºçš„æä¾›æ–¹</span></span><br><span class="line"><span class="attr">INFRASTRUCTURE_PROVIDER:</span> <span class="string">vsphere</span></span><br><span class="line"><span class="comment"># cluster, machine ç­‰è‡ªå®šä¹‰èµ„æºåˆ›å»ºçš„ namespace</span></span><br><span class="line"><span class="attr">NAMESPACE:</span> <span class="string">default</span></span><br><span class="line"><span class="comment"># CNI é€‰ç”¨ç±»å‹ï¼Œç›®å‰åº”è¯¥åªæ”¯æŒ VMware è‡ªå®¶çš„ antrea</span></span><br><span class="line"><span class="attr">CNI:</span> <span class="string">antrea</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤çš„ VIP</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_ENDPOINT:</span> <span class="number">192.168</span><span class="number">.20</span><span class="number">.95</span></span><br><span class="line"><span class="comment"># control-plan èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># control-plan èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_MEM_MIB:</span> <span class="string">"8192"</span></span><br><span class="line"><span class="comment"># control-plan èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_NUM_CPUS:</span> <span class="string">"4"</span></span><br><span class="line"><span class="comment"># work èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># work èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_MEM_MIB:</span> <span class="string">"4096"</span></span><br><span class="line"><span class="comment"># work èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_NUM_CPUS:</span> <span class="string">"2"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter çš„ Datacenter è·¯å¾„</span></span><br><span class="line"><span class="attr">VSPHERE_DATACENTER:</span> <span class="string">/SH-IDC</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„ Datastore è·¯å¾„</span></span><br><span class="line"><span class="attr">VSPHERE_DATASTORE:</span> <span class="string">/SH-IDC/datastore/datastore1</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="attr">VSPHERE_FOLDER:</span> <span class="string">/SH-IDC/vm/Tanzu-node</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œ</span></span><br><span class="line"><span class="attr">VSPHERE_NETWORK:</span> <span class="string">/SH-IDC/network/VM</span> <span class="string">Network</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºå…³è”çš„èµ„æºæ± </span></span><br><span class="line"><span class="attr">VSPHERE_RESOURCE_POOL:</span> <span class="string">/SH-IDC/host/Tanzu-Cluster/Resources</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter çš„ IP</span></span><br><span class="line"><span class="attr">VSPHERE_SERVER:</span> <span class="number">192.168</span><span class="number">.20</span><span class="number">.92</span></span><br><span class="line"><span class="comment"># vCenter çš„ç”¨æˆ·å</span></span><br><span class="line"><span class="attr">VSPHERE_USERNAME:</span> <span class="string">administrator@vsphere.local</span></span><br><span class="line"><span class="comment"># vCenter çš„å¯†ç ï¼Œä»¥ base64 ç¼–ç </span></span><br><span class="line"><span class="attr">VSPHERE_PASSWORD:</span> <span class="string">&lt;encoded:YWRtaW5AMjAyMA==&gt;</span></span><br><span class="line"><span class="comment"># vCenter çš„è¯ä¹¦æŒ‡çº¹ï¼Œå¯ä»¥é€šè¿‡ govc about.cert -json | jq -r '.ThumbprintSHA1' è·å–</span></span><br><span class="line"><span class="attr">VSPHERE_TLS_THUMBPRINT:</span> <span class="string">CB:23:48:E8:93:34:AD:27:D8:FD:88:1C:D7:08:4B:47:9B:12:F4:E0</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºæ³¨å…¥çš„ ssh å…¬é’¥ï¼Œéœ€è¦ç”¨å®ƒæ¥ ssh ç™»å½•é›†ç¾¤èŠ‚ç‚¹</span></span><br><span class="line"><span class="attr">VSPHERE_SSH_AUTHORIZED_KEY:</span> <span class="string">ssh-rsa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€äº›é»˜è®¤å‚æ•°</span></span><br><span class="line"><span class="attr">AVI_ENABLE:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">IDENTITY_MANAGEMENT_TYPE:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">ENABLE_AUDIT_LOGGING:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">ENABLE_CEIP_PARTICIPATION:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">TKG_HTTP_PROXY_ENABLED:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">DEPLOY_TKG_ON_VSPHERE7:</span> <span class="string">"true"</span></span><br><span class="line"><span class="comment"># æ˜¯å¦å¼€å¯è™šæ‹Ÿæœºå¥åº·æ£€æŸ¥</span></span><br><span class="line"><span class="attr">ENABLE_MHC:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">MHC_UNKNOWN_STATUS_TIMEOUT:</span> <span class="string">5m</span></span><br><span class="line"><span class="attr">MHC_FALSE_STATUS_TIMEOUT:</span> <span class="string">12m</span></span><br><span class="line"><span class="comment"># æ˜¯å¦éƒ¨ç½² vsphere cis ç»„ä»¶</span></span><br><span class="line"><span class="attr">ENABLE_DEFAULT_STORAGE_CLASS:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># æ˜¯å¦å¼€å¯é›†ç¾¤è‡ªåŠ¨æ‰©ç¼©å®¹</span></span><br><span class="line"><span class="attr">ENABLE_AUTOSCALER:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ tanzu å‘½ä»¤æ¥éƒ¨ç½² workload é›†ç¾¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># tanzu cluster create tanzu-workload-cluster --file tanzu-workload-cluster.yaml</span></span><br><span class="line">Validating configuration...</span><br><span class="line">Warning: Pinniped configuration not found. Skipping pinniped configuration <span class="keyword">in</span> workload cluster. Please refer to the documentation to check <span class="keyword">if</span> you can configure pinniped on workload cluster manually</span><br><span class="line">Creating workload cluster <span class="string">'tanzu-workload-cluster'</span>...</span><br><span class="line">Waiting <span class="keyword">for</span> cluster to be initialized...</span><br><span class="line">Waiting <span class="keyword">for</span> cluster nodes to be available...</span><br><span class="line">Waiting <span class="keyword">for</span> cluster autoscaler to be available...</span><br><span class="line">Unable to <span class="built_in">wait</span> <span class="keyword">for</span> autoscaler deployment to be ready. reason: deployments.apps <span class="string">"tanzu-workload-cluster-cluster-autoscaler"</span> not found</span><br><span class="line">Waiting <span class="keyword">for</span> addons installation...</span><br><span class="line">Waiting <span class="keyword">for</span> packages to be up and running...</span><br><span class="line">Workload cluster <span class="string">'tanzu-workload-cluster'</span> created</span><br></pre></td></tr></table></figure><ul><li>éƒ¨ç½²å®Œæˆä¹‹åæŸ¥çœ‹ä¸€ä¸‹é›†ç¾¤çš„ CR ä¿¡æ¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get cluster</span></span><br><span class="line">NAME                     PHASE</span><br><span class="line">tanzu-workload-cluster   Provisioned</span><br><span class="line"><span class="comment"># machine çŠ¶æ€å¤„äº Running è¯´æ˜èŠ‚ç‚¹å·²ç»æ­£å¸¸è¿è¡Œäº†</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine</span></span><br><span class="line">NAME                                          PROVIDERID                                       PHASE     VERSION</span><br><span class="line">tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1</span><br></pre></td></tr></table></figure><h2 id="æ‰©å®¹é›†ç¾¤"><a href="#æ‰©å®¹é›†ç¾¤" class="headerlink" title="æ‰©å®¹é›†ç¾¤"></a>æ‰©å®¹é›†ç¾¤</h2><p>é›†ç¾¤éƒ¨ç½²å¥½ä¹‹åï¼Œå¦‚æœæƒ³å¯¹é›†ç¾¤èŠ‚ç‚¹è¿›è¡Œæ‰©ç¼©å®¹ï¼Œæˆ‘ä»¬å¯ä»¥åƒ deployment çš„ä¸€æ ·ï¼Œåªéœ€è¦ä¿®æ”¹ä¸€äº› CR çš„ä¿¡æ¯å³å¯ã€‚cluster-api ç›¸å…³ç»„ä»¶ä¼š watch åˆ°è¿™äº› CR çš„å˜åŒ–ï¼Œå¹¶æ ¹æ®å®ƒçš„ spec ä¿¡æ¯è¿›è¡Œä¸€ç³»åˆ—è°ƒè°æ“ä½œã€‚å¦‚æœå½“å‰é›†ç¾¤èŠ‚ç‚¹æ•°é‡ä½äºæ‰€å®šä¹‰çš„èŠ‚ç‚¹å‰¯æœ¬æ•°é‡ï¼Œåˆ™ä¼šè‡ªåŠ¨è°ƒç”¨å¯¹åº”çš„ Provider åˆ›å»ºè™šæ‹Ÿæœºï¼Œå¹¶å¯¹è™šæ‹Ÿæœºè¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œå°†å®ƒè½¬æ¢ä¸º k8s é‡Œçš„ä¸€ä¸ª node èµ„æºï¼›</p><h3 id="æ‰©å®¹-control-plan-èŠ‚ç‚¹"><a href="#æ‰©å®¹-control-plan-èŠ‚ç‚¹" class="headerlink" title="æ‰©å®¹ control-plan èŠ‚ç‚¹"></a>æ‰©å®¹ control-plan èŠ‚ç‚¹</h3><p>å³æ‰©å®¹ master èŠ‚ç‚¹ï¼Œé€šè¿‡ä¿®æ”¹ <code>KubeadmControlPlane</code> è¿™ä¸ª CR ä¸­çš„ <code>replicas</code> å‰¯æœ¬æ•°å³å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl scale kcp tanzu-workload-cluster-control-plane --replicas=3</span></span><br><span class="line"><span class="comment"># å¯ä»¥çœ‹åˆ° machine å·²ç»å¤„äº Provisioning çŠ¶æ€ï¼Œè¯´æ˜é›†ç¾¤èŠ‚ç‚¹å¯¹åº”çš„è™šæ‹Ÿæœºæ­£åœ¨åˆ›å»ºä¸­</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine</span></span><br><span class="line">NAME                                          PROVIDERID                                       PHASE          VERSION</span><br><span class="line">tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running        v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-control-plane-mkmd2                                                     Provisioning   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running        v1.21.2+vmware.1</span><br></pre></td></tr></table></figure><h3 id="æ‰©å®¹-work-èŠ‚ç‚¹"><a href="#æ‰©å®¹-work-èŠ‚ç‚¹" class="headerlink" title="æ‰©å®¹ work èŠ‚ç‚¹"></a>æ‰©å®¹ work èŠ‚ç‚¹</h3><p>æ‰©å®¹ worker èŠ‚ç‚¹ï¼Œé€šè¿‡ä¿®æ”¹ <code>MachineDeployment</code> è¿™ä¸ª CR ä¸­çš„ <code>replicas</code> å‰¯æœ¬æ•°å³å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl scale md tanzu-workload-cluster-md-0 --replicas=3</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine</span></span><br><span class="line">NAME                                          PROVIDERID                                       PHASE     VERSION</span><br><span class="line">tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-control-plane-mkmd2    vsphere://4239278c-0503-f03a-08b8-df92286bcdd7   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-control-plane-rt5mb    vsphere://4239c882-2fe5-a394-60c0-616941a6363e   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-4hlqk   vsphere://42395deb-e706-8b4b-a44f-c755c222575c   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-ftmlp   vsphere://42399640-8e94-85e5-c4bd-8436d84966e0   Running   v1.21.2+vmware.1</span><br></pre></td></tr></table></figure><h2 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h2><p>æœ¬æ–‡åªæ˜¯ä»‹ç»äº† tanzu é›†ç¾¤éƒ¨ç½²çš„å¤§ä½“æµç¨‹ï¼Œé‡Œé¢åŒ…å«äº† cluster-api ç›¸å…³çš„æ¦‚å¿µåœ¨æœ¬æ–‡å¹¶æ²¡æœ‰åšæ·±å…¥çš„åˆ†æï¼Œå› ä¸ºå®åœ¨æ˜¯å¤ªå¤æ‚äº† ğŸ˜‚ï¼Œåˆ°ç°åœ¨æˆ‘è¿˜æ˜¯æ²¡å¤ªç†è§£å…¶ä¸­çš„ä¸€äº›åŸç†ï¼Œå› æ­¤åç»­æˆ‘å†å•ç‹¬å†™ä¸€ç¯‡åšå®¢æ¥è®²è§£ä¸€äº› cluster-api ç›¸å…³çš„å†…å®¹ï¼Œåˆ°é‚£æ—¶å€™åœ¨ç»“åˆæœ¬æ–‡æ¥çœ‹å°±å®¹æ˜“ç†è§£å¾ˆå¤šã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://github.com/vmware-tanzu/community-edition" target="_blank" rel="noopener">community-edition</a></li><li><a href="https://github.com/vmware/photon" target="_blank" rel="noopener">vmware/photon</a></li><li><a href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go" target="_blank" rel="noopener">tanzu-framework</a></li><li><a href="https://github.com/kubernetes-sigs/cluster-api-provider-vsphere" target="_blank" rel="noopener">cluster-api-provider-vsphere</a></li><li><a href="https://tanzucommunityedition.io/docs/latest/workload-clusters/" target="_blank" rel="noopener">Deploying a workload cluster</a></li><li><a href="https://tanzucommunityedition.io/docs/latest/verify-deployment/" target="_blank" rel="noopener">Examine the Management Cluster Deployment</a></li><li><a href="https://tanzucommunityedition.io/docs/latest/vsphere/" target="_blank" rel="noopener">Prepare to Deploy a Management or Standalone Clusters to vSphere</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ä¹‹å‰æ¥è§¦çš„ Kubernetes
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="ESXi" scheme="https://blog.k8s.li/tags/ESXi/"/>
    
      <category term="Tanzu" scheme="https://blog.k8s.li/tags/Tanzu/"/>
    
      <category term="Kubernetes" scheme="https://blog.k8s.li/tags/Kubernetes/"/>
    
      <category term="Cluster-api" scheme="https://blog.k8s.li/tags/Cluster-api/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ overlay2 æˆ– bind é‡æ–°æ„å»º ISO é•œåƒ</title>
    <link href="https://blog.k8s.li/rebuild-iso-image.html"/>
    <id>https://blog.k8s.li/rebuild-iso-image.html</id>
    <published>2022-01-24T16:00:00.000Z</published>
    <updated>2022-01-25T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç¬”è€…ä¹‹å‰åœ¨å­—èŠ‚è·³åŠ¨çš„æ—¶å€™æ˜¯è´Ÿè´£ PaaS å®¹å™¨äº‘å¹³å°çš„ç§æœ‰åŒ–éƒ¨ç½²ç›¸å…³çš„å·¥ä½œï¼Œæ‰€ä»¥ç»å¸¸ä¼šå’Œä¸€äº›å®¹å™¨é•œåƒæ‰“äº¤é“ï¼Œå¯¹å®¹å™¨é•œåƒä¹Ÿæœ‰ä¸€äº›ç ”ç©¶ï¼Œä¹‹å‰è¿˜å†™è¿‡ä¸å°‘åšå®¢æ–‡ç« ã€‚æ¯”å¦‚ <a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿ ğŸ¤”</a>ã€<a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 åœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­çš„åº”ç”¨</a> ç­‰ç­‰ã€‚</p><p>è‡ªä»æ¢äº†æ–°å·¥ä½œä¹‹åï¼Œåˆ™å¼€å§‹è´Ÿè´£ <a href="https://www.smartx.com/smartx-hci/" target="_blank" rel="noopener">è¶…èåˆäº§å“</a> é›†ç¾¤éƒ¨ç½²ç›¸å…³å·¥ä½œï¼Œå› æ­¤ä¹Ÿä¼šæ¥è§¦å¾ˆå¤š <code>é•œåƒ</code>ï¼Œä¸è¿‡è¿™ä¸ªé•œåƒæ˜¯æ“ä½œç³»ç»Ÿçš„ ISO é•œåƒè€Œä¸æ˜¯å®¹å™¨é•œåƒ ğŸ˜‚ã€‚è™½ç„¶ä¸¤è€…éƒ½ç»Ÿç§°ä¸ºé•œåƒï¼Œä½†ä¸¤è€…æœ‰ç€æœ¬è´¨çš„åŒºåˆ«ã€‚</p><p>é¦–å…ˆä¸¤è€…æ„å»ºçš„æ–¹å¼æœ‰æœ¬è´¨çš„å¾ˆå¤§çš„åŒºåˆ«ï¼ŒISO é•œåƒä¸€èˆ¬ä½¿ç”¨ <code>mkisofs</code> æˆ–è€… <code>genisoimage</code> ç­‰å‘½ä»¤å°†ä¸€ä¸ªåŒ…å«æ“ä½œç³»ç»Ÿå®‰è£…æ‰€æœ‰æ–‡ä»¶ç›®å½•æ„å»ºä¸ºä¸€ä¸ª ISO é•œåƒï¼›è€Œå®¹å™¨é•œåƒæ„å»ºåˆ™æ˜¯æ ¹æ® <code>Dockerfile</code> æ–‡ä»¶ä½¿ç”¨ç›¸åº”çš„å®¹å™¨é•œåƒæ„å»ºå·¥å…·æ¥ä¸€å±‚ä¸€å±‚æ„å»ºï¼›</p><p>å¦å¤– ISO é•œåƒæŒ‚è½½åæ˜¯åªè¯»çš„ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœæƒ³è¦ä¿®æ”¹ ISO é•œåƒä¸­çš„ä¸€ä¸ªæ–‡ä»¶ï¼ˆæ¯”å¦‚ kickstart æ–‡ä»¶ï¼‰ï¼Œåˆ™éœ€è¦å…ˆå°† ISO é•œåƒä¸­çš„æ‰€æœ‰å†…å®¹è´Ÿè´£åˆ°ä¸€ä¸ªå¯ä»¥è¯»å†™çš„ç›®å½•ä¸­ï¼Œåœ¨è¿™ä¸ªè¯»å†™çš„ç›®å½•ä¸­è¿›è¡Œä¿®æ”¹å’Œé‡æ–°æ„å»º ISO æ“ä½œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox ~/build</span><br><span class="line">â•°â”€<span class="comment"># mount -o loop CentOS-7-x86_64-Minimal-2009.iso /mnt/iso</span></span><br><span class="line">mount: /mnt/iso: WARNING: device write-protected, mounted <span class="built_in">read</span>-only.</span><br><span class="line">â•­â”€root@esxi-debian-devbox ~/build</span><br><span class="line">â•°â”€<span class="comment"># touch /mnt/iso/kickstart.cfg</span></span><br><span class="line">touch: cannot touch <span class="string">'/mnt/iso/kickstart.cfg'</span>: Read-only file system</span><br></pre></td></tr></table></figure><p>åœ¨æ—¥å¸¸å·¥ä½œä¸­ç»å¸¸ä¼šå¯¹ä¸€äº›å·²æœ‰çš„ ISO é•œåƒè¿›è¡Œé‡æ–°æ„å»ºï¼Œé‡æ–°æ„å»º ISO çš„æ•ˆç‡æ ¹æ®ä¸åŒçš„æ–¹å¼ä¹Ÿä¼šæœ‰æ‰€ä¸åŒï¼Œæœ¬æ–‡å°±æ•´ç†äº†ä¸‰ç§ä¸åŒé‡æ–°æ„å»º ISO é•œåƒçš„æ–¹æ¡ˆä¾›å¤§å®¶å‚è€ƒã€‚</p><h2 id="å¸¸è§„æ–¹å¼"><a href="#å¸¸è§„æ–¹å¼" class="headerlink" title="å¸¸è§„æ–¹å¼"></a>å¸¸è§„æ–¹å¼</h2><p>ä»¥ä¸‹æ˜¯æŒ‰ç…§ RedHat å®˜æ–¹æ–‡æ¡£ <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/anaconda_customization_guide/sect-iso-images" target="_blank" rel="noopener"> WORKING WITH ISO IMAGES</a> ä¸­çš„æ“ä½œæ­¥éª¤è¿›è¡Œ ISO é‡æ–°æ„å»ºã€‚</p><ul><li>é¦–å…ˆæˆ‘ä»¬ä¸‹è½½ä¸€ä¸ª ISO æ–‡ä»¶ï¼Œè¿™é‡Œä»¥ <a href="https://mirrors.tuna.tsinghua.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso" target="_blank" rel="noopener">CentOS-7-x86_64-Minimal-2009.iso</a> ä¸ºä¾‹ï¼Œä¸‹è½½å¥½ä¹‹åå°†å®ƒæŒ‚è½½åˆ°æœ¬åœ° <code>/mn/iso</code> ç›®å½•ä¸‹ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox ~/build</span><br><span class="line">â•°â”€<span class="comment"># mount -o loop CentOS-7-x86_64-Minimal-2009.iso /mnt/iso</span></span><br><span class="line">mount: /mnt/iso: WARNING: device write-protected, mounted <span class="built_in">read</span>-only.</span><br></pre></td></tr></table></figure><ul><li>å°† ISO é‡Œçš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°å¦ä¸€ä¸ªç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox ~/build</span><br><span class="line">â•°â”€<span class="comment"># rsync -avrut --force /mnt/iso/ /mnt/build/</span></span><br></pre></td></tr></table></figure><ul><li>è¿›å…¥åˆ°è¯¥ç›®å½•ä¸‹ä¿®æ”¹æˆ–æ–°å¢æ–‡ä»¶ï¼Œç„¶åé‡æ–°æ„å»º ISO é•œåƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ genisoimage å‘½ä»¤æ„å»º ISO é•œåƒï¼Œåœ¨ CentOS ä¸Šå¯ä»¥ä½¿ç”¨ mkisofs å‘½ä»¤ï¼Œå‚æ•°ä¸Šä¼šæœ‰ä¸€äº›å·®å¼‚</span></span><br><span class="line">â•­â”€root@esxi-debian-devbox ~/build</span><br><span class="line">â•°â”€<span class="comment"># genisoimage -U -r -v -T -J -joliet-long -V "CentOS 7 x86_64" -volset "CentOS 7 x86_64" -A "CentOS 7 x86_64" -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -no-emul-boot -o /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso .</span></span><br><span class="line">Total translation table size: 124658</span><br><span class="line">Total rockridge attributes bytes: 55187</span><br><span class="line">Total directory bytes: 100352</span><br><span class="line">Path table size(bytes): 140</span><br><span class="line">Done with: The File(s)                             Block(s)    527985</span><br><span class="line">Writing:   Ending Padblock                         Start Block 528101</span><br><span class="line">Done with: Ending Padblock                         Block(s)    150</span><br><span class="line">Max brk space used a4000</span><br><span class="line">528251 extents written (1031 MB)</span><br><span class="line"><span class="comment"># ç»™ ISO é•œåƒç”Ÿæˆ md5 æ ¡éªŒ</span></span><br><span class="line">â•­â”€root@esxi-debian-devbox ~/build</span><br><span class="line">â•°â”€<span class="comment"># implantisomd5 /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso</span></span><br><span class="line">Inserting md5sum into iso image...</span><br><span class="line">md5 = 9ddf5277bcb1d8679c367dfa93f9b162</span><br><span class="line">Inserting fragment md5sums into iso image...</span><br><span class="line">fragmd5 = f39e2822ec1ae832a69ae399ea4bd3e891eeb31e9deb9c536f529c15bbeb</span><br><span class="line">frags = 20</span><br><span class="line">Setting supported flag to 0</span><br></pre></td></tr></table></figure><p>å¯¹äº ISO é•œåƒæ¯”è¾ƒå°æˆ–è€…è¯¥æ“ä½œä¸æ˜¯å¾ˆé¢‘ç¹çš„æƒ…å†µä¸‹æŒ‰ç…§è¿™ç§æ–¹å¼æ˜¯æœ€çœäº‹å„¿çš„ï¼Œä½†å¦‚æœæ˜¯ ISO é•œåƒæ¯”è¾ƒå¤§ï¼Œæˆ–è€…æ˜¯åœ¨ CI/CD æµæ°´çº¿ä¸­é¢‘ç¹åœ°é‡æ–°æ„å»ºé•œåƒï¼Œæ¯æ¬¡éƒ½è¦ cp å¤åˆ¶åŸ ISO é•œåƒçš„å†…å®¹ç¡®å®æ¯”è¾ƒæµªè´¹æ—¶é—´ã€‚é‚£æœ‰æ²¡æœ‰ä¸€ä¸ªæ›´åŠ é«˜æ•ˆçš„æ–¹æ³•å‘¢ ğŸ¤”ï¸</p><p>ç»è¿‡ä¸€ç•ªæ‘¸ç´¢ï¼ŒæŠ˜è…¾å‡ºæ¥ä¸¤ç§å¯ä»¥é¿å…ä½¿ç”¨ cp å¤åˆ¶è¿™ç§å ç”¨å¤§é‡ IO æ“ä½œçš„æ„å»ºæ–¹æ¡ˆï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯è¿›è¡Œé€‰æ‹©ã€‚</p><h2 id="overlay2"><a href="#overlay2" class="headerlink" title="overlay2"></a>overlay2</h2><p>ç†Ÿæ‚‰ docker é•œåƒçš„åº”è¯¥éƒ½çŸ¥é“é•œåƒæ˜¯åªè¯»çš„ï¼Œä½¿ç”¨é•œåƒçš„æ—¶å€™åˆ™æ˜¯é€šè¿‡è”åˆæŒ‚è½½çš„æ–¹å¼å°†é•œåƒçš„æ¯ä¸€å±‚ layer æŒ‚è½½ä¸ºåªè¯»å±‚ï¼Œå°†å®¹å™¨å®é™…è¿è¡Œçš„ç›®å½•æŒ‚è½½ä¸ºè¯»å†™å±‚ï¼Œè€Œå®¹å™¨è¿è¡ŒæœŸé—´åœ¨è¯»å†™å±‚çš„æ‰€æœ‰æ“ä½œä¸ä¼šå½±å“åˆ°é•œåƒåŸæœ‰çš„å†…å®¹ã€‚å®¹å™¨é•œåƒæŒ‚è½½çš„æ–¹å¼ä½¿ç”¨æœ€å¤šçš„æ˜¯ overlay2 æŠ€æœ¯ï¼Œåœ¨ <a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 åœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­çš„åº”ç”¨</a> å’Œ <a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿ ğŸ¤”</a> ä¸­å’±æ›¾å¯¹å®ƒè¿›è¡Œè¿‡æ¯”è¾ƒæ·±å…¥çš„ç ”ç©¶å’Œä½¿ç”¨ï¼Œå¯¹ overlay2 æŠ€æœ¯æ„Ÿå…´è¶£çš„å¯ä»¥ç¿»çœ‹ä¸€ä¸‹è¿™ä¸¤ç¯‡åšå®¢ï¼Œæœ¬æ–‡å°±ä¸å†è¯¦è§£å…¶ä¸­çš„æŠ€æœ¯åŸç†äº†ï¼Œåªå¯¹ä½¿ç”¨ overlay2 æŠ€æœ¯é‡æ–°æ„å»º ISO é•œåƒçš„å¯è¡Œæ€§è¿›è¡Œä¸€ä¸‹åˆ†æã€‚</p><ul><li>é¦–å…ˆæ˜¯åˆ›å»º overlay2 æŒ‚è½½æ‰€éœ€è¦çš„å‡ ä¸ªç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox ~</span><br><span class="line">â•°â”€<span class="comment"># mkdir -p /mnt/overlay2/&#123;lower,upper,work,merged&#125;</span></span><br><span class="line">â•­â”€root@esxi-debian-devbox ~</span><br><span class="line">â•°â”€<span class="comment"># cd /mnt/overlay2</span></span><br></pre></td></tr></table></figure><ul><li>æ¥ç€å°† ISO é•œåƒæŒ‚è½½åˆ° overlay2 çš„åªè¯»å±‚ <code>lower</code> ç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox /mnt/overlay2</span><br><span class="line">â•°â”€<span class="comment"># mount -o loop  /root/build/CentOS-7-x86_64-Minimal-2009.iso lower</span></span><br><span class="line">mount: /mnt/overlay2/lower: WARNING: device write-protected, mounted <span class="built_in">read</span>-only.</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ mount å‘½ä»¤æŒ‚è½½ overlay2 æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‚è½½ç‚¹ä¸º <code>merged</code> ç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox /mnt/overlay2</span><br><span class="line">â•°â”€<span class="comment"># mount -t overlay overlay -o lowerdir=lower,upperdir=upper,workdir=work merged</span></span><br><span class="line">â•­â”€root@esxi-debian-devbox /mnt/overlay2</span><br><span class="line">â•°â”€<span class="comment"># cd merged</span></span><br></pre></td></tr></table></figure><ul><li>æ–°å¢ä¸€ä¸ª kickstart.cfg æ–‡ä»¶ï¼Œç„¶åé‡æ–°æ„å»º ISO é•œåƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox /mnt/overlay2/merged</span><br><span class="line">â•°â”€<span class="comment"># echo '# this is a kickstart config file' &gt; kickstart.cfg</span></span><br><span class="line">â•­â”€root@esxi-debian-devbox /mnt/overlay2/merged</span><br><span class="line">â•°â”€<span class="comment"># genisoimage -U -r -v -T -J -joliet-long -V "CentOS 7 x86_64" -volset "CentOS 7 x86_64" -A "CentOS 7 x86_64" -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -no-emul-boot -o /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso .</span></span><br><span class="line">Total translation table size: 124658</span><br><span class="line">Total rockridge attributes bytes: 55187</span><br><span class="line">Total directory bytes: 100352</span><br><span class="line">Path table size(bytes): 140</span><br><span class="line">Done with: The File(s)                             Block(s)    527985</span><br><span class="line">Writing:   Ending Padblock                         Start Block 528101</span><br><span class="line">Done with: Ending Padblock                         Block(s)    150</span><br><span class="line">Max brk space used a4000</span><br><span class="line">528251 extents written (1031 MB)</span><br></pre></td></tr></table></figure><ul><li>æŒ‚è½½æ–°çš„ ISO é•œåƒéªŒè¯åå‘ç°ç¡®å®å¯è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox /mnt/overlay2/merged</span><br><span class="line">â•°â”€<span class="comment"># mount -o loop /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso /mnt/newiso</span></span><br><span class="line">mount: /mnt/newiso: WARNING: device write-protected, mounted <span class="built_in">read</span>-only.</span><br><span class="line">â•­â”€root@esxi-debian-devbox /mnt/overlay2/merged</span><br><span class="line">â•°â”€<span class="comment"># cat /mnt/newiso/kickstart.cfg</span></span><br><span class="line"><span class="comment"># this is a kickstart config file</span></span><br></pre></td></tr></table></figure><h2 id="mount-â€“bind"><a href="#mount-â€“bind" class="headerlink" title="mount â€“bind"></a>mount â€“bind</h2><p>å‰é¢è®²åˆ°äº†ä½¿ç”¨ overlay2 çš„æ–¹å¼é¿å…å¤åˆ¶åŸé•œåƒå†…å®¹è¿›è¡Œé‡æ–°æ„å»ºé•œåƒçš„æ–¹æ¡ˆï¼Œä½†æ˜¯ overlay2 å¯¹äºä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„äººæ¥è®²è¿˜æ˜¯æ¯”è¾ƒå¤æ‚ï¼Œå…‰ lowerdirã€upperdirã€workdirã€mergeddir è¿™å››ä¸ªæ–‡ä»¶å¤¹çš„ä½œç”¨å’ŒåŸç†å°±æŠŠäººç›´æ¥ç»™æ•´ä¸ä¼šäº†ã€‚é‚£ä¹ˆè¿˜æœ‰æ²¡æœ‰æ›´ä¸ºç®€å•ä¸€ç‚¹çš„æ–¹å¼å‘¢ï¼Ÿ</p><p>åˆ«è¯´è¿˜çœŸæœ‰ï¼Œåªä¸è¿‡è¿™ç§æ–¹å¼çš„ç”¨é€”æ¯”è¾ƒå±€é™ã€‚å¦‚æœä»…ä»…æ˜¯ç”¨äºä¿®æ”¹ ISO ä¸­çš„ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•ï¼Œå¯ä»¥å°†è¯¥æ–‡ä»¶æˆ–ç›®å½•ä»¥ <code>bind</code> æŒ‚è½½çš„æ–¹å¼å°†å®ƒæŒ‚è½½åˆ° ISO ç›®å½•ç›®å½•å¯¹åº”çš„æ–‡ä»¶ä¸Šã€‚</p><p>åŸç†å°±æ˜¯è™½ç„¶ ISO ç›®å½•æœ¬èº«æ˜¯åªè¯»çš„ï¼Œä½†å®ƒé‡Œé¢çš„æ–‡ä»¶å’Œç›®å½•æ˜¯å¯ä»¥ä½œä¸ºä¸€ä¸ªæŒ‚è½½ç‚¹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘æŠŠæ–‡ä»¶ A æŒ‚è½½åˆ°æ–‡ä»¶ Bï¼Œå¹¶ä¸æ˜¯åœ¨ä¿®æ”¹æ–‡ä»¶ Bï¼Œè¿™å°±æ˜¯ Unix/Linux æ–‡ä»¶ç³»ç»Ÿååˆ†å¥‡å¦™çš„åœ°æ–¹ã€‚åŒæ ·è¿ç”¨ bind æŒ‚è½½çš„è¿˜æœ‰ docker çš„ volume ä»¥åŠ pod çš„ volume ä¹Ÿæ˜¯è¿ç”¨åŒæ ·çš„åŸç†ï¼Œä»¥ bind çš„æ–¹å¼å°†å®¿ä¸»æœºä¸Šçš„ç›®å½•æˆ–æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨è¿è¡Œå¯¹åº”çš„ç›®å½•ä¸Šã€‚å¯¹äºä¿®æ”¹åªè¯» ISO é‡Œçš„æ–‡ä»¶/ç›®å½•æˆ‘ä»¬å½“ç„¶ä¹Ÿå¯ä»¥è¿™æ ·åšã€‚åºŸè¯ä¸å¤šè¯´æ¥å®è·µéªŒè¯ä¸€ä¸‹ï¼š</p><ul><li>é¦–å…ˆä¾æ—§æ˜¯å°† ISO é•œåƒæŒ‚è½½åˆ° <code>/mn/iso</code> ç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox ~/build</span><br><span class="line">â•°â”€<span class="comment"># mount -o loop CentOS-7-x86_64-Minimal-2009.iso /mnt/iso</span></span><br><span class="line">mount: /mnt/iso: WARNING: device write-protected, mounted <span class="built_in">read</span>-only.</span><br></pre></td></tr></table></figure><ul><li>æ¥ç€åˆ›å»ºä¸€ä¸ª <code>/mnt/files/ks.cfg</code> æ–‡ä»¶ï¼Œå¹¶å†™å…¥æˆ‘ä»¬éœ€è¦çš„å†…å®¹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox ~/build</span><br><span class="line">â•°â”€<span class="comment"># mkdir -p /mnt/files</span></span><br><span class="line">â•­â”€root@esxi-debian-devbox ~/build</span><br><span class="line">â•°â”€<span class="comment"># echo '# this is a kickstart config file' &gt; /mnt/files/ks.cfg</span></span><br></pre></td></tr></table></figure><ul><li>æ¥ç€ä»¥ mount â€“bind çš„æ–¹å¼æŒ‚è½½æ–°å»ºçš„æ–‡ä»¶åˆ° ISO çš„ EULA æ–‡ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox /mnt/build</span><br><span class="line">â•°â”€<span class="comment"># mount --bind /mnt/files/ks.cfg /mnt/iso/EULA</span></span><br><span class="line">â•­â”€root@esxi-debian-devbox /mnt/build</span><br><span class="line">â•°â”€<span class="comment"># cat /mnt/iso/EULA</span></span><br><span class="line"><span class="comment"># this is a kickstart config file</span></span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥çœ‹åˆ°åŸæ¥ ISO æ–‡ä»¶ä¸­çš„ EULA æ–‡ä»¶å·²ç»è¢«æˆåŠŸæ›¿æ¢æˆäº†æˆ‘ä»¬ä¿®æ”¹çš„æ–‡ä»¶ï¼Œç„¶åå†é‡æ–°æ„å»ºä¸€ä¸‹è¯¥ ISO é•œåƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox /mnt/iso</span><br><span class="line">â•°â”€<span class="comment"># genisoimage -U -r -v -T -J -joliet-long -V "CentOS 7 x86_64" -volset "CentOS 7 x86_64" -A "CentOS 7 x86_64" -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -no-emul-boot -o /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso .</span></span><br></pre></td></tr></table></figure><ul><li>ç„¶åæˆ‘ä»¬å†é‡æ–°æŒ‚è½½æ–°çš„ ISO æ–‡ä»¶éªŒè¯ä¸€ä¸‹æ˜¯å¦å¯ä»¥</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox /mnt/iso</span><br><span class="line">â•°â”€<span class="comment"># mkdir /mnt/newiso</span></span><br><span class="line">â•­â”€root@esxi-debian-devbox /mnt/iso</span><br><span class="line">â•°â”€<span class="comment"># mount -o loop /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso /mnt/newiso</span></span><br><span class="line">mount: /mnt/newiso: WARNING: device write-protected, mounted <span class="built_in">read</span>-only.</span><br><span class="line">â•­â”€root@esxi-debian-devbox /mnt/iso</span><br><span class="line">â•°â”€<span class="comment"># cat /mnt/newiso/EULA</span></span><br><span class="line"><span class="comment"># this is a kickstart config file</span></span><br></pre></td></tr></table></figure><p>éªŒè¯é€šè¿‡ï¼Œç¡®å®å¯ä»¥ï¼ä¸è¿‡è¿™ç§æ–¹å¼å¾ˆå±€é™ï¼Œæ¯”è¾ƒé€‚ç”¨äºä¿®æ”¹å•ä¸ªæ–‡ä»¶å¦‚ <code>kickstart.cfg</code>ï¼Œå¦‚æœæ˜¯è¦æ–°å¢æ–‡ä»¶é‚£è¿˜æ˜¯ä½¿ç”¨ä¸Šæ–‡æåˆ°çš„ overlay2 çš„æ–¹å¼æ›´ä¸ºæ–¹ä¾¿ä¸€äº›ã€‚</p><h2 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h2><p>è™½ç„¶ ISO é•œåƒå’Œå®¹å™¨é•œåƒäºŒè€…æœ‰ç€æœ¬è´¨çš„å·®åˆ«ï¼Œä½†å¯¹äºåªè¯»å’Œè”åˆæŒ‚è½½çš„è¿™äº›ç‰¹æ€§äºŒè€…å¯ä»¥ç›¸äº’å€Ÿé‰´æ»´ã€‚</p><p>ä¸æ­¢å¦‚æ­¤ overlay2 è¿™ç§è”åˆæŒ‚è½½çš„ç‰¹æ€§ï¼Œè¿˜å¯ä»¥ç”¨åœ¨å…¶ä»–åœ°æ–¹ã€‚æ¯”å¦‚æˆ‘æœ‰ä¸€ä¸ªå…¬å…±çš„ NFS å…±äº«æœåŠ¡å™¨ï¼Œå…±äº«ç€ä¸€äº›ç›®å½•ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥ä»¥ root ç”¨æˆ·å¹¶ä»¥è¯»å†™çš„æƒé™è¿›è¡Œ NFS æŒ‚è½½ã€‚è¿™ç§æƒ…å†µä¸‹å¾ˆéš¾ä¿éšœä¸€äº›é‡è¦çš„æ–‡ä»¶å’Œæ•°æ®è¢«è¯¯åˆ ã€‚è¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨ overlay2 çš„æ–¹å¼å°†ä¸€äº›é‡è¦çš„æ–‡ä»¶æ•°æ®æŒ‚è½½ä¸º overlay2 çš„ lowerdir åªè¯»å±‚ï¼Œä¿è¯è¿™äº›æ•°æ®å°±å¦‚å®¹å™¨é•œåƒä¸€æ ·ï¼Œæ¯æ¬¡æŒ‚è½½ä½¿ç”¨çš„æ—¶å€™éƒ½ä½œä¸ºä¸€ä¸ªåªè¯»å±‚ã€‚æ‰€æœ‰çš„è¯»å†™æ“ä½œéƒ½åœ¨ overlay2 çš„ merged é‚£ä¸€å±‚ï¼Œä¸ä¼šçœŸæ­£å½±å“åˆ°åªè¯»å±‚çš„å†…å®¹ã€‚</p><p>è‰è‰åœ°æ°´äº†ä¸€ç¯‡åšå®¢ï¼Œæ˜¯ä¸æ˜¯æ²¡æœ‰ç”¨çš„çŸ¥è¯†åˆå¢åŠ äº† ğŸ˜‚</p><h2 id="æ¨èé˜…è¯»"><a href="#æ¨èé˜…è¯»" class="headerlink" title="æ¨èé˜…è¯»"></a>æ¨èé˜…è¯»</h2><ul><li><a href="https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt" target="_blank" rel="noopener">overlayfs.txt</a></li><li><a href="https://arkingc.github.io/2017/05/05/2017-05-05-docker-filesystem-overlay/" target="_blank" rel="noopener">Docker å­˜å‚¨é©±åŠ¨â€”Overlay/Overlay2ã€Œè¯‘ã€</a></li><li><a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿ ğŸ¤”</a></li><li><a href="https://zdyxry.github.io/2019/01/12/%E8%81%8A%E4%B8%80%E8%81%8A-ISO-9660/" target="_blank" rel="noopener">èŠä¸€èŠ ISO 9660</a></li><li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/anaconda_customization_guide/sect-iso-images" target="_blank" rel="noopener">WORKING WITH ISO IMAGES</a></li><li><a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 åœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­çš„åº”ç”¨</a></li><li><a href="https://blog.k8s.li/mount-bind.html">mount å‘½ä»¤ä¹‹ â€“bind æŒ‚è½½å‚æ•°</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ç¬”è€…ä¹‹å‰åœ¨å­—èŠ‚è·³åŠ¨çš„æ—¶å€™æ˜¯è´Ÿè´£ PaaS
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="overlay2" scheme="https://blog.k8s.li/tags/overlay2/"/>
    
      <category term="ISO" scheme="https://blog.k8s.li/tags/ISO/"/>
    
  </entry>
  
  <entry>
    <title>Kubespray 2.18 ç‰ˆæœ¬ç‰¹æ€§é¢„è§ˆ</title>
    <link href="https://blog.k8s.li/kubespray-2.18.html"/>
    <id>https://blog.k8s.li/kubespray-2.18.html</id>
    <published>2022-01-04T16:00:00.000Z</published>
    <updated>2022-03-15T00:55:12.747Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ kubernetes-sig ç¤¾åŒºçš„ <a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener">kubespray</a> é¡¹ç›®æ­£å¼ release äº† <a href="https://github.com/kubernetes-sigs/kubespray/releases/tag/v2.18.0" target="_blank" rel="noopener">v2.18.0</a> ç‰ˆæœ¬ï¼ŒåŒæ—¶å¯¹åº” <a href="https://github.com/cncf/k8s-conformance" target="_blank" rel="noopener">k8s-conformance</a> çš„ <a href="https://github.com/cncf/k8s-conformance/pull/1748" target="_blank" rel="noopener">v1.21</a> å’Œ <a href="https://github.com/cncf/k8s-conformance/pull/1760" target="_blank" rel="noopener">v1.22</a> ç‰ˆæœ¬ kubespray ä¹Ÿéƒ½å·²ç»å¾—åˆ° CNCF çš„ä¸€è‡´æ€§è®¤è¯ã€‚äºæ˜¯ä»Šå¤©å°±å€Ÿè¿™ä¸ªæ–°ç‰ˆæœ¬ release çš„æœºä¼šæ•´ç†ä¸€ä¸‹ 2.18 ç‰ˆæœ¬çš„ kubespray æœ‰å“ªäº›æœ‰è¶£çš„å˜åŒ–ã€‚</p><h2 id="ç»„ä»¶ç‰ˆæœ¬"><a href="#ç»„ä»¶ç‰ˆæœ¬" class="headerlink" title="ç»„ä»¶ç‰ˆæœ¬"></a>ç»„ä»¶ç‰ˆæœ¬</h2><p>ä»¥ä¸‹æ˜¯ v2.18.0 ç‰ˆæœ¬ä¸­ kubespray éƒ¨ç½²ç»„ä»¶çš„ä¸€äº›ç‰ˆæœ¬ä¿¡æ¯ï¼š</p><h3 id="K8s-æ ¸å¿ƒç»„ä»¶"><a href="#K8s-æ ¸å¿ƒç»„ä»¶" class="headerlink" title="K8s æ ¸å¿ƒç»„ä»¶"></a>K8s æ ¸å¿ƒç»„ä»¶</h3><ul><li>kubespray æ”¯æŒçš„ Kubernetes æ”¯æŒä» v1.22.0 åˆ° v1.23.1 ä¹‹é—´çš„æ‰€æœ‰æ­£å¼ç‰ˆæœ¬ï¼Œé»˜è®¤éƒ¨ç½²çš„ç‰ˆæœ¬ä¸º v1.22.5ï¼Œå¹¶ä¸” <a href="https://github.com/cncf/k8s-conformance/pull/1760" target="_blank" rel="noopener">v1.22</a> ç‰ˆæœ¬å¾—åˆ°äº† CNCF å®˜æ–¹çš„ä¸€è‡´æ€§è®¤è¯ï¼›</li><li>etcd ä»åŸæ¥çš„ v3.4.13 å‡çº§åˆ°äº† v3.5.0ï¼›</li><li>coredns ç‰ˆæœ¬å‡çº§åˆ°äº† v1.8.0ï¼Œå®ƒçš„æ­æ¡£ dnsautoscaler åˆ™ä¸º 1.8.5ï¼›</li><li>pod_infra å³ pause é•œåƒçš„ç‰ˆæœ¬æ²¡æœ‰å˜åŒ–ä¾æ—§ä¸º 3.3ï¼›</li></ul><table><thead><tr><th>Addon</th><th align="left">Version</th></tr></thead><tbody><tr><td>kube</td><td align="left">v1.22.5</td></tr><tr><td>pod_infra</td><td align="left">3.3</td></tr><tr><td>etcd</td><td align="left">v3.5.0</td></tr><tr><td>coredns</td><td align="left">v1.8.0</td></tr></tbody></table><h3 id="å®¹å™¨è¿è¡Œæ—¶"><a href="#å®¹å™¨è¿è¡Œæ—¶" class="headerlink" title="å®¹å™¨è¿è¡Œæ—¶"></a>å®¹å™¨è¿è¡Œæ—¶</h3><p>ç›®å‰å¸‚é¢ä¸Šæ‰€æœ‰çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·ä¸­ï¼Œå¯¹å®¹å™¨è¿è¡Œæ—¶çš„æ”¯æŒ kubespray æ— ç–‘æ˜¯æœ€ä¸°å¯Œçš„ã€‚éƒ¨ç½²èƒ½æ”¯æŒ dockerã€containerdã€crunã€kataã€cri-oã€‚é»˜è®¤çš„å®¹å™¨è¿è¡Œæ—¶å·²ç»ä»ä¹‹å‰çš„ docker åˆ‡æ¢åˆ°äº† containerdï¼Œcontainerd çš„ç‰ˆæœ¬æ˜¯ v1.5.8ã€‚</p><table><thead><tr><th>Addon</th><th>Version</th></tr></thead><tbody><tr><td>containerd</td><td>1.5.8</td></tr><tr><td>docker</td><td>20.10</td></tr><tr><td>docker_containerd</td><td>1.4.12</td></tr><tr><td>crun</td><td>1.3</td></tr><tr><td>runc</td><td>v1.0.3</td></tr><tr><td>crio</td><td>1.22</td></tr><tr><td>kata_containers</td><td>2.2.3</td></tr><tr><td>gvisor</td><td>20210921</td></tr></tbody></table><h3 id="CNI"><a href="#CNI" class="headerlink" title="CNI"></a>CNI</h3><p>åŒæ ·ï¼Œç›®å‰å¸‚é¢ä¸Šæ‰€æœ‰çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·ä¸­ï¼Œå¯¹ CNI çš„æ”¯æŒ kubespray ä¹Ÿæ— ç–‘æ˜¯æœ€ä¸ºä¸°å¯Œçš„ï¼Œèƒ½æ”¯æŒ 9 ç§ CNI ä»¥åŠå¤šç§ CNI ç»„åˆéƒ¨ç½²çš„ <a href="https://github.com/intel/multus-cni" target="_blank" rel="noopener">multus</a> ã€‚</p><table><thead><tr><th>Addon</th><th>Version</th></tr></thead><tbody><tr><td>calico</td><td>v3.20.3</td></tr><tr><td>flannel</td><td>v0.15.1</td></tr><tr><td>flannel_cni</td><td>v1.0.0</td></tr><tr><td>cni</td><td>v1.0.1</td></tr><tr><td>weave</td><td>2.8.1</td></tr><tr><td>cilium</td><td>v1.9.11</td></tr><tr><td>kube_ovn</td><td>v1.8.1</td></tr><tr><td>kube_router</td><td>v1.3.2</td></tr><tr><td>multus_cni</td><td>0.4.0</td></tr><tr><td>multus</td><td>v3.8</td></tr></tbody></table><h3 id="Kubernetes-app"><a href="#Kubernetes-app" class="headerlink" title="Kubernetes-app"></a>Kubernetes-app</h3><p>åŒæ—¶ï¼Œkubespray è¿˜æ”¯æŒä¸€äº› CLI å·¥å…·ä»¥åŠç¬¬ä¸‰æ–¹åº”ç”¨çš„éƒ¨ç½²ã€‚</p><ul><li>CLI å·¥å…·</li></ul><p>ä¸€äº› CLI å·¥å…·ï¼Œæ¯”å¦‚ helmã€nerdctlã€krewã€crictlã€‚å…¶ä¸­ nerdctl çš„éƒ¨ç½²æ”¯æŒæ˜¯å’±åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/7500" target="_blank" rel="noopener">#7500</a> ä¸­åŠ å…¥æ”¯æŒçš„ï¼Œç›®çš„æ˜¯ä¸º containerd ç”¨æˆ·æä¾›ä¸€ä¸ªç›¸å¯¹å‹å¥½çš„å‘½ä»¤è¡Œæ“ä½œä½“éªŒï¼Œä»¥æ›¿ä»£ docker CLIã€‚</p><table><thead><tr><th>addon</th><th>version</th></tr></thead><tbody><tr><td>helm</td><td>v3.7.1</td></tr><tr><td>nerdctl</td><td>0.15.0</td></tr><tr><td>krew</td><td>v0.4.2</td></tr><tr><td>crictl</td><td>v1.22.0</td></tr></tbody></table><ul><li>app</li></ul><p>ä¸ªäººæ„Ÿè§‰éƒ¨ç½²ä¸€äº›åƒ <code>dnsautoscaler</code>ã€ <code>argoCD</code> è¿™æ ·çš„åº”ç”¨ï¼Œè¿˜æ˜¯ä½¿ç”¨ helm æ¯”è¾ƒå¥½ã€‚å› ä¸ºåŸºäº ansible çš„ kubespray ç»´æŠ¤è¿™ä¹ˆå¤šç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œä»¥åŠå®ƒä»¬çš„å‡çº§ç®¡ç†éƒ½è¿œä¸å¦‚ helm æ–¹ä¾¿ã€‚å› æ­¤è€ƒè™‘åˆ°è¿™äº›ç»„ä»¶çš„å‡çº§ç»´æŠ¤æˆæœ¬ï¼Œä¸ªäººè¿˜æ˜¯ä¸å¤ªå»ºè®®ä½¿ç”¨ kubespray æ¥éƒ¨ç½²è¿™äº›ç»„ä»¶ã€‚</p><table><thead><tr><th>Addon</th><th>Version</th></tr></thead><tbody><tr><td>dnsautoscaler</td><td>1.8.5</td></tr><tr><td>netcheck</td><td>v1.2.2</td></tr><tr><td>nodelocaldns</td><td>1.21.1</td></tr><tr><td>metrics_server</td><td>v0.5.0</td></tr><tr><td>cert_manager</td><td>v1.5.4</td></tr><tr><td>addon_resizer</td><td>1.8.11</td></tr><tr><td>cinder_blockstorage</td><td>v3</td></tr><tr><td>external_vsphere</td><td>6.7u3</td></tr><tr><td>nvidia_driver</td><td>390.87</td></tr><tr><td>oci_cloud_controller</td><td>0.7.0</td></tr><tr><td>metallb</td><td>v0.10.3</td></tr><tr><td>argocd</td><td>v2.1.6</td></tr></tbody></table><h2 id="æ”¯æŒçš„-OS"><a href="#æ”¯æŒçš„-OS" class="headerlink" title="æ”¯æŒçš„ OS"></a>æ”¯æŒçš„ OS</h2><table><thead><tr><th>distribution</th><th>version</th></tr></thead><tbody><tr><td>Amazon Linux</td><td>2</td></tr><tr><td>Fedora CoreOS</td><td>34.x/35.x</td></tr><tr><td>Flatcar Container Linux by Kinvolk</td><td></td></tr><tr><td>Alma Linux</td><td>8</td></tr><tr><td>Rocky Linux</td><td>8</td></tr><tr><td>CentOS/RHEL</td><td>7/8</td></tr><tr><td>Oracle Linux</td><td>7/8</td></tr><tr><td>Debian</td><td>8/9/10/11</td></tr><tr><td>Ubuntu</td><td>16.04/18.04/20.04</td></tr><tr><td>Fedora</td><td>34/35</td></tr><tr><td>openSUSE</td><td>Leap 15.x/Tumbleweed</td></tr></tbody></table><h2 id="ä¸»è¦å˜åŒ–"><a href="#ä¸»è¦å˜åŒ–" class="headerlink" title="ä¸»è¦å˜åŒ–"></a>ä¸»è¦å˜åŒ–</h2><h3 id="åºŸé™¤"><a href="#åºŸé™¤" class="headerlink" title="åºŸé™¤"></a>åºŸé™¤</h3><ul><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8086" target="_blank" rel="noopener">#8086</a> ä¸­ç§»é™¤äº†å¯¹ Ambassador çš„æ”¯æŒï¼›</li><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8327" target="_blank" rel="noopener">#8327</a> ä¸­ç§»é™¤äº†å¯¹ registry-proxy çš„æ”¯æŒï¼›</li><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8246" target="_blank" rel="noopener">#8246</a> ä¸­ç§»é™¤äº†å¯¹ Fedora 33 çš„æ”¯æŒï¼Œå› ä¸º  Fedora 33 åœ¨ 2021-11-30 å°±å·²ç» EOL äº†ï¼Œæ‰€ä»¥è¢«åºŸå¼ƒæ”¯æŒä¹Ÿç†æ‰€å½“ç„¶ï¼›</li><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8265" target="_blank" rel="noopener">#8265</a> ä¸­ç§»é™¤äº†å¯¹ Mitogen çš„æ”¯æŒï¼ŒMitogen çš„ä½œç”¨å°±æ˜¯ç”¨æ¥ä¼˜åŒ– Ansible çš„æ€§èƒ½ï¼Œä½† Mitogen å¯¹äºä¸€äº›æ–°çš„ Linux å‘è¡Œç‰ˆæ”¯æŒçš„é¢å¹¶ä¸æ˜¯å¾ˆå‹å¥½ï¼Œåœ¨ Kubespray ä¸­ç»´æŠ¤çš„æˆæœ¬ä¹Ÿæ¯”è¾ƒå¤§ï¼Œå› æ­¤ç¤¾åŒºå°±åºŸå¼ƒå®ƒäº†ï¼›</li></ul><h3 id="æ–°ç‰¹æ€§"><a href="#æ–°ç‰¹æ€§" class="headerlink" title="æ–°ç‰¹æ€§"></a>æ–°ç‰¹æ€§</h3><ul><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/7895" target="_blank" rel="noopener">#7895</a> ä¸­æ–°å¢äº† ArgoCD çš„éƒ¨ç½²æ”¯æŒï¼Œé€šè¿‡è®¾ç½® <code>argocd_enabled</code> å³å¯åœ¨éƒ¨ç½²é›†ç¾¤çš„æ—¶å€™å®‰è£… ArgoCDã€‚ä¸è¿‡ä¸ªäººè®¤ä¸ºï¼ŒArgoCD è¿™ç©æ„å„¿ä¸å¤ªé€‚åˆæ”¾åœ¨ K8s éƒ¨ç½²å½“ä¸­æ¥ï¼Œçœ‹çœ‹ <a href="https://github.com/kubesphere/ks-installer" target="_blank" rel="noopener">ks-installer</a> çš„ä»£ç ä½ å°±èƒ½æ˜ç™½äº† ğŸ˜‚ã€‚</li><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8175" target="_blank" rel="noopener">#8175</a> ä¸­é»˜è®¤ä½¿ç”¨ containerd ä½œä¸ºé»˜è®¤çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œæ›¿ä»£æ‰äº† dockerã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“å‰ç‰ˆæœ¬çš„ kubespray æ˜¯ä½¿ç”¨ <a href="https://github.com/containerd/containerd" target="_blank" rel="noopener">containerd</a> å®˜æ–¹ repo release çš„äºŒè¿›åˆ¶å®‰è£…åŒ…ï¼Œä½†äºŒè¿›åˆ¶å®‰è£…åŒ…å¹¶æ²¡æœ‰ arm64 ç‰ˆæœ¬çš„ã€‚æ‰€ä»¥å¦‚æœè¦éƒ¨ç½²çš„é›†ç¾¤èŠ‚ç‚¹åŒ…å« arm64 çš„æœºå™¨ï¼Œæœ€å¥½è¿˜æ˜¯ä½¿ç”¨ docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ã€‚</li><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8291" target="_blank" rel="noopener">#8291</a> æ–°å¢äº† registry éƒ¨ç½²æ”¯æŒå¤šç§ ServiceTypes çš„æ”¯æŒï¼›</li><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8229" target="_blank" rel="noopener">#8229</a> ä¸­æ–°å¢äº†æ”¯æŒ registry è®¤è¯çš„æ–¹å¼ï¼Œç§æœ‰åŒ–éƒ¨ç½²çš„æ—¶å€™ä½¿ç”¨å¸¦æœ‰è®¤è¯çš„ registry ä¼šç”¨åˆ°ï¼›</li></ul><h3 id="å·²çŸ¥é—®é¢˜"><a href="#å·²çŸ¥é—®é¢˜" class="headerlink" title="å·²çŸ¥é—®é¢˜"></a>å·²çŸ¥é—®é¢˜</h3><ul><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8239" target="_blank" rel="noopener">#8239</a> ä¸­ <a href="https://github.com/cristicalin" target="_blank" rel="noopener">cristicalin</a> å¤§ä½¬å¼•å…¥äº†ä¸€ä¸ªä¿®æ”¹ï¼Œå¦‚æœæ˜¯ containerd è¿è¡Œæ—¶ï¼Œåˆ™ä½¿ç”¨ nerdctl ä¸‹è½½é•œåƒã€‚è¿™å°†ä¼šå¯¼è‡´é…ç½®äº† containerd registry mirrors çš„å‚æ•°å°†ä¼šå¤±æ•ˆã€‚</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;æœ€è¿‘ kubernetes-sig ç¤¾åŒºçš„ &lt;a
        
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>æ—¶å…‰ç—•è¿¹ï¼š2021 å¹´æ€»ç»“</title>
    <link href="https://blog.k8s.li/2021.html"/>
    <id>https://blog.k8s.li/2021.html</id>
    <published>2022-01-02T16:00:00.000Z</published>
    <updated>2022-03-15T00:55:12.747Z</updated>
    
    <content type="html"><![CDATA[<p>2021 ä¾æ—§æ˜¯äººç±»ç¤¾ä¼š<strong>å€’è½¦å’ŒåŠ é€Ÿç­äº¡</strong>çš„ä¸€å¹´ï¼Œå…¨çƒèŒƒå›´å†…æ–°å† ç—…æ¯’ä¾æ—§åœ¨è‚†è™ï¼Œæ–°çš„å˜å¼‚åˆæ¥è¸µè€Œæ¥ï¼Œç–«æƒ…å¹¶æ²¡æœ‰å¤šå°‘æ¶ˆé€€çš„è¿¹è±¡ã€‚è€Œç°åœ¨å›½å†…è¥¿å®‰ç–«æƒ…åˆçˆ†å‘å¼€æ¥ï¼Œæ— æ³•é¢„æƒ³æœªæ¥ç©¶ç«Ÿèƒ½å˜æˆä»€ä¹ˆæ ·å­ã€‚</p><h2 id="é˜…è¯»"><a href="#é˜…è¯»" class="headerlink" title="é˜…è¯»"></a>é˜…è¯»</h2><p>2021 å¹´ 9 æœˆä»½çš„æ—¶å€™å°†ä¹¦å•ä»åŸæ¥çš„ Markdown æ–‡æœ¬è¿ç§»åˆ°äº† Notion ä¸Šï¼Œä½“éªŒååˆ†æ£’ã€‚Notion çš„è¡¨æ ¼æ•°æ®åº“åŠŸèƒ½ååˆ†å¼ºå¤§ï¼Œå¯¹ä¹¦å•æ¥è¯´ç®€ç›´å°±æ˜¯ä¸€ä»¶ç¥å™¨ã€‚æŠ½ç©ºæ•´ç†äº†ä¸€ä¸‹ä¹¦å•  <a href="https://reading.k8s.li" target="_blank" rel="noopener">reading.k8s.li</a>  ï¼Œ2021 å¹´å¤§æ¦‚è¯»å®Œäº† 97 æœ¬ä¹¦ã€‚å…¶ä¸­ç§‘æ™® 27 æœ¬ã€æ¼«ç”» 17 æœ¬ã€å†å² 13 æœ¬ã€æ”¿æ²» 11 æœ¬ã€è½»å°è¯´ 8 æœ¬ã€ç¤¾ç§‘ 7 æœ¬ã€å¿ƒç†å­¦ 5 æœ¬ã€æŠ€æœ¯ 5 æœ¬ã€æ³•å¾‹ 2 æœ¬ã€‚ä¹‹æ‰€ä»¥èƒ½è¯»å®Œè¿™ä¹ˆå¤šä¹¦å¤§æ¦‚æ˜¯å› ä¸ºå¦‚ä¸‹ ğŸ˜‚ï¼š</p><ul><li>å•èº«ç‹¬å±…ï¼Œè‡ªå·±ä¸€ä¸ªäººç”Ÿæ´»ï¼Œæ²¡äººæ‰“æ‰°ï¼›</li><li>ä¸å–œæ¬¢ç¤¾äº¤ï¼Œä¸å–œæ¬¢ç¾¤èŠé—²èŠæ‰¯æ·¡æ’•é€¼ï¼›</li><li>ä¸ç©æ¸¸æˆä¸åˆ·çŸ­è§†é¢‘ï¼Œæ²¡æœ‰å…¶ä»–çˆ±å¥½ï¼›</li><li>å‘¨æœ«å’ŒèŠ‚å‡æ—¥å¤§å¤šæ•°å®…åœ¨å®¶é‡Œç©å„¿ï¼›</li></ul><p>å…¶ä¸­æˆ‘è§‰ç€å•èº«ç‹¬å±…æ˜¯æœ€ä¸»è¦çš„åŸå› ï¼Œæ¯”å¦‚ <a href="https://twitter.com/yihong0618" target="_blank" rel="noopener">ä¼Šæ´ª</a> è€å“¥ä¹Ÿæ˜¯å¦‚æ­¤ï¼š</p><p><img src="https://p.k8s.li/image-20220103202406764.png" alt="image-20220103202406764"></p><p>æ ¹æ®ä¸ªäººçš„å–œå¥½ï¼Œå°±åˆ†äº«ä»¥ä¸‹ 10 æœ¬æˆ‘ä¸ªäººè§‰ç€ååˆ†æœ‰æ„æ€çš„ä¹¦ç»™å¤§å®¶ï¼š</p><p><img src="https://p.k8s.li/image-20220103202406766.png" alt="Snipaste_2021-12-31_19-28-11"></p><p>ç”±äºè¯»ä¹¦ç¬”è®°çš„ç¯‡å¹…å¤ªé•¿ï¼Œåé¢æœ‰ç©ºçš„è¯æˆ‘ä¼šå’Œå»å¹´çš„ã€Š<a href="https://blog.k8s.li/2020-booklist.html">2020 å¹´è¯»ä¹¦ç¬”è®°å’Œæ€è€ƒ</a>ã€‹ä¸€æ ·ï¼Œå†å†™ä¸€ç¯‡ 2021 å¹´çš„è¯»ä¹¦ç¬”è®°æ¥åˆ†äº«ç»™å¤§å®¶ï¼ˆå¤§æ¦‚ç‡æ˜¯åœ¨æ˜¥èŠ‚æœŸé—´å†™äº†ï¼‰ã€‚</p><h2 id="å·¥ä½œ"><a href="#å·¥ä½œ" class="headerlink" title="å·¥ä½œ"></a>å·¥ä½œ</h2><h3 id="å­—èŠ‚è·³åŠ¨"><a href="#å­—èŠ‚è·³åŠ¨" class="headerlink" title="å­—èŠ‚è·³åŠ¨"></a>å­—èŠ‚è·³åŠ¨</h3><p>ä»Šå¹´æœ€å¤§çš„å˜åŒ–å°±æ˜¯æ¢äº†æ–°å·¥ä½œï¼Œè¿™ä¹Ÿæ˜¯ç¬¬äºŒæ¬¡æ¢å·¥ä½œã€‚æœ¬æ¥æ²¡æœ‰æ‰“ç®—ç¦»èŒï¼Œä½†æ˜¯è¢«è¿«<del>å­—èŠ‚</del>è·³åŠ¨äº†ä¸€å¹´ä¹‹åï¼Œæ„Ÿè§‰å¤ªç´¯äº†ï¼Œå¹¶æ²¡æœ‰æƒ³è±¡ä¸­çš„é‚£ä¹ˆå¿«ä¹ã€‚</p><p>ä¸å¾—ä¸åæ§½ä¸€ä¸‹å­—èŠ‚çš„åŸºç¡€è®¾æ–½åšçš„å®åœ¨æ˜¯å¤ªçƒ‚äº†ï¼Œæ¯”å¦‚é•œåƒä»“åº“å„ç§å¥‡è‘©çš„é—®é¢˜ã€‚å½“æ—¶è¿˜å› ä¸ºè¿™ç ´ç©æ„å„¿å‡ºè¿‡ç‰ˆæœ¬å‘å¸ƒçš„é”™è¯¯ï¼Œå¯¼è‡´ç»„ä»¶ç¼–è¯‘çš„ base é•œåƒå‡ºé”™ï¼Œåæ¥åˆä¸å¾—ä¸é‡æ–°å‘å¸ƒä¸€ä¸ªç‰ˆæœ¬æ¥æ“¦å±è‚¡ã€‚</p><p>è¿˜æœ‰å½“æ—¶ PaaS å®¹å™¨äº‘å¹³å°ç§æœ‰åŒ–äº§å“ç‰ˆæœ¬å‘å¸ƒçš„æ—¶å€™ï¼Œé¢†å¯¼éå¾—å°†æ‰“åŒ…å‘å¸ƒçš„æ—¶é—´ç‚¹å®šåœ¨ä¸´è¿‘æ™šä¸Šä¸‹ç­çš„æ—¶å€™ã€‚è¿™å°±ä¼šå¯¼è‡´æˆ‘ä»¬ç»„ï¼ˆè‹¦å‘½å‘ç‰ˆå·¥å…·äººï¼‰å¿™æ´»åˆ°æ™šä¸Šåä¸€äºŒç‚¹ï¼ŒçœŸçš„æ˜¯ååˆ†ä¸çˆ½ã€‚å°±æ˜¯å› ä¸ºä¸€äº›å…¬å…±äº‹åŠ¡æ²¡æœ‰åšå¥½ï¼Œä¸€äº›é—®é¢˜åœ¨ç»„ä»¶è‡ªèº«çš„ CI/CD æµæ°´çº¿ä¸­å¹¶ä¸èƒ½åŠæ—¶æš´éœ²ï¼Œç­‰åˆ°æœ€ç»ˆæœ€åç‰ˆæœ¬å‘å¸ƒçš„æ—¶å€™ï¼Œå„ç§å¥‡è‘©çš„é—®é¢˜çªçªçªåœ°å†’å‡ºæ¥ã€‚æ¯”å¦‚ç¼ºé•œåƒã€é•œåƒé”™è¯¯ã€helm chart é”™è¯¯ã€ç‰ˆæœ¬é”™è¯¯ç­‰ã€‚ç„¶åå‡ºäº†é—®é¢˜ä¹‹ååˆè¦ @ å„ä¸ªç»„ä»¶çš„ owner å»è§£å†³é—®é¢˜ï¼Œå®ƒä»¬ä¿®æ”¹å¥½ä¹‹åæˆ‘ä»¬å†é‡æ–°æ‰“åŒ…éƒ¨ç½²æ–°çš„ç¯å¢ƒæ¥éªŒè¯ã€‚æ¯åˆ°å‘ç‰ˆæ—¥å°±ååˆ†ç—›è‹¦ï¼Œä¸€äº›åŸºç¡€è®¾æ–½å’Œå…¬å…±äº‹åŠ¡æ²¡æœ‰åšå¥½ï¼Œç­‰åˆ°æœ€åæˆ‘ä»¬å‘ç‰ˆå·¥å…·äººæ¥æ“¦å±è‚¡ã€‚è¿™è®©æˆ‘æƒ³èµ·äº†å¦ä¸€ä½æ¨å‹åˆ†äº«çš„ç»å†ï¼š</p><p><img src="https://p.k8s.li/image-20220104082135898.png" alt="image-20220104082135898"></p><h3 id="è£¸è¾ç¦»èŒ"><a href="#è£¸è¾ç¦»èŒ" class="headerlink" title="è£¸è¾ç¦»èŒ"></a>è£¸è¾ç¦»èŒ</h3><p>å››æœˆåº•å’Œ leader ç»©æ•ˆæ²Ÿé€šå®Œåæ„Ÿè§‰ä¸å¤ªæ»¡æ„äºæ˜¯å†…å¿ƒå°±å†³å®šäº†è¦ç¦»èŒã€‚ä¸è¿‡å› ä¸ºå½“æ—¶ä¸€äº›ç»„ç»‡æ¶æ„çš„è°ƒæ•´ï¼Œæˆ‘æ‰€åšçš„å·¥ä½œæ²¡æœ‰ä¸€ä¸ªåˆé€‚çš„äººæ¥æ¥ç›˜ã€‚å†åŠ ä¸Šæ–°äº§å“åˆšè¿›å…¥è®¾è®¡é˜¶æ®µï¼Œæ–°äº§å“å¹³å°åº•å±‚çš„ K8s éƒ¨ç½²ä»¥åŠç§æœ‰åŒ–æ‰“åŒ…å‘å¸ƒç›¸å…³çš„å·¥ä½œæ²¡æœ‰å…¶ä»–äººèƒ½å¤Ÿ take èµ·æ¥ï¼Œæœ€å°´å°¬çš„æ˜¯è¿™éƒ¨åˆ†å·¥ä½œå½“æ—¶åªæœ‰æˆ‘ä¸€ä¸ªäººèƒ½å®Œæ•´åœ°åšå‡ºæ¥ã€‚å¦‚æœåœ¨äº”æœˆåº•ç¦»èŒçš„è¯ï¼Œå¯èƒ½ä¼šå¯¹æ–°äº§å“çš„å¼€å‘å¸¦æ¥ä¸€å®šå½±å“ã€‚å› æ­¤å½“æ—¶è€ƒè™‘äº†ä¸€ä¸‹ï¼Œè¿˜æ˜¯ç­‰åˆ°æ–°äº§å“ç¨³å®šå‘ç‰ˆä»¥åŠæŠŠè´Ÿè´£çš„å·¥ä½œäº¤æ¥ç»™æ–°äººä¹‹åå†ç¦»å¼€å§ã€‚</p><p>å°±è¿™æ ·è‡ªå·±ä¸€ä¸ªäººåˆé‡æ–°è´Ÿè´£èµ·äº†æ•´ä¸ª PaaS å¹³å°çš„ç§æœ‰åŒ–éƒ¨ç½²å’Œæ‰“åŒ…å‘å¸ƒç›¸å…³çš„å·¥ä½œï¼Œè¿™æ®µæ—¶é—´ä¹Ÿæ”¶è·æŒºå¤šçš„ï¼Œé¡ºä¾¿ç»™ kubernetes-sig ç¤¾åŒºçš„ kubespray é¡¹ç›®è´¡çŒ®äº†åå‡ ä¸ª <a href="https://github.com/kubernetes-sigs/kubespray/pulls?q=is%3Apr+author%3Amuzi502+is%3Aclosed" target="_blank" rel="noopener">PR</a>ã€‚ç­‰åˆ°ä¸ƒæœˆåº•çš„æ—¶å€™ï¼Œæ–°äº§å“å·²ç»è¿›å…¥äº†ç¨³å®šå¼€å‘çš„é˜¶æ®µï¼Œåœ¨ç¬¬ä¸€ä¸ª alpha.1 ç‰ˆæœ¬æ—¶å°±æå®šäº†ç§æœ‰åŒ–éƒ¨ç½²å’Œç§æœ‰åŒ–æ‰“åŒ…çš„æµæ°´çº¿ï¼Œåˆç»è¿‡ä¸‰ä¸ª sprint çš„è¿­ä»£åï¼Œç»ˆäºç¨³å®šäº†ä¸‹æ¥ã€‚ä¹‹åå°±æ•´ç†äº†ä¸€äº›å¹³æ—¶ç§¯ç´¯çš„æ–‡æ¡£ï¼Œäº¤æ¥ç»™äº†å…¶ä»–åŒäº‹ï¼Œç„¶ååŠç†ç¦»èŒæ‰‹ç»­èµ°äººã€‚</p><p>è£¸è¾çš„åŸå› ä¹Ÿæœ‰å¾ˆå¤šï¼šæƒ³èµ°å‡ºå¿ƒç†èˆ’é€‚åœˆï¼Œæ¢ä¸ªç¯å¢ƒèƒ½è®©è‡ªå·±æˆé•¿èµ·æ¥ï¼›å½“æ—¶å¯¹å·¥ä½œä¹Ÿæœ‰äº†ä¸€ç‚¹åŒå€¦ï¼Œæƒ³å¥½å¥½ä¼‘æ¯ä¸€ä¸‹ï¼›å½“æ—¶çš„çŠ¶æ€ä¹Ÿä¸æ˜¯å¾ˆå¥½ï¼Œå¦‚æœé‚£æ—¶å€™å‡†å¤‡é¢è¯•çš„è¯ï¼Œæ„Ÿè§‰æ•ˆæœä¸å¤ªå¥½ï¼›å¾ˆä¹…æ²¡æœ‰å›å®¶äº†ï¼Œæƒ³åœ¨å®¶å¥½å¥½ä¼‘æ¯ä¸€æ®µæ—¶é—´ã€‚å½“æ—¶ä¹Ÿæ²¡æœ‰é€‰æ‹©ä¼‘å‡ï¼Œè€Œæ˜¯å°†æ‰€æœ‰çš„å‡æœŸéƒ½æŠ˜ç®—æˆåŒå€å·¥èµ„äº†ï¼Œæ„Ÿè§‰è¿™æ ·æ›´åˆ’ç®—ä¸€äº›ã€‚å¦‚æœæ˜¯ä¼‘å‡çš„è¯ï¼Œä¿ä¸å‡†åœ¨ä¼‘å‡çš„æ—¶å€™ä»è¦åœ¨é£ä¹¦ä¸Šå¤„ç†ä¸€äº›åŒäº‹çš„é—®é¢˜ã€‚æ„Ÿè§‰è¿™æ ·å°±æŒºçƒ¦äººçš„ï¼Œæ‰€ä»¥å¹²è„†å°±ç›´æ¥èµ°äººï¼Œé£ä¹¦éƒ½æ²¡äº†è¿˜æ€ä¹ˆè”ç³»æˆ‘ã€‚</p><p>ç¦»èŒçš„ç¬¬äºŒå¤©å°±æ”¶æ‹¾è¡Œæå›è€å®¶ï¼Œå› ä¸ºè€çˆ¸çš„ç”Ÿæ—¥å¿«åˆ°äº†ï¼Œä¹Ÿæƒ³å°½å¿«å›å®¶å’Œå®¶äººå›¢èšã€‚</p><p>ä¹‹åå°±ä¸€ç›´åœ¨å®¶åˆ’æ°´æ‘¸é±¼å•¦ï¼ŒæœŸé—´èŠ±äº†ä¸¤å‘¨å·¦å³çš„æ—¶é—´å®Œæˆäº†ä¸¤ä¸ªå¼€æºé¡¹ç›®ï¼šä¸€ä¸ªæ˜¯ç”¨äºæ„å»º yum/apt/dnf ç¦»çº¿æºçš„å·¥å…· <a href="https://github.com/k8sli/os-packages" target="_blank" rel="noopener">k8sli/os-packages</a> ï¼Œä»¥åŠæ— ç½‘ç¯å¢ƒä¸­ç¦»çº¿éƒ¨ç½² k8s çš„å·¥å…·  <a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">k8sli/kubeplay</a> ã€‚</p><h3 id="é¢è¯•"><a href="#é¢è¯•" class="headerlink" title="é¢è¯•"></a>é¢è¯•</h3><p>æ­£å¼å¼€å§‹å‡†å¤‡é¢è¯•æ˜¯åœ¨ 9 æœˆåˆçš„æ—¶å€™ï¼Œå·²ç»åˆ’æ°´æ‘¸é±¼ä¸€ä¸ªæœˆäº†ï¼Œæ„Ÿè§‰ä¼‘æ¯çš„ä¹Ÿå·®ä¸å¤šäº†ã€‚è¿˜æ˜¯èµ¶ç´§æ‰¾å·¥ä½œé¢è¯•å§ï¼Œåœ¨èµ·åˆçš„ä¸€å‘¨æ˜¯é€šè¿‡ä¸€äº›å¿ƒä»ªå…¬å¸çš„å®˜ç½‘ä¸ŠæŠ•é€’çš„ç®€å†ï¼Œä¸å¹¸çš„æ˜¯æ”¶åˆ°çš„å›å¤å¾ˆå°‘ã€‚å½“æ—¶å¿ƒé‡Œæœ‰ç‚¹æ…Œï¼Œå†™äº†ç¯‡æ±‚èŒã€Š<a href="https://blog.k8s.li/jobs.html">æ±‚èŒè´´ï¼šè¿ç»´å¼€å‘ ï½œSRE</a>ã€‹ä»‹ç»äº†ä¸€ä¸‹è‡ªå·±çš„ç°çŠ¶ï¼Œç»ˆäºæ”¶åˆ°äº†ä¸€äº›å°ä¼™ä¼´ä»¬çš„å†…æ¨ã€‚</p><p><img src="https://p.k8s.li/image-20211231205927088.png" alt="image-20211231205927088"></p><p>åœ¨æ­¤è¿˜æ˜¯ååˆ†æ„Ÿè°¢å¸®åŠ©æˆ‘å†…æ¨çš„å°ä¼™ä¼´ï¼Œåœ¨æˆ‘å³å°†èµ°æŠ•æ— è·¯çš„æ—¶å€™æœ‰ä½ ä»¬çš„æ¨èæ‰æœ‰äº†æˆ‘ç°åœ¨çš„å·¥ä½œæœºä¼šã€‚å¤§å¤§å°å°çš„é¢è¯•æ€»å…±è¿›è¡Œäº† 25 æ¬¡å§ï¼Œå·®ä¸å¤šé€šè¿‡äº†ä¸€åŠï¼Œæ‹¿åˆ° 4 ä¸ªä¹¦é¢ offerï¼Œæœ€ç»ˆå»äº†ä¸€å®¶åš IaaS è™šæ‹ŸåŒ–å’Œåˆ†å¸ƒå¼å—å­˜å‚¨äº§å“çš„ toB å…¬å¸ã€‚</p><p>å› ä¸ºä¹‹å‰æ˜¯åœ¨å­—èŠ‚è·³åŠ¨åš PaaS toB äº§å“çš„é›†ç¾¤éƒ¨ç½²å’Œç§æœ‰åŒ–äº¤ä»˜ç›¸å…³å·¥ä½œï¼Œåœ¨æ–°å·¥ä½œåˆ™æ˜¯åš IaaS toB äº§å“çš„é›†ç¾¤éƒ¨ç½²ç›¸å…³å·¥ä½œï¼Œéƒ½æ˜¯â€œé›†ç¾¤éƒ¨ç½²â€ç›¸å…³çš„ï¼Œå› æ­¤å’Œä»¥å¾€çš„ç»å†æ¯”è¾ƒåŒ¹é…ã€‚å¯¹äºåƒå’±è¿™ç§å–œæ¬¢æŠ˜è…¾çš„åƒåœ¾ä½¬æ¥è¯´ï¼Œè¿˜æ˜¯ç¡¬ä»¶æœåŠ¡å™¨ã€æ“ä½œç³»ç»Ÿã€è™šæ‹ŸåŒ–ã€åˆ†å¸ƒå¼å­˜å‚¨ç­‰æ–¹é¢çš„å†…å®¹æ¯”è¾ƒæœ‰æ„æ€ï¼Œç©èµ·æ¥å¯å¼€å¿ƒæƒ¹ ğŸ¤£ã€‚</p><p>æ›´ä¸ºé‡è¦çš„ä¸€ç‚¹æ˜¯æ–°å·¥ä½œä¸å†åƒä»¥å‰é‚£æ ·è¿ç»´æŠ€æœ¯ä¸ºä¸»äº†ï¼Œè€Œè‡³ä»¥åç«¯ç ”å‘ä¸ºä¸»ã€‚å…¶å®æˆ‘å¾ˆæ—©ä¹‹å‰å°±æƒ³å†™ä¸€äº› Go/Python åç«¯é¡¹ç›®çš„ä»£ç äº†ï¼Œåªä¸è¿‡ä¸€ç›´æ²¡æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„æœºä¼šï¼ˆå…¶å®æ˜¯å·æ‡’çš„å€Ÿå£ ğŸŒšï¼‰ã€‚åœ¨å­—èŠ‚çš„æ—¶å€™ä¹Ÿæ²¡æœ‰å¤ªå¤šåç«¯å¼€å‘çš„ç»éªŒï¼Œæ‰€ä»¥å½“åˆé¢è¯•çš„æ—¶å€™å› ä¸ºå¼€å‘èƒ½åŠ›è¾ƒå¼±è¢«åˆ·æ‰äº†å¾ˆå¤šï¼Œä¹Ÿè®©ä¸€äº›é¢è¯•å®˜æå…¶å¤±æœ›ã€‚</p><p>å¹¸è¿çš„æ˜¯é¢è¯•çš„æ—¶å€™ä¹Ÿé‡åˆ°äº†ä¸€ä¸ªéå¸¸ nice çš„å…¬å¸æ„¿æ„èŠ±æ—¶é—´åŸ¹å…»æˆ‘è¿™æ–¹é¢çš„èƒ½åŠ›ï¼Œleader ä¹Ÿååˆ†ä¿¡ä»»æˆ‘çš„å­¦ä¹ èƒ½åŠ›ï¼Œè®©æˆ‘ä»é›¶å¼€å§‹æ‰¿æ‹…ä¸€ä¸ªé¡¹ç›®çš„åç«¯å¼€å‘ï¼Œç»™äº†æˆ‘è¿™ä¹ˆä¸€ä¸ªå®è´µçš„æœºä¼šæ¥å­¦ä¹ å’Œå¼¥è¡¥å¼€å‘èƒ½åŠ›ä¸è¶³çš„çŸ­æ¿ã€‚</p><h2 id="ç”Ÿæ´»"><a href="#ç”Ÿæ´»" class="headerlink" title="ç”Ÿæ´»"></a>ç”Ÿæ´»</h2><p>ç”Ÿæ´»ä¸Šä¾æ—§æ˜¯å•èº«ç‹¬å±…ï¼Œè‡ªå·±ä¸€ä¸ªäººç”Ÿæ´»å®åœ¨æ˜¯å¤ªçˆ½äº†ï¼Œè¶Šæ¥è¶Šä¹ æƒ¯è¿™ç§ç”Ÿæ´»ï¼Œå¥½æƒ³æ°¸è¿œåœ°å°±è¿™æ ·ç”Ÿæ´»ä¸‹å»ï¼Œæ²¡æœ‰å‚¬å©šçš„çƒ¦æ¼ ğŸ˜–ã€‚ç‹¬è‡ªä¸€ä¸ªäººç”Ÿæ´»æœ€é‡è¦çš„å°±æ˜¯å­¦ä¼š<strong>å¦‚ä½•å¯¹æŠ—è™šæ— </strong>ã€‚åªè¦æ‰¾äº›æœ‰æ„ä¹‰çš„äº‹æƒ…æ¥åšï¼ˆæ¯”å¦‚è¯»ä¹¦ï¼‰ï¼Œå°±ä¸ä¼šè§‰ç€ç”Ÿæ´»æ— å‘³æˆ–è€…æœ‰ç©ºè™šæ„Ÿã€‚å›æƒ³èµ·å¤§å­¦å››å¹´ï¼ŒåŸºæœ¬ä¸Šæˆ‘ä¹Ÿæ˜¯çš„ç‹¬è‡ªä¸€äººå»å›¾ä¹¦é¦†çœ‹ä¹¦ã€ç‹¬è‡ªä¸€äººåƒé¥­ã€ç‹¬è‡ªä¸€äººå»è‡ªä¹ å®¤ï¼Œæ„Ÿè§‰å’Œç°åœ¨æ²¡æœ‰å¤ªå¤šå·®åˆ«ï¼Œåªä¸è¿‡ä»ä¸Šè¯¾å­¦ä¹ æ¢æˆäº†å·¥ä½œæ¬ç –ï¼Œå…¶ä»–æ—¶é—´çš„ç”Ÿæ´»èŠ‚å¥åŸºæœ¬ä¸Šæ²¡æœ‰å¤ªå¤§çš„å˜åŒ–ã€‚</p><p>è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯å°½é‡çš„è¿œç¦»ç¤¾äº¤åª’ä½“ï¼Œä¸è¦è¿‡åº¦åœ°ä¾èµ–å®ƒä»¬ï¼Œæ›´ä¸è¦æ”¾çºµè‡ªå·±ä¸åœåœ°åˆ·æ¨æˆ–è€…çŸ­è§†é¢‘æ¥å¨±ä¹æ¶ˆé£ã€‚å…¶å®è¿™äº›ä¸œè¥¿å¹¶ä¸èƒ½ç»™æˆ‘ä»¬å¸¦æ¥çœŸæ­£æ„ä¹‰ä¸Šçš„å¿«ä¹ï¼Œæœ‰ä¸€éƒ¨çºªå½•ç‰‡ã€Š<a href="https://www.netflix.com/sg-zh/title/81254224" target="_blank" rel="noopener">ç›‘è§†èµ„æœ¬ä¸»ä¹‰ï¼šæ™ºèƒ½é™·é˜±</a>ã€‹é‡Œé¢ä¹Ÿè°ˆåˆ°è¿‡è¿‡åº¦ä¾èµ–ç¤¾äº¤åª’ä½“çš„åæœã€‚</p><h3 id="æ­å·è¿‡å¹´"><a href="#æ­å·è¿‡å¹´" class="headerlink" title="æ­å·è¿‡å¹´"></a>æ­å·è¿‡å¹´</h3><p>å› ä¸ºç–«æƒ…çš„åŸå›  2021 å¹´å°±æ²¡å›å®¶è¿‡å¹´ï¼Œå†åŠ ä¸Šè¶Šæ˜¯å†œæ‘é‚£ç§ç ´åœ°æ–¹é˜²ç–«æªæ–½å°±æ˜¯è¶Šç¦»è°±ï¼Œçœ‹çœ‹ç°åœ¨è¥¿å®‰çš„é˜²ç–«æªæ–½ä½ ä»¬å°±èƒ½æ˜ç™½äº†ä¸ºä»€ä¹ˆä¸æƒ³å›å®¶ã€‚äºæ˜¯å°±æ‡’å¾—æŠ˜è…¾ï¼Œé€‰æ‹©ç‹¬è‡ªä¸€äººç•™åœ¨æ­å·è¿‡å¹´ï¼Œé¡ºä¾¿è¿˜èƒ½é¢†å–æ­å·å¸‚æ”¿åºœçš„ç•™æ­è¡¥è´´ 1000 å—é’±ã€‚æ­å·å¸‚åœ¨è¿™ä¸€å—åšçš„è¿˜çœŸä¸é”™ï¼Œå»å¹´è¿˜é¢†äº†äººæ‰è¡¥è´´çš„ 1w å—é’±ï¼Œä»è€å¤§å“¥æ‰‹é‡Œè–…ç¾Šæ¯›ï¼ŒçœŸé¸¡å„¿åˆºæ¿€ã€‚</p><h3 id="ç¯å¤ªæ¹–éª‘è¡Œ"><a href="#ç¯å¤ªæ¹–éª‘è¡Œ" class="headerlink" title="ç¯å¤ªæ¹–éª‘è¡Œ"></a>ç¯å¤ªæ¹–éª‘è¡Œ</h3><p>ä¸ºäº†ä¸è®©äº”ä¸€å‡æœŸå†åƒè¿‡å¹´é‚£æ ·ä¸€ç›´çƒ‚åœ¨å®¶é‡Œï¼Œå°±ç‹¬è‡ªä¸€äººä»æ­å·éª‘è¡Œåˆ°æ¹–å·ã€å¸¸å·ã€æ— é”¡ã€è‹å·ã€å¤ªæ¹–ä¸€å¸¦æ¸¸ç©ï¼ŒçœŸçš„æ˜¯å¾ˆä¹…æ²¡æœ‰é‚£ä¹ˆå¼€å¿ƒè¿‡äº†ã€‚å›æ¥ä¹‹åè¿˜æ›´æ–°äº†ä¸€ç¯‡åšå®¢ã€Š<a href="https://blog.k8s.li/taihu.html">äº”ä¸€å‡æœŸç¯å¤ªæ¹–éª‘è¡Œä¹‹æ—…</a>ã€‹ï¼Œæ—…ç¨‹çš„é£æ™¯çœŸçš„ä¸é”™ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥å»è¯»ä¸€ä¸‹ã€‚</p><h3 id="ä¸Šæµ·ç§Ÿæˆ¿"><a href="#ä¸Šæµ·ç§Ÿæˆ¿" class="headerlink" title="ä¸Šæµ·ç§Ÿæˆ¿"></a>ä¸Šæµ·ç§Ÿæˆ¿</h3><p>æ–°å·¥ä½œçš„åŠå…¬åœ°ç‚¹æ˜¯åœ¨ä¸Šæµ·ï¼Œå› ä¸ºä¸æ”¯æŒè¿œç¨‹åŠå…¬æ‰€ä»¥ä¸å¾—ä¸ä»æ­å·æ¬å®¶æ¥åˆ°ä¸Šæµ·ã€‚åœ¨ä¸­ä»‹è€å“¥çš„å¸¦é¢†ä¸‹æ‰¾äº†ä¸€ä¸ªæœˆç§Ÿ 3100 å…ƒçš„å§å®¤ + ç‹¬å«çš„æˆ¿å­ï¼ˆåŒ…æ°´ç”µè´¹ï¼‰ï¼Œæ•´ä½“æ„Ÿè§‰ååˆ†æ»¡æ„ã€‚æˆ¿å­æ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯ä¸‰å®¤ä¸€å…ã€‚æˆ‘ä½åœ¨å…¶ä¸­çš„ä¸€ä¸ªå¤§å§å®¤ï¼Œæˆ¿ä¸œä»–çˆ¶æ¯ä½åœ¨å¦ä¸€ä¸ªå§å®¤ï¼Œå‰©ä½™çš„ä¸€ä¸ªå§å®¤æ˜¯ç©ºç€çš„ï¼Œé™¤äº†æˆ‘ä»¥å¤–æ²¡æœ‰å…¶ä»–çš„ç§Ÿå®¢ã€‚å‡ºäºå¯¹è€äººå®‰å…¨çš„è€ƒè™‘ï¼Œæˆ¿ä¸œåªå…è®¸æˆ‘è‡ªå·±ä¸€ä¸ªäººä½ï¼Œä¸èƒ½å¸¦å¤–äººæ¥ã€‚å¯¹æˆ‘æ¥è¯´ä¹Ÿæ²¡å•¥ï¼Œç‹¬æ¥ç‹¬å¾€çš„ç”Ÿæ´»åæ­£ä¹Ÿä¸ä¼šæœ‰å…¶ä»–äººæ¥æ‰¾æˆ‘ç©å„¿ã€‚</p><p>å§å®¤é¢ç§¯ 3.3 * 4.3m=14.19 å¹³ã€ç„å…³ 1.1 * 1m=1.1 å¹³ã€å«ç”Ÿé—´ 2.3 * 2.1m=4.38 å¹³ã€‚åŠ èµ·æ¥æ€»å…±å·®ä¸å¤š 20 å¹³ã€‚æ„Ÿè§‰è¿™ä¸ªé¢ç§¯æ„Ÿè§‰æ¯”æ­å·é‚£ä¸ªå¸¦é˜³å°çš„å§å®¤å¤§å¾ˆå¤šã€‚ä¸€ä¸ª 1.5 * 2m çš„åºŠã€é å¢™å†æ”¾ç½®ä¸¤å¼  60* 120 cm çš„å®œå®¶æ¡Œå­ã€åºŠçš„å³ä¾§åˆèƒ½æ”¾ä¸‹ä¸€å¼  0.6 * 1.4m ç±³çš„ä¹¦æ¡Œï¼Œè¿˜æœ‰ä¸€ä¸ª 0.5 *2m çš„è¡£æŸœã€‚</p><p>ç°åœ¨ç»ˆäºä½ä¸Šäº†è‡ªå·±æ‰€æœŸå¾…çš„é‚£ç§æˆ¿å­ï¼Œå›æƒ³èµ·å¤§å­¦åˆšæ¯•ä¸šé‚£ä¸€å¹´ä½çš„è¿˜æ˜¯ 300 å—é’±çš„ä¸Šä¸‹é“ºé’æ—…ï¼Œå°±æ„Ÿè§‰å½“æ—¶ååˆ†å¯’é…¸ ğŸ˜­ã€‚</p><p><img src="https://p.k8s.li/image-20220103165850671.png" alt="image-20220103165850671"></p><p>æˆ¿é—´é‡Œè¿˜æœ‰ä¸€ä¸ªå¸¦ä¹¦æ¶çš„ç”µè„‘æ¡Œï¼Œæ”¾ä¸‹ä¸€ä¸ª 27 å¯¸çš„æ˜¾ç¤ºå™¨åˆšåˆšå¥½ã€‚å¦å¤–æŠŠæˆ‘é‚£å° HPE Gen10 Plus æœåŠ¡å™¨å®‰ç½®åœ¨äº†ä¹¦æ¡Œä¸‹é¢ã€‚è™½ç„¶é è¿‘åºŠå¤´ï¼Œä½† NAS é‡Œç¡¬ç›˜çš„å™ªéŸ³è¿˜ç®—èƒ½æ¥å—ï¼Œä¸è‡³äºåµå¾—ç¡ä¸ç€è§‰ã€‚æœ‰æ—¶å€™åœ¨æƒ³è¦ä¸è¦æ•´ä¸ª 12U çš„æœºæŸœæ¥ç€ï¼Œä½†è§„åˆ’äº†ä¸€ä¸‹æ„Ÿè§‰è¿˜æ˜¯æ²¡æœ‰å¤ªå¤§çš„å¿…è¦ï¼Œå…ˆè¿™æ ·å‡‘æ´»ç€ç”¨å§ã€‚</p><p><img src="https://p.k8s.li/image-20220103202406765.jpg" alt="IMG_2177"></p><p>æ¬è¿›æ¥ä¹‹åçš„ç¬¬äºŒå¤©åœ¨é—²é±¼ä¸ŠèŠ±äº† 300 å—é’±æ¡æ¥äº†ä¸€ä¸ªåŸä»· 1699 çš„ç±³å®¶æ‰«åœ°æœºå™¨äººï¼ŒåˆèŠ±äº† 200 å—é’±æ¡äº†ä¸€ä¸ªç±³å®¶ç©ºæ°”å‡€åŒ–å™¨ï¼ˆè´«ç©·å¦‚æˆ‘ï¼Œåªèƒ½é æ¡å’Œè–…æ¥æå‡ç”Ÿæ´»å¹¸ç¦æ„Ÿäº†ï¼‰ã€‚æ„Ÿè§‰è¿™ä¸¤ä¸ªå®¶ç”¨ç”µå™¨è¿˜æ˜¯æŒºå€¼çš„ï¼Œæ‰«åœ°æœºå™¨äººçœå»äº†æ‰“æ‰«å«ç”Ÿçš„éº»çƒ¦äº‹å„¿ï¼Œç”Ÿæ´»å¹¸ç¦æ„Ÿ +++ã€‚</p><h2 id="2022"><a href="#2022" class="headerlink" title="2022"></a>2022</h2><p>å°±åƒä½œå®¶æ–¹æ–¹æ‰€è¯´çš„é‚£æ ·ï¼š<a href="http://fangfang.blog.caixin.com/archives/220746" target="_blank" rel="noopener">æ—¶ä»£çš„ä¸€ç²’ç°ï¼Œè½åœ¨ä¸ªäººå¤´ä¸Šå°±æ˜¯ä¸€åº§å±±</a> ã€‚å¤–å©†åœ¨ 2020 å¹´æ–°å† ç–«æƒ…åˆšçˆ†å‘çš„é‚£æ®µæ—¶é—´ä¸å¹¸ç¦»å¼€äº†è¿™ä¸ªä¸–ç•Œï¼Œè€Œé‚£æ®µæ—¶é—´çš„ç»å†ä¹Ÿå½»åº•æ”¹å˜äº†æˆ‘çœ‹å¾…ç”Ÿæ­»çš„æƒ³æ³•ã€‚ä»¿ä½›ä¸€åˆ‡éƒ½æ²¡æœ‰é‚£ä¹ˆé‡è¦äº†ï¼Œä¹Ÿè®©æˆ‘æ·±åˆ»åœ°æ˜ç™½äº†<strong>è¿™ä¸ªä¸–ç•Œä¸Šæ²¡æœ‰ä»€ä¹ˆä¸œè¥¿æ— æ³•ä¸èƒ½å¤±å»çš„ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆéå¾—å¿…é¡»è¦å¾—åˆ°çš„</strong>ã€‚å³ä¾¿æ˜¯æŸä¸€å¤©æˆ‘ä¸å¹¸å»ä¸–ï¼Œä¹Ÿæ²¡æœ‰å¤ªå¤šé—æ†¾å’Œæ‚”æ¨ã€‚æ‰€ä»¥å»ä»–çš„æœªæ¥è®¡åˆ’ï¼Œå’Œå¾€å¸¸ä¸€æ ·å¥½å¥½æ¬ç –å·¥ä½œå’Œçœ‹ä¹¦å­¦ä¹ ï¼Œè¿™æ ·å°±å¤Ÿäº†ã€‚</p><p>å¦å¤–ç¥å¤§å®¶æ–°çš„ä¸€å¹´å¿«å¿«ä¹ä¹ ğŸ¥³</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;2021
        
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Tencent Cloud lighthouse Firewall tool</title>
    <link href="https://blog.k8s.li/cfwctl.html"/>
    <id>https://blog.k8s.li/cfwctl.html</id>
    <published>2021-12-14T16:00:00.000Z</published>
    <updated>2021-12-14T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šæ¬¡å»åŒ—äº¬å‡ºå·®ï¼Œä¸ºäº†ä¾¿æ·åœ°è®¿é—®å®¶é‡Œå†…ç½‘ä¸­çš„ä¸€äº›æœåŠ¡ï¼Œå°±åœ¨è…¾è®¯äº‘æœåŠ¡å™¨ä¸Šéƒ¨ç½²äº†ä¸€ä¸ª frps æœåŠ¡ï¼Œåœ¨æœ¬åœ°å†…ç½‘çš„ Openwrt è·¯ç”±å™¨ä¸Šå®‰è£… frpc å®¢æˆ·ç«¯ï¼Œå°†å†…ç½‘ä¸­çš„ä¸€å° Windows æœåŠ¡å™¨ç©¿é€åˆ°è…¾è®¯äº‘æœåŠ¡å™¨ä¸Šã€‚ç„¶åé€šè¿‡ Windows RDP è¿œç¨‹è¿æ¥åˆ°è¿™å° Windows æœºå™¨ä¸Šï¼Œæ¥ä½¿ç”¨å†…ç½‘çš„ä¸€äº›æœåŠ¡ã€‚ä¹‹å‰ä¹Ÿå°è¯•è¿‡ WireGuardï¼Œä½†æ˜¯ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´ä½“éªŒä¸‹æ¥æ„Ÿè§‰è¿˜æ˜¯é€šè¿‡å†…ç½‘ç©¿é€çš„æ–¹å¼æ¯”è¾ƒç¨³å®šå’Œæµç•…ã€‚äºæ˜¯æœ€ç»ˆçš„æ–¹å¼è¿˜æ˜¯é€‰ç”¨ frp å†…ç½‘ç©¿é€çš„æ–¹æ¡ˆã€‚</p><p>æœ¬ç€æ–¹ä¾¿çœäº‹å„¿çš„åŸåˆ™å°±æ”¾å¿ƒå¤§èƒ†åœ°å¼€æ”¾äº†äº‘æœåŠ¡å™¨çš„å®‰å…¨ç»„è§„åˆ™ã€‚ä¸å¹¸çš„æ˜¯ï¼Œç”±äºè¿™æ ·çš„ç–å¿½ï¼ŒæŸä¸€å¤©æˆ‘çš„ Windows è™šæ‹Ÿæœºè¢«å¼±å£ä»¤ï¼ˆadmin2020ï¼‰ç»™çˆ†ç ´äº†ã€‚å·¨å¤§çš„æŸå¤±å°±æ˜¯æŒ‚è½½åˆ° Windows è™šæ‹Ÿæœºä¸Šçš„ NAS å­˜å‚¨è¢«å‹’ç´¢ç—…æ¯’è¿›è¡Œäº†åŠ å¯† ğŸ˜‚ã€‚ä¸è¿‡å¥½åœ¨æœ€æœ€é‡è¦çš„æ•°æ®å…¨éƒ¨å­˜åˆ°äº† OneDrive ä¸Šï¼ŒNAS ä¸ŠæŸå¤±çš„éƒ½æ˜¯ä¸€äº›ä¸‹è½½çš„ç”µå½±ã€ä¹¦ç±ä»¥åŠä¸€äº› ISOã€è™šæ‹Ÿæœºæ¨¡ç‰ˆä¹‹ç±»çš„æ–‡ä»¶ã€‚ä¸€ä¸‹å­æŸå¤±äº† 8TB çš„æ•°æ®å¾ˆå¿ƒç–¼ï¼Œæ¯•ç«Ÿæ˜¯è‡ªå·±è¾›è¾›è‹¦è‹¦æœé›†çš„èµ„æºï¼Œä½†æ˜¯ä»”ç»†æƒ³ä¸€ä¸‹ï¼Œè¿™äº›èµ„æºéƒ½ä¸æ˜¯è‡ªå·±çš„ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ä»ä¸‹è½½ä¸‹æ¥çš„ï¼Œè¿˜å¯ä»¥é€šè¿‡åŒæ ·çš„æ–¹å¼æ‰¾å›æ¥ã€‚æˆ–è®¸æ˜¯ä¹‹å‰çœ‹è¿‡ã€Šæ–­èˆç¦»ã€‹çš„ç¼˜æ•…ï¼Œä¹Ÿçœ‹çš„å¼€äº†ï¼Œéš¾å—äº†ä¸€å°ä¼šå„¿ä¹‹åå°±å¥½è¿‡æ¥äº†ã€‚æ¯•ç«Ÿè¿™ä¸ªä¸–ç•Œä¸Šï¼Œæ²¡æœ‰æ— æ³•ä¸èƒ½å¤±å»çš„ä¸œè¥¿ï¼Œä¹Ÿæ²¡æœ‰éå¾—å¿…é¡»è¦å¾—åˆ°çš„ä¸œè¥¿ã€‚</p><p>æœ‰äº†æ­¤æ¬¡æ•™è®­ï¼Œå°±å¼€å§‹è€ƒè™‘å¯¹æ‰‹ä¸Šçš„äº‘ä¸»æœºèµ„æºè¿›è¡Œå®‰å…¨åŠ å›ºï¼Œå°†ä¸€äº›ä¸å†…ç½‘äº’é€šçš„äº‘ä¸»æœºå®‰å…¨ç»„/é˜²ç«å¢™çš„é€šç”¨å»é™¤äº†å…è®¸æ‰€æœ‰ï¼Œåªæ·»åŠ æœ¬åœ°å…¬ç½‘ IP çš„å…è®¸è§„åˆ™ã€‚ä½†æ˜¯å¯¹äºå®¶åº­å®½å¸¦ç”¨æˆ·æ¥è®²ï¼Œå…¬ç½‘ IP å¹¶ä¸æ˜¯ä¸€ä¸ªå›ºå®šçš„ IPï¼Œè€Œæ˜¯ä¼šä¸€ç›´ä¸æ–­å˜åŒ–ï¼Œæ€»ä¸èƒ½æ¯æ¬¡å˜åŒ–ä¹‹åå†ç™»å½•åˆ°äº‘ä¸»æœºæ§åˆ¶å°æ‰‹åŠ¨æ·»åŠ ä¸€ä¸‹å§ã€‚äºæ˜¯å°±æƒ³ç€æœ‰æ²¡æœ‰è‡ªåŠ¨åŒ–çš„æ–¹å¼æ¥è‡ªåŠ¨æ·»åŠ å’Œæ›´æ–°å®‰å…¨ç»„/é˜²ç«å¢™è§„åˆ™å‘¢ï¼Ÿ</p><h2 id="Terraform"><a href="#Terraform" class="headerlink" title="Terraform"></a>Terraform</h2><p>ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„æ–¹æ¡ˆä¾¿æ˜¯ terraformï¼Œä¸»æµçš„äº‘å‚å•†éƒ½æœ‰å¯¹åº”çš„ provider æ”¯æŒï¼Œè…¾è®¯äº‘åº”è¯¥ä¹Ÿæ˜¯èƒ½å¤Ÿæ”¯æŒçš„ã€‚ä¸è¿‡çœ‹äº†å®˜æ–¹çš„ <a href="https://github.com/tencentcloudstack/terraform-provider-tencentcloud" target="_blank" rel="noopener">terraform-provider-tencentcloud</a> repo æ–‡æ¡£ä¹‹åï¼Œå¹¶æ²¡æœ‰æ‰¾åˆ°ç»™ lighthouse ä¸»æœºé…ç½®é˜²ç«å¢™è§„åˆ™çš„æ”¯æŒï¼Œé‚æ”¾å¼ƒã€‚</p><h2 id="cfwctl"><a href="#cfwctl" class="headerlink" title="cfwctl"></a>cfwctl</h2><p>æ—¢ç„¶ terraform ä¸æ”¯æŒï¼Œé‚£å°±è‡ªå·±é€ è½®å­å†™ä¸€ä¸ªå§ï¼Œå°±å«å®ƒ Cloud Firewall Control Toolï¼Œç®€ç§° <a href="https://github.com/muzi502/cfwctl" target="_blank" rel="noopener">cfwctl</a>ã€‚è…¾è®¯äº‘å®˜æ–¹çš„ API æ–‡æ¡£è¿˜å¯ä»¥ï¼Œè¿˜èƒ½åœ¨çº¿ç”Ÿæˆä»£ç ï¼Œç”¨èµ·æ¥ä¹Ÿååˆ†æ–¹ä¾¿ã€‚è€ƒè™‘åˆ°ä¼šå°†è¯¥å·¥å…·è¿è¡Œåˆ°è¿è¡Œåˆ° arm64 çš„è·¯ç”±å™¨ä¸Šï¼Œå› æ­¤è·¨å¹³å°è¿è¡Œ cfwctl ä½¿ç”¨ golang æ¥å®ç°æ— ç–‘æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œæ­£å¥½ä¹Ÿèƒ½æ¥ç»ƒç»ƒæ‰‹ã€‚</p><p>æ‰§è¡Œçš„æ“ä½œå…¶å®å¾ˆç®€å•ï¼Œå…ˆæ˜¯é€šè¿‡æŸç§æ–¹å¼è·å–æœ¬åœ°æœºå™¨çš„å…¬ç½‘ IPï¼Œç„¶åå°†è¯¥ IP æ·»åŠ åˆ°å¯¹åº”å®ä¾‹çš„é˜²ç«å¢™è§„åˆ™å½“ä¸­ï¼Œå¹¶åœ¨è§„åˆ™æè¿°ä¸­æ·»åŠ æ ‡è¯†ç¬¦æ¥æ ‡è®°ã€‚ç›®å‰è‡ªå·±åªéœ€è¦æ·»åŠ è§„åˆ™ï¼Œå…ˆå‡‘æ´»ç€ç”¨ä¸€æ®µæ—¶é—´ï¼Œçœ‹ä¸‹æ•ˆæœå¦‚ä½•ã€‚ç›®å‰åªæ”¯æŒè…¾è®¯äº‘çš„ lighthouse å®ä¾‹ï¼Œåç»­æœ‰æœºä¼šå†å¢åŠ å‡ ä¸ªåˆ«çš„äº‘å‚å•†æ”¯æŒã€‚</p><h3 id="è·å–å…¬ç½‘-IP"><a href="#è·å–å…¬ç½‘-IP" class="headerlink" title="è·å–å…¬ç½‘ IP"></a>è·å–å…¬ç½‘ IP</h3><p>é¦–å…ˆè¦è·å–åˆ°æˆ‘ä»¬æœ¬åœ°ç½‘è·¯çš„å…¬ç½‘ IPï¼Œç”±äºå…¬ç½‘ IP å¯èƒ½ä¸€ç›´æ˜¯å˜åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡æ›´æ–°é˜²ç«å¢™è§„åˆ™ä¹‹å‰éƒ½éœ€è¦è·å–æœ€æ–°çš„å…¬ç½‘ IPã€‚ä»¥ä¸‹æ˜¯å…·ä½“å®ç°çš„ä»£ç ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"io/ioutil"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"><span class="string">"regexp"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰ IPv4 çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œç›®çš„æ˜¯ä»è·å–å…¬ç½‘ IP çš„  API è¿”å›ç»“æœä¸­è¿‡æ»¤å‡º IPv4 åœ°å€</span></span><br><span class="line"><span class="keyword">const</span> ipv4_regex = <span class="string">`(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))&#123;3&#125;`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰å‡ ä¸ªå‡ ä¸ªæä¾›è·å–å…¬ç½‘ IPv4 åœ°å€çš„ API URL</span></span><br><span class="line"><span class="keyword">var</span> urlList = []<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"https://ip.me"</span></span><br><span class="line"><span class="string">"http://ip.sb"</span>,</span><br><span class="line"><span class="string">"http://ip.cip.cc"</span>,</span><br><span class="line"><span class="string">"http://myip.ipip.net"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetPublicIP</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, url := <span class="keyword">range</span> urlList &#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ª http client</span></span><br><span class="line">client := &amp;http.Client&#123;&#125;</span><br><span class="line">    <span class="comment">// è®¾ç½® client çš„è¯·æ±‚æ–¹æ³•ä¸º GET ä»¥åŠè¯·æ±‚çš„ URL</span></span><br><span class="line">request, err := http.NewRequest(<span class="string">"GET"</span>, url, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// è®¾ç½® Client çš„ User-Agent ä¸º curlï¼Œä¸ç„¶ä¸€äº› API ä¼šè¿”å› html çš„ç»“æœ</span></span><br><span class="line">request.Header.Set(<span class="string">"User-Agent"</span>, <span class="string">"curl/7.54.0"</span>)</span><br><span class="line">resp, err := client.Do(request)</span><br><span class="line"><span class="keyword">if</span> resp.StatusCode != <span class="number">200</span> &amp;&amp; err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">body, err := ioutil.ReadAll(resp.Body)</span><br><span class="line">    <span class="comment">// ä» API è¿”å›ç»“æœä¸­ç”¨æ­£åˆ™åŒ¹é…å‡º IPv4 åœ°å€</span></span><br><span class="line">reg := regexp.MustCompile(ipv4_regex)</span><br><span class="line">ipList := reg.FindAllString(<span class="keyword">string</span>(body), <span class="number">-1</span>)</span><br><span class="line">    <span class="comment">// å¦‚æœåŒ¹é…ç»“æœä¸­æœ‰ IPv4 åœ°å€ï¼Œåˆ™è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ å³å¯</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(ipList) &gt; <span class="number">0</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"my public ip is %s\n"</span>, ipList[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">return</span> ipList[<span class="number">0</span>]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ -Firewall-è§„åˆ™"><a href="#æ·»åŠ -Firewall-è§„åˆ™" class="headerlink" title="æ·»åŠ  Firewall è§„åˆ™"></a>æ·»åŠ  Firewall è§„åˆ™</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/common"</span></span><br><span class="line"><span class="string">"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/common/errors"</span></span><br><span class="line"><span class="string">"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/common/profile"</span></span><br><span class="line">lighthouse <span class="string">"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/lighthouse/v20200324"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰ API è¯·æ±‚çš„ URL</span></span><br><span class="line"><span class="keyword">const</span> endpoint = <span class="string">"lighthouse.tencentcloudapi.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰è¯·æ±‚ API çš„ Client ç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> &#123;</span><br><span class="line">SecretId  <span class="keyword">string</span></span><br><span class="line">SecretKey <span class="keyword">string</span></span><br><span class="line">InstaceId <span class="keyword">string</span></span><br><span class="line">Region    <span class="keyword">string</span></span><br><span class="line">Endpoint  <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡è¯¥æ–¹æ³•ä»ç¯å¢ƒå˜é‡ä¸­è¯»å– Ck Sk ç­‰ä¿¡æ¯ï¼Œå¹¶è¿”å›ä¸€ä¸ª client å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewClient</span><span class="params">()</span> <span class="title">Client</span></span> &#123;</span><br><span class="line">client := Client&#123;</span><br><span class="line">SecretId:  os.Getenv(<span class="string">"TENCENTCLOUD_SECRET_ID"</span>),</span><br><span class="line">SecretKey: os.Getenv(<span class="string">"TENCENTCLOUD_SECRET_KEY"</span>),</span><br><span class="line">InstaceId: os.Getenv(<span class="string">"TENCENTCLOUD_INSTANCE_ID"</span>),</span><br><span class="line">Region:    os.Getenv(<span class="string">"TENCENTCLOUD_REGION"</span>),</span><br><span class="line">Endpoint:  endpoint,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> client.SecretId == <span class="string">""</span> || client.SecretKey == <span class="string">""</span> || client.InstaceId == <span class="string">""</span> || client.Region == <span class="string">""</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">"Please set TENCENTCLOUD_SECRET_ID, TENCENTCLOUD_SECRET_KEY, TENCENTCLOUD_INSTANCE_ID, TENCENTCLOUD_REGION"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®šä¹‰æ·»åŠ é˜²ç«å¢™è§„åˆ™çš„æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Client)</span> <span class="title">AddRules</span><span class="params">(firewallRules []*lighthouse.FirewallRule)</span></span> &#123;</span><br><span class="line">credential := common.NewCredential(c.SecretId, c.SecretKey)</span><br><span class="line">cpf := profile.NewClientProfile()</span><br><span class="line">cpf.HttpProfile.Endpoint = endpoint</span><br><span class="line">client, _ := lighthouse.NewClient(credential, c.Region, cpf)</span><br><span class="line"></span><br><span class="line">request := lighthouse.NewCreateFirewallRulesRequest()</span><br><span class="line">request.InstanceId = common.StringPtr(c.InstaceId)</span><br><span class="line">request.FirewallRules = firewallRules</span><br><span class="line"></span><br><span class="line">response, err := client.CreateFirewallRules(request)</span><br><span class="line"><span class="keyword">if</span> _, ok := err.(*errors.TencentCloudSDKError); ok &#123;</span><br><span class="line">fmt.Printf(<span class="string">"An API error has returned: %s"</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">"%s"</span>, response.ToJsonString())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è·å–é˜²ç«å¢™è§„åˆ™"><a href="#è·å–é˜²ç«å¢™è§„åˆ™" class="headerlink" title="è·å–é˜²ç«å¢™è§„åˆ™"></a>è·å–é˜²ç«å¢™è§„åˆ™</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Client)</span> <span class="title">GetRules</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">credential := common.NewCredential(c.SecretId, c.SecretKey)</span><br><span class="line">cpf := profile.NewClientProfile()</span><br><span class="line">cpf.HttpProfile.Endpoint = endpoint</span><br><span class="line">client, _ := lighthouse.NewClient(credential, c.Region, cpf)</span><br><span class="line"></span><br><span class="line">request := lighthouse.NewDescribeFirewallRulesRequest()</span><br><span class="line"></span><br><span class="line">request.InstanceId = common.StringPtr(c.InstaceId)</span><br><span class="line"></span><br><span class="line">response, err := client.DescribeFirewallRules(request)</span><br><span class="line"><span class="keyword">if</span> _, ok := err.(*errors.TencentCloudSDKError); ok &#123;</span><br><span class="line">fmt.Printf(<span class="string">"An API error has returned: %s"</span>, err)</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> response.ToJsonString()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><ul><li>åœ¨æœ¬åœ°çš„ <code>~/.bashrc</code> æˆ–è€… <code>~/.zshrc</code> æ–‡ä»¶ä¸­è®¾ç½®ä¸€äº› AKSK ä¿¡æ¯ã€å®ä¾‹ IDã€region ä¿¡æ¯ç­‰å‚æ•°ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> TENCENTCLOUD_SECRET_ID=<span class="string">"AKiiiplQntjJbcMp1"</span></span><br><span class="line"><span class="built_in">export</span> TENCENTCLOUD_SECRET_KEY=<span class="string">"SKkkkiiwwlwjmmG5"</span></span><br><span class="line"><span class="built_in">export</span> TENCENTCLOUD_INSTANCE_ID=<span class="string">"lhins-qjxazjaa"</span></span><br><span class="line"><span class="built_in">export</span> TENCENTCLOUD_REGION=<span class="string">"ap-beijing"</span></span><br></pre></td></tr></table></figure><ul><li>è®¾ç½®å¥½ç¯å¢ƒå˜é‡ä¹‹åï¼Œå†ç¼–è¯‘è¿è¡Œçœ‹ä¸‹èƒ½å¦æˆåŠŸ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ go build -o cfwctl</span><br><span class="line">$ chmod +x cfwctl</span><br><span class="line">$ cfwctl add</span><br><span class="line"></span><br><span class="line">my public ip is 193.191.231.82</span><br><span class="line">&#123;<span class="string">"Response"</span>:&#123;<span class="string">"RequestId"</span>:<span class="string">"30e71243-1793-112e-9e41-b310ec599b90"</span>&#125;&#125;%</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœæ˜¯ arm64 çš„ OpenWrt ç¯å¢ƒï¼Œåœ¨æœ¬åœ°å¼€å‘æœºä¸Šè¿›è¡Œè·¨å¹³å°ç¼–è¯‘ï¼Œç„¶åå°†ç¼–è¯‘å¥½çš„ cfwctl äºŒè¿›åˆ¶æ–‡ä»¶ scp åˆ°è·¯ç”±å™¨ä¸Šï¼Œå†æ·»åŠ  cron job å®šæ—¶ä»»åŠ¡å³å¯ï¼Œè¿™æ ·å°±èƒ½è‡ªåŠ¨å®šæ—¶æ›´æ–°é˜²ç«å¢™è§„åˆ™æ¥ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ CGO_ENABLED=0  GOOS=linux  GOARCH=arm64 go build -o cfwctl</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ä¸Šæ¬¡å»åŒ—äº¬å‡ºå·®ï¼Œä¸ºäº†ä¾¿æ·åœ°è®¿é—®å®¶é‡Œå†…ç½‘ä¸­çš„ä¸€äº›æœåŠ¡ï¼Œå°±åœ¨è…¾
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="äº‘æœåŠ¡å™¨" scheme="https://blog.k8s.li/tags/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>Python å¤„ç† kindle æ ‡æ³¨æ–‡æœ¬</title>
    <link href="https://blog.k8s.li/python-kindle.html"/>
    <id>https://blog.k8s.li/python-kindle.html</id>
    <published>2021-11-29T16:00:00.000Z</published>
    <updated>2022-03-15T00:55:12.743Z</updated>
    
    <content type="html"><![CDATA[<h2 id="kindle-æ ‡æ³¨"><a href="#kindle-æ ‡æ³¨" class="headerlink" title="kindle æ ‡æ³¨"></a>kindle æ ‡æ³¨</h2><p>å¤§å­¦æ¯•ä¸šä¹‹åä¸å†åƒåœ¨æ ¡æ—¶é‚£æ ·èƒ½éšä¾¿å»å›¾ä¹¦é¦†çœ‹ä¹¦ï¼Œå°±ä»ä¼ ç»Ÿçº¸è´¨ä¹¦çš„é˜…è½¬æ¢åˆ°äº† kindle ä¸Šæ¥ã€‚è¿™ä¸¤å¹´å°±ä¸€ç›´ä¹ æƒ¯ä½¿ç”¨ kindle æ¥çœ‹ä¹¦ï¼Œè¯»ä¹¦è¿‡ç¨‹ä¸­é‡åˆ°ä¸€äº›ä¸é”™çš„å¥å­æˆ–æ®µè½å¾€å¾€ä¼šæ ‡æ³¨è®°å½•ä¸‹æ¥ã€‚è¿™æ ·æ—¶é—´ä¸€é•¿ï¼Œç°åœ¨çš„ Kindle ä¸Šå°±ç§¯ç´¯äº† å…± 189 æœ¬ä¹¦å’Œ 3522 æ¡ç¬”è®° ğŸ˜‚ã€‚æœ¬äººæœ‰ä¸ªä¹ æƒ¯å°±æ˜¯ä¼šè¿›è¡Œç¬”è®°æ•´ç†ï¼Œé€šè¿‡è¿™äº›æ ‡æ³¨æ¥å›å¿†å½“æ—¶è¯»ä¹¦æ—¶çš„ä¸€äº›æƒ³æ³•ï¼Œæ•´ç†ä¸€ä¸‹è¯»ä¹¦ç¬”è®°ã€‚Kindle æ ‡æ³¨çš„æ–‡æœ¬éƒ½æ˜¯ä»¥ txt æ ¼å¼æ–¹å¼å­˜å‚¨åœ¨ Kindle çš„ <code>/documents/My Clippings.txt</code> æ–‡ä»¶ä¸­ã€‚ç”±äº txt æ ¼å¼çš„æ–‡æœ¬æ•°æ®é˜…è¯»èµ·æ¥å®åœ¨æ˜¯å¤ªè´¹åŠ²äº†ï¼Œäºæ˜¯ä¹‹å‰å‚è€ƒäº† <a href="https://github.com/cyang812/kindleNote" target="_blank" rel="noopener">kindleNote</a> å’Œ <a href="https://bookfere.com/tools#ClippingsFere" target="_blank" rel="noopener">ä¹¦ä¼´ç½‘ Clippings Fere å·¥å…·</a> ç¼åˆäº†ä¸€ä¸ªå·¥å…· <strong><a href="https://github.com/muzi502/kindle" target="_blank" rel="noopener">muzi502/kindle</a></strong>ã€‚ç”¨å®ƒæ¥å°† txt æ ¼å¼çš„æ ‡æ³¨æ–‡æœ¬æ¸²æŸ“æˆ html çš„æ ¼å¼ã€‚è¿™æ ·æ¯ä¸€æœ¬ä¹¦å°±èƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„ html é¡µé¢æ¥å±•ç¤ºæ ‡æ³¨çš„å†…å®¹ï¼Œé˜…è¯»èµ·æ¥å°±ååˆ†æ–¹ä¾¿ã€‚æœ€è¿‘èŠ±äº†ç‚¹æ—¶é—´é‡æ„äº†ä¸€ä¸‹è¯¥å·¥å…·ï¼Œå¹¶æ–°å¢äº† svg æ—¥å†å›¾çš„ç”Ÿæˆæ–¹å¼ï¼Œæœ¬æ–‡å°±ä»‹ç»ä¸€ä¸‹è¿™ä¸ªå·¥å…·çš„å®ç°æ€è·¯å’Œæ–¹æ³•ã€‚</p><h2 id="åˆ†éš”"><a href="#åˆ†éš”" class="headerlink" title="åˆ†éš”"></a>åˆ†éš”</h2><p>ç”±äº Kindle çš„æ ‡æ³¨æ–‡æœ¬æœ‰ä¸€å®šçš„è§„å¾‹å¯å¾ªï¼Œå®ç°èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒæ–¹ä¾¿æ»´ã€‚å¤§è‡´æ€è·¯å°±æ˜¯å…ˆè¯»å– Kindle çš„æ ‡æ³¨æ–‡ä»¶ <code>My Clippings.txt</code>ï¼Œç„¶åæ ¹æ®åˆ†éš”ç¬¦ <code>==========</code> åˆ†å‰²æ¯ä¸€ä¸ªæ ‡æ³¨ï¼›æ¯ä¸ªæ ‡æ³¨åŒ…å«ç€ä¹¦åã€æ ‡æ³¨æ—¶é—´ã€æ ‡æ³¨å†…å®¹ç­‰ä¿¡æ¯ï¼Œè§„å¾‹å¦‚ä¸‹ï¼š</p><ul><li>ç¬¬ä¸€è¡Œï¼šä¹¦ç±çš„åç§°ä»¥åŠä½œè€…ï¼Œå¯ä»¥ä»¥åŠè§’æ‹¬å·æ¥æ‹†åˆ†å‡ºä¹¦åå’Œä½œè€…ï¼›</li><li>ç¬¬äºŒè¡Œï¼šæ ‡æ³¨çš„ä½ç½®å’Œæ—¶é—´ï¼Œä»¥ <code>|</code> æ‹†åˆ†å‡ºæ ‡æ³¨ä½ç½®å’Œæ ‡æ³¨æ—¶é—´ï¼›</li><li>ç¬¬ä¸‰è¡Œï¼šç©ºè¡Œï¼Œå¯ä»¥å°†è¿™ä¸€è¡Œå»é™¤æ‰ï¼Œå³å–å‡ºæ ‡æ³¨æ–‡ä»¶ä¸­æ‰€æœ‰çš„ç©ºè¡Œï¼›</li><li>ç¬¬å››è¡Œï¼šæ ‡æ³¨æ–‡æœ¬å†…å®¹ï¼ŒKindle æ ‡æ³¨çš„æ­£æ–‡æ˜¯æ²¡æœ‰æ¢è¡Œçš„ï¼Œå³ä¾¿æ˜¯è¿ç»­æ ‡æ³¨äº†å‡ æ®µä¹Ÿéƒ½ä¼šå‹ç¼©åœ¨ä¸€è¡Œé‡Œé¢ï¼›</li><li>ç¬¬äº”è¡Œï¼š å³åˆ†éš”ç¬¦ <code>==========</code> ï¼Œæ‰€æœ‰çš„æ ‡æ³¨éƒ½æ˜¯ä»¥å®ƒæ¥è¿›è¡Œåˆ†éš”ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">å¨±ä¹è‡³æ­» ([ç¾]å°¼å°”Â·æ³¢å…¹æ›¼)</span><br><span class="line">- æ‚¨åœ¨ä½ç½® <span class="comment">#109-110çš„æ ‡æ³¨ | æ·»åŠ äº 2019å¹´10æœˆ27æ—¥æ˜ŸæœŸæ—¥ ä¸‹åˆ11:09:01</span></span><br><span class="line"></span><br><span class="line">ç”µè§†éœ€è¦çš„å†…å®¹å’Œå…¶ä»–åª’ä½“æˆªç„¶ä¸åŒã€‚ç”µè§†æ— æ³•è¡¨ç°æ”¿æ²»å“²å­¦ï¼Œç”µè§†çš„å½¢å¼æ³¨å®šäº†å®ƒåŒæ”¿æ²»å“²å­¦æ˜¯æ°´ç«ä¸ç›¸å®¹çš„ã€‚</span><br><span class="line">==========</span><br><span class="line">å¨±ä¹è‡³æ­» ([ç¾]å°¼å°”Â·æ³¢å…¹æ›¼)</span><br><span class="line">- æ‚¨åœ¨ä½ç½® <span class="comment">#110-112çš„æ ‡æ³¨ | æ·»åŠ äº 2019å¹´10æœˆ27æ—¥æ˜ŸæœŸæ—¥ ä¸‹åˆ11:09:19</span></span><br><span class="line"></span><br><span class="line">ä¿¡æ¯ã€å†…å®¹ï¼Œæˆ–è€…å¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥ç§°ä¹‹ä¸ºæ„æˆâ€œä»Šæ—¥æ–°é—»â€çš„â€œç´ æâ€ï¼Œåœ¨ä¸€ä¸ªç¼ºä¹åª’ä»‹çš„ä¸–ç•Œé‡Œæ˜¯ä¸å­˜åœ¨çš„â€”â€”æ˜¯ä¸èƒ½å­˜åœ¨çš„ã€‚</span><br><span class="line">==========</span><br><span class="line">å¨±ä¹è‡³æ­» ([ç¾]å°¼å°”Â·æ³¢å…¹æ›¼)</span><br><span class="line">- æ‚¨åœ¨ä½ç½® <span class="comment">#114-115çš„æ ‡æ³¨ | æ·»åŠ äº 2019å¹´10æœˆ27æ—¥æ˜ŸæœŸæ—¥ ä¸‹åˆ11:09:52</span></span><br><span class="line"></span><br><span class="line">ç”µæŠ¥ä½¿æ— èƒŒæ™¯çš„ä¿¡æ¯èƒ½å¤Ÿä»¥éš¾ä»¥ç½®ä¿¡çš„é€Ÿåº¦è·¨è¶Šå¹¿é˜”çš„ç©ºé—´ã€‚</span><br><span class="line">==========</span><br><span class="line">é€šå¾€å¥´å½¹ä¹‹è·¯ (å¼—é‡Œå¾·é‡Œå¸ŒÂ·å¥¥å¤æ–¯ç‰¹Â·å†¯Â·å“ˆè€¶å…‹)</span><br><span class="line">- æ‚¨åœ¨ä½ç½® <span class="comment">#259-261çš„æ ‡æ³¨ | æ·»åŠ äº 2019å¹´11æœˆ8æ—¥æ˜ŸæœŸäº” ä¸‹åˆ12:50:33</span></span><br><span class="line"></span><br><span class="line">åœ¨å®‰æ’æˆ‘ä»¬çš„äº‹åŠ¡æ—¶ï¼Œåº”è¯¥å°½å¯èƒ½å¤šåœ°è¿ç”¨è‡ªå‘çš„ç¤¾ä¼šåŠ›é‡ï¼Œè€Œå°½å¯èƒ½å°‘åœ°å€ŸåŠ©äºå¼ºåˆ¶ï¼Œè¿™ä¸ªåŸºæœ¬åŸåˆ™èƒ½å¤Ÿä½œåƒå˜ä¸‡åŒ–çš„åº”ç”¨ã€‚æ·±æ€ç†Ÿè™‘åœ°åˆ›é€ ä¸€ç§ä½¿ç«äº‰èƒ½å°½å¯èƒ½åœ°æœ‰ç›Šè¿›è¡Œçš„ä½“åˆ¶ï¼Œå’Œè¢«åŠ¨åœ°æ¥å—æ—¢å®šçš„åˆ¶åº¦ï¼ŒäºŒè€…ä¹‹é—´çš„å·®åˆ«å°¤å…¶æ‚¬æ®Šã€‚</span><br><span class="line">==========</span><br><span class="line">é€šå¾€å¥´å½¹ä¹‹è·¯ (å¼—é‡Œå¾·é‡Œå¸ŒÂ·å¥¥å¤æ–¯ç‰¹Â·å†¯Â·å“ˆè€¶å…‹)</span><br><span class="line">- æ‚¨åœ¨ä½ç½® <span class="comment">#312-318çš„æ ‡æ³¨ | æ·»åŠ äº 2019å¹´11æœˆ8æ—¥æ˜ŸæœŸäº” ä¸‹åˆ12:54:46</span></span><br><span class="line"></span><br><span class="line">å°½ç®¡ç»å¤§éƒ¨åˆ†çš„æ–°æ€æƒ³ï¼Œå°¤å…¶æ˜¯ç¤¾ä¼šä¸»ä¹‰ï¼Œå¹¶éèµ·æºäºå¾·å›½ï¼Œä½†æ­£æ˜¯åœ¨å¾·å›½å®ƒä»¬å¾—åˆ°å®Œå–„ï¼Œå¹¶åœ¨19ä¸–çºªçš„æœ€å25å¹´å’Œ20ä¸–çºªçš„æœ€åˆ25å¹´ï¼Œå¾—åˆ°æœ€å……åˆ†çš„å‘å±•ã€‚ç°åœ¨ï¼Œäººä»¬å¸¸å¸¸å¿½ç•¥äº†ï¼Œå¾·å›½åœ¨è¿™ä¸€æ—¶æœŸç¤¾ä¼šä¸»ä¹‰çš„ç†è®ºå’Œå®é™…çš„å‘å±•ä¸­èµ·äº†å¤šä¹ˆå·¨å¤§çš„é¢†å¯¼ä½œç”¨ï¼›åœ¨ç¤¾ä¼šä¸»ä¹‰æˆä¸ºè¿™ä¸ªå›½å®¶çš„ä¸€ä¸ªä¸¥é‡é—®é¢˜ä»¥å‰çš„é‚£ä¸€ä»£ï¼Œå¾·å›½å›½ä¼šä¸­å·²æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç¤¾ä¼šä¸»ä¹‰æ”¿å…šï¼›å¹¶ä¸”åœ¨ä¸ä¹…ä»¥å‰ï¼Œç¤¾ä¼šä¸»ä¹‰å­¦è¯´çš„å‘å±•ï¼Œå‡ ä¹å®Œå…¨æ˜¯åœ¨å¾·å›½å’Œå¥¥åœ°åˆ©è¿›è¡Œçš„ï¼Œä»¥è‡´äºä»Šå¤©ä¿„å›½äººçš„è®¨è®ºï¼Œåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä»å¾·å›½äººä¸­æ­¢çš„åœ°æ–¹è¿›è¡Œçš„ï¼›ç»å¤§éƒ¨åˆ†è‹±å›½çš„ç¤¾ä¼šä¸»ä¹‰è€…å°šæœªæ„è¯†åˆ°ï¼Œä»–ä»¬æ‰å¼€å§‹å‘ç°çš„å¤§å¤šæ•°é—®é¢˜ï¼Œå¾·å›½ç¤¾ä¼šä¸»ä¹‰è€…å¾ˆæ—©ä»¥å‰å·²å½»åº•è®¨è®ºè¿‡äº†ã€‚</span><br><span class="line">==========</span><br><span class="line">è§è¯†åŸé‚¦Â·ç«¥å¹´çš„æ¶ˆé€ï¼ˆåª’ä»‹æ–‡åŒ–ç ”ç©¶å¤§å¸ˆå°¼å°”Â·æ³¢å…¹æ›¼20å¹´ç»å…¸ç•…é”€ä½œå“ï¼‰ (å°¼å°”Â·æ³¢å…¹æ›¼)</span><br><span class="line">- æ‚¨åœ¨ä½ç½® <span class="comment">#536-539çš„æ ‡æ³¨ | æ·»åŠ äº 2019å¹´11æœˆ21æ—¥æ˜ŸæœŸå›› ä¸Šåˆ6:47:26</span></span><br><span class="line"></span><br><span class="line">åˆ—å¥¥Â·æ´›æ–‡å¡”å°”ï¼ˆLeo Lowenthalï¼‰è¯´é“ï¼šâ€œè‡ªä»æ–‡è‰ºå¤å…´ä»¥æ¥ï¼Œå…³äºäººç±»æœ¬æ€§çš„æ™®éå“²å­¦æ˜¯å»ºç«‹åœ¨è¿™æ ·çš„æ„æƒ³ä¹‹ä¸Šçš„ï¼šæ¯ä¸ªä¸ªäººéƒ½æ˜¯ç¦»ç»å›é“è€…ã€‚åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šï¼Œä¸ªäººçš„å­˜åœ¨å°±åœ¨äºåšæŒä¸ªæ€§ï¼Œåå¯¹ç¤¾ä¼šçš„é™åˆ¶å’Œè§„èŒƒè¦æ±‚ã€‚â€</span><br><span class="line">==========</span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆå®šä¹‰ä¸€ä¸ªä¹¦ç±åˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ ä¸ºä¸€ä¸ªå­—å…¸ï¼Œå­—å…¸ä¸­è®°å½•çš„ä¿¡æ¯å¦‚ä¸‹ï¼š</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"name"</span>: book_name,</span><br><span class="line">    <span class="attr">"author"</span>: book_author,</span><br><span class="line">    <span class="attr">"url"</span>: book_url,</span><br><span class="line">    <span class="attr">"nums"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"marks"</span>: [],</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>æ¯æœ¬ä¹¦çš„æ ‡æ³¨åˆ—è¡¨</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"time"</span>: mark_time,</span><br><span class="line">    <span class="attr">"address"</span>: mark_address,</span><br><span class="line">    <span class="attr">"content"</span>: mark_content</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>è½¬æ¢åçš„ json æ ¼å¼</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"å¨±ä¹è‡³æ­» "</span>,</span><br><span class="line">    <span class="attr">"author"</span>: <span class="string">"å°¼å°”Â·æ³¢å…¹æ›¼"</span>,</span><br><span class="line">    <span class="attr">"url"</span>: <span class="string">"dd0875de349e84eb7e6a2402c64bd95a"</span>,</span><br><span class="line">    <span class="attr">"nums"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"marks"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"time"</span>: <span class="string">" æ·»åŠ äº 2019å¹´10æœˆ27æ—¥æ˜ŸæœŸæ—¥ ä¸‹åˆ11:09:01"</span>,</span><br><span class="line">        <span class="attr">"address"</span>: <span class="string">"æ‚¨åœ¨ä½ç½® #109-110çš„æ ‡æ³¨"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"ç”µè§†éœ€è¦çš„å†…å®¹å’Œå…¶ä»–åª’ä½“æˆªç„¶ä¸åŒã€‚ç”µè§†æ— æ³•è¡¨ç°æ”¿æ²»å“²å­¦ï¼Œç”µè§†çš„å½¢å¼æ³¨å®šäº†å®ƒåŒæ”¿æ²»å“²å­¦æ˜¯æ°´ç«ä¸ç›¸å®¹çš„ã€‚"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"time"</span>: <span class="string">" æ·»åŠ äº 2019å¹´10æœˆ27æ—¥æ˜ŸæœŸæ—¥ ä¸‹åˆ11:09:19"</span>,</span><br><span class="line">        <span class="attr">"address"</span>: <span class="string">"æ‚¨åœ¨ä½ç½® #110-112çš„æ ‡æ³¨"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"ä¿¡æ¯ã€å†…å®¹ï¼Œæˆ–è€…å¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥ç§°ä¹‹ä¸ºæ„æˆâ€œä»Šæ—¥æ–°é—»â€çš„â€œç´ æâ€ï¼Œåœ¨ä¸€ä¸ªç¼ºä¹åª’ä»‹çš„ä¸–ç•Œé‡Œæ˜¯ä¸å­˜åœ¨çš„â€”â€”æ˜¯ä¸èƒ½å­˜åœ¨çš„ã€‚"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"time"</span>: <span class="string">" æ·»åŠ äº 2019å¹´10æœˆ27æ—¥æ˜ŸæœŸæ—¥ ä¸‹åˆ11:09:52"</span>,</span><br><span class="line">        <span class="attr">"address"</span>: <span class="string">"æ‚¨åœ¨ä½ç½® #114-115çš„æ ‡æ³¨"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"ç”µæŠ¥ä½¿æ— èƒŒæ™¯çš„ä¿¡æ¯èƒ½å¤Ÿä»¥éš¾ä»¥ç½®ä¿¡çš„é€Ÿåº¦è·¨è¶Šå¹¿é˜”çš„ç©ºé—´ã€‚"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"é€šå¾€å¥´å½¹ä¹‹è·¯ "</span>,</span><br><span class="line">    <span class="attr">"author"</span>: <span class="string">"å¼—é‡Œå¾·é‡Œå¸ŒÂ·å¥¥å¤æ–¯ç‰¹Â·å†¯Â·å“ˆè€¶å…‹"</span>,</span><br><span class="line">    <span class="attr">"url"</span>: <span class="string">"646a2a825b48c4c9df653a42aa72b702"</span>,</span><br><span class="line">    <span class="attr">"nums"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"marks"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"time"</span>: <span class="string">" æ·»åŠ äº 2019å¹´11æœˆ8æ—¥æ˜ŸæœŸäº” ä¸‹åˆ12:50:33"</span>,</span><br><span class="line">        <span class="attr">"address"</span>: <span class="string">"æ‚¨åœ¨ä½ç½® #259-261çš„æ ‡æ³¨"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"åœ¨å®‰æ’æˆ‘ä»¬çš„äº‹åŠ¡æ—¶ï¼Œåº”è¯¥å°½å¯èƒ½å¤šåœ°è¿ç”¨è‡ªå‘çš„ç¤¾ä¼šåŠ›é‡ï¼Œè€Œå°½å¯èƒ½å°‘åœ°å€ŸåŠ©äºå¼ºåˆ¶ï¼Œè¿™ä¸ªåŸºæœ¬åŸåˆ™èƒ½å¤Ÿä½œåƒå˜ä¸‡åŒ–çš„åº”ç”¨ã€‚æ·±æ€ç†Ÿè™‘åœ°åˆ›é€ ä¸€ç§ä½¿ç«äº‰èƒ½å°½å¯èƒ½åœ°æœ‰ç›Šè¿›è¡Œçš„ä½“åˆ¶ï¼Œå’Œè¢«åŠ¨åœ°æ¥å—æ—¢å®šçš„åˆ¶åº¦ï¼ŒäºŒè€…ä¹‹é—´çš„å·®åˆ«å°¤å…¶æ‚¬æ®Šã€‚"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"time"</span>: <span class="string">" æ·»åŠ äº 2019å¹´11æœˆ8æ—¥æ˜ŸæœŸäº” ä¸‹åˆ12:54:46"</span>,</span><br><span class="line">        <span class="attr">"address"</span>: <span class="string">"æ‚¨åœ¨ä½ç½® #312-318çš„æ ‡æ³¨"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"å°½ç®¡ç»å¤§éƒ¨åˆ†çš„æ–°æ€æƒ³ï¼Œå°¤å…¶æ˜¯ç¤¾ä¼šä¸»ä¹‰ï¼Œå¹¶éèµ·æºäºå¾·å›½ï¼Œä½†æ­£æ˜¯åœ¨å¾·å›½å®ƒä»¬å¾—åˆ°å®Œå–„ï¼Œå¹¶åœ¨19ä¸–çºªçš„æœ€å25å¹´å’Œ20ä¸–çºªçš„æœ€åˆ25å¹´ï¼Œå¾—åˆ°æœ€å……åˆ†çš„å‘å±•ã€‚ç°åœ¨ï¼Œäººä»¬å¸¸å¸¸å¿½ç•¥äº†ï¼Œå¾·å›½åœ¨è¿™ä¸€æ—¶æœŸç¤¾ä¼šä¸»ä¹‰çš„ç†è®ºå’Œå®é™…çš„å‘å±•ä¸­èµ·äº†å¤šä¹ˆå·¨å¤§çš„é¢†å¯¼ä½œç”¨ï¼›åœ¨ç¤¾ä¼šä¸»ä¹‰æˆä¸ºè¿™ä¸ªå›½å®¶çš„ä¸€ä¸ªä¸¥é‡é—®é¢˜ä»¥å‰çš„é‚£ä¸€ä»£ï¼Œå¾·å›½å›½ä¼šä¸­å·²æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç¤¾ä¼šä¸»ä¹‰æ”¿å…šï¼›å¹¶ä¸”åœ¨ä¸ä¹…ä»¥å‰ï¼Œç¤¾ä¼šä¸»ä¹‰å­¦è¯´çš„å‘å±•ï¼Œå‡ ä¹å®Œå…¨æ˜¯åœ¨å¾·å›½å’Œå¥¥åœ°åˆ©è¿›è¡Œçš„ï¼Œä»¥è‡´äºä»Šå¤©ä¿„å›½äººçš„è®¨è®ºï¼Œåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯ä»å¾·å›½äººä¸­æ­¢çš„åœ°æ–¹è¿›è¡Œçš„ï¼›ç»å¤§éƒ¨åˆ†è‹±å›½çš„ç¤¾ä¼šä¸»ä¹‰è€…å°šæœªæ„è¯†åˆ°ï¼Œä»–ä»¬æ‰å¼€å§‹å‘ç°çš„å¤§å¤šæ•°é—®é¢˜ï¼Œå¾·å›½ç¤¾ä¼šä¸»ä¹‰è€…å¾ˆæ—©ä»¥å‰å·²å½»åº•è®¨è®ºè¿‡äº†ã€‚"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"è§è¯†åŸé‚¦Â·ç«¥å¹´çš„æ¶ˆé€"</span>,</span><br><span class="line">    <span class="attr">"author"</span>: <span class="string">"å°¼å°”Â·æ³¢å…¹æ›¼"</span>,</span><br><span class="line">    <span class="attr">"url"</span>: <span class="string">"1e1c307ca9d857c047d33df2a808e557"</span>,</span><br><span class="line">    <span class="attr">"nums"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"marks"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"time"</span>: <span class="string">" æ·»åŠ äº 2019å¹´11æœˆ21æ—¥æ˜ŸæœŸå›› ä¸Šåˆ6:47:26"</span>,</span><br><span class="line">        <span class="attr">"address"</span>: <span class="string">"æ‚¨åœ¨ä½ç½® #536-539çš„æ ‡æ³¨"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"åˆ—å¥¥Â·æ´›æ–‡å¡”å°”ï¼ˆLeo Lowenthalï¼‰è¯´é“ï¼šâ€œè‡ªä»æ–‡è‰ºå¤å…´ä»¥æ¥ï¼Œå…³äºäººç±»æœ¬æ€§çš„æ™®éå“²å­¦æ˜¯å»ºç«‹åœ¨è¿™æ ·çš„æ„æƒ³ä¹‹ä¸Šçš„ï¼šæ¯ä¸ªä¸ªäººéƒ½æ˜¯ç¦»ç»å›é“è€…ã€‚åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šï¼Œä¸ªäººçš„å­˜åœ¨å°±åœ¨äºåšæŒä¸ªæ€§ï¼Œåå¯¹ç¤¾ä¼šçš„é™åˆ¶å’Œè§„èŒƒè¦æ±‚ã€‚â€"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="txt-to-json"><a href="#txt-to-json" class="headerlink" title="txt to json"></a>txt to json</h2><p>æœ‰äº†ä¸Šé¢çš„æ€è·¯ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ Kindle çš„æ ‡æ³¨æ–‡æœ¬è¿›è¡Œå¤„ç†ã€‚å…ˆå°† txt æ ¼å¼çš„æ–‡æœ¬è½¬æ¢æˆ json ç»“æ„åŒ–çš„æ•°æ®ã€‚ç„¶åå†ä½¿ç”¨è¿™ä¸ªç»“æ„åŒ–çš„ json è¿›è¡Œåç»­çš„å¤„ç†æ“ä½œã€‚å¯¹äºæ–‡æœ¬çš„å¤„ç†ï¼Œé€‰æ‹© Python æ¯”è¾ƒåˆé€‚ã€‚å› ä¸ºåœ¨ Python ä¸­å­—ç¬¦ä¸²å¯¹è±¡æœ‰å¾ˆå¤šæ“ä½œæ–¹æ³•ï¼Œæ¯”å¦‚åˆ†å‰²ã€åŒ¹é…ã€æ›¿æ¢ç­‰ç­‰ï¼Œéƒ½è¦æ¯”å…¶ä»–è¯­è¨€æ–¹ä¾¿ä¸€äº›ï¼›ä»¥ä¸‹å°±æ˜¯å…·ä½“å®ç°çš„ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰åˆ†éš”ç¬¦</span></span><br><span class="line">DELIMITER = <span class="string">u"==========\n"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‰ç…§åˆ†éš”ç¬¦å¯¹æ‰€æœ‰æ ‡æ³¨è¿›è¡Œåˆ†å‰²ï¼Œå¹¶å­˜æ”¾åœ¨è¯¥æ•°ç»„ä¸­</span></span><br><span class="line">all_marks = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‰ç…§ä¹¦ç±æ¥å¯¹æ ‡æ³¨è¿›è¡Œåˆ†ç»„å­˜æ”¾</span></span><br><span class="line">all_books = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€ä¸ªå‡½æ•°ç”¨äºè·å–å½“å‰ä¹¦ç±åœ¨ all_books åˆ—è¡¨ä¸­çš„ç´¢å¼•</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_book_index</span><span class="params">(book_name)</span>:</span></span><br><span class="line">    <span class="string">"""get book's index"""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(all_books)):</span><br><span class="line">        <span class="keyword">if</span> all_books[i][<span class="string">"name"</span>] == book_name:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="comment"># å¦‚æœä¹¦ç±å¹¶ä¸å­˜åœ¨ï¼Œè¯´æ˜è¿˜æ²¡æœ‰æ’å…¥è¯¥å…ƒç´ ï¼Œå°±å°†è¯¥å…ƒç´ æ’å…¥åˆ°æœ€åä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰æ¸²æŸ“å¤„ç†æ ‡æ³¨æ–‡æœ¬çš„å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_clippings</span><span class="params">(file_name)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> all_marks</span><br><span class="line">    <span class="keyword">global</span> all_books</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»¥ utf-8 æ ¼å¼æ‰“å¼€æ ‡æ³¨æ–‡ä»¶å¹¶å¹¶å°†å†…å®¹è¯»å–åˆ° content å˜é‡ä¸­</span></span><br><span class="line">    <span class="keyword">with</span> open(file_name, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹è¯»å…¥çš„å†…å®¹å»é™¤ç©ºè¡Œï¼Œå³å°† '\n\n' æ›¿æ¢ä¸º '\n'ï¼Œæ–¹ä¾¿åç»­å¤„ç†</span></span><br><span class="line">    content = content.replace(<span class="string">"\n\n"</span>, <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹å»é™¤ç©ºè¡Œçš„å†…å®¹ä»¥åˆ†éš”ç¬¦è¿›è¡Œåˆ†éš”ï¼Œå¾—åˆ°çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ å°±æ˜¯ä¸€ä¸ªæ ‡æ³¨</span></span><br><span class="line">    all_marks = content.split(DELIMITER)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(all_marks)):</span><br><span class="line">        <span class="comment"># ä»¥æ¢è¡Œç¬¦è¿›è¡Œåˆ†éš”ï¼Œå°†æ¯ä¸ªæ ‡æ³¨æ‹†åˆ†æˆå››ä¸ªå…ƒç´ </span></span><br><span class="line">        mark = all_marks[i].split(<span class="string">"\n"</span>)</span><br><span class="line">        <span class="comment"># å¦‚æœè¯¥æ ‡æ³¨ä¸­å…ƒç´ çš„æ•°é‡ä¸º 4 è¯´æ˜å°±æ˜¯ä¸€ä¸ªæ­£ç¡®çš„æ ‡æ³¨ï¼Œå¦åˆ™å°±æ˜¯æ— æ•ˆçš„</span></span><br><span class="line">        <span class="keyword">if</span> len(mark) == <span class="number">4</span>:</span><br><span class="line"></span><br><span class="line">          <span class="comment"># å¯¹æ ‡æ³¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå³ä¹¦åéƒ¨åˆ†è¿›è¡Œ md5 è®¡ç®—ï¼Œç”¨äºå°†å®ƒè®¾ç½®ä¸ºåç»­çš„ url è·¯å¾„ï¼Œä»¥åŠ html æ–‡ä»¶å</span></span><br><span class="line">            book_url = md5(mark[<span class="number">0</span>].encode(<span class="string">"utf-8"</span>)).hexdigest()</span><br><span class="line">            <span class="comment"># å»é™¤æ‰ä¹¦åä¸­ä¸€äº›ç‰¹æ®Šçš„å­—ç¬¦ï¼Œç”¨æ¥æ‹†åˆ†å‡ºç®€çŸ­çš„ä¹¦å</span></span><br><span class="line">            book_info = re.split(<span class="string">r"[()&lt;&gt;|\[\]ï¼ˆï¼‰ã€Šã€‹ã€ã€‘ï½œ]\s*"</span>, mark[<span class="number">0</span>])</span><br><span class="line">            <span class="comment"># è·å–ä¹¦åï¼Œä¸€èˆ¬ä¸ºç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œç›®çš„æ˜¯ä¸ºäº†å»é™¤ kinlde ä¸­æ–‡å•†åº—ä¸‹è½½çš„åˆé•¿åˆè‡­çš„ä¹¦å</span></span><br><span class="line">            book_name = book_info[<span class="number">0</span>] <span class="keyword">if</span> str(book_info[<span class="number">0</span>]) != <span class="string">""</span> <span class="keyword">else</span> (mark[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># è·å–è¯¥ä¹¦çš„ä½œè€…</span></span><br><span class="line">            book_author = book_info[<span class="number">-2</span>] <span class="keyword">if</span> len(book_info) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">            mark_info = mark[<span class="number">1</span>].split(<span class="string">"|"</span>)</span><br><span class="line">  <span class="comment"># è·å–è¯¥ä¹¦çš„æ ‡è®°æ—¶é—´å’Œæ ‡æ³¨ä½ç½®</span></span><br><span class="line">            mark_time = mark_info[<span class="number">1</span>]</span><br><span class="line">            mark_address = mark_info[<span class="number">0</span>].strip(<span class="string">"- "</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># è·å–è¯¥æ ‡æ³¨çš„æ­£æ–‡å†…å®¹</span></span><br><span class="line">            mark_content = mark[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># æŸ¥è¯¢è¯¥ä¹¦çš„åˆ—è¡¨ç´¢å¼•ï¼Œå°†è¯¥æ ‡è®°æ’å…¥åˆ°è¯¥ä¹¦çš„ marks åˆ—è¡¨ä¸­</span></span><br><span class="line">            book_index = get_book_index(book_name)</span><br><span class="line">            <span class="keyword">if</span> book_index == <span class="number">-1</span>:</span><br><span class="line">                all_books.append(</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"name"</span>: book_name,</span><br><span class="line">                        <span class="string">"author"</span>: book_author,</span><br><span class="line">                        <span class="string">"url"</span>: book_url,</span><br><span class="line">                        <span class="string">"nums"</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"marks"</span>: [],</span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line">            all_books[book_index][<span class="string">"marks"</span>].append(</span><br><span class="line">                &#123;<span class="string">"time"</span>: mark_time, <span class="string">"address"</span>: mark_address, <span class="string">"content"</span>: mark_content&#125;</span><br><span class="line">            )</span><br><span class="line">            <span class="comment"># æ›´æ–°è¯¥ä¹¦çš„æ ‡è®°æ•°é‡</span></span><br><span class="line">            all_books[book_index][<span class="string">"nums"</span>] += <span class="number">1</span></span><br><span class="line">    <span class="comment"># ä½¿ç”¨ lambda å‡½æ•°ä»¥æ ‡æ³¨æ•°é‡ä¸º key å¯¹æ‰€æœ‰ä¹¦ç±è¿›è¡Œå€’åºæ’åº</span></span><br><span class="line">    all_books.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">"nums"</span>], reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä»¥ä¸‹å°±æ˜¯å°† all_books åˆ—è¡¨ä»¥ json æ ¼å¼å†™å…¥åˆ°ä¸€ä¸ª json æ–‡ä»¶ä¸­ï¼Œæˆ–è®¸ä¼šæœ‰ä¸€äº›å…¶ä»–çš„ç”¨é€”ï¼Œæ¯”å¦‚å‰ç«¯å±•ç¤º</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        json_str = json.dumps(all_books, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">"clippings.json"</span>, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(json_str)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    file_path = <span class="string">"source.txt"</span> <span class="keyword">if</span> len(sys.argv) == <span class="number">1</span> <span class="keyword">else</span> sys.argv[<span class="number">1</span>]</span><br><span class="line">    render_clippings(file_path)</span><br></pre></td></tr></table></figure><h2 id="json-to-html"><a href="#json-to-html" class="headerlink" title="json to html"></a>json to html</h2><p>æ¥ä¸‹æ¥å†å°†ä¸Šè¿°å¾—åˆ°çš„ json å†…å®¹å†™å…¥åˆ° html æ–‡ä»¶ä¸­ã€‚æ¸²æŸ“ html çš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯é€šè¿‡ jinja2 çš„æ¨¡ç‰ˆè¿›è¡Œæ¸²æŸ“ï¼Œä¸€ç§æ˜¯é€šè¿‡å­—ç¬¦ä¸²æ›¿æ¢æ‹¼å‡‘ html å†…å®¹ã€‚ä¸¤ç§å„æœ‰å„çš„å¥½å¤„ï¼Œjinjia2 å®ç°èµ·æ¥æ¯”è¾ƒä¼˜é›…ä¸€äº›ï¼Œä½†æ˜¯ä¼šå¼•å…¥ä¸€ä¸ª jinjia2 çš„ä¾èµ–ï¼›ç¬¬äºŒç§æ–¹å¼å°±æ— ä»»ä½•ä¾èµ–ï¼Œé€‚ç”¨æ€§å›å¥½ä¸€äº›ï¼›ä¸‹é¢å°±è®²ä¸€ä¸‹ä½¿ç”¨ç¬¬äºŒç§æ–¹å¼çš„å®ç°ï¼›</p><ul><li>å°† html å†…å®¹æŒ‰ç…§å…ƒç´ çš„åˆ†å¸ƒè¿›è¡Œæ‹†åˆ†ï¼Œå®šä¹‰å¦‚ä¸‹å‡ ä¸ªå‡ ä¸ªç‰¹æ®Šçš„å˜é‡</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">HTML_HEAD = <span class="string">"""&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;meta charset="utf-8" /&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt; Kindle è¯»ä¹¦ç¬”è®° &lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;</span></span><br><span class="line"><span class="string">&lt;link href="../style/css/bootstrap.min.css" rel="stylesheet" type="text/css" /&gt;</span></span><br><span class="line"><span class="string">&lt;link href="../style/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css" /&gt;</span></span><br><span class="line"><span class="string">&lt;link href="../style/css/custom.css" rel="stylesheet" type="text/css" /&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">INDEX_TITLE = <span class="string">"""</span></span><br><span class="line"><span class="string">&lt;div class="container"&gt;</span></span><br><span class="line"><span class="string">&lt;header class="header col-md-12"&gt;</span></span><br><span class="line"><span class="string">&lt;div class="page-header"&gt;</span></span><br><span class="line"><span class="string">                &lt;embed src="date.svg" type="image/svg+xml" /&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;&lt;small&gt;&lt;span class="glyphicon glyphicon-book" aria-hidden="true"&gt;&lt;/span&gt; Kindle è¯»ä¹¦ç¬”è®° &lt;/small&gt; &lt;span class="badge"&gt;æ›´æ–°äº UPDATE &lt;/span&gt; &lt;span class="badge"&gt; å…± BOOKS_SUM æœ¬ä¹¦ï¼ŒSENTENCE_SUM æ¡ç¬”è®°&lt;/span&gt;&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/header&gt;</span></span><br><span class="line"><span class="string">&lt;div class="col-md-12"&gt;</span></span><br><span class="line"><span class="string">        &lt;div class="list-group"&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">BOOK_TITLE = <span class="string">"""</span></span><br><span class="line"><span class="string">&lt;div class="container"&gt;</span></span><br><span class="line"><span class="string">&lt;header class="header col-md-12"&gt;</span></span><br><span class="line"><span class="string">&lt;div class="page-header"&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;&lt;small&gt;&lt;span class="glyphicon glyphicon-book" aria-hidden="true"&gt;&lt;/span&gt;BookName&lt;/small&gt; &lt;span class="badge"&gt;&lt;/span&gt;&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/header&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &lt;div class="col-md-2"&gt;</span></span><br><span class="line"><span class="string">&lt;ul class="nav nav-pills nav-stacked go-back"&gt;</span></span><br><span class="line"><span class="string">&lt;li role="presentation" class="active text-center"&gt;</span></span><br><span class="line"><span class="string">&lt;a href="../index.html" style="border-radius: 50%;"&gt;&lt;span class="glyphicon glyphicon-backward" aria-hidden="true"&gt;&lt;/span&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;/ul&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">MARK_CONTENT = <span class="string">"""</span></span><br><span class="line"><span class="string">    &lt;div class="col-md-12"&gt;</span></span><br><span class="line"><span class="string">&lt;article&gt;</span></span><br><span class="line"><span class="string">&lt;div class="panel panel-default"&gt;</span></span><br><span class="line"><span class="string">&lt;div class="panel-body mk88"&gt;&lt;p&gt;SENTENCE_TXT</span></span><br><span class="line"><span class="string">                    &lt;/p&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;div class="panel-footer text-right"&gt;</span></span><br><span class="line"><span class="string">&lt;span class="label label-primary"&gt;&lt;span class="glyphicon glyphicon-tag" aria-hidden="true"&gt;&lt;/span&gt; æ ‡æ³¨&lt;/span&gt;</span></span><br><span class="line"><span class="string">&lt;span class="label label-default"&gt;&lt;span class="glyphicon glyphicon-bookmark" aria-hidden="true"&gt;&lt;/span&gt;SENTENCE_ADDR&lt;/span&gt;</span></span><br><span class="line"><span class="string">&lt;span class="label label-default"&gt;&lt;span class="glyphicon glyphicon-time" aria-hidden="true"&gt;&lt;/span&gt;SENTENCE_TIME&lt;/span&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/article&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">ITEM_CONTENT = <span class="string">"""          &lt;a href="HTML_URL" class="list-group-item"&gt;&lt;span class="glyphicon glyphicon-book" aria-hidden="true"&gt;&lt;/span&gt;HTML_FILE_NAME&lt;span class="glyphicon glyphicon-tag" aria-hidden="true"&gt;SENTENCE_COUNT&lt;/span&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">FOOTER_CONTENT = <span class="string">"""</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure><ul><li>æ¸²æŸ“ index.html æ–‡ä»¶</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_index_html</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"index.html"</span>, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(HTML_HEAD.replace(<span class="string">"../"</span>, <span class="string">""</span>))</span><br><span class="line">        <span class="comment"># æ›¿æ¢ä¹¦ç±çš„æ€»æ•°é‡å’Œæ ‡æ³¨çš„æ€»æ•°é‡</span></span><br><span class="line">        f.write(</span><br><span class="line">            INDEX_TITLE.replace(<span class="string">"SENTENCE_SUM"</span>, str(len(all_marks)))</span><br><span class="line">            .replace(<span class="string">"UPDATE"</span>, time.strftime(<span class="string">"%Y-%m-%d %H:%M"</span>, time.localtime()))</span><br><span class="line">            .replace(<span class="string">"BOOKS_SUM"</span>, str(len(all_books)))</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># æ ¹æ®é¢„å…ˆå®šä¹‰çš„æ ‡è¯†å­—ç¬¦æ›¿æ¢æ¯æœ¬ä¹¦ç±çš„ä¹¦ç±åã€ä½œè€…ã€æ ‡æ³¨æ•°é‡ã€URL</span></span><br><span class="line">        <span class="keyword">for</span> book <span class="keyword">in</span> all_books:</span><br><span class="line">            f.write(</span><br><span class="line">                ITEM_CONTENT.replace(<span class="string">"HTML_URL"</span>, <span class="string">"books/"</span> + book[<span class="string">"url"</span>] + <span class="string">".html"</span>)</span><br><span class="line">                .replace(<span class="string">"HTML_FILE_NAME"</span>, book[<span class="string">"name"</span>] + <span class="string">" ["</span> + book[<span class="string">"author"</span>] + <span class="string">"]"</span>)</span><br><span class="line">                .replace(<span class="string">"SENTENCE_COUNT"</span>, str(book[<span class="string">"nums"</span>]))</span><br><span class="line">            )</span><br><span class="line">        f.write(FOOTER_CONTENT)</span><br></pre></td></tr></table></figure><ul><li>æ¸²æŸ“ book ä¹¦ç±é¡µé¢</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_books_html</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">"books"</span>):</span><br><span class="line">        shutil.rmtree(<span class="string">"books"</span>)</span><br><span class="line">    os.mkdir(<span class="string">"books"</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(all_books)):</span><br><span class="line">        book_url = all_books[i][<span class="string">"url"</span>]</span><br><span class="line">        book_name = all_books[i][<span class="string">"name"</span>]</span><br><span class="line">        book_author = all_books[i][<span class="string">"author"</span>]</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">"books/"</span> + book_url + <span class="string">".html"</span>, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(HTML_HEAD)</span><br><span class="line">            f.write(</span><br><span class="line">                BOOK_TITLE.replace(<span class="string">"BookName"</span>, book_name + <span class="string">" ["</span> + book_author + <span class="string">"]"</span>)</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(len(all_books[i][<span class="string">"marks"</span>])):</span><br><span class="line">                mark = all_books[i][<span class="string">"marks"</span>][j]</span><br><span class="line">                f.write(</span><br><span class="line">                    MARK_CONTENT.replace(<span class="string">"SENTENCE_TXT"</span>, mark[<span class="string">"content"</span>])</span><br><span class="line">                    .replace(<span class="string">"SENTENCE_ADDR"</span>, mark[<span class="string">"address"</span>])</span><br><span class="line">                    .replace(<span class="string">"SENTENCE_TIME"</span>, mark[<span class="string">"time"</span>])</span><br><span class="line">                )</span><br><span class="line">            f.write(FOOTER_CONTENT)</span><br></pre></td></tr></table></figure><h2 id="date-to-svg"><a href="#date-to-svg" class="headerlink" title="date to svg"></a>date to svg</h2><p>å‰æ®µæ—¶é—´çœ‹åˆ° yihong å¤§ä½¬çš„ <strong><a href="https://github.com/yihong0618/GitHubPoster" target="_blank" rel="noopener">GitHubPoster</a></strong> æ”¯æŒäº† json æ ¼å¼çš„æ•°æ®ï¼Œåªè¦æä¾›ç±»ä¼¼ç±»ä¼¼å¦‚ä¸‹æ ¼å¼çš„æ•°æ®ï¼Œå°±å¯ä»¥ç”Ÿæˆç›¸åº”çš„ svg äº†ã€‚çœŸçš„æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„ç‰¹æ€§ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®æ¯å¤©æ ‡è®°çš„æ•°é‡æ¥ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„ svg å›¾äº†ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"2019-05-28"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"2019-06-10"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"2019-07-18"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"2019-07-23"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"2019-07-24"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"2019-07-29"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"2019-08-12"</span>: <span class="number">1</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><blockquote class="twitter-tweet"><p lang="zh" dir="ltr">æ”¯æŒäº†è‡ªå®šä¹‰ json çš„æºæ•°æ®ï¼Œç”Ÿæˆäº†æŸä¸ª tg ç°å……ç¾¤çš„ç¾¤èŠçš„ poster <a href="https://t.co/nhSe3qlVe0" target="_blank" rel="noopener">https://t.co/nhSe3qlVe0</a> <a href="https://t.co/bkijsFDtzC" target="_blank" rel="noopener">pic.twitter.com/bkijsFDtzC</a></p>&mdash; yihong0618 (@yihong0618) <a href="https://twitter.com/yihong0618/status/1466275108952051716?ref_src=twsrc%5Etfw" target="_blank" rel="noopener">December 2, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><ul><li>ç”Ÿæˆ <code>date.json</code> æ•°æ®æ–‡ä»¶</li></ul><p>ç”Ÿæˆä¸€ä¸ª{æ—¥æœŸ: æ•°é‡} æ ¼å¼çš„å­—å…¸å…¶å®æŒºç®€å•ï¼Œä¸è¿‡å¯¹äº kindle æ ‡æ³¨çš„æ—¶é—´æ ¼å¼éœ€è¦ç¨å¾®å¤„ç†ä¸€ä¸‹ï¼Œè½¬æ¢æˆä¸€ä¸ªæ ‡å‡†çš„æ—¶é—´æ ¼å¼ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_date_json</span><span class="params">()</span>:</span></span><br><span class="line">    all_dates = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(all_marks)):</span><br><span class="line">        mark = all_marks[i].split(<span class="string">"\n"</span>)</span><br><span class="line">        <span class="comment"># å¦‚æœä¸€ä¸ªæ ‡æ³¨æœ‰ 4 è¡Œè¯´æ˜å®ƒå°±æ˜¯ä¸€ä¸ªæ­£ç¡®çš„æ ‡æ³¨</span></span><br><span class="line">        <span class="keyword">if</span> len(mark) == <span class="number">4</span>:</span><br><span class="line">            <span class="comment"># ç¬¬äºŒè¡Œå°±æ˜¯æ ‡æ³¨çš„æ—¶é—´ï¼Œä»¥å¹´æœˆæ—¥å…³é”®å­—è¿›è¡Œåˆ†éš”ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ å°±æ˜¯å¹´ï¼Œç¬¬äºŒä¸ªå°±æ˜¯æœˆï¼Œç¬¬ä¸‰ä¸ªå°±æ˜¯æ—¥</span></span><br><span class="line">            date = re.split(<span class="string">r"[å¹´æœˆæ—¥]\s*"</span>,mark[<span class="number">1</span>].split(<span class="string">"|"</span>)[<span class="number">1</span>].split(<span class="string">" "</span>)[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># åœ¨ 1-9 æœˆå‰é¢è¡¥å……ä¸€ä¸ª 0</span></span><br><span class="line">            month = date[<span class="number">1</span>] <span class="keyword">if</span> len(date[<span class="number">1</span>]) == <span class="number">2</span> <span class="keyword">else</span> <span class="string">"0"</span> + date[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># åœ¨ 1-9 æ—¥å‰é¢è¡¥å……ä¸€ä¸ª 0</span></span><br><span class="line">            day = date[<span class="number">2</span>] <span class="keyword">if</span> len(date[<span class="number">2</span>]) == <span class="number">2</span> <span class="keyword">else</span> <span class="string">"0"</span> + date[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># æœ€åæ‹¼å‡‘æˆ 2021-12-05 è¿™æ ·çš„æ—¶é—´æ ¼å¼</span></span><br><span class="line">            date = date[<span class="number">0</span>] + <span class="string">"-"</span> + month + <span class="string">"-"</span> + day</span><br><span class="line"></span><br><span class="line">            <span class="comment"># å¦‚æœå½“å‰æ—¥æœŸæ²¡æœ‰åœ¨å­—å…¸ä¸­ï¼Œåˆ™å°†å®ƒæ·»åŠ åˆ°å­—å…¸ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> date <span class="keyword">not</span> <span class="keyword">in</span> all_dates:</span><br><span class="line">                all_dates[date] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># å¯¹å¤©æ•°çš„ value å€¼è¿›è¡Œè‡ªå¢ 1</span></span><br><span class="line">            all_dates[date] += <span class="number">1</span></span><br><span class="line">    <span class="comment"># å°†æ•°æ®å†™å…¥ json æ–‡ä»¶å½“ä¸­</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        json_str = json.dumps(all_dates, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">"date.json"</span>, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(json_str)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>ç”Ÿæˆå¥½ json æ ¼å¼çš„æ•°æ®ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä½¿ç”¨ GitHubPoster æ¥ç”Ÿæˆç›¸åº”çš„ svg æ–‡ä»¶ã€‚ç”±äº GitHubPoster çš„ä¾èµ–é¡¹å¤ªå¤šï¼Œä¸”è¿˜æ²¡æœ‰æ”¯æŒ docker æ–¹å¼æ¥è¿è¡Œï¼Œåœ¨æœ¬åœ°å®‰è£…ä¹Ÿä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œå› æ­¤ä¸ºäº†æ–¹ä¾¿èµ·è§æˆ‘ä»¬å°†å®ƒæ”¾åœ¨ GitHub action ä¸­è¿è¡Œã€‚è¿™æ ·åªè¦æ¯æ¬¡æ›´æ–°æ ‡æ³¨æ–‡æœ¬çš„æºæ–‡ä»¶å°±å¯ä»¥è‡ªåŠ¨æ›´æ–° html é¡µé¢å¹¶ç”Ÿæˆæœ€æ–°çš„ svg å›¾ç‰‡äº†ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Build</span> <span class="string">kindle</span> <span class="string">note</span> <span class="string">website</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">gh-pages</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Python</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-python@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">python-version:</span> <span class="number">3.6</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="comment"># å®‰è£… github_poster åŠå…¶ä¾èµ–</span></span><br><span class="line">          <span class="string">pip3</span> <span class="string">install</span> <span class="string">-U</span> <span class="string">github_poster</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ç”Ÿæˆ html æ–‡ä»¶</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">.html</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">python3</span> <span class="string">kindle.py</span></span><br><span class="line"></span><br><span class="line">       <span class="comment"># ç”Ÿæˆ svg æ–‡ä»¶</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">svg</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">github_poster</span> <span class="string">json</span> <span class="string">--json_file</span> <span class="string">date.json</span> <span class="string">--year</span> <span class="number">2021</span> <span class="string">--me</span> <span class="string">kindleReading</span> <span class="string">--background-color</span> <span class="string">'#ffffff'</span></span><br><span class="line">          <span class="string">mv</span> <span class="string">OUT_FOLDER/json.svg</span> <span class="string">date.svg</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># è®¾ç½® commit ä¿¡æ¯ä¸º GitHub action botï¼Œå¹¶æäº¤ commit å’Œ push åˆ° origin ä¸Š</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Config</span> <span class="string">git</span> <span class="string">user</span> <span class="string">and</span> <span class="string">user.email</span> <span class="string">and</span> <span class="string">push</span> <span class="string">commit</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">git</span> <span class="string">config</span> <span class="string">user.name</span> <span class="string">github-actions</span></span><br><span class="line">          <span class="string">git</span> <span class="string">config</span> <span class="string">user.email</span> <span class="number">41898282</span><span class="string">+github-actions[bot]@users.noreply.github.com</span></span><br><span class="line">          <span class="string">git</span> <span class="string">add</span> <span class="string">.</span></span><br><span class="line">          <span class="string">git</span> <span class="string">commit</span> <span class="string">-am</span> <span class="string">"Auto build by GitHub Actions $(date)"</span></span><br><span class="line">          <span class="string">git</span> <span class="string">push</span> <span class="string">origin</span> <span class="string">-f</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;kindle-æ ‡æ³¨&quot;&gt;&lt;a
        
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ apcupsd å®Œæˆ UPS æ–­ç”µå ESXi ç¨³å¦¥å…³æœºæ–¹æ¡ˆ</title>
    <link href="https://blog.k8s.li/apcupsd-on-openwrt-with-esxi.html"/>
    <id>https://blog.k8s.li/apcupsd-on-openwrt-with-esxi.html</id>
    <published>2021-10-24T16:00:00.000Z</published>
    <updated>2021-10-24T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="APC-UPS-BK650M2-CH"><a href="#APC-UPS-BK650M2-CH" class="headerlink" title="APC UPS BK650M2-CH"></a>APC UPS BK650M2-CH</h2><p>ä¸Šä¸ªæœˆè¿˜åœ¨æ­å·çš„æ—¶å€™ï¼Œæˆ¿ä¸œå®¶é‡Œçš„ç©ºæ°”å¼€å…³å‡ºç°äº†æ•…éšœï¼Œå¯¼è‡´æ¯å¤©åœç”µåå‡ æ¬¡ï¼Œæˆ‘é‚£ä¸€ç™¾å¤šå—é’±æ¡æ¥çš„åƒåœ¾ UPS æ–­ç”µä¹‹åç»­å‘½ä¸åˆ° 5 åˆ†é’Ÿå°±å‡‰å‡‰äº†ã€‚æ¥åˆ°ä¸Šæµ·æ¢äº†æ–°å®¶åï¼Œå‡†å¤‡èŠ± 500 å…ƒå·¦å³ä¹°ä¸ªå¥½ä¸€ç‚¹çš„ UPSï¼Œç»™æˆ‘çš„ NAS æœåŠ¡å™¨æ‰¾ä¸ªå¥½ä¼´ä¾£ã€‚è¿™æ¬¡çš„ UPS ä¸å†ä¹°ä¸€ç™¾å—é’±çš„åƒåœ¾è´§äº†ï¼Œå®åœ¨æ˜¯å¤ªå‘äººäº†å‘œå‘œå‘œï¼Œé‚£å°åƒåœ¾ UPS å·²ç»åœ¨é—²é±¼ä¸Š 50 åŒ…é‚®å–æ‰äº†ã€‚</p><p>å¸‚é¢ä¸Š 500 å·¦å³çš„ç•…é”€ UPS æ— éå°±æ˜¯æ–½è€å¾· APC çš„ <a href="https://www.apc.com/shop/cn/zh/products/APC-BACK-UPS-BK-650VA-4-2-USB-230V-USB-/P-BK650M2-CH" target="_blank" rel="noopener">BK650M2-CH</a> å’Œå›½äº§å±±ç‰¹çš„ <a href="https://www.santak.com.cn/product/santak-tg-box-ups.html" target="_blank" rel="noopener">TG-BOX 600/850</a> ã€‚ä¸¤è€…ä»·ä½å·®ä¸å¤ªå¤šï¼Œä»é…ç½®ä¸Šæ¥çœ‹  <a href="https://www.santak.com.cn/product/santak-tg-box-ups.html" target="_blank" rel="noopener">TG-BOX 600/850</a> ç¨å¾®å¥½ä¸€ç‚¹ã€‚ä½†è€ƒè™‘åˆ° APC çš„ apcupsd åœ¨ Linux å¹³å°ä¸Šå…¼å®¹æ€§æ¯”è¾ƒå¥½ï¼Œå› æ­¤æˆ‘æœ€ç»ˆè¿˜æ˜¯é€‰æ‹©äº† <a href="https://www.apc.com/shop/cn/zh/products/APC-BACK-UPS-BK-650VA-4-2-USB-230V-USB-/P-BK650M2-CH" target="_blank" rel="noopener">BK650M2-CH</a> ï¼›å¦ä¸€æ–¹é¢è¿˜æ˜¯æœ¬äººä¸å¤ªå–œæ¬¢å’Œä¿¡ä»»å›½äº§è´§ï¼Œè¢«å°ç²‰çº¢çœ‹åˆ°ä¼šä¸ä¼šè¢«éª‚æˆæ¨å›½å…šï¼ˆæ‰‹åŠ¨ç‹—å¤´ã€‚</p><p>ä¹‹å‰åœ¨ä½¿ç”¨åƒåœ¾ UPS çš„æ—¶å€™æœ‰è¿‡ä¸€ä¸ªå¾ˆ low çš„ UPS æ–­ç”µå…³æœº NAS çš„æ–¹æ¡ˆï¼Œå°±æ˜¯é€šè¿‡ ping çš„æ–¹å¼æ¥åˆ¤æ–­æ˜¯å¦åœç”µï¼Œç„¶åå°±é¢„ä¼°ä¸ªæ—¶é—´å°±æ–­ç”µå…³æœºã€‚ä¸è¿‡è¿™ç§æ–¹æ¡ˆä½¿ç”¨èµ·æ¥ååˆ†ä¸æ–¹ä¾¿ï¼Œå°¤å…¶æ˜¯å½“ç½‘ç»œæŠ½é£çš„æ—¶å€™ï¼ŒNAS å°±æ— ç¼˜æ— æ•…åœ°å…³æœºäº†ï¼›æˆ–è€…æœ‰æ—¶å€™ UPS ç”µæ± ç”¨å°½äº†ï¼Œå…³æœºè„šæœ¬è¿˜æ²¡æœ‰è§¦å‘ã€‚å› æ­¤è¿˜æ˜¯éœ€è¦é€šè¿‡ UPS æœ¬èº«çš„ä¸²å£åè®®æ¥è·å–å½“å‰ UPS çš„çŠ¶æ€æ¯”è¾ƒå¥½ä¸€äº›ï¼Œæ¯”ç”¨ ping çš„æ–¹å¼é«˜åˆ°ä¸çŸ¥é“å“ªé‡Œå»äº†ã€‚</p><h2 id="ESXi-USB-ç›´é€šç¿»è½¦"><a href="#ESXi-USB-ç›´é€šç¿»è½¦" class="headerlink" title="ESXi USB ç›´é€šç¿»è½¦"></a>ESXi USB ç›´é€šç¿»è½¦</h2><p>ä½¿ç”¨ UPS è‡ªå¸¦çš„ USB çº¿ç¼†æ’åˆ° NAS ä¸»æœº USB æ¥å£ä¹‹åï¼ŒESXi çš„ USB è®¾å¤‡åˆ—è¡¨é‡Œä¹Ÿèƒ½æ­£ç¡®åœ°è¯†åˆ«åˆ°äº†è¯¥è®¾å¤‡ã€‚ä½†å°†è¯¥è®¾å¤‡æ·»åŠ åˆ° Linux è™šæ‹Ÿæœºä¸Šä¹‹åï¼Œapcupsd å´æ— æ³•è·å–è¯¥ UPS çš„è®¾å¤‡ä¿¡æ¯ï¼Œè€Œä¸”åœ¨å†…æ ¸æ—¥å¿—ä¸­ä¸€ç›´ä¼šå‡ºç° <code>USB disconnect</code> çš„ä¿¡æ¯ï¼Œemmmï¼Œæ€€ç–‘æ˜¯ ESXi ç›´é€š USB çš„é—®é¢˜ï¼Œé‚æ”¾å¼ƒã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[  124.759971] usb 1-2.1: USB disconnect, device number 4</span><br><span class="line">[  126.840674] usb 1-2.1: new full-speed USB device number 5 using uhci_hcd</span><br><span class="line">[  127.364001] usb 1-2.1: New USB device found, idVendor=051d, idProduct=0002, bcdDevice= 1.06</span><br><span class="line">[  127.364006] usb 1-2.1: New USB device strings: Mfr=1, Product=2, SerialNumber=3</span><br><span class="line">[  127.364009] usb 1-2.1: Product: Back-UPS BK650M2-CH FW:294803G -292804G</span><br><span class="line">[  127.364011] usb 1-2.1: Manufacturer: American Power Conversion</span><br><span class="line">[  127.364013] usb 1-2.1: SerialNumber: 9B2118A06920</span><br><span class="line">[  127.403811] hid-generic 0003:051D:0002.0003: hiddev0,hidraw1: USB HID v1.10 Device [American Power Conversion Back-UPS BK650M2-CH FW:294803G -292804G ] on usb-0000:02:01.0-2.1/input0</span><br><span class="line">[  248.394259] usb 1-2.1: USB disconnect, device number 5</span><br><span class="line">[  250.589751] usb 1-2.1: new full-speed USB device number 6 using uhci_hcd</span><br><span class="line">[  251.123039] usb 1-2.1: New USB device found, idVendor=051d, idProduct=0002, bcdDevice= 1.06</span><br><span class="line">[  251.123044] usb 1-2.1: New USB device strings: Mfr=1, Product=2, SerialNumber=3</span><br><span class="line">[  251.123048] usb 1-2.1: Product: Back-UPS BK650M2-CH FW:294803G -292804G</span><br><span class="line">[  251.123050] usb 1-2.1: Manufacturer: American Power Conversion</span><br><span class="line">[  251.123052] usb 1-2.1: SerialNumber: 9B2118A06920</span><br><span class="line">[  251.160223] hid-generic 0003:051D:0002.0004: hiddev0,hidraw1: USB HID v1.10 Device [American Power Conversion Back-UPS BK650M2-CH FW:294803G -292804G ] on usb-0000:02:01.0-2.1/input0</span><br><span class="line">[  268.621010] usb 1-2.1: USB disconnect, device number 6</span><br></pre></td></tr></table></figure><p>ä¸å¹¸ USB ç›´é€šç»™è™šæ‹Ÿæœºçš„æ–¹æ¡ˆç¿»è½¦äº†ï¼Œäºæ˜¯æƒ³ç€è¦ä¸å°† USB çº¿ç¼†è¿æ¥åˆ°æˆ‘çš„ R4S è½¯è·¯ç”±ä¸Š ğŸ¤”ï¸ã€‚è¿æ¥åˆ°è½¯è·¯ç”±ä¸Šè¦æ¯”åœ¨ ESXi ä¸»æœºä¸Šå¥½ä¸€äº›ï¼Œè¿™æ ·åœ¨æ¥ç”µä¹‹åå†™çš„ç›‘æ§è„šæœ¬ä¹Ÿèƒ½æ£€æµ‹åˆ° UPS å·²ç»é€šç”µäº†ï¼Œè¿™æ ·å°±å¯ä»¥è‡ªåŠ¨å¯åŠ¨ NAS ä¸»æœºä»¥åŠä¸Šé¢çš„ä¸€äº› VMã€‚äºæ˜¯å°±ç¢ç£¨äº†ä»¥ä¸‹çš„æ–¹æ¡ˆï¼Œçº¿è·¯å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://p.k8s.li/2021-10-25-apcupsd-on-openwrt-with-esxi.png" alt="image-20211025224325577"></p><p>æˆ‘çš„ NAS æœåŠ¡å™¨ã€äº¤æ¢æœºã€R4S è½¯è·¯ç”±çš„ç”µæºéƒ½è¿æ¥åˆ° UPS ä¸Šã€‚R6300v2 é€šè¿‡æ— çº¿æ¡¥æ¥çš„æ–¹å¼è¿æ¥åˆ°æˆ¿ä¸œå®¶çš„  Wi-Fiã€‚æ— çº¿æ¡¥æ¥ä¹‹åï¼ŒR6300v2 å°±å˜æˆäº†ä¸€å°â€æ— çº¿äº¤æ¢æœºâ€ï¼Œè¿æ¥åˆ°å®ƒçš„è®¾å¤‡å°†ä¼šä»æˆ¿ä¸œå®¶ Wi-Fi è·¯ç”±å™¨çš„ DHCP é‚£é‡Œè·å–åˆ°åŒä¸€ç½‘æ®µçš„ IPã€‚R4S çš„ WAN å£é€šè¿‡ç½‘çº¿è¿æ¥åˆ° R6300v2 çš„ LAN å£ä¸Šï¼Œè¿™æ · R4S å°±èƒ½é€šè¿‡ R6300v2 è¿æ¥åˆ°æˆ¿ä¸œå®¶çš„ Wi-Fiï¼Œä»è€Œè¿æ¥åˆ°å…¬ç½‘ã€‚</p><p>åœ¨è¿™é‡Œ R6300v2 çš„ç”µæºæœªä½¿ç”¨ UPSï¼Œè€Œé€šè¿‡å¸‚ç”µè¿æ¥ï¼Œå› ä¸ºåœç”µä¹‹åä¼°è®¡æˆ¿ä¸œå®¶çš„ Wi-Fi ä¹Ÿè¿ä¸ä¸Šï¼Œè¿æ¥åˆ° UPS ç”µæºæ„ä¹‰ä¸å¤§ï¼Œå…¶å®ä¹Ÿç”¨ä¸å¤šå°‘ç”µã€‚æ–­ç”µä¹‹åï¼Œè¿è¡Œåœ¨ R4S è½¯è·¯ç”±ä¸Šçš„ apcupsd è¿›ç¨‹ä¼šæ¢æµ‹åˆ° UPS ç”µæºå¤„äº offline çš„çŠ¶æ€ã€‚ç­‰åˆ° UPS å‰©ä½™ç”µé‡è¿˜å‰© 30% æ—¶ï¼ˆæˆ–è€…å…¶ä»–è‡ªå®šä¹‰æŒ‡æ ‡ï¼‰å°±è§¦å‘è‡ªå·±å®šä¹‰çš„æ–­ç”µå…³æœºè„šæœ¬ã€‚ç„¶åå‰©ä½™ 30% çš„ç”µé‡å°±ä¾›ç»™ R4S è½¯è·¯ç”±ä½¿ç”¨è‡³å°‘ 5 ä¸ªå°æ—¶ï¼Œè¿™æ®µæ—¶é—´åº”è¯¥å¾ˆå¿«å°±èƒ½æ¥ç”µã€‚ç­‰ç›‘æµ‹åˆ° UPS é€šç”µä¹‹åï¼Œå†è§¦å‘è‡ªå®šä¹‰çš„ UPS æ¥ç”µå¯åŠ¨è„šæœ¬ã€‚</p><p>å¤§è‡´çš„æµç¨‹æ¢³ç†å¥½ä¹‹åï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±å¼€å§‹æäº‹æƒ…ã€‚</p><h2 id="apcupsd-on-openwrt"><a href="#apcupsd-on-openwrt" class="headerlink" title="apcupsd on openwrt"></a>apcupsd on openwrt</h2><p>é¦–å…ˆå°±æ˜¯åœ¨ R4S openwrt ä¸Šå®‰è£…å’Œé…ç½® apcupsdï¼Œå®‰è£…å’Œé…ç½®çš„è¯¦ç»†å†…å®¹å¯å‚è€ƒå‡ ä¸‡å­—çš„å®˜æ–¹æ‰‹å†Œ <a href="http://www.apcupsd.org/manual/" target="_blank" rel="noopener">apcupsd.org/manual</a> ï¼ˆåŠé€€ ğŸ˜‚ã€‚</p><h3 id="å®‰è£…é…ç½®"><a href="#å®‰è£…é…ç½®" class="headerlink" title="å®‰è£…é…ç½®"></a>å®‰è£…é…ç½®</h3><p>å…ˆå°† USP è‡ªå¸¦çš„é‚£æ ¹ USB çº¿ç¼† RJ45 çš„é‚£ä¸€å¤´æŸ¥åˆ° UPS çš„ä¸Šï¼Œå†å°† USB é‚£ä¸€å¤´æ’åˆ°è·¯ç”±å™¨çš„ USB å£ä¸Šã€‚</p><ul><li>å®‰è£… apcupsd ä»¥åŠ usbutils ç­‰ç›¸å…³ä¾èµ–åŒ…</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ OpenWrt in ~ [21:00:20]</span></span><br><span class="line">$ opkg update</span><br><span class="line">$ opkg install usbutils kmod-hid kmod-hid-generic kmod-usb-hid apcupsd</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…å®Œä¹‹åï¼Œä¼šåœ¨ /etc/apcupsd ç›®å½•ä¸‹ç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># root @ OpenWrt in ~ [21:01:32]</span></span><br><span class="line">$ tree /etc/apcupsd</span><br><span class="line">/etc/apcupsd</span><br><span class="line">â”œâ”€â”€ apccontrol <span class="comment"># UPS çŠ¶æ€è§¦å‘è„šæœ¬</span></span><br><span class="line">â”œâ”€â”€ apcupsd.conf <span class="comment"># apcupsd é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ apcupsd_mail.conf <span class="comment"># email å‘é€é…ç½®æ–‡ä»¶ï¼Œæ–­ç”µéƒ½æ–­ç½‘äº†ï¼Œæœ‰å®ƒä¹Ÿæ²¡å•¥ç”¨å‘€</span></span><br><span class="line">â”œâ”€â”€ changeme <span class="comment"># UPS éœ€è¦è¿›è¡Œå……ç”µæ—¶è§¦å‘çš„è„šæœ¬</span></span><br><span class="line">â”œâ”€â”€ commfailure <span class="comment"># è¿æ¥ UPS è®¾å¤‡å¤±è´¥åè§¦å‘çš„è„šæœ¬</span></span><br><span class="line">â”œâ”€â”€ commok <span class="comment"># è¿æ¥ UPS è®¾å¤‡ä¹‹åè§¦å‘çš„è„šæœ¬</span></span><br><span class="line">â”œâ”€â”€ offbattery <span class="comment"># UPS æ¥ç”µä¹‹åè§¦å‘çš„è„šæœ¬</span></span><br><span class="line">â””â”€â”€ onbattery <span class="comment"># æ–­ç”µä¹‹å UPS è¿›å…¥ä½¿ç”¨ç”µæ± çŠ¶æ€åè§¦å‘çš„è„šæœ¬</span></span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <code>lsusb</code> æˆ–è€… <code>dmesg</code> å‘½ä»¤æŸ¥çœ‹ USB è®¾å¤‡æ˜¯å¦æ­£å¸¸è¿æ¥ä»¥åŠå†…æ ¸åŠ è½½ USB è®¾å¤‡çš„ä¿¡æ¯ã€‚å¦‚æœ USB è®¾å¤‡èƒ½æ­£å¸¸è¯†åˆ«åˆ°ï¼Œé‚£å°±æ²¡é—®é¢˜å•¦ã€‚å¦‚æœæ²¡å‡ºç°çš„è¯ï¼Œé‚£å°±é‡å¯å¤§æ³•å¥½ï¼çœ‹çœ‹é‡å¯ä¹‹åèƒ½ä¸èƒ½è¯†åˆ«åˆ° UPS è®¾å¤‡ä¿¡æ¯ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ OpenWrt in ~ [21:04:29]</span></span><br><span class="line">$ lsusb</span><br><span class="line">Bus 005 Device 003: ID 051d:0002 American Power Conversion Uninterruptible Power Supply</span><br><span class="line"><span class="comment"># root @ OpenWrt in ~ [21:04:29]</span></span><br><span class="line">$ dmesg</span><br><span class="line">[   64.485003] usb 5-1: new full-speed USB device number 2 using xhci-hcd</span><br><span class="line">[   64.669133] hid-generic 0003:051D:0002.0001: hiddev96,hidraw0: USB HID v1.10 Device [American Power Conversion Back-UPS BK650M2-CH FW:294803G -292804G ] on usb-xhci-hcd.0.auto-1/input0</span><br><span class="line">[ 1260.590529] usb 5-1: USB disconnect, device number 2</span><br><span class="line">[ 1261.285846] usb 5-1: new full-speed USB device number 3 using xhci-hcd</span><br><span class="line">[ 1261.468989] hid-generic 0003:051D:0002.0002: hiddev96,hidraw0: USB HID v1.10 Device [American Power Conversion Back-UPS BK650M2-CH FW:294803G -292804G ] on usb-xhci-hcd.0.auto-1/input0</span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹ <code>/etc/default/apcupsd</code></li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å› ä¸ºä¸æ˜¯ä½¿ç”¨ systemd å¯åŠ¨ apcupsd çš„ï¼Œéœ€è¦å°†å®ƒä¿®æ”¹ä¸º yes</span></span><br><span class="line"><span class="attr">ISCONFIGURED</span>=<span class="literal">yes</span></span><br></pre></td></tr></table></figure><ul><li>é…ç½® <code>/etc/apcupsd/apcupsd.conf</code></li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…»æˆå¥½ä¹ æƒ¯ï¼Œå…ˆå¤‡ä»½ä¸€ä¸‹è¿œé…ç½®æ–‡ä»¶</span></span><br><span class="line">$ cp /etc/apcupsd/apcupsd.conf&#123;,.bak&#125;</span><br><span class="line">$ vim /etc/apcupsd/apcupsd.conf</span><br><span class="line"><span class="comment"># è‡ªå®šä¹‰ä½ çš„ UPS åç§°ï¼Œä½¿ç”¨é»˜è®¤çš„ä¹Ÿå¯ä»¥</span></span><br><span class="line">UPSNAME BK650M2-CH</span><br><span class="line"><span class="comment"># è®¾ç½® UPS çš„è¿æ¥çº¿ç¼†ä¸º USB æ¨¡å¼</span></span><br><span class="line">UPSCABLE usb</span><br><span class="line"><span class="comment"># è®¾ç½® UPS çš„é€šè®¯æ¨¡å¼ä¸º USB æ¨¡å¼</span></span><br><span class="line">UPSTYPE usb</span><br><span class="line"><span class="comment"># DEVICE è¿™è¡Œéœ€è¦æ³¨é‡Šæ‰æˆ–è€…å»æ‰ /dev/ttyS0</span></span><br><span class="line"><span class="comment"># DEVICE /dev/ttyS0</span></span><br><span class="line">NETSERVER on</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ä¸‹ä¸‰ä¸ªå‚æ•°å®šä¹‰äº†ä½•æ—¶è§¦å‘ doshutdown å…³æœºäº‹ä»¶</span></span><br><span class="line"><span class="comment"># å½“å‰©ä½™ç”µæ± ç”µé‡ä½äºæŒ‡å®šç™¾åˆ†æ¯”</span></span><br><span class="line">BATTERYLEVEL 30</span><br><span class="line"><span class="comment"># å½“UPSå†…éƒ¨è®¡ç®—çš„ç”µæ± å‰©ä½™è¿è¡Œæ—¶é—´ä½äºæŒ‡å®šçš„åˆ†é’Ÿæ•°</span></span><br><span class="line">MINUTES 15</span><br><span class="line"><span class="comment"># å‘ç”Ÿç”µæºæ•…éšœåï¼Œè¿›å…¥ UPS ç”µæ± æ¨¡å¼æ—¶é—´</span></span><br><span class="line">TIMEOUT 0</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶å…·ä½“çš„å‚æ•°ä¿¡æ¯å¯å‚è€ƒå®˜æ–¹æ‰‹å†Œ <a href="http://www.apcupsd.org/manual/#configuration-directive-reference" target="_blank" rel="noopener">configuration-directive-reference</a>ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åªéœ€è¦é…ç½®ä¸Šé¢æˆ‘æåˆ°çš„é‚£å‡ ä¸ªå‚æ•°å°±å¯ä»¥ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ä»”ç»†é˜…è¯»ä¸€äº›å®˜æ–¹æ‰‹å†Œã€‚</p><ul><li>å¼€æœºè‡ªå¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /etc/init.d/apcupsd <span class="built_in">enable</span></span><br><span class="line">$ /etc/init.d/apcupsd start</span><br></pre></td></tr></table></figure><h3 id="UPS-çŠ¶æ€å‚æ•°"><a href="#UPS-çŠ¶æ€å‚æ•°" class="headerlink" title="UPS çŠ¶æ€å‚æ•°"></a>UPS çŠ¶æ€å‚æ•°</h3><ul><li>ä½¿ç”¨ <code>apcaccess</code> æŸ¥çœ‹æ˜¯å¦èƒ½è¿æ¥åˆ° UPS è®¾å¤‡ï¼Œä»¥ä¸‹æ˜¯æ­£å¸¸é€šç”µæ—¶çš„ä¿¡æ¯ï¼š</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ OpenWrt in ~ [21:04:29]</span></span><br><span class="line">$ apcaccess</span><br><span class="line">APC      : 001,036,0860</span><br><span class="line">DATE     : 2021-10-24 21:02:51 +0800</span><br><span class="line">HOSTNAME : OpenWrt</span><br><span class="line">VERSION  : 3.14.14 (31 May 2016) unknown</span><br><span class="line">UPSNAME  : ups1</span><br><span class="line">CABLE    : USB Cable</span><br><span class="line">DRIVER   : USB UPS Driver</span><br><span class="line">UPSMODE  : Stand Alone</span><br><span class="line">STARTTIME: 2021-10-24 21:02:49 +0800</span><br><span class="line">MODEL    : Back-UPS BK650M2-CH</span><br><span class="line">STATUS   : ONLINE</span><br><span class="line">LINEV    : 224.0 Volts</span><br><span class="line">LOADPCT  : 14.0 Percent</span><br><span class="line">BCHARGE  : 100.0 Percent</span><br><span class="line">TIMELEFT : 46.8 Minutes</span><br><span class="line">MBATTCHG : 5 Percent</span><br><span class="line">MINTIMEL : 3 Minutes</span><br><span class="line">MAXTIME  : 0 Seconds</span><br><span class="line">SENSE    : Low</span><br><span class="line">LOTRANS  : 160.0 Volts</span><br><span class="line">HITRANS  : 278.0 Volts</span><br><span class="line">ALARMDEL : 30 Seconds</span><br><span class="line">BATTV    : 13.5 Volts</span><br><span class="line">LASTXFER : No transfers since turnon</span><br><span class="line">NUMXFERS : 0</span><br><span class="line">TONBATT  : 0 Seconds</span><br><span class="line">CUMONBATT: 0 Seconds</span><br><span class="line">XOFFBATT : N/A</span><br><span class="line">SELFTEST : NO</span><br><span class="line">BATTDATE : 2001-01-01</span><br><span class="line">NOMINV   : 220 Volts</span><br><span class="line">NOMBATTV : 12.0 Volts</span><br><span class="line">NOMPOWER : 390 Watts</span><br><span class="line">FIRMWARE : 294803G -292804G</span><br><span class="line">END APC  : 2021-10-24 21:04:36 +0800</span><br></pre></td></tr></table></figure><ul><li>å°è¯•æ‹”ä¸‹ UPS ç”µæºï¼Œæ–­ç”µä¹‹åçš„çŠ¶æ€ä¿¡æ¯</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ OpenWrt in ~ [21:06:39]</span></span><br><span class="line">$ apcaccess</span><br><span class="line">APC      : 001,037,0899</span><br><span class="line">DATE     : 2021-10-24 21:05:33 +0800</span><br><span class="line">HOSTNAME : OpenWrt</span><br><span class="line">VERSION  : 3.14.14 (31 May 2016) unknown</span><br><span class="line">UPSNAME  : ups1</span><br><span class="line">CABLE    : USB Cable</span><br><span class="line">DRIVER   : USB UPS Driver</span><br><span class="line">UPSMODE  : Stand Alone</span><br><span class="line">STARTTIME: 2021-10-24 21:02:49 +0800</span><br><span class="line">MODEL    : Back-UPS BK650M2-CH</span><br><span class="line">STATUS   : ONBATT</span><br><span class="line">LINEV    : 0.0 Volts</span><br><span class="line">LOADPCT  : 15.0 Percent</span><br><span class="line">BCHARGE  : 100.0 Percent</span><br><span class="line">TIMELEFT : 46.8 Minutes</span><br><span class="line">MBATTCHG : 5 Percent</span><br><span class="line">MINTIMEL : 3 Minutes</span><br><span class="line">MAXTIME  : 0 Seconds</span><br><span class="line">SENSE    : Low</span><br><span class="line">LOTRANS  : 160.0 Volts</span><br><span class="line">HITRANS  : 278.0 Volts</span><br><span class="line">ALARMDEL : 30 Seconds</span><br><span class="line">BATTV    : 12.8 Volts</span><br><span class="line">LASTXFER : No transfers since turnon</span><br><span class="line">NUMXFERS : 1</span><br><span class="line">XONBATT  : 2021-10-24 21:05:33 +0800</span><br><span class="line">TONBATT  : 27 Seconds</span><br><span class="line">CUMONBATT: 27 Seconds</span><br><span class="line">XOFFBATT : N/A</span><br><span class="line">SELFTEST : NO</span><br><span class="line">BATTDATE : 2001-01-01</span><br><span class="line">NOMINV   : 220 Volts</span><br><span class="line">NOMBATTV : 12.0 Volts</span><br><span class="line">NOMPOWER : 390 Watts</span><br><span class="line">FIRMWARE : 294803G -292804G</span><br><span class="line">END APC  : 2021-10-24 21:06:00 +0800</span><br></pre></td></tr></table></figure><p>å…¨éƒ¨çš„ UPS çŠ¶æ€å‚æ•°å¯å‚è€ƒå®˜æ–¹æ‰‹å†Œ <a href="http://www.apcupsd.org/manual/#status-report-fields" target="_blank" rel="noopener">status-report-fields</a> ï¼Œä¸è¿‡å¯¹äºæˆ‘ä»¬æ¥è®²ï¼Œä»¥ä¸‹å‡ ä¸ªå‚æ•°æ¯”è¾ƒé‡è¦ï¼š</p><table><thead><tr><th>å‚æ•°</th><th>æ„ä¹‰</th><th>æ¥ç”µ</th><th>æ–­ç”µ</th></tr></thead><tbody><tr><td>STATUS</td><td>UPS çŠ¶æ€</td><td>ONLINE</td><td>ONBATT</td></tr><tr><td>LINEV</td><td>æ¥å…¥ç”µå‹</td><td>224.0 Volts</td><td>0.0 Volts</td></tr><tr><td>BCHARGE</td><td>ç”µæ± å‰©ä½™</td><td>100.0 Percent</td><td>&lt; 100.0 Percent</td></tr><tr><td>XONBATT</td><td>ä¸Šæ¬¡</td><td>N/A</td><td>~</td></tr><tr><td>TONBATT</td><td>å½“å‰ç”µæ± ä½¿ç”¨æ—¶é—´</td><td>N/A</td><td>~</td></tr><tr><td>CUMONBATT</td><td>å½“å‰ç”µæ± ä½¿ç”¨æ€»æ—¶é—´</td><td>N/A</td><td>~</td></tr></tbody></table><h3 id="apccontrol"><a href="#apccontrol" class="headerlink" title="apccontrol"></a>apccontrol</h3><p><code>apccontrol</code> é‡Œå®šä¹‰äº† UPS äº‹ä»¶è§¦å‘åè¦æ‰§è¡Œçš„æ“ä½œï¼Œå®Œæ•´çš„å†…å®¹å¯å‚è€ƒå®˜æ–¹æ‰‹å†Œ <a href="http://www.apcupsd.org/manual/#customizing-event-handling" target="_blank" rel="noopener">apcupsd</a> ã€‚å¯¹äºæˆ‘ä»¬æ¥è®² <code>doshutdown</code> è¿™ä¸ªäº‹ä»¶æ˜¯æ¯”è¾ƒé‡è¦çš„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">doshutdown</span><br><span class="line">When the UPS is running on batteries and one of the limits expires (time, run, load), this event is generated to cause the machine to shutdown.</span><br><span class="line"></span><br><span class="line">Default: Shuts down the system using shutdown -h or similar</span><br></pre></td></tr></table></figure><p>å½“å‡ºç°å¦‚ä¸‹äº‹ä»¶çš„æ—¶å€™åˆ™ä¼šè°ƒç”¨ doshutdown åçš„æ‰§è¡Œå†…å®¹ï¼š</p><ol><li>UPS ç”µæ± å³å°†ç”¨å°½</li><li>UPS è¿è¡Œåœ¨ç”µæ± æ¨¡å¼ä¸‹å‰©ä½™æ—¶é—´ä½äºæ‰€å®šä¹‰çš„ <code>MINUTES</code> å€¼</li><li>UPS ç”µæ± å‰©ä½™ç™¾åˆ†æ¯”ä½äºæ‰€å®šä¹‰çš„ <code>BATTERYLEVEL</code> å€¼</li><li>UPS. è¿è¡Œåœ¨ç”µæ± æ¨¡å¼ä¸‹æ‰€è¶…å‡ºçš„æ—¶é—´ <code>TIMEOUT</code> å€¼</li></ol><blockquote><p>When one of the conditions listed below occurs, apcupsd issues a shutdown command by calling <code>/etc/apcupsd/apccontrol doshutdown</code>, which should perform a shutdown of your system using the system shutdown(8) command. You can modify the behavior as described in <a href="http://www.apcupsd.org/manual/#customizing-event-handling" target="_blank" rel="noopener">Customizing Event Handling</a>.</p><p>The conditions that trigger the shutdown can be any of the following:</p><ul><li>Running time on batteries have expired (<code>TIMEOUT</code>)</li><li>The battery runtime remaining is below the configured value (<code>BATTERYLEVEL</code>)</li><li>The estimated remaining runtime is below the configured value (<code>MINUTES</code>)</li><li>The UPS signals that the batteries are exhausted.</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   doshutdown)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"UPS <span class="variable">$&#123;2&#125;</span> initiated Shutdown Sequence"</span> | <span class="variable">$&#123;WALL&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"apcupsd UPS <span class="variable">$&#123;2&#125;</span> initiated shutdown"</span></span><br><span class="line">bash /opt/bin/shutdown_esxi.sh</span><br><span class="line">;;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥åœ¨ doshutdown é‡Œé¢åŠ å…¥æˆ‘ä»¬è¦æ‰§è¡Œçš„å…³æœºè„šæœ¬ï¼Œæ¯”å¦‚ <code>shutdown_esxi.sh</code>ã€‚è‡³äºå¦‚ä½•ä¼˜é›…åœ°å…³é—­ ESXi ä¸»æœºï¼Œæ¨èä½¿ç”¨ govc è¿™ä¸ª CLI å·¥å…·ã€‚ä¸å¤ªå»ºè®®ç›´æ¥ ssh åˆ° ESXi ä¸»æœºï¼Œç„¶å /sbin/shudown.sh &amp;&amp; poweroff ä¸€æŠŠæ¢­å­å°±å®Œäº‹å„¿äº†ã€‚è¿™æ ·ä¸€é¡¿æ“ä½œçŒ›æœ‰å¯èƒ½ä¼šå¯¹æˆ‘ä»¬çš„è™šæ‹Ÿæœºé€ æˆä¸€å®šçš„å½±å“ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ govc æˆ–è€… vim-cmd å‘½ä»¤å¯¹è™šæ‹Ÿæœºè¿›è¡ŒæŒ‚èµ·æˆ–è€…ä¿å­˜å¿«ç…§çš„æ“ä½œï¼Œæ¥ä¿å­˜è™šæ‹Ÿæœºæ–­ç”µä¹‹å‰çš„çŠ¶æ€ï¼Œç­‰æ‰€æœ‰è™šæ‹Ÿæœºå®‰å…¨å…³æœºä¹‹åï¼Œå†å…³é—­ ESXi ä¸»æœºï¼Œè¿™æ ·æ¯”è¾ƒç¨³å¦¥ä¸€ç‚¹ã€‚ä»¥ä¸‹ä¸¤ç§å…³é—­ ESXi çš„æ–¹å¼ä»»é€‰ä¸€ç§å³å³å¯ï¼š</p><h2 id="govc"><a href="#govc" class="headerlink" title="govc"></a>govc</h2><p>ç”±äºæˆ‘çš„ apcupsd æ˜¯è¿è¡Œåœ¨ R4S è½¯è·¯ç”±ä¸Šï¼Œå¦‚æœå°†å…³æœºè„šæœ¬ä¿å­˜åœ¨ R4S è½¯è·¯ç”±ä¸Šï¼Œå¯ä»¥ä½¿ç”¨ govc è¿™ä¸ªå·¥å…·ï¼Œç„¶åé€šè¿‡ ESXi çš„ https API æ¥å¯¹è™šæ‹Ÿæœºå’Œ ESXi ä¸»æœºè¿›è¡Œç›¸å…³æ“ä½œã€‚</p><ul><li>ä¸‹è½½å¹¶å®‰è£…å®‰è£… govc</li></ul><p>åœ¨ <a href="https://github.com/vmware/govmomi/releases" target="_blank" rel="noopener">vmware/govmomi/releases</a> ä¸‹è½½é¡µé¢æ‰¾åˆ°ä¸è‡ªå·± CPU ä½“ç³»æ¶æ„ç›¸åŒ¹é…çš„ä¸‹è½½åœ°å€ï¼Œæ¯”å¦‚æˆ‘çš„ aarch64 çš„ CPU ä½¿ç”¨å¦‚ä¸‹åœ°å€ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/vmware/govmomi/releases/download/v0.27.1/govc_Linux_arm64.tar.gz</span><br><span class="line">$ tar xf govc_Linux_arm64.tar.gz</span><br><span class="line">$ mv govc /usr/bin</span><br></pre></td></tr></table></figure><ul><li>é…ç½® ESXi è¿æ¥ä¿¡æ¯ï¼Œä½¿ç”¨ <code>govc host.info</code> å‘½ä»¤æŸ¥çœ‹æ˜¯å¦èƒ½æ­£å¸¸è¿æ¥åˆ° ESXi ä¸»æœº</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> GOVC_URL=<span class="string">"https://root:passw0rd@esxi.yoi.li"</span></span><br><span class="line">$ <span class="built_in">export</span> GOVC_DATASTORE=<span class="string">"NVME"</span></span><br><span class="line"></span><br><span class="line">$ govc host.info</span><br><span class="line">Name:              hp-esxi.lan</span><br><span class="line">  Path:            /ha-datacenter/host/hp-esxi.lan/hp-esxi.lan</span><br><span class="line">  Manufacturer:    HPE</span><br><span class="line">  Logical CPUs:    6 CPUs @ 3000MHz</span><br><span class="line">  Processor <span class="built_in">type</span>:  Genuine Intel(R) CPU 0000 @ 3.00GHz</span><br><span class="line">  CPU usage:       960 MHz (5.3%)</span><br><span class="line">  Memory:          32613MB</span><br><span class="line">  Memory usage:    29512 MB (90.5%)</span><br><span class="line">  Boot time:       2021-10-24 13:57:04.396892 +0000 UTC</span><br><span class="line">  State:           connected</span><br></pre></td></tr></table></figure><ul><li>è·å– ESXi ä¸»æœºä¸Šè™šæ‹Ÿæœºçš„åˆ—è¡¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ govc ls /ha-datacenter/vm</span><br><span class="line">/ha-datacenter/vm/NAS</span><br><span class="line">/ha-datacenter/vm/kube-control-02</span><br><span class="line">/ha-datacenter/vm/kube-control-03</span><br><span class="line">/ha-datacenter/vm/kube-node-01</span><br><span class="line">/ha-datacenter/vm/kube-registry-01</span><br><span class="line">/ha-datacenter/vm/WG0</span><br><span class="line">/ha-datacenter/vm/Windows</span><br><span class="line">/ha-datacenter/vm/OP</span><br><span class="line">/ha-datacenter/vm/Devbox</span><br><span class="line">/ha-datacenter/vm/kube-control-01</span><br></pre></td></tr></table></figure><ul><li>VM çš„ç”µæºç›¸å…³æ“ä½œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†è™šæ‹ŸæœºæŒ‚èµ·</span></span><br><span class="line">$ govc vm.power -s NAS</span><br></pre></td></tr></table></figure><ul><li>åœ¨ VM é‡Œæ‰§è¡Œå‘½ä»¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…ˆè®¾ç½®ç»ˆç«¯ç™»å½•çš„ç”¨æˆ·åå’Œå¯†ç </span></span><br><span class="line">$ <span class="built_in">export</span> GOVC_GUEST_LOGIN=<span class="string">"root:passw0rd"</span></span><br><span class="line"><span class="comment"># å…ˆè®©ç¼“å†²åŒºæ•°æ®å†™å…¥åˆ°ç£ç›˜ï¼Œç„¶åå†ä½¿ç”¨ shutdown å®‰å…¨åœ°å…³æœº</span></span><br><span class="line">$ govc guest.run -vm NAS <span class="string">"sync &amp;&amp; shutdown -h now"</span></span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ esxcli å‘½ä»¤æŸ¥çœ‹ VM è¿›ç¨‹ï¼Œä»¥ç¡®ä¿è™šæ‹ŸæœºçœŸæ­£çš„å…³é—­äº†ã€‚åªæœ‰å½“ esxcli vm process list è¾“å‡ºç»“æœä¸ºç©ºçš„æ—¶å€™ï¼ŒESXi ä¸Šæ‰€æœ‰çš„ VM æ‰çœŸæ­£çš„é€€å‡ºï¼Œè¿™æ—¶å°±å¯ä»¥æ”¾å¿ƒå¤§èƒ†åœ°å…³é—­ ESXi ä¸»æœºäº†ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@esxi-debian-devbox ~</span><br><span class="line">â•°â”€<span class="comment"># govc host.esxcli vm process list</span></span><br><span class="line">ConfigFile:   /vmfs/volumes/6118f30c-3e1989cb-77c4-b47af1db548c/NAS/NAS.vmx</span><br><span class="line">DisplayName:  NAS</span><br><span class="line">ProcessID:    0</span><br><span class="line">UUID:         56 4d 7a 57 4c 17 4e 68-07 25 03 5e 4b 0f 8c 96</span><br><span class="line">VMXCartelID:  1121973</span><br><span class="line">WorldID:      1121976</span><br><span class="line"></span><br><span class="line">ConfigFile:   /vmfs/volumes/6118f30c-3e1989cb-77c4-b47af1db548c/Devbox/Devbox.vmx</span><br><span class="line">DisplayName:  Devbox</span><br><span class="line">ProcessID:    0</span><br><span class="line">UUID:         56 4d 91 74 02 b7 b7 59-2b 48 e3 21 d2 a6 b2 9d</span><br><span class="line">VMXCartelID:  1122777</span><br><span class="line">WorldID:      1122778</span><br></pre></td></tr></table></figure><ul><li>å…³é—­ ESXi ä¸»æœº</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡è°ƒç”¨ esxcli å‘½ä»¤æ¥å…³æœº</span></span><br><span class="line">$ govc host.esxcli system shutdown</span><br><span class="line"><span class="comment"># é€šè¿‡ host.shutdown æ¥å…³æœºï¼Œä¸è¿‡ç¿»è½¦äº†</span></span><br><span class="line">â•­â”€root@esxi-debian-devbox ~</span><br><span class="line">â•°â”€<span class="comment"># govc host.shutdown -host "esxi.yoi.li"</span></span><br><span class="line">govc: no argument</span><br></pre></td></tr></table></figure><ul><li>å…³æœºè„šæœ¬ <code>shutdown_esxi.sh</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://root:passw0rd@esxi.yoi.li"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=<span class="string">"NVME"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_GUEST_LOGIN=<span class="string">"root:passw0rd"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># suspend all vms</span></span><br><span class="line">govc find . -<span class="built_in">type</span> m -runtime.powerState poweredOn | awk -F <span class="string">'/'</span> <span class="string">'&#123;print $NF&#125;'</span> \</span><br><span class="line">| grep -v NAS | xargs -L1 -&#123;&#125; govc vm.power -<span class="built_in">suspend</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># sync data to disk and shutdown vm</span></span><br><span class="line">govc vm.info NAS | grep -q poweredOn &amp;&amp; govc guest.run -vm NAS <span class="string">"sync &amp;&amp; shutdown -h now"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># wait all vm exit</span></span><br><span class="line"><span class="keyword">for</span>((i=0;i&lt;12;i++)); <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> ! esxcli vm process list | grep UUID; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    sleep 10</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">govc host.esxcli system shutdown</span><br></pre></td></tr></table></figure><ul><li>ä¿®æ”¹ <code>/etc/apcupsd/apccontrol</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   doshutdown)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"UPS <span class="variable">$&#123;2&#125;</span> initiated Shutdown Sequence"</span> | <span class="variable">$&#123;WALL&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"apcupsd UPS <span class="variable">$&#123;2&#125;</span> initiated shutdown"</span></span><br><span class="line"><span class="string">"bash /opt/bin/shutdown_esxi.sh"</span></span><br><span class="line">;;</span><br></pre></td></tr></table></figure><h2 id="vim-cmd"><a href="#vim-cmd" class="headerlink" title="vim-cmd"></a>vim-cmd</h2><p>ç”±äº vim-cmd å‘½ä»¤åªèƒ½åœ¨ ESXi ä¸»æœºä¸Šè¿è¡Œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å°†è¯¥å…³æœºè„šæœ¬ä¿å­˜åˆ° ESXI ä¸»æœºä¸Šï¼Œæˆ–è€…é€šè¿‡ scp çš„æ–¹å¼å°†è¯¥è„šæœ¬ä¼ è¾“åˆ° ESXi ä¸»æœºä¸Šï¼Œç„¶åæ‰§è¡Œè¯¥è„šæœ¬å®Œæˆå…³æœºæ“ä½œã€‚</p><ul><li>ä¿®æ”¹ <code>/etc/apcupsd/apccontrol</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   doshutdown)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"UPS <span class="variable">$&#123;2&#125;</span> initiated Shutdown Sequence"</span> | <span class="variable">$&#123;WALL&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"apcupsd UPS <span class="variable">$&#123;2&#125;</span> initiated shutdown"</span></span><br><span class="line">scp shutdown_esxi.sh root@esxi.yoi.li:/</span><br><span class="line">ssh root@esxi.yoi.li <span class="string">"sh /shutdown_esxi.sh"</span></span><br><span class="line">;;</span><br></pre></td></tr></table></figure><ul><li><code>shutdown_esxi.sh</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">LOG_PATH=/vmfs/volumes/NVME/.<span class="built_in">log</span>/suspend.log</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$(TZ=UTC-8 date +%Y-%m-%d" "%H:%M:%S)</span>"</span> &gt;&gt; <span class="variable">$&#123;LOG_PATH&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">poweroff_vms</span></span>()&#123;</span><br><span class="line">    <span class="keyword">for</span> vm <span class="keyword">in</span> $(vim-cmd vmsvc/getallvms | grep -E <span class="string">'NAS'</span> | awk <span class="string">'&#123;print $1&#125;'</span> | xargs); <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> vim-cmd vmsvc/power.getstate <span class="variable">$&#123;vm&#125;</span> | grep <span class="string">'Powered on'</span>; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"<span class="variable">$(TZ=UTC-8 date +%Y-%m-%d" "%H:%M:%S)</span> shutdown vm <span class="variable">$&#123;vm&#125;</span>"</span> &gt;&gt; <span class="variable">$&#123;LOG_PATH&#125;</span></span><br><span class="line">            vim-cmd vmsvc/power.shutdown <span class="variable">$&#123;vm&#125;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">suspend_vms</span></span>()&#123;</span><br><span class="line">    <span class="keyword">for</span> vm <span class="keyword">in</span> $(vim-cmd vmsvc/getallvms | grep -Ev <span class="string">'NAS|Vmid'</span> | awk <span class="string">'&#123;print $1&#125;'</span> | xargs); <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> vim-cmd vmsvc/power.getstate <span class="variable">$&#123;vm&#125;</span> | grep <span class="string">'Powered on'</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$(TZ=UTC-8 date +%Y-%m-%d" "%H:%M:%S)</span> suppend vm <span class="variable">$&#123;vm&#125;</span>"</span> &gt;&gt; <span class="variable">$&#123;LOG_PATH&#125;</span></span><br><span class="line">        vim-cmd vmsvc/power.suspend <span class="variable">$&#123;vm&#125;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">suspend_vms</span><br><span class="line">poweroff_vms</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Poweroff at <span class="variable">$(TZ=UTC-8 date +%Y-%m-%d" "%H:%M:%S)</span>"</span> &gt;&gt; <span class="variable">$&#123;LOG_PATH&#125;</span></span><br><span class="line">/bin/host_shutdown.sh</span><br></pre></td></tr></table></figure><p>é€šè¿‡ ssh çš„æ–¹å¼æ‰§è¡Œè¯¥è„šæœ¬éœ€è¦ ESXi ä¸»æœºå¼€å¯ ssh æœåŠ¡å¹¶åšå¥½ ssh å…å¯†ç™»å½•ï¼Œè¿™éƒ¨åˆ†å†…å®¹å¯å‚è€ƒ <a href="https://kb.vmware.com/s/article/1002866?lang=zh_CN" target="_blank" rel="noopener">å…è®¸ä½¿ç”¨å…¬é’¥/ç§é’¥èº«ä»½éªŒè¯å¯¹ ESXi/ESX ä¸»æœºè¿›è¡Œ SSH è®¿é—®</a>ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="http://www.apcupsd.org/manual/" target="_blank" rel="noopener">apcupsd å®˜æ–¹æ–‡æ¡£</a></li><li><a href="https://wiki.debian.org/apcupsd" target="_blank" rel="noopener">apcupsd debian wiki</a></li><li><a href="https://linuxtoy.org/archives/howto-use-apcupsd-to-automatically-shutdown-system-during-outrage.html" target="_blank" rel="noopener">ä½¿ç”¨ apcupsd å®ç° UPS æ–­ç”µè‡ªåŠ¨å…³æœº</a></li><li><a href="https://github.com/vmware/govmomi/blob/master/govc/USAGE.md" target="_blank" rel="noopener">govc usage</a></li><li><a href="https://gitbook.curiouser.top/origin/vsphere-govc.html" target="_blank" rel="noopener">vSphere go å‘½ä»¤è¡Œç®¡ç†å·¥å…· govc</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;APC-UPS-BK650M2-CH&quot;&gt;&lt;a
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="NAS" scheme="https://blog.k8s.li/tags/NAS/"/>
    
      <category term="åƒåœ¾ä½¬" scheme="https://blog.k8s.li/tags/%E5%9E%83%E5%9C%BE%E4%BD%AC/"/>
    
      <category term="UPS" scheme="https://blog.k8s.li/tags/UPS/"/>
    
  </entry>
  
  <entry>
    <title>ä¸‡å­—é•¿æ–‡è¯¦è§£ PaaS toB åœºæ™¯ä¸‹ K8s ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆ</title>
    <link href="https://blog.k8s.li/pass-tob-k8s-offline-deploy.html"/>
    <id>https://blog.k8s.li/pass-tob-k8s-offline-deploy.html</id>
    <published>2021-08-29T16:00:00.000Z</published>
    <updated>2021-08-29T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒå½“ä¸­ï¼Œå‡ºäºå¯¹æ•°æ®å®‰å…¨çš„è€ƒè™‘ä»¥åŠæ»¡è¶³ <a href="http://www.djbh.net/" target="_blank" rel="noopener">ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤</a> çš„è¦æ±‚ï¼Œå¾€å¾€ä¼šå¯¹å†…éƒ¨ç¯å¢ƒä¸­çš„æœåŠ¡å™¨åšå‡ºä¸¥æ ¼çš„è®¿é—®é™åˆ¶ã€‚ä¸€èˆ¬æ¥è®²ç”Ÿäº§ç¯å¢ƒéƒ½ä¼šç¦æ­¢è®¿é—®å¤–éƒ¨ç½‘ç»œï¼Œå¼€å‘äººå‘˜è¦è®¿é—®ç”Ÿäº§ç¯å¢ƒä¹Ÿå¿…é¡»é€šè¿‡å ¡å’æœºæˆ–è€…å…¶ä»–æ–¹å¼è¿›è¡Œå®‰å…¨å®¡è®¡ç™»å½•ã€‚åœ¨è¿™ç§æ— ç½‘ï¼ˆæ— æ³•è®¿é—®å…¬ç½‘ï¼‰çš„ç¯å¢ƒä¸­ï¼Œæƒ³è¦éƒ¨ç½²å¥½ä¸€ä¸ª K8s é›†ç¾¤å¹¶ä¸æ˜¯ä¸€ä»¶è½»æ¾çš„äº‹å„¿ã€‚å¸‚é¢ä¸Š K8s éƒ¨ç½²å·¥å…·ä¹Ÿå¤šä¸èƒœæ•°ï¼Œå¯¹äºç¦»çº¿éƒ¨ç½²çš„æ”¯æŒæƒ…å†µä¹Ÿå„ä¸ç›¸åŒï¼š</p><table><thead><tr><th align="center">Item</th><th align="center">Language</th><th align="center">Star</th><th align="center">Fork</th><th align="left">ç¦»çº¿éƒ¨ç½²æ”¯æŒæƒ…å†µ</th></tr></thead><tbody><tr><td align="center"><a href="https://github.com/kubernetes/kops" target="_blank" rel="noopener">kops</a></td><td align="center">Golang</td><td align="center">13.2k</td><td align="center">4.1k</td><td align="left">ä¸æ”¯æŒ</td></tr><tr><td align="center"><a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener">kubespray</a></td><td align="center">Ansible</td><td align="center">11.1k</td><td align="center">4.7k</td><td align="left">æ”¯æŒï¼Œéœ€è‡ªè¡Œæ„å»ºå®‰è£…åŒ…</td></tr><tr><td align="center"><a href="https://github.com/easzlab/kubeasz" target="_blank" rel="noopener">kubeasz</a></td><td align="center">Ansible</td><td align="center">7.2k</td><td align="center">2.7k</td><td align="left">æ”¯æŒï¼Œéœ€è‡ªè¡Œæ„å»ºå®‰è£…åŒ…</td></tr><tr><td align="center"><a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a></td><td align="center">Golang</td><td align="center">4.1k</td><td align="center">790</td><td align="left">æ”¯æŒï¼Œéœ€ä»˜è´¹å……å€¼ä¼šå‘˜</td></tr><tr><td align="center"><a href="https://github.com/rancher/rke" target="_blank" rel="noopener">RKE</a></td><td align="center">Golang</td><td align="center">2.5k</td><td align="center">480</td><td align="left">ä¸æ”¯æŒï¼Œéœ€è‡ªè¡Œå®‰è£… docker</td></tr><tr><td align="center"><a href="https://github.com/alibaba/sealer" target="_blank" rel="noopener">sealer</a></td><td align="center">Golang</td><td align="center">503</td><td align="center">112</td><td align="left">æ”¯æŒï¼Œæºè‡ª <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a></td></tr><tr><td align="center"><a href="https://github.com/kubesphere/kubekey" target="_blank" rel="noopener">kubekey</a></td><td align="center">Golang</td><td align="center">471</td><td align="center">155</td><td align="left">éƒ¨åˆ†æ”¯æŒï¼Œä»…é•œåƒå¯ç¦»çº¿</td></tr></tbody></table><p>æ— ç½‘ç¯å¢ƒç¦»çº¿éƒ¨ç½² K8s å¾€å¾€æ˜¯ä½œä¸ºä¸€ä¸ªå•†ä¸šæœåŠ¡æˆ–è€…å•†ä¸šä»˜è´¹äº§å“æ¥å‡ºå”®ï¼ˆå¦‚ <a href="https://www.sealyun.com/" target="_blank" rel="noopener">sealos</a> ï¼‰ï¼Œå¾ˆå°‘æœ‰å¼€æºå…è´¹çš„è§£å†³æ–¹æ¡ˆï¼›æˆ–è€…è™½ç„¶æä¾›äº†ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆï¼Œä½†æƒ³è¦æ“ä½œèµ·æ¥ååˆ†ç¹çï¼Œå¾ˆéš¾é¡ºç•…åœ°åšåˆ°ä¸€é”®éƒ¨ç½²ï¼›åˆæˆ–è€…åªæ”¯æŒéƒ¨åˆ†ç¦»çº¿éƒ¨ç½²ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†èµ„æºéœ€è¦åœ¨éƒ¨ç½²çš„æ—¶å€™é€šè¿‡å…¬ç½‘è·å–ã€‚</p><p>é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œæœ¬æ–‡è°ƒç ”ä¸»æµçš„ K8s éƒ¨ç½²å·¥å…·ï¼Œå¹¶åŸºäºè¿™äº›å·¥å…·è®¾è®¡å¹¶å®ç°ä¸€ç§ä»æ„å»ºç¦»çº¿å®‰è£…åŒ…åˆ°ä¸€é”®éƒ¨ç½² K8s é›†ç¾¤å…¨æµç¨‹çš„è§£å†³æ–¹æ¡ˆï¼Œä»¥æ»¡è¶³åœ¨æ— ç½‘çš„ç¯å¢ƒä¸­ä¸€é”®éƒ¨ç½² K8s é›†ç¾¤çš„éœ€æ±‚ï¼Œæ¯”è¾ƒé€‚åˆåŸºäº K8s çš„ PaaS toB äº§å“ä½¿ç”¨ã€‚</p><h2 id="ç¦»çº¿èµ„æº"><a href="#ç¦»çº¿èµ„æº" class="headerlink" title="ç¦»çº¿èµ„æº"></a>ç¦»çº¿èµ„æº</h2><p>æ€»ä½“æ¥è®²éƒ¨ç½²ä¸€ä¸ª K8s é›†ç¾¤å¤§è‡´éœ€è¦ä¾èµ–å¦‚ä¸‹ä¸‰ç§èµ„æºï¼š</p><ul><li>ç³»ç»Ÿ OS çš„ rpm/deb åŒ…ï¼šå¦‚ docker-ceã€containerdã€ipvsadmã€conntrack ç­‰ï¼›</li><li>äºŒè¿›åˆ¶æ–‡ä»¶ï¼šå¦‚ kubeletã€kubectlã€kubeadmã€crictl ç­‰ï¼›</li><li>ç»„ä»¶å®¹å™¨é•œåƒï¼šå¦‚ kube-apiserverã€kube-proxyã€corednsã€calicoã€flannel ç­‰ï¼›</li></ul><h3 id="OS-packages"><a href="#OS-packages" class="headerlink" title="OS packages"></a>OS packages</h3><p>è¿™ç±»å±äº OS ç³»ç»Ÿå±‚é¢çš„ä¾èµ–ï¼Œæ ¹æ®ä¸åŒç³»ç»Ÿæˆ–è€…æ”¯æŒçš„åŠŸèƒ½éœ€è¦ä½¿ç”¨ç›¸åº”çš„åŒ…ç®¡ç†å™¨å®‰è£…ç›¸åº”çš„ä¾èµ–åŒ…ï¼Œå¤§è‡´åˆ†ä¸ºå¦‚ä¸‹å‡ ç§ï¼š</p><ul><li>kubernetes ç»„ä»¶ä¾èµ–</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- conntrack           <span class="comment"># kube-proxy ä¾èµ–</span></span><br><span class="line">- ipset               <span class="comment"># kube-proxy ä½¿ç”¨ ipvs æ¨¡å¼éœ€è¦</span></span><br><span class="line">- ipvsadm             <span class="comment"># kube-proxy ä½¿ç”¨ ipvs æ¨¡å¼éœ€è¦</span></span><br><span class="line">- socat               <span class="comment"># ç”¨äº port forwarding</span></span><br></pre></td></tr></table></figure><blockquote><p><a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/implementation-details/" target="_blank" rel="noopener">Implementation details</a>:</p><p>[Error] if conntrack, ip, iptables, mount, nsenter commands are not present in the command path<br>[warning] if ebtables, ethtool, socat, tc, touch, crictl commands are not present in the command path</p></blockquote><ul><li>éƒ¨ç½²ä¾èµ–</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- ebtables            <span class="comment"># kubeadm ä¾èµ–å·¥å…·</span></span><br><span class="line">- ethtool             <span class="comment"># kubeadm ä¾èµ–å·¥å…·</span></span><br><span class="line">- chrony              <span class="comment"># æ—¶é’ŸåŒæ­¥å·¥å…·ï¼Œéƒ¨ç½²å‰èŠ‚ç‚¹çš„æ—¶å€™å¿…é¡»ä¸€è‡´ï¼Œä¸ç„¶è¯ä¹¦æˆ–è€… CNI æ’ä»¶ä¼šå‡ºç°é—®é¢˜</span></span><br></pre></td></tr></table></figure><ul><li>CRI å®¹å™¨è¿è¡Œè¿è¡Œæ—¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- containerd.io       <span class="comment"># å¯å•ç‹¬å®‰è£…/docker-ce ä¾èµ–</span></span><br><span class="line">- docker-ce           <span class="comment"># docker-ce</span></span><br><span class="line">- libseccomp          <span class="comment"># å®‰è£… containerd éœ€è¦</span></span><br><span class="line">- nvidia-container-runtime <span class="comment"># æ”¯æŒ GPU æ—¶éœ€è¦ä¾èµ–</span></span><br></pre></td></tr></table></figure><ul><li>å­˜å‚¨å®¢æˆ·ç«¯ä¾èµ–</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- nfs-utils/nfs-common <span class="comment"># åˆ›å»ºåŸºäº nfs çš„ PV éœ€è¦</span></span><br><span class="line">- ceph-common          <span class="comment"># ceph å®¢æˆ·ç«¯å®‰è£…åŒ…ï¼Œåˆ›å»ºåŸºäº ceph çš„ pv éœ€è¦</span></span><br><span class="line">- lvm2                 <span class="comment"># åˆ›å»ºåŸºäº ceph çš„ pv éœ€è¦</span></span><br><span class="line">- glusterfs-client     <span class="comment"># åˆ›å»ºåŸºäº glusterfs çš„ pv éœ€è¦</span></span><br><span class="line">- glusterfs-common     <span class="comment"># åˆ›å»ºåŸºäº glusterfs çš„ pv éœ€è¦</span></span><br><span class="line">- cifs-utils           <span class="comment"># åˆ›å»ºåŸºäº cifs çš„ pv éœ€è¦</span></span><br><span class="line">- fuse                 <span class="comment"># ceph æˆ–è€…å…¶ä»–å­˜å‚¨å®¢æˆ·ç«¯ä¾èµ–</span></span><br></pre></td></tr></table></figure><p>æƒ³è¦è§£å†³ä¸Šé¢è¿™äº›ä¾èµ–é¡¹ååˆ†æ£˜æ‰‹ï¼Œä¹Ÿæ˜¯ç¦»çº¿éƒ¨ç½²åœºæ™¯ä¸‹æœ€éš¾çš„ä¸€éƒ¨åˆ†ï¼Œè‡³ä»Šå¹¶æ²¡æœ‰ä¸€ä¸ªæˆç†Ÿçš„æ–¹æ¡ˆå®ç°è¿™äº›ä¾èµ–çš„ç¦»çº¿éƒ¨ç½²ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„ k8s éƒ¨ç½²å·¥å…·éƒ½æ²¡æœ‰æä¾›è¿™äº›åŒ…çš„ç¦»çº¿å®‰è£…æ–¹å¼ã€‚å¯¹äºè¿™äº›åŒ…çš„ä¾èµ–ï¼Œç›®å‰ä¸»è¦æœ‰é¿å…å®‰è£…è¿™äº›ä¾èµ–å’Œåˆ¶ä½œç¦»çº¿æºè¿™ä¸¤ç§è§£å†³æ–¹æ¡ˆã€‚</p><h4 id="sealos"><a href="#sealos" class="headerlink" title="sealos"></a>sealos</h4><p>åœ¨ <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a> ä¸­å°±æåŠ›é¿å…ä½¿ç”¨åŒ…ç®¡ç†å™¨æ¥å®‰è£…ä¾èµ–ï¼Œæ¯”å¦‚å®‰è£… containerd æ—¶çš„ä¾èµ– libseccomp ä½¿ç”¨çš„æ˜¯ç¼–è¯‘å¥½çš„ .so æ–‡ä»¶çš„æ–¹å¼ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ tar -tf kube1.20.0.tar.gz</span><br><span class="line">kube/</span><br><span class="line">kube/lib64/</span><br><span class="line">kube/lib64/README.md</span><br><span class="line">kube/lib64/libseccomp.so.2</span><br><span class="line">kube/lib64/libseccomp.so.2.3.1</span><br></pre></td></tr></table></figure><p>å®‰è£… docker ä½¿ç”¨çš„äºŒè¿›åˆ¶çš„æ–¹å¼ï¼Œä½† docker å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæ˜ç¡®è¯´æ˜<strong>ä¸å»ºè®®ä½¿ç”¨äºŒè¿›åˆ¶çš„æ–¹å¼æ¥å®‰è£… docker</strong>ï¼Œåº”è¯¥ä½¿ç”¨å‘è¡Œç‰ˆè‡ªå¸¦çš„åŒ…ç®¡ç†å™¨æ¥å®‰è£…ã€‚</p><blockquote><p>If you want to try Docker or use it in a testing environment, but youâ€™re not on a supported platform, you can try installing from static binaries. <strong>If possible, you should use packages built for your operating system</strong>, and use your operating systemâ€™s package management system to manage Docker installation and upgrades.</p><p><a href="https://docs.docker.com/engine/install/binaries/" target="_blank" rel="noopener">Install Docker Engine from binaries</a></p></blockquote><p>å®é™…ä¸Šä»»ä½•éƒ¨ç½²å·¥å…·éƒ½ä¼šå¯¹ç³»ç»Ÿ rpm/deb åŒ…éƒ½ä¼šæœ‰ä¸åŒç¨‹åº¦ä¸Šçš„ä¾èµ–ï¼Œæœ‰ä¸€éƒ¨åˆ†ä¾èµ–å¯ä»¥åƒ <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a>  è¿™æ ·é€šè¿‡æŸç§æ–¹å¼å»è§„é¿æ‰ã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„ä¾èµ–éƒ½èƒ½è§„é¿çš„ï¼Œæ¯”å¦‚æä¾›æŒ‚è½½ PV éœ€è¦ä¾èµ–çš„å­˜å‚¨å®¢æˆ·ç«¯ï¼ˆnfs-common/nfs-utilsï¼Œlvm2ï¼Œgluster-clientï¼‰è¿™äº›åŒ…ï¼ŒåŸºæœ¬ä¸Šæ˜¯æ²¡æœ‰ä»»ä½•è§„é¿çš„é€”å¾„ï¼Œå¿…é¡»é€šè¿‡åŒ…ç®¡ç†å™¨æ¥å®‰è£…æ‰è¡Œã€‚</p><p>å½“ç„¶å¦‚æœè¿™äº›å‰ç½®çš„ä¾èµ–é¡¹åœ¨éƒ¨ç½²å·¥å…·ä¹‹å¤–æ‰‹åŠ¨è§£å†³æˆ–è€…è®©ç”¨æˆ·è‡ªè¡Œå»è§£å†³ï¼Œé‚£ä¹ˆä½¿ç”¨ <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a>  è¿™ç§è½»é‡çº§çš„å·¥å…·æ¥éƒ¨ç½² K8s æ˜¯æ¯”è¾ƒåˆé€‚çš„ã€‚ä½†å¯¹äºä¸€äº› PaaS toB çš„äº§å“è€Œè¨€ï¼Œè®©ç”¨æˆ·è‡ªå·±å»æ‰‹åŠ¨è§£å†³è¿™äº›ä¾èµ–ææ€•ä¸å¤ªå¥½ã€‚ç«™åœ¨å®¢æˆ·çš„è§’åº¦æ¥è€ƒè™‘æ—¢ç„¶å¹³å°æä¾›äº†è¿™éƒ¨åˆ†åŠŸèƒ½ï¼Œå°±åº”è¯¥åœ¨éƒ¨ç½²çš„æ—¶å€™è§£å†³æ‰€æœ‰çš„ä¾èµ–é—®é¢˜ï¼Œè€Œä¸æ˜¯è®©æˆ‘è‡ªå·±æ‰‹åŠ¨ä¸´æ—¶æ¥è§£å†³ã€‚</p><h4 id="kubekey"><a href="#kubekey" class="headerlink" title="kubekey"></a>kubekey</h4><p>åœ¨ kubekey ä¸­ä¸€äº›ä¾èµ–é¡¹ç›®åˆ™æ˜¯è¦æ±‚ç”¨æˆ·è‡ªè¡Œå®‰è£…ï¼Œå¹¶æ²¡æœ‰æä¾›ç¦»çº¿å®‰è£…çš„æ–¹å¼ï¼š</p><blockquote><ul><li>å»ºè®®æ‚¨ä½¿ç”¨å¹²å‡€çš„æ“ä½œç³»ç»Ÿï¼ˆä¸å®‰è£…ä»»ä½•å…¶ä»–è½¯ä»¶ï¼‰ï¼Œå¦åˆ™å¯èƒ½ä¼šæœ‰å†²çªã€‚</li><li>è¯·ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹çš„ç¡¬ç›˜è‡³å°‘æœ‰ <strong>100G</strong>ã€‚</li><li>æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»éƒ½èƒ½é€šè¿‡ <code>SSH</code> è®¿é—®ã€‚</li><li>æ‰€æœ‰èŠ‚ç‚¹æ—¶é—´åŒæ­¥ã€‚</li><li>æ‰€æœ‰èŠ‚ç‚¹éƒ½åº”ä½¿ç”¨ <code>sudo</code>/<code>curl</code>/<code>openssl</code>ã€‚</li></ul><p>KubeKey èƒ½å¤ŸåŒæ—¶å®‰è£… Kubernetes å’Œ KubeSphereã€‚æ ¹æ®è¦å®‰è£…çš„ Kubernetes ç‰ˆæœ¬ï¼Œéœ€è¦å®‰è£…çš„ä¾èµ–é¡¹å¯èƒ½ä¼šä¸åŒã€‚æ‚¨å¯ä»¥å‚è€ƒä¸‹æ–¹åˆ—è¡¨ï¼ŒæŸ¥çœ‹æ˜¯å¦éœ€è¦æå‰åœ¨æ‚¨çš„èŠ‚ç‚¹ä¸Šå®‰è£…ç›¸å…³ä¾èµ–é¡¹ã€‚</p><table><thead><tr><th align="left">ä¾èµ–é¡¹</th><th align="left">Kubernetes ç‰ˆæœ¬ â‰¥ 1.18</th><th align="left">Kubernetes ç‰ˆæœ¬ &lt; 1.18</th></tr></thead><tbody><tr><td align="left"><code>socat</code></td><td align="left">å¿…é¡»</td><td align="left">å¯é€‰ä½†å»ºè®®</td></tr><tr><td align="left"><code>conntrack</code></td><td align="left">å¿…é¡»</td><td align="left">å¯é€‰ä½†å»ºè®®</td></tr><tr><td align="left"><code>ebtables</code></td><td align="left">å¯é€‰ä½†å»ºè®®</td><td align="left">å¯é€‰ä½†å»ºè®®</td></tr><tr><td align="left"><code>ipset</code></td><td align="left">å¯é€‰ä½†å»ºè®®</td><td align="left">å¯é€‰ä½†å»ºè®®</td></tr></tbody></table><p>å¤‡æ³¨</p><ul><li>åœ¨ç¦»çº¿ç¯å¢ƒä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç§æœ‰åŒ…ã€RPM åŒ…ï¼ˆé€‚ç”¨äº CentOSï¼‰æˆ–è€… Deb åŒ…ï¼ˆé€‚ç”¨äº Debianï¼‰æ¥å®‰è£…è¿™äº›ä¾èµ–é¡¹ã€‚</li><li>å»ºè®®æ‚¨äº‹å…ˆåˆ›å»ºä¸€ä¸ªæ“ä½œç³»ç»Ÿé•œåƒæ–‡ä»¶ï¼Œå¹¶ä¸”å®‰è£…å¥½æ‰€æœ‰ç›¸å…³ä¾èµ–é¡¹ã€‚è¿™æ ·ï¼Œæ‚¨ä¾¿å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥é•œåƒæ–‡ä»¶åœ¨æ¯å°æœºå™¨ä¸Šå®‰è£…æ“ä½œç³»ç»Ÿï¼Œæé«˜éƒ¨ç½²æ•ˆç‡ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒä»»ä½•ä¾èµ–é¡¹é—®é¢˜ã€‚</li></ul><p>æ‚¨çš„é›†ç¾¤å¿…é¡»æœ‰ä¸€ä¸ªå¯ç”¨çš„å®¹å™¨è¿è¡Œæ—¶ã€‚åœ¨ç¦»çº¿ç¯å¢ƒä¸­åˆ›å»ºé›†ç¾¤ä¹‹å‰ï¼Œæ‚¨å¿…é¡»æ‰‹åŠ¨å®‰è£… Docker æˆ–å…¶ä»–å®¹å™¨è¿è¡Œæ—¶ã€‚</p><p><a href="https://github.com/kubesphere/kubekey#requirements-and-recommendations" target="_blank" rel="noopener">Requirements and Recommendations</a></p></blockquote><h4 id="æ„å»ºç¦»çº¿æº"><a href="#æ„å»ºç¦»çº¿æº" class="headerlink" title="æ„å»ºç¦»çº¿æº"></a>æ„å»ºç¦»çº¿æº</h4><p>å¯¹äºç³»ç»Ÿ rpm/deb åŒ…çš„ä¾èµ–ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¸è¸å®å®åœ°ä½¿ç”¨åŒ…ç®¡ç†å™¨æ¥å®‰è£…è¿™äº›åŒ…è¾ƒä¸ºå¦¥å½“ï¼Œå› æ­¤æˆ‘ä»¬æœ‰å¿…è¦ä¸ºè¿™äº›ä¾èµ–çš„ rpm/deb åŒ…æ„å»ºæˆç¦»çº¿æºï¼Œéƒ¨ç½²çš„æ—¶å€™ä½¿ç”¨è¿™ä¸ªç¦»çº¿æºæ¥å®‰è£…è¿™äº›ä¾èµ–ã€‚åœ¨ ã€Š<a href="https://blog.k8s.li/make-offline-mirrors.html">ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</a>ã€‹ä¸€æ–‡ä¸­æ›¾åˆ†æè¿‡åˆ¶ä½œå’Œä½¿ç”¨ç¦»çº¿æºè¿™ä¹ˆéš¾çš„åŸå› ï¼š</p><blockquote><p>ä½œä¸ºå¹³å°éƒ¨ç½²å·¥å…·çš„å¼€å‘è€…ï¼Œå§‹ç»ˆè¢«ç¦»çº¿éƒ¨ç½²è¿™ä¸ªéš¾é¢˜å›°æ‰°ç€ã€‚åœ¨çº¿çš„å®¹å™¨é•œåƒå’ŒäºŒè¿›åˆ¶æ–‡ä»¶æ¯”è¾ƒå¥½è§£å†³ï¼Œå› ä¸ºè¿™äº›èµ„æºæ˜¯ä¸ OS æ— å…³çš„ï¼Œåªè¦ä¸‹è½½ä¸‹æ¥æ”¾åˆ°å®‰è£…åŒ…é‡Œï¼Œéƒ¨ç½²çš„æ—¶å€™å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨å’Œé•œåƒä»“åº“æœåŠ¡æä¾›è¿™äº›èµ„æºçš„ä¸‹è½½å³å¯ã€‚</p><p>ä½†æ˜¯å¯¹äº yum/apt ä¹‹ç±»çš„è½¯ä»¶æ¥è®²å¹¶ä¸é‚£ä¹ˆç®€å•ï¼š</p><ul><li>é¦–å…ˆç”±äºå„ä¸ªåŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»æ¯”è¾ƒå¤æ‚ï¼Œå¹¶ä¸èƒ½å°†å®ƒä»¬ç›´æ¥ä¸‹è½½ä¸‹æ¥ï¼›</li><li>å…¶æ¬¡å³ä¾¿ä¸‹è½½ä¸‹æ¥ä¹‹åä¹Ÿæ— æ³•ç›´æ¥é€šè¿‡ yum/apt çš„æ–¹å¼å®‰è£…æŒ‡å®šçš„è½¯ä»¶åŒ…ï¼Œè™½ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ scp çš„æ–¹å¼å°†è¿™äº›åŒ…å¤åˆ¶åˆ°éƒ¨ç½²èŠ‚ç‚¹ï¼Œé€šè¿‡ rpm æˆ– dpkg çš„æ–¹å¼æ¥å®‰è£…ä¸Šï¼Œä½†è¿™æ ·å¹¶ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œè€Œä¸”é€šç”¨æ€§èƒ½ä¹Ÿä¸æ˜¯å¾ˆå¥½ï¼›</li><li>æœ€åéœ€è¦é€‚é…çš„ Linux å‘è¡Œç‰ˆå’ŒåŒ…ç®¡ç†å™¨ç§ç±»ä¹Ÿæœ‰å¤šç§ï¼Œè€Œä¸”æœ‰äº›åŒ…çš„åŒ…åæˆ–è€…ç‰ˆæœ¬å·åœ¨ä¸åŒçš„åŒ…ç®¡ç†ä¹‹é—´ä¹Ÿç›¸å·®ç”šå¤§ï¼Œæ— æ³•åšåˆ°ç»Ÿä¸€ç®¡ç†ã€‚</li><li>ç¦»çº¿æºåŒæ—¶é€‚é…é€‚é… ARM64 å’Œ AMD64 æœ‰ä¸€å®šçš„éš¾åº¦</li></ul></blockquote><p>å¥½åœ¨æ–‡ä¸­ä¹Ÿç»™å‡ºäº†ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œå³é€šè¿‡ Dockerfile æ¥æ„å»ºç¦»çº¿æºï¼Œå…·ä½“çš„å®ç°ç»†èŠ‚å¯ä»¥ç¿»çœ‹ã€Š<a href="https://blog.k8s.li/make-offline-mirrors.html">ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</a>ã€‹ä¸€æ–‡ã€‚ä½¿ç”¨è¿™ä¸ªæ–¹æ¡ˆå¯ä»¥è§£å†³ PaaS æˆ–è€… IaaS å±‚é¢çš„ç¦»çº¿æºåˆ¶ä½œçš„éš¾é¢˜ï¼ŒåŒæ ·ä¹Ÿé€‚ç”¨äºæˆ‘ä»¬éƒ¨ç½² K8s é›†ç¾¤çš„åœºæ™¯ï¼Œè€Œä¸”é‡‡ç”¨ Dockerfile çš„æ–¹å¼æ¥æ„å»ºç¦»çº¿æºå¯ä»¥å®Œç¾åœ°è§£å†³åŒæ—¶é€‚é… arm64 å’Œ amd64 çš„éš¾é¢˜ã€‚</p><h3 id="files"><a href="#files" class="headerlink" title="files"></a>files</h3><p>ä¸€äº›éƒ¨ç½²è¿‡ç¨‹ä¸­éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- kubelet</span><br><span class="line">- kubeadm</span><br><span class="line">- kubectl</span><br><span class="line">- etcd            <span class="comment"># systemd æ–¹å¼éƒ¨ç½² etcd æ—¶éœ€è¦çš„å®‰è£…åŒ…</span></span><br><span class="line">- crictl          <span class="comment"># k8s å®˜æ–¹çš„ CRI CLI å·¥å…·</span></span><br><span class="line">- calicoctl       <span class="comment"># calico çš„ CLI å·¥å…·</span></span><br><span class="line">- helm            <span class="comment"># å®‰è£… helm éœ€è¦çš„äºŒè¿›åˆ¶å®‰è£…åŒ…</span></span><br><span class="line">- nerdctl         <span class="comment"># containerd çš„ CLI å·¥å…·</span></span><br><span class="line">- cni-plugins     <span class="comment"># CNI æ’ä»¶</span></span><br><span class="line">- cuda            <span class="comment"># GPU ä¾èµ–</span></span><br><span class="line">- nvidia_driver   <span class="comment"># GPU é©±åŠ¨</span></span><br></pre></td></tr></table></figure><h4 id="sealos-1"><a href="#sealos-1" class="headerlink" title="sealos"></a>sealos</h4><p>sealos å¯¹äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤„ç†æ¯”è¾ƒå¥½ï¼Œå…¨éƒ¨æ‰“åŒ…åœ¨ç¦»çº¿å®‰è£…åŒ…é‡Œï¼Œéƒ¨ç½²çš„æ—¶å€™ä¼šåˆ†å‘åˆ°é›†ç¾¤èŠ‚ç‚¹ä¸Šï¼Œæ•´ä¸ªéƒ¨ç½²è¿‡ç¨‹éƒ½æ— éœ€è®¿é—®å…¬ç½‘ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tar -tf kube1.20.0.tar.gz</span><br><span class="line">kube/bin/kubelet</span><br><span class="line">kube/bin/kubectl</span><br><span class="line">kube/bin/conntrack</span><br><span class="line">kube/bin/kubeadm</span><br></pre></td></tr></table></figure><h4 id="kubekey-1"><a href="#kubekey-1" class="headerlink" title="kubekey"></a>kubekey</h4><p>åœ¨ kubekey çš„æºç å½“ä¸­ï¼Œæ˜¯å°†æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶çš„ URL ç¡¬ç¼–ç åœ¨ä»£ç å½“ä¸­çš„ã€‚å¦‚æœåœ¨éƒ¨ç½²çš„æ—¶å€™éœ€è¦æ ¹æ®éƒ¨ç½²ç¯å¢ƒæ¥ä¿®æ”¹äºŒè¿›åˆ¶æ–‡ä»¶çš„ä¸‹è½½åœ°å€ï¼Œæ¯”å¦‚ä»å†…ç½‘ nginx æœåŠ¡å™¨ä¸Šä¸‹è½½ï¼Œå°±éœ€è¦ä¿®æ”¹è¿™éƒ¨åˆ†æºç æŠŠ <code>https://kubernetes-release.pek3b.qingstor.com</code> ä¿®æ”¹æˆå†…ç½‘åœ°å€ï¼Œæ¯”å¦‚ <code>http://172.20.0.25:8080/files</code> ï¼Œç„¶è€Œåœ¨éƒ¨ç½²çš„æ—¶å€™é‡æ–°ç¼–è¯‘ kubekey çš„ä»£ç åˆå¿…é¡»èƒ½è®¿é—®å…¬ç½‘æ‰è¡Œï¼Œè¿™å°±å¾ˆåƒµç¡¬ã€‚æ‰€ä»¥ä»¥ç›®å‰å¼€æºçš„ kubekey æ¥çœ‹ï¼Œæ˜¯æ²¡æœ‰åŠæ³•åšåˆ°æ— ç½‘ç¯å¢ƒä¸­æ„‰å¿«åœ°éƒ¨ç½² k8s çš„ï¼Œå¯èƒ½å•†ä¸šç‰ˆçš„æ”¯æŒï¼ˆçŒœæµ‹ã€‚</p><ul><li><a href="https://github.com/kubesphere/kubekey/blob/master/pkg/kubernetes/preinstall/preinstall.go" target="_blank" rel="noopener">kubekey/blob/master/pkg/kubernetes/preinstall/preinstall.go</a></li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FilesDownloadHTTP defines the kubernetes' binaries that need to be downloaded in advance and downloads them.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FilesDownloadHTTP</span><span class="params">(mgr *manager.Manager, filepath, version, arch <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">kkzone := os.Getenv(<span class="string">"KKZONE"</span>)</span><br><span class="line">etcd := files.KubeBinary&#123;Name: <span class="string">"etcd"</span>, Arch: arch, Version: kubekeyapiv1alpha1.DefaultEtcdVersion&#125;</span><br><span class="line">kubeadm := files.KubeBinary&#123;Name: <span class="string">"kubeadm"</span>, Arch: arch, Version: version&#125;</span><br><span class="line">kubelet := files.KubeBinary&#123;Name: <span class="string">"kubelet"</span>, Arch: arch, Version: version&#125;</span><br><span class="line">kubectl := files.KubeBinary&#123;Name: <span class="string">"kubectl"</span>, Arch: arch, Version: version&#125;</span><br><span class="line">kubecni := files.KubeBinary&#123;Name: <span class="string">"kubecni"</span>, Arch: arch, Version: kubekeyapiv1alpha1.DefaultCniVersion&#125;</span><br><span class="line">helm := files.KubeBinary&#123;Name: <span class="string">"helm"</span>, Arch: arch, Version: kubekeyapiv1alpha1.DefaultHelmVersion&#125;</span><br><span class="line"></span><br><span class="line">etcd.Path = fmt.Sprintf(<span class="string">"%s/etcd-%s-linux-%s.tar.gz"</span>, filepath, kubekeyapiv1alpha1.DefaultEtcdVersion, arch)</span><br><span class="line">kubeadm.Path = fmt.Sprintf(<span class="string">"%s/kubeadm"</span>, filepath)</span><br><span class="line">kubelet.Path = fmt.Sprintf(<span class="string">"%s/kubelet"</span>, filepath)</span><br><span class="line">kubectl.Path = fmt.Sprintf(<span class="string">"%s/kubectl"</span>, filepath)</span><br><span class="line">kubecni.Path = fmt.Sprintf(<span class="string">"%s/cni-plugins-linux-%s-%s.tgz"</span>, filepath, arch, kubekeyapiv1alpha1.DefaultCniVersion)</span><br><span class="line">helm.Path = fmt.Sprintf(<span class="string">"%s/helm"</span>, filepath)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> kkzone == <span class="string">"cn"</span> &#123;</span><br><span class="line">etcd.Url = fmt.Sprintf(<span class="string">"https://kubernetes-release.pek3b.qingstor.com/etcd/release/download/%s/etcd-%s-linux-%s.tar.gz"</span>, etcd.Version, etcd.Version, etcd.Arch)</span><br><span class="line">kubeadm.Url = fmt.Sprintf(<span class="string">"https://kubernetes-release.pek3b.qingstor.com/release/%s/bin/linux/%s/kubeadm"</span>, kubeadm.Version, kubeadm.Arch)</span><br><span class="line">kubelet.Url = fmt.Sprintf(<span class="string">"https://kubernetes-release.pek3b.qingstor.com/release/%s/bin/linux/%s/kubelet"</span>, kubelet.Version, kubelet.Arch)</span><br><span class="line">kubectl.Url = fmt.Sprintf(<span class="string">"https://kubernetes-release.pek3b.qingstor.com/release/%s/bin/linux/%s/kubectl"</span>, kubectl.Version, kubectl.Arch)</span><br><span class="line">kubecni.Url = fmt.Sprintf(<span class="string">"https://containernetworking.pek3b.qingstor.com/plugins/releases/download/%s/cni-plugins-linux-%s-%s.tgz"</span>, kubecni.Version, kubecni.Arch, kubecni.Version)</span><br><span class="line">helm.Url = fmt.Sprintf(<span class="string">"https://kubernetes-helm.pek3b.qingstor.com/linux-%s/%s/helm"</span>, helm.Arch, helm.Version)</span><br><span class="line">helm.GetCmd = mgr.DownloadCommand(helm.Path, helm.Url)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">etcd.Url = fmt.Sprintf(<span class="string">"https://github.com/coreos/etcd/releases/download/%s/etcd-%s-linux-%s.tar.gz"</span>, etcd.Version, etcd.Version, etcd.Arch)</span><br><span class="line">kubeadm.Url = fmt.Sprintf(<span class="string">"https://storage.googleapis.com/kubernetes-release/release/%s/bin/linux/%s/kubeadm"</span>, kubeadm.Version, kubeadm.Arch)</span><br><span class="line">kubelet.Url = fmt.Sprintf(<span class="string">"https://storage.googleapis.com/kubernetes-release/release/%s/bin/linux/%s/kubelet"</span>, kubelet.Version, kubelet.Arch)</span><br><span class="line">kubectl.Url = fmt.Sprintf(<span class="string">"https://storage.googleapis.com/kubernetes-release/release/%s/bin/linux/%s/kubectl"</span>, kubectl.Version, kubectl.Arch)</span><br><span class="line">kubecni.Url = fmt.Sprintf(<span class="string">"https://github.com/containernetworking/plugins/releases/download/%s/cni-plugins-linux-%s-%s.tgz"</span>, kubecni.Version, kubecni.Arch, kubecni.Version)</span><br><span class="line">helm.Url = fmt.Sprintf(<span class="string">"https://get.helm.sh/helm-%s-linux-%s.tar.gz"</span>, helm.Version, helm.Arch)</span><br><span class="line">getCmd := mgr.DownloadCommand(fmt.Sprintf(<span class="string">"%s/helm-%s-linux-%s.tar.gz"</span>, filepath, helm.Version, helm.Arch), helm.Url)</span><br><span class="line">helm.GetCmd = fmt.Sprintf(<span class="string">"%s &amp;&amp; cd %s &amp;&amp; tar -zxf helm-%s-linux-%s.tar.gz &amp;&amp; mv linux-%s/helm . &amp;&amp; rm -rf *linux-%s*"</span>, getCmd, filepath, helm.Version, helm.Arch, helm.Arch, helm.Arch)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤– kubekey åœ¨å®‰è£… docker æ—¶ï¼Œæ˜¯ç›´æ¥è°ƒç”¨çš„ <a href="https://get.docker.com/" target="_blank" rel="noopener">docker å®˜æ–¹çš„è„šæœ¬</a> æ¥å®‰è£…ï¼Œå®‰è£…è¿‡ç¨‹ä¹Ÿå¿…é¡»è®¿é—®å…¬ç½‘æ‰è¡Œã€‚</p><ul><li><a href="https://github.com/kubesphere/kubekey/blob/master/pkg/container-engine/docker/docker.go" target="_blank" rel="noopener">kubekey/blob/master/pkg/container-engine/docker/docker.go</a></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">installDockerOnNode</span><span class="params">(mgr *manager.Manager, _ *kubekeyapiv1alpha1.HostCfg)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">dockerConfig, err := GenerateDockerConfig(mgr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">dockerConfigBase64 := base64.StdEncoding.EncodeToString([]<span class="keyword">byte</span>(dockerConfig))</span><br><span class="line">output, err1 := mgr.Runner.ExecuteCmd(fmt.Sprintf(<span class="string">"sudo -E /bin/sh -c \"if [ -z $(which docker) ] || [ ! -e /var/run/docker.sock ]; then curl https://kubernetes.pek3b.qingstor.com/tools/kubekey/docker-install.sh | sh &amp;&amp; systemctl enable docker; if [ ! -f /etc/docker/daemon.json ]; then mkdir -p /etc/docker &amp;&amp; echo %s | base64 -d &gt; /etc/docker/daemon.json; fi; systemctl daemon-reload &amp;&amp; systemctl restart docker; fi\""</span>, dockerConfigBase64), <span class="number">0</span>, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">if</span> err1 != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errors.Wrap(errors.WithStack(err1), fmt.Sprintf(<span class="string">"Failed to install docker:\n%s"</span>, output))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ docker å®˜æ–¹çš„å®‰è£…è„šæœ¬æ¥å®‰è£… docker æ˜¯æœ‰ä¸€ä¸ªæ˜æ˜¾çš„é—®é¢˜å°±æ˜¯ï¼šæ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶ï¼Œä¸èƒ½æŒ‡å®š docker çš„ç‰ˆæœ¬ï¼Œæ¯æ¬¡å®‰è£…çš„ docker ç‰ˆæœ¬éƒ½æ˜¯æœ€æ–°çš„ stable ç‰ˆæœ¬ã€‚æ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶å°±ä¼šå¯¼è‡´ä¸åŒæ—¶é—´éƒ¨ç½²çš„é›†ç¾¤æˆ–è€…åŠ å…¥çš„èŠ‚ç‚¹ï¼Œdocker ç‰ˆæœ¬å¯èƒ½å°±ä¸ä¸€æ ·ï¼Œåœ¨è¿™é‡Œå¯èƒ½ä¼šåŸ‹ä¸‹ä¸€äº›å‘ï¼Œå¯èƒ½ä¼šå¸¦æ¥ä¸€å®šçš„ç»´æŠ¤æˆæœ¬æˆ–è€…å°†æ¥å‡çº§æ—¶é‡åˆ°é—®é¢˜ã€‚</p><p>ç¼–è¯‘è¿‡ kubernetes ç»„ä»¶çš„å¯èƒ½éƒ½çŸ¥é“ k8s æºç å½“ä¸­å­˜åœ¨ä¸€ä¸ª <a href="https://github.com/kubernetes/kubernetes/blob/master/build/dependencies.yaml" target="_blank" rel="noopener">build/dependencies.yaml</a> çš„æ–‡ä»¶ï¼Œé‡Œé¢è®°å½•çš„æ˜¯ k8s ç»„ä»¶ä¸å…¶ä»–ç»„ä»¶ (å¦‚ docker, etcd, coredns, cni, pause) æ‰€åŒ¹é…çš„æœ€ä½³ç‰ˆæœ¬ã€‚</p><blockquote><p>On each of your nodes, install the Docker for your Linux distribution as per <a href="https://docs.docker.com/engine/install/#server" target="_blank" rel="noopener">Install Docker Engine</a>. You can find the latest validated version of Docker in this <a href="https://git.k8s.io/kubernetes/build/dependencies.yaml" target="_blank" rel="noopener">dependencies</a> file.</p></blockquote><ul><li><a href="https://github.com/kubernetes/kubernetes/blob/release-1.20/build/dependencies.yaml" target="_blank" rel="noopener">kubernetes/blob/release-1.20/build/dependencies.yaml</a></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="comment"># zeitgeist (https://github.com/kubernetes-sigs/zeitgeist) was inspired by</span></span><br><span class="line">  <span class="comment"># (and now replaces) the cmd/verifydependencies tool to verify external</span></span><br><span class="line">  <span class="comment"># dependencies across the repo.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># The zeitgeist dependencies.yaml file format is intended to be</span></span><br><span class="line">  <span class="comment"># backwards-compatible with the original tooling.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># In instances where the file format may change across versions, this meta</span></span><br><span class="line">  <span class="comment"># dependency check exists to ensure we're pinned to a known good version.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># ref: https://github.com/kubernetes/kubernetes/pull/98845</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Docker</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"docker"</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">19.03</span></span><br><span class="line">    <span class="attr">refPaths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">vendor/k8s.io/system-validators/validators/docker_validator.go</span></span><br><span class="line">      <span class="attr">match:</span> <span class="string">latestValidatedDockerVersion</span></span><br></pre></td></tr></table></figure><p>ä»¥ 1.20.x ç‰ˆæœ¬çš„ k8s ä¸ºä¾‹ï¼Œå®ƒæ‰€ä¾èµ–çš„ docker ç‰ˆæœ¬ä¸º 19.03ï¼Œè€Œç°åœ¨æœ€æ–°çš„ docker ç‰ˆæœ¬å¦‚ 20.10.8ï¼Œå¹¶ä¸æ˜¯ K8s å®˜æ–¹æ‰€å»ºè®®çš„æœ€ä½³ç‰ˆæœ¬ã€‚æ€»ä¹‹ï¼Œæˆ‘ä»¬åœ¨éƒ¨ç½² K8s æ—¶ï¼Œå¯ä»¥å‚è€ƒ <a href="https://github.com/kubernetes/kubernetes/blob/master/build/dependencies.yaml" target="_blank" rel="noopener">build/dependencies.yaml</a> æ¥ç¡®å®šä¸ K8s ç›¸å…³çš„ç»„ä»¶åº”è¯¥é€‰æ‹©å“ªä¸€ä¸ªæœ€ä½³çš„ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯éšä¾¿è£…ä¸€ä¸ªæœ€æ–°çš„ç‰ˆæœ¬å°±å®Œäº‹å„¿äº†ã€‚</p><h4 id="kubespray"><a href="#kubespray" class="headerlink" title="kubespray"></a>kubespray</h4><p>åœ¨ kubespray ä¸­ï¼Œæ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶çš„ URL éƒ½æ˜¯é€šè¿‡å˜é‡çš„æ–¹å¼å®šä¹‰çš„ï¼Œæƒ³è¦åšåˆ°ç¦»çº¿éƒ¨ç½²ååˆ†ç®€å•ï¼Œåªéœ€è¦é€šè¿‡ ansible å˜é‡ä¼˜å…ˆçº§çš„ç‰¹æ€§ï¼Œå°†å®ƒä»¬åœ¨ group_vars é€šè¿‡ overrides çš„æ–¹å¼è¦†ç›–å³å¯ã€‚æ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download URLs</span></span><br><span class="line"><span class="attr">kubelet_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubelet"</span></span><br><span class="line"><span class="attr">kubectl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubectl"</span></span><br><span class="line"><span class="attr">kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubeadm"</span></span><br></pre></td></tr></table></figure><h3 id="images"><a href="#images" class="headerlink" title="images"></a>images</h3><p>ä¸€äº›å¦‚ kube-proxyã€kube-apiserverã€corednsã€calico ç»„ä»¶é•œåƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">k8s.gcr.io/kube-apiserver:v1.20.7</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.20.7</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.20.7</span><br><span class="line">k8s.gcr.io/kube-registry-proxy:0.4</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.20.7</span><br><span class="line">k8s.gcr.io/pause:3.3</span><br><span class="line">k8s.gcr.io/coredns:1.7.0</span><br><span class="line">k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64:1.8.3</span><br><span class="line">k8s.gcr.io/dns/k8s-dns-node-cache:1.17.1</span><br></pre></td></tr></table></figure><h4 id="sealos-2"><a href="#sealos-2" class="headerlink" title="sealos"></a>sealos</h4><p>sealos å°†è¿™äº›é•œåƒä½¿ç”¨ docker save çš„æ–¹å¼æ‰“åŒ…æˆä¸€ä¸ª tar åŒ…ï¼Œåœ¨éƒ¨ç½²çš„æ—¶å€™ä½¿ç”¨ docker/ctr load çš„æ–¹å¼å°†é•œåƒå¯¼å…¥åˆ°å®¹å™¨è¿è¡Œæ—¶çš„å­˜å‚¨ç›®å½•å½“ä¸­ï¼Œæºç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/fanux/sealos/blob/develop/install/send.go" target="_blank" rel="noopener">fanux/sealos/blob/develop/install/send.go</a></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendPackage is send new pkg to all nodes.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *SealosUpgrade)</span> <span class="title">SendPackage</span><span class="params">()</span></span> &#123;</span><br><span class="line">all := <span class="built_in">append</span>(u.Masters, u.Nodes...)</span><br><span class="line">pkg := path.Base(u.NewPkgUrl)</span><br><span class="line"><span class="comment">// rm old sealos in package avoid old version problem. if sealos not exist in package then skip rm</span></span><br><span class="line"><span class="keyword">var</span> kubeHook <span class="keyword">string</span></span><br><span class="line"><span class="keyword">if</span> For120(Version) &#123;</span><br><span class="line"><span class="comment">// TODO update need load modprobe -- br_netfilter modprobe -- bridge.</span></span><br><span class="line"><span class="comment">// https://github.com/fanux/cloud-kernel/issues/23</span></span><br><span class="line">kubeHook = fmt.Sprintf(<span class="string">"cd /root &amp;&amp; rm -rf kube &amp;&amp; tar zxvf %s  &amp;&amp; cd /root/kube/shell &amp;&amp; rm -f ../bin/sealos &amp;&amp; (ctr -n=k8s.io image import ../images/images.tar || true) &amp;&amp; cp -f ../bin/* /usr/bin/ "</span>, pkg)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">kubeHook = fmt.Sprintf(<span class="string">"cd /root &amp;&amp; rm -rf kube &amp;&amp; tar zxvf %s  &amp;&amp; cd /root/kube/shell &amp;&amp; rm -f ../bin/sealos &amp;&amp; (docker load -i ../images/images.tar || true) &amp;&amp; cp -f ../bin/* /usr/bin/ "</span>, pkg)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PkgUrl = SendPackage(pkg, all, <span class="string">"/root"</span>, <span class="literal">nil</span>, &amp;kubeHook)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ç§æ–¹å¼åŠ è½½é•œåƒæœ‰ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„é™åˆ¶å°±æ˜¯ kube-apiserver çš„ admission å‡†å…¥æ§åˆ¶ä¸­ä¸èƒ½åŠ å…¥ <code>AlwaysPullImages</code> å‚æ•°ã€‚ä¸ç„¶ä¸è¿™äº›é•œåƒç›¸å…³çš„ pod é‡æ–°è°ƒåº¦æˆ–è€…é‡å¯ä¹‹åä¼šé‡æ–°ä»æºé•œåƒä»“åº“æ‹‰å–é•œåƒï¼Œåœ¨æ— ç½‘æˆ–è€…ç½‘ç»œé™åˆ¶çš„ç¯å¢ƒä¸­å¯èƒ½æ— æ³•æ‹‰å–é•œåƒå¯¼è‡´è¿™äº› Pod å¯åŠ¨å¤±è´¥ï¼Œä»è€Œå¯¼è‡´é›†ç¾¤å¼‚å¸¸ã€‚</p><p>è€Œåœ¨å¤šç§Ÿæˆ·åœºæ™¯ä¸‹ï¼Œå‡ºäºå®‰å…¨çš„è€ƒè™‘  <code>AlwaysPullImages</code> å‡†å…¥æ§åˆ¶å¾€å¾€æ˜¯è¦å¼€å¯çš„ã€‚å› æ­¤ sealos å¯èƒ½å¹¶ä¸é€‚ç”¨äºå¤šç§Ÿæˆ·æˆ–è€…å¯¹æ­¤æœ‰è¦æ±‚çš„ç¯å¢ƒä¸­ï¼ˆæœ€å¸¸è§çš„å°±æ˜¯ PaaS å¹³å°ï¼‰ã€‚</p><blockquote><p>è¯¥å‡†å…¥æ§åˆ¶å™¨ä¼šä¿®æ”¹æ¯ä¸€ä¸ªæ–°åˆ›å»ºçš„ Pod çš„é•œåƒæ‹‰å–ç­–ç•¥ä¸º Always ã€‚ è¿™åœ¨å¤šç§Ÿæˆ·é›†ç¾¤ä¸­æ˜¯æœ‰ç”¨çš„ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥æ”¾å¿ƒï¼Œä»–ä»¬çš„ç§æœ‰é•œåƒåªèƒ½è¢«é‚£äº›æœ‰å‡­è¯çš„äººä½¿ç”¨ã€‚ å¦‚æœæ²¡æœ‰è¿™ä¸ªå‡†å…¥æ§åˆ¶å™¨ï¼Œä¸€æ—¦é•œåƒè¢«æ‹‰å–åˆ°èŠ‚ç‚¹ä¸Šï¼Œä»»ä½•ç”¨æˆ·çš„ Pod éƒ½å¯ä»¥é€šè¿‡å·²äº†è§£åˆ°çš„é•œåƒçš„åç§°ï¼ˆå‡è®¾ Pod è¢«è°ƒåº¦åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ä¸Šï¼‰æ¥ä½¿ç”¨å®ƒï¼Œè€Œä¸éœ€è¦å¯¹é•œåƒè¿›è¡Œä»»ä½•æˆæƒæ£€æŸ¥ã€‚ å½“å¯ç”¨è¿™ä¸ªå‡†å…¥æ§åˆ¶å™¨æ—¶ï¼Œæ€»æ˜¯åœ¨å¯åŠ¨å®¹å™¨ä¹‹å‰æ‹‰å–é•œåƒï¼Œè¿™æ„å‘³ç€éœ€è¦æœ‰æ•ˆçš„å‡­è¯ã€‚</p></blockquote><h4 id="kubekey-2"><a href="#kubekey-2" class="headerlink" title="kubekey"></a>kubekey</h4><p><a href="https://kubesphere.io/docs/installing-on-linux/introduction/air-gapped-installation/" target="_blank" rel="noopener">kubekey å®˜æ–¹çš„æ–‡æ¡£</a> ä¸­æœ‰æåˆ°ç»„ä»¶é•œåƒç¦»çº¿éƒ¨ç½²çš„æ–¹å¼ï¼Œä¸è¿‡ååˆ†ç¹ç(åŠé€€ ğŸ˜‚)ï¼Œåœ¨ <a href="https://github.com/kubesphere/kubekey/issues/597" target="_blank" rel="noopener">Offline installation is too troublesome #597</a> ä¸­ä¹Ÿæœ‰äººåæ§½è¿™ä¸ªé—®é¢˜ã€‚ä¸è¿‡ç›®å‰ kubekey å¼€å‘å›¢é˜Ÿå·²ç»åœ¨é‡æ„è¿™éƒ¨åˆ†å†…å®¹äº†ï¼Œè‡³äºç»“æœå¦‚ä½•ï¼Œåªèƒ½ç­‰äº†ã€‚</p><h4 id="é•œåƒä»“åº“"><a href="#é•œåƒä»“åº“" class="headerlink" title="é•œåƒä»“åº“"></a>é•œåƒä»“åº“</h4><p>åœ¨ç§æœ‰äº‘ç¯å¢ƒä¸­ï¼Œä¼ä¸šä¸€èˆ¬éƒ½ä¼šæœ‰è‡ªå·±çš„é•œåƒä»“åº“ï¼ˆæ¯”å¦‚ harbor ï¼‰ç”¨äºå­˜æ”¾ä¸šåŠ¡ç»„ä»¶é•œåƒæˆ–è€…ä¸€äº›å…¶ä»–å¹³å°ä¾èµ–çš„é•œåƒã€‚å†åŠ ä¸Š Docker Hub è‡ªä»å»å¹´å¼€å§‹å°±åŠ å…¥äº† pull é•œåƒæ¬¡æ•°çš„é™åˆ¶ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨ Docker Hub ä¸Šé¢çš„é•œåƒæ¥éƒ¨ç½²é›†ç¾¤ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå› ä¸º <a href="https://www.docker.com/increase-rate-limit" target="_blank" rel="noopener">429 toomanyrequests</a> æˆ–è€…ä¸€äº›ç½‘ç»œåŸå› å¯¼è‡´æ‹‰å–é•œåƒå¤±è´¥ã€‚å› æ­¤å¯¹äº k8s é›†ç¾¤éƒ¨ç½²è€Œè¨€ï¼Œå»ºè®®ä½¿ç”¨å†…éƒ¨è‡ªå·±çš„é•œåƒä»“åº“ï¼Œè€Œéå…¬ç½‘ä¸Šé•œåƒä»“åº“ã€‚å¦‚æœæ²¡æœ‰çš„è¯å¯ä»¥ä½¿ç”¨ harbor æˆ–è€… docker registry åœ¨æœ¬åœ°éƒ¨ç½²ä¸€ä¸ªé•œåƒä»“åº“ã€‚æˆ‘ä»¬å°†éƒ¨ç½²ä¾èµ–çš„é•œåƒå¯¼å…¥åˆ°å·²ç»å­˜åœ¨çš„é•œåƒä»“åº“ä¸­ï¼Œéƒ¨ç½²çš„æ—¶å€™ä»è¯¥é•œåƒä»“åº“æ‹‰å–å³å¯ã€‚</p><h2 id="éƒ¨ç½²å·¥å…·é€‰æ‹©"><a href="#éƒ¨ç½²å·¥å…·é€‰æ‹©" class="headerlink" title="éƒ¨ç½²å·¥å…·é€‰æ‹©"></a>éƒ¨ç½²å·¥å…·é€‰æ‹©</h2><p>ä¸Šé¢ç®€å•æ¢³ç†äº†ä¸€ä¸‹éƒ¨ç½² k8s é›†ç¾¤è¿‡ç¨‹ä¸­æ‰€ä¾èµ–çš„çš„åœ¨çº¿èµ„æºï¼Œä»¥åŠå¦‚ä½•å°†å®ƒä»¬åˆ¶ä½œæˆç¦»çº¿èµ„æºçš„ä¸€äº›åˆ†æã€‚ä¸Šé¢æåŠçš„éƒ¨ç½²å·¥å…·å„æœ‰å„çš„ä¼˜ç¼ºç‚¹ï¼Œé’ˆå¯¹ä»¥ä¸‹ä¸¤ç§ä¸åŒçš„åœºæ™¯å¯ä»¥é€‰æ‹©ä¸åŒçš„éƒ¨ç½²å·¥å…·ã€‚</p><h3 id="sealos-3"><a href="#sealos-3" class="headerlink" title="sealos"></a>sealos</h3><p>å¦‚æœä»…ä»…æ˜¯éƒ¨ç½²ä¸€ä¸ªç®€å•çš„ k8s é›†ç¾¤ï¼Œå¯¹é›†ç¾¤æ²¡æœ‰å¤ªå¤šå®šåˆ¶åŒ–çš„éœ€æ±‚ï¼Œé‚£ä¹ˆä½¿ç”¨ <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a> å¯èƒ½æ˜¯æœ€ä½³çš„é€‰æ‹©ï¼Œåªä¸è¿‡å®ƒæ˜¯æ”¶è´¹çš„ï¼Œ<a href="https://www.sealyun.com/" target="_blank" rel="noopener">éœ€è¦å……å€¼ä¼šå‘˜</a> ğŸ˜‚ã€‚</p><blockquote><h3 id="ç°åœ¨å¼€å§‹-ï¿¥99-ï¿¥69-å¹´"><a href="#ç°åœ¨å¼€å§‹-ï¿¥99-ï¿¥69-å¹´" class="headerlink" title="ç°åœ¨å¼€å§‹ ï¿¥99 ï¿¥69/å¹´"></a>ç°åœ¨å¼€å§‹ <del>ï¿¥99</del> ï¿¥69/å¹´</h3><p>æ¬¢è¿æˆä¸ºå¹´è´¹ä¼šå‘˜ï¼Œä»»æ„ä¸‹è½½æ‰€æœ‰ç‰ˆæœ¬è½¯ä»¶åŒ…!</p><blockquote><p>@F-liuhui ç¦»çº¿åŒ…å±…ç„¶è¦æ”¶è´¹ï¼Ÿé‚£è¿˜æ˜¯å¼€æºé¡¹ç›®å—ï¼Ÿ</p></blockquote><p>å¼€æºä¸ä»˜è´¹ä¸å†²çªï¼Œ100% å¼€æº 100% ä»˜è´¹</p><p><a href="https://www.sealyun.com/" target="_blank" rel="noopener">sealyun.com</a></p></blockquote><p>å¦‚æœåŠ¨æ‰‹èƒ½åŠ›å¼ºçš„è¯ï¼Œå¯ä»¥æ ¹æ® selaos ç¦»çº¿å®‰è£…åŒ…çš„ç›®å½•ç»“æ„ä½¿ç”¨ GitHub Actions æ¥æ„å»ºï¼Œå®ç°èµ·æ¥ä¹Ÿä¸æ˜¯å¾ˆéš¾ã€‚åªä¸è¿‡ç ¸åˆ«äººé¥­ç¢—çš„äº‹å„¿è¿˜æ˜¯ä¸åšä¸ºå¥½ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥é€‰æ‹©å¦ä¸€ç§æ–¹æ¡ˆæ¥å®ç°ï¼Œè¿™æ ·ä¹Ÿèƒ½é¿å…ä¸€äº›å•†ä¸šçº çº·é—®é¢˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ tar -tf kube1.20.0.tar.gz</span><br><span class="line">kube/</span><br><span class="line">kube/lib64/</span><br><span class="line">kube/lib64/README.md</span><br><span class="line">kube/lib64/libseccomp.so.2</span><br><span class="line">kube/lib64/libseccomp.so.2.3.1</span><br><span class="line">kube/shell/</span><br><span class="line">kube/shell/containerd.sh</span><br><span class="line">kube/shell/init.sh</span><br><span class="line">kube/shell/master.sh</span><br><span class="line">kube/README.md</span><br><span class="line">kube/bin/</span><br><span class="line">kube/bin/kubelet</span><br><span class="line">kube/bin/kubectl</span><br><span class="line">kube/bin/conntrack</span><br><span class="line">kube/bin/kubeadm</span><br><span class="line">kube/bin/kubelet-pre-start.sh</span><br><span class="line">kube/conf/</span><br><span class="line">kube/conf/kubeadm.yaml</span><br><span class="line">kube/conf/kubelet.service</span><br><span class="line">kube/conf/calico.yaml</span><br><span class="line">kube/conf/10-kubeadm.conf</span><br><span class="line">kube/conf/net/</span><br><span class="line">kube/conf/net/calico.yaml</span><br><span class="line">kube/containerd/</span><br><span class="line">kube/containerd/README.md</span><br><span class="line">kube/containerd/cri-containerd-cni-linux-amd64.tar.gz</span><br><span class="line">kube/images/</span><br><span class="line">kube/images/images.tar</span><br><span class="line">kube/images/README.md</span><br></pre></td></tr></table></figure><h3 id="kubekey-3"><a href="#kubekey-3" class="headerlink" title="kubekey"></a>kubekey</h3><p>ç”±äº kubekey éƒ¨ç½²æ—¶äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦å…¬ç½‘è·å–ï¼Œdocker æ— æ³•ç¦»çº¿éƒ¨ç½²ä»¥åŠéœ€è¦æ‰‹åŠ¨å®‰è£…ä¸€äº›å‰ç½®ä¾èµ–ï¼Œæ²¡æœ‰åŠæ³•åšåˆ°å®Œæ•´çš„ç¦»çº¿éƒ¨ç½²ï¼Œå› æ­¤ç¦»çº¿éƒ¨ç½²çš„æ–¹æ¡ˆä¹Ÿå°±ç›´æ¥æ”¾å¼ƒæ‰äº†ï¼ŒæŠ½ç©ºä»–ä»¬æä¸ª Issue æˆ– PR çœ‹çœ‹èƒ½å¦æ”¯æŒè¿™éƒ¨åˆ† ğŸ˜…ã€‚</p><h3 id="kubespray-1"><a href="#kubespray-1" class="headerlink" title="kubespray"></a>kubespray</h3><p>å¦‚æœæƒ³æ‰¾ä¸€ä¸ªå³å¼€æºåˆå…è´¹çš„ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆï¼Œæˆ–è€…å¯¹é›†ç¾¤éƒ¨ç½²æœ‰ç‰¹æ®Šçš„è¦æ±‚ï¼Œæ¯”å¦‚åŸºäº K8s çš„ PaaS toB äº§å“ï¼Œéœ€è¦åœ¨éƒ¨ç½²æ—¶å®‰è£…å¹³å°æœ¬èº«éœ€è¦çš„ä¸€äº›ä¾èµ–ï¼ˆå¦‚å­˜å‚¨å®¢æˆ·ç«¯ã€GPU é©±åŠ¨ç­‰ï¼‰ã€‚é‚£ä¹ˆä¸å¦¨å…ˆçœ‹ä¸€ä¸‹ kubernetes-sig ç¤¾åŒºçš„ <a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener">kubespray</a> å¦‚ä½• ğŸ¤”ï¼Œä¸»è¦çš„ç‰¹æ€§å¦‚ä¸‹ï¼š</p><ul><li>æ”¯æŒçš„ 10 ç§ CNI æ’ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- cni-plugins v0.9.1</span><br><span class="line">- calico v3.17.4</span><br><span class="line">- canal (given calico/flannel versions)</span><br><span class="line">- cilium v1.9.9</span><br><span class="line">- flanneld v0.14.0</span><br><span class="line">- kube-ovn v1.7.1</span><br><span class="line">- kube-router v1.3.0</span><br><span class="line">- multus v3.7.2</span><br><span class="line">- ovn4nfv v1.1.0</span><br><span class="line">- weave v2.8.1</span><br></pre></td></tr></table></figure><ul><li>æ”¯æŒ 3 ç§å®¹å™¨è¿è¡Œæ—¶ä»¥åŠ <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/kata-containers.md" target="_blank" rel="noopener">Kata Containers</a> è¿˜æœ‰ nvidia-gpu-device-plugin ç­‰</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- docker v20.10</span><br><span class="line">- containerd v1.4.6</span><br><span class="line">- cri-o v1.21</span><br></pre></td></tr></table></figure><ul><li>é€‚é…äº† 10 ç§ Linux å‘è¡Œç‰ˆï¼Œè¦†ç›–äº†ç»å¤§å¤šæ•°ç§æœ‰äº‘åœºæ™¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- Flatcar Container Linux by Kinvolk</span><br><span class="line">- Debian Buster, Jessie, Stretch, Wheezy</span><br><span class="line">- Ubuntu 16.04, 18.04, 20.04</span><br><span class="line">- CentOS/RHEL 7, 8</span><br><span class="line">- Fedora 33, 34</span><br><span class="line">- Fedora CoreOS (see fcos Note)</span><br><span class="line">- openSUSE Leap 15.x/Tumbleweed</span><br><span class="line">- Oracle Linux 7, 8</span><br><span class="line">- Alma Linux 8</span><br><span class="line">- Amazon Linux 2</span><br></pre></td></tr></table></figure><ul><li>ä¸°å¯Œçš„æ’ä»¶å’Œæ‰©å±•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## å·¥å…·ç±»</span></span><br><span class="line">- helm</span><br><span class="line">- krew</span><br><span class="line">- nerdctl</span><br><span class="line"></span><br><span class="line"><span class="comment">## ä¸€äº› controller å’Œ provisioner</span></span><br><span class="line">- ambassador: v1.5</span><br><span class="line">- cephfs-provisioner v2.1.0-k8s1.11</span><br><span class="line">- rbd-provisioner v2.1.1-k8s1.11</span><br><span class="line">- cert-manager v0.16.1</span><br><span class="line">- coredns v1.8.0</span><br><span class="line">- ingress-nginx v0.43.0</span><br></pre></td></tr></table></figure><ul><li>ä¾èµ–çš„æ–‡ä»¶å’Œé•œåƒæ”¯æŒç¦»çº¿éƒ¨ç½² <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/offline-environment.md" target="_blank" rel="noopener">Offline environment</a></li></ul><p>kubespray å¯¹æ‰€æœ‰çš„ä¾èµ–èµ„æºéƒ½åšåˆ°äº†ç¦»çº¿ä¸‹è½½çš„æ”¯æŒï¼šæ¯”å¦‚æ‰€æœ‰ä¾èµ–æ–‡ä»¶çš„ URL éƒ½é€šè¿‡å˜é‡çš„æ–¹å¼æ¥å®šä¹‰ï¼Œè€Œé kubekey é‚£æ ·ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼›æ‰€æœ‰é•œåƒçš„ repo å’Œ tag éƒ½æ˜¯é€šè¿‡å˜é‡çš„æ–¹å¼æ¥å®šä¹‰ã€‚è¿™æ ·çš„å¥½å¤„å°±æ˜¯åœ¨éƒ¨ç½²çš„æ—¶å€™å¯ä»¥æ ¹æ®å®¢æˆ·ç¯å¢ƒçš„çš„é•œåƒä»“åº“åœ°å€å’Œæ–‡ä»¶æœåŠ¡å™¨çš„ URL åœ°å€æ¥å¡«å†™ç›¸åº”çš„å‚æ•°ï¼Œæ— éœ€é€šè¿‡å…¬ç½‘æ¥è·å–ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Registry overrides</span></span><br><span class="line"><span class="attr">kube_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_host &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">gcr_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_host &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">docker_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_host &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">quay_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_host &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/kubeadm"</span></span><br><span class="line"><span class="attr">kubectl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/kubectl"</span></span><br><span class="line"><span class="attr">kubelet_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/kubelet"</span></span><br><span class="line"><span class="comment"># etcd is optional if you **DON'T** use etcd_deployment=host</span></span><br><span class="line"><span class="attr">etcd_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/etcd/etcd-<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>-linux-amd64.tar.gz"</span></span><br><span class="line"><span class="attr">cni_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/cni/cni-plugins-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>-<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>.tgz"</span></span><br><span class="line"><span class="attr">crictl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/cri-tools/crictl-<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="comment"># If using Calico</span></span><br><span class="line"><span class="attr">calicoctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/calico/<span class="template-variable">&#123;&#123; calico_ctl_version &#125;&#125;</span>/calicoctl-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><p>å’Œä¸Šè¿°å‡ ç§éƒ¨ç½²å·¥å…·å¯¹æ¯”ä¸éš¾å‘ç°ï¼Œkubespray çµæ´»æ€§å’Œå¯æ‰©å±•æ€§è¦é¢†å…ˆå…¶ä»–å·¥å…·ï¼ˆæ”¯æŒ 10 ç§ CNIã€10 ç§ Linux  å‘è¡Œç‰ˆã€3 ç§ CRIã€ä»¥åŠå¤šç§æ’ä»¶å’Œæ‰©å±•ï¼‰å¹¶åœ¨å‚æ•°å±‚é¢ä¸Šåšåˆ°äº†ç¦»çº¿éƒ¨ç½²çš„æ”¯æŒã€‚å› æ­¤æˆ‘ä»¬é¦–å…ˆé€‰ç”¨ kubespray ä½œä¸ºé›†ç¾¤éƒ¨ç½²çš„åº•å±‚å·¥å…·ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ kubespray è™½ç„¶åœ¨å‚æ•°é…ç½®ä¸Šæ”¯æŒç¦»çº¿éƒ¨ç½²ï¼Œä½†æ˜¯ä»åˆ¶ä½œç¦»çº¿å®‰è£…åŒ…åˆ°ä¸€é”®éƒ¨ç½²ï¼Œç›®å‰ä¸ºæ­¢è¿˜æœªæœ‰ä¸€ä¸ªå®Œæ•´çš„å®ç°æ–¹æ¡ˆã€‚å› æ­¤éœ€è¦ä¸º kubespray è®¾è®¡ä¸€å¥—ä»ç¦»çº¿å®‰è£…åŒ…çš„æ„å»ºåˆ°é›†ç¾¤ä¸€é”®éƒ¨ç½²çš„æµç¨‹å’Œæ–¹æ¡ˆï¼Œä¸ºæ­¤æˆ‘ä»¬æ–°å»ºä¸€ä¸ªåä¸º <a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">kubeplay</a> çš„ repo æ¥å®Œæˆè¿™éƒ¨åˆ†å†…å®¹ã€‚</p><p>å¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ kubesphere æ—©æœŸçš„ç‰ˆæœ¬ v2.x ä½¿ç”¨ä¹Ÿæ˜¯ kubespray éƒ¨ç½²çš„ k8sï¼Œè‡³ä»Š ks-installer ä»£ç ä¸­ä»æ®‹ç•™ç€ <a href="https://github.com/kubesphere/ks-installer/commits/master/roles/download/tasks" target="_blank" rel="noopener">éƒ¨åˆ† kubespray çš„ä»£ç </a> ï¼Œåˆ°äº† 3.0 çš„æ—¶å€™å¼€å§‹ä½¿ç”¨è‡ªç ”çš„ kubekey æ¥éƒ¨ç½² K8s äº†ã€‚</p><blockquote><p>åŸºäº Ansible çš„å®‰è£…ç¨‹åºå…·æœ‰å¤§é‡è½¯ä»¶ä¾èµ–æ€§ï¼Œä¾‹å¦‚ Pythonã€‚KubeKey æ˜¯ä½¿ç”¨ Go è¯­è¨€å¼€å‘çš„ï¼Œå¯ä»¥æ¶ˆé™¤åœ¨å„ç§ç¯å¢ƒä¸­å‡ºç°çš„é—®é¢˜ï¼Œä»è€Œæé«˜å®‰è£…æˆåŠŸç‡ã€‚</p><p><a href="https://github.com/kubesphere/kubekey/blob/master/README_zh-CN.md" target="_blank" rel="noopener">README_zh-CN.md</a></p></blockquote><p>ä¸è¿‡ ansible çš„ä¾èµ–é—®é¢˜å½“æ—¶ä¸ºä»€ä¹ˆæ²¡æœ‰è€ƒè™‘é‡‡ç”¨å®¹å™¨åŒ–çš„æ–¹å¼è¿è¡Œ kubespray ğŸ¤”ï¼Œè‡³äº ansible çš„æ€§èƒ½é—®é¢˜ä¹Ÿä¸æ˜¯æ²¡æœ‰ä¼˜åŒ–çš„ä½™åœ°ã€‚</p><h2 id="kubeplay"><a href="#kubeplay" class="headerlink" title="kubeplay"></a><a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">kubeplay</a></h2><p>kubeplay è¿™ä¸ªé¡¹ç›®ä¸»è¦æ˜¯å®ç° K8s ç¦»çº¿å®‰è£…åŒ…çš„æ„å»ºå’Œä¸€é”®éƒ¨ç½²åŠŸèƒ½ï¼Œç›®å‰åªé€‚é…äº† kubesprayï¼Œç­‰åˆ°åé¢ä¼šé€‚é…ä¸€äº›å…¶ä»–éƒ¨ç½²å·¥å…·å¦‚ kubekeyã€‚</p><h3 id="æ‰“åŒ…æ–¹å¼"><a href="#æ‰“åŒ…æ–¹å¼" class="headerlink" title="æ‰“åŒ…æ–¹å¼"></a>æ‰“åŒ…æ–¹å¼</h3><p>ç”±äºéƒ¨ç½²ä¾èµ–çš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œç»„ä»¶é•œåƒå¤§éƒ½å­˜æ”¾åœ¨ GitHub ã€Docker Hubã€gcr.ioï¼ˆGoogle Container Registryï¼‰ã€quay.io è¿™äº›å›½å¤–çš„å¹³å°ä¸Šï¼Œåœ¨å›½å†…ç¯å¢ƒè·å–è¿™äº›èµ„æºæ˜¯æœ‰ä¸€å®šçš„ç½‘ç»œé™åˆ¶ã€‚è€Œ GitHub æ‰˜ç®¡çš„ runner è¿è¡Œåœ¨å›½å¤–çš„æœºæˆ¿å½“ä¸­ï¼Œå¯ä»¥å¾ˆé¡ºç•…åœ°è·å–è¿™äº›èµ„æºã€‚å› æ­¤æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ GitHub Actions æ¥è¿›è¡Œç¦»çº¿å®‰è£…åŒ…çš„æ„å»ºã€‚</p><p>åƒ selos é‚£æ ·å°†å®‰è£…åŒ…å­˜æ”¾åœ¨é˜¿é‡Œäº‘ OSS ä¸Šï¼Œåœ¨å›½å†…èƒ½ååˆ†é¡ºç•…åœ°é«˜é€Ÿä¸‹è½½ï¼Œæ”¶è´¹ä¹Ÿæ˜¯ç†æ‰€å½“ç„¶ã€‚ä½†æˆ‘ä»¬çš„æ–¹æ¡ˆæ˜¯ 100% å¼€æº 100% å…è´¹ï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥ fork ä»£ç åˆ°è‡ªå·±çš„ repoï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œæ„å»ºã€‚å› æ­¤é€‰æ‹© GitHub æ¥æ„å»ºå’Œå­˜æ”¾æˆ‘ä»¬çš„å®‰è£…åŒ…æ˜¯æœ€åˆé€‚çš„é€‰æ‹©ï¼Œè¿™æ ·ä¹Ÿä¸ç”¨å»é¢å¤–è€ƒè™‘å®‰è£…åŒ…ä¸‹è½½çš„é—®é¢˜ã€‚è‡³äºä» GitHub ä¸Šä¸‹è½½å®‰è£…åŒ…æ…¢çš„é—®é¢˜ï¼Œé‚£åº”è¯¥ç”±ä½¿ç”¨è€…è‡ªè¡Œå»è§£å†³ï¼Œè€Œéæœ¬æ–¹æ¡ˆæ‰€å…³å¿ƒçš„é—®é¢˜ã€‚</p><blockquote><p>Qï¼šå¦‚ä½•æ‘†è„±ç½‘ç»œçš„ä¾èµ–æ¥åˆ›å»ºä¸ª Docker çš„ image å‘¢ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªæ˜¯ Docker ç”¨æˆ·è‡ªå·±çš„åŸºæœ¬æƒåˆ©ï¼Ÿ</p><p>Aï¼šè¿™ä¸ªåŸºæœ¬æƒåˆ©æˆ‘è§‰å¾—è¿˜æ˜¯è¦é—® GFW ï¼Œå›½å¤–çš„å¼€å‘äººå‘˜æ˜¯éå¸¸éš¾ç†è§£æœ‰äº›ä»–ä»¬è®¤ä¸ºè·Ÿæ°´ç”µä¸€æ ·æ™®åŠçš„åŸºç¡€è®¾æ–½åœ¨æŸäº›åœ°æ–¹è¿˜æ˜¯å¾ˆå›°éš¾çš„ã€‚</p><p>æ­¤å¤„å¼•ç”¨ <a href="http://dockone.io/article/722" target="_blank" rel="noopener">DockOne æŠ€æœ¯åˆ†äº«ï¼ˆäºŒåå››ï¼‰ï¼šå®¹å™¨å’Œ IaaSï¼šè°åŠ¨äº†è°çš„å¥¶é…ª</a></p></blockquote><p>é€‰æ‹©å¥½çš„æ„å»ºåœºæ‰€ä¸º GitHub Actions ä¹‹åæˆ‘ä»¬å†å°†è¿™äº›ç¦»çº¿èµ„æºè¿›è¡Œæ‹†åˆ†ï¼Œç›®çš„æ˜¯ä¸ºäº†å®ç°å„ä¸ªç¦»çº¿èµ„æºä¹‹é—´çš„è§£è€¦ï¼Œè¿™æ ·åšçµæ´»æ€§æ›´å¥½ä¸€äº›ï¼Œæ¯”å¦‚èƒ½å¤Ÿé€‚é…å¤šç§ OSã€æ”¯æŒå¤šä¸ª k8s ç‰ˆæœ¬ç­‰ã€‚ä¸»è¦æ‹†åˆ†æˆå¦‚ä¸‹å‡ ä¸ªæ¨¡å—ã€‚</p><table><thead><tr><th>æ¨¡å—</th><th>Repo</th><th>ç”¨é€”</th><th>è¿è¡Œ/ä½¿ç”¨æ–¹å¼</th></tr></thead><tbody><tr><td>compose</td><td><a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">kubeplay</a></td><td>ç”¨äºéƒ¨ç½² nginx å’Œ registry æœåŠ¡</td><td>nerdctl compose</td></tr><tr><td>os-tools</td><td><a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">kubeplay</a></td><td>éƒ¨ç½² compose æ—¶çš„ä¸€äº›ä¾èµ–å·¥å…·</td><td>äºŒè¿›åˆ¶å®‰è£…</td></tr><tr><td>os-packages</td><td><a href="https://github.com/k8sli/os-packages" target="_blank" rel="noopener">os-packages</a></td><td>æä¾› rpm/deb ç¦»çº¿æº</td><td>nginx æä¾› http æ–¹å¼ä¸‹è½½</td></tr><tr><td>kubespray</td><td><a href="https://github.com/k8sli/kubespray" target="_blank" rel="noopener">kubespray</a></td><td>ç”¨äºéƒ¨ç½²/æ‰©ç¼©å®¹ k8s é›†ç¾¤</td><td>å®¹å™¨æˆ–è€… pod</td></tr><tr><td>kubespray-files</td><td><a href="https://github.com/k8sli/kubespray" target="_blank" rel="noopener">kubespray</a></td><td>æä¾›äºŒè¿›åˆ¶æ–‡ä»¶ä¾èµ–</td><td>nginx æä¾› http æ–¹å¼ä¸‹è½½</td></tr><tr><td>kubespray-images</td><td><a href="https://github.com/k8sli/kubespray" target="_blank" rel="noopener">kubespray</a></td><td>æä¾›ç»„ä»¶é•œåƒ</td><td>registry æä¾›é•œåƒä¸‹è½½</td></tr></tbody></table><p>æ‹†åˆ†å®Œæˆä¹‹åï¼Œæˆ‘ä»¬æœ€ç»ˆè¿˜æ˜¯éœ€è¦å°†å®ƒä»¬ç»„åˆæˆä¸€ä¸ªå®Œæˆçš„ç¦»çº¿å®‰è£…åŒ…ã€‚ä¸ºäº†å‡å°‘ç»´æŠ¤æˆæœ¬ï¼Œæˆ‘ä»¬å°†æ¯ä¸ªæ¨¡å—çš„æ„å»ºæ“ä½œéƒ½æ”¾åœ¨ Dockerfile ä¸­ï¼Œå³ <code>All in Dockerfile</code> ğŸ¤£ã€‚è¿™æ ·æ¯ä¸ªæ¨¡å—çš„ GitHub Actions æµæ°´çº¿æœ€ç»ˆäº¤ä»˜çš„éƒ½æ˜¯ä¸€ä¸ªé•œåƒï¼Œç„¶åé•œåƒéƒ½æ¨é€åˆ°  <code>ghcr.io</code> ä¸Šï¼Œè¿™æ ·å°±è§£å†³äº†æ¨¡å—é—´äº§ç‰©ä¼ é€’ä»¥åŠé•œåƒç¼“å­˜çš„é—®é¢˜ã€‚æœ€ç»ˆé€šè¿‡ä¸€ä¸ªæœ€ç»ˆçš„ <a href="https://github.com/k8sli/kubeplay/blob/main/Dockerfile" target="_blank" rel="noopener">Dockerfile</a> å°†è¿™äº›æ¨¡å—çš„é•œåƒå…¨éƒ¨ COPY åˆ°ä¸€ä¸ªé•œåƒå½“ä¸­ï¼Œåªè¦æ‰“åŒ…è¿™ä¸ªæœ€ç»ˆçš„é•œåƒä¸ºç¦»çº¿å®‰è£…åŒ…å³å¯ï¼›å¦ä¸€ä¸ªå¥½å¤„å°±ä½¿ç”¨ buildx æ„å»ºè¿™äº›ç¦»çº¿èµ„æºå°±åŸç”Ÿæ”¯æŒå¤š CPU ä½“ç³»æ¶æ„ï¼Œèƒ½å¤ŸåŒæ—¶é€‚é… amd64 å’Œ arm64 ä½“ç³»æ¶æ„ï¼Œè¿™æ · arm64 ä¹Ÿèƒ½æ„‰å¿«åœ°ç©è€äº†ï¼ŒçœŸæ˜¯ä¸€ä¸¾ä¸¤å¾—ã€‚</p><p>ä¸‹é¢å°±è¯¦ç»†è®²è§£æ¯ä¸ªæ¨¡å—çš„åŠŸèƒ½ä»¥åŠæ˜¯å¦‚ä½•æ‰“åŒ…çš„ï¼š</p><h3 id="compose"><a href="#compose" class="headerlink" title="compose"></a>compose</h3><p>compose æ¨¡å—é‡Œé¢ä¸»è¦è¿ä¸¤ä¸ªæœåŠ¡ï¼š ç”¨äºæä¾›æ–‡ä»¶ä¸‹è½½çš„ nginx å’Œç»„ä»¶é•œåƒæ‹‰å–çš„ registryã€‚è¿™ä¸¤ä¸ªæˆ‘ä»¬ä¾æ—§æ˜¯å®¹å™¨åŒ–ä»¥ç±»ä¼¼ docker-compose çš„æ–¹å¼æ¥éƒ¨ç½²ï¼Œè€Œæ‰€ä¾èµ–çš„ä¹Ÿåªæœ‰ä¸¤ä¸ªé•œåƒå’Œä¸€äº›é…ç½®æ–‡ä»¶è€Œå·²ã€‚</p><ul><li><a href="https://github.com/k8sli/kubeplay/blob/main/compose.yaml" target="_blank" rel="noopener">kubeplay/blob/main/compose.yaml</a></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.1'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.20-alpine</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./resources/nginx:/usr/share/nginx</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config/compose/certs/domain.crt:/etc/nginx/conf.d/domain.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config/compose/certs/domain.key:/etc/nginx/conf.d/domain.key</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config/compose/nginx.conf:/etc/nginx/conf.d/default.conf</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="comment"># 443 ç«¯å£åå‘ä»£ç† registr çš„ 5000 ç«¯å£ï¼Œä»…ç”¨äº pull é•œåƒ</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">443</span><span class="string">:443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2.7.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./resources/registry:/var/lib/registry</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="comment"># åªå…è®¸æœ¬åœ° 5000 ç«¯å£ push é•œåƒ</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5000:5000</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªé•œåƒæˆ‘ä»¬ä½¿ç”¨ skopeo copy çš„æ–¹å¼ä¿å­˜ä¸º tar åŒ…ï¼Œéƒ¨ç½²çš„æ—¶å€™ load åˆ°å®¹å™¨è¿è¡Œæ—¶çš„å­˜å‚¨ä¸­ã€‚</p><blockquote><p>Qï¼šä¸ºä»€ä¹ˆè¦ç”¨ skopeo è€Œä¸æ˜¯ dockerï¼Ÿ</p><p>Aï¼šå› ä¸º Dockerfile æ„å»ºè¿‡ç¨‹ä¸­ä¸æ”¯æŒè¿è¡Œ docker å‘½ä»¤ save é•œåƒ</p></blockquote><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:latest as downloader</span><br><span class="line"><span class="keyword">ARG</span> SKOPEO_VERSION=v1.<span class="number">4.0</span></span><br><span class="line"><span class="keyword">ARG</span> NGINX_VERSION=<span class="number">1.20</span>-alpine</span><br><span class="line"><span class="keyword">ARG</span> RERGISRRY_VERSION=<span class="number">2.7</span>.<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /tools</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add wget ca-certificates \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -k https://github.com/k8sli/skopeo/releases/download/v1.4.0/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> -O /tools/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /tools/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ln -s /tools/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> /usr/bin/skopeo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /images</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=<span class="literal">false</span> --override-arch <span class="variable">$&#123;ARCH&#125;</span> --additional-tag nginx:<span class="variable">$&#123;NGINX_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">       docker://docker.io/library/nginx:<span class="variable">$&#123;NGINX_VERSION&#125;</span> docker-archive:nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span>.tar \</span></span><br><span class="line"><span class="bash">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=<span class="literal">false</span> --override-arch <span class="variable">$&#123;ARCH&#125;</span> --additional-tag registry:<span class="variable">$&#123;RERGISRRY_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">       docker://docker.io/library/registry:<span class="variable">$&#123;RERGISRRY_VERSION&#125;</span> docker-archive:registry-<span class="variable">$&#123;RERGISRRY_VERSION&#125;</span>.tar</span></span><br></pre></td></tr></table></figure><p>åœ¨éƒ¨ç½²çš„æ—¶å€™æˆ‘ä»¬ä½¿ç”¨ nerdctl compose çš„æ–¹å¼å¯åŠ¨å³å¯ï¼Œä½¿ç”¨æ–¹å¼æœ‰ç‚¹ç±»ä¼¼äº docker-composeã€‚</p><blockquote><p>Q: ä¸ºä»€ä¹ˆä¸ç”¨ docker å’Œ docker-compose</p><p>Aï¼šK8s å» docker æ˜¯å¤§åŠ¿æ‰€è¶‹ï¼Œé€‰æ‹© containerd æ›´ç¬¦åˆä¸»æµå‘å±•æ–¹å‘</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†é•œåƒ load è¿› containerd å­˜å‚¨</span></span><br><span class="line">$ find <span class="variable">$&#123;IMAGES_DIR&#125;</span> -<span class="built_in">type</span> f -name <span class="string">'*.tar'</span> | xargs -L1 nerdctl load -i</span><br><span class="line"><span class="comment"># nerdctl compose å¯åŠ¨ nginx å’Œ registry</span></span><br><span class="line">$ nerdctl compose -f compose.yaml up</span><br></pre></td></tr></table></figure><h3 id="os-packages"><a href="#os-packages" class="headerlink" title="os-packages"></a>os-packages</h3><p>è¿™éƒ¨åˆ†æ˜¯ rpm/deb ç¦»çº¿æºçš„æ„å»ºï¼Œå…¶è¯¦ç»†çš„è¿‡ç¨‹å’ŒåŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„åšå®¢ ã€Š<a href="https://blog.k8s.li/make-offline-mirrors.html">ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</a>ã€‹ï¼Œä¸‹é¢åªåˆ—ä¸¾ä¸€ä¸‹ CentOS7 ç¦»çº¿æºçš„æ„å»ºé…ç½®ï¼š</p><ul><li><a href="https://github.com/k8sli/os-packages/blob/main/build/Dockerfile.os.centos7" target="_blank" rel="noopener">Dockerfile</a></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7.9</span>.<span class="number">2009</span> as os-centos7</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=<span class="number">7</span></span><br><span class="line"><span class="keyword">ARG</span> DOCKER_MIRROR_URL=<span class="string">"https://download.docker.com"</span></span><br><span class="line"><span class="keyword">ARG</span> BUILD_TOOLS=<span class="string">"yum-utils createrepo epel-release wget"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…æ„å»ºå·¥å…·ï¼Œé…ç½® docker å®˜æ–¹ yum æº</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -q -y <span class="variable">$&#123;BUILD_TOOLS&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; yum-config-manager --add-repo <span class="variable">$&#123;DOCKER_MIRROR_URL&#125;</span>/linux/centos/docker-ce.repo \</span></span><br><span class="line"><span class="bash">    &amp;&amp; yum makecache</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /centos/<span class="variable">$OS_VERSION</span>/os</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=mikefarah/yq:4.11.1 /usr/bin/yq /usr/bin/yq</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ®é…ç½®æ–‡ä»¶è§£æè¯¥ OS éœ€è¦æ„å»ºçš„åŒ…ï¼Œå¹¶è·å–è¿™äº›åŒ…çš„ä¸‹è½½ url</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> <span class="string">'.common[],.yum[],.centos7[],.kubespray.common[],.kubespray.yum[]'</span> packages.yaml &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sort -u packages.list | xargs repotrack --urls | sort -u &gt; packages.urls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡ wget çš„æ–¹å¼ä¸‹è½½ rpm åŒ…ï¼Œä½¿ç”¨ createrepo åˆ›å»º repo ç´¢å¼•æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -x -P <span class="variable">$&#123;ARCH&#125;</span> -i packages.urls \</span></span><br><span class="line"><span class="bash">    &amp;&amp; createrepo -d <span class="variable">$&#123;ARCH&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ„å»ºçš„å†…å®¹ COPY æˆå•ç‹¬çš„ä¸€å±‚</span></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=os-centos7 /centos /centos</span></span><br></pre></td></tr></table></figure><ul><li><a href="https://github.com/k8sli/os-packages/blob/main/packages.yaml" target="_blank" rel="noopener">packages.yaml</a> é…ç½®æ–‡ä»¶</li></ul><p>è¿™ä¸ªæ˜¯éœ€è¦å®‰è£…åŒ…çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥æ ¹æ®å¹³å°æˆ–è€…å®¢æˆ·çš„ä¸€äº›è¦æ±‚é…ç½®ä¸Šä¸åŒçš„åŒ…</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kubespray:</span></span><br><span class="line">  <span class="attr">common:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">curl</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">rsync</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">socat</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">unzip</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">e2fsprogs</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">xfsprogs</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ebtables</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bash-completion</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ipvsadm</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ipset</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">conntrack</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nss</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">libselinux-python</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">device-mapper-libs</span></span><br><span class="line">  <span class="attr">apt:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">python-apt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">python3-apt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">aufs-tools</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">apt-transport-https</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">software-properties-common</span></span><br><span class="line"></span><br><span class="line"><span class="attr">common:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cifs-utils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lsof</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lvm2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">openssl</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">sshpass</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">vim</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">wget</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ethtool</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">net-tools</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rsync</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">chrony</span></span><br><span class="line"></span><br><span class="line"><span class="attr">yum:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfs-utils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">yum-utils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">createrepo</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">epel-release</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nc</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">httpd-tools</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apt:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfs-common</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apt-transport-https</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ca-certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">gnupg</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lsb-release</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">aptitude</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">dpkg-dev</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">gnupg2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">netcat</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apache2-utils</span></span><br><span class="line"></span><br><span class="line"><span class="attr">centos7:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">containerd.io-1.4.6</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ubuntu:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">containerd.io=1.4.6-1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">debian10:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">containerd.io=1.4.6-1</span></span><br></pre></td></tr></table></figure><blockquote><p>å¯¹äº toB äº§å“ï¼Œå»ºè®®å°†ä¸‹é¢è¿™äº›å¸¸è§çš„è¿ç»´è°ƒè¯•å·¥å…·ï¼ˆå¦‚ tcpdump, strace, lsof, net-tools ç­‰ï¼‰ä¹Ÿæ„å»ºåœ¨ç¦»çº¿æºä¸­ã€‚è¿™æ ·ä¹Ÿä¸è‡³äºåœ¨å®¢æˆ·çš„ç¯å¢ƒä¸­æ’æŸ¥é—®é¢˜çš„æ—¶å€™æœºå™¨ä¸Šè¿ä¸ª tcpdump éƒ½æ²¡æœ‰ï¼Œå°¤å…¶æ˜¯åœ¨æ— ç½‘çš„ç¯å¢ƒä¸­ï¼Œå¦‚æœæ²¡æœ‰è¿™äº›å¸¸ç”¨çš„è¿ç»´å·¥å…·ï¼Œæ’æŸ¥é—®é¢˜å°†ä¼šååˆ†æ£˜æ‰‹ã€‚</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tools:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">bash-completion</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">chrony</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cifs-utils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">curl</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">dstat</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">e2fsprogs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ebtables</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">expect</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">gdb</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">htop</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">iftop</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">iotop</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ipset</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ipvsadm</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">jq</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lsof</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lvm2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ncdu</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">net-tools</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nethogs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nload</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ntpdate</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">openssl</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pciutils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">psmisc</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rsync</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">smartmontools</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">socat</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">sshpass</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">strace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">sysstat</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tcpdump</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">telnet</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tmux</span></span><br></pre></td></tr></table></figure><h3 id="kubespray-2"><a href="#kubespray-2" class="headerlink" title="kubespray"></a>kubespray</h3><p>kubespray æ˜¯éƒ¨ç½² K8s é›†ç¾¤ã€å¢åŠ èŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹ã€ç§»é™¤é›†ç¾¤ç­‰æ¶‰åŠå¯¹é›†ç¾¤æ“ä½œçš„ä¸»è¦å·¥å…·ã€‚æˆ‘ä»¬ä¾æ—§é‡‡ç”¨å®¹å™¨åŒ–çš„æ–¹å¼è¿è¡Œ kubesprayï¼Œä¸»è¦æœ‰ä»¥ä¸‹åœºæ™¯ä¼šç”¨åˆ° kubesprayï¼š</p><ul><li>åœ¨éƒ¨ç½²å·¥å…·è¿è¡ŒèŠ‚ç‚¹ï¼Œä½¿ç”¨ nerdctl æ¥è¿è¡Œ kubespray å®¹å™¨éƒ¨ç½²  K8s é›†ç¾¤</li><li>K8s é›†ç¾¤éƒ¨ç½²å®Œæ¯•åï¼Œä»¥ Job pod çš„æ–¹å¼è¿è¡Œéƒ¨ç½²å¦ä¸€ä¸ª K8s é›†ç¾¤ï¼Œå®ç°å¤šé›†ç¾¤éƒ¨ç½²çš„åŸºæœ¬èƒ½åŠ›</li><li>K8s é›†ç¾¤éƒ¨ç½²å®Œæ¯•åï¼Œä»¥ Job pod çš„æ–¹å¼è¿è¡Œ kubespray å¯¹è¯¥é›†ç¾¤é›†ç¾¤èŠ‚ç‚¹è¿›è¡Œæ‰©ç¼©å®¹</li></ul><p>Job pod æ–¹å¼å¯¹é›†ç¾¤è¿›è¡Œæ‰©ç¼©å®¹çš„è®¾è®¡çš„æ˜¯ä¸ºäº†ä»ä¸€å®šç¨‹åº¦ä¸Šè§£å†³éƒ¨ç½²å¤§è§„æ¨¡é›†ç¾¤æ—¶ ansible æ€§èƒ½é—®é¢˜ã€‚å³æˆ‘ä»¬ä¸€å¼€å§‹ä¸å¿…å°±éƒ¨ç½²ä¸€ä¸ªä¸ŠåƒèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œè€Œæ˜¯å…ˆæŠŠä¸€ä¸ªè§„æ¨¡è¾ƒå°çš„é›†ç¾¤éƒ¨ç½²èµ·æ¥ï¼Œç„¶åé€šè¿‡åˆ›å»ºæ‰¹é‡çš„ Job çš„æ–¹å¼è¿è¡Œ kubespray å†å°†é›†ç¾¤æ…¢æ…¢æ‰©å®¹èµ·æ¥ï¼Œæ¯”å¦‚æ‰©å®¹åˆ°ä¸Šåƒå°èŠ‚ç‚¹ã€‚</p><p>kubespray å®˜æ–¹çš„ Dockerfile æ„å»ºå‡ºæ¥çš„é•œåƒæœ‰ 1.4GBï¼Œå®åœ¨æ˜¯å¤ªå¤§äº†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¼˜åŒ–ä¸€ä¸‹ï¼Œå‡å°‘é•œåƒå¤§å°</p><ul><li>kubespray BASE é•œåƒ</li></ul><p>é¦–å…ˆæ„å»ºä¸€ä¸ª base é•œåƒï¼Œå¯¹äºä¸ç»å¸¸å˜åŠ¨çš„å†…å®¹æˆ‘ä»¬æŠŠå®ƒå°è£…åœ¨ä¸€ä¸ª base é•œåƒé‡Œï¼Œåªæœ‰å½“ç›¸å…³ä¾èµ–æ›´æ–°äº†æ‰éœ€è¦é‡æ–°æ„å»ºè¿™ä¸ª base é•œåƒï¼Œ<code>Dockerfile.base</code> å¦‚ä¸‹ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3</span> as builder</span><br><span class="line"><span class="keyword">ARG</span> KUBE_VERSION=v1.<span class="number">21.3</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> requirements.txt requirements.txt</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> tests/requirements.txt tests/requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">'shellcheck-py==0.7.2.1'</span> &gt;&gt; requirements.txt \</span></span><br><span class="line"><span class="bash">    &amp;&amp; grep -E <span class="string">'^yamllint|^ansible-lint'</span> tests/requirements.txt &gt;&gt; requirements.txt \</span></span><br><span class="line"><span class="bash">    &amp;&amp; pip3 install --user -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -O /root/.<span class="built_in">local</span>/bin/kubectl -q https://dl.k8s.io/<span class="variable">$&#123;KUBE_VERSION&#125;</span>/bin/linux/<span class="variable">$&#123;ARCH&#125;</span>/kubectl \</span></span><br><span class="line"><span class="bash">&amp;&amp; chmod a+x /root/.<span class="built_in">local</span>/bin/kubectl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3</span>-slim</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> DEBIAN_FRONTEND=noninteractive apt-get update -y -qq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install -y -qq --no-install-recommends \</span></span><br><span class="line"><span class="bash">        ca-certificates libssl-dev openssh-client sshpass curl gnupg2 rsync \</span></span><br><span class="line"><span class="bash">        jq moreutils vim iputils-ping wget tcpdump xz-utils \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /root/.<span class="built_in">local</span> /usr/<span class="built_in">local</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /kubespray</span></span><br></pre></td></tr></table></figure><ul><li><a href="">kubespray é•œåƒ</a></li></ul><p>FROM çš„ base é•œåƒå°±ä½¿ç”¨æˆ‘ä»¬åˆšåˆšæ„å»ºå¥½çš„é•œåƒï¼Œç›¸å…³ä¾èµ–å·²ç»åœ¨ base é•œåƒä¸­å®‰è£…å¥½äº†ï¼Œè¿™é‡Œæ„å»ºçš„æ—¶å€™åªéœ€è¦æŠŠ repo æºç å¤åˆ¶åˆ° /kubespray ç›®å½•ä¸‹å³å¯ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> BASE_IMAGE=ghcr.io/k8sli/kubespray-base</span><br><span class="line"><span class="keyword">ARG</span> BASE_IMAGE_VERSION=latest</span><br><span class="line"><span class="keyword">FROM</span> $BASE_IMAGE:$BASE_IMAGE_VERSION</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /kubespray</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br></pre></td></tr></table></figure><ul><li>kubespray é›†ç¾¤éƒ¨ç½²å…¥å£ <code>run.sh</code></li></ul><p>å°†é›†ç¾¤éƒ¨ç½²ã€å¢åŠ èŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹ã€åˆ é™¤é›†ç¾¤ç­‰æ“ä½œå°è£…æˆä¸€ä¸ªå…¥å£çš„è„šæœ¬ï¼Œæä¾›å¤–éƒ¨å·¥å…·è°ƒç”¨è¯¥è„šæœ¬ï¼Œä¸ç„¶å¤–éƒ¨è°ƒç”¨çš„æ—¶å€™ç›´æ¥è¿è¡Œ <code>ansible-playbook</code> å‘½ä»¤å®åœ¨æ˜¯ä¸å¤ªæ–¹ä¾¿ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">TYPE=<span class="variable">$1</span></span><br><span class="line">NODES=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">KUBE_ROOT=<span class="string">"<span class="variable">$(cd "$(dirname "$0")</span>"</span> &amp;&amp; <span class="built_in">pwd</span>)<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;TYPE:=deploy-cluster&#125;</span></span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;ANSIBLE_FORKS:=10&#125;</span></span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;BECOME_USER:=root&#125;</span></span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;ANSIBLE_LOG_FORMAT:=yaml&#125;</span></span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;INVENTORY:=$&#123;KUBE_ROOT&#125;</span>/config/inventory&#125;</span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;ENV_FILE:=$&#123;KUBE_ROOT&#125;</span>/config/env.yml&#125;</span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;INSTALL_STEPS_FILE:=$&#123;KUBE_ROOT&#125;</span>/config/.install_steps&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export ANSIBLE_STDOUT_CALLBACK=<span class="variable">$&#123;ANSIBLE_LOG_FORMAT&#125;</span></span></span><br><span class="line"><span class="string">export ANSIBLE_ARGS="</span>-f <span class="variable">$&#123;ANSIBLE_FORKS&#125;</span> --become --become-user=<span class="variable">$&#123;BECOME_USER&#125;</span> -i <span class="variable">$&#123;INVENTORY&#125;</span> -e @<span class="variable">$&#123;ENV_FILE&#125;</span><span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># Set logging colors</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">NORMAL_COL=<span class="variable">$(tput sgr0)</span></span></span><br><span class="line"><span class="string">RED_COL=<span class="variable">$(tput setaf 1)</span></span></span><br><span class="line"><span class="string">WHITE_COL=<span class="variable">$(tput setaf 7)</span></span></span><br><span class="line"><span class="string">GREEN_COL=<span class="variable">$(tput setaf 76)</span></span></span><br><span class="line"><span class="string">YELLOW_COL=<span class="variable">$(tput setaf 202)</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">debuglog()&#123; printf "</span><span class="variable">$&#123;WHITE_COL&#125;</span>%s<span class="variable">$&#123;NORMAL_COL&#125;</span>\n<span class="string">" "</span><span class="variable">$@</span><span class="string">"; &#125;</span></span><br><span class="line"><span class="string">infolog()&#123; printf "</span><span class="variable">$&#123;GREEN_COL&#125;</span>âœ” %s<span class="variable">$&#123;NORMAL_COL&#125;</span>\n<span class="string">" "</span><span class="variable">$@</span><span class="string">"; &#125;</span></span><br><span class="line"><span class="string">warnlog()&#123; printf "</span><span class="variable">$&#123;YELLOW_COL&#125;</span>âœ %s<span class="variable">$&#123;NORMAL_COL&#125;</span>\n<span class="string">" "</span><span class="variable">$@</span><span class="string">"; &#125;</span></span><br><span class="line"><span class="string">errorlog()&#123; printf "</span><span class="variable">$&#123;RED_COL&#125;</span>âœ– %s<span class="variable">$&#123;NORMAL_COL&#125;</span>\n<span class="string">" "</span><span class="variable">$@</span><span class="string">"; &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">set -eo pipefail</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if [[ ! -f <span class="variable">$&#123;INVENTORY&#125;</span> ]]; then</span></span><br><span class="line"><span class="string">  errorlog "</span><span class="variable">$&#123;INVENTORY&#125;</span> file is missing, please check the inventory file is exists<span class="string">"</span></span><br><span class="line"><span class="string">  exit 1</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deploy_cluster()&#123;</span></span><br><span class="line"><span class="string">:</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">main()&#123;</span></span><br><span class="line"><span class="string">  case <span class="variable">$TYPE</span> in</span></span><br><span class="line"><span class="string">    deploy-cluster)</span></span><br><span class="line"><span class="string">      infolog "</span><span class="comment">######  start deploy kubernetes cluster  ######"</span></span><br><span class="line">      deploy_cluster</span><br><span class="line">      infolog <span class="string">"######  kubernetes cluster successfully installed  ######"</span></span><br><span class="line">      ;;</span><br><span class="line">    remove-cluster)</span><br><span class="line">      infolog <span class="string">"######  start remove kubernetes cluster  ######"</span></span><br><span class="line">      <span class="keyword">if</span> ansible-playbook <span class="variable">$&#123;ANSIBLE_ARGS&#125;</span> <span class="variable">$&#123;KUBE_ROOT&#125;</span>/reset.yml &gt;/dev/stdout 2&gt;/dev/stderr; <span class="keyword">then</span></span><br><span class="line">        rm -f <span class="variable">$&#123;INSTALL_STEP_FILE&#125;</span></span><br><span class="line">        infolog <span class="string">"######  kubernetes cluster successfully removed ######"</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">      ;;</span><br><span class="line">    add-node)</span><br><span class="line">      check_nodename</span><br><span class="line">      infolog <span class="string">"######  start add worker to kubernetes cluster  ######"</span></span><br><span class="line">      ansible-playbook <span class="variable">$&#123;ANSIBLE_ARGS&#125;</span> --<span class="built_in">limit</span>=<span class="string">"<span class="variable">$&#123;NODES&#125;</span>"</span> <span class="variable">$&#123;KUBE_ROOT&#125;</span>/playbooks/10-scale-nodes.yml &gt;/dev/stdout 2&gt;/dev/stderr</span><br><span class="line">      ;;</span><br><span class="line">    remove-node)</span><br><span class="line">      check_nodename</span><br><span class="line">      infolog <span class="string">"######  start remove worker from kubernetes cluster  ######"</span></span><br><span class="line">      ansible-playbook <span class="variable">$&#123;ANSIBLE_ARGS&#125;</span> -e node=<span class="string">"<span class="variable">$&#123;NODES&#125;</span>"</span> -e reset_nodes=<span class="literal">true</span> <span class="variable">$&#123;KUBE_ROOT&#125;</span>/remove-node.yml &gt;/dev/stdout 2&gt;/dev/stderr</span><br><span class="line">      ;;</span><br><span class="line">    *)</span><br><span class="line">      errorlog <span class="string">"unknow [TYPE] parameter: <span class="variable">$&#123;TYPE&#125;</span>"</span></span><br><span class="line">      ;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure><ul><li>åˆ†å±‚éƒ¨ç½² <a href="https://github.com/k8sli/kubespray/tree/main/playbooks" target="_blank" rel="noopener">playbooks</a></li></ul><p>ä¸åŒäº kubespray å®˜æ–¹ä½¿ç”¨ä¸€ä¸ªå®Œæ•´çš„ <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/cluster.yml" target="_blank" rel="noopener">cluster.yaml</a> æ¥å®Œæˆæ•´ä¸ª K8s é›†ç¾¤çš„éƒ¨ç½²ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå¼•å…¥äº†åˆ†å±‚éƒ¨ç½²çš„ç‰¹æ€§ã€‚å³å°†é›†ç¾¤éƒ¨ç½²åˆ†æˆè‹¥å¹²ä¸ªç›¸äº’ç‹¬ç«‹çš„ playbookï¼Œç„¶ååœ¨å„ä¸ª playbook é‡Œå¼•å…¥æˆ‘ä»¬å¢åŠ çš„ roles ä»¥åŠäºŒå¼€å†…å®¹ã€‚è¿™æ ·çš„å¥½å¤„å°±æ˜¯èƒ½å’Œ kubespray ä¸Šæ¸¸çš„ä»£ç ä¿æŒç›¸äº’ç‹¬ç«‹ï¼Œåœ¨ rebase æˆ–è€… cherry-pick ä¸Šæ¸¸æœ€æ–°çš„ä»£ç èƒ½å¤Ÿé¿å…å‡ºç°å†²çªçš„ç°è±¡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">playbooks</span><br><span class="line">â”œâ”€â”€ 00-default-ssh-config.yml    <span class="comment"># é…ç½® ssh è¿æ¥</span></span><br><span class="line">â”œâ”€â”€ 01-cluster-bootstrap-os.yml  <span class="comment"># åˆå§‹åŒ–é›†ç¾¤èŠ‚ç‚¹</span></span><br><span class="line">â”œâ”€â”€ 02-cluster-etcd.yml          <span class="comment"># éƒ¨ç½² etcd é›†ç¾¤</span></span><br><span class="line">â”œâ”€â”€ 03-cluster-kubernetes.yml    <span class="comment"># éƒ¨ç½² k8s master å’Œ node</span></span><br><span class="line">â”œâ”€â”€ 04-cluster-network.yml       <span class="comment"># éƒ¨ç½² CNI æ’ä»¶</span></span><br><span class="line">â”œâ”€â”€ 05-cluster-apps.yml          <span class="comment"># éƒ¨ç½²ä¸€äº› addon ç»„ä»¶å¦‚ coredns</span></span><br><span class="line">â””â”€â”€ 10-scale-nodes.yml           <span class="comment"># å¢åˆ èŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure><p>åˆ†å±‚éƒ¨ç½²çš„æ—¶å€™é€šè¿‡ä¸€ä¸ªæ–‡ä»¶æ¥è®°å½•å·²ç»éƒ¨ç½²æˆåŠŸçš„æ­¥éª¤ï¼Œè¿™æ ·å¦‚æœæœ¬æ¬¡å› ä¸ºä¸€äº›åŸå› å¯¼è‡´éƒ¨ç½²å¤±è´¥ï¼ˆå¦‚ç½‘ç»œä¸­æ–­ï¼‰ï¼Œé‚£ä¹ˆä¸‹æ¬¡é‡æ–°éƒ¨ç½²çš„æ—¶å€™ä¼šè·³è¿‡å·²ç»éƒ¨ç½²å¥½çš„æ­¥éª¤ï¼Œä»å¤±è´¥çš„åœ°æ–¹ç»§ç»­éƒ¨ç½²ï¼Œä»¥æå‡æ•´ä½“çš„éƒ¨ç½²æ•ˆç‡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">deploy_cluster</span></span>()&#123;</span><br><span class="line">  touch <span class="variable">$&#123;INSTALL_STEPS_FILE&#125;</span></span><br><span class="line">  STEPS=<span class="string">"00-default-ssh-config 01-cluster-bootstrap-os 02-cluster-etcd 03-cluster-kubernetes 04-cluster-network 05-cluster-apps"</span></span><br><span class="line">  <span class="keyword">for</span> step <span class="keyword">in</span> <span class="variable">$&#123;STEPS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> ! grep -q <span class="string">"<span class="variable">$&#123;step&#125;</span>"</span> <span class="variable">$&#123;INSTALL_STEPS_FILE&#125;</span>; <span class="keyword">then</span></span><br><span class="line">      infolog <span class="string">"start deploy <span class="variable">$&#123;step&#125;</span>"</span></span><br><span class="line">      <span class="keyword">if</span> ansible-playbook <span class="variable">$&#123;ANSIBLE_ARGS&#125;</span> <span class="variable">$&#123;KUBE_ROOT&#125;</span>/playbooks/<span class="variable">$&#123;step&#125;</span>.yml; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$&#123;step&#125;</span> &gt;&gt; <span class="variable">$&#123;INSTALL_STEPS_FILE&#125;</span></span><br><span class="line">        infolog <span class="string">"<span class="variable">$&#123;step&#125;</span> successfully installed"</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        errorlog <span class="string">"<span class="variable">$&#123;step&#125;</span> installation failed"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      warnlog <span class="string">"<span class="variable">$&#123;step&#125;</span> is already installed, so skipped..."</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶å’Œé•œåƒ"><a href="#æ–‡ä»¶å’Œé•œåƒ" class="headerlink" title="æ–‡ä»¶å’Œé•œåƒ"></a>æ–‡ä»¶å’Œé•œåƒ</h3><p>æˆ‘ä»¬éœ€è¦æå–å‡º kubespray éƒ¨ç½²çš„æ—¶å€™ä¾èµ–çš„æ–‡ä»¶å’Œé•œåƒï¼Œç”Ÿæˆä¸€ä¸ªæ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ï¼Œç„¶åæ ¹æ®è¿™äº›åˆ—è¡¨ä¸‹è½½å¹¶æ„å»ºåˆ°ä¸€ä¸ªé•œåƒé‡Œã€‚</p><ul><li>æ–‡ä»¶</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download URLs</span></span><br><span class="line"><span class="attr">kubelet_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubelet"</span></span><br><span class="line"><span class="attr">kubectl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubectl"</span></span><br><span class="line"><span class="attr">kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubeadm"</span></span><br><span class="line"><span class="attr">etcd_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/coreos/etcd/releases/download/<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>/etcd-<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">cni_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containernetworking/plugins/releases/download/<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>/cni-plugins-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>-<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>.tgz"</span></span><br><span class="line"><span class="attr">calicoctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calicoctl/releases/download/<span class="template-variable">&#123;&#123; calico_ctl_version &#125;&#125;</span>/calicoctl-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_crds_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calico/archive/<span class="template-variable">&#123;&#123; calico_version &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crictl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kubernetes-sigs/cri-tools/releases/download/<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>/crictl-<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">helm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/get.helm.sh/helm-<span class="template-variable">&#123;&#123; helm_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">nerdctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containerd/nerdctl/releases/download/v<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>/nerdctl-<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">patched_kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/k8sli/kubernetes/releases/download/<span class="template-variable">&#123;&#123; kubeadm_patch_version &#125;&#125;</span>/kubeadm-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><p>åœ¨æ„å»ºå®‰è£…åŒ…çš„æ—¶å€™ï¼Œå°† download_url å˜é‡è®¾ç½®ä¸º <code>https://</code> ï¼Œåœ¨éƒ¨ç½²çš„æ—¶å€™å°† <code>download_url</code> è®¾ç½®ä¸ºå†…ç½‘ æ–‡ä»¶æœåŠ¡å™¨æœåŠ¡å™¨çš„ URLï¼Œæ¯”å¦‚ <code>https://172.20.0.25:8080/files</code>ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°æ–‡ä»¶æ„å»ºå’Œéƒ¨ç½²ä½¿ç”¨çš„ç»Ÿä¸€ï¼ŒèŠ‚çœç»´æŠ¤æˆæœ¬ã€‚</p><ul><li>é•œåƒ</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define image repo and tag overwrite role/download/default/main.yml</span></span><br><span class="line"><span class="attr">pod_infra_image_tag:</span> <span class="string">"<span class="template-variable">&#123;&#123; pod_infra_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">pod_infra_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span>/pause"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kube_proxy_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span>/kube-proxy"</span></span><br><span class="line"><span class="attr">kube_apiserver_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span>/kube-apiserver"</span></span><br><span class="line"><span class="attr">kube_scheduler_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span>/kube-scheduler"</span></span><br><span class="line"><span class="attr">kube_controller_manager_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span>/kube-controller-manager"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">coredns_image_tag:</span> <span class="string">"<span class="template-variable">&#123;&#123; coredns_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">dnsautoscaler_image_tag:</span> <span class="string">"<span class="template-variable">&#123;&#123; dnsautoscaler_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">coredns_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_image_repo &#125;&#125;</span>/coredns"</span></span><br><span class="line"><span class="attr">dnsautoscaler_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span>/cluster-proportional-autoscaler-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Full image name for generate images list</span></span><br><span class="line"><span class="attr">kube_proxy_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_proxy_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kube_apiserver_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_apiserver_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kube_scheduler_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_scheduler_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kube_controller_manager_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_controller_manager_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">coredns_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; coredns_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; coredns_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">dnsautoscaler_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; dnsautoscaler_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; dnsautoscaler_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">nginx_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; nginx_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; nginx_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">pod_infra_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; pod_infra_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; pod_infra_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_policy_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; calico_policy_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; calico_policy_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_cni_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; calico_cni_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; calico_cni_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_node_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; calico_node_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; calico_node_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">flannel_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; flannel_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; flannel_image_tag &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><ul><li><code>generate.sh</code> åˆ—è¡¨ç”Ÿæˆè„šæœ¬</li></ul><p>æˆ‘ä»¬æ ¹æ®ä¸Šé¢ group_vars ä¸­å®šä¹‰çš„ç‰ˆæœ¬å·å’Œä¸€äº›å‚æ•°ï¼Œä½¿ç”¨è„šæœ¬çš„æ–¹å¼è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ï¼Œæ„å»ºçš„æ—¶å€™æ ¹æ®è¿™äº›åˆ—è¡¨æ¥ä¸‹è½½æ‰€éœ€è¦çš„æ–‡ä»¶å’Œé•œåƒã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line"></span><br><span class="line">SCRIPT_PATH=$(<span class="built_in">cd</span> $(dirname <span class="variable">$0</span>); <span class="built_in">pwd</span>)</span><br><span class="line">REPO_PATH=<span class="string">"<span class="variable">$&#123;SCRIPT_PATH%/build&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">: <span class="variable">$&#123;IMAGE_ARCH:="amd64"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;ANSIBLE_ARCHITECTURE:="x86_64"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;DOWNLOAD_YML:="config/group_vars/all/download.yml"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ARCH used in convert &#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125; to &#123;&#123;arch&#125;&#125;</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$&#123;IMAGE_ARCH&#125;</span>"</span> != <span class="string">"amd64"</span> ]]; <span class="keyword">then</span> ARCH=<span class="string">"-<span class="variable">$&#123;IMAGE_ARCH&#125;</span>"</span>; <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">cat &gt; /tmp/generate.sh &lt;&lt; EOF</span><br><span class="line">arch=<span class="variable">$&#123;ARCH&#125;</span></span><br><span class="line">download_url=https:/</span><br><span class="line">image_arch=<span class="variable">$&#123;IMAGE_ARCH&#125;</span></span><br><span class="line">ansible_system=linux</span><br><span class="line">ansible_architecture=<span class="variable">$&#123;ANSIBLE_ARCHITECTURE&#125;</span></span><br><span class="line">registry_project=library</span><br><span class="line">registry_domain=localhost</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate all component version by $DOWNLOAD_YML</span></span><br><span class="line">grep <span class="string">'_version:'</span> <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">| sed <span class="string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> | tr -d <span class="string">' '</span> &gt;&gt; /tmp/generate.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate download files url list</span></span><br><span class="line">grep <span class="string">'_download_url:'</span> <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">| sed <span class="string">'s/: /=/g;s/ //g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g;s/|lower//g;s/^.*_url=/echo /g'</span> &gt;&gt; /tmp/generate.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate download images list</span></span><br><span class="line">grep -E <span class="string">'_image_tag:|_image_repo:|_image_name:'</span> <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">| sed <span class="string">"s#&#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125;#&#123;&#123;arch&#125;&#125;#g"</span> \</span><br><span class="line">| sed <span class="string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> | tr -d <span class="string">' '</span> &gt;&gt; /tmp/generate.sh</span><br><span class="line"></span><br><span class="line">grep <span class="string">'_image_name:'</span> <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">| cut -d <span class="string">':'</span> -f1 | sed <span class="string">'s/^/echo $/g'</span> &gt;&gt; /tmp/generate.sh</span><br></pre></td></tr></table></figure><p>ä¸ºäº†åŒæ—¶æ”¯æŒ amd64 å’Œ arm64 çš„ CPU æ¶æ„ï¼Œéœ€è¦ä¸ºä¸¤ç§æ¶æ„å„è‡ªç”Ÿæˆåˆ—è¡¨ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹ã€‚åœ¨è¿™é‡Œè¸©çš„ä¸€ä¸ªå‘å°±æ˜¯ä¸åŒçš„ç»„ä»¶é•œåƒçš„å‘½åæ–¹æ³•åƒå·®ä¸‡åˆ«ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å››ç§æƒ…å†µï¼š</p><ul><li>åƒ kube-apiserver è¿™äº› k8s ç»„ä»¶çš„é•œåƒï¼Œé•œåƒåç§°å’Œé•œåƒ tag æ˜¯ä¸éœ€è¦åŠ ä¸Š CPU ä½“ç³»æ¶æ„çš„ï¼›</li><li>cluster-proportional-autoscaler çš„é•œåƒåˆ™æ˜¯åœ¨é•œåƒçš„åç§°åé¢åŠ ä¸Šäº† CPU ä½“ç³»æ¶æ„çš„åç§°å¦‚ cluster-proportional-autoscaler-amd64ï¼Œcluster-proportional-autoscaler-arm64ï¼›</li><li>flannel åˆ™æ˜¯å°† CPU ä½“ç³»æ¶æ„åç§°å®šä¹‰åœ¨é•œåƒ tag åé¢æ¯”å¦‚ <code>flannel:v0.14.0-amd64</code>ï¼›</li><li>è¿˜æœ‰ calico æ›´å¥‡è‘©ï¼Œamd64 æ¶æ„çš„é•œåƒä¸éœ€è¦åŠ ä½“ç³»æ¶æ„çš„åç§°å¦‚ <code>calico/cni:v3.18.4</code>ï¼Œè€Œ arm64 çš„åˆ™å¿…é¡»è¦åœ¨é•œåƒ tag åé¢å¸¦ä¸Š CPU ä½“ç³»æ¶æ„æ¯”å¦‚ <code>calico/cni:v3.18.4-arm64</code>ï¼›</li></ul><p><img src="https://p.k8s.li/2021-08-31-pass-tob-k8s-offline-deploy-2.jpeg" alt=""></p><p>åœ¨è¿™é‡Œéœ€è¦å¼ºè°ƒä¸€ä¸‹ï¼Œæ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ä¸€å®šè¦ä½¿ç”¨è‡ªåŠ¨åŒ–çš„æ–¹å¼æ¥ç®¡ç†ï¼Œåˆ‡å‹¿æ‰‹åŠ¨æ›´æ–°ï¼Œè¿™æ ·èƒ½èŠ‚çœå¤§é‡çš„ç»´æŠ¤æˆæœ¬ï¼Œä¸ç„¶çš„è¯æ¯æ¬¡éƒ½æ‰‹åŠ¨å»æ›´æ–°è¿™äº›åˆ—è¡¨æˆæœ¬å®åœ¨æ˜¯å¤ªé«˜äº†ï¼Œè€Œä¸”ç‰¹åˆ«å®¹æ˜“å‡ºå‡ºé”™æˆ–è€…é—æ¼æŸä¸ªç»„ä»¶ã€‚</p><h3 id="kubespray-files"><a href="#kubespray-files" class="headerlink" title="kubespray-files"></a>kubespray-files</h3><p>æˆ‘ä»¬å°† kubespray éƒ¨ç½²æ‰€ä¾èµ–çš„äºŒè¿›åˆ¶æ–‡ä»¶æ„å»ºåœ¨ä¸€ä¸ªåä¸º kubespray-files çš„é•œåƒå½“ä¸­ï¼š</p><ul><li>ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">https://get.helm.sh/helm-v3.6.3-linux-amd64.tar.gz</span><br><span class="line">https://github.com/containerd/nerdctl/releases/download/v0.8.1/nerdctl-0.8.1-linux-amd64.tar.gz</span><br><span class="line">https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">https://github.com/coreos/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">https://github.com/k8sli/kubernetes/releases/download/v1.21.3-patch-1.0/kubeadm-linux-amd64</span><br><span class="line">https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.21.0/crictl-v1.21.0-linux-amd64.tar.gz</span><br><span class="line">https://github.com/projectcalico/calico/archive/v3.18.4.tar.gz</span><br><span class="line">https://github.com/projectcalico/calicoctl/releases/download/v3.18.4/calicoctl-linux-amd64</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.21.3/bin/linux/amd64/kubeadm</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.21.3/bin/linux/amd64/kubectl</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.21.3/bin/linux/amd64/kubelet</span><br></pre></td></tr></table></figure><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:latest as files</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk --no-cache add wget ca-certificates</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /build</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> build/kubespray-files/files_*.list /build/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed <span class="string">'/#/d'</span> *<span class="variable">$&#123;ARCH&#125;</span>.list &gt; all_files.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -x -P /files -i all_files.list</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=files /files /files</span></span><br></pre></td></tr></table></figure><ul><li>æ„å»ºåçš„ç›®å½•ç»“æ„ï¼Œé€šè¿‡ç›®å½•å±‚çº§çš„æ–¹å¼ä¿ç•™åŸæœ‰çš„ URL åœ°å€ï¼Œç»´æŠ¤å’Œä½¿ç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">files/</span><br><span class="line">â”œâ”€â”€ get.helm.sh</span><br><span class="line">â”‚Â Â  â””â”€â”€ helm-v3.6.3-linux-amd64.tar.gz</span><br><span class="line">â”œâ”€â”€ github.com</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containerd</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ nerdctl</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.8.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ nerdctl-0.8.1-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containernetworking</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ plugins</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.9.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ coreos</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ etcd</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v3.4.13</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ k8sli</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ kubernetes</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v1.21.3-patch-1.0</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ kubeadm-linux-amd64</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kubernetes-sigs</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ cri-tools</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v1.21.0</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ crictl-v1.21.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â””â”€â”€ projectcalico</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ calico</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ archive</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ v3.18.4.tar.gz</span><br><span class="line">â”‚Â Â      â””â”€â”€ calicoctl</span><br><span class="line">â”‚Â Â          â””â”€â”€ releases</span><br><span class="line">â”‚Â Â              â””â”€â”€ download</span><br><span class="line">â”‚Â Â                  â””â”€â”€ v3.18.4</span><br><span class="line">â”‚Â Â                      â””â”€â”€ calicoctl-linux-amd64</span><br><span class="line">â””â”€â”€ storage.googleapis.com</span><br><span class="line">    â””â”€â”€ kubernetes-release</span><br><span class="line">        â””â”€â”€ release</span><br><span class="line">            â””â”€â”€ v1.21.3</span><br><span class="line">                â””â”€â”€ bin</span><br><span class="line">                    â””â”€â”€ linux</span><br><span class="line">                        â””â”€â”€ amd64</span><br><span class="line">                            â”œâ”€â”€ kubeadm</span><br><span class="line">                            â”œâ”€â”€ kubectl</span><br><span class="line">                            â””â”€â”€ kubelet</span><br></pre></td></tr></table></figure><h3 id="kubespray-images"><a href="#kubespray-images" class="headerlink" title="kubespray-images"></a>kubespray-images</h3><p>æˆ‘ä»¬åŒæ ·å°† kubespray éƒ¨ç½²æ‰€éœ€è¦çš„ç»„ä»¶é•œåƒæ„å»ºåœ¨ä¸€ä¸ªåä¸º kubespray-images çš„é•œåƒå½“ä¸­ï¼š</p><ul><li>é•œåƒåˆ—è¡¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">library/calico-cni:v3.18.4</span><br><span class="line">library/calico-kube-controllers:v3.18.4</span><br><span class="line">library/calico-node:v3.18.4</span><br><span class="line">library/calico-pod2daemon-flexvol:v3.18.4</span><br><span class="line">library/cluster-proportional-autoscaler-amd64:1.8.3</span><br><span class="line">library/coredns:v1.8.0</span><br><span class="line">library/flannel:v0.14.0-amd64</span><br><span class="line">library/kube-apiserver:v1.21.3</span><br><span class="line">library/kube-controller-manager:v1.21.3</span><br><span class="line">library/kube-proxy:v1.21.3</span><br><span class="line">library/kube-scheduler:v1.21.3</span><br><span class="line">library/nginx:1.19</span><br><span class="line">library/pause:3.3</span><br></pre></td></tr></table></figure><ul><li>Dockerfile</li></ul><p>åœ¨ Dockerfile é‡Œå®Œæˆæ‰€æœ‰é•œåƒçš„ä¸‹è½½ï¼Œå¹¶ä½¿ç”¨ ã€Š<a href="https://blog.k8s.li/skopeo-to-registry.html">å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</a>ã€‹æ–‡ä¸­æåˆ°çš„éªšæ“ä½œï¼Œåˆ©ç”¨ registry å­˜å‚¨å¤ç”¨ç›¸åŒ layer çš„ç‰¹æ€§ï¼Œå°† skopeo sync ä¸‹è½½çš„é•œåƒè½¬æ¢æˆ registry å­˜å‚¨çš„ç»“æ„ã€‚è¿™æ ·åœ¨éƒ¨ç½²çš„æ—¶å€™ç›´æ¥æŠŠè¿™ä¸ª registry å­˜å‚¨ç›®å½•æŒ‚è½½è¿› registry å®¹å™¨çš„ <code>/var/lib/registry</code> å³å¯ã€‚ç‰¹ç‚¹æ˜¯æ€§èƒ½æ–¹é¢æ— è®ºæ˜¯æ„å»ºå’Œéƒ¨ç½²ï¼Œéƒ½æ¯”å¸¸è§„ä½¿ç”¨ docker save å’Œ docker load çš„æ–¹å¼è¦å¿«è‡³å°‘ 5 åˆ° 10 å€ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">FROM alpine:3.12 as images</span><br><span class="line">ARG SKOPEO_VERSION=v1.4.0</span><br><span class="line">ARG YQ_VERSION=v4.11.2</span><br><span class="line">RUN ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span><br><span class="line">    &amp;&amp; apk --no-cache add bash wget ca-certificates \</span><br><span class="line">    &amp;&amp; wget -q -k https://github.com/mikefarah/yq/releases/download/<span class="variable">$&#123;YQ_VERSION&#125;</span>/yq_linux_<span class="variable">$&#123;ARCH&#125;</span> -O /usr/<span class="built_in">local</span>/bin/yq \</span><br><span class="line">    &amp;&amp; wget -q -k https://github.com/k8sli/skopeo/releases/download/<span class="variable">$&#123;SKOPEO_VERSION&#125;</span>/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> -O /usr/<span class="built_in">local</span>/bin/skopeo \</span><br><span class="line">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/*</span><br><span class="line"></span><br><span class="line">WORKDIR /build</span><br><span class="line">COPY build/kubespray-images/*  /build/</span><br><span class="line">RUN ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span><br><span class="line">    &amp;&amp; IMAGE_ARCH=<span class="variable">$&#123;ARCH&#125;</span> bash build.sh</span><br><span class="line"></span><br><span class="line">FROM scratch</span><br><span class="line">COPY --from=images /build/docker /docker</span><br></pre></td></tr></table></figure><ul><li>images_origin.yaml é•œåƒé…ç½®æ–‡ä»¶</li></ul><p>è€ƒè™‘åˆ°æœ‰å°†é•œåƒå¯¼å…¥åˆ°å·²ç»å­˜åœ¨çš„é•œåƒä»“åº“ä¸­çš„åœºæ™¯ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹é•œåƒä»“åº“çš„ repoã€‚å› ä¸º <code>library</code> è¿™ä¸ª repo åœ¨ harbor ä¸­æ˜¯é»˜è®¤è‡ªå¸¦çš„ï¼Œåœ¨å¯¼å…¥åˆ° harbor çš„è¿‡ç¨‹ä¸­ä¹Ÿä¸éœ€è¦åˆ›å»ºä¸€äº›é¢å¤–çš„ project ï¼Œæ‰€ä»¥å°†æ‰€æœ‰é•œåƒçš„ repo å…¨éƒ¨ç»Ÿä¸€ä¸º <code>library</code> æ›´é€šç”¨ä¸€äº›ã€‚</p><p>è¿™é‡Œç”¨ä¸€ä¸ª yaml é…ç½®æ–‡ä»¶æ¥è®°å½•åŸé•œåƒåœ°å€å’Œ library é•œåƒçš„åœ°å€çš„å¯¹åº”å…³ç³»ã€‚æ¯”å¦‚ä¸Šæ¸¸çš„ <code>k8s.gcr.io/kube-apiserver</code> æ˜ å°„ä¸º <code>library/kube-apiserver</code>ï¼Œ <code>quay.io/calico/node</code> æ˜ å°„ä¸º <code>library/calico-node</code>ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># kubeadm core images</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-apiserver</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/kube-apiserver</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-controller-manager</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/kube-controller-manager</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-proxy</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/kube-proxy</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-scheduler</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/kube-scheduler</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/coredns/coredns</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/coredns</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/pause</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/pause</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes addons</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/dns/k8s-dns-node-cache</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/k8s-dns-node-cache</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/cluster-proportional-autoscaler-amd64</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/cpa/cluster-proportional-autoscaler-arm64</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/cluster-proportional-autoscaler-arm64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># network plugin</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/cni</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/calico-cni</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/node</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/calico-node</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/kube-controllers</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/calico-kube-controllers</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/pod2daemon-flexvol</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/calico-pod2daemon-flexvol</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/typha</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/calico-typha</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/coreos/flannel</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/flannel</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx for daemonset and offline</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/nginx</span></span><br></pre></td></tr></table></figure><h3 id="kubeplay-1"><a href="#kubeplay-1" class="headerlink" title="kubeplay"></a>kubeplay</h3><p>kubeplay éƒ¨ç½²çš„ä»£ç ä¸»è¦æ˜¯ç”±ä¸€äº› shell è„šæœ¬å’Œé…ç½®æ–‡ä»¶æ„æˆï¼Œç”¨äºå®Œæˆ nginx æœåŠ¡å’Œ registry æœåŠ¡çš„éƒ¨ç½²ï¼Œä»¥åŠæœ€åè°ƒç”¨ kubespray æ¥å®Œæˆé›†ç¾¤éƒ¨ç½²ã€‚</p><ul><li>ä»£ç ç»“æ„</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubeplay/</span><br><span class="line">â”œâ”€â”€ Dockerfile          <span class="comment"># æ„å»ºå®Œæ•´å®‰è£…åŒ…çš„ Dockerfile</span></span><br><span class="line">â”œâ”€â”€ compose.yaml        <span class="comment"># compose å¯åŠ¨é…ç½® yaml æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ compose</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ nginx.conf  <span class="comment"># nginx é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”‚Â Â  â””â”€â”€ rootCA.cnf      <span class="comment"># ç”Ÿæˆé•œåƒä»“åº“è¯ä¹¦ç”¨åˆ°çš„ openssl é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ config-sample.yaml  <span class="comment"># ä¸»é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ install.sh          <span class="comment"># å®‰è£…æ“ä½œç„¶å</span></span><br><span class="line">â””â”€â”€ library             <span class="comment"># ä¸€äº› shell å‡½æ•°åº“</span></span><br></pre></td></tr></table></figure><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:latest as downloader</span><br><span class="line"><span class="keyword">ARG</span> SKOPEO_VERSION=v1.<span class="number">4.0</span></span><br><span class="line"><span class="keyword">ARG</span> YQ_VERSION=v4.<span class="number">11.2</span></span><br><span class="line"><span class="keyword">ARG</span> NERDCTL_VERSION=<span class="number">0.11</span>.<span class="number">0</span></span><br><span class="line"><span class="keyword">ARG</span> NGINX_VERSION=<span class="number">1.20</span>-alpine</span><br><span class="line"><span class="keyword">ARG</span> RERGISRRY_VERSION=<span class="number">2.7</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">ARG</span> KUBESPRAY_VERSION=latest</span><br><span class="line"><span class="keyword">ARG</span> KUBESPRAY_IMAGE=ghcr.io/k8sli/kubespray</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½éƒ¨ç½²æ—¶éœ€è¦çš„å·¥å…·ï¼Œå¦‚ yqã€skopeoã€nerdctl-fullsss</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /tools</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add wget ca-certificates \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -k https://github.com/mikefarah/yq/releases/download/<span class="variable">$&#123;YQ_VERSION&#125;</span>/yq_linux_<span class="variable">$&#123;ARCH&#125;</span>  -O /tools/yq-linux-<span class="variable">$&#123;ARCH&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -k https://github.com/k8sli/skopeo/releases/download/v1.4.0/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> -O /tools/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -k https://github.com/containerd/nerdctl/releases/download/v<span class="variable">$&#123;NERDCTL_VERSION&#125;</span>/nerdctl-full-<span class="variable">$&#123;NERDCTL_VERSION&#125;</span>-linux-<span class="variable">$&#123;ARCH&#125;</span>.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /tools/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ln -s /tools/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> /usr/bin/skopeo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ä¸€äº›é•œåƒï¼Œå¦‚ nginxã€registryã€kubespray</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /images</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=<span class="literal">false</span> --override-arch <span class="variable">$&#123;ARCH&#125;</span> --additional-tag nginx:<span class="variable">$&#123;NGINX_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">       docker://docker.io/library/nginx:<span class="variable">$&#123;NGINX_VERSION&#125;</span> docker-archive:nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span>.tar \</span></span><br><span class="line"><span class="bash">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=<span class="literal">false</span> --override-arch <span class="variable">$&#123;ARCH&#125;</span> --additional-tag registry:<span class="variable">$&#123;RERGISRRY_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">       docker://docker.io/library/registry:<span class="variable">$&#123;RERGISRRY_VERSION&#125;</span> docker-archive:registry-<span class="variable">$&#123;RERGISRRY_VERSION&#125;</span>.tar \</span></span><br><span class="line"><span class="bash">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=<span class="literal">false</span> --override-arch <span class="variable">$&#123;ARCH&#125;</span> --additional-tag kubespray:<span class="variable">$&#123;KUBESPRAY_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">       docker://<span class="variable">$&#123;KUBESPRAY_IMAGE&#125;</span>:<span class="variable">$&#123;KUBESPRAY_VERSION&#125;</span> docker-archive:kubespray-<span class="variable">$&#123;KUBESPRAY_VERSION&#125;</span>.tar</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"> <span class="comment"># å°†å…¶å®ƒæ¨¡å—ä¸­çš„å†…å®¹å¤åˆ¶åˆ° scratch é•œåƒä¸­ï¼Œæ„å»ºçš„æ—¶å€™å¯¼å‡ºä¸º local æ–¹å¼</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=downloader /tools /resources/nginx/tools</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=downloader /images /resources/images</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=<span class="variable">$&#123;OS_PACKAGES_IMAGE&#125;</span>:<span class="variable">$&#123;OS_PACKAGE_REPO_TAG&#125;</span> / /resources/nginx</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=<span class="variable">$&#123;KUBESPRAY_FILES_IMAGE&#125;</span>:<span class="variable">$&#123;KUBESPRAY_REPO_TAG&#125;</span> / /resources/nginx</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=<span class="variable">$&#123;KUBESPRAY_IMAGES_IMAGE&#125;</span>:<span class="variable">$&#123;KUBESPRAY_REPO_TAG&#125;</span> / /resources/registry</span></span><br></pre></td></tr></table></figure><h3 id="æ„å»º"><a href="#æ„å»º" class="headerlink" title="æ„å»º"></a>æ„å»º</h3><p>ç”±äºæœ€ç»ˆçš„æ„å»ºæ¶‰åŠå¤šä¸ªæ¨¡å—å’Œ repoï¼Œå…¶æµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œè¯¦ç»†çš„ä»£ç å¯å‚è€ƒæºç  <a href="https://github.com/k8sli/kubeplay/blob/main/.github/workflows/build.yaml" target="_blank" rel="noopener">build.yaml</a> ï¼Œåœ¨è¿™é‡Œåªè®²å‡ ä¸ªå…³é”®çš„éƒ¨åˆ†</p><ul><li>checkout repoï¼Œå°† kubespray å’Œ os-packages repo clone åˆ°å·¥ä½œç›®å½•</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build-package:</span></span><br><span class="line">    <span class="comment"># ä»¥ tag çš„äº‹ä»¶è§¦å‘æ„å»ºæµæ°´çº¿</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">startsWith(github.ref,</span> <span class="string">'refs/tags/'</span><span class="string">)</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-20.04</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># fetch all git repo tag for define image tag</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">kubespray</span> <span class="string">repo</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">main</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">kubespray</span></span><br><span class="line">          <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.repository_owner</span> <span class="string">&#125;&#125;/kubespray</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">os-packages</span> <span class="string">repo</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">main</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">os-packages</span></span><br><span class="line">          <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.repository_owner</span> <span class="string">&#125;&#125;/os-packages</span></span><br></pre></td></tr></table></figure><ul><li>è·å– kubespray å’Œ os-packages çš„ repo tagï¼Œæ ¹æ®å®ƒæ¥ç¡®å®š os-packages, kubespray-files, kubespray-images è¿™ä¸ªä¸‰ä¸ªé•œåƒçš„ tagï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª All in One çš„ Dockerfile ç”¨äºå®Œæˆåç»­å®‰è£…åŒ…çš„æ„å»ºã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–ä¸€äº›ç»„ä»¶çš„ç‰ˆæœ¬å’Œå˜é‡ä¼ é€’ç»™ Dockerfile</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prepare</span> <span class="string">for</span> <span class="string">build</span> <span class="string">images</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">git</span> <span class="string">describe</span> <span class="string">--tags</span> <span class="string">--always</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/IMAGE_TAG=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line"></span><br><span class="line">    <span class="string">cd</span> <span class="string">kubespray</span> <span class="string">&amp;&amp;</span> <span class="string">git</span> <span class="string">describe</span> <span class="string">--tags</span> <span class="string">--always</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/KUBESPRAY_VERSION=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span> <span class="string">&amp;&amp;</span> <span class="string">cd</span> <span class="string">..</span></span><br><span class="line">    <span class="string">cd</span> <span class="string">os-packages</span> <span class="string">&amp;&amp;</span> <span class="string">git</span> <span class="string">describe</span> <span class="string">--tags</span> <span class="string">--always</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/OS_PACKAGE_REPO_TAG=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span> <span class="string">&amp;&amp;</span> <span class="string">cd</span> <span class="string">..</span></span><br><span class="line">    <span class="string">cp</span> <span class="string">-rf</span> <span class="string">kubespray/config</span> <span class="string">config/kubespray</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">kubespray</span> <span class="string">os-packages</span></span><br><span class="line"></span><br><span class="line">    <span class="string">source</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">echo</span> <span class="string">""</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="string">echo</span> <span class="string">"COPY --from=$&#123;OS_PACKAGES_IMAGE&#125;:$&#123;OS_PACKAGE_REPO_TAG&#125; / /resources/nginx"</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="string">echo</span> <span class="string">"COPY --from=$&#123;KUBESPRAY_FILES_IMAGE&#125;:$&#123;KUBESPRAY_VERSION&#125; / /resources/nginx"</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="string">echo</span> <span class="string">"COPY --from=$&#123;KUBESPRAY_IMAGES_IMAGE&#125;:$&#123;KUBESPRAY_VERSION&#125; / /resources/registry"</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line"></span><br><span class="line">    <span class="string">sed</span> <span class="string">-n</span> <span class="string">'s|image: nginx:|NGINX_VERSION=|p'</span> <span class="string">compose.yaml</span> <span class="string">|</span> <span class="string">tr</span> <span class="string">-d</span> <span class="string">' '</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">sed</span> <span class="string">-n</span> <span class="string">'s|image: registry:|RERGISRRY_VERSION=|p'</span> <span class="string">compose.yaml</span> <span class="string">|</span> <span class="string">tr</span> <span class="string">-d</span> <span class="string">' '</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <code>outputs: type=local,dest=./</code> æ„å»ºé•œåƒåˆ°æœ¬åœ°ç›®å½•è€Œé push åˆ° registry</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">kubeplay</span> <span class="string">image</span> <span class="string">to</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">docker/build-push-action@v2</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">platforms:</span> <span class="string">linux/amd64,linux/arm64</span></span><br><span class="line">    <span class="attr">build-args:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">NGINX_VERSION=$&#123;&#123;</span> <span class="string">env.NGINX_VERSION</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">RERGISRRY_VERSION=$&#123;&#123;</span> <span class="string">env.RERGISRRY_VERSION</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">KUBESPRAY_IMAGE=$&#123;&#123;</span> <span class="string">env.KUBESPRAY_IMAGE</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">KUBESPRAY_VERSION=$&#123;&#123;</span> <span class="string">env.KUBESPRAY_VERSION</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">outputs:</span> <span class="string">type=local,dest=./</span></span><br></pre></td></tr></table></figure><ul><li>æ‰“åŒ…å¹¶ä¸Šä¼ å®‰è£…åŒ…åˆ° GitHub release å­˜å‚¨</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prepare</span> <span class="string">for</span> <span class="string">upload</span> <span class="string">package</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">rm</span> <span class="string">-rf</span> <span class="string">linux_&#123;amd64,arm64&#125;/&#123;Dockerfile,LICENSE&#125;</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">linux_amd64</span> <span class="string">kubeplay</span></span><br><span class="line">    <span class="string">tar</span> <span class="string">-I</span> <span class="string">pigz</span> <span class="string">-cf</span> <span class="string">kubeplay-$&#123;IMAGE_TAG&#125;-linux-amd64.tar.gz</span> <span class="string">kubeplay</span> <span class="string">--remove-files</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">linux_arm64</span> <span class="string">kubeplay</span></span><br><span class="line">    <span class="string">tar</span> <span class="string">-I</span> <span class="string">pigz</span> <span class="string">-cf</span> <span class="string">kubeplay-$&#123;IMAGE_TAG&#125;-linux-arm64.tar.gz</span> <span class="string">kubeplay</span> <span class="string">--remove-files</span></span><br><span class="line">    <span class="string">sha256sum</span> <span class="string">kubeplay-$&#123;IMAGE_TAG&#125;-linux-&#123;amd64,arm64&#125;.tar.gz</span> <span class="string">&gt;</span> <span class="string">sha256sum.txt</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span> <span class="string">and</span> <span class="string">upload</span> <span class="string">packages</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">softprops/action-gh-release@v1</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">files:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">sha256sum.txt</span></span><br><span class="line">      <span class="string">kubeplay-$&#123;&#123;</span> <span class="string">env.IMAGE_TAG</span> <span class="string">&#125;&#125;-linux-amd64.tar.gz</span></span><br><span class="line">      <span class="string">kubeplay-$&#123;&#123;</span> <span class="string">env.IMAGE_TAG</span> <span class="string">&#125;&#125;-linux-arm64.tar.gz</span></span><br></pre></td></tr></table></figure><p>ç”±æ­¤ä¸€ä¸ªå®Œæ•´çš„ç¦»çº¿å®‰è£…åŒ…å°±æ„å»ºå®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å†è®²ä¸€ä¸‹å®‰è£…æµç¨‹</p><h2 id="å®‰è£…æµç¨‹"><a href="#å®‰è£…æµç¨‹" class="headerlink" title="å®‰è£…æµç¨‹"></a>å®‰è£…æµç¨‹</h2><p>åœ¨ <a href="https://github.com/k8sli/kubeplay/releases" target="_blank" rel="noopener">GitHub release é¡µé¢</a> å°†æˆ‘ä»¬çš„ç¦»çº¿å®‰è£…åŒ…ä¸‹è½½åˆ°æœ¬åœ°ï¼Œéœ€è¦æ ¹æ® CPU æ¶æ„çš„ç±»å‹é€‰æ‹©ç›¸åº”çš„å®‰è£…åŒ…ã€‚</p><p><img src="https://p.k8s.li/2021-08-24-offline-deploy-k8s-1.png" alt="image"></p><p>ä¸‹è½½å®Œæˆä¹‹åå†å°†å®‰è£…åŒ…é€šè¿‡ scp æˆ–è€…å…¶ä»–æ–¹å¼ä¸Šä¼ åˆ°å†…ç½‘çš„éƒ¨ç½²èŠ‚ç‚¹ä¸Šï¼Œéƒ¨ç½²çš„æ–‡æ¡£å¯å‚è€ƒ <a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">README</a> ã€‚è¿‡ç¨‹ååˆ†ç®€å•ï¼šåªéœ€è¦å¡«å†™å¥½ <code>config.yaml</code> é…ç½®æ–‡ä»¶ç„¶åæ‰§è¡Œ <code>bash install.sh</code> å³å¯å®Œæˆ K8s é›†ç¾¤çš„ä¸€é”®éƒ¨ç½²ã€‚</p><p>ä¸‹é¢ä»æºç è€Œé README æ–‡æ¡£çš„è§’åº¦æ¥è®²ä¸€ä¸‹éƒ¨ç½²æµç¨‹çš„å®ç°ç»†èŠ‚</p><h3 id="å®‰è£…åŒ…ç»“æ„"><a href="#å®‰è£…åŒ…ç»“æ„" class="headerlink" title="å®‰è£…åŒ…ç»“æ„"></a>å®‰è£…åŒ…ç»“æ„</h3><ul><li>é…ç½®æ–‡ä»¶ <code>config.yaml</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx ç«¯å£å’Œ registry åŸŸåé…ç½®å‚æ•°</span></span><br><span class="line"><span class="attr">compose:</span></span><br><span class="line">  <span class="comment"># Compose bootstrap node ip, default is local internal ip</span></span><br><span class="line">  <span class="attr">internal_ip:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.25</span></span><br><span class="line">  <span class="comment"># Nginx http server bind port for download files and packages</span></span><br><span class="line">  <span class="attr">nginx_http_port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="comment"># Registry domain for CRI runtime download images</span></span><br><span class="line">  <span class="attr">registry_domain:</span> <span class="string">kube.registry.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubespray å‚æ•°</span></span><br><span class="line"><span class="attr">kubespray:</span></span><br><span class="line">  <span class="comment"># Kubernetes version by default, only support v1.20.6</span></span><br><span class="line">  <span class="attr">kube_version:</span> <span class="string">v1.21.3</span></span><br><span class="line">  <span class="comment"># For deploy HA cluster you must configure a external apiserver access ip</span></span><br><span class="line">  <span class="attr">external_apiserver_access_ip:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">  <span class="comment"># Set network plugin to calico with vxlan mode by default</span></span><br><span class="line">  <span class="attr">kube_network_plugin:</span> <span class="string">calico</span></span><br><span class="line">  <span class="comment">#Container runtime, only support containerd if offline deploy</span></span><br><span class="line">  <span class="attr">container_manager:</span> <span class="string">containerd</span></span><br><span class="line">  <span class="comment"># Now only support host if use containerd as CRI runtime</span></span><br><span class="line">  <span class="attr">etcd_deployment_type:</span> <span class="string">host</span></span><br><span class="line">  <span class="comment"># Settings for etcd event server</span></span><br><span class="line">  <span class="attr">etcd_events_cluster_setup:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">etcd_events_cluster_enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹ ssh ç™»å½• inventory é…ç½®</span></span><br><span class="line"><span class="comment"># Cluster nodes inventory info</span></span><br><span class="line"><span class="attr">inventory:</span></span><br><span class="line">  <span class="attr">all:</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">ansible_port:</span> <span class="number">22</span></span><br><span class="line">      <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">ansible_ssh_pass:</span> <span class="string">Password</span></span><br><span class="line">      <span class="comment"># ansible_ssh_private_key_file: /kubespray/config/id_rsa</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">      <span class="attr">node1:</span></span><br><span class="line">        <span class="attr">ansible_host:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.21</span></span><br><span class="line">      <span class="attr">node2:</span></span><br><span class="line">        <span class="attr">ansible_host:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.22</span></span><br><span class="line">      <span class="attr">node3:</span></span><br><span class="line">        <span class="attr">ansible_host:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.23</span></span><br><span class="line">      <span class="attr">node4:</span></span><br><span class="line">        <span class="attr">ansible_host:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.24</span></span><br><span class="line">    <span class="attr">children:</span></span><br><span class="line">      <span class="attr">kube_control_plane:</span></span><br><span class="line">        <span class="attr">hosts:</span></span><br><span class="line">          <span class="attr">node1:</span></span><br><span class="line">          <span class="attr">node2:</span></span><br><span class="line">          <span class="attr">node3:</span></span><br><span class="line">      <span class="attr">kube_node:</span></span><br><span class="line">        <span class="attr">hosts:</span></span><br><span class="line">          <span class="attr">node1:</span></span><br><span class="line">          <span class="attr">node2:</span></span><br><span class="line">          <span class="attr">node3:</span></span><br><span class="line">          <span class="attr">node4:</span></span><br><span class="line">      <span class="attr">etcd:</span></span><br><span class="line">        <span class="attr">hosts:</span></span><br><span class="line">          <span class="attr">node1:</span></span><br><span class="line">          <span class="attr">node2:</span></span><br><span class="line">          <span class="attr">node3:</span></span><br><span class="line">      <span class="attr">k8s_cluster:</span></span><br><span class="line">        <span class="attr">children:</span></span><br><span class="line">          <span class="attr">kube_control_plane:</span></span><br><span class="line">          <span class="attr">kube_node:</span></span><br><span class="line">      <span class="attr">gpu:</span></span><br><span class="line">        <span class="attr">hosts:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">calico_rr:</span></span><br><span class="line">        <span class="attr">hosts:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€äº›é»˜è®¤çš„é…ç½®ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ— éœ€ä¿®æ”¹</span></span><br><span class="line"><span class="comment">### Default parameters ###</span></span><br><span class="line"><span class="comment">## This filed not need config, will auto update,</span></span><br><span class="line"><span class="comment">## if no special requirement, do not modify these parameters.</span></span><br><span class="line"><span class="attr">default:</span></span><br><span class="line">  <span class="comment"># NTP server ip address or domain, default is internal_ip</span></span><br><span class="line">  <span class="attr">ntp_server:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">internal_ip</span></span><br><span class="line">  <span class="comment"># Registry ip address, default is internal_ip</span></span><br><span class="line">  <span class="attr">registry_ip:</span> <span class="string">internal_ip</span></span><br><span class="line">  <span class="comment"># Offline resource url for download files, default is internal_ip:nginx_http_port</span></span><br><span class="line">  <span class="attr">offline_resources_url:</span> <span class="string">internal_ip:nginx_http_port</span></span><br><span class="line">  <span class="comment"># Use nginx and registry provide all offline resources</span></span><br><span class="line">  <span class="attr">offline_resources_enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Image repo in registry</span></span><br><span class="line">  <span class="attr">image_repository:</span> <span class="string">library</span></span><br><span class="line">  <span class="comment"># Kubespray container image for deploy user cluster or scale</span></span><br><span class="line">  <span class="attr">kubespray_image:</span> <span class="string">"kubespray"</span></span><br><span class="line">  <span class="comment"># Auto generate self-signed certificate for registry domain</span></span><br><span class="line">  <span class="attr">generate_domain_crt:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># For nodes pull image, use 443 as default</span></span><br><span class="line">  <span class="attr">registry_https_port:</span> <span class="number">443</span></span><br><span class="line">  <span class="comment"># For push image to this registry, use 5000 as default, and only bind at 127.0.0.1</span></span><br><span class="line">  <span class="attr">registry_push_port:</span> <span class="number">5000</span></span><br><span class="line">  <span class="comment"># Set false to disable download all container images on all nodes</span></span><br><span class="line">  <span class="attr">download_container:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><ul><li>å®‰è£…åŒ…ç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">kubeplay/</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ compose.yaml                 <span class="comment"># compose é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ compose</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ nginx.conf           <span class="comment"># nginx é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kubespray</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ env.yml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ group_vars           <span class="comment"># kubespray group_vars  é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ inventory.ini</span><br><span class="line">â”‚Â Â  â””â”€â”€ rootCA.cnf               <span class="comment"># openssl é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ config-sample.yaml           <span class="comment"># ä¸»é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ install.sh                   <span class="comment"># å®‰è£…åŒ…å…¥å£è„šæœ¬</span></span><br><span class="line">â”œâ”€â”€ library</span><br><span class="line">â””â”€â”€ resources                    <span class="comment"># æ‰€æœ‰ç¦»çº¿èµ„æº</span></span><br><span class="line">    â”œâ”€â”€ images</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ kubespray-v2.16.tar  <span class="comment"># kubespray é•œåƒ</span></span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ nginx-1.20-alpine.tar<span class="comment"># nginx é•œåƒ</span></span><br><span class="line">    â”‚Â Â  â””â”€â”€ registry-2.7.1.tar   <span class="comment"># registry é•œåƒ</span></span><br><span class="line">    â”œâ”€â”€ nginx                    <span class="comment"># rpm/deb åŒ…ä»¥åŠä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ centos               <span class="comment"># centos rpm åŒ…</span></span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ debian               <span class="comment"># debian deb åŒ…</span></span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ files                <span class="comment"># ä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ repos                <span class="comment"># yum/apt é…ç½®æ–‡ä»¶</span></span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ tools                <span class="comment"># ä¸€äº›éƒ¨ç½²æ—¶ä¾èµ–çš„å·¥å…·</span></span><br><span class="line">    â”‚Â Â  â””â”€â”€ ubuntu               <span class="comment"># ubuntu deb åŒ…</span></span><br><span class="line">    â””â”€â”€ registry</span><br><span class="line">        â””â”€â”€ docker               <span class="comment"># ç»„ä»¶é•œåƒ registry å­˜å‚¨ç›®å½•</span></span><br></pre></td></tr></table></figure><h3 id="compose-èŠ‚ç‚¹"><a href="#compose-èŠ‚ç‚¹" class="headerlink" title="compose èŠ‚ç‚¹"></a>compose èŠ‚ç‚¹</h3><p>éœ€è¦å•ç‹¬åˆ’åˆ†å‡ºä¸€ä¸ªèŠ‚ç‚¹ç”¨æˆ·éƒ¨ç½² nginx å’Œé•œåƒä»“åº“æœåŠ¡ï¼Œå¹¶åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œ kubespray æ¥éƒ¨ç½² K8s é›†ç¾¤ã€‚å¤§è‡´æµç¨‹çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">deploy_compose</span></span>()&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="variable">$&#123;ID&#125;</span> <span class="keyword">in</span></span><br><span class="line">    Debian|debian)</span><br><span class="line">      system::debian::config_repo</span><br><span class="line">      ;;</span><br><span class="line">    CentOS|centos)</span><br><span class="line">      system::centos::disable_selinux</span><br><span class="line">      system::centos::config_repo</span><br><span class="line">      ;;</span><br><span class="line">    Ubuntu|ubuntu)</span><br><span class="line">      system::ubuntu::config_repo</span><br><span class="line">      ;;</span><br><span class="line">    *)</span><br><span class="line">      errorlog <span class="string">"Not support system: <span class="variable">$&#123;ID&#125;</span>"</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">      ;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line">  system::disable_firewalld</span><br><span class="line">  system::install_pkgs</span><br><span class="line">  common::install_tools</span><br><span class="line">  common::rudder_config</span><br><span class="line">  common::update_hosts</span><br><span class="line">  common::generate_domain_certs</span><br><span class="line">  common::load_images</span><br><span class="line">  common::compose_up</span><br><span class="line">  common::health_check</span><br><span class="line">  system::install_chrony</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">main</span></span>()&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="variable">$&#123;INSTALL_TYPE&#125;</span> <span class="keyword">in</span></span><br><span class="line">    all)</span><br><span class="line">      deploy_compose</span><br><span class="line">      common::push_kubespray_image</span><br><span class="line">      common::run_kubespray <span class="string">"bash /kubespray/run.sh deploy-cluster"</span></span><br><span class="line">      ;;</span><br><span class="line">    *)</span><br><span class="line">      echowarn <span class="string">"unknow [TYPE] parameter: <span class="variable">$&#123;INSTALL_TYPE&#125;</span>"</span></span><br><span class="line">      common::usage</span><br><span class="line">      ;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆåˆå§‹åŒ–èŠ‚ç‚¹ï¼Œå…³é—­é˜²ç«å¢™å’Œ <code>SELinux</code></li><li>é…ç½®éƒ¨ç½²èŠ‚ç‚¹ yum/apt ç¦»çº¿æº</li><li>å®‰è£…ä¸€äº›éƒ¨ç½²ä¾èµ–åŒ…ï¼Œå¦‚ chronyã€ libseccomp  ç­‰</li><li>å®‰è£…ä¸€äº›å·¥å…·å¦‚ yq, skopeo, kubectl ç­‰</li><li>å®‰è£… nerdctl-full (containerd)</li><li>ä½¿ç”¨ nerdctl load -i çš„æ–¹å¼å¯¼å…¥ nginx, registry, kubespray é•œåƒ</li><li>ä½¿ç”¨ yq æ¸²æŸ“é…ç½®æ–‡ä»¶ï¼Œç”Ÿæˆ kubespray éœ€è¦çš„ env æ–‡ä»¶å’Œ inventory æ–‡ä»¶</li><li>ç”Ÿæˆé•œåƒä»“åº“åŸŸåè¯ä¹¦å¹¶å°†è‡ªç­¾è¯ä¹¦æ·»åŠ åˆ°ä¸»æœºçš„ CA trust ä¿¡ä»»å½“ä¸­</li><li>åœ¨ <code>/etc/hosts</code> ä¸­æ·»åŠ é•œåƒä»“åº“åŸŸå hosts æ˜ å°„</li><li>ä½¿ç”¨ nerdctl compose å¯åŠ¨ nginx å’Œ registry æœåŠ¡</li><li>éƒ¨ç½²æ—¶é’ŸåŒæ­¥æœåŠ¡ chrony</li><li>æ£€æŸ¥å„ä¸ªæœåŠ¡çš„çŠ¶æ€</li><li>æœ€åä½¿ç”¨ nerdctl run å¯åŠ¨ kubespray å®¹å™¨æ¥éƒ¨ç½² k8s é›†ç¾¤</li></ul><h3 id="kubespray-3"><a href="#kubespray-3" class="headerlink" title="kubespray"></a>kubespray</h3><p>éƒ¨ç½²çš„æµç¨‹ä¸ŠåŸºæœ¬ä¸Šå’Œ kubespray å®˜æ–¹å¤§ä½“ä¸€è‡´ï¼Œåªä¸è¿‡æˆ‘ä»¬å¼•å…¥é‡Œåˆ†å±‚éƒ¨ç½²çš„ç‰¹æ€§</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">deploy_cluster</span></span>()&#123;</span><br><span class="line">  touch <span class="variable">$&#123;INSTALL_STEPS_FILE&#125;</span></span><br><span class="line">  STEPS=<span class="string">"00-default-ssh-config 01-cluster-bootstrap-os 02-cluster-etcd 03-cluster-kubernetes 04-cluster-network 05-cluster-apps"</span></span><br><span class="line">  <span class="keyword">for</span> step <span class="keyword">in</span> <span class="variable">$&#123;STEPS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> ! grep -q <span class="string">"<span class="variable">$&#123;step&#125;</span>"</span> <span class="variable">$&#123;INSTALL_STEPS_FILE&#125;</span>; <span class="keyword">then</span></span><br><span class="line">      infolog <span class="string">"start deploy <span class="variable">$&#123;step&#125;</span>"</span></span><br><span class="line">      <span class="keyword">if</span> ansible-playbook <span class="variable">$&#123;ANSIBLE_ARGS&#125;</span> <span class="variable">$&#123;KUBE_ROOT&#125;</span>/playbooks/<span class="variable">$&#123;step&#125;</span>.yml; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$&#123;step&#125;</span> &gt;&gt; <span class="variable">$&#123;INSTALL_STEPS_FILE&#125;</span></span><br><span class="line">        infolog <span class="string">"<span class="variable">$&#123;step&#125;</span> successfully installed"</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        errorlog <span class="string">"<span class="variable">$&#123;step&#125;</span> installation failed"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      warnlog <span class="string">"<span class="variable">$&#123;step&#125;</span> is already installed, so skipped..."</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é…ç½®å ¡å’æœº ssh ç™»å½•ï¼ˆå¯é€‰ï¼‰</li><li>é…ç½®èŠ‚ç‚¹ yum/apt æºä¸º nginx æœåŠ¡æä¾›çš„æº</li><li>å°†è‡ªç­¾çš„åŸŸåè¯ä¹¦æ·»åŠ åˆ°ä¸»æœºçš„ CA trust ä¿¡ä»»å½“ä¸­</li><li>åœ¨ <code>/etc/hosts</code> ä¸­æ·»åŠ é•œåƒä»“åº“åŸŸå hosts æ˜ å°„</li><li>å…³é—­é˜²ç«å¢™ï¼Œå®‰è£…æ—¶é’ŸåŒæ­¥æœåŠ¡ï¼Œè¿›è¡ŒåŒæ­¥æ—¶é’Ÿ</li><li>åˆå§‹åŒ–é›†ç¾¤èŠ‚ç‚¹ï¼Œå®‰è£…éƒ¨ç½²ä¾èµ–</li><li>å®‰è£…å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸‹è½½æ–‡ä»¶å’Œç»„ä»¶é•œåƒ</li><li>éƒ¨ç½² etcd é›†ç¾¤</li><li>éƒ¨ç½² K8s é›†ç¾¤</li><li>éƒ¨ç½² CNI æ’ä»¶</li><li>å®‰è£…ä¸€äº›é¢å¤–çš„ addon ç»„ä»¶å¦‚ (coredns)</li></ul><p>è‡³æ­¤æ•´ä¸ªæ‰“åŒ…å’Œéƒ¨ç½²æµç¨‹å°±å®Œæ¯•äº†ï¼Œä¸‹é¢å†è®²å‡ ä¸ªæ‰“åŒ…/éƒ¨ç½²å¸¸è§çš„é—®é¢˜</p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="kubeadm-è¯ä¹¦"><a href="#kubeadm-è¯ä¹¦" class="headerlink" title="kubeadm è¯ä¹¦"></a>kubeadm è¯ä¹¦</h3><p>é€šè¿‡ä¿®æ”¹ kubeadm æºç çš„æ–¹å¼å°†è¯ä¹¦ç»­å‘½åˆ° 10 å¹´ï¼Œå¼€å¯ <code>kubeadm_patch_enabled</code> å‚æ•°éƒ¨ç½²æ—¶å°±å°† kubeadm æ›¿æ¢ä¸ºä¿®æ”¹åçš„ kubeadmã€‚å…³äº kubeadm çš„ä¿®æ”¹å’Œæ„å»ºå’Œå‚è€ƒæˆ‘ä¹‹å‰å†™è¿‡çš„ã€Š<a href="https://blog.k8s.li/build-k8s-binary-by-github-actions.html">ä½¿ç”¨ GitHub Actions ç¼–è¯‘ kubernetes ç»„ä»¶</a>ã€‹ã€‚</p><ul><li><a href="https://github.com/k8sli/kubespray/blob/main/roles/cluster/download/tasks/main.yml" target="_blank" rel="noopener">roles/cluster/download/tasks/main.yml</a></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Relpace</span> <span class="string">kubeadm</span> <span class="string">binary</span> <span class="string">file</span> <span class="string">as</span> <span class="string">patched</span> <span class="string">version</span></span><br><span class="line">  <span class="attr">get_url:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">"<span class="template-variable">&#123;&#123; patched_kubeadm_download_url &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">"<span class="template-variable">&#123;&#123; bin_dir &#125;&#125;</span>/kubeadm"</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0755</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubeadm</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">kubeadm_patch_enabled</span> <span class="string">|</span> <span class="string">default(true)</span> <span class="string">|</span> <span class="string">bool</span></span><br></pre></td></tr></table></figure><h3 id="é•œåƒç¼“å­˜"><a href="#é•œåƒç¼“å­˜" class="headerlink" title="é•œåƒç¼“å­˜"></a>é•œåƒç¼“å­˜</h3><p>os-packages, kubespray-base, kubespray-files, kubespray-images è¿™å››ä¸ªé•œåƒåœ¨æ„å»ºçš„æ—¶å€™éƒ½ä¼šé‡‡ç”¨ md5 å€¼çš„æ–¹å¼æ ¡éªŒæ˜¯å¦éœ€è¦é‡æ–°æ„å»ºé•œåƒï¼Œè¿™æ ·èƒ½å¤Ÿå¤§å¤§æå‡ CI çš„æ‰§è¡Œæ•ˆç‡ï¼Œä¸‹é¢ä»¥ kubespray-base è¿™ä¸ªé•œåƒä¸ºä¾‹ä»‹ç»å…¶åŸç†å’Œå®ç°ï¼š</p><ul><li>åœ¨æ„å»ºé•œåƒå‰ä¼šæœ‰ä¸€ä¸ª md5 è®¡ç®—å’Œæ ¡éªŒçš„æ­¥éª¤ï¼Œå°†ä¸è¯¥é•œåƒç´§å¯†ç›¸å…³çš„æ–‡ä»¶å†…å®¹è¿›è¡Œæ±‡æ€»å¹¶ç”Ÿæˆ md5 å€¼ï¼Œå¹¶å°†è¿™ä¸ªå€¼å¾—ä»¥ label çš„æ–¹å¼ä¿å­˜åœ¨é•œåƒçš„å…ƒæ•°æ®ä¿¡æ¯å½“ä¸­ã€‚å¦‚æœè¯¥å€¼ä¸ä¸Šä¸ªæœ€æ–°çš„é•œåƒä¸­çš„ md5 å€¼ç›¸ç­‰ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦é‡æ–°æ„å»ºè¯¥é•œåƒï¼Œåªéœ€è¦è¿›è¡Œ retag å³å¯ã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prepare</span> <span class="string">for</span> <span class="string">build</span> <span class="string">images</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">git</span> <span class="string">describe</span> <span class="string">--tags</span> <span class="string">--always</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/IMAGE_TAG=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">git</span> <span class="string">branch</span> <span class="string">--show-current</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/BRANCH_NAME=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">git</span> <span class="string">branch</span> <span class="string">--show-current</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/master/latest/;s/main/latest/;s/^/IMAGE_TAG_BY_BRANCH=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">sed</span> <span class="string">-n</span> <span class="string">'s/^kube_version: /KUBE_VERSION=/p'</span> <span class="string">roles/kubespray-defaults/defaults/main.yaml</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">cat</span> <span class="string">build/kubespray-base/Dockerfile</span> <span class="string">requirements.txt</span> <span class="string">tests/requirements.txt</span> <span class="string">.github/workflows/build.yaml</span> <span class="string">\</span></span><br><span class="line">    <span class="string">|</span> <span class="string">md5sum</span> <span class="string">|</span> <span class="string">tr</span> <span class="string">-d</span> <span class="string">'\ -'</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/BASE_MD5=md5-/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line"></span><br><span class="line">    <span class="string">source</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">if</span> <span class="string">skopeo</span> <span class="string">inspect</span> <span class="string">docker://$&#123;BASE_IMAGE_REPO&#125;:$&#123;BRANCH_NAME&#125;</span> <span class="string">&gt;</span> <span class="string">mainfest.json;</span> <span class="string">then</span></span><br><span class="line">      <span class="string">jq</span> <span class="string">-r</span> <span class="string">'.Labels.BASE_MD5'</span> <span class="string">mainfest.json</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/LATEST_BASE_MD5=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">else</span></span><br><span class="line">      <span class="string">echo</span> <span class="string">'LATEST_BASE_MD5=null'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">fi</span></span><br></pre></td></tr></table></figure><ul><li>å¦‚æœå½“å‰ md5 çš„å€¼ä¸æœ€æ–°çš„ md5 å€¼ç›¸ç­‰ï¼Œå°±é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„ Dockerfile æ¥è¿›è¡Œé•œåƒ retag çš„æ“ä½œã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Replace</span> <span class="string">Dockerfile</span> <span class="string">if</span> <span class="string">MD5</span> <span class="string">not</span> <span class="string">update</span></span><br><span class="line">  <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.BASE_MD5</span> <span class="string">==</span> <span class="string">env.LATEST_BASE_MD5</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">echo</span> <span class="string">"FROM $<span class="template-variable">&#123;&#123; env.BASE_IMAGE_REPO &#125;&#125;</span>:$<span class="template-variable">&#123;&#123; env.BASE_MD5 &#125;&#125;</span>"</span> <span class="string">&gt;</span> <span class="string">build/kubespray-base/Dockerfile</span></span><br></pre></td></tr></table></figure><ul><li>æ„å»ºé•œåƒå¹¶å°† md5 å€¼ä½œä¸º labels å¡«å……åˆ°é•œåƒçš„å…ƒæ•°æ®ä¿¡æ¯å½“ä¸­ã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span> <span class="string">kubespray-base</span> <span class="string">images</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">docker/build-push-action@v2</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">push:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event_name</span> <span class="string">!=</span> <span class="string">'pull_request'</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">build/kubespray-base/Dockerfile</span></span><br><span class="line">    <span class="attr">platforms:</span> <span class="string">linux/amd64,linux/arm64</span></span><br><span class="line">    <span class="attr">cache-from:</span> <span class="string">type=local,src=/tmp/.buildx-cache</span></span><br><span class="line">    <span class="attr">cache-to:</span> <span class="string">type=local,dest=/tmp/.buildx-cache-new</span></span><br><span class="line">    <span class="attr">build-args:</span> <span class="string">KUBE_VERSION=$&#123;&#123;</span> <span class="string">env.KUBE_VERSION</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">labels:</span> <span class="string">BASE_MD5=$&#123;&#123;</span> <span class="string">env.BASE_MD5</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">$&#123;&#123;</span> <span class="string">env.BASE_IMAGE_REPO</span> <span class="string">&#125;&#125;:$&#123;&#123;</span> <span class="string">env.IMAGE_TAG</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">$&#123;&#123;</span> <span class="string">env.BASE_IMAGE_REPO</span> <span class="string">&#125;&#125;:$&#123;&#123;</span> <span class="string">env.BASE_MD5</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">$&#123;&#123;</span> <span class="string">env.BASE_IMAGE_REPO</span> <span class="string">&#125;&#125;:$&#123;&#123;</span> <span class="string">env.BRANCH_NAME</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">$&#123;&#123;</span> <span class="string">env.BASE_IMAGE_REPO</span> <span class="string">&#125;&#125;:$&#123;&#123;</span> <span class="string">env.IMAGE_TAG_BY_BRANCH</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ç§æ–¹å¼çš„å¥½å¤„å°±åœ¨äºåœ¨ä¸éœ€è¦æ„å»ºé•œåƒçš„æ—¶å€™èƒ½å¤§å¹…åº¦æå‡ CI çš„è¿è¡Œæ•ˆç‡ã€‚</p><h2 id="æ¨èé˜…è¯»"><a href="#æ¨èé˜…è¯»" class="headerlink" title="æ¨èé˜…è¯»"></a>æ¨èé˜…è¯»</h2><ul><li><a href="https://blog.k8s.li/pass-platform-release.html">äº‘åŸç”Ÿ PaaS äº§å“å‘å¸ƒ&amp;éƒ¨ç½²æ–¹æ¡ˆ</a></li><li><a href="https://mp.weixin.qq.com/s/7hKkdBUXHFZt5q3KbpmU6Q" target="_blank" rel="noopener">æ”¿é‡‡äº‘åŸºäº sealer çš„ç§æœ‰åŒ–ä¸šåŠ¡äº¤ä»˜å®è·µ</a></li><li><a href="https://blog.k8s.li/make-offline-mirrors.html">ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</a></li><li><a href="https://blog.k8s.li/deploy-k8s-by-kubespray.html">ä½¿ç”¨ Kubespray æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤</a></li><li><a href="https://blog.k8s.li/select-registry-images.html">ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼</a></li><li><a href="https://blog.k8s.li/skopeo-to-registry.html">å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;åœ¨ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒå½“ä¸­ï¼Œå‡ºäºå¯¹æ•°æ®å®‰å…¨çš„è€ƒè™‘ä»¥åŠæ»¡è¶³ &lt;a
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubernetes" scheme="https://blog.k8s.li/tags/kubernetes/"/>
    
      <category term="k8s" scheme="https://blog.k8s.li/tags/k8s/"/>
    
      <category term="PaaS" scheme="https://blog.k8s.li/tags/PaaS/"/>
    
      <category term="toB" scheme="https://blog.k8s.li/tags/toB/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ GitHub Actions ç¼–è¯‘ kubernetes ç»„ä»¶</title>
    <link href="https://blog.k8s.li/build-k8s-binary-by-github-actions.html"/>
    <id>https://blog.k8s.li/build-k8s-binary-by-github-actions.html</id>
    <published>2021-08-25T16:00:00.000Z</published>
    <updated>2021-08-25T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä½¿ç”¨ kubernetes è¿‡ç¨‹ä¸­ç”±äºæŸäº›éœ€æ±‚å¾€å¾€è¦ä¿®æ”¹ä¸€ä¸‹ k8s å®˜æ–¹çš„æºç ï¼Œç„¶åé‡æ–°ç¼–è¯‘æ‰è¡Œã€‚æœ¬æ–‡å°±ä»¥ä¿®æ”¹ kubeadm ç”Ÿæˆè¯ä¹¦ä¸ºé»˜è®¤ 10 å¹´ä¸ºä¾‹ï¼Œæ¥è®²è§£å¦‚ä½•ä½¿ç”¨ GitHub Actions æ¥ç¼–è¯‘å’Œå‘å¸ƒç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><h2 id="æ„å»º"><a href="#æ„å»º" class="headerlink" title="æ„å»º"></a>æ„å»º</h2><h3 id="clone-repo"><a href="#clone-repo" class="headerlink" title="clone repo"></a>clone repo</h3><p>å°† kubernetes å®˜æ–¹æºç  fork åˆ°è‡ªå·±çš„ repo ä¸­</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/k8sli/kubernetes.git</span><br><span class="line">$ <span class="built_in">cd</span> kubernetes</span><br><span class="line">$ git remote add upstream https://github.com/kubernetes/kubernetes.git</span><br><span class="line">$ git fetch --all</span><br><span class="line">$ git checkout upstream/release-1.21</span><br><span class="line">$ git checkout -B kubeadm-1.21</span><br></pre></td></tr></table></figure><h3 id="workflow"><a href="#workflow" class="headerlink" title="workflow"></a>workflow</h3><ul><li><code>.github/workflows/kubeadm.yaml</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Build</span> <span class="string">kubeadm</span> <span class="string">binary</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">tag:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'v*'</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-20.04</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä»¥ tag çš„æ–¹å¼æƒ©è§¦å‘ job çš„è¿è¡Œ</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">startsWith(github.ref,</span> <span class="string">'refs/tags/'</span><span class="string">)</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">kubeadm</span> <span class="string">binary</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="comment"># è¿è¡Œ build/run.sh æ„å»ºè„šæœ¬æ¥ç¼–è¯‘ç›¸åº”å¹³å°ä¸Šçš„äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">          <span class="string">build/run.sh</span> <span class="string">make</span> <span class="string">kubeadm</span> <span class="string">KUBE_BUILD_PLATFORMS=linux/amd64</span></span><br><span class="line">          <span class="string">build/run.sh</span> <span class="string">make</span> <span class="string">kubeadm</span> <span class="string">KUBE_BUILD_PLATFORMS=linux/arm64</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># æ„å»ºå¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶å­˜æ”¾åœ¨ _output/dockerized/bin/ ä¸­</span></span><br><span class="line">      <span class="comment"># æˆ‘ä»¬æ ¹æ®äºŒè¿›åˆ¶ç›®æ ‡æ–‡ä»¶çš„ç³»ç»Ÿåç§°+CPUä½“ç³»æ¶æ„åç§°è¿›è¡Œå‘½å</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prepare</span> <span class="string">for</span> <span class="string">upload</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">mv</span> <span class="string">_output/dockerized/bin/linux/amd64/kubeadm</span> <span class="string">kubeadm-linux-amd64</span></span><br><span class="line">          <span class="string">mv</span> <span class="string">_output/dockerized/bin/linux/arm64/kubeadm</span> <span class="string">kubeadm-linux-arm64</span></span><br><span class="line">          <span class="string">sha256sum</span> <span class="string">kubeadm-linux-&#123;amd64,arm64&#125;</span> <span class="string">&gt;</span> <span class="string">sha256sum.txt</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># ä½¿ç”¨ softprops/action-gh-release æ¥å°†æ„å»ºäº§ç‰©ä¸Šä¼ åˆ° GitHub release å½“ä¸­</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span> <span class="string">and</span> <span class="string">upload</span> <span class="string">packages</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">softprops/action-gh-release@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">files:</span> <span class="string">|</span></span><br><span class="line">            <span class="string">sha256sum.txt</span></span><br><span class="line">            <span class="string">kubeadm-linux-amd64</span></span><br><span class="line">            <span class="string">kubeadm-linux-arm64</span></span><br></pre></td></tr></table></figure><ul><li><code>build/run.sh</code></li></ul><blockquote><p>: Run a command in a build docker container. Common invocations:</p><ul><li><code>build/run.sh make</code>: Build just linux binaries in the container. Pass options and packages as necessary.</li><li><code>build/run.sh make cross</code>: Build all binaries for all platforms. To build only a specific platform, add <code>KUBE_BUILD_PLATFORMS=&lt;os&gt;/&lt;arch&gt;</code></li><li><code>build/run.sh make kubectl KUBE_BUILD_PLATFORMS=darwin/amd64</code>: Build the specific binary for the specific platform (<code>kubectl</code> and <code>darwin/amd64</code> respectively in this example)</li><li><code>build/run.sh make test</code>: Run all unit tests</li><li><code>build/run.sh make test-integration</code>: Run integration test</li><li><code>build/run.sh make test-cmd</code>: Run CLI tests</li></ul></blockquote><h3 id="ä¿®æ”¹æºç "><a href="#ä¿®æ”¹æºç " class="headerlink" title="ä¿®æ”¹æºç "></a>ä¿®æ”¹æºç </h3><ul><li><code>cmd/kubeadm/app/constants/constants.go</code></li></ul><p>æ‰¾åˆ° <code>CertificateValidity</code> å˜é‡å°†å®ƒåœ¨ 375 å¤©åé¢åŠ ä¸ª 0ï¼Œå°±å°†è¯ä¹¦ç»­å‘½ä¸º 10 å¹´äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// CertificateValidity defines the validity for all the signed certificates generated by kubeadm</span></span><br><span class="line">-CertificateValidity = time.Hour * <span class="number">24</span> * <span class="number">365</span></span><br><span class="line">+CertificateValidity = time.Hour * <span class="number">24</span> * <span class="number">3650</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// CACertAndKeyBaseName defines certificate authority base name</span></span><br><span class="line"> CACertAndKeyBaseName = <span class="string">"ca"</span></span><br></pre></td></tr></table></figure><ul><li><code>git diff</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/.github/workflows/kubeadm.yaml b/.github/workflows/kubeadm.yaml</span><br><span class="line">new file mode 100644</span><br><span class="line">index 00000000000..376f37c0edf</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/.github/workflows/kubeadm.yaml</span><br><span class="line">@@ -0,0 +1,37 @@</span><br><span class="line">+---</span><br><span class="line">+name: Build kubeadm binary image</span><br><span class="line">+</span><br><span class="line">+on:</span><br><span class="line">+  push:</span><br><span class="line">+    tag:</span><br><span class="line">+      - <span class="string">'v*'</span></span><br><span class="line">+<span class="built_in">jobs</span>:</span><br><span class="line">+  build:</span><br><span class="line">+    runs-on: ubuntu-20.04</span><br><span class="line">+    <span class="keyword">if</span>: startsWith(github.ref, <span class="string">'refs/tags/'</span>)</span><br><span class="line">+    steps:</span><br><span class="line">+      - name: Checkout</span><br><span class="line">+        uses: actions/checkout@v2</span><br><span class="line">+</span><br><span class="line">+      - name: Build kubeadm binary</span><br><span class="line">+        shell: bash</span><br><span class="line">+        run: |</span><br><span class="line">+          build/run.sh make kubeadm KUBE_BUILD_PLATFORMS=linux/amd64</span><br><span class="line">+          build/run.sh make kubeadm KUBE_BUILD_PLATFORMS=linux/arm64</span><br><span class="line">+</span><br><span class="line">+      - name: Prepare <span class="keyword">for</span> upload</span><br><span class="line">+        shell: bash</span><br><span class="line">+        run: |</span><br><span class="line">+          mv _output/dockerized/bin/linux/amd64/kubeadm kubeadm-linux-amd64</span><br><span class="line">+          mv _output/dockerized/bin/linux/arm64/kubeadm kubeadm-linux-arm64</span><br><span class="line">+          sha256sum kubeadm-linux-&#123;amd64,arm64&#125; &gt; sha256sum.txt</span><br><span class="line">+</span><br><span class="line">+      - name: Release and upload packages</span><br><span class="line">+        uses: softprops/action-gh-release@v1</span><br><span class="line">+        env:</span><br><span class="line">+          GITHUB_TOKEN: <span class="variable">$&#123;&#123; secrets.GITHUB_TOKEN &#125;</span>&#125;</span><br><span class="line">+        with:</span><br><span class="line">+          files: |</span><br><span class="line">+            sha256sum.txt</span><br><span class="line">+            kubeadm-linux-amd64</span><br><span class="line">+            kubeadm-linux-arm64</span><br><span class="line">diff --git a/cmd/kubeadm/app/constants/constants.go b/cmd/kubeadm/app/constants/constants.go</span><br><span class="line">index aed3a713020..08a24d237f8 100644</span><br><span class="line">--- a/cmd/kubeadm/app/constants/constants.go</span><br><span class="line">+++ b/cmd/kubeadm/app/constants/constants.go</span><br><span class="line">@@ -46,7 +46,7 @@ const (</span><br><span class="line"> TempDirForKubeadm = <span class="string">"tmp"</span></span><br><span class="line"></span><br><span class="line"> // CertificateValidity defines the validity <span class="keyword">for</span> all the signed certificates generated by kubeadm</span><br><span class="line">-CertificateValidity = time.Hour * 24 * 365</span><br><span class="line">+CertificateValidity = time.Hour * 24 * 3650</span><br><span class="line"></span><br><span class="line"> // CACertAndKeyBaseName defines certificate authority base name</span><br><span class="line"> CACertAndKeyBaseName = <span class="string">"ca"</span></span><br></pre></td></tr></table></figure><h3 id="cherry-pick"><a href="#cherry-pick" class="headerlink" title="cherry-pick"></a>cherry-pick</h3><p>åœ¨åˆ†æ”¯ä¸Šå®Œæˆä¿®æ”¹ä¹‹åï¼Œæˆ‘ä»¬å°†è¿™ä¸ªä¿®æ”¹ cherry-pick åˆ°å…¶ä»–çš„ tag ä¸Šé¢å»ï¼Œä¸‹é¢ä»¥ v1.21.4 ä¸ºä¾‹å­ï¼šåœ¨ v1.21.4 tag çš„åŸºç¡€ä¹‹ä¸Šå°†ä¸Šè¿°çš„ä¿®æ”¹ cherry-pick è¿‡æ¥ï¼Œé‡æ–°æ‰“ä¸Šæ–°çš„ tagã€‚</p><ul><li>è·å–ä¸Šè¿°ä¿®æ”¹çš„ commit id</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ COMMIT_ID=$(git rev-parse HEAD)</span><br></pre></td></tr></table></figure><ul><li>checkout åˆ° v1.21.4 è¿™ä¸ª tag ä¸Š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout v1.21.4</span><br><span class="line">Note: checking out <span class="string">'v1.21.4'</span>.</span><br><span class="line"></span><br><span class="line">You are <span class="keyword">in</span> <span class="string">'detached HEAD'</span> state. You can look around, make experimental</span><br><span class="line">changes and commit them, and you can discard any commits you make <span class="keyword">in</span> this</span><br><span class="line">state without impacting any branches by performing another checkout.</span><br><span class="line"></span><br><span class="line">If you want to create a new branch to retain commits you create, you may</span><br><span class="line"><span class="keyword">do</span> so (now or later) by using -b with the checkout <span class="built_in">command</span> again. Example:</span><br><span class="line"></span><br><span class="line">HEAD is now at 3cce4a82b44 Release commit <span class="keyword">for</span> Kubernetes v1.21.4</span><br></pre></td></tr></table></figure><ul><li>å°†ä¿®æ”¹ cherry-pick åˆ°å½“å‰ tag ä¸Š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git cherry-pick <span class="variable">$COMMIT_ID</span></span><br><span class="line">[detached HEAD baadbe03458] Update kubeadm CertificateValidity time to ten years</span><br><span class="line"> Date: Tue Aug 24 16:32:49 2021 +0800</span><br><span class="line"> 2 files changed, 38 insertions(+), 1 deletion(-)</span><br><span class="line"> create mode 100644 .github/workflows/kubeadm.yaml</span><br></pre></td></tr></table></figure><ul><li>é‡æ–°æ‰“ä¸Šæ–°çš„ tagï¼Œå¦‚ <code>v1.21.4-patch-1.0</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git tag v1.21.4-patch-1.0 -f</span><br><span class="line">Updated tag <span class="string">'v1.21.4-patch-1.0'</span> (was 70bcbd6de6c)</span><br></pre></td></tr></table></figure><p><img src="https://p.k8s.li/2021-08-25-build-k8s-binary-by-github-actions-1.png" alt="image-20210826020226785"></p><ul><li>å°† tag push åˆ° repo ä¸­è§¦å‘ workflow</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ git push origin --tags -f</span><br><span class="line">Enumerating objects: 17, <span class="keyword">done</span>.</span><br><span class="line">Counting objects: 100% (17/17), <span class="keyword">done</span>.</span><br><span class="line">Delta compression using up to 4 threads</span><br><span class="line">Compressing objects: 100% (9/9), <span class="keyword">done</span>.</span><br><span class="line">Writing objects: 100% (10/10), 1.13 KiB | 192.00 KiB/s, <span class="keyword">done</span>.</span><br><span class="line">Total 10 (delta 7), reused 0 (delta 0)</span><br><span class="line">remote: Resolving deltas: 100% (7/7), completed with 7 <span class="built_in">local</span> objects.</span><br><span class="line">To github.com:k8sli/kubernetes.git</span><br><span class="line"> + c2a633e07ec...baadbe03458 v1.21.4-patch-1.0 -&gt; v1.21.4-patch-1.0 (forced update)</span><br></pre></td></tr></table></figure><p><img src="https://p.k8s.li/2021-08-25-build-k8s-binary-by-github-actions-2.png" alt="image-20210826020837194"></p><ul><li>æ•´ä¸ªæ„å»ºè¿‡ç¨‹å¤§æ¦‚éœ€è¦ 7 åˆ†é’Ÿå·¦å³ï¼Œæ•ˆç‡è¿˜æ˜¯è›®é«˜çš„ã€‚</li></ul><p><img src="https://p.k8s.li/2021-08-25-build-k8s-binary-by-github-actions-3.png" alt="image-20210826021451447"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸Šé¢åªå±•ç¤ºäº†ä»¥ä¸€ä¸ª tag ä¸ºå•ä½è¿›è¡Œæ„å»ºçš„æµç¨‹ï¼Œæƒ³è¦æ„å»ºå…¶ä»–ç‰ˆæœ¬çš„ kubeadm ï¼Œå¯ä»¥æŒ‰ç…§åŒæ ·çš„æµç¨‹å’Œæ–¹æ³•æ¥å®Œæˆã€‚å…¶å®å†™ä¸€ä¸ª shell è„šæœ¬æ¥å¤„ç†ä¹Ÿæ˜¯ååˆ†ç®€å•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -o errexit</span><br><span class="line"><span class="built_in">set</span> -o nounset</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ commit ID</span></span><br><span class="line">: <span class="variable">$&#123;COMMIT:="48e4b4c7c62a84ab4ec363588721011b73ee77e6"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰éœ€è¦é‡æ–°ç¼–è¯‘çš„ç‰ˆæœ¬å·</span></span><br><span class="line">: <span class="variable">$&#123;TAGS:="v1.22.1 v1.22.0 v1.21.4 v1.21.3 v1.20.10 v1.19.14 v1.18.10"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> tag <span class="keyword">in</span> <span class="variable">$&#123;TAGS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    git reset --hard <span class="variable">$&#123;tag&#125;</span></span><br><span class="line">    git cherry-pick <span class="variable">$&#123;COMMIT&#125;</span></span><br><span class="line">    git tag <span class="variable">$&#123;tag&#125;</span>-patch-1.0</span><br><span class="line">    git push origin <span class="variable">$&#123;tag&#125;</span>-patch-1.0</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p><img src="https://p.k8s.li/2021-08-25-build-k8s-binary-by-github-actions-5.png" alt="image-20210827021756974"></p><p>ä½¿ç”¨ GitHub Actions çš„å¥½å¤„å°±æ˜¯èƒ½å¤Ÿä¸ºæˆ‘ä»¬è§£å†³ä»£ç ç®¡ç†å’Œäº§ç‰©ç®¡ç†ï¼Œæ„å»ºå¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶å­˜æ”¾åœ¨ GitHub release å½“ä¸­ï¼Œä¸‹è½½å’Œä½¿ç”¨èµ·æ¥ååˆ†æ–¹ä¾¿ï¼Œä¸ç”¨åœ¨è‡ªå·±æä¸€å°å•ç‹¬çš„æœºå™¨æˆ–è€…å­˜å‚¨æœåŠ¡å™¨ï¼ŒèŠ‚çœå¾ˆå¤šäººåŠ›ç»´æŠ¤æˆæœ¬ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;åœ¨ä½¿ç”¨ kubernetes
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="k8s" scheme="https://blog.k8s.li/tags/k8s/"/>
    
      <category term="GitHub" scheme="https://blog.k8s.li/tags/GitHub/"/>
    
  </entry>
  
</feed>
