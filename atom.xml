<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>æœ¨å­</title>
  <icon>https://blog.k8s.li/icon.png</icon>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.k8s.li/"/>
  <updated>2021-07-10T16:00:00.000Z</updated>
  <id>https://blog.k8s.li/</id>
  
  <author>
    <name>æœ¨å­</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>é•œåƒæ¬è¿å·¥ skopeo æœ€ä½³å®è·µ</title>
    <link href="https://blog.k8s.li/skopeo.html"/>
    <id>https://blog.k8s.li/skopeo.html</id>
    <published>2021-07-10T16:00:00.000Z</published>
    <updated>2021-07-10T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¬ç –å·¥å…·"><a href="#æ¬ç –å·¥å…·" class="headerlink" title="æ¬ç –å·¥å…·"></a>æ¬ç –å·¥å…·</h2><p>ä½œä¸ºå…¬å¸å†…éƒ¨ PaaS toB äº§å“çš„æ‰“åŒ…å‘å¸ƒäººå‘˜ï¼Œå®¹å™¨é•œåƒå¯¹æˆ‘ä»¬æ‰“å·¥äººè€Œè¨€å°±åƒæ˜¯å·¥åœ°ä¸Šçš„ç –å¤´ ğŸ§±ï¼Œè€Œæˆ‘çš„ä¸€éƒ¨åˆ†å·¥ä½œå°±æ˜¯å°†è¿™äº›ç –å¤´åœ¨å„ä¸ªä»“åº“ä¹‹é—´æ¬æ¥æ¬å»ï¼Œæœ€ç»ˆå°†è¿™äº›ç –å¤´æ‰“åŒ…æ”¾åœ¨äº§å“çš„å®‰è£…åŒ…ä¸­ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„ PaaS äº§å“å®‰è£…åŒ…ã€‚</p><p>è€Œé€‰æ‹©ä¸€ä¸ªå¥½çš„æ¬ç –å·¥å…·èƒ½èŠ‚çœæˆ‘ä»¬å¤§é‡çš„äººåŠ›å’Œ CPU ç®—åŠ›ï¼Œåœ¨æ—¥å¸¸å¼€å‘å·¥ä½œä¸­æˆ‘ä»¬ä¹Ÿå¸¸å¸¸ä¼šä½¿ç”¨ docker push å’Œ docker pull æ¥æ¨æ‹‰é•œåƒï¼Œè™½ç„¶æœ¬åœ° push &amp;&amp; pull ä¸€ä¸ªé•œåƒå¹¶ä¸æ˜¯ä»€ä¹ˆéš¾äº‹å„¿ï¼Œä½†å¯¹äºä¸€äº›ç‰¹å®šçš„åœºæ™¯å¦‚äº§å“æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­ï¼Œè¿˜ç»§ç»­å†ä½¿ç”¨ docker è¿™ä¸ªç¬¨é‡çš„å·¥å…·æ¥æ¨æ‹‰é•œåƒçš„è¯ï¼Œæ˜¯ååˆ†è´¹æ—¶è´¹åŠ›çš„ï¼Œå…·ä½“çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„åšå®¢ã€Š<a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”ŸğŸ¤”</a>ã€‹ã€‚</p><p>è‡ªä» Kubernetes 1.20 ä¹‹åï¼ŒK8s ç¤¾åŒºä¹Ÿå¼ƒç”¨äº† Docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œdocker-shim ç›¸å…³çš„ä»£ç å°†åœ¨ kubelet ä¸­ä¸å†ç»´æŠ¤ï¼Œéšåæ€èµ·äº†ä¸€æ³¢å» docker çš„æµªæ½®ã€‚é‚£ä¹ˆç°åœ¨æœ‰æ²¡æœ‰ä¸€ç§èƒ½å¤Ÿæ›¿ä»£ docker-cli çš„å·¥å…·æ¥ä¼ è¾“é•œåƒå‘¢ï¼Ÿä»Šå¤©ç»™å¤§å®¶ä»‹ç»ä¸€ä¸ªèƒ½å¤Ÿå®Œå…¨æ›¿ä»£ docker-cli æ¥æ¬è¿é•œåƒçš„å·¥å…·ï¼šskopeoã€‚è¿™ç©æ„å„¿æ¯” docker-cli é«˜åˆ°ä¸çŸ¥é“å“ªé‡Œå»äº†ï¼</p><h2 id="å®‰è£…æ–¹å¼"><a href="#å®‰è£…æ–¹å¼" class="headerlink" title="å®‰è£…æ–¹å¼"></a>å®‰è£…æ–¹å¼</h2><p>å®˜æ–¹çš„å®‰è£…æ–¹å¼å‚è€ƒå®‰è£…æ–‡æ¡£å³å¯ <a href="https://github.com/containers/skopeo/blob/main/install.md" target="_blank" rel="noopener">https://github.com/containers/skopeo/blob/main/install.md</a></p><p>ç”±äºæˆ‘çš„ VPS æœºå™¨æ˜¯ Ubuntu 1804 çš„ OS ï¼Œé…ç½® apt æºå¹¶æ²¡æˆåŠŸï¼Œå½“åœºç¿»è½¦ã€‚åœ¨å®˜æ–¹çš„ Makefile é‡Œåªæä¾›äº†åœ¨ nixos ä¸‹æ„å»ºé™æ€è¿æ¥çš„æ–¹å¼ï¼Œå…¶ä»– Linux å‘ç›¸ç‰ˆåªèƒ½ä½¿ç”¨åŠ¨æ€é“¾æ¥çš„æ–¹å¼æ¥ç¼–è¯‘ã€‚ä½†åŠ¨æ€é“¾æ¥çš„æ–¹å¼é€šç”¨æ€§å¤ªå·®ï¼Œæ¯”å¦‚åœ¨ ubuntu 18.04 ä¸Šä½¿ç”¨åŠ¨æ€é“¾æ¥ç¼–è¯‘çš„ skopeo åªèƒ½åœ¨ ubuntu ä¸Šä½¿ç”¨ï¼Œæ— æ³•åœ¨ centos ä¸Šä½¿ç”¨ã€‚å› ä¸ºåŠ¨æ€é“¾æ¥ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶åœ¨ä¸åŒçš„ OS ä¸Šæ‰€ä¾èµ–çš„åº“æ–‡ä»¶æ˜¯ä¸ä¸€æ ·çš„ã€‚æ‰€ä»¥è¿˜æ˜¯å¦è¾Ÿè¹Šå¾„ï¼Œäº²è‡ªç¼–è¯‘ä¸€ä¸ªã€‚</p><ul><li>Clone repo</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ SKOPEO_VERSION=v1.3.0</span><br><span class="line">$ git <span class="built_in">clone</span> --branch <span class="variable">$&#123;SKOPEO_VERSION&#125;</span> https://github.com/containers/skopeo</span><br><span class="line">$ <span class="built_in">cd</span> skopeo</span><br></pre></td></tr></table></figure><ul><li>docker  build</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ BUILD_IMAGE=nixos/nix:2.3.12</span><br><span class="line">$ docker run --rm -t -v <span class="variable">$PWD</span>:/build <span class="variable">$&#123;BUILD_IMAGE&#125;</span> \</span><br><span class="line">sh -c <span class="string">"cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo"</span></span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <code>nixos/nix:2.3.12</code> æ¥æ„å»ºé™æ€é“¾æ¥çš„ skopeo äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦å®Œæ•´æ„å»º skopeo æ‰€æœ‰çš„ä¾èµ–ï¼Œæ¯”å¦‚ glibcã€systemdã€golang ç­‰ï¼Œæ‰€ä»¥æ„å»ºååˆ†è€—æ—¶ã€‚åœ¨ä¸€å° 4c8G çš„æœºå™¨ä¸Šæ„å»ºç”¨äº†å°†è¿‘åŠä¸ªå°æ—¶ï¼Œåœ¨ GitHub Action çš„ runner æœºå™¨ä¸Šæ„å»ºéœ€è¦å°†è¿‘<a href="https://github.com/k8sli/skopeo/actions/runs/1010266302" target="_blank" rel="noopener">ä¸€ä¸ªå°æ—¶</a>ã€‚</li></ul><p><img src="https://p.k8s.li/skopeo-github-action-build.png" alt="img"></p><ul><li>ä½¿ç”¨ GitHub Action æ„å»º</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">build</span> <span class="string">static</span> <span class="string">binary</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">push</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">BUILD_IMAGE:</span> <span class="string">"nixos/nix:2.3.12"</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">static</span> <span class="string">binary</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">docker</span> <span class="string">run</span> <span class="string">--rm</span> <span class="string">-t</span> <span class="string">-v</span> <span class="string">$PWD:/build</span> <span class="string">--name</span> <span class="string">builder</span> <span class="string">$&#123;BUILD_IMAGE&#125;</span> <span class="string">\</span></span><br><span class="line">          <span class="string">sh</span> <span class="string">-c</span> <span class="string">"cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo-linux-amd64"</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">softprops/action-gh-release@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">files:</span> <span class="string">skopeo-linux-amd64</span></span><br></pre></td></tr></table></figure><p>ä¸è¿‡ä¹Ÿå¯ä»¥ä½¿ç”¨ go build çš„æ–¹å¼æ„å»ºå‡ºé™æ€é“¾æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¦‚ä¸‹ <code>Dockerfile</code></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.14</span>-buster as skopeo-builder</span><br><span class="line"><span class="keyword">ARG</span> SKOPEO_VERSION=v1.<span class="number">2.0</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install -y -qq libdevmapper-dev libgpgme11-dev </span></span><br><span class="line"><span class="keyword">ENV</span> GOPATH=/</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /src/github.com/containers/skopeo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> git <span class="built_in">clone</span> --branch <span class="variable">$&#123;SKOPEO_VERSION&#125;</span> https://github.com/containers/skopeo . \</span></span><br><span class="line"><span class="bash"> &amp;&amp; CGO_ENABLE=0 GO111MODULE=on go build -mod=vendor <span class="string">"-buildmode=pie"</span> -ldflags <span class="string">'-extldflags "-static"'</span> -gcflags <span class="string">""</span> \</span></span><br><span class="line"><span class="bash"> -tags <span class="string">"exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp"</span> -o /usr/bin/skopeo ./cmd/skopeo</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.12</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=skopeo-builder /usr/bin/skopeo /usr/bin/skopeo</span></span><br><span class="line"><span class="comment"># FROM scratch</span></span><br><span class="line"><span class="comment"># COPY --from=skopeo-builder /usr/bin/skopeo /skopeo</span></span><br><span class="line"><span class="comment"># DOCKER_BUILDKIT=1 docker build -o type=local,dest=$PWD -f Dockerfile .</span></span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ GitHub Action æ¥ç¼–è¯‘</li></ul><h2 id="ä¸Šæ‰‹ä½“éªŒ"><a href="#ä¸Šæ‰‹ä½“éªŒ" class="headerlink" title="ä¸Šæ‰‹ä½“éªŒ"></a>ä¸Šæ‰‹ä½“éªŒ</h2><ul><li>copyï¼šå¤åˆ¶ä¸€ä¸ªé•œåƒä» A åˆ° Bï¼Œè¿™é‡Œçš„ A å’Œ B å¯ä»¥ä¸ºæœ¬åœ° docker é•œåƒæˆ–è€… registry ä¸Šçš„é•œåƒï¼›</li><li>inspectï¼šæŸ¥çœ‹ä¸€ä¸ªé•œåƒçš„ manifest æˆ–è€… image config è¯¦ç»†ä¿¡æ¯ï¼›</li><li>deleteï¼šåˆ é™¤ä¸€ä¸ªé•œåƒ tagï¼Œå¯ä»¥æ˜¯æœ¬åœ° docker é•œåƒæˆ–è€… registry ä¸Šçš„é•œåƒï¼›</li><li>list-tagsï¼šåˆ—å‡ºä¸€ä¸ª registry ä¸ŠæŸä¸ªé•œåƒçš„æ‰€æœ‰ tagï¼›</li><li>loginï¼šç™»å½•åˆ°æŸä¸ª registryï¼Œå’Œ docker login ç±»ä¼¼ï¼›</li><li>logoutï¼š é€€å‡ºå·²ç»ç™»å½•åˆ°æŸä¸ª registry çš„ auth ä¿¡æ¯ï¼Œå’Œ docker logout ç±»ä¼¼ï¼›</li><li>manifest-digestï¼šå‡ åœˆä¸€ä¸ªæ–‡ä»¶çš„ sha256sum å€¼ï¼›</li><li>standalone-signã€standalone-verify è¿™ä¸¤ä¸ªæ˜¯å’Œé•œåƒåŠ å¯†ç›¸å…³çš„ï¼Œä½¿ç”¨çš„ä¸æ˜¯å¾ˆå¤šï¼›</li><li>syncï¼šåŒæ­¥ä¸€ä¸ªé•œåƒä» A åˆ° Bï¼Œæ„Ÿè§‰å’Œ copy ä¸€æ ·ï¼Œä½† sync æ”¯æŒçš„å‚æ•°æ›´å¤šï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">completion             generate the autocompletion script <span class="keyword">for</span> the specified shell</span><br><span class="line">copy                   Copy an IMAGE-NAME from one location to another</span><br><span class="line">delete                 Delete image IMAGE-NAME</span><br><span class="line"><span class="built_in">help</span>                   Help about any <span class="built_in">command</span></span><br><span class="line">inspect                Inspect image IMAGE-NAME</span><br><span class="line">list-tags              List tags <span class="keyword">in</span> the transport/repository specified by the REPOSITORY-NAME</span><br><span class="line">login                  Login to a container registry</span><br><span class="line"><span class="built_in">logout</span>                 Logout of a container registry</span><br><span class="line">manifest-digest        Compute a manifest digest of a file</span><br><span class="line">standalone-sign        Create a signature using <span class="built_in">local</span> files</span><br><span class="line">standalone-verify      Verify a signature using <span class="built_in">local</span> files</span><br><span class="line">sync                   Synchronize one or more images</span><br></pre></td></tr></table></figure><h3 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h3><ul><li>command-timeoutï¼šå‘½ä»¤è¶…æ—¶æ—¶é—´</li><li>debugï¼šå¼€å¯ debug æ¨¡å¼ï¼Œè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—</li><li>insecure-policyï¼š ä½¿ç”¨éå®‰å…¨çš„ policyï¼Œå¦‚æœæ²¡æœ‰é…ç½® policy çš„è¯ï¼Œéœ€è¦åŠ ä¸Šè¯¥å‚æ•°</li><li>override-archï¼šå¤„ç†é•œåƒæ—¶è¦†ç›–å®¢æˆ·ç«¯ CPU ä½“ç³»æ¶æ„ï¼Œå¦‚åœ¨ amd64 çš„æœºå™¨ä¸Šç”¨ skopeo å¤„ç† arm64 çš„é•œåƒ</li><li>override-osï¼š å¤„ç†é•œåƒæ—¶è¦†ç›–å®¢æˆ·ç«¯ OS</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Flags:</span><br><span class="line">      --<span class="built_in">command</span>-timeout duration   timeout <span class="keyword">for</span> the <span class="built_in">command</span> execution</span><br><span class="line">      --debug                      <span class="built_in">enable</span> debug output</span><br><span class="line">  -h, --<span class="built_in">help</span>                       <span class="built_in">help</span> <span class="keyword">for</span> skopeo</span><br><span class="line">      --insecure-policy            run the tool without any policy check</span><br><span class="line">      --override-arch ARCH         use ARCH instead of the architecture of the machine <span class="keyword">for</span> choosing images</span><br><span class="line">      --override-os OS             use OS instead of the running OS <span class="keyword">for</span> choosing images</span><br><span class="line">      --override-variant VARIANT   use VARIANT instead of the running architecture variant <span class="keyword">for</span> choosing images</span><br><span class="line">      --policy string              Path to a trust policy file</span><br><span class="line">      --registries.d DIR           use registry configuration files <span class="keyword">in</span> DIR (e.g. <span class="keyword">for</span> container signature storage)</span><br><span class="line">      --tmpdir string              directory used to store temporary files</span><br><span class="line">  -v, --version                    Version <span class="keyword">for</span> Skopeo</span><br></pre></td></tr></table></figure><p>ä¸€ä¸‹æ˜¯æˆ‘åœ¨ä½¿ç”¨ skopeo å‘½ä»¤æ—¶å€™çš„ä¸€äº›å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--insecure-policy --src-tls-verify=<span class="literal">false</span> --dest-tls-verify=<span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="IMAGE-NAMES-é•œåƒæ ¼å¼ğŸ¤”ï¸"><a href="#IMAGE-NAMES-é•œåƒæ ¼å¼ğŸ¤”ï¸" class="headerlink" title="IMAGE NAMES é•œåƒæ ¼å¼ğŸ¤”ï¸"></a>IMAGE NAMES é•œåƒæ ¼å¼ğŸ¤”ï¸</h3><p>åœ¨ä½¿ç”¨ skopeo ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“åœ¨å‘½ä»¤è¡Œä¸­é•œåƒçš„æ ¼å¼ï¼Œä¸‹é¢æ˜¯å®˜æ–¹è¯¦ç»†çš„æ–‡æ¡£æ ¼å¼ã€‚æ— è®ºæˆ‘ä»¬çš„ src é•œåƒè¿˜æ˜¯ dest é•œåƒéƒ½è¦æ»¡è¶³ä»¥ä¸‹æ ¼å¼æ‰å¯ä»¥ã€‚</p><blockquote><p>Most commands refer to container images, using a <em>transport<em><code>:</code></em>details</em> format. The following formats are supported:</p></blockquote><blockquote><p><strong>containers-storage:*</strong>docker-reference* An image located in a local containers/storage image store. Both the location and image store are specified in /etc/containers/storage.conf. (Backend for Podman, CRI-O, Buildah and friends)</p></blockquote><blockquote><p><strong>dir:*</strong>path* An existing local directory <em>path</em> storing the manifest, layer tarballs and signatures as individual files. This is a non-standardized format, primarily useful for debugging or noninvasive container inspection.</p></blockquote><blockquote><p><strong>docker://*</strong>docker-reference* An image in a registry implementing the â€œDocker Registry HTTP API V2â€. By default, uses the authorization state in either <code>$XDG_RUNTIME_DIR/containers/auth.json</code>, which is set using <code>(skopeo login)</code>. If the authorization state is not found there, <code>$HOME/.docker/config.json</code> is checked, which is set using <code>(docker login)</code>.</p></blockquote><blockquote><p><strong>docker-archive:*</strong>path<strong>***[</strong>:<em>*<em>docker-reference</em>] An image is stored in the <code>docker save</code> formatted file. *docker-reference</em> is only used when creating such a file, and it must not contain a digest.</p></blockquote><blockquote><p><strong>docker-daemon:*</strong>docker-reference* An image <em>docker-reference</em> stored in the docker daemon internal storage. <em>docker-reference</em> must contain either a tag or a digest. Alternatively, when reading images, the format can be docker-daemon:algo:digest (an image ID).</p></blockquote><blockquote><p><strong>oci:*</strong>path<strong><em>:</em></strong>tag* An image <em>tag</em> in a directory compliant with â€œOpen Container Image Layout Specificationâ€ at <em>path</em>.</p></blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™å‡ ç§é•œåƒçš„åå­—ï¼Œå¯¹åº”ç€é•œåƒå­˜åœ¨çš„æ–¹å¼ï¼Œä¸åŒå­˜åœ¨çš„æ–¹å¼å¯¹é•œåƒçš„ layer å¤„ç†çš„æ–¹å¼ä¹Ÿä¸ä¸€æ ·ï¼Œæ¯”å¦‚ <code>docker://</code> è¿™ç§æ–¹å¼æ˜¯å­˜åœ¨ registry ä¸Šçš„ï¼Œ<code>docker-daemon:</code> æ˜¯å­˜åœ¨æœ¬åœ° docker pull ä¸‹æ¥çš„ï¼Œå†æ¯”å¦‚ <code>docker-archive</code> æ˜¯é€šè¿‡ docker save å‡ºæ¥çš„é•œåƒã€‚åŒä¸€ä¸ªé•œåƒæœ‰è¿™å‡ ç§å­˜åœ¨çš„æ–¹å¼å°±åƒæ°´åˆ†å­æœ‰æ°”ä½“ã€æ¶²ä½“ã€å›ºä½“ä¸€æ ·ã€‚å¯ä»¥è¿™æ ·å»ç†è§£ï¼Œä»–ä»¬è¡¨è¿°çš„éƒ½æ˜¯åŒä¸€ä¸ªé•œåƒï¼Œåªä¸è¿‡æ˜¯å­˜åœ¨çš„æ–¹å¼ä¸ä¸€æ ·è€Œå·²ã€‚</p><p>IMAGE NAMESï¼ˆé•œåƒæ ¼å¼ï¼‰examplecontainers-storage:containers-storage:dir:dir:/PATHdocker://docker://k8s.gcr.io/kube-apiserver:v1.17.5docker-daemon:docker-daemon:alpine:latestdocker-archive:docker-archive:alpine.tar (docker save)oci:oci:alpine:latest</p><h3 id="skopeo-login"><a href="#skopeo-login" class="headerlink" title="skopeo login"></a>skopeo login</h3><p>åœ¨ä½¿ç”¨ skopeo å‰å¦‚æœ src æˆ– dest é•œåƒæ˜¯åœ¨ registry ä¸­çš„ï¼Œå¦‚æœé public çš„é•œåƒéœ€è¦ç›¸åº”çš„ auth è®¤è¯ï¼Œå¯ä»¥ä½¿ç”¨ docker login æˆ–è€… skopeo login çš„æ–¹å¼ç™»å½•åˆ° registryï¼Œç”Ÿæˆå¦‚ä¸‹æ ¼å¼çš„ registry ç™»å½•é…ç½®æ–‡ä»¶ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ jq "." ~/.docker/config.json                                                             </span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"auths"</span>: &#123;</span><br><span class="line">    <span class="attr">"https://index.docker.io/v1/"</span>: &#123;</span><br><span class="line">      <span class="attr">"auth"</span>: <span class="string">"d2sdwdaqWMasss7bSVlJFpmQE43Sw=="</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"HttpHeaders"</span>: &#123;</span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"Docker-Client/19.03.5 (linux)"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"experimental"</span>: <span class="string">"enabled"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="skopeo-copy"><a href="#skopeo-copy" class="headerlink" title="skopeo copy"></a>skopeo copy</h3><blockquote><p>Copy an IMAGE-NAME from one location to another</p></blockquote><blockquote><p>å°†ä¸€ä¸ªé•œåƒä» A å¤åˆ¶åˆ° B</p></blockquote><p>æ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡Œçš„ location å°±æ˜¯æŒ‡çš„ä¸Šé¢æåˆ°çš„ <code>IMAGE NAMES</code> ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>skopeo copy src dest</code> å¯ä»¥æœ‰6*6=36 ç§ç»„åˆï¼æ¯”å¦‚æˆ‘å¯ä»¥å°†ä¸€ä¸ªé•œåƒä»ä¸€ä¸ª registry å¤åˆ¶åˆ°å¦ä¸€ä¸ª registryï¼š<code>skopeo copy docker://IMAGE_NAME docker://IMAGE_NAME</code>ï¼›æˆ–è€…å°†ä¸€ä¸ªé•œåƒä» registry ä¸­å¤åˆ¶åˆ°ä¸€ä¸ªæœ¬åœ°ç›®å½• <code>skopeo copy docker://k8s.gcr.io/pause:3.3 dir:pause:3.3</code></p><ul><li>ä» regsitry A åˆ° registry B å¤åˆ¶é•œåƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy docker://k8s.gcr.io/kube-apiserver:v1.17.5 docker://hub.k8s.li/kube-apiserver:v1.17.5 --dest-authfile /root/.docker/config.json</span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob 597de8ba0c30 <span class="keyword">done</span></span><br><span class="line">Copying blob e13a88fa950c <span class="keyword">done</span></span><br><span class="line">Copying config f640481f6d <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br></pre></td></tr></table></figure><blockquote><p>skopeo è¾“å‡ºçš„æ—¥å¿—æ˜¾ç¤ºæ˜¯ Copying blob 597de8ba0c30 done.å¯ä»¥çœ‹åˆ° skopeo æ˜¯ç›´æ¥ä» registry ä¸­ copy é•œåƒ layer çš„ blob æ–‡ä»¶ï¼Œä¼ è¾“æ˜¯é•œåƒåœ¨ registry ä¸­å­˜å‚¨çš„åŸå§‹æ ¼å¼ã€‚</p></blockquote><ul><li>å°†é•œåƒä» registry å¤åˆ¶åˆ°æœ¬åœ°ç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy docker://k8s.gcr.io/pause:3.3 dir:pause:3.3</span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob aeab776c4837 <span class="keyword">done</span></span><br><span class="line">Copying config 0184c1613d <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line">$ tree pause:3.3</span><br><span class="line">pause:3.3</span><br><span class="line">â”œâ”€â”€ 0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da</span><br><span class="line">â”œâ”€â”€ aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b</span><br><span class="line">â”œâ”€â”€ manifest.json</span><br><span class="line">â””â”€â”€ version</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é•œåƒçš„ manifest æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">$ jq <span class="string">'.'</span> pause:3.3/manifest.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"schemaVersion"</span>: 2,</span><br><span class="line">  <span class="string">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">  <span class="string">"config"</span>: &#123;</span><br><span class="line">    <span class="string">"mediaType"</span>: <span class="string">"application/vnd.docker.container.image.v1+json"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 743,</span><br><span class="line">    <span class="string">"digest"</span>: <span class="string">"sha256:0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"layers"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"mediaType"</span>: <span class="string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span>,</span><br><span class="line">      <span class="string">"size"</span>: 296517,</span><br><span class="line">      <span class="string">"digest"</span>: <span class="string">"sha256:aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ® manifest æ–‡ä»¶æŸ¥çœ‹é•œåƒçš„ image config æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">$ jq <span class="string">'.'</span> pause:3.3/0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">  <span class="string">"config"</span>: &#123;</span><br><span class="line">    <span class="string">"Env"</span>: [</span><br><span class="line">      <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"Entrypoint"</span>: [</span><br><span class="line">      <span class="string">"/pause"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"WorkingDir"</span>: <span class="string">"/"</span>,</span><br><span class="line">    <span class="string">"OnBuild"</span>: null</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"created"</span>: <span class="string">"2020-05-02T09:46:29.068489061Z"</span>,</span><br><span class="line">  <span class="string">"history"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"created"</span>: <span class="string">"2020-05-02T09:46:29.068489061Z"</span>,</span><br><span class="line">      <span class="string">"created_by"</span>: <span class="string">"ARG ARCH"</span>,</span><br><span class="line">      <span class="string">"comment"</span>: <span class="string">"buildkit.dockerfile.v0"</span>,</span><br><span class="line">      <span class="string">"empty_layer"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"created"</span>: <span class="string">"2020-05-02T09:46:29.068489061Z"</span>,</span><br><span class="line">      <span class="string">"created_by"</span>: <span class="string">"ADD bin/pause-amd64 /pause # buildkit"</span>,</span><br><span class="line">      <span class="string">"comment"</span>: <span class="string">"buildkit.dockerfile.v0"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"created"</span>: <span class="string">"2020-05-02T09:46:29.068489061Z"</span>,</span><br><span class="line">      <span class="string">"created_by"</span>: <span class="string">"ENTRYPOINT [\"/pause\"]"</span>,</span><br><span class="line">      <span class="string">"comment"</span>: <span class="string">"buildkit.dockerfile.v0"</span>,</span><br><span class="line">      <span class="string">"empty_layer"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">  <span class="string">"rootfs"</span>: &#123;</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"layers"</span>,</span><br><span class="line">    <span class="string">"diff_ids"</span>: [</span><br><span class="line">      <span class="string">"sha256:48a5e87615149095fad57d5db80f2cd9728b5562900eccb32842a45e8e8a61ae"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å°†é•œåƒä» registry å¤åˆ¶åˆ°æœ¬åœ°ç›®å½•ï¼Œä»¥ OCI æ ¼å¼ä¿å­˜</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy docker://k8s.gcr.io/pause:3.3 oci:images</span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob aeab776c4837 <span class="keyword">done</span></span><br><span class="line">Copying config fa5df7713f <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line">$ tree images</span><br><span class="line">images</span><br><span class="line">â”œâ”€â”€ blobs</span><br><span class="line">â”‚   â””â”€â”€ sha256</span><br><span class="line">â”‚       â”œâ”€â”€ 3450ba84b8fbfd12cbf58710c0b5678f4311a888d4d5c42b053faefa1af4f8be</span><br><span class="line">â”‚       â”œâ”€â”€ aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b</span><br><span class="line">â”‚       â””â”€â”€ fa5df7713fc78f96e377d236b353d33815073105bbacd381e50705e576ce4da5</span><br><span class="line">â”œâ”€â”€ index.json</span><br><span class="line">â””â”€â”€ oci-layout</span><br></pre></td></tr></table></figure><ul><li>æ›¿ä»£ docker push åŠŸèƒ½ï¼Œå°†é•œåƒä» docker æœ¬åœ°å­˜å‚¨ push åˆ° registry ä¸­</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy docker-daemon:alpine:3.12 docker://hub.k8s.li/library/alpine:3.12</span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob 32f366d666a5 <span class="keyword">done</span></span><br><span class="line">Copying config 13621d1b12 <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br></pre></td></tr></table></figure><h3 id="skopeo-sync"><a href="#skopeo-sync" class="headerlink" title="skopeo sync"></a>skopeo sync</h3><p>Skopeo sync çš„åŠŸèƒ½åŸºæœ¬ä¸Šç­‰åŒäºé˜¿é‡Œäº‘çš„ <a href="https://github.com/AliyunContainerService/image-syncer" target="_blank" rel="noopener">image-syncer</a> å·¥å…·ï¼Œä¸è¿‡ä¸ªäººè§‰ç€ skopeo è¦æ¯” image-syncer æ›´å¼ºå¤§ï¼Œçµæ´»æ€§æ›´å¼ºä¸€äº›ï¼Œæ±è¿˜åœ¨ä½¿ç”¨ image-syncer çš„è¯ï¼Œå¼ºçƒˆå»ºè®®ä½ ä½¿ç”¨ skopeo sync æ›¿ä»£å®ƒğŸ˜‚ã€‚</p><ul><li>skopeo sync é•œåƒåŒæ­¥æ–‡ä»¶</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">registry.example.com:</span></span><br><span class="line">    <span class="attr">images:</span></span><br><span class="line">        <span class="attr">busybox:</span> <span class="string">[]</span></span><br><span class="line">        <span class="attr">redis:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"1.0"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"2.0"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"sha256:111111"</span></span><br><span class="line">    <span class="attr">images-by-tag-regex:</span></span><br><span class="line">        <span class="attr">nginx:</span> <span class="string">^1\.13\.[12]-alpine-perl$</span></span><br><span class="line">    <span class="attr">credentials:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">john</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">this</span> <span class="string">is</span> <span class="string">a</span> <span class="string">secret</span></span><br><span class="line">    <span class="attr">tls-verify:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cert-dir:</span> <span class="string">/home/john/certs</span></span><br><span class="line"><span class="attr">quay.io:</span></span><br><span class="line">    <span class="attr">tls-verify:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">images:</span></span><br><span class="line">        <span class="attr">coreos/etcd:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">latest</span></span><br></pre></td></tr></table></figure><ul><li>Image-syncer é•œåƒåŒæ­¥é…ç½®æ–‡ä»¶</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># registry ç™»å½•é…ç½®</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line">    <span class="attr">"quay.io":</span> <span class="string">&#123;</span>        <span class="string">//</span> <span class="string">This</span> <span class="string">"registry"</span> <span class="string">or</span> <span class="string">"registry/namespace"</span> <span class="string">string</span> <span class="string">should</span> <span class="string">be</span> <span class="string">the</span> <span class="string">same</span> <span class="string">as</span> <span class="string">registry</span> <span class="string">or</span> <span class="string">registry/namespace</span> <span class="string">used</span> <span class="string">below</span> <span class="string">in</span> <span class="string">"images"</span> <span class="string">field.</span>  </span><br><span class="line">                            <span class="string">//</span> <span class="string">The</span> <span class="string">format</span> <span class="string">of</span> <span class="string">"registry/namespace"</span> <span class="string">will</span> <span class="string">be</span> <span class="string">more</span> <span class="string">prior</span> <span class="string">matched</span> <span class="string">than</span> <span class="string">"registry"</span></span><br><span class="line">        <span class="attr">"username":</span> <span class="string">"xxx"</span><span class="string">,</span>             </span><br><span class="line">        <span class="attr">"password":</span> <span class="string">"xxxxxxxxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"insecure":</span> <span class="literal">true</span>         <span class="string">//</span> <span class="string">"insecure"</span> <span class="string">field</span> <span class="string">needs</span> <span class="string">to</span> <span class="string">be</span> <span class="literal">true</span> <span class="string">if</span> <span class="string">this</span> <span class="string">registry</span> <span class="string">is</span> <span class="string">a</span> <span class="string">http</span> <span class="string">service,</span> <span class="string">default</span> <span class="string">value</span> <span class="string">is</span> <span class="literal">false</span><span class="string">,</span> <span class="string">version</span> <span class="string">of</span> <span class="string">image-syncer</span> <span class="string">need</span> <span class="string">to</span> <span class="string">be</span> <span class="string">later</span> <span class="string">than</span> <span class="string">v1.0.1</span> <span class="string">to</span> <span class="string">support</span> <span class="string">this</span> <span class="string">field</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="attr">"registry.cn-beijing.aliyuncs.com":</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">"username":</span> <span class="string">"xxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"password":</span> <span class="string">"xxxxxxxxx"</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="attr">"registry.hub.docker.com":</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">"username":</span> <span class="string">"xxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"password":</span> <span class="string">"xxxxxxxxxx"</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="attr">"quay.io/coreos":</span> <span class="string">&#123;</span>     <span class="string">//</span> <span class="string">"registry/namespace"</span> <span class="string">format</span> <span class="string">is</span> <span class="string">supported</span> <span class="string">after</span> <span class="string">v1.0.3</span> <span class="string">of</span> <span class="string">image-syncer</span>     </span><br><span class="line">        <span class="attr">"username":</span> <span class="string">"abc"</span><span class="string">,</span>              </span><br><span class="line">        <span class="attr">"password":</span> <span class="string">"xxxxxxxxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"insecure":</span> <span class="literal">true</span>  </span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="comment"># é•œåƒé…ç½®</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line">    <span class="attr">"quay.io/coreos/kube-rbac-proxy":</span> <span class="string">"quay.io/ruohe/kube-rbac-proxy"</span><span class="string">,</span></span><br><span class="line">    <span class="string">"xxxx"</span><span class="string">:"xxxxx",</span></span><br><span class="line">    <span class="string">"xxx/xxx/xx:tag1,tag2,tag3"</span><span class="string">:"xxx/xxx/xx"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>å°†é•œä» registry A åŒæ­¥åˆ° registry B</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --src docker --dest docker k8s.gcr.io/pause:3.3 hub.k8s.li</span><br><span class="line">INFO[0000] Tag presence check                            imagename=<span class="string">"k8s.gcr.io/pause:3.3"</span> tagged=<span class="literal">true</span></span><br><span class="line">INFO[0000] Copying image tag 1/1                         from=<span class="string">"docker://k8s.gcr.io/pause:3.3"</span> to=<span class="string">"docker://hub.k8s.li/pause:3.3"</span></span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob aeab776c4837 <span class="keyword">done</span></span><br><span class="line">Copying config 0184c1613d <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line">INFO[0000] Synced 1 images from 1 sources</span><br></pre></td></tr></table></figure><ul><li>å°†ä¸€ä¸ªé•œåƒä» registry ä¸­åŒæ­¥åˆ°æœ¬åœ°ç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --src docker --dest dir k8s.gcr.io/pause:3.3 images</span><br><span class="line">images</span><br><span class="line">â””â”€â”€ pause:3.3</span><br><span class="line">    â”œâ”€â”€ 0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da</span><br><span class="line">    â”œâ”€â”€ aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b</span><br><span class="line">    â”œâ”€â”€ manifest.json</span><br><span class="line">    â””â”€â”€ version</span><br></pre></td></tr></table></figure><ul><li>å°†é•œåƒä»æœ¬åœ°ç›®å½•åŒæ­¥åˆ° registry ä¸­</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --src dir --dest docker images hub.k8s.li</span><br><span class="line">INFO[0000] Copying image ref 1/1                         from=<span class="string">"dir:images/pause:3.3"</span> to=<span class="string">"docker://hub.k8s.li/pause:3.3"</span></span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob aeab776c4837 [--------------------------------------] 0.0b / 0.0b</span><br><span class="line">Copying config 0184c1613d <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line">INFO[0002] Synced 1 images from 1 sources</span><br></pre></td></tr></table></figure><h3 id="skopeo-inspect"><a href="#skopeo-inspect" class="headerlink" title="skopeo inspect"></a>skopeo inspect</h3><p>è¿™ä¸ªå‘½ä»¤å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªé•œåƒçš„ image config æˆ–è€… manifests æ–‡ä»¶ï¼Œå’Œ docker inspect å‘½ä»¤å·®ä¸å¤šã€‚ä¸åŠ  â€“raw å‚æ•°é»˜è®¤æ˜¯æŸ¥çœ‹é•œåƒçš„ image config æ–‡ä»¶ï¼ŒåŠ ä¸Š â€“raw å‚æ•°å°±æ˜¯æŸ¥çœ‹é•œåƒçš„ manifest æ–‡ä»¶ã€‚</p><ul><li>æŸ¥çœ‹ docker æœ¬åœ°å­˜å‚¨ä¸­çš„ä¸€ä¸ªé•œåƒçš„ image config æ–‡ä»¶</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo inspect docker-daemon:alpine:latest</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Name"</span>: <span class="string">"docker.io/library/alpine"</span>,</span><br><span class="line">    <span class="attr">"Digest"</span>: <span class="string">"sha256:ab84514e85b179ff569fd0042969b04f68812f23e187a927cb84664b417e0d3e"</span>,</span><br><span class="line">    <span class="attr">"RepoTags"</span>: [],</span><br><span class="line">    <span class="attr">"Created"</span>: <span class="string">"2021-04-14T19:19:49.594730611Z"</span>,</span><br><span class="line">    <span class="attr">"DockerVersion"</span>: <span class="string">"19.03.12"</span>,</span><br><span class="line">    <span class="attr">"Labels"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"Architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">    <span class="attr">"Os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">    <span class="attr">"Layers"</span>: [</span><br><span class="line">        <span class="string">"sha256:32f366d666a541852cad754ee1cdb53a736110b550f0c2d5a46bc5ba519896b6"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Env"</span>: [</span><br><span class="line">        <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹ registry ä¸­ä¸€ä¸ªé•œåƒçš„ manifests æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥åˆ¤æ–­é•œåƒæ˜¯å¦å­˜åœ¨</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">skopeo inspect docker://alpine:latest --raw | jq '.'</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"manifests"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:1775bebec23e1f3ce486989bfc9ff3c4e951690df84aa9f926497d82f2ffca9d"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:1f66b8f3041ef8575260056dedd437ed94e7bfeea142ee39ff0d795f94ff2287"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"arm"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">        <span class="attr">"variant"</span>: <span class="string">"v6"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:8d99168167baa6a6a0d7851b9684625df9c1455116a9601835c2127df2aaa2f5"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"arm"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">        <span class="attr">"variant"</span>: <span class="string">"v7"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:53b74ddfc6225e3c8cc84d7985d0f34666e4e8b0b6892a9b2ad1f7516bc21b54"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"arm64"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">        <span class="attr">"variant"</span>: <span class="string">"v8"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:52a197664c8ed0b4be6d3b8372f1d21f3204822ba432583644c9ce07f7d6448f"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"386"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:b421672fe4e74a3c7eff2775736e854d69e8d38b2c337063f8699de9c408ddd3"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"ppc64le"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:8a22269106a31264874cc3a719c1e280e76d42dff1fa57bd9c7fe68dab574023"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"s390x"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.list.v2+json"</span>,</span><br><span class="line">  <span class="attr">"schemaVersion"</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="skopeo-delete"><a href="#skopeo-delete" class="headerlink" title="skopeo delete"></a>skopeo delete</h3><p>ä½¿ç”¨è¿™ä¸ªå‘½ä»¤å¯ä»¥åˆ é™¤é•œåƒ tagã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé€šè¿‡  registry API æ¥åˆ é™¤é•œåƒçš„ tag ä»…ä»…æ˜¯åˆ é™¤äº† tag å¯¹ manifests æ–‡ä»¶çš„å¼•ç”¨ï¼Œå¹¶éçœŸæ­£å°†é•œåƒåˆ é™¤æ‰ã€‚å¦‚æœæƒ³è¦åˆ é™¤é•œåƒçš„ layer è¿˜æ˜¯éœ€è¦é€šè¿‡ registry GC çš„æ–¹å¼ï¼Œå¯å‚è€ƒä¹‹å‰å†™è¿‡çš„ä¸€ç¯‡åšå®¢ã€Š<a href="https://blog.k8s.li/registry-gc.html">docker registry GC åŸç†åˆ†æ</a>ã€‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo delete docker:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;pause:3.2 --debug</span><br><span class="line">DEBU[0000] Returning credentials from &#x2F;home&#x2F;release&#x2F;.docker&#x2F;config.json</span><br><span class="line">DEBU[0000] Using registries.d directory &#x2F;etc&#x2F;containers&#x2F;registries.d for sigstore configuration</span><br><span class="line">DEBU[0000]  No signature storage configuration found for hub.k8s.li&#x2F;library&#x2F;pause:3.2</span><br><span class="line">DEBU[0000] Looking for TLS certificates and private keys in &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;hub.k8s.li&#x2F;library</span><br><span class="line">DEBU[0000] Loading registries configuration &quot;&#x2F;etc&#x2F;containers&#x2F;registries.conf&quot;</span><br><span class="line">DEBU[0000] GET https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;</span><br><span class="line">DEBU[0000] Ping https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F; status 401</span><br><span class="line">DEBU[0000] GET https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;library&#x2F;pause&#x2F;manifests&#x2F;3.2</span><br><span class="line">DEBU[0000] DELETE https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;library&#x2F;pause&#x2F;manifests&#x2F;sha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108</span><br></pre></td></tr></table></figure><h3 id="skopeo-list-tags"><a href="#skopeo-list-tags" class="headerlink" title="skopeo list-tags"></a>skopeo list-tags</h3><p>è¿™ä¸ªå‘½ä»¤å¯ç”¨äºåˆ—å‡º registry ä¸Šçš„æŸä¸ªé•œåƒçš„æ‰€æœ‰ tag ï¼Œä½¿ç”¨æ ‡å‡†çš„ registry API æ¥è·å–é•œåƒ tag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo list-tags docker:&#x2F;&#x2F;k8s.gcr.io&#x2F;pause</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Repository&quot;: &quot;k8s.gcr.io&#x2F;pause&quot;,</span><br><span class="line">    &quot;Tags&quot;: [</span><br><span class="line">        &quot;0.8.0&quot;,</span><br><span class="line">        &quot;1.0&quot;,</span><br><span class="line">        &quot;2.0&quot;,</span><br><span class="line">        &quot;3.0&quot;,</span><br><span class="line">        &quot;3.1&quot;,</span><br><span class="line">        &quot;3.2&quot;,</span><br><span class="line">        &quot;3.3&quot;,</span><br><span class="line">        &quot;3.4.1&quot;,</span><br><span class="line">        &quot;3.5&quot;,</span><br><span class="line">        &quot;go&quot;,</span><br><span class="line">        &quot;latest&quot;,</span><br><span class="line">        &quot;test&quot;,</span><br><span class="line">        &quot;test2&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><p>ä¸€ä¸‹ç»™å‡ºå‡ ä¸ª skopeo å·¥å…·çš„æœ€ä½³å®è·µ ğŸ˜Š</p><h3 id="é•œåƒåŒæ­¥"><a href="#é•œåƒåŒæ­¥" class="headerlink" title="é•œåƒåŒæ­¥"></a>é•œåƒåŒæ­¥</h3><p>å‡å¦‚ç»™ä½ ä¸€ä¸ªé•œåƒåˆ—è¡¨ï¼Œå¦‚ <a href="https://github.com/kubesphere/ks-installer/blob/master/scripts/images-list.txtã€‚å¦‚ä½•å°†å®ƒå¿«é€Ÿåœ°ä»ä¸€ä¸ª" target="_blank" rel="noopener">https://github.com/kubesphere/ks-installer/blob/master/scripts/images-list.txtã€‚å¦‚ä½•å°†å®ƒå¿«é€Ÿåœ°ä»ä¸€ä¸ª</a> registry åŒæ­¥åˆ°å¦ä¸€ä¸ª registry ä¸­å‘¢ï¼Ÿè¿˜æ˜¯ skopeo copy èµ°èµ·ï¼</p><ul><li>images-list.txt</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line">##k8s-images</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.19.8</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.19.8</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.19.8</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.19.8</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.19.9</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.19.9</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.19.9</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.19.9</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.18.8</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.18.8</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.18.8</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.18.8</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.17.9</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.17.9</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.17.9</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.17.9</span><br><span class="line">kubesphere&#x2F;pause:3.1</span><br><span class="line">kubesphere&#x2F;pause:3.2</span><br><span class="line">kubesphere&#x2F;etcd:v3.4.13</span><br><span class="line">calico&#x2F;cni:v3.16.3</span><br><span class="line">calico&#x2F;kube-controllers:v3.16.3</span><br><span class="line">calico&#x2F;node:v3.16.3</span><br><span class="line">calico&#x2F;pod2daemon-flexvol:v3.16.3</span><br><span class="line">calico&#x2F;typha:v3.16.3</span><br><span class="line">kubesphere&#x2F;flannel:v0.12.0</span><br><span class="line">coredns&#x2F;coredns:1.6.9</span><br><span class="line">kubesphere&#x2F;k8s-dns-node-cache:1.15.12</span><br><span class="line">openebs&#x2F;provisioner-localpv:2.10.1</span><br><span class="line">openebs&#x2F;linux-utils:2.10.0</span><br><span class="line">kubesphere&#x2F;nfs-client-provisioner:v3.1.0-k8s1.11</span><br><span class="line">##csi-images</span><br><span class="line">csiplugin&#x2F;csi-neonsan:v1.2.0</span><br><span class="line">csiplugin&#x2F;csi-neonsan-ubuntu:v1.2.0</span><br><span class="line">csiplugin&#x2F;csi-neonsan-centos:v1.2.0</span><br><span class="line">csiplugin&#x2F;csi-provisioner:v1.5.0</span><br><span class="line">csiplugin&#x2F;csi-attacher:v2.1.1</span><br><span class="line">csiplugin&#x2F;csi-resizer:v0.4.0</span><br><span class="line">csiplugin&#x2F;csi-snapshotter:v2.0.1</span><br><span class="line">csiplugin&#x2F;csi-node-driver-registrar:v1.2.0</span><br><span class="line">csiplugin&#x2F;csi-qingcloud:v1.2.0</span><br><span class="line">##kubesphere-images</span><br><span class="line">kubesphere&#x2F;ks-apiserver:v3.1.1</span><br><span class="line">kubesphere&#x2F;ks-console:v3.1.1</span><br><span class="line">kubesphere&#x2F;ks-controller-manager:v3.1.1</span><br><span class="line">kubesphere&#x2F;ks-installer:v3.1.1</span><br><span class="line">kubesphere&#x2F;kubectl:v1.20.0</span><br><span class="line">kubesphere&#x2F;kubectl:v1.19.0</span><br><span class="line">redis:5.0.12-alpine</span><br><span class="line">alpine:3.14</span><br><span class="line">haproxy:2.0.22-alpine</span><br><span class="line">nginx:1.14-alpine</span><br><span class="line">minio&#x2F;minio:RELEASE.2019-08-07T01-59-21Z</span><br><span class="line">minio&#x2F;mc:RELEASE.2019-08-07T23-14-43Z</span><br><span class="line">mirrorgooglecontainers&#x2F;defaultbackend-amd64:1.4</span><br><span class="line">kubesphere&#x2F;nginx-ingress-controller:v0.35.0</span><br><span class="line">osixia&#x2F;openldap:1.3.0</span><br><span class="line">csiplugin&#x2F;snapshot-controller:v3.0.3</span><br><span class="line">kubesphere&#x2F;kubefed:v0.7.0</span><br><span class="line">kubesphere&#x2F;tower:v0.2.0</span><br><span class="line">kubesphere&#x2F;prometheus-config-reloader:v0.42.1</span><br><span class="line">kubesphere&#x2F;prometheus-operator:v0.42.1</span><br><span class="line">prom&#x2F;alertmanager:v0.21.0</span><br><span class="line">prom&#x2F;prometheus:v2.26.0</span><br><span class="line">prom&#x2F;node-exporter:v0.18.1</span><br><span class="line">kubesphere&#x2F;ks-alerting-migration:v3.1.0</span><br><span class="line">jimmidyson&#x2F;configmap-reload:v0.3.0</span><br><span class="line">kubesphere&#x2F;notification-manager-operator:v1.0.0</span><br><span class="line">kubesphere&#x2F;notification-manager:v1.0.0</span><br><span class="line">kubesphere&#x2F;metrics-server:v0.4.2</span><br><span class="line">kubesphere&#x2F;kube-rbac-proxy:v0.8.0</span><br><span class="line">kubesphere&#x2F;kube-state-metrics:v1.9.7</span><br><span class="line">openebs&#x2F;provisioner-localpv:2.3.0</span><br><span class="line">thanosio&#x2F;thanos:v0.18.0</span><br><span class="line">grafana&#x2F;grafana:7.4.3</span><br><span class="line">##kubesphere-logging-images</span><br><span class="line">kubesphere&#x2F;elasticsearch-oss:6.7.0-1</span><br><span class="line">kubesphere&#x2F;elasticsearch-curator:v5.7.6</span><br><span class="line">kubesphere&#x2F;fluentbit-operator:v0.5.0</span><br><span class="line">kubesphere&#x2F;fluentbit-operator:migrator</span><br><span class="line">kubesphere&#x2F;fluent-bit:v1.6.9</span><br><span class="line">elastic&#x2F;filebeat:6.7.0</span><br><span class="line">kubesphere&#x2F;kube-auditing-operator:v0.1.2</span><br><span class="line">kubesphere&#x2F;kube-auditing-webhook:v0.1.2</span><br><span class="line">kubesphere&#x2F;kube-events-exporter:v0.1.0</span><br><span class="line">kubesphere&#x2F;kube-events-operator:v0.1.0</span><br><span class="line">kubesphere&#x2F;kube-events-ruler:v0.2.0</span><br><span class="line">kubesphere&#x2F;log-sidecar-injector:1.1</span><br><span class="line">docker:19.03</span><br><span class="line">##istio-images</span><br><span class="line">istio&#x2F;pilot:1.6.10</span><br><span class="line">istio&#x2F;proxyv2:1.6.10</span><br><span class="line">jaegertracing&#x2F;jaeger-agent:1.17</span><br><span class="line">jaegertracing&#x2F;jaeger-collector:1.17</span><br><span class="line">jaegertracing&#x2F;jaeger-es-index-cleaner:1.17</span><br><span class="line">jaegertracing&#x2F;jaeger-operator:1.17.1</span><br><span class="line">jaegertracing&#x2F;jaeger-query:1.17</span><br><span class="line">kubesphere&#x2F;kiali:v1.26.1</span><br><span class="line">kubesphere&#x2F;kiali-operator:v1.26.1</span><br><span class="line">##kubesphere-devops-images</span><br><span class="line">kubesphere&#x2F;ks-jenkins:2.249.1</span><br><span class="line">jenkins&#x2F;jnlp-slave:3.27-1</span><br><span class="line">kubesphere&#x2F;s2ioperator:v3.1.0</span><br><span class="line">kubesphere&#x2F;s2irun:v2.1.1</span><br><span class="line">kubesphere&#x2F;builder-base:v3.1.0</span><br><span class="line">kubesphere&#x2F;builder-nodejs:v3.1.0</span><br><span class="line">kubesphere&#x2F;builder-maven:v3.1.0</span><br><span class="line">kubesphere&#x2F;builder-go:v3.1.0</span><br><span class="line">kubesphere&#x2F;s2i-binary:v2.1.0</span><br><span class="line">kubesphere&#x2F;tomcat85-java11-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;tomcat85-java11-runtime:v2.1.0</span><br><span class="line">kubesphere&#x2F;tomcat85-java8-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;tomcat85-java8-runtime:v2.1.0</span><br><span class="line">kubesphere&#x2F;java-11-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;java-8-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;java-8-runtime:v2.1.0</span><br><span class="line">kubesphere&#x2F;java-11-runtime:v2.1.0</span><br><span class="line">kubesphere&#x2F;nodejs-8-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;nodejs-6-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;nodejs-4-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;python-36-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;python-35-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;python-34-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;python-27-centos7:v2.1.0</span><br><span class="line">##openpitrix-images</span><br><span class="line">kubespheredev&#x2F;openpitrix-jobs:v3.1.1</span><br><span class="line">##weave-scope-images</span><br><span class="line">weaveworks&#x2F;scope:1.13.0</span><br><span class="line">##kubeedge-images</span><br><span class="line">kubeedge&#x2F;cloudcore:v1.6.2</span><br><span class="line">kubesphere&#x2F;edge-watcher:v0.1.0</span><br><span class="line">kubesphere&#x2F;kube-rbac-proxy:v0.5.0</span><br><span class="line">kubesphere&#x2F;edge-watcher-agent:v0.1.0</span><br><span class="line">##example-images-images</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-productpage-v1:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-reviews-v1:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-reviews-v2:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-reviews-v3:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-details-v1:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-ratings-v1:1.16.3</span><br><span class="line">busybox:1.31.1</span><br><span class="line">joosthofman&#x2F;wget:1.0</span><br><span class="line">kubesphere&#x2F;netshoot:v1.0</span><br><span class="line">nginxdemos&#x2F;hello:plain-text</span><br><span class="line">wordpress:4.8-apache</span><br><span class="line">mirrorgooglecontainers&#x2F;hpa-example:latest</span><br><span class="line">java:openjdk-8-jre-alpine</span><br><span class="line">fluent&#x2F;fluentd:v1.4.2-2.0</span><br><span class="line">perl:latest</span><br></pre></td></tr></table></figure><ul><li>sync.sh</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">GREEN_COL=<span class="string">"\\033[32;1m"</span></span><br><span class="line">RED_COL=<span class="string">"\\033[1;31m"</span></span><br><span class="line">NORMAL_COL=<span class="string">"\\033[0;39m"</span></span><br><span class="line">SOURCE_REGISTRY=<span class="variable">$1</span></span><br><span class="line">TARGET_REGISTRY=<span class="variable">$2</span></span><br><span class="line">: <span class="variable">$&#123;IMAGES_LIST_FILE:="images-list.txt"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;TARGET_REGISTRY:="hub.k8s.li"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;SOURCE_REGISTRY:="docker.io"&#125;</span></span><br><span class="line"></span><br><span class="line">BLOBS_PATH=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">REPO_PATH=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line"></span><br><span class="line">CURRENT_NUM=0</span><br><span class="line">ALL_IMAGES=<span class="string">"<span class="variable">$(sed -n '/#/d;s/:/:/p' $&#123;IMAGES_LIST_FILE&#125; | sort -u)</span>"</span></span><br><span class="line">TOTAL_NUMS=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;ALL_IMAGES&#125;</span>"</span> | wc -l)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">skopeo_copy</span></span>() &#123;</span><br><span class="line"> <span class="keyword">if</span> skopeo copy --insecure-policy --src-tls-verify=<span class="literal">false</span> --dest-tls-verify=<span class="literal">false</span> \</span><br><span class="line"> --override-arch amd64 --override-os linux -q docker://<span class="variable">$1</span> docker://<span class="variable">$2</span>; <span class="keyword">then</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$GREEN_COL</span> Progress: <span class="variable">$&#123;CURRENT_NUM&#125;</span>/<span class="variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="variable">$1</span> to <span class="variable">$2</span> successful <span class="variable">$NORMAL_COL</span>"</span></span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$RED_COL</span> Progress: <span class="variable">$&#123;CURRENT_NUM&#125;</span>/<span class="variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="variable">$1</span> to <span class="variable">$2</span> failed <span class="variable">$NORMAL_COL</span>"</span></span><br><span class="line"> <span class="built_in">exit</span> 2</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> <span class="variable">$&#123;ALL_IMAGES&#125;</span>; <span class="keyword">do</span></span><br><span class="line"> <span class="built_in">let</span> CURRENT_NUM=<span class="variable">$&#123;CURRENT_NUM&#125;</span>+1</span><br><span class="line"> skopeo_copy <span class="variable">$&#123;SOURCE_REGISTRY&#125;</span>/<span class="variable">$&#123;image&#125;</span> <span class="variable">$&#123;TARGET_REGISTRY&#125;</span>/<span class="variable">$&#123;image&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li><code>bash sync.sh docker.io ``localhost:5000</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ bash sync.sh docker.io localhost:5000</span><br><span class="line">Progress: 1/143 sync docker.io/alpine:3.14 to localhost:5000/alpine:3.14 successful</span><br><span class="line">Progress: 2/143 sync docker.io/busybox:1.31.1 to localhost:5000/busybox:1.31.1 successful</span><br><span class="line">Progress: 3/143 sync docker.io/calico/cni:v3.16.3 to localhost:5000/calico/cni:v3.16.3 successful</span><br><span class="line">Progress: 4/143 sync docker.io/calico/kube-controllers:v3.16.3 to localhost:5000/calico/kube-controllers:v3.16.3 successful</span><br><span class="line">Progress: 141/143 sync docker.io/thanosio/thanos:v0.18.0 to localhost:5000/thanosio/thanos:v0.18.0 successful</span><br><span class="line">Progress: 142/143 sync docker.io/weaveworks/scope:1.13.0 to localhost:5000/weaveworks/scope:1.13.0 successful</span><br><span class="line">Progress: 143/143 sync docker.io/wordpress:4.8-apache to localhost:5000/wordpress:4.8-apache successful</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨-registry-å­˜å‚¨ç‰¹æ€§"><a href="#ä½¿ç”¨-registry-å­˜å‚¨ç‰¹æ€§" class="headerlink" title="ä½¿ç”¨ registry å­˜å‚¨ç‰¹æ€§"></a>ä½¿ç”¨ registry å­˜å‚¨ç‰¹æ€§</h3><p>å°†é•œåƒä» registry ä¸­åŒæ­¥åˆ°æœ¬åœ°ç›®å½•ï¼Œä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§ï¼Œå°†æœ¬åœ°ç›®å½•ä¸­çš„é•œåƒè½¬æ¢æˆ registry å­˜å‚¨çš„æ ¼å¼ã€‚è¿™æ ·å­çš„å¥½å¤„å°±æ˜¯å¯ä»¥å»é™¤ä¸€äº› skopeo dir ä¸­é‡å¤çš„ layersï¼Œå‡å°‘é•œåƒçš„æ€»å¤§å°ã€‚å…·ä½“çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™è¿‡çš„ ã€Š<a href="https://blog.k8s.li/skopeo-to-registry.html">å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</a>ã€‹</p><ul><li>sync.sh</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">GREEN_COL=<span class="string">"\\033[32;1m"</span></span><br><span class="line">RED_COL=<span class="string">"\\033[1;31m"</span></span><br><span class="line">NORMAL_COL=<span class="string">"\\033[0;39m"</span></span><br><span class="line">SOURCE_REGISTRY=<span class="variable">$1</span></span><br><span class="line">TARGET_REGISTRY=<span class="variable">$2</span></span><br><span class="line">IMAGES_DIR=<span class="variable">$2</span></span><br><span class="line">: <span class="variable">$&#123;IMAGES_DIR:="images"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;IMAGES_LIST_FILE:="images-list.txt"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;TARGET_REGISTRY:="hub.k8s.li"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;SOURCE_REGISTRY:="docker.io"&#125;</span></span><br><span class="line">BLOBS_PATH=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">REPO_PATH=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line">CURRENT_NUM=0</span><br><span class="line">ALL_IMAGES=<span class="string">"<span class="variable">$(sed -n '/#/d;s/:/:/p' $&#123;IMAGES_LIST_FILE&#125; | sort -u)</span>"</span></span><br><span class="line">TOTAL_NUMS=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;ALL_IMAGES&#125;</span>"</span> | wc -l)</span><br><span class="line"><span class="function"><span class="title">skopeo_sync</span></span>() &#123;</span><br><span class="line"> <span class="keyword">if</span> skopeo sync --insecure-policy --src-tls-verify=<span class="literal">false</span> --dest-tls-verify=<span class="literal">false</span> \</span><br><span class="line"> --override-arch amd64 --override-os linux --src docker --dest dir <span class="variable">$1</span> <span class="variable">$2</span> &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$GREEN_COL</span> Progress: <span class="variable">$&#123;CURRENT_NUM&#125;</span>/<span class="variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="variable">$1</span> to <span class="variable">$2</span> successful <span class="variable">$NORMAL_COL</span>"</span></span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$RED_COL</span> Progress: <span class="variable">$&#123;CURRENT_NUM&#125;</span>/<span class="variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="variable">$1</span> to <span class="variable">$2</span> failed <span class="variable">$NORMAL_COL</span>"</span></span><br><span class="line"> <span class="built_in">exit</span> 2</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">convert_images</span></span>() &#123;</span><br><span class="line"> rm -rf <span class="variable">$&#123;IMAGES_DIR&#125;</span>; mkdir -p <span class="variable">$&#123;IMAGES_DIR&#125;</span></span><br><span class="line"> <span class="keyword">for</span> image <span class="keyword">in</span> <span class="variable">$&#123;ALL_IMAGES&#125;</span>; <span class="keyword">do</span></span><br><span class="line"> <span class="built_in">let</span> CURRENT_NUM=<span class="variable">$&#123;CURRENT_NUM&#125;</span>+1</span><br><span class="line"> image_name=<span class="variable">$&#123;image%%:*&#125;</span></span><br><span class="line"> image_tag=<span class="variable">$&#123;image##*:&#125;</span></span><br><span class="line"> image_repo=<span class="variable">$&#123;image%%/*&#125;</span></span><br><span class="line"> skopeo_sync <span class="variable">$&#123;SOURCE_REGISTRY&#125;</span>/<span class="variable">$&#123;image&#125;</span> <span class="variable">$&#123;IMAGES_DIR&#125;</span>/<span class="variable">$&#123;image_repo&#125;</span></span><br><span class="line"> manifest=<span class="string">"<span class="variable">$&#123;IMAGES_DIR&#125;</span>/<span class="variable">$&#123;image&#125;</span>/manifest.json"</span></span><br><span class="line"> manifest_sha256=$(sha256sum <span class="variable">$&#123;manifest&#125;</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line"> mkdir -p <span class="variable">$&#123;BLOBS_PATH&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line"> ln -f <span class="variable">$&#123;manifest&#125;</span> <span class="variable">$&#123;BLOBS_PATH&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span>/data</span><br><span class="line"> <span class="comment"># make image repositories dir</span></span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/&#123;_uploads,_layers,_manifests&#125;</span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/&#123;current,index/sha256&#125;</span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line"> <span class="comment"># create image tag manifest link file</span></span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/current/link</span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br><span class="line"> <span class="comment"># link image layers file to registry blobs dir</span></span><br><span class="line"> <span class="keyword">for</span> layer <span class="keyword">in</span> $(sed <span class="string">'/v1Compatibility/d'</span> <span class="variable">$&#123;manifest&#125;</span> | grep -Eo <span class="string">"\b[a-f0-9]&#123;64&#125;\b"</span>); <span class="keyword">do</span></span><br><span class="line"> mkdir -p <span class="variable">$&#123;BLOBS_PATH&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;layer&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span>/link</span><br><span class="line"> ln -f <span class="variable">$&#123;IMAGES_DIR&#125;</span>/<span class="variable">$&#123;image&#125;</span>/<span class="variable">$&#123;layer&#125;</span> <span class="variable">$&#123;BLOBS_PATH&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data</span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">convert_images</span><br></pre></td></tr></table></figure><ul><li>install.sh</li></ul><p>ä½¿ç”¨è¿™ä¸ªè„šæœ¬å°† registry å­˜å‚¨ä¸­çš„é•œåƒè½¬æ¢æˆ skopeo dir çš„æ–¹å¼ï¼Œç„¶åå†å°†é•œåƒåŒæ­¥åˆ° registry ä¸­ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">REGISTRY_DOMAIN=<span class="string">"harbor.k8s.li"</span></span><br><span class="line">REGISTRY_PATH=<span class="string">"/var/lib/registry"</span></span><br><span class="line"><span class="comment"># åˆ‡æ¢åˆ° registry å­˜å‚¨ä¸»ç›®å½•ä¸‹</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;REGISTRY_PATH&#125;</span></span><br><span class="line"><span class="function"><span class="title">gen_skopeo_dir</span></span>() &#123;</span><br><span class="line">   <span class="comment"># å®šä¹‰ registry å­˜å‚¨çš„ blob ç›®å½• å’Œ repositories ç›®å½•ï¼Œæ–¹ä¾¿åé¢ä½¿ç”¨</span></span><br><span class="line">    BLOB_DIR=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">    REPO_DIR=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line">    <span class="comment"># å®šä¹‰ç”Ÿæˆ skopeo ç›®å½•</span></span><br><span class="line">    SKOPEO_DIR=<span class="string">"docker/skopeo"</span></span><br><span class="line">    <span class="comment"># é€šè¿‡ find å‡º current æ–‡ä»¶å¤¹å¯ä»¥å¾—åˆ°æ‰€æœ‰å¸¦ tag çš„é•œåƒï¼Œå› ä¸ºä¸€ä¸ª tag å¯¹åº”ä¸€ä¸ª current ç›®å½•</span></span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> $(find <span class="variable">$&#123;REPO_DIR&#125;</span> -<span class="built_in">type</span> d -name <span class="string">"current"</span>); <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># æ ¹æ®é•œåƒçš„ tag æå–é•œåƒçš„åå­—</span></span><br><span class="line">        name=$(<span class="built_in">echo</span> <span class="variable">$&#123;image&#125;</span> | awk -F <span class="string">'/'</span> <span class="string">'&#123;print $5"/"$6":"$9&#125;'</span>)</span><br><span class="line">        link=$(cat <span class="variable">$&#123;image&#125;</span>/link | sed <span class="string">'s/sha256://'</span>)</span><br><span class="line">        mfs=<span class="string">"<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;link:0:2&#125;</span>/<span class="variable">$&#123;link&#125;</span>/data"</span></span><br><span class="line">        <span class="comment"># åˆ›å»ºé•œåƒçš„ç¡¬é“¾æ¥éœ€è¦çš„ç›®å½•</span></span><br><span class="line">        mkdir -p <span class="string">"<span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>"</span></span><br><span class="line">        <span class="comment"># ç¡¬é“¾æ¥é•œåƒçš„ manifests æ–‡ä»¶åˆ°ç›®å½•çš„ manifest æ–‡ä»¶</span></span><br><span class="line">        ln <span class="variable">$&#123;mfs&#125;</span> <span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>/manifest.json</span><br><span class="line">        <span class="comment"># ä½¿ç”¨æ­£åˆ™åŒ¹é…å‡ºæ‰€æœ‰çš„ sha256 å€¼ï¼Œç„¶åæ’åºå»é‡</span></span><br><span class="line">        layers=$(grep -Eo <span class="string">"\b[a-f0-9]&#123;64&#125;\b"</span> <span class="variable">$&#123;mfs&#125;</span> | sort -n | uniq)</span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> <span class="variable">$&#123;layers&#125;</span>; <span class="keyword">do</span></span><br><span class="line">          <span class="comment"># ç¡¬é“¾æ¥ registry å­˜å‚¨ç›®å½•é‡Œçš„é•œåƒ layer å’Œ images config åˆ°é•œåƒçš„ dir ç›®å½•</span></span><br><span class="line">            ln <span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data <span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">sync_image</span></span>() &#123;</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ skopeo sync å°† dir æ ¼å¼çš„é•œåƒåŒæ­¥åˆ° harbor</span></span><br><span class="line">    <span class="keyword">for</span> project <span class="keyword">in</span> $(ls <span class="variable">$&#123;SKOPEO_DIR&#125;</span>); <span class="keyword">do</span></span><br><span class="line">        skopeo sync --insecure-policy --src-tls-verify=<span class="literal">false</span> --dest-tls-verify=<span class="literal">false</span> \</span><br><span class="line">        --src dir --dest docker <span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;project&#125;</span> <span class="variable">$&#123;REGISTRY_DOMAIN&#125;</span>/<span class="variable">$&#123;project&#125;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line">gen_skopeo_dir</span><br></pre></td></tr></table></figure><h3 id="ä»-registry-å­˜å‚¨ä¸­-select-å‡ºé•œåƒ"><a href="#ä»-registry-å­˜å‚¨ä¸­-select-å‡ºé•œåƒ" class="headerlink" title="ä» registry å­˜å‚¨ä¸­ select å‡ºé•œåƒ"></a>ä» registry å­˜å‚¨ä¸­ select å‡ºé•œåƒ</h3><p>å…ˆå°†é•œåƒåŒæ­¥åˆ°ä¸€ä¸ª registry ä¸­ï¼Œå†å°†é•œåƒä» registry å­˜å‚¨ä¸­æå‡ºæ¥ã€‚è¿™ä¸ª registry å¯ä»¥å½“ä½œä¸€ä¸ªé•œåƒå­˜å‚¨çš„æ± å­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Linux ä¸­ç¡¬é“¾æ¥çš„ç‰¹æ€§å°†é•œåƒ<code>&quot;å¤åˆ¶&quot;</code>ä¸€ä»½å‡ºæ¥ï¼Œç„¶åå†æ‰“ä¸€ä¸ª tar åŒ…ã€‚è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯æ¯æ¬¡æ‰“åŒ…é•œåƒçš„æ—¶å€™éƒ½èƒ½å¤ç”¨å†å²çš„é•œåƒæ•°æ®ï¼Œè€Œä¸”æ€§èƒ½æå¿«ã€‚å…·ä½“çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„åšå®¢ã€Š<a href="https://blog.k8s.li/select-registry-images.html">ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼</a>ã€‹</p><ul><li>å…ˆå°†é•œåƒåŒæ­¥åˆ°ä¸€ä¸ªå›ºå®šçš„ registry ä¸­</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bash sync.sh docker.io localhost:5000</span><br></pre></td></tr></table></figure><ul><li>å†ä½¿ç”¨è¯¥è„šæœ¬å°†é•œåƒä» registry å­˜å‚¨ä¸­æå‡ºæ¥</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line">IMAGES_LIST=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">REGISTRY_PATH=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">OUTPUT_DIR=<span class="string">"<span class="variable">$3</span>"</span></span><br><span class="line">BLOB_DIR=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">REPO_DIR=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line">rm -rf <span class="variable">$&#123;OUTPUT_DIR&#125;</span>; mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span></span><br><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> $(find <span class="variable">$&#123;IMAGES_LIST&#125;</span> -<span class="built_in">type</span> f -name <span class="string">"*.list"</span> | xargs grep -Ev <span class="string">'^#|^/'</span> | grep <span class="string">':'</span>); <span class="keyword">do</span></span><br><span class="line">    image_tag=<span class="variable">$&#123;image##*:&#125;</span></span><br><span class="line">    image_name=<span class="variable">$&#123;image%%:*&#125;</span></span><br><span class="line">    tag_link=<span class="variable">$&#123;REGISTRY_PATH&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/current/link</span><br><span class="line">    manifest_sha256=$(sed <span class="string">'s/sha256://'</span> <span class="variable">$&#123;tag_link&#125;</span>)</span><br><span class="line">    manifest=<span class="variable">$&#123;REGISTRY_PATH&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span>/data</span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line">    ln -f <span class="variable">$&#123;manifest&#125;</span> <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span>/data</span><br><span class="line">    <span class="comment"># make image repositories dir</span></span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/&#123;_uploads,_layers,_manifests&#125;</span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/&#123;current,index/sha256&#125;</span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line">    <span class="comment"># create image tag manifest link file</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/current/link</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br><span class="line">    <span class="keyword">for</span> layer <span class="keyword">in</span> $(sed <span class="string">'/v1Compatibility/d'</span> <span class="variable">$&#123;manifest&#125;</span> | grep -Eo <span class="string">'\b[a-f0-9]&#123;64&#125;\b'</span> | sort -u); <span class="keyword">do</span></span><br><span class="line">        mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">        mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">        ln -f <span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;layer&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span>/link</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="å»¶ä¼¸é˜…è¯»"><a href="#å»¶ä¼¸é˜…è¯»" class="headerlink" title="å»¶ä¼¸é˜…è¯»"></a>å»¶ä¼¸é˜…è¯»</h2><ul><li><a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”ŸğŸ¤”</a></li><li><a href="https://blog.k8s.li/registry-gc.html">docker registry GC åŸç†åˆ†æ</a></li><li><a href="https://blog.k8s.li/docker-registry-to-harbor.html">docker registry è¿ç§»è‡³ harbor</a></li><li><a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 åœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­çš„åº”ç”¨</a></li><li><a href="https://blog.k8s.li/skopeo-to-registry.html">å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</a></li><li><a href="https://blog.k8s.li/select-registry-images.html">ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;æ¬ç –å·¥å…·&quot;&gt;&lt;a href=&quot;#æ¬ç –å·¥å…·&quot;
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="registry" scheme="https://blog.k8s.li/tags/registry/"/>
    
      <category term="é•œåƒ" scheme="https://blog.k8s.li/tags/%E9%95%9C%E5%83%8F/"/>
    
      <category term="skopeo" scheme="https://blog.k8s.li/tags/skopeo/"/>
    
  </entry>
  
  <entry>
    <title>äº‘åŸç”Ÿ PaaS äº§å“å‘å¸ƒ&amp;éƒ¨ç½²æ–¹æ¡ˆ</title>
    <link href="https://blog.k8s.li/pass-platform-release.html"/>
    <id>https://blog.k8s.li/pass-platform-release.html</id>
    <published>2021-06-09T16:00:00.000Z</published>
    <updated>2021-06-09T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>å¯¹äºä¸€æ¬¾åŸºäº kubernetes çš„å®¹å™¨äº‘å¹³å°æ¥è®²ï¼Œå®ƒéœ€è¦ç»™ç”¨æˆ·æä¾›èµ„æºè°ƒåº¦ã€æœåŠ¡ç¼–æ’ã€åº”ç”¨éƒ¨ç½²ã€ç›‘æ§æ—¥å¿—ã€é…ç½®ç®¡ç†ã€é•œåƒæ„å»ºã€CI/CDã€å­˜å‚¨å’Œç½‘ç»œç®¡ç†ç­‰åŠŸèƒ½ã€‚ä¸€ä¸ª PaaS äº§å“æƒ³è¦å®ç°è¿™äº›é¢é¢ä¿±å…¨çš„åŠŸèƒ½å¹¶ä¸æ˜¯ä¸€ä»¶è½»æ¾çš„äº‹å„¿ã€‚ä»è½¯ä»¶ç ”å‘æµç¨‹ä¸Šæ¥è®²ï¼Œä¸åŒäºä¼ ç»Ÿçš„å•ä½“åº”ç”¨æˆ–å®¢æˆ·ç«¯åº”ç”¨ï¼Œå®¹å™¨äº‘å¹³å°æœ¬ä»åº•å±‚çš„ Kubernetes é›†ç¾¤éƒ¨ç½²åˆ°ä¸Šå±‚çš„ç”¨æˆ·åº”ç”¨éƒ¨ç½²ï¼Œæ‰€æ¶‰åŠåˆ°çš„æŠ€æœ¯æ ˆååˆ†å¤æ‚ï¼Œæœ€ç»ˆå¯¼è‡´å¹³å°çš„å¼€å‘æµç¨‹å˜å¾—ååˆ†ç¹çã€‚</p><p>å½“ç„¶ä¸šç•Œä¹Ÿæœ‰ä¸€äº›ä¸»æµè§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚å¹³å°ç»„ä»¶å®¹å™¨åŒ–éƒ¨ç½²ï¼Œä»¥åŠä½¿ç”¨å¾®æœåŠ¡æ¶æ„å°†å¹³å°æ‹†åˆ†æˆè‹¥å¹²ä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼Œæ¯”å¦‚ç›‘æ§å‘Šè­¦æ¨¡å—ã€åº”ç”¨ç®¡ç†æ¨¡å—ã€å¤šé›†ç¾¤ç®¡ç†æ¨¡å—ç­‰ç­‰ã€‚ä½¿ç”¨å¾®æœåŠ¡æ¶æ„å¯ä»¥è§£å†³å®¹å™¨äº‘å¹³å°æœ¬èº«çš„å¤æ‚æ€§ï¼Œå°†å¹³å°æ‹†åˆ†æˆå•ç‹¬çš„æ¨¡å—è¿›è¡Œç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²ï¼Œè¿™æ ·å¯ä»¥è®©æŸä¸€ç‰¹å®šçš„å›¢é˜Ÿä¸“é—¨è´Ÿè´£è¯¥æ¨¡å—çš„å¼€å‘ã€‚</p><p>è€Œä½¿ç”¨å¾®æœåŠ¡æ¶æ„ä¹‹åï¼Œä¹Ÿå¼•å…¥äº†æ–°çš„é—®é¢˜ï¼šç»„ä»¶æ•°é‡å¤šäº†ã€å¯¹åº”æ¨¡å—å¼€å‘äººå‘˜å¤šäº†ã€äº§å“ä»£ç ä»“åº“å¤šäº†ã€ç»„ä»¶é•œåƒå¤šäº†ã€éƒ¨ç½²å˜å¾—å¤æ‚äº†ç­‰ã€‚ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­å°±æ˜¯ <a href="https://github.com/kubesphere/ks-installer" target="_blank" rel="noopener">ks-installer</a>  è¿™ä¸ªå¼€æºé¡¹ç›®ï¼Œé‡Œé¢åŒ…å«äº† 20 å¤šä¸ªç»„ä»¶å’Œ 140 å¤šä¸ªå®¹å™¨é•œåƒã€‚æƒ³è¦ç®¡ç†è¿™ä¹ˆå¤šçš„ç»„ä»¶å’Œé•œåƒç»éæ˜“äº‹å„¿ï¼Œä¸ªäººè®¤ä¸ºè¿™éœ€è¦ä»äº§å“å‘å¸ƒå’Œå¹³å°éƒ¨ç½²ä¸¤ä¸ªç»´åº¦å»è§£å†³ä¼—å¤šç»„ä»¶ç®¡ç†çš„éš¾é¢˜ï¼Œå› æ­¤æœ¬æ–‡å°±æ¢³ç†äº†ä¸ªäººåœ¨ PaaS å®¹å™¨äº‘å¹³å°äº§å“å‘å¸ƒå’Œéƒ¨ç½²æ–¹é¢çš„ä¸€äº›ç»éªŒæ€»ç»“ã€‚</p><h2 id="æœ¯è¯­å®šä¹‰"><a href="#æœ¯è¯­å®šä¹‰" class="headerlink" title="æœ¯è¯­å®šä¹‰"></a>æœ¯è¯­å®šä¹‰</h2><p>æœ¬æ–‡ä¸­ä¼šæœ‰ä¸€äº›ä¸“ä¸šæœ¯è¯­ï¼Œåœ¨è¿™å…ˆè§£é‡Šä¸€ä¸‹ï¼š</p><table><thead><tr><th><strong>æœ¯è¯­</strong></th><th>å®šä¹‰</th></tr></thead><tbody><tr><td>Platform/å¹³å°</td><td>å³å¹³å°ï¼Œæœ¬æ–‡æŒ‡åŸºäº kubernetes çš„ PaaS å®¹å™¨äº‘å¹³å°</td></tr><tr><td>Addon/ç»„ä»¶</td><td>æŸä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸€ä¸ª PaaS å®¹å™¨äº‘å¹³å°ç”±å¤šä¸ªç»„ä»¶æ„æˆ</td></tr><tr><td>Chart/Charts</td><td>æŒ‡ä¸€ä¸ªæˆ–å¤šä¸ª Helm Chartï¼Œé‡Œé¢åŒ…å«å®šä¹‰ç»„ä»¶éƒ¨ç½²æ‰€éœ€è¦çš„ manifests æ–‡ä»¶</td></tr><tr><td>Helm</td><td>éƒ¨ç½²ç»„ä»¶ Charts æ‰€ä½¿ç”¨çš„å‘½ä»¤è¡Œå·¥å…·</td></tr><tr><td>Release/å‘å¸ƒ</td><td>æ”¶é›†äº§å“æ‰€åŒ…å«æ‰€æœ‰ç»„ä»¶çš„éƒ¨ç½²éœ€è¦çš„æ–‡ä»¶å’Œé•œåƒåˆ—è¡¨åˆ° git repo</td></tr><tr><td>Package/æ‰“åŒ…</td><td>æ ¹æ®å‘å¸ƒæµç¨‹ä¸­æ”¶é›†è¿‡æ¥çš„éƒ¨ç½²æ–‡ä»¶å’Œé•œåƒåˆ—è¡¨å°†å®ƒä»¬æ‰“åŒ…æˆç¦»çº¿å®‰è£…åŒ…</td></tr><tr><td>helm-controller</td><td>åŸºäº Helm å¼€å‘çš„æ§åˆ¶å™¨ï¼Œç”¨äºéƒ¨ç½²å¹³å°ç»„ä»¶</td></tr><tr><td>æ ‡å‡†äº§å“</td><td>æŒ‡ PaaS å®¹å™¨äº‘å¹³å°æœ¬èº«ï¼Œæ— ä»»ä½•å®šåˆ¶åŒ–å¼€å‘</td></tr><tr><td>OEM äº§å“</td><td>åŸºäºæ ‡å‡†äº§å“äºŒæ¬¡å¼€å‘æˆ–ä½¿ç”¨ OEM è¡¥ä¸åŒ…å®šåˆ¶åŒ–å¼€å‘çš„äºŒå¼€äº§å“</td></tr><tr><td>Jenkins æµæ°´çº¿</td><td>Release è‡ªåŠ¨åŒ–æ‰“åŒ…å‘å¸ƒäº§å“åŒ…ä½¿ç”¨çš„å·¥å…·</td></tr><tr><td>platform-release</td><td>äº§å“å‘å¸ƒä¸“ç”¨çš„ git repoï¼Œæ”¶é›†å’Œç®¡ç†å„ä¸ªç»„ä»¶å‘å¸ƒç›¸å…³çš„é…ç½®</td></tr><tr><td>PR/MR</td><td>Pull Request / Merge Request</td></tr></tbody></table><h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>å¯¹äºä¸€ä¸ªåŸºäº kubernetes çš„ PaaS å¹³å°æ¥è®²ï¼Œæ•´ä¸ªå¹³å°çš„éƒ¨ç½²å¯ä»¥å¤§è‡´åˆ’åˆ†ä¸ºå¹³å°åº•å±‚çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å’Œå¹³å°ç»„ä»¶çš„éƒ¨ç½²è¿™ä¸¤éƒ¨åˆ†ã€‚æ¯”å¦‚ Kubesphere 3.x è¿™ä¸ªäº§å“ï¼Œkubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·æ˜¯ä½¿ç”¨ Golang å¼€å‘çš„  <a href="https://github.com/kubesphere/kubekey" target="_blank" rel="noopener">kubekey</a>ï¼Œå¹³å°ç»„ä»¶éƒ¨ç½²å·¥å…·æ˜¯ä½¿ç”¨ Ansible å¼€å‘çš„ <a href="https://github.com/kubesphere/ks-installer" target="_blank" rel="noopener">ks-installer</a>ã€‚</p><p>ä¸ªäººè®¤ä¸º Kubesphere çš„éƒ¨ç½²æµç¨‹æ˜¯æ¯”è¾ƒåˆç†çš„ã€‚å¹³å°åº•å±‚çš„ Kubernetes é›†ç¾¤éƒ¨ç½²åšçš„å¾ˆç®€å•ï¼ˆä¸€ä¸ªäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ï¼Œå¹³å°ç»„ä»¶éƒ¨ç½²å·¥å…·ä¾èµ–çš„ä¹Ÿä»…ä»…æ˜¯ä¸€ä¸ªå·²ç»éƒ¨ç½²å¥½çš„ Kubernetes é›†ç¾¤å’Œä¸€ä¸ªå­˜å‚¨ StorageClassã€‚è¿™æ ·å°±å¯ä»¥å®ç°å¹³å°ç»„ä»¶çš„éƒ¨ç½²ä¸åº•å±‚ Kubernetes é›†ç¾¤éƒ¨ç½²çš„è§£è€¦ï¼Œä½¿å¾—å¹³å°ç»„ä»¶å¯ä»¥éƒ¨ç½²åœ¨ä¸€ä¸ªå·²ç»éƒ¨ç½²å¥½çš„ kubernetes é›†ç¾¤ä¸­ï¼Œæ¯”å¦‚ AKSã€‚åŒæ—¶å¯¹äºç”¨æˆ·æ¥è®²ï¼Œå¹³å°ç»„ä»¶çš„éƒ¨ç½²ä¹Ÿå˜å¾—ååˆ†ç®€å•ï¼Œåªéœ€è¦å‡ æ¡ kubectl å‘½ä»¤å°±èƒ½è½»æ¾å®Œæˆã€‚</p><p>å› æ­¤åœ¨è®¾è®¡éƒ¨ç½²æ–¹æ¡ˆæ—¶ï¼Œç»“åˆå®¢æˆ·çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯¹éƒ¨ç½²æ–¹æ¡ˆåšå‡ºå¦‚ä¸‹å‡ ç‚¹è¦æ±‚ï¼š</p><ul><li>éœ€è¦åšåˆ°ç¦»çº¿éƒ¨ç½²ï¼Œå³ç§æœ‰åŒ–éƒ¨ç½²æ—¶ä¸èƒ½ä¾èµ–ä»»ä½•åœ¨çº¿çš„èµ„æºï¼›</li><li>å¹³å°åº•å±‚ Kubernetes é›†ç¾¤éƒ¨ç½²ä¸å¹³å°ç»„ä»¶éƒ¨ç½²è¿›è¡Œè§£è€¦ï¼›</li><li>å¹³å°ç»„ä»¶éƒ¨ç½²ä»…ä»…ä¾èµ–äºä¸€ä¸ªå·²ç»éƒ¨ç½²å¥½çš„ Kubernetes é›†ç¾¤å’Œå­˜å‚¨ StorageClassï¼›</li><li>å¹³å°ç»„ä»¶éƒ¨ç½²çš„æ–¹å¼åšåˆ°ç»Ÿä¸€ï¼Œæ¯”å¦‚ Helm Chart éƒ¨ç½²ï¼›</li><li>å°½é‡å°†ä¸Šå±‚çš„ç»„ä»¶æ”¾åˆ°å¹³å°ç»„ä»¶é‡Œï¼Œä¸è¦æ”¾åœ¨ Kubernetes é›†ç¾¤éƒ¨ç½²ä¸­ï¼Œæ¯”å¦‚è´Ÿè½½å‡è¡¡å™¨ã€æŒä¹…åŒ–å­˜å‚¨ã€é•œåƒä»“åº“ç­‰ï¼›</li></ul><p>ä¸ºäº†æ»¡è¶³ä»¥ä¸Šå‡ ç‚¹éƒ¨ç½²çš„éœ€æ±‚ï¼Œæˆ‘ä»¬åˆå°†æ•´ä¸ªå¹³å°çš„éƒ¨ç½²æ‹†åˆ†æˆä¸‰éƒ¨åˆ†ï¼Œåœ¨äº§å“å‘å¸ƒçš„æ—¶å€™ä¼šä½¿ç”¨ Jenkins æµæ°´çº¿è‡ªåŠ¨åŒ–æ„å»ºå‡ºå¯¹åº”çš„ç¦»çº¿å®‰è£…åŒ…ï¼š</p><ul><li>offline-resourcesï¼šéƒ¨ç½² nginx æœåŠ¡å’Œé•œåƒä»“åº“æœåŠ¡ç”¨äºæä¾›ç¦»çº¿å®‰è£…ä¾èµ–çš„æ‰€æœ‰èµ„æºï¼›</li><li>Kubernetesï¼šåŸºäº Kubespray ä½¿ç”¨ offline-resources æä¾›çš„èµ„æºéƒ¨ç½² Kubernetes é›†ç¾¤ï¼›</li><li>platformï¼šåœ¨ Kubernetes é›†ç¾¤ä¹‹ä¸Šéƒ¨ç½²æˆ‘ä»¬çš„ PaaS å®¹å™¨äº‘å¹³å°ï¼›</li></ul><p>Kubernetes é›†ç¾¤éƒ¨ç½²å’Œå¹³å°éƒ¨ç½²æ˜¯ç›¸äº’åˆ†å¼€çš„ï¼Œä¸¤è€…åœ¨éƒ¨ç½²çš„å±‚é¢å°½é‡åœ°åšåˆ°äº†è§£è€¦ï¼Œå‘å¸ƒçš„æ—¶å€™ä¹Ÿåšåˆ°äº†è§£è€¦ï¼Œè¿™æ ·å°±å¯ä»¥é¿å… K8s éƒ¨ç½²å·¥å…·é‡Œæ›´æ–°ä¸€ä¸ªé•œåƒè€Œåˆè¦å°†å¹³å°å®‰è£…åŒ…è·Ÿç€ä¸€èµ·æ›´æ–°çš„æƒ…å†µã€‚</p><p>ä¸¤è€…å¯ä»¥ä½œä¸ºç‹¬ç«‹çš„äº§å“è¿›è¡Œäº¤ä»˜ï¼Œè€Œæ²¡æœ‰å’Œæˆ‘ä»¬çš„ PaaS å¹³å°ç»‘å®šåœ¨ä¸€èµ·ã€‚å› ä¸ºå…¬å¸å†…çš„å…¶ä»–å›¢é˜Ÿä¹Ÿæœ‰ K8s é›†ç¾¤éƒ¨ç½²çš„éœ€æ±‚ï¼Œè¿™æ ·ä¹Ÿèƒ½å°†æˆ‘ä»¬çš„ K8s é›†ç¾¤éƒ¨ç½²å·¥å…·å•ç‹¬äº¤ä»˜ç»™å…¶ä»–å›¢é˜Ÿä½¿ç”¨ã€‚å¹³å°ç»„ä»¶å¤šé›†ç¾¤éƒ¨ç½²çš„å·¥å…·ï¼Œä¹Ÿæ˜¯æ²¡æœ‰å’Œå¹³å°è‡ªèº«ç»‘å®šåœ¨ä¸€èµ·ã€‚åªè¦æ˜¯éƒ¨ç½²åœ¨ K8s ä¸Šå¹¶ä¸”ç»„ä»¶ä½¿ç”¨ Helm Chart éƒ¨ç½²ï¼Œéƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªå·¥å…·æ¥å®ç°å¤šé›†ç¾¤éƒ¨ç½²å’Œæ›´æ–°ã€‚</p><h3 id="offline-resources-æœåŠ¡"><a href="#offline-resources-æœåŠ¡" class="headerlink" title="offline-resources æœåŠ¡"></a>offline-resources æœåŠ¡</h3><p>offline-resources  å³ç¦»çº¿èµ„æºæœåŠ¡ï¼Œè¿™ä¸€æ­¥å¾ˆç®€å•ï¼šå°±ä¸€ä¸ªå®‰è£…åŒ…ï¼Œè§£å‹åä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œä¸€æ¡ <code>bash install.sh</code> å‘½ä»¤å°±èƒ½å®‰è£…å®Œæˆã€‚ç”±äºåœ¨ Kubernetes é›†ç¾¤éƒ¨ç½²å±‚é¢æˆ‘ä»¬å·²ç»å»é™¤å¯¹ Docker å®¹å™¨è¿è¡Œæ—¶çš„ä¾èµ–ï¼Œoffline-resources æœåŠ¡åŒæ ·ä¹Ÿè¦è€ƒè™‘å»é™¤å¯¹ Docker çš„ä¾èµ–ã€‚å› æ­¤æˆ‘ä»¬é€‰æ‹©äº† Containerd å®˜æ–¹çš„ CLI å·¥å…· <a href="https://github.com/containerd/nerdctl" target="_blank" rel="noopener">nerdctl</a> ï¼Œä½¿ç”¨ nerdctl-full çš„å®‰è£…åŒ…æ¥é…ç½®å¥½ Containerd è¿è¡Œæ—¶æ‰€éœ€çš„ä¾èµ–ï¼Œå¹¶ä½¿ç”¨ nerdctl compose æ–¹å¼ä¸€é”®å¯åŠ¨ Nginx å’Œé•œåƒä»“åº“æœåŠ¡ã€‚åç»­çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å’Œå¹³å°ç»„ä»¶éƒ¨ç½²éƒ½ä¼šä¾èµ– offline-resources æä¾›çš„ rpm/deb åŒ…ã€äºŒè¿›åˆ¶æ–‡ä»¶ã€å®¹å™¨é•œåƒç­‰èµ„æºã€‚</p><h3 id="Kubernetes-é›†ç¾¤éƒ¨ç½²"><a href="#Kubernetes-é›†ç¾¤éƒ¨ç½²" class="headerlink" title="Kubernetes é›†ç¾¤éƒ¨ç½²"></a>Kubernetes é›†ç¾¤éƒ¨ç½²</h3><p>Kubernetes é›†ç¾¤éƒ¨ç½²é‡‡ç”¨çš„æ˜¯ Kubernetes ç¤¾åŒºçš„ <a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener">Kubespray</a>ï¼Œå› ä¸ºå®ƒæ¯”è¾ƒé€‚ç”¨äºç§æœ‰åŒ–äº¤ä»˜çš„åœºæ™¯ï¼Œç›¸å…³ç‰¹æ€§å¦‚ä¸‹ï¼š</p><ul><li>æ”¯æŒçš„ K8s ä» 1.19.0ï½1.21.1 çš„æ‰€æœ‰ç‰ˆæœ¬ï¼›</li><li>æ”¯æŒ 10 ç§ä¸»æµçš„ Linux å‘è¡Œç‰ˆå’Œå…¬æœ‰äº‘ Linux å‘è¡Œç‰ˆï¼›</li><li>æ”¯æŒ 10 ç§ CNI æ’ä»¶ï¼›</li><li>æ”¯æŒ 4 ç§å®¹å™¨è¿è¡Œæ—¶ (Docker, Containerd, CRI-O, Kata)ã€‚</li></ul><p>æˆ‘ä»¬å¯¹ Kubespray è¿›è¡Œäº†äºŒæ¬¡å¼€å‘ï¼ŒåŠ å…¥äº†ç¦»çº¿éƒ¨ç½²éœ€è¦é€‚é…çš„å†…å®¹ï¼Œæ¯”å¦‚é…ç½®ç³»ç»Ÿ OS çš„ yum/apt çš„æºä¸º offline-resources æœåŠ¡æ‰€æä¾›çš„æºï¼›å°†é•œåƒä»“åº“çš„åŸŸå CA è¯ä¹¦åœ¨èŠ‚ç‚¹è¿›è¡Œä¿¡ä»»ï¼›å°†é›†ç¾¤éƒ¨ç½²æ‹†åˆ†æˆè‹¥å¹²ä¸ªå­æ­¥éª¤ï¼›ä¸€äº›å¹³å°è‡ªèº« self-host ç‰¹æ€§ç­‰ã€‚</p><p>åŒæ—¶æˆ‘ä»¬åˆå¯¹ Kubespray è¿›è¡Œå®¹å™¨åŒ–å°è£…ï¼Œåœ¨éƒ¨ç½²çš„æ—¶å€™ä¼šä½¿ç”¨è„šæœ¬è°ƒç”¨ nerdctl CLI å·¥å…·æ¥è¿è¡Œ Kubespray å®¹å™¨ï¼Œåªéœ€è¦ä¼ å…¥é›†ç¾¤èŠ‚ç‚¹ inventory æ–‡ä»¶å’Œä¸€ä¸ªé›†ç¾¤é…ç½®æ–‡ä»¶å°±èƒ½ä¸€é”®å®Œæˆ Kubernetes é›†ç¾¤éƒ¨ç½²ã€‚é›†ç¾¤éƒ¨ç½²å®Œæˆä¹‹åä¼šå°†é›†ç¾¤çš„ä¸€äº›ä¿¡æ¯å¦‚é•œåƒä»“åº“çš„åŸŸåã€CA è¯ä¹¦ã€è´Ÿè½½å‡è¡¡ VIP ç­‰ä¿¡æ¯ä¿å­˜ä¸ºä¸€ä¸ª system-info çš„ configmap ä¸ºåç»­çš„å¹³å°éƒ¨ç½²ä½¿ç”¨ã€‚</p><h3 id="å¹³å°ç»„ä»¶éƒ¨ç½²"><a href="#å¹³å°ç»„ä»¶éƒ¨ç½²" class="headerlink" title="å¹³å°ç»„ä»¶éƒ¨ç½²"></a>å¹³å°ç»„ä»¶éƒ¨ç½²</h3><p>å¹³å°ç»„ä»¶éƒ¨ç½²æˆ‘ä»¬å¹¶æ²¡æœ‰åƒ <a href="https://github.com/kubesphere/ks-installer" target="_blank" rel="noopener">ks-installer</a> é‚£æ ·ä¸ºæ¯ä¸€ä¸ªç»„ä»¶éƒ½å•ç‹¬å†™ä¸€ä¸ª Ansible çš„ rolesï¼Œç„¶å controller é€šè¿‡è°ƒç”¨ ansible-playbook æ¥éƒ¨ç½²è¿™äº›ç»„ä»¶ã€‚è€Œæ˜¯å°†æ‰€æœ‰å¹³å°ç»„ä»¶çš„éƒ¨ç½²æ–¹å¼éƒ½ç»Ÿä¸€æˆä¸º Helm Chartï¼Œæ²¡æœ‰å¯¹ä»»ä½•ç»„ä»¶åšç‰¹æ®Šå¤„ç†ã€‚åœ¨å®‰è£…çš„æ—¶å€™ä½¿ç”¨ Helm CLI æˆ–è€…åŸºäº Helm SDK å¼€å‘çš„ helm controller æ¥å°†æ‰€æœ‰çš„å¹³å°ç»„ä»¶è¿›è¡Œç»Ÿä¸€çš„éƒ¨ç½²å’Œæ›´æ–°ã€‚è¿™æ ·åœ¨å‘å¸ƒçš„æ—¶å€™å¯¹è¿™äº›ç»„ä»¶ä¹Ÿèƒ½é€šè¿‡ git repo åšåˆ°ç»Ÿä¸€çš„ç®¡ç†ã€‚è¿™æ ·çš„è®¾è®¡å¯¹ä¸€äº› OEM å®šåˆ¶åŒ–å¼€å‘æˆ–è€…å¢é‡è¡¥ä¸åŒ…çš„å‘å¸ƒä¹Ÿååˆ†å‹å¥½ã€‚</p><h2 id="å‘å¸ƒ"><a href="#å‘å¸ƒ" class="headerlink" title="å‘å¸ƒ"></a>å‘å¸ƒ</h2><p>ä»‹ç»å®Œäº†å¹³å°éƒ¨ç½²çš„æ•´ä½“æµç¨‹åæˆ‘ä»¬å†æ¥è°ˆä¸€ä¸‹å‘å¸ƒæµæ°´çº¿æ˜¯å¦‚ä¸‹è®¾è®¡å’Œå®ç°çš„ã€‚</p><p>æ ¹æ®å†…éƒ¨äº§å“ç‰ˆæœ¬è¿­ä»£çš„æµç¨‹è¦æ±‚ï¼Œå‘å¸ƒæµæ°´çº¿å¤§è‡´å¯ä»¥åˆ’åˆ†ä¸ºå¦‚ä¸‹å‡ éƒ¨åˆ†ï¼š</p><ul><li>RD åœ¨å‘å¸ƒå‰ä¸€å¤©å®Œæˆå†’çƒŸæµ‹è¯•ï¼Œå¹¶åœ¨å†…éƒ¨ DevOps å¹³å°æ„å»ºç»„ä»¶é•œåƒå’Œæ‰“ repo tagï¼›</li><li>æœ¬æ¬¡å‘å¸ƒå¦‚æœ‰å¢åˆ ç»„ä»¶çš„æƒ…å†µï¼Œç»„ä»¶è´Ÿè´£äººæäº¤ PR/MR åˆ°å‘å¸ƒ repo ä¿®æ”¹å‘å¸ƒé…ç½®ï¼›</li><li>RD å†’çƒŸå®Œæˆå’Œæ‰€æœ‰å‡†å¤‡å·¥ç»„å°±ç»ªä¹‹åï¼ŒPM é€šçŸ¥å‘å¸ƒäººå‘˜å¼€å§‹å‘å¸ƒï¼›</li><li>å‘å¸ƒäººå‘˜æ‰§è¡Œæµæ°´çº¿ä»»åŠ¡ï¼Œè‡ªåŠ¨åŒ–æ”¶é›†ç»„ä»¶æœ€æ–°çš„ repo tagï¼Œå¹¶å‘é€ç¾¤æ¶ˆæ¯é€šçŸ¥ç»„ä»¶ Onwer ç¡®è®¤ï¼›</li><li>ç»„ä»¶ repo tag ç¡®è®¤å®Œæ¯•ä¹‹åï¼Œåˆå¹¶ PR/MR åˆ°å‘å¸ƒåˆ†æ”¯ï¼Œè‡ªåŠ¨åŒ–æ”¶é›†ç»„ä»¶çš„ Chart æ–‡ä»¶ï¼›</li><li>æ ¹æ®æ”¶é›†çš„ Chart æ–‡ä»¶æ›´æ–°é•œåƒåˆ—è¡¨å’Œå¹³å°ç»„ä»¶éƒ¨ç½²é…ç½®æ–‡ä»¶ï¼Œä»¥åŠæ£€æŸ¥é•œåƒåˆ—è¡¨ä¸­çš„é•œåƒæ˜¯å¦å­˜åœ¨ï¼›</li><li>å°†æ”¶é›†çš„ Chart å’Œé•œåƒåˆ—è¡¨ç­‰æ–‡ä»¶æäº¤ PR/MR åˆå¹¶åˆ°å‘å¸ƒåˆ†æ”¯ï¼›</li><li>å‰©ä¸‹çš„å°±æ˜¯æ‰“åŒ…äº†ï¼Œæ‰“åŒ…å¯ä»¥çœ‹ä½œæ˜¯å‘å¸ƒçš„æ”¶å°¾ç¯èŠ‚ï¼Œå°†äº§å“æ‰“åŒ…æˆç¦»çº¿å®‰è£…åŒ…å¹¶ä¸Šä¼ åˆ°å­˜å‚¨æœåŠ¡å™¨ï¼›</li></ul><h3 id="offline-resources-å®‰è£…åŒ…å‘å¸ƒ"><a href="#offline-resources-å®‰è£…åŒ…å‘å¸ƒ" class="headerlink" title="offline-resources å®‰è£…åŒ…å‘å¸ƒ"></a>offline-resources å®‰è£…åŒ…å‘å¸ƒ</h3><p>å¯¹äºå¹³å°éƒ¨ç½²è€Œè¨€ï¼Œä¾èµ–çš„åœ¨çº¿èµ„æºä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š</p><ul><li>ç¬¬ä¸€ç±»ï¼šä¸€äº› OS ä¾èµ–çš„åŒ…ï¼Œæ¯”å¦‚ç”¨åŒ…ç®¡ç†å™¨å®‰è£… Containerd, ceph-common, nfs-utils ç­‰</li><li>ç¬¬äºŒç±»ï¼šäºŒè¿›åˆ¶æ–‡ä»¶ï¼šæ¯”å¦‚ Kubelet, Kubeadm, Kubectl, CNIï¼Œè¿˜æœ‰ä¸€äº›å·¥å…·ç±»å¦‚ Helm, Skopeo ç­‰</li><li>ç¬¬ä¸‰ç±»ï¼šå®¹å™¨é•œåƒï¼Œæ¯”å¦‚ kube-apiserver, CoreDNS, å¹³å°ç»„ä»¶é•œåƒç­‰</li></ul><p>å¯¹äºè¿™ä¸‰ç§åœ¨çº¿çš„èµ„æºï¼Œæˆ‘ä»¬éƒ½ç»Ÿä¸€æˆ Docker build çš„æ–¹å¼ï¼Œä½¿ç”¨ä¸ä¹‹å¯¹åº”çš„è‡ªåŠ¨åŒ–å·¥å…·è¿›è¡Œæ„å»ºã€‚</p><ul><li>å¯¹äºç¬¬ä¸€ç§ï¼Œæˆ‘ä»¬é‡‡ç”¨é…ç½®æ–‡ä»¶ + Dockerfile çš„æ–¹å¼è¿›è¡Œä¸€é”®æ„å»ºå‡ºæ‰€æœ‰ä¾èµ–çš„ yum/apt åŒ…ï¼Œåˆ¶ä½œæˆç¦»çº¿æºã€‚å…·ä½“çš„å®ç°ç»†èŠ‚å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„åšå®¢ <a href="https://blog.k8s.li/make-offline-mirrors.html">ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</a>ï¼›</li><li>å¯¹äºç¬¬äºŒç§ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®éƒ¨ç½²çš„é…ç½®æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåœ¨çº¿çš„æ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶æ”¾åˆ° Dockerfile é‡Œè¿›è¡Œæ„å»ºä¸‹è½½ï¼›</li><li>å¯¹äºç¬¬ä¸‰ç§ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯æ ¹æ®éƒ¨ç½²çš„é…ç½®æ–‡ä»¶ç”Ÿæˆä¸€äº›é•œåƒåˆ—è¡¨ï¼Œåœ¨ä¸€ä¸ª Dockerfile  é‡Œå°†é•œåƒæ‰“åŒ…å‡ºæ¥ã€‚</li></ul><p>æœ€åæˆ‘ä»¬å°†æ‰€æœ‰çš„ Dockerfile åˆå¹¶æˆä¸€ä¸ª all-in-one çš„ Dockerfileï¼Œå¹¶ä½¿ç”¨ Docker çš„å¤šé˜¶æ®µæ„å»ºå’Œ  <code>BUILDKIT</code>  çš„ç‰¹æ€§å……åˆ†åˆ©ç”¨äº†æ„å»ºç¼“å­˜ï¼Œä½¿å¾—æ„å»ºæ•ˆç‡æ¯”é Docker build çš„æ–¹å¼æé«˜äº†å¾ˆå¤šã€‚</p><h3 id="K8s-éƒ¨ç½²å®‰è£…åŒ…å‘å¸ƒ"><a href="#K8s-éƒ¨ç½²å®‰è£…åŒ…å‘å¸ƒ" class="headerlink" title="K8s éƒ¨ç½²å®‰è£…åŒ…å‘å¸ƒ"></a>K8s éƒ¨ç½²å®‰è£…åŒ…å‘å¸ƒ</h3><p>ç”±äº Kubernetes é›†ç¾¤éƒ¨ç½²æ¶‰åŠçš„ç ”å‘äººå‘˜åªæœ‰äº”å…­ä¸ªï¼Œå› æ­¤å°†å‘å¸ƒæµç¨‹æ¶‰åŠçš„ååˆ†è½»é‡ã€‚å¤§è‡´å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥ï¼š</p><ul><li>å‘å¸ƒäººå‘˜æ‰§è¡Œå‘å¸ƒæµæ°´çº¿ï¼Œæµæ°´çº¿æ ¹æ®éƒ¨ç½²çš„æºç ç”Ÿæˆé•œåƒåˆ—è¡¨å’Œæ–‡ä»¶åˆ—è¡¨ï¼Œè‹¥ä¸¤è€…æ›´æ–°äº†å°±è‡ªåŠ¨æäº¤ PR/MR åˆ°å‘å¸ƒåˆ†æ”¯ï¼›</li><li>ç ”å‘äººå‘˜ review PR/MR æ£€æŸ¥ç”Ÿæˆçš„é•œåƒåˆ—è¡¨å’Œæ–‡ä»¶åˆ—è¡¨æ˜¯å¦æ­£ç¡®ã€‚å› ä¸ºé•œåƒåˆ—è¡¨å’Œæ–‡ä»¶åˆ—è¡¨å°±æ˜¯é›†ç¾¤éƒ¨ç½²é‡Œæ‰€æœ‰ç»„ä»¶çš„ç‰ˆæœ¬ï¼Œå¯ä»¥æ ¹æ®è¿™äº›åˆ—è¡¨åˆ¤æ–­ç»„ä»¶ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®ï¼›</li><li>æµæ°´çº¿è‡ªåŠ¨æ£€æŸ¥é•œåƒåˆ—è¡¨ä¸­çš„é•œåƒæ˜¯å¦å­˜åœ¨ï¼Œæµæ°´çº¿æˆåŠŸä¹‹åï¼Œrepo è´Ÿè´£äººåˆå¹¶ PR/MRï¼›</li><li>åˆå¹¶å®Œæˆ MR ä¹‹åï¼Œä¼šæ‰“ä¸Šç›¸åº”ç‰ˆæœ¬çš„ repo tagï¼Œä¸ºåç»­è¡¥ä¸åŒ…å‘å¸ƒä½¿ç”¨ï¼›</li><li>æµæ°´çº¿æ„å»º Kubespray é•œåƒæ¨é€åˆ°å…¬å¸å†…éƒ¨çš„é•œåƒä»“åº“ï¼Œå¹¶å°†é•œåƒè¿½åŠ åˆ°é•œåƒåˆ—è¡¨ä¸­ï¼›</li><li>æµæ°´çº¿è°ƒç”¨ offline-resources æ„å»ºå·¥å…·ï¼Œæ ¹æ®é•œåƒåˆ—è¡¨æ‰“åŒ…é•œåƒã€æ ¹æ®æ–‡ä»¶åˆ—è¡¨ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ã€æ ¹æ®é…ç½®æ–‡ä»¶æ‰“åŒ…ç¦»çº¿å®‰è£…ä¾èµ–çš„ rpm/deb åŒ…ï¼›</li><li>å¤åˆ¶é…ç½®æ–‡ä»¶å’Œ install.sh è„šæœ¬åˆ°å®‰è£…åŒ…å†…ï¼Œå°†ä¸Šè¿°å†…å®¹æ‰“åŒ…æˆä¸€ä¸ªå®‰è£…åŒ…ï¼Œå¹¶ä¸Šä¼ è‡³å­˜å‚¨æœåŠ¡å™¨ï¼›</li><li>å‘é€ç¾¤æ¶ˆæ¯é€šçŸ¥æµæ°´çº¿å‘å¸ƒå®Œæˆã€‚</li></ul><h3 id="å¹³å°å®‰è£…åŒ…å‘å¸ƒæµç¨‹"><a href="#å¹³å°å®‰è£…åŒ…å‘å¸ƒæµç¨‹" class="headerlink" title="å¹³å°å®‰è£…åŒ…å‘å¸ƒæµç¨‹"></a>å¹³å°å®‰è£…åŒ…å‘å¸ƒæµç¨‹</h3><p>ç”±äºå¹³å°ç»„ä»¶æ•°é‡æ¯”è¾ƒå¤šï¼Œæ‰€æ¶‰åŠçš„ç ”å‘äººå‘˜ä¹Ÿè¾ƒå¤šï¼Œä¸ºäº†æé«˜å‘å¸ƒæ•ˆç‡å’Œå›¢é˜Ÿæ•´ä½“çš„ç ”å‘æ•ˆç‡ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰å¹³å°ç»„ä»¶éƒ½ç»Ÿä¸€ä½¿ç”¨ Helm Chart çš„æ–¹å¼æ¥éƒ¨ç½²ã€‚ä½¿ç”¨ Helm Chart çš„å¥½å¤„å°±åœ¨äºè¿™äº›æ–‡ä»¶éƒ½æ˜¯å£°æ˜å¼çš„ï¼Œç»„ä»¶çš„ç‰ˆæœ¬å¯ä»¥å®šä¹‰åœ¨è¿™äº› Chart.yaml æ–‡ä»¶ä¸­ï¼Œä¸ºåç»­ç»´æŠ¤å¹³å°å„ä¸ªç»„ä»¶çš„ç‰ˆæœ¬æä¾›äº†ä¾¿åˆ©ã€‚</p><p>ä¸ºäº†ç®¡ç†è¿™äº›å¹³å°ç»„å»ºçš„ Charts æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰ç»„ä»¶éƒ¨ç½²çš„ Chart ä½¿ç”¨è‡ªåŠ¨åŒ–çš„å·¥å…·ç»Ÿä¸€æ”¶é›†åˆ°ä¸€ä¸ª Git repo ä¸­ï¼Œåˆ©ç”¨ Git ä½œä¸ºå£°æ˜åŸºç¡€è®¾æ–½ä¸åº”ç”¨ç¨‹åºçš„å•ä¸€äº‹å®æ¥æºã€‚ä½¿ç”¨ git tag çš„æ–¹å¼ç®¡ç†å’Œè®°å½•å¹³å°çš„ç‰ˆæœ¬å’Œå„ä¸ªç»„ä»¶çš„ç‰ˆæœ¬ï¼›ä½¿ç”¨ git diff çš„æ–¹å¼åšå·®å¼‚æ¯”è¾ƒï¼Œä¸ºå¢é‡çš„è¡¥ä¸åŒ…å‘å¸ƒæä¾›äº†ä¾¿åˆ©ï¼›ä½¿ç”¨åˆ†æ”¯çš„æ–¹å¼æ¥ç®¡ç†ä¸åŒçš„ OEM å®šåˆ¶åŒ–å¼€å‘é¡¹ç›®ã€‚</p><h4 id="å‘å¸ƒé…ç½®"><a href="#å‘å¸ƒé…ç½®" class="headerlink" title="å‘å¸ƒé…ç½®"></a>å‘å¸ƒé…ç½®</h4><p>ä»¥ä¸‹è¿™äº›æ–‡ä»¶å’Œç›®å½•è®°å½•äº†å¦‚ä½•ä½¿ç”¨ git repo æ¥ç®¡ç†å¹³å°ç»„ä»¶çš„ï¼š</p><table><thead><tr><th>ç›®å½•/æ–‡ä»¶</th><th>ä½œç”¨</th><th>æ›´æ–°æ–¹å¼</th></tr></thead><tbody><tr><td>addons</td><td>ç”¨äºå­˜æ”¾å¹³å°ç»„ä»¶éƒ¨ç½²éœ€è¦çš„ Helm Chart</td><td>æ ¹æ® repos ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶è‡ªåŠ¨æ›´æ–°</td></tr><tr><td>repos</td><td>ç”¨äºå­˜æ”¾å¹³å°ç»„ä»¶ git  repo é…ç½®ï¼Œæ ¹æ®å®ƒæ¥æ”¶é›†ç»„ä»¶æŒ‡å®š repo æŒ‡å®šç‰ˆæœ¬å·çš„ Chart æ–‡ä»¶</td><td>å¢åˆ ç»„ä»¶éœ€è¦æ‰‹åŠ¨æ·»åŠ ç›¸åº”é…ç½®ï¼Œç»„ä»¶ç‰ˆæœ¬å·è‡ªåŠ¨æ›´æ–°</td></tr><tr><td>images</td><td>ç”¨äºå­˜æ”¾å¹³å°æ‰€éœ€é•œåƒçš„åˆ—è¡¨</td><td>æ ¹æ® addons ç›®å½•ä¸‹çš„ç»„ä»¶è‡ªåŠ¨æ›´æ–°</td></tr><tr><td>scripts</td><td>ç”¨äºå­˜æ”¾ä¸€äº›éƒ¨ç½²ä¾èµ–è„šæœ¬æ–‡ä»¶</td><td>æ‰‹åŠ¨æ›´æ–°æˆ–è‡ªåŠ¨ä»å…¶ä»– repo ä¸­æ”¶é›†</td></tr><tr><td>configs</td><td>ç”¨äºå­˜æ”¾å¹³å°æˆ–ç»„ä»¶éœ€è¦çš„é…ç½®æ–‡ä»¶</td><td>æ‰‹åŠ¨æ›´æ–°æˆ–è‡ªåŠ¨ä»å…¶ä»– repo ä¸­æ”¶é›†</td></tr><tr><td>version.yml</td><td>è®°å½•å¹³å°ç»„ä»¶ç‰ˆæœ¬</td><td>æ ¹æ®ç»„ä»¶ Chart ä¸­çš„ version è‡ªåŠ¨æ›´æ–°</td></tr><tr><td>install.sh</td><td>å¹³å°å®‰è£…è„šæœ¬</td><td>æ‰‹åŠ¨æ›´æ–°</td></tr></tbody></table><p>Git Repo çš„ç›®å½•ç»“æ„å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ tree platform-release</span><br><span class="line">platform-release</span><br><span class="line">â”œâ”€â”€ addons</span><br><span class="line">â”‚   â”œâ”€â”€ cyclone</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ templates</span><br><span class="line">â”‚   â”‚   â””â”€â”€ values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ mongo</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ templates</span><br><span class="line">â”‚   â”‚   â””â”€â”€ values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ rook-ceph</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ crds</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ templates</span><br><span class="line">â”‚   â”‚   â””â”€â”€ values.yaml</span><br><span class="line">â”‚   â””â”€â”€ swagger-ui</span><br><span class="line">â”‚       â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ templates</span><br><span class="line">â”‚       â””â”€â”€ values.yaml</span><br><span class="line">â”œâ”€â”€ configs</span><br><span class="line">â”‚   â”œâ”€â”€ mongo-config-secret.yaml.j2</span><br><span class="line">â”‚   â”œâ”€â”€ platform-config.yaml.j2</span><br><span class="line">â”‚   â””â”€â”€ platform-info.yaml.j2</span><br><span class="line">â”œâ”€â”€ env.yml</span><br><span class="line">â”œâ”€â”€ images</span><br><span class="line">â”‚   â”œâ”€â”€ images_app_store.list</span><br><span class="line">â”‚   â”œâ”€â”€ images_base.list</span><br><span class="line">â”‚   â”œâ”€â”€ images_extra.list</span><br><span class="line">â”‚   â””â”€â”€ images_platform.list</span><br><span class="line">â”œâ”€â”€ install.sh</span><br><span class="line">â”œâ”€â”€ repos</span><br><span class="line">â”‚   â”œâ”€â”€ app.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ auth.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ common.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ devops.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ insight.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ net.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ resource.yaml</span><br><span class="line">â”‚   â””â”€â”€ web.yaml</span><br><span class="line">â””â”€â”€ scripts</span><br><span class="line"></span><br><span class="line">    â””â”€â”€ init.sh</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹-repo-é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹-repo-é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ repo é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹ repo é…ç½®æ–‡ä»¶</h4><p>ç‰ˆæœ¬å‘å¸ƒå‰ï¼Œå¦‚æœæœ‰å¢åˆ ç»„ä»¶çš„æƒ…å†µï¼Œéœ€è¦å¯¹åº”ç»„ä»¶çš„è´Ÿè´£äººä¿®æ”¹è‡ªå·±è´Ÿè´£æ¨¡å—çš„å‘å¸ƒé…ç½®æ–‡ä»¶ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GitHub ä¸Šrepo çš„åç§°ï¼Œå¦‚ï¼šmuzi502/xxx</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">repositoryFullName:</span> <span class="string">muzi502/cyclone</span> </span><br><span class="line">  <span class="comment"># ç»„ä»¶çš„æœ€æ–° tag</span></span><br><span class="line">  <span class="attr">currentTag:</span> <span class="string">v0.5.3</span></span><br><span class="line">  <span class="comment"># ä»æŒ‡å®š repo æ‹‰å– helm chart çš„ç›®å½•</span></span><br><span class="line">  <span class="attr">chartPaths:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">manifests/cyclone</span>       <span class="comment"># æ‹‰å– chart çš„è·¯å¾„ï¼Œå¯ä»¥é…ç½®å¤šæ¡</span></span><br><span class="line">  <span class="attr">targetChartPath:</span> <span class="string">addons</span></span><br></pre></td></tr></table></figure><p>æ¯”å¦‚<code>repos/devops.yaml</code> ä¸­ç”¨äºé…ç½®æ”¶é›†æµæ°´çº¿ç»„ä»¶çš„ helm Chartã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">A</span> <span class="string">set</span> <span class="string">of</span> <span class="string">files</span> <span class="string">to</span> <span class="string">collect.</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">collect</span> <span class="string">set</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">repositoryFullName:</span> <span class="string">muzi502/cyclone</span></span><br><span class="line">  <span class="attr">baseVersion:</span> <span class="string">v1.2</span></span><br><span class="line">  <span class="attr">currentTag:</span> <span class="string">v1.2.0</span></span><br><span class="line">  <span class="attr">chartPaths:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">manifests/cyclone</span></span><br><span class="line">  <span class="attr">targetChartPath:</span> <span class="string">addons</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥åªéœ€è¦æ·»åŠ ä¸€æ¬¡å³å¯ï¼Œåç»­æ— å¢åˆ ç»„ä»¶çš„æƒ…å†µæ— éœ€å†å…³å¿ƒè¿™äº›é…ç½®ï¼Œé…ç½®ä¸­çš„ repo ç‰ˆæœ¬ä¹Ÿä¼šä½¿ç”¨è‡ªåŠ¨åŒ–çš„å·¥å…·æ¥å®Œæˆè‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤ï¼Œè¿™æ ·èƒ½å‡å°‘ç ”å‘ä»¬çš„ç»´æŠ¤æˆæœ¬ã€‚</p><h4 id="æ›´æ–°ç»„ä»¶-repo-ç‰ˆæœ¬"><a href="#æ›´æ–°ç»„ä»¶-repo-ç‰ˆæœ¬" class="headerlink" title="æ›´æ–°ç»„ä»¶ repo ç‰ˆæœ¬"></a>æ›´æ–°ç»„ä»¶ repo ç‰ˆæœ¬</h4><p>å‘å¸ƒå‰ç½®å·¥ä½œéƒ½å®Œæˆä¹‹åï¼ŒPM ä¼šé€šçŸ¥å‘å¸ƒäººå‘˜å¼€å§‹å‘å¸ƒã€‚å› ä¸ºå‚æ•°åŒ–æ„å»ºå’Œ Job é›†ä¸­å¼ç®¡ç†ç­‰å¼ºä¾èµ–çš„ç‰¹æ€§å…¶ä»– CI å·¥å…·æ— æ³•å¾ˆå¥½åœ°æ›¿ä»£ï¼Œç›®å‰æˆ‘ä»¬çš„å‘å¸ƒæµæ°´çº¿ä¾æ—§æ˜¯ä½¿ç”¨çš„ Jenkins ã€‚</p><p>å‘å¸ƒäººå‘˜åœ¨ Jenkins ä¸Šæ‰§è¡Œå‘å¸ƒæµæ°´çº¿çš„ä»»åŠ¡ï¼Œæµæ°´çº¿ä¸­é¦–å…ˆä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·è§£æ repo é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®ç»„ä»¶æ‰“ repo tag æ—¶å€™çš„ message ä¿¡æ¯æ”¶é›†æœ€æ–°çš„ tag ç‰ˆæœ¬å·ã€‚æ”¶é›†å®Œæ¯•ä¹‹åå‘å¸ƒæµæ°´çº¿è‡ªåŠ¨æäº¤ä¸€ä¸ª PR/MR åˆ° repo çš„å‘å¸ƒåˆ†æ”¯ã€‚å¹¶é€šè‡ªåŠ¨å‘é€ç¾¤æ¶ˆæ¯é€šçŸ¥è®©æ‰€æœ‰ repo çš„è´Ÿè´£äººç¡®è®¤æ”¶é›†åˆ°çš„ repo tag æ˜¯å¦æ­£ç¡®ã€‚ç¡®è®¤æ— è¯¯ä¹‹åï¼Œå°† PR/MR è‡ªåŠ¨åˆå¹¶åˆ°å‘å¸ƒåˆ†æ”¯ã€‚</p><h4 id="æ›´æ–°ç»„ä»¶-Chart-æ–‡ä»¶"><a href="#æ›´æ–°ç»„ä»¶-Chart-æ–‡ä»¶" class="headerlink" title="æ›´æ–°ç»„ä»¶ Chart æ–‡ä»¶"></a>æ›´æ–°ç»„ä»¶ Chart æ–‡ä»¶</h4><p>æ›´æ–°å®Œç»„ä»¶ repo çš„ tag ä¹‹åï¼Œè¿™æ ·å°±èƒ½ç¡®å®šæœ¬æ¬¡å‘å¸ƒéœ€è¦åˆ°å“ªäº› repo çš„å“ªä¸ª repo tag ä¸‹å»æ”¶é›†ç»„ä»¶éƒ¨ç½²çš„ Chart æ–‡ä»¶ï¼Œåœ¨è¿™ä¸€æ­¥ä¼šä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ï¼Œæ ¹æ® repos ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œæ”¶é›†å¯¹åº”ç»„ä»¶çš„ Chart æ–‡ä»¶åˆ°å‘å¸ƒ repo çš„æŒ‡å®šç›®å½•ä¸‹ï¼Œä¸€èˆ¬é»˜è®¤ä¸º addons ç›®å½•ã€‚</p><h4 id="æ›´æ–°ç»„ä»¶ç‰ˆæœ¬é…ç½®æ–‡ä»¶"><a href="#æ›´æ–°ç»„ä»¶ç‰ˆæœ¬é…ç½®æ–‡ä»¶" class="headerlink" title="æ›´æ–°ç»„ä»¶ç‰ˆæœ¬é…ç½®æ–‡ä»¶"></a>æ›´æ–°ç»„ä»¶ç‰ˆæœ¬é…ç½®æ–‡ä»¶</h4><p>æ ¹æ®æ”¶é›†åˆ°çš„ç»„ä»¶ Chart ç‰ˆæœ¬å·æ›´æ–° <code>version.yml</code>è¿™ä¸ªç»„ä»¶ç‰ˆæœ¬é…ç½®æ–‡ä»¶ä¸­å¯¹åº”çš„ç‰ˆæœ¬ï¼Œéƒ¨ç½²çš„æ—¶å€™ä¼šæ ¹æ®è¿™ä¸ªæ–‡ä»¶å»éƒ¨ç½²å“ªäº›ç»„ä»¶ä»¥åŠéƒ¨ç½²ç»„ä»¶çš„ç‰ˆæœ¬æ˜¯ä»€ä¹ˆã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">modules:</span> <span class="comment"># æ¨¡å—åˆ—è¡¨ï¼Œä¸€ä¸ªå¹³å°å¯ä»¥æœ‰å¤šä¸ª modules</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="comment"># æ¨¡å—å</span></span><br><span class="line">    <span class="attr">description:</span> <span class="comment"># æ¨¡å—çš„æè¿°ä¿¡æ¯</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="comment"># æ˜¯å¦å¯ç”¨æ¨¡å—</span></span><br><span class="line">    <span class="attr">addons:</span> <span class="comment"># æ¨¡å—ä¸­çš„ç»„ä»¶åˆ—è¡¨</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="comment"># ç»„ä»¶çš„åç§°ï¼Œ å¿…é¡»å’Œç»„ä»¶åä»¥åŠ Chart.yaml name ä¿æŒä¸€è‡´</span></span><br><span class="line">      <span class="attr">description:</span> <span class="comment"># ç»„ä»¶çš„æè¿°ä¿¡æ¯</span></span><br><span class="line">      <span class="attr">enable:</span> <span class="comment"># æ˜¯å¦å¯ç”¨æ¨¡å—</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="comment"># ç»„ä»¶è¿è¡Œçš„ namespace</span></span><br><span class="line">      <span class="attr">version:</span> <span class="comment"># ç»„ä»¶çš„ç‰ˆæœ¬å·ï¼Œå¿…é¡»å’Œ repo tag Chart.yaml version ä¿æŒä¸€è‡´</span></span><br></pre></td></tr></table></figure><h4 id="æ›´æ–°å¹³å°é•œåƒåˆ—è¡¨"><a href="#æ›´æ–°å¹³å°é•œåƒåˆ—è¡¨" class="headerlink" title="æ›´æ–°å¹³å°é•œåƒåˆ—è¡¨"></a>æ›´æ–°å¹³å°é•œåƒåˆ—è¡¨</h4><p>ä½¿ç”¨ Helm Template æ¸²æŸ“å‡ºåŸç”Ÿçš„ K8s YAMLå†…å®¹ï¼Œä½¿ç”¨ grep è¿‡æ»¤å‡ºå¹³å°ç»„ä»¶éƒ¨ç½²æ‰€éœ€è¦çš„é•œåƒï¼Œå¹¶å°†è¾“å‡ºçš„ç»“æœé‡å®šå‘åˆ° <code>images/images_platform.list</code> æ–‡ä»¶ä¸­ï¼Œè¿™äº›é•œåƒæ˜¯éƒ¨ç½²éƒ¨ç½²ç»„ä»¶å¿…é¡»ç”¨åˆ°çš„é•œåƒã€‚å¦å¤–è¿˜æœ‰ä¸‰ç§å…¶ä»–çš„é•œåƒå¦‚ä¸‹ï¼š</p><ul><li>images_extra.listï¼šä¸€äº›é¢å¤–çš„é•œåƒç¬¬ä¸‰æ–¹é•œåƒã€‚</li><li>images_base.listï¼šä¸€äº›å¹³å° DevOps ç»„ä»¶ç”¨åˆ°çš„ base é•œåƒï¼Œæ¯”å¦‚ golang, nodejs, maven ç­‰ã€‚</li><li>images_app_store.listï¼š å¹³å°åº”ç”¨å•†åº—ä¸­åº”ç”¨éƒ¨ç½²éœ€è¦çš„é•œåƒï¼Œæ¯”å¦‚ Wordpressï¼ŒGitLabï¼ŒHarbor ç­‰ã€‚</li></ul><p>å¤„ç†è¿™äº›é•œåƒåˆ—è¡¨æ—¶ä¹Ÿå¾ˆç®€å•ï¼Œå³ä½¿ç”¨ find æŸ¥æ‰¾å„ä¸ªç»„ä»¶ Chart ä¸­çš„ images_xxx.list æ–‡ä»¶ï¼Œå°†è¿™äº›é•œåƒç»Ÿä¸€åˆå¹¶åˆ° images ç›®å½•ä¸‹å¯¹åº”çš„æ–‡ä»¶ä¸­ã€‚</p><p>åœ¨å‘å¸ƒ repo ä¸­è¿™äº›é•œåƒåˆ—è¡¨éƒ½æ˜¯è‡ªåŠ¨åŒ–å®Œæˆäº†ï¼Œå¹¶ä¸”ç¦æ­¢ä¸ªäººæ‰‹åŠ¨åœ¨å‘å¸ƒ repo ä¸­è¿›è¡Œæ›´æ–°ï¼Œè¿™æ ·èƒ½é¿å…ä¸€äº›äººä¸ºçš„ä½çº§é”™è¯¯ï¼Œæ¯”å¦‚é•œåƒç‰ˆæœ¬é”™è¯¯ã€‚æˆ‘ä»¬ä½¿ç”¨è¿™ç§æ–¹å¼æ¥ç®¡ç†å¹³å°æ‰€éœ€è¦çš„ 200 å¤šä¸ªé•œåƒï¼Œå¾ˆå°‘å› ä¸ºé•œåƒåˆ—è¡¨çš„é”™è¯¯è€Œå¯¼è‡´å‘å¸ƒäº‹æ•…ï¼Œæå¤§åœ°æé«˜äº†ç‰ˆæœ¬å‘å¸ƒçš„æ•ˆç‡ã€‚</p><h4 id="æäº¤æ”¶é›†äº§ç‰©"><a href="#æäº¤æ”¶é›†äº§ç‰©" class="headerlink" title="æäº¤æ”¶é›†äº§ç‰©"></a>æäº¤æ”¶é›†äº§ç‰©</h4><p>ä¸Šè¿°æ­¥éª¤éƒ½å®Œæˆä¹‹åä¼šå°†è¿™äº›æ”¶é›†çš„æ–‡ä»¶æäº¤ä¸€ä¸ª PR/MR åˆ°å‘å¸ƒ repoï¼Œå‘å¸ƒ repo ä¼šè§¦å‘ä¸€ä¸ªé¢å¤–çš„æµæ°´çº¿å»æ£€æŸ¥é•œåƒåˆ—è¡¨ä¸­çš„é•œåƒæ˜¯å¦å­˜åœ¨äºå†…éƒ¨çš„é•œåƒä»“åº“ä¸­ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¼šå‘é€ç¾¤æ¶ˆæ¯é€šçŸ¥ç ”å‘å‡†å¤‡å¥½é•œåƒã€‚</p><p>ç­‰é•œåƒéƒ½å‡†å¤‡å®Œæ¯•ä¹‹åï¼Œä¼šå°†è¿™ä¸ª PR/MR åˆå¹¶åˆ°å‘å¸ƒ repo ç›¸åº”çš„åˆ†æ”¯ã€‚åˆå¹¶å®Œ PR/MR ä¹‹åè‡³æ­¤ç ”å‘éœ€è¦å‚ä¸çš„å‘å¸ƒæµç¨‹å·²ç»å®Œæ¯•ï¼Œrepo çš„å‘å¸ƒåˆ†æ”¯æ— éœ€å†ä¿®æ”¹å…¶ä»–çš„å†…å®¹ï¼Œè¿™æ—¶ä¼šç»™å½“å‰å‘å¸ƒåˆ†æ”¯çš„æœ€æ–° commit æ‰“ä¸Šä¸€ä¸ª repo tagï¼Œrepo tag çš„åç§°å°±æ˜¯äº§å“çš„ç‰ˆæœ¬å·ï¼Œæ¯”å¦‚ <code>v2.10.2</code> ã€‚</p><p>åˆ°æ­¤ä¸ºæ­¢å®Œæˆäº†å‘å¸ƒç¯èŠ‚çš„ç»å¤§å¤šæ•°ä»»åŠ¡ï¼Œå‰©ä¸‹çš„åªæœ‰æ‰“åŒ…å®‰è£…åŒ…è¿™ä¸ªæ”¶å°¾å·¥ä½œã€‚</p><h4 id="æ‰“åŒ…æµç¨‹"><a href="#æ‰“åŒ…æµç¨‹" class="headerlink" title="æ‰“åŒ…æµç¨‹"></a>æ‰“åŒ…æµç¨‹</h4><p>ä»¥ä¸Šå‘å¸ƒæµç¨‹éœ€è¦ä¼—å¤šç ”å‘æ¥å‚ä¸ç¡®ä¿å‘å¸ƒç¯èŠ‚æ”¶é›†åˆ°çš„ç»„ä»¶ Chart å’Œé•œåƒæ˜¯æ­£ç¡®çš„ï¼Œæ”¶é›†å®Œæˆè¿™äº›æ–‡ä»¶ä¹‹åå°±ç»§ç»­è¿›è¡Œæ‰“åŒ…æ“ä½œã€‚æ‰“åŒ…çš„ç›®çš„æ˜¯å°†äº§å“éƒ¨ç½²ä¾èµ–çš„æ–‡ä»¶å’Œé•œåƒæ‰“åŒ…åœ¨ä¸€èµ·ï¼Œåˆ¶ä½œæˆä¸€ä¸ªç¦»çº¿å®‰è£…åŒ…ã€‚æ‰“åŒ…æµç¨‹å¾ˆç®€å•ï¼Œå¤§è‡´å¯åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p><ul><li>æ‰“åŒ… Helm Chart</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p charts &amp;&amp; rm -rf charts/* || <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> dir <span class="keyword">in</span> $(find <span class="variable">$&#123;ADDONS_PATH&#125;</span> -<span class="built_in">type</span> f | sed -n <span class="string">'s/Chart.yaml//p'</span>); <span class="keyword">do</span> helm package <span class="variable">$&#123;dir&#125;</span> -d charts; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">chown -R 10000:10000 charts &amp;&amp; tar -cpvf charts.tar.gz charts</span><br></pre></td></tr></table></figure><ul><li>æ‰“åŒ…é•œåƒ</li></ul><p>æ ¹æ® images ç›®å½•ä¸‹çš„é•œåƒåˆ—è¡¨å°†é•œåƒåŒæ­¥åˆ°ä¸€ä¸ªæŒ‡å®šçš„ Registry ä¸­ï¼Œä¸ºäº†æå‡æ‰“åŒ…æ•ˆç‡ï¼Œè¿™ä¸ª Registry é•¿æœŸä¿ç•™ã€‚ç„¶åä½¿ç”¨ç¡¬è¿æ¥çš„æ–¹å¼å°†é•œåƒæ–‡ä»¶ç›´æ¥ä»è¿™ä¸ª Registry å­˜å‚¨ç›®å½•ä¸­ç›´æ¥æå–å‡ºæ¥ï¼Œå¹¶æ‰“åŒ…æˆä¸€ä¸ª tar æ ¼å¼çš„æ–‡ä»¶æ”¾åˆ°äº§å“å®‰è£…åŒ…ä¸­ã€‚å…³äºé•œåƒåŒæ­¥çš„è¯¦ç»†åŸç†å’Œä¸€äº›ä¹‹å‰åšçš„ä¼˜åŒ–å¯ä»¥å‚è€ƒ <a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 åœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­çš„åº”ç”¨</a> å’Œ <a href="https://blog.k8s.li/select-registry-images.html">ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼</a>è¿™ä¸¤ç¯‡æ–‡ç« ã€‚</p><ul><li>æ‰“åŒ…ä¸Šä¼ </li></ul><p>é•œåƒå’Œç»„ä»¶ Chart éƒ½æ‰“åŒ…å®Œæˆä¹‹åï¼Œå†å°†ä¸€äº›å®‰è£…è„šæœ¬å’Œé…ç½®æ–‡ä»¶å¤åˆ¶åˆ°å®‰è£…åŒ…ä¸­ã€‚æœ€åå°†è¿™äº›å†…å®¹ä¸€å¹¶æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œå¹¶å°†å®ƒä¸Šä¼ ç‰¹æ€§çš„å­˜å‚¨æœåŠ¡å™¨ä¸Šã€‚ä¹‹åä¼šæœ‰ä¸“é—¨çš„æµ‹è¯•å›¢é˜Ÿæ¥å¯¹æ‰“å‡ºæ¥å®‰è£…åŒ…è¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡ä¹‹åå°±å¯ä»¥å¯¹å¤–å‘å¸ƒäº¤ä»˜ç»™å®¢æˆ·ä½¿ç”¨ã€‚</p><h4 id="å‘å¸ƒ-release-åˆ†æ”¯"><a href="#å‘å¸ƒ-release-åˆ†æ”¯" class="headerlink" title="å‘å¸ƒ release åˆ†æ”¯"></a>å‘å¸ƒ release åˆ†æ”¯</h4><p>è‡³æ­¤å¹³å°ç»„ä»¶å‘å¸ƒæµç¨‹åˆ°æ­¤å®Œæ¯•ï¼Œå½“ä¸€ä¸ªæ­£å¼çš„ç‰ˆæœ¬å‘å¸ƒå®Œæˆä¹‹åï¼Œæˆ‘ä»¬ä¼šé‡‡ç”¨ Kubernetes ç¤¾åŒºç‰ˆæœ¬ç®¡ç†çš„æ–¹å¼ç»™å‘å¸ƒ repo åˆ›å»ºä¸€ä¸ª release åˆ†æ”¯ï¼Œæ¯”å¦‚ release-2.10 åˆ†æ”¯ã€‚åç»­æ‰€æœ‰çš„è¡¥ä¸åŒ…å’Œä¸€äº› OEM å®šåˆ¶åŒ–å¼€å‘çš„é¡¹ç›®éƒ½ä¼šåŸºäºè¿™ç§ release åˆ†æ”¯æ¥è¿›è¡Œå¼€å‘ã€‚</p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="é•œåƒç®¡ç†"><a href="#é•œåƒç®¡ç†" class="headerlink" title="é•œåƒç®¡ç†"></a>é•œåƒç®¡ç†</h3><p>ä¸ºäº†é€‚é…è¿™å¥—å‘å¸ƒæµç¨‹ï¼Œæˆ‘ä»¬å°† Kubernetes é›†ç¾¤éƒ¨ç½²å’Œå¹³å°ç»„éƒ¨ç½²å°†æ‰€ä½¿ç”¨çš„é•œåƒæ”¶æ•›åˆ° library å’Œ release ä¸¤ä¸ª projectï¼š</p><ul><li>å¯¹äºå¼€æºçš„é•œåƒï¼Œå³ç›´æ¥ä½¿ç”¨ docker.ioã€k8s.gcr.ioã€quay.io è¿™äº›å®˜æ–¹ registry ä¸­çš„é•œåƒï¼Œå°†ä¼šç»Ÿä¸€ä½¿ç”¨ library è¿™ä¸ª projectï¼Œæ¯”å¦‚ <code>library/nginx:1.19.0</code>ã€‚</li><li>å¯¹äºå¹³å°ç»„ä»¶è‡ªèº«çš„é•œåƒï¼Œå¦‚è‡ªç ”ç»„ä»¶ä½¿ç”¨è‡ªå·±çš„ Dockerfile build å‡ºæ¥çš„é•œåƒåˆ™ç»Ÿä¸€ä½¿ç”¨ release è¿™ä¸ª projectï¼Œæ¯”å¦‚ <code>release/cyclone:v1.2.0</code> ã€‚</li></ul><p>release project ä¸­çš„é•œåƒæ˜¯æˆ‘ä»¬å¹³å°ç»„ä»¶çš„é•œåƒï¼Œèƒ½å¾ˆæ–¹ä¾¿åœ°çŸ¥é“è¯¥é•œåƒæ¥è‡ªå“ªä¸ªç»„ä»¶ä»¥åŠæ˜¯å¦‚ä½•æ„å»ºçš„ã€‚ä½†å°†ä¸€äº›ä¸Šæ¸¸å®˜æ–¹çš„é•œåƒç»Ÿä¸€åˆ° library è¿™ä¸ª project ä¹‹åï¼Œå°±å¾ˆéš¾çŸ¥é“è¯¥é•œåƒçš„åŸé•œåƒæ˜¯ä»€ä¹ˆäº†ã€‚æ¯”å¦‚ <code>library/coredns:1.7.0</code> è¿™ä¸ªé•œåƒï¼Œä»…ä»…é€šè¿‡è¿™ä¸ªåå­—å¾ˆéš¾è¾¨åˆ«å‡ºå®ƒæ˜¯æ¥è‡ª docker.io è¿˜æ˜¯ k8s.gcr.ioã€‚å› æ­¤ä¸ºäº†è§£å†³è¿™ç±»é—®é¢˜å’Œæ–¹ä¾¿è¿½æº¯ä¸Šæ¸¸åŸé•œåƒï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ç»Ÿä¸€çš„é•œåƒåŒæ­¥é…ç½®æ–‡ä»¶æ¥å¤„ç†è¿™ç§è½¬æ¢å…³ç³»ï¼Œåœ¨æ‰“åŒ…å‘å¸ƒçš„æ—¶å€™æˆ‘ä»¬ä¼šå°†è¿™äº›é•œåƒè¿›è¡Œè‡ªåŠ¨åœ°è½¬æ¢å’Œå¤„ç†ï¼Œè¿™æ ·é¿å…äº†å¾ˆå¤šæ‰‹åŠ¨ push é•œåƒçš„éº»çƒ¦å’Œä½¿ç”¨é•œåƒé”™è¯¯çš„é—®é¢˜ã€‚</p><ul><li>images_origin.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># kubeadm core images</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-apiserver</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/kube-apiserver</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-controller-manager</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/kube-controller-manager</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-proxy</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/kube-proxy</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-scheduler</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/kube-scheduler</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/coredns</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/coredns</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/pause</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/pause</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes addons</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/dns/k8s-dns-node-cache</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/k8s-dns-node-cache</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/cluster-proportional-autoscaler-amd64</span></span><br><span class="line"><span class="comment"># network plugin</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/cni</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/calico-cni</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/kube-controllers</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/calico-kube-controllers</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/node</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/calico-node</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/typha</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/calico-typha</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/coreos/flannel</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/flannel</span></span><br><span class="line"><span class="comment"># nginx for daemonset and offline resources</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/nginx</span></span><br><span class="line"><span class="comment"># docker registry for offline resources</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">docker.io/library/registry</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/registry</span></span><br><span class="line"><span class="comment"># helm chartmuseum for offline resources</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">ghcr.io/helm/chartmuseum</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/chartmuseum</span></span><br><span class="line"><span class="comment"># yq eval -j images.yml | jq -r '.[]|select(.dest=="'"$&#123;image&#125;"'") | .src'</span></span><br></pre></td></tr></table></figure><h3 id="è¡¥ä¸åŒ…ç®¡ç†"><a href="#è¡¥ä¸åŒ…ç®¡ç†" class="headerlink" title="è¡¥ä¸åŒ…ç®¡ç†"></a>è¡¥ä¸åŒ…ç®¡ç†</h3><p>äº§å“çš„æ­£å¼ç‰ˆæœ¬åœ¨å‘å¸ƒä¸ä¹…ä¹‹åï¼Œåœ¨å®¢æˆ·ä½¿ç”¨çš„è¿‡ç¨‹ä¸­å¦‚æœå‘ç°æ–°çš„ bug æˆ–è€…å®¢æˆ·æå‡ºä¸€äº›æ–°çš„éœ€æ±‚ã€‚æˆ‘ä»¬è¿™æ—¶ä¼šåŸºäºè¿™äº›éœ€æ±‚å‘å¸ƒä¸€ä¸ªçƒ­æ›´æ–°è¡¥ä¸åŒ…ï¼Œè€Œä¸æ˜¯å‘å¸ƒä¸€ä¸ªæ–°ç‰ˆæœ¬ã€‚å› ä¸ºçƒ­æ›´æ–°è¡¥ä¸åŒ…æ‰€æ¶‰åŠä¿®æ”¹çš„ç»„ä»¶æ¯”è¾ƒå°‘ï¼Œéœ€è¦å‚ä¸çš„ç ”å‘äººå‘˜ä¹Ÿæ¯”è¾ƒå°‘ï¼Œè¿™æ ·èƒ½å¤ŸèŠ‚çœå¾ˆå¤šäººåŠ›æˆæœ¬ã€‚åŒæ—¶é‡‡ç”¨è¡¥ä¸åŒ…çš„æ–¹å¼è¿›è¡Œçƒ­æ›´æ–°èƒ½å¤Ÿä¿éšœå®¢æˆ·ç¯å¢ƒçš„ç¨³å®šè¿è¡Œï¼Œå¹³å°ç¨³å®šæ€§ä¹Ÿèƒ½å¤Ÿå¾—åˆ°ä¿éšœã€‚</p><p>åœ¨å‘å¸ƒæµç¨‹ä¸­æˆ‘ä»¬æ›¾æåˆ°ï¼Œå‘å¸ƒè¿‡ç¨‹ä¸­ä¼šç»™ repo æ‰“ä¸Šä¸€ä¸ªäº§å“ç‰ˆæœ¬çš„ tagï¼Œæ¯”å¦‚ <code>v2.10.2</code>ï¼Œåœ¨è¿™é‡Œéœ€è¦å¼ºè°ƒä¸€ä¸‹ï¼Œ<strong>è¿™ç‰ˆæœ¬å·ç‰¹åˆ«é‡è¦ã€‚</strong>åç»­æ‰€æœ‰çš„è¡¥ä¸åŒ…å‘å¸ƒéƒ½ä¼šå¼ºä¾èµ–äºæ­¤ç‰ˆæœ¬å·ï¼Œå› æ­¤æˆ‘ä»¬ä¼šåœ¨ repo çš„ä¿æŠ¤ tag é‡Œå°†è¿™ç§æ­£å¼å‘å¸ƒçš„ repo tag è¿›è¡Œé”å®šä¿æŠ¤èµ·æ¥ï¼Œç¦æ­¢<code>--force</code> æ–¹å¼è¦†ç›–ã€‚åœ¨éƒ¨ç½²çš„æ—¶å€™ï¼Œè¿™ä¸ªç‰ˆæœ¬å·ä¹Ÿä¼šä»¥ configmap çš„æ–¹å¼è®°å½•èµ·æ¥ï¼Œç”¨äºåœ¨å‰ç«¯ web é¡µé¢ä¸Šå±•ç¤ºå¹³å°ç‰ˆæœ¬å’Œåç»­å®‰è£…è¡¥ä¸åŒ…æ—¶è¿›è¡Œç‰ˆæœ¬æ ¡éªŒã€‚</p><p>è¡¥ä¸åŒ…å‘å¸ƒçš„é¢‘ç‡ä¹Ÿæ˜¯è›®é«˜çš„ï¼Œä»å»å¹´äº”æœˆä»½åˆ°ç°åœ¨ä¸€å¹´å·¦å³çš„æ—¶é—´é‡Œï¼Œè‡ªå·±è´Ÿè´£çš„è¡¥ä¸åŒ…å‘å¸ƒæ•°é‡å¤§çº¦æœ‰ 50 ä¸ªå·¦å³ï¼Œå¹³å‡æ¯å‘¨ä¸€ä¸ªã€‚åŒä¸€ä¸ªç‰ˆæœ¬æˆ– OEM é¡¹ç›®ï¼Œè¡¥ä¸åŒ…å‘å¸ƒçš„æ•°é‡ä¹Ÿå¤§ä¸ç›¸åŒï¼ˆå°‘åˆ™ä¸‰å››ä¸ªï¼Œå¤šåˆ™åä¸ƒå…«ä¸ªï¼‰ã€‚å½“è¡¥ä¸åŒ…çš„æ•°é‡è¶Šæ¥è¶Šå¤šæ—¶ï¼Œå°±éœ€è¦ä¸€å¥—æœºåˆ¶æ¥ç®¡ç†è¿™äº›å¤æ‚ç¯å¢ƒçš„è¡¥ä¸åŒ…ã€‚ä¸ç„¶çš„è¯ç‰ˆæœ¬å‘å¸ƒå°†ä¼šå˜å¾—ååˆ†æ··ä¹±ï¼Œå¯¼è‡´å®¢æˆ·ç”Ÿäº§ç¯å¢ƒå®‰è£…ä¸Šé”™è¯¯ç‰ˆæœ¬çš„ç»„ä»¶ï¼Œç”±æ­¤å¯èƒ½å¯¼è‡´ç”Ÿäº§äº‹æ•…ã€‚</p><p>å› æ­¤åœ¨è®¾è®¡è¡¥ä¸åŒ…å‘å¸ƒæ–¹æ¡ˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¾æ—§å’Œæ ‡å‡†äº§å“çš„å‘å¸ƒæµç¨‹ç»“åˆèµ·æ¥ï¼Œä½¿ç”¨ git repo tag + åˆ†æ”¯çš„æ–¹å¼æ¥ç®¡ç†è¿™äº›è¡¥ä¸åŒ…çš„å‘å¸ƒå·¥ä½œã€‚æ•´ä½“çš„å‘å¸ƒæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>PM å®‰æ’ç ”å‘äººå‘˜ä¿®å¤ç»„ä»¶ bugï¼›</li><li>ç»„ä»¶è´Ÿè´£äººå®Œæˆå†’çƒŸæµ‹è¯•ï¼Œå¹¶åœ¨å†…éƒ¨ DevOps å¹³å°æ‰“é•œåƒå’Œ repo tagï¼›</li><li>ç»„ä»¶è´Ÿè´£äººä¿®æ”¹å‘å¸ƒ repo ä¸­ addons ç›®å½•ä¸‹å¯¹åº”ç»„ä»¶çš„ chart æ–‡ä»¶ï¼›</li><li>PM é€šçŸ¥å‘å¸ƒäººå‘˜å¼€å§‹å‘å¸ƒè¡¥ä¸åŒ…ï¼›</li><li>å‘å¸ƒäººå‘˜è¿è¡Œæµæ°´çº¿ä»»åŠ¡è‡ªåŠ¨åŒ–æ‰“è¡¥ä¸åŒ…ï¼›</li><li>æµ‹è¯•äººå‘˜éªŒè¯è¡¥ä¸åŒ…çš„è´¨é‡ï¼›</li></ul><p>åœ¨æ‰“åŒ…è¡¥ä¸åŒ…çš„æ—¶å€™æˆ‘ä»¬é‡‡ç”¨ git diff çš„æ–¹å¼ï¼Œå°†æœ¬æ¬¡è¡¥ä¸åŒ…å‘å¸ƒæ‰€ä¿®æ”¹çš„ç»„ä»¶ Chart æ–‡ä»¶ç­›é€‰å‡ºæ¥ï¼Œåªå¯¹è¿™äº›ä¿®æ”¹çš„ç»„ä»¶è¿›è¡Œæ‰“åŒ…æ“ä½œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> chart <span class="keyword">in</span> $(git diff --name-only --diff-filter=AM --ignore-space-at-eol --ignore-space-change <span class="variable">$&#123;DENPENDENCY_VERSION&#125;</span> <span class="variable">$&#123;NEW_VERSION&#125;</span> <span class="variable">$&#123;ADDONS_PATH&#125;</span> | sed -n <span class="string">'s/Chart.yaml//p'</span> | sort -u );<span class="keyword">do</span> cp -rf <span class="variable">$&#123;chart&#125;</span> <span class="variable">$&#123;HOTFIX_YAML_DIR&#125;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>å¯¹äºä¸€äº› OEM é¡¹ç›®ï¼Œæˆ‘ä»¬ä¼šåŸºäºäº§å“ç‰ˆæœ¬çš„åˆ†æ”¯åˆ›å»ºä¸€ä¸ªä¸è¯¥ OEM äº§å“ç›¸å¯¹åº”çš„å‘å¸ƒåˆ†æ”¯ï¼Œå¦‚ <code>release-2.10/muzi502</code>ï¼Œå³ä»£è¡¨ muzi502 è¿™ä¸ªå®¢æˆ·ä½¿ç”¨çš„äº§å“ç‰ˆæœ¬æ˜¯åŸºäº 2.10 ç‰ˆæœ¬çš„ã€‚åœ¨è¿™ä¸ªåˆ†æ”¯ä¸Šæˆ‘ä»¬åŸºäºä¸Šè¿°æ­¥éª¤è¿›è¡Œ OEM è¡¥ä¸åŒ…çš„å‘å¸ƒã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot;
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubernetes" scheme="https://blog.k8s.li/tags/kubernetes/"/>
    
      <category term="PaaS" scheme="https://blog.k8s.li/tags/PaaS/"/>
    
      <category term="toB" scheme="https://blog.k8s.li/tags/toB/"/>
    
  </entry>
  
  <entry>
    <title>2021 äº”ä¸€å‡æœŸç¯å¤ªæ¹–éª‘è¡Œä¹‹æ—…</title>
    <link href="https://blog.k8s.li/taihu.html"/>
    <id>https://blog.k8s.li/taihu.html</id>
    <published>2021-05-29T16:00:00.000Z</published>
    <updated>2021-05-29T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>è°ƒä¼‘ä¸¤å¤©ç»ˆäºè¿æ¥äº†äº”å¤©çš„äº”ä¸€å‡æœŸï¼Œå®é™…ä¸Šä»…ä»…æ”¾äº†ä¸€å¤©å‡æœŸï¼Œä¹Ÿæœ‰ç½‘å‹è°ƒä¾ƒåˆ° <strong>äººä»¬ 996 è¿ç»­å·¥ä½œ 12 å¤©ä»è€Œæ¢å– 5 å¤©å‡æœŸå»çºªå¿µè¿™ä¸ªå·¥äººè·å¾— 8 å°æ—¶å·¥ä½œåˆ¶çš„èŠ‚æ—¥</strong>ã€‚</p><p>æ˜¥èŠ‚çš„æ—¶å€™å°±åœ°è¿‡å¹´æ²¡æœ‰å›å®¶ï¼Œç‹¬è‡ªä¸€äººåœ¨æ­å·å‘†äº† 7 å¤©ï¼Œè¿™ 7 å¤©ä¸€ç›´å®…åœ¨å®¶é‡Œçœ‹ä¹¦å’Œè¿½ç•ªï¼Œç”šè‡³è¿å°åŒºçš„é—¨éƒ½æ²¡å‡ºå»è¿‡ã€‚ä¸ºäº†ä¸è®©å®è´µçš„äº”ä¸€å‡æœŸçƒ‚åœ¨å®¶é‡Œï¼Œåœ¨ 4 æœˆåˆçš„æ—¶å€™å°±å¼€å§‹è®¡åˆ’ç¯å¤ªæ¹–çš„éª‘è¡Œä¹‹æ—…ã€‚</p><p>è®°å¾—ä¸Šä¸€æ¬¡é•¿è¿œçš„éª‘è¡Œè¿˜æ˜¯é«˜è€ƒå®Œçš„é‚£ä¸ªæš‘å‡ï¼Œä¹Ÿæ˜¯ç‹¬è‡ªä¸€äººä»å®¶éª‘è½¦å»åŒ—äº¬ï¼Œæ¥å›ç”¨äº†äº”å¤©æ—¶é—´ã€‚ç®€å•ä¼°è®¡äº†ä¸€ä¸‹ä»æ­å·éª‘è¡Œåˆ°å¤ªæ¹–ï¼Œç„¶åç¯å¤ªæ¹–éª‘è¡Œä¸€å‘¨ï¼Œæ€»çš„è·¯ç¨‹å¤§æ¦‚ 520 å…¬é‡Œï¼Œä¹Ÿæ­£å¥½äº”å¤©çš„æ—¶é—´ã€‚ç­‰åˆ°å›æ¥çš„æ—¶å€™å¦‚æœèº«ä½“åƒä¸æ¶ˆå†è°ƒä¼‘å‡ å¤©ä¹Ÿæ²¡å•¥å¤§ç¢ã€‚äºæ˜¯ï¼Œä¸€ä¸ªç¯å¤ªæ¹–éª‘è¡Œçš„è®¡åˆ’æ…¢æ…¢åœ¨è„‘ä¸­é…é…¿äº†ï¼Œé‚£ä¹ˆå¼€å§‹å›é¡¾è¿™æ®µéª‘è¡Œä¹‹æ—…å§ï¼š</p><h2 id="å‡†å¤‡ç¯‡"><a href="#å‡†å¤‡ç¯‡" class="headerlink" title="å‡†å¤‡ç¯‡"></a>å‡†å¤‡ç¯‡</h2><p>å±±åœ°è½¦æ˜¯å»å¹´åˆšæ¥æ­å·æ—¶å°±ä¹°çš„ï¼Œåœ¨é—²é±¼ä¸ŠèŠ±äº† 800 å—é’±ä¹°çš„ 2012 æ¬¾ GIANT æ·å®‰ç‰¹ ATX770-Dï¼Œåˆ°ç°åœ¨ä¹Ÿæ˜¯æœ‰äº›å¹´å¤´äº†ã€‚ä¸Šä¸‹ç­éª‘è¡Œç”¨äº†ä¸€å¹´å¤šä¹Ÿæ²¡å•¥å¤§æ¯›ç—…ï¼Œè¿™ä¸€å¹´é—´å°±åè½®å¡”åŸºé‡Œçš„è½´æ‰¿åäº†ä¸€æ¬¡ï¼Œè‡ªå·±ä¹°æ¥å·¥å…·æ‹†å¼€ç»™è½´æ‰¿è¡¥ä¸Šç¼ºæŸçš„ç å­å¹¶ä¸Šå¥½é»„æ²¹å¯†å°å°±ä¿®å¥½äº†ã€‚</p><p><img src="https://p.k8s.li/20210501_021308214_iOS.jpg" alt=""></p><p>åœ¨äº”æœˆçš„æœ€åä¸¤å‘¨ä¸€ç›´åœ¨å‡†å¤‡éª‘è¡Œçš„è£…å¤‡ï¼ŒæŠŠåè½®çš„å¤–èƒæ¢äº†ä¸€æ¡æ–°çš„ï¼Œå› ä¸ºæ—§çš„ç£¨æŸå¤ªä¸¥é‡äº†ï¼Œä¸­é—´éƒ¨åˆ†åŸºæœ¬ç£¨å¹³äº†ï¼Œå¦‚æœä¸æ¢æ‰çš„è¯ä¿ä¸å‡†è¿™ä¸€è·¯ä¼šçˆ†èƒã€‚å¦å¤–åˆå‡†å¤‡äº†ä¸¤æ¡å†…èƒä»¥åº”å¯¹çˆ†èƒçš„æƒ…å†µã€‚åˆä¹°äº†ä¸€ä¸ªäºŒæ°§åŒ–ç¢³å……æ°”æ³µå’Œ 4 ç“¶äºŒæ°§åŒ–ç¢³è¡¥æ°”ç“¶ï¼Œä»¥åŠå¤šåŠŸèƒ½æ‰³æ‰‹ã€‚å°†è¿™ä¸€äº›ç»´ä¿®å·¥å…·å…¨éƒ¨æ”¾åˆ°äº†è½¦æ¶çš„ä¸‰è§’åŒ…é‡Œé¢ã€‚</p><p>å¦å¤–åœ¨æ­¤å¼ºçƒˆæ¨èè½¦æ¶ä¸ŠæŒ‚çš„ä¸‰è§’åŒ…ã€‚å®ƒçš„ç©ºé—´æ”¾ä¸‹ä¿®è½¦å¸¸ç”¨çš„å·¥å…·å’Œä¸€æ¡å†…èƒç»°ç»°æœ‰ä½™ï¼Œè¿™æ ·å³ä¾¿æ˜¯ä¸€åˆ°ä¸¤å¤©çš„çŸ­é€”éª‘è¡Œä¹Ÿèƒ½å¸¦é½è£…å¤‡è½»è£…ä¸Šé˜µï¼Œå”¯ä¸€ä¸è¶³çš„å°±æ˜¯è¦ç‰ºç‰²æ‰æ°´å£¶ä½ã€‚</p><p>ä¸ºäº†æ”¾ä¸‹ååº§æ¶çš„é©¼åŒ…ï¼ŒåˆèŠ±äº†ä¸‰åå¤šå—é’±ä¹°äº†åè½¦æ¶ï¼Œå°†é©¼åŒ…å›ºå®šåœ¨ä¸Šé¢ã€‚é©¼åŒ…é‡Œé¢å¸¦çš„ä¸œè¥¿è¿˜è›®å¤šçš„ï¼šå‡ ä»¶æ¢æ´—çš„è¡£æœã€é›¨è¡£å’Œé›¨ä¼ã€å……ç”µå®ã€æ¯›å·¾çº¸å·¾ç­‰ã€‚æ°´æ²¡æœ‰å¸¦å¤ªå¤šï¼Œåœ¨è·¯ä¸Šéšä¾¿ä¹°ç€å–å°±è¡Œã€‚</p><h2 id="å‡ºå‘ç¯‡"><a href="#å‡ºå‘ç¯‡" class="headerlink" title="å‡ºå‘ç¯‡"></a>å‡ºå‘ç¯‡</h2><p>å‡ºå‘å‰å¤©æ™šä¸Šä¸€ç›´ç¡ä¸ç€ï¼Œè„‘å­å®åœ¨æ˜¯å¤ªå…´å¥‹äº†ï¼Œè¿™ç§æ„Ÿè§‰å°±åƒæ˜¯é«˜ä¸­æ”¾å¯’æš‘å‡çš„å‰å¤©æ™šä¸Šä¸€æ ·ï¼Œç»ˆäºå¯ä»¥ç—›å¿«åœ°æ”¾æ¾ä¸€ä¸‹äº†ã€‚äº”ä¸€å½“å¤©æ—©ä¸Š 8 ç‚¹èµ·åºŠçš„ï¼Œæœ¬è®¡åˆ’ç€ 6 ç‚¹èµ·åºŠå‡ºå‘çš„ï¼Œå› ä¸ºæ—©ä¸Šå‡‰å¿«è½¦å°‘æ¯”è¾ƒé€‚åˆéª‘è¡Œã€‚æ”¶æ‹¾ä¸€ä¸‹è£…å¤‡ä¸‹æ¥¼å‡†å¤‡å‡ºå‘ï¼Œç¦»å¼€å°åŒºæ²¡å¤šä¹…åå°±å‘ç°ï¼šæˆ‘è‰¹ï¼Œä¿å‘½å¤´ç›”æ²¡å¸¦ï¼è¿™æ€ä¹ˆèƒ½è¡Œï¼Œäºæ˜¯å±é¢ é¢ åœ°è¿”å›å®¶é‡Œæ‹¿å¤´ç›”ã€‚è™½ç„¶å¤´ç›”æ˜¯å‡ åå—é’±çš„ç ´çƒ‚è´§ï¼Œä½†å…³é”®æ—¶åˆ»è¿˜æ˜¯èƒ½ä¿å°å‘½ä¸€æ¡æ»´ï¼Œè¿˜æ˜¯è¦æˆ´ä¸Šæ»´ã€‚</p><p>ç¬¬ä¸€å¤©å‡†å¤‡å…ˆéª‘è¡Œåˆ°æ¹–å·ï¼Œå› ä¸ºä¸´è¿‘å¤ªæ¹–çš„åŸå¸‚ä¸­ï¼Œæ¹–å·æ˜¯è·ç¦»æ­å·æœ€è¿‘çš„ä¸€ä¸ªï¼Œæ­£å¥½å¯ä»¥æŠŠæ¹–å·å½“ä½œç¯å¤ªæ¹–éª‘è¡Œçš„å‡ºå‘ç‚¹ï¼Œæœ€ç»ˆå†è¿”å›è¿™é‡Œã€‚ä»åœ°å›¾ä¸Šçœ‹ï¼Œæ­å·åˆ°å¤ªæ¹–é€‚åˆéª‘è¡Œçš„çš„æœ€ä½³è·¯çº¿å°±æ˜¯æ²¿ç€ç¬¤ï¼ˆtiaoï¼‰æºªæ—çš„å…¬è·¯ç›´è¾¾æ¹–å·ï¼Œæˆ‘ä»¬è¿™é‡Œæš‚å®šå®ƒæ¡è·¯ä¸ºç¬¤æºªè·¯ã€‚åªè¦è¿›å…¥åˆ°è¿™æ¡æ²¿æºªå…¬è·¯åŸºæœ¬ä¸Šæ— éœ€å¯¼èˆªå’Œåœ°å›¾å°±èƒ½åˆ°è¾¾æ¹–å·ï¼Œè€Œä¸”è¿™æ¡è·¯ä¸Šçš„è·¯ç»¿ç¯ç‰¹åˆ«å°‘ï¼Œè½¦è¾†ç›¸å¯¹äºå›½é“å’Œçœé“ä¹Ÿå°‘å¾ˆå¤šï¼Œè·¯è¾¹æœ‰å¤§ç‰‡çš„ç»¿åŒ–å¸¦æ ‘æ—å¯ä»¥é®é˜´ï¼Œä»¥åŠä¸´è¿‘æ°´è¾¹ç©ºæ°”è´¨é‡å’Œæ¹¿åº¦éƒ½ååˆ†å®‰é€¸ã€‚</p><p><img src="https://p.k8s.li/20210501_031349626_iOS.jpg" alt=""></p><p><img src="https://p.k8s.li/20210501_040031464_iOS.jpg" alt=""></p><h2 id="Day-1-æ­å·-â€“-gt-æ¹–å·-â€“-gt-é•¿å…´"><a href="#Day-1-æ­å·-â€“-gt-æ¹–å·-â€“-gt-é•¿å…´" class="headerlink" title="Day 1 æ­å· â€“&gt; æ¹–å· â€“&gt; é•¿å…´"></a>Day 1 æ­å· â€“&gt; æ¹–å· â€“&gt; é•¿å…´</h2><p>å¤§æ¦‚ä¸Šåˆä¹ç‚¹å·¦å³å°±è¿›å…¥åˆ°ç¬¤æºªè·¯ï¼Œå½“æ—¶éšèº«æºå¸¦çš„ä¸€ç“¶çŸ¿æ³‰æ°´ä¹Ÿä¸€å£é—·å–å®Œäº†ã€‚åé¢ä¸€ç›´æ²¿ç€è¿™æ¡è·¯éª‘è¡Œè·¯ä¸¤ä¸ªå°æ—¶ä¾æ—§æ²¡æœ‰åœ¨è·¯è¾¹æ‰¾åˆ°ä»»ä½•ä¸€å®¶è¶…å¸‚ï¼Œååˆ†åƒµç¡¬ã€‚åªå¥½çœ‹åœ°å›¾æ‰¾åˆ°å¾·æ¸…å¿çš„ä¸€ä¸ªå°ä¹¡é•‡ï¼Œäºæ˜¯ç»•é“è¿™ä¸ªè¿™ä¸ªå°ä¹¡é•‡é‡Œä¹°æ°´å’Œåƒé¥­ã€‚ä¸­åˆåƒå®Œé¥­ä¹‹åæ„Ÿè§‰å®åœ¨æ˜¯å¤ªçƒ­ï¼Œæ‰°æ‰°å¤´å‘ç°å¤´å‘å¥½é•¿ï¼Œå¤§æ¦‚æœ‰ä¸‰ä¸ªæœˆæ²¡æœ‰ç†å‘ ğŸ¥²ï¼Œæ˜¯æˆ‘å¤ªæ‡’äº†ï¼Œå¹³æ—¶å¾ˆå°‘åœ¨æ„è¿™ä»¶äº‹å„¿ã€‚è¿™ä¹ˆçƒ­çš„å¤©å¤´å‘å¤´é¡¶ç€è¿™ä¹ˆé•¿ä¹Ÿä¸æ˜¯ä¸ªå¥½åŠæ³•ï¼Œäºæ˜¯åœ¨è·¯è¾¹éšä¾¿æ‰¾è·¯ä¸€å®¶ç†å‘ç‚¹å‰ªçŸ­äº†å¤´å‘ã€‚</p><ul><li>ç†å®Œå‘ä¹‹åå·²ç»ä¸­åˆåäºŒç‚¹åŠäº†ï¼Œåº”è¯¥æ‰¾ä¸ªåœ°æ–¹ç¨ä½œä¼‘æ¯ä¸€ä¸‹ã€‚äºæ˜¯è¿˜æ˜¯è¿”å›åˆ°ç¬¤æºªè·¯ï¼Œåœ¨è·¯è¾¹çš„ç»¿åŒ–å¸¦æ ‘æ—é‡Œæ‰¾åˆ°è·¯ä¸ªåˆé€‚çš„å¤§çŸ³å¤´ã€‚å°†éšèº«æºå¸¦çš„æ¢æ´—è¡£æœå½“ä½œæ•å¤´ï¼Œé›¨è¡£åœ¨çŸ³å¤´ä¸Šä¸€æ‘Šå°±æ˜¯ä¸ªç®€æ˜“çš„å°åºŠäº†ï¼Œèººç€ä¼‘æ¯ä¸€ä¸ªåŠå°æ—¶å†å‡ºå‘ã€‚</li></ul><p><img src="https://p.k8s.li/20210501_050737596_iOS.jpg" alt=""></p><ul><li>åœ¨ç¬¤æºªè·¯è·¯è¾¹çš„ç»¿åŒ–å¸¦æ ‘æ—é‡Œæœ‰ç‰¹åˆ«å¤šçš„å¤§æ ‘è¢«é£å¹æ–­ï¼Œå¿ƒç–¼æ ‘æ ‘ ğŸ¥º</li></ul><p><img src="https://p.k8s.li/20210501_064702113_iOS.jpg" alt=""></p><ul><li>åˆ°äº†ä¸‹åˆäº”ç‚¹å·¦å³åˆ°è¾¾æ¹–å·çš„å¤ªæ¹–é£æ™¯åŒºï¼Œæ‹æ‘„åœ°ç‚¹ä¸ºæ¹–æ»¨è·¯é™„è¿‘çš„å…¬å›­</li></ul><p><img src="https://p.k8s.li/20210501_092945406_iOS.jpg" alt=""></p><p>åœ¨æ™¯åŒºä¼‘æ¯äº†åŠä¸ªå¤šå°æ—¶ä¹‹åï¼Œå¤©å·²ç»å¿«é»‘äº†ï¼ŒåŸæœ¬å‡†å¤‡å½“æ™šä½åœ¨æ¹–å·ï¼Œä½†å‘ç°é™„è¿‘äº”å…¬é‡Œå†…çš„é…’ä»·æ ¼æ™®éåœ¨ 3kï½5k ä¹‹é—´ã€‚æ¯•ç«Ÿæ˜¯ä¸´è¿‘å¤ªæ¹–é£æ™¯åŒºï¼Œè€Œä¸”æ˜¯äº”ä¸€é»„é‡‘å‘¨ï¼Œä»·æ ¼é«˜çš„ç¦»è°±å¯ä¸æ˜¯å’±è¿™ç§éŸ­èœå’Œä½ç«¯äººå£èƒ½å¤Ÿäº«å—çš„ ğŸ¥²ã€‚äºæ˜¯åœ¨æœä¸€ä¸‹åå…¬é‡Œå¤–çš„åŸåŒºï¼Œè™½ç„¶ä»·æ ¼èƒ½å¤Ÿæ¥å—ã€‚ä½†è¦éª‘è¡Œåå¤šå…¬é‡Œï¼Œè€Œä¸”åœ¨åŸåŒºéª‘è¡Œçº¢ç»¿ç¯ç‰¹åˆ«å¤šï¼Œååˆ†æµªè´¹æ—¶é—´ã€‚ç¬¬äºŒå¤©æ—©ä¸Šåˆå¾—éª‘è¡Œåå¤šå…¬é‡Œè¿”å›ç¯å¤ªæ¹–å…¬è·¯ï¼Œæ„Ÿè§‰æ¥å›äºŒåå¤šå…¬é‡Œè¿˜ä¸å¦‚å¾€å‰é¢æ¥ç€éª‘è¡Œï¼Œåœ¨è¿œä¸€ç‚¹çš„åœ°æ–¹æ‰¾ä¸€ä¸ªåˆé€‚çš„é…’åº—ä½ä¸‹ã€‚äºæ˜¯åœ¨åœ°å›¾ä¸Šå‘ç°é•¿å…´ç«è½¦ç«™è·ç¦»å¤ªæ¹–ååˆ†è¿‘ï¼Œç«è½¦ç«™é™„è¿‘è‚¯å®šæœ‰é…’åº—ã€‚äºæ˜¯æ¥ç€æ‰¾äº†è·ç¦»ç¯å¤ªæ¹–è·¯æœ€è¿‘çš„é…’åº—ã€‚è·ç¦»å½“å‰åœ°ç‚¹äºŒåå…¬é‡Œå·¦å³ï¼Œå¦‚æœç°åœ¨éª‘è¡Œçš„è¯ï¼Œä¸€å°æ—¶å·¦å³åº”è¯¥å°±èƒ½éª‘åˆ°é…’åº—ã€‚åº”è¯¥æ²¡é—®é¢˜ï¼Œå› ä¸ºå¤©å·²ç»å¿«é»‘äº†ï¼Œä¸å†èµ¶ç´§éª‘è¡Œçš„è¯å°†è¦å¤œé—´éª‘è¡Œï¼Œå¾ˆä¸å®‰å…¨ã€‚</p><p>äºæ˜¯å½“æ—¶åšäº†ä¸€ä¸ªå¾ˆè ¢çš„å†³å®šï¼Œç»§ç»­éª‘è¡Œï¼Œå¿˜è®°äº†åƒæ™šé¥­ã€‚æœ¬æ¥åˆé¥­åƒçš„å°±æ¯”è¾ƒå°‘ï¼Œä¹Ÿæ²¡æœ‰åŠæ—¶è¡¥å……èƒ½é‡ï¼Œä½“åŠ›å·²ç»å¿«åˆ°è¾¾äº†æé™ã€‚äºæ˜¯åœ¨ä½“åŠ›ä¸å ªçš„æƒ…å†µä¸‹åˆç»§ç»­éª‘è¡Œäº†äºŒåå…¬é‡Œã€‚åˆ°è¾¾é•¿å…´ç«è½¦ç«™é™„è¿‘åï¼Œè·ç¦»é…’åº—å°±ä¸åˆ°ä¸¤å…¬é‡Œçš„è·¯ç¨‹äº†ã€‚ä»¤æˆ‘æ„æƒ³ä¸åˆ°çš„æ˜¯ï¼Œåˆšè¿‡ç«è½¦ç«™ä¸ä¹…åï¼Œå°±å‡ºçªç„¶å‡ºç°å¤´æ™•æ¶å¿ƒçš„ä¸é€‚ã€‚åœä¸‹æ¥æ­‡æ¯äº†åŠä¸ªå°æ—¶æ‰ç¼“è¿‡æ¥ï¼Œä»¥è‡³äºæœ€åçš„ä¸¤å‘¨é‡ŒåŸºæœ¬ä¸Šæ˜¯æ¨ç€è½¦å­èµ°äº†åŠä¸ªå°æ—¶æ‰åˆ°çš„é…’åº—ã€‚åˆ°è¾¾é…’åº—å·²ç»å…«ç‚¹åŠäº†ï¼Œå·²ç»å¿«ä¹ä¸ªå°æ—¶æ²¡åƒä¸œè¥¿äº†ï¼Œæ„Ÿè§‰ç‰¹åˆ«ç´¯ã€å…¨èº«æ— åŠ›ã€‚</p><p>æŠŠè½¦å­æ¨åˆ°æˆ¿é—´é‡Œç®€å•æ´—æ¼±äº†ä¸€ä¸‹ï¼Œå°±å»æ¥¼ä¸‹çš„å¤œå¸‚åƒç‚¹é¥­ã€‚ç‚¹äº†ä¸€ç›˜å‡‰æ‹Œé»„ç“œå’Œå¹²é”…åŒ…èœï¼Œæ²¡æƒ³åˆ°ç­‰äº†åŠä¸ªå°æ—¶â€¦â€¦</p><p>åƒå®Œé¥­ååœ¨è¶…å¸‚ä¹°äº†å‡ ç“¶æ°´å’Œæ°´æœï¼Œå›åˆ°æˆ¿é—´çœ‹äº†ä¸€é›† <a href="">BBCï¼šå†°å†»æ˜ŸçƒÂ·å¦‚å±¥è–„å†°</a> çºªå½•ç‰‡å°±ç¡ç€äº†ã€‚</p><p><img src="https://p.k8s.li/20210501_141353000_iOS.png" alt=""></p><h2 id="Day-2-é•¿å…´-â€“-gt-æ— é”¡-â€“-gt-è‹å·"><a href="#Day-2-é•¿å…´-â€“-gt-æ— é”¡-â€“-gt-è‹å·" class="headerlink" title="Day 2 é•¿å…´ â€“&gt; æ— é”¡ â€“&gt; è‹å·"></a>Day 2 é•¿å…´ â€“&gt; æ— é”¡ â€“&gt; è‹å·</h2><p>ç¬¬äºŒå¤©æ—©ä¸Šä¸ƒç‚¹åŠèµ·åºŠï¼Œåœ¨æ¥¼ä¸‹çš„æ—©é¤åº—åƒæ—©é¥­ï¼Œä¹Ÿæ˜¯é…’åº—é™„èµ çš„ä¸€é¡¿æ—©é¤ã€‚åœ¨é…’åº—ä»¬å£å‘ç°äº†å¾ˆå¤šé©´å‹çš„å±±åœ°è½¦å’Œå…¬è·¯è½¦ï¼Œä¼°è®¡ä»–ä»¬æ˜¨æ™šä¹Ÿæ˜¯åœ¨è¿™é‡Œä¼‘æ¯çš„ã€‚åƒå®Œé¥­ä¹‹åæ”¶æ‹¾ä¸œè¥¿å‡ºå‘ï¼Œä¸‹ä¸€ç«™æ˜¯è‹å·ï¼Œæœ¬æƒ³ç€è¦å»æ— é”¡ï¼Œä½†ç”±äºæ—¶é—´ç¼˜æ•…è¿˜æ˜¯ä¸å»æ— é”¡äº†ï¼Œä»Šå¤©è¦éª‘è¡Œ 150 å¤šå…¬é‡Œåˆ°è¾¾è‹å·çš„è¥¿å±±é£æ™¯åŒºã€‚</p><p><img src="https://p.k8s.li/20210502_004340465_iOS.jpg" alt=""></p><p>åˆšåˆšå‡ºæ¥é…’åº—é—¨å£åˆ°è¾¾ 302 å›½é“åå°±å‘ç°ä»Šå¤©å¤©æ°”ååˆ†ä¸å¦™ï¼Œé€†é£ï¼éª‘è¡Œèµ·æ¥ç‰¹åˆ«è´¹åŠ²ï¼Œå¹³å‡æ—¶é€Ÿåªèƒ½ç»´æŒåœ¨ 18å…¬é‡Œ/å°æ—¶ï¼Œåªèƒ½å¥‹åŠ›éª‘è¡Œäº†ã€‚ä¸­åˆçš„æ—¶å€™åˆ°è¾¾äº†å®œå…´çš„ä¸€ä¸ªå°é•‡ï¼Œåœ¨é‚£é‡Œåƒäº†é¡¿åˆé¥­ï¼Œä¹‹åç»§ç»­éª‘è¡Œåˆ°äº†æ— é”¡å¸‚çš„åå…«æ¹¾æ¹¿åœ°å…¬å›­ï¼Œåœ¨å…¬å›­é‡Œçš„ä¸€ä¸ªæ¹–è¾¹ä¼‘æ¯äº†ä¸€ä¸ªå°æ—¶å€™å°±ç»§ç»­éª‘è¡Œã€‚åˆ°è¾¾æ— é”¡ä¹‹åæ²¡æœ‰ç»§ç»­æ²¿ç€å¤ªæ¹–å…¬è·¯éª‘è¡Œï¼Œè€Œæ˜¯é€‰æ‹©äº†æœ€çŸ­çš„è·¯çº¿åˆ°è¾¾è‹å·è¥¿å±±é£æ™¯åŒºã€‚</p><p><img src="https://p.k8s.li/20210502_010036044_iOS.jpg" alt=""></p><p>æ™šä¸Šåˆ°è¾¾è¥¿å±±é£æ™¯åŒºå·²ç»å…«ç‚¹å·¦å³äº†ï¼Œåˆ°è¾¾å‡¤å‡°å°æ™¯ç‚¹æ‰€åœ¨çš„å°å²›ä¹‹åï¼Œåœ¨æ™¯åŒºé‡Œçš„ä¸€å®¶é¥­åº—åƒé¡¿æ™šé¥­ï¼Œä¸€ä¸ªäººä¸‰èœä¸€æ±¤åƒå¾—ç‰¹åˆ«é¥±ã€‚ä¹‹ååˆç»§ç»­éª‘è¡Œåˆ°è¥¿å±±é£æ™¯åŒºé‡Œé¢çš„ä¸€å®¶æ°‘å®¿ã€‚åœ¨ç¾å›¢ä¸Šè®¢çš„ä»·æ ¼æ˜¯ 108Â¥ ä¸€ä¸ªå¤§åºŠå¤§é—´ã€‚</p><p><img src="https://p.k8s.li/20210502_110411190_iOS.jpg" alt=""></p><h2 id="Day-3-å¤ªæ¹–é£æ™¯åŒº-â€“-gt-è‹å·åŸåŒº"><a href="#Day-3-å¤ªæ¹–é£æ™¯åŒº-â€“-gt-è‹å·åŸåŒº" class="headerlink" title="Day 3 å¤ªæ¹–é£æ™¯åŒº â€“&gt; è‹å·åŸåŒº"></a>Day 3 å¤ªæ¹–é£æ™¯åŒº â€“&gt; è‹å·åŸåŒº</h2><p>æ—©ä¸Šä¸ƒç‚¹åŠèµ·åºŠï¼Œå°†é©¼åŒ…ä»å±±åœ°è½¦ä¸Šå¸äº†ä¸‹æ¥æ”¾åœ¨äº†æˆ¿é—´é‡Œã€‚ä»Šå¤©ä¸Šåˆåªåœ¨è¥¿å±±é£æ™¯åŒºç©å„¿ï¼Œä¸éœ€è¦å¸¦è¿™äº›è¡Œæï¼Œè¿™æ ·åœ¨å±±é‡Œéª‘è¡Œèµ·æ¥ä¹Ÿèƒ½æ”¾é£è‡ªæˆ‘ã€‚</p><ul><li>å»çš„ç¬¬ä¸€ä¸ªæ™¯ç‚¹æ˜¯æ—å±‹æ´ï¼Œä»·æ ¼æ˜¯ 50Â¥ï¼Œåœ¨æ—å±‹æ´å±±ä¸Šçš„ä¸€åº§å¡”çš„å†…éƒ¨æ‹æ‘„å¤ªæ¹–æ²¿å²¸çš„é£æ™¯</li></ul><p><img src="https://p.k8s.li/20210503_005522469_iOS.jpg" alt=""></p><p>ä¸Šåˆçš„æ—¶å€™å°±åœ¨è¥¿å±±é£æ™¯åŒºæ²¿ç€æ¹–è¾¹éª‘è¡Œç©å„¿äº†ä¸€åœˆï¼Œé€€æˆ¿ä¹‹åä¹ŸåäºŒç‚¹å¤šäº†ï¼Œäºæ˜¯åœ¨é™„è¿‘çš„ä¸€å®¶å…°å·æ‹‰é¢åƒäº†é¡¿è›‹ç‚’é¥­ã€‚</p><ul><li>éšååˆéª‘è¡Œåˆ°å¤ªæ¹–å‘¨è¾¹ä¼‘æ¯ä¸€æ®µæ—¶é—´</li></ul><p><img src="https://p.k8s.li/20210503_044026640_iOS.jpg" alt=""></p><p>ä¸‹åˆç»§ç»­éª‘è¡Œï¼Œä¸‰å·å·å’Œå››å·è¿™ä¸¤æ™šå®šçš„æ°‘å®¿åœ¨å¹³æ±Ÿå†å²è¡—åŒºé™„è¿‘ã€‚ä»è¥¿å±±é£æ™¯åŒºåˆ°é‚£é‡Œå¤§æ¦‚æœ‰ 65 å…¬é‡Œçš„éª‘è¡Œè·¯ç¨‹ã€‚ä¸‹åˆäº”ç‚¹å·¦å³åˆ°è¾¾ä½çš„åœ°æ–¹ã€‚ä»·æ ¼æ˜¯ 512Â¥ ä¸¤æ™šï¼Œæ„Ÿè§‰è¿˜æ˜¯æ¯”è¾ƒè´µçš„ï¼Œè€Œä¸”æ˜¯ä¸‰äººé—´ï¼Œå‡‘æ´»ä½ä¸¤æ™šå§ã€‚å…¶å®æœ¬äººå¯¹å’Œé™Œç”Ÿäººåˆä½å¹¶ä¸æ˜¯å¾ˆä»‹æ„ï¼Œè¿˜æ˜¯èƒ½æ¥å—ã€‚åœ¨æˆ‘å¤§å­¦åˆšæ¯•ä¸šä¹‹åï¼Œä¹Ÿæ˜¯ä½åœ¨å…¬å¸é™„è¿‘çš„ä¸€å®¶æ°‘å®¿ã€‚å½“æ—¶ä¸€ä¸ªä¸åˆ°åäº”å¹³ç±³çš„æˆ¿é—´é‡Œï¼Œä¸¤ä¸ªä¸Šä¸‹é“ºçš„åºŠï¼Œå’Œå››ä¸ªäººä½ä¸€å—ã€‚è™½ç„¶ååˆ†æ‹¥æŒ¤ä¹Ÿåˆå¾ˆå¤šä¸ä¾¿ï¼Œä½†ä»·æ ¼ååˆ†ä¾¿å®œï¼Œæ¯ä¸ªæœˆ 300Â¥ åŒ…æ‰€æœ‰è´¹ç”¨ï¼Œååˆ†é€‚åˆå½“æ—¶åˆšæ¯•ä¸šæ‰‹æ— åˆ†æ–‡çš„æˆ‘ã€‚</p><ul><li>æ™šä¸Šçš„æ—¶å€™è‡ªå·±ä¸€ä¸ªäººå»åƒäº†é¡¿æµ·åº•æç«é”…ï¼Œæ€»æ„Ÿè§‰åœ¨å¤–é¢è‡ªå·±ä¸€ä¸ªäººåƒé¥­ååˆ†å°´å°¬ ğŸ˜… ã€‚å¦‚ä»Šæ¯•ä¸šä¹Ÿå¿«ä¸¤å¹´äº†ï¼Œè¿™ä¸¤å¹´åŸºæœ¬ä¸Šæ˜¯ç‹¬è‡ªä¸€ä¸ªäººç”Ÿæ´»çš„ï¼Œè¿™ç§ç‹¬å¤„çš„æ„Ÿè§‰ä¹Ÿæ…¢æ…¢é€‚åº”äº†ï¼Œä¹Ÿè¶Šæ¥è¶Šäº«å—è¿™ç§ç‹¬å¤„çš„ç”Ÿæ´»äº†ã€‚</li></ul><p><img src="https://p.k8s.li/20210503_114832550_iOS.jpg" alt=""></p><ul><li>å¹³æ±Ÿå†å²è¡—åŒºå¤œæ™¯</li></ul><p><img src="https://p.k8s.li/20210503_124849278_iOS.jpg" alt=""></p><ul><li>å¹³æ±Ÿå†å²è¡—åŒºå¤œæ™¯</li></ul><p><img src="https://p.k8s.li/20210503_125244682_iOS.jpg" alt=""></p><h2 id="Day-4-è‹å·æ¸¸ç©"><a href="#Day-4-è‹å·æ¸¸ç©" class="headerlink" title="Day 4 è‹å·æ¸¸ç©"></a>Day 4 è‹å·æ¸¸ç©</h2><p>æ—©ä¸Šä¸ƒç‚¹åŠå°±èµ·åºŠäº†ï¼Œä¸Šåˆæ¸¸ç©çš„ç¬¬ä¸€ç«™æ˜¯ç•™å›­ï¼Œé¢„å®šçš„æ˜¯æ—©ä¸Š 8 ç‚¹åˆ° 9 ç‚¹çš„é—¨ç¥¨ï¼Œæ—©ä¸Šä¸‹èµ·äº†ä¸ä¸ç»†é›¨ï¼Œæ„Ÿè§‰å¤©æ°”ä¸å¤ªå¥½ã€‚åœ¨ç•™å›­é€›å®Œä¹‹ååˆå»äº†ç‹®å­æ—ï¼Œæ„Ÿè§‰è¿™ä¸¤ä¸ªå›­å­è¿˜å¯ä»¥ï¼Œæ™¯åŒºçš„äººå¹¶ä¸æ˜¯ç‰¹åˆ«å¤šã€‚</p><p><img src="https://p.k8s.li/20210504_010754779_iOS.jpg" alt=""></p><p>æœ¬æƒ³ç€ä¸‹åˆå»æ‹™æ”¿å›­ï¼Œä½†å½“å¤©å·²ç»æ²¡æœ‰é—¨ç¥¨äº†ï¼Œåªèƒ½é¢„å®šåˆ°äº”å·ä¸Šåˆçš„ã€‚äºæ˜¯ä¸‹åˆå°±å»äº†è™ä¸˜é£æ™¯åŒºã€‚</p><p><img src="https://p.k8s.li/20210504_084847466_iOS.jpg" alt=""></p><ul><li>è™ä¸˜é£æ™¯åŒºé™„è¿‘</li></ul><p><img src="https://p.k8s.li/20210504_085354580_iOS.jpg" alt=""></p><p><img src="https://p.k8s.li/20210504_085413326_iOS.jpg" alt=""></p><h2 id="Day-5-è‹å·-â€“-gt-æ¹–å·"><a href="#Day-5-è‹å·-â€“-gt-æ¹–å·" class="headerlink" title="Day 5 è‹å· â€“&gt; æ¹–å·"></a>Day 5 è‹å· â€“&gt; æ¹–å·</h2><p>æ—©ä¸Šå…«ç‚¹å°±å‡ºå‘å»äº†æ‹™æ”¿å›­ï¼Œåœ¨é‡Œé¢é€›çš„æ—¶é—´æ¯”è¾ƒé•¿ï¼Œç­‰åˆ°åç‚¹åŠçš„æ—¶å€™æ‰ä»é‡Œé¢å‡ºæ¥ã€‚</p><p><img src="https://p.k8s.li/20210505_010850949_iOS.jpg" alt=""></p><ul><li>æ„Ÿè§‰è¿™æ£µæ ‘ç‰¹åˆ«åƒäººçš„æ‰‹ ğŸ–ï¸ ğŸ¤”ï¸</li></ul><p><img src="https://p.k8s.li/20210505_011052002_iOS.jpg" alt=""></p><p>é€›å®Œæ‹™æ”¿å›­ä¹‹åå·²ç»å¿«åä¸€ç‚¹äº†ï¼Œå›åˆ°ä½çš„åœ°æ–¹æ”¶æ‹¾å®Œè¡Œæï¼Œåœ¨é™„è¿‘çš„ä¸€å®¶ç´ é£Ÿé¤å…åƒäº†é¡¿åˆé¥­ã€‚ä¹‹åç»§ç»­éª‘è¡Œï¼Œå‡†å¤‡è¿”å›äº†ï¼Œæ™šä¸Šå‡†å¤‡ä½åœ¨æ¹–å·ã€‚</p><p><img src="https://p.k8s.li/20210505_082143685_iOS.jpg" alt=""></p><ul><li>ä¸‹åˆäº”ç‚¹åŠçš„æ—¶å€™åˆ°è¾¾æ¹–å·æ»¨æ¹–å¤§é“ï¼Œå†æ¬¡æ¥åˆ°äº†å‡ºå‘ç‚¹ï¼Œç¯å¤ªæ¹–éª‘è¡Œæ€»ç®—é¡ºåˆ©ç»“æŸäº†ï¼Œåªå‰©ä¸‹æ˜å¤©ä¸€å¤©è¿”å›æ­å·çš„è·¯ç¨‹äº†ã€‚æ˜å¤©åˆ°å®¶åå†åœ¨å®¶ä¼‘æ¯ä¸€å¤©ï¼Œå› æ­¤ç»™ TL ç”³è¯·äº†ä¸¤å¤©å¹´å‡ï¼Œä¹Ÿå¾ˆé¡ºåˆ©æ»´æ‰¹å‡†äº†ã€‚</li></ul><p><img src="https://p.k8s.li/20210505_093503000_iOS.png" alt=""></p><ul><li>æ»¨æ¹–å¤§é“æ—çš„å…¬å›­ï¼Œæ¹–è¾¹å¤•é˜³è¥¿ä¸‹çš„æ™¯è‰²</li></ul><p><img src="https://p.k8s.li/20210505_095106128_iOS.jpg" alt=""></p><h2 id="Day-6-æ¹–å·-â€“-gt-æ­å·"><a href="#Day-6-æ¹–å·-â€“-gt-æ­å·" class="headerlink" title="Day 6 æ¹–å· â€“&gt; æ­å·"></a>Day 6 æ¹–å· â€“&gt; æ­å·</h2><p>æœ€åä¸€å¤©å°±æ˜¯ä»æ¹–å·è¿”å›æ­å·äº†ï¼Œè¿˜æ˜¯æ²¿ç€åŸè·¯è¿”å›ï¼Œä¸‹åˆä¸´è¿‘å…­ç‚¹é¡ºåˆ©åˆ°è¾¾æ­å·ã€‚</p><p>æ„Ÿè§‰è¿™å‡ å¤©åƒçš„å¤ªå¤šäº† ğŸ˜¤</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>ä½å®¿</td><td>866</td></tr><tr><td>é—¨ç¥¨</td><td>295</td></tr><tr><td>é£Ÿç‰©</td><td>750</td></tr><tr><td>å…¶ä»–</td><td>182</td></tr><tr><td>æ€»è®¡</td><td>2093</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;è°ƒä¼‘ä¸¤å¤©ç»ˆäºè¿æ¥äº†äº”å¤©çš„äº”ä¸€å‡æœŸï¼Œå®é™…ä¸Šä»…ä»…æ”¾äº†ä¸€å¤©å‡æœŸï¼Œ
        
      
    
    </summary>
    
    
      <category term="ç”Ÿæ´»" scheme="https://blog.k8s.li/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
      <category term="éª‘è¡Œ" scheme="https://blog.k8s.li/tags/%E9%AA%91%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</title>
    <link href="https://blog.k8s.li/make-offline-mirrors.html"/>
    <id>https://blog.k8s.li/make-offline-mirrors.html</id>
    <published>2021-05-22T16:00:00.000Z</published>
    <updated>2021-05-22T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç¦»çº¿éƒ¨ç½²"><a href="#ç¦»çº¿éƒ¨ç½²" class="headerlink" title="ç¦»çº¿éƒ¨ç½²"></a>ç¦»çº¿éƒ¨ç½²</h2><p>å¯¹äº PaaS toB äº§å“æ¥è®²ï¼Œå®¢æˆ·å¾€å¾€ä¼šè¦æ±‚äº§å“çš„éƒ¨ç½²æ–¹æ¡ˆå¿…é¡»åšåˆ°ç¦»çº¿å®‰è£…ï¼Œå³åœ¨éƒ¨ç½²æ—¶ä¸èƒ½ä¾èµ–ä»»ä½•åœ¨çº¿çš„èµ„æºï¼Œæ¯”å¦‚å®‰è£…ä¸€äº› OS è½¯ä»¶åŒ…æ—¶ä¾èµ–çš„ yum/apt æºï¼›docker.ioã€k8s.gcr.io ã€quay.io ä¸Šé¢çš„å®¹å™¨é•œåƒï¼›GitHub ä¸Šå¼€æºè½¯ä»¶çš„äºŒè¿›åˆ¶ä¸‹è½½æ–‡ä»¶ç­‰ã€‚</p><p>ä½œä¸ºå¹³å°éƒ¨ç½²å·¥å…·çš„å¼€å‘è€…ï¼Œå§‹ç»ˆè¢«ç¦»çº¿éƒ¨ç½²è¿™ä¸ªéš¾é¢˜å›°æ‰°ç€ã€‚åœ¨çº¿çš„å®¹å™¨é•œåƒå’ŒäºŒè¿›åˆ¶æ–‡ä»¶æ¯”è¾ƒå¥½è§£å†³ï¼Œå› ä¸ºè¿™äº›èµ„æºæ˜¯ä¸ OS æ— å…³çš„ï¼Œåªè¦ä¸‹è½½ä¸‹æ¥æ”¾åˆ°å®‰è£…åŒ…é‡Œï¼Œéƒ¨ç½²çš„æ—¶å€™å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨å’Œé•œåƒä»“åº“æœåŠ¡æä¾›è¿™äº›èµ„æºçš„ä¸‹è½½å³å¯ã€‚</p><p>ä½†æ˜¯å¯¹äº yum/apt ä¹‹ç±»çš„è½¯ä»¶æ¥è®²å¹¶ä¸é‚£ä¹ˆç®€å•ï¼š</p><ul><li>é¦–å…ˆç”±äºå„ä¸ªåŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»æ¯”è¾ƒå¤æ‚ï¼Œå¹¶ä¸èƒ½å°†å®ƒä»¬ç›´æ¥ä¸‹è½½ä¸‹æ¥ï¼›</li><li>å…¶æ¬¡å³ä¾¿ä¸‹è½½ä¸‹æ¥ä¹‹åä¹Ÿæ— æ³•ç›´æ¥é€šè¿‡ yum/apt çš„æ–¹å¼å®‰è£…æŒ‡å®šçš„è½¯ä»¶åŒ…ï¼Œè™½ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ scp çš„æ–¹å¼å°†è¿™äº›åŒ…å¤åˆ¶åˆ°éƒ¨ç½²èŠ‚ç‚¹ï¼Œé€šè¿‡ rpm æˆ– dpkg çš„æ–¹å¼æ¥å®‰è£…ä¸Šï¼Œä½†è¿™æ ·å¹¶ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œè€Œä¸”é€šç”¨æ€§èƒ½ä¹Ÿä¸æ˜¯å¾ˆå¥½ï¼›</li><li>æœ€åéœ€è¦é€‚é…çš„ Linux å‘è¡Œç‰ˆå’ŒåŒ…ç®¡ç†å™¨ç§ç±»ä¹Ÿæœ‰å¤šç§ï¼Œè€Œä¸”æœ‰äº›åŒ…çš„åŒ…åæˆ–è€…ç‰ˆæœ¬å·åœ¨ä¸åŒçš„åŒ…ç®¡ç†ä¹‹é—´ä¹Ÿç›¸å·®ç”šå¤§ï¼Œæ— æ³•åšåˆ°ç»Ÿä¸€ç®¡ç†ã€‚</li></ul><p>ç»¼ä¸Šï¼Œå°†å¹³å°éƒ¨ç½²ä¾èµ–çš„åœ¨çº¿ yum/apt ä¹‹ç±»çš„è½¯ä»¶åŒ…èµ„æºåˆ¶ä½œæˆç¦»çº¿å®‰è£…åŒ…æ˜¯ä¸€ä»¶å¾ˆæ£˜æ‰‹çš„äº‹æƒ…ã€‚ä¸ªäººå°±è¿™ä¸ªé—®é¢˜æŠ˜è…¾äº†ä¸€æ®µæ—¶é—´ï¼Œç»ˆäºæ‰¾åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒåˆé€‚çš„è§£å†³æ–¹æ¡ˆï¼šå³é€šè¿‡ä¸€ä¸ª YAML é…ç½®æ–‡ä»¶æ¥ç®¡ç†åŒ…ï¼Œç„¶åä½¿ç”¨ Dockerfile æ¥æ„å»ºæˆç¦»çº¿çš„ tar åŒ…æˆ–è€…å®¹å™¨é•œåƒã€‚å¦‚æœæœ‰ç±»ä¼¼éœ€æ±‚çš„å°ä¼™ä¼´ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹æœ¬æ–¹æ¡ˆã€‚</p><h2 id="Docker-build"><a href="#Docker-build" class="headerlink" title="Docker build"></a>Docker build</h2><p>ä¼ ç»Ÿåˆ¶ä½œç¦»çº¿æºçš„æ–¹å¼æ˜¯æ‰¾ä¸€å°ç›¸åº”çš„ Linux æœºå™¨ï¼Œåœ¨ä¸Šé¢é€šè¿‡åŒ…ç®¡ç†å™¨ä¸‹è½½è¿™äº›è½¯ä»¶åŒ…ï¼Œç„¶åå†åˆ›å»ºè¿™äº›è½¯ä»¶åŒ…çš„ repo ç´¢å¼•æ–‡ä»¶ã€‚</p><p>å¯ä»¥çœ‹å‡ºè¿™ç§æ–¹å¼ååˆ†ä¸çµæ´»ï¼Œå‡å¦‚æˆ‘æƒ³è¦åˆ¶ä½œ Debian 9 çš„ apt ç¦»çº¿æºï¼Œæˆ‘å°±éœ€è¦ä¸€å° Debian 9 çš„æœºå™¨ã€‚å¦‚æœè¦é€‚é…å¤šä¸ª Linux å‘è¡Œç‰ˆå°±éœ€è¦å¤šä¸ªç›¸åº”çš„ OS æœºå™¨ã€‚è¦ç®¡ç†å’Œä½¿ç”¨è¿™ä¹ˆå¤šç§ç±»çš„ OS ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹å„¿ï¼Œè€Œå¦‚ä»Šå·²ç»ååˆ†æ™®éä½¿ç”¨çš„å®¹å™¨æŠ€æœ¯æ°æ°èƒ½å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ç±»é—®é¢˜ã€‚æ¯”å¦‚æˆ‘æƒ³è¿è¡Œä¸€ä¸ª Debian9 çš„æ“ä½œç³»ç»Ÿï¼Œæˆ‘åªéœ€è¦è¿è¡Œä¸€ä¸ª Debian 9 é•œåƒçš„å®¹å™¨å³å¯ï¼Œè€Œä¸”ä¸éœ€è¦é¢å¤–çš„ç®¡ç†æˆæœ¬ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿååˆ†åœ°è½»é‡ã€‚</p><p>æ—¥å¸¸å·¥ä½œä¸­æˆ‘ä»¬å¸¸ä½¿ç”¨å®¹å™¨æ¥æ„å»ºä¸€äº› Golang å†™çš„åç«¯ç»„ä»¶ï¼Œé‚£ä¹ˆæ„å»ºç¦»çº¿æºæ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥è¿™æ ·åšï¼Ÿå®è·µè¯æ˜ç¡®å®å¯ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸ºä¸åŒçš„ OS å’ŒåŒ…ç®¡ç†å™¨å†™ä¸€ä¸ªç›¸åº”çš„ Dockerfile å³å¯ã€‚ä½¿ç”¨ docker build å¤šé˜¶æ®µæ„å»ºçš„ç‰¹æ€§ï¼Œå¯ä»¥å°†å¤šä¸ª Dockerfile åˆå¹¶æˆä¸€ä¸ªï¼Œç„¶åæœ€åä½¿ç”¨ COPY â€“from çš„æ–¹å¼å°†è¿™ä¸ªæ„å»ºçš„äº§ç‰©å¤åˆ¶åˆ°åŒä¸€ä¸ªé•œåƒä¸­ï¼Œæ¯”å¦‚æä¾› HTTP çš„ nginx å®¹å™¨ï¼Œæˆ–è€…ä½¿ç”¨ BuildKit çš„ç‰¹æ€§å°†è¿™äº›æ„å»ºäº§ç‰©å¯¼å‡ºä¸º taråŒ… æˆ–è€…ä¸ºæœ¬åœ°ç›®å½•ã€‚</p><h2 id="é€‚é…-OS"><a href="#é€‚é…-OS" class="headerlink" title="é€‚é… OS"></a>é€‚é… OS</h2><p>æ ¹æ®è‡ªå·±çš„ PaaS toB ä»ä¸šç»éªŒå¯çŸ¥ï¼Œç›®å‰å›½å†…çš„ç§æœ‰äº‘å®¢æˆ·ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨çš„ OS ä¸­ï¼Œ CentOS åº”è¯¥æ˜¯æœ€å¤šçš„ï¼Œå…¶æ¬¡æ˜¯ Ubuntu å’Œ Debianã€‚è‡³äº RedHat åˆ™éœ€è¦ä»˜è´¹è®¢é˜…æ‰èƒ½ä½¿ç”¨ï¼ŒDockerHub ä¸Šæ›´æ˜¯æ²¡æœ‰å…è´¹å¯ä½¿ç”¨çš„é•œåƒï¼Œå› æ­¤æœ¬æ–¹æ¡ˆæ— æ³•ç¡®ä¿é€‚ç”¨äº RedHatã€‚äº§å“æ–¹é¢ CentOS éœ€è¦çš„ç‰ˆæœ¬åªæœ‰ 7.9ï¼›Ubuntu éœ€è¦æ”¯æŒ 18.04 å’Œ 20.04ï¼›Debian éœ€è¦æ”¯æŒ 9 å’Œ 10ã€‚å› ä¸ºæ—¶é—´å’Œç²¾åŠ›æœ‰é™ï¼Œæœ¬æ–¹æ¡ˆæ”¯æŒçš„ Linux å‘è¡Œç‰ˆå’Œç›¸åº”çš„ç‰ˆæœ¬åªæœ‰ CentOS 7, Debian 9/10, Ubuntu 18.04/20.04 è¿™äº”ä¸ªã€‚å¦‚æœè¦æ”¯æŒå…¶ä»– OS çš„ç¦»çº¿æºæ¯”å¦‚ OpenSUSEï¼Œä¹Ÿå¯ä»¥å‚è€ƒæœ¬æ–¹æ¡ˆç¼–å†™ä¸€ä¸ª Dockerfile æ–‡ä»¶æ¥å®ç°é€‚é…ã€‚</p><h2 id="æ„å»º"><a href="#æ„å»º" class="headerlink" title="æ„å»º"></a>æ„å»º</h2><p>æ„å»ºçš„è¿‡ç¨‹ååˆ†ç®€å•ï¼Œä½¿ç”¨ä¸€ä¸ª YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶æ¥ç®¡ç†ä¸åŒçš„åŒ…ç®¡ç†å™¨æˆ– Linux å‘è¡Œç‰ˆå®‰è£…ä¸åŒçš„åŒ…ï¼Œå¹¶åœ¨ä¸€ä¸ª Dockerfile é‡Œå®Œæˆæ‰€æœ‰çš„æ„å»ºæ“ä½œã€‚å®ç°æºç åœ¨ <a href="https://github.com/muzi502/scripts/tree/master/build-packages-repo" target="_blank" rel="noopener">github.com/muzi502/scripts/build-packages-repo</a>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">build</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ Dockerfile.centos</span><br><span class="line">â”œâ”€â”€ Dockerfile.debian</span><br><span class="line">â”œâ”€â”€ Dockerfile.ubuntu</span><br><span class="line">â””â”€â”€ packages.yaml</span><br></pre></td></tr></table></figure><h3 id="æ„å»ºè¿‡ç¨‹"><a href="#æ„å»ºè¿‡ç¨‹" class="headerlink" title="æ„å»ºè¿‡ç¨‹"></a>æ„å»ºè¿‡ç¨‹</h3><p>ä½¿ç”¨ docker build çš„æ–¹å¼æ„å»ºç¦»çº¿æºå¤§è‡´å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ul><li>åœ¨æ„å»ºå®¹å™¨å†…é…ç½® yum/apt æºï¼Œå®‰è£…æ„å»ºæ—¶éœ€è¦å·¥å…·ï¼›</li><li>ç”Ÿæˆç³»ç»Ÿå†…çš„ rpm/deb åŒ…çš„åˆ—è¡¨å’Œéœ€è¦ä¸‹è½½çš„åŒ…åˆ—è¡¨ï¼Œè§£å†³ä¸€äº›è½¯ä»¶åŒ…ä¾èµ–çš„é—®é¢˜ï¼›</li><li>æ ¹æ®ç”Ÿæˆçš„åŒ…åˆ—è¡¨ä½¿ç”¨ç›¸åº”çš„åŒ…ç®¡ç†å™¨å·¥å…·ä¸‹è½½éœ€è¦çš„è½¯ä»¶åŒ…ï¼›</li><li>ç”Ÿç”¨ç›¸åº”çš„åŒ…ç®¡ç†å™¨ç”Ÿæˆè¿™äº›åŒ…çš„ index æ–‡ä»¶ï¼Œå¦‚ repodata æˆ– Packages.gz æ–‡ä»¶ï¼›</li><li>å°†ä¸Šè¿°çš„æ„å»ºäº§ç‰© COPY åˆ°åŒä¸€ä¸ªå®¹å™¨é•œåƒé‡Œï¼Œæ¯”å¦‚ nginx ï¼›ä¹Ÿå¯ä»¥å¯¼å‡ºä¸º tar åŒ…æˆ–ç›®å½•ï¼›</li></ul><h3 id="packages-yaml"><a href="#packages-yaml" class="headerlink" title="packages.yaml"></a>packages.yaml</h3><p>è¿™ä¸ªæ–‡ä»¶ç”¨æ¥ç®¡ç†ä¸åŒçš„åŒ…ç®¡ç†å™¨æˆ–è€… Linux å‘è¡Œç‰ˆéœ€è¦å®‰è£…çš„è½¯ä»¶åŒ…ã€‚æ ¹æ®ä¸åŒçš„åŒ…ç®¡ç†å™¨å’Œå‘è¡Œç‰ˆæˆ‘ä»¬å¯ä»¥å°†è¿™äº›åŒ…å¤§è‡´åˆ’åˆ†ä¸º 4 ç±»ã€‚</p><ul><li><p>commonï¼šé€‚ç”¨äºä¸€äº›æ‰€æœ‰åŒ…ç®¡ç†å™¨ä¸­åŒ…åç›¸åŒæˆ–è€…å¯¹ç‰ˆæœ¬æ— è¦æ±‚çš„åŒ…ï¼Œæ¯”å¦‚ vim ã€curlã€wget è¿™ç±»å·¥å…·ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨è¿™äº›å·¥å…·æˆ‘ä»¬å¹¶ä¸å…³å¿ƒå®ƒçš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”è¿™ç±»åŒ…çš„åŒ…ååœ¨æ‰€æœ‰çš„åŒ…ç®¡ç†å™¨ä¸­éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥è¿™ç±»å¯ä»¥åˆ’åˆ†ä¸ºå…¬å…±åŒ…ã€‚</p></li><li><p>yum/apt/dnfï¼šé€‚ç”¨äºä¸åŒçš„å‘è¡Œç‰ˆä½¿ç”¨ç›¸åŒçš„åŒ…ç®¡ç†å™¨ã€‚æ¯”å¦‚ nfs çš„åŒ…ï¼Œåœ¨ yum ä¸­åŒ…åä¸º nfs-utils ä½†åœ¨ apt ä¸­ä¸º nfs-commonï¼Œè¿™ç±»è½¯ä»¶åŒ…å¯ä»¥åˆ’åˆ†ä¸ºä¸€ç±»ã€‚</p></li><li><p>OSï¼šé€‚ç”¨äºä¸€äº›è¯¥ OS ç‹¬æœ‰çš„åŒ…ï¼Œæ¯”å¦‚å®‰è£…ä¸€ä¸ª Ubuntu ä¸­æœ‰ä½† Debian ä¸­æ²¡æœ‰çš„åŒ…ï¼ˆæ¯”å¦‚ debian-builder æˆ– ubuntu-dev-toolsï¼‰ã€‚</p></li><li><p>OS-å‘è¡Œç‰ˆä»£å·ï¼šè¿™ç±»åŒ…çš„ç‰ˆæœ¬å’Œå‘è¡Œç‰ˆä»£å·ç»‘å®šåœ¨ä¸€èµ·ï¼Œæ¯”å¦‚ <code>docker-ce=5:19.03.15~3-0~debian-stretchã€‚</code></p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">common:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">vim</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">curl</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">wget</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tree</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lvm2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">yum:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfs-utils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">yum-utils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">createrepo</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">centos-release-gluster</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">epel-release</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apt:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfs-common</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apt-transport-https</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ca-certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lsb-release</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">software-properties-common</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">aptitude</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">dpkg-dev</span></span><br><span class="line"></span><br><span class="line"><span class="attr">centos:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">centos-release</span></span><br><span class="line"></span><br><span class="line"><span class="attr">debian:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">debian-builder</span></span><br><span class="line"></span><br><span class="line"><span class="attr">debian-buster:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker-ce=5:19.03.15~3-0~debian-buster</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ubuntu:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ubuntu-dev-tools</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œéœ€è¦é¢å¤–æ³¨æ„ä¸€ä¸‹ï¼Œåœ¨ä¸åŒçš„åŒ…ç®¡ç†å™¨ä¹‹é—´æŒ‡å®šåŒ…ç‰ˆæœ¬çš„æ–¹å¼ä¹Ÿå„ä¸ç›¸åŒï¼Œæ¯”å¦‚åœ¨ yum ä¸­å¦‚æœè¦å®‰è£… 19.03.15 ç‰ˆæœ¬çš„ docker-ce åŒ…åä¸º <code>docker-ce-19.03.15</code>ï¼Œè€Œåœ¨ debian ä¸­åŒ…ååˆ™ä¸º <code>docker-ce=5:19.03.15~3-0~debian-stretch</code>ã€‚å¯ä»¥ä½¿ç”¨åŒ…ç®¡ç†å™¨æŸ¥çœ‹ç›¸åŒçš„ä¸€ä¸ªåŒ…å¦‚ docker-ce åœ¨ä¸åŒçš„åŒ…ç®¡ç†å™¨ä¹‹å‰çš„å·®å¼‚ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos:]<span class="comment"># yum list docker-ce --showduplicates | grep 19.03.15</span></span><br><span class="line">docker-ce.x86_64            3:19.03.15-3.el7                    docker-ce-stable</span><br><span class="line"></span><br><span class="line">root@debian:/<span class="comment"># apt-cache policy docker-ce</span></span><br><span class="line">docker-ce:</span><br><span class="line">  Installed: (none)</span><br><span class="line">  Candidate: 5:19.03.15~3-0~debian-stretch</span><br><span class="line">  Version table:</span><br><span class="line">     5:19.03.15~3-0~debian-stretch 500</span><br><span class="line">        500 https://download.docker.com/linux/debian stretch/stable amd64 Packages</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç‰ˆæœ¬å·çš„é—®é¢˜åœ¨ kubespray çš„æºç ä¸­ä¹Ÿæ˜¯åŒæ ·åšäº†ç‰¹æ®Šå¤„ç†ï¼Œç›®å‰ç¡®å®æ²¡æœ‰å¤ªå¥½çš„æ–¹æ¡ˆæ¥è§£å†³ï¼Œåªèƒ½æ‰‹åŠ¨ç»´æŠ¤è¿™ä¸ªç‰ˆæœ¬å·ã€‚</p><ul><li>roles/container-engine/docker/vars/redhat.yml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># https://docs.docker.com/engine/installation/linux/centos/#install-from-a-package</span></span><br><span class="line"><span class="comment"># https://download.docker.com/linux/centos/&lt;centos_version&gt;&gt;/x86_64/stable/Packages/</span></span><br><span class="line"><span class="comment"># or do 'yum --showduplicates list docker-engine'</span></span><br><span class="line"><span class="attr">docker_versioned_pkg:</span></span><br><span class="line">  <span class="attr">'latest':</span> <span class="string">docker-ce</span></span><br><span class="line">  <span class="attr">'18.09':</span> <span class="string">docker-ce-18.09.9-3.el7</span></span><br><span class="line">  <span class="attr">'19.03':</span> <span class="string">docker-ce-19.03.15-3.el&#123;&#123;</span> <span class="string">ansible_distribution_major_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'20.10':</span> <span class="string">docker-ce-20.10.5-3.el&#123;&#123;</span> <span class="string">ansible_distribution_major_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'stable':</span> <span class="string">docker-ce-19.03.15-3.el&#123;&#123;</span> <span class="string">ansible_distribution_major_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'edge':</span> <span class="string">docker-ce-19.03.15-3.el&#123;&#123;</span> <span class="string">ansible_distribution_major_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">docker_cli_versioned_pkg:</span></span><br><span class="line">  <span class="attr">'latest':</span> <span class="string">docker-ce-cli</span></span><br><span class="line">  <span class="attr">'18.09':</span> <span class="string">docker-ce-cli-18.09.9-3.el7</span></span><br><span class="line">  <span class="attr">'19.03':</span> <span class="string">docker-ce-cli-19.03.15-3.el&#123;&#123;</span> <span class="string">ansible_distribution_major_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'20.10':</span> <span class="string">docker-ce-cli-20.10.5-3.el&#123;&#123;</span> <span class="string">ansible_distribution_major_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">docker_package_info:</span></span><br><span class="line">  <span class="attr">enablerepo:</span> <span class="string">"docker-ce"</span></span><br><span class="line">  <span class="attr">pkgs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; containerd_versioned_pkg[containerd_version | string] &#125;&#125;</span>"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_cli_versioned_pkg[docker_cli_version | string] &#125;&#125;</span>"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_versioned_pkg[docker_version | string] &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><ul><li>roles/container-engine/docker/vars/ubuntu.yml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://download.docker.com/linux/ubuntu/</span></span><br><span class="line"><span class="attr">docker_versioned_pkg:</span></span><br><span class="line">  <span class="attr">'latest':</span> <span class="string">docker-ce</span></span><br><span class="line">  <span class="attr">'18.09':</span> <span class="string">docker-ce=5:18.09.9~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'19.03':</span> <span class="string">docker-ce=5:19.03.15~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'20.10':</span> <span class="string">docker-ce=5:20.10.5~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'stable':</span> <span class="string">docker-ce=5:19.03.15~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'edge':</span> <span class="string">docker-ce=5:19.03.15~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">docker_cli_versioned_pkg:</span></span><br><span class="line">  <span class="attr">'latest':</span> <span class="string">docker-ce-cli</span></span><br><span class="line">  <span class="attr">'18.09':</span> <span class="string">docker-ce-cli=5:18.09.9~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'19.03':</span> <span class="string">docker-ce-cli=5:19.03.15~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'20.10':</span> <span class="string">docker-ce-cli=5:20.10.5~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">docker_package_info:</span></span><br><span class="line">  <span class="attr">pkgs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; containerd_versioned_pkg[containerd_version | string] &#125;&#125;</span>"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_cli_versioned_pkg[docker_cli_version | string] &#125;&#125;</span>"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_versioned_pkg[docker_version | string] &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><h3 id="CentOS7"><a href="#CentOS7" class="headerlink" title="CentOS7"></a>CentOS7</h3><p>ä»‹ç»å®Œä¸Šè¿°çš„åŒ…é…ç½®æ–‡ä»¶ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ ¹æ®è¿™ä¸ª packages.yml é…ç½®æ–‡ä»¶ä½¿ç”¨ Dockerfile æ„å»ºè¿™äº›åŒ…çš„ç¦»çº¿æºã€‚ä»¥ä¸‹æ˜¯æ„å»º CentOS 7 ç¦»çº¿æºçš„ Dockerfileã€‚</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ centos 7.9 ä½œä¸º base æ„å»ºé•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7.9</span>.<span class="number">2009</span> as builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ centos çš„ç‰ˆæœ¬å’Œå¤„ç†å™¨ä½“ç³»æ¶æ„</span></span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=<span class="number">7</span></span><br><span class="line"><span class="keyword">ARG</span> ARCH=x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨è¿™é‡Œå®šä¹‰ä¸€äº›æ„å»ºæ—¶éœ€è¦çš„è½¯ä»¶åŒ…</span></span><br><span class="line"><span class="keyword">ARG</span> BUILD_TOOLS=<span class="string">"yum-utils createrepo centos-release-gluster epel-release curl"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…æ„å»ºå·¥å…·å’Œé…ç½®ä¸€äº›è½¯ä»¶æº repo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -q -y <span class="variable">$BUILD_TOOLS</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo \</span></span><br><span class="line"><span class="bash">    &amp;&amp; yum makecache &amp;&amp; yum update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éœ€è¦å®‰è£… yq å’Œ jq è¿™ä¸¤ä¸ªå·¥å…·æ¥å¤„ç† packages.yaml é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -sL -o /usr/<span class="built_in">local</span>/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/jq</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£æ packages.yml é…ç½®æ–‡ä»¶ï¼Œç”Ÿæˆæ‰€éœ€è¦çš„ packages.list æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /centos/<span class="variable">$OS_VERSION</span>/os/<span class="variable">$ARCH</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ yq å…ˆå°† YAML æ–‡ä»¶è½¬æ¢æˆ json æ ¼å¼çš„å†…å®¹ï¼Œå†ä½¿ç”¨ jq è¿‡æ»¤å‡ºæ‰€éœ€è¦çš„åŒ…ï¼Œè¾“å‡ºä¸ºä¸€ä¸ªåˆ—è¡¨</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.yum[],.centos[]'</span> | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rpm -qa &gt;&gt; packages.list</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ packages.list ä¸­çš„è½¯ä»¶åŒ…ï¼Œå¹¶ç”Ÿæˆ repo ç´¢å¼•æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> cat packages.list | xargs yumdownloader --resolve \</span></span><br><span class="line"><span class="bash">    &amp;&amp; createrepo -d .</span></span><br><span class="line"><span class="comment"># å°†æ„å»ºäº§ç‰©å¤åˆ¶åˆ°ä¸€å±‚ç©ºçš„é•œåƒä¸­ï¼Œæ–¹ä¾¿å¯¼å‡ºä¸º tar åŒ…æˆ–ç›®å½•çš„æ ¼å¼</span></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=centos7 /centos /centos</span></span><br></pre></td></tr></table></figure><p>åœ¨æœ€åçš„ä¸€ä¸ª FROM é•œåƒä¸­ï¼Œè¿™é‡ŒæŒ‡å®šçš„æ˜¯ <code>scratch</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é•œåƒåï¼Œå®ƒä»£è¡¨çš„æ˜¯ä¸€ä¸ªç©ºçš„é•œåƒ layerã€‚</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æ„å»ºäº§ç‰©å¤åˆ¶åˆ°ä¸€å±‚ç©ºçš„é•œåƒä¸­ï¼Œæ–¹ä¾¿å¯¼å‡ºä¸º tar åŒ…æˆ–ç›®å½•çš„æ ¼å¼</span></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=centos7 /centos /centos</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç›´æ¥å°†æ„å»ºå‡ºæ¥çš„äº§ç‰©æ”¾åˆ° nginx å®¹å™¨ä¸­ï¼Œè¿™æ ·ç›´æ¥è¿è¡Œ nginx å®¹å™¨å°±èƒ½æä¾› yum/apt æºçš„æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM nginx:1.19</span><br><span class="line">COPY --from=centos7 /centos /usr/share/nginx/html</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœè¦æ„å»ºä¸º tar åŒ…æˆ–è€…æœ¬åœ°ç›®å½•çš„æ–¹å¼ï¼Œéœ€è¦ä¸º Docker å¼€å¯ <code>DOCKER_BUILDKIT=1</code> è¿™ä¸ªç‰¹æ€§</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„å»ºä¸ºæœ¬åœ°ç›®å½•</span></span><br><span class="line">root@debian: ~ <span class="comment"># DOCKER_BUILDKIT=1 docker build -o type=local,dest=$PWD -f Dockerfile.centos .</span></span><br><span class="line"><span class="comment"># æ„å»ºä¸º tar åŒ…</span></span><br><span class="line">root@debian: ~ <span class="comment"># DOCKER_BUILDKIT=1 docker build -o type=tar,dest=$PWD/centos7.tar -f Dockerfile.centos .</span></span><br></pre></td></tr></table></figure><ul><li>æ„å»ºæ—¥å¿—å¦‚ä¸‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[+] Building 30.9s (13/13) FINISHED</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                                                                                            0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 109B                                                                                                                                            0.0s</span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile.centos                                                                                                                  0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 979B                                                                                                                                         0.0s</span><br><span class="line"> =&gt; [internal] load metadata <span class="keyword">for</span> docker.io/library/centos:7.9.2009                                                                                                           2.6s</span><br><span class="line"> =&gt; [centos7 1/7] FROM docker.io/library/centos:7.9.2009@sha256:0f4ec88e21daf75124b8a9e5ca03c37a5e937e0e108a255d890492430789b60e                                             0.0s</span><br><span class="line"> =&gt; [internal] load build context                                                                                                                                            0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 818B                                                                                                                                            0.0s</span><br><span class="line"> =&gt; CACHED [centos7 2/7] RUN yum install -q -y yum-utils createrepo centos-release-gluster epel-release curl     &amp;&amp; yum-config-manager --add-repo https://download.docker.c  0.0s</span><br><span class="line"> =&gt; [centos7 3/7] WORKDIR /centos/7/os/x86_64                                                                                                                                0.0s</span><br><span class="line"> =&gt; [centos7 4/7] RUN curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64     &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq     &amp;&amp; curl   3.2s</span><br><span class="line"> =&gt; [centos7 5/7] COPY packages.yaml packages.yaml                                                                                                                           0.1s</span><br><span class="line"> =&gt; [centos7 6/7] RUN yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.yum[],.centos[]'</span> | sort -u &gt; packages.list     &amp;&amp; rpm -qa &gt;&gt; packages.list                                1.0s</span><br><span class="line"> =&gt; [centos7 7/7] RUN cat packages.list | xargs yumdownloader --resolve     &amp;&amp; createrepo -d .                                                                              21.6s</span><br><span class="line"> =&gt; [stage-1 1/1] COPY --from=centos7 /centos /centos                                                                                                                        0.5s</span><br><span class="line"> =&gt; exporting to client                                                                                                                                                      0.7s</span><br><span class="line"> =&gt; =&gt; copying files 301.37MB</span><br></pre></td></tr></table></figure><ul><li>æ„å»ºäº§ç‰©å¦‚ä¸‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/build <span class="comment"># tree centos</span></span><br><span class="line">centos</span><br><span class="line">â””â”€â”€ 7</span><br><span class="line">    â””â”€â”€ os</span><br><span class="line">        â””â”€â”€ x86_64</span><br><span class="line">            â”œâ”€â”€ acl-2.2.51-15.el7.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ ansible-2.9.21-1.el7.noarch.rpm</span><br><span class="line">            â”œâ”€â”€ at-3.1.13-24.el7.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ attr-2.4.46-13.el7.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ audit-libs-2.8.5-4.el7.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ audit-libs-python-2.8.5-4.el7.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ avahi-libs-0.6.31-20.el7.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ basesystem-10.0-7.el7.centos.noarch.rpm</span><br><span class="line">            â”œâ”€â”€ bash-4.2.46-34.el7.x86_64.rpm</span><br><span class="line">            â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">            â”œâ”€â”€ redhat-lsb-submod-security-4.1-27.el7.centos.1.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ repodata</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ 28d2fe2d1dbd9b76d3e5385d42cf628ac9fc34d69e151edfe8d134fe6ac6a6d9-primary.xml.gz</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ 5264ca1af13ec7c870f25b2a28edb3c2843556ca201d07ac681eb4af7a28b47c-primary.sqlite.bz2</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ 591d9c2d5be714356e8db39f006d07073f0e1e024a4a811d5960d8e200a874fb-other.xml.gz</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ c035d2112d55d23a72b6d006b9e86a2f67db78c0de45345e415884aa0782f40c-other.sqlite.bz2</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ cd756169c3718d77201d08590c0613ebed80053f84a2db7acc719b5b9bca866f-filelists.xml.gz</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ ed0c5a36b12cf1d4100f90b4825b93dac832e6e21f83b23ae9d9753842801cee-filelists.sqlite.bz2</span><br><span class="line">            â”‚Â Â  â””â”€â”€ repomd.xml</span><br><span class="line">            â”œâ”€â”€ yum-utils-1.1.31-54.el7_8.noarch.rpm</span><br><span class="line">            â””â”€â”€ zlib-1.2.7-19.el7_9.x86_64.rpm</span><br><span class="line"></span><br><span class="line">4 directories, 368 files</span><br></pre></td></tr></table></figure><h3 id="Debian9"><a href="#Debian9" class="headerlink" title="Debian9"></a>Debian9</h3><p>ä¸‹é¢æ˜¯ Debian9 æ„å»º Dockerfileï¼Œæµç¨‹ä¸Šå’Œ CentOS ç›¸å·®ä¸å¤šï¼Œåªæ˜¯åŒ…ç®¡ç†å™¨çš„ä½¿ç”¨æ–¹å¼ä¸å¤ªç›¸åŒè€Œå·²ï¼Œè¿™é‡Œå°±ä¸å†åšè¯¦ç»†çš„æºç ä»‹ç»ã€‚</p><ul><li>Dockerfile.debian</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:stretch-slim as stretch</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=stretch</span><br><span class="line"><span class="keyword">ARG</span> ARCH=amd64</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEP_PACKAGES=<span class="string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update -y -q \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install -y --no-install-recommends <span class="variable">$DEP_PACKAGES</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian <span class="variable">$&#123;OS_VERSION&#125;</span> stable"</span> \</span></span><br><span class="line"><span class="bash">    | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /debian/<span class="variable">$&#123;OS_VERSION&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -sL -o /usr/<span class="built_in">local</span>/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/jq</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.apt[],.debian[]'</span> | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 &gt;&gt; packages.list</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown -R _apt /debian/<span class="variable">$OS_VERSION</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests \</span></span><br><span class="line"><span class="bash">    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="string">'^\w'</span> | sort -u | xargs apt-get download</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ../ &amp;&amp; dpkg-scanpackages <span class="variable">$OS_VERSION</span> | gzip -9c &gt; <span class="variable">$OS_VERSION</span>/Packages.gz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /debian /debian</span></span><br></pre></td></tr></table></figure><h3 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h3><p>Ubuntu ç¦»çº¿æºçš„åˆ¶ä½œæ­¥éª¤å’Œ Debian å·®ä¸å¤ªå¤šï¼Œåªéœ€è¦ç®€å•ä¿®æ”¹ä¸€ä¸‹ Debian çš„ Dockerfile åº”è¯¥å°± OK ï¼Œæ¯”å¦‚ <code>&#39;s/debian/ubuntu/g&#39;</code> ï¼Œæ¯•ç«Ÿ Debian æ˜¯ Ubuntu çš„çˆ¸çˆ¸å˜›ï½ï½ï¼Œæ‰€ä»¥ apt ä½¿ç”¨çš„æ–¹å¼å’ŒåŒ…åå‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p><h3 id="All-in-Oone"><a href="#All-in-Oone" class="headerlink" title="All-in-Oone"></a>All-in-Oone</h3><p>å°†ä¸Šè¿°å‡ ä¸ª Linux å‘è¡Œç‰ˆçš„ Dockerfile æ•´åˆæˆä¸€ä¸ªï¼Œè¿™æ ·åªéœ€è¦ä¸€ä¸ª docker build å‘½ä»¤å°±èƒ½æ„å»ºå‡ºæ‰€éœ€è¦çš„æ‰€æœ‰ OS çš„ç¦»çº¿æºäº†ã€‚</p><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CentOS 7.9 2009</span></span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7.9</span>.<span class="number">2009</span> as centos7</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=<span class="number">7</span></span><br><span class="line"><span class="keyword">ARG</span> ARCH=x86_64</span><br><span class="line"><span class="keyword">ARG</span> BUILD_TOOLS=<span class="string">"yum-utils createrepo centos-release-gluster epel-release curl"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -q -y <span class="variable">$BUILD_TOOLS</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo \</span></span><br><span class="line"><span class="bash">    &amp;&amp; yum makecache &amp;&amp; yum update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -sL -o /usr/<span class="built_in">local</span>/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/jq</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /centos/<span class="variable">$OS_VERSION</span>/os/<span class="variable">$ARCH</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.yum[],.centos[]'</span> | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rpm -qa &gt;&gt; packages.list</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> cat packages.list | xargs yumdownloader --resolve \</span></span><br><span class="line"><span class="bash">    &amp;&amp; createrepo -d .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Debian 9 stretch</span></span><br><span class="line"><span class="keyword">FROM</span> debian:stretch-slim as stretch</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=stretch</span><br><span class="line"><span class="keyword">ARG</span> ARCH=amd64</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEP_PACKAGES=<span class="string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update -y -q \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install -y --no-install-recommends <span class="variable">$DEP_PACKAGES</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian <span class="variable">$&#123;OS_VERSION&#125;</span> stable"</span> \</span></span><br><span class="line"><span class="bash">    | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -sL -o /usr/<span class="built_in">local</span>/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/jq</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /debian/<span class="variable">$&#123;OS_VERSION&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.apt[],.debian[]'</span> | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 &gt;&gt; packages.list</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown -R _apt /debian/<span class="variable">$OS_VERSION</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests \</span></span><br><span class="line"><span class="bash">    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="string">'^\w'</span> | sort -u | xargs apt-get download</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ../ &amp;&amp; dpkg-scanpackages <span class="variable">$OS_VERSION</span> | gzip -9c &gt; <span class="variable">$OS_VERSION</span>/Packages.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Debian 10 buster</span></span><br><span class="line"><span class="keyword">FROM</span> debian:buster-slim as buster</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=buster</span><br><span class="line"><span class="keyword">ARG</span> ARCH=amd64</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEP_PACKAGES=<span class="string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update -y -q \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install -y --no-install-recommends <span class="variable">$DEP_PACKAGES</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian <span class="variable">$&#123;OS_VERSION&#125;</span> stable"</span> \</span></span><br><span class="line"><span class="bash">    | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -sL -o /usr/<span class="built_in">local</span>/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/jq</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /debian/<span class="variable">$&#123;OS_VERSION&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.apt[],.debian[]'</span> | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 &gt;&gt; packages.list</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown -R _apt /debian/<span class="variable">$OS_VERSION</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests \</span></span><br><span class="line"><span class="bash">    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="string">'^\w'</span> | sort -u | xargs apt-get download</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ../ &amp;&amp; dpkg-scanpackages <span class="variable">$OS_VERSION</span> | gzip -9c &gt; <span class="variable">$OS_VERSION</span>/Packages.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu 18.04 bionic</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:bionic as bionic</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=bionic</span><br><span class="line"><span class="keyword">ARG</span> ARCH=amd64</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEP_PACKAGES=<span class="string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update -y -q \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install -y --no-install-recommends <span class="variable">$DEP_PACKAGES</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu <span class="variable">$&#123;OS_VERSION&#125;</span> stable"</span> \</span></span><br><span class="line"><span class="bash">    | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -sL -o /usr/<span class="built_in">local</span>/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/jq</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /ubuntu/<span class="variable">$&#123;OS_VERSION&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.apt[],.ubuntu[]'</span> | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 &gt;&gt; packages.list</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown -R _apt /ubuntu/<span class="variable">$OS_VERSION</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests \</span></span><br><span class="line"><span class="bash">    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="string">'^\w'</span> | sort -u | xargs apt-get download</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ../ &amp;&amp; dpkg-scanpackages <span class="variable">$OS_VERSION</span> | gzip -9c &gt; <span class="variable">$OS_VERSION</span>/Packages.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu 20.04 focal</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:focal as focal</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=focal</span><br><span class="line"><span class="keyword">ARG</span> ARCH=amd64</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEP_PACKAGES=<span class="string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update -y -q \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install -y --no-install-recommends <span class="variable">$DEP_PACKAGES</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu <span class="variable">$&#123;OS_VERSION&#125;</span> stable"</span> \</span></span><br><span class="line"><span class="bash">    | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -sL -o /usr/<span class="built_in">local</span>/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/jq</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /ubuntu/<span class="variable">$&#123;OS_VERSION&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.apt[],.ubuntu[]'</span> | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 &gt;&gt; packages.list</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown -R _apt /ubuntu/<span class="variable">$OS_VERSION</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests \</span></span><br><span class="line"><span class="bash">    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="string">'^\w'</span> | sort -u | xargs apt-get download</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ../ &amp;&amp; dpkg-scanpackages <span class="variable">$OS_VERSION</span> | gzip -9c &gt; <span class="variable">$OS_VERSION</span>/Packages.gz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=centos7 /centos /centos</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=stretch /debian /debian</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=buster /debian /debian</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=bionic /ubuntu /ubuntu</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=focal /ubuntu /ubuntu</span></span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>æ„å»ºå¥½äº†ç¦»çº¿æºä¹‹åï¼Œåœ¨éƒ¨ç½²çš„æœºå™¨ä¸Šè¿è¡Œä¸€ä¸ª Nginx æœåŠ¡ï¼Œç”¨äºæä¾› HTTP æ–¹å¼ä¸‹è½½è¿™äº›è½¯ä»¶åŒ…ï¼ŒåŒæ—¶éœ€è¦é…ç½®ä¸€ä¸‹æœºå™¨çš„åŒ…ç®¡ç†å™¨ repo é…ç½®æ–‡ä»¶ã€‚</p><ul><li>CentOS 7</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Inra-Mirror]</span><br><span class="line">name=Infra Mirror Repository</span><br><span class="line">baseurl=http://172.20.0.10/centos/7/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br></pre></td></tr></table></figure><ul><li>Debian 9 stretch</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb [trusted=yes] http://172.20.0.10:8080/debian stretch/</span><br></pre></td></tr></table></figure><ul><li>Debian 10 buster</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb [trusted&#x3D;yes] http:&#x2F;&#x2F;172.20.0.10:8080&#x2F;debian buster&#x2F;</span><br></pre></td></tr></table></figure><ul><li>Ubuntu 18.04 bionic</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb [trusted=yes] http://172.20.0.10:8080/ubuntu bionic/</span><br></pre></td></tr></table></figure><ul><li>Ubuntu 20.04 focal</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb [trusted&#x3D;yes] http:&#x2F;&#x2F;172.20.0.10:8080&#x2F;debian focal&#x2F;</span><br></pre></td></tr></table></figure><h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2><h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>å¯ä»¥è€ƒè™‘å°† Dockerfile ä¸­çš„æ„å»ºè¿‡ç¨‹åˆå¹¶æˆä¸€ä¸ª shell è„šæœ¬ï¼Œç„¶ååœ¨ Dockerfile ä¸­è°ƒç”¨è¿™ä¸ªè„šæœ¬å³å¯ï¼Œè¿™æ ·å¯ä¼˜åŒ– Dockerfile ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼ŒåŒæ—¶åç»­é€‚é…å¤šç§ OS çš„æ—¶å€™ä¹Ÿå¯ä»¥å¤ç”¨éƒ¨åˆ†ç›¸åŒçš„ä»£ç ï¼Œä½†è¿™æ ·å¯èƒ½ä¼šå¯¼è‡´ docker build ç¼“å­˜çš„å¤±æ•ˆé—®é¢˜ã€‚</p><p>å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨è„šæœ¬å°†å¤šä¸ª Dockerfile åˆå¹¶æˆä¸€ä¸ªï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Merge all Dockerfile.xx to an all-in-one file</span></span><br><span class="line">ls Dockerfile.* | xargs -L1 grep -Ev 'FROM scratch|COPY --from=' &gt; Dockerfile</span><br><span class="line">echo "FROM scratch" &gt;&gt; Dockerfile</span><br><span class="line">ls Dockerfile.* | xargs -L1 grep 'COPY --from=' &gt;&gt; Dockerfile</span><br></pre></td></tr></table></figure><h3 id="Package-version"><a href="#Package-version" class="headerlink" title="Package version"></a>Package version</h3><p>å¯¹äºä¸€äº›ç‰ˆæœ¬ä¸­åŒ…å« Linux å‘è¡Œç‰ˆæœ¬ä»£å·çš„åŒ…æ¥è®²ï¼Œæ‰‹åŠ¨ç»´æŠ¤è¿™ä¸ªä»£å·ä¸å¤ªæ–¹ä¾¿ï¼Œå¯ä»¥è€ƒè™‘å°†å®ƒé­”æ”¹æˆå ä½å˜é‡çš„æ–¹å¼ï¼Œåœ¨æ„å»ºå®¹å™¨å†…ç”Ÿæˆ package.list æ–‡ä»¶åç»Ÿä¸€ä½¿ç”¨ sed æŠŠè¿™äº›å ä½çš„å˜é‡ç»™æ›¿æ¢ä¸€ä¸‹ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt:</span><br><span class="line">  - docker-ce=5:19.03.15~3-0~__ID__-__VERSION_CODENAME__</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ sed å¤„ç†ä¸€ä¸‹ç”Ÿæˆçš„ packages.list ä¸­çš„è¿™äº›å ä½ç¬¦å˜é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">"s|__ID__|<span class="variable">$(sed -n 's|^ID=||p' /etc/os-release)</span>|;s|__VERSION_CODENAME__|<span class="variable">$(sed -n 's|^VERSION_CODENAME=||p' /etc/os-release)</span>|"</span> packages.list</span><br></pre></td></tr></table></figure><p>è™½ç„¶è¿™æ ·åšå¾ˆä¸ç¾è§‚ï¼Œä½†è¿™ç§æ–¹å¼ç¡®å®å¯è¡Œ ğŸ˜‚ï¼Œæœ€ç»ˆèƒ½å¤Ÿçš„åˆ°æ­£ç¡®çš„ç‰ˆæœ¬å·ã€‚æ€»ä¹‹æˆ‘ä»¬å°½é‡åœ°å°‘ç»´æŠ¤ä¸€äº›åŒ…çš„ç‰ˆæœ¬ï¼Œæ¯”å¦‚ä½¿ç”¨è¿™ç§æ–¹å¼å°±å¯ä»¥å°†æŸä¸ªç‰ˆæœ¬çš„ docker-ce åŒ…æ”¾åœ¨é…ç½®æ–‡ä»¶çš„ apt ä¸­ï¼Œè€Œä¸æ˜¯ debian/ubuntu ä¸­ï¼Œé€šè¿‡ä¸€äº›ç¯å¢ƒå˜é‡æˆ–è€… shell è„šæœ¬è‡ªåŠ¨æ·»åŠ ä¸Šè¿™äº›ç‰¹æ®Šé¡¹ï¼Œè¿™æ ·èƒ½å‡å°‘ä¸€äº›ç»´æŠ¤æˆæœ¬ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://www.aptly.info/tutorial/mirror/" target="_blank" rel="noopener">aptly.info</a></li><li><a href="https://mozillazg.com/2018/01/jq-use-examples-cookbook.html" target="_blank" rel="noopener">jq å¸¸ç”¨æ“ä½œ</a></li><li><a href="https://lyyao09.github.io/2019/08/02/tools/The-usage-of-yq-read-write/" target="_blank" rel="noopener">yq ä¹‹è¯»å†™ç¯‡</a></li><li><a href="https://docs.docker.com/develop/develop-images/build_enhancements/" target="_blank" rel="noopener">Build images with BuildKit</a></li><li><a href="https://github.com/kubernetes-sigs/kubespray/pull/6766" target="_blank" rel="noopener">kubernetes-sigs/kubespray/pull/6766</a></li><li><a href="https://moelove.info/2021/03/14/ä¸‡å­—é•¿æ–‡å½»åº•ææ‡‚å®¹å™¨é•œåƒæ„å»º/" target="_blank" rel="noopener">ä¸‡å­—é•¿æ–‡ï¼šå½»åº•ææ‡‚å®¹å™¨é•œåƒæ„å»º</a></li><li><a href="https://www.xiaocoder.com/2017/09/12/offline-local-source/" target="_blank" rel="noopener">ä¸º CentOS ä¸ Ubuntu åˆ¶ä½œç¦»çº¿æœ¬åœ°æº</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;ç¦»çº¿éƒ¨ç½²&quot;&gt;&lt;a href=&quot;#ç¦»çº¿éƒ¨ç½²&quot;
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="docker" scheme="https://blog.k8s.li/tags/docker/"/>
    
      <category term="centos" scheme="https://blog.k8s.li/tags/centos/"/>
    
      <category term="ubuntu" scheme="https://blog.k8s.li/tags/ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>kubespray éƒ¨ç½²å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æ±‡æ€»</title>
    <link href="https://blog.k8s.li/kubespray-tips.html"/>
    <id>https://blog.k8s.li/kubespray-tips.html</id>
    <published>2021-05-12T16:00:00.000Z</published>
    <updated>2021-05-12T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>kubespray v2.16 ç‰ˆæœ¬å³å°†å‘å¸ƒï¼Œæ•´ç†ä¸€ä¸‹è‡ªå·±åœ¨ä½¿ç”¨ kubespray è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œä¸€äº›ä¼˜åŒ–å»ºè®®ã€‚</p><h2 id="äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="äºŒè¿›åˆ¶æ–‡ä»¶"></a>äºŒè¿›åˆ¶æ–‡ä»¶</h2><p>åœ¨ kubespray ä¸Šæ¸¸çš„ <a href="https://github.com/kubernetes-sigs/kubespray/pull/7561" target="_blank" rel="noopener">#7561</a>  PR ä¸­å®ç°äº†æ ¹æ® kubespray çš„æºç ç”Ÿæˆéœ€è¦çš„æ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ã€‚åªéœ€è¦åœ¨ repo çš„ <code>contrib/offline</code> ç›®å½•ä¸‹æ‰§è¡Œ <code>bash generate_list.sh</code> å°±å¯ä»¥ç”Ÿæˆä¸€ä¸ª files.list å’Œä¸€ä¸ª images.list  æ–‡ä»¶ã€‚ç„¶åå°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ–‡ä»¶æ¥ä¸‹è½½ä¾èµ–çš„æ–‡ä»¶å’Œé•œåƒã€‚å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> contrib/offline</span><br><span class="line">$ bash generate_list.sh</span><br><span class="line">$ tree temp</span><br><span class="line">temp</span><br><span class="line">â”œâ”€â”€ files.list</span><br><span class="line">â”œâ”€â”€ generate.sh</span><br><span class="line">â””â”€â”€ images.list</span><br></pre></td></tr></table></figure><ul><li>files.list å†…å®¹å¦‚ä¸‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cat temp/files.list</span><br><span class="line">https://get.helm.sh/helm-v3.5.4-linux-amd64.tar.gz</span><br><span class="line">https://github.com/containerd/nerdctl/releases/download/v0.8.0/nerdctl-0.8.0-linux-amd64.tar.gz</span><br><span class="line">https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">https://github.com/containers/crun/releases/download/0.19/crun-0.19-linux-amd64</span><br><span class="line">https://github.com/coreos/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">https://github.com/kata-containers/runtime/releases/download/1.12.1/kata-static-1.12.1-x86_64.tar.xz</span><br><span class="line">https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.20.0/crictl-v1.20.0-linux-amd64.tar.gz</span><br><span class="line">https://github.com/kubernetes-sigs/krew/releases/download/v0.4.1/krew.tar.gz</span><br><span class="line">https://github.com/projectcalico/calico/archive/v3.17.4.tar.gz</span><br><span class="line">https://github.com/projectcalico/calicoctl/releases/download/v3.17.4/calicoctl-linux-amd64</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubeadm</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubectl</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubelet</span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡ wget è¿›è¡Œä¸‹è½½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -x -P temp/files -i temp/files.list</span><br></pre></td></tr></table></figure><ul><li>ä¸‹è½½åçš„æ–‡ä»¶å¦‚ä¸‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"> tree temp/files</span><br><span class="line">temp/files</span><br><span class="line">â”œâ”€â”€ get.helm.sh</span><br><span class="line">â”‚Â Â  â””â”€â”€ helm-v3.5.4-linux-amd64.tar.gz</span><br><span class="line">â”œâ”€â”€ github.com</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containerd</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ nerdctl</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.8.0</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ nerdctl-0.8.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containernetworking</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ plugins</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.9.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containers</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ crun</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ 0.19</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ crun-0.19-linux-amd64</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ coreos</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ etcd</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v3.4.13</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kata-containers</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ runtime</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ 1.12.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ kata-static-1.12.1-x86_64.tar.xz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kubernetes-sigs</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cri-tools</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â          â””â”€â”€ v1.20.0</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â              â””â”€â”€ crictl-v1.20.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ krew</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.4.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ krew.tar.gz</span><br><span class="line">â”‚Â Â  â””â”€â”€ projectcalico</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ calico</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ archive</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ v3.17.4.tar.gz</span><br><span class="line">â”‚Â Â      â””â”€â”€ calicoctl</span><br><span class="line">â”‚Â Â          â””â”€â”€ releases</span><br><span class="line">â”‚Â Â              â””â”€â”€ download</span><br><span class="line">â”‚Â Â                  â””â”€â”€ v3.17.4</span><br><span class="line">â”‚Â Â                      â””â”€â”€ calicoctl-linux-amd64</span><br><span class="line">â””â”€â”€ storage.googleapis.com</span><br><span class="line">    â””â”€â”€ kubernetes-release</span><br><span class="line">        â””â”€â”€ release</span><br><span class="line">            â””â”€â”€ v1.20.6</span><br><span class="line">                â””â”€â”€ bin</span><br><span class="line">                    â””â”€â”€ linux</span><br><span class="line">                        â””â”€â”€ amd64</span><br><span class="line">                            â”œâ”€â”€ kubeadm</span><br><span class="line">                            â”œâ”€â”€ kubectl</span><br><span class="line">                            â””â”€â”€ kubelet</span><br></pre></td></tr></table></figure><p>ä¿æŒè¿™ä¸ªç›®å½•ç»“æ„ä¸å˜ï¼ŒæŠŠå®ƒä»¬ä¸Šä¼ åˆ°è‡ªå·±çš„æ–‡ä»¶æœåŠ¡å™¨ä¸Šï¼Œç„¶åå†ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶çš„ä¸‹è½½å‚æ•°ï¼Œåªéœ€è¦åœ¨å‰é¢åŠ ä¸Šæ–‡ä»¶æœåŠ¡å™¨çš„ URL å³å¯ï¼Œæ¯”å¦‚æˆ‘çš„é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download URLs</span></span><br><span class="line"><span class="attr">download_url:</span> <span class="string">"https://dl.k8s.li"</span></span><br><span class="line"><span class="attr">kubelet_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubelet"</span></span><br><span class="line"><span class="attr">kubectl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubectl"</span></span><br><span class="line"><span class="attr">kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kubeadm_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubeadm"</span></span><br><span class="line"><span class="attr">etcd_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/coreos/etcd/releases/download/<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>/etcd-<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">cni_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containernetworking/plugins/releases/download/<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>/cni-plugins-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>-<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>.tgz"</span></span><br><span class="line"><span class="attr">calicoctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calicoctl/releases/download/<span class="template-variable">&#123;&#123; calico_ctl_version &#125;&#125;</span>/calicoctl-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_crds_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calico/archive/<span class="template-variable">&#123;&#123; calico_version &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crictl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kubernetes-sigs/cri-tools/releases/download/<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>/crictl-<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">helm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/get.helm.sh/helm-<span class="template-variable">&#123;&#123; helm_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crun_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containers/crun/releases/download/<span class="template-variable">&#123;&#123; crun_version &#125;&#125;</span>/crun-<span class="template-variable">&#123;&#123; crun_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kata_containers_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kata-containers/runtime/releases/download/<span class="template-variable">&#123;&#123; kata_containers_version &#125;&#125;</span>/kata-static-<span class="template-variable">&#123;&#123; kata_containers_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_architecture &#125;&#125;</span>.tar.xz"</span></span><br><span class="line"><span class="attr">nerdctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containerd/nerdctl/releases/download/v<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>/nerdctl-<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br></pre></td></tr></table></figure><ul><li>images.list æ˜¯ kubespray æ‰€æœ‰å¯èƒ½ä¼šç”¨åˆ°çš„é•œåƒï¼Œå¦‚ä¸‹ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat temp/images.list</span></span><br><span class="line">docker.io/amazon/aws-alb-ingress-controller:v1.1.9</span><br><span class="line">docker.io/amazon/aws-ebs-csi-driver:v0.5.0</span><br><span class="line">docker.io/cloudnativelabs/kube-router:v1.2.2</span><br><span class="line">docker.io/integratedcloudnative/ovn4nfv-k8s-plugin:v1.1.0</span><br><span class="line">docker.io/k8scloudprovider/cinder-csi-plugin:v1.20.0</span><br><span class="line">docker.io/kubeovn/kube-ovn:v1.6.2</span><br><span class="line">docker.io/kubernetesui/dashboard-amd64:v2.2.0</span><br><span class="line">docker.io/kubernetesui/metrics-scraper:v1.0.6</span><br><span class="line">docker.io/library/haproxy:2.3</span><br><span class="line">docker.io/library/nginx:1.19</span><br><span class="line">docker.io/library/registry:2.7.1</span><br><span class="line">docker.io/nfvpe/multus:v3.7</span><br><span class="line">docker.io/rancher/<span class="built_in">local</span>-path-provisioner:v0.0.19</span><br><span class="line">docker.io/weaveworks/weave-kube:2.8.1</span><br><span class="line">docker.io/weaveworks/weave-npc:2.8.1</span><br><span class="line">docker.io/xueshanf/install-socat:latest</span><br><span class="line">k8s.gcr.io/addon-resizer:1.8.11</span><br><span class="line">k8s.gcr.io/coredns:1.7.0</span><br><span class="line">k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64:1.8.3</span><br><span class="line">k8s.gcr.io/dns/k8s-dns-node-cache:1.17.1</span><br><span class="line">k8s.gcr.io/ingress-nginx/controller:v0.43.0</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-registry-proxy:0.4</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.20.6</span><br><span class="line">k8s.gcr.io/metrics-server/metrics-server:v0.4.2</span><br><span class="line">k8s.gcr.io/pause:3.3</span><br><span class="line">quay.io/calico/cni:v3.17.4</span><br><span class="line">quay.io/calico/kube-controllers:v3.17.4</span><br><span class="line">quay.io/calico/node:v3.17.4</span><br><span class="line">quay.io/calico/typha:v3.17.4</span><br><span class="line">quay.io/cilium/cilium-init:2019-04-05</span><br><span class="line">quay.io/cilium/cilium:v1.8.9</span><br><span class="line">quay.io/cilium/operator:v1.8.9</span><br><span class="line">quay.io/coreos/etcd:v3.4.13</span><br><span class="line">quay.io/coreos/flannel:v0.13.0-amd64</span><br><span class="line">quay.io/datawire/ambassador-operator:v1.2.9</span><br><span class="line">quay.io/external_storage/cephfs-provisioner:v2.1.0-k8s1.11</span><br><span class="line">quay.io/external_storage/<span class="built_in">local</span>-volume-provisioner:v2.3.4</span><br><span class="line">quay.io/external_storage/rbd-provisioner:v2.1.1-k8s1.11</span><br><span class="line">quay.io/jetstack/cert-manager-cainjector:v1.0.4</span><br><span class="line">quay.io/jetstack/cert-manager-controller:v1.0.4</span><br><span class="line">quay.io/jetstack/cert-manager-webhook:v1.0.4</span><br><span class="line">quay.io/k8scsi/csi-attacher:v2.2.0</span><br><span class="line">quay.io/k8scsi/csi-node-driver-registrar:v1.3.0</span><br><span class="line">quay.io/k8scsi/csi-provisioner:v1.6.0</span><br><span class="line">quay.io/k8scsi/csi-resizer:v0.5.0</span><br><span class="line">quay.io/k8scsi/csi-snapshotter:v2.1.1</span><br><span class="line">quay.io/k8scsi/snapshot-controller:v2.0.1</span><br><span class="line">quay.io/l23network/k8s-netchecker-agent:v1.0</span><br><span class="line">quay.io/l23network/k8s-netchecker-server:v1.0</span><br></pre></td></tr></table></figure><p>å¯ä½¿ç”¨ skopeo å°†é•œåƒåŒæ­¥åˆ°è‡ªå·±çš„ registry ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> $(cat temp/images.list); <span class="keyword">do</span> skopeo copy docker://<span class="variable">$&#123;image&#125;</span> docker://hub.k8s.li/<span class="variable">$&#123;image#*/&#125;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><blockquote><p>å½“æ—¶å†™è¿™ä¸ªè„šæœ¬çš„æ—¶å€™ä¸€å †è›‡çš® sed æ›¿æ¢æ“ä½œå†™å¾—æƒ³ ğŸ¤®ï¼Œæ¯”å¦‚æœ‰äº›å˜é‡ä¼šæœ‰ ansible çš„ if else åˆ¤æ–­ï¼Œè¿™å°±æ„å‘³ç€ä¹Ÿè¦ç”¨ shell å»å®ç°å®ƒçš„åˆ¤æ–­é€»è¾‘ã€‚æ¯”å¦‚ä½¿ç”¨ shell å¤„ç†çš„æ—¶å€™éœ€è¦å°†è¿™ä¸‹é¢å¨è½¬æ¢æˆ shell çš„ if elseï¼Œè€Œä¸”è¿˜ä¸èƒ½æ¢è¡Œï¼š</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">coredns_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span><span class="template-variable">&#123;&#123;'/coredns/coredns' if (coredns_image_is_namespaced | bool) else '/coredns' &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">coredns_image_tag:</span> <span class="string">"<span class="template-variable">&#123;&#123; coredns_version if (coredns_image_is_namespaced | bool) else (coredns_version | regex_replace('^v', '')) &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># special handling for https://github.com/kubernetes-sigs/kubespray/pull/7570</span></span><br><span class="line">sed -i <span class="string">'s#^coredns_image_repo=.*#coredns_image_repo=$&#123;kube_image_repo&#125;$(if printf "%s\\n%s\\n" v1.21 $&#123;kube_version%.*&#125; | sort --check=quiet --version-sort; then echo -n /coredns/coredns;else echo -n /coredns; fi)#'</span> <span class="variable">$&#123;TEMP_DIR&#125;</span>/generate.sh</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'s#^coredns_image_tag=.*#coredns_image_tag=$(if printf "%s\\n%s\\n" v1.21 $&#123;kube_version%.*&#125; | sort --check=quiet --version-sort; then echo -n $&#123;coredns_version&#125;;else echo -n $&#123;coredns_version/v/&#125;; fi)#'</span> <span class="variable">$&#123;TEMP_DIR&#125;</span>/generate.sh</span><br></pre></td></tr></table></figure><p>å½“æ—¶è¿˜å­¦ä¼šäº†ä¸€æ‰‹ï¼Œåœ¨ shell ä¸­ä½¿ç”¨ <code>printf &quot;%s\\n%s\\n&quot; $v1 $v2 | sort --check=quiet --version-sort</code> è¿™ç§æ–¹å¼å¯ä»¥åˆ¤æ–­ä¸¤ä¸ªç‰ˆæœ¬å·çš„å¤§å°ï¼Œè€Œä¸”æ˜¯æœ€ç®€å•ä¾¿æ·çš„ã€‚</p><h2 id="é•œåƒä»“åº“"><a href="#é•œåƒä»“åº“" class="headerlink" title="é•œåƒä»“åº“"></a>é•œåƒä»“åº“</h2><p>ä¹‹å‰æåˆ°çš„æ˜¯æ ¹æ®é•œåƒåˆ—è¡¨å°†éœ€è¦çš„é•œåƒåŒæ­¥åˆ°è‡ªå·±çš„ registry ä¸­ï¼Œä½†å¯¹äºæœ¬åœ°å¼€å‘æµ‹è¯•æ¥è®²ï¼Œè¿™ç§æ‰‹åŠ¨å¯¼å…¥æ¯”è¾ƒè´¹äº‹è´¹åŠ›ã€‚åœ¨çœ‹äº†å¤§ä½¬å†™çš„ <a href="https://fuckcloudnative.io/posts/docker-registry-proxy/" target="_blank" rel="noopener">Docker é•œåƒåŠ é€Ÿæ•™ç¨‹</a> å’Œ <a href="https://www.chenshaowen.com/blog/how-to-run-a-private-registry-mirror.html" target="_blank" rel="noopener">å¦‚ä½•æ­å»ºä¸€ä¸ªç§æœ‰çš„é•œåƒä»“åº“ mirror</a>  å°±æƒ³åˆ°äº†å¯ä»¥ä½¿ç”¨ docker registry çš„ proxy ç‰¹æ€§æ¥éƒ¨ç½²å‡ ä¸ª kubespray éœ€è¦çš„é•œåƒä»“åº“ã€‚å¦‚ä¸‹</p><table><thead><tr><th>origin</th><th>mirror</th></tr></thead><tbody><tr><td>docker.io</td><td>hub.k8s.li</td></tr><tr><td>k8s.gcr.io</td><td>gcr.k8s.li</td></tr><tr><td>quay.io</td><td>quay.k8s.li</td></tr></tbody></table><ul><li>config.yml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">0.1</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">registry</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">blobdescriptor:</span> <span class="string">inmemory</span></span><br><span class="line">  <span class="attr">oss:</span></span><br><span class="line">    <span class="attr">accesskeyid:</span> <span class="string">xxxx</span> <span class="comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeyid</span></span><br><span class="line">    <span class="attr">accesskeysecret:</span> <span class="string">xxxx</span> <span class="comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeysecret</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">oss-cn-beijing</span> <span class="comment"># é…ç½® OSS bucket çš„åŒºåŸŸï¼Œæ¯”å¦‚ oss-cn-beijing</span></span><br><span class="line">    <span class="attr">internal:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">bucket:</span> <span class="string">fileserver</span> <span class="comment"># é…ç½®å­˜å‚¨ bucket çš„åç§°</span></span><br><span class="line">    <span class="attr">rootdirectory:</span> <span class="string">/kubespray/registry</span> <span class="comment"># é…ç½®è·¯å¾„</span></span><br><span class="line">  <span class="attr">delete:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">headers:</span></span><br><span class="line">    <span class="attr">X-Content-Type-Options:</span> <span class="string">[nosniff]</span></span><br><span class="line"><span class="attr">health:</span></span><br><span class="line">  <span class="attr">storagedriver:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><ul><li>docker-compose.yml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">gcr-registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gcr-registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.yml:/etc/docker/registry/config.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5001:5001</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_HTTP_ADDR=0.0.0.0:5001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_PROXY_REMOTEURL=https://k8s.gcr.io</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">hub-registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">hub-registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.yml:/etc/docker/registry/config.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5002:5002</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_HTTP_ADDR=0.0.0.0:5002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_PROXY_REMOTEURL=https://docker.io</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">quay-registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">quay-registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.yml:/etc/docker/registry/config.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5003:5003</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_HTTP_ADDR=0.0.0.0:5003</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_PROXY_REMOTEURL=https://quay.io</span></span><br></pre></td></tr></table></figure><ul><li>nginx.conf</li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  gcr.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> domain.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> domain.key;</span><br><span class="line">    <span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">100000m</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET|HEAD)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   http://localhost:5001;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  hub.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> domain.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> domain.key;</span><br><span class="line">    <span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">100000m</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET|HEAD)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   http://localhost:5002;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  quay.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> domain.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> domain.key;</span><br><span class="line">    <span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">100000m</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET|HEAD)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   http://localhost:5003;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸å…³é…ç½®æ–‡ä»¶åœ¨ <a href="https://github.com/muzi502/registry-mirrors" target="_blank" rel="noopener">registry-mirrors</a> è¿™ä¸ª repo ä¸­ã€‚</p><h2 id="ä¼˜åŒ–-kubespray-é•œåƒå¤§å°"><a href="#ä¼˜åŒ–-kubespray-é•œåƒå¤§å°" class="headerlink" title="ä¼˜åŒ– kubespray é•œåƒå¤§å°"></a>ä¼˜åŒ– kubespray é•œåƒå¤§å°</h2><p>kubespray v1.25.1 ç‰ˆæœ¬å®˜æ–¹æ„å»ºçš„é•œåƒå¤§å°ä¸º <code>1.41GB</code>ï¼Œå¯¹äºä¸€äº›åœºæ™¯ä¸‹å¸Œæœ›é•œåƒå°ä¸€äº›ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•æ„å»ºä¸€ä¸ªä½“ç§¯è¾ƒå°çš„é•œåƒã€‚</p><ul><li>é¦–å…ˆæ„å»ºä¸€ä¸ª base é•œåƒï¼Œå¯¹äºä¸ç»å¸¸å˜åŠ¨çš„æˆ‘ä»¬æŠŠå®ƒå°è£…åœ¨ä¸€ä¸ª base é•œåƒé‡Œï¼Œåªæœ‰å½“ç›¸å…³ä¾èµ–æ›´æ–°äº†æ‰éœ€è¦é‡æ–°æ„å»ºè¿™ä¸ª base é•œåƒï¼Œ<code>Dockerfile.base</code> å¦‚ä¸‹ï¼š</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.6</span>-slim</span><br><span class="line"><span class="keyword">ENV</span> KUBE_VERSION v1.<span class="number">20.6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update -y \</span></span><br><span class="line"><span class="bash"> &amp;&amp; apt install -y \</span></span><br><span class="line"><span class="bash"> libssl-dev sshpass apt-transport-https jq moreutils vim moreutils iputils-ping \</span></span><br><span class="line"><span class="bash"> ca-certificates curl gnupg2 software-properties-common rsync wget tcpdump \</span></span><br><span class="line"><span class="bash"> &amp;&amp; rm -rf /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="bash"> &amp;&amp; wget -q https://dl.k8s.io/<span class="variable">$KUBE_VERSION</span>/bin/linux/amd64/kubectl -O /usr/<span class="built_in">local</span>/bin/kubectl \</span></span><br><span class="line"><span class="bash"> &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/kubectl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /kubespray</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> python3 -m pip install -r requirements.txt</span></span><br></pre></td></tr></table></figure><p>æ„å»º kubespray é•œåƒï¼šFROM çš„ base é•œåƒå°±ä½¿ç”¨æˆ‘ä»¬åˆšåˆšæ„å»ºå¥½çš„é•œåƒï¼Œå¯¹äº kubespray æ¥è®²ï¼Œç›¸å…³ä¾èµ–å·²ç»åœ¨ base é•œåƒä¸­å®‰è£…å¥½äº†ï¼Œè¿™é‡Œæ„å»ºçš„æ—¶å€™åªéœ€è¦æŠŠ repo å¤åˆ¶åˆ° /kubespray ç›®å½•ä¸‹å³å¯ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> kubespray:v2.<span class="number">16.0</span>-base-kube-v1.<span class="number">20.6</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . /kubespray</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·æ„å»ºå‡ºæ¥çš„é•œåƒå¤§å°ä¸åˆ° 600MBï¼Œæ¯”ä¹‹å‰å°äº†å¾ˆå¤šï¼Œè€Œä¸”æ¯æ¬¡æ„å»ºé•œåƒçš„æ—¶å€™ä¹Ÿæ¯”è¾ƒå¿«ã€‚åªä¸è¿‡å½“ <code>requirements.txt</code>  æ–‡ä»¶æ›´æ–°åéœ€è¦é‡æ–°æ„å»º base é•œåƒï¼Œå¹¶ä¿®æ”¹ kubespray çš„ FROM é•œåƒä¸ºæ–°çš„ base é•œåƒã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubespray     v2.15.1                  73294562105a    1.41GB</span><br><span class="line">kubespray     v2.16-kube-v1.20.6-1.0   80b735995e48    579MB</span><br></pre></td></tr></table></figure><ul><li>kubespray é»˜è®¤æ²¡æœ‰åŠ å¦‚ <code>.dockerignore</code>ï¼Œè¿™å°±æ„å‘³ç€æ„å»ºé•œåƒçš„æ—¶å€™ä¼šæŠŠå½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹å¤åˆ¶åˆ°é•œåƒé‡Œï¼Œä¼šå¯¼è‡´é•œåƒå·¥ä½œç›®å½•ä¸‹å¯èƒ½å¾ˆæ··ä¹±ï¼Œåœ¨å®¹å™¨é‡Œ debug çš„æ—¶å€™ä¸å¤ªç¾è§‚ï¼Œå¼ºè¿«ç—‡æ‚£è€…å¯ä»¥åœ¨ repo ä¸­åŠ å…¥å¦‚ä¸‹çš„ <code>.dockerignore</code> æ–‡ä»¶ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.ansible-lint</span><br><span class="line">.editorconfig</span><br><span class="line">.git</span><br><span class="line">.github</span><br><span class="line">.gitignore</span><br><span class="line">.gitlab-ci</span><br><span class="line">.gitlab-ci.yml</span><br><span class="line">.gitmodules</span><br><span class="line">.markdownlint.yaml</span><br><span class="line">.nojekyll</span><br><span class="line">CNAME</span><br><span class="line">CONTRIBUTING.md</span><br><span class="line">Dockerfile</span><br><span class="line">Makefile</span><br><span class="line">OWNERS</span><br><span class="line">README.md</span><br><span class="line">RELEASE.md</span><br><span class="line">SECURITY_CONTACTS</span><br><span class="line">build</span><br><span class="line">code-of-conduct.md</span><br><span class="line">docs</span><br><span class="line">index.html</span><br><span class="line">logo</span><br></pre></td></tr></table></figure><h2 id="docker-registry-ç¦æ­¢-push-é•œåƒ"><a href="#docker-registry-ç¦æ­¢-push-é•œåƒ" class="headerlink" title="docker registry ç¦æ­¢ push é•œåƒ"></a>docker registry ç¦æ­¢ push é•œåƒ</h2><p>é»˜è®¤ç›´æ¥ä½¿ç”¨ docker registry æ¥éƒ¨ç½²é•œåƒä»“åº“çš„è¯ï¼Œæ¯”å¦‚æˆ‘çš„ hub.k8s.li ï¼Œå› ä¸ºæ²¡æœ‰æƒé™é™åˆ¶ä¼šå¯¼è‡´ä»»ä½•å¯è®¿é—®è¯¥é•œåƒä»“åº“çš„å®¢æˆ·ç«¯å¯ä»¥ push é•œåƒï¼Œè¿™æœ‰ç‚¹ä¸å®‰å…¨ï¼Œéœ€è¦å®‰å…¨åŠ å›ºä¸€ä¸‹ã€‚å› ä¸º pull é•œåƒçš„æ—¶å€™å®¢æˆ·ç«¯èµ°çš„éƒ½æ˜¯ HTTP GET è¯·æ±‚ï¼Œå¯ä»¥é€šè¿‡ nginx ç¦æ­¢ POSTã€PUT è¿™ç§è¯·æ±‚æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥ç¦æ­¢ push é•œåƒã€‚åœ¨ nginx çš„server å­—æ®µä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·åœ¨ push é•œåƒçš„æ—¶å€™ä¼šè¿”å› 403 çš„é”™è¯¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root # docker pull hub.k8s.li/calico/node:v3.17.3</span><br><span class="line">v3.17.3: Pulling from calico/node</span><br><span class="line">282bf12aa8be: Pull complete</span><br><span class="line">4ac1bb9354ad: Pull complete</span><br><span class="line">Digest: sha256:3595a9a945a7ba346a12ee523fc7ae15ed35f1e6282b76bce7fec474d28d68bb</span><br><span class="line">Status: Downloaded newer image for hub.k8s.li/calico/node:v3.17.3</span><br><span class="line">root@debian:/root # docker push !$</span><br><span class="line">root@debian:/root # docker push hub.k8s.li/calico/node:v3.17.3</span><br><span class="line">The push refers to repository [hub.k8s.li/calico/node]</span><br><span class="line">bc19ae092bb4: Preparing</span><br><span class="line">94333d52d45d: Preparing</span><br><span class="line">error parsing HTTP 403 response body: invalid character '&lt;' looking for beginning of value: "&lt;html&gt;\r\n&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;\r\n&lt;body bgcolor=\"white\"&gt;\r\n&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;\r\n&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n"</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆéœ€è¦ push é•œåƒçš„æ—¶å€™æ€ä¹ˆåŠï¼Ÿ</p><p>docker registry å¯åŠ¨çš„æ—¶å€™ bind åœ¨ 127.0.0.1 ä¸Šï¼Œè€Œä¸æ˜¯ 0.0.0.0ï¼Œé€šè¿‡ localhost:5000 æ¥ push é•œåƒã€‚</p><h2 id="é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦"><a href="#é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦" class="headerlink" title="é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦"></a>é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦</h2><p>å¦‚æœé•œåƒä»“åº“ä½¿ç”¨çš„æ˜¯è‡ªç­¾è¯ä¹¦ï¼Œå¯ä»¥è·‘ä¸‹é¢è¿™ä¸ª playbook å°†è‡ªç­¾è¯ä¹¦æ·»åŠ åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ trusted CA dir ä¸­ï¼Œè¿™æ ·æ— éœ€é…ç½® <code>insecure-registries</code> ä¹Ÿèƒ½æ‹‰å–é•œåƒã€‚</p><p><code>add-registry-ca.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">target</span> <span class="string">ca-certificate</span> <span class="string">store</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">set_fact:</span></span><br><span class="line">        <span class="attr">ca_cert_path:</span> <span class="string">|-</span></span><br><span class="line">          <span class="string">&#123;%</span> <span class="string">if</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"Debian"</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/usr/local/share/ca-certificates/registry-ca.crt</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">elif</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"RedHat"</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/etc/pki/ca-trust/source/anchors/registry-ca.crt</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">elif</span> <span class="string">ansible_os_family</span> <span class="string">in</span> <span class="string">["Flatcar</span> <span class="string">Container</span> <span class="string">Linux</span> <span class="string">by</span> <span class="string">Kinvolk"]</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/etc/ssl/certs/registry-ca.pem</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">elif</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"Suse"</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/etc/pki/trust/anchors/registry-ca.pem</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">elif</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"ClearLinux"</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/usr/share/ca-certs/registry-ca.pem</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">endif</span> <span class="string">%&#125;</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">facts</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">add</span> <span class="string">CA</span> <span class="string">to</span> <span class="string">trusted</span> <span class="string">CA</span> <span class="string">dir</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_cert_path &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">&#123;&#123; ca_cert_path &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">registry_ca_cert</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">update</span> <span class="string">ca-certificates</span> <span class="string">(Debian/Ubuntu/SUSE/Flatcar)</span>  <span class="comment"># noqa 503</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">update-ca-certificates</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">registry_ca_cert.changed</span> <span class="string">and</span> <span class="string">ansible_os_family</span> <span class="string">in</span> <span class="string">["Debian",</span> <span class="string">"Flatcar Container Linux by Kinvolk"</span><span class="string">,</span> <span class="string">"Suse"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">update</span> <span class="string">ca-certificates</span> <span class="string">(RedHat)</span>  <span class="comment"># noqa 503</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">update-ca-trust</span> <span class="string">extract</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">registry_ca_cert.changed</span> <span class="string">and</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"RedHat"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">update</span> <span class="string">ca-certificates</span> <span class="string">(ClearLinux)</span>  <span class="comment"># noqa 503</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">clrtrust</span> <span class="string">add</span> <span class="string">"<span class="template-variable">&#123;&#123; ca_cert_path &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">registry_ca_cert.changed</span> <span class="string">and</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"ClearLinux"</span></span><br></pre></td></tr></table></figure><ul><li>å°†è‡ªç­¾çš„ registry è¯ä¹¦æ”¾åˆ°æœ¬åœ°ï¼Œæ‰§è¡Œ playbook å¹¶æŒ‡å®š <code>registry_cert_path</code> ä¸ºæ­£ç¡®çš„è·¯å¾„</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/kubespray# ansible-playbook -i deploy/inventory -e registry_cert_path=/kubespray/registry_ca.pem add-registry-ca.yml</span><br><span class="line"></span><br><span class="line">PLAY [all] **********************************************************************************</span><br><span class="line">Thursday 29 April 2021  08:18:25 +0000 (0:00:00.077)       0:00:00.077 ********</span><br><span class="line"></span><br><span class="line">TASK [Gen_certs | target ca-certificate store file] *****************************************</span><br><span class="line">ok: [kube-control-2]</span><br><span class="line">ok: [kube-control-3]</span><br><span class="line">ok: [kube-control-1]</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">Thursday 29 April 2021  08:18:25 +0000 (0:00:00.389)       0:00:00.467 ********</span><br><span class="line"></span><br><span class="line">TASK [Gen_certs | add CA to trusted CA dir] *************************************************</span><br><span class="line">changed: [kube-control-2]</span><br><span class="line">changed: [kube-control-3]</span><br><span class="line">changed: [kube-control-1]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">Thursday 29 April 2021  08:18:29 +0000 (0:00:04.433)       0:00:04.901 ********</span><br><span class="line">Thursday 29 April 2021  08:18:30 +0000 (0:00:00.358)       0:00:05.259 ********</span><br><span class="line"></span><br><span class="line">TASK [Gen_certs | update ca-certificates (RedHat)] ******************************************</span><br><span class="line">changed: [kube-control-1]</span><br><span class="line">changed: [kube-control-3]</span><br><span class="line">changed: [kube-control-2]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">Thursday 29 April 2021  08:18:33 +0000 (0:00:02.938)       0:00:08.197 ********</span><br><span class="line"></span><br><span class="line">PLAY RECAP **********************************************************************************</span><br><span class="line">kube-control-1             : ok=3    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0</span><br><span class="line">kube-control-2             : ok=3    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0</span><br><span class="line">kube-control-3             : ok=3    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0</span><br><span class="line">kube-node-1                : ok=3    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0</span><br><span class="line"></span><br><span class="line">Thursday 29 April 2021  08:18:33 +0000 (0:00:00.355)  0:00:08.553 ********</span><br><span class="line">================================================================</span><br><span class="line">Gen_certs | add CA to trusted CA dir ------------------------------------------------------------- 4.43s</span><br><span class="line">Gen_certs | update ca-certificates (RedHat) ------------------------------------------------------------- 2.94s</span><br><span class="line">Gen_certs | target ca-certificate store file ------------------------------------------------------------- 0.39s</span><br><span class="line">Gen_certs | update ca-certificates (Debian/Ubuntu/SUSE/Flatcar) ------------------------------------------------------------- 0.36s</span><br><span class="line">Gen_certs | update ca-certificates (ClearLinux) -------------------------------------------------------------- 0.36s</span><br></pre></td></tr></table></figure><h2 id="containerd-æ— æ³•åŠ è½½-CNI-é…ç½®å¯¼è‡´èŠ‚ç‚¹-NotReady"><a href="#containerd-æ— æ³•åŠ è½½-CNI-é…ç½®å¯¼è‡´èŠ‚ç‚¹-NotReady" class="headerlink" title="containerd æ— æ³•åŠ è½½ CNI é…ç½®å¯¼è‡´èŠ‚ç‚¹ NotReady"></a>containerd æ— æ³•åŠ è½½ CNI é…ç½®å¯¼è‡´èŠ‚ç‚¹ NotReady</h2><p>å¶ç°é—®é¢˜ï¼Œé‡å¯ä¸€ä¸‹ containerd å°±å¯ä»¥äº†ï¼Œå…·ä½“åŸå› è¿˜æ²¡æ’æŸ¥å‡ºæ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/kubespray<span class="comment"># ansible all -i deploy/inventory -m service -a "name=containerd state=restarted"</span></span><br></pre></td></tr></table></figure><h2 id="ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦"><a href="#ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦" class="headerlink" title="ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦"></a>ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦</h2><p>Kubespray éƒ¨ç½²çš„æ—¶å€™æœ‰ä¸ª task ä¸“é—¨ç”¨æ¥ä¸‹è½½éƒ¨ç½²éœ€è¦çš„é•œåƒï¼Œç”±äºæ˜¯æ“ä½œçš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¼šå°†ä¸€äº›ä¸éœ€è¦çš„é•œåƒæ‹‰å–åˆ°è¯¥èŠ‚ç‚¹ä¸Šã€‚æ¯”å¦‚ kube-apiserverã€kube-controller-managerã€kube-scheduler è¿™äº›åœ¨ node èŠ‚ç‚¹ä¸Šä¸ä¼šç”¨åˆ°çš„é•œåƒä¹Ÿä¼šåœ¨ node èŠ‚ç‚¹ä¸Šæ‹‰å–ï¼Œè¿™æ ·ä¼šå¯¼è‡´ download çš„ task æ¯”è¾ƒè€—æ—¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">TASK [download : set_container_facts | Display the name of the image being processed] ********************************************************************************************</span><br><span class="line">ok: [kube-control-3] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-controller-manager"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-control-2] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-controller-manager"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-control-1] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-controller-manager"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-node-1] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-controller-manager"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ok: [kube-control-3] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-scheduler"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-control-2] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-scheduler"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-control-1] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-scheduler"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-node-1] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-scheduler"</span></span><br></pre></td></tr></table></figure><p>å¯ç”¨é€šè¿‡ <code>download_container: false</code> è¿™ä¸ªå‚æ•°æ¥ç¦ç”¨ download container è¿™ä¸ª taskï¼Œè¿™æ ·åœ¨ pod å¯åŠ¨çš„æ—¶å€™åªæ‹‰å–éœ€è¦çš„é•œåƒï¼Œå¯ä»¥èŠ‚çœä¸€äº›éƒ¨ç½²è€—æ—¶ã€‚</p><h2 id="å¯ç”¨æ’ä»¶"><a href="#å¯ç”¨æ’ä»¶" class="headerlink" title="å¯ç”¨æ’ä»¶"></a>å¯ç”¨æ’ä»¶</h2><p>Kubespray å®˜æ–¹æ”¯æŒçš„æ’ä»¶åˆ—è¡¨å¦‚ä¸‹ï¼Œé»˜è®¤æ˜¯ false ç¦ç”¨äº†æ’ä»¶ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kubernetes dashboard</span></span><br><span class="line"><span class="comment"># RBAC required. see docs/getting-started.md for access details.</span></span><br><span class="line"><span class="attr">dashboard_enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Addons which can be enabled</span></span><br><span class="line"><span class="attr">helm_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">krew_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">registry_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">metrics_server_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">enable_network_policy:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">local_path_provisioner_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">local_volume_provisioner_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">local_volume_provisioner_directory_mode:</span> <span class="number">0700</span></span><br><span class="line"><span class="attr">cinder_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">aws_ebs_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">azure_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">gcp_pd_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">vsphere_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">persistent_volumes_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">cephfs_provisioner_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">rbd_provisioner_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">ingress_nginx_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">ingress_ambassador_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">ingress_alb_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">cert_manager_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">expand_persistent_volumes:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">metallb_enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># containerd official CLI tool</span></span><br><span class="line"><span class="attr">nerdctl_enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>åœ¨éƒ¨ç½²çš„æ—¶å€™å¦‚æœæƒ³å¯åŠ¨æŸäº›æ’ä»¶å¯ä»¥åœ¨è‡ªå·±æœ¬åœ°å¯¹åº”çš„ inventory ç›®å½•ä¸‹çš„ <code>group_vars/k8s_cluster/addons.yml</code> æ–‡ä»¶ä¸­é€‰æ‹©å¼€å¯ç›¸åº”çš„æ’ä»¶ï¼Œæ¯”å¦‚ <code>inventory/sample/group_vars/k8s_cluster/addons.yml</code>ã€‚</p><h2 id="åˆ†å±‚éƒ¨ç½²"><a href="#åˆ†å±‚éƒ¨ç½²" class="headerlink" title="åˆ†å±‚éƒ¨ç½²"></a>åˆ†å±‚éƒ¨ç½²</h2><p>è¿™ä¸ªæ˜¯æˆ‘ä»¬å¯¹ kubespray äºŒå¼€çš„ä¸€ä¸ªä¼˜åŒ–é¡¹ã€‚kubespray åœ¨éƒ¨ç½²é›†ç¾¤çš„æ—¶å€™è¿è¡Œçš„ playbook æ˜¯ <code>cluster.yml</code>ï¼Œåœ¨é›†ç¾¤éƒ¨ç½²çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå› ä¸ºä½ ä¸€äº›ä¸ç¨³å®šå› ç´ å¯¼è‡´é›†ç¾¤éƒ¨ç½²å¤±è´¥ï¼Œå¤±è´¥åå†æ¬¡å°è¯•éƒ¨ç½²çš„è¯ï¼Œkubespray ä¼šä»å¤´å¼€å§‹å†è·‘ä¸€éå·²ç»æˆåŠŸè¿è¡Œçš„ taskï¼Œè¿™æ ·çš„æ•ˆç‡ä¼šæ¯”è¾ƒä½ã€‚å› æ­¤éœ€è¦ä½¿ç”¨æŸç§æ–¹æ³•è®°å½•ä¸€ä¸‹å·²ç»æˆåŠŸæ‰§è¡Œçš„ task æˆ– rolesï¼Œå¤±è´¥åé‡æ–°éƒ¨ç½²çš„æ—¶å€™å°±è·³è¿‡è¿™äº›å·²ç»æˆåŠŸè¿è¡Œçš„ taskï¼Œç„¶åä»ä¸Šæ¬¡å¤±è´¥çš„åœ°æ–¹å¼€å§‹è¿è¡Œã€‚</p><p>å¤§ä½“çš„æ€è·¯æ˜¯æ ¹æ® <code>cluster.yml</code> ä¸­çš„ roles æ‹†åˆ†ä¸ºä¸åŒçš„å±‚å³ layerï¼Œå¦‚ bootstrap-osã€downloadã€kubernetesã€networkã€apps ï¼Œåœ¨éƒ¨ç½²çš„è¿‡ç¨‹ä¸­æ¯è¿è¡Œå®Œä¸€ä¸ª layer å°±å°†å®ƒè®°å½•åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œéƒ¨ç½²çš„æ—¶å€™ä¼šæ ¹æ®è¿™ä¸ªæ–‡ä»¶æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦éƒ¨ç½²ï¼Œå¦‚æœæ–‡ä»¶ä¸­è®°å½•å­˜åœ¨çš„è¯å°±è¯´æ˜å·²ç»æˆåŠŸéƒ¨ç½²å®Œæˆäº†ï¼Œå°±è·³è¿‡å®ƒï¼Œç»§ç»­æ‰§è¡Œæœªæ‰§è¡Œçš„ layerã€‚</p><p>è‡³äºæ‹†åˆ†çš„æ–¹å¼å¤§æ¦‚æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ ¹æ® tag ã€ä¸€ç§æ˜¯å°† <code>cluster.yml</code> æ–‡ä»¶æ‹†åˆ†æˆè‹¥å¹²ä¸ª playbook æ–‡ä»¶ã€‚é€šè¿‡ tag çš„æ–¹å¼å¯èƒ½ä¼šæ¯”è¾ƒå¤æ‚ä¸€äº›ï¼Œåœ¨è¿™é‡Œè¿˜æ˜¯é€‰æ‹©æ‹†åˆ†çš„æ–¹å¼ã€‚æ‹†åˆ†çš„ç²’åº¦æœ‰å¤§æœ‰å°ï¼Œä»¥ä¸‹æ˜¯æˆ‘è®¤ä¸ºæ¯”è¾ƒåˆç†çš„æ‹†å°æ–¹å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">playbooks</span><br><span class="line">â”œâ”€â”€ 00-default-ssh-config.yml <span class="comment"># é»˜è®¤éœ€è¦è¿è¡Œçš„ playbookï¼Œç”¨äºé…ç½®å ¡å’æœºå’Œé…ç½® ssh è®¤è¯</span></span><br><span class="line">â”œâ”€â”€ 01-cluster-bootstrap-os.yml <span class="comment"># åˆå§‹åŒ–é›†ç¾¤èŠ‚ç‚¹ OSï¼Œå®‰è£…å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸‹è½½éƒ¨ç½²ä¾èµ–çš„æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ 02-cluster-etcd.yml <span class="comment"># éƒ¨ç½² etcd é›†ç¾¤</span></span><br><span class="line">â”œâ”€â”€ 03-cluster-kubernetes.yml <span class="comment"># éƒ¨ç½² kubernetes é›†ç¾¤</span></span><br><span class="line">â”œâ”€â”€ 04-cluster-network.yml <span class="comment"># éƒ¨ç½²ç½‘ç»œæ’ä»¶</span></span><br><span class="line">â”œâ”€â”€ 05-cluster-apps.yml <span class="comment"># éƒ¨ç½²ä¸€äº› addons ç»„ä»¶ï¼Œå¦‚ coredns ç­‰</span></span><br><span class="line">â”œâ”€â”€ 06-cluster-self-host.yml <span class="comment"># å¹³å° self-host è‡ªæ‰˜ç®¡çš„éƒ¨åˆ†</span></span><br><span class="line">â””â”€â”€ 11-reset-reset.yml <span class="comment"># ç§»é™¤é›†ç¾¤</span></span><br></pre></td></tr></table></figure><ul><li>00-default-ssh-config.yml</li></ul><p>è¯¥ playbook ç”¨äºé…ç½®å ¡å’æœºå’Œ ssh è®¤è¯ï¼Œkubespray éœ€è¦ä½¿ç”¨  public key çš„æ–¹å¼ ssh è¿æ¥åˆ°éƒ¨ç½²èŠ‚ç‚¹ï¼Œå¦‚æœéƒ¨ç½²èŠ‚ç‚¹æ²¡æœ‰é…ç½® ssh public key çš„æ–¹å¼ï¼Œå¯ä»¥æŒ‡å®š <code>ssh_cert_path</code> è¿™ä¸ªå˜é‡çš„è·¯å¾„ï¼Œå°†å…¬é’¥æ·»åŠ åˆ°ä¸»æœºçš„ authorized_key ä¸­ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">bastion[0]</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">bastion-ssh-config,</span> <span class="attr">tags:</span> <span class="string">["localhost",</span> <span class="string">"bastion"</span><span class="string">]</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster:etcd</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setting</span> <span class="string">up</span> <span class="string">ssh</span> <span class="string">public</span> <span class="string">key</span> <span class="string">authentication</span></span><br><span class="line">      <span class="attr">authorized_key:</span> <span class="string">"user=<span class="template-variable">&#123;&#123; ansible_user &#125;&#125;</span> key=<span class="template-variable">&#123;&#123; lookup('file', '&#123;&#123; ssh_cert_path &#125;&#125;</span>') &#125;&#125;"</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ssh_cert_path</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">ssh-config</span></span><br></pre></td></tr></table></figure><ul><li>01-cluster-bootstrap-os.yml</li></ul><p>è¿™ä¸ª playbook ç”¨äºåˆå§‹åŒ–éƒ¨ç½²èŠ‚ç‚¹ OSã€å®‰è£…ä¸€äº›ä¾èµ–çš„ rpm/deb åŒ…ã€å®‰è£…å®¹å™¨è¿è¡Œæ—¶ã€ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ç­‰</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster:etcd</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">linear</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">bootstrap-os,</span> <span class="attr">tags:</span> <span class="string">bootstrap-os&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster:etcd</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/preinstall,</span> <span class="attr">tags:</span> <span class="string">preinstall</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">"container-engine"</span><span class="string">,</span> <span class="attr">tags:</span> <span class="string">"container-engine"</span><span class="string">,</span> <span class="attr">when:</span> <span class="string">deploy_container_engine|default(true)</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">download,</span> <span class="attr">tags:</span> <span class="string">download,</span> <span class="attr">when:</span> <span class="string">"not skip_downloads"</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>02-cluster-etcd.yml</li></ul><p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½² etcd é›†ç¾¤å’Œåˆ†å‘ etcd é›†ç¾¤çš„è¯ä¹¦åˆ°é›†ç¾¤èŠ‚ç‚¹ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">etcd</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">etcd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">etcd</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">etcd_cluster_setup:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">etcd_events_cluster_setup:</span> <span class="string">"<span class="template-variable">&#123;&#123; etcd_events_cluster_enabled &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">not</span> <span class="string">etcd_kubeadm_enabled|</span> <span class="string">default(false)</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">etcd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">etcd</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">etcd_cluster_setup:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">etcd_events_cluster_setup:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">not</span> <span class="string">etcd_kubeadm_enabled|</span> <span class="string">default(false)</span></span><br></pre></td></tr></table></figure><ul><li>03-cluster-kubernetes.yml</li></ul><p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½² kubernetes é›†ç¾¤ï¼Œè™½ç„¶è¿™é‡Œçš„ roles å¾ˆå¤šï¼Œä½†å¹¶æ²¡æœ‰åšè¿‡å¤šçš„æ‹†åˆ†ï¼Œä¸ªäººè¿˜æ˜¯è§‰ç€è¿™éƒ¨åˆ†å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/node,</span> <span class="attr">tags:</span> <span class="string">node</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/control-plane,</span> <span class="attr">tags:</span> <span class="string">master</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/client,</span> <span class="attr">tags:</span> <span class="string">client</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/cluster_roles,</span> <span class="attr">tags:</span> <span class="string">cluster-roles</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/kubeadm,</span> <span class="attr">tags:</span> <span class="string">kubeadm&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/node-label,</span> <span class="attr">tags:</span> <span class="string">node-label</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>04-cluster-network.yml</li></ul><p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½²ç½‘ç»œæ’ä»¶</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">network_plugin,</span> <span class="attr">tags:</span> <span class="string">network</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/network_plugin,</span> <span class="attr">tags:</span> <span class="string">network</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/policy_controller,</span> <span class="attr">tags:</span> <span class="string">policy-controller</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>05-cluster-apps.yml</li></ul><p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½²ä¸€äº› addons æ’ä»¶ï¼Œå¿…é¡» coredns, ingress-controllerï¼Œä»¥åŠä¸€äº›å¤–ç½®çš„ provisioner ç­‰ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/external_cloud_controller,</span> <span class="attr">tags:</span> <span class="string">external-cloud-controller</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/ingress_controller,</span> <span class="attr">tags:</span> <span class="string">ingress-controller</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/external_provisioner,</span> <span class="attr">tags:</span> <span class="string">external-provisioner</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps,</span> <span class="attr">tags:</span> <span class="string">apps</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>æ‹†åˆ†çš„æ—¶å€™å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µå»é™¤ä¸€äº›ä¸å¿…è¦çš„ rolesï¼Œæ¯”å¦‚ <code>calico_rr</code> , <code>win_nodes</code> ï¼Œæˆ‘ä»¬çš„äº§å“æœ¬èº«å°±ä¸æ”¯æŒ calico è·¯ç”±åå°„å™¨ã€ä¹Ÿä¸æ”¯æŒ windows èŠ‚ç‚¹ï¼Œå› æ­¤ç›´æ¥å°†è¿™ä¸¤éƒ¨åˆ†ç»™å»é™¤äº†ï¼Œè¿™æ ·ä¹Ÿèƒ½é¿å…å»æ‰§è¡Œè¿™äº› task çš„åˆ¤æ–­ï¼Œèƒ½èŠ‚çœä¸€å®šçš„æ—¶é—´ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">calico_rr</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">network_plugin/calico/rr,</span> <span class="attr">tags:</span> <span class="string">['network',</span> <span class="string">'calico_rr'</span><span class="string">]</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane[0]</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">win_nodes/kubernetes_patch,</span> <span class="attr">tags:</span> <span class="string">["master",</span> <span class="string">"win_nodes"</span><span class="string">]</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;kubespray v2.16
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubernetes" scheme="https://blog.k8s.li/tags/kubernetes/"/>
    
      <category term="kubespray" scheme="https://blog.k8s.li/tags/kubespray/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ Kubespray æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤</title>
    <link href="https://blog.k8s.li/deploy-k8s-by-kubespray.html"/>
    <id>https://blog.k8s.li/deploy-k8s-by-kubespray.html</id>
    <published>2021-04-28T16:00:00.000Z</published>
    <updated>2021-04-28T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>å…¬å¸ PaaS å¹³å°åº•å±‚çš„ kubernetes é›†ç¾¤éƒ¨ç½²é‡‡ç”¨çš„å¼€æºçš„ kubesprayï¼Œæ­£å¥½æˆ‘åœ¨å‚ä¸ kubespray äºŒå¼€å·¥ä½œã€‚åœ¨è¿™æ®µæ—¶ä¸»è¦å®Œæˆäº† kubespray è‡ªåŠ¨åŒ–æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ã€ç§æœ‰åŒ–éƒ¨ç½²ã€å¢åŠ è‡ªç ” CNI éƒ¨ç½²ã€ä»¥åŠä¸€äº› bugfix ç­‰ã€‚æœ€è¿‘æŠ½ç©ºæ•´ç†å¹¶æ€»ç»“ä¸€ä¸‹ä½¿ç”¨ kubespray åœ¨æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤è¸©çš„ä¸€äº›å‘ã€‚</p><h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><p>åŠé€€ä¸‰è¿ğŸ˜‚ï¼š</p><ul><li>éœ€è¦ä¸€ä¸ªéƒ¨ç½²é•œåƒä»“åº“å’Œ nginx</li><li>éœ€è¦ä¸€ä¸ªåŸŸåï¼Œæœ€å¥½å·²ç»è®¾ç½®å¥½ DNS è§£æå’Œ SSL è¯ä¹¦</li><li>é›†ç¾¤èŠ‚ç‚¹éœ€è¦è‡³å°‘ä¸¤å°æœºå™¨ï¼Œå¹¶ä¸”å¯ä»¥è®¿é—®å¤–ç½‘</li></ul><p>è™½ç„¶æ‰‹å¤´é‡Œæœ‰ä¸€å¤§æ‰¹å¼€å‘æœºå™¨ï¼Œä½†ç”±äºæˆ‘çš„åŸŸå <code>k8s.li</code> æ¯”è¾ƒç‰¹æ®Šï¼Œå›½å†…å¾ˆéš¾è¿›è¡Œå¤‡æ¡ˆï¼ˆä¹Ÿä¸æƒ³å¤‡æ¡ˆï¼‰ï¼Œæ‰€ä»¥æ— æ³•å°† DNS è§£æåˆ°è¿™äº›å›½å†…çš„æœåŠ¡å™¨ä¸Šã€‚å› æ­¤æˆ‘æ‰“ç®—å°†åŸŸåè§£æåˆ°ä¸€å°å›½å¤–çš„æœåŠ¡å™¨ä¸Šï¼Œç„¶åå†ä½¿ç”¨ nginx rewrite é‡å†™å°†è¯·æ±‚è½¬å‘åˆ°é˜¿é‡Œäº‘çš„ OSS ï¼›å¦å¤– docker registry çš„åç«¯å­˜å‚¨ä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨é˜¿é‡Œäº‘ OSSï¼Œè¿™æ ·å®¢æˆ·ç«¯åœ¨æ‹‰å–é•œåƒçš„æ—¶å€™ï¼Œåªä¼šé€šè¿‡æˆ‘çš„åŸŸåè·å–é•œåƒçš„ manifest æ–‡ä»¶ï¼Œé•œåƒçš„ blobs æ•°æ®å°†ä¼šè½¬å‘åˆ°é˜¿é‡Œäº‘ OSSã€‚åœ¨é›†ç¾¤éƒ¨ç½²çš„æ—¶å€™ï¼Œä¸‹è½½æ–‡ä»¶å’Œé•œåƒæœ€ä¸»è¦çš„æµé‡éƒ½ä¼šé€šè¿‡é˜¿é‡Œäº‘ OSSï¼Œè¿™æ ·å¯ä»¥èŠ‚çœé›†ç¾¤éƒ¨ç½²è€—æ—¶ï¼Œæé«˜éƒ¨ç½²æ•ˆç‡ï¼ŒåŒæ—¶åˆèƒ½å‰©ä¸‹ä¸€ç¬”æœåŠ¡å™¨çš„æµé‡è´¹ç”¨ã€‚</p><h3 id="åŸŸå-SSL-è¯ä¹¦åˆ¶ä½œ"><a href="#åŸŸå-SSL-è¯ä¹¦åˆ¶ä½œ" class="headerlink" title="åŸŸå SSL è¯ä¹¦åˆ¶ä½œ"></a>åŸŸå SSL è¯ä¹¦åˆ¶ä½œ</h3><p>åŸŸå SSL è¯ä¹¦ä¸»è¦æ˜¯ç»™é•œåƒä»“åº“ä½¿ç”¨çš„ï¼Œå‡å¦‚è¯ä¹¦æ˜¯è‡ªç­¾çš„æˆ–è€…é•œåƒä»“åº“ä½¿ç”¨çš„æ˜¯ HTTP åè®®ï¼Œè¿™æ ·ä¼šå¯¼è‡´ docker æˆ–è€… containerd æ— æ³•æ‹‰å–é•œåƒï¼Œéœ€è¦ä¸ºé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹é…ç½® <code>insecure-registries</code>  è¿™ä¸ªå‚æ•°ã€‚æèµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œå› æ­¤è¿˜æ˜¯æ¨èç»™é•œåƒä»“åº“åŠ ä¸€ä¸ªéè‡ªç­¾çš„ SSL è¯ä¹¦ï¼Œè¿™æ ·èƒ½å‡å°‘ä¸€äº›ä¸å¿…è¦çš„éº»çƒ¦ã€‚å¦‚æœæœ‰ç°æˆçš„é•œåƒä»“åº“å¹¶ä¸”é…ç½®å¥½äº† SSL è¯ä¹¦ï¼Œå¯ä»¥ç•¥è¿‡æ­¤æ­¥ã€‚</p><p>åˆ¶ä½œåŸŸåè¯ä¹¦çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä¸ªäººæ¯”è¾ƒæ¨èä½¿ç”¨ acme.sh ã€‚å®ƒå®ç°äº† acme åè®®æ”¯æŒçš„æ‰€æœ‰éªŒè¯åè®®ï¼Œå¹¶ä¸”æ”¯æŒæ”¯æŒæ•°åç§åŸŸåè§£æå•†ã€‚ç”±äºæˆ‘çš„åŸŸåæ˜¯æ‰˜ç®¡åœ¨ cloudflare ä¸Šçš„ï¼Œä½¿ç”¨ acme.sh æ¥ç­¾å‘è¯ä¹¦ç‰¹åˆ«æ–¹ä¾¿ï¼Œåªéœ€è¦é…ç½®ä¸¤ä¸ªå‚æ•°å³å¯ã€‚ä¸‹é¢å°±ç»™ k8s.li è¿™ä¸ªåŸŸåç­¾å‘ä¸€ä¸ªæ³›åŸŸåè¯ä¹¦ã€‚</p><ul><li>å®‰è£…  acme.sh</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://get.acme.sh | sh</span><br><span class="line">~/.acme.sh/acme.sh --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><ul><li>ç­¾å‘è¯ä¹¦</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CF_Email=<span class="string">"muzi502.li@gmail.com"</span> <span class="comment"># cloudflare è´¦æˆ·çš„é‚®ç®±</span></span><br><span class="line"><span class="built_in">export</span> CF_Key=<span class="string">"xxxxxx"</span> <span class="comment"># "cloudflareä¸­æŸ¥çœ‹ä½ çš„key"</span></span><br><span class="line"></span><br><span class="line">~/.acme.sh/acme.sh --issue --dns dns_cf -d k8s.li -d *.k8s.li</span><br><span class="line"></span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] Cert success.</span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] Your cert is <span class="keyword">in</span>  /root/.acme.sh/k8s.li/k8s.li.cer</span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] Your cert key is <span class="keyword">in</span>  /root/.acme.sh/k8s.li/k8s.li.key</span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] The intermediate CA cert is <span class="keyword">in</span>  /root/.acme.sh/k8s.li/ca.cer</span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] And the full chain certs is there:  /root/.acme.sh/k8s.li/fullchain.cer</span><br></pre></td></tr></table></figure><blockquote><p>å‰é¢è¯ä¹¦ç”Ÿæˆä»¥åï¼Œæ¥ä¸‹æ¥éœ€è¦æŠŠè¯ä¹¦ copy åˆ°çœŸæ­£éœ€è¦ç”¨å®ƒçš„åœ°æ–¹ã€‚</p><p>æ³¨æ„ï¼Œé»˜è®¤ç”Ÿæˆçš„è¯ä¹¦éƒ½æ”¾åœ¨å®‰è£…ç›®å½•ä¸‹<code>~/.acme.sh/</code>ï¼Œ è¯·ä¸è¦ç›´æ¥ä½¿ç”¨æ­¤ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œä¾‹å¦‚: ä¸è¦ç›´æ¥è®©<code>nginx/apache</code>çš„é…ç½®æ–‡ä»¶ä½¿ç”¨è¿™ä¸‹é¢çš„æ–‡ä»¶ã€‚è¿™é‡Œé¢çš„æ–‡ä»¶éƒ½æ˜¯å†…éƒ¨ä½¿ç”¨ï¼Œè€Œä¸”ç›®å½•ç»“æ„å¯èƒ½ä¼šå˜åŒ–ã€‚</p><p>æ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•æ˜¯ä½¿ç”¨<code>--installcert</code> å‘½ä»¤ï¼Œå¹¶æŒ‡å®šç›®æ ‡ä½ç½®ï¼Œç„¶åè¯ä¹¦æ–‡ä»¶ä¼šè¢« copy åˆ°ç›¸åº”çš„ä½ç½®</p></blockquote><ul><li>å®‰è£…è¯ä¹¦</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --install-cert -d k8s.li \</span><br><span class="line">--cert-file      /etc/nginx/ssl/k8s.li.cer  \</span><br><span class="line">--key-file       /etc/nginx/ssl/k8s.li.key  \</span><br><span class="line">--fullchain-file /etc/nginx/ssl/fullchain.cer</span><br></pre></td></tr></table></figure><h3 id="æ­å»ºé•œåƒä»“åº“"><a href="#æ­å»ºé•œåƒä»“åº“" class="headerlink" title="æ­å»ºé•œåƒä»“åº“"></a>æ­å»ºé•œåƒä»“åº“</h3><ul><li>config.yml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">0.1</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">registry</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">blobdescriptor:</span> <span class="string">inmemory</span></span><br><span class="line">  <span class="attr">oss:</span></span><br><span class="line">    <span class="attr">accesskeyid:</span> <span class="string">xxxx</span> <span class="comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeyid</span></span><br><span class="line">    <span class="attr">accesskeysecret:</span> <span class="string">xxxx</span> <span class="comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeysecret</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">oss-cn-beijing</span> <span class="comment"># é…ç½® OSS bucket çš„åŒºåŸŸï¼Œæ¯”å¦‚ oss-cn-beijing</span></span><br><span class="line">    <span class="attr">internal:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">bucket:</span> <span class="string">fileserver</span> <span class="comment"># é…ç½®å­˜å‚¨ bucket çš„åç§°</span></span><br><span class="line">    <span class="attr">rootdirectory:</span> <span class="string">/kubespray/registry</span> <span class="comment"># é…ç½®è·¯å¾„</span></span><br><span class="line">  <span class="attr">delete:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">addr:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:5000</span></span><br><span class="line">  <span class="attr">headers:</span></span><br><span class="line">    <span class="attr">X-Content-Type-Options:</span> <span class="string">[nosniff]</span></span><br><span class="line"><span class="attr">health:</span></span><br><span class="line">  <span class="attr">storagedriver:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><ul><li>docker-compose</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">hub-registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2.7.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">hub-registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.yml:/etc/docker/registry/config.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5000:5000</span></span><br></pre></td></tr></table></figure><ul><li>nginx.conf</li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  hub.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/fullchain.cer;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/k8s.li.key;</span><br><span class="line">    <span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">4096m</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   http://localhost:5000;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶æœåŠ¡å™¨"><a href="#æ–‡ä»¶æœåŠ¡å™¨" class="headerlink" title="æ–‡ä»¶æœåŠ¡å™¨"></a>æ–‡ä»¶æœåŠ¡å™¨</h3><p>æ–‡ä»¶æœåŠ¡å™¨ç”¨äºå­˜æ”¾ä¸€äº› kubeadmã€kubectlã€kubelet ç­‰äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œkubespray é»˜è®¤çš„ä¸‹è½½åœ°å€åœ¨å›½å†…è®¿é—®ç‰¹åˆ«æ…¢ï¼Œå› æ­¤éœ€è¦æ­å»ºä¸€ä¸ª http/https æœåŠ¡å™¨ï¼Œç”¨äºç»™é›†ç¾¤éƒ¨ç½²ä¸‹è½½è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨ã€‚</p><ul><li>nginx.conf</li></ul><p>éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œçš„ nginx é…ç½®ä½¿ç”¨çš„æ˜¯ rewrite è€Œä¸æ˜¯ proxy_passï¼Œè¿™æ ·å®¢æˆ·ç«¯åœ¨æƒ³æˆ‘çš„æœåŠ¡å™¨è¯·æ±‚æ–‡ä»¶æ—¶ï¼Œä¼šé‡å†™å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè®©å®¢æˆ·ç«¯å»è¯·æ±‚é˜¿é‡Œäº‘ OSS çš„åœ°å€ã€‚</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span>;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>   dl.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/fullchain.cer;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/k8s.li.key;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> https://fileserver.oss-cn-beijing.aliyuncs.com/kubespray/files/<span class="variable">$1</span>;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> Content-Disposition;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-request-id;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-object-type;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-hash-crc64ecma;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-storage-class;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-force-download;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-server-time;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘å®‰è£…-skopeo"><a href="#ç¼–è¯‘å®‰è£…-skopeo" class="headerlink" title="ç¼–è¯‘å®‰è£… skopeo"></a>ç¼–è¯‘å®‰è£… skopeo</h3><p>å®‰è£… skopeo ç”¨æ¥åŒæ­¥ä¸€äº›ä½¿ç”¨çš„é•œåƒåˆ°ç§æœ‰é•œåƒä»“åº“ï¼Œæ€§èƒ½ä¸Šæ¯” docker å¿«å¾ˆå¤šï¼Œå¼ºçƒˆæ¨èã€‚skopeo çš„å®‰è£…æ–¹å¼å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ <a href="https://github.com/containers/skopeo/blob/master/install.md" target="_blank" rel="noopener">Installing from packages</a> ã€‚ä¸è¿‡ä¸ªäººè¿˜æ˜¯ä½¿ç”¨ go buid ç¼–è¯‘ä¸€ä¸ªé™æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™æ ·åœ¨ Linux å‘è¡Œç‰ˆéƒ½å¯ä»¥ä½¿ç”¨ã€‚ä¸ç„¶åœ¨ Debian ä¸Šç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶æ— æ³•æ‹¿åˆ° CentOS ä¸Šä½¿ç”¨ï¼Œå› ä¸ºäºŒè€…ä½¿ç”¨çš„åŠ¨æ€é“¾æ¥åº“ä¸ä¸€æ ·ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/skopeo git:(master*) <span class="comment"># git clone https://github.com/containers/skopeo &amp;&amp; cd skopeo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ¬åœ°å¼€å‘æœºå™¨å·²ç»å®‰è£…å¹¶é…ç½®å¥½äº† golang ç¼–è¯‘ç¯å¢ƒ</span></span><br><span class="line">root@debian:/root/skopeo git:(master*) <span class="comment"># CGO_ENABLE=0 GO111MODULE=on go build -mod=vendor "-buildmode=pie" -ldflags '-extldflags "-static"' -gcflags "" -tags "exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp" -o bin/skopeo ./cmd/skopeo</span></span><br><span class="line"></span><br><span class="line">root@debian:/root/skopeo git:(master*) <span class="comment"># ldd bin/skopeo</span></span><br><span class="line">not a dynamic executable</span><br></pre></td></tr></table></figure><h3 id="è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶"></a>è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶</h3><p>kubespray éƒ¨ç½²çš„æ—¶å€™éœ€è¦åˆ° github.com æˆ– storage.googleapis.com ä¸‹è½½ä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™äº›åœ°å€åœ¨å›½å†…éƒ½éƒ½è¢«é˜»æ–­äº†ï¼Œå› æ­¤éœ€è¦å°†éƒ¨ç½²æ—¶ä¾èµ–çš„æ–‡ä»¶ä¸Šä¼ åˆ°è‡ªå·±çš„æ–‡ä»¶æœåŠ¡å™¨ä¸Šã€‚è‡ªå·±å†™äº†ä¸ªè„šæœ¬ç”¨äºè·å– kubespray éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåœ¨ kubespray repo çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œ,ä¸‹è½½çš„æ–‡ä»¶é»˜è®¤ä¼šå­˜æ”¾åœ¨ <code>temp/files</code> ç›®å½•ä¸‹ã€‚ä¸‹è½½å®Œæˆä¹‹åå°†è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•ä¸Šä¼ åˆ°è‡ªå·±çš„æ–‡ä»¶æœåŠ¡å™¨ä¸Šã€‚åé¢é…ç½®ä¸€äº›å‚æ•°åœ¨è¿™ä¸ªåœ°å€çš„å‚æ•°å‰é¢åŠ ä¸Šè‡ªå·±æ–‡ä»¶æœåŠ¡å™¨çš„ URL å³å¯ã€‚</p><ul><li>é¦–å…ˆ clone repo åˆ°æœ¬åœ°</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root<span class="comment"># git clone https://github.com/kubernetes-sigs/kubespray &amp;&amp; cd kubespray</span></span><br></pre></td></tr></table></figure><ul><li>å°†è¯¥è„šæœ¬ <code>generate_list.sh</code> ä¿å­˜åˆ° repo æ ¹ç›®å½•ä¸‹ï¼Œå¹¶æ‰§è¡Œè¯¥è„šä¸‹è½½éœ€è¦çš„æ–‡ä»¶ã€‚</li></ul><blockquote><p>ps: ç”¨ shell è„šæœ¬å»å¤„ç† Jinja2 çš„ yamlï¼Œ å†™ sed å†™å¾—æˆ‘æƒ³åğŸ¤®</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line"></span><br><span class="line">CURRENT_DIR=$(<span class="built_in">cd</span> $(dirname <span class="variable">$0</span>); <span class="built_in">pwd</span>)</span><br><span class="line">TEMP_DIR=<span class="string">"<span class="variable">$&#123;CURRENT_DIR&#125;</span>/temp"</span></span><br><span class="line">REPO_ROOT_DIR=<span class="string">"<span class="variable">$&#123;CURRENT_DIR&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">: <span class="variable">$&#123;IMAGE_ARCH:="amd64"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;ANSIBLE_SYSTEM:="linux"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;ANSIBLE_ARCHITECTURE:="x86_64"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;DOWNLOAD_YML:="roles/download/defaults/main.yml"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;KUBE_VERSION_YAML:="roles/kubespray-defaults/defaults/main.yaml"&#125;</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$&#123;TEMP_DIR&#125;</span></span><br><span class="line"><span class="function"><span class="title">generate_versions</span></span>() &#123;</span><br><span class="line">    <span class="comment"># ARCH used in convert &#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125; to &#123;&#123;arch&#125;&#125;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;IMAGE_ARCH&#125;</span>"</span> != <span class="string">"amd64"</span> ]; <span class="keyword">then</span> ARCH=<span class="string">"<span class="variable">$&#123;IMAGE_ARCH&#125;</span>"</span>; <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    cat &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh &lt;&lt; EOF</span><br><span class="line">arch=<span class="variable">$&#123;ARCH&#125;</span></span><br><span class="line">image_arch=<span class="variable">$&#123;IMAGE_ARCH&#125;</span></span><br><span class="line">ansible_system=<span class="variable">$&#123;ANSIBLE_SYSTEM&#125;</span></span><br><span class="line">ansible_architecture=<span class="variable">$&#123;ANSIBLE_ARCHITECTURE&#125;</span></span><br><span class="line">EOF</span><br><span class="line">    grep <span class="string">'kube_version:'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;KUBE_VERSION_YAML&#125;</span> \</span><br><span class="line">    | sed <span class="string">'s/: /=/g'</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh</span><br><span class="line">    grep <span class="string">'_version:'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">    | sed <span class="string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> | tr -d <span class="string">' '</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh</span><br><span class="line">    sed -i <span class="string">'s/kube_major_version=.*/kube_major_version=$&#123;kube_version%.*&#125;/g'</span> <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh</span><br><span class="line">    sed -i <span class="string">'s/crictl_version=.*/crictl_version=$&#123;kube_version%.*&#125;.0/g'</span> <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">generate_files_list</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"source <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh"</span> &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.sh</span><br><span class="line">    grep <span class="string">'download_url:'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">    | sed <span class="string">'s/: /=/g;s/ //g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g;s/|lower//g;s/^.*_url=/echo /g'</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.sh</span><br><span class="line">    bash <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.sh | sort &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.list</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">generate_images_list</span></span>() &#123;</span><br><span class="line">    KUBE_IMAGES=<span class="string">"kube-apiserver kube-controller-manager kube-scheduler kube-proxy"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"source <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh"</span> &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh</span><br><span class="line">    grep -E <span class="string">'_repo:|_tag:'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">    | sed <span class="string">"s#&#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125;#&#123;&#123;arch&#125;&#125;#g"</span> \</span><br><span class="line">    | sed <span class="string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> | tr -d <span class="string">' '</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh</span><br><span class="line">    sed -n <span class="string">'/^downloads:/,/download_defaults:/p'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">    | sed -n <span class="string">"s/repo: //p;s/tag: //p"</span> | tr -d <span class="string">' '</span> | sed <span class="string">'s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> \</span><br><span class="line">    | sed <span class="string">'N;s#\n# #g'</span> | tr <span class="string">' '</span> <span class="string">':'</span> | sed <span class="string">'s/^/echo /g'</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;KUBE_IMAGES&#125;</span>"</span> | tr <span class="string">' '</span> <span class="string">'\n'</span> | xargs -L1 -I &#123;&#125; \</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'echo $&#123;kube_image_repo&#125;/&#123;&#125;:$&#123;kube_version&#125;'</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh</span><br><span class="line">    bash <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh | sort &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.list</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">generate_versions</span><br><span class="line">generate_files_list</span><br><span class="line">generate_images_list</span><br><span class="line">wget -x -P <span class="variable">$&#123;TEMP_DIR&#125;</span>/files -i <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.list</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆä¸‹è½½çš„ç»“æœå¦‚ä¸‹ï¼ŒåŸºæœ¬ä¸Šä¿æŒäº†åŸæœ‰çš„ URL è·¯å¾„ï¼Œä¹Ÿæ–¹ä¾¿åç»­çš„æ›´æ–°å’Œç‰ˆæœ¬è¿­ä»£ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">temp/files</span><br><span class="line">â”œâ”€â”€ get.helm.sh</span><br><span class="line">â”‚Â Â  â””â”€â”€ helm-v3.5.4-linux-amd64.tar.gz</span><br><span class="line">â”œâ”€â”€ github.com</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containerd</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ nerdctl</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.8.0</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ nerdctl-0.8.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containernetworking</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ plugins</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.9.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containers</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ crun</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ 0.19</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ crun-0.19-linux-amd64</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ coreos</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ etcd</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v3.4.13</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kata-containers</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ runtime</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ 1.12.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ kata-static-1.12.1-x86_64.tar.xz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kubernetes-sigs</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ cri-tools</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v1.20.0</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ crictl-v1.20.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â””â”€â”€ projectcalico</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ calico</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ archive</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ v3.17.3.tar.gz</span><br><span class="line">â”‚Â Â      â””â”€â”€ calicoctl</span><br><span class="line">â”‚Â Â          â””â”€â”€ releases</span><br><span class="line">â”‚Â Â              â””â”€â”€ download</span><br><span class="line">â”‚Â Â                  â””â”€â”€ v3.17.3</span><br><span class="line">â”‚Â Â                      â””â”€â”€ calicoctl-linux-amd64</span><br><span class="line">â””â”€â”€ storage.googleapis.com</span><br><span class="line">    â””â”€â”€ kubernetes-release</span><br><span class="line">        â””â”€â”€ release</span><br><span class="line">            â””â”€â”€ v1.20.6</span><br><span class="line">                â””â”€â”€ bin</span><br><span class="line">                    â””â”€â”€ linux</span><br><span class="line">                        â””â”€â”€ amd64</span><br><span class="line">                            â”œâ”€â”€ kubeadm</span><br><span class="line">                            â”œâ”€â”€ kubectl</span><br><span class="line">                            â””â”€â”€ kubelet</span><br></pre></td></tr></table></figure><h3 id="è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ"><a href="#è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ" class="headerlink" title="è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ"></a>è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ</h3><p>å¯¹äºç¦»çº¿éƒ¨ç½²ï¼Œkubespray æ”¯æŒçš„å¹¶ä¸æ˜¯å¾ˆå‹å¥½ã€‚æ¯”å¦‚è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒåˆ—è¡¨ï¼Œç›®å‰çš„æ–¹æ¡ˆæ˜¯éœ€è¦å…ˆéƒ¨ç½²ä¸€ä¸ªé›†ç¾¤ï¼Œç„¶åé€šè¿‡ kubectl get ä¸€äº›èµ„æºæ¥è·å– pod ä½¿ç”¨åˆ°çš„é•œåƒã€‚ä¸ªäººè§‰å¾—è¿™ä¸ªæ–¹å¼å¯ä»¥ä¿®æ”¹ä¸€ä¸‹ï¼Œæ¯”å¦‚é€šè¿‡ kubespray æºç æ¥ç”Ÿæˆä¸€ä¸ªé•œåƒåˆ—è¡¨ã€‚ä¸‹é¢åªæ˜¯ç®€å•ç”Ÿæˆä¸€ä¸ªé•œåƒåˆ—è¡¨ï¼Œå†…å®¹å¦‚ä¸‹</p><ul><li>images.list</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker.io/nginx:1.19.0</span><br><span class="line">docker.io/calico/cni:v3.17.3</span><br><span class="line">docker.io/calico/node:v3.17.3</span><br><span class="line">docker.io/calico/kube-controllers:v3.17.3</span><br><span class="line">quay.io/coreos/flannel:v0.13.0</span><br><span class="line">quay.io/coreos/flannel:v0.13.0-amd64</span><br><span class="line">k8s.gcr.io/pause:3.2</span><br><span class="line">k8s.gcr.io/coredns:1.7.0</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.20.6</span><br><span class="line">k8s.gcr.io/dns/k8s-dns-node-cache:1.17.1</span><br><span class="line">k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64:1.8.3</span><br></pre></td></tr></table></figure><p>ç”±äº master åˆ†æ”¯çš„ä»£ç ä¸€ç›´åœ¨æ›´æ–°ï¼Œå½“å‰çš„ master åˆ†æ”¯çš„ç‰ˆæœ¬å¯èƒ½å’Œè¿™é‡Œçš„ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦ä¿®æ”¹ä¸ºè‡ªå·±éœ€è¦çš„ç‰ˆæœ¬ã€‚</p><ul><li>æ ¹æ®ä¸Šé¢çš„é•œåƒåˆ—è¡¨ï¼Œä½¿ç”¨ skopeo å°†é•œåƒåŒæ­¥åˆ°è‡ªå·±çš„é•œåƒä»“åº“ä¸­ï¼Œå¦‚æˆ‘çš„ <code>hub.k8s.li</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> $(cat images.list); <span class="keyword">do</span> skopeo copy docker://<span class="variable">$&#123;image&#125;</span> docker://hub.k8s.li/<span class="variable">$&#123;image#*/&#125;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>åŒæ­¥åˆ°æˆ‘çš„é•œåƒä»“åº“ä¸­ï¼Œå†…å®¹å°±å¦‚ä¸‹ï¼Œåœ¨éƒ¨ç½²çš„æ—¶å€™é€šè¿‡ä¿®æ”¹ä¸€äº›é•œåƒä»“åº“çš„åœ°å€å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hub.k8s.li/nginx:1.19.0</span><br><span class="line">hub.k8s.li/calico/cni:v3.17.3</span><br><span class="line">hub.k8s.li/calico/node:v3.17.3</span><br><span class="line">hub.k8s.li/calico/kube-controllers:v3.17.3</span><br><span class="line">hub.k8s.li/coreos/flannel:v0.13.0</span><br><span class="line">hub.k8s.li/coreos/flannel:v0.13.0-amd64</span><br><span class="line">hub.k8s.li/pause:3.2</span><br><span class="line">hub.k8s.li/coredns:1.7.0</span><br><span class="line">hub.k8s.li/kube-apiserver:v1.20.6</span><br><span class="line">hub.k8s.li/kube-controller-manager:v1.20.6</span><br><span class="line">hub.k8s.li/kube-proxy:v1.20.6</span><br><span class="line">hub.k8s.li/kube-scheduler:v1.20.6</span><br><span class="line">hub.k8s.li/dns/k8s-dns-node-cache:1.17.1</span><br><span class="line">hub.k8s.li/cpa/cluster-proportional-autoscaler-amd64:1.8.3</span><br></pre></td></tr></table></figure><p>è‡³æ­¤å‡†å¤‡å·¥ä½œå¤§è‡´éƒ½å·²ç»å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹é…ç½® kubespray çš„ä¸€äº›å‚æ•°å’Œ inventory æ–‡ä»¶</p><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>æŒ‰ç…§ kubespray æ–‡æ¡£è¯´æ˜ï¼Œå°† <code>inventory/sample</code> ç›®å½•å¤åˆ¶ä¸€ä»½ï¼Œç„¶åé€šè¿‡ä¿®æ”¹é‡Œé¢çš„å‚æ•°æ¥æ§åˆ¶éƒ¨ç½²ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># cp -rf inventory/sample deploy</span></span><br></pre></td></tr></table></figure><h3 id="inventory"><a href="#inventory" class="headerlink" title="inventory"></a>inventory</h3><ul><li><code>deploy/inventory</code></li></ul><p>åˆ›å»ºä¸»æœº inventory æ–‡ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[all:vars]</span></span><br><span class="line"><span class="attr">ansible_port</span>=<span class="number">22</span></span><br><span class="line"><span class="attr">ansible_user</span>=root</span><br><span class="line"></span><br><span class="line"><span class="attr">ansible_ssh_private_key_file</span>=/kubespray/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line"><span class="section">[all]</span></span><br><span class="line">kube-control-1 ansible_host=192.168.4.11</span><br><span class="line">kube-control-2 ansible_host=192.168.4.12</span><br><span class="line">kube-control-3 ansible_host=192.168.4.13</span><br><span class="line">kube-node-1 ansible_host=192.168.4.4</span><br><span class="line"></span><br><span class="line"><span class="section">[kube_control_plane]</span></span><br><span class="line">kube-control-1</span><br><span class="line">kube-control-2</span><br><span class="line">kube-control-3</span><br><span class="line"></span><br><span class="line"><span class="section">[etcd]</span></span><br><span class="line">kube-control-1</span><br><span class="line">kube-control-2</span><br><span class="line">kube-control-3</span><br><span class="line"></span><br><span class="line"><span class="section">[kube-node]</span></span><br><span class="line">kube-control-1</span><br><span class="line">kube-control-2</span><br><span class="line">kube-control-3</span><br><span class="line">kube-node-1</span><br><span class="line"></span><br><span class="line"><span class="section">[calico-rr]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[k8s-cluster:children]</span></span><br><span class="line">kube_control_plane</span><br><span class="line">kube-node</span><br><span class="line">calico-rr</span><br></pre></td></tr></table></figure><ul><li>ssh äº’ä¿¡</li></ul><p>Kubespray ç”¨åˆ°äº† ansible çš„ <a href="https://docs.ansible.com/ansible/latest/collections/ansible/posix/synchronize_module.html" target="_blank" rel="noopener">synchronize</a> æ¨¡å—æ¥åˆ†å‘æ–‡ä»¶ï¼ŒåŸºäº rsync åè®®æ‰€ä»¥å¿…é¡»è¦ä½¿ç”¨ ssh å¯†é’¥å¯¹æ¥è¿æ¥é›†ç¾¤èŠ‚ç‚¹ã€‚inventory é…ç½®çš„æ˜¯ kubespray å®¹å™¨å†…çš„è·¯å¾„ï¼Œå› æ­¤éœ€è¦å°† ssh å…¬é’¥å’Œç§é’¥å¤åˆ¶åˆ° repo çš„ .ssh ç›®å½•ä¸‹ã€‚å¦‚æœèŠ‚ç‚¹å°±æ²¡æœ‰è¿›è¡Œ ssh å…å¯†ç™»å½•ï¼Œå¯ä»¥ç”¨ ansible çš„ authorized_key æ¨¡å—å°† ssh å…¬é’¥æ·»åŠ åˆ°ä¸»æœºçš„ authorized_key ä¸­ã€‚æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># mkdir -p .ssh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆ ssh å¯†é’¥å¯¹</span></span><br><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># ssh-keygen -t rsa -f .ssh/id_rsa -P ""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°† ssh å…¬é’¥æ·»åŠ åˆ°æ‰€æœ‰ä¸»æœº</span></span><br><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># ansible -i deploy/inventory all -m authorized_key -a "user=&#123;&#123; ansible_user &#125;&#125; key='&#123;&#123; lookup('file', '&#123;&#123; ssh_cert_path &#125;&#125;') &#125;&#125;'" -e ssh_cert_path=./.ssh/id_rsa.pub -e ansible_ssh_pass=passwd</span></span><br></pre></td></tr></table></figure><h3 id="vars"><a href="#vars" class="headerlink" title="vars"></a>vars</h3><p>åˆ›å»ºå¹¶ä¿®æ”¹ä»¥ä¸‹é…ç½®æ–‡ä»¶</p><ul><li><code>deploy/env.yml</code></li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€äº›ç»„ä»¶çš„ç‰ˆæœ¬</span></span><br><span class="line"><span class="attr">kube_version:</span> <span class="string">v1.20.6</span></span><br><span class="line"><span class="attr">calico_version:</span> <span class="string">"v3.17.3"</span></span><br><span class="line"><span class="attr">pod_infra_version:</span> <span class="string">"3.2"</span></span><br><span class="line"><span class="attr">nginx_image_version:</span> <span class="string">"1.19"</span></span><br><span class="line"><span class="attr">coredns_version:</span> <span class="string">"1.7.0"</span></span><br><span class="line"><span class="attr">image_arch:</span> <span class="string">"amd64"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker registry domain</span></span><br><span class="line"><span class="attr">registry_domain:</span> <span class="string">"hub.k8s.li"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># file download server url</span></span><br><span class="line"><span class="attr">download_url:</span> <span class="string">"https://dl.k8s.li"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-ce-repo mirrors</span></span><br><span class="line"><span class="attr">docker_mirrors_url:</span> <span class="string">"https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">container_manager:</span> <span class="string">"containerd"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”±äºä½¿ç”¨çš„æ˜¯ containerd ä½œä¸º CRIï¼Œç›®å‰ etcd ä¸æ”¯æŒ containerd å®¹å™¨åŒ–éƒ¨ç½²å› æ­¤éœ€è¦å°†è¯¥å‚æ•°ä¿®æ”¹ä¸º host ï¼Œä½¿ç”¨ systemd æ¥éƒ¨ç½²</span></span><br><span class="line"><span class="attr">etcd_deployment_type:</span> <span class="string">host</span></span><br><span class="line"><span class="attr">etcd_cluster_setup:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">etcd_events_cluster_setup:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">etcd_events_cluster_enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes CNI type é…ç½®é›†ç¾¤ CNI ä½¿ç”¨çš„ç±»å‹</span></span><br><span class="line"><span class="attr">kube_network_plugin:</span> <span class="string">canal</span></span><br></pre></td></tr></table></figure><ul><li><code>deploy/group_vars/all/download.yml</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Container registry define</span></span><br><span class="line"><span class="attr">gcr_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_domain &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kube_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_domain &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">docker_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_domain &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">quay_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_domain &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Download URLs</span></span><br><span class="line"><span class="attr">kubelet_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubelet"</span></span><br><span class="line"><span class="attr">kubectl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubectl"</span></span><br><span class="line"><span class="attr">kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kubeadm_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubeadm"</span></span><br><span class="line"><span class="attr">etcd_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/coreos/etcd/releases/download/<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>/etcd-<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">cni_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containernetworking/plugins/releases/download/<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>/cni-plugins-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>-<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>.tgz"</span></span><br><span class="line"><span class="attr">calicoctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calicoctl/releases/download/<span class="template-variable">&#123;&#123; calico_ctl_version &#125;&#125;</span>/calicoctl-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_crds_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calico/archive/<span class="template-variable">&#123;&#123; calico_version &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crictl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kubernetes-sigs/cri-tools/releases/download/<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>/crictl-<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">helm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/get.helm.sh/helm-<span class="template-variable">&#123;&#123; helm_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crun_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containers/crun/releases/download/<span class="template-variable">&#123;&#123; crun_version &#125;&#125;</span>/crun-<span class="template-variable">&#123;&#123; crun_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kata_containers_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kata-containers/runtime/releases/download/<span class="template-variable">&#123;&#123; kata_containers_version &#125;&#125;</span>/kata-static-<span class="template-variable">&#123;&#123; kata_containers_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_architecture &#125;&#125;</span>.tar.xz"</span></span><br><span class="line"><span class="attr">nerdctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containerd/nerdctl/releases/download/v<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>/nerdctl-<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br></pre></td></tr></table></figure><h3 id="docker-ce-mirrors"><a href="#docker-ce-mirrors" class="headerlink" title="docker-ce mirrors"></a>docker-ce mirrors</h3><p>kubespray å®‰è£… docker æˆ–è€… containerd å®¹å™¨è¿è¡Œæ—¶ï¼Œéœ€è¦ä½¿ç”¨ docker-ce çš„æºï¼Œå›½å†…å¯ä»¥ä½¿ç”¨æ¸…åçš„é•œåƒæºã€‚æ ¹æ®ä¸åŒçš„ Linux å‘è¡Œç‰ˆï¼Œåœ¨ <code>deploy/group_vars/all/offline.yml</code> æ–‡ä»¶ä¸­æ·»åŠ è¿™äº›å‚æ•°å³å¯ã€‚å…¶ä¸­ <code>docker_mirrors_url</code> è¿™ä¸ªå‚æ•°å°±æ˜¯åœ¨ <code>env.yml</code> é‡Œè®¾ç½®çš„å‚æ•°ã€‚</p><ul><li>CentOS/Redhat</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## CentOS/Redhat</span></span><br><span class="line"><span class="comment">### For EL7, base and extras repo must be available, for EL8, baseos and appstream</span></span><br><span class="line"><span class="comment">### By default we enable those repo automatically</span></span><br><span class="line"><span class="comment"># rhel_enable_repos: false</span></span><br><span class="line"><span class="comment">### Docker / Containerd</span></span><br><span class="line">docker_rh_repo_base_url: <span class="string">"&#123;&#123; docker_mirrors_url &#125;&#125;/centos/&#123;&#123; ansible_distribution_major_version &#125;&#125;/&#123;&#123; ansible_architecture &#125;&#125;/stable"</span></span><br><span class="line">docker_rh_repo_gpgkey: <span class="string">"&#123;&#123; docker_mirrors_url &#125;&#125;/centos/gpg"</span></span><br></pre></td></tr></table></figure><ul><li>Fedora</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Fedora</span></span><br><span class="line"><span class="comment">### Docker</span></span><br><span class="line"><span class="attr">docker_fedora_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/fedora/<span class="template-variable">&#123;&#123; ansible_distribution_major_version &#125;&#125;</span>/<span class="template-variable">&#123;&#123; ansible_architecture &#125;&#125;</span>/stable"</span></span><br><span class="line"><span class="attr">docker_fedora_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/fedora/gpg"</span></span><br><span class="line"><span class="comment">### Containerd</span></span><br><span class="line"><span class="attr">containerd_fedora_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/fedora/<span class="template-variable">&#123;&#123; ansible_distribution_major_version &#125;&#125;</span>/<span class="template-variable">&#123;&#123; ansible_architecture &#125;&#125;</span>/stable"</span></span><br><span class="line"><span class="attr">containerd_fedora_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/fedora/gpg"</span></span><br></pre></td></tr></table></figure><ul><li>debian</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Debian</span></span><br><span class="line"><span class="comment">### Docker</span></span><br><span class="line"><span class="attr">docker_debian_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/debian"</span></span><br><span class="line"><span class="attr">docker_debian_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/debian/gpg"</span></span><br><span class="line"><span class="comment">### Containerd</span></span><br><span class="line"><span class="attr">containerd_debian_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/debian"</span></span><br><span class="line"><span class="attr">containerd_debian_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/debian/gpg"</span></span><br><span class="line"><span class="comment"># containerd_debian_repo_repokey: 'YOURREPOKEY'</span></span><br></pre></td></tr></table></figure><ul><li>ubuntu</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Ubuntu</span></span><br><span class="line"><span class="comment">### Docker</span></span><br><span class="line"><span class="attr">docker_ubuntu_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/ubuntu"</span></span><br><span class="line"><span class="attr">docker_ubuntu_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/ubuntu/gpg"</span></span><br><span class="line"><span class="comment">### Containerd</span></span><br><span class="line"><span class="attr">containerd_ubuntu_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/ubuntu"</span></span><br><span class="line"><span class="attr">containerd_ubuntu_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/ubuntu/gpg"</span></span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>ç»è¿‡ä»¥ä¸Šå‡†å¤‡å¥½é…ç½®å·¥ä½œä¹‹åï¼Œæ¥ä¸‹æ¥å¯ä»¥å¼€å§‹æ­£å¼éƒ¨ç½²äº†ã€‚åœ¨ä½¿ç”¨ ansible è¿›è¡Œéƒ¨ç½²çš„æ—¶å€™ï¼Œä¸ªäººå€¾å‘äºåœ¨ kubespray å®¹å™¨é‡Œè¿›è¡Œæ“ä½œï¼Œè€Œéåœ¨æœ¬åœ°å¼€å‘æœºå™¨ä¸Šå®‰è£… python3 ç­‰ç¯å¢ƒã€‚å¯¹äºç¦»çº¿éƒ¨ç½²è€Œè¨€ï¼Œæå‰æ„å»ºå¥½é•œåƒï¼Œä½¿ç”¨ docker å®¹å™¨æ›´ä¸ºæ–¹ä¾¿ä¸€äº›ã€‚</p><ul><li>æ„å»ºé•œåƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># docker build -t kubespray:v2.15.1-kube-v1.20.6 .</span></span><br></pre></td></tr></table></figure><ul><li>è¿è¡Œ kubespray å®¹å™¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># docker run --rm -it --net=host -v $PWD:/kubespray kubespray:v2.15.1-kube-v1.20.6 bash</span></span><br></pre></td></tr></table></figure><ul><li>æµ‹è¯•ä¸»æœºæ˜¯å¦è¿æ¥æ­£å¸¸</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/kubespray<span class="comment"># ansible -i cluster/inventory all -m ping</span></span><br><span class="line">kube-control-3 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">kube-control-1 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">kube-node-1 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">kube-control-2 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¼€å§‹éƒ¨ç½²é›†ç¾¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/kubespray<span class="comment"># ansible-playbook -i deploy/inventory -e "@deploy/env.yml" cluster.yml</span></span><br></pre></td></tr></table></figure><ul><li>éƒ¨ç½²å®Œæˆæ—¥å¿—å¦‚ä¸‹ï¼Œå½“ failed éƒ½ä¸º 0 æ—¶è¯´æ˜ tasks éƒ½å·²ç»æˆåŠŸè·‘å®Œäº†</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PLAY RECAP ******************************************************************</span><br><span class="line">kube-control-1             : ok=526  changed=67   unreachable=0    failed=0    skipped=978  rescued=0    ignored=0</span><br><span class="line">kube-control-2             : ok=524  changed=66   unreachable=0    failed=0    skipped=980  rescued=0    ignored=0</span><br><span class="line">kube-control-3             : ok=593  changed=76   unreachable=0    failed=0    skipped=1125 rescued=0    ignored=1</span><br><span class="line">kube-node-1                : ok=366  changed=34   unreachable=0    failed=0    skipped=628  rescued=0    ignored=0</span><br><span class="line">localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br><span class="line">Wednesday 28 April 2021  10:57:57 +0000 (0:00:00.115)       0:15:21.190 *******</span><br><span class="line">===============================================================================</span><br><span class="line">kubernetes/control-plane : kubeadm | Initialize first master -------------- 65.88s</span><br><span class="line">kubernetes/control-plane : Joining control plane node to the cluster. ----- 50.05s</span><br><span class="line">kubernetes/kubeadm : Join to cluster -------------------------------------- 31.54s</span><br><span class="line">download_container | Download image <span class="keyword">if</span> required --------------------------- 24.38s</span><br><span class="line">reload etcd --------------------------------------------------------------- 20.56s</span><br><span class="line">Gen_certs | Write etcd member and admin certs to other etcd nodes --------- 19.32s</span><br><span class="line">Gen_certs | Write node certs to other etcd nodes -------------------------- 19.14s</span><br><span class="line">Gen_certs | Write etcd member and admin certs to other etcd nodes --------- 17.45s</span><br><span class="line">network_plugin/canal : Canal | Create canal node manifests ---------------- 15.41s</span><br><span class="line">kubernetes-apps/ansible : Kubernetes Apps | Lay Down CoreDNS Template ----- 13.27s</span><br><span class="line">kubernetes/control-plane : Master | <span class="built_in">wait</span> <span class="keyword">for</span> kube-scheduler --------------- 11.97s</span><br><span class="line">download_container | Download image <span class="keyword">if</span> required --------------------------- 11.76s</span><br><span class="line">Gen_certs | Write node certs to other etcd nodes -------------------------- 10.50s</span><br><span class="line">kubernetes-apps/ansible : Kubernetes Apps | Start Resources ---------------- 8.28s</span><br><span class="line">policy_controller/calico : Create calico-kube-controllers manifests -------- 7.61s</span><br><span class="line">kubernetes/control-plane : <span class="built_in">set</span> kubeadm certificate key --------------------- 6.32s</span><br><span class="line">download : extract_file | Unpacking archive -------------------------------- 5.51s</span><br><span class="line">Configure | Check <span class="keyword">if</span> etcd cluster is healthy ------------------------------- 5.41s</span><br><span class="line">Configure | Check <span class="keyword">if</span> etcd-events cluster is healthy ------------------------ 5.41s</span><br><span class="line">kubernetes-apps/network_plugin/canal : Canal | Start Resources ------------- 4.85s</span><br></pre></td></tr></table></figure><ul><li>é›†ç¾¤çŠ¶æ€</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-control-1 ~]# kubectl get node -o wide</span><br><span class="line">NAME             STATUS   ROLES                  AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME</span><br><span class="line">kube-control-1   Ready    control-plane,master   5m24s   v1.20.6   192.168.4.11   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4</span><br><span class="line">kube-control-2   Ready    control-plane,master   5m40s   v1.20.6   192.168.4.12   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4</span><br><span class="line">kube-control-3   Ready    control-plane,master   6m28s   v1.20.6   192.168.4.13   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4</span><br><span class="line">kube-node-1      Ready    &lt;none&gt;                 3m53s   v1.20.6   192.168.4.14   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4</span><br></pre></td></tr></table></figure><ul><li>é›†ç¾¤ç»„ä»¶çŠ¶æ€</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-control-1 ~]<span class="comment"># kubectl get all -n kube-system</span></span><br><span class="line">NAME                                           READY   STATUS             RESTARTS   AGE</span><br><span class="line">pod/calico-kube-controllers-67d6cdb559-cwf62   0/1     CrashLoopBackOff   5          4m10s</span><br><span class="line">pod/canal-node-46x2b                           2/2     Running            0          4m25s</span><br><span class="line">pod/canal-node-5rkhq                           2/2     Running            0          4m25s</span><br><span class="line">pod/canal-node-fcsgn                           2/2     Running            0          4m25s</span><br><span class="line">pod/canal-node-nhkp8                           2/2     Running            0          4m25s</span><br><span class="line">pod/coredns-5d578c6f84-5nnp8                   1/1     Running            0          3m33s</span><br><span class="line">pod/coredns-5d578c6f84-w2kvf                   1/1     Running            0          3m39s</span><br><span class="line">pod/dns-autoscaler-6b675c8995-vp282            1/1     Running            0          3m34s</span><br><span class="line">pod/kube-apiserver-kube-control-1              1/1     Running            0          6m51s</span><br><span class="line">pod/kube-apiserver-kube-control-2              1/1     Running            0          7m7s</span><br><span class="line">pod/kube-apiserver-kube-control-3              1/1     Running            0          7m41s</span><br><span class="line">pod/kube-controller-manager-kube-control-1     1/1     Running            0          6m52s</span><br><span class="line">pod/kube-controller-manager-kube-control-2     1/1     Running            0          7m7s</span><br><span class="line">pod/kube-controller-manager-kube-control-3     1/1     Running            0          7m41s</span><br><span class="line">pod/kube-proxy-5dfx8                           1/1     Running            0          5m17s</span><br><span class="line">pod/kube-proxy-fvrqk                           1/1     Running            0          5m17s</span><br><span class="line">pod/kube-proxy-jd84p                           1/1     Running            0          5m17s</span><br><span class="line">pod/kube-proxy-l2mjk                           1/1     Running            0          5m17s</span><br><span class="line">pod/kube-scheduler-kube-control-1              1/1     Running            0          6m51s</span><br><span class="line">pod/kube-scheduler-kube-control-2              1/1     Running            0          7m7s</span><br><span class="line">pod/kube-scheduler-kube-control-3              1/1     Running            0          7m41s</span><br><span class="line">pod/nginx-proxy-kube-node-1                    1/1     Running            0          5m20s</span><br><span class="line">pod/nodelocaldns-77kq9                         1/1     Running            0          3m32s</span><br><span class="line">pod/nodelocaldns-fn5pd                         1/1     Running            0          3m32s</span><br><span class="line">pod/nodelocaldns-lfjzb                         1/1     Running            0          3m32s</span><br><span class="line">pod/nodelocaldns-xnc6n                         1/1     Running            0          3m32s</span><br><span class="line"></span><br><span class="line">NAME              TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">service/coredns   ClusterIP   10.233.0.3   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   3m38s</span><br><span class="line"></span><br><span class="line">NAME                          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span><br><span class="line">daemonset.apps/canal-node     4         4         4       4            4           &lt;none&gt;                   4m25s</span><br><span class="line">daemonset.apps/kube-proxy     4         4         4       4            4           kubernetes.io/os=linux   7m53s</span><br><span class="line">daemonset.apps/nodelocaldns   4         4         4       4            4           &lt;none&gt;                   3m32s</span><br><span class="line"></span><br><span class="line">NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/calico-kube-controllers   0/1     1            0           4m12s</span><br><span class="line">deployment.apps/coredns                   2/2     2            2           3m39s</span><br><span class="line">deployment.apps/dns-autoscaler            1/1     1            1           3m34s</span><br><span class="line"></span><br><span class="line">NAME                                                 DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/calico-kube-controllers-67d6cdb559   1         1         0       4m12s</span><br><span class="line">replicaset.apps/coredns-5d578c6f84                   2         2         2       3m39s</span><br><span class="line">replicaset.apps/dns-autoscaler-6b675c8995            1         1         1       3m34s</span><br></pre></td></tr></table></figure><h2 id="åæ§½"><a href="#åæ§½" class="headerlink" title="åæ§½"></a>åæ§½</h2><p>åœ¨å›½å†…è¿™ç§ååˆ†ç³Ÿç³•çš„ç½‘ç»œç¯å¢ƒä¸‹ï¼Œå¯¹äºæ™®é€šçš„å¼€å‘è€…æˆ–è€…å­¦ç”Ÿæ¥è®²ï¼Œéƒ¨ç½²ä¸€ä¸ª kubernetes é›†ç¾¤æ˜¯ååˆ†ç—›è‹¦çš„äº‹æƒ…ï¼Œè¿™ä¹Ÿè¿›ä¸€æ­¥é˜»ç¢äº†è¿™é—¨æŠ€æœ¯çš„æ™®åŠå’Œä½¿ç”¨ã€‚ä¹Ÿæƒ³èµ·äº†å‡ å¹´å‰åœ¨ä¸€æ¬¡ docker æŠ€æœ¯åˆ†äº«æ—¶çš„ QA é—®ç­”ï¼š</p><blockquote><p>Qï¼šå¦‚ä½•æ‘†è„±ç½‘ç»œçš„ä¾èµ–æ¥åˆ›å»ºä¸ª Docker çš„ image å‘¢ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªæ˜¯ Docker ç”¨æˆ·è‡ªå·±çš„åŸºæœ¬æƒåˆ©ï¼Ÿ</p></blockquote><p><strong>Aï¼šè¿™ä¸ªåŸºæœ¬æƒåˆ©æˆ‘è§‰å¾—è¿˜æ˜¯è¦é—® GFW ï¼Œå›½å¤–çš„å¼€å‘äººå‘˜æ˜¯éå¸¸éš¾ç†è§£æœ‰äº›ä»–ä»¬è®¤ä¸ºè·Ÿæ°´ç”µä¸€æ ·æ™®åŠçš„åŸºç¡€è®¾æ–½åœ¨æŸäº›åœ°æ–¹è¿˜æ˜¯å¾ˆå›°éš¾çš„ã€‚</strong></p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;å…¬å¸ PaaS å¹³å°åº•å±‚çš„ kubernetes
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubernetes" scheme="https://blog.k8s.li/tags/kubernetes/"/>
    
      <category term="k8s" scheme="https://blog.k8s.li/tags/k8s/"/>
    
      <category term="kubespray" scheme="https://blog.k8s.li/tags/kubespray/"/>
    
  </entry>
  
  <entry>
    <title>ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼</title>
    <link href="https://blog.k8s.li/select-registry-images.html"/>
    <id>https://blog.k8s.li/select-registry-images.html</id>
    <published>2021-04-27T16:00:00.000Z</published>
    <updated>2021-04-27T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="overlay2-ä¼˜åŒ–"><a href="#overlay2-ä¼˜åŒ–" class="headerlink" title="overlay2 ä¼˜åŒ–"></a>overlay2 ä¼˜åŒ–</h2><p>å‰æ®µæ—¶é—´å†™è¿‡ä¸€ç¯‡ <a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 åœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­çš„åº”ç”¨</a>ï¼Œæ¥ä»‹ç»åœ¨äº§å“å‘å¸ƒæµæ°´çº¿ä¸­ä½¿ç”¨ overlay2 å’Œ registry ç»„åˆçš„æŠ€æœ¯æ¥ä¼˜åŒ–é•œåƒåŒæ­¥çš„æµç¨‹ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å»é˜…è¯»ä¸€ä¸‹ã€‚æœ€è¿‘<strong>å¿½ç„¶</strong>å‘ç°äº†ä¸€ä¸ªå¯ä»¥å®Œç¾æ›¿ä»£ overlay2 çš„æ–¹æ¡ˆï¼Œè€Œä¸”æ€§èƒ½æ›´å¥½ï¼Œæµç¨‹æ›´ç®€å•ã€‚</p><p><img src="https://p.k8s.li/2021-03-01-002.jpeg" alt=""></p><p>æ ¹æ®åœ¨æ–‡ç« ä¸­æåˆ°çš„é•œåƒåŒæ­¥æµç¨‹å¯ä»¥å¾—çŸ¥ï¼šåœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­ï¼Œä¼šè¿›è¡Œä¸¤æ¬¡é•œåƒåŒæ­¥ã€‚ç¬¬ä¸€æ¬¡æ˜¯æ ¹æ®ä¸€ä¸ªé•œåƒåˆ—è¡¨å°†é•œåƒä» cicd.registry.local ä»“åº“åŒæ­¥åˆ° overlay2.registry.localï¼›ç¬¬äºŒæ¬¡æ˜¯å°† overlay2.registry.local é•œåƒåŒæ­¥åˆ° package.registry.localã€‚overlay2.registry.local å’Œ package.registry.local è¿™ä¸¤ä¸ªé•œåƒä»“åº“æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Šï¼Œè€Œä¸” overlay2.registry.lcoal çš„ registry å­˜å‚¨ç›®å½•å°†ä½œä¸º overlay2 æŒ‚è½½çš„ lower ç»™ package.registry.local ä½¿ç”¨ã€‚</p><p>åœ¨ <a href="https://blog.k8s.li/skopeo-to-registry.html">å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</a> æ–‡ç« æˆ‘æåˆ°è¿‡ skopeo dir æ ¼å¼çš„é•œåƒå¯ä»¥è¿˜åŸå› registry å­˜å‚¨çš„æ ¼å¼ï¼›åœ¨ <a href="https://blog.k8s.li/docker-registry-to-harbor.html">docker registry è¿ç§»è‡³ harbor</a> æ–‡ç« ä¸­æåˆ°äº†å¯ä»¥å°† registry å­˜å‚¨çš„æ ¼å¼è½¬æ¢ä¸º skopeo dir çš„æ ¼å¼ï¼Œå› æ­¤æ€»ç»“å‡º skopeo dir å’Œ docker registry è¿™ä¸¤ç§é•œåƒå­˜å‚¨æ ¼å¼å¯ä»¥äº’ç›¸è½¬æ¢ã€‚</p><p>æŒæ¡äº†è¿™ä¸¤ç§é•œåƒå­˜å‚¨æ ¼å¼ä¹‹é—´äº’ç›¸è½¬æ¢ä¹‹åï¼Œçªç„¶æ„è¯†åˆ°<strong>ä¸ºä½•ä¸ç›´æ¥ä» registry å­˜å‚¨æå–ç‰¹å®šçš„é•œåƒï¼ˆé•œåƒåˆ—è¡¨ï¼‰ï¼Œå¹¶ä¿å–ä¸º registry å­˜å‚¨çš„æ ¼å¼ï¼Ÿ</strong> è¿™æ ·æ ¹æœ¬å°±ä¸éœ€è¦ overlay2 å’Œ skopeoï¼Œå¯ä»¥ç›´æ¥å¯¹ registry çš„å­˜å‚¨è¿›è¡Œæ“ä½œï¼Œå°†é•œåƒä¸€ä¸ªä¸€ä¸ªåœ°ç¡¬é“¾æ¥å‡ºæ¥ã€‚è€Œä¸”å¯¹ registry æ–‡ä»¶ç³»ç»Ÿçš„ I/O æ“ä½œä»ç†è®ºä¸Šæ¥è®²æ€§èƒ½ä¼šè¿œè¿œé«˜äº skopeo è¿™ç§é€šè¿‡ HTTP åè®®ä¼ è¾“ã€‚</p><h2 id="ç©è½¬-registry-å­˜å‚¨"><a href="#ç©è½¬-registry-å­˜å‚¨" class="headerlink" title="ç©è½¬ registry å­˜å‚¨"></a>ç©è½¬ registry å­˜å‚¨</h2><p>å†ä¸€æ¬¡æ¬æ¥è¿™å¼  registry å­˜å‚¨çš„ç»“æ„å›¾ï¼Œå¦‚æœæƒ³è¦çœ‹æ‡‚è¿™ç³»åˆ—çš„æ–‡ç« ï¼Œä¸€å®šè¦ç†è§£è¿™å¼ å›¾ï¼š</p><p><img src="https://p.k8s.li/registry-storage.jpeg" alt=""></p><h3 id="registry-to-skopeo-dir"><a href="#registry-to-skopeo-dir" class="headerlink" title="registry to skopeo dir"></a>registry to skopeo dir</h3><p>ä¹‹å‰åœ¨ <a href="https://blog.k8s.li/docker-registry-to-harbor.html">docker registry è¿ç§»è‡³ harbor</a>  æ–‡ç« ä¸­æåˆ°è¿‡å°† registry å­˜å‚¨ä¸­çš„é•œåƒè½¬æ¢ä¸º skopeo dir çš„æ ¼å¼ï¼Œç„¶åä½¿ç”¨ skopeo å°†è½¬æ¢åçš„é•œåƒ push åˆ° harbor ä¸­ã€‚å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>é¦–å…ˆè¦å¾—åˆ°é•œåƒçš„ manifests æ–‡ä»¶ï¼Œä» manifests æ–‡ä»¶ä¸­å¯ä»¥å¾—åˆ°è¯¥é•œåƒçš„æ‰€æœ‰ blob æ–‡ä»¶ã€‚ä¾‹å¦‚å¯¹äº registry å­˜å‚¨ç›®å½•ä¸­çš„ <code>library/alpine:latest</code> é•œåƒæ¥è®²ï¼Œå®ƒåœ¨ registry ä¸­æ˜¯è¿™æ ·å­˜æ”¾çš„ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">â•°â”€# tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ blobs</span><br><span class="line">â”‚   â””â”€â”€ sha256</span><br><span class="line">â”‚       â”œâ”€â”€ 21</span><br><span class="line">â”‚       â”‚   â””â”€â”€ 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">â”‚       â”‚       â””â”€â”€ data</span><br><span class="line">â”‚       â”œâ”€â”€ a1</span><br><span class="line">â”‚       â”‚   â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">â”‚       â”‚       â””â”€â”€ data</span><br><span class="line">â”‚       â””â”€â”€ be</span><br><span class="line">â”‚           â””â”€â”€ be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">â”‚               â””â”€â”€ data</span><br><span class="line">â””â”€â”€ repositories</span><br><span class="line">    â””â”€â”€ library</span><br><span class="line">        â””â”€â”€ alpine</span><br><span class="line">            â”œâ”€â”€ _layers</span><br><span class="line">            â”‚   â””â”€â”€ sha256</span><br><span class="line">            â”‚       â”œâ”€â”€ 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">            â”‚       â”‚   â””â”€â”€ link</span><br><span class="line">            â”‚       â””â”€â”€ be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">            â”‚           â””â”€â”€ link</span><br><span class="line">            â”œâ”€â”€ _manifests</span><br><span class="line">            â”‚   â”œâ”€â”€ revisions</span><br><span class="line">            â”‚   â”‚   â””â”€â”€ sha256</span><br><span class="line">            â”‚   â”‚       â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">            â”‚   â”‚           â””â”€â”€ link</span><br><span class="line">            â”‚   â””â”€â”€ tags</span><br><span class="line">            â”‚       â””â”€â”€ latest</span><br><span class="line">            â”‚           â”œâ”€â”€ current</span><br><span class="line">            â”‚           â”‚   â””â”€â”€ link</span><br><span class="line">            â”‚           â””â”€â”€ index</span><br><span class="line">            â”‚               â””â”€â”€ sha256</span><br><span class="line">            â”‚                   â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">            â”‚                       â””â”€â”€ link</span><br><span class="line">            â””â”€â”€ _uploads</span><br><span class="line"></span><br><span class="line">26 directories, 8 files</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤ä¸€ï¼šé€šè¿‡ <code>repositories/library/alpine/_manifests/tags/latest/current/link</code> æ–‡ä»¶å¾—åˆ° alpine é•œåƒ lasts è¿™ä¸ª tag çš„ manifests æ–‡ä»¶çš„ sha256 å€¼ï¼Œç„¶åæ ¹æ®è¿™ä¸ª sha256 å€¼å» blobs æ‰¾åˆ°é•œåƒçš„ manifests æ–‡ä»¶;</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/repositories/library/alpine/_manifests/tags/latest/current/</span><br><span class="line">â•°â”€# cat link</span><br><span class="line">sha256:39eda93d15866957feaee28f8fc5adb545276a64147445c64992ef69804dbf01#</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤äºŒï¼šæ ¹æ® <code>current/link</code> æ–‡ä»¶ä¸­çš„ sha256 å€¼åœ¨ blobs ç›®å½•ä¸‹æ‰¾åˆ°ä¸ä¹‹å¯¹åº”çš„æ–‡ä»¶ï¼Œblobs ç›®å½•ä¸‹å¯¹åº”çš„ manifests æ–‡ä»¶ä¸º blobs/sha256/39/39eda93d15866957feaee28f8fc5adb545276a64147445c64992ef69804dbf01/data;</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/repositories/library/alpine/_manifests/tags/latest/current</span><br><span class="line">â•°â”€# cat /var/lib/registry/docker/registry/v2/blobs/sha256/39/39eda93d15866957feaee28f8fc5adb545276a64147445c64992ef69804dbf01/data</span><br><span class="line">&#123;</span><br><span class="line">   "schemaVersion": 2,</span><br><span class="line">   "mediaType": "application/vnd.docker.distribution.manifest.v2+json",</span><br><span class="line">   "config": &#123;</span><br><span class="line">      "mediaType": "application/vnd.docker.container.image.v1+json",</span><br><span class="line">      "size": 1507,</span><br><span class="line">      "digest": "sha256:f70734b6a266dcb5f44c383274821207885b549b75c8e119404917a61335981a"</span><br><span class="line">   &#125;,</span><br><span class="line">   "layers": [</span><br><span class="line">      &#123;</span><br><span class="line">         "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",</span><br><span class="line">         "size": 2813316,</span><br><span class="line">         "digest": "sha256:cbdbe7a5bc2a134ca8ec91be58565ec07d037386d1f1d8385412d224deafca08"</span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤ä¸‰ï¼šä½¿ç”¨æ­£åˆ™åŒ¹é…ï¼Œè¿‡æ»¤å‡º manifests æ–‡ä»¶ä¸­çš„æ‰€æœ‰ sha256 å€¼ï¼Œè¿™äº› sha256 å€¼å°±å¯¹åº”ç€ blobs ç›®å½•ä¸‹çš„ image config æ–‡ä»¶å’Œ image layer æ–‡ä»¶;</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/repositories/library/alpine/_manifests/tags/latest/current</span><br><span class="line">â•°â”€# grep -Eo "\b[a-f0-9]&#123;64&#125;\b" /var/lib/registry/docker/registry/v2/blobs/sha256/39/39eda93d15866957feaee28f8fc5adb545276a64147445c64992ef69804dbf01/data</span><br><span class="line">f70734b6a266dcb5f44c383274821207885b549b75c8e119404917a61335981a</span><br><span class="line">cbdbe7a5bc2a134ca8ec91be58565ec07d037386d1f1d8385412d224deafca08</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤å››ï¼šæ ¹æ® manifests æ–‡ä»¶å°±å¯ä»¥å¾—åˆ° blobs ç›®å½•ä¸­é•œåƒçš„æ‰€æœ‰ layer å’Œ image config æ–‡ä»¶ï¼Œç„¶åå°†è¿™äº›æ–‡ä»¶æ‹¼æˆä¸€ä¸ª dir æ ¼å¼çš„é•œåƒï¼Œåœ¨è¿™é‡Œä½¿ç”¨ cp çš„æ–¹å¼å°†é•œåƒä» registry å­˜å‚¨ç›®å½•é‡Œå¤åˆ¶å‡ºæ¥ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œä¸ºäº†ä¿ç•™é•œåƒçš„ name å’Œ tagï¼Œæ–‡ä»¶å¤¹çš„åç§°å°±å¯¹åº”çš„æ˜¯ NAME:TAG</span></span><br><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker</span><br><span class="line">â•°â”€# mkdir -p skopeo/library/alpine:latest</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¤åˆ¶é•œåƒçš„ manifest æ–‡ä»¶</span></span><br><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker</span><br><span class="line">â•°â”€# cp /var/lib/registry/docker/registry/v2/blobs/sha256/39/39eda93d15866957feaee28f8fc5adb545276a64147445c64992ef69804dbf01/data skopeo/library/alpine:latest/manifest</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¤åˆ¶é•œåƒçš„ blob æ–‡ä»¶</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp /var/lib/registry/docker/registry/v2/blobs/sha256/f7/f70734b6a266dcb5f44c383274821207885b549b75c8e119404917a61335981a/data skopeo/library/alpine:latest/f70734b6a266dcb5f44c383274821207885b549b75c8e119404917a61335981a</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cp /var/lib/registry/docker/registry/v2/blobs/sha256/cb/cbdbe7a5bc2a134ca8ec91be58565ec07d037386d1f1d8385412d224deafca08/data skopeo/library/alpine:latest/cbdbe7a5bc2a134ca8ec91be58565ec07d037386d1f1d8385412d224deafca08</span></span><br></pre></td></tr></table></figure><p>æœ€ç»ˆå¾—åˆ°çš„é•œåƒæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker</span><br><span class="line">â•°â”€# tree skopeo/library/alpine:latest</span><br><span class="line">skopeo/library/alpine:latest</span><br><span class="line">â”œâ”€â”€ cbdbe7a5bc2a134ca8ec91be58565ec07d037386d1f1d8385412d224deafca08</span><br><span class="line">â”œâ”€â”€ f70734b6a266dcb5f44c383274821207885b549b75c8e119404917a61335981a</span><br><span class="line">â””â”€â”€ manifest</span><br><span class="line"></span><br><span class="line">0 directories, 3 files</span><br></pre></td></tr></table></figure><h3 id="skopeo-dir-to-registry"><a href="#skopeo-dir-to-registry" class="headerlink" title="skopeo dir to registry"></a>skopeo dir to registry</h3><p>åœ¨ <a href="https://blog.k8s.li/skopeo-to-registry.html">å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</a> æ–‡ç« æˆ‘æåˆ°è¿‡ skopeo dir æ ¼å¼çš„é•œåƒå¯ä»¥è¿˜åŸå› registry å­˜å‚¨çš„æ ¼å¼ï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p><p>å°† <code>images/alpine:latest</code> è¿™ä¸ªé•œåƒåœ¨è½¬æ¢æˆ docker registry å­˜å‚¨ç›®å½•çš„å½¢å¼</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root # tree -h images/alpine:latest</span><br><span class="line">images/alpine:latest</span><br><span class="line">â””â”€â”€ [4.0K]  alpine:latest</span><br><span class="line">    â”œâ”€â”€ [2.7M]  4167d3e149762ea326c26fc2fd4e36fdeb7d4e639408ad30f37b8f25ac285a98</span><br><span class="line">    â”œâ”€â”€ [1.5K]  af341ccd2df8b0e2d67cf8dd32e087bfda4e5756ebd1c76bbf3efa0dc246590e</span><br><span class="line">    â”œâ”€â”€ [ 528]  manifest.json</span><br><span class="line">    â””â”€â”€ [  33]  version</span><br></pre></td></tr></table></figure><p>æ ¹æ®é•œåƒæ–‡ä»¶å¤§å°æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼š <code>2.7M</code> å¤§å°çš„ <code>4167d3e1497â€¦â€¦</code> æ–‡ä»¶å°±æ˜¯é•œåƒçš„ layer æ–‡ä»¶ï¼Œç”±äº alpine æ˜¯ä¸€ä¸ª base é•œåƒï¼Œè¯¥ layer å°±æ˜¯ alpine çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼›<code>1.5K</code> å¤§å°çš„ <code>af341ccd2â€¦â€¦</code> æ˜¾è€Œæ˜“è§å°±æ˜¯é•œåƒçš„ images config æ–‡ä»¶ï¼›<code>manifest.json</code> æ–‡ä»¶åˆ™æ˜¯é•œåƒåœ¨ registry å­˜å‚¨ä¸­çš„ manifest.json æ–‡ä»¶ã€‚</p><ul><li>æ­¥éª¤ä¸€ï¼šå…ˆåˆ›å»ºè¯¥é•œåƒåœ¨ registry å­˜å‚¨ä¸­çš„ç›®å½•ç»“æ„</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root # mkdir -p docker/registry/v2/&#123;blobs/sha256,repositories/alpine&#125;</span><br><span class="line">root@debian:/root # tree docker</span><br><span class="line">docker</span><br><span class="line">â””â”€â”€ registry</span><br><span class="line">    â””â”€â”€ v2</span><br><span class="line">        â”œâ”€â”€ blobs</span><br><span class="line">        â”‚   â””â”€â”€ sha256</span><br><span class="line">        â””â”€â”€ repositories</span><br><span class="line">            â””â”€â”€ alpine</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤äºŒï¼šæ„å»ºé•œåƒ layer çš„ link æ–‡ä»¶</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grep -Eo "\b[a-f0-9]&#123;64&#125;\b" images/alpine:latest/manifest.json | sort -u | xargs -L1 -I &#123;&#125; mkdir -p docker/registry/v2/repositories/alpine/_layers/sha256/&#123;&#125;</span><br><span class="line"></span><br><span class="line">grep -Eo "\b[a-f0-9]&#123;64&#125;\b" images/alpine:latest/manifest.json | sort -u | xargs -L1 -I &#123;&#125; sh -c "echo -n 'sha256:&#123;&#125;' &gt; docker/registry/v2/repositories/alpine/_layers/sha256/&#123;&#125;/link"</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤ä¸‰ï¼šæ„å»ºé•œåƒ tag çš„ link æ–‡ä»¶</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">manifests_sha256=$(sha256sum images/alpine:latest/manifest.json | awk '&#123;print $1&#125;')</span><br><span class="line">mkdir -p docker/registry/v2/repositories/alpine/_manifests/revisions/sha256/$&#123;manifests_sha256&#125;</span><br><span class="line">echo -n "sha256:$&#123;manifests_sha256&#125;" &gt; docker/registry/v2/repositories/alpine/_manifests/revisions/sha256/$&#123;manifests_sha256&#125;/link</span><br><span class="line"></span><br><span class="line">mkdir -p docker/registry/v2/repositories/alpine/_manifests/tags/latest/index/sha256/$&#123;manifests_sha256&#125;</span><br><span class="line">echo -n "sha256:$&#123;manifests_sha256&#125;" &gt; docker/registry/v2/repositories/alpine/_manifests/tags/latest/index/sha256/$&#123;manifests_sha256&#125;/link</span><br><span class="line"></span><br><span class="line">mkdir -p docker/registry/v2/repositories/alpine/_manifests/tags/latest/current</span><br><span class="line">echo -n "sha256:$&#123;manifests_sha256&#125;" &gt; docker/registry/v2/repositories/alpine/_manifests/tags/latest/current/link</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤å››ï¼šæ„å»ºé•œåƒçš„ blobs ç›®å½•</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p docker/registry/v2/blobs/sha256/$&#123;manifests_sha256:0:2&#125;/$&#123;manifests_sha256&#125;</span><br><span class="line">ln -f images/alpine:latest/manifest.json docker/registry/v2/blobs/sha256/$&#123;manifests_sha256:0:2&#125;/$&#123;manifests_sha256&#125;/data</span><br><span class="line"></span><br><span class="line">for layer in $(grep -Eo "\b[a-f0-9]&#123;64&#125;\b" images/alpine:latest/manifest.json); do</span><br><span class="line">    mkdir -p docker/registry/v2/blobs/sha256/$&#123;layer:0:2&#125;/$&#123;layer&#125;</span><br><span class="line">    ln -f  images/alpine:latest/$&#123;layer&#125; docker/registry/v2/blobs/sha256/$&#123;layer:0:2&#125;/$&#123;layer&#125;/data</span><br><span class="line">done</span><br></pre></td></tr></table></figure><ul><li>æœ€ç»ˆå¾—åˆ°çš„ registry å­˜å‚¨ç›®å½•å¦‚ä¸‹</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">docker</span><br><span class="line">â””â”€â”€ registry</span><br><span class="line">    â””â”€â”€ v2</span><br><span class="line">        â”œâ”€â”€ blobs</span><br><span class="line">        â”‚   â””â”€â”€ sha256</span><br><span class="line">        â”‚       â”œâ”€â”€ 41</span><br><span class="line">        â”‚       â”‚   â””â”€â”€ 4167d3e149762ea326c26fc2fd4e36fdeb7d4e639408ad30f37b8f25ac285a98</span><br><span class="line">        â”‚       â”‚       â””â”€â”€ data</span><br><span class="line">        â”‚       â”œâ”€â”€ af</span><br><span class="line">        â”‚       â”‚   â””â”€â”€ af341ccd2df8b0e2d67cf8dd32e087bfda4e5756ebd1c76bbf3efa0dc246590e</span><br><span class="line">        â”‚       â”‚       â””â”€â”€ data</span><br><span class="line">        â”‚       â””â”€â”€ de</span><br><span class="line">        â”‚           â””â”€â”€ de78803598bc4c940fc4591d412bffe488205d5d953f94751c6308deeaaa7eb8</span><br><span class="line">        â”‚               â””â”€â”€ data</span><br><span class="line">        â””â”€â”€ repositories</span><br><span class="line">            â””â”€â”€ alpine</span><br><span class="line">                â”œâ”€â”€ _layers</span><br><span class="line">                â”‚   â””â”€â”€ sha256</span><br><span class="line">                â”‚       â”œâ”€â”€ 4167d3e149762ea326c26fc2fd4e36fdeb7d4e639408ad30f37b8f25ac285a98</span><br><span class="line">                â”‚       â”‚   â””â”€â”€ link</span><br><span class="line">                â”‚       â””â”€â”€ af341ccd2df8b0e2d67cf8dd32e087bfda4e5756ebd1c76bbf3efa0dc246590e</span><br><span class="line">                â”‚           â””â”€â”€ link</span><br><span class="line">                â””â”€â”€ _manifests</span><br><span class="line">                    â”œâ”€â”€ revisions</span><br><span class="line">                    â”‚   â””â”€â”€ sha256</span><br><span class="line">                    â”‚       â””â”€â”€ de78803598bc4c940fc4591d412bffe488205d5d953f94751c6308deeaaa7eb8</span><br><span class="line">                    â”‚           â””â”€â”€ link</span><br><span class="line">                    â””â”€â”€ tags</span><br><span class="line">                        â””â”€â”€ latest</span><br><span class="line">                            â”œâ”€â”€ current</span><br><span class="line">                            â”‚   â””â”€â”€ link</span><br><span class="line">                            â””â”€â”€ index</span><br><span class="line">                                â””â”€â”€ sha256</span><br><span class="line">                                    â””â”€â”€ de78803598bc4c940fc4591d412bffe488205d5d953f94751c6308deeaaa7eb8</span><br><span class="line">                                        â””â”€â”€ link</span><br></pre></td></tr></table></figure><h3 id="registry-to-registry-by-images-list"><a href="#registry-to-registry-by-images-list" class="headerlink" title="registry to registry  by images list"></a>registry to registry  by images list</h3><p>ç†Ÿæ‚‰äº†å¦‚ä½•å°† registry å­˜å‚¨è½¬æ¢ä¸º skopeo dir ä»¥åŠé•œåƒ skopeo dir è½¬æ¢ä¸º registry å­˜å‚¨çš„æµç¨‹ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ ¹æ®ä¸€ä¸ªé•œåƒåˆ—è¡¨ï¼Œå°†é•œåƒä»ä¸€ä¸ªå¾ˆå¤§çš„ registry å­˜å‚¨ä¸­ï¼ˆé‡Œé¢å‡ åƒä¸ªé•œåƒï¼‰æå–å‡ºä¸€äº›ç‰¹å®šçš„é•œåƒã€‚æ¯”å¦‚é•œåƒåˆ—è¡¨å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">library/alpine:latest</span><br><span class="line">library/alpine:3.6</span><br><span class="line">library/alpine:3.7</span><br><span class="line">library/busybox:1.30.0</span><br><span class="line">library/centos:6.7</span><br><span class="line">library/centos:7.4.1708</span><br><span class="line">library/default-http-backend:v0.1.0</span><br><span class="line">library/elasticsearch:6.5.4</span><br><span class="line">library/examples-bookinfo-details-v1:1.8.0</span><br><span class="line">library/examples-bookinfo-productpage-v1:1.8.0</span><br><span class="line">library/examples-bookinfo-ratings-v1:1.8.0</span><br><span class="line">library/examples-bookinfo-reviews-v1:1.8.0</span><br><span class="line">library/examples-bookinfo-reviews-v2:1.8.0</span><br><span class="line">library/examples-bookinfo-reviews-v3:1.8.0</span><br><span class="line">library/galera:5.7.20</span><br><span class="line">library/gitlab-ce:10.3.3-ce.0</span><br><span class="line">library/golang:1.10.1-alpine3.7</span><br><span class="line">library/golang:1.9.5-alpine3.7</span><br><span class="line">library/gradle:5.5.1</span><br><span class="line">library/haproxy:1.6.14-alpine</span><br><span class="line">library/haproxy:1.7.10-alpine</span><br><span class="line">library/influxdb:1.4.2-alpine</span><br><span class="line">library/influxdb:1.4.3</span><br><span class="line">library/influxdb:1.5.2-alpine</span><br><span class="line">library/jenkins:2.101-alpine-enhanced</span><br><span class="line">library/kibana:6.5.4</span><br><span class="line">library/mariadb:10.2.12</span><br><span class="line">library/maven:3.5.3-ibmjava-8-alpine</span><br><span class="line">library/maven:3.5.3-jdk-8-alpine</span><br><span class="line">library/memcached:1.5.4-alpine</span><br><span class="line">library/mongo:3.4.14-jessie</span><br><span class="line">library/mongo:3.6.1</span><br><span class="line">library/mongo:3.6.13</span><br><span class="line">library/mongo:3.7.3-jessie</span><br><span class="line">library/mysql:5.6.39</span><br><span class="line">library/mysql:5.7.20</span><br><span class="line">library/nginx:1.11.12-alpine</span><br><span class="line">library/nginx:1.12.2</span><br><span class="line">library/nginx:1.13.8-alpine</span><br><span class="line">library/nginx-ingress-controller:0.23.0-cps-1.3</span><br><span class="line">library/node:9-alpine</span><br><span class="line">library/openjdk:8u151-alpine3.7</span><br><span class="line">library/openjdk:8u151-jre-alpine3.7</span><br><span class="line">library/php:7.1-apache</span><br><span class="line">library/python:2.7.14-alpine3.6</span><br><span class="line">library/python:3.6.5-alpine3.6</span><br><span class="line">library/rabbitmq:3.7.2-alpine</span><br><span class="line">library/redis:3.2.11-alpine</span><br><span class="line">library/redis:4.0.6-alpine</span><br><span class="line">library/redis:4.0.9-alpine</span><br><span class="line">library/redmine:3.4.4</span><br><span class="line">library/sbt:8u232_1.3.13</span><br><span class="line">library/wordpress:4.9.1</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆä»¥å•ä¸ªé•œåƒä¸ºä¾‹å­å¦‚ï¼š <code>library/alpine:latest</code></p><ul><li>é¦–å…ˆè¦å¾—åˆ°é•œåƒçš„ manifest æ–‡ä»¶ï¼Œä» manifest æ–‡ä»¶ä¸­å¯ä»¥å¾—åˆ°è¯¥é•œåƒçš„æ‰€æœ‰ blob æ–‡ä»¶ã€‚ä¾‹å¦‚å¯¹äº registry å­˜å‚¨ç›®å½•ä¸­çš„ <code>library/alpine:latest</code> é•œåƒæ¥è®²ï¼Œå®ƒåœ¨ registry ä¸­æ˜¯è¿™æ ·å­˜æ”¾çš„ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">â•°â”€# tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ blobs</span><br><span class="line">â”‚   â””â”€â”€ sha256</span><br><span class="line">â”‚       â”œâ”€â”€ 21</span><br><span class="line">â”‚       â”‚   â””â”€â”€ 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">â”‚       â”‚       â””â”€â”€ data</span><br><span class="line">â”‚       â”œâ”€â”€ a1</span><br><span class="line">â”‚       â”‚   â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">â”‚       â”‚       â””â”€â”€ data</span><br><span class="line">â”‚       â””â”€â”€ be</span><br><span class="line">â”‚           â””â”€â”€ be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">â”‚               â””â”€â”€ data</span><br><span class="line">â””â”€â”€ repositories</span><br><span class="line">    â””â”€â”€ library</span><br><span class="line">        â””â”€â”€ alpine</span><br><span class="line">            â”œâ”€â”€ _layers</span><br><span class="line">            â”‚   â””â”€â”€ sha256</span><br><span class="line">            â”‚       â”œâ”€â”€ 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">            â”‚       â”‚   â””â”€â”€ link</span><br><span class="line">            â”‚       â””â”€â”€ be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">            â”‚           â””â”€â”€ link</span><br><span class="line">            â”œâ”€â”€ _manifests</span><br><span class="line">            â”‚   â”œâ”€â”€ revisions</span><br><span class="line">            â”‚   â”‚   â””â”€â”€ sha256</span><br><span class="line">            â”‚   â”‚       â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">            â”‚   â”‚           â””â”€â”€ link</span><br><span class="line">            â”‚   â””â”€â”€ tags</span><br><span class="line">            â”‚       â””â”€â”€ latest</span><br><span class="line">            â”‚           â”œâ”€â”€ current</span><br><span class="line">            â”‚           â”‚   â””â”€â”€ link</span><br><span class="line">            â”‚           â””â”€â”€ index</span><br><span class="line">            â”‚               â””â”€â”€ sha256</span><br><span class="line">            â”‚                   â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">            â”‚                       â””â”€â”€ link</span><br><span class="line">            â””â”€â”€ _uploads</span><br><span class="line"></span><br><span class="line">26 directories, 8 files</span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆå®šä¹‰ä¸€äº›éœ€è¦ç”¨åˆ°çš„å˜é‡</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®šä¹‰é•œåƒåˆ—è¡¨</span></span><br><span class="line">IMAGES_LIST=<span class="string">"images.list"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ registry å­˜å‚¨ç›®å½•çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line">REGISTRY_PATH=<span class="string">"/var/lib/registry"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰è¾“å‡ºçš„å­˜å‚¨ç›®å½•è·¯å¾„ï¼Œè¦å’Œ registay å­˜å‚¨åœ¨åŒä¸€åˆ†åŒº</span></span><br><span class="line">OUTPUT_DIR=<span class="string">"/var/lib/images"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰è¿™ä¸¤ä¸ªå›ºå®šå˜é‡</span></span><br><span class="line">BLOB_DIR=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">REPO_DIR=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰å•ä¸ªé•œåƒ</span></span><br><span class="line">image=<span class="string">"library/alpine:latest"</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨ bash å†…ç½®çš„å˜é‡æ›¿æ¢æˆªå–å‡ºé•œåƒçš„ name</span></span><br><span class="line">image_tag=<span class="variable">$&#123;image##*:&#125;</span></span><br><span class="line"><span class="comment"># ä½¿ç”¨ bash å†…ç½®çš„å˜é‡æ›¿æ¢æˆªå–å‡ºé•œåƒçš„ tag</span></span><br><span class="line">image_name=<span class="variable">$&#123;image%%:*&#125;</span></span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤ä¸€ï¼šé€šè¿‡ <code>${REGISTRY_PATH}/${REPO_DIR}/${image_name}/_manifests/tags/${image_tag}/current/link</code> æ–‡ä»¶å¾—åˆ° alpine é•œåƒ lasts è¿™ä¸ª tag çš„ manifests æ–‡ä»¶çš„ sha256 å€¼ï¼Œç„¶åæ ¹æ®è¿™ä¸ª sha256 å€¼å» blobs ç›®å½•ä¸‹æ‰¾åˆ°é•œåƒçš„ manifests æ–‡ä»¶;</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tag_link=<span class="variable">$&#123;REGISTRY_PATH&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/current/link</span><br><span class="line">manifest_sha256=$(sed <span class="string">'s/sha256://'</span> <span class="variable">$&#123;tag_link&#125;</span>)</span><br><span class="line">manifest=<span class="variable">$&#123;REGISTRY_PATH&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span>/data</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤äºŒï¼šæ‰¾åˆ°é•œåƒçš„ manifest æ–‡ä»¶ä¹‹åï¼Œåœ¨è¾“å‡ºç›®å½•ä¸‹åˆ›å»ºç›¸åº”çš„ç›®å½•ï¼Œå¹¶é€šè¿‡ç¡¬é“¾æ¥çš„æ–¹å¼å°†é•œåƒçš„ manifest é“¾æ¥åˆ°è¾“å‡ºå¯¹åº”çš„ç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line">ln -f <span class="variable">$&#123;manifest&#125;</span> <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span>/data</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤ä¸‰ï¼šå‚ç…§ <strong>skopeo dir to registry</strong> ä¸­çš„æ­¥éª¤ä¸‰åˆ›å»ºé•œåƒ tag çš„ link æ–‡ä»¶ï¼Œè·¯å¾„åŸºæœ¬ä¸Šä¿æŒä¸€è‡´ï¼Œåªä¸è¿‡å‰é¢éœ€è¦åŠ ä¸Šè¾“å‡ºç›®å½•çš„è·¯å¾„ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># make image repositories dir</span></span><br><span class="line">mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/&#123;_uploads,_layers,_manifests&#125;</span><br><span class="line">mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line">mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/&#123;current,index/sha256&#125;</span><br><span class="line">mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create image tag manifest link file</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/current/link</span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br></pre></td></tr></table></figure><ul><li>æ­¥éª¤å››ï¼šé€šè¿‡æ­£åˆ™åŒ¹é…  sha256 å€¼è·å–è¯¥é•œåƒ manifest æ–‡ä»¶ä¸­çš„æ‰€æœ‰ image layer å’Œ image configï¼Œå¹¶åœ¨ä¸€ä¸ª for å¾ªç¯ä¸­å°†å¯¹åº” sha256 å€¼å¯¹åº”çš„ blob æ–‡ä»¶ç¡¬é“¾æ¥åˆ°è¾“å‡ºç›®å½•ï¼Œå¹¶åœ¨ _layer ç›®å½•ä¸‹åˆ›å»ºç›¸åº”çš„ link æ–‡ä»¶ã€‚è¿™ä¸€æ­¥å’Œ <strong>skopeo dir to registry</strong> ä¸­çš„æ­¥éª¤å››åŠå…¶ç›¸ä¼¼ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> layer <span class="keyword">in</span> $(sed <span class="string">'/v1Compatibility/d'</span> <span class="variable">$&#123;manifest&#125;</span> | grep -Eo <span class="string">'\b[a-f0-9]&#123;64&#125;\b'</span> | sort -u); <span class="keyword">do</span></span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">    ln -f <span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;layer&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span>/link</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li>å°†ä¸Šè¿°æ­¥éª¤æ•´åˆæˆä¸€ä¸ª shell è„šæœ¬ <code>select_registry_images.sh</code> å¦‚ä¸‹ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">set -eo pipefail</span><br><span class="line"></span><br><span class="line">IMAGES_LIST="$1"</span><br><span class="line">REGISTRY_PATH="$2"</span><br><span class="line">OUTPUT_DIR="$3"</span><br><span class="line">BLOB_DIR="docker/registry/v2/blobs/sha256"</span><br><span class="line">REPO_DIR="docker/registry/v2/repositories"</span><br><span class="line"></span><br><span class="line">rm -rf $&#123;OUTPUT_DIR&#125;; mkdir -p $&#123;OUTPUT_DIR&#125;</span><br><span class="line">for image in $(find $&#123;IMAGES_LIST&#125; -type f -name "*.list" | xargs grep -Ev '^#|^/' | grep ':'); do</span><br><span class="line">    image_tag=$&#123;image##*:&#125;</span><br><span class="line">    image_name=$&#123;image%%:*&#125;</span><br><span class="line">    tag_link=$&#123;REGISTRY_PATH&#125;/$&#123;REPO_DIR&#125;/$&#123;image_name&#125;/_manifests/tags/$&#123;image_tag&#125;/current/link</span><br><span class="line">    manifest_sha256=$(sed 's/sha256://' $&#123;tag_link&#125;)</span><br><span class="line">    manifest=$&#123;REGISTRY_PATH&#125;/$&#123;BLOB_DIR&#125;/$&#123;manifest_sha256:0:2&#125;/$&#123;manifest_sha256&#125;/data</span><br><span class="line">    mkdir -p $&#123;OUTPUT_DIR&#125;/$&#123;BLOB_DIR&#125;/$&#123;manifest_sha256:0:2&#125;/$&#123;manifest_sha256&#125;</span><br><span class="line">    ln -f $&#123;manifest&#125; $&#123;OUTPUT_DIR&#125;/$&#123;BLOB_DIR&#125;/$&#123;manifest_sha256:0:2&#125;/$&#123;manifest_sha256&#125;/data</span><br><span class="line"></span><br><span class="line">    # make image repositories dir</span><br><span class="line">    mkdir -p $&#123;OUTPUT_DIR&#125;/$&#123;REPO_DIR&#125;/$&#123;image_name&#125;/&#123;_uploads,_layers,_manifests&#125;</span><br><span class="line">    mkdir -p $&#123;OUTPUT_DIR&#125;/$&#123;REPO_DIR&#125;/$&#123;image_name&#125;/_manifests/revisions/sha256/$&#123;manifest_sha256&#125;</span><br><span class="line">    mkdir -p $&#123;OUTPUT_DIR&#125;/$&#123;REPO_DIR&#125;/$&#123;image_name&#125;/_manifests/tags/$&#123;image_tag&#125;/&#123;current,index/sha256&#125;</span><br><span class="line">    mkdir -p $&#123;OUTPUT_DIR&#125;/$&#123;REPO_DIR&#125;/$&#123;image_name&#125;/_manifests/tags/$&#123;image_tag&#125;/index/sha256/$&#123;manifest_sha256&#125;</span><br><span class="line"></span><br><span class="line">    # create image tag manifest link file</span><br><span class="line">    echo -n "sha256:$&#123;manifest_sha256&#125;" &gt; $&#123;OUTPUT_DIR&#125;/$&#123;REPO_DIR&#125;/$&#123;image_name&#125;/_manifests/tags/$&#123;image_tag&#125;/current/link</span><br><span class="line">    echo -n "sha256:$&#123;manifest_sha256&#125;" &gt; $&#123;OUTPUT_DIR&#125;/$&#123;REPO_DIR&#125;/$&#123;image_name&#125;/_manifests/revisions/sha256/$&#123;manifest_sha256&#125;/link</span><br><span class="line">    echo -n "sha256:$&#123;manifest_sha256&#125;" &gt; $&#123;OUTPUT_DIR&#125;/$&#123;REPO_DIR&#125;/$&#123;image_name&#125;/_manifests/tags/$&#123;image_tag&#125;/index/sha256/$&#123;manifest_sha256&#125;/link</span><br><span class="line">    for layer in $(sed '/v1Compatibility/d' $&#123;manifest&#125; | grep -Eo '\b[a-f0-9]&#123;64&#125;\b' | sort -u); do</span><br><span class="line">        mkdir -p $&#123;OUTPUT_DIR&#125;/$&#123;BLOB_DIR&#125;/$&#123;layer:0:2&#125;/$&#123;layer&#125;</span><br><span class="line">        mkdir -p $&#123;OUTPUT_DIR&#125;/$&#123;REPO_DIR&#125;/$&#123;image_name&#125;/_layers/sha256/$&#123;layer&#125;</span><br><span class="line">        ln -f $&#123;BLOB_DIR&#125;/$&#123;layer:0:2&#125;/$&#123;layer&#125;/data $&#123;OUTPUT_DIR&#125;/$&#123;BLOB_DIR&#125;/$&#123;layer:0:2&#125;/$&#123;layer&#125;/data</span><br><span class="line">        echo -n "sha256:$&#123;layer&#125;" &gt; $&#123;OUTPUT_DIR&#125;/$&#123;REPO_DIR&#125;/$&#123;image_name&#125;/_layers/sha256/$&#123;layer&#125;/link</span><br><span class="line">    done</span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè¯¥è„šæœ¬ï¼Œå°† images.list ä¸­çš„ 183 ä¸ªé•œåƒé€šè¿‡ç¡¬é“¾æ¥çš„æ–¹å¼ï¼Œä» registry å­˜å‚¨ä¸­æå–åˆ°å¦ä¸€ä¸ª registry å­˜å‚¨ç›®å½•ä¸‹ï¼Œç”¨æ—¶æ‰ 6s å·¦å³ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@debian:~$ wc images.list</span><br><span class="line"> 183  183 5644 images.list</span><br><span class="line"></span><br><span class="line">root@debian:~$ time bash select_registry_images.sh images.list /var/lib/registry /var/lib/images</span><br><span class="line">bash select_registry_images.sh images.list /var/lib/registry   4.39s user 2.48s system 109% cpu 6.283 total</span><br></pre></td></tr></table></figure><h2 id="æ•ˆæœå¦‚ä½•ï¼Ÿ"><a href="#æ•ˆæœå¦‚ä½•ï¼Ÿ" class="headerlink" title="æ•ˆæœå¦‚ä½•ï¼Ÿ"></a>æ•ˆæœå¦‚ä½•ï¼Ÿ</h2><p>ä¹‹å‰ä½¿ç”¨ overlay2 æŠ€æœ¯å·²ç»å°†æµæ°´çº¿çš„é•œåƒåŒæ­¥ä¼˜åŒ–å¾—å¾ˆå¥½äº†ï¼Œç”±åŸæ¥çš„æœ€é•¿ 2h30min ç¼©çŸ­åˆ°äº†å‡ åˆ†é’Ÿã€‚</p><p>ç»è¿‡æœ¬æ¬¡çš„ä¼˜åŒ–ï¼Œå°†æµæ°´çº¿ä¸­ç¬¬äºŒæ¬¡çš„é•œåƒåŒæ­¥è€—æ—¶ä»åŸæ¥çš„  90s ç¼©çŸ­åˆ°äº† 6sï¼Œé€Ÿåº¦æå‡äº† 15 å€ï¼Œè€Œä¸”è¿‡ç¨‹æ¯”ä¹‹å‰æ›´ç®€å•äº†ä¸€äº›ï¼Œä¹Ÿä¸å†éœ€è¦å¼•å…¥ overlay2 è¿™ç§æŠ€æœ¯ã€‚çœ‹æ¥ä¹‹å‰è¢«æˆ‘å¹äº†è¿™ä¹ˆä¹…çš„ overlay2 + registry ç»„åˆæŠ€æœ¯å’Œè¿™æ¬¡ä¼˜åŒ–ç›¸æ¯”ä¹Ÿä¸è¿‡å¦‚æ­¤ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;overlay2-ä¼˜åŒ–&quot;&gt;&lt;a
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="registry" scheme="https://blog.k8s.li/tags/registry/"/>
    
      <category term="images" scheme="https://blog.k8s.li/tags/images/"/>
    
      <category term="skopeo" scheme="https://blog.k8s.li/tags/skopeo/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</title>
    <link href="https://blog.k8s.li/skopeo-to-registry.html"/>
    <id>https://blog.k8s.li/skopeo-to-registry.html</id>
    <published>2021-04-16T16:00:00.000Z</published>
    <updated>2021-04-16T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="è‹¦å‘½æ‰“åŒ…å·¥å…·äººğŸ˜­"><a href="#è‹¦å‘½æ‰“åŒ…å·¥å…·äººğŸ˜­" class="headerlink" title="è‹¦å‘½æ‰“åŒ…å·¥å…·äººğŸ˜­"></a>è‹¦å‘½æ‰“åŒ…å·¥å…·äººğŸ˜­</h2><p>ç›®å‰åœ¨è´Ÿè´£å…¬å¸ PaaS toB äº§å“çš„æ‰“åŒ…å‘å¸ƒå·¥ä½œï¼ˆè‹¦å‘½å‘ç‰ˆ+æ‰“åŒ…å·¥å…·äººğŸ˜£ï¼‰ã€‚æ—¥å¸¸çš„ä¸€é¡¹å·¥ä½œå°±æ˜¯è·‘å®Œè‡ªåŠ¨åŒ–æ‰“åŒ…æµæ°´çº¿ï¼Œå†å°†æ‰“å‡ºæ¥çš„å®‰è£…åŒ…æ›´æ–°åˆ° QA æµ‹è¯•ç¯å¢ƒä¸­ã€‚å› ä¸ºæ‰“åŒ…ç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒåˆ†å¸ƒåœ¨ä¸¤ä¸ªä¸åŒçš„æœºæˆ¿ï¼Œäº§å“çš„å®‰è£…åŒ…éœ€è¦è·¨å…¬ç½‘ä»æ‰“åŒ…æœºå™¨ä¸ŠåŒæ­¥åˆ° QA ç¯å¢ƒä¸­ï¼Œå› æ­¤äº§å“å®‰è£…åŒ…çš„å¤§å°å°±å†³å®šç€ä¸¤è€…é—´åŒæ­¥çš„è€—æ—¶ã€‚ä¼˜åŒ–å’Œå‡å°‘äº§å“å®‰è£…åŒ…çš„å¤§å°å°±æˆä¸ºäº†æå‡æµæ°´çº¿æ•ˆç‡çš„é€”å¾„ä¹‹ä¸€ã€‚æœ€è¿‘åšçš„ä¸€é¡¹å·¥ä½œå°±æ˜¯å°†äº§å“è¡¥ä¸åŒ…çš„å¤§å°å‡å°‘ 30%ï½60%ï¼Œå¤§å¤§èŠ‚çœäº†è¡¥ä¸åŒ…ä¸Šä¼ ä¸‹è½½å’Œå®‰è£…çš„è€—æ—¶ï¼Œæå‡äº†äº§å“æ‰“åŒ…æµæ°´çº¿çš„æ•ˆç‡ã€‚å› æ­¤ä»Šå¤©å°±æ€»ç»“ä¸€ä¸‹ä»ä¸­å­¦åˆ°çš„ä¸€ç‚¹äººç”Ÿç»éªŒ ğŸ‘“ã€‚</p><h2 id="å†æ¬¡ä¼˜åŒ–"><a href="#å†æ¬¡ä¼˜åŒ–" class="headerlink" title="å†æ¬¡ä¼˜åŒ–"></a>å†æ¬¡ä¼˜åŒ–</h2><p>å› ä¸ºäº§å“æ‰€æœ‰çš„ç»„ä»¶éƒ½æ˜¯å®¹å™¨åŒ–çš„å½¢å¼éƒ¨ç½²çš„ï¼Œæ‰€ä»¥äº§å“çš„è¡¥ä¸åŒ…ä¸­æœ€ä¸»è¦çš„å°±æ˜¯é•œåƒæ–‡ä»¶ä»¥åŠä¸€äº›éƒ¨ç½²è„šæœ¬ï¼Œæƒ³è¦ä¼˜åŒ–å’Œè§å‡å°è¡¥ä¸åŒ…åŸºæœ¬ä¸Šç­‰åŒäºå‡å°è¿™äº›é•œåƒçš„å¤§å°ã€‚ä¼—æ‰€å‘¨çŸ¥ docker é•œåƒæ˜¯ç”±ä¸€å±‚ä¸€å±‚çš„ layer + é•œåƒçš„å…ƒæ•°æ®ä¿¡æ¯æ„æˆçš„ï¼Œå…¶ä¸­é•œåƒçš„å…ƒæ•°æ®ä¿¡æ¯å°±æ˜¯é•œåƒçš„ image config + manifestsï¼Œè¿™äº›éƒ½æ˜¯ json æ ¼å¼çš„æ–‡æœ¬å†…å®¹ï¼Œç›¸å¯¹äºé•œåƒçš„ layer çš„å¤§å°ï¼Œè¿™äº›æ–‡æœ¬å†…å®¹å¾€å¾€å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</p><p>å…¶å®å»å¹´çš„æ—¶å€™å·²ç»åšè¿‡äº†ä¸€æ¬¡ä¼˜åŒ–ï¼Œå°†è¡¥ä¸åŒ…é•œåƒæ‰“åŒ…çš„æ–¹å¼ç”±åŸæ¥çš„ docker save çš„æ–¹å¼æ›¿æ¢æˆäº† skopeo copy åˆ°ç›®å½•çš„æ–¹å¼ï¼Œä¼˜åŒ–çš„æ•ˆæœå°±æ˜¯ï¼šå°†è¡¥ä¸åŒ…çš„å¤§å°å‡å°‘äº† 60%ï½80%ï¼›æµæ°´çº¿çš„é€Ÿåº¦æå‡äº† 5 å€ï¼›è¡¥ä¸åŒ…å®‰è£…é€Ÿåº¦ä¹Ÿæå‡äº† 5 å€ã€‚è¿™é¡¹ä¼˜åŒ–çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„åšå®¢ <a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿ</a>ã€‚è™½ç„¶ç¬¬ä¸€æ¬¡å·²ç»æœ‰äº†è¿™ä¹ˆæ˜æ˜¾çš„ä¼˜åŒ–ï¼Œä½†å’±ä»ç„¶è§‰å¾—è¿˜æœ‰å¯ä»¥ä¼˜åŒ–çš„ç©ºé—´ã€‚</p><p>ç»è¿‡ç¬¬ä¸€æ¬¡ä¼˜åŒ–ä¹‹åï¼Œäº§å“è¡¥ä¸åŒ…ä¸­é•œåƒå­˜åœ¨çš„å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kube <span class="comment"># tree images -h</span></span><br><span class="line">images</span><br><span class="line">â”œâ”€â”€ [4.0K]  kube-apiserver:v1.20.5</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ [707K]  742efefc8a44179dcc376b969cb5e3f8afff66f87ab618a15164638ad07bf722</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ [ 28M]  98d681774b176bb2fd6b3499377d63ff4b1b040886dd9d3641bb93840815a1e7</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ [2.6K]  d7e24aeb3b10210bf6a2dc39f77c1ea835b22af06dfd2933c06e0421ed6d35ac</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ [642K]  fefd475334af8255ba693de12951b5176a2853c2f0d5d2b053e188a1f3b611d9</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ [ 949]  manifest.json</span><br><span class="line">â”‚Â Â  â””â”€â”€ [  33]  version</span><br><span class="line">â”œâ”€â”€ [4.0K]  kube-controller-manager:v1.20.5</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ [ 27M]  454a7944c47b608efb657a1bef7f4093f63ceb2db14fd78c5ecd2a08333da7cf</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ [2.6K]  6f0c3da8c99e99bbe82920a35653f286bd8130f0662884e77fa9fcdca079c07f</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ [707K]  742efefc8a44179dcc376b969cb5e3f8afff66f87ab618a15164638ad07bf722</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ [642K]  fefd475334af8255ba693de12951b5176a2853c2f0d5d2b053e188a1f3b611d9</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ [ 949]  manifest.json</span><br><span class="line">â”‚Â Â  â””â”€â”€ [  33]  version</span><br><span class="line">â””â”€â”€ [4.0K]  kube-scheduler:v1.20.5</span><br><span class="line">    â”œâ”€â”€ [ 12M]  565677e452d17c4e2841250bbf0cc010d906fbf7877569bb2d69bfb4e68db1b5</span><br><span class="line">    â”œâ”€â”€ [707K]  742efefc8a44179dcc376b969cb5e3f8afff66f87ab618a15164638ad07bf722</span><br><span class="line">    â”œâ”€â”€ [2.6K]  8d13f1db8bfb498afb0caff6bf3f8c599ecc2ace74275f69886067f6af8ffdf6</span><br><span class="line">    â”œâ”€â”€ [642K]  fefd475334af8255ba693de12951b5176a2853c2f0d5d2b053e188a1f3b611d9</span><br><span class="line">    â”œâ”€â”€ [ 949]  manifest.json</span><br><span class="line">    â””â”€â”€ [  33]  version</span><br></pre></td></tr></table></figure><p>ä»”ç»†åˆ†æå¯ä»¥å‘ç°è¿™æ ·æ‰“åŒ…å‡ºæ¥çš„é•œåƒè¦æ¯”å®ƒä»¬åœ¨ registry ä¸­çš„æ‰€å å­˜å‚¨ç©ºé—´è¦å¤§ä¸€äº›ï¼Œè¿™æ˜¯å› ä¸ºæ¯ä¸€ä¸ªé•œåƒå­˜å‚¨ç›®å½•ä¸‹éƒ½ä¿å­˜åœ¨è¯¥é•œåƒçš„æ‰€æœ‰ layer ï¼Œä¸èƒ½åƒ registry å­˜å‚¨é‚£æ ·å¯ä»¥å¤ç”¨ç›¸åŒçš„ layerã€‚æ¯”å¦‚ <code>kube-apiserver</code>  <code>kube-controller-manager</code> <code>kube-scheduler</code> è¿™ä¸‰ä¸ªé•œåƒéƒ½æ˜¯ä½¿ç”¨çš„ <code>k8s.gcr.io/build-image/go-runner</code> è¿™ä¸ª base é•œåƒã€‚åœ¨ registry ä¸­ï¼Œå®ƒåªéœ€è¦å­˜å‚¨ä¸€ä»½ <code>go-runner</code> base é•œåƒå³å¯ã€‚è€Œä½¿ç”¨ skopeo copy å­˜å‚¨åœ¨ç›®å½•ä¸­æ—¶ï¼Œå°±éœ€è¦åˆ†åˆ«å­˜å‚¨ä¸€ä»½è¿™ä¸ª base é•œåƒäº†ã€‚</p><p>ä»æ–‡ä»¶åå’Œæ–‡ä»¶å¤§å°ä¹Ÿå¯ä»¥å¤§è‡´æ¨æ–­å‡º <code>707K</code> å¤§å°çš„ 742efefc8a å°±æ˜¯ <code>go-runner</code> é•œåƒçš„è·Ÿæ–‡ä»¶ç³»ç»Ÿï¼›<code>642K</code> å¤§å°çš„ fefd47533 å°±æ˜¯ go-runner çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼›<code>2.x</code> å·¦å³å¤§å°çš„åº”è¯¥å°±æ˜¯é•œåƒçš„ image config æ–‡ä»¶ï¼›å‰©ä¸‹é‚£ä¸ªåå‡ äºŒåå‡  M çš„å°±æ˜¯  <code>kube-apiserver</code>  <code>kube-controller-manager</code> <code>kube-scheduler</code>  çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼›manifest.json æ–‡ä»¶å°±æ˜¯é•œåƒåœ¨ registry å­˜å‚¨ä¸­çš„ manifest ã€‚</p><ul><li>ä½¿ç”¨ find æ¥ç»Ÿè®¡è¿™äº›æ–‡ä»¶çš„æ•°é‡ï¼Œç»è¿‡å»é‡ä¹‹åå¯ä»¥å‘ç°é•œåƒçš„ layer æ–‡ä»¶å’Œ config æ–‡ä»¶æ€»æ•°é‡ä»åŸæ¥çš„ 12 ä¸ªå‡å°‘åˆ° 8 ä¸ªã€‚åšä¸€ä¸ªç®€å•çš„åŠ æ³•è®¡ç®—ä¹Ÿå°±æ˜¯ï¼š3 ä¸ª image config æ–‡ä»¶ + 3 ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ + 1 ä¸ª base é•œåƒ layer æ–‡ä»¶ + 1 ä¸ª go-runner äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™ä¸æ­£å¥½å°±æ˜¯ 8 å˜›ğŸ˜‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kube <span class="comment"># find images -type f | grep -Eo "\b[a-f0-9]&#123;64&#125;\b" | wc</span></span><br><span class="line">12</span><br><span class="line">root@debian:/root/kube <span class="comment"># find images -type f | grep -Eo "\b[a-f0-9]&#123;64&#125;\b" | sort -u | wc -l</span></span><br><span class="line">8</span><br></pre></td></tr></table></figure><p>æ—¢ç„¶è¡¥ä¸åŒ…ä¸­çš„é•œåƒæ–‡ä»¶æœ‰ä¸€äº›ç›¸åŒçš„ layerï¼Œé‚£ä¹ˆå»é‡è¿™äº›ç›¸åŒçš„ layer æ–‡ä»¶å²‚ä¸å°±èƒ½å‡å°‘è¡¥ä¸åŒ…çš„å¤§å°äº†ï¼Ÿäºæ˜¯å°±æ‹¿äº†ä¸€ä¸ªå†å²çš„è¡¥ä¸åŒ…æµ‹è¯•ä¸€ä¸‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root $ du -sh images</span><br><span class="line">3.3Gimages</span><br><span class="line">root@debian:/root $ find images -<span class="built_in">type</span> f ! -name <span class="string">'version'</span> ! -name <span class="string">'manifest.json'</span> | wc -l</span><br><span class="line">279</span><br><span class="line">root@debian:/root $ mkdir -p images2</span><br><span class="line">root@debian:/root $ find images -<span class="built_in">type</span> f -<span class="built_in">exec</span> mv &#123;&#125; images2 \;</span><br><span class="line">root@debian:/root $ du -sh images2</span><br><span class="line">1.3Gimages2</span><br><span class="line">root@debian:/root $ $ find images2 -<span class="built_in">type</span> f ! -name <span class="string">'version'</span> ! -name <span class="string">'manifest.json'</span> | wc -l</span><br><span class="line">187</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰å¯¹æ¯”å°±æ²¡æœ‰ä¼¤å®³ï¼Œç»è¿‡æµ‹è¯•ä¹‹åå‘ç°ï¼šè¡¥ä¸åŒ…ä¸­é•œåƒæ–‡ä»¶çš„æ€»æ•°é‡ç”±åŸæ¥çš„ 279 ä¸ªå‡å°è‡³ 187 ä¸ªï¼Œæ€»å¤§å°ä»åŸæ¥çš„ 3.3G å‡å°åˆ° 1.3Gï¼Œå‡å°äº† 60%ï¼å½“æ—¶å…´å¥‹å¾—æˆ‘æ‹æ¡ˆå«ç»ï¼Œå¦‚è·çå®ã€‚å…¶å®è¿™å¾—ç›Šäºæˆ‘ä»¬äº§å“ç»„ä»¶ä½¿ç”¨çš„ base é•œåƒåŸºæœ¬ä¸Šæ˜¯ç›¸åŒçš„ï¼Œå› æ­¤å¯ä»¥å»é™¤æ‰å¾ˆå¤šç›¸åŒçš„ base é•œåƒ layer æ–‡ä»¶ã€‚</p><p>æ—¢ç„¶æ‰¾åˆ°äº†å‡å°è¡¥ä¸åŒ…ä¸­é•œåƒå¤§å°çš„æ€è·¯ï¼Œé‚£ä¹ˆåªè¦æ‰¾åˆ°ä¸€ç§æ–¹å¼æ¥å»é‡è¿™äº›é•œåƒ layer å°±å¯ä»¥äº†ã€‚é¦–å…ˆæƒ³åˆ°çš„å°±æ˜¯ä½¿ç”¨ registry å­˜å‚¨ï¼šæ ¹æ® registry å­˜å‚¨çš„ç‰¹æ€§ï¼Œé•œåƒåœ¨ registry ä¸­æ˜¯å¯ä»¥å¤ç”¨ç›¸åŒçš„ layer çš„ã€‚æ‰€ä»¥å¤§ä½“çš„æ€è·¯å°±æ˜¯å°†è¿™äº›è¡¥ä¸åŒ…ä¸­çš„é•œåƒè½¬æ¢ä¸º registry å­˜å‚¨çš„æ ¼å¼ï¼Œåœ¨å®‰è£…çš„æ—¶å€™å†å°† registry å­˜å‚¨çš„æ ¼å¼è½¬æ¢ä¸º skopeo copy æ”¯æŒçš„ dir æ ¼å¼ã€‚</p><h2 id="æ„å»º-skopeo-dir-é•œåƒå­˜å‚¨"><a href="#æ„å»º-skopeo-dir-é•œåƒå­˜å‚¨" class="headerlink" title="æ„å»º skopeo dir é•œåƒå­˜å‚¨"></a>æ„å»º skopeo dir é•œåƒå­˜å‚¨</h2><ul><li>ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œéœ€è¦æ‰¾ä¸ªåˆé€‚çš„é•œåƒåˆ—è¡¨ï¼Œçœ‹äº†ä¸€ä¸‹ <a href="https://github.com/kubesphere/ks-installer" target="_blank" rel="noopener">ks-installer</a> é¡¹ç›®ä¸­æœ‰ä¸ªé•œåƒåˆ—è¡¨ï¼Œçœ‹æ ·å­æ¯”è¾ƒåˆé€‚é‚£å°±ç”¨å®ƒå§ğŸ˜ƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root <span class="comment"># curl -L -O https://github.com/kubesphere/ks-installer/releases/download/v3.0.0/images-list.txt</span></span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆå°†é•œåƒä½¿ç”¨ skopeo sync åŒæ­¥åˆ°æœ¬åœ°ç›®å½•ï¼Œå¹¶ç»Ÿè®¡ä¸€ä¸‹é•œåƒçš„å¤§å°å’Œæ–‡ä»¶çš„æ•°é‡</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root <span class="comment"># for img in $(cat cat images-list.txt | grep -v "#");do skopeo sync --insecure-policy --src docker --dest dir $&#123;img&#125; images; done</span></span><br><span class="line"></span><br><span class="line">root@debian:/root <span class="comment"># tree images -d -L 1</span></span><br><span class="line">images</span><br><span class="line">â”œâ”€â”€ alpine:3.10.4</span><br><span class="line">â”œâ”€â”€ busybox:1.31.1</span><br><span class="line">â”œâ”€â”€ calico</span><br><span class="line">â”œâ”€â”€ coredns</span><br><span class="line">â”œâ”€â”€ csiplugin</span><br><span class="line">â”œâ”€â”€ docker:19.03</span><br><span class="line">â”œâ”€â”€ elastic</span><br><span class="line">â”œâ”€â”€ fluent</span><br><span class="line">â”œâ”€â”€ haproxy:2.0.4</span><br><span class="line">â”œâ”€â”€ istio</span><br><span class="line">â”œâ”€â”€ jaegertracing</span><br><span class="line">â”œâ”€â”€ java:openjdk-8-jre-alpine</span><br><span class="line">â”œâ”€â”€ jenkins</span><br><span class="line">â”œâ”€â”€ jimmidyson</span><br><span class="line">â”œâ”€â”€ joosthofman</span><br><span class="line">â”œâ”€â”€ kubesphere</span><br><span class="line">â”œâ”€â”€ minio</span><br><span class="line">â”œâ”€â”€ mirrorgooglecontainers</span><br><span class="line">â”œâ”€â”€ mysql:8.0.11</span><br><span class="line">â”œâ”€â”€ nginx:1.14-alpine</span><br><span class="line">â”œâ”€â”€ nginxdemos</span><br><span class="line">â”œâ”€â”€ openpitrix</span><br><span class="line">â”œâ”€â”€ osixia</span><br><span class="line">â”œâ”€â”€ perl:latest</span><br><span class="line">â”œâ”€â”€ prom</span><br><span class="line">â”œâ”€â”€ redis:5.0.5-alpine</span><br><span class="line">â””â”€â”€ wordpress:4.8-apache</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ skopeo sync å°†é•œåƒåŒæ­¥åˆ°æœ¬åœ° images ç›®å½•åï¼Œç»Ÿè®¡å¯å¾—æ‰€æœ‰é•œåƒçš„å¤§å°ä¸º 11Gã€æ€»çš„æ–‡ä»¶ä¸º 1264 ä¸ªã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root <span class="comment"># du -sh images</span></span><br><span class="line">11Gimages</span><br><span class="line">root@debian:/root <span class="comment"># find images -type f ! -name "version" | wc -l</span></span><br><span class="line">1264</span><br></pre></td></tr></table></figure><h2 id="è½¬æ¢æˆ-registry-å­˜å‚¨ç›®å½•"><a href="#è½¬æ¢æˆ-registry-å­˜å‚¨ç›®å½•" class="headerlink" title="è½¬æ¢æˆ registry å­˜å‚¨ç›®å½•"></a>è½¬æ¢æˆ registry å­˜å‚¨ç›®å½•</h2><p>æ ¹æ®ä¸‹å›¾æ‰€ç¤ºçš„ registry å­˜å‚¨ç»“æ„ï¼Œæˆ‘ä»¬è¦å°†é•œåƒçš„ layerã€image configã€manifests è¿™ä¸‰ç§æ–‡ä»¶æ ¹æ®å®ƒä»¬çš„ sha256 å€¼å­˜æ”¾åˆ° blobs/sha256 ç›®å½•ä¸‹ï¼Œç„¶åå†åœ¨ repositories ç›®å½•ä¸‹åˆ›å»ºç›¸åº”link æ–‡ä»¶ï¼Œè¿™æ ·å°±å¯ä»¥å°†é•œåƒè½¬æ¢æˆ registry å­˜å‚¨çš„æ ¼å¼äº†ã€‚</p><p><img src="https://p.k8s.li/registry-storage.jpeg" alt=""></p><p>ä¸ºæ–¹ä¾¿æ¼”ç¤ºæˆ‘ä»¬å…ˆä»¥å•ä¸ªé•œåƒä¸ºä¾‹ï¼Œå°† <code>images/alpine:3.10.4</code> è¿™ä¸ªé•œåƒåœ¨è½¬æ¢æˆ docker registry å­˜å‚¨ç›®å½•çš„å½¢å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root <span class="comment"># tree -h images/alpine:3.10.4</span></span><br><span class="line">images/alpine:3.10.4</span><br><span class="line">â””â”€â”€ [4.0K]  alpine:3.10.4</span><br><span class="line">    â”œâ”€â”€ [2.7M]  4167d3e149762ea326c26fc2fd4e36fdeb7d4e639408ad30f37b8f25ac285a98</span><br><span class="line">    â”œâ”€â”€ [1.5K]  af341ccd2df8b0e2d67cf8dd32e087bfda4e5756ebd1c76bbf3efa0dc246590e</span><br><span class="line">    â”œâ”€â”€ [ 528]  manifest.json</span><br><span class="line">    â””â”€â”€ [  33]  version</span><br></pre></td></tr></table></figure><p> æ ¹æ®é•œåƒæ–‡ä»¶å¤§å°æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼š <code>2.7M</code> å¤§å°çš„ <code>4167d3e1497â€¦â€¦</code> æ–‡ä»¶å°±æ˜¯é•œåƒçš„ layer æ–‡ä»¶ï¼Œç”±äº alpine æ˜¯ä¸€ä¸ª base é•œåƒï¼Œè¯¥ layer å°±æ˜¯ alpine çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼›<code>1.5K</code> å¤§å°çš„ <code>af341ccd2â€¦â€¦</code> æ˜¾è€Œæ˜“è§å°±æ˜¯é•œåƒçš„ images config æ–‡ä»¶ï¼›<code>manifest.json</code> æ–‡ä»¶åˆ™æ˜¯é•œåƒåœ¨ registry å­˜å‚¨ä¸­çš„ manifest.json æ–‡ä»¶ã€‚</p><ul><li>å…ˆåˆ›å»ºè¯¥é•œåƒåœ¨ registry å­˜å‚¨ä¸­çš„ç›®å½•ç»“æ„</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root <span class="comment"># mkdir -p docker/registry/v2/&#123;blobs/sha256,repositories/alpine&#125;</span></span><br><span class="line">root@debian:/root <span class="comment"># tree docker</span></span><br><span class="line">docker</span><br><span class="line">â””â”€â”€ registry</span><br><span class="line">    â””â”€â”€ v2</span><br><span class="line">        â”œâ”€â”€ blobs</span><br><span class="line">        â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">        â””â”€â”€ repositories</span><br><span class="line">            â””â”€â”€ alpine</span><br></pre></td></tr></table></figure><ul><li>æ„å»ºé•œåƒ layer çš„ link æ–‡ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grep -Eo <span class="string">"\b[a-f0-9]&#123;64&#125;\b"</span> images/alpine:3.10.4/manifest.json | sort -u | xargs -L1 -I &#123;&#125; mkdir -p docker/registry/v2/repositories/alpine/_layers/sha256/&#123;&#125;</span><br><span class="line"></span><br><span class="line">grep -Eo <span class="string">"\b[a-f0-9]&#123;64&#125;\b"</span> images/alpine:3.10.4/manifest.json | sort -u | xargs -L1 -I &#123;&#125; sh -c <span class="string">"echo -n 'sha256:&#123;&#125;' &gt; docker/registry/v2/repositories/alpine/_layers/sha256/&#123;&#125;/link"</span></span><br></pre></td></tr></table></figure><ul><li>æ„å»ºé•œåƒ tag çš„ link æ–‡ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">manifests_sha256=$(sha256sum images/alpine:3.10.4/manifest.json | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">mkdir -p docker/registry/v2/repositories/alpine/_manifests/revisions/sha256/<span class="variable">$&#123;manifests_sha256&#125;</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifests_sha256&#125;</span>"</span> &gt; docker/registry/v2/repositories/alpine/_manifests/revisions/sha256/<span class="variable">$&#123;manifests_sha256&#125;</span>/link</span><br><span class="line"></span><br><span class="line">mkdir -p docker/registry/v2/repositories/alpine/_manifests/tags/3.10.4/index/sha256/<span class="variable">$&#123;manifests_sha256&#125;</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifests_sha256&#125;</span>"</span> &gt; docker/registry/v2/repositories/alpine/_manifests/tags/3.10.4/index/sha256/<span class="variable">$&#123;manifests_sha256&#125;</span>/link</span><br><span class="line"></span><br><span class="line">mkdir -p docker/registry/v2/repositories/alpine/_manifests/tags/3.10.4/current</span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifests_sha256&#125;</span>"</span> &gt; docker/registry/v2/repositories/alpine/_manifests/tags/3.10.4/current/link</span><br></pre></td></tr></table></figure><ul><li>æ„å»ºé•œåƒçš„ blobs ç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p docker/registry/v2/blobs/sha256/<span class="variable">$&#123;manifests_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifests_sha256&#125;</span></span><br><span class="line">ln -f images/alpine:3.10.4/manifest.json docker/registry/v2/blobs/sha256/<span class="variable">$&#123;manifests_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifests_sha256&#125;</span>/data</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> layer <span class="keyword">in</span> $(grep -Eo <span class="string">"\b[a-f0-9]&#123;64&#125;\b"</span> images/alpine:3.10.4/manifest.json); <span class="keyword">do</span></span><br><span class="line">    mkdir -p docker/registry/v2/blobs/sha256/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">    ln -f  images/alpine:3.10.4/<span class="variable">$&#123;layer&#125;</span> docker/registry/v2/blobs/sha256/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li>æœ€ç»ˆå¾—åˆ°çš„ registry å­˜å‚¨ç›®å½•å¦‚ä¸‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">docker</span><br><span class="line">â””â”€â”€ registry</span><br><span class="line">    â””â”€â”€ v2</span><br><span class="line">        â”œâ”€â”€ blobs</span><br><span class="line">        â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">        â”‚Â Â      â”œâ”€â”€ 41</span><br><span class="line">        â”‚Â Â      â”‚Â Â  â””â”€â”€ 4167d3e149762ea326c26fc2fd4e36fdeb7d4e639408ad30f37b8f25ac285a98</span><br><span class="line">        â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">        â”‚Â Â      â”œâ”€â”€ af</span><br><span class="line">        â”‚Â Â      â”‚Â Â  â””â”€â”€ af341ccd2df8b0e2d67cf8dd32e087bfda4e5756ebd1c76bbf3efa0dc246590e</span><br><span class="line">        â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">        â”‚Â Â      â””â”€â”€ de</span><br><span class="line">        â”‚Â Â          â””â”€â”€ de78803598bc4c940fc4591d412bffe488205d5d953f94751c6308deeaaa7eb8</span><br><span class="line">        â”‚Â Â              â””â”€â”€ data</span><br><span class="line">        â””â”€â”€ repositories</span><br><span class="line">            â””â”€â”€ alpine</span><br><span class="line">                â”œâ”€â”€ _layers</span><br><span class="line">                â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">                â”‚Â Â      â”œâ”€â”€ 4167d3e149762ea326c26fc2fd4e36fdeb7d4e639408ad30f37b8f25ac285a98</span><br><span class="line">                â”‚Â Â      â”‚Â Â  â””â”€â”€ link</span><br><span class="line">                â”‚Â Â      â””â”€â”€ af341ccd2df8b0e2d67cf8dd32e087bfda4e5756ebd1c76bbf3efa0dc246590e</span><br><span class="line">                â”‚Â Â          â””â”€â”€ link</span><br><span class="line">                â””â”€â”€ _manifests</span><br><span class="line">                    â”œâ”€â”€ revisions</span><br><span class="line">                    â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">                    â”‚Â Â      â””â”€â”€ de78803598bc4c940fc4591d412bffe488205d5d953f94751c6308deeaaa7eb8</span><br><span class="line">                    â”‚Â Â          â””â”€â”€ link</span><br><span class="line">                    â””â”€â”€ tags</span><br><span class="line">                        â””â”€â”€ 3.10.4</span><br><span class="line">                            â”œâ”€â”€ current</span><br><span class="line">                            â”‚Â Â  â””â”€â”€ link</span><br><span class="line">                            â””â”€â”€ index</span><br><span class="line">                                â””â”€â”€ sha256</span><br><span class="line">                                    â””â”€â”€ de78803598bc4c940fc4591d412bffe488205d5d953f94751c6308deeaaa7eb8</span><br><span class="line">                                        â””â”€â”€ link</span><br></pre></td></tr></table></figure><ul><li>æµ‹è¯•æ˜¯å¦æ­£å¸¸ï¼Œæœ¬åœ° docker run ä¸€ä¸ª registry å®¹å™¨ï¼Œå°†åˆšåˆšè½¬æ¢çš„ registry å­˜å‚¨ç›®å½•æŒ‚è½½åˆ°å®¹å™¨çš„ /var/lib/registryï¼Œç„¶åå†ä½¿ç”¨ docker pull çš„æ–¹å¼æ‹‰å–é•œåƒï¼Œåœ¨ä½¿ç”¨ docker run æµ‹è¯•ä¸€ä¸‹èƒ½å¦æ­£å¸¸ä½¿ç”¨ã€‚ç»è¿‡éªŒè¯ä¹‹åç¡®å®å¯ä»¥ä½¿ç”¨ï¼Œé‚£å°±è¯´æ˜è¿™æ ·çš„è½¬æ¢æ˜¯æ²¡æœ‰é—®é¢˜çš„ğŸ˜Šã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root <span class="comment"># docker pull localhost/alpine:3.10.4</span></span><br><span class="line">3.10.4: Pulling from alpine</span><br><span class="line">4167d3e14976: Pull complete</span><br><span class="line">Digest: sha256:de78803598bc4c940fc4591d412bffe488205d5d953f94751c6308deeaaa7eb8</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> localhost/alpine:3.10.4</span><br><span class="line">root@debian:/root <span class="comment"># docker run --rm -it localhost/alpine:3.10.4 cat /etc/os-release</span></span><br><span class="line">NAME=<span class="string">"Alpine Linux"</span></span><br><span class="line">ID=alpine</span><br><span class="line">VERSION_ID=3.10.4</span><br><span class="line">PRETTY_NAME=<span class="string">"Alpine Linux v3.10"</span></span><br><span class="line">HOME_URL=<span class="string">"https://alpinelinux.org/"</span></span><br><span class="line">BUG_REPORT_URL=<span class="string">"https://bugs.alpinelinux.org/"</span></span><br></pre></td></tr></table></figure><ul><li>å°†ä¸Šè¿°æ­¥éª¤æ•´åˆæˆä¸€ä¸ª shell è„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line"></span><br><span class="line">IMAGES_DIR=<span class="string">"images"</span></span><br><span class="line">REGISTRY_DIR=<span class="string">"docker"</span></span><br><span class="line"></span><br><span class="line">rm -rf <span class="variable">$&#123;REGISTRY_DIR&#125;</span></span><br><span class="line">BLOBS_PATH=<span class="string">"<span class="variable">$&#123;REGISTRY_DIR&#125;</span>/registry/v2/blobs"</span></span><br><span class="line">REPO_PATH=<span class="string">"<span class="variable">$&#123;REGISTRY_DIR&#125;</span>/registry/v2/repositories"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> $(find <span class="variable">$&#123;IMAGES_DIR&#125;</span> -<span class="built_in">type</span> f | sed -n <span class="string">'s|/manifest.json||p'</span> | sort -u); <span class="keyword">do</span></span><br><span class="line">    image_name=$(<span class="built_in">echo</span> <span class="variable">$&#123;image%%:*&#125;</span> | sed <span class="string">"s|<span class="variable">$&#123;IMAGES_DIR&#125;</span>/||g"</span>)</span><br><span class="line">    image_tag=<span class="variable">$&#123;image##*:&#125;</span>; mfs=<span class="string">"<span class="variable">$&#123;image&#125;</span>/manifest.json"</span></span><br><span class="line">    mfs_sha256=$(sha256sum <span class="variable">$&#123;image&#125;</span>/manifest.json | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">    mkdir -p <span class="variable">$&#123;BLOBS_PATH&#125;</span>/sha256/<span class="variable">$&#123;mfs_sha256:0:2&#125;</span>/<span class="variable">$&#123;mfs_sha256&#125;</span></span><br><span class="line">    ln -f <span class="variable">$&#123;mfs&#125;</span> <span class="variable">$&#123;BLOBS_PATH&#125;</span>/sha256/<span class="variable">$&#123;mfs_sha256:0:2&#125;</span>/<span class="variable">$&#123;mfs_sha256&#125;</span>/data</span><br><span class="line"></span><br><span class="line">    <span class="comment"># make image repositories dir</span></span><br><span class="line">    mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/&#123;_layers,_manifests/revisions&#125;/sha256</span><br><span class="line">    mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;mfs_sha256&#125;</span></span><br><span class="line">    mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/&#123;current,index/sha256&#125;</span><br><span class="line">    mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;mfs_sha256&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># create image tag manifest link file</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;mfs_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/current/link</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;mfs_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;mfs_sha256&#125;</span>/link</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;mfs_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;mfs_sha256&#125;</span>/link</span><br><span class="line"></span><br><span class="line">    <span class="comment"># link image layers file to registry blobs file</span></span><br><span class="line">    <span class="keyword">for</span> layer <span class="keyword">in</span> $(grep -Eo <span class="string">"\b[a-f0-9]&#123;64&#125;\b"</span> <span class="variable">$&#123;mfs&#125;</span>); <span class="keyword">do</span></span><br><span class="line">        mkdir -p <span class="variable">$&#123;BLOBS_PATH&#125;</span>/sha256/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">        mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;layer&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span>/link</span><br><span class="line">        ln -f <span class="variable">$&#123;image&#125;</span>/<span class="variable">$&#123;layer&#125;</span> <span class="variable">$&#123;BLOBS_PATH&#125;</span>/sha256/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨è¯¥è„šæœ¬å¯¹ images ä¸­æ‰€æœ‰é•œåƒè¿›è¡Œä¸€ä¸‹è½¬æ¢ï¼Œæœ€ç»ˆå¾—åˆ°çš„ registry å­˜å‚¨å¤§å°ä¸º 8.3 Gï¼Œæ¯”ä¹‹å‰å‡å°‘äº† 2.7Gã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root <span class="comment"># du -sh docker</span></span><br><span class="line">8.3Gdocker</span><br><span class="line">root@debian:/root <span class="comment"># find docker -type f -name "data" | wc -l</span></span><br><span class="line">1046</span><br></pre></td></tr></table></figure><h2 id="å†è¿˜åŸå›-Dir-æ ¼å¼"><a href="#å†è¿˜åŸå›-Dir-æ ¼å¼" class="headerlink" title="å†è¿˜åŸå› Dir æ ¼å¼"></a>å†è¿˜åŸå› Dir æ ¼å¼</h2><p>ç»è¿‡ä¸Šè¿°æ­¥éª¤ä¸€ç•ªæŠ˜è…¾ä¹‹åï¼Œå°†è¡¥ä¸åŒ…ä¸­é•œåƒæ–‡ä»¶çš„æ€»å¤§å°çš„ç¡®å®å‡å°‘äº†å¾ˆå¤šï¼Œä½†åŒæ—¶åˆå¼•å…¥äº†å¦ä¸€ä¸ªé—®é¢˜ï¼šskopeo æ— æ³•ç›´æ¥ä½¿ç”¨ registry å­˜å‚¨çš„æ ¼å¼ã€‚å› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å†åšä¸€æ¬¡è½¬æ¢ï¼Œå°†é•œåƒç”± registry å­˜å‚¨çš„æ ¼å¼è¿˜åŸå› skopeo æ‰€æ”¯æŒçš„ dir æ ¼å¼ã€‚è‡³äºè¿˜åŸçš„åŸç†å’Œæ–¹æ³•æˆ‘åœ¨ <a href="https://blog.k8s.li/docker-registry-to-harbor.html">docker registry è¿ç§»è‡³ harbor</a> ä¸­æœ‰è¯¦ç»†åœ°ä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å†å»çœ‹ä¸€ä¸‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">REGISTRY_DOMAIN=<span class="string">"harbor.k8s.li"</span></span><br><span class="line">REGISTRY_PATH=<span class="string">"/var/lib/registry"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ‡æ¢åˆ° registry å­˜å‚¨ä¸»ç›®å½•ä¸‹</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;REGISTRY_PATH&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">gen_skopeo_dir</span></span>() &#123;</span><br><span class="line">   <span class="comment"># å®šä¹‰ registry å­˜å‚¨çš„ blob ç›®å½• å’Œ repositories ç›®å½•ï¼Œæ–¹ä¾¿åé¢ä½¿ç”¨</span></span><br><span class="line">    BLOB_DIR=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">    REPO_DIR=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line">    <span class="comment"># å®šä¹‰ç”Ÿæˆ skopeo ç›®å½•</span></span><br><span class="line">    SKOPEO_DIR=<span class="string">"docker/skopeo"</span></span><br><span class="line">    <span class="comment"># é€šè¿‡ find å‡º current æ–‡ä»¶å¤¹å¯ä»¥å¾—åˆ°æ‰€æœ‰å¸¦ tag çš„é•œåƒï¼Œå› ä¸ºä¸€ä¸ª tag å¯¹åº”ä¸€ä¸ª current ç›®å½•</span></span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> $(find <span class="variable">$&#123;REPO_DIR&#125;</span> -<span class="built_in">type</span> d -name <span class="string">"current"</span>); <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># æ ¹æ®é•œåƒçš„ tag æå–é•œåƒçš„åå­—</span></span><br><span class="line">        name=$(<span class="built_in">echo</span> <span class="variable">$&#123;image&#125;</span> | awk -F <span class="string">'/'</span> <span class="string">'&#123;print $5"/"$6":"$9&#125;'</span>)</span><br><span class="line">        link=$(cat <span class="variable">$&#123;image&#125;</span>/link | sed <span class="string">'s/sha256://'</span>)</span><br><span class="line">        mfs=<span class="string">"<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;link:0:2&#125;</span>/<span class="variable">$&#123;link&#125;</span>/data"</span></span><br><span class="line">        <span class="comment"># åˆ›å»ºé•œåƒçš„ç¡¬é“¾æ¥éœ€è¦çš„ç›®å½•</span></span><br><span class="line">        mkdir -p <span class="string">"<span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>"</span></span><br><span class="line">        <span class="comment"># ç¡¬é“¾æ¥é•œåƒçš„ manifests æ–‡ä»¶åˆ°ç›®å½•çš„ manifest æ–‡ä»¶</span></span><br><span class="line">        ln <span class="variable">$&#123;mfs&#125;</span> <span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>/manifest.json</span><br><span class="line">        <span class="comment"># ä½¿ç”¨æ­£åˆ™åŒ¹é…å‡ºæ‰€æœ‰çš„ sha256 å€¼ï¼Œç„¶åæ’åºå»é‡</span></span><br><span class="line">        layers=$(grep -Eo <span class="string">"\b[a-f0-9]&#123;64&#125;\b"</span> <span class="variable">$&#123;mfs&#125;</span> | sort -u)</span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> <span class="variable">$&#123;layers&#125;</span>; <span class="keyword">do</span></span><br><span class="line">          <span class="comment"># ç¡¬é“¾æ¥ registry å­˜å‚¨ç›®å½•é‡Œçš„é•œåƒ layer å’Œ images config åˆ°é•œåƒçš„ dir ç›®å½•</span></span><br><span class="line">            ln <span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data <span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">sync_image</span></span>() &#123;</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ skopeo sync å°† dir æ ¼å¼çš„é•œåƒåŒæ­¥åˆ° harbor</span></span><br><span class="line">    <span class="keyword">for</span> project <span class="keyword">in</span> $(ls <span class="variable">$&#123;SKOPEO_DIR&#125;</span>); <span class="keyword">do</span></span><br><span class="line">        skopeo sync --insecure-policy --src-tls-verify=<span class="literal">false</span> --dest-tls-verify=<span class="literal">false</span> \</span><br><span class="line">        --src dir --dest docker <span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;project&#125;</span> <span class="variable">$&#123;REGISTRY_DOMAIN&#125;</span>/<span class="variable">$&#123;project&#125;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gen_skopeo_dir</span><br><span class="line">sync_image</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;è‹¦å‘½æ‰“åŒ…å·¥å…·äººğŸ˜­&quot;&gt;&lt;a
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="registry" scheme="https://blog.k8s.li/tags/registry/"/>
    
      <category term="image" scheme="https://blog.k8s.li/tags/image/"/>
    
  </entry>
  
  <entry>
    <title>python-gitlab CLI ä½¿ç”¨è®°å½•</title>
    <link href="https://blog.k8s.li/gitlab-cli.html"/>
    <id>https://blog.k8s.li/gitlab-cli.html</id>
    <published>2021-03-22T16:00:00.000Z</published>
    <updated>2021-03-19T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼€å€’è½¦-ğŸš—-ï¼Ÿ"><a href="#å¼€å€’è½¦-ğŸš—-ï¼Ÿ" class="headerlink" title="å¼€å€’è½¦ ğŸš— ï¼Ÿ"></a>å¼€å€’è½¦ ğŸš— ï¼Ÿ</h2><p>å¹´åè¿™å‡ å‘¨èŠ±äº†ä¸¤å‘¨å·¦å³çš„æ—¶é—´å°†æˆ‘å¸çš„ GitHub ä»£ç è¿ç§»åˆ°å†…éƒ¨çš„ Gitlabã€‚å½±å“æœ€å¤§çš„å°±æ˜¯æˆ‘ä»¬äº§å“çš„å‘å¸ƒæµæ°´çº¿ï¼Œéœ€è¦é€‚é… Gitlab å’Œå†…ç½‘ç¯å¢ƒçš„ä¸€äº›æœåŠ¡ã€‚åŸºæœ¬ä¸Šæ•´ä¸ªäº§å“æ‰“åŒ…å‘å¸ƒçš„æµæ°´çº¿ä»£ç å…¨éƒ¨é‡å†™äº†ä¸€éï¼Œå¯ç´¯åå’±äº†ğŸ¥ºã€‚å½“æ—¶å¿ƒé‡Œè¿˜è®¤ä¸ºä»£ç è¿ç§»è‡³ Gitlab çº¯å±å€’è½¦è¡Œä¸ºğŸ˜…ï¼Œä¸è¿‡ç­‰åˆ°æ‰€æœ‰çš„é€‚é…ä¿®æ”¹å®Œæ¯•åå¿½ç„¶å‘ç° Gitlab çœŸé¦™ï¼</p><p>å½’æ ¹ç»“åº•å†…ç½‘çš„ Gitlab ç½‘ç»œçŠ¶å†µåå€ç™¾å€ä¸ GitHub ä¸æ­¢ã€‚ä¼—æ‰€å‘¨çŸ¥åœ¨å­¦ä¹ <strong>å¢™å›½</strong>ï¼ŒGitHub ç›´è¿çš„é€Ÿåº¦å’Œç¨³å®šæ€§å·®çš„ä¸€æ‰¹ã€‚ä¹Ÿæ­£å› æ­¤ä¹‹å‰åœ¨ GitHub ä¸Šçš„æµæ°´çº¿ç»å¸¸ä¼šè¢«ç½‘ç»œæŠ–åŠ¨æ‰€å¹²æ‰°ï¼Œæœ‰æ—¶ä¾¯ fetch ä¸€ä¸ª repo åå‡ äºŒååˆ†é’Ÿï¼è¿ç§»åˆ°å†…ç½‘ Gitlab ä¹‹åï¼Œé‚£é€Ÿåº¦ç®€ç›´é£èµ·ï¼ä»¥å¾€æœ€å°‘åå‡ åˆ†é’Ÿçš„æµæ°´çº¿ç°åœ¨åªéœ€è¦ä¸åˆ°äº”åˆ†é’Ÿå°±èƒ½å®ŒæˆğŸ˜‚ã€‚</p><p>äºæ˜¯ä»Šå¤©å°±å†™ç¯‡åšå®¢è®°å½•ä¸€ä¸‹å½“æ—¶æŠ˜è…¾ Gitlab æ—¶æ”¶è·çš„ä¸€ç‚¹äººç”Ÿç»éªŒğŸ‘“</p><blockquote><p>æˆ‘ä»Šå¤©æ˜¯ä½œä¸ºä¸€ä¸ªé•¿è€…ç»™ä½ ä»¬è®²çš„ï¼Œæˆ‘ä¸æ˜¯æ–°é—»å·¥ä½œè€…ï¼Œä½†æ˜¯æˆ‘è§å¾—å¤ªå¤šäº†ï¼Œæˆ‘æœ‰è¿™ä¸ªå¿…è¦å‘Šè¯‰ä½ ä»¬ä¸€ç‚¹äººç”Ÿçš„ç»éªŒ</p></blockquote><h2 id="Gitlab"><a href="#Gitlab" class="headerlink" title="Gitlab"></a>Gitlab</h2><p>åœ¨æŠ˜è…¾çš„è¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°çš„æœ‰å…³ Gitlab çš„æ–‡æ¡£å’Œå·¥å…·ï¼š</p><ul><li><a href="https://about.gitlab.com/topics/version-control/what-is-gitlab-workflow/" target="_blank" rel="noopener">Gitlab workflow</a>ï¼šäº†è§£ä¸€ä¸‹ Gitlab çš„å·¥ä½œæµï¼Œä¸åŒäº GitHub çš„ PRï¼Œåœ¨ Gitlab ä¸­ä½¿ç”¨çš„æ˜¯ MR çš„æ–¹å¼ï¼›</li><li><a href="https://docs.gitlab.com/ee/api/README.html" target="_blank" rel="noopener">Gitlab API</a>ï¼šGitlab API çš„å®˜æ–¹æ–‡æ¡£ï¼Œäº†è§£å®ƒåœ¨ä½¿ç”¨ä¸‹ä¸‹é¢è¿™äº›å·¥å…·æ—¶å€™ä¼šå¾—å¿ƒåº”æ‰‹ã€‚</li><li><a href="https://python-gitlab.readthedocs.io/en/stable/api-objects.html" target="_blank" rel="noopener">python-gitlab</a> API clientï¼šä½¿ç”¨ Python å®ç°çš„ Gitlab API clientï¼Œç”¨å®ƒæ¥å®Œæˆä¸€äº›ç‰¹å®šéœ€æ±‚å·¥å…·çš„å¼€å‘ï¼Œæ¯”å¦‚æ ¹æ® tag æˆ–è€… branchè·å– repo ä¸­æŒ‡å®šçš„æ–‡ä»¶æˆ–ç›®å½•ï¼›</li><li><a href="https://python-gitlab.readthedocs.io/" target="_blank" rel="noopener">python-gitlab</a> CLIï¼šåŸºäº <a href="https://python-gitlab.readthedocs.io/en/stable/api-objects.html" target="_blank" rel="noopener">python-gitlab</a> API client å°è£…æˆçš„å‘½ä»¤è¡Œå·¥å…·ï¼Œå› ä¸ºæ˜¯ CLI å·¥å…·æ‰€ä»¥å¯ä»¥å¾ˆæ–¹ä¾¿åœ°é›†æˆåœ¨ä¸€äº›æµæ°´çº¿çš„è„šæœ¬ä¸­ï¼›</li><li><a href="https://github.com/xanzy/go-gitlab" target="_blank" rel="noopener">go-gitlab</a> API clientï¼šä½¿ç”¨ Golang å®ç°çš„ Gitlab API clientã€‚ç”±äºå‘å¸ƒæµæ°´çº¿ä¸­çš„ä¸€ä¸ªé˜¶æ®µå°±æ˜¯æ ¹æ®ä¸€ä¸ª list æ¥æ”¶é›†å…¶ä»– repo ä¸­çš„ç‰¹å®šæ–‡ä»¶å’Œç›®å½•ï¼Œä½¿ç”¨çš„å·¥å…·æ˜¯ golang å†™çš„ï¼Œä¸ºäº†å‡å°‘ä»£ç ä¿®æ”¹é‡å°±ä½¿ç”¨äº† go-gitlab è€Œä¸æ˜¯ python-gitlabã€‚</li></ul><h2 id="Gitlab-workflow"><a href="#Gitlab-workflow" class="headerlink" title="Gitlab workflow"></a><a href="https://about.gitlab.com/topics/version-control/what-is-gitlab-workflow/" target="_blank" rel="noopener">Gitlab workflow</a></h2><h3 id="PR"><a href="#PR" class="headerlink" title="PR"></a>PR</h3><p>åœ¨ GitHub ä¸Šæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨ PR çš„æ–¹å¼æ¥å®Œæˆä»£ç åˆå¹¶å·¥ä½œï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æˆå‘˜ Fork åŸå§‹ä»“åº“ï¼Œå°† Fork å‡ºæ¥çš„ä»“åº“ clone åˆ°æœ¬åœ°</li><li>åœ¨æœ¬åœ°åˆ›å»ºæ–°åˆ†æ”¯ï¼Œå¹¶åŸºäºæ–°åˆ†æ”¯è¿›è¡Œä¿®æ”¹å’Œæäº¤ï¼Œæ¨é€æ–°åˆ†æ”¯åˆ° Fork çš„ä»“åº“</li><li>åŸºäº Fork ä»“åº“ä¸­çš„æ–°åˆ†æ”¯å‘åŸå§‹ä»“åº“çš„ç›®æ ‡åˆ†æ”¯å‘èµ· Pull Request</li><li>åœ¨ PR çš„è¯„è®ºä¸­ @ å®¡æŸ¥è€…ï¼Œè¯·æ±‚ review ä¿®æ”¹</li><li>å®¡æŸ¥è€…æ”¶åˆ°è¯·æ±‚é‚®ä»¶ï¼Œå®¡æŸ¥ä»£ç ï¼Œå¹¶åœ¨å»ºè®®å¤„ç›´æ¥åšå‡ºè¯„è®º</li><li>æäº¤è€…æ ¹æ®å»ºè®®ï¼Œç»§ç»­æäº¤æ”¹åŠ¨ï¼Œå¹¶å¯¹æ„è§ä½œå‡ºå›åº”</li><li>å®¡æŸ¥è€…æ— å¼‚è®®åï¼Œåœ¨ PR çš„è¯„è®ºä¸­ @ ç®¡ç†å‘˜ï¼Œè¯·æ±‚åˆå…¥ä»£ç ï¼Œç®¡ç†å‘˜æ¥å— PRï¼Œä»£ç åˆå…¥ä¸»åˆ†æ”¯</li></ul><h3 id="MR"><a href="#MR" class="headerlink" title="MR"></a>MR</h3><p>ä½†æ˜¯åˆ°äº† Gitlab ä¹‹åæˆ‘ä»¬å°±ä½¿ç”¨ MR çš„æ–¹å¼æ¥å®Œæˆä»£ç åˆå¹¶å·¥ä½œï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æˆå‘˜ Clone åŸå§‹ä»“åº“åˆ°æœ¬åœ°ï¼ŒåŸºäºè¦ä¿®æ”¹çš„åˆ†æ”¯ï¼Œåˆ›å»ºæ–°çš„åˆ†æ”¯</li><li>æœ¬åœ°ä¿®æ”¹å’Œæäº¤ï¼Œæ¨é€æ–°åˆ†æ”¯åˆ°åŸå§‹ä»“åº“</li><li>åœ¨åŸå§‹ä»“åº“ä¸­åŸºäºæ–°åˆ†æ”¯å‘ç›®æ ‡ä¿æŠ¤åˆ†æ”¯å‘èµ· Merge Request</li><li>å®¡æ ¸è€… review ä»£ç ï¼Œç®¡ç†å‘˜ Merge ä»£ç </li></ul><p>ç›¸æ¯”æ¥è®² MR å’Œæ–¹å¼æ›´é€‚åˆå›¢é˜Ÿå†…éƒ¨çš„åä½œå¼€å‘ï¼ŒPR çš„æ–¹å¼é€‚åˆå¼€æºé¡¹ç›®çš„åä½œå¼€å‘ã€‚</p><h2 id="Gitlab-API"><a href="#Gitlab-API" class="headerlink" title="Gitlab API"></a><a href="https://docs.gitlab.com/ee/api/README.html" target="_blank" rel="noopener">Gitlab</a> API</h2><blockquote><p>The main GitLab API is a <a href="http://spec.openapis.org/oas/v3.0.3" target="_blank" rel="noopener">REST</a> API. Because of this, the documentation in this section assumes that youâ€™re familiar with REST concepts.</p></blockquote><p>å‚ç…§å®˜æ–¹æ–‡æ¡£ <a href="https://docs.gitlab.com/ee/api/api_resources.html" target="_blank" rel="noopener">API resources</a> å¯çŸ¥ï¼Œå…±æœ‰ Projects ã€Groupsã€Standalone è¿™ä¸‰ç§ API åˆ†ç»„ã€‚</p><ul><li>Projectsï¼š å¯¹åº”çš„å°±æ˜¯ä¸ repo ç›¸å…³çš„ API ï¼Œæ¯”å¦‚ tagã€commitã€branch ã€MRã€Issue è¿™ä¸€ç±»å‹ï¼›</li><li>Groupsï¼š å¯¹åº”ç±»ä¼¼äº GitHub ä¸Šçš„ Organizationsï¼Œä¸€èˆ¬æ¥è®²å…¬å¸é‡Œçš„ repo éƒ½ä¼šæŒ‰ç…§å›¢é˜Ÿæ¥åˆ’åˆ†ç»„ç»‡ï¼ŒåŒä¸€å›¢é˜Ÿé‡Œçš„ repo ä¼šæ”¾åœ¨ gitlab åŒä¸€ä¸ª Groups  ä¸‹ï¼Œè€Œä¸æ˜¯ä»¥ä¸ªäººä¸ºå•ä½å­˜æ”¾ repoï¼›</li><li>Standaloneï¼šåˆ™æ˜¯é™¤äº† Projects å’Œ Groups ä¹‹å¤–çš„ API èµ„æºï¼Œå¦‚ user</li></ul><p>è€Œæˆ‘ä»¬å¤šæ•°æƒ…å†µä¸‹ä½¿ç”¨çš„æ˜¯ Projects ç›¸å…³çš„ APIï¼Œé€šè¿‡å®ƒæ¥å¯¹ repo è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚ç®€å•ä»‹ç»å®Œ Gitlab API ç±»å‹ä¹‹åï¼Œæœ¬æ–‡ä¼šä»‹ç»å‡ ç§ä½¿ç”¨ Gitlab API çš„å·¥å…·ã€‚åœ¨ä½¿ç”¨è¿™äº›å·¥å…·çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ°ä¸€äº›é”™è¯¯å¯ä»¥é€šè¿‡ <a href="https://docs.gitlab.com/ee/api/README.html#status-codes" target="_blank" rel="noopener">Status codes</a> API è¿”å›çŠ¶æ€ç æ¥æ’æŸ¥é—®é¢˜ã€‚</p><h2 id="python-gitlab-CLI"><a href="#python-gitlab-CLI" class="headerlink" title="python-gitlab CLI"></a><a href="https://python-gitlab.readthedocs.io/" target="_blank" rel="noopener">python-gitlab</a> CLI</h2><p>è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ <a href="https://python-gitlab.readthedocs.io/en/stable/api-objects.html" target="_blank" rel="noopener">python-gitlab</a> API client å°è£…å¥½çš„ gitlab å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯ä»¥ä½¿ç”¨å®ƒæ¥å®Œæˆç»å¤§å¤šæ•° Gitlab API æ‰€æ”¯æŒçš„æ“ä½œã€‚å› ä¸ºä¹‹å‰çš„æµæ°´çº¿ä¸­æœ‰å¾ˆå¤šæ“ä½œæ˜¯è®¿é—®çš„ GitHubï¼Œæ¯”å¦‚æäº¤ PRã€è·å– repo tagã€æŸ¥çœ‹ PR labels ç­‰ï¼Œéƒ½æ˜¯å†™åœ¨ Jenkinsfile è°ƒç”¨å„ç§è„šæœ¬å’Œå·¥å…·æ¥å®Œæˆçš„ã€‚ åˆ‡æ¢åˆ°äº† Gitlabï¼Œè‡ªç„¶ä¹Ÿéœ€è¦ä¸€ä¸ªå·¥å…·æ¥å®Œæˆä¸Šè¿°æ“ä½œäº†ã€‚é‚£ä¹ˆ python-gitlab CLI è¿™ä¸ªå·¥å…·æ— ç–‘æ˜¯ä¸äºŒä¹‹é€‰ï¼Œç”šè‡³æ¯”ä¹‹å‰çš„å·¥å…·æ›´æ–¹ä¾¿ã€‚å› ä¸ºè¿„ä»Šä¸ºæ­¢è¿˜æ²¡æœ‰è§åˆ°è¿‡ GitHub èƒ½æœ‰åƒ python-gitlab è¿™æ ·çš„å·¥å…·ã€‚æ€»ä¹‹ï¼Œå¯¹äºä½¿ç”¨ Gitlab çš„äººæ¥è®²ï¼Œè¦å¯¹ repo å®Œæˆä¸€äº›è‡ªåŠ¨åŒ–å¤„ç†çš„å·¥ä½œï¼Œå¼ºçƒˆæ¨èä½¿ç”¨è¿™ä¸ª CLI å·¥å…·ï¼Œå®ƒå¯ä»¥å¾ˆæ–¹ä¾¿åœ°é›†æˆåœ¨æµæ°´çº¿ä¸­ã€‚</p><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>python-gitlab CLI ä¾èµ– Python 2.7 æˆ–è€… 3.4+ï¼Œ2021 å¹´å•¦ï¼Œå°±ä¸è¦ä½¿ç”¨ Python2.7 å•¦ğŸ˜Šã€‚æœ¬åœ°å®‰è£…å¥½ python3 å’Œ pip3 åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨è¿™é‡Œä½¿ç”¨æ¸…åçš„ pypi æºæ¥åŠ é€Ÿå®‰è£…ï¼Œæ¯•ç«Ÿæ˜¯å¢™ğŸ§±å›½</span></span><br><span class="line">$ sudo pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple requests PyYAML python-gitlab</span><br></pre></td></tr></table></figure><p>ç”±äºä½¿ç”¨è¿™ä¸ªå·¥å…·çš„åœºæ™¯å¤§å¤šæ•°æ˜¯åœ¨ Jenkins æ‰€åˆ›å»ºçš„ slave pod ä¸­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥æ„å»ºä¸€ä¸ª docker é•œåƒï¼Œ <code>Dockerfile</code> å¦‚ä¸‹</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:buster</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install -y --no-install-recommends \</span></span><br><span class="line"><span class="bash">        git \</span></span><br><span class="line"><span class="bash">        python3 \</span></span><br><span class="line"><span class="bash">        python3-pip \</span></span><br><span class="line"><span class="bash">        jq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple requests PyYAML python-gitlab</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> python-gitlab.cfg /etc/python-gitlab.cfg</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>Gitlab CLI å·¥å…·éœ€è¦ä½¿ç”¨ä¸€ä¸ª <code>python-gitlab.cfg</code> é…ç½®æ–‡ä»¶ç”¨äºè¿æ¥ Gitlab æœåŠ¡å™¨ä»¥åŠå®Œæˆä¸€äº›é‰´æƒè®¤è¯ï¼Œé…ç½®æ–‡ä»¶æ ¼å¼ä¸º <code>ini</code> å¦‚ä¸‹ï¼š</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[global]</span></span><br><span class="line"><span class="attr">default</span> = gitlab.com</span><br><span class="line"><span class="attr">ssl_verify</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">timeout</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">per_page</span> = <span class="number">100</span></span><br><span class="line"><span class="attr">api_version</span> = <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="section">[gitlab.com]</span></span><br><span class="line"><span class="attr">url</span> = https://gitlab.com</span><br><span class="line"><span class="attr">private_token</span> = xxxxxxxxx</span><br></pre></td></tr></table></figure><ul><li>å…¨å±€çš„è¿æ¥å‚æ•°</li></ul><table><thead><tr><th>Option</th><th>Possible values</th><th>Description</th></tr></thead><tbody><tr><td><code>ssl_verify</code></td><td><code>True</code> æˆ– <code>False</code></td><td>æ˜¯å¦å¼€å¯ SSL åŠ å¯†éªŒè¯</td></tr><tr><td><code>timeout</code></td><td>è¯ä¹¦</td><td>è¿æ¥è¶…æ—¶æ—¶é—´</td></tr><tr><td><code>api_version</code></td><td><code>4</code></td><td>API çš„ç‰ˆæœ¬ï¼Œé»˜è®¤ä¸º 4 å³å¯ï¼Œå‚è€ƒ <a href="https://docs.gitlab.com/ee/api/v3_to_v4.html" target="_blank" rel="noopener">API V3 to API V4</a></td></tr><tr><td><code>per_page</code></td><td>1 ï½ 100</td><td>æ¯æ¬¡è¿”å›çš„å…ƒç´ æ•°é‡ï¼ŒGitlab çš„æœ€å¤§é™åˆ¶ä¸º 100ã€‚å¯ä»¥é€šè¿‡ <code>--all</code> å‚æ•°è·å–æ‰€æœ‰çš„å…ƒç´ </td></tr></tbody></table><ul><li>è‡ªå®šä¹‰ GitLab server å‚æ•°</li></ul><table><thead><tr><th>Option</th><th>Description</th></tr></thead><tbody><tr><td><code>url</code></td><td>GitLab server çš„ URL</td></tr><tr><td><code>private_token</code></td><td>é€šè¿‡è®¿é—® gitlab æœåŠ¡å™¨çš„ <a href="https://gitlab.com/-/profile/personal_access_tokens" target="_blank" rel="noopener">-/profile/personal_access_tokens</a> æ¥ç”Ÿæˆ token</td></tr><tr><td><code>oauth_token</code></td><td></td></tr><tr><td><code>job_token</code></td><td></td></tr><tr><td><code>api_version</code></td><td>API çš„ç‰ˆæœ¬ï¼Œé»˜è®¤ä¸º 4 å³å¯ï¼Œä¹Ÿå¯ä»¥ä¸ç”¨å®šä¹‰ï¼Œä½¿ç”¨å…¨å±€å‚æ•°</td></tr><tr><td><code>http_username</code></td><td>Gitlab ç”¨æˆ·åï¼Œä¸æ¨èä½¿ç”¨å®ƒæ¥è¿æ¥ Gitlab æœåŠ¡å™¨</td></tr><tr><td><code>http_password</code></td><td>Gitlab å¯†ç ï¼Œä¸æ¨èä½¿ç”¨å®ƒæ¥è¿æ¥ Gitlab æœåŠ¡å™¨</td></tr></tbody></table><p>å°†æ–‡ä»¶ä¿å­˜åœ¨ <code>~/.python-gitlab.cfg</code> æˆ–è€… <code>/etc/python-gitlab.cfg</code> ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡ <code>PYTHON_GITLAB_CFG</code> æˆ–è€… <code>--config-file</code> æ‰§è¡Œé…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼Œä¸ºäº†çœäº‹å„¿è¿˜æ˜¯å°†å®ƒæ”¾åˆ° <code>~/.python-gitlab.cfg</code> ä¸‹ã€‚</p><p>é…ç½®å®Œæˆä¹‹åï¼Œå¯ä»¥ä½¿ç”¨ <code>gitlab current-user get</code> å‘½ä»¤æµ‹è¯•è¿æ¥æ˜¯å¦æ­£å¸¸ï¼Œå¦‚æœæœ‰è¿”å›å€¼ä¸”æ­£ç¡®çš„ç”¨æˆ·åè¯´æ˜é…ç½®æˆåŠŸäº†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab current-user get</span><br><span class="line">username: muzi502</span><br></pre></td></tr></table></figure><h3 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h3><p>gitlab å‘½ä»¤è¡Œå·¥å…·ä¸»è¦æ˜¯å¯¹ Gitlab æœåŠ¡å™¨ä¸Šçš„å„ç§å¯¹è±¡å¦‚ï¼šuser, project, file, repo, mr, tag, commit ç­‰è¿›è¡Œå¢åˆ æ”¹æŸ¥(getã€listã€createã€deleteã€update)ã€‚ä½¿ç”¨çš„å‘½ä»¤è¡Œæ ¼å¼æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab &lt;option&gt; [object] [action] &lt;option&gt;</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æ¥è®²åªéœ€è¦ 4 ç§å‚æ•°ï¼š</p><ul><li><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç´§æ¥ç€ gitlab å‘½ä»¤åé¢çš„å‚æ•°ï¼Œå®ƒæ˜¯ gitlab å‘½ä»¤è¡Œçš„è¾“å‡ºå‚æ•°å’Œé…ç½®å‚æ•°ï¼Œå¦‚ <code>-o</code>å‚æ•°æŒ‡å®šè¾“å‡ºç»“æœçš„æ ¼å¼ï¼›<code>-f</code> å‚æ•°å°†è¾“å‡ºç»“æœå­˜æ”¾åˆ°æ–‡ä»¶ä¸­; <code>-g</code> å‚æ•°æ‰§è¡Œè¿æ¥å“ªä¸ª Gitlab æœåŠ¡å™¨ã€‚</p></li><li><p>ç¬¬äºŒä¸ªå‚æ•°åˆ™æ˜¯ç”¨æ¥æŒ‡å®šæ‰€è¦æ“ä½œçš„å¯¹è±¡ï¼Œæ¯”å¦‚ project-merge-requestï¼Œproject-tag ç­‰ï¼Œæ‰€æ”¯æŒçš„å¯¹è±¡æœ‰å¾ˆå¤šï¼ŒåŸºæœ¬ä¸Šæ¶µç›–äº†æ‰€æœ‰ Gitlab API æ‰€æ”¯æŒçš„æ“ä½œå¯¹è±¡ï¼Œå¦‚ä¸‹ï¼š</p></li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab -h</span><br><span class="line">usage: gitlab [-h] [--version] [-v] [-d] [-c CONFIG_FILE] [-g GITLAB] [-o &#123;json,legacy,yaml&#125;] [-f FIELDS]</span><br><span class="line">&#123;application,application-appearance,application-settings,audit-event,broadcast-message,current-user,current-user-email,current-user-gp-gkey,current-user-key,current-user-status,deploy-key,deploy-token,dockerfile,event,feature,geo-node,gitignore,gitlabciyml,group,group-access-request,group-badge,group-board,group-board-list,group-cluster,group-custom-attribute,group-deploy-token,group-epic,group-epic-issue,group-epic-resource-label-event,group-export,group-import,group-issue,group-label,group-member,group-merge-request,group-milestone,group-notification-settings,group-package,group-project,group-runner,group-subgroup,group-variable,hook,issue,l-da-pgroup,license,merge-request,namespace,notification-settings,pages-domain,project,project-access-request,project-additional-statistics,project-approval,project-approval-rule,project-badge,project-board,project-board-list,project-branch,project-cluster,project-commit,project-commit-comment,project-commit-discussion,project-commit-discussion-note,project-commit-status,project-custom-attribute,project-deploy-token,project-deployment,project-environment,project-event,project-export,project-file,project-fork,project-hook,project-import,project-issue,project-issue-award-emoji,project-issue-discussion,project-issue-discussion-note,project-issue-link,project-issue-note,project-issue-note-award-emoji,project-issue-resource-label-event,project-issue-resource-milestone-event,project-issues-statistics,project-job,project-key,project-label,project-member,project-merge-request,project-merge-request-approval,project-merge-request-approval-rule,project-merge-request-award-emoji,project-merge-request-diff,project-merge-request-discussion,project-merge-request-discussion-note,project-merge-request-note,project-merge-request-note-award-emoji,project-merge-request-resource-label-event,project-merge-request-resource-milestone-event,project-milestone,project-note,project-notification-settings,project-package,project-pages-domain,project-pipeline,project-pipeline-bridge,project-pipeline-job,project-pipeline-schedule,project-pipeline-schedule-variable,project-pipeline-variable,project-protected-branch,project-protected-tag,project-push-rules,project-registry-repository,project-registry-tag,project-release,project-remote-mirror,project-runner,project-service,project-snippet,project-snippet-award-emoji,project-snippet-discussion,project-snippet-discussion-note,project-snippet-note,project-snippet-note-award-emoji,project-tag,project-trigger,project-user,project-variable,project-wiki,runner,runner-job,snippet,todo,user,user-activities,user-custom-attribute,user-email,user-event,user-gp-gkey,user-impersonation-token,user-key,user-membership,user-project,user-status,variable&#125;</span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸‰ä¸ªå‚æ•°åˆ™æ˜¯ action å‚æ•°ï¼Œå³ç”¨äºæŒ‡å®šå¯¹æ‰€æ“ä½œçš„å¯¹è±¡è¿›è¡Œä½•ç§æ“ä½œï¼Œä¸€èˆ¬æ¥è®²éƒ½ä¼šæ”¯æŒå¢åˆ æ”¹æŸ¥æ“ä½œï¼ˆget, list, create, update, deleteï¼‰</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab project-tag</span><br><span class="line">usage: gitlab project-tag [-h] &#123;list,get,create,delete,<span class="built_in">set</span>-release-description&#125; ...</span><br></pre></td></tr></table></figure><ul><li>ç¬¬ä¸‰ä¸ªå‚æ•°åˆ™æ˜¯ object + action æ‰€ä¾èµ–çš„å‚æ•°ï¼Œæ¯”å¦‚æŒ‡å®š project id</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab project-tag list</span><br><span class="line">usage: gitlab project-tag list --project-id PROJECT_ID [--page PAGE] [--per-page PER_PAGE] [--all]</span><br><span class="line">gitlab project-tag list: error: the following arguments are required: --project-id</span><br></pre></td></tr></table></figure><ul><li><p>Project-IDï¼šæ˜¯ gitlab ä¸Šå”¯ä¸€è¡¨ç¤ºè¯¥ repo çš„ IDï¼Œå¯åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯ <code>group/project</code> çš„å½¢å¼ï¼Œå…¶ä¸­ <code>/</code> è¦è½¬è¯‘æˆ <code>%2F</code> å¦‚ï¼š<code>muzi502%2Fkubespray</code>ï¼›å¦ä¸€ç§åˆ™æ˜¯æ•°å­—çš„å½¢å¼ï¼Œåœ¨è¯¥ repo çš„ web é¡µé¢ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œæ¨èä½¿ç”¨ç¬¬äºŒç§ã€‚</p><p><img src="https://p.k8s.li/image-20210319085926423.png" alt="image-20210319085926423"></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥ä½¿ç”¨gitlab å‘½ä»¤è·å– repo çš„ id</span></span><br><span class="line">$ gitlab project get --id muzi502%2Fkubespray</span><br><span class="line">id: 25099880</span><br><span class="line">path: kubespray</span><br></pre></td></tr></table></figure><ul><li>åœ¨æµæ°´çº¿ä¸­å¯ä»¥æ ¹æ® token è·å–ç”¨æˆ·çš„ç”¨æˆ·åå’Œé‚®ç®±ï¼Œç”¨äºé…ç½®æµæ°´çº¿ä¸­çš„ repo git ä¿¡æ¯ï¼Œé¿å…å› ä¸º CLA æ— æ³•é€šè¿‡ã€‚</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gitlab -o json current-user get | jq '.id'</span><br><span class="line">git config --global user.email $(gitlab -o json current-user get | jq -r '.email')</span><br><span class="line">git config --global user.name $(gitlab -o json current-user get | jq -r '.username')</span><br></pre></td></tr></table></figure><h3 id="project"><a href="#project" class="headerlink" title="project"></a>project</h3><ul><li>è·å– repo ssh url  åœ°å€</li></ul><p>ç”±äº Jenkins æµæ°´çº¿ä¸­ clone çš„ repo url æ˜¯ä½¿ç”¨ token+ https çš„æ–¹å¼ï¼Œåœ¨æµæ°´çº¿ä¸­å¦‚æœè¦ push ä»£ç åˆ° repo éœ€è¦ä¿®æ”¹ä¸º ssh çš„æ–¹å¼ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æ ¹æ® project id æ¥è·å–è¯¥ repo çš„ ssh urlã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab -o json  project get --id <span class="variable">$&#123;PROJECT_ID&#125;</span> | jq -r <span class="string">'.ssh_url_to_repo'</span></span><br><span class="line">$ git remote remove origin</span><br><span class="line">$ git remote add origin $(gitlab -o json  project get --id <span class="variable">$&#123;PROJECT_ID&#125;</span> | jq -r <span class="string">'.ssh_url_to_repo'</span>)</span><br></pre></td></tr></table></figure><h3 id="file"><a href="#file" class="headerlink" title="file"></a>file</h3><p>å¯¹äº repo ä¸­æ–‡ä»¶çš„æ“ä½œä½¿ç”¨ project-file</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab project-file</span><br><span class="line">usage: gitlab project-file [-h] &#123;get,create,update,delete,raw,blame&#125; ...</span><br></pre></td></tr></table></figure><ul><li>è·å–æ–‡ä»¶ï¼Œé€šè¿‡ <code>project-file</code> å¯¹è±¡çš„ get æ“ä½œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab -o json project-file get --project-id <span class="variable">$&#123;PROJECT_ID&#125;</span> --file-path .gitignore --ref master  | jq <span class="string">'.'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"file_name"</span>: <span class="string">".gitignore"</span>,</span><br><span class="line">  <span class="string">"file_path"</span>: <span class="string">".gitignore"</span>,</span><br><span class="line">  <span class="string">"size"</span>: 1208,</span><br><span class="line">  <span class="string">"encoding"</span>: <span class="string">"base64"</span>,</span><br><span class="line">  <span class="string">"content_sha256"</span>: <span class="string">"91f1d50ba3a4f79f96d9371afc70b389f75dfb2ac5190b8fb01051aa8679fd04"</span>,</span><br><span class="line">  <span class="string">"ref"</span>: <span class="string">"master"</span>,</span><br><span class="line">  <span class="string">"blob_id"</span>: <span class="string">"b09ca9d3b101034c7e34430177c1d64738df5fbb"</span>,</span><br><span class="line">  <span class="string">"commit_id"</span>: <span class="string">"a9c97e5253c455546c2c7fdd794147eeb9b8ab7a"</span>,</span><br><span class="line">  <span class="string">"last_commit_id"</span>: <span class="string">"4ffc106c58fc5865b6d72a52365e25b8c268d4d8"</span>,</span><br><span class="line">  <span class="string">"content"</span>: <span class="string">"LnZhZ3JhbnQKKi5yZXRyeQoqKi92YWdyYW50X2Fuc2libGVfaW52ZW50b3J5CiouaW1sCnRlbXAKLmlkZWEKLnRveAouY2FjaGUKKi5iYWsKKi50ZnN0YXRlCioudGZzdGF0ZS5iYWNrdXAKLnRlcnJhZm9ybS8KY29udHJpYi90ZXJyYWZvcm0vYXdzL2NyZWRlbnRpYWxzLnRmdmFycwovc3NoLWJhc3Rpb24uY29uZgoqKi8qLnN3W3Bvbl0KKn4KdmFncmFudC8KcGx1Z2lucy9taXRvZ2VuCgojIEFuc2libGUgaW52ZW50b3J5CmludmVudG9yeS8qCiFpbnZlbnRvcnkvbG9jYWwKIWludmVudG9yeS9zYW1wbGUKaW52ZW50b3J5LyovYXJ0aWZhY3RzLwoKIyBCeXRlLWNvbXBpbGVkIC8gb3B0aW1pemVkIC8gRExMIGZpbGVzCl9fcHljYWNoZV9fLwoqLnB5W2NvZF0KKiRweS5jbGFzcwoKIyBEaXN0cmlidXRpb24gLyBwYWNrYWdpbmcKLlB5dGhvbgplbnYvCmJ1aWxkLwpjcmVkZW50aWFscy8KZGV2ZWxvcC1lZ2dzLwpkaXN0Lwpkb3dubG9hZHMvCmVnZ3MvCi5lZ2dzLwpwYXJ0cy8Kc2Rpc3QvCnZhci8KKi5lZ2ctaW5mby8KLmluc3RhbGxlZC5jZmcKKi5lZ2cKCiMgUHlJbnN0YWxsZXIKIyAgVXN1YWxseSB0aGVzZSBmaWxlcyBhcmUgd3JpdHRlbiBieSBhIHB5dGhvbiBzY3JpcHQgZnJvbSBhIHRlbXBsYXRlCiMgIGJlZm9yZSBQeUluc3RhbGxlciBidWlsZHMgdGhlIGV4ZSwgc28gYXMgdG8gaW5qZWN0IGRhdGUvb3RoZXIgaW5mb3MgaW50byBpdC4KKi5tYW5pZmVzdAoqLnNwZWMKCiMgSW5zdGFsbGVyIGxvZ3MKcGlwLWxvZy50eHQKcGlwLWRlbGV0ZS10aGlzLWRpcmVjdG9yeS50eHQKCiMgVW5pdCB0ZXN0IC8gY292ZXJhZ2UgcmVwb3J0cwpodG1sY292LwoudG94LwouY292ZXJhZ2UKLmNvdmVyYWdlLioKLmNhY2hlCm5vc2V0ZXN0cy54bWwKY292ZXJhZ2UueG1sCiosY292ZXIKLmh5cG90aGVzaXMvCgojIFRyYW5zbGF0aW9ucwoqLm1vCioucG90CgojIERqYW5nbyBzdHVmZjoKKi5sb2cKbG9jYWxfc2V0dGluZ3MucHkKCiMgRmxhc2sgc3R1ZmY6Cmluc3RhbmNlLwoud2ViYXNzZXRzLWNhY2hlCgojIFNjcmFweSBzdHVmZjoKLnNjcmFweQoKIyBTcGhpbnggZG9jdW1lbnRhdGlvbgpkb2NzL19idWlsZC8KCiMgUHlCdWlsZGVyCnRhcmdldC8KCiMgSVB5dGhvbiBOb3RlYm9vawouaXB5bmJfY2hlY2twb2ludHMKCiMgcHllbnYKLnB5dGhvbi12ZXJzaW9uCgojIGRvdGVudgouZW52CgojIHZpcnR1YWxlbnYKdmVudi8KRU5WLwo="</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–‡ä»¶å†…å®¹æ˜¯ base64 ç¼–ç çš„ï¼Œéœ€è¦ä½¿ç”¨ base64 è§£ç æ‰èƒ½è·å–åŸå§‹çš„å†…å®¹ã€‚</span></span><br><span class="line">$ gitlab -g gitlab -o json project-file get --project-id 25099880 --file-path .gitignore --ref master  | jq -r <span class="string">'.content'</span> | base64 -d</span><br><span class="line">.vagrant</span><br><span class="line">*.retry</span><br><span class="line">**/vagrant_ansible_inventory</span><br><span class="line">*.iml</span><br><span class="line">temp</span><br><span class="line">.idea</span><br><span class="line">.tox</span><br><span class="line">â€¦â€¦â€¦â€¦</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ project-file çš„ raw æ–¹æ³•å¯ä»¥è·å–æ–‡ä»¶çš„åŸå§‹å†…å®¹ï¼Œæ— é¡» base64 è§£ç </li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab project-file get --project-id <span class="variable">$&#123;PROJECT_ID&#125;</span> --file-path .gitignore --ref master</span><br></pre></td></tr></table></figure><ul><li><p>åˆ›å»ºæ–‡ä»¶ï¼Œå¯¹æ–‡ä»¶çš„å¢åˆ æ”¹éƒ½æ˜¯é€šè¿‡æäº¤ commit æ¥å®Œæˆçš„ï¼Œå› æ­¤éœ€è¦æŒ‡å®šæ‰€è¦æ“ä½œçš„åˆ†æ”¯ä»¥åŠ commit-message çš„ä¿¡æ¯ã€‚å¦å¤–å¦‚æœæ“ä½œçš„æ–‡ä»¶æ˜¯ master åˆ†æ”¯è·å–å…¶ä»–ä¿æŠ¤åˆ†æ”¯ï¼Œè¦ç¡®ä¿å½“å‰ç”¨æˆ·æœ‰å†™å…¥çš„æƒé™ï¼Œä¸ç„¶ä¼šæç¤ºå¦‚ä¸‹é”™è¯¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gitlab project-file update</span><br><span class="line">Impossible to update object (400: You are not allowed to push into this branch)</span><br></pre></td></tr></table></figure></li></ul><p>ä¹‹å‰åœ¨ GitHub ä¸Šæœ‰ä¸€å¥— CI å¹¶ä¸èƒ½é€‚ç”¨äº Gitlabï¼Œå› æ­¤éœ€è¦ä¸ºæ‰€æœ‰çš„åˆ†æ”¯åˆ›å»º CI æµæ°´çº¿ï¼Œç”¨äºæ£€æŸ¥ä»£ç æ˜¯å¦ç¬¦åˆè§„èŒƒï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•æ‰¹é‡é‡åœ°å‘æ‰€æœ‰åˆ†æ”¯åˆ›å»ºæ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ID=123456</span><br><span class="line">BRANCHS=$(gitlab -o json project-branch list --project-id <span class="variable">$&#123;ID&#125;</span> --all | jq -r <span class="string">".[].name"</span>)</span><br><span class="line"><span class="keyword">for</span> branch <span class="keyword">in</span> <span class="variable">$&#123;BRANCHS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">gitlab project-file create --project-id <span class="variable">$&#123;ID&#125;</span> --file-path .gitlab-ci.yml --branch <span class="variable">$&#123;branch&#125;</span> --content @.gitlab-ci.yml --commit-message <span class="string">"feat(gitlab-ci): add gitlab-ci.yml for ci"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li>æ›´æ–°æ–‡ä»¶</li></ul><p>æ¯”å¦‚æ‰¹é‡æ›´æ–°æ‰€æœ‰åˆ†æ”¯çš„ <code>Makefile</code> ä¸­ <code>github.com</code> ä¸º <code>gitlab.com</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ID=123456</span><br><span class="line">BRANCHS=$(gitlab -o json project-branch list --project-id <span class="variable">$&#123;ID&#125;</span> --all | jq -r <span class="string">".[].name"</span>)</span><br><span class="line"><span class="keyword">for</span> branch <span class="keyword">in</span> <span class="variable">$&#123;BRANCHS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    rm -f Makefile Makefile-</span><br><span class="line">    gitlab project-file raw --project-id <span class="variable">$&#123;ID&#125;</span> --file-path Makefile --ref <span class="variable">$&#123;branch&#125;</span> &gt; Makefile</span><br><span class="line">    sed -i- <span class="string">"s|github.com/muzi502|gitlab.com/muzi502"</span> Makefile</span><br><span class="line">    gitlab project-file update --project-id <span class="variable">$&#123;ID&#125;</span> --file-path Makefile --branch <span class="variable">$&#123;branch&#125;</span> --content @Makefile \</span><br><span class="line">    --commit-message <span class="string">"chore(Makefile): update repo url in Makefile for migrate gitlab"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li>åˆ é™¤æ–‡ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab project-file delete --project-id <span class="variable">$&#123;PROJECT_ID&#125;</span> --file-path .gitignore --ref master \</span><br><span class="line">--commit-message <span class="string">"test delete file"</span></span><br></pre></td></tr></table></figure><h3 id="MR-1"><a href="#MR-1" class="headerlink" title="MR"></a>MR</h3><ul><li>åˆ›å»º MRï¼ŒæŒ‡å®š source branch å’Œ target branch ä»¥åŠ mr çš„ title è¿™ä¸‰ä¸ªå‚æ•°ã€‚å‰é¢æœ€å¥½åŠ ä¸Š -o json å‚æ•°ç”¨æˆ·è·å– mr çš„ iidï¼Œå¯é€šè¿‡æ­¤ iid æ¥å¯¹è¿™ä¸ª mr è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab -o json project-merge-request create --project-id <span class="variable">$&#123;PROJECT_ID&#125;</span> --<span class="built_in">source</span>-branch --target-branch <span class="variable">$&#123;BASE_BRANCH&#125;</span> --title <span class="string">"<span class="variable">$&#123;MR_TITLE&#125;</span>"</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ -o json å‚æ•°ä¼šè¿”å›æ­¤ mr çš„ä¿¡æ¯ï¼Œå…¶ä¸­ <code>iid</code> å°±æ˜¯è¯¥ mr åœ¨æ­¤ repo ä¸­çš„å”¯ä¸€æ ‡ç¤º</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab -g gitlab -o json project-merge-request create --project-id 25099880 --source-branch release-2.14 --target-branch  master --title "mr create test"</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="number">92872102</span>,</span><br><span class="line">  <span class="attr">"iid"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"project_id"</span>: <span class="number">25099880</span>,</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"mr create test"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"state"</span>: <span class="string">"opened"</span>,</span><br><span class="line">  <span class="attr">"created_at"</span>: <span class="string">"2021-03-21T12:42:52.893Z"</span>,</span><br><span class="line">  <span class="attr">"updated_at"</span>: <span class="string">"2021-03-21T12:42:52.893Z"</span>,</span><br><span class="line">  <span class="attr">"merged_by"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"merged_at"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"closed_by"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"closed_at"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"target_branch"</span>: <span class="string">"master"</span>,</span><br><span class="line">  <span class="attr">"source_branch"</span>: <span class="string">"release-2.14"</span>,</span><br><span class="line">  <span class="attr">"user_notes_count"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"upvotes"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"downvotes"</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"author"</span>: &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">5599205</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"muzi502"</span>,</span><br><span class="line">    <span class="attr">"username"</span>: <span class="string">"muzi502"</span>,</span><br><span class="line">    <span class="attr">"state"</span>: <span class="string">"active"</span>,</span><br><span class="line">    <span class="attr">"avatar_url"</span>: <span class="string">"https://secure.gravatar.com/avatar/f91578ffea9a538eedd8fbaf3007289b?s=80&amp;d=identicon"</span>,</span><br><span class="line">    <span class="attr">"web_url"</span>: <span class="string">"https://gitlab.com/muzi502"</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ul><li>åˆå¹¶ MR</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab project-merge-request merge --project-id <span class="variable">$&#123;PROJECT_ID&#125;</span> --iid @mr_iid</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹ MR çŠ¶æ€</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab -o json project-merge-request get --project-id <span class="variable">$&#123;PROJECT_ID&#125;</span> --iid @mr_iid | jq -r <span class="string">".state"</span></span><br></pre></td></tr></table></figure><ul><li>é›†æˆåœ¨ Jenkinsfile  ä¸­å®Œæˆåˆ›å»º MRã€åˆå¹¶ MRã€æ£€æŸ¥ MR </li></ul><p>è°ƒç”¨ç”¨å®ƒçš„æ—¶å€™åªéœ€è¦ä¼ å…¥ SOURCE_BRANCH, TARGET_BRANCH, MR_TITLE è¿™ä¸‰ä¸ªå‚æ•°å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">def makeMR(SOURCE_BRANCH, TARGET_BRANCH, MR_TITLE) &#123;</span><br><span class="line">    container(<span class="string">"debian"</span>) &#123;</span><br><span class="line">        sh <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        gitlab -o json project-merge-request create --project-id <span class="variable">$&#123;PROJECT_ID&#125;</span>  --title \"<span class="variable">$&#123;MR_TITLE&#125;</span>\" \</span></span><br><span class="line"><span class="string">        --source-branch <span class="variable">$&#123;SOURCE_BRANCH&#125;</span> --target-branch <span class="variable">$&#123;TARGET_BRANCH&#125;</span> &gt; mr_info.json</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        jq -r '.iid' mr_info.json &gt; mr_iid</span></span><br><span class="line"><span class="string">        jq -r '.web_url' mr_info.json &gt; mr_url</span></span><br><span class="line"><span class="string">        "</span><span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def <span class="function"><span class="title">checkMR</span></span>() &#123;</span><br><span class="line">    container(<span class="string">"debian"</span>) &#123;</span><br><span class="line">        retry(120) &#123;</span><br><span class="line">        sh <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        if [ ! -s mr_iid ]; then exit 0; else sleep 60s; fi</span></span><br><span class="line"><span class="string">        gitlab -o json project-merge-request get --project-id <span class="variable">$&#123;PROJECT_ID&#125;</span> --iid @mr_iid | jq -r "</span>.labels[]<span class="string">" | grep 'approve'</span></span><br><span class="line"><span class="string">        "</span><span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">def <span class="function"><span class="title">mergeMR</span></span>()&#123;</span><br><span class="line">    container(<span class="string">"debian"</span>) &#123;</span><br><span class="line">        retry(10)&#123;</span><br><span class="line">        sh <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">        if [ ! -s mr_iid ]; then exit 0; else sleep 60s; fi</span></span><br><span class="line"><span class="string">        if gitlab project-merge-request merge --project-id <span class="variable">$&#123;PROJECT_ID&#125;</span> --iid @mr_iid; then sleep 10s; fi</span></span><br><span class="line"><span class="string">        gitlab -o json project-merge-request get --project-id <span class="variable">$&#123;PROJECT_ID&#125;</span> --iid @mr_iid | jq -r "</span>.state<span class="string">" | grep 'merged'</span></span><br><span class="line"><span class="string">        "</span><span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Tag"><a href="#Tag" class="headerlink" title="Tag"></a>Tag</h3><ul><li>åˆ—å‡º repo tag</li></ul><p>åœ¨è¿™é‡Œè¿˜æ˜¯æ¨èä½¿ç”¨ git tag çš„æ–¹å¼è·å– repo tag ï¼Œå› ä¸º Gitlab API çš„é™åˆ¶ï¼Œæ¯æ¬¡è¯·æ±‚æœ€å¤šåªèƒ½è¿”å› 100 ä¸ªå€¼ï¼Œå¯ä»¥åŠ ä¸Š <code>--all</code> å‚æ•°æ¥è¿”å›æ‰€æœ‰çš„å€¼ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab -o json project-tag list --project-id <span class="variable">$&#123;ID&#125;</span> | jq -r <span class="string">'.[].name'</span></span><br><span class="line">$ gitlab -o json project-tag list --project-id <span class="variable">$&#123;ID&#125;</span> --all | jq -r <span class="string">'.[].name'</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»º tag</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab project-tag create --project-id <span class="variable">$&#123;ID&#125;</span> --tag-name v1.0.0-rc.2 --ref master</span><br></pre></td></tr></table></figure><ul><li>åˆ é™¤ tag</li></ul><p>upstream ä¸Šçš„ repo tag åªèƒ½é€šè¿‡åœ¨ Gitlab ä¸Šåˆ é™¤ï¼Œåœ¨æœ¬åœ° repo ä¸‹æ˜¯æ— æ³•åˆ é™¤çš„ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åˆ é™¤  Gitlab repo tagï¼Œæ³¨æ„ï¼šå—ä¿æŠ¤çš„ repo tag å¦‚æœæ²¡æœ‰æƒé™çš„è¯æ˜¯æ— æ³•åˆ é™¤çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gitlab project-tag delete --project-id <span class="variable">$&#123;ID&#125;</span> --tag-name v1.0.0-rc.2</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºå—ä¿æŠ¤çš„ repo tag</li></ul><p>ç”±äºæˆ‘ä»¬æµæ°´çº¿ä»»åŠ¡ä¾èµ–äº repo tag æ¥åšç‰ˆæœ¬çš„å¯¹äºï¼Œå› æ­¤éœ€è¦ä¿æŠ¤æ¯ä¸€ä¸ª repo tagï¼Œä½†æœ‰ç‰¹æ®Šæƒ…å†µä¸‹åˆè¦è¦†ç›– repo tagï¼Œæ‰€ä»¥å—ä¿æŠ¤çš„ repo tag ç›®å‰è¿˜æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ–¹æ³•ï¼Œåªèƒ½å…ˆæ‰‹åŠ¨åˆ›å»ºäº†ï¼Œç­‰åˆ°éœ€è¦åˆ é™¤çš„æ—¶å€™å†åˆ é™¤å®ƒã€‚å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ‰¹é‡åˆ›å»ºå—ä¿æŠ¤çš„ repo tagã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git tag | xargs -L1 -I &#123;&#125; gitlab project-protected-tag create --project-id <span class="variable">$&#123;ID&#125;</span> --name &#123;&#125;</span><br></pre></td></tr></table></figure><h2 id="Lint-æµæ°´çº¿"><a href="#Lint-æµæ°´çº¿" class="headerlink" title="Lint æµæ°´çº¿"></a>Lint æµæ°´çº¿</h2><p>è¿ç§»åˆ°äº† Gitlab ä¹‹ååŸæœ‰çš„æµæ°´çº¿åœ¨å†…ç½‘çš„ Gitlab ä¸Šä¹Ÿå°±æ— æ³•ä½¿ç”¨äº†ï¼Œä¸ºäº†å‡å°‘ç»´æŠ¤æˆæœ¬å°±ä½¿ç”¨äº† Gitlab è‡ªå¸¦çš„ CI ã€‚æˆ‘æ‰€ç»´æŠ¤çš„ repo ä½¿ç”¨ Gitlab CI åªæ˜¯åšä¸€äº› lint çš„æ£€æŸ¥å†…å®¹ï¼Œå› æ­¤ CI é…ç½®èµ·æ¥ä¹Ÿç‰¹åˆ«ç®€å•ã€‚å¦‚ kubespray çš„ CI é…ç½®ï¼š</p><ul><li><code>.gitlab-ci.yml</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">lint:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">'quay.io/kubespray/kubespray:v2.15.0'</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">chmod</span> <span class="string">-R</span> <span class="string">o-w</span> <span class="string">.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">make</span> <span class="string">lint</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">shared</span></span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ gitlab CLI å·¥å…·ç»™æ‰€æœ‰åˆ†æ”¯æ·»åŠ  <code>.gitlab-ci.yml</code> æ–‡ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ID=123456</span><br><span class="line">BRANCHS=$(gitlab -o json project-branch list --project-id <span class="variable">$&#123;ID&#125;</span> --all | jq -r <span class="string">".[].name"</span>)</span><br><span class="line"><span class="keyword">for</span> branch <span class="keyword">in</span> <span class="variable">$&#123;BRANCHS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">gitlab project-file create --project-id <span class="variable">$&#123;ID&#125;</span> --file-path .gitlab-ci.yml --branch <span class="variable">$&#123;branch&#125;</span> --content @.gitlab-ci.yml --commit-message <span class="string">"feat(gitlab-ci): add gitlab-ci.yml for ci"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><ul><li>repo è¿ç§»</li></ul><p>ç”±äºå†…éƒ¨çš„ Gitlab ä¸æ”¯æŒå¯¼å…¥ git url çš„æ–¹å¼ï¼Œæ‰€ä»¥åªèƒ½æ‰‹åŠ¨åœ°å°† GitHub ä¸Šçš„ repo clone åˆ°æœ¬åœ°å† push åˆ° Gitlab ä¸Šã€‚ä½¿ç”¨ git clone çš„æ–¹å¼æœ¬åœ°åªä¼šæœ‰ä¸€ä¸ª master åˆ†æ”¯ï¼Œè¦æŠŠ GitHub ä¸Š repo çš„æ‰€æœ‰åˆ†æ”¯éƒ½ track ä¸€éï¼Œç„¶åå† push åˆ° Gitlab ä¸Šã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ git clone ä¸‹æ¥çš„ repo é»˜è®¤ä¸º master åˆ†æ”¯</span></span><br><span class="line">$ git <span class="built_in">clone</span> git@gitlab.com/muzi502/kubespray.git</span><br><span class="line"><span class="comment"># track å‡º origin ä¸Šçš„æ‰€æœ‰åˆ†æ”¯</span></span><br><span class="line">$ git branch -r | grep -v <span class="string">'\-&gt;'</span> | <span class="keyword">while</span> <span class="built_in">read</span> remote; <span class="keyword">do</span> git branch --track <span class="string">"<span class="variable">$&#123;remote#origin/&#125;</span>"</span> <span class="string">"<span class="variable">$remote</span>"</span>; <span class="keyword">done</span></span><br><span class="line">$ git fetch --all</span><br><span class="line">$ git pull --all</span><br><span class="line">$ git remote remove origin</span><br><span class="line">$ git remote add origin git@gitlab/gitlab502/kubespray.git</span><br><span class="line">$ git push origin --all</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://stackoverflow.com/questions/10312521/how-to-fetch-all-git-branches" target="_blank" rel="noopener">How to fetch all Git branches</a></li><li><a href="https://yixinglu.gitlab.io/gitlab-workflow.html" target="_blank" rel="noopener">GitLab å·¥ä½œæµ</a></li><li><a href="https://python-gitlab.readthedocs.io/" target="_blank" rel="noopener">python-gitlab</a></li><li><a href="https://docs.gitlab.com/ee/api/README.html" target="_blank" rel="noopener">Gitlab API Docs</a></li><li><a href="https://github.com/xanzy/go-gitlab" target="_blank" rel="noopener">go-gitlab</a></li><li><a href="https://mp.weixin.qq.com/s/x5PHNn87OYCSpYE_hb8I2A" target="_blank" rel="noopener">è°ˆè°ˆ Git å­˜å‚¨åŸç†åŠç›¸å…³å®ç°</a></li><li><a href="https://morningspace.github.io/tech/inside-git-3/" target="_blank" rel="noopener">Gitè§£å¯†â€”â€”è®¤è¯†Gitå¼•ç”¨</a></li><li><a href="https://blinkfox.github.io/2018/11/22/ruan-jian-gong-ju/devops/gitlab-ci-jie-shao-he-shi-yong/" target="_blank" rel="noopener">GitLab CI/CD ä»‹ç»å’Œä½¿ç”¨</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;å¼€å€’è½¦-ğŸš—-ï¼Ÿ&quot;&gt;&lt;a
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="ci" scheme="https://blog.k8s.li/tags/ci/"/>
    
      <category term="gitlab" scheme="https://blog.k8s.li/tags/gitlab/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins å¤§å”ä¸ kubernetes èˆ¹é•¿æ‰‹ç‰µæ‰‹ ğŸ§‘â€ğŸ¤â€ğŸ§‘</title>
    <link href="https://blog.k8s.li/jenkins-with-kubernetes.html"/>
    <id>https://blog.k8s.li/jenkins-with-kubernetes.html</id>
    <published>2021-03-05T16:00:00.000Z</published>
    <updated>2021-03-06T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>è™½ç„¶äº‘åŸç”Ÿæ—¶ä»£æœ‰äº† <a href="https://jenkins-x.io/" target="_blank" rel="noopener">JenkinsX</a>ã€<a href="https://www.drone.io/" target="_blank" rel="noopener">Drone</a>ã€<a href="https://tekton.dev" target="_blank" rel="noopener">Tekton</a> è¿™æ ·çš„åèµ·ä¹‹ç§€ï¼Œä½† Jenkins è¿™æ ·ä¸€ä¸ªè€ç‰Œçš„ CI/CD å·¥å…·ä»æ˜¯å„å¤§å…¬å¸ä¸»æµçš„ä½¿ç”¨æ–¹æ¡ˆã€‚æ¯”å¦‚æˆ‘å¸çš„ç§æœ‰äº‘äº§å“æ‰“åŒ…å‘å¸ƒå°±æ˜¯ç”¨è¿™è€å®¶ä¼™å®Œæˆçš„ã€‚ç„¶è€Œä¼ ç»Ÿçš„ Jenkins Slave ä¸€ä¸»å¤šä»æ–¹å¼ä¼šå­˜åœ¨ä¸€äº›ç—›ç‚¹ï¼Œæ¯”å¦‚ï¼š</p><ul><li>æ¯ä¸ª Slave çš„é…ç½®ç¯å¢ƒä¸ä¸€æ ·ï¼Œæ¥å®Œæˆä¸åŒè¯­è¨€çš„ç¼–è¯‘æ‰“åŒ…ç­‰æ“ä½œï¼Œä½†æ˜¯è¿™äº›å·®å¼‚åŒ–çš„é…ç½®å¯¼è‡´ç®¡ç†èµ·æ¥éå¸¸ä¸æ–¹ä¾¿ï¼Œç»´æŠ¤èµ·æ¥ä¹Ÿæ˜¯æ¯”è¾ƒè´¹åŠ²</li><li>èµ„æºåˆ†é…ä¸å‡è¡¡ï¼Œæœ‰çš„ Slave è¦è¿è¡Œçš„ job å‡ºç°æ’é˜Ÿç­‰å¾…ï¼Œè€Œæœ‰çš„ Slave å¤„äºç©ºé—²çŠ¶æ€</li><li>èµ„æºæœ‰æµªè´¹ï¼Œæ¯å° Slave å¯èƒ½æ˜¯ç‰©ç†æœºæˆ–è€…è™šæ‹Ÿæœºï¼Œå½“ Slave å¤„äºç©ºé—²çŠ¶æ€æ—¶ï¼Œä¹Ÿä¸ä¼šå®Œå…¨é‡Šæ”¾æ‰èµ„æºã€‚</li></ul><p>æ­£å› ä¸ºä¸Šé¢çš„ Jenkins slave å­˜åœ¨è¿™äº›ç§ç§ç—›ç‚¹ï¼Œæˆ‘ä»¬æ¸´æœ›ä¸€ç§æ›´é«˜æ•ˆæ›´å¯é çš„æ–¹å¼æ¥å®Œæˆè¿™ä¸ª CI/CD æµç¨‹ï¼Œè€Œ Docker è™šæ‹ŸåŒ–å®¹å™¨æŠ€æœ¯èƒ½å¾ˆå¥½çš„è§£å†³è¿™ä¸ªç—›ç‚¹ï¼Œåˆç‰¹åˆ«æ˜¯åœ¨ Kubernetes é›†ç¾¤ç¯å¢ƒä¸‹é¢èƒ½å¤Ÿæ›´å¥½æ¥è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œä¸‹å›¾æ˜¯åŸºäº Kubernetes æ­å»º Jenkins slave é›†ç¾¤çš„ç®€å•ç¤ºæ„å›¾ï¼š</p><p><img src="https://p.k8s.li/k8s-jenkins-slave.png" alt="k8s-jenkins"></p><p>ä»å›¾ä¸Šå¯ä»¥çœ‹åˆ° Jenkins Master æ—¶ä»¥ docker-compose çš„æ–¹å¼è¿è¡Œåœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚Jenkins Slave ä»¥ Pod å½¢å¼è¿è¡Œåœ¨ Kubernetes é›†ç¾¤çš„ Node ä¸Šï¼Œå¹¶ä¸”å®ƒä¸æ˜¯ä¸€ç›´å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå®ƒä¼šæŒ‰ç…§éœ€æ±‚åŠ¨æ€çš„åˆ›å»ºå¹¶è‡ªåŠ¨åˆ é™¤ã€‚è¿™ç§æ–¹å¼çš„å·¥ä½œæµç¨‹å¤§è‡´ä¸ºï¼šå½“ Jenkins Master æ¥å—åˆ° Build è¯·æ±‚æ—¶ï¼Œä¼šæ ¹æ®é…ç½®çš„ Label åŠ¨æ€åˆ›å»ºä¸€ä¸ªè¿è¡Œåœ¨ Pod ä¸­çš„ Jenkins Slave å¹¶æ³¨å†Œåˆ° Master ä¸Šï¼Œå½“è¿è¡Œå®Œ Job åï¼Œè¿™ä¸ª Slave ä¼šè¢«æ³¨é”€å¹¶ä¸”è¿™ä¸ª Pod ä¹Ÿä¼šè‡ªåŠ¨åˆ é™¤ï¼Œæ¢å¤åˆ°æœ€åˆçŠ¶æ€ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬ä½¿ç”¨è¿™ç§æ–¹å¼å¸¦æ¥äº†ä»¥ä¸‹å¥½å¤„ï¼š</p><ul><li><strong>åŠ¨æ€ä¼¸ç¼©</strong>ï¼Œåˆç†ä½¿ç”¨èµ„æºï¼Œæ¯æ¬¡è¿è¡Œ Job æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª Jenkins Slaveï¼ŒJob å®Œæˆåï¼ŒSlave è‡ªåŠ¨æ³¨é”€å¹¶åˆ é™¤å®¹å™¨ï¼Œèµ„æºè‡ªåŠ¨é‡Šæ”¾ï¼Œè€Œä¸” Kubernetes ä¼šæ ¹æ®æ¯ä¸ªèµ„æºçš„ä½¿ç”¨æƒ…å†µï¼ŒåŠ¨æ€åˆ†é… Slave åˆ°ç©ºé—²çš„èŠ‚ç‚¹ä¸Šåˆ›å»ºï¼Œé™ä½å‡ºç°å› æŸèŠ‚ç‚¹èµ„æºåˆ©ç”¨ç‡é«˜ï¼Œè¿˜æ’é˜Ÿç­‰å¾…åœ¨è¯¥èŠ‚ç‚¹çš„æƒ…å†µã€‚</li><li><strong>æ‰©å±•æ€§å¥½</strong>ï¼Œå½“ Kubernetes é›†ç¾¤çš„èµ„æºä¸¥é‡ä¸è¶³è€Œå¯¼è‡´ Job æ’é˜Ÿç­‰å¾…æ—¶ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„æ·»åŠ ä¸€ä¸ª Kubernetes Node åˆ°é›†ç¾¤ä¸­ï¼Œä»è€Œå®ç°æ‰©å±•ã€‚</li></ul><p>ä¸Šé¢çš„å¤§åŠæ®µå¤åˆ¶ç²˜è´´è‡ª <a href="https://www.qikqiak.com/k8s-book/docs/36.Jenkins%20Slave.html" target="_blank" rel="noopener">åŸºäº Jenkins çš„ CI/CD (ä¸€)</a> ğŸ¤</p><h2 id="kubernetes-é›†ç¾¤"><a href="#kubernetes-é›†ç¾¤" class="headerlink" title="kubernetes é›†ç¾¤"></a>kubernetes é›†ç¾¤</h2><p>å…³äº kubernetes é›†ç¾¤éƒ¨ç½²ï¼Œä½¿ç”¨ kubeadm éƒ¨ç½²æ˜¯æœ€ä¸ºæ–¹ä¾¿çš„äº†ï¼Œå¯å‚è€ƒæˆ‘å¾ˆæ—©ä¹‹å‰å†™è¿‡çš„æ–‡ç« ã€Š<a href="https://blog.k8s.li/kubeadm-deploy-k8s-v1.17.4.html">ä½¿ç”¨ kubeadm å¿«é€Ÿéƒ¨ç½²ä½“éªŒ K8s</a>ã€‹ï¼Œåœ¨è¿™é‡Œåªæ˜¯ç®€å•ä»‹ç»ä¸€ä¸‹ï¼š</p><ul><li>ä½¿ç”¨ kubeadm æ¥åˆ›å»ºä¸€ä¸ªå• master èŠ‚ç‚¹çš„ kubernets é›†ç¾¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@jenkins:~ <span class="comment"># kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=192.168.20.11</span></span><br></pre></td></tr></table></figure><ul><li>é›†ç¾¤æˆåŠŸéƒ¨ç½²å®Œæˆä¹‹åä¼šæœ‰å¦‚ä¸‹æç¤ºï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€å’Œ pod éƒ½å·²ç»æ­£å¸¸</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@jenkins:~ <span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE     NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   coredns-f9fd979d6-9t6qp           1/1     Running   0          89s</span><br><span class="line">kube-system   coredns-f9fd979d6-hntm8           1/1     Running   0          89s</span><br><span class="line">kube-system   etcd-jenkins                      1/1     Running   0          106s</span><br><span class="line">kube-system   kube-apiserver-jenkins            1/1     Running   0          106s</span><br><span class="line">kube-system   kube-controller-manager-jenkins   1/1     Running   0          106s</span><br><span class="line">kube-system   kube-proxy-8pzkz                  1/1     Running   0          89s</span><br><span class="line">kube-system   kube-scheduler-jenkins            1/1     Running   0          106s</span><br><span class="line">root@jenkins:~ <span class="comment"># kubectl get node</span></span><br><span class="line">NAME      STATUS   ROLES    AGE    VERSION</span><br><span class="line">jenkins   Ready    master   119s   v1.19.8</span><br></pre></td></tr></table></figure><ul><li>å»é™¤ master èŠ‚ç‚¹ä¸Šçš„æ±¡ç‚¹ï¼Œå…è®¸å…¶ä»–çš„ pod è°ƒåº¦åœ¨ master èŠ‚ç‚¹ä¸Šï¼Œä¸ç„¶åé¢ Jenkins æ‰€åˆ›å»ºçš„ pod å°†æ— æ³•è°ƒåº¦åœ¨è¯¥èŠ‚ç‚¹ä¸Šã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes $(hostname) node-role.kubernetes.io/master:NoSchedule-</span><br></pre></td></tr></table></figure><h2 id="Jenkins-master"><a href="#Jenkins-master" class="headerlink" title="Jenkins master"></a>Jenkins master</h2><p>è‡³äº  Jenkins master çš„éƒ¨ç½²æ–¹å¼ï¼Œä¸ªäººå»ºè®®ä½¿ç”¨ docker-compose æ¥éƒ¨ç½²ã€‚è¿è¡Œåœ¨ kubernetes é›†ç¾¤é›†ç¾¤ä¸­ä¹Ÿæ²¡ä»€ä¹ˆæ¯›ç—…ï¼Œå¯ä»¥å‚è€ƒ <a href="https://www.qikqiak.com/k8s-book/docs/36.Jenkins%20Slave.html" target="_blank" rel="noopener">åŸºäº Jenkins çš„ CI/CD (ä¸€)</a> è¿™ç¯‡åšå®¢ã€‚ä½†ä»ä¸ªäººè¿ç»´è¸©çš„å‘æ¥è®²ï¼Œè¿˜æ˜¯å°†  Jenkins master ç‹¬ç«‹äº kubernetes é›†ç¾¤éƒ¨ç½²æ¯”è¾ƒæ–¹ä¾¿ğŸ˜‚ã€‚</p><ul><li><code>docker-compose.yaml</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.6'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">jenkins:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">jenkins/jenkins:2.263.4-lts-slim</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">jenkins</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./jenkins_home:/var/jenkins_home</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JAVA_OPTS=-Duser.timezone=Asia/Shanghai</span></span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ docker-compose up æ¥å¯åŠ¨ï¼ŒæˆåŠŸå¯åŠ¨åä¼šæœ‰å¦‚ä¸‹æç¤ºï¼Œæ—¥å¿—è¾“å‡ºçš„å¯†é’¥å°±æ˜¯ <code>admin</code> ç”¨æˆ·çš„é»˜è®¤å¯†ç ï¼Œä½¿ç”¨å®ƒæ¥ç¬¬ä¸€æ¬¡ç™»å½• Jenkinsã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">jenkins    | 2021-03-06 02:22:31.741+0000 [id=41]INFOjenkins.install.SetupWizard<span class="comment">#init:</span></span><br><span class="line">jenkins    |</span><br><span class="line">jenkins    | *************************************************************</span><br><span class="line">jenkins    | *************************************************************</span><br><span class="line">jenkins    | *************************************************************</span><br><span class="line">jenkins    |</span><br><span class="line">jenkins    | Jenkins initial setup is required. An admin user has been created and a password generated.</span><br><span class="line">jenkins    | Please use the following password to proceed to installation:</span><br><span class="line">jenkins    |</span><br><span class="line">jenkins    | 4c2361968cd94323acdde17f7603d8e1</span><br><span class="line">jenkins    |</span><br><span class="line">jenkins    | This may also be found at: /var/jenkins_home/secrets/initialAdminPassword</span><br><span class="line">jenkins    |</span><br><span class="line">jenkins    | *************************************************************</span><br><span class="line">jenkins    | *************************************************************</span><br><span class="line">jenkins    | *************************************************************</span><br></pre></td></tr></table></figure><ul><li>ç™»å½•ä¸Šå»ä¹‹åï¼Œå»ºè®®é€‰æ‹© <code>é€‰æ‹©æ’ä»¶æ¥å®‰è£…</code>ï¼Œå°½å¯èƒ½å°‘åœ°å®‰è£…æ’ä»¶ï¼ŒæŒ‰éœ€å®‰è£…å³å¯ã€‚</li></ul><p><img src="https://p.k8s.li/image-20210306102735594.png" alt="image-20210306102735594"></p><ul><li>åœ¨ Jenkins çš„æ’ä»¶ç®¡ç†é‚£é‡Œå®‰è£…ä¸Š kubernetes æ’ä»¶</li><li><img src="https://p.k8s.li/image-20210306103352837.png" alt="image-20210306103352837"></li><li>æ¥ä¸‹æ¥å¼€å§‹é…ç½® Jenkins å¤§å”å¦‚ä½•ä¸ kubernetes èˆ¹é•¿æ‰‹ç‰µæ‰‹ğŸ§‘â€ğŸ¤â€ğŸ§‘ :-)ã€‚é…ç½® kubernets çš„åœ°æ–¹æ˜¯åœ¨ <code>ç³»ç»Ÿç®¡ç† &gt; èŠ‚ç‚¹ç®¡ç† &gt; Configure Clouds</code>ã€‚ç‚¹å‡» <code>Add a new cloud</code>ï¼Œæ¥æ·»åŠ ä¸€ä¸ª kubernetes é›†ç¾¤ã€‚</li></ul><p><img src="https://p.k8s.li/image-20210306111626079.png" alt="image-20210306111626079"></p><ul><li>é…ç½®è¿æ¥å‚æ•°</li></ul><table><thead><tr><th>å‚æ•°</th><th>å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>åç§°</td><td>kubernetes</td><td>ä¹Ÿæ˜¯åé¢ pod æ¨¡æ¿ä¸­çš„ <code>cloud</code> çš„å€¼</td></tr><tr><td>å‡­æ®</td><td>kubeconfig å‡­æ® id</td><td>ä½¿ç”¨ kubeconfig æ–‡ä»¶æ¥è¿æ¥é›†ç¾¤</td></tr><tr><td>Kubernetes åœ°å€</td><td>é»˜è®¤å³å¯</td><td></td></tr><tr><td>Use Jenkins Proxy</td><td>é»˜è®¤å³å¯</td><td></td></tr><tr><td>Kubernetes æœåŠ¡è¯ä¹¦ key</td><td>é»˜è®¤å³å¯</td><td></td></tr><tr><td>ç¦ç”¨ HTTPS è¯ä¹¦æ£€æŸ¥</td><td>é»˜è®¤å³å¯</td><td></td></tr><tr><td>Kubernetes å‘½åç©ºé—´</td><td>é»˜è®¤å³å¯</td><td></td></tr><tr><td>WebSocket</td><td>é»˜è®¤å³å¯</td><td></td></tr><tr><td>Direct Connection</td><td>é»˜è®¤å³å¯</td><td></td></tr><tr><td>Jenkins åœ°å€</td><td><a href="http://jenkins.k8s.li:8080" target="_blank" rel="noopener">http://jenkins.k8s.li:8080</a></td><td>Jenkins pod è¿æ¥  Jenkins master çš„  URL</td></tr><tr><td>Jenkins é€šé“</td><td>50000</td><td>Jenkins <code>JNLP</code> çš„ç«¯å£ï¼Œé»˜è®¤ä¸º 50000</td></tr><tr><td>Connection Timeout</td><td>é»˜è®¤å³å¯</td><td>Jenkins è¿æ¥ kubernetes è¶…æ—¶æ—¶é—´</td></tr><tr><td>Read Timeout</td><td>é»˜è®¤å³å¯</td><td></td></tr><tr><td>å®¹å™¨æ•°é‡</td><td>é»˜è®¤å³å¯</td><td>Jenkins pod åˆ›å»ºçš„æœ€å¤§æ•°é‡</td></tr><tr><td>Pod Labels</td><td>é»˜è®¤å³å¯</td><td>Jenkins pod çš„ lables</td></tr><tr><td>è¿æ¥ Kubernetes API çš„æœ€å¤§è¿æ¥æ•°</td><td>é»˜è®¤å³å¯</td><td></td></tr><tr><td>Seconds to wait for pod to be running</td><td>é»˜è®¤å³å¯</td><td>ç­‰å¾… pod æ­£å¸¸ running çš„æ—¶é—´</td></tr></tbody></table><ul><li>åœ¨ Jenkins çš„å‡­æ®é‚£é‡Œæ·»åŠ ä¸Š kubeconfig æ–‡ä»¶ï¼Œå‡­æ®çš„ç±»å‹é€‰æ‹©ä¸º <code>Secret file</code>ï¼Œç„¶åå°†ä¸Šé¢ä½¿ç”¨ kubeadm éƒ¨ç½²ç”Ÿæˆçš„ kubeconfig ä¸Šä¼ åˆ°è¿™é‡Œã€‚</li></ul><p><img src="https://p.k8s.li/image-20210306111037947.png" alt="image-20210306111037947"></p><ul><li>ç‚¹å‡»è¿æ¥æµ‹è¯•ï¼Œå¦‚æœæç¤º <code>Connected to Kubernetes v1.19.8</code> å°±è¯´æ˜å·²ç»æˆåŠŸè¿æ¥ä¸Šäº† kubernetes é›†ç¾¤ã€‚</li></ul><p><img src="https://p.k8s.li/image-20210306111148462.png" alt="image-20210306111148462"></p><ul><li>å…³äº pod æ¨¡æ¿</li></ul><p>å…¶å®å°±æ˜¯é…ç½® Jenkins Slave è¿è¡Œçš„ Pod æ¨¡æ¿ï¼Œä¸ªäººä¸å¤ªå»ºè®®ä½¿ç”¨æ’ä»¶ä¸­çš„æ¨¡æ¿å»é…ç½®ï¼Œæ¨èå°† pod çš„æ¨¡æ¿æ”¾åœ¨ Jenkinsfile ä¸­ï¼Œå› ä¸ºè¿™äº›é…ç½®ä¸æˆ‘ä»¬çš„æµæ°´çº¿ç´§å¯†ç›¸å…³ï¼ŒæŠŠ pod çš„é…ç½®å­˜å‚¨åœ¨ Jenkins çš„æ’ä»¶é‡Œå®åœ¨æ˜¯ä¸å¤ªæ–¹ä¾¿ï¼›ä¸æ–¹ä¾¿åç»­çš„è¿ç§»å¤‡ä»½ä¹‹ç±»çš„å·¥ä½œï¼›åç»­æ’ä»¶å‡çº§åè¿™äº›é…ç½®ä¹Ÿå¯èƒ½ä¼šä¸¢å¤±ã€‚å› æ­¤å»ºè®®å°† pod æ¨¡æ¿çš„é…ç½®ç›´æ¥å®šä¹‰åœ¨ Jenkinsfile ä¸­ï¼Œçµæ´»æ€§æ›´é«˜ä¸€äº›ï¼Œä¸ä¼šå— Jenkins æ’ä»¶å‡çº§çš„å½±å“ã€‚æ€»ä¹‹ç”¨ä»£ç å»ç®¡ç†è¿™äº› pod é…ç½®ç»´æŠ¤æˆæœ¬å°†ä¼šå°‘å¾ˆå¤šã€‚</p><h2 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h2><ul><li>æµæ°´çº¿ <code>Jenkinsfile</code>ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä»»åŠ¡ï¼Œç”¨äºæ„å»º <a href="https://github.com/webp-sh/webp_server_go" target="_blank" rel="noopener">webp-server-go</a> é¡¹ç›®çš„ docker é•œåƒã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">Kubernetes</span> <span class="string">pod</span> <span class="string">template</span> <span class="string">to</span> <span class="string">run.</span></span><br><span class="line"><span class="string">def</span> <span class="string">JOB_NAME</span> <span class="string">=</span> <span class="string">"$&#123;env.JOB_NAME&#125;"</span></span><br><span class="line"><span class="string">def</span> <span class="string">BUILD_NUMBER</span> <span class="string">=</span> <span class="string">"$&#123;env.BUILD_NUMBER&#125;"</span></span><br><span class="line"><span class="string">def</span> <span class="string">POD_NAME</span> <span class="string">=</span> <span class="string">"jenkins-$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125;"</span></span><br><span class="line"><span class="string">podTemplate(</span></span><br><span class="line"><span class="comment"># è¿™é‡Œå®šä¹‰ pod æ¨¡ç‰ˆ</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">&#123;</span> <span class="string">node(POD_NAME)</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="string">container(JOB_NAME)</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="string">stage("Build</span> <span class="string">image")</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">sh</span> <span class="string">""</span><span class="string">"#!/bin/bash</span></span><br><span class="line"><span class="string">          git clone https://github.com/webp-sh/webp_server_go /build</span></span><br><span class="line"><span class="string">          cd /build</span></span><br><span class="line"><span class="string">          docker build -t webps:0.3.2-rc.1 .</span></span><br><span class="line"><span class="string">        "</span><span class="string">""</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>pod æ¨¡ç‰ˆå¦‚ä¸‹ï¼Œå°†æ¨¡æ¿çš„å†…å®¹å¤åˆ¶ç²˜è´´åˆ°ä¸Šé¢çš„ Jenkinsfile ä¸­ã€‚åœ¨å®¹å™¨ä¸­æ„å»ºé•œåƒï¼Œæˆ‘ä»¬ä½¿ç”¨ dind çš„æ–¹æ¡ˆï¼šå°† pod æ‰€åœ¨å®¿ä¸»æœºçš„ docker sock æ–‡ä»¶æŒ‚è½½åˆ° pod çš„å®¹å™¨å†…ï¼Œpod å®¹å™¨å†…åªè¦å®‰è£…å¥½ docker-cli å·¥å…·å°±å¯ä»¥åƒå®¿ä¸»æœºé‚£æ ·ç›´æ¥ä½¿ç”¨ docker äº†ã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">podTemplate(</span></span><br><span class="line">  <span class="attr">cloud:</span> <span class="string">"kubernetes"</span><span class="string">,</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">"default"</span><span class="string">,</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">POD_NAME,</span></span><br><span class="line">  <span class="attr">label:</span> <span class="string">POD_NAME,</span></span><br><span class="line">  <span class="attr">yaml:</span> <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: $&#123;JOB_NAME&#125;</span></span><br><span class="line"><span class="string">    image: "</span><span class="string">debian:buster-docker"</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dockersock</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/var/run/docker.sock</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jnlp</span></span><br><span class="line">    <span class="attr">args:</span> <span class="string">["\$(JENKINS_SECRET)",</span> <span class="string">"\$(JENKINS_NAME)"</span><span class="string">]</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"jenkins/inbound-agent:4.3-4-alpine"</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dockersock</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/var/run/docker.sock</span></span><br><span class="line"><span class="string">""</span><span class="string">",</span></span><br><span class="line"><span class="string">)</span></span><br></pre></td></tr></table></figure><ul><li>æ„å»º <code>debian:buster-docker</code> é•œåƒï¼Œä½¿ç”¨å®ƒæ¥åœ¨ pod çš„å®¹å™¨å†…æ„å»º docker é•œåƒï¼Œä½¿ç”¨çš„ <code>Dockerfile</code> å¦‚ä¸‹ï¼š</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:buster</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install -y --no-install-recommends \</span></span><br><span class="line"><span class="bash">        vim \</span></span><br><span class="line"><span class="bash">        curl \</span></span><br><span class="line"><span class="bash">        git \</span></span><br><span class="line"><span class="bash">        make \</span></span><br><span class="line"><span class="bash">        ca-certificates \</span></span><br><span class="line"><span class="bash">        gnupg \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -fsSL <span class="string">"https://download.docker.com/linux/debian/gpg"</span> | apt-key add -qq - &gt;/dev/null \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"deb [arch=amd64] https://download.docker.com/linux/debian buster stable"</span> &gt; /etc/apt/sources.list.d/docker.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update -qq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install -y -qq --no-install-recommends docker-ce-cli \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span><br></pre></td></tr></table></figure><p>å®šä¹‰å¥½ jenkinsfile æ–‡ä»¶å¹¶ä¸”æ„å»ºå¥½ pod æ¨¡æ¿ä¸­çš„é•œåƒåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ä½¿ç”¨å®ƒæ¥åˆ›å»ºæµæ°´çº¿ä»»åŠ¡ã€‚</p><h2 id="æµæ°´çº¿"><a href="#æµæ°´çº¿" class="headerlink" title="æµæ°´çº¿"></a>æµæ°´çº¿</h2><ul><li>åœ¨ Jenkins ä¸Šæ–°å»ºä¸€ä¸ªä»»åŠ¡ï¼Œé€‰æ‹©ä»»åŠ¡çš„ç±»å‹ä¸º <code>æµæ°´çº¿</code></li></ul><p><img src="https://p.k8s.li/image-20210306185651025.png" alt="image-20210306185651025"></p><ul><li>å°†å®šä¹‰å¥½çš„ Jenkinsfile å†…å®¹å¤åˆ¶ç²˜è´´åˆ°æµæ°´çº¿å®šä¹‰ <code>Pipeline script</code> ä¸­å¹¶ç‚¹å‡»ä¿å­˜ã€‚åœ¨æ–°å»ºå¥½çš„ Job é¡µé¢ç‚¹å‡» <code>ç«‹å³æ„å»º</code> æ¥è¿è¡Œæµæ°´çº¿ä»»åŠ¡ã€‚</li></ul><p><img src="https://p.k8s.li/image-20210306185838845.png" alt="image-20210306185838845"></p><ul><li>åœ¨ kubernetes é›†ç¾¤çš„æœºå™¨ä¸Šä½¿ç”¨ kubectl å‘½ä»¤æŸ¥çœ‹ pod æ˜¯å¦æ­£å¸¸ Running</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@jenkins:~ <span class="comment"># kubectl get pod</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">jenkins-webps-9-bs78x-5x204   2/2     Running   0          66s</span><br></pre></td></tr></table></figure><ul><li>Job æ­£å¸¸è¿è¡Œå¹¶ä¸”çŠ¶æ€ä¸ºç»¿è‰²è¡¨æ˜è¯¥ job å·²ç»æˆåŠŸæ‰§è¡Œäº†ã€‚</li></ul><p><img src="https://p.k8s.li/image-20210306190124096.png" alt="image-20210306190124096"></p><ul><li>åœ¨ kubernetes é›†ç¾¤æœºå™¨ä¸ŠæŸ¥çœ‹ docker é•œåƒæ˜¯å¦æ„å»ºæˆåŠŸ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@jenkins:~ <span class="comment"># docker images | grep webps</span></span><br><span class="line">webps                                0.3.2-rc.1          f68f496c0444        20 minutes ago      13.7MB</span><br></pre></td></tr></table></figure><h2 id="è¸©å‘"><a href="#è¸©å‘" class="headerlink" title="è¸©å‘"></a>è¸©å‘</h2><ul><li>pod æ— æ³•æ­£å¸¸ Running</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Running <span class="keyword">in</span> Durability level: MAX_SURVIVABILITY</span><br><span class="line">[Pipeline] Start of Pipeline</span><br><span class="line">[Pipeline] podTemplate</span><br><span class="line">[Pipeline] &#123;</span><br><span class="line">[Pipeline] node</span><br><span class="line">Created Pod: kubernetes default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-9wm0r</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-9wm0r][Scheduled] Successfully assigned default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-9wm0r to jenkins</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-9wm0r][Pulling] Pulling image <span class="string">"debian:buster"</span></span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-9wm0r][Pulled] Successfully pulled image <span class="string">"debian:buster"</span> <span class="keyword">in</span> 2.210576896s</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-9wm0r][Created] Created container debian</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-9wm0r][Started] Started container debian</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-9wm0r][Pulling] Pulling image <span class="string">"jenkins/inbound-agent:4.3-4-alpine"</span></span><br><span class="line">Still waiting to schedule task</span><br><span class="line">â€˜debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-9wm0râ€™ is offline</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-9wm0r][Pulled] Successfully pulled image <span class="string">"jenkins/inbound-agent:4.3-4-alpine"</span> <span class="keyword">in</span> 3.168311973s</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-9wm0r][Created] Created container jnlp</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-9wm0r][Started] Started container jnlp</span><br><span class="line">Created Pod: kubernetes default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-qdw4m</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-qdw4m][Scheduled] Successfully assigned default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-qdw4m to jenkins</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-qdw4m][Pulled] Container image <span class="string">"debian:buster"</span> already present on machine</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-qdw4m][Created] Created container debian</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-qdw4m][Started] Started container debian</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-qdw4m][Pulled] Container image <span class="string">"jenkins/inbound-agent:4.3-4-alpine"</span> already present on machine</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-qdw4m][Created] Created container jnlp</span><br><span class="line">[Normal][default/debian-35a11b49-087b-4a8c-abac-bd97d7eb5a1f-fkmzq-qdw4m][Started] Started container jnlp</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å› ä¸º Jenkins pod ä¸­çš„ jnlp å®¹å™¨æ— æ³•è¿æ¥  Jenkins masterã€‚å¯ä»¥æ£€æŸ¥ä¸€ä¸‹ Jenkins master ä¸Š <code>ç³»ç»Ÿç®¡ç† &gt; èŠ‚ç‚¹ç®¡ç† &gt; Configure Clouds</code> ä¸­ <code>Jenkins åœ°å€</code> å’Œ <code>Jenkins é€šé“</code> è¿™ä¸¤ä¸ªå‚æ•°æ˜¯å¦é…ç½®æ­£ç¡®ã€‚</p><h2 id="ç»“æŸ"><a href="#ç»“æŸ" class="headerlink" title="ç»“æŸ"></a>ç»“æŸ</h2><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†è®© Jenkins å¤§å”ä¸ kubernetes èˆ¹é•¿æ‰‹ç‰µæ‰‹ğŸ§‘â€ğŸ¤â€ğŸ§‘å•¦ï¼ä¸Šé¢ä½¿ç”¨äº†ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥å±•ç¤ºäº†å¦‚ä½•å°† Jenkins çš„ Job ä»»åŠ¡è¿è¡Œåœ¨ kubernetes é›†ç¾¤ä¸Šï¼Œä½†åœ¨å®é™…å·¥ä½œä¸­é‡åˆ°çš„æƒ…å½¢å¯èƒ½æ¯”è¿™è¦å¤æ‚ä¸€äº›ï¼Œæµæ°´çº¿éœ€è¦é…ç½®çš„å‚æ•°ä¹Ÿè¦å¤šä¸€äº›ã€‚é‚£ä¹ˆæˆ‘å°†ä¼šåœ¨ä¸‹ä¸€ç¯‡åšå®¢ä¸­å†è®²ä¸€ä¸‹é«˜çº§çš„ç”¨æ³•ï¼šä½¿ç”¨ Jenkins å®Œæˆ kubespray ç¦»çº¿å®‰è£…åŒ…æ‰“åŒ…ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><p><a href="https://jenkins-zh.cn/wechat/articles/2020/03/2020-03-10-create-a-ci-cd-pipeline-with-kubernetes-and-jenkins/" target="_blank" rel="noopener">ä½¿ç”¨ Kubernetes å’Œ Jenkins åˆ›å»ºä¸€ä¸ª CI/CD æµæ°´çº¿</a></p></li><li><p><a href="https://www.qikqiak.com/k8s-book/docs/36.Jenkins%20Slave.html" target="_blank" rel="noopener">åŸºäº Jenkins çš„ CI/CD (ä¸€)</a></p></li><li><p><a href="https://a-wing.top/kubernetes/2021/01/27/jenkins_and_kubernetes.html" target="_blank" rel="noopener">PingCAP é¢è¯•ï¼šJenkins å’Œ Kubernetes</a></p></li><li><p><a href="https://www.chenshaowen.com/blog/using-podman-to-build-images-under-kubernetes-and-jenkins.html" target="_blank" rel="noopener">åŸºäº Kubernetes çš„ Jenkins æœåŠ¡ä¹Ÿå¯ä»¥å» Docker äº†</a></p></li><li><p><a href="https://www.chenshaowen.com/blog/jenkins-pipeline-usging-and-debug.html" target="_blank" rel="noopener">Jenkins Pipeline ä½¿ç”¨åŠè°ƒè¯•</a></p></li><li><p><a href="https://www.chenshaowen.com/blog/creating-jenkins-slave-dynamically-on-kubernetes.html" target="_blank" rel="noopener">åœ¨ Kubernetes ä¸ŠåŠ¨æ€åˆ›å»º Jenkins Slave</a></p></li><li><p><a href="https://www.chenshaowen.com/blog/jenkins-x-is-not-jenkins-but-stack.html" target="_blank" rel="noopener">Jenkins X ä¸æ˜¯ Jenkins ï¼Œè€Œæ˜¯ä¸€ä¸ªæŠ€æœ¯æ ˆ</a></p></li><li><p><a href="https://atbug.com/using-role-based-authorization-strategy-in-jenkins/" target="_blank" rel="noopener">Jenkins CI/CD (ä¸€) åŸºäºè§’è‰²çš„æˆæƒç­–ç•¥</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot;
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubernetes" scheme="https://blog.k8s.li/tags/kubernetes/"/>
    
      <category term="Jenkins" scheme="https://blog.k8s.li/tags/Jenkins/"/>
    
  </entry>
  
</feed>
