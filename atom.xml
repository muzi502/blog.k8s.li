<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Reimu&#39;s blog</title>
  <icon>https://blog.k8s.li/icon.png</icon>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.k8s.li/"/>
  <updated>2024-06-13T16:00:00.000Z</updated>
  <id>https://blog.k8s.li/</id>
  
  <author>
    <name>Reimu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>端午节游玩：徒步、骑行、跑山</title>
    <link href="https://blog.k8s.li/travel-in-june.html"/>
    <id>https://blog.k8s.li/travel-in-june.html</id>
    <published>2024-06-13T16:00:00.000Z</published>
    <updated>2024-06-13T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>转瞬间距上一次更新博客快半年了，主要是这段时间在享<a href="https://www.thepaper.cn/newsDetail_forward_3291793">福报</a>，享完福报后周末就开车拉着同事去徒步游玩放松一下，因此实在是没有心情来写博客（其实是自己懒，找个借口自欺一下自己 😔</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/image-20240607205814023.png"></p><p>不过好在端午节前终于修完了所有的 ticket，QE 小伙伴也完成了第一轮测试，项目终于取得了一个阶段性的成果，没了这个烦恼心情自然好了很多。正好端午节完成了一次环千岛湖骑行，就想着和《<a href="https://blog.k8s.li/taihu.html">2021 五一假期环太湖骑行之旅</a>》一样，水一篇博客来记录一下游玩时的所思所想以及所见所闻吧。那么咱们就开始回顾下端午节游玩的经历吧 😇</p><h2 id="计划篇"><a href="#计划篇" class="headerlink" title="计划篇"></a>计划篇</h2><h3 id="饭搭子"><a href="#饭搭子" class="headerlink" title="饭搭子"></a>饭搭子</h3><p>在《<a href="https://blog.k8s.li/honda-civic.html">考驾照和买二手车</a>》里曾提到过，自从去年买车之后就和同事入坑了户外徒步，每个月都会和同事一起自驾去江浙附近徒步游玩。因为一起出去玩儿的次数多了，和其中两位同事的关系也就密切了很多。其中一位是前端开发，另一位是 UI 设计师，为了后面叙述方便，就分别简称他俩为 FE 和 UI 好了。在公司每到饭点，我们仨个就一起去楼下吃麻辣烫或者油泼面，再或者晚上下班后一起骑车去耀华路附近的路边摊吃炒饭。时间长了，三个人的关系就变得非同一般了，这也是我毕业后工作五多年来结交的关系最好的两个朋友。之前在公司都是做一个小透明，就像学校里的<a href="https://zh.wikipedia.org/wiki/%E6%AD%B8%E5%AE%85%E9%83%A8">归宅部</a>，下班后就早早溜回家一个人玩泥巴，也不太参与同事之间的社交。这种局面从去年我买车之后才开始真正改变，不得不说有了一辆车之后，生活的确改变了很多，变得越来越现充了。</p><h3 id="熊野古道徒步"><a href="#熊野古道徒步" class="headerlink" title="熊野古道徒步"></a>熊野古道徒步</h3><p>早在过年之前，另一位同事（也是前端开发）和 UI 就计划清明节休假几天去日本田边市和歌山的<a href="https://www.tb-kumano.jp/tw/kumano-kodo/suggested-walks/">熊野古道</a>徒步。春节期间开车回老家顺路送 UI，UI 在车里开始学日语五十音。我们周末出去徒步游玩的时候 UI 也在车里跟着多邻国学日语，有时候他突然蹦出来一句日语，整得我们一阵欢声笑语。</p><p>不过好景不长，正当 UI 每日充满期待干劲满满地学日语的时候，在 3 月底公司迎来了一波裁员，不幸 UI 在裁员的队列中。得知被裁的消息后，UI 直接愣住了，给我说的第一句话居然是：我被裁了，熊野古道徒步去不了了。我赶紧安抚他说：裁员是小事，熊野古道徒步还是要去，因为机会难得，现在放弃了会让你后悔一辈子。UI 听从了我的建议端午节和另一位同事去了熊野古道。</p><p>四月底的时候，同事在我们徒步小队微信群里说端午节期间上海到名古屋的往返机票只要 1500 出头，赶紧冲冲冲鸭。当时我就萌生了想要去熊野古道徒步的打算，于是就立马在淘宝上找了个旅行社准备办一个三年多次的赴日签证。因为当时再过几天就到五一假期了，就行动起来准备签证材料。还好准备的都比较顺利，在五一放假前旅行社就牵收到了我邮寄的材料。五一过后大概等了七个工作日，签证就顺利办下来了。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/image-20240612071324128.png"></p><p>签证下来后，正准备定酒店和机票，就在那时自己负责的项目出现了风险要延期发布了。当时有点纠结端午节究竟要不要休假去熊野古道徒步。那天正好到了和 leader 每个月 1:1 的时间点，就想着等和 leader 1:1 后再做决定吧。和 leader 1:1 后感觉要凉了，因为端午节前 QE 会完成第一轮的测试，端午节后要进行第二轮的回归测试，由于要搭配两个产品的版本发布，第二轮的回归测试要在这两个版本上分别测一遍。赶在 6 月底项目发布，QE 测试的压力会很大，因此需要投入研发的人力到回归测试中。当时就没有再考虑，果断放弃了熊野古道徒步的计划，等到以后项目发布之后再去吧。端午节就像往常一样，和饭搭子一块去江浙附近徒步游玩吧。</p><h3 id="UI-被裁"><a href="#UI-被裁" class="headerlink" title="UI 被裁"></a>UI 被裁</h3><p>因为设计组的 leader 要求极其严格，在设计组工作会顶着巨大的压力。去年一个设计师因无法忍受 PUA 拷打就跳槽去了字节，今年五月底的时候另一位设计师也受不了 PUA 就裸辞了，真佩服她们的勇气。被裁对于 UI 来说或许是一种解脱，每次出去徒步的时候 UI 都会和我们哭诉各种 PUA 拷打的细节。比如交付的设计稿上有考虑不周全或细节不到位的地方，leader 就会在设计稿上疯狂 comment，给你一种巨大的压迫感让你无所适从；再比如 UI 在一次组会上分上了我们周末和同事一起徒步游玩的快乐日常，然后当 UI</p><p>看到 UI 的遭遇，有时会会觉着不同的团队领导风格确实会。</p><p>在《<a href="https://blog.k8s.li/2021.html">时光痕迹：2021 年总结</a>》给大家分享过从字节跳槽来我们公司的经历。在字节的时候我是做 K8S PaaS 容器云平台的运维部署相关的内容，Golang 后端开发接触的并不是很多。当时已经拿到了心动 TapTap 系统运维工程师的 Offer，而且十分喜欢心动这种二次元浓度很高的游戏公司，当时是很想去的。</p><h3 id="FE-离职"><a href="#FE-离职" class="headerlink" title="FE 离职"></a>FE 离职</h3><h3 id="环千岛湖骑行"><a href="#环千岛湖骑行" class="headerlink" title="环千岛湖骑行"></a>环千岛湖骑行</h3><p>五一假期的时候和饭搭子一块去台州仙居的公盂村以及神仙居景区徒步游玩了几天，可能是路途遥远加上徒步也比较累，端午节 FE 想去享福躺平型的路线，不想再像五一那样那么累了。而 UI 也没有主见，觉着去哪里都可以。期间想过去绍兴东白山露营观星，不过由于天气原因被否了；也想过去嵊泗海岛游玩，但担心由于天气原因被困在岛上买不到回来的票就放弃了；也想过去台州温岭的水桶岙徒步赶海，因为是徒步路线也被 FE 否掉了。就这样大家纠结了很久也没有想好要去哪儿，既然这样那这次就单独行动，自己一个人出去玩儿吧。</p><p>在石头星球和游侠客小程序上都看到了千岛湖两天一夜的骑行玩法，就想着要不端午节来一次环千岛湖骑行，嗯，可以可以，冲冲冲。于是看了下江浙附近的天气预报，说是周六有小雨、周日阴天、周一多云。又看了下环千岛湖骑行的轨迹，不到 140 公里，骑两天感觉太轻松，不如挑战一下自己，一天完成环千岛湖骑行？那就定下了周日完成环千岛湖骑行。</p><p>又接着看了去千岛湖的导航路线，会路过富阳和绍兴，那周六就选择一个在富阳的徒步路线，于是就找到了<a href="https://www.2bulu.com/community/gotohuatinfo.htm?id=ZRcf7qbTjLO8jmiMc8ZMEg==&type=">杏梅尖</a>。然后又看了下回来时的路线，可以绕一点远路去王位山跑山，然后再从莫干山景区附近上 S12 申嘉湖高速回上海。去年 12 月底的时候和饭搭子去过一次王位山徒步，感觉那里的山路真的不错，有杭州秋名山之称，十分适合跑山（练习排水沟过弯）。</p><p>于是端午节大体的游玩计划初步成型：</p><ul><li>Day1：富阳杏梅尖徒步，13 公里爬升 1000 米；</li><li>Day2：环千岛湖 138 公里骑行；</li><li>Day3：余杭王位山跑山，练习排水沟过弯 🤣；</li></ul><p>和往常出去游玩时一样，在 Notion 上制定了一个游玩时的计划表：</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/image-20240610203217734.png" alt="image-20240610203217734"></p><h2 id="准备篇"><a href="#准备篇" class="headerlink" title="准备篇"></a>准备篇</h2><h3 id="公路车"><a href="#公路车" class="headerlink" title="公路车"></a>公路车</h3><p>在《<a href="https://blog.k8s.li/taihu.html">2021 五一假期环太湖骑行之旅</a>》的时候骑行用的车子是 2012 款 GIANT 捷安特 ATX770-D，这辆车子从杭州搬家来上海的时候也一并带来了，一直用它骑行上下班。在去年四月份的时候想换一辆公路车了，因为 ATX770-D 车身太重骑行起来比较累，于是就在闲鱼上花了 1500 买了辆二手的捷安特 ROAM 2 跨界公路车。这辆车一个特点就是车架是山地车，轮圈可以装山地车宽胎，也可以装公路车窄胎，算是公路车和山地车的缝合怪 😂。自从把买来后它一直是我主力代步工具，每天都会骑着它上下班，这次的环千岛湖骑行就准备带着它去。</p><p>这辆 ROAM2 公路车本身没有太多问题，前段时间后轮辐条断了一根。去公司附近的捷安特专卖店问了下可以修但配件等的时间比较久，但我感觉是只换一根辐条修车的利润比较少，店员不想给修。于是就自己买来辐条进行更换，顺带更换了下前后轮的外胎和内胎。</p><h3 id="小区停车"><a href="#小区停车" class="headerlink" title="小区停车"></a>小区停车</h3><p>由于小区停车很难，对于咱这种实力（习）期的新手而言简直就是噩梦。有好几次停进来的时候很顺利，开出去的时候由于旁边的车停得不讲武德导致我出库的时候被卡住，每次都要保安指挥或者打电话让车主来挪车才能出来：</p><ul><li>我们小区的车道是一个 U 形的单行路，路的左侧可以侧位停车，然后路的右侧有一些画库位线的车位，当侧位停的车太靠外的时候就会导致右侧的车右转出来的时候没有足够转弯半径，由于这被卡住过一次。然后保安指挥了我很久仍没能将车开出来，最后保安只能骂骂咧咧地联系车主让他来挪车，我觉着应该不是我菜 😅；</li><li>我们楼下也有一排车位，当车位满了的时候有些车主就直接停在路上，由此被堵住过三次，这种情况只联系车主来挪车，有的车主电话打不通，保安就会帮忙到车主家里叫他来挪车；</li><li>有车车停得很随意，不是右前轮压住库位线就是车头太靠前，旁边的车位想要左转出来的时候车轮就会碰到马路牙子，再加路不到两米宽，倒库和出库的时候都很极限地贴着旁车或者轮胎碰着路沿石。因为这被卡住一次，那时候保安让车主下来挪车往后倒一点就能将车开出来了；</li></ul><p>为了周六早上出发的时候车子不像往常一样被堵在车位里，周五早上就将车挪到了外面方便出库的位置。后来事实证明这样做是对的，周六早上出发的时候果然有辆车和往常一样停在路上，挡住了车位线里面的车。还好有先见之明，不然早上五点半多让车主来挪车，车主也是挺奔溃的。</p><h3 id="Ticket-修完啦"><a href="#Ticket-修完啦" class="headerlink" title="Ticket 修完啦"></a>Ticket 修完啦</h3><p>周五下午 TL 告诉我项目就剩最后一个待验证的 ticket 了，我瞅了一下 Jira 面板，哦豁，还真是耶。赶紧 DM 鼓励了一下 QE 小伙伴，加油加油，冲冲冲！等收到 ticket close 的邮件后，第一时间感谢了下 QE 小伙伴。这是我入职以来作为主力后端开发的第二个项目，也是我觉着最难的项目。第一轮测试结束算是一个阶段性的胜利，心情好了很多，之前一直在崩溃的边缘挣扎，今天终于要结束了。没了烦恼端午节就能有个好心情愉快地玩耍啦，在这里再次感谢我那位 QE 小伙伴。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/image-20240608200713378.png" alt="image-20240608200713378"></p><h3 id="收拾车子"><a href="#收拾车子" class="headerlink" title="收拾车子"></a>收拾车子</h3><p>忙完项目上的事情后看了下时间大概五点多了，就赶紧骑车溜回家，因为要把在骑的这辆公路车塞到我那辆思域车里，还不确定车里能不能放得下，为了以防万一就早点回家吧，要是真的放不下也有时间想办法来处理，不至于忙到天黑。</p><p>到家后，就将公路车的车轮和车座拆下，并用塑封膜包裹住链条和牙盘的部分，以免油泥擦碰到车上。刚开始试着将车子放进后备箱，调整了好几次都不太行。如果是辆两厢或者旅行车就好了，有点后悔当初买了三厢的思域。主要是三厢车后排放倒后空间还是很紧凑，容纳不下山地车横放的空间。于是试着把车子放在后排，没想到能完美地塞进去，就是挤占了后排的空间，不过这次就我一个人出来玩，后排不用坐人所以也没事儿。最后再用安全带固定主车架，以免禁止制动的时候车子由于惯性飞到前排来，这样吃席风险大大减少。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6177.JPG" alt="IMG_6177"></p><p>把车子装好之后就放心了，本以为放不下的，没想到后排的空间斜放一辆公路车还是绰绰有余滴，等到以后去莫干山或崇明岛骑行游玩的时候就可以采用相同的办法了，非常不戳。</p><h2 id="Day1-杏梅尖徒步"><a href="#Day1-杏梅尖徒步" class="headerlink" title="Day1 杏梅尖徒步"></a>Day1 杏梅尖徒步</h2><h3 id="出发"><a href="#出发" class="headerlink" title="出发"></a>出发</h3><p>每次要出去玩儿的时候，头天晚上就兴奋地睡不着，有点像上学的时候放寒暑假的那天晚上一直睡不着，和宿舍下铺聊天到大半夜一样。晚上睡得不是很好，凌晨四点多就不知不觉醒来了，醒来后干瞪眼睡不着。距离出发还有两个小时，干瞪眼也是浪费时间，索性就起床打开笔记本开始整理博客，思考下这篇游记的内容。一直等到 5 点半左右，就起身洗脸刷牙收拾东西，开始出发了。</p><p>收拾好东西后，就下楼准备把车从车位开出来。下楼后发现果然有个大聪明把车停在出库的路上，幸好昨天早上我把车挪走了，不然今天又要打电话让他来挪车了。因此出门前做好规划，把一些潜在的问题提前规避掉，能省不少事儿。上午先导航到绍兴，去我姐那里拿帐篷以及一些其他的露营装备。这次的导航路线还是和往常一样：S32 申嘉湖高速 -&gt; G60 沪昆高速 -&gt; G1522 常台高速。在浦东出沪去往宁波或绍兴方向，如果是住在 S32 申嘉湖高速以北的地方，还是挺建议这里路线的。会比走 S20 外环高速 -&gt; G60 沪昆高速路况要好很多。因为 S20 外环高速和  G60 沪昆高速途径上海的主要城区，高速的出入口会很多，车流量也很大，节假肯定会堵车。而 S32 申嘉湖高速途径的地方基本上都是一些郊区，车流量会少一些，很少会遇到堵车的情况。不过等到今年 7 月份 <a href="https://www.dongchedi.com/article/7301984401263641138">S32 申嘉湖高速上海段免费</a>之后可能会有所不同了，毕竟还是会有很多人绕一点远路来白嫖这几十公里的高速费的 😂。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6139.PNG" alt="IMG_6139"></p><p>因为选择了路线比较通畅且出发的比较早，路上基本上没有遇到堵车的情况，一路很顺畅地来到了绍兴，从我姐那拿到帐篷后就继续出发前往富阳杏梅尖了。之所以来拿帐篷因为想着在千岛湖骑行的时候看看能不能在千岛湖找到一个合适的露营地点，晚上就不住酒店来露营。后来事实证明我太天真了，露营什么的根本就不存在。</p><h3 id="杏梅尖徒步"><a href="#杏梅尖徒步" class="headerlink" title="杏梅尖徒步"></a>杏梅尖徒步</h3><p>9 点半左右到达富阳瑶坞村，村子里的露天停车场收费 10 块。车子停好后，收拾好行李就开始跟着两步路上的轨迹徒步。富阳杏梅尖这条经典的徒步路线像空心户外、游侠客、浦东户外、华东户外每个月都会成团来的。这里不是一个正规开发的景区，不过好在当地建设和维护的都还不错，中途还有一个补给点可以休息。虽然这条路线 13 公里爬升 1000 米看着有点难度，但爬升的坡度还是相对轻松一些，不像之前去盐帮古道回来时 1.5 公里爬升 400 米那样十分陡峭难走。只要放慢节奏，正常人还是能走完全程的。</p><ul><li>午餐，一个大大的甜瓜就填饱肚子了 😋</li></ul><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6151.JPG" alt="IMG_6151"></p><ul><li>登顶杏梅尖，景色真不戳 😆</li></ul><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6167.JPG" alt="IMG_6167 2"></p><ul><li>途中的蚊虫很多，坐下休息的时候一只小蜜蜂落在我胳膊上</li></ul><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6161.JPG" alt="IMG_6161"></p><p>下山的时候看到一个很有意思的路标牌，上面写着 「<strong>很明显这里有条近路</strong>」，于是赶紧拍照发在我们的徒步小队微信群里。去年带饭搭子去覆卮山徒步，下山回来的时候因为我选择了抄近路把大家带到了一片深山老林里，在丛林里走了大半天差点就要叫救援，好在有惊无险最终安全下山了。从那以后我只要一提抄近路，就会引来他们的一阵嘲讽，调侃我这是大聪明行为 🤣。这次可是货真价实的近路，而 FE 回复：只有聪明的人才能看到的近路！哈哈，可能是因为那次抄近路翻车，我在他们心中的形象就变成了一个大聪明 😓。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6173.JPG" alt="IMG_6173"></p><p>顺着这条近路下山，小路周边被树木和芦苇覆盖的严严实实，有时候需要弯腰从这些茂密的树丛钻过去，有那么一点点丛林探险的感觉 😂。半路遇到一处小池子，在里面玩了会水，洗了洗就继续下山了。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6171.JPG" alt="IMG_6171"></p><p>到达停车场后才下午三点多，比预期回来早一个小时。当时太阳正烈，打开车门发现车内 50 多度。有点后悔没有带隔热的车衣，虽然挡风玻璃上撑开了遮阳伞，但隔热效果并不佳。50 多度简直像蒸拿房一样热，坐在这里一小会已经汗流浃背了，比中午在上山的时候还要热。于是导航看了下去千岛湖的路线，看看能不能在上高速前找个加油站休息会，顺便在阴凉的地方开空调让车内温度降下来。看地图导航发现去千岛湖的长深高速要堵车 30 分钟，原本一个半小时的车程现在要两个小时了。顺着路线找到了另一个高速入口刚好能绕过堵车的路段，附近还有一个加油站，十分合适，于是就开车前往加油站。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6175.JPG" alt="IMG_6175"></p><h3 id="停车费"><a href="#停车费" class="headerlink" title="停车费"></a>停车费</h3><p>出来村子的时候看到了有个宝马车主和村民小哥发生了冲突。因为杏梅尖这里并不是一个正规开发的景区，不是本村的车进村都要交 10 块钱的停车费。开宝马的老哥很任性，就是不想交这 10 块钱的停车费，想要从逆向车道硬闯过来，我刚好路过差一点点撞上，拿二维码收费的村民小哥也被气得骂骂咧咧地问候他全家。小哥帮我看了下车没有被剐蹭到，我就尴尬地调侃了下：你看吧，人与人之间的差距比宝马与思域的差距还要大。</p><p>虽然村民收停车费不是很正规也没有发票啥的，但这种情况我们徒步的时候也遇到的可多了，不过我们每次都会很爽快地交个停车费。10 块钱的停车费可以避免很多不必要的麻烦，总不能为了省个 10 块钱绕大半天找个车位。如果停的地方不合适的话说不定还会被贴违章罚款 200 块，再或者停路边被剐蹭了也不好弄，所以为了省事和节省时间成本我们都不会太计较这些。之前去绍兴的呼狗崖徒步的时候就停在农家里，收费 10 块；去台州仙居的时候村里的露天停车场收费 10 块；去宁波风车公路的时候在童夏家村，那里建设的比较好，村口会有停车收费的闸机，然后附近还有卫生间，周边的基础设施做的很好。尽管我们徒步游玩去的都是一些免费白嫖的路线，但和当地的村民相处还是很融洽的，从来没有发生过冲突。</p><p>所以嘛，出门在外，花点小钱可以摆平的事情还是不要发生不必要的冲突，和人吵一架一天的好心情就没了。在中国，尤其是农村，说点好话讲点人情世故，互相理解一下，相处起来就会很融洽。就像虽然我没有抽烟的习惯，但我车里仍然会放一包烟，真的遇到点麻烦事儿，给大哥大叔大爷啥的递根烟，说点好话人家还是很愿意帮忙的。之前我在小区停车被堵住的时候，我都会给保安大叔递根烟，说声谢谢麻烦啦等客套话，他都会很乐意帮忙指挥我把车开出来。因为帮的次数多了，慢慢就混熟了，在小区偶尔遇到了也会相互打招呼说两句。</p><h3 id="淳安县城"><a href="#淳安县城" class="headerlink" title="淳安县城"></a>淳安县城</h3><p>导航到加油站加完油，休息了一段时间继续前往淳安县城。下高速进入到淳安县城后，道路就变得十分离谱。双向两车道开着开着右侧的非机动车道就变成了机动车道，然后一过红绿灯又强行变成了两车道，我满脸？？？。然后旁边非机动车道的车就被强行挤了过来，每过路口的时候都要留意一下，还有次险些撞上。还有一些机动车直接开在非机动车道，遇到前面有电驴的时候又加塞过来，开车体验极差。</p><p>更离谱的是酒店门口大概有十个画车位线的车位，这些画车位线的车位都不是酒店的，而是政府规划的。停车按小时收费，每小时 5 块，停一天要 60。然后酒店住客的车就停在车位线外面的一些狭窄空位上。经过酒店保安大叔的指挥总算在一个犄角旮旯里停好了车。停好车后就把山地车拿出来装上轮子，轮子装上后发现刹车盘会蹭碟刹片，一顿操作猛如虎，调试了大半天还是会蹭那么一点点，先就这样凑活着吧，又不是不能骑。</p><p>晚上没有吃饭，简单吃了点水果和粽子就算填饱肚子了。拿出笔记本整理了下今天的日记，就睡了，希望明天的环千岛湖骑行能顺利一些。</p><h2 id="Day2-环千岛湖骑行"><a href="#Day2-环千岛湖骑行" class="headerlink" title="Day2 环千岛湖骑行"></a>Day2 环千岛湖骑行</h2><h3 id="出发-1"><a href="#出发-1" class="headerlink" title="出发"></a>出发</h3><p>之前看天气预报说是千岛湖周六有雨周日多云的，没想到周日早上开始下雨了。用彩云天气看了下，上午会一直下雨，中午会停一会。八点半之后雨会小一些，于是就想着等雨小一点再去骑行吧。如果因为下雨就放弃了感觉还是挺遗憾的。就这样一直等到 9 点左右，雨终于小了一些。已经九点了，再不出发晚上回来就要走夜路是十分危险的。当时内心还是有一点退缩想要放弃的想法，不过又想起了一位推友的话：</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/image-20240612215737254.png" alt="image-20240612215737254"></p><p>如果放弃了，我可能会后悔一辈子，所以即便还在零星下着小雨，毅然决然还是出发了。雨中骑行，铁憨憨是我又怎么啦！冲冲冲！</p><h3 id="骑行"><a href="#骑行" class="headerlink" title="骑行"></a>骑行</h3><p>刚开始骑行的时候就遇到了不顺，由于昨晚没有调整好轮组，刹车碟片会一直蹭外层的刹车片，相当于踩着 10% 的刹车在骑，导致骑起来特别费劲。于是不得不停下来调整轮组的角度，让它刚好卡在一个不碰刹车片的位置。当时雨还突然下大了，穿着雨衣热得满头大汗，再加上忘记带毛巾了，十分地狼狈。不过好在经过一顿操作终于调整好了。调整好车子后就继续骑行，刚开始的一段距离特别难走，因为下雨怕身体被雨淋失温就不得不披着雨衣，雨衣又不透气，出汗之后汗水顺着胳膊流到袖口，手一甩就一大把汗水。，就像一只落汤鸡，好狼狈。</p><ul><li>在桥上遇到了一些驴友，看来雨中骑行的铁憨憨不止我一个 🤡，心态瞬间好了很多。</li></ul><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6189.JPG" alt="IMG_6189"></p><p>从九点一直骑行到 11 点半，中途休息了十几分钟。出发时只带了一瓶水，刚开始骑行的了大概 20 多公里仍然没有找到一家超市可以买水和。路上刚好碰见一个卖杨梅的老奶奶，就从她那里买了一小筐杨梅。顺便问了下老奶奶附近有没有吃饭的地方，她说还比较远，骑车可能要 20 分钟。老奶奶看着我可怜兮兮的样子，就从饭盒里拿出一个自家做的包子要送给我，让我填一下肚子。当时感觉好尴尬 😅，我就厚着脸皮有点不好意思地接受了。豆腐馅的包子是我喜欢吃的，真好。吃着吃着鼻子一酸，莫名其妙想起了已故的奶奶，小时候经常和弟弟偷偷摸摸向奶奶要零花钱，回想起那一幕着真的好怀念。想起《寻梦环游记》中的一段台词：<strong>死亡不是生命的终点，遗忘才是</strong>。</p><p>吃完包子和杨梅后就继续向前出发，争取十二点前找到一家农家乐吃午饭补充下体力。终于上午骑行了 50 公里后到了一家农家乐，在里面点了一份蛋炒饭和一瓶柚子汁。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6192.JPG" alt="IMG_6192"></p><p>吃饭的时候听农家乐老板讲了一段故事：他之前是上海的武警，退役之后在杭州找了份工作，这里的农家乐是租的当地村民的房子开的。他们周末会开车来这里，因为他们夫妻俩不想一直生活在大城市里，周末和节假日就来千岛湖这里体验农村的生活，这里是他们的第二个家。听的着实有些羡慕，整得我都有点想把父母接来南方农村生活了。</p><p>吃完饭后在院子里休息了一会就继续出发，现在才骑行了 50 公里，还不到一半。于是就给自己定下了等骑行到 70 公里的时候再休息一会。中途遇到了一片雏菊花田，就在附近拍照休息了一小会。这里一瓜人都没有，独享这番美景，真不错 😌。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6194.JPG" alt="IMG_6194"></p><p>偶见老大哥标语 「<strong>绿水青山就是金山银山</strong>」。如果和饭搭子 UI 一起来，看到这个标语后肯定又开始键政了 😂。每次和 FE 以及 UI 我们仨出去徒步的时候，政治和历史是必聊的话题，一些无关的话题聊着聊着就会扯上政治。关于政治话题，虽然我们仨的观点都各不相同，有时候也会争论的面红耳赤，不过都能互相包容理解对方，不会像小粉红那样友谊小船说翻就翻。我觉着这也是我们几个能经常聚在一起玩的原因吧，朋友之间的友谊会像生物学进化论那样经过一层层筛选和进化，那些与你相处不来的人可能玩个一两次因为观念不和就分开了。而最终能长久陪你玩下去的那些人，都是会容忍并包容你身上的缺点以及那些不和的观念。</p><p>说到政治，之前在《<a href="https://blog.k8s.li/One-Year-After-the-Lockdown-in-Shanghai.html">写在上海封城一年之后</a>》曾提到过：「或许我们已经早已经听惯了<strong>你不关心政治政治会来关心你</strong>这句废话，但当经历了这场灾难（防疫闹剧）之后，我们或多或少地能感触到<strong>一个国家的政治气候的变化是如何深刻地影响和限制人类生存的状态和生存的可能</strong>。在某些性命攸关的时刻，政治它直接或间接地决定了我们还能不能在这个世界生存下去。」</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6197.JPG" alt="IMG_6197"></p><p>有一段下坡了，为了节省体力想多白嫖一些重力势能（大雾，就骑行得特别快，速度已经达到了 56KM&#x2F;h，当时如果稍不留神就有可能当场吃席，还好作为一个骑车驾龄 20 多年的老司机比较稳没有翻车 🤣。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6201.JPG" alt="IMG_6201"></p><p>休息完后就继续出发，现在差不多已经骑行了一半的路程了，还有 70 公里到终点。继续加油加油，冲冲冲！</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6203.JPG" alt="IMG_6203"></p><p>到了下午五点左右，还剩 30 公里的路程，如果顺利的话 6 点半前就可以到达终点。而这时天气又开始下雨了，虽然不是很大但看天气预报 6 点之后雨量会增大。休息了一会就继续赶路，刚骑没多久在十字路口遇到两个老哥，他俩的充电宝因为上午下雨淋坏了，然后一个人手机没电了，另一个手机还剩百分之十的电。因为如果骑行回淳安县城酒店必须要看轨迹导航的，这点电量肯定是不够的。看了下我带的充电宝，还有 30% 的电量，应该够他们用的了，也没顾虑啥就借给了他俩，希望他们能安全到达淳安县城吧。</p><h3 id="摔车"><a href="#摔车" class="headerlink" title="摔车"></a>摔车</h3><p>就在最后五公里的时候，雨就突然下大了起来，不得不穿上雨衣，顶着大雨继续骑行。在最后两公里，路过千岛湖大桥的时候不幸发生了点意外。当时我记得清清楚楚我骑在了红色的非机动车道上，但到了千岛湖大桥后就没了非机动车道。我就选择骑在了桥的高台上，那是一条瓷砖路，下雨之后路就特别地滑，当时一直纠结要不要把车放到机动车道去骑，这样会更安全一点？正想着要不要停下来到机动车道上骑，前轮就突然侧滑了，连车带人直接从高台上摔了下来。摔到后的第一反应就是连滚带爬赶紧躲到高台上，以免被机动车碾压到。或许是求生本能的挣扎，那一刻肾上腺素急剧上升，反应十分迅速，没有半点拖泥带水。伴随着心脏砰砰地跳动，坐在高台上久久才缓过来，感觉就像从鬼门关走了一遭。旁边机动车道中的车辆见到我的车子摔倒在路边后也很热心地打开双闪停了下来，我挥了挥手说没事儿他就慢慢地开走了。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6209.JPG" alt="IMG_6209"></p><h3 id="归来"><a href="#归来" class="headerlink" title="归来"></a>归来</h3><p>终于在 7 点前安全到达酒店，把车子锁在路边的栏杆上就感紧到房间洗了个热水澡，顺带叫了一份外卖。吃饭的时候之前遇到的那两个老哥也将充电宝送到酒店的前台，保安帮忙上楼送到了房间。真好，人与人之间的信任就是这样奇妙，你怎么对待别人比人就怎么对待你。吃完饭后太累了很快就睡着了，本想着今晚要在千岛湖附近找个地儿露营来着，看来是我多想了，骑行归来后这么累而且这么大的雨去露营脑袋真的被驴踢了。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6879.jpg" alt="IMG_6879"></p><h2 id="Day3-王位山跑山"><a href="#Day3-王位山跑山" class="headerlink" title="Day3 王位山跑山"></a>Day3 王位山跑山</h2><h3 id="出发-2"><a href="#出发-2" class="headerlink" title="出发"></a>出发</h3><p>早上醒来后就收拾东西准备出发，6 点之后可能还要下雨。昨晚回来后车子锁在了路边还没有收拾，今早要赶在下雨前把我那辆公路车拆下来重新塞回思域车里。收拾好车子后，让保安帮忙指挥将车开到路边，就导航出发前往王位山。</p><h3 id="跑山"><a href="#跑山" class="headerlink" title="跑山"></a>跑山</h3><p>这里给大家解释一下，跑山并不是我跑着 🏃 在山里瞎逛，而是开车在山路狂飙，属实有点鬼 👻 火 🔥 少年行为 🌚。平时在家吃饭的时候会刷一些交通事故的电子榨菜视频，学习一下防御性驾驶。每当看到一些鬼火少年骑摩托在山路飙车压弯摔进排水沟里时，弹幕评论都会嘲笑他们为<strong>又菜又爱玩儿</strong>。然后还会看一些教你怎么开车跑山的视频，比如 <a href="https://www.bilibili.com/video/BV1Md4y1474T">90% 老司机不会！开 BRZ 跑山悟出的十条道理！慢进快出、左脚刹车</a>、<a href="https://www.bilibili.com/video/BV1KG41137Dc">手动档跑山的正确操作方式!别被假老司机各种错误操作忽悠了</a>、<a href="https://www.bilibili.com/video/BV1JU4y1g7pG">跑山需谨慎，思域上演排水渠过弯</a>。排水渠过弯其实也是一种嘲讽，就是出弯的时候车子推头导致失控前轮一头扎进路边排水沟里，这时你只能打电话叫救援把车拖出来了，妥妥滴<strong>又菜又爱玩儿</strong>。</p><p>不过这次跑山的体验还可以，总共有六十多个弯，其中有十几个发卡弯，十分有挑战性。尤其是在过发卡弯的时候，因为入弯后的坡度很大，不得不用一档全油门轰上去，转速直接拉到六千转，那种燃油车发动机嗡嗡嗡的巨响真的巨爽。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/IMG_6227.JPG" alt="IMG_6227"></p><p>正因为现在还单身，所以还有大把的时间来体验这种驾驶乐趣，感受这种人车合一的操纵感，试探出人和车的一个极限，是可以提升自己的驾驶技术的，这样也能在一些紧要关头作出正确的反应来自救。不过鬼火少年终究还是会成长的，等将来我有了老婆和孩子，我开手动挡绝对比开 CVT 自动挡还要稳。因为那时候身上已经有了责任，要安全驾驶保护好家人，不能再像现在这样瞎玩了。哈哈哈，开个玩笑，将来我也可能单身一辈子，只是徒步的时候遇到过一些家长带着孩子出来玩，有点羡慕这样的生活，所有偶尔也会想象一下将来这样的生活也未尝不可。</p><h3 id="回家"><a href="#回家" class="headerlink" title="回家"></a>回家</h3><p>跑完山后在周边镇子上逛了一会就返航回家，在服务区简单吃了顿午饭在车里休息了一会，玩了两天多了确实有点累了。到家后收拾完车里的东西，将车开到空地上，自己动手洗了下车。端午假期就这样完美结束了 🎉</p><h2 id="总结篇"><a href="#总结篇" class="headerlink" title="总结篇"></a>总结篇</h2><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul><li>雨天骑行很危险，一定好多家小心带好保命头盔，自从回来后我每天上下班路上骑车都会带上头盔，虽然长这么大骑车没摔过；</li><li>整体的计划完成度 90%，因为下雨的关系导致周日露营取消了。其实露营也不太现实，因为骑行回来后身心疲惫只想洗个热水澡躺床上睡大觉，去露营睡帐篷不妥妥找罪受吗；</li><li>行程去的地方都是冷门小众免费的路线，不存在堵车，也没有人山人海排队现场，游玩体验极佳；</li></ul><h3 id="费用"><a href="#费用" class="headerlink" title="费用"></a>费用</h3><p>端午节三天大概花了 1200 左右，其中油费高速费就花了 732、住宿花了 262、吃的就花了 157。花了 1200 独自一人游玩三天，感觉这个体验还是挺值的。</p><p><img data-src="https://p.k8s.li/2024-06-10-travel-in-june/image-20240612224210576.png" alt="image-20240612224210576"></p><h2 id="尾声"><a href="#尾声" class="headerlink" title="尾声"></a>尾声</h2><p>洋洋洒洒写完这篇游记才发现不知不觉已经水了一万多字了 🥲，可能是我很久没有写博客太想表达自己的一些内心想法和感受了，终于找回了之前坚持写博客的那种感觉。后面有机会再写一写技术相关的博客吧，不然我要变成一个生活博主了？感谢大家看完我这么多废话，谢谢大家的陪伴。祝大家生活愉快，开开心心 😋。</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;转瞬间距上一次更新博客快半年了，主要是这段时间在享&lt;a
        
      
    
    </summary>
    
    
      <category term="生活" scheme="https://blog.k8s.li/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
      <category term="生活" scheme="https://blog.k8s.li/tags/%E7%94%9F%E6%B4%BB/"/>
    
      <category term="骑行" scheme="https://blog.k8s.li/tags/%E9%AA%91%E8%A1%8C/"/>
    
      <category term="徒步" scheme="https://blog.k8s.li/tags/%E5%BE%92%E6%AD%A5/"/>
    
      <category term="自驾" scheme="https://blog.k8s.li/tags/%E8%87%AA%E9%A9%BE/"/>
    
  </entry>
  
  <entry>
    <title>考驾照和买二手车</title>
    <link href="https://blog.k8s.li/honda-civic.html"/>
    <id>https://blog.k8s.li/honda-civic.html</id>
    <published>2023-12-28T16:00:00.000Z</published>
    <updated>2023-12-28T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>2023 值得回忆和分享的两件人生大事就是：考了 C1 驾照、买了辆二手的本田十代思域</p><h2 id="考驾照"><a href="#考驾照" class="headerlink" title="考驾照"></a>考驾照</h2><h3 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h3><p>准备考驾照的动机是过年的时候父母提起想要去山西大同那边自驾玩几天，再加上刚经历了三年大健康运动（防疫闹剧）。父母想要实现的愿望就想尽早地帮他们实现，说不定那天被再来一场闹剧被关进「集中营」，那时候再后悔就来不及了。</p><p>想要在路上合法地开车就需要有个驾照，毕竟开车是一件吃席风险比较高的事情。都需要考个驾照才能合法上路，不然无证驾驶会被处以 200 以上 2000 元以下罚款，并处 15 天以下拘留。那我们就考个驾照吧。</p><p>我觉着考驾照的最佳时机是高考完的那个暑假或者大学时，因为刚满十八周岁到了考驾照的年龄、时间也很充裕，而且那时候手脚灵活、脑袋还比较好使。可惜那段时间都在瞎玩，没有去考驾照。觉着自己又买不起车又不怎么开车，对当时的自己来讲考驾照没啥用。事实证明，驾照考的越早越好，当你会开车以及有了车之后，你的生活出行距离范围会扩大很多，也会方便很多。像我这样，工作之后再去考驾照，时间成本可谓是真高，为了练车和考试我还用掉了五天的宝贵年假 😭。</p><h3 id="驾校报名"><a href="#驾校报名" class="headerlink" title="驾校报名"></a>驾校报名</h3><p>过年回来的第一周就开始联系在上海的朋友找个靠谱的驾校，朋友之前是在特斯拉卖车的，所以认识了一个驾校教练，刚好他的老婆也跟着这个教练练车。于是经介绍加了教练的微信，确认了在上海考驾照的一些基本信息：</p><ul><li>外地户口考驾照不需要居住证；</li><li>在宝山练科目二、嘉定练科目三、金山考科目二和科目三；</li><li>每周练车一到两次，每次两个小时左右（因为我住在浦东，离练车地方比较远，特意让教练多练会）；</li><li>科目一考完十天后就可以预约科目二和科目三考试；</li><li>每个科目挂科后需要等 10 天才能预约下一场考试；</li><li>从考完科一到拿驾照顺利的话最快一个月；</li></ul><p>关于费用：</p><ul><li>体检以及以及证件照 120；</li><li>驾校这边共收取 4600 （报名、培训、场地练车费用）；</li><li>科一到科四的考试费每次 40 需要自己在 12123 上缴纳；</li><li>科二考试场地模拟费，200 一圈、500 三圈、900 不限圈数；</li><li>科目三场地模拟费，500 三个线路各一圈、850 两圈；</li></ul><p>我当时考的时候没有学时限制，现在上海这边考驾照要求学时达到后才能预约相应科目的考试，所以驾照是考的越早越省事，后面肯定会越来越严的。听教练说明年练车的时候就要人脸识别了，越来越难，所以如果你在上海还想考驾照，就马上行动起来别再拖啦。</p><p>另外在上海考驾照，通过驾校无疑是最方便省事儿的，虽然可以自学直考，但是有场地限制以及需要车辆安装副驾的刹车踏板，对没有车的人来说是比较麻烦的，而且成本不见得比驾校要低。对于其他关于驾考的信息，推荐看一下 <a href="https://www.bilibili.com/video/BV17T411a7eA">上海学车考驾照经历分享，科二科三一把过，两个月内快速拿到 C2 驾照。</a> 这个视频。</p><h3 id="面签"><a href="#面签" class="headerlink" title="面签"></a>面签</h3><p>面签就是去驾校办理一个类似于学籍的东西，把身份证、照片、驾照类型、住址等信息录入到上海交警驾照考试系统里。面签完成后，需要自己在 12123 上注册账户，等到车管所那边录入信息后才能在 12123 上预约科目一考试。如果 12123 上提示没有找到学员信息，很可能是车管所那边在建档的时候出现问题，比如存在异地档案、身份信息错误、有其他违章（比如骑电车不带头盔或闯红灯被抓到）。这时一定要及时联系驾校那边问下什么情况，及时处理，不要一直干等着。我当时就是因为存在异地档案没有注销被拖了两周🥹。</p><h3 id="科目一"><a href="#科目一" class="headerlink" title="科目一"></a>科目一</h3><p>科目一比较简单，花了 90 块钱氪金充值了驾校一点通的会员，每天有空的时候就刷题。等到 12123 上能预约科目一考试的时候，就约了最近的一场考试。考科目一的时候提前半个小时到了考场，排队的人已经七八十人了。到考场后是不按预约场次排序的，只要预约了当天的场次就能随到随考。科一共 100 道题，大部分题都刷过，所以只要掌握一点技巧多刷题多背就能稳过。</p><h3 id="科目二"><a href="#科目二" class="headerlink" title="科目二"></a>科目二</h3><p>驾校这边一般是科目一过了之后才开始科目二练车，没有考过科目一教练是不给安排科目二练车的。所以科目一一定不要挂，挂了之后需要等两周才能重考，在这期间只能干等着，十分浪费时间。</p><p>上海驾考科目二主要考下面这几项：</p><ul><li>倒车入库（难度五星）</li><li>侧方位停车（难度三星）</li><li>曲线行驶（难度三星）</li><li>窄路掉头（难度一星）</li><li>直角转弯（难度三星）</li><li>半坡起步（难度四星）</li><li>紧急停车（难度一星）</li></ul><p>科目二我练习了大概 10 次就预约去考试了，当时感觉状态良好绝对能一把过的。没想到很快打脸了，考第一把的时候左倒库压线挂掉了，第二把在半坡起步的时候溜车挂掉了 😭。后来听教练说我开的那辆考试车离合器有问题，半坡起步的时候，离合器送到半联动时如果直接送开刹车大概率会溜车，只要上了这辆车十有八九的会挂掉，很多考生都挂在我开的那辆车上了。无奈只能等待十天继续预约下一次考试，而每次只能预约四天后的考试，所以当挂科后需要等待两周才能重新考试。</p><p>考第二次的时候十分紧张，不幸两把都在倒库的时候挂掉了；接着等待两周再考第三次，第三次的时候又因为倒库挂掉了。考了三次都挂掉了，当时就陷入了自我怀疑中，自己适不适合开车呀。听同事调侃说他考科三挂了四次，五十步笑百步，心理有了些许安慰。挂了三次，还剩两次机会的嘛，即便如此还是要硬着头皮继续考，不能就因此放弃了。</p><p>第四次考试的时候，换了一个考场，模拟的时候状态并不是很好，教练也觉着我过不了，但没想到最终一把满分过了 🎉。个人感觉考科二最主要的是心态，只要不紧张，放松一点慢慢开就能稳过 😂。我第一次考试也不怎么紧张，状态也是最好的，无奈运气不好碰上了个有问题的车就挂掉了。</p><p>科目二考试最麻烦的就是考场在金山，需要头天晚上过去住在考场附近的酒店，或者凌晨四点多跟着教练的车去考场。为了多睡会我选择头天晚上去住在考场附近的酒店，早上六点起床到考场进行模拟。由于只请了半天的假，考完后就得赶紧回公司继续搬砖。而每次挂科后，回到公司的心情极差，尤其是同事问起考过没有，心里贼难受 😣。</p><h3 id="科目三"><a href="#科目三" class="headerlink" title="科目三"></a>科目三</h3><p>科目二考过后就开始练习科目三，科目三练车时间并不是很长，大概就练了六次，每次一个半小时。考试的时候也是头天晚上去，早上早起去考场进行模拟。科三考试会在三个路线里面随机挑选一个，所以模拟的时候三个线路都会模拟一圈。科三考试不同于科二，科二考试副驾驶是没有监考员的，而科三有，并且监考员就是我们的教练。有个熟人在旁边心态会好很多，所以不会像科二那样紧张，很顺利地一把满分过了。</p><p>当时考试是我们四个人学员一块考，一辆车四个人轮流进行模拟，等到都模拟完已经十二点了，在车上呆了将近六个小时，身心疲惫的。等到下午轮到我们考试的时候也已经一点多了，考完之后就感觉像是做梦一样这么顺利地一把过了，比科目二考试顺利多了。</p><h3 id="科目四"><a href="#科目四" class="headerlink" title="科目四"></a>科目四</h3><p>科目四和科目一差不多，只要刷点题就能轻松过。考试的时候带上在驾校面签时留下的那张证件照，科四考过之后，就会当场办驾驶证，然后进行宣誓就能拿到驾照啦。</p><h2 id="买车"><a href="#买车" class="headerlink" title="买车"></a>买车</h2><h3 id="动机-1"><a href="#动机-1" class="headerlink" title="动机"></a>动机</h3><p>考完驾照后还没有买车的打算，直到有一天和我姐商量好国庆带父母去山西自驾游玩后，才想赶紧买辆车练练手，方便在自驾游的时候代替老爸开车，让老爸休息会。当时想买车的动机主要是想练练手，于是想着能不能租一辆车来开练手呢？事实证明租车练手不太可行，因为绝大多数租车平台上要求驾龄至少三个月，而我刚拿驾照不到一个月 😂。于是就下定决心买辆车吧，拥有一台属于自己的车。</p><h3 id="选车"><a href="#选车" class="headerlink" title="选车"></a>选车</h3><p>现在回想起来，大概率是受好友 <a href="https://fk7.nova.moe/">Nova Kwok 的思域 FK7 改车笔记</a> 的影响，当时买车的时候只认准了本田的十代思域（人称鬼 👻 火 🔥 思域），其他车型一概没有考虑，而且还是手动挡的思域。十代思域在同级别同价位的车型中，性能和操控性无疑是最有性价比的选择。至于隔音差、异响多、碰撞测试 B 柱断裂、发动机积炭、织布座椅、内饰用料一般等缺点，无疑是印证了本田就是<strong>买发动机送车</strong>的刻板印象 😂。</p><p>为什买手动挡而不是自动挡：</p><ul><li>手动挡便宜呗，而且本田的自动挡 CVT 变速箱有点脆弱，经不起暴力驾驶；</li><li>驾驶乐趣？体验人车合一的感觉 🤔（大雾</li><li>手动挡的车更省油，事实上确实如此，我开了大概 5000 多公里，百公里油耗一直维持在 5.7L 左右；</li></ul><p>为什买二手车而不是新车：</p><ul><li>新车比较贵，当时新车价格差不多 13 万左右，加上保险以及购置税，落地差不多 14 万，而二手车没有购置税保险也便宜，落地只需要 8 万多，相差 5 万多，所以二手车更划算些；</li><li>刚拿驾照不久，新手上路，新车不小心剐蹭或出事故后很心疼的，二手车用来实习期新手练车，小磕小碰也不心疼；</li></ul><h3 id="闲鱼找车"><a href="#闲鱼找车" class="headerlink" title="闲鱼找车"></a>闲鱼找车</h3><p>二手车购买的方式无疑就两种：车商和个人，其逻辑和租房十分相似。车商就是个中介，买家和卖家的钱都赚。对于咱这种日常生活都要靠抠和薅来养家糊口的穷哥们，能省则省，所以买二手车当然不能从车商那里买啦，从个人车主那里买无疑是最具性价比的。当时在闲鱼上大概找了下面这几辆车：</p><table><thead><tr><th>车型</th><th>上牌年份</th><th>公里数</th><th>价格</th><th>城市</th><th>备注</th></tr></thead><tbody><tr><td>2016 款十代思域 FC1</td><td>2018 年 10 月</td><td>4.8 万</td><td>7.3 万</td><td>上海</td><td>怀疑是事故车</td></tr><tr><td>2016 款十代思域 FC1</td><td>2018 年 10 月</td><td>5.6 万</td><td>8 万</td><td>上海</td><td>改装件比较多</td></tr><tr><td>2019 款十代思域 FC1</td><td>2021 年 6 月</td><td>2.2 万</td><td>8.3 万</td><td>杭州</td><td>最终买下的车</td></tr><tr><td>2021 款十代思域 FK7</td><td>2021 年 1 月</td><td>2.8 万</td><td>10.8 万</td><td>上海</td><td>看中却被买走的车</td></tr><tr><td>2021 款十代思域 FK7</td><td>2020 年 7 月</td><td>3.2 万</td><td>11 万</td><td>台州</td><td>价格略贵，性价比低</td></tr></tbody></table><p>十代思域大概分三厢（底盘代号 FC1）和两厢（底盘代号 FK7）两个车型，三厢 FC1 又分为 2016 款、2019 款两种，FK7 则只有 2021 款，总体上 FK7 价格比 FC1 要高出两万左右，能在接受范围。</p><h3 id="上海看车"><a href="#上海看车" class="headerlink" title="上海看车"></a>上海看车</h3><p>头天晚上和卖家在微信上沟通好周六上午去看车，约好了时间和地点。周六的时候找了驾校的教练开车一块去的，还给教练买了包烟，毕竟为了帮我看车还把上午学员练车的时间都推掉了，不意思一下也不太好。</p><p>卖家把车开来后，看了下感觉外观很破，翼子板和保险杠都有十分明显的破损，内饰磨损的十分严重，内饰门把手和扶手箱都磨出皮了，比十几万公里的教练车磨损的还严重。心想就这磨损程度公里也不会太低，不可能五万不到。于是就和卖家商量了一下找个第三方的监测机构验一下车，看看车真实的车况。卖家也是同意了，不过他支支吾吾地说一会有事要离开，还是约到下午吧。</p><p>中午的时候就在闲鱼上找了个验车的师傅，和卖家越好下午 5 点开到一家汽修店验车。验车的定金都付好了，下午的时候卖家居然把我给鸽了，说什么都不来验车。结合上午的看车经历，感觉这辆大概率是辆事故车，估计车主也心虚了，不敢来验车。</p><h3 id="杭州看车"><a href="#杭州看车" class="headerlink" title="杭州看车"></a>杭州看车</h3><p>自从有了第一次看车的教训后面也就谨慎多了，再三纠结之后就选择了杭州的这辆 2019 款十代思域 FC1。虽然看上了 10.8 万的 FK7 ，无奈手慢，卖家已经把车卖掉了，只能选择这辆在杭州的 FC1 了。由于车管所周六日不上班，所以就约好周五开来看车然后再去过户。周四和 leader 请了一天假，下班后就坐动车去了杭州，在杭州住了一晚。晚上在闲鱼上花了 299 找了个二手车检测的师傅，并约好了明天的看车地点。</p><p>第二天看车的时候约在了一个修理厂附近，看车师傅先是拿一个读取 ECU 数据的设备看了下发送机的运行时间，以及变速箱里记录的行驶里程。结合 4S 店维保记录可以确定这不是一辆调表车。一般一手的个人车主卖车很少会有调表的情况，车商那里的二手车买到调表车的概率极大。然后师傅又拿漆膜仪排查里下车辆整体钣金维修的情况，也基本和车主描述的一致，没有大事故只有几处刮蹭。最后在修理店举升机上看了下发送机底盘，也没啥大碍。前前后后验车大概用了一个多小时，各个方面看的都十分仔细，花点钱请个专业的师傅来看还是挺值的得。</p><h3 id="嘉兴过户"><a href="#嘉兴过户" class="headerlink" title="嘉兴过户"></a>嘉兴过户</h3><p>大概上午九点左右看完车后，觉着没啥问题就和车主一块去车管所办理过户手续。车主的车牌是嘉兴的，而我刚好也想挂嘉兴的车牌。因为上海的燃油车蓝牌拍卖至少要 10 万，而且什么时候能拍到也不确定，所以挂浙江或者江苏的车牌是最合适的。虽然上海有外牌限行政策，但考虑到我工作日也很少会用到车，也就是节假日开车出去玩，所以外牌限行对咱来说也没啥问题。</p><p>在嘉兴过户需要在 12123 上提前预约，没有预约的话是无法进入到车管所进行验车的，而那天的预约名额已经没有了，本以为要等到下周一才能过户了。还好车主帮忙找了个黄牛帮忙办理的过户，不用提前预约，就能把车开进车管所验车。用了不到一个小时就办完了所有手续，还是黄牛帮忙办比较省心。</p><p>拿到新的行驶证，这辆车就属于咱的啦。终于有了一辆自己的车，虽然是辆二手车但感觉还是很开心 🥳。把车主送到高铁站，道别之后就自己一个人从嘉兴开车回上海。因为还在实习期不能单独上高速，再加上自从考完科三后一个多月没再看过车，自己一个人也不敢上高速，就走国道省道慢慢地开回了上海。当天的感觉就是没想到买辆二手车这么顺利，没出啥意外。头天晚上聊好价钱，第二天上午看车并顺利过户，下午顺利开回上海，期间没出啥幺蛾子。</p><h3 id="二手车避坑"><a href="#二手车避坑" class="headerlink" title="二手车避坑"></a>二手车避坑</h3><p>根据个人买车的经历，分享几条二手车避坑的建议，如果你有买二手车的打算，可以参考一下：</p><ul><li>尽量买个人车主，大多数车商不靠谱，而且性价比较低，如果非要选择车商的话一定要选择一个靠谱的车商；<ul><li>闲鱼上有很多虚假的二手车车源，很多帖子实际上就是引流骗你过去看车，和租房一个套路；</li></ul></li><li>去看车前，可以先在闲鱼上找人查一下 4S 店的维保记录以及保险的出险记录：<ul><li>根据 4S 店维保记录判断公里数是否有猫腻，4S 店保养时一般都会记录公里数的；</li><li>根据保养记录判断车主是否爱惜车子，是否及时保养；</li><li>根据维修记录判断车子是否维修过发动机、变速箱等；</li><li>根据出险记录判断事故大致类型，是否是事故车、火烧车、泡水车；</li></ul></li><li>一定要再找个懂车或专门验车的师傅帮忙一起看车：<ul><li>通过读取 ECU 发送机运行时间、变速箱运行里程、上次 ABS 触发里程等信息来判断是否为调表车；</li><li>把车开到修理厂举升起来，看底盘以及车架是否正常、油底壳是否漏油、发送机工况等；</li><li>打开发动机机舱看防撞梁、车架、副车架、水箱、中冷、机脚等部件是否有钣金维修的痕迹；</li><li>用漆膜仪测量车上数否有钣金维修的痕迹判断车子是否有过事故；</li><li>后备箱备胎坑、车门、A&#x2F;B&#x2F;C 柱是否有钣金维修的痕迹；</li><li>查看车椅子螺丝、安全带螺丝、安全带、安全气囊等是否有拆卸的痕迹；</li></ul></li><li>办理过户如果想图个省事儿的话，建议找个靠谱的黄牛帮忙办理，这样可以帮你节省很多时间和繁琐的手续；</li></ul><h3 id="改装"><a href="#改装" class="headerlink" title="改装"></a>改装</h3><p>车子买来后，就开始给自己的爱车进行合法改装，升级一下装备。从 <a href="https://fk7.nova.moe/">《Nova Kwok 的思域 FK7 改车笔记》</a> 那里偷来一个类似的表格：</p><table><thead><tr><th>名称</th><th>时间</th><th>价格 （CNY）</th><th>推荐指数</th></tr></thead><tbody><tr><td>本田原厂胎压监测</td><td>2023 年 9 月</td><td>530+300 工时费用</td><td>★★★★★</td></tr><tr><td>马牌 UC7 (215&#x2F;55&#x2F;R16)</td><td>2023 年 11 月</td><td>709*4&#x3D;2836</td><td>★★★★</td></tr><tr><td>MX72 前后刹车片</td><td>2023 年 11 月</td><td>2300+300 工时费</td><td>★★★</td></tr><tr><td>endless S-Four 刹车油</td><td>2023 年 11 月</td><td>320+ 100 工时费</td><td>★★★</td></tr><tr><td>碳纤维方向盘</td><td>2023 年 10 月</td><td>480（原厂置换）</td><td>★★</td></tr><tr><td>RAZO 踏板</td><td>2023 年 9 月</td><td>320+100 工时费</td><td>★★★</td></tr><tr><td>雨刷</td><td>2023 年 9 月</td><td>180</td><td>★★</td></tr><tr><td>顶吧</td><td>2023 年 10 月</td><td>175</td><td>★★</td></tr><tr><td>发动机防护板</td><td>2023 年 10 月</td><td>210</td><td>★★</td></tr><tr><td>Type R 排挡头</td><td>2023 年 9 月</td><td>180</td><td>★★★★</td></tr><tr><td>后备箱隔音棉</td><td>2023 年 11 月</td><td>90</td><td>★★★★</td></tr><tr><td>达芬奇车机助手</td><td>2023 年 9 月</td><td>168</td><td>★★</td></tr></tbody></table><ul><li>达芬奇车机助手</li></ul><p>车开回来的第二天就在淘宝上买了达芬奇车机助手，破解了原厂的车机。刚开始用的时候感觉很新奇，一堆花里胡哨的功能，但后来很少用了。目前最大的用途就是自定义仪表盘，把老婆头像放在上面，就没有别的用途了。之前有用过一段时间在仪表盘上显示导航，但需要连接手机热点才能支持，如果用 U 盘离线地图的话会和 CarPlay 冲突，使用起来并不是很方便就没再使用了。</p><p><img data-src="https://p.k8s.li/2023-honda-civic/2023-honda-civic12.jpg"></p><ul><li>胎压监测</li></ul><p>本田原厂的胎压检测，十分推荐，安装在方向盘左下侧的原厂预留位置，从原厂预留的取电插口取电，要比一些 USB 供电的胎压监测美观很多。</p><p><img data-src="https://p.k8s.li/2023-honda-civic/2023-honda-civic-02.jpg"></p><p>当时换完胎压监测后，修车师傅忘记给左前轮打胎压了，我一直以为是胎压传感器的问题，就没有去管。直到后来用打气筒测了一下，胎压确实只有 1.7 Bar。我还开车走高速去了一趟沈家湾码头，现在回想起来后背突然发凉，幸好没出意外，不然的话可能从东海大桥那里爆胎掉到海里了 😨。</p><ul><li>排挡头</li></ul><p>原厂排挡头的材质是橡胶塑料，感觉摸起来不是很爽，就在换成了全铝合金的排挡头，手感贼棒。唯一的缺点就是夏天高温天气时烫手 🔥、冬天冷的时候冻手 🥶。</p><p><img data-src="https://p.k8s.li/2023-honda-civic/2023-honda-civic-08.jpg"></p><ul><li>方向盘</li></ul><p>改装的碳纤维方向盘，感觉不是很值得</p><ul><li>轮胎</li></ul><p>国庆回来的路上在高速上经历了一次差点追尾的事故后，就感觉到车子的刹车距离有点上，刹车前半段空行程比较长。为了能提升刹车性能减少刹车距离，就准备改装一下轮胎和刹车片。由于原厂的 215&#x2F;55R16 尺寸的轮胎可选择的范围比较少，比较流向的马牌 MC6 和米其林 PS4 都没有 16 寸的，为了合法改装不更改轮胎轮毂尺寸就无奈选择了马牌的 UC7 轮胎。</p><ul><li>刹车</li></ul><p>前后轮的刹车盘换成了 Endless MX72，顺带更换 endless S-Four 的刹车油，更换完成后感觉刹车脚感变软了，但刹车制动距离缺失比原厂好了很多。尤其是紧急急刹的时候，前半段的空行程缩短了不少。</p><p><img data-src="https://p.k8s.li/2023-honda-civic/2023-honda-civic-03.jpg"></p><ul><li>发动机底盘防护板</li></ul><p>原厂的底盘防护板只有薄薄的一层铝合金，更换成了加厚全钢的护板。更换完成后就后悔了，因为加装的护板会影响到剧烈碰撞后发动机下沉，发送机可能会由于无法下沉而突破防火墙挤入驾驶室，驾驶员有吃席的风险。其实如果用车环境比较好，比如在市区和高速上开，不开一些烂路，原厂的护板已经足够了，完全没必要更换。</p><ul><li>后备箱隔音棉</li></ul><p>原厂后备箱的隔音棉给减配掉了，在后备箱装一些大件物品的时候容易刮到上面的音响和一些螺丝。于是就加装了一个隔音棉，看起来靠谱了很多。</p><p><img data-src="/pics/2023-honda-civic/2023-honda-civic-07.jpg"></p><ul><li>机油机滤</li></ul><p>十代思域是要求每 5000 公里更换一次机油，由于搭载的是 1.5T 地球梦（缸内直喷涡轮增压）发动机，积碳问题会严重一些，本田官方就要求每 5000 公里加注一瓶燃油宝以缓解积碳问题，故地球梦发动机也被称之为积碳梦发动机 😂。</p><p><img data-src="https://p.k8s.li/2023-honda-civic/2023-honda-civic-09.jpg"></p><p>感觉四儿子店保养使用的机油和机滤都比较差，所以没有去 4S 店保养，自己买好机油机滤在京东养车店里上花 50 块钱就能换好。京东上搞活动的时候 HKS 0W-20 4L 机油大概需要 360 块左右、小瓶 DDR 燃油宝 100 块、本田原厂 HAMP 滤芯 48 块、更换机油机滤工时费 50 块，每次保养加起来差不多需要 550 块。</p><h3 id="油耗"><a href="#油耗" class="headerlink" title="油耗"></a>油耗</h3><p>我开车比较温柔，不会大脚油门大脚刹车，所以百公里油耗基本维持在 5.7L 左右，路况好的话 5.2L 左右，上任车主的百公里油耗是 7.2L。对于一款家用买菜车，5.7L 的油耗确实不错了，如果油价能跌回 6 块，这个加油费用估计和新能源电车齐平了。</p><p><img data-src="https://p.k8s.li/2023-honda-civic/2023-honda-civic-01.jpg"></p><h3 id="户外徒步"><a href="#户外徒步" class="headerlink" title="户外徒步"></a>户外徒步</h3><p>国庆回来之后，和同事一起入坑了户外徒步，买了各种户外徒步的装备：徒步鞋、徒步包、水袋、速干衣、速干袜、冲锋衣等。每到周六的时候和三四个同事自驾去江浙沪附近徒步，再也不像以前那样周末只会宅在家里玩泥巴了。同事们已经在计划明年在公司成立一个户外徒步俱乐部，每次和同事出来徒步游玩的时候都有一种自费团建的感觉 😂。</p><ul><li>长兴岛郊野公园采摘橘子</li></ul><p>10 月底的时候，长兴岛郊野公园有个柑橘节，于是和同事商量着去公园采摘橘子。那天周六中午去的，郊野公园对面的荒地停车场停的车也是满满的，公园里面露营的人也很多。好在整个公园的占地面积比较大，虽然人多但也不会感觉到拥挤。</p><p><img data-src="https://p.k8s.li/2023-honda-civic/2023-honda-civic-12.jpg"></p><ul><li>余姚四明山华盖山</li></ul><p><img data-src="https://p.k8s.li/2023-honda-civic/2023-honda-civic-06.jpg"></p><p>当时和同事报的华东户外的周末团去的，本想着去看四明山秋景，但领队选的路线很一般，路上没有任何秋景可看，走的都是防火道，各种陡坡。期间还有两个大聪明在关门点没到达被领队劝回下撤后，又偷偷跟在了后面，领队没有发现他俩。由于他们两个体力不行等到回去的时候他们还没有回到集合店，等了一个多小时这两个大聪明才联系领队说天黑找不到回去的路了。最终留下了两个领队带去山上找他们，其他人跟车回上海。</p><p>由于两个大聪明不听从领队的安排，导致到了七点半多领队才让司机回上海，而对于大型客车，8 点过后是要限速 80KM&#x2F;h 的，最终回到上海市已经十一点半了。也就是从这之后，我和同事再也不想报团去徒步了，不想再遇到一些自以为是的大聪明。</p><ul><li>长兴八都岕银杏长廊</li></ul><p>十一月中旬和同事带着他女朋友一块去的，就是想去看那里的银杏，不过去风景没有想象中的那么好。很多高大的银杏树叶子还不够黄，但矮小的银杏树叶子都快掉光了，没找到那种一片金黄的银杏林。</p><p><img data-src="https://p.k8s.li/2023-honda-civic/2023-honda-civic-10.jpg"></p><ul><li>绍兴石井水库</li></ul><p>十二月上旬去的，石井水库周边的水杉林风景确实不错，这也是去过众多徒步路线中体验最好的一个景点了。</p><p><img data-src="https://p.k8s.li/2023-honda-civic/2023-honda-civic-04.jpg"></p><ul><li>湖州王位山古道</li></ul><p>十二月中旬去的王位山，距离莫莫干山比较近，当时想去龙王山看雪景和雾凇，但怕技术不好在雪天开车容易翻车，就改去了王位山。这条路线上人很少，到达王位山山顶后，有一段有雾凇的竹林，风景还可以。虽然比不上长白山般的浙西天地，但好在人少，体验也不错。</p><p><img data-src="https://p.k8s.li/2023-honda-civic/2023-honda-civic-05.jpg"></p><ul><li>绍兴千年香榧林</li></ul><p>十一月初时和同事一块去的，把车停在雪窦岭景区里的停车场。然后再爬山走到雪窦岭山上的水库看水衫，但感觉风景一般，没有石井水库的水杉好看些。从雪窦岭山上下来后就围着千年香榧林景区来了个大环线，当天大概走了 20 公里。初冬时节，山上也没啥好看的风景，好在路比较好走些。</p><p><img data-src="https://p.k8s.li/2023-honda-civic/2023-honda-civic-13.jpg"></p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;2023 值得回忆和分享的两件人生大事就是：考了 C1
        
      
    
    </summary>
    
    
      <category term="生活" scheme="https://blog.k8s.li/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
      <category term="生活" scheme="https://blog.k8s.li/tags/%E7%94%9F%E6%B4%BB/"/>
    
  </entry>
  
  <entry>
    <title>使用 BuildKit on Kubernetes 构建多架构容器镜像</title>
    <link href="https://blog.k8s.li/buildkit-on-kubernetes.html"/>
    <id>https://blog.k8s.li/buildkit-on-kubernetes.html</id>
    <published>2023-04-19T16:00:00.000Z</published>
    <updated>2023-04-19T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>去年曾写过一篇介绍如何使用 docker in pod 的方式在 Kubernetes 集群上构建容器镜像的博客 ➡️《<a href="https://blog.k8s.li/docker-in-pod.html">流水线中使用 docker in pod 方式构建容器镜像</a>》。自己负责的项目中稳定使用了一年多没啥问题，用着还是挺香的。虽然说众多 Kubernetes PaaS 平台都逐渐抛弃了 docker 作为容器运行时，但 docker 在镜像构建领域还是占据着统治地位滴。不过最近的一些项目需要构建多 CPU 架构的容器镜像，docker in pod 的方式就不太行了。于是就调研了一下 BuildKit，折腾出来 BuildKit on Kubernetes 构建镜像的新玩法分享给大家。</p><h2 id="qemu-VS-native"><a href="#qemu-VS-native" class="headerlink" title="qemu VS native"></a>qemu VS native</h2><p>默认情况下，docker build 只能构建出与 docker 主机相同 CPU 架构的容器镜像。如果要在同一台主机上构建多 CPU 架构的镜像，需要配置 qemu 或 binfmt。例如，在 amd64 主机上构建 arm64 架构的镜像，可以使用 <a href="https://github.com/tonistiigi/binfmt">tonistiigi&#x2F;binfmt</a> 项目，在主机上运行 <code>docker run --privileged --rm tonistiigi/binfmt --install arm64</code> 命令来安装一个 CPU 指令集的模拟器，以处理不同 CPU 架构之间的指令集翻译问题。同样我们在 GitHub 上通过 GitHub Action 提供的 <a href="https://github.com/actions/runner-images">runner</a> 来构建多 CPU 架构的容器镜像，也是采用类似的方式。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up QEMU  <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>qemu<span class="token punctuation">-</span>action@v2<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Docker Buildx  <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v2<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build open<span class="token punctuation">-</span>vm<span class="token punctuation">-</span>tool rpms to local  <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v2  <span class="token key atrule">with</span><span class="token punctuation">:</span>    <span class="token key atrule">context</span><span class="token punctuation">:</span> .    <span class="token key atrule">file</span><span class="token punctuation">:</span> Dockerfile    <span class="token key atrule">platforms</span><span class="token punctuation">:</span> linux/$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> matrix.arch <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">outputs</span><span class="token punctuation">:</span> type=local<span class="token punctuation">,</span>dest=artifacts<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然而，这种方式构建多 CPU 架构的镜像存在着比较严重的性能问题。尤其是在编译构建一些 C&#x2F;C++ 项目时，由于 CPU 指令需要翻译的问题，会导致编译速度十分慢缓慢。例如，使用 GitHub 官方提供的机器上构建 open-vm-tools 这个 RPM 包，构建相同 CPU 架构的 amd64 镜像只需要不到 10 分钟就能完成，而构建异构的 arm64 镜像则接近一个小时，构建速度相差 6 倍之多。如果将 arm64 的镜像放到相同 CPU 架构的主机上来构建，构建时间和 amd64 差不太多。</p><p><img data-src="https://p.k8s.li/2023-04-20-build-open-vm-tools.png"></p><p>由此可见，在同一台机器上构建异构的容器镜像有着比较严重的性能问题。因此构建多 CPU 架构的容器镜像性能最好的方案就是在对应 CPU 架构的机器上来构建，这种原生的构建方式由于没有 CPU 指令翻译这一开销性能当然是最棒滴，这种方式也被称之为 <a href="https://docs.docker.com/build/building/multi-platform/#building-multi-platform-images">native nodes provide</a>。</p><h2 id="BuildKit"><a href="#BuildKit" class="headerlink" title="BuildKit"></a>BuildKit</h2><p><a href="https://github.com/moby/buildkit">BuildKit</a> 是一个将 source code 通过自定义的构建语法转换为 build artifacts 的开源构建工具，被称为下一代镜像构建工具。同时它也是 docker 的一部分，负责容器镜像的构建。我们平时使用 docker build 命令时就是它负责后端容器镜像的构建。BuildKit 它支持四种不同的驱动来执行镜像的构建：</p><ul><li>docker：使用内嵌在 Docker 守护程序中的 BuildKit 库。默认情况下 docker build 就是这种方式；</li><li>docker-container：创建一个专门的 BuildKit 容器，将 BuildKit 运行在容器中，有点类似于 docker in docker；</li><li>kubernetes：在 kubernetes 集群中创建  BuildKit pod，类似于我之前提到的 docker in pod 的方式；</li><li>remote：通过 TCP 或 SSH 等方式连接一个远端的 BuildKit  守护进程；</li></ul><p>不同的驱动所支持的特性也不太一样：</p><table><thead><tr><th align="left">Feature</th><th align="center"><code>docker</code></th><th align="center"><code>docker-container</code></th><th align="center"><code>kubernetes</code></th><th align="center"><code>remote</code></th></tr></thead><tbody><tr><td align="left"><strong>Automatically load image</strong></td><td align="center">✅</td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td align="left"><strong>Cache export</strong></td><td align="center">Inline only</td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td></tr><tr><td align="left"><strong>Tarball output</strong></td><td align="center"></td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td></tr><tr><td align="left"><strong>Multi-arch images</strong></td><td align="center"></td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td></tr><tr><td align="left"><strong>BuildKit configuration</strong></td><td align="center"></td><td align="center">✅</td><td align="center">✅</td><td align="center">Managed externally</td></tr></tbody></table><p>如果想要使用原生方式构建多 CPU 架构的容器镜像，则需要为 BuildKit 创建多个不同的 driver。同时，由于该构建方案运行在 Kubernetes 集群上，我们当然是采用 Kubernetes 这个 driver 啦。然而，这要求 Kubernetes 集群必须是一个异构集群，即集群中的 node 节点必须同时包含对应 CPU 架构的机器。然而，这也引出了另一个尴尬难题：目前主流的 Kubernetes 部署工具对异构 Kubernetes 集群的支持并不是十分完善，因为异构的 kubernetes 集群有点奇葩需求不多的缘故吧。在此，咱推荐使用 <a href="https://github.com/k3s-io/k3s">k3s</a> 或 <a href="https://github.com/kubesphere/kubekey">kubekey</a> 来部署异构 Kubernetes 集群。</p><h2 id="BuildKit-on-Kubernetes"><a href="#BuildKit-on-Kubernetes" class="headerlink" title="BuildKit on Kubernetes"></a>BuildKit on Kubernetes</h2><p>其实在 kubernetes 集群中部署 buildkit 官方是提供了一些 <a href="https://github.com/moby/buildkit/tree/master/examples/kubernetes">manifest</a>，不过并不适合我们现在的这个场景，因此我们使用 <a href="https://github.com/docker/buildx">buildx</a> 来部署。Buildx 是一个 Docker CLI 插件，它扩展了 docker build 命令的镜像构建功能，完全支持 BuildKit builder 工具包提供的特性。它提供了与 docker build 相似的操作体验，并增加了许多新的构建特性，例如多架构镜像构建和并发构建。</p><p>在部署 BuildKit 前我们需要先把异构的 kubernetes 集群部署好，部署的方式和流程本文就不在赘述了，可以参考 k3s 或 kubekey 的官方文档。部署好之后我们将 kubeconfig 文件复制到本机并配置好 kubectl 连接这个 kubernetes 集群。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get <span class="token function">node</span> <span class="token parameter variable">-o</span> wide --show-labelsNAME                             STATUS   ROLES                  AGE   VERSION        INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME          LABELSproduct-builder-ci-arm-node-02   Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 11d   v1.26.3+k3s1   <span class="token number">192.168</span>.26.20    <span class="token operator">&lt;</span>none<span class="token operator">></span>        Ubuntu <span class="token number">22.04</span>.1 LTS   <span class="token number">5.15</span>.0-69-generic   containerd://1.6.19-k3s1   beta.kubernetes.io/arch<span class="token operator">=</span>arm64,beta.kubernetes.io/os<span class="token operator">=</span>linux,kubernetes.io/arch<span class="token operator">=</span>arm64,kubernetes.io/hostname<span class="token operator">=</span>product-builder-ci-arm-node-02,kubernetes.io/os<span class="token operator">=</span>linuxcluster-installer                Ready    control-plane,master   11d   v1.26.3+k3s1   <span class="token number">192.168</span>.28.253   <span class="token operator">&lt;</span>none<span class="token operator">></span>        Ubuntu <span class="token number">20.04</span>.2 LTS   <span class="token number">5.4</span>.0-146-generic   containerd://1.6.19-k3s1   beta.kubernetes.io/arch<span class="token operator">=</span>amd64,beta.kubernetes.io/os<span class="token operator">=</span>linux,kubernetes.io/arch<span class="token operator">=</span>amd64,kubernetes.io/hostname<span class="token operator">=</span>cluster-installer,kubernetes.io/os<span class="token operator">=</span>linux,node-role.kubernetes.io/control-plane<span class="token operator">=</span>true,node-role.kubernetes.io/master<span class="token operator">=</span>true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>准备好 kubernetes 集群后我们我们还需要安装 docker-cli 以及 buildx 插件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装 docker，如果已经安装可以跳过该步骤</span>$ <span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://get.docker.com <span class="token parameter variable">-o</span> get-docker.sh<span class="token function">sudo</span> <span class="token function">sh</span> get-docker.sh<span class="token comment"># 安装 buildx docker-cli 插件</span>$ <span class="token assign-left variable">BUILDX_VERSION</span><span class="token operator">=</span>v0.10.4$ <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.docker/cli-plugins$ <span class="token function">wget</span> https://github.com/docker/buildx/releases/download/<span class="token variable">$BUILDX_VERSION</span>/buildx-<span class="token variable">$BUILDX_VERSION</span>.linux-amd64$ <span class="token function">mv</span> buildx-<span class="token variable">$BUILDX_VERSION</span>.linux-amd64 <span class="token environment constant">$HOME</span>/.docker/cli-plugins/docker-buildx$ <span class="token function">chmod</span> +x <span class="token environment constant">$HOME</span>/.docker/cli-plugins/docker-buildx$ <span class="token function">docker</span> buildx versiongithub.com/docker/buildx v0.10.4 c513d34049e499c53468deac6c4267ee72948f02<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>接着我们参考 <a href="https://docs.docker.com/engine/reference/commandline/buildx_create/">docker buildx create</a> 和 <a href="https://docs.docker.com/build/drivers/kubernetes/">Kubernetes driver</a> 文档在 kubernetes 集群中部署 amd64 和 arm64 CPU 架构对应的 builder。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建一个单独的 namespace 来运行 buildkit</span>$ kubectl create namespace buildkit --dry-run<span class="token operator">=</span>client <span class="token parameter variable">-o</span> yaml <span class="token operator">|</span> kubectl apply <span class="token parameter variable">-f</span> -<span class="token comment"># 创建 linux/amd64 CPU 架构的 builder</span>$ <span class="token function">docker</span> buildx create <span class="token punctuation">\</span>  <span class="token parameter variable">--bootstrap</span> <span class="token punctuation">\</span>  <span class="token parameter variable">--name</span><span class="token operator">=</span>kube <span class="token punctuation">\</span>  <span class="token parameter variable">--driver</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>  <span class="token parameter variable">--platform</span><span class="token operator">=</span>linux/amd64 <span class="token punctuation">\</span>  <span class="token parameter variable">--node</span><span class="token operator">=</span>builder-amd64 <span class="token punctuation">\</span>  --driver-opt<span class="token operator">=</span>namespace<span class="token operator">=</span>buildkit,replicas<span class="token operator">=</span><span class="token number">2</span>,nodeselector<span class="token operator">=</span><span class="token string">"kubernetes.io/arch=amd64"</span><span class="token comment"># 创建 linux/arm64 CPU 架构的 builder</span>$ <span class="token function">docker</span> buildx create <span class="token punctuation">\</span>  <span class="token parameter variable">--append</span> <span class="token punctuation">\</span>  <span class="token parameter variable">--bootstrap</span> <span class="token punctuation">\</span>  <span class="token parameter variable">--name</span><span class="token operator">=</span>kube <span class="token punctuation">\</span>  <span class="token parameter variable">--driver</span><span class="token operator">=</span>kubernetes <span class="token punctuation">\</span>  <span class="token parameter variable">--platform</span><span class="token operator">=</span>linux/arm64 <span class="token punctuation">\</span>  <span class="token parameter variable">--node</span><span class="token operator">=</span>builder-arm64 <span class="token punctuation">\</span>  --driver-opt<span class="token operator">=</span>namespace<span class="token operator">=</span>buildkit,replicas<span class="token operator">=</span><span class="token number">2</span>,nodeselector<span class="token operator">=</span><span class="token string">"kubernetes.io/arch=arm64"</span><span class="token comment"># 查看 builder 的 deployment 是否正常运行</span>$ kubectl get deploy <span class="token parameter variable">-n</span> buildkitNAME            READY   UP-TO-DATE   AVAILABLE   AGEbuilder-amd64   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           60sbuilder-arm64   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           30s<span class="token comment"># 最后将 docker 默认的的 builder 设置为我们创建的这个</span>$ <span class="token function">docker</span> buildx use kube<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>docker buildx create 参数</p><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td><a href="https://www.zhaowenyu.com/docker-doc/reference/dockercmd/dockercmd-docker-buildx-create.html#append"><code>--append</code></a></td><td>追加一个构建节点到 builder 实例中</td></tr><tr><td><code>--bootstrap</code></td><td>builder 实例创建后进行初始化启动</td></tr><tr><td><a href="https://www.zhaowenyu.com/docker-doc/reference/dockercmd/dockercmd-docker-buildx-create.html#buildkitd-flags"><code>--buildkitd-flags</code></a></td><td>配置 buildkitd 进程的参数</td></tr><tr><td><a href="https://www.zhaowenyu.com/docker-doc/reference/dockercmd/dockercmd-docker-buildx-create.html#config"><code>--config</code></a></td><td>指定 BuildKit 配置文件</td></tr><tr><td><a href="https://www.zhaowenyu.com/docker-doc/reference/dockercmd/dockercmd-docker-buildx-create.html#driver"><code>--driver</code></a></td><td>指定驱动 (支持: <code>docker</code>, <code>docker-container</code>, <code>kubernetes</code>)</td></tr><tr><td><a href="https://www.zhaowenyu.com/docker-doc/reference/dockercmd/dockercmd-docker-buildx-create.html#driver-opt"><code>--driver-opt</code></a></td><td>驱动选项</td></tr><tr><td><a href="https://www.zhaowenyu.com/docker-doc/reference/dockercmd/dockercmd-docker-buildx-create.html#leave"><code>--leave</code></a></td><td>从 builder 实例中移除一个构建节点</td></tr><tr><td><a href="https://www.zhaowenyu.com/docker-doc/reference/dockercmd/dockercmd-docker-buildx-create.html#name"><code>--name</code></a></td><td>指定 Builder 实例的名称</td></tr><tr><td><a href="https://www.zhaowenyu.com/docker-doc/reference/dockercmd/dockercmd-docker-buildx-create.html#node"><code>--node</code></a></td><td>创建或修改一个构建节点</td></tr><tr><td><a href="https://www.zhaowenyu.com/docker-doc/reference/dockercmd/dockercmd-docker-buildx-create.html#platform"><code>--platform</code></a></td><td>强制指定节点的平台信息</td></tr><tr><td><a href="https://www.zhaowenyu.com/docker-doc/reference/dockercmd/dockercmd-docker-buildx-create.html#use"><code>--use</code></a></td><td>创建成功后，自动切换到该 builder 实例</td></tr></tbody></table><p><code>--driver-opt</code> kubernetes driver 参数</p><table><thead><tr><th align="left">Parameter</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code>image</code></td><td align="left">buildkit 的容器镜像</td></tr><tr><td align="left"><code>namespace</code></td><td align="left">buildkit 部署在哪个 namespace</td></tr><tr><td align="left"><code>replicas</code></td><td align="left">deployment 的副本数</td></tr><tr><td align="left"><code>requests.cpu</code></td><td align="left">pod 的资源限额配置，如果并发构建的任务比较多建议多给点或者不配置</td></tr><tr><td align="left"><code>requests.memory</code></td><td align="left">同上</td></tr><tr><td align="left"><code>limits.cpu</code></td><td align="left">同上</td></tr><tr><td align="left"><code>limits.memory</code></td><td align="left">同上</td></tr><tr><td align="left"><code>nodeselector</code></td><td align="left">node 标签选择器，这里我们给对应 CPU 架构的 builder 添加上 <code>kubernetes.io/arch=$arch</code> 这个 node 标签选择器来限制运行在指定节点上。</td></tr><tr><td align="left"><code>tolerations</code></td><td align="left">污点容忍配置</td></tr><tr><td align="left"><code>rootless</code></td><td align="left">是否选择 rootless 模式。不过要求 kubernetes 版本在 1.19 以上并推荐使用 Ubuntu 内核 <a href="https://github.com/moby/buildkit/blob/master/docs/rootless.md">Using Ubuntu host kernel is recommended</a>。个人感觉 rootless 模式限制比较多而且也有一堆问题，不建议使用。</td></tr><tr><td align="left"><code>loadbalance</code></td><td align="left">负载均衡模式，无特殊要求使用默认值即可。</td></tr><tr><td align="left"><code>qemu.install</code></td><td align="left">是否安装 qemu 以支持在同一台机器上构建多架构的镜像，这种方式就倒车回去了，违背了我们这个方案的初衷，不建议使用</td></tr><tr><td align="left"><code>qemu.image</code></td><td align="left">qemu 模拟器的镜像，不建议使用</td></tr></tbody></table><p>部署好之后我们运行 <code>docker buildx inspect</code> 就可以查看到 builder 的详细信息</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">docker</span> buildx inspect kubeName:          kubeDriver:        kubernetesLast Activity: <span class="token number">2023</span>-04-19 00:27:57 +0000 UTCNodes:Name:           builder-amd64Endpoint:       kubernetes:///kube?deployment<span class="token operator">=</span>builder-amd64<span class="token operator">&amp;</span><span class="token assign-left variable">kubeconfig</span><span class="token operator">=</span>Driver Options: <span class="token assign-left variable">nodeselector</span><span class="token operator">=</span><span class="token string">"kubernetes.io/arch=amd64"</span> <span class="token assign-left variable">replicas</span><span class="token operator">=</span><span class="token string">"2"</span> <span class="token assign-left variable">namespace</span><span class="token operator">=</span><span class="token string">"buildkit"</span>Status:         runningBuildkit:       v0.11.5Platforms:      linux/amd64*, linux/amd64/v2, linux/amd64/v3, linux/386Name:           builder-amd64Endpoint:       kubernetes:///kube?deployment<span class="token operator">=</span>builder-amd64<span class="token operator">&amp;</span><span class="token assign-left variable">kubeconfig</span><span class="token operator">=</span>Driver Options: <span class="token assign-left variable">replicas</span><span class="token operator">=</span><span class="token string">"2"</span> <span class="token assign-left variable">namespace</span><span class="token operator">=</span><span class="token string">"buildkit"</span> <span class="token assign-left variable">nodeselector</span><span class="token operator">=</span><span class="token string">"kubernetes.io/arch=amd64"</span>Status:         runningBuildkit:       v0.11.5Platforms:      linux/amd64*, linux/amd64/v2, linux/amd64/v3, linux/386Name:           builder-arm64Endpoint:       kubernetes:///kube?deployment<span class="token operator">=</span>builder-arm64<span class="token operator">&amp;</span><span class="token assign-left variable">kubeconfig</span><span class="token operator">=</span>Driver Options: <span class="token assign-left variable">image</span><span class="token operator">=</span><span class="token string">"docker.io/moby/buildkit:v0.11.5"</span> <span class="token assign-left variable">namespace</span><span class="token operator">=</span><span class="token string">"buildkit"</span> <span class="token assign-left variable">nodeselector</span><span class="token operator">=</span><span class="token string">"kubernetes.io/arch=arm64"</span> <span class="token assign-left variable">replicas</span><span class="token operator">=</span><span class="token string">"2"</span>Status:         runningBuildkit:       v0.11.5Platforms:      linux/arm64*Name:           builder-arm64Endpoint:       kubernetes:///kube?deployment<span class="token operator">=</span>builder-arm64<span class="token operator">&amp;</span><span class="token assign-left variable">kubeconfig</span><span class="token operator">=</span>Driver Options: <span class="token assign-left variable">nodeselector</span><span class="token operator">=</span><span class="token string">"kubernetes.io/arch=arm64"</span> <span class="token assign-left variable">replicas</span><span class="token operator">=</span><span class="token string">"2"</span> <span class="token assign-left variable">image</span><span class="token operator">=</span><span class="token string">"docker.io/moby/buildkit:v0.11.5"</span> <span class="token assign-left variable">namespace</span><span class="token operator">=</span><span class="token string">"buildkit"</span>Status:         runningBuildkit:       v0.11.5Platforms:      linux/arm64*<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同时 buildx 会在当前用户的 <code>~/.docker/buildx/instances/kube</code> 路径下 生成一个 json 格式的配置文件，通过这个配置文件再加上 kubeconfig 文件就可以使用 buildx 来连接 buildkit 构建镜像啦。</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"kube"</span><span class="token punctuation">,</span>  <span class="token property">"Driver"</span><span class="token operator">:</span> <span class="token string">"kubernetes"</span><span class="token punctuation">,</span>  <span class="token property">"Nodes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"builder-amd64"</span><span class="token punctuation">,</span>      <span class="token property">"Endpoint"</span><span class="token operator">:</span> <span class="token string">"kubernetes:///kube?deployment=builder-amd64&amp;kubeconfig="</span><span class="token punctuation">,</span>      <span class="token property">"Platforms"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>          <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>          <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"Flags"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>      <span class="token property">"DriverOpts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"buildkit"</span><span class="token punctuation">,</span>        <span class="token property">"nodeselector"</span><span class="token operator">:</span> <span class="token string">"kubernetes.io/arch=amd64"</span><span class="token punctuation">,</span>        <span class="token property">"replicas"</span><span class="token operator">:</span> <span class="token string">"2"</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token property">"Files"</span><span class="token operator">:</span> <span class="token null keyword">null</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"builder-arm64"</span><span class="token punctuation">,</span>      <span class="token property">"Endpoint"</span><span class="token operator">:</span> <span class="token string">"kubernetes:///kube?deployment=builder-arm64&amp;kubeconfig="</span><span class="token punctuation">,</span>      <span class="token property">"Platforms"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>          <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"arm64"</span><span class="token punctuation">,</span>          <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"Flags"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>      <span class="token property">"DriverOpts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"image"</span><span class="token operator">:</span> <span class="token string">"docker.io/moby/buildkit:v0.11.5"</span><span class="token punctuation">,</span>        <span class="token property">"namespace"</span><span class="token operator">:</span> <span class="token string">"buildkit"</span><span class="token punctuation">,</span>        <span class="token property">"nodeselector"</span><span class="token operator">:</span> <span class="token string">"kubernetes.io/arch=arm64"</span><span class="token punctuation">,</span>        <span class="token property">"replicas"</span><span class="token operator">:</span> <span class="token string">"2"</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token property">"Files"</span><span class="token operator">:</span> <span class="token null keyword">null</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"Dynamic"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们将 buildx 生成的配置文件创建为 configmap 保存在 kubernetes 集群中，后面我们需要将这个 configmap 挂载到 pod 里。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl create cm buildx.config --from-file<span class="token operator">=</span>data<span class="token operator">=</span><span class="token environment constant">$HOME</span>/.docker/buildx/instances/kube<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="构建测试"><a href="#构建测试" class="headerlink" title="构建测试"></a>构建测试</h2><p>是骡子是马拉出来遛遛，我们就以构建 <strong><a href="https://github.com/muzi502/open-vm-tools-oe2003">open-vm-tools-oe2003</a></strong> RPM 为例来验证一下咱的这个方案究竟靠不靠谱 🤣。这个项目是给某为的 openEuler 2003 构建 open-vm-tools rpm 包用的 Dockerfile 如下。</p><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> openeuler/openeuler:20.03 <span class="token keyword">as</span> builder</span><span class="token instruction"><span class="token keyword">RUN</span> sed -i <span class="token string">"s#repo.openeuler.org#repo.huaweicloud.com/openeuler#g"</span> /etc/yum.repos.d/openEuler.repo &amp;&amp; <span class="token operator">\</span>    dnf install rpmdevtools* dnf-utils -y &amp;&amp; <span class="token operator">\</span>    rpmdev-setuptree</span><span class="token comment"># clone open-vm-tools source code and update spec file for fixes oe2003 build error</span><span class="token instruction"><span class="token keyword">ARG</span> COMMIT_ID=8a7f961</span><span class="token instruction"><span class="token keyword">ARG</span> GIT_REPO=https://gitee.com/src-openeuler/open-vm-tools.git</span><span class="token instruction"><span class="token keyword">WORKDIR</span> /root/rpmbuild/SOURCES</span><span class="token instruction"><span class="token keyword">RUN</span> git clone <span class="token variable">$GIT_REPO</span> . &amp;&amp; <span class="token operator">\</span>    git reset --hard <span class="token variable">$COMMIT_ID</span> &amp;&amp; <span class="token operator">\</span>    sed -i <span class="token string">'s#^%&#123;_bindir&#125;/vmhgfs-fuse$##g'</span> open-vm-tools.spec &amp;&amp; <span class="token operator">\</span>    sed -i <span class="token string">'s#^%&#123;_bindir&#125;/vmware-vmblock-fuse$##g'</span> open-vm-tools.spec &amp;&amp; <span class="token operator">\</span>    sed -i <span class="token string">'s#gdk-pixbuf-xlib#gdk-pixbuf2-xlib#g'</span> open-vm-tools.spec</span><span class="token comment"># install open-vm-tools rpm build dependencies</span><span class="token instruction"><span class="token keyword">RUN</span> yum-builddep -y open-vm-tools.spec</span><span class="token instruction"><span class="token keyword">RUN</span> rpmbuild --define <span class="token string">"dist .oe1"</span> -ba open-vm-tools.spec --quiet</span><span class="token comment"># download rpm runtime dependencies</span><span class="token instruction"><span class="token keyword">FROM</span> openeuler/openeuler:20.03 <span class="token keyword">as</span> dep</span><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /root/rpmbuild/RPMS/ /root/rpmbuild/RPMS/</span><span class="token instruction"><span class="token keyword">RUN</span> sed -i <span class="token string">"s#repo.openeuler.org#repo.huaweicloud.com/openeuler#g"</span> /etc/yum.repos.d/openEuler.repo &amp;&amp; <span class="token operator">\</span>    dnf install -y --downloadonly --downloaddir=/root/rpmbuild/RPMS/$(arch) /root/rpmbuild/RPMS/$(arch)/*.rpm</span><span class="token comment"># copy rpms to local</span><span class="token instruction"><span class="token keyword">FROM</span> scratch</span><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">dep</span></span> /root/rpmbuild/RPMS/ /</span><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /root/rpmbuild/RPMS/ /</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其中 <code>RUN rpmbuild --define &quot;dist .oe1&quot; -ba open-vm-tools.spec --quiet</code> 这个步骤是构建和编译 RPM 里的二进制文件因此十分耗费 CPU 资源，也是整个镜像构建最耗时的一部分。</p><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token comment"># copy rpms to local</span><span class="token instruction"><span class="token keyword">FROM</span> scratch</span><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">dep</span></span> /root/rpmbuild/RPMS/ /</span><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /root/rpmbuild/RPMS/ /</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>因为我们构建的目标产物是 RPM 包文件并不需要把镜像 push 到镜像仓库中，所以 <code>Dockerfile</code> 最后面这一段是为了将构建产物捞出来输出到我们本地的目录上，buildx 对应的参数就是 <code>--output type=local,dest=path</code>。同时为了排除 cache 的影响，我们再加上 <code>--no-cache</code> 参数构建过程中不使用缓存。接着我们运行 docker build 命令进行构建，看一下构建的用时是多久 🤓</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">DOCKER_BUILDKIT</span><span class="token operator">=</span><span class="token number">1</span> <span class="token function">docker</span> buildx build <span class="token punctuation">\</span>--no-cache <span class="token punctuation">\</span><span class="token parameter variable">--ulimit</span> <span class="token assign-left variable">nofile</span><span class="token operator">=</span><span class="token number">1024</span>:1024 <span class="token punctuation">\</span><span class="token parameter variable">--platform</span> linux/amd64,linux/arm64 <span class="token punctuation">\</span><span class="token parameter variable">-f</span> /root/usr/src/github.com/muzi502/open-vm-tools-oe2003/Dockerfile <span class="token punctuation">\</span><span class="token parameter variable">--output</span> <span class="token assign-left variable">type</span><span class="token operator">=</span>local,dest<span class="token operator">=</span>/root/usr/src/github.com/muzi502/open-vm-tools-oe2003/output <span class="token punctuation">\</span>/root/usr/src/github.com/muzi502/open-vm-tools-oe2003<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Building <span class="token number">364</span>.6s <span class="token punctuation">(</span><span class="token number">30</span>/30<span class="token punctuation">)</span> FINISHED <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load .dockerignore                                                                                                         <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> transferring context: 2B                                                                                                           <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load build definition from Dockerfile                                                                                      <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> transferring dockerfile: <span class="token number">1</span>.35kB                                                                                                    <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load .dockerignore                                                                                                         <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> transferring context: 2B                                                                                                           <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load build definition from Dockerfile                                                                                      <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> transferring dockerfile: <span class="token number">1</span>.35kB                                                                                                    <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/amd64 internal<span class="token punctuation">]</span> load metadata <span class="token keyword">for</span> docker.io/openeuler/openeuler:20.03                                                          <span class="token number">2</span>.1s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/arm64 internal<span class="token punctuation">]</span> load metadata <span class="token keyword">for</span> docker.io/openeuler/openeuler:20.03                                                          <span class="token number">2</span>.1s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>auth<span class="token punctuation">]</span> openeuler/openeuler:pull token <span class="token keyword">for</span> registry-1.docker.io                                                                        <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>auth<span class="token punctuation">]</span> openeuler/openeuler:pull token <span class="token keyword">for</span> registry-1.docker.io                                                                        <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> CACHED <span class="token punctuation">[</span>linux/arm64 builder <span class="token number">1</span>/6<span class="token punctuation">]</span> FROM docker.io/openeuler/openeuler:20.03@sha256:4aef44f5d6af7b07b02a9a3b29cbac5f1f109779209d7649a2e  <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> resolve docker.io/openeuler/openeuler:20.03@sha256:4aef44f5d6af7b07b02a9a3b29cbac5f1f109779209d7649a2ea196a681a52ee                <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/arm64 builder <span class="token number">2</span>/6<span class="token punctuation">]</span> RUN <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#repo.openeuler.org#repo.huaweicloud.com/openeuler#g"</span> /etc/yum.repos.d/openEuler.repo <span class="token operator">&amp;&amp;</span>      <span class="token number">54</span>.6s <span class="token operator">=</span><span class="token operator">></span> CACHED <span class="token punctuation">[</span>linux/amd64 builder <span class="token number">1</span>/6<span class="token punctuation">]</span> FROM docker.io/openeuler/openeuler:20.03@sha256:4aef44f5d6af7b07b02a9a3b29cbac5f1f109779209d7649a2e  <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> resolve docker.io/openeuler/openeuler:20.03@sha256:4aef44f5d6af7b07b02a9a3b29cbac5f1f109779209d7649a2ea196a681a52ee                <span class="token number">0</span>.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/amd64 builder <span class="token number">2</span>/6<span class="token punctuation">]</span> RUN <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#repo.openeuler.org#repo.huaweicloud.com/openeuler#g"</span> /etc/yum.repos.d/openEuler.repo <span class="token operator">&amp;&amp;</span>      <span class="token number">65</span>.1s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/arm64 builder <span class="token number">3</span>/6<span class="token punctuation">]</span> WORKDIR /root/rpmbuild/SOURCES                                                                              <span class="token number">0</span>.3s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/arm64 builder <span class="token number">4</span>/6<span class="token punctuation">]</span> RUN <span class="token function">git</span> clone https://gitee.com/src-openeuler/open-vm-tools.git <span class="token builtin class-name">.</span> <span class="token operator">&amp;&amp;</span>     <span class="token function">git</span> reset <span class="token parameter variable">--hard</span> 8a7f961 <span class="token operator">&amp;&amp;</span>     s  <span class="token number">1</span>.8s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/arm64 builder <span class="token number">5</span>/6<span class="token punctuation">]</span> RUN yum-builddep <span class="token parameter variable">-y</span> open-vm-tools.spec                                                                     <span class="token number">58</span>.8s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/amd64 builder <span class="token number">3</span>/6<span class="token punctuation">]</span> WORKDIR /root/rpmbuild/SOURCES                                                                              <span class="token number">0</span>.3s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/amd64 builder <span class="token number">4</span>/6<span class="token punctuation">]</span> RUN <span class="token function">git</span> clone https://gitee.com/src-openeuler/open-vm-tools.git <span class="token builtin class-name">.</span> <span class="token operator">&amp;&amp;</span>     <span class="token function">git</span> reset <span class="token parameter variable">--hard</span> 8a7f961 <span class="token operator">&amp;&amp;</span>     s  <span class="token number">2</span>.1s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/amd64 builder <span class="token number">5</span>/6<span class="token punctuation">]</span> RUN yum-builddep <span class="token parameter variable">-y</span> open-vm-tools.spec                                                                     <span class="token number">71</span>.9s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/arm64 builder <span class="token number">6</span>/6<span class="token punctuation">]</span> RUN rpmbuild <span class="token parameter variable">--define</span> <span class="token string">"dist .oe1"</span> <span class="token parameter variable">-ba</span> open-vm-tools.spec <span class="token parameter variable">--quiet</span>                                          <span class="token number">175</span>.2s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/amd64 builder <span class="token number">6</span>/6<span class="token punctuation">]</span> RUN rpmbuild <span class="token parameter variable">--define</span> <span class="token string">"dist .oe1"</span> <span class="token parameter variable">-ba</span> open-vm-tools.spec <span class="token parameter variable">--quiet</span>                                          <span class="token number">181</span>.4s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/arm64 dep <span class="token number">2</span>/3<span class="token punctuation">]</span> COPY <span class="token parameter variable">--from</span><span class="token operator">=</span>builder /root/rpmbuild/RPMS/ /root/rpmbuild/RPMS/                                                   <span class="token number">0</span>.1s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/arm64 dep <span class="token number">3</span>/3<span class="token punctuation">]</span> RUN <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#repo.openeuler.org#repo.huaweicloud.com/openeuler#g"</span> /etc/yum.repos.d/openEuler.repo <span class="token operator">&amp;&amp;</span>     dnf  <span class="token number">31</span>.6s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/amd64 dep <span class="token number">2</span>/3<span class="token punctuation">]</span> COPY <span class="token parameter variable">--from</span><span class="token operator">=</span>builder /root/rpmbuild/RPMS/ /root/rpmbuild/RPMS/                                                   <span class="token number">0</span>.1s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/amd64 dep <span class="token number">3</span>/3<span class="token punctuation">]</span> RUN <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#repo.openeuler.org#repo.huaweicloud.com/openeuler#g"</span> /etc/yum.repos.d/openEuler.repo <span class="token operator">&amp;&amp;</span>     dnf  <span class="token number">39</span>.2s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/arm64 stage-2 <span class="token number">1</span>/2<span class="token punctuation">]</span> COPY <span class="token parameter variable">--from</span><span class="token operator">=</span>dep /root/rpmbuild/RPMS/ /                                                                      <span class="token number">0</span>.1s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/arm64 stage-2 <span class="token number">2</span>/2<span class="token punctuation">]</span> COPY <span class="token parameter variable">--from</span><span class="token operator">=</span>builder /root/rpmbuild/RPMS/ /                                                                  <span class="token number">0</span>.2s <span class="token operator">=</span><span class="token operator">></span> exporting to client directory                                                                                                         <span class="token number">2</span>.4s <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> copying files linux/arm64 <span class="token number">35</span>.93MB                                                                                                  <span class="token number">2</span>.3s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/amd64 stage-2 <span class="token number">1</span>/2<span class="token punctuation">]</span> COPY <span class="token parameter variable">--from</span><span class="token operator">=</span>dep /root/rpmbuild/RPMS/ /                                                                      <span class="token number">0</span>.1s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>linux/amd64 stage-2 <span class="token number">2</span>/2<span class="token punctuation">]</span> COPY <span class="token parameter variable">--from</span><span class="token operator">=</span>builder /root/rpmbuild/RPMS/ /                                                                  <span class="token number">0</span>.2s <span class="token operator">=</span><span class="token operator">></span> exporting to client directory                                                                                                         <span class="token number">1</span>.6s <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> copying files linux/amd64 <span class="token number">36</span>.59MB                                                                                                  <span class="token number">1</span>.6stree rpms<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>用时对比</th><th>amd64 (Intel(R) Xeon(R) Silver 4110 CPU @ 2.10GHz)</th><th>arm64（HUAWEI Kunpeng 920 5250 2.6 GHz）</th></tr></thead><tbody><tr><td>yum-builddep</td><td>71.9s</td><td>58.8s</td></tr><tr><td>rpmbuild</td><td>181.4s</td><td>175.2s</td></tr></tbody></table><p>通过上面的构建用时对比可以看到 arm64 的机器上构建比 amd64 要快一点，是由于 Kunpeng 920 5250 CPU 主频比 Intel Xeon 4110 高的缘故，如果主频拉齐的话二者的构建速度应该是差不多的。可惜我们 IDC 内部的机器 CPU 大多是<strong>十几块钱包邮还送硅脂的钥匙串</strong>（某宝上搜 E5 v3&#x2F;v4）找不到合适的机器进行 PK 对比，大家自己脑补一下吧🥹，要不汝给咱点 CPU 😂。</p><p>总之我们这套方案实现的效果还是蛮不错滴，比用 qemu 模拟多架构的方式不知道高到哪里去了 🤓。</p><h2 id="Jenkins-流水线"><a href="#Jenkins-流水线" class="headerlink" title="Jenkins 流水线"></a>Jenkins 流水线</h2><p>首先，我们需要定制自己的 Jenkins slave pod 的基础镜像，将 docker 和 buildx 这两个二进制工具添加进来。需要注意的是，这里的 docker 命令行只是作为客户端使用，因此我们可以直接从 docker 的官方镜像中提取此二进制文件。不同的项目需要不同的工具集，可以参考我的 <a href="https://github.com/muzi502/buildkit-on-k8s-example/blob/master/Dockerfile">Dockerfile</a>。</p><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> python:3.10-slim</span><span class="token instruction"><span class="token keyword">ARG</span> BUILDER_NAME=kube</span><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">docker.io/library/docker:20.10.12-dind-rootless</span></span> /usr/local/bin/docker /usr/local/bin/docker</span><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">docker.io/docker/buildx-bin:v0.10</span></span> /buildx /usr/libexec/docker/cli-plugins/docker-buildx</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>这里还有一个冷门的 Dockerfile 的小技巧：通过 <code>COPY --from=</code> 的方式来下载一些二进制工具。基本上我写的 Dockerfile 都会用它，可谓是屡试不爽 <code>身经百战了</code>😎。别再用 wget&#x2F;curl 这种方式傻乎乎地安装这些二进制工具啦，一句 <code>COPY --from= </code> 不知道高到哪里去了。</p><blockquote class="twitter-tweet"><p lang="zh" dir="ltr">分享一个比较冷门的 Dockerfile 的小技巧：<br>当你要安装一个 binary 工具时（比如 jq、yq、kubectl、helm、docker 等等），可以考虑直接从它们的镜像里 COPY 过来，替代使用 wget/curl 下载安装的方式，比如：<br>COPY --from=docker:20.10.12-dind-rootless /usr/local/bin/docker /usr/local/bin/docker <a href="https://t.co/4ZWFqk5EEv">pic.twitter.com/4ZWFqk5EEv</a></p>&mdash; Reimu (@muzi_ii) <a href="https://twitter.com/muzi_ii/status/1522599179918647296?ref_src=twsrc%5Etfw">May 6, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>接下来，我们需要自定义 Jenkins Kubernetes 插件的 Pod 模板，将我们上面创建的 buildx 配置文件的 configMap 通过 volume 挂载到 Pod 中。这个 Jenkins slave Pod 就可以在 k8s 中通过 Service Accounts 加上 buildx 配置文件来连接 buildkit 了。可以参考我这个 <a href="https://github.com/muzi502/buildkit-on-k8s-example/blob/master/Jenkinsfile">Jenkinsfile</a>。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">// Kubernetes pod template to run.podTemplate(    <span class="token key atrule">cloud</span><span class="token punctuation">:</span> JENKINS_CLOUD<span class="token punctuation">,</span>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> POD_NAMESPACE<span class="token punctuation">,</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">label</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">yaml</span><span class="token punctuation">:</span> """<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">kubectl.kubernetes.io/default-container</span><span class="token punctuation">:</span> runner<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>    <span class="token key atrule">kubernetes.io/arch</span><span class="token punctuation">:</span> amd64  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> runner    <span class="token key atrule">image</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span>POD_IMAGE<span class="token punctuation">&#125;</span>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token comment"># 将 buildx 配置文件挂载到当前用户的 /root/.docker/buildx/instances/kube 目录下</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> buildx<span class="token punctuation">-</span>config      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /root/.docker/buildx/instances/kube      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">subPath</span><span class="token punctuation">:</span> kube    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> HOST_IP      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>        <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>          <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.hostIP  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jnlp    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"\$(JENKINS_SECRET)"</span><span class="token punctuation">,</span> <span class="token string">"\$(JENKINS_NAME)"</span><span class="token punctuation">]</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"docker.io/jenkins/inbound-agent:4.11.2-4-alpine"</span>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token comment"># 配置 configmap 挂载</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> buildx<span class="token punctuation">-</span>config      <span class="token key atrule">configMap</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> buildx.config        <span class="token key atrule">items</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> data            <span class="token key atrule">path</span><span class="token punctuation">:</span> kube"""<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当 Jenkins slave pod 创建好之后，我们还需要进行一些初始化配置，例如设置 buildx 和登录镜像仓库等。我们可以在 Jenkins pipeline 中增加一个 Init 的 stage 来完成这些操作。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">stage<span class="token punctuation">(</span><span class="token string">"Init"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    withCredentials<span class="token punctuation">(</span><span class="token punctuation">[</span>usernamePassword<span class="token punctuation">(</span>credentialsId: <span class="token string">"<span class="token variable">$&#123;REGISTRY_CREDENTIALS_ID&#125;</span>"</span>, passwordVariable: <span class="token string">"REGISTRY_PASSWORD"</span>, usernameVariable: <span class="token string">"REGISTRY_USERNAME"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">sh</span> <span class="token string">""</span>"        <span class="token comment"># 将 docker buildx build 重命名为 docker build</span>        <span class="token function">docker</span> buildx <span class="token function">install</span>        <span class="token comment"># 设置 buildx 使用的 builder，不然会默认使用 unix:///var/run/docker.sock</span>        <span class="token function">docker</span> buildx use kube        <span class="token comment"># 登录镜像仓库</span>        <span class="token function">docker</span> login <span class="token variable">$&#123;REGISTRY&#125;</span> <span class="token parameter variable">-u</span> <span class="token string">'$&#123;REGISTRY_USERNAME&#125;'</span> <span class="token parameter variable">-p</span> <span class="token string">'$&#123;REGISTRY_PASSWORD&#125;'</span>        <span class="token string">""</span>"    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>构建镜像时，我们可以在 buildkit 部署节点上运行 pstree 命令，来查看构建的过程。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@product-builder-master:~<span class="token comment"># pstree -l -c -a -p -h -A 2637</span>buildkitd,2637  <span class="token operator">|</span>-buildkit-runc,989505 <span class="token parameter variable">--log</span> /var/lib/buildkit/runc-overlayfs/executor/runc-log.json --log-format json run <span class="token parameter variable">--bundle</span> /var/lib/buildkit/runc-overlayfs/executor/82zvcfesf5g19t2682g3j9hrr 82zvcfesf5g19t2682g3j9hrr  <span class="token operator">|</span>   <span class="token operator">|</span>-rpmbuild,989519 <span class="token parameter variable">--define</span> dist .oe1 <span class="token parameter variable">-ba</span> open-vm-tools.spec <span class="token parameter variable">--quiet</span>  <span class="token operator">|</span>   <span class="token operator">|</span>   <span class="token variable"><span class="token variable">`</span>-sh,989562 <span class="token parameter variable">-e</span> /var/tmp/rpm-tmp.xKly7N  <span class="token operator">|</span>   <span class="token operator">|</span>       <span class="token variable">`</span></span>-make,995708 <span class="token parameter variable">-O</span> <span class="token parameter variable">-j64</span> <span class="token assign-left variable">V</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">VERBOSE</span><span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过 buildkitd 的进程树，我们可以看到 buildkitd 进程中有一个 buildkit-runc 的子进程。它会在一个 runc 容器中运行 Dockerfile 中对应的命令。因此，我们可以得知 buildkit on kubernetes 和之前的 docker in pod 实现原理是类似的，只不过这里的 buildkit 只用于构建镜像而已。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://github.com/muzi502/buildkit-on-k8s-example">buildkit-on-k8s-example</a></li><li><a href="https://docs.docker.com/engine/reference/commandline/buildx_create/#driver">docker buildx create</a></li><li><a href="https://docs.docker.com/build/drivers/kubernetes/">Kubernetes driver</a></li><li><a href="https://yanhang.me/post/2019-04-08-buildkit/">Docker BuildKit 介绍</a></li><li><a href="https://meaninglive.com/2022/02/14/%E3%80%8Cdocker-buildx%E3%80%8D-%E6%9E%84%E5%BB%BA%E8%B7%A8%E5%B9%B3%E5%8F%B0%E9%95%9C%E5%83%8F/">「Docker Buildx」- 构建“跨平台”镜像</a></li><li><a href="https://moelove.info/2021/11/03/OCI-%E4%B8%8E%E4%B8%8B%E4%B8%80%E4%BB%A3%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E5%B7%A5%E5%85%B7/">OCI 与下一代镜像构建工具</a></li><li><a href="https://moelove.info/2021/03/14/%E4%B8%87%E5%AD%97%E9%95%BF%E6%96%87%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/">万字长文：彻底搞懂容器镜像构建</a></li><li><a href="https://github.com/docker/buildx/pull/1412">Attestations from buildx </a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;去年曾写过一篇介绍如何使用 docker in pod
        
      
    
    </summary>
    
    
      <category term="技術" scheme="https://blog.k8s.li/categories/%E6%8A%80%E8%A1%93/"/>
    
    
      <category term="kubernetes" scheme="https://blog.k8s.li/tags/kubernetes/"/>
    
      <category term="BuildKit" scheme="https://blog.k8s.li/tags/BuildKit/"/>
    
  </entry>
  
  <entry>
    <title>写在上海封城一年之后</title>
    <link href="https://blog.k8s.li/One-Year-After-the-Lockdown-in-Shanghai.html"/>
    <id>https://blog.k8s.li/One-Year-After-the-Lockdown-in-Shanghai.html</id>
    <published>2023-04-15T16:00:00.000Z</published>
    <updated>2023-04-15T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>时代的一粒灰尘落在个人身上就是一座山，不幸的是：我们偏偏却活在一个尘土飞扬的年代。如果要对三年防疫做一句总结的话，我愿意称之为<strong>一场政治运动型的防疫闹剧</strong>。</p><h2 id="防疫闹剧"><a href="#防疫闹剧" class="headerlink" title="防疫闹剧"></a>防疫闹剧</h2><p>2022 依旧是人类社会<strong>倒车和加速灭亡</strong>的一年。不过有幸的是，在经济下行压力、白纸运动抗议、国际共存舆论等众多因素的影响下，年末当权者终于叫停了这场政治运动型的防疫闹剧，底层的屁民韭菜们终于有了口喘气活下去的机会。回想起去年的现在，还被封在家里、还在抢菜、还在为明天吃什么发愁、还在担心这场荒诞至极的防疫闹剧什么时候能结束、还在担心这场闹剧的现实会一直持续下去。回想起那段时间唯独两天一次的支性检测不敢半点耽搁、老老实实做核酸、戴口罩、出示健康码、被训得服服帖帖，可谓是奴(zhi)性十足。</p><p>即便是去年六月初上海解封后，依旧没有从那种恐惧中解脱出来，反而变得越来越自闭，直到现在此刻的心态和上海封城那段时间没有太大区别。思想审查、文字狱、集中营、白色恐怖、谎言欺骗，这些并没有因为疫情结束而消失，每天的感触就像是在历史与现实的夹缝中苟活，对未来充满着无限的恐惧。</p><p>或许我们已经早已经听惯了<strong>你不关心政治政治会来关心你</strong>这句废话，但当经历了这场灾难（防疫闹剧）之后，我们或多或少地能感触到<strong>一个国家的政治气候的变化是如何深刻地影响和限制人类生存的状态和生存的可能</strong>。在某些性命攸关的时刻，政治它直接或间接地决定了我们还能不能在这个世界生存下去。</p><p>从去年上海封城到现在，在这一年多的时间里，博客已经很少再更新了，也慢慢地淡出了推特。除了正常的工作生活外，大部分时间和精力都是在研究和思考这个国家和社会为什么会上演着一场场荒诞至极的防疫闹剧。结合这三年防疫闹剧期间所发生、暴露出的一切，以及自己的生活感受，我越来越有一种想探究这场防疫闹剧的政治基础是如何一步步建立起来的想法。于是近期就整理了一些最近一年多的时间里所读的书以及一些个人的想法。</p><h2 id="读书笔记"><a href="#读书笔记" class="headerlink" title="读书笔记"></a>读书笔记</h2><h3 id="孔飞力《叫魂：1768-年中國妖術大恐慌》"><a href="#孔飞力《叫魂：1768-年中國妖術大恐慌》" class="headerlink" title="孔飞力《叫魂：1768 年中國妖術大恐慌》"></a>孔飞力《叫魂：1768 年中國妖術大恐慌》</h3><p>第一次读这本书是在 2021 年五一假期期间，那时我正在 <a href="https://blog.k8s.li/taihu.html">2021 五一假期环太湖骑行之旅</a>中。2022 年上海封城后，我又重新读了一遍。再次读这本书的动机，已经想不太清了。我记得当时看到了一些令人匪夷所思的防疫闹剧，比如某个小区的防疫工作人员把居民团购买的菜扔进垃圾桶里，这种防疫闹剧令我十分费解。我不能理解大白和红袖章这些群体以防疫为名拥有了一点权力后就会上演着一场场令人匪夷所思的防疫闹剧。</p><p>还有就是当时在推特上看到了一个以防疫为名殴打村民的短视频，让我再一次想起了我的另一段切身经历：在 2020 年武汉肺炎刚爆发的时候，我外婆在大年初六那天不幸离开了这个世界。依稀记得那天去我外婆家的路也被封得严严实实，没办法开车去，只能骑电动车。在村与村交界的路上被当地的红袖章拦住不让过，给他说明了原因也死活不让过。真是欺人太甚，气得我直接踹开挡板骑车电车硬闯了过去。随后红袖章拨打了当地派出所的电话，两辆警车十几号人来抓捕我。当时一直就想不清为什么一个普通的村民戴上红袖章之后就如此膨胀，直到读了这本书后我慢慢地想通了。</p><p>这本书向人们展示了中国社会普遍存在的一个现象：社会上到处表现出冤冤相报的敌意。中国的专制制度从公元前 221 年秦始皇统一中国开始，沿袭了两千多年，有着丰厚的历史积淀。即便是在今天，权力仍垄断在专制统治阶层手中，让普通民众享有权力十分困难，而当以叫魂或防疫为名的“幻觉权力”进入社会之后，普通民众就拥有了互相报复的武器。他们所能爆发出来的威力正如书中所描写的那样恐怖。</p><blockquote><p>一旦官府认真发起对妖术的清剿，普通人就有了很好的机会来清算宿怨或谋取私利。这是扔在大街上的上了膛的武器，每个人——无论恶棍或良善——都可以取而用之。在这个权力对普通民众来说向来稀缺的社会里，以“叫魂”罪名来恶意中伤他人成了普通人的一种突然可得的权力。对任何受到横暴的族人或贪婪的债主逼迫的人来说，这一权力为他们提供了某种解脱；对害怕受到迫害的人，它提供了一块盾牌；对想得到好处的人，它提供了奖赏；对妒嫉者，它是一种补偿；对恶棍，它是一种力量；对虐待狂，它则是一种乐趣。</p></blockquote><blockquote><p>施行妖术和提出妖术指控所折射反映出来的是人们的无权无势状态。对一些无权无势的普通民众来说，弘历的清剿给他们带来了慷慨的机会。即使在今天，让普通民众享有权力仍是一个还未实现的许诺。毫不奇怪，冤冤相报（这是“受困扰社会”中最为普遍的社会进攻方式）仍然是中国社会生活的一个显著特点。</p></blockquote><blockquote><p>没有人会哀悼旧中国的官僚制度。即使按照当时的标准，它所造成的社会伤害也已超出了仅仅压碎几个无依无助的游民踝骨的程度。但不论是好事还是坏事，它的特性却可以阻挡任何一种狂热。没有这样一个应急的锚碇，中国就会在风暴中急剧偏航。在缺乏一种可行的替代制度的情况下，统治者就可以利用操纵民众的恐惧，将之转变为可怕的力量。生活于我们时代的那些异见人士和因社会背景或怪异信仰而易受指控的替罪羊，便会成为这种力量的攻击目标。</p></blockquote><blockquote><p>当代中国的历史中充满了这种幻觉权力进入社会的例子。我还记得 1982 年在北京与一个老红卫兵的谈话。他当时是一个低收入的服务工。他感慨地说，毛泽东的文化革命对于像他这样没有正式资格循常规途径在社会上进身的人来说是一个黄金时代，毛号召年轻人起来革命造反，这一来自顶端的突然可得的权力使他的野心得到了满足。他抱怨说，现在的社会样样都要通过考试，他再也没有希望从现在这个最底层的位置爬上去了。</p></blockquote><h3 id="高华《历史笔记》"><a href="#高华《历史笔记》" class="headerlink" title="高华《历史笔记》"></a>高华《历史笔记》</h3><blockquote class="twitter-tweet"><p lang="zh" dir="ltr">最近在读高华的《历史笔记》，感触最深的就是：六十年前大饥荒时基层干部对死亡人数谎报瞒报、中央政府拒不承认事实、新闻媒体跟着愚民洗脑。再看看我们所处的时代，从武汉肺炎谎报瞒报到西安的掩耳到“零”。六十年过去了，还是熟悉的味道。<br><br>所以我十分相信“对未来充满希望的人往往对历史一无所知”。 <a href="https://t.co/QNhH5AfxPs">pic.twitter.com/QNhH5AfxPs</a></p>&mdash; Reimu (@muzi_ii) <a href="https://twitter.com/muzi_ii/status/1481975057190916096?ref_src=twsrc%5Etfw">January 14, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>《历史笔记》是我在 2022 年读的第一本书，从元旦开始阅读，花费了相当长的时间和精力才读完。这本书是高华教授的遗作，共分为上下两卷四编，繁体中文。</p><p>第一编《⾰命、内战与⺠族主义》分论国⺠党共产党两党 1949 年前各⾃的历史。作为国共内战胜利方的中共是本章的论述重点，所选文章不仅反映其革命夺权历程，还映射出 1949 年后政治实践的某些雏形。</p><blockquote><p>民族主義與民主主義是一對雙胞胎，區別在於：民族主義，強調集體認同和國家認同；民主主義，強調個人本位，個人權利，個人自由。從理論上講，當國家、民族面臨嚴重的危機時，國民應讓渡出自己的一部分個人權利，以服從於國家利益，支持國家戰勝危機，而國家的最終目的是保護個人自由。但是在近代以來，民族主義經常吞噬民主主義，這主要是由中國近代的政治和大的環境造成的。也和人們認識的誤區，統治階級的狹隘和自私有關。</p></blockquote><p>第⼆编《断裂与延续》主要论及⽑泽东时代，内容涵盖了三反五反、大跃进运动、四清运动、林彪事件等多个历史事件。其中十分推荐大家去仔细地去读一下<a href="https://www.cuhk.edu.hk/ics/21c/media/articles/c048-199807004.pdf">《大躍進運動與國家權力的擴張》</a>这个章节，从某种程度上我觉着这场防疫闹剧和大跃进运动背后的政治逻辑极其相似。</p><blockquote><p>1958 年由毛澤東親自發動、席捲全國的大躍進運動，是一場具有空想烏托邦性質的政治運動。今天人們憶及當年的大躍進，馬上會聯想到「高產衛星」、「全民煉鋼」、「公社食堂」等帶有荒誕色彩的景象。然而大躍進並非僅僅是一場烏托邦運動，在大躍進期間，國家權力借着這場運動的推動，以前所未有的規模急速地向社會各個領域擴張。大躍進運動使國家權威得以擴大和強化，不僅深刻地改變了中國社會的面貌，也大大加強了民眾對國家權威的認知。</p></blockquote><blockquote><p>在大躍進期間，國家意志透過強有力的政治動員和組織措施得以全力貫徹，國家權力在這個過程中急速擴張。</p></blockquote><blockquote><p>與以往歷次政治運動相比，大躍進是一場規模更大的群眾性運動，這場運動不僅促使國家權威向城鄉全面滲透，而且在社會生活所有領域都建立、鞏固和強化了國家權力。</p></blockquote><blockquote><p>令人驚奇的是，即使到了這一步，一些領導幹部仍在繼續隱瞞饑荒的真相。周恩來以後回憶道，在 I960 年夏天召開的北戴河會議上，他本人「已經意識到糧食有問題，但大家不承認，結果把真實情況給掩蓋起來了」。</p></blockquote><blockquote><p>直至 1960 年 10 月，《人民日報》在國慶社論中才對形勢作出了新的解釋。社論稱，「兩年來，全國大部分地區連續遭受嚴重的自然災害，造成糧食嚴重減產」。社論並宣稱，「人民公社已使我國農民永遠擺脱了那種每遭自然災害必然有成百萬、成千萬人饑餓、逃荒和死亡的歷史命運」。社論作者當然知道，就在這篇社論發表之時，全國各地農村正在發生大面積餓死人的情況，但事實歸事實，宣傳歸宣傳，他們選擇採取了「硬着頭皮頂住」的方針。</p></blockquote><p>还有<a href="https://www.hkiaps.cuhk.edu.hk//wd/ni/20181024-091256_1_usc_17_secure.pdf">《1949-1965 年中國社會的政治分層》</a>章节里提到的<strong>向党交心运动</strong>十分有有意思，大跃进时期都是要把心交给党的，比现在安个反诈 app 把隐私交给党高到不知道哪里去了 😂。</p><blockquote><p>全體教師聯合舉行改造促進大會，他們抬着「大紅心」的標誌上街遊行。4 月 4 日，南京市各高校師生與科研機關的民主人士共三千餘人，高舉「把心交給黨」、「把知識交給人民」的旗幟在南京市舉行大遊行，之後，又舉行了社會主義自我改造促進大會。4 月 21 日，南京市工商界三千多人召開大會，宣佈「立即開展向黨交心運動」，民建中央主席黃炎培親臨會場予以鼓勵。4 月 22 日，南京市工商界和民主黨派提出向黨「交心」要「快、透、深、真」的口號，表示要把「接受黨的領導和走社會主義道路的三心二意，躍進到一心一意」。江蘇省宗教界人士也開展了「交心」運動，天主教界通過「自選」、「自聖」主教，「使全省天主教出現了一個新的局面」。在「交心」運動中，全省 11 個城市民主黨派和工商界人士 4,106 人，共交心 47 萬條。據當時的記載稱，這次交心「大量暴露了他們長期隱瞞的腐朽思想和反動行為」12()。對於工商界和民主人士的「交心」，組織上規定的原則是「自梳自理，求醫會診」。先讓他們對照要求、自我批判，然後引導他們懇請黨員和領導對他們的「壞思想」有針對性地進行批評，並鼓勵他們打破庸俗的情面觀，「比先進，比幹勁」，互相展開批評和思想鬥爭，以使「交心」落在實處，防止「交心」走過場。</p></blockquote><blockquote><p>經過對「二十二個文件」的逐字逐句的精讀，和反復對照檢查，個人原來的小資產階級的自我意識開始分裂。隨着「發掘本心」的逐步深入，學習者普遍對自己的缺點錯誤產生了羞愧意識，出身剝削階級家庭的知識分子黨員更自慚形穢，認為自己確實如毛澤東所言，除了讀了一些如同「狗屎」般無用的書之外，對共產黨和人民的價值無多，尤其嚴重的是，剝削階級的家庭背景，甚至還會使自己在革命的關鍵時刻動搖革命立場，在客觀上危害革命！這樣的自我壓力有如大山般沉重，使許多知識分子黨員原有的沾沾自喜、驕傲自滿等不良習氣一掃而空。</p></blockquote><blockquote><p>按照毛澤東的看法，一個人的階級立場必然決定了他的觀點和態度。例如：你是不是在心裏還欣賞資產階級個性自由、個性解放的錯誤思想？你是否心悦誠服地把一切都獻給黨？你是否真正同意你所出身的剝削階級家庭是骯髒和反動的？你對沒有文化的工農群眾是滿心鄙夷，還是甘心做他們的小學生？你對黨的考驗是真心接受，還是抱冤叫屈？</p></blockquote><p>第三编《「從『大破』走向『大立』」：文革中的「新生事物」》是高華教授生前承擔了香港中文大學中國文化研究所《中華人民共和國史》第七卷的寫作任務。他已列出該卷寫作綱要，惜乎天不假年，只完成了十餘萬字的文稿。</p><blockquote><p>毛為什麼要發動「文革」？「文革」是如何發動起來的？我認為毛澤東發動「文革」有兩方面的動因，第一個因素：「文革」集中體現了毛對他所理想的社會主義的追求；第二個因素：他認為自己已大權旁落，而急於追回，這兩方面的因素互相纏繞，緊密的交融在一起。</p></blockquote><blockquote><p>國家的領導者為了快速建立起一個強大的社會主義的國家，他們一直在謀求一種「最好的」治理中國的制度或管理形式，他們有許多創造，建構了一種新意識形態敍述，中國傳統的思想及制度資源，革命年代的經驗與蘇聯因素融為一體，都被運用其中，被用來統合社會大眾的意識。他們也非常重視做動員、組織民眾的工作，使社會的組織化、軍事化程度不斷增強</p></blockquote><p>第四編《讀書有感》包含多篇書評，論及對象既有風雲人物，也有平頭百姓，既有追隨國民黨政權遷台的作家，也有大陸人所皆知的左翼文人。本章通過對他們回憶的評議展現出多角度的時代變遷與個體感受。</p><blockquote><p>我認為，學歷史、讀歷史，記住余英時先生的一段話是很重要的。他説：學歷史的好處不是光看歷史教訓，歷史教訓也是很少人接受，前面犯多少錯誤，到後面還是繼續。因為人性就是大權在握或利益在手，但難以捨棄，權力和利益的關口，有人過得去，也有人過不去。所以我認為讀歷史的最大好處是使我們懂得人性。</p></blockquote><blockquote><p>在大學讀書的那幾年，我知道，雖然毛澤東晚年的錯誤已被批評，但毛的極左的一套仍根深蒂固，它已滲透到當代人思想意識的深處，成為某種習慣性思維，表現在中國現代史、中共黨史研究領域，就是官學甚行，為聖人避諱，或研究為某種權威著述作注腳，幾乎成為一種流行的風尚。</p></blockquote><h3 id="杨继绳《墓碑：一九五八—一九六二年中國大饑荒紀實》"><a href="#杨继绳《墓碑：一九五八—一九六二年中國大饑荒紀實》" class="headerlink" title="杨继绳《墓碑：一九五八—一九六二年中國大饑荒紀實》"></a>杨继绳《墓碑：一九五八—一九六二年中國大饑荒紀實》</h3><blockquote class="twitter-tweet"><p lang="zh" dir="ltr">親身經歷了上海封城之後再讀楊繼繩的著作《墓碑：中國六十年代大饑荒紀實》，又一次對這個社會陷入了深深的絕望之中😭。<br><br>任何災難都可以被用來塑造成正確的集體記憶，然後成為政權合法性的組成部分。正是這種對民族記憶的大清洗和對罪惡的強制遺忘，遂使得相同的歷史悲劇一次次不斷地重演。 <a href="https://t.co/DfcE6V28Vw">pic.twitter.com/DfcE6V28Vw</a></p>&mdash; Reimu (@muzi_ii) <a href="https://twitter.com/muzi_ii/status/1541775783059787777?ref_src=twsrc%5Etfw">June 28, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>我是去年上海解封后才开始读这本书的。经历了封城，我的心态已经麻木了，无论发生什么荒唐的事情，我已经习以为常了。读这本书的时候，有好几次我都想大哭一场，眼泪和鼻涕都止不住。因为我们现在所经历的悲剧在六十多年前已经发生过一次，而官僚体制应对灾难的方式和六十年前相比没有多少改变。</p><p>从武汉肺炎刚爆发时的谎报瞒报、训诫李文亮医生再到后来西安的”掩耳到零”等招式在六十年前已经使用过了。六十年前怎么应对大饥荒的，我们现在就是怎么应对防疫的，没有任何改变。</p><blockquote><p>各级政府千方百计地对外封锁饥饿的消息。公安局控制了所有的邮局，向外面发出的信件一律扣留。中共信阳地委让邮局扣了 12000 多封向外求助的信。为了不让外出逃荒的饥民走漏消息，在村口封锁，不准外逃。对已经外逃的饥民则以“盲流”的罪名游街、拷打或其它惩罚。</p></blockquote><blockquote><p>1960 年 3 月 12 日卫生所的干部王启云写信给党中央，反映饿死人的严重问题，要求中央仿照“包文丞陈州放粮”，公安局侦破后，对王启云进行残酷的批判斗争。</p></blockquote><blockquote><p>伞陂公社第一次向上报的死亡人数 523 人，第二次报的是 3889 人（后又改为 2907 人），后来省委工作组调查结果是 6668 人。</p></blockquote><blockquote><p>用空洞的“全国形势一派大好”淡化人们实实在在的饥饿，压制人们对饥饿的不满。</p></blockquote><blockquote><p>就在信阳大量饿死人、人相食普遍发生的时候，《河南日报》还宣传形势一派大好，连续发表七篇“向共产主义进军”的文章。</p></blockquote><blockquote><p>在饿殍遍地的情况下，1960 年《河南日报》的元旦社论却以“开门红 春意浓”为题，继续粉饰太平，仍坚持全面跃进。</p></blockquote><blockquote><p>农民明明是饿死了，还不能说是因饥饿而死的。县委领导人赵玉书和董安春到武店公社考城大队检查浮肿病情况，问医师王善良：“为什么浮肿病总是治不好，少什么药？”王医生回答说：“少一味粮食！”赵、董二人立即决定，将王医生交大会批斗后逮捕。</p></blockquote><blockquote><p>在大批农民饿死的时刻，1960 年 2 月 16 日到 18 日，贵州省委召开了三天地、州、市委第一书记会议，主要讨论农村公共食堂问题。这个会不是解决食堂缺粮的问题，而是闭眼不看现实，向中共中央写了一个假报告――《关于农村公共食堂的报告》</p></blockquote><blockquote><p>强大的政治思想工作使人们驯服，新闻封锁使人愚昧。饿死上百万人的“信阳事件”、饿死三分之一人口的“通渭问题”，不仅当时邻近地区不知有其事，甚到几十年后还严加保密。</p></blockquote><blockquote><p>死人明明是饿死的，而说成是年老死的，疾病死的，把非正常死亡说成是正常死亡。有些地方还不允许死者家属哭丧带孝，不准埋坟，对反映死人情况的来信加以扣压，甚至对来信者进行打击；有的干部因为如实向组织反映了死人的情况还挨了斗争。”“因为怕犯错误，怕受处分，怕摘掉乌纱帽，而不敢暴露真实情况；越不敢暴露，问题就发展越大；问题越大，就越不敢暴露。”</p></blockquote><p><a href="https://zhuanlan.zhihu.com/p/508337238">上海养老院将活人装尸袋要求殡仪馆火化</a> 这种荒唐事历史上已经发生过不止一次了</p><blockquote><p>省委副秘书长周颐在雅安考察时看到不少肿得很严重的病人，问他们为什么不去医院治疗，他们说：医院条件很坏，在那里死得更快些。金堂县五星管理区的肿病医院是牛棚改的，清洁卫生没有搞彻底，臭气难闻。病房没有门，四周没有墙，90% 的病人睡地铺，铺草很薄。有的病人没被子，白天还喊冷。广汉县金鱼公社医院院长黄某，把活人装进棺材埋掉。</p></blockquote><blockquote><p>温江清平公社社员李方平饿得奄奄一息，县委检查团下来检查生活，管区干部怕他走漏风声，便把他关进保管室关了三天，生产队长报告说李已死，管区干部下令“死了把他埋了算球”。社员张绍春薅油菜饿倒在田头，队长以为他死了，赶快挖了个坑想把他埋了，埋到一半，张醒过来，大叫“活埋人了……”，吓得队长扔掉锄头就跑。</p></blockquote><blockquote><p>一些地区规定死人后“四不准”：一不准浅埋，要深埋三尺，上面种上庄稼；二不准哭；三不准埋在路旁；四不准戴孝。更恶劣的是黄湾公社张湾小队规定死了人不仅不准戴白布，还叫人披红！</p></blockquote><blockquote><p>二十多岁的民工任文厚被打死后，水库派人直接将尸体拉到该家坟地埋葬，父母想看上一眼都不允许。</p></blockquote><p>同样为了应付上级的视察，官僚组织如何上演共谋闹剧的也是如出一辙。</p><blockquote><p>为了应付上级检查，把大部分人力、畜力、肥料，都调到公路铁路两旁，调到社与社、县与县的交界处，做出样子，而里面却是大片土地抛荒。</p></blockquote><blockquote><p>在外宾所到之处，完全布置了一派丰饶、富裕的景象：湖里有穿着漂亮的女子悠闲地划船唱歌，在路旁的小店里食品丰富。省委所划定了外宾活动的地方，不让老百姓进入，特意布置假象欺骗外宾。</p></blockquote><blockquote><p>1959 年 12 月 9 日，我下放到和政县苏集公社。这里群众没有粮吃，饿得干瘦、浮肿，有的冻饿而死。榆树皮都被剥光吃掉了！有一天县上来电话，说张鹏图副省长要到康乐视察，命令我们连夜组织人把公路两边被剥光皮的榆树，统统砍掉，运到隐蔽的地方去。人都快饿死了，哪有力量去砍树、抬树？我们办不到，留下榆树正好让张鹏图副省长看看。</p></blockquote><p>还有被集中隔离关进方舱的方式也是熟悉的味道</p><blockquote><p>有的地方把社员自留地里的南瓜苗拔出来栽到集休的地里，结果全部死光。强占房屋，逼人搬家，不搬就强行把东西扔到外面。强行收走各家做饭的锅，甚至当着社员的面把锅砸烂了，老人要求留下一口锅烧水也不行。大通桥大队为了办农场，乘社员下地生产之机，将大通桥东头一个小庄子社员家的东西全部抛了出来，房屋由大队占领。社员无家可归，痛哭流涕。</p></blockquote><blockquote><p>乔山大队 31 个村庄，1960 年 6 月，总支书记梅某强迫群众在半天之内并成 6 个庄子，拆掉房子 300 多间，党员不干开除党籍，团员不干开除团籍，社员不干不给饭吃。说是建新村，实际上旧房子拆了新房子没有建，社员无家可归，100 多人被迫集中居住，有 14 户 40 人住在 3 间通连的房子里，晚上大门上锁，民兵持棍把门，尿尿拉屎都在一起。</p></blockquote><blockquote><p>食堂缺柴也是一个普遍问题。解决缺柴的办法一是砍树，二是拆房。全县树木被砍达 80% 以上，全县房屋倒塌和被扒 10 万间以上。有的地方挖坟劈棺当柴烧。在田野劈棺后剩下片片白骨，令人胆寒。</p></blockquote><p>对大饥荒的反思也值得我们认真思考这场防疫闹剧</p><blockquote><p>这是一场人类历史上空前的悲剧。在气候正常的年景，没有战争，没有瘟疫，却有几千万人死于饥饿，却有大范围的“人相食”，这是人类历史上绝无仅有的异数。</p></blockquote><blockquote><p>总路线，大跃进，人民公社，当时合称为“三面红旗”。这是 1958 年令中国人狂热的政治旗帜，是造成三年大饥荒的直接原因，也就是大饥荒的祸根。</p></blockquote><blockquote><p>的确，造成中国几千万人饿死的根本原因是极权制度。当然，我不是说极权制度必然造成如此大规模的死亡，而是说极权制度最容易造成重大政策失误，一旦出现重大政策失误又很难纠正。更重要的是，在这种制度下，政府垄断了一切生产和生活资源，出现灾难以后，普通百姓没有自救能力，只能坐以待毙。</p></blockquote><blockquote><p>为什么没有纠错机制？这是专制制度固有的缺陷。1958 年指导思想的错误，不仅仅是领袖和领导集团的错误，而是制度性错误。</p></blockquote><blockquote><p>权制度就是这样使民族性堕落。大跃进和文化大革命中，人们表现的那样疯狂，那样的残忍，正是民族性堕落的结果，也正是极权制度的“政绩”。</p></blockquote><blockquote><p>中国有句古话：“上有好者，下必甚焉”。这是在专制制度下，下级官员迎合上级的情形。1958 年的情况也是如此。处在一层一层的权力阶梯上的官员们，总是把最高层的意志一步一步地推向极端。</p></blockquote><blockquote><p>中共中央和毛泽东没有从制度、政策、指导思想方面寻找大饥荒的原因，而把大量死人的原因归罪于早已被打入十八层地狱的地、富、反、坏、右。说是因“民主革命不彻底”，而使阶级敌人篡夺基层领导权。这显然是违背事实。</p></blockquote><h2 id="书单"><a href="#书单" class="headerlink" title="书单"></a>书单</h2><p>以下是我个人推荐的历史书籍。在经历了三年的防疫闹剧之后，结合自己的切身经历再次阅读这些历史书籍，就会有种亲临历史的错觉，仿佛活在历史与现实的夹缝之中。这些历史事件并不遥远，就像昨天一样清晰地铭刻在我们的脑海中。</p><table><thead><tr><th>作者</th><th>书名</th></tr></thead><tbody><tr><td>徐贲</td><td>人以什么理由来记忆</td></tr><tr><td>周雪光</td><td>中国国家治理的制度逻辑：一个组织学研究</td></tr><tr><td>谢岳</td><td>维稳的政治逻辑</td></tr><tr><td>笑蜀</td><td>历史的先声：半个世纪前的承诺</td></tr><tr><td>赵紫阳</td><td>改革历程</td></tr><tr><td>徐中约</td><td>中国近代史</td></tr><tr><td>高华</td><td>身份和差异：1949－1965 年中国社会的政治分层</td></tr><tr><td>高华</td><td>在历史的风陵渡口</td></tr><tr><td>高华</td><td>历史笔记</td></tr><tr><td>杨继绳</td><td>天地翻覆：中国文化大革命史</td></tr><tr><td>杨继绳</td><td>中国改革年代的政治斗争</td></tr><tr><td>杨继绳</td><td>中国当代社会阶层分析</td></tr><tr><td>杨继绳</td><td>墓碑: 中国六十年代大饥荒纪实</td></tr><tr><td>橙实 山川 等</td><td>文革笑料集</td></tr><tr><td>【美】傅高义</td><td>邓小平时代</td></tr><tr><td>【美】亨利·基辛格</td><td>世界秩序</td></tr><tr><td>【美】亨利·基辛格</td><td>论中国</td></tr><tr><td>【英】乔治·奥威尔</td><td>1984</td></tr><tr><td>【美】孔飞力</td><td>叫魂：1768 年中国妖术大恐慌</td></tr><tr><td>【美】芭芭拉·德米克</td><td>我们最幸福：北韩人民的真实生活</td></tr><tr><td>【捷克】哈维尔</td><td>哈维尔文集</td></tr><tr><td>【捷克】伊凡·克里玛</td><td>布拉格精神</td></tr><tr><td>【白俄】S·A·阿列克谢耶维奇</td><td>切尔诺贝利的悲鸣</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;时代的一粒灰尘落在个人身上就是一座山，不幸的是：我们偏偏却
        
      
    
    </summary>
    
    
      <category term="生活" scheme="https://blog.k8s.li/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
      <category term="防疫闹剧" scheme="https://blog.k8s.li/tags/%E9%98%B2%E7%96%AB%E9%97%B9%E5%89%A7/"/>
    
  </entry>
  
  <entry>
    <title>使用 Packer 构建虚拟机镜像踩的坑</title>
    <link href="https://blog.k8s.li/packer-vsphere-example.html"/>
    <id>https://blog.k8s.li/packer-vsphere-example.html</id>
    <published>2022-05-24T16:00:00.000Z</published>
    <updated>2022-05-24T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>不久前写过一篇博客《<a href="https://blog.k8s.li/redfish-esxi-os-installer.html">使用 Redfish 自动化安装 ESXi OS</a>》分享了如何使用 Redfish 给物理服务器自动化安装 ESXi OS。虽然在我们内部做到了一键安装&#x2F;重装 ESXi OS，但想要将这套方案应用在客户的私有云机房环境中还是有很大的难度。</p><p>首先这套工具必须运行在 Linux 中才行，对于 Bare Metal 裸服务器来讲还没有安装任何 OS，这就引申出了鸡生蛋蛋生鸡的尴尬难题。虽然可以给其中的一台物理服务器安装上一个 Linux 发行版比如 CentOS，然后再将这套自动化安装 ESXi OS 的工具搭建上去，但这会额外占用一台物理服务器，客户也肯定不愿意接受。</p><p>真实的实施场景中，可行的方案就是将这套工具运行在实施人员的笔记本电脑或者客户提供的台式机上。这又引申出了一个另外的难题：实施人员的笔记本电脑或者客户提供的台式机运行的大都是 Windows 系统，在 Windows 上安装 Ansible、Make、Python3 等一堆依赖，想想就不太现实，而且稳定性和兼容性很难得到保障，以及开发环境和运行环境不一致导致一些其他的奇奇怪怪的问题。虽然该工具支持容器化运行能够解决开发环境和运行环境不一致的问题，但在 Windows 上安装 docker 也比较繁琐和麻烦。</p><p>这时候就要搬出计算机科学中的至理名言: <strong>计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决</strong>。</p><blockquote><p><strong>Any problem in computer science can be solved by another layer of indirection.</strong></p></blockquote><p>既然我们这套工具目前只能在 Linux 上稳定运行，那么我们不如就将这套工具和它所运行的环境封装在一个“中间容器”里，比如虚拟机。使用者只需要安装像 <a href="https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html">VMware Workstation</a> 或者 <a href="https://www.virtualbox.org/">Oracle VirtualBox</a> 虚拟化管理软件运行这台虚拟机不就行了。一切皆可套娃（🤣</p><p>其实原理就像 docker 容器那样，我们将这套工具和它所依赖的运行环境在构建虚拟机的时候将它们全部打包在一起，使用者只需要想办法将这个虚拟机运行起来，就能一键使用我们这个工具，不必再手动安装 Ansible 和 Python3 等一堆依赖了，真正做到开箱即用。</p><p>于是本文分享一下如何使用 <a href="https://www.packer.io/">Packer</a> 在 <a href="https://www.vmware.com/products/vsphere.html">VMware vSphere</a> 环境上构建虚拟机镜像的方案，以及如何在这个虚拟机中运行一个 k3s 集群，然后通过 <a href="https://github.com/argoproj/argo-workflows">argo-workflow</a> 工作流引擎运行 <a href="https://github.com/muzi502/redfish-esxi-os-installer">redfish-esxi-os-installer</a> 来对裸金属服务器进行自动化安装 ESXi OS 的操作。</p><h2 id="劝退三连-😂"><a href="#劝退三连-😂" class="headerlink" title="劝退三连 😂"></a>劝退三连 😂</h2><ul><li>提前下载好 Base OS 的 ISO 镜像，比如 <a href="https://mirrors.tuna.tsinghua.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso">CentOS-7-x86_64-Minimal-2009.iso</a></li><li>需要一个 <a href="https://www.vmware.com/products/vcenter-server.html">vCenter Server</a> 以及一台 <a href="https://www.vmware.com/products/esxi-and-esx.html">VMware ESXi</a> 主机</li><li>ESXi 的 VM Network 网络中需要有一台 DHCP 服务器用于给 VM 分配 IP</li></ul><h2 id="Packer"><a href="#Packer" class="headerlink" title="Packer"></a>Packer</h2><p>很早之前玩儿 VMware ESXi 的时候还没有接触到 Packer，那时候只能使用<a href="https://blog.k8s.li/esxi-vmbase.html">手搓虚拟机模版</a>的方式，费时费力还容易出错，下面就介绍一下这个自动化构建虚拟机镜像的工具。</p><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><a href="https://github.com/hashicorp/packer">Packer</a> 是 <a href="https://www.hashicorp.com/">hashicorp</a> 公司开源的一个虚拟机镜像构建工具，与它类似的工具还有 <a href="https://github.com/openstack/diskimage-builder">OpenStack diskimage-builder</a>、<a href="https://aws.amazon.com/image-builder/">AWS EC2 Image Builder</a> ，但是这两个只支持自家的平台。Packer 能够支持主流的公有云、私有云以及混合云，比它俩高到不知道哪里去了。可以这么来理解：Packer 在 IaaS 虚拟化领域的地位就像 Docker 在 PaaS 容器虚拟中那样重要，一个是虚拟机镜像的构建，另一个容器镜像的构建，有趣的是两者都是在 2013 年成立的项目。</p><p>Kubernetes 社区的 <a href="https://github.com/kubernetes-sigs/image-builder">image-builder</a> 项目就是使用 Packer 构建一些公有云及私有云的虚拟机模版提供给 <a href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> 项目使用，十分推荐大家去看下这个项目的代码，刚开始我也是从这个项目熟悉 Packer 的，并从中抄袭借鉴了很多内容 😅。</p><p>下面就介绍一下 Packer 的基本使用方法</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>对于 Linux 发行版，建议直接下载二进制安装包来安装，通过包管理器安装感觉有点麻烦</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">wget</span> https://releases.hashicorp.com/packer/1.8.0/packer_1.8.0_linux_amd64.zip$ <span class="token function">unzip</span> packer_1.8.0_linux_amd64.zip$ <span class="token function">mv</span> packer /usr/local/bin/packer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>如果是 macOS 用户直接 <code>brew install packer</code> 命令一把梭就能安装好</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>不同于 Docker 有一个 Dockerfile 文件来定义如何构建容器镜像，Packer 构建虚拟机镜像则是由一系列的配置文件缝合而成，主要由 <a href="https://www.packer.io/docs/terminology#builders">Builders</a> 、<a href="https://www.packer.io/docs/terminology#provisioners">Provisioners</a> 、<a href="https://www.packer.io/docs/terminology#post-processors">Post-processors</a> 这三部分组成。其中 Builder 主要是与 IaaS Provider 构建器相关的一些参数；Provisioner 用来配置构建过程中需要运行的一些任务；Post-processors 用于配置构建动作完成后的一些后处理操作；下面就依次介绍一下这几个配置的详细使用说明：</p><p>另外 Packer 推荐的配置语法是 <a href="https://www.packer.io/guides/hcl">HCL2</a>，但个人觉着 HCL 的语法风格怪怪的，不如 json 那样整洁好看 😅，因此下面我统一使用 json 来进行配置，其实参数都一样，只是格式不相同而已。</p><h4 id="vars-x2F-var-file"><a href="#vars-x2F-var-file" class="headerlink" title="vars&#x2F;var-file"></a>vars&#x2F;var-file</h4><p>Packer 的变量配置文件有点类似于 Ansible 中的 vars。一个比较合理的方式就是按照每个参数的作用域进行分类整理，将它们统一放在一个单独的配置文件中，这样维护起来会更方便一些。参考了 image-builder 项目中的 <a href="https://github.com/kubernetes-sigs/image-builder/tree/master/images/capi/packer/ova">ova</a> 构建后我根据参数的不同作用划分成了如下几个配置文件：</p><ul><li><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/vcenter.json">vcenter.json</a>：主要用于配置一些与 vCenter 相关的参数，比如 datastore、datacenter、resource_pool、vcenter_server 等；另外像 vcenter 的用户名和密码建议使用环境变量的方式，避免明文编码在文件当中；</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"folder"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>  <span class="token property">"resource_pool"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>  <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>  <span class="token property">"datacenter"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>  <span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>  <span class="token property">"convert_to_template"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>  <span class="token property">"create_snapshot"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>  <span class="token property">"linked_clone"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>  <span class="token property">"network"</span><span class="token operator">:</span> <span class="token string">"VM Network"</span><span class="token punctuation">,</span>  <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"password"</span><span class="token punctuation">,</span>  <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"administrator@vsphere.local"</span><span class="token punctuation">,</span>  <span class="token property">"vcenter_server"</span><span class="token operator">:</span> <span class="token string">"vcenter.k8s.li"</span><span class="token punctuation">,</span>  <span class="token property">"insecure_connection"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/centos7.json">centos7.json</a>：主要用于配置一些通过 ISO 安装 CentOS 的参数，比如 ISO 的下载地址、ISO 的 checksum、kickstart 文件路径、关机命令、isolinux 启动参数等；</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"boot_command_prefix"</span><span class="token operator">:</span> <span class="token string">"&lt;tab> text ks=hd:fd0:"</span><span class="token punctuation">,</span>  <span class="token property">"boot_command_suffix"</span><span class="token operator">:</span> <span class="token string">"/7/ks.cfg&lt;enter>&lt;wait>"</span><span class="token punctuation">,</span>  <span class="token property">"boot_media_path"</span><span class="token operator">:</span> <span class="token string">"/HTTP"</span><span class="token punctuation">,</span>  <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"centos-7"</span><span class="token punctuation">,</span>  <span class="token property">"distro_arch"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>  <span class="token property">"distro_name"</span><span class="token operator">:</span> <span class="token string">"centos"</span><span class="token punctuation">,</span>  <span class="token property">"distro_version"</span><span class="token operator">:</span> <span class="token string">"7"</span><span class="token punctuation">,</span>  <span class="token property">"floppy_dirs"</span><span class="token operator">:</span> <span class="token string">"./kickstart/&#123;&#123;user `distro_name`&#125;&#125;/http/"</span><span class="token punctuation">,</span>  <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"centos7-64"</span><span class="token punctuation">,</span>  <span class="token property">"iso_checksum"</span><span class="token operator">:</span> <span class="token string">"07b94e6b1a0b0260b94c83d6bb76b26bf7a310dc78d7a9c7432809fb9bc6194a"</span><span class="token punctuation">,</span>  <span class="token property">"iso_checksum_type"</span><span class="token operator">:</span> <span class="token string">"sha256"</span><span class="token punctuation">,</span>  <span class="token property">"iso_url"</span><span class="token operator">:</span> <span class="token string">"https://mirrors.edge.kernel.org/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso"</span><span class="token punctuation">,</span>  <span class="token property">"os_display_name"</span><span class="token operator">:</span> <span class="token string">"CentOS 7"</span><span class="token punctuation">,</span>  <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"shutdown -h now"</span><span class="token punctuation">,</span>  <span class="token property">"vsphere_guest_os_type"</span><span class="token operator">:</span> <span class="token string">"centos7_64Guest"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/photon3.json">photon3.json</a>：主要用于配置一些通过 ISO 安装 Photon3 OS 的参数，和上面的 centos7.json 作用基本一致；</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"boot_command_prefix"</span><span class="token operator">:</span> <span class="token string">"&lt;esc>&lt;wait> vmlinuz initrd=initrd.img root/dev/ram0 loglevel=3 photon.media=cdrom ks="</span><span class="token punctuation">,</span>  <span class="token property">"boot_command_suffix"</span><span class="token operator">:</span> <span class="token string">"/3/ks.json&lt;enter>&lt;wait>"</span><span class="token punctuation">,</span>  <span class="token property">"boot_media_path"</span><span class="token operator">:</span> <span class="token string">"http://&#123;&#123; .HTTPIP &#125;&#125;:&#123;&#123; .HTTPPort &#125;&#125;"</span><span class="token punctuation">,</span>  <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"photon-3"</span><span class="token punctuation">,</span>  <span class="token property">"distro_arch"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>  <span class="token property">"distro_name"</span><span class="token operator">:</span> <span class="token string">"photon"</span><span class="token punctuation">,</span>  <span class="token property">"distro_version"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>  <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"vmware-photon-64"</span><span class="token punctuation">,</span>  <span class="token property">"http_directory"</span><span class="token operator">:</span> <span class="token string">"./kickstart/&#123;&#123;user `distro_name`&#125;&#125;/http/"</span><span class="token punctuation">,</span>  <span class="token property">"iso_checksum"</span><span class="token operator">:</span> <span class="token string">"c2883a42e402a2330d9c39b4d1e071cf9b3b5898"</span><span class="token punctuation">,</span>  <span class="token property">"iso_checksum_type"</span><span class="token operator">:</span> <span class="token string">"sha1"</span><span class="token punctuation">,</span>  <span class="token property">"iso_url"</span><span class="token operator">:</span> <span class="token string">"https://packages.vmware.com/photon/3.0/Rev3/iso/photon-minimal-3.0-a383732.iso"</span><span class="token punctuation">,</span>  <span class="token property">"os_display_name"</span><span class="token operator">:</span> <span class="token string">"VMware Photon OS 64-bit"</span><span class="token punctuation">,</span>  <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"shutdown now"</span><span class="token punctuation">,</span>  <span class="token property">"vsphere_guest_os_type"</span><span class="token operator">:</span> <span class="token string">"vmwarePhoton64Guest"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/common.json">common.json</a>：一些公共参数，比如虚拟机的 ssh 用户名和密码（要和 kickstart 中设置的保持一致）、虚拟机的一些硬件配置如 CPU、内存、硬盘、虚拟机版本、网卡类型、存储控制器类型等；</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"ssh_username"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>  <span class="token property">"ssh_password"</span><span class="token operator">:</span> <span class="token string">"password"</span><span class="token punctuation">,</span>  <span class="token property">"boot_wait"</span><span class="token operator">:</span> <span class="token string">"15s"</span><span class="token punctuation">,</span>  <span class="token property">"disk_controller_type"</span><span class="token operator">:</span> <span class="token string">"lsilogic"</span><span class="token punctuation">,</span>  <span class="token property">"disk_thin_provisioned"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>  <span class="token property">"disk_type_id"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>  <span class="token property">"firmware"</span><span class="token operator">:</span> <span class="token string">"bios"</span><span class="token punctuation">,</span>  <span class="token property">"cpu"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>  <span class="token property">"cpu_cores"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>  <span class="token property">"memory"</span><span class="token operator">:</span> <span class="token string">"4096"</span><span class="token punctuation">,</span>  <span class="token property">"disk_size"</span><span class="token operator">:</span> <span class="token string">"65536"</span><span class="token punctuation">,</span>  <span class="token property">"network_card"</span><span class="token operator">:</span> <span class="token string">"e1000"</span><span class="token punctuation">,</span>  <span class="token property">"ssh_timeout"</span><span class="token operator">:</span> <span class="token string">"3m"</span><span class="token punctuation">,</span>  <span class="token property">"vmx_version"</span><span class="token operator">:</span> <span class="token string">"14"</span><span class="token punctuation">,</span>  <span class="token property">"base_build_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `template`&#125;&#125;"</span><span class="token punctuation">,</span>  <span class="token property">"build_timestamp"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;timestamp&#125;&#125;"</span><span class="token punctuation">,</span>  <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"k3s"</span><span class="token punctuation">,</span>  <span class="token property">"build_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ova_name`&#125;&#125;"</span><span class="token punctuation">,</span>  <span class="token property">"export_manifest"</span><span class="token operator">:</span> <span class="token string">"none"</span><span class="token punctuation">,</span>  <span class="token property">"output_dir"</span><span class="token operator">:</span> <span class="token string">"./output/&#123;&#123;user `build_version`&#125;&#125;"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Builder"><a href="#Builder" class="headerlink" title="Builder"></a>Builder</h4><p>Builder 就是告诉 Packer 要使用什么类型的构建器构建什么样的虚拟机镜像，主要是与底层 IaaS 资源提供商相关的配置。比如 <a href="https://www.packer.io/plugins/builders/vsphere">vSphere Builder</a> 中有如下两种构建器：</p><ul><li><a href="https://www.packer.io/docs/builders/vsphere/vsphere-iso">vsphere-iso</a> 从 ISO 安装 OS 开始构建，通常情况下构建为一个虚拟机或虚拟机模版</li><li><a href="https://www.packer.io/docs/builders/vsphere/vsphere-clone">vsphere-clone</a> 通过 clone 虚拟机的方式进行构建，通常情况下构建产物为导出后的 OVF&#x2F;OVA 文件</li></ul><p>不同类型的 Builder 配置参数也会有所不同，每个参数的详细用途和说明可以参考 <a href="https://www.packer.io/plugins">Packer 官方的文档</a>，在这里就不一一说明了。因为 Packer 的参数配置是在是太多太复杂了，很难三言两语讲清楚。最佳的方式就是阅读官方的文档和一些其他项目的实现方式，照葫芦画瓢学就行。</p><p><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/builder.json">builders.json</a>：里面的配置参数大多都是引用的 var-file 中的参数，将这些参数单独抽出来的好处就是不同的 builder 之间可以复用一些公共参数。比如 vsphere-iso 和 vsphere-clone 这两种不同的 builder 与 vCenter 相关的 datacenter、datastore、vcenter_server 等参数都是其实相同的。</p><ul><li><a href="https://www.packer.io/docs/builders/vsphere/vsphere-iso">vsphere-iso</a> ：通过 ISO 安装 OS 构建一个虚拟机或虚拟机模版</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"builders"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"CPUs"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"RAM"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `memory`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"boot_command"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"&#123;&#123;user `boot_command_prefix`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token string">"&#123;&#123;user `boot_media_path`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token string">"&#123;&#123;user `boot_command_suffix`&#125;&#125;"</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"boot_wait"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `boot_wait`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cluster`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"communicator"</span><span class="token operator">:</span> <span class="token string">"ssh"</span><span class="token punctuation">,</span>      <span class="token property">"convert_to_template"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `convert_to_template`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"cpu_cores"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu_cores`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"create_snapshot"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `create_snapshot`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"datacenter"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datacenter`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datastore`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"disk_controller_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_controller_type`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"firmware"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `firmware`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"floppy_dirs"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `floppy_dirs`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"folder"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `folder`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vsphere_guest_os_type`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `host`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"http_directory"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `http_directory`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"insecure_connection"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `insecure_connection`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"iso_checksum"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `iso_checksum_type`&#125;&#125;:&#123;&#123;user `iso_checksum`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"iso_urls"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `iso_url`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"vsphere-iso-base"</span><span class="token punctuation">,</span>      <span class="token property">"network_adapters"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>          <span class="token property">"network"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `network`&#125;&#125;"</span><span class="token punctuation">,</span>          <span class="token property">"network_card"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `network_card`&#125;&#125;"</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `password`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"echo '&#123;&#123;user `ssh_password`&#125;&#125;' | sudo -S -E sh -c '&#123;&#123;user `shutdown_command`&#125;&#125;'"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_clear_authorized_keys"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_password`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_timeout"</span><span class="token operator">:</span> <span class="token string">"4h"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_username`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"storage"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>          <span class="token property">"disk_size"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_size`&#125;&#125;"</span><span class="token punctuation">,</span>          <span class="token property">"disk_thin_provisioned"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_thin_provisioned`&#125;&#125;"</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"vsphere-iso"</span><span class="token punctuation">,</span>      <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `username`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"vcenter_server"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vcenter_server`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"vm_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `base_build_version`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"vm_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vmx_version`&#125;&#125;"</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="https://www.packer.io/docs/builders/vsphere/vsphere-clone">vsphere-clone</a>：通过 clone 虚拟机构建一个虚拟机，并导出虚拟机 OVF 模版</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"builders"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"CPUs"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"RAM"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `memory`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cluster`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"communicator"</span><span class="token operator">:</span> <span class="token string">"ssh"</span><span class="token punctuation">,</span>      <span class="token property">"convert_to_template"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `convert_to_template`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"cpu_cores"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu_cores`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"create_snapshot"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `create_snapshot`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"datacenter"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datacenter`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datastore`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"export"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"force"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token property">"manifest"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `export_manifest`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"output_directory"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `output_dir`&#125;&#125;"</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token property">"folder"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `folder`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `host`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"insecure_connection"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `insecure_connection`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"linked_clone"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `linked_clone`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"vsphere-clone"</span><span class="token punctuation">,</span>      <span class="token property">"network"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `network`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `password`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"echo '&#123;&#123;user `ssh_password`&#125;&#125;' | sudo -S -E sh -c '&#123;&#123;user `shutdown_command`&#125;&#125;'"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_password`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_timeout"</span><span class="token operator">:</span> <span class="token string">"4h"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_username`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"template"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `template`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"vsphere-clone"</span><span class="token punctuation">,</span>      <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `username`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"vcenter_server"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vcenter_server`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"vm_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `build_version`&#125;&#125;"</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Provisioner"><a href="#Provisioner" class="headerlink" title="Provisioner"></a><a href="https://www.packer.io/docs/provisioners">Provisioner</a></h4><p>Provisioner 就是告诉 Packer 要如何构建镜像，有点类似于 Dockerile 中的 RUN&#x2F;COPY&#x2F;ADD 等指令，用于执行一些命令&#x2F;脚本、往虚拟机里添加一些文件、调用第三方插件执行一些操作等。</p><p>在这个配置文件中我先使用 file 模块将一些脚本和依赖文件上传到虚拟机中，然后使用 shell 模块在虚拟机中执行 install.sh 安装脚本。如果构建的 builder 比较多，比如需要支持多个 Linux 发行版，这种场景建议使用 Ansible。由于我在 ISO 安装 OS 的构建流程中已经将一些与 OS 发行版相关的操作完成了，在这里使用 shell 执行的操作不需要区分哪个 Linux 发行版，所以就没有使用 ansible。</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"provisioners"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>      <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"scripts"</span><span class="token punctuation">,</span>      <span class="token property">"destination"</span><span class="token operator">:</span> <span class="token string">"/root"</span><span class="token punctuation">,</span>      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"vsphere-iso-base"</span>      <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>      <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"resources"</span><span class="token punctuation">,</span>      <span class="token property">"destination"</span><span class="token operator">:</span> <span class="token string">"/root"</span><span class="token punctuation">,</span>      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"vsphere-iso-base"</span>      <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"shell"</span><span class="token punctuation">,</span>      <span class="token property">"environment_vars"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"INSECURE_REGISTRY=&#123;&#123;user `insecure_registry`&#125;&#125;"</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"inline"</span><span class="token operator">:</span> <span class="token string">"bash /root/scripts/install.sh"</span><span class="token punctuation">,</span>      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"vsphere-iso-base"</span>      <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="post-processors"><a href="#post-processors" class="headerlink" title="post-processors"></a>post-processors</h3><p>一些构建后的操作， 比如 <code>&quot;type&quot;: &quot;manifest&quot;</code> 可以导出一些构建过程中的配置参数，给后续的其他操作来使用。再比如 <code>&quot;type&quot;: &quot;shell-local&quot;</code> 就是执行一些 shell 脚本，在这里就是执行一个 Python 脚本将 OVF 转换成 OVA。</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"post-processors"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"custom_data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"release_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `release_version`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"build_date"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;isotime&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `build_name`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"build_timestamp"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `build_timestamp`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"build_type"</span><span class="token operator">:</span> <span class="token string">"node"</span><span class="token punctuation">,</span>        <span class="token property">"cpu"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"memory"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `memory`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"disk_size"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_size`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"distro_arch"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `distro_arch` &#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"distro_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `distro_name` &#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"distro_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `distro_version` &#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"firmware"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `firmware`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `guest_os_type`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"os_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `os_display_name`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"vsphere_guest_os_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vsphere_guest_os_type`&#125;&#125;"</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"packer-manifest"</span><span class="token punctuation">,</span>      <span class="token property">"output"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `output_dir`&#125;&#125;/packer-manifest.json"</span><span class="token punctuation">,</span>      <span class="token property">"strip_path"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"manifest"</span><span class="token punctuation">,</span>      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"vsphere-iso-base"</span>      <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"inline"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"python3 ./scripts/ova.py --vmx &#123;&#123;user `vmx_version`&#125;&#125; --ovf_template &#123;&#123;user `ovf_template`&#125;&#125; --build_dir=&#123;&#123;user `output_dir`&#125;&#125;"</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"vsphere-iso-base"</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"vsphere"</span><span class="token punctuation">,</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"shell-local"</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h3><p><a href="https://github.com/muzi502/packer-vsphere-example">packer-vsphere-example</a> 项目的目录结构如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>/packer-vsphere-example├── kickstart        <span class="token comment"># kickstart 配置文件存放目录</span>├── Makefile         <span class="token comment"># makefile，make 命令的操作的入口</span>├── packer           <span class="token comment"># packer 配置文件</span>│   ├── builder.json <span class="token comment"># packer builder 配置文件</span>│   ├── centos7.json <span class="token comment"># centos iso 安装 os 的配置</span>│   ├── common.json  <span class="token comment"># 一些公共配置参数</span>│   ├── photon3.json <span class="token comment"># photon3 iso 安装 os 的配置</span>│   └── vcenter.json <span class="token comment"># vcenter 相关的配置</span>├── resources        <span class="token comment"># 一些 k8s manifests 文件</span>└── scripts          <span class="token comment"># 构建过程中需要用到的脚本文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>与 docker 类似，packer 执行构建操作的子命令同样也是 build，即 <code>packer build</code>，不过 packer build 命令支持的选项并没有 docker 那么丰富。最核心选项就是 -except, -only, -var,  -var-file 这几个：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ packer buildOptions:<span class="token comment"># 控制终端颜色输出</span>  <span class="token parameter variable">-color</span><span class="token operator">=</span>false                  Disable color output. <span class="token punctuation">(</span>Default: color<span class="token punctuation">)</span>  <span class="token comment"># debug 模式，类似于断点的方式运行</span>  <span class="token parameter variable">-debug</span>                        Debug mode enabled <span class="token keyword">for</span> builds.  <span class="token comment"># 排除一些 builder，有点类似于 ansible 的 --skip-tags</span>  <span class="token parameter variable">-except</span><span class="token operator">=</span>foo,bar,baz           Run all builds and post-processors other than these.  <span class="token comment"># 指定运行某些 builder，有点类似于 ansible 的 --tags</span>  <span class="token parameter variable">-only</span><span class="token operator">=</span>foo,bar,baz             Build only the specified builds.  <span class="token comment"># 强制构建，如果构建目标已经存在则强制删除重新构建</span>  <span class="token parameter variable">-force</span>                        Force a build to <span class="token builtin class-name">continue</span> <span class="token keyword">if</span> artifacts exist, deletes existing artifacts.  -machine-readable             Produce machine-readable output.  <span class="token comment"># 出现错误之后的动作，cleanup 清理所有操作、abort 中断执行、ask 询问、</span>  -on-error<span class="token operator">=</span><span class="token punctuation">[</span>cleanup<span class="token operator">|</span>abort<span class="token operator">|</span>ask<span class="token operator">|</span>run-cleanup-provisioner<span class="token punctuation">]</span> If the build fails do: clean up <span class="token punctuation">(</span>default<span class="token punctuation">)</span>, abort, ask, or run-cleanup-provisioner.  <span class="token comment"># 并行运行的 builder 数量，默认没有限制，有点类似于 ansible 中的 --forks 参数</span>  -parallel-builds<span class="token operator">=</span><span class="token number">1</span>            Number of builds to run <span class="token keyword">in</span> parallel. <span class="token number">1</span> disables parallelization. <span class="token number">0</span> means no limit <span class="token punctuation">(</span>Default: <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># UI 输出的时间戳</span>  -timestamp-ui                 Enable prefixing of each ui output with an RFC3339 timestamp.  <span class="token comment"># 变量参数，有点类似于 ansible 的 -e 选项</span>  <span class="token parameter variable">-var</span> <span class="token string">'key=value'</span>              Variable <span class="token keyword">for</span> templates, can be used multiple times.  <span class="token comment"># 变量文件，有点类似于 ansible 的 -e@ 选项</span>  -var-file<span class="token operator">=</span>path                JSON or HCL2 <span class="token function">file</span> containing user variables.<span class="token comment"># 指定一些 var 参数以及 var-file 文件，最后一个参数是 builder 的配置文件路径</span>$ packer build  <span class="token parameter variable">--var</span> <span class="token assign-left variable">ova_name</span><span class="token operator">=</span>k3s-photon3-c4ca93f <span class="token parameter variable">--var</span> <span class="token assign-left variable">release_version</span><span class="token operator">=</span>c4ca93f <span class="token parameter variable">--var</span> <span class="token assign-left variable">ovf_template</span><span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/scripts/ovf_template.xml <span class="token parameter variable">--var</span> <span class="token assign-left variable">template</span><span class="token operator">=</span>base-os-photon3 <span class="token parameter variable">--var</span> <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token variable">$&#123;VCENTER_USERNAME&#125;</span> <span class="token parameter variable">--var</span> <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token variable">$&#123;VCENTER_PASSWORD&#125;</span> <span class="token parameter variable">--var</span> <span class="token assign-left variable">vcenter_server</span><span class="token operator">=</span><span class="token variable">$&#123;VCENTER_SERVER&#125;</span> <span class="token parameter variable">--var</span> <span class="token assign-left variable">build_name</span><span class="token operator">=</span>k3s-photon3 <span class="token parameter variable">--var</span> <span class="token assign-left variable">output_dir</span><span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/output/k3s-photon3-c4ca93f <span class="token parameter variable">-only</span> vsphere-clone -var-file<span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/vcenter.json -var-file<span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/photon3.json -var-file<span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/common.json /root/usr/src/github.com/muzi502/packer-vsphere-example/packer/builder.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面那个又长又臭的 packer build 命令我们在 <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/Makefile">Makefile</a> 里封装一下，那么多的参数选项手动输起来能把人气疯 😂</p><ul><li>首先定义一些默认的参数，比如构建版本、构建时间、base 模版名称、导出 ova 文件名称等等。</li></ul><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># Ensure Make is run with bash shell as some syntax below is bash-specific</span>SHELL<span class="token operator">:=</span>/usr/bin/env bash.DEFAULT_GOAL<span class="token operator">:=</span>help<span class="token comment"># Full directory of where the Makefile resides</span>ROOT_DIR <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> dirname <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">realpath</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">firstword</span> <span class="token variable">$</span><span class="token punctuation">(</span>MAKEFILE_LIST<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>RELEASE_VERSION       <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> git describe --tags --always --dirty<span class="token punctuation">)</span>RELEASE_TIME          <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> date -u +<span class="token string">'%Y-%m-%dT%H:%M:%SZ'</span><span class="token punctuation">)</span>PACKER_IMAGE          <span class="token operator">?=</span> hashicorp/packer<span class="token punctuation">:</span>1.8PACKER_CONFIG_DIR     <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/packerPACKER_FORCE          <span class="token operator">?=</span> falsePACKER_OVA_PREFIX     <span class="token operator">?=</span> k3sPACKER_BASE_OS        <span class="token operator">?=</span> centos7PACKER_OUTPUT_DIR     <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/outputPACKER_TEMPLATE_NAME  <span class="token operator">?=</span> base-os-<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span>OVF_TEMPLATE          <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/scripts/ovf_template.xmlPACKER_OVA_NAME       <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_PREFIX<span class="token punctuation">)</span>-<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span>-<span class="token variable">$</span><span class="token punctuation">(</span>RELEASE_VERSION<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>然后定义 vars 和 var-file 参数</li></ul><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># 是否为强制构建，增加 force 参数</span><span class="token keyword">ifeq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_FORCE<span class="token punctuation">)</span>, true<span class="token punctuation">)</span>  PACKER_FORCE_ARG <span class="token operator">=</span> --force<span class="token operator">=</span>true<span class="token keyword">endif</span><span class="token comment"># 定义 vars 可变参数，比如 vcenter 用户名、密码 等参数</span>PACKER_VARS <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_FORCE_ARG<span class="token punctuation">)</span> \            <span class="token comment"># 是否强制构建</span>--var ova_name<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_NAME<span class="token punctuation">)</span> \          <span class="token comment"># OVA 文件名</span>--var release_version<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>RELEASE_VERSION<span class="token punctuation">)</span> \   <span class="token comment"># 发布版本</span>--var ovf_template<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>OVF_TEMPLATE<span class="token punctuation">)</span> \         <span class="token comment"># OVF 模版文件</span>--var template<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_TEMPLATE_NAME<span class="token punctuation">)</span> \     <span class="token comment"># OVA 的 base 虚拟机模版名称</span>--var username<span class="token operator">=</span><span class="token variable">$$</span><span class="token punctuation">&#123;</span>VCENTER_USERNAME<span class="token punctuation">&#125;</span> \        <span class="token comment"># vCenter 用户名（环境变量）</span>--var password<span class="token operator">=</span><span class="token variable">$$</span><span class="token punctuation">&#123;</span>VCENTER_PASSWORD<span class="token punctuation">&#125;</span> \        <span class="token comment"># vCenter 密码（环境变量）</span>--var vcenter_server<span class="token operator">=</span><span class="token variable">$$</span><span class="token punctuation">&#123;</span>VCENTER_SERVER<span class="token punctuation">&#125;</span> \    <span class="token comment"># vCenter 访问地址（环境变量）</span>--var build_name<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_PREFIX<span class="token punctuation">)</span>-<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span> \  <span class="token comment"># 构建名称</span>--var output_dir<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OUTPUT_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_NAME<span class="token punctuation">)</span>   <span class="token comment"># OVA 导出的目录</span><span class="token comment"># 定义 var-file 参数</span>PACKER_VAR_FILES <span class="token operator">=</span> -var-file<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/vcenter.json \ <span class="token comment"># vCenter 的参数配置</span>-var-file<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span>.json \        <span class="token comment"># OS 的参数配置</span>-var-file<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/common.json                     <span class="token comment"># 一些公共配置</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>最后定义 make targrt</li></ul><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> build-template<span class="token comment"># 通过 ISO 安装 OS 构建一个 base 虚拟机</span><span class="token target symbol">build-template</span><span class="token punctuation">:</span> <span class="token comment">## build the base os template by iso</span>packer build <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VARS<span class="token punctuation">)</span> -only vsphere-iso-base <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VAR_FILES<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/builder.json<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> build-ovf<span class="token comment"># 通过 clone 方式构建并导出 OVF/OVA</span><span class="token target symbol">build-ovf</span><span class="token punctuation">:</span> <span class="token comment">## build the ovf template by clone the base os template</span>packer build <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VARS<span class="token punctuation">)</span> -only vsphere-clone <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VAR_FILES<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/builder.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>构建 BASE 模版</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 通过 PACKER_BASE_OS 参数设置 base os 是 photon3 还是 centos7</span>$ <span class="token function">make</span> build-template <span class="token assign-left variable">PACKER_BASE_OS</span><span class="token operator">=</span>photon3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>构建 OVF 模版并导出为 OVA</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 通过 PACKER_BASE_OS 参数设置 base os 是 photon3 还是 centos7</span>$ <span class="token function">make</span> build-ovf <span class="token assign-left variable">PACKER_BASE_OS</span><span class="token operator">=</span>photon3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="构建流程"><a href="#构建流程" class="headerlink" title="构建流程"></a>构建流程</h2><p>将 Packer 的配置文件以及 Makefile 封装好之后，我们就可以运行 <code>make build-template</code> 和 <code>make build-ovf</code> 命令来构建虚拟机模版了，整体的构建流程如下：</p><ul><li>先使用 ISO 构建一个与业务无关的 base 虚拟机</li><li>在 base 虚拟机之上通过 vsphere-clone 方式构建业务虚拟机</li><li>导出 OVF 虚拟机文件，打包成 OVA 格式的虚拟机模版</li></ul><h3 id="通过-vsphere-iso-构建-Base-虚拟机"><a href="#通过-vsphere-iso-构建-Base-虚拟机" class="headerlink" title="通过 vsphere-iso 构建 Base 虚拟机"></a>通过 vsphere-iso 构建 Base 虚拟机</h3><p>base 虚拟机有点类似于 Dockerfile 中的 FROM base 镜像。在 Packer 中我们可以把一些很少会改动的内容做成一个 base 虚拟机。然后从这个 base 虚拟机克隆出一台新的虚拟机来完成接下来的构建流程，这样能够节省整体的构建耗时，使得构建效率更高一些。</p><ul><li>centos7 构建输出日志</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vsphere-iso-base: output will be <span class="token keyword">in</span> this color.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: File /root/.cache/packer/e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso already uploaded<span class="token punctuation">;</span> continuing<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: File <span class="token punctuation">[</span>Packer<span class="token punctuation">]</span> packer_cache//e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso already exists<span class="token punctuation">;</span> skipping upload.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: the vm/template Packer/base-os-centos7 already exists, but deleting it due to <span class="token parameter variable">-force</span> flag<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating VM<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Customizing hardware<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Mounting ISO images<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding configuration parameters<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating floppy disk<span class="token punctuation">..</span>.    vsphere-iso-base: Copying files flatly from floppy_files    vsphere-iso-base: Done copying files from floppy_files    vsphere-iso-base: Collecting paths from floppy_dirs    vsphere-iso-base: Resulting paths from floppy_dirs <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>./kickstart/centos/http/<span class="token punctuation">]</span>    vsphere-iso-base: Recursively copying <span class="token builtin class-name">:</span> ./kickstart/centos/http/    vsphere-iso-base: Done copying paths from floppy_dirs    vsphere-iso-base: Copying files from floppy_content    vsphere-iso-base: Done copying files from floppy_content<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Uploading created floppy image<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding generated Floppy<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Set boot order temporary<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Power on VM<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting 15s <span class="token keyword">for</span> boot<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Typing boot command<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting <span class="token keyword">for</span> IP<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: IP address: <span class="token number">192.168</span>.29.46<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Using SSH communicator to connect: <span class="token number">192.168</span>.29.46<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting <span class="token keyword">for</span> SSH to become available<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Connected to SSH<span class="token operator">!</span><span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Executing <span class="token function">shutdown</span> command<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Deleting Floppy drives<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Deleting Floppy image<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Eject CD-ROM drives<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating snapshot<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Clear boot order<span class="token punctuation">..</span>.Build <span class="token string">'vsphere-iso-base'</span> finished after <span class="token number">6</span> minutes <span class="token number">42</span> seconds.<span class="token operator">==</span><span class="token operator">></span> Wait completed after <span class="token number">6</span> minutes <span class="token number">42</span> seconds<span class="token operator">==</span><span class="token operator">></span> Builds finished. The artifacts of successful builds are:--<span class="token operator">></span> vsphere-iso-base: base-os-centos7<span class="token punctuation">[</span>root@localhost:/vmfs/volumes/622aec5b-de94a27c-948e-00505680fb1d<span class="token punctuation">]</span> <span class="token function">ls</span> packer_cache/51511394170e64707b662ca8db012be4d23e121f.iso  d3e175624fc2d704975ce9a149f8f270e4768727.iso  e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso<span class="token punctuation">[</span>root@localhost:/vmfs/volumes/622aec5b-de94a27c-948e-00505680fb1d<span class="token punctuation">]</span> <span class="token function">ls</span> <span class="token parameter variable">-alh</span> base-os-centos7/total <span class="token number">4281536</span>drwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">72</span>.0K Apr  <span class="token number">1</span> 09:17 <span class="token builtin class-name">.</span>drwxr-xr-t    <span class="token number">1</span> root     root       <span class="token number">76</span>.0K Apr  <span class="token number">1</span> 09:17 <span class="token punctuation">..</span>-rw-------    <span class="token number">1</span> root     root        <span class="token number">4</span>.0G Apr  <span class="token number">1</span> 09:17 base-os-centos7-3ea6b205.vswp-rw-r--r--    <span class="token number">1</span> root     root         <span class="token number">253</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7-65ff34a3.hlog-rw-------    <span class="token number">1</span> root     root       <span class="token number">64</span>.0G Apr  <span class="token number">1</span> 09:17 base-os-centos7-flat.vmdk-rw-------    <span class="token number">1</span> root     root        <span class="token number">8</span>.5K Apr  <span class="token number">1</span> 09:17 base-os-centos7.nvram-rw-------    <span class="token number">1</span> root     root         <span class="token number">482</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmdk-rw-r--r--    <span class="token number">1</span> root     root           <span class="token number">0</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmsd-rwxr-xr-x    <span class="token number">1</span> root     root        <span class="token number">2</span>.3K Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmx-rw-------    <span class="token number">1</span> root     root           <span class="token number">0</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmx.lck-rwxr-xr-x    <span class="token number">1</span> root     root        <span class="token number">2</span>.2K Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmx~-rw-------    <span class="token number">1</span> root     root        <span class="token number">1</span>.4M Apr  <span class="token number">1</span> 09:17 packer-tmp-created-floppy.flp-rw-r--r--    <span class="token number">1</span> root     root       <span class="token number">96</span>.1K Apr  <span class="token number">1</span> 09:17 vmware.logroot@devbox-fedora:/root <span class="token comment"># scp 192.168.24.43:/vmfs/volumes/Packer/base-os-centos7/packer-tmp-created-floppy.flp .</span>root@devbox-fedora:/root <span class="token comment"># mount packer-tmp-created-floppy.flp /mnt</span>root@devbox-fedora:/root <span class="token comment"># readlink /dev/disk/by-label/packer</span><span class="token punctuation">..</span>/<span class="token punctuation">..</span>/loop2root@devbox-fedora:/root <span class="token comment"># ls /mnt/HTTP/7/KS.CFG</span>KS.CFG<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Photon3 构建输出日志</li></ul><pre class="line-numbers language-none"><code class="language-none">vsphere-iso-base: output will be in this color.&#x3D;&#x3D;&gt; vsphere-iso-base: File &#x2F;root&#x2F;.cache&#x2F;packer&#x2F;d3e175624fc2d704975ce9a149f8f270e4768727.iso already uploaded; continuing&#x3D;&#x3D;&gt; vsphere-iso-base: File [Packer] packer_cache&#x2F;&#x2F;d3e175624fc2d704975ce9a149f8f270e4768727.iso already exists; skipping upload.&#x3D;&#x3D;&gt; vsphere-iso-base: the vm&#x2F;template Packer&#x2F;base-os-photon3 already exists, but deleting it due to -force flag&#x3D;&#x3D;&gt; vsphere-iso-base: Creating VM...&#x3D;&#x3D;&gt; vsphere-iso-base: Customizing hardware...&#x3D;&#x3D;&gt; vsphere-iso-base: Mounting ISO images...&#x3D;&#x3D;&gt; vsphere-iso-base: Adding configuration parameters...&#x3D;&#x3D;&gt; vsphere-iso-base: Starting HTTP server on port 8674&#x3D;&#x3D;&gt; vsphere-iso-base: Set boot order temporary...&#x3D;&#x3D;&gt; vsphere-iso-base: Power on VM...&#x3D;&#x3D;&gt; vsphere-iso-base: Waiting 15s for boot...&#x3D;&#x3D;&gt; vsphere-iso-base: HTTP server is working at http:&#x2F;&#x2F;192.168.29.171:8674&#x2F;&#x3D;&#x3D;&gt; vsphere-iso-base: Typing boot command...&#x3D;&#x3D;&gt; vsphere-iso-base: Waiting for IP...&#x3D;&#x3D;&gt; vsphere-iso-base: IP address: 192.168.29.208&#x3D;&#x3D;&gt; vsphere-iso-base: Using SSH communicator to connect: 192.168.29.208&#x3D;&#x3D;&gt; vsphere-iso-base: Waiting for SSH to become available...&#x3D;&#x3D;&gt; vsphere-iso-base: Connected to SSH!&#x3D;&#x3D;&gt; vsphere-iso-base: Executing shutdown command...&#x3D;&#x3D;&gt; vsphere-iso-base: Deleting Floppy drives...&#x3D;&#x3D;&gt; vsphere-iso-base: Eject CD-ROM drives...&#x3D;&#x3D;&gt; vsphere-iso-base: Creating snapshot...&#x3D;&#x3D;&gt; vsphere-iso-base: Clear boot order...Build &#39;vsphere-iso-base&#39; finished after 5 minutes 24 seconds.&#x3D;&#x3D;&gt; Wait completed after 5 minutes 24 seconds&#x3D;&#x3D;&gt; Builds finished. The artifacts of successful builds are:--&gt; vsphere-iso-base: base-os-photon3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过 <code>packer build</code> 命令的输出我们大致可以推断出通过 vsphere-iso 构建 Base 虚拟机的主要步骤和原理：</p><ul><li>下载 ISO 文件到本地的 ${HOME}&#x2F;.cache&#x2F;packer 目录，并以 checksum.iso 方式保存，这样的好处就是便于缓存 ISO 文件，避免重复下载；</li><li>上传本地 ISO 文件到 vCenter 的 datastore 中，默认保存在 datastore 的 packer_cache 目录下，如果 ISO 文件已经存在了，则会跳过上传的流程；</li><li>创建虚拟机，配置虚拟机硬件，挂载上传的 ISO 文件到虚拟机上的 CD&#x2F;ROM，设置 boot 启动项为 CD&#x2F;ROM</li><li>如果 <a href="https://www.packer.io/plugins/builders/vsphere/vsphere-iso#boot-configuration">boot_media_path</a> 是 http 类型的则在本地随机监听一个 TCP 端口来运行一个 http 服务，用于提供 kickstart 文件的 HTTP 下载功能；如果是目录类型的则将 kickstart 文件创建成一个软盘文件，并将该文件上传到 datastore 中，将软盘文件插入到虚拟机中；</li><li>虚拟机开机启动到 ISO 引导页面，通过 vCenter API 发送键盘输入，插入 kickstart 文件的路径；</li><li>通过 vCenter API 发送回车键盘输入，ISO 中的 OS 安装程序读取 kickstart 进行 OS 安装；</li><li>在 kickstart 脚本里安装 <a href="https://github.com/vmware/open-vm-tools">open-vm-tools</a> 工具；</li><li>等待 OS 安装完成，安装完成重启后进入安装好的 OS，OS 启动后通过 DHCP 获取 IP 地址；</li><li>通过 vm-tools 获取到虚拟机的 IP 地址，然后 ssh 连接到虚拟机执行关机命令；</li><li>虚拟机关机，卸载 ISO 和软驱等不需要的设备；</li><li>创建快照或者将虚拟机转换为模版；</li></ul><p>个人觉着这里比较好玩儿就是居然可以通过 vCenter 或 ESXi 的 <a href="https://vdc-repo.vmware.com/vmwb-repository/dcr-public/1ef6c336-7bef-477d-b9bb-caa1767d7e30/82521f49-9d9a-42b7-b19b-9e6cd9b30db1/vim.VirtualMachine.html#putUsbScanCodes">PutUsbScanCodes</a> API 来给虚拟机发送一些键盘输入的指令，感觉这简直太神奇啦 😂。之前我们的项目是将 kickstart 文件构建成一个 ISO 文件，然后通过重新构建源 ISO 的方式来修改 isolinux 启动参数。后来感觉这种重新构建 ISO 的方式太蠢了，于是就参考 Packer 的思路使用 govc 里内置的 <a href="https://github.com/vmware/govmomi/blob/master/govc/vm/keystrokes.go">vm.keystrokes</a> 命令来给虚拟机发送键盘指令，完成指定 kickstart 文件路径参数启动的操作。具体的 govc 操作命令可以参考如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 发送 tab 键，进入到 ISO 启动参数编辑页面</span>$ govc vm.keystrokes <span class="token parameter variable">-vm</span><span class="token operator">=</span><span class="token string">'centos-vm-192'</span> <span class="token parameter variable">-c</span><span class="token operator">=</span><span class="token string">'KEY_TAB'</span><span class="token comment"># 发送 Right Control + U 键清空输入框</span>$ govc vm.keystrokes <span class="token parameter variable">-vm</span><span class="token operator">=</span><span class="token string">'centos-vm-192'</span> <span class="token parameter variable">-rc</span><span class="token operator">=</span>true <span class="token parameter variable">-c</span><span class="token operator">=</span><span class="token string">'KEY_U'</span><span class="token comment"># 输入 isolinux 的启动参数配置，通过 ks=hd:LABEL=KS:/ks.cfg 指定 kickstart 路径，LABEL 为构建 ISO 时设置的 lable</span>$ govc vm.keystrokes <span class="token parameter variable">-vm</span><span class="token operator">=</span><span class="token string">'centos-vm-192'</span> <span class="token parameter variable">-s</span><span class="token operator">=</span><span class="token string">'vmlinuz initrd=initrd.img ks=hd:LABEL=KS:/ks.cfg inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 quiet console=ttyS0'</span><span class="token comment"># 按下回车键，开始安装 OS</span>$ govc vm.keystrokes <span class="token parameter variable">-vm</span><span class="token operator">=</span><span class="token string">'centos-vm-192'</span> <span class="token parameter variable">-c</span><span class="token operator">=</span><span class="token string">'KEY_ENTER'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="通过-vsphere-clone-构建业务虚拟机并导出-OVF-x2F-OVA"><a href="#通过-vsphere-clone-构建业务虚拟机并导出-OVF-x2F-OVA" class="headerlink" title="通过 vsphere-clone 构建业务虚拟机并导出 OVF&#x2F;OVA"></a>通过 vsphere-clone 构建业务虚拟机并导出 OVF&#x2F;OVA</h3><p>通过 vsphere-iso 构建 Base 虚拟机之后，我们就使用这个 base 虚拟机克隆出一台新的虚拟机，用来构建我们的业务虚拟机镜像，将 k3s, argo-workflow, redfish-esxi-os-installer 这一堆工具打包进去；</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vsphere-clone: output will be <span class="token keyword">in</span> this color.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Cloning VM<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Customizing hardware<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Power on VM<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Waiting <span class="token keyword">for</span> IP<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: IP address: <span class="token number">192.168</span>.30.112<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Using SSH communicator to connect: <span class="token number">192.168</span>.30.112<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Waiting <span class="token keyword">for</span> SSH to become available<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Connected to SSH<span class="token operator">!</span><span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Uploading scripts <span class="token operator">=</span><span class="token operator">></span> /root<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Uploading resources <span class="token operator">=</span><span class="token operator">></span> /root<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Provisioning with shell script: /tmp/packer-shell557168976<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Executing <span class="token function">shutdown</span> command<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Creating snapshot<span class="token punctuation">..</span>.    vsphere-clone: Starting export<span class="token punctuation">..</span>.    vsphere-clone: Downloading: k3s-photon3-c4ca93f-disk-0.vmdk    vsphere-clone: Exporting file: k3s-photon3-c4ca93f-disk-0.vmdk    vsphere-clone: Writing ovf<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Running post-processor: packer-manifest <span class="token punctuation">(</span>type manifest<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Running post-processor: vsphere <span class="token punctuation">(</span>type shell-local<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">></span> vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: Running <span class="token builtin class-name">local</span> shell script: /tmp/packer-shell2376077966    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: <span class="token builtin class-name">cd</span> /root/usr/src/github.com/muzi502/packer-vsphere-example/output/k3s-photon3-c4ca93f    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: create ovf k3s-photon3-c4ca93f.ovf    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: create ova manifest k3s-photon3-c4ca93f.mf    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: creating OVA using <span class="token function">tar</span>    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: <span class="token punctuation">[</span><span class="token string">'tar'</span>, <span class="token string">'-c'</span>, <span class="token string">'-f'</span>, <span class="token string">'k3s-photon3-c4ca93f.ova'</span>, <span class="token string">'k3s-photon3-c4ca93f.ovf'</span>, <span class="token string">'k3s-photon3-c4ca93f.mf'</span>, <span class="token string">'k3s-photon3-c4ca93f-disk-0.vmdk'</span><span class="token punctuation">]</span>    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: create ova checksum k3s-photon3-c4ca93f.ova.sha256Build <span class="token string">'vsphere-clone'</span> finished after <span class="token number">14</span> minutes <span class="token number">16</span> seconds.<span class="token operator">==</span><span class="token operator">></span> Wait completed after <span class="token number">14</span> minutes <span class="token number">16</span> seconds<span class="token operator">==</span><span class="token operator">></span> Builds finished. The artifacts of successful builds are:--<span class="token operator">></span> vsphere-clone: k3s-photon3-c4ca93f--<span class="token operator">></span> vsphere-clone: k3s-photon3-c4ca93f--<span class="token operator">></span> vsphere-clone: k3s-photon3-c4ca93f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过 packer build 命令的输出我们大致可以推断出构建流程：</p><ul><li>clone 虚拟机，修改虚拟机的硬件配置</li><li>虚拟机开机，通过 vm-tools 获取虚拟机的 IP 地址</li><li>获取到虚拟机的 IP 地址后等待 ssh 能够正常连接</li><li>ssh 能够正常连接后，通过 scp 的方式上传文件</li><li>ssh 远程执行虚拟机里的 <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/install.sh">install.sh</a> 脚本</li><li>执行虚拟机关机命令</li><li>创建虚拟机快照</li><li>导出虚拟机 OVF 文件</li><li>导出构建配置参数的 manifest.json 文件</li><li>执行 <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/ova.py">ova.py</a> 脚本，根据 manifest.json 配置参数将 OVF 格式转换成 OVA</li></ul><p>至此，整个的虚拟机模版的构建流程算是完成了，最终我们的到一个 OVA 格式的虚拟机模版。使用的时候只需要在本地机器上安装好 VMware Workstation 或者 Oracle VirtualBox 就能一键导入该虚拟机，开机后就可以使用啦，算是做到了开箱即用的效果。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">output└── k3s-photon3-c4ca93f    ├── k3s-photon3-c4ca93f-disk-0.vmdk    ├── k3s-photon3-c4ca93f.mf    ├── k3s-photon3-c4ca93f.ova    ├── k3s-photon3-c4ca93f.ova.sha256    ├── k3s-photon3-c4ca93f.ovf    └── packer-manifest.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="argo-workflow-和-k3s"><a href="#argo-workflow-和-k3s" class="headerlink" title="argo-workflow 和 k3s"></a>argo-workflow 和 k3s</h2><p>在虚拟机内使用 redfish-esxi-os-installer 有点特殊，是将它放在 argo-workflow 的 Pod 内来执行的。在 workflow 模版文件 <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/resources/workflow/workflow.yaml">workflow.yaml</a> 中我们定义了若干个 steps 来运行 redfish-esxi-os-installer。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Workflow<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">generateName</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">-</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer  <span class="token key atrule">templates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer    <span class="token key atrule">steps</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command            <span class="token key atrule">value</span><span class="token punctuation">:</span> pre<span class="token punctuation">-</span>check        <span class="token key atrule">name</span><span class="token punctuation">:</span> Precheck        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command            <span class="token key atrule">value</span><span class="token punctuation">:</span> build<span class="token punctuation">-</span>iso        <span class="token key atrule">name</span><span class="token punctuation">:</span> BuildISO        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command            <span class="token key atrule">value</span><span class="token punctuation">:</span> mount<span class="token punctuation">-</span>iso        <span class="token key atrule">name</span><span class="token punctuation">:</span> MountISO        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command            <span class="token key atrule">value</span><span class="token punctuation">:</span> reboot        <span class="token key atrule">name</span><span class="token punctuation">:</span> Reboot        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command            <span class="token key atrule">value</span><span class="token punctuation">:</span> post<span class="token punctuation">-</span>check        <span class="token key atrule">name</span><span class="token punctuation">:</span> Postcheck        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command            <span class="token key atrule">value</span><span class="token punctuation">:</span> umount<span class="token punctuation">-</span>iso        <span class="token key atrule">name</span><span class="token punctuation">:</span> UmountISO        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer  <span class="token punctuation">-</span> <span class="token key atrule">container</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> installer      <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/muzi502/redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">:</span>v0.1.0<span class="token punctuation">-</span>alpha.1      <span class="token key atrule">command</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> bash      <span class="token punctuation">-</span> <span class="token punctuation">-</span>c      <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">        make inventory &amp;&amp; make &#123;&#123;inputs.parameters.command&#125;&#125;</span>      <span class="token key atrule">env</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>          <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>            <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> HOST_IP        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>          <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>            <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.hostIP      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SRC_ISO_DIR        <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/iso      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> HTTP_DIR        <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/iso/redfish      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> HTTP_URL        <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$(HOST_IP)/files/iso/redfish      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ESXI_ISO        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>          <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">-</span>config            <span class="token key atrule">key</span><span class="token punctuation">:</span> esxi_iso      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>        <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /ansible/config.yaml        <span class="token key atrule">name</span><span class="token punctuation">:</span> config        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">subPath</span><span class="token punctuation">:</span> config.yaml      <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data        <span class="token key atrule">name</span><span class="token punctuation">:</span> data    <span class="token key atrule">inputs</span><span class="token punctuation">:</span>      <span class="token key atrule">parameters</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command    <span class="token key atrule">name</span><span class="token punctuation">:</span> installer    <span class="token key atrule">retryStrategy</span><span class="token punctuation">:</span>      <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token string">"2"</span>      <span class="token key atrule">retryPolicy</span><span class="token punctuation">:</span> OnFailure  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">items</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> config        <span class="token key atrule">path</span><span class="token punctuation">:</span> config.yaml      <span class="token key atrule">name</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">-</span>config    <span class="token key atrule">name</span><span class="token punctuation">:</span> config  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由于目前没有 Web UI 和后端 Server 所以还是需要手动编辑 <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/resources/workflow/configmap.yaml">&#x2F;root&#x2F;resources&#x2F;workflow&#x2F;configmap.yaml</a> 配置文件，然后再执行 <code>kubectl create -f /root/resources/workflow</code> 命令创建 workflow 工作流。</p><p>workflow 创建了之后，就可以通过 argo 命令查看 workflow 执行的进度和状态</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@localhost <span class="token punctuation">[</span> ~/resources/workflow <span class="token punctuation">]</span><span class="token comment"># argo get redfish-esxi-os-installer-tjjqz</span>Name:                redfish-esxi-os-installer-tjjqzNamespace:           defaultServiceAccount:      <span class="token builtin class-name">unset</span> <span class="token punctuation">(</span>will run with the default ServiceAccount<span class="token punctuation">)</span>Status:              SucceededConditions: PodRunning          False Completed           TrueCreated:             Mon May <span class="token number">23</span> <span class="token number">11</span>:07:31 +0000 <span class="token punctuation">(</span><span class="token number">16</span> minutes ago<span class="token punctuation">)</span>Started:             Mon May <span class="token number">23</span> <span class="token number">11</span>:07:31 +0000 <span class="token punctuation">(</span><span class="token number">16</span> minutes ago<span class="token punctuation">)</span>Finished:            Mon May <span class="token number">23</span> <span class="token number">11</span>:23:38 +0000 <span class="token punctuation">(</span><span class="token number">19</span> seconds ago<span class="token punctuation">)</span>Duration:            <span class="token number">16</span> minutes <span class="token number">7</span> secondsProgress:            <span class="token number">6</span>/6ResourcesDuration:   29m45s*<span class="token punctuation">(</span><span class="token number">1</span> cpu<span class="token punctuation">)</span>,29m45s*<span class="token punctuation">(</span>100Mi memory<span class="token punctuation">)</span>STEP                                TEMPLATE                   PODNAME                                     DURATION  MESSAGE ✔ redfish-esxi-os-installer-tjjqz  redfish-esxi-os-installer ├───✔ Precheck<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-647555770   11s ├───✔ BuildISO<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-3078771217  14s ├───✔ MountISO<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-4099695623  19s ├───✔ Reboot<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                    installer                  redfish-esxi-os-installer-tjjqz-413209187   7s ├───✔ Postcheck<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                 installer                  redfish-esxi-os-installer-tjjqz-2674696793  14m └───✔ UmountISO<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                 installer                  redfish-esxi-os-installer-tjjqz-430254503   13s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="argo-workflow"><a href="#argo-workflow" class="headerlink" title="argo-workflow"></a>argo-workflow</h3><p>之所以使用 argo-workflow 而不是使用像 docker、nerdctl 这些命令行工具来运行 redfish-esxi-os-installer ，是因为通过 argo-workflow 来编排我们的安装部署任务能够比较方便地实现多个任务同时运行、获取任务执行的进度及日志、获取任务执行的耗时、停止重试等功能。使用 argo-workflow 来编排我们的安装部署任务，并通过 argo-workflow 的 RESTful API 获取部署任务的进度日志等信息，这样做更云原生一些（🤣</p><p><img data-src="https://p.k8s.li/2022-05-23-packer-vsphere-example-01.png" alt="argo-workfloe-apis"></p><p>在我们内部其实最终目的是准备将该方案做成一个产品化的工具，提供一个 Web UI 用来进行配置部署参数以及展示部署的进度日志等功能。当初设计方案的时候也是参考了一下  <a href="https://github.com/vmware-tanzu/community-edition">VMware Tanzu 社区版</a> ：部署 Tanzu 管理集群的时候需要有一个已经存在的 k8s 集群，或者通过 Tanzu 新部署一个 kind 集群。部署一个 tanzu 管理集群可以通过 tanzu 命令行的方式，也可以通过 Tanzu Web UI 的方式，Tanzu Web UI 的方式其实就是一个偏向于产品化的工具。在 <a href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">VMware Tanzu kubernetes 发行版部署尝鲜</a> 我曾分享过 Tanzu 的部署方式，感兴趣的话可以去看一下。</p><p><img data-src="https://p.k8s.li/2022-05-23-packer-vsphere-example-02.png" alt="tanzu-cluster"></p><p>该方案主要是面向一些产品化的场景，由于引入了 K8s 这个庞然大物，整体的技术栈会复杂一些，但也有一些好处啦 😅。</p><h3 id="k8s-and-k3s"><a href="#k8s-and-k3s" class="headerlink" title="k8s and k3s"></a>k8s and k3s</h3><p>argo-workflow 需要依赖一个 k8s 集群才能运行，我们内部测试了 kubekey、sealos、kubespray、k3s 几种常见的部署工具。综合评定下来 k3s 集群占用的资源最少。参考 <a href="https://docs.rancher.cn/docs/k3s/installation/installation-requirements/resource-profiling/_index/">K3s 资源分析</a> 给出的资源要求，最小只需要 768M 内存就能运行。对于硬件资源不太充足的笔记本电脑来讲，k3s 无疑是目前最佳的方案。</p><p>另外还有一个十分重要的原因就是 k3s server 更换单 control plan 节点的 IP 地址十分方便，对用户来说是无感知的。这样就可以将安装 k3s 的操作在构建 OVA 的时候完成，而不是在使用的时候手动执行安装脚本来安装。</p><p>只要开机运行虚拟机能够通过 DHCP 分配到一个内网 IPv4 地址或者手动配置一个静态 IP，k3s 就能够正常运行起来，能够真正做到开箱即用，而不是像 kubekey、sealos、kubespray 那样傻乎乎地填写一个复杂无比的配置文件，然后再执行一些命令来安装 k8s 集群。这种导入虚拟机开即用的方式，对用户来讲十分友好。</p><p>当然在使用 kubekey、sealos、kubespray 在构建虚拟机的时候安装好 k8s 集群也不是不可行，只不过我们构建时候虚拟机的 IP 地址（比如 10.172.20.223）和使用时的 IP 地址（比如 192.168.20.11）基本上是不会相同的。给 k8s control plain 节点更换 IP 的操作 <a href="https://www.qikqiak.com/">阳明博主</a> 曾在 <a href="https://www.qikqiak.com/post/how-to-change-k8s-node-ip/">如何修改 Kubernetes 节点 IP 地址?</a> 文章中分享过他的经历，看完后直接把我整不会了，感觉操作起来实在是太麻烦了，还不如重新部署一套新的 k8s 方便呢 😂</p><p>其实构建虚拟机模版的时候安装 k8s 的思路最初我是借鉴的 <a href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> 项目 😂。即将部署 k8s 依赖的一些文件和容器镜像构建在虚拟机模版当中，部署 k8s 的时候不需要再联网下载这些依赖资源了。不同的是，我们通过 k3s 直接提前将 k8s 集群部署好了，也就省去了让用户执行部署的操作。</p><p>综上，选用 k3s 作为该方案的 K8s 底座无疑是最佳的啦（</p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="使用感受"><a href="#使用感受" class="headerlink" title="使用感受"></a>使用感受</h3><p>使用了一段时间后感觉 Packer 的复杂度和上手难度要比 Docker 构建容器镜像要高出一个数量级。可能是因为虚拟机并不像容器镜像那样有 <a href="https://opencontainers.org/">OCI</a> 这种统一的构建、分发、运行工业标准。虚拟机的创建克隆等操作与底层的 IaaS 供应商耦合的十分紧密，这就导致不同 IaaS 供应商比如 vSphere、kvm&#x2F;qemu 他们之间能够复用的配置参数并不多。比如 vSphere 里有 datastore、datacenter、resource_pool、folder 等概念，但 kvm&#x2F;qemu 中缺没有，这就导致很难将它们统一成一个配置。</p><h3 id="OVA-格式"><a href="#OVA-格式" class="headerlink" title="OVA 格式"></a>OVA 格式</h3><p>使用 OVA 而不是 vagrant.box、vmdk、raw、qcow2 等其他格式是因为 OVA 支持支持一键导入的特性，在 Windows 上使用起来比较方便。毕竟 Windows 上安装 Vagrant 或者 qemu&#x2F;KVM 也够你折腾的了，<a href="https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html">VMware Workstation</a> 或者 <a href="https://www.virtualbox.org/">Oracle VirtualBox</a> 使用得更广泛一些。</p><p>另外 Packer 并不支持直接将虚拟机导出为 OVA 的方式，默认情况下只会通过 vCenter 的 API 导出为 ovf。如果需要 OVA 格式，需要将 OVF 打包成 OVA。在 ISSUE <a href="https://github.com/hashicorp/packer/issues/9645">Add support for exporting to OVA in vsphere-iso builder #9645</a> 也有人反馈了支持 OVA 导出的需求，但 Packer 至今仍未支持。将 OVF 转换为 OVA 我是参考的 image-builder 项目的 <a href="https://github.com/kubernetes-sigs/image-builder/blob/master/images/capi/hack/image-build-ova.py"><strong>image-build-ova.py</strong> </a> 来完成的。</p><h3 id="安装-open-vm-tool-失败"><a href="#安装-open-vm-tool-失败" class="headerlink" title="安装 open-vm-tool 失败"></a>安装 open-vm-tool 失败</h3><p>由于 ISO 中并不包含 open-vm-tool 软件包，这就需要在 ISO 安装 OS 的过程中联网安装 open-vm-tools。如果安装的时候网络抖动了就可能会导致 open-vm-tools 安装失败。open-vm-tools 安装失败 packer 是无法感知到的，只能一直等到获取虚拟机 IP 超时后退出执行。目前没有很好的办法，只能在 kickstart 里安装 open-vm-tools 的时候进行重试直到 open-vm-tools 安装成功。</p><h3 id="减少导出后-vmdk-文件大小"><a href="#减少导出后-vmdk-文件大小" class="headerlink" title="减少导出后 vmdk 文件大小"></a>减少导出后 vmdk 文件大小</h3><p>曾经在 <a href="https://blog.k8s.li/esxi-vmbase.html">手搓虚拟机模板</a> 文章中分析过通过 dd 置零的方式可以大幅减少虚拟机导出后的 vmdk 文件大</p><blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">464M Aug <span class="token number">28</span> <span class="token number">16</span>:15 Ubuntu1804-2.ova <span class="token comment"># 置零后的大小</span><span class="token number">1</span>.3G Aug <span class="token number">28</span> <span class="token number">15</span>:48 Ubuntu1804.ova   <span class="token comment"># 置零前的大小</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></blockquote><p>需要注意的是，在 dd 置零之前要先停止 k3s 服务，不然置零的时候会占满 root 根分区导致 kubelet 启动 GC 将一些镜像给删除掉。之前导出虚拟机后发现少了一些镜像，排查了好久才发现是 kubelet GC 把我的镜像给删掉了，踩了个大坑，可气死我了 😡</p><p>另外也可以删除一些不必要的文件，比如 containerd 中 <code>io.containerd.content.v1.content/blobs/sha256</code> 一些镜像 layer 的原始 blob 文件是不需要的，可以将它们给删除掉，这样能够减少部分磁盘空间占用；</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token comment"># stop k3s server for for prevent it starting the garbage collection to delete images</span>  systemctl stop k3s  <span class="token comment"># Ensure on next boot that network devices get assigned unique IDs.</span>  <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'/^\(HWADDR\|UUID\)=/d'</span> /etc/sysconfig/network-scripts/ifcfg-* <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">||</span> <span class="token boolean">true</span>  <span class="token comment"># Clean up network interface persistence</span>  <span class="token function">find</span> /var/log <span class="token parameter variable">-type</span> f <span class="token parameter variable">-exec</span> truncate <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">\</span><span class="token punctuation">;</span>  <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /tmp/* /var/tmp/*  <span class="token comment"># cleanup all blob files of registry download image</span>  <span class="token function">find</span> /var/lib/rancher/k3s/agent/containerd/io.containerd.content.v1.content/blobs/sha256 <span class="token parameter variable">-size</span> +1M <span class="token parameter variable">-type</span> f <span class="token parameter variable">-delete</span>  <span class="token comment"># zero out the rest of the free space using dd, then delete the written file.</span>  <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/EMPTY <span class="token assign-left variable">bs</span><span class="token operator">=</span>4M <span class="token assign-left variable">status</span><span class="token operator">=</span>progress <span class="token operator">||</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> /EMPTY  <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/data/EMPTY <span class="token assign-left variable">bs</span><span class="token operator">=</span>4M <span class="token assign-left variable">status</span><span class="token operator">=</span>progress <span class="token operator">||</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> /data/EMPTY  <span class="token comment"># run sync so Packer doesn't quit too early, before the large file is deleted.</span>  <span class="token function">sync</span>  yum clean all<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Photon3"><a href="#Photon3" class="headerlink" title="Photon3"></a>Photon3</h3><p>之前在 <a href="https://blog.k8s.li/Photon-OS.html">轻量级容器优化型 Linux 发行版 Photon OS</a> 里分享过 VMware 的 Linux 发行版 <a href="https://vmware.github.io/photon/assets/files/html/3.0/">Photon</a>。不同于传统的 Linux 发行版 Photon 的系统十分精简，使用它替代 CentOS 能够一定程度上减少系统资源的占用，导出后的 vmdk 文件也要比 CentOS 小一些。</p><h3 id="goss"><a href="#goss" class="headerlink" title="goss"></a><a href="https://github.com/aelsabbahy/goss">goss</a></h3><p>在构建的过程中我们在 k3s 集群上安装了一些其他的组件，比如提供文件上传和下载服务的 filebrowser 以及 workflow 工作流引擎 argo-workflow，为了保证这些服务的正常运行，我们就需要通过不同的方式去检查这些服务是否正常。一般是通过 kubectl get 等命令查看 deployment、pod、daemonset 等服务是否正常运行，或者通过 curl 访问这些这些服务的健康检查 API。</p><p>由于检查项比较多且十分繁琐，使用传统的 shell 脚本来做这并不是很方便，需要解析每个命令的退出码以及返回值。因此我们使用 <a href="https://github.com/aelsabbahy/goss">goss</a> 通过 YAML 格式的配置文件来定义一些检查项，让它批量来执行这些检查，而不用在 shell 对每个检查项写一堆的 awk&#x2F;grep 等命令来 check 了。</p><ul><li><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/goss/k3s.yaml">k3s.yaml</a>：用于检查 k3s 以及它默认自带的服务是否正常运行</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># DNS 类型的检查</span><span class="token key atrule">dns</span><span class="token punctuation">:</span>  <span class="token comment"># 检查 coredns 是否能够正常解析到 kubernetes apiserver 的 service IP 地址</span>  <span class="token key atrule">kubernetes.default.svc.cluster.local</span><span class="token punctuation">:</span>    <span class="token key atrule">resolvable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">addrs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> 10.43.0.1    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.43.0.10    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token comment"># TCP/UDP 端口类型的检查</span><span class="token key atrule">addr</span><span class="token punctuation">:</span>  <span class="token comment"># 检查 coredns 的 UDP 53 端口是否正常</span>  <span class="token key atrule">udp://10.43.0.10:53</span><span class="token punctuation">:</span>    <span class="token key atrule">reachable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token comment"># 检查 cni0 网桥是否存在</span><span class="token key atrule">interface</span><span class="token punctuation">:</span>  <span class="token key atrule">cni0</span><span class="token punctuation">:</span>    <span class="token key atrule">exists</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">addrs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> 10.42.0.1/24<span class="token comment"># 本机端口类型的检查</span><span class="token key atrule">port</span><span class="token punctuation">:</span>  <span class="token comment"># 检查 ssh 22 端口是否正常</span>  <span class="token key atrule">tcp:22</span><span class="token punctuation">:</span>    <span class="token key atrule">listening</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">ip</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> 0.0.0.0    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 检查 kubernetes apiserver 6443 端口是否正常</span>  <span class="token key atrule">tcp6:6443</span><span class="token punctuation">:</span>    <span class="token key atrule">listening</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token comment"># 检查一些 systemd 服务的检查</span><span class="token key atrule">service</span><span class="token punctuation">:</span>  <span class="token comment"># 默认禁用 firewalld 服务</span>  <span class="token key atrule">firewalld</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">running</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 确保 sshd 服务正常运行</span>  <span class="token key atrule">sshd</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">running</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 检查 k3s 服务是否正常运行</span>  <span class="token key atrule">k3s</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">running</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token comment"># 定义一些 shell 命令执行的检查</span><span class="token key atrule">command</span><span class="token punctuation">:</span>  <span class="token comment"># 检查 kubernetes cheduler 组件是否正常</span>  <span class="token key atrule">check_k8s_scheduler_health</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> curl <span class="token punctuation">-</span>k https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10259/healthz    <span class="token comment"># 退出码是否为 0</span>    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment"># 标准输出中是否包含正确的输出值</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ok"</span><span class="token punctuation">]</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 检查 kubernetes controller-manager 是否正常</span>  <span class="token key atrule">check_k8s_controller-manager_health</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> curl <span class="token punctuation">-</span>k https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10257/healthz    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ok"</span><span class="token punctuation">]</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 检查 cluster-info  中输出的组件运行状态是否正常</span>  <span class="token key atrule">check_cluster_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl cluster<span class="token punctuation">-</span>info <span class="token punctuation">|</span> grep 'is running'    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> CoreDNS      <span class="token punctuation">-</span> Kubernetes control plane    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 检查节点是否处于 Ready 状态</span>  <span class="token key atrule">check_node_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get node <span class="token punctuation">-</span>o jsonpath='<span class="token punctuation">&#123;</span>.items<span class="token punctuation">[</span><span class="token punctuation">]</span>.status<span class="token punctuation">&#125;</span>' <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.conditions<span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">]</span>.type'    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> Ready    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 检查节点 IP 是否正确</span>  <span class="token key atrule">check_node_address</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get node <span class="token punctuation">-</span>o wide <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.status.addresses<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">|</span> select(.type == "InternalIP") <span class="token punctuation">|</span> .address'    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 检查 traefik loadBalancer 的 IP 地址是否正确</span>  <span class="token key atrule">check_traefik_address</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system get svc traefik <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.status.loadBalancer.ingress<span class="token punctuation">[</span><span class="token punctuation">]</span>.ip'    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 检查 containerd 容器运行是否正常</span>  <span class="token key atrule">check_container_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> crictl ps <span class="token punctuation">-</span><span class="token punctuation">-</span>output=json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.containers<span class="token punctuation">[</span><span class="token punctuation">]</span>.metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> coredns      <span class="token punctuation">-</span> /lb<span class="token punctuation">-</span>.<span class="token important">*-443/</span>      <span class="token punctuation">-</span> /lb<span class="token punctuation">-</span>.<span class="token important">*-80/</span>      <span class="token punctuation">-</span> traefik    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 检查 kube-system namespace 下的 pod 是否正常</span>  <span class="token key atrule">check_kube_system_namespace_pod_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get pod <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">|</span> select((.status.phase <span class="token tag">!=</span> "Running") and (.status.phase <span class="token tag">!=</span> "Succeeded") and (.status.phase <span class="token tag">!=</span> "Completed"))'    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"!string"</span><span class="token punctuation">]</span>  <span class="token comment"># 检查 k8s deployment 服务是否都正常</span>  <span class="token key atrule">check_k8s_deployment_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get deploy <span class="token punctuation">-</span><span class="token punctuation">-</span>all<span class="token punctuation">-</span>namespaces <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">|</span> select(.status.replicas == .status.availableReplicas) <span class="token punctuation">|</span> .metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> coredns      <span class="token punctuation">-</span> traefik    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 检查 svclb-traefik daemonset 是否正常</span>  <span class="token key atrule">check_k8s_daemonset_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get daemonset <span class="token punctuation">-</span><span class="token punctuation">-</span>all<span class="token punctuation">-</span>namespaces <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">|</span> select(.status.replicas == .status.availableReplicas) <span class="token punctuation">|</span> .metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> svclb<span class="token punctuation">-</span>traefik    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/goss/goss.yaml">goss.yaml</a>：用于检查我们部署的一些服务是否正常</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 通过 include 其他 gossfile 方式将上面定义的 k3s.yaml 检查项也包含进来</span><span class="token key atrule">gossfile</span><span class="token punctuation">:</span>  <span class="token key atrule">k3s.yaml</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token key atrule">dns</span><span class="token punctuation">:</span>  <span class="token comment"># 检查部署的 filebrowser deployment 的 service IP 是否能正常解析到</span>  <span class="token key atrule">filebrowser.default.svc.cluster.local</span><span class="token punctuation">:</span>    <span class="token key atrule">resolvable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.43.0.10    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 检查部署的 argo-workflow deployment 的 service IP 是否能正常解析到</span>  <span class="token key atrule">argo-workflow-argo-workflows-server.default.svc.cluster.local</span><span class="token punctuation">:</span>    <span class="token key atrule">resolvable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.43.0.10    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token comment"># 一些 HTTP 请求方式的检查</span><span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token comment"># 检查 filebrowser 服务是否正常运行，类似于 pod 里的存活探针</span>  http<span class="token punctuation">:</span>//<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/filebrowser/<span class="token punctuation">:</span>    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token number">200</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">method</span><span class="token punctuation">:</span> GET  <span class="token comment"># 检查 argo-workflow 是否正常运行</span>  http<span class="token punctuation">:</span>//<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/workflows/api/v1/version<span class="token punctuation">:</span>    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token number">200</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">method</span><span class="token punctuation">:</span> GET<span class="token comment"># 同样也是一些 shell 命令的检查项目</span><span class="token key atrule">command</span><span class="token punctuation">:</span>  <span class="token comment"># 检查容器镜像是否齐全，避免缺镜像的问题</span>  <span class="token key atrule">check_container_images</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> crictl images <span class="token punctuation">-</span><span class="token punctuation">-</span>output=json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.images<span class="token punctuation">[</span><span class="token punctuation">]</span>.repoTags<span class="token punctuation">[</span><span class="token punctuation">]</span>' <span class="token punctuation">|</span> awk <span class="token punctuation">-</span>F '/' '<span class="token punctuation">&#123;</span>print $NF<span class="token punctuation">&#125;</span>' <span class="token punctuation">|</span> awk <span class="token punctuation">-</span>F '<span class="token punctuation">:</span>' '<span class="token punctuation">&#123;</span>print $1<span class="token punctuation">&#125;</span>' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> argocli      <span class="token punctuation">-</span> argoexec      <span class="token punctuation">-</span> workflow<span class="token punctuation">-</span>controller      <span class="token punctuation">-</span> filebrowser      <span class="token punctuation">-</span> nginx    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 检查容器运行的状态是否正常</span>  <span class="token key atrule">check_container_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> crictl ps <span class="token punctuation">-</span><span class="token punctuation">-</span>output=json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.containers<span class="token punctuation">[</span><span class="token punctuation">]</span>.metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> argo<span class="token punctuation">-</span>server      <span class="token punctuation">-</span> controller      <span class="token punctuation">-</span> nginx      <span class="token punctuation">-</span> filebrowser    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># 检查一些 deployment 的状态是否正常</span>  <span class="token key atrule">check_k8s_deployment_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get deploy <span class="token punctuation">-</span>n default <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">|</span> select(.status.replicas == .status.availableReplicas) <span class="token punctuation">|</span> .metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> argo<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>argo<span class="token punctuation">-</span>workflows<span class="token punctuation">-</span>server      <span class="token punctuation">-</span> argo<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>argo<span class="token punctuation">-</span>workflows<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>controller      <span class="token punctuation">-</span> filebrowser    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token comment"># 一些硬件参数的检查，比如 CPU 核心数、内存大小、可用内存大小</span><span class="token key atrule">matching</span><span class="token punctuation">:</span>  <span class="token key atrule">check_vm_cpu_core</span><span class="token punctuation">:</span>    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.cpu_core_number <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">matches</span><span class="token punctuation">:</span>      <span class="token key atrule">gt</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">check_vm_memory_size</span><span class="token punctuation">:</span>    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.memory_size <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">matches</span><span class="token punctuation">:</span>      <span class="token key atrule">gt</span><span class="token punctuation">:</span> <span class="token number">1880000</span>  <span class="token key atrule">check_available_memory_size</span><span class="token punctuation">:</span>    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.available_memory_size <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">matches</span><span class="token punctuation">:</span>      <span class="token key atrule">gt</span><span class="token punctuation">:</span> <span class="token number">600000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>另外 goss 也比较适合做一些巡检的工作。比如在一个 k8s 集群中进行巡检：检查集群内 pod 的状态、kubernetes 组件的状态、CNI 运行状态、节点的网络、磁盘存储空间、CPU 负载、内核参数、daemonset 服务状态等，都可以参照上述方式定义一系列的检查项，使用 goss 来帮我们自动完成巡检。</p><h3 id="导入-OVA-虚拟机后-Pod-状态异常"><a href="#导入-OVA-虚拟机后-Pod-状态异常" class="headerlink" title="导入 OVA 虚拟机后 Pod 状态异常"></a>导入 OVA 虚拟机后 Pod 状态异常</h3><p>将 OVA 虚拟机在 VMware Workstation 上导入之后，由于虚拟机 IP 的变化可能会导致一些 Pod 处于异常的状态，这时候就需要对这些 Pod 进行强制删除，强制重启一下才能恢复正常。因此需要需要在虚拟机里增加一个 <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/prepare.sh">prepare.sh</a> 脚本用来重启这些状态异常的 Pod。当导入 OVA 虚拟机后运行这个脚本让所有的 Pod 都正常运行起来，然后再调用 goss 来检查其他服务是否正常。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> errexit<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> nounset<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> pipefailkubectl get pods --no-headers <span class="token parameter variable">-n</span> kube-system <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'0/2|0/1|Error|Unknown|CreateContainerError|CrashLoopBackOff'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">-I</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> kubectl delete pod <span class="token parameter variable">-n</span> kube-system --grace-period<span class="token operator">=</span><span class="token number">0</span> <span class="token parameter variable">--force</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> /dev/null  <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token boolean">true</span>kubectl get pods --no-headers <span class="token parameter variable">-n</span> default <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'0/1|Error|Unknown|CreateContainerError|CrashLoopBackOff'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">-I</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> kubectl delete pod <span class="token parameter variable">-n</span> default --grace-period<span class="token operator">=</span><span class="token number">0</span> <span class="token parameter variable">--force</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> /dev/null  <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token boolean">true</span><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span>  <span class="token keyword">if</span> kubectl get pods --no-headers --all-namespaces <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-Ev</span> <span class="token string">'Running|Completed'</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> <span class="token string">"Waiting for service readiness"</span>    <span class="token function">sleep</span> <span class="token number">10</span>  <span class="token keyword">else</span>    <span class="token builtin class-name">break</span>  <span class="token keyword">fi</span><span class="token keyword">done</span><span class="token builtin class-name">cd</span> <span class="token variable">$&#123;<span class="token environment constant">HOME</span>&#125;</span>/.goss<span class="token function">cat</span> <span class="token operator">></span> vars.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOFip_address: <span class="token variable"><span class="token variable">$(</span><span class="token function">ip</span> r get <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">"s/ uid.*//g"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $NF&#125;'</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-n1</span><span class="token variable">)</span></span>cpu_core_number: <span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token parameter variable">-c</span> ^processor /proc/cpuinfo<span class="token variable">)</span></span>memory_size: <span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token string">'^MemTotal:'</span> /proc/meminfo <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span><span class="token variable">)</span></span>available_memory_size: <span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token string">'^MemAvailable:'</span> /proc/meminfo <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span><span class="token variable">)</span></span>EOF</span>goss <span class="token parameter variable">--vars</span> vars.yaml <span class="token parameter variable">-g</span> goss.yaml validate --retry-timeout<span class="token operator">=</span>10s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://www.escapelife.site/posts/754ba85c.html">K3S 工具进阶完全指南</a></li><li><a href="https://docs.rancher.cn/docs/k3s/installation/installation-requirements/resource-profiling/_index/">K3s 资源分析</a></li><li><a href="https://github.com/aelsabbahy/goss/blob/master/docs/manual.md">goss</a>：goss 配置文档</li><li><a href="https://github.com/alexellis/awesome-baremetal">awesome-baremetal</a>：一些与裸金属服务器相关的工具汇总</li><li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax">Kickstart Syntax Reference</a>：CentOS&#x2F;Red Hat kickstart 语法</li><li><a href="https://vmware.github.io/photon/assets/files/html/3.0/photon_user/kickstart.html">Kickstart Support in Photon OS</a>：Photon OS 的 kickstart 语法</li></ul><h3 id="Packer-相关"><a href="#Packer-相关" class="headerlink" title="Packer 相关"></a>Packer 相关</h3><ul><li><a href="https://github.com/chef/bento">bento</a>：是一个 Packer 最佳实践的模版仓库，不过它的 builder 是 Vagrant，但可以从中借鉴一些 Linux 发行版的自动化安装脚本，比如 CentOS 的 <a href="https://github.com/chef/bento/tree/main/packer_templates/centos/http">kickstart</a> 文件。</li><li><a href="https://mp.weixin.qq.com/s/FnnMnu9i6gFNrAjIlzaNnQ">基于 Packer+Ansible 实现云平台黄金镜像统一构建和发布</a></li><li><a href="https://github.com/kubernetes-sigs/image-builder/tree/master/images/capi">Image Builder for Cluster API</a></li><li><a href="https://image-builder.sigs.k8s.io/capi/providers/vsphere.html#building-images-for-vsphere">Building Images for vSphere</a></li><li><a href="https://www.packer.io/plugins/builders/vsphere/vsphere-clone">VMware vSphere Clone Builder</a></li><li><a href="https://www.packer.io/plugins/builders/vsphere/vsphere-iso">Packer Builder for VMware vSphere</a></li><li><a href="https://github.com/hashicorp/packer-plugin-vsphere">packer-plugin-vsphere</a></li><li><a href="https://github.com/vmware-samples/packer-examples-for-vsphere">packer-examples-for-vsphere</a></li><li><a href="https://docs.rockylinux.org/guides/automation/templates-automation-packer-vsphere/">Automatic template creation with Packer and deployment with Ansible in a VMware vSphere environment</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;不久前写过一篇博客《&lt;a
        
      
    
    </summary>
    
    
      <category term="技术" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="argo-workflow" scheme="https://blog.k8s.li/tags/argo-workflow/"/>
    
      <category term="vSphere" scheme="https://blog.k8s.li/tags/vSphere/"/>
    
      <category term="packer" scheme="https://blog.k8s.li/tags/packer/"/>
    
      <category term="esxi" scheme="https://blog.k8s.li/tags/esxi/"/>
    
      <category term="k3s" scheme="https://blog.k8s.li/tags/k3s/"/>
    
      <category term="redfish" scheme="https://blog.k8s.li/tags/redfish/"/>
    
  </entry>
  
  <entry>
    <title>使用 Redfish 自动化安装 ESXi OS</title>
    <link href="https://blog.k8s.li/redfish-esxi-os-installer.html"/>
    <id>https://blog.k8s.li/redfish-esxi-os-installer.html</id>
    <published>2022-04-29T16:00:00.000Z</published>
    <updated>2022-04-29T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>从去年十一月底到现在一直在做在  <a href="https://www.vmware.com/products/esxi-and-esx.html">VMware ESXi</a>  上部署 <a href="https://www.smartx.com/smartx-hci/">超融合集群</a> 的产品化工具，也是在最近完成了前后端的联调，五一节后开始进入测试阶段。为了测试不同的 VMware ESXi 版本和我们产品的兼容性，需要很频繁地在一些物理服务器（如戴尔、联想、惠普、浪潮、超微等）上安装 VMware ESXi OS。</p><p>之前一直都是登录 IPMI 管理页面，挂载远程的 ISO 文件手动安装。安装完成之后还需要配置 ESXi 管理网络的 IP 地址。整体的安装流程比较繁琐，而且物理服务器每次重启和开机都十分耗时，对经常要安装 ESXi 的 QE 小伙伴来讲十分痛苦。</p><p>为了后续测试起来爽快一点，不用再为安装 ESXi OS 而烦恼，于是就基于 Redfish 快速实现了一套自动化安装 ESXi OS 的工具 <a href="https://github.com/muzi502/redfish-esxi-os-installer">redfish-esxi-os-installer</a>。通过它我们内部的戴尔、联想、HPE 服务器安装 ESXi OS 只需要填写一个配置文件并选择需要安装的 ESXi ISO，运行一下 Jenkins Job 等待十几分钟就能自动安装好。原本需要一个多小时的工作量，现在只需要运行一下 Jenkins Job 帮助我们自动安装好 ESXi OS 啦 😂，真是爽歪歪。</p><p>五一假期刚开始，正好有时间抽空整理一下最近学到的东西，和大家分享一下这套自动化安装 ESXi OS 工具。</p><h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><ul><li>支持服务器：联想&#x2F;戴尔&#x2F;HPE（超微和浪潮优先级不高，暂时不支持）；</li><li>一键自动化安装&#x2F;重装 ESXi OS，最好能配置好 Jenkins Job；</li><li>指定 ESXi OS 安装的物理盘：由于物理服务器有多块硬盘，ESXi OS 需要安装在指定的硬盘上。一般为 SATA DOM 盘。比如戴尔的 <a href="https://downloads.dell.com/manuals/all-products/esuprt_solutions_int/esuprt_solutions_int_solutions_resources/servers-solution-resources_white-papers10_en-us.pdf">DELLBOSS</a>，联想的 <a href="https://lenovopress.com/lp0769.pdf">ThinkSystem M.2</a> 。这类 DOM 盘的好处就在于不占用多余的 HBA 卡或 PCI 插槽，有点类似于家用台式机主板上的 M.2 硬盘位插槽；</li><li>指定网卡并配置静态 IP 地址：由于我们的物理服务器上有多块网卡，且不同的网卡有不同的网络用途，因此需要指定某块物理网卡为 ESXi 管理网络所使用的网卡。</li><li>为 ESXi 管理网路配置静态 IP、子网掩码、网关，便于部署好之后直接就能通过该 IP 访问 ESXi。而不是通过 DHCP 分配一个 IP，然后再登录 IPMI 管理页面手动查看 ESXi 的 IP；</li></ul><h2 id="技术调研"><a href="#技术调研" class="headerlink" title="技术调研"></a>技术调研</h2><p>目前市面上主流的裸金属服务器自动化安装 OS 的工具有 PXE 和 IPMI&#x2F;Redfish 两种。</p><h3 id="PXE"><a href="#PXE" class="headerlink" title="PXE"></a>PXE</h3><p>虽然内部也有 PXE 服务可用，但重启服务器和设置服务器的引导项为 PXE 启动仍然需要手动登录 IPMI 管理页面进行操作，无法做到自动重启和自动重装，仍有一定的工作量。而且 PXE 安装 OS 无法解决为每台服务器配置各自的安装盘和管理网络网卡及静态 IP 地址的问题，遂放弃。</p><h3 id="IPMI-x2F-Redfish"><a href="#IPMI-x2F-Redfish" class="headerlink" title="IPMI&#x2F;Redfish"></a>IPMI&#x2F;Redfish</h3><p><a href="https://www.dmtf.org/standards/redfish">Redfish</a> 的概念和原理什么的就懒得介绍了，下面就直接剽窃一下官方的文档吧 😅：</p><blockquote><p><code>DMTF</code> 的 <code>Redfish®</code> 是一个标准 <code>API</code>，旨在为融合、混合 <code>IT</code> 和软件定义数据中心（<code>SDDC</code>）提供简单和安全管理。</p><p>在 <code>Redfish</code> 出现之前，现代数据中心环境中缺乏互操作管理标准。随着机构越来越青睐于大规模的解决方案，传统标准不足以成功管理大量简单的多节点服务器或混合基础设施。<code>IPMI</code> 是一种较早的带外管理标准，仅限于“最小公共集”命令集（例如，开机&#x2F;关机&#x2F;重启、温度值、文本控制台等），由于供应商扩展在所有平台上并不常见，导致了客户常用的功能集减少。许多用户开发了自己的紧密集成工具，但是也不得不依赖带内管理软件。</p><p>而对于企业级用户来说，设备都是上千台，其需要统一的管理界面，就要对接不同供应商的 <code>API</code>。当基本 <code>IPMI</code> 功能已经不太好满足大规模 <code>Scale-out</code> 环境时，如何以更便捷的方式调用服务器高级管理功能就是一个新的需求。</p><p>为了寻求一个基于广泛使用的工具来加快发展的现代接口，现如今，客户需要一个使用互联网和 <code>web</code> 服务环境中常见的协议、结构和安全模型定义的 <code>API</code>。</p><p><code>Redfish</code> 可扩展平台管理 <code>API</code>（<code>The Redfish Scalable Platforms Management API</code>）是一种新的规范，其使用 <code>RESTful</code> 接口语义来访问定义在模型格式中的数据，用于执行带外系统管理 （<code>out of band systems management</code>）。其适用于大规模的服务器，从独立的服务器到机架式和刀片式的服务器环境，而且也同样适用于大规模的云环境。</p><p><code>Redfish</code> 的第 <code>1</code> 版侧重于服务器，为 <code>IPMI-over-LAN</code> 提供了一个安全、多节点的替代品。随后的 <code>Redfish</code> 版本增加了对网络接口(例如 <code>NIC</code>、<code>CNA</code> 和 <code>FC HBA</code>)、<code>PCIe</code> 交换、本地存储、<code>NVDIMM</code>、多功能适配器和可组合性以及固件更新服务、软件更新推送方法和安全特权映射的管理。此外，<code>Redfish</code> 主机接口规范允许在操作系统上运行应用程序和工具，包括在启动前（固件）阶段-与 <code>Redfish</code> 管理服务沟通。</p><p>在定义 <code>Redfish</code> 标准时，协议与数据模型可分开并允许独立地修改。以模式为基础的数据模型是可伸缩和可扩展的，并且随着行业的发展，它将越来越具有人类可读性定义。</p></blockquote><p>通过 Redfish 我们可以对服务器进行挂载&#x2F;卸载 ISO、设置 BIOS 启动项、开机&#x2F;关机&#x2F;重启等操作。只需要使用一些特定的 ansible 模块，将它们缝合起来就能将整个流程跑通。</p><p>内部的服务器戴尔、联想、HPE 的较多，这三家厂商对 Redfish 支持的也比较完善。于是这个 ESXi OS 自动化安装工具 <a href="https://github.com/muzi502/redfish-esxi-os-installer">redfish-esxi-os-installer</a> 就基于 Redfish 并结合 Jenkins 实现了一套自动化安装 ESXi OS 的方案，下面就详细介绍一下这套方案的安装流程和技术实现细节。</p><h2 id="安装流程"><a href="#安装流程" class="headerlink" title="安装流程"></a>安装流程</h2><ol><li>获取硬盘和网卡硬件设备信息</li><li>根据硬件设备信息填写配置文件</li><li>根据配置文件生成 ansible inventory 文件</li><li>根据配置文件为每台主机生成 kickstart 文件</li><li>将生成好的 kickstart 文件打包放到 ESXi ISO 当中</li><li>为每台主机重新构建一个 ESXi ISO 文件</li><li>通过 redfish 弹出已有的 ISO 镜像</li><li>通过 redfish 插入远程的 ISO 镜像</li><li>设置 one-boot 启动引导项为虚拟光驱</li><li>重启服务器到 ESXI ISO</li><li>ESXi installer 调用 Kickstart 脚本安装 OS</li><li>等待 ESXi OS 安装完成</li></ol><h3 id="获取硬件信息"><a href="#获取硬件信息" class="headerlink" title="获取硬件信息"></a>获取硬件信息</h3><p>该步骤主要是获取 ESXi OS 所要安装的硬盘和管理网络网卡设备信息。</p><h4 id="获取硬盘型号-x2F-序列号"><a href="#获取硬盘型号-x2F-序列号" class="headerlink" title="获取硬盘型号&#x2F;序列号"></a>获取硬盘型号&#x2F;序列号</h4><p>要指定 ESXi OS 安装的硬盘，可以通过硬盘型号或序列号的方式。如果当前服务器已经安装了 ESXi，登录到 ESXi 则可以查看到所安装硬盘的型号：</p><ul><li>比如这台戴尔的服务器 ESXi OS 安装的硬盘型号是 <code>DELLBOSS VD</code>（注意中间的空格不要省略）；</li></ul><p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-01.png" alt="img"></p><ul><li>比如这台联想服务器的 SATA DOM 盘型号为 <code>ThinkSystem M.2</code></li></ul><p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-06.png" alt="img"></p><ul><li>如果安装的是 Linux，可以通过 <a href="https://www.smartmontools.org/">smartctl</a> 工具查看所要安装硬盘的型号即 <code>Device Model</code>，比如：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@esxi-debian-nas ~╰─<span class="token comment"># smartctl -x /dev/sdb</span>smartctl <span class="token number">6.6</span> <span class="token number">2017</span>-11-05 r4594 <span class="token punctuation">[</span>x86_64-linux-4.19.0-18-amd64<span class="token punctuation">]</span> <span class="token punctuation">(</span>local build<span class="token punctuation">)</span>Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2002</span>-17, Bruce Allen, Christian Franke, www.smartmontools.org<span class="token operator">==</span><span class="token operator">=</span> START OF INFORMATION SECTION <span class="token operator">==</span><span class="token operator">=</span>Device Model:     HGST HUH721212ALE604Serial Number:    5PJAMUHDLU WWN Device Id: <span class="token number">5</span> 000cca 291e10521<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-04.png" alt="img"></p><p>如果有多块型号相同的硬盘，ESXi 会默认选择第一块，如果要指定某一块硬盘则使用 WWN 号的方式，获取 WWN ID 的命令如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@esxi-debian-nas ~╰─<span class="token comment"># smartctl -x /dev/sdb | sed -n "s/LU WWN Device Id:/naa./p" | tr -d ' '</span>naa.5000cca291e10521<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="获取网卡设备名-x2F-MAC-地址"><a href="#获取网卡设备名-x2F-MAC-地址" class="headerlink" title="获取网卡设备名&#x2F;MAC 地址"></a>获取网卡设备名&#x2F;MAC 地址</h4><ul><li>如果当前物理服务器已经安装了 ESXi，则登录 ESXi 主机查看 ESXi 默认的管理网络 vSwitch0 虚拟交换机所连接的物理网卡设备名，比如这台服务器网卡设备名为 <code>vmnic4</code></li></ul><p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-05.png" alt="img"></p><ul><li>另一种方式则是登录服务器的 IPMI 管理页面，查看对应网卡的 MAC 地址</li></ul><p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-02.png" alt="img"></p><h3 id="填写配置文件"><a href="#填写配置文件" class="headerlink" title="填写配置文件"></a>填写配置文件</h3><p>通过以上方式确定好 ESXi OS 所安装的硬盘型号或序列号，以及 ESXi 默认管理网络 vSwitch0 所关联的物理网卡设备名或 MAC 地址之后，我们就将这些配置参数填入到该配置文件当中。后面的工具会使用该配置为每台机器生成不同的 kickstart 文件，在 kickstart 文件中指定 ESXi OS 安装的硬盘，ESXi 管理网络所使用的网卡，以及设置静态 IP、子网掩码、网关、主机名等参数。</p><ul><li><a href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/config-example.yaml">config.yaml</a></li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">hosts</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">ipmi</span><span class="token punctuation">:</span>    <span class="token key atrule">vendor</span><span class="token punctuation">:</span> lenovo                  <span class="token comment"># 服务器厂商名 [dell, lenovo, hpe]</span>    <span class="token key atrule">address</span><span class="token punctuation">:</span> 10.172.70.186          <span class="token comment"># IPMI IP 地址</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> username              <span class="token comment"># IPMI 用户名</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> password              <span class="token comment"># IPMI 密码</span>  <span class="token key atrule">esxi</span><span class="token punctuation">:</span>    <span class="token key atrule">esxi_disk</span><span class="token punctuation">:</span> ThinkSystem M.2      <span class="token comment"># ESXi OS 所安装硬盘的型号或序列号</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> password              <span class="token comment"># ESXi 的 root 用户密码</span>    <span class="token key atrule">address</span><span class="token punctuation">:</span> 10.172.69.86           <span class="token comment"># ESXi 管理网络 IP 地址</span>    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 10.172.64.1            <span class="token comment"># ESXi 管理网络网关</span>    <span class="token key atrule">netmask</span><span class="token punctuation">:</span> 255.255.240.0          <span class="token comment"># ESXi 管理网络子网掩码</span>    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> esxi<span class="token punctuation">-</span>69<span class="token punctuation">-</span><span class="token number">86</span>            <span class="token comment"># ESXi 主机名（可选）</span>    <span class="token key atrule">mgtnic</span><span class="token punctuation">:</span> vmnic4                  <span class="token comment"># ESXi 管理网络网卡名称或MAC 地址</span><span class="token punctuation">-</span> <span class="token key atrule">ipmi</span><span class="token punctuation">:</span>    <span class="token key atrule">vendor</span><span class="token punctuation">:</span> dell    <span class="token key atrule">address</span><span class="token punctuation">:</span> 10.172.18.191    <span class="token key atrule">username</span><span class="token punctuation">:</span> username    <span class="token key atrule">password</span><span class="token punctuation">:</span> password  <span class="token key atrule">esxi</span><span class="token punctuation">:</span>    <span class="token key atrule">esxi_disk</span><span class="token punctuation">:</span> DELLBOSS VD    <span class="token key atrule">password</span><span class="token punctuation">:</span> password    <span class="token key atrule">address</span><span class="token punctuation">:</span> 10.172.18.95    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 10.172.16.1    <span class="token key atrule">netmask</span><span class="token punctuation">:</span> 255.255.240.0    <span class="token key atrule">mgtnic</span><span class="token punctuation">:</span> B4<span class="token punctuation">:</span>96<span class="token punctuation">:</span>91<span class="token punctuation">:</span>A7<span class="token punctuation">:</span>3F<span class="token punctuation">:</span>D6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="生成-inventory-文件"><a href="#生成-inventory-文件" class="headerlink" title="生成 inventory 文件"></a>生成 inventory 文件</h3><p>在 <a href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/tools.sh">tools.sh</a> 脚本中通过 <a href="https://github.com/mikefarah/yq">yq</a> 命令行工具解析 <code>config.yaml</code> 配置文件，得到每台主机的配置信息，并根据该信息生成一个 ansible 的 inventory 文件</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">rendder_host_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token variable">$1</span>    <span class="token assign-left variable">vendor</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq <span class="token parameter variable">-e</span> <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].ipmi.vendor"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">os_disk</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>yq <span class="token parameter variable">-e</span> <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.esxi_disk"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>"</span>    <span class="token assign-left variable">esxi_mgtnic</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq <span class="token parameter variable">-e</span> <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.mgtnic"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">esxi_address</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq <span class="token parameter variable">-e</span> <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.address"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">esxi_gateway</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq <span class="token parameter variable">-e</span> <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.gateway"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">esxi_netmask</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq <span class="token parameter variable">-e</span> <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.netmask"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">esxi_password</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq <span class="token parameter variable">-e</span> <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.password"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">ipmi_address</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq <span class="token parameter variable">-e</span> <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].ipmi.address"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">ipmi_username</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq <span class="token parameter variable">-e</span> <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].ipmi.username"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">ipmi_password</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq <span class="token parameter variable">-e</span> <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].ipmi.password"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">esxi_hostname</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>yq <span class="token parameter variable">-e</span> <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.hostname"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span> /dev/null <span class="token operator">||</span> <span class="token boolean">true</span><span class="token variable">)</span></span>"</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function-name function">gen_inventory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> <span class="token variable">$&#123;INVENTORY&#125;</span></span>_hpe__dell__lenovo_[all:children]hpedelllenovoEOF</span>    <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">0</span> `expr $<span class="token punctuation">&#123;</span>nums<span class="token punctuation">&#125;</span> - <span class="token number">1</span>`<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>        rendder_host_info <span class="token variable">$&#123;i&#125;</span>        <span class="token assign-left variable">host_info</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;ipmi_address&#125;</span> username=<span class="token variable">$&#123;ipmi_username&#125;</span> password=<span class="token variable">$&#123;ipmi_password&#125;</span> esxi_address=<span class="token variable">$&#123;esxi_address&#125;</span> esxi_password=<span class="token variable">$&#123;esxi_password&#125;</span>"</span>        <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"/_<span class="token variable">$&#123;vendor&#125;</span>_/a <span class="token variable">$&#123;host_info&#125;</span>"</span> <span class="token variable">$&#123;INVENTORY&#125;</span>    <span class="token keyword">done</span>    <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s#^_dell_#[dell]#g;s#^_lenovo_#[lenovo]#g;s#_hpe_#[hpe]#g"</span> <span class="token variable">$&#123;INVENTORY&#125;</span>    <span class="token builtin class-name">echo</span> <span class="token string">"gen inventory success"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>生成后的 inventory 文件内容如下，根据不同的厂商名称进行分组</p><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">hpe</span><span class="token punctuation">]</span></span><span class="token key attr-name">10.172.18.191 username</span><span class="token punctuation">=</span><span class="token value attr-value">username password=password esxi_address=10.172.18.95 esxi_password=password</span><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">dell</span><span class="token punctuation">]</span></span><span class="token key attr-name">10.172.18.192 username</span><span class="token punctuation">=</span><span class="token value attr-value">username password=password esxi_address=10.172.18.96 esxi_password=password</span><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">lenovo</span><span class="token punctuation">]</span></span><span class="token key attr-name">10.172.18.193 username</span><span class="token punctuation">=</span><span class="token value attr-value">username password=password esxi_address=10.172.18.97 esxi_password=password</span><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">all:children</span><span class="token punctuation">]</span></span>hpedelllenovo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="检查-Redfish-登录是否正常"><a href="#检查-Redfish-登录是否正常" class="headerlink" title="检查 Redfish 登录是否正常"></a>检查 Redfish 登录是否正常</h3><p>通过 Redfish 的 GetSystemInventory 命令获取服务器的 inventory 清单来检查登录 Redfish 是否正常，用户名或密码是否正确。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Getting system inventory  <span class="token key atrule">community.general.redfish_info</span><span class="token punctuation">:</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> Systems    <span class="token key atrule">command</span><span class="token punctuation">:</span> GetSystemInventory    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="生成-kickstart-文件"><a href="#生成-kickstart-文件" class="headerlink" title="生成 kickstart 文件"></a>生成 kickstart 文件</h3><p>在 <a href="">tools.sh</a> 同样使用 yq 命令行工具渲染配置文件，得到每台主机的配置信息，为每台主机生成一个特定的 kickstart 文件。</p><p>在 kickstart 文件中我们我们可以通过 <code>install --overwritevmfs --firstdisk=&quot;$&#123;ESXI_DISK&#125;&quot;</code> 配置 ESXi OS 安装在哪一块硬盘上；</p><p>通过 <code>network --bootproto=static</code> 为 ESXi 管理网络配置静态 IP、子网掩码、网关、主机名、物理网卡等参数。需要注意的是，如果使用 MAC 地址指定网卡，MAC 地址必须为大写，因此需要使用 tr 进行了一下大小写转换；</p><p>通过 <code>clearpart --alldrives --overwritevmfs</code> 可以清除所有硬盘上的分区，我们安装时一般是将它们全部清理掉，方便进行测试；</p><p>最后再开启 SSH 服务并开启 sshServer 的防火墙，方便后续测试使用；</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">gen_iso_ks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">ISO_KS</span><span class="token operator">=</span><span class="token variable">$1</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">ESXI_DISK</span><span class="token operator">=</span><span class="token variable">$&#123;os_disk&#125;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">IP_ADDRESS</span><span class="token operator">=</span><span class="token variable">$&#123;esxi_address&#125;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">NETMASK</span><span class="token operator">=</span><span class="token variable">$&#123;esxi_netmask&#125;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">GATEWAY</span><span class="token operator">=</span><span class="token variable">$&#123;esxi_gateway&#125;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">DNS_SERVER</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;GATEWAY&#125;</span>"</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">PASSWORD</span><span class="token operator">=</span><span class="token variable">$&#123;esxi_password&#125;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable"><span class="token environment constant">HOSTNAME</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $<span class="token punctuation">&#123;</span>esxi_hostname<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">"s/null/esxi-<span class="token variable">$&#123;esxi_address<span class="token operator">/</span><span class="token operator">/</span>.<span class="token operator">/</span>-&#125;</span>/"</span><span class="token variable">)</span></span>"</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">MGTNIC</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $<span class="token punctuation">&#123;</span>esxi_mgtnic<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">'[a-z]'</span> <span class="token string">'[A-Z]'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/VMNIC/vmnic/g'</span><span class="token variable">)</span></span>    <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> <span class="token variable">$&#123;ISO_KS&#125;</span></span>vmaccepteula# Set the root password for the DCUI and Tech Support Moderootpw <span class="token variable">$&#123;PASSWORD&#125;</span># Set the keyboardkeyboard 'US Default'# wipe exisiting VMFS store # CAREFUL!clearpart --alldrives --overwritevmfs# Install on the first local disk available on machineinstall --overwritevmfs --firstdisk="<span class="token variable">$&#123;ESXI_DISK&#125;</span>"# Set the network to DHCP on the first network adapternetwork --bootproto=static --hostname=<span class="token variable">$&#123;<span class="token environment constant">HOSTNAME</span>&#125;</span> --ip=<span class="token variable">$&#123;IP_ADDRESS&#125;</span> --gateway=<span class="token variable">$&#123;GATEWAY&#125;</span> --nameserver=<span class="token variable">$&#123;DNS_SERVER&#125;</span> --netmask=<span class="token variable">$&#123;NETMASK&#125;</span> --device="<span class="token variable">$&#123;MGTNIC&#125;</span>"reboot%firstboot --interpreter=busybox# Enable SSHvim-cmd hostsvc/enable_sshvim-cmd hostsvc/start_sshesxcli network firewall ruleset set --enabled=false --ruleset-id=sshServerEOF</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="重新构建-ESXi-ISO"><a href="#重新构建-ESXi-ISO" class="headerlink" title="重新构建 ESXi ISO"></a>重新构建 ESXi ISO</h3><p>这一步的操作主要是修改 ESXi ISO 的启动项配置，配置 ks 文件的路径，主要是修改 ISO 文件里的 <code> boot.cfg</code> 和 <code>efi/boot/boot.cfg</code> 文件。在启动参数中加入 <code>ks=cdrom:/KS.CFG</code> 用于指定 ESXi OS 安装通过读取 kickstart 脚本的方式来完成。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> boot.cfg<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> efi/boot/boot.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>另外在 VMware 的 KB <a href="https://kb.vmware.com/s/article/81166">Boot option to configure the size of ESXi system partitions (81166)</a> 中，提到过可以设置 <code>systemMediaSize=small</code> 来调整 VMFS-L 分区的大小。ESXi 7.0 版本之后会默认创建一个 VMFS-L 分区，如果 SATA DOM 盘比较小的话比如只有 128G，建议设置此参数。不然可能会导致安装完 ESXi OS 之后磁盘剩余的空间都被 VMFS-L 分区给占用，导致没有一个本地的数据存储可以使用。</p><p>修改好 ESXi 的启动配置之后，我们再使用 genisoimage 命令重新构建一个 ESXi ISO 文件，将构建好的 ISO 文件放到一个 http 文件服务的目录下，如 nginx 的 <code>/usr/share/nginx/html/iso</code>。后面将会通过 http 的方式将 ISO 挂载到服务器的虚拟光驱上。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">rebuild_esxi_iso</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">dest_iso_mount_dir</span><span class="token operator">=</span><span class="token variable">$1</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">dest_iso_path</span><span class="token operator">=</span><span class="token variable">$2</span>    <span class="token function">pushd</span> <span class="token variable">$&#123;dest_iso_mount_dir&#125;</span> <span class="token operator">></span> /dev/null    <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> boot.cfg    <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> efi/boot/boot.cfg    genisoimage <span class="token parameter variable">-J</span> <span class="token punctuation">\</span>                <span class="token parameter variable">-R</span>  <span class="token punctuation">\</span>                <span class="token parameter variable">-o</span> <span class="token variable">$&#123;dest_iso_path&#125;</span> <span class="token punctuation">\</span>                -relaxed-filenames <span class="token punctuation">\</span>                <span class="token parameter variable">-b</span> isolinux.bin <span class="token punctuation">\</span>                <span class="token parameter variable">-c</span> boot.cat <span class="token punctuation">\</span>                -no-emul-boot <span class="token punctuation">\</span>                -boot-load-size <span class="token number">4</span> <span class="token punctuation">\</span>                -boot-info-table <span class="token punctuation">\</span>                -eltorito-alt-boot <span class="token punctuation">\</span>                -eltorito-boot efiboot.img <span class="token punctuation">\</span>                <span class="token parameter variable">-quiet</span> --no-emul-boot <span class="token punctuation">\</span>                <span class="token builtin class-name">.</span> <span class="token operator">></span> /dev/null  <span class="token function">popd</span> <span class="token operator">></span> /dev/null<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>重新构建好 ESXi ISO 之后的 nginx 目录结构如下：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># tree /usr/share/nginx/html/iso/</span>/usr/share/nginx/html/iso/├── redfish│   ├── <span class="token number">172.20</span>.18.191│   │   └── VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="token comment"># 重新构建的 ISO</span>│   ├── <span class="token number">172.20</span>.18.192│   │   └── VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="token comment"># 重新构建的 ISO</span>│   ├── <span class="token number">172.20</span>.18.193│   │   └── VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="token comment"># 重新构建的 ISO</span>│   └── <span class="token number">172.20</span>.70.186│       └── VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="token comment"># 重新构建的 ISO</span>├── VMware-VMvisor-Installer-6.7.0.update03-14320388.x86_64.iso <span class="token comment"># 原 ISO</span>├── VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso         <span class="token comment"># 原 ISO</span>└── VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso         <span class="token comment"># 原 ISO</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="通过-redfish-弹出已有的-Virtual-Media"><a href="#通过-redfish-弹出已有的-Virtual-Media" class="headerlink" title="通过 redfish 弹出已有的 Virtual Media"></a>通过 redfish 弹出已有的 Virtual Media</h3><p>redfish 插入&#x2F;弹出 ISO 操作有现成可用的 ansible 模块可以使用，不必重复造轮子。不同的服务器厂商调用的模块可能会有所不同，不过参数基本上是相同的。</p><p>如果当前服务器上已经挂载了一些其他的 ISO，要将他们全部弹出才行，不然在挂载 ISO 的时候会失败退出，并且也能避免多个 ISO 重启启动的时候引起冲突启动到另一个 ISO 中。</p><ul><li>联想服务器的 VirtualMediaEject 命令可以弹出所有的 ISO</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Lenovo <span class="token punctuation">|</span> Eject all Virtual Media  <span class="token key atrule">community.general.xcc_redfish_command</span><span class="token punctuation">:</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> Manager    <span class="token key atrule">command</span><span class="token punctuation">:</span> VirtualMediaEject    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">resource_id</span><span class="token punctuation">:</span> <span class="token string">"1"</span>  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso  <span class="token punctuation">-</span> umount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>戴尔和 HPE 服务器在弹出 ISO 的时候需要先知道原有 ISO 的 URL。因此先通过 <code>GetVirtualMedia</code> 命令获取到一个 ISO 的 URL 列表，然后再根据这个列表一一弹出。</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get virtual media details  <span class="token key atrule">community.general.redfish_info</span><span class="token punctuation">:</span>    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"GetVirtualMedia"</span>  <span class="token key atrule">register</span><span class="token punctuation">:</span> result  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso  <span class="token punctuation">-</span> umount<span class="token punctuation">-</span>iso  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Eject virtual media  <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"VirtualMediaEject"</span>    <span class="token key atrule">virtual_media</span><span class="token punctuation">:</span>      <span class="token key atrule">image_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; item &#125;&#125;"</span>  <span class="token key atrule">with_items</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; result.redfish_facts.virtual_media.entries[0][1] | selectattr('ConnectedVia', 'equalto','URI') | map(attribute='Image') | list &#125;&#125;"</span>  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso  <span class="token punctuation">-</span> umount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在弹出一个 ISO 的时候需要先知道 ISO 的 URL，感觉有点奇葩 😂。更合理的应该是需要一个挂载点的标识，就像比 Linux 上的挂载点。在 umount 挂载的设备时，只需要知道挂载点即可，不需要知道挂载的设备是什么。在 ISSUE <a href="https://github.com/ansible-collections/community.general/issues/3042">VirtualMediaEject should not require image_url </a> 中有大佬反馈过在弹出 ISO 的时候不应该需要 image url，不过被 maintainer 给否决了 😅。</p><blockquote><p>Yes, at least with the behavior we’ve implemented today the image URL is needed since the expectation is the user is specifying the image URL for the ISO to eject. I think we need to consider some things first before making changes.</p><p>If the image URL is not given, then what exactly should be ejected? All virtual media your example indicates? This seems a bit heavy handed in my opinion, but others might like this behavior. Redfish itself doesn’t support an “eject all” type of operation, and I suspect the script you’re referencing is either using OEM actions or is just looping on all slots and ejecting everything.</p><p>Should a user be allowed specify an alternative identifier (such as the “Id” of the virtual media instance) in order to control what slot is ejected?</p><p>Certainly would like opinions from others for desired behavior. I do like the idea of keeping the mandatory argument list as minimal as possible, but would like to agree upon the desired behavior first.</p></blockquote><h3 id="通过-Redfish-插入-ISO"><a href="#通过-Redfish-插入-ISO" class="headerlink" title="通过 Redfish 插入 ISO"></a>通过 Redfish 插入 ISO</h3><ul><li>联想服务器使用的是 <code>community.general.xcc_redfish_command</code> 模块，redfish 的 command 为 VirtualMediaInsert；</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Lenovo <span class="token punctuation">|</span> Insert <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> image_url <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> Virtual Media  <span class="token key atrule">community.general.xcc_redfish_command</span><span class="token punctuation">:</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> Manager    <span class="token key atrule">command</span><span class="token punctuation">:</span> VirtualMediaInsert    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">virtual_media</span><span class="token punctuation">:</span>      <span class="token key atrule">image_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; image_url &#125;&#125;"</span>      <span class="token key atrule">media_types</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> CD        <span class="token punctuation">-</span> DVD    <span class="token key atrule">resource_id</span><span class="token punctuation">:</span> <span class="token string">"1"</span>  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>戴尔和 HPE 服务器挂载 ISO 使用的则是 <code>community.general.redfish_command</code> 模块，command 和联想的相同；</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Insert <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> image_url <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO as virtual media device <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>   <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>   <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>   <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>   <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>   <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"VirtualMediaInsert"</span>   <span class="token key atrule">virtual_media</span><span class="token punctuation">:</span>     <span class="token key atrule">image_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; image_url &#125;&#125;"</span>     <span class="token key atrule">media_types</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> CD       <span class="token punctuation">-</span> DVD <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要注意的是：如果使用 <code>community.general.redfish_command</code> 模块为联想的服务器挂载 ISO 会提示 4xx 错误，必须使用 <code>community.general.xcc_redfish_command</code> 模块才行。</p><h3 id="设置启动项为虚拟光驱"><a href="#设置启动项为虚拟光驱" class="headerlink" title="设置启动项为虚拟光驱"></a>设置启动项为虚拟光驱</h3><p>此过程是将服务器的启动项设置为虚拟光驱，不同厂商的服务器调用的 ansible 模块可能也会有所不同。</p><ul><li>联想和 HPE 服务器</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set one<span class="token punctuation">-</span>time boot device to <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> bootdevice <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> Systems    <span class="token key atrule">command</span><span class="token punctuation">:</span> SetOneTimeBoot    <span class="token key atrule">bootdevice</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; bootdevice &#125;&#125;"</span>    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">20</span>  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'dell'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>戴尔服务器</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>  Dell <span class="token punctuation">|</span> set iDRAC attribute for one<span class="token punctuation">-</span>time boot from virtual CD  <span class="token key atrule">community.general.idrac_redfish_config</span><span class="token punctuation">:</span>    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"SetManagerAttributes"</span>    <span class="token key atrule">manager_attributes</span><span class="token punctuation">:</span>      <span class="token key atrule">ServerBoot.1.BootOnce</span><span class="token punctuation">:</span> <span class="token string">"Enabled"</span>      <span class="token key atrule">ServerBoot.1.FirstBootDevice</span><span class="token punctuation">:</span> <span class="token string">"VCD-DVD"</span>  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname in groups<span class="token punctuation">[</span><span class="token string">'dell'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="重启服务器"><a href="#重启服务器" class="headerlink" title="重启服务器"></a>重启服务器</h3><p>重启服务器直接调用 <code>community.general.redfish_command</code> 模块就可以。不过需要注意的是，重启服务器之前要保证服务器当前状态为开启状态，因此调用一下 redfish 的 PowerOn 命令对服务器进行开机，如果已处于开机状态则无影响，然后再调用 PowerForceRestart 命令重启服务器。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">name</span><span class="token punctuation">:</span> Power Force Restart the host  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Turn system power on    <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>      <span class="token key atrule">category</span><span class="token punctuation">:</span> Systems      <span class="token key atrule">command</span><span class="token punctuation">:</span> PowerOn      <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>      <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Reboot system    <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>      <span class="token key atrule">category</span><span class="token punctuation">:</span> Systems      <span class="token key atrule">command</span><span class="token punctuation">:</span> PowerForceRestart      <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>      <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">20</span>  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> reboot<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里还有优化的空间，就是根据电源的状态决定是重启还是开机，不过有点麻烦懒得弄了 😅</p><h3 id="等待-ESXi-OS-安装完成"><a href="#等待-ESXi-OS-安装完成" class="headerlink" title="等待 ESXi OS 安装完成"></a>等待 ESXi OS 安装完成</h3><p>服务器重启之后，我们通过 govc 命令不断尝试连接 ESXi 主机，如果能够正常连接则说明 ESXi OS 已经安装完成了。一般情况下等待 15 分钟左右就能安装完成，期间需要重启服务器两次，每次重启大概需要 5 分钟左右，实际上 ESXi 进入安装页面到安装完成只需要 5 分钟左右，服务器开机自检占用的时间会稍微长一点。</p><p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-03.png" alt="image-20220428210819057"></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">name</span><span class="token punctuation">:</span> Wait for the ESXi OS installation to complete  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">vars</span><span class="token punctuation">:</span>    <span class="token key atrule">esxi_username</span><span class="token punctuation">:</span> <span class="token string">"root"</span>    <span class="token key atrule">govc_url</span><span class="token punctuation">:</span> <span class="token string">"https://&#123;&#123; esxi_username &#125;&#125;:&#123;&#123; esxi_password &#125;&#125;@&#123;&#123; esxi_address &#125;&#125;"</span>  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"Wait for &#123;&#123; inventory_hostname &#125;&#125; install ESXi &#123;&#123; esxi_address &#125;&#125; host to be complete"</span>    <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">"govc about -k=true -u=&#123;&#123; govc_url&#125;&#125;"</span>    <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">60</span>    <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token number">30</span>    <span class="token key atrule">register</span><span class="token punctuation">:</span> result    <span class="token key atrule">until</span><span class="token punctuation">:</span> result.rc == 0  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> post<span class="token punctuation">-</span>check<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Makefile-封装"><a href="#Makefile-封装" class="headerlink" title="Makefile 封装"></a>Makefile 封装</h2><p>为了方便操作，将上述流程使用 Makefile 进行封装一下，如果不配置 Jenkins Job 的话，可以在本地填写好 <code>config.yaml</code> 配置文件，然后运行 make 命令来进行相关操作。</p><h3 id="vars"><a href="#vars" class="headerlink" title="vars"></a>vars</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">SRC_ISO_DIR     ?<span class="token operator">=</span> /usr/share/nginx/html/isoHTTP_DIR        ?<span class="token operator">=</span> /usr/share/nginx/html/iso/redfishHTTP_URL        ?<span class="token operator">=</span> http://172.20.17.20/iso/redfishESXI_ISO        ?<span class="token operator">=</span> VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.isoSRC_ISO_DIR   <span class="token comment"># 原 ESXi ISO 的存放目录</span>ESXI_ISO      <span class="token comment"># ESXi ISO 的文件名，如 VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso</span>HTTP_DIR      <span class="token comment"># HTTP 服务器的静态文件存放目录，比如 /usr/share/nginx/html 或 /var/www/html</span>              <span class="token comment"># 重新构建好的 ISO 文件将存放到这个目录当中</span>HTTP_URL      <span class="token comment"># HTTP 服务器的 URL 地址，比如 http://172.20.29.171/iso/redfish</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="target"><a href="#target" class="headerlink" title="target"></a>target</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">make docke<span class="token punctuation">-</span>run  <span class="token comment"># 在 docker 容器里运行所有操作，好处就是不用再安装一堆 ansible 等工具的依赖</span>make inventory  <span class="token comment"># 根据 config.yaml 配置文件生成 ansible 的 inventory 文件</span>make pre<span class="token punctuation">-</span>check  <span class="token comment"># 检查生成的 inventory 文件是否正确，连接 redfish 是否正常</span>make build<span class="token punctuation">-</span>iso  <span class="token comment"># 为每台主机生成 kickstart 文件并重新构建 ESXi OS ISO 文件</span>make mount<span class="token punctuation">-</span>iso  <span class="token comment"># 将构建好的 ISO 文件通过 redfish 挂载到物理服务器的虚拟光驱，并设备启动项</span>make reboot     <span class="token comment"># 重启服务器，进入到虚拟光驱启动 ESXi inatller</span>make post<span class="token punctuation">-</span>check <span class="token comment"># 等待 ESXi OS 安装完成</span>make install<span class="token punctuation">-</span>os <span class="token comment"># 运行 pre-check, mount-iso, reboot, post-check</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Jenkins-Job"><a href="#Jenkins-Job" class="headerlink" title="Jenkins Job"></a>Jenkins Job</h2><p>虽然在 Makefile 里封装了比较方便的命令操作，但是对于不太熟悉这套流程的使用人员来讲还是不够便捷。对于使用人员来讲不需要知道具体的流程是什么，因此还需要提供一个更为便捷的入口来使用这套工具，对外屏蔽掉技术实现的细节。</p><p>在我们内部，老牌 CI 工具 Jenkins 大叔十分受欢迎，使用的十分普遍。之前同事也常调侃：<code>我们内部的 Jenkins 虽然达不到人手一个的数量，但每个团队有两三个自己的 Jenkins 再正常不过了</code>🤣。因此提供了一个 Jenkins Job 来运行这套安装工具再完美不过了。这样使用人员就不用再 clone repo 代码，傻乎乎地运行一些 make 命令了，毕竟一个 Jenkins build 的按钮比 make 命令好好用得太多。</p><p>我们组的 Jenkins 比较特殊，是使用 kubernetes Pod 作为动态 Jenkins slave 节点，即每运行一个 Jenkins Job 就会根据定义的 Pod 模版创建一个 Pod 到指定的 Kubernetes 集群中，然后 Jenkinsfile 中定义的 stage 都会运行在这个 Pod 容器内。这些内容可以参考一下我之前写的 <a href="https://blog.k8s.li/jenkins-with-kubernetes.html">Jenkins 大叔与 kubernetes 船长手牵手 🧑‍🤝‍🧑</a>。</p><h3 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h3><p>如果你熟悉 Jenkins 的话，可以创建一个 Jenkins Job ，并在 Job 中设置好如下几个参数，并将这个 <a href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/jenkins/Jenkinsfile">Jenkinsfile</a> 中的内容复制到 Jenkins Job 的配置中。</p><table><thead><tr><th>参数名</th><th>参数类型</th><th>说明</th></tr></thead><tbody><tr><td>esxi_iso</td><td>ArrayList</td><td>ESXi ISO 文件名列表</td></tr><tr><td>http_server</td><td>String</td><td>HTTP 服务器的 IP 地址</td></tr><tr><td>http_dir</td><td>String</td><td>HTTP 服务器的文件目录路径</td></tr><tr><td>config_yaml</td><td>Text</td><td>config.yaml 配置文件内容</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// params of jenkins jobdef ESXI_ISO <span class="token operator">=</span> params.esxi_isodef CONFIG_YAML <span class="token operator">=</span> params.config_yamldef HTTP_SERVER <span class="token operator">=</span> params.http_server// default params <span class="token keyword">for</span> the jobdef HTTP_DIR  <span class="token operator">=</span> params.http_dir ?: <span class="token string">"/usr/share/nginx/html"</span>def SRC_ISO_DIR <span class="token operator">=</span> params.src_iso_dir ?: <span class="token string">"<span class="token variable">$&#123;HTTP_DIR&#125;</span>/iso"</span>def DEST_ISO_DIR <span class="token operator">=</span> params.dest_iso_dir ?: <span class="token string">"<span class="token variable">$&#123;HTTP_DIR&#125;</span>/iso/redfish"</span>def WORKSPACE <span class="token operator">=</span> env.WORKSPACEdef JOB_NAME <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;env.JOB_BASE_NAME&#125;</span>"</span>def BUILD_NUMBER <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;env.BUILD_NUMBER&#125;</span>"</span>def POD_NAME <span class="token operator">=</span> <span class="token string">"jenkins-<span class="token variable">$&#123;JOB_NAME&#125;</span>-<span class="token variable">$&#123;BUILD_NUMBER&#125;</span>"</span>def POD_IMAGE <span class="token operator">=</span> params.pod_image ?: <span class="token string">"ghcr.io/muzi502/redfish-esxi-os-installer:v0.1.0-alpha.1"</span>// Kubernetes pod template to run.podTemplate<span class="token punctuation">(</span>    cloud: <span class="token string">"kubernetes"</span>,    namespace: <span class="token string">"default"</span>,    name: POD_NAME,    label: POD_NAME,    yaml: <span class="token string">""</span>"apiVersion: v1kind: Podspec:  containers:  - name: runner    image: <span class="token variable">$&#123;POD_IMAGE&#125;</span>    imagePullPolicy: Always    tty: <span class="token boolean">true</span>    volumeMounts:    - name: http-dir      mountPath: <span class="token variable">$&#123;HTTP_DIR&#125;</span>    securityContext:      privileged: <span class="token boolean">true</span>    env:    - name: ESXI_ISO      value: <span class="token variable">$&#123;ESXI_ISO&#125;</span>    - name: SRC_ISO_DIR      value: <span class="token variable">$&#123;SRC_ISO_DIR&#125;</span>    - name: HTTP_DIR      value: <span class="token variable">$&#123;DEST_ISO_DIR&#125;</span>    - name: HTTP_URL      value: http://<span class="token variable">$&#123;HTTP_SERVER&#125;</span>/iso/redfish  - name: jnlp    args: <span class="token punctuation">[</span><span class="token string">"\<span class="token variable"><span class="token variable">$(</span>JENKINS_SECRET<span class="token variable">)</span></span>"</span>, <span class="token string">"\<span class="token variable"><span class="token variable">$(</span>JENKINS_NAME<span class="token variable">)</span></span>"</span><span class="token punctuation">]</span>    image: <span class="token string">"jenkins/inbound-agent:4.11.2-4-alpine"</span>    imagePullPolicy: IfNotPresent  volumes:  - name: http-dir    nfs:      server: <span class="token variable">$&#123;HTTP_SERVER&#125;</span>      path: <span class="token variable">$&#123;HTTP_DIR&#125;</span><span class="token string">""</span>",<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    node<span class="token punctuation">(</span>POD_NAME<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        try <span class="token punctuation">&#123;</span>            container<span class="token punctuation">(</span><span class="token string">"runner"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                writeFile file: <span class="token string">'config.yaml'</span>, text: <span class="token string">"<span class="token variable">$&#123;CONFIG_YAML&#125;</span>"</span>                stage<span class="token punctuation">(</span><span class="token string">"Inventory"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">sh</span> <span class="token string">""</span>"                    <span class="token function">cp</span> <span class="token parameter variable">-rf</span> /ansible/* <span class="token builtin class-name">.</span>                    <span class="token function">make</span> inventory                    <span class="token string">""</span>"                <span class="token punctuation">&#125;</span>                stage<span class="token punctuation">(</span><span class="token string">"Precheck"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">sh</span> <span class="token string">""</span>"                    <span class="token function">make</span> pre-check                    <span class="token string">""</span>"                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>params.build_iso<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    stage<span class="token punctuation">(</span><span class="token string">"Build-iso"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token function">sh</span> <span class="token string">""</span>"                        <span class="token function">make</span> build-iso                        <span class="token string">""</span>"                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>                stage<span class="token punctuation">(</span><span class="token string">"Mount-iso"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">sh</span> <span class="token string">""</span>"                    <span class="token function">make</span> mount-iso                    <span class="token string">""</span>"                <span class="token punctuation">&#125;</span>                stage<span class="token punctuation">(</span><span class="token string">"Reboot"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">sh</span> <span class="token string">""</span>"                    <span class="token function">make</span> <span class="token function">reboot</span>                    <span class="token function">sleep</span> <span class="token number">60</span>                    <span class="token string">""</span>"                <span class="token punctuation">&#125;</span>                stage<span class="token punctuation">(</span><span class="token string">"Postcheck"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">sh</span> <span class="token string">""</span>"                    <span class="token function">make</span> post-check                    <span class="token string">""</span>"                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            stage<span class="token punctuation">(</span><span class="token string">"Success"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                MESSAGE <span class="token operator">=</span> <span class="token string">"【Succeed】Jenkins Job <span class="token variable">$&#123;JOB_NAME&#125;</span>-<span class="token variable">$&#123;BUILD_NUMBER&#125;</span> Link: <span class="token variable">$&#123;BUILD_URL&#125;</span>"</span>                // slackSend<span class="token punctuation">(</span>channel: <span class="token string">'$&#123;SLACK_CHANNE&#125;'</span>, color: <span class="token string">'good'</span>, message: <span class="token string">"<span class="token variable">$&#123;MESSAGE&#125;</span>"</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> catch <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            MESSAGE <span class="token operator">=</span> <span class="token string">"【Failed】Jenkins Job <span class="token variable">$&#123;JOB_NAME&#125;</span>-<span class="token variable">$&#123;BUILD_NUMBER&#125;</span> Link: <span class="token variable">$&#123;BUILD_URL&#125;</span>"</span>            // slackSend<span class="token punctuation">(</span>channel: <span class="token string">'$&#123;SLACK_CHANNE&#125;'</span>, color: <span class="token string">'warning'</span>, message: <span class="token string">"<span class="token variable">$&#123;MESSAGE&#125;</span>"</span><span class="token punctuation">)</span>            throw e        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>或者参考 <a href="https://stackoverflow.com/questions/8424228/export-import-jobs-in-jenkins">Export&#x2F;import jobs in Jenkins</a> 将这个 <a href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/jenkins/config.xml">Job</a> 的配置导入到 Jenkins 当中，并设置好上面提到的几个参数。</p><p><img data-src="https://p.k8s.li/2022-04-30-redfish-esxi-os-installer-07.png" alt="image-20220429201859704"></p><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="硬件信息收集"><a href="#硬件信息收集" class="headerlink" title="硬件信息收集"></a>硬件信息收集</h3><p>整体上该方案有一点不足的就是需要人为地确认 ESXi OS 安装硬盘的型号&#x2F;序列号，以及 ESXi 管理网络所使用的物理网卡。其实是可以通过 redfish 的 API 来统一地获取，然后再根据这些硬件设备信息进行选择，这样就不用登录到每一台物理服务器上进行查看了。</p><p>但考虑到实现成本，工作量会翻倍，而且我们的服务器都是固定的，只要人为确认一次就可以，下一次重装 ESXi OS 的时候只需要复制粘贴上一次的硬件配置即可，所以目前并没有打算做获取硬件信息的功能。</p><p>而且即便是将硬件信息获取出来，如果没有一个可视化的 Web UI 展示这些设备信息，也很难从一堆硬件数据中找出特定的设备，对这些数据进行 UI 展示工作量也会翻倍，因此暂时不再考虑这个功能了。</p><h3 id="挂载-ISO-之前先确保-ISO-存在"><a href="#挂载-ISO-之前先确保-ISO-存在" class="headerlink" title="挂载 ISO 之前先确保 ISO 存在"></a>挂载 ISO 之前先确保 ISO 存在</h3><p>有些服务器比如 HPE 在挂载一个不存在的 ISO 时并不会报错，当时我排查了好久才发现 😂，我一直以为是启动项设置的问题。因此在挂载 ISO 之前我们可以通过 curl 的方式检查一下 ISO 的 URL 是否正确，如果 404 不存在的话就报错退出。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">name</span><span class="token punctuation">:</span> Mount  <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> image_url <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Check <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> image_url <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO file exists    <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">"curl -sI &#123;&#123; image_url &#125;&#125;"</span>    <span class="token key atrule">register</span><span class="token punctuation">:</span> response    <span class="token key atrule">failed_when</span><span class="token punctuation">:</span> <span class="token string">"'200 OK' not in response.stdout or '404 Not Found' in response.stdout"</span>    <span class="token key atrule">tags</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="单独构建-Kickstart-ISO"><a href="#单独构建-Kickstart-ISO" class="headerlink" title="单独构建 Kickstart ISO"></a>单独构建 Kickstart ISO</h3><p>目前的方案是为将 ESXi 的 kickstart 文件 KS.CFG 放到了 ESXi OS ISO 镜像里，由于每台主机的 kickstart 文件都不相同，这就需要为每台服务器构建一个 ISO 文件，如果机器数量比较多的话，可能会占用大量的磁盘存储空间，效率上会有些问题。也尝试过将 kickstart 文件单独放到一个 ISO 中，大体的思路如下：</p><ul><li>构建 kickstart ISO 文件，-V 参数指定 ISO 的 label 名称为 KS</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ genisoimage <span class="token parameter variable">-o</span> /tmp/ks.iso <span class="token parameter variable">-V</span> KS ks.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>修改 ESXi 启动配置，将 ks 文件路径通过 label 的方式指向刚才构建的 ISO</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">'s#cdromBoot#ks=hd:KS:/ks.cfg systemMediaSize=small#g'</span> boot.cfg$ <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token parameter variable">-e</span> <span class="token string">'s#cdromBoot#ks=hd:KS:/ks.cfg systemMediaSize=small#g'</span> efi/boot/boot.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>修改一下 playbook，插入两个 ISO</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Insert <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO as virtual media device  <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"VirtualMediaInsert"</span>    <span class="token key atrule">virtual_media</span><span class="token punctuation">:</span>      <span class="token key atrule">image_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; item &#125;&#125;"</span>      <span class="token key atrule">media_types</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> CD        <span class="token punctuation">-</span> DVD  <span class="token key atrule">with_items</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">"&#123;&#123; esxi_iso_url &#125;&#125;"</span>  <span class="token punctuation">-</span> <span class="token string">"&#123;&#123; ks_iso_url &#125;&#125;"</span>  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>等这些都修改好之后我满怀期待地运行了 make mount-iso 命令等到奇迹的发生，没想到直接翻车了！不支持挂载两个 ISO，白白高兴一场，真气人 😡</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">TASK <span class="token punctuation">[</span>Insert <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO as virtual media device<span class="token punctuation">]</span> <span class="token important">******************************************************************************************</span><span class="token key atrule">changed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.191<span class="token punctuation">]</span> =<span class="token punctuation">></span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/VMware<span class="token punctuation">-</span>VMvisor<span class="token punctuation">-</span>Installer<span class="token punctuation">-</span>7.0U3d<span class="token punctuation">-</span>19482537.x86_64.iso)<span class="token key atrule">changed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.192<span class="token punctuation">]</span> =<span class="token punctuation">></span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/VMware<span class="token punctuation">-</span>VMvisor<span class="token punctuation">-</span>Installer<span class="token punctuation">-</span>7.0U3d<span class="token punctuation">-</span>19482537.x86_64.iso)<span class="token key atrule">changed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.193<span class="token punctuation">]</span> =<span class="token punctuation">></span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/VMware<span class="token punctuation">-</span>VMvisor<span class="token punctuation">-</span>Installer<span class="token punctuation">-</span>7.0U3d<span class="token punctuation">-</span>19482537.x86_64.iso)<span class="token key atrule">failed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.193<span class="token punctuation">]</span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/10.172.18.193/ks.iso) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span><span class="token key atrule">"ansible_loop_var"</span><span class="token punctuation">:</span> <span class="token string">"item"</span><span class="token punctuation">,</span> <span class="token key atrule">"changed"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">"item"</span><span class="token punctuation">:</span> <span class="token string">"http://10.172.29.171/iso/redfish/10.172.18.193/ks.iso"</span><span class="token punctuation">,</span> <span class="token key atrule">"msg"</span><span class="token punctuation">:</span> <span class="token string">"Unable to find an available VirtualMedia resource supporting ['CD', 'DVD']"</span><span class="token punctuation">&#125;</span><span class="token key atrule">failed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.192<span class="token punctuation">]</span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/10.172.18.192/ks.iso) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span><span class="token key atrule">"ansible_loop_var"</span><span class="token punctuation">:</span> <span class="token string">"item"</span><span class="token punctuation">,</span> <span class="token key atrule">"changed"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">"item"</span><span class="token punctuation">:</span> <span class="token string">"http://10.172.29.171/iso/redfish/10.172.18.192/ks.iso"</span><span class="token punctuation">,</span> <span class="token key atrule">"msg"</span><span class="token punctuation">:</span> <span class="token string">"Unable to find an available VirtualMedia resource supporting ['CD', 'DVD']"</span><span class="token punctuation">&#125;</span><span class="token key atrule">failed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.191<span class="token punctuation">]</span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/10.172.18.191/ks.iso) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span><span class="token key atrule">"ansible_loop_var"</span><span class="token punctuation">:</span> <span class="token string">"item"</span><span class="token punctuation">,</span> <span class="token key atrule">"changed"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">"item"</span><span class="token punctuation">:</span> <span class="token string">"http://10.172.29.171/iso/redfish/10.172.18.191/ks.iso"</span><span class="token punctuation">,</span> <span class="token key atrule">"msg"</span><span class="token punctuation">:</span> <span class="token string">"Unable to find an available VirtualMedia resource supporting ['CD', 'DVD']"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>或许将 ISO 替换成软盘  floppy  的方式可能行得通，不过当我看了 <a href="https://stackoverflow.com/questions/11202706/create-a-virtual-floppy-image-without-mount">create-a-virtual-floppy-image-without-mount</a> 后直接把我整不会了，没想创建一个软盘文件到这么麻烦，还是直接放弃该方案吧 🌚。</p><p>多说一句，之所以想到使用软盘的方式是因为之前在玩 <a href="https://github.com/hashicorp/packer">Packer</a> 的时候，研究过它就是将 kickstart 文件制作成一个软盘，插入到虚拟机中。虚拟机开机后通过 vCenter API 发送键盘输入，插入 kickstart 的路径，anaconda 执行自动化安装 OS。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating VM<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Customizing hardware<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Mounting ISO images<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding configuration parameters<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating floppy disk<span class="token punctuation">..</span>.    vsphere-iso-base: Copying files flatly from floppy_files    vsphere-iso-base: Done copying files from floppy_files    vsphere-iso-base: Collecting paths from floppy_dirs    vsphere-iso-base: Resulting paths from floppy_dirs <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>./kickstart/centos/http/<span class="token punctuation">]</span>    vsphere-iso-base: Recursively copying <span class="token builtin class-name">:</span> ./kickstart/centos/http/    vsphere-iso-base: Done copying paths from floppy_dirs    vsphere-iso-base: Copying files from floppy_content    vsphere-iso-base: Done copying files from floppy_content<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Uploading created floppy image<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding generated Floppy<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Set boot order temporary<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Power on VM<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting 15s <span class="token keyword">for</span> boot<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Typing boot command<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting <span class="token keyword">for</span> IP<span class="token punctuation">..</span>.root@devbox-fedora:/root <span class="token comment"># scp 192.168.24.43:/vmfs/volumes/Packer/base-os-centos7/packer-tmp-created-floppy.flp .</span>packer-tmp-created-floppy.flp                                                                                <span class="token number">100</span>% 1440KB  <span class="token number">89</span>.4MB/s   00:00root@devbox-fedora:/root <span class="token comment"># mount packer-tmp-created-floppy.flp /mnt</span>root@devbox-fedora:/root <span class="token comment"># readlink /dev/disk/by-label/packer</span><span class="token punctuation">..</span>/<span class="token punctuation">..</span>/loop2root@devbox-fedora:/root <span class="token comment"># df -h /mnt</span>Filesystem      Size  Used Avail Use% Mounted on/dev/loop2      <span class="token number">1</span>.4M   16K  <span class="token number">1</span>.4M   <span class="token number">2</span>% /mntroot@devbox-fedora:/root <span class="token comment">#</span>root@devbox-fedora:/root <span class="token comment"># ls /mnt</span>HTTProot@devbox-fedora:/root <span class="token comment"># ls /mnt/HTTP</span><span class="token number">7</span>root@devbox-fedora:/root <span class="token comment"># ls /mnt/HTTP/7</span>KS.CFG<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="通过-http-方式读取-kickstart"><a href="#通过-http-方式读取-kickstart" class="headerlink" title="通过 http 方式读取 kickstart"></a>通过 http 方式读取 kickstart</h3><p>不一定可行，在通过 http 方式读取 kickstart 文件之前，ESXi OS installer 需要有一个 IP 地址才行。如果服务器如果有多块网卡的话，就很难确定是否分配到一个 IP，使用默认 DHCP 的方式并不一定能获取到正确的 IP 地址。因此读取 kickstart 文件的方式还是建议使用 ISO 的方式，这样在安装 OS 时对网络环境无依赖，更稳定一些。</p><h3 id="支持其他-OS-的安装"><a href="#支持其他-OS-的安装" class="headerlink" title="支持其他 OS 的安装"></a>支持其他 OS 的安装</h3><p>目前该方案只支持 ESXi OS 的安装，其他 OS 的自动化安装其实原理是一样的。比如 CentOS 同样也是修改 kickstart 文件。如果要指定 OS 所安装的磁盘可以参考一下戴尔官方的一篇文档 <a href="https://www.dell.com/support/kbdoc/zh-hk/000177584/automating-operating-system-deployment-to-dell-boss-techniques-for-different-operating-systems">Automating Operating System Deployment to Dell BOSS – Techniques for Different Operating Systems</a> 。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">%include /tmp/bootdisk.cfg%pre<span class="token comment"># Use DELLBOSS device for OS install if present.</span><span class="token assign-left variable">BOSS_DEV</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">find</span> /dev <span class="token parameter variable">-name</span> <span class="token string">"*DELLBOSS*"</span> <span class="token parameter variable">-printf</span> %P<span class="token string">"<span class="token entity" title="\n">\n</span>"</span> <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token parameter variable">-v</span> <span class="token parameter variable">-e</span> part <span class="token parameter variable">-e</span> scsi<span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-1</span><span class="token variable">)</span></span><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$BOSS_DEV</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> ignoredisk --only-use<span class="token operator">=</span><span class="token string">"<span class="token variable">$BOSS_DEV</span>"</span> <span class="token operator">></span> /tmp/bootdisk.cfg<span class="token keyword">fi</span>%end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果要为某块物理网卡配置 IP 地址，可以根据 MAC 地址找到对应的物理网卡，然后将静态 IP 配置写入到网卡配置文件当中。比如 CentOS 在 kickstart 中为某块物理网卡配置静态 IP，可以采用如下方式：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">MAC_ADDRESS 在生成 kickstart 文件的时候根据 config.yaml 动态修改的<span class="token comment"># MAC_ADDRESS=B4:96:91:A7:3F:D6</span><span class="token comment"># 根据 MAC 地址获取到网卡设备的名称</span><span class="token assign-left variable">NIC</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token parameter variable">-l</span> $<span class="token punctuation">&#123;</span>MAC_ADDRESS<span class="token punctuation">&#125;</span> /sys/class/net/*/address <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">'/'</span> <span class="token string">'&#123;print $5&#125;'</span><span class="token variable">)</span></span><span class="token comment"># 将网卡静态 IP 配置写入到文件当中</span><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /etc/sysconfig/network-scripts/ifcfg-<span class="token variable">$&#123;NIC&#125;</span></span>TYPE=EhternetBOOTPROTO=staticDEFROUTE=yesNAME=<span class="token variable">$&#123;NIC&#125;</span>DEVICE=<span class="token variable">$&#123;NIC&#125;</span>ONBOOT=yesIPADDR=<span class="token variable">$&#123;IP&#125;</span>NETMASK=<span class="token variable">$&#123;NETMASK&#125;</span>GATEWAY=<span class="token variable">$&#123;GATEWAY&#125;</span>EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由于时间关系，在这里就不再进行深入讲解了，在这里只是提供一个方法和思路。至于 Debian&#x2F;Ubuntu 发行版，还是你们自己摸索吧，因为我工作中确实没有在物理服务器上安装这些发行版的场景，毕竟国内企业私有云环境中使用 CentOS&#x2F;RedHat 系列发行版的占绝大多数。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><h3 id="Redfish-相关"><a href="#Redfish-相关" class="headerlink" title="Redfish 相关"></a>Redfish 相关</h3><ul><li><a href="https://www.dmtf.org/standards/redfish">DMTF’s Redfish</a></li><li><a href="https://www.dmtf.org/sites/default/files/DSP2044%20Redfish%20%E7%99%BD%E7%9A%AE%E4%B9%A6%201.0.0.pdf">Redfish 白皮书</a></li><li><a href="https://wsgzao.github.io/post/redfish/">Redfish 下一代数据中心管理标准详解和实践</a></li><li><a href="https://github.com/dell/redfish-ansible-module">redfish-ansible-module</a></li><li><a href="https://github.com/lenovo/python-redfish-lenovo">python-redfish-lenovo</a></li><li><a href="https://docs.ansible.com/ansible/latest/collections/community/general/xcc_redfish_command_module.html">xcc_redfish_command module</a></li><li><a href="https://sysmgt.lenovofiles.com/help/index.jsp?topic=/com.lenovo.systems.management.xcc.doc/rest_api.html">Lenovo XClarity Controller Redfish REST API</a></li><li><a href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.esxi.upgrade.doc/GUID-61A14EBB-5CF3-43EE-87EF-DB8EC6D83698.html">Installation and Upgrade Script Commands</a></li><li><a href="https://www.hpe.com/psnow/doc/4AA6-1727ENW">Redfish API implementation on HPE servers with iLO RESTful API technical white paper</a></li><li><a href="https://github.com/ansible-collections/community.general/issues/3042">VirtualMediaEject should not require image_url </a></li></ul><h3 id="VMware-ESXi-相关"><a href="#VMware-ESXi-相关" class="headerlink" title="VMware ESXi 相关"></a>VMware ESXi 相关</h3><ul><li><a href="https://communities.vmware.com/t5/ESXi-Discussions/Reducing-Esxi-7-VMFSL/td-p/2808955">Reducing Esxi 7 VMFSL</a></li><li><a href="https://kb.vmware.com/s/article/1014953">Identifying disks when working with VMware ESXi (1014953)</a></li><li><a href="https://downloads.dell.com/manuals/all-products/esuprt_solutions_int/esuprt_solutions_int_solutions_resources/servers-solution-resources_white-papers10_en-us.pdf">PowerEdge Boot Optimized Storage Solution BOSS - Dell</a></li><li><a href="https://www.reddit.com/r/vmware/comments/2a5jv7/esxi_kickstart_script_to_grep_for_correct_lun/">ESXi Kickstart script to grep for correct LUN? (iSCSI, Boot from SAN)</a></li><li><a href="https://www.dell.com/support/kbdoc/zh-hk/000177584/automating-operating-system-deployment-to-dell-boss-techniques-for-different-operating-systems">Automating Operating System Deployment to Dell BOSS – Techniques for Different Operating Systems</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;从去年十一月底到现在一直在做在  &lt;a
        
      
    
    </summary>
    
    
      <category term="技术" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="ESXi" scheme="https://blog.k8s.li/tags/ESXi/"/>
    
      <category term="Redfish" scheme="https://blog.k8s.li/tags/Redfish/"/>
    
      <category term="Dell 服务器" scheme="https://blog.k8s.li/tags/Dell-%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
      <category term="HPE 服务器" scheme="https://blog.k8s.li/tags/HPE-%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
      <category term="Lenovo 服务器" scheme="https://blog.k8s.li/tags/Lenovo-%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
      <category term="裸金属服务器" scheme="https://blog.k8s.li/tags/%E8%A3%B8%E9%87%91%E5%B1%9E%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>搬砖工具 govc 使用记录</title>
    <link href="https://blog.k8s.li/govc-usage.html"/>
    <id>https://blog.k8s.li/govc-usage.html</id>
    <published>2022-03-30T16:00:00.000Z</published>
    <updated>2022-03-30T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近由于工作原因需要在 ESXi 主机上完成一些参数配置、虚拟交换机&#x2F;网创建、虚拟机创建、VIB 安装、PCI 直通、虚拟机创建等工作，于是抽空整理了一下在使用 govc 时踩的一些坑。</p><h2 id="govc"><a href="#govc" class="headerlink" title="govc"></a>govc</h2><p><a href="https://github.com/vmware/govmomi/tree/master/govc">govc</a> 是 VMware 官方 <a href="https://github.com/vmware/govmom">govmomi</a> 库的一个封装实现。使用它可以完成对 ESXi 主机或 vCenter 的一些操作。比如创建虚拟机、管理快照等。基本上能在 ESXi 或 vCenter 上的操作，在 govmomi 中都有对应的实现。目前 govc 支持的 ESXi &#x2F; vCenter 版本有 7.0, 6.7, 6.5 , 6.0 (5.x 版本太老了，干脆放弃吧)，另外也支持 VMware Workstation 的某些版本。</p><p>使用 govc 连接 ESXi 主机或 vCenter 可以通过设置环境变量或者命令行参数，建议使用环境变量，如果通过命令行 flag 的话，将明文规定用户名和密码输出来有一定的安全风险。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Options:  <span class="token parameter variable">-cert</span><span class="token operator">=</span>                           Certificate <span class="token punctuation">[</span>GOVC_CERTIFICATE<span class="token punctuation">]</span>  <span class="token parameter variable">-dc</span><span class="token operator">=</span>                             Datacenter <span class="token punctuation">[</span>GOVC_DATACENTER<span class="token punctuation">]</span>  <span class="token parameter variable">-debug</span><span class="token operator">=</span>false                     Store debug logs <span class="token punctuation">[</span>GOVC_DEBUG<span class="token punctuation">]</span>  <span class="token parameter variable">-dump</span><span class="token operator">=</span>false                      Enable Go output  <span class="token parameter variable">-host</span><span class="token operator">=</span>                           Host system <span class="token punctuation">[</span>GOVC_HOST<span class="token punctuation">]</span>  <span class="token parameter variable">-host.dns</span><span class="token operator">=</span>                       Find <span class="token function">host</span> by FQDN  <span class="token parameter variable">-host.ip</span><span class="token operator">=</span>                        Find <span class="token function">host</span> by IP address  <span class="token parameter variable">-host.ipath</span><span class="token operator">=</span>                     Find <span class="token function">host</span> by inventory path  <span class="token parameter variable">-host.uuid</span><span class="token operator">=</span>                      Find <span class="token function">host</span> by UUID  <span class="token parameter variable">-json</span><span class="token operator">=</span>false                      Enable JSON output  <span class="token parameter variable">-k</span><span class="token operator">=</span>false                         Skip verification of server certificate <span class="token punctuation">[</span>GOVC_INSECURE<span class="token punctuation">]</span>  <span class="token parameter variable">-key</span><span class="token operator">=</span>                            Private key <span class="token punctuation">[</span>GOVC_PRIVATE_KEY<span class="token punctuation">]</span>  -persist-session<span class="token operator">=</span>true            Persist session to disk <span class="token punctuation">[</span>GOVC_PERSIST_SESSION<span class="token punctuation">]</span>  -tls-ca-certs<span class="token operator">=</span>                   TLS CA certificates <span class="token function">file</span> <span class="token punctuation">[</span>GOVC_TLS_CA_CERTS<span class="token punctuation">]</span>  -tls-known-hosts<span class="token operator">=</span>                TLS known hosts <span class="token function">file</span> <span class="token punctuation">[</span>GOVC_TLS_KNOWN_HOSTS<span class="token punctuation">]</span>  <span class="token parameter variable">-trace</span><span class="token operator">=</span>false                     Write SOAP/REST traffic to stderr  <span class="token parameter variable">-u</span><span class="token operator">=</span>https://root@esxi.yoi.li/sdk  ESX or vCenter URL <span class="token punctuation">[</span>GOVC_URL<span class="token punctuation">]</span>  <span class="token parameter variable">-verbose</span><span class="token operator">=</span>false                   Write request/response data to stderr  -vim-namespace<span class="token operator">=</span>vim25             Vim namespace <span class="token punctuation">[</span>GOVC_VIM_NAMESPACE<span class="token punctuation">]</span>  -vim-version<span class="token operator">=</span><span class="token number">7.0</span>                 Vim version <span class="token punctuation">[</span>GOVC_VIM_VERSION<span class="token punctuation">]</span>  <span class="token parameter variable">-xml</span><span class="token operator">=</span>false                       Enable XML output<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过 <code>GOVC_URL</code> 环境变量指定 ESXi 主机或 vCenter 的 URL，登录的用户名和密码可设置在 GOVC_URL 中或者单独设置 <code>GOVC_USERNAME</code> 和 <code>GOVC_PASSWORD</code>。如果 https 证书是自签的域名或者 IP 需要通过设置 <code>GOVC_INSECURE=true</code> 参数来允许不安全的 https 连接。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_URL</span><span class="token operator">=</span><span class="token string">"https://root:password@esxi.k8s.li"</span>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_INSECURE</span><span class="token operator">=</span>true$ govc aboutFullName:     VMware ESXi <span class="token number">7.0</span>.2 build-17867351Name:         VMware ESXiVendor:       VMware, Inc.Version:      <span class="token number">7.0</span>.2Build:        <span class="token number">17867351</span>OS type:      vmnix-x86API type:     HostAgentAPI version:  <span class="token number">7.0</span>.2.0Product ID:   embeddedEsxUUID:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果用户名和密码当中有特殊字符比如 <code> \ @ /</code>，建议分别设置 <code>GOVC_URL</code>、<code>GOVC_USERNAME</code> 和 <code>GOVC_PASSWORD</code> 这样能避免特殊字符在 <code>GOVC_URL</code> 出现一些奇奇怪怪的问题。</p><h2 id="获取主机信息"><a href="#获取主机信息" class="headerlink" title="获取主机信息"></a>获取主机信息</h2><h3 id="govc-host-info"><a href="#govc-host-info" class="headerlink" title="govc host.info"></a><code>govc host.info</code></h3><p>通过 host.info 自命命令可以得到 ESXi 主机的基本信息，</p><ul><li>Path: 当前主机在集群中的资源路径</li><li>Manufacturer: 硬件设备制造商</li><li>Logical CPUs: 逻辑 CPU 的数量，以及 CPU 的基础频率</li><li>Processor type: CPU 的具体型号，由于我的是 ES 版的 E-2126G，所以无法显示出具体的型号 🤣</li><li>CPU usage:  CPU 使用的负载情况</li><li>Memory:  主机安装的内存大小</li><li>Memory usage:  内存使用的负载情况</li><li>Boot time: 开机时间</li><li>State:  连接状态</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ govc host.infoName:              hp-esxi.lan  Path:            /ha-datacenter/host/hp-esxi.lan/hp-esxi.lan  Manufacturer:    HPE  Logical CPUs:    <span class="token number">6</span> CPUs @ 3000MHz  Processor type:  Genuine Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> CPU 0000 @ <span class="token number">3</span>.00GHz  CPU usage:       <span class="token number">3444</span> MHz <span class="token punctuation">(</span><span class="token number">19.1</span>%<span class="token punctuation">)</span>  Memory:          32613MB  Memory usage:    <span class="token number">26745</span> MB <span class="token punctuation">(</span><span class="token number">82.0</span>%<span class="token punctuation">)</span>  Boot time:       <span class="token number">2021</span>-12-05 06:11:53.42802 +0000 UTC  State:           connected<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果加上 -json 参数会得到一个至少 3w 行的 json 输出，里面包含的 ESXi 主机的所有信息，然后可以使用 jq 命令去过滤出一些自己所需要的参数。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@esxi-debian-devbox ~╰─<span class="token comment"># govc host.info -json=true > host_info.json</span>╭─root@esxi-debian-devbox ~╰─<span class="token comment"># wc host_info.json</span>  <span class="token number">34522</span>   <span class="token number">73430</span> <span class="token number">1188718</span> host_info.json╭─root@esxi-debian-devbox ~╰─<span class="token comment"># govc host.info -json | jq '.HostSystems[0].Summary.Hardware'</span><span class="token punctuation">&#123;</span>  <span class="token string">"Vendor"</span><span class="token builtin class-name">:</span> <span class="token string">"HPE"</span>,  <span class="token string">"Model"</span><span class="token builtin class-name">:</span> <span class="token string">"ProLiant MicroServer Gen10 Plus"</span>,  <span class="token string">"Uuid"</span><span class="token builtin class-name">:</span> <span class="token string">"30363150"</span>,  <span class="token string">"MemorySize"</span><span class="token builtin class-name">:</span> <span class="token number">34197471232</span>,  <span class="token string">"CpuModel"</span><span class="token builtin class-name">:</span> <span class="token string">"Genuine Intel(R) CPU 0000 @ 3.00GHz"</span>,  <span class="token string">"CpuMhz"</span><span class="token builtin class-name">:</span> <span class="token number">3000</span>,  <span class="token string">"NumCpuPkgs"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"NumCpuCores"</span><span class="token builtin class-name">:</span> <span class="token number">6</span>,  <span class="token string">"NumCpuThreads"</span><span class="token builtin class-name">:</span> <span class="token number">6</span>,  <span class="token string">"NumNics"</span><span class="token builtin class-name">:</span> <span class="token number">4</span>,  <span class="token string">"NumHBAs"</span><span class="token builtin class-name">:</span> <span class="token number">3</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果加上 -dump 参数，则会以 Golang 结构体的格式来输出，输出的内容也是包含了 ESXi 主机的所有信息，用它可以比较方便地定位某个信息的结构体，这一点对基于 govmomi 来开发其他的功能来说十分方便。尤其是在写单元测试的时候，可以从这里 dump 出一些数据来进行 mock。需要注意的是，并不是所有的子命令都支持 json 格式的输出。</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">mo.HostSystem&#123;    ManagedEntity: mo.ManagedEntity&#123;        ExtensibleManagedObject: mo.ExtensibleManagedObject&#123;            Self:           types.ManagedObjectReference&#123;Type:&quot;HostSystem&quot;, Value:&quot;ha-host&quot;&#125;,            Value:          nil,            AvailableField: nil,        &#125;,        Parent:        &amp;types.ManagedObjectReference&#123;Type:&quot;ComputeResource&quot;, Value:&quot;ha-compute-res&quot;&#125;,        CustomValue:   nil,        OverallStatus: &quot;green&quot;,        ConfigStatus:  &quot;yellow&quot;,        ConfigIssue:   []types.BaseEvent&#123;            &amp;types.RemoteTSMEnabledEvent&#123;                HostEvent: types.HostEvent&#123;                    Event: types.Event&#123;                        Key:             1,                        ChainId:         0,                        CreatedTime:     time.Now(),                        UserName:        &quot;&quot;,                        Datacenter:      (*types.DatacenterEventArgument)(nil),                        ComputeResource: (*types.ComputeResourceEventArgument)(nil),                        Host:            &amp;types.HostEventArgument&#123;                            EntityEventArgument: types.EntityEventArgument&#123;                                EventArgument: types.EventArgument&#123;&#125;,                                Name:          &quot;hp-esxi.lan&quot;,                            &#125;,                            Host: types.ManagedObjectReference&#123;Type:&quot;HostSystem&quot;, Value:&quot;ha-host&quot;&#125;,                        &#125;,                        Vm:                   (*types.VmEventArgument)(nil),                        Ds:                   (*types.DatastoreEventArgument)(nil),                        Net:                  (*types.NetworkEventArgument)(nil),                        Dvs:                  (*types.DvsEventArgument)(nil),                        FullFormattedMessage: &quot;SSH for the host hp-esxi.lan has been enabled&quot;,                        ChangeTag:            &quot;&quot;,                    &#125;,                &#125;,            &#125;,        &#125;,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在写单元测试的时候，我经常用它来 mock 一些特殊硬件设备的信息，这比自己手写这些结构体要方便很多。比如以 <code>mpx.vmhba&lt;Adapter&gt;:C&lt;Channel&gt;:T&lt;Target&gt;:L&lt;LUN&gt; </code> 命名的硬盘可以通过  <code>PlugStoreTopology</code> 这个结构体来获取该硬盘的 NAA 号：</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">func getDiskIDByHostPlugStoreTopology(hpst *types.HostPlugStoreTopology, diskName string) string &#123;for _, path :&#x3D; range hpst.Path &#123;if path.Name &#x3D;&#x3D; diskName &#123;s :&#x3D; strings.Split(path.Target, &quot;-sas.&quot;)return s[len(s)-1]&#125;&#125;return &quot;&quot;&#125;&#x2F;&#x2F; 单元测试代码如下：var plugStoreTopology &#x3D; &amp;types.HostPlugStoreTopology&#123;Path: []types.HostPlugStoreTopologyPath&#123;&#123;Key:           &quot;key-vim.host.PlugStoreTopology.Path-vmhba0:C0:T1:L0&quot;,Name:          &quot;vmhba0:C0:T1:L0&quot;,ChannelNumber: 0,TargetNumber:  1,LunNumber:     0,Adapter:       &quot;key-vim.host.PlugStoreTopology.Adapter-vmhba0&quot;,Target:        &quot;key-vim.host.PlugStoreTopology.Target-sas.500056b3d93828c0&quot;,Device:        &quot;key-vim.host.PlugStoreTopology.Device-020000000055cd2e414dc39d4e494e54454c20&quot;,&#125;,&#125;,&#125;func TestGetDiskIDByHostPlugStoreTopology(t *testing.T) &#123;tests :&#x3D; []struct &#123;name stringwant string&#125;&#123;&#123;name: &quot;vmhba0:C0:T1:L0&quot;,want: &quot;500056b3d93828c0&quot;,&#125;,&#123;name: &quot;vmhba0:C0:T2:L0&quot;,want: &quot;&quot;,&#125;,&#123;name: &quot;&quot;,want: &quot;&quot;,&#125;,&#125;for _, tt :&#x3D; range tests &#123;t.Run(tt.name, func(t *testing.T) &#123;if got :&#x3D; getDiskIDByHostPlugStoreTopology(plugStoreTopology, tt.name); got !&#x3D; tt.want &#123;t.Errorf(&quot;getDiskIDByHostPlugStoreTopology() &#x3D; %v, want %v&quot;, got, tt.want)&#125;&#125;)&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>再比如 NVMe 硬盘可以通过 <code>NvmeTopology</code> 这个数据对象获取它的序列号</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">func getNVMeIDByHostNvmeTopology(hnt *types.HostNvmeTopology, diskName string) string &#123;for _, adapter :&#x3D; range hnt.Adapter &#123;for _, controller :&#x3D; range adapter.ConnectedController &#123;for _, ns :&#x3D; range controller.AttachedNamespace &#123;if ns.Name &#x3D;&#x3D; diskName &#123;return strings.TrimSpace(controller.SerialNumber)&#125;&#125;&#125;&#125;return &quot;&quot;&#125;&#x2F;&#x2F; 单元测试代码如下：var nvmeTopology &#x3D; &amp;types.HostNvmeTopology&#123;Adapter: []types.HostNvmeTopologyInterface&#123;&#123;Key:     &quot;key-vim.host.NvmeTopology.Interface-vmhba0&quot;,Adapter: &quot;key-vim.host.PcieHba-vmhba0&quot;,ConnectedController: []types.HostNvmeController&#123;&#123;Key:                     &quot;key-vim.host.NvmeController-256&quot;,ControllerNumber:        256,Subnqn:                  &quot;nqn.2021-06.com.intel:PHAB123502CU1P9SGN  &quot;,Name:                    &quot;nqn.2021-06.com.intel:PHAB123502CU1P9SGN&quot;,AssociatedAdapter:       &quot;key-vim.host.PcieHba-vmhba0&quot;,TransportType:           &quot;pcie&quot;,FusedOperationSupported: false,NumberOfQueues:          2,QueueSize:               1024,AttachedNamespace: []types.HostNvmeNamespace&#123;&#123;Key:              &quot;key-vim.host.NvmeNamespace-t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CB406E4D25C@256&quot;,Name:             &quot;t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CB406E4D25C&quot;,Id:               1,BlockSize:        512,CapacityInBlocks: 3125627568,&#125;,&#125;,VendorId:        &quot;0x8086&quot;,Model:           &quot;Dell Ent NVMe P5600 MU U.2 1.6TB        &quot;,SerialNumber:    &quot;PHAB123502CU1P9SGN  &quot;,FirmwareVersion: &quot;1.0.0   PCIe&quot;,&#125;,&#125;,&#125;,&#123;Key:     &quot;key-vim.host.NvmeTopology.Interface-vmhba1&quot;,Adapter: &quot;key-vim.host.PcieHba-vmhba1&quot;,ConnectedController: []types.HostNvmeController&#123;&#123;Key:                     &quot;key-vim.host.NvmeController-257&quot;,ControllerNumber:        257,Subnqn:                  &quot;nqn.2021-06.com.intel:PHAB123602H81P9SGN  &quot;,Name:                    &quot;nqn.2021-06.com.intel:PHAB123602H81P9SGN&quot;,AssociatedAdapter:       &quot;key-vim.host.PcieHba-vmhba1&quot;,TransportType:           &quot;pcie&quot;,FusedOperationSupported: false,NumberOfQueues:          2,QueueSize:               1024,AttachedNamespace: []types.HostNvmeNamespace&#123;&#123;Key:              &quot;key-vim.host.NvmeNamespace-t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CEE23E4D25C@257&quot;,Name:             &quot;t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CEE23E4D25C&quot;,Id:               1,BlockSize:        512,CapacityInBlocks: 3125627568,&#125;,&#125;,VendorId:        &quot;0x8086&quot;,Model:           &quot;Dell Ent NVMe P5600 MU U.2 1.6TB        &quot;,SerialNumber:    &quot;PHAB123602H81P9SGN  &quot;,FirmwareVersion: &quot;1.0.0   PCIe&quot;,&#125;,&#125;,&#125;,&#125;,&#125;func TestGetNVMeIDByHostNvmeTopology(t *testing.T) &#123;tests :&#x3D; []struct &#123;name stringwant string&#125;&#123;&#123;name: &quot;t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CEE23E4D25C&quot;,want: &quot;PHAB123602H81P9SGN&quot;,&#125;,&#123;name: &quot;t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB&quot;,want: &quot;&quot;,&#125;,&#123;name: &quot;&quot;,want: &quot;&quot;,&#125;,&#125;for _, tt :&#x3D; range tests &#123;t.Run(tt.name, func(t *testing.T) &#123;if got :&#x3D; getNVMeIDByHostNvmeTopology(nvmeTopology, tt.name); got !&#x3D; tt.want &#123;t.Errorf(&quot;getNVMeIDByHostNvmeTopology() &#x3D; %v, want %v&quot;, got, tt.want)&#125;&#125;)&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="配置-ESXi-主机参数"><a href="#配置-ESXi-主机参数" class="headerlink" title="配置 ESXi 主机参数"></a>配置 ESXi 主机参数</h2><p>通过 <code>host.option.ls</code> 可以列出当前 ESXi 主机所有的配置选项</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ govc host.option.lsAnnotations.WelcomeMessage:BufferCache.FlushInterval:                          <span class="token number">30000</span>BufferCache.HardMaxDirty:                           <span class="token number">95</span>BufferCache.PerFileHardMaxDirty:                    <span class="token number">50</span>BufferCache.SoftMaxDirty:                           <span class="token number">15</span>CBRC.DCacheMemReserved:                             <span class="token number">400</span>CBRC.Enable:                                        <span class="token boolean">false</span>COW.COWMaxHeapSizeMB:                               <span class="token number">192</span>COW.COWMaxREPageCacheszMB:                          <span class="token number">256</span>COW.COWMinREPageCacheszMB:                          <span class="token number">0</span>COW.COWREPageCacheEviction:                         <span class="token number">1</span>Config.Defaults.host.TAAworkaround:                 <span class="token boolean">true</span>Config.Defaults.monitor.if_pschange_mc_workaround:  <span class="token boolean">false</span>Config.Defaults.security.host.ruissl:               <span class="token boolean">true</span>Config.Defaults.vGPU.consolidation:                 <span class="token boolean">false</span>Config.Etc.issue:Config.Etc.motd:                                    The <span class="token function">time</span> and <span class="token function">date</span> of this login have been sent to the system logs.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过 <code>host.option.set</code> 可以设置 ESXi 主机参数，例如如果想要配置 NFS 存储心跳超时时间可以通过如下方式</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ govc host.option.set NFS.HeartbeatTimeout <span class="token number">30</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="开启-ssh-服务"><a href="#开启-ssh-服务" class="headerlink" title="开启 ssh 服务"></a>开启 ssh 服务</h2><p>通过 <code>host.service</code> 可以对 ESXi 主机上的服务进行相关操作。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ govc host.serviceWhere ACTION is one of: start, stop, restart, status, enable, disable<span class="token comment"># 启动 ssh 服务</span>$ govc host.service start TSM-SSH<span class="token comment"># 将 ssh 服务设置为开机自启</span>$ govc host.service <span class="token builtin class-name">enable</span> TSM-SSH<span class="token comment"># 查看 ssh 服务的状态</span>$ govc host.service status TSM-SSH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token assign-left variable">VM_NAME</span><span class="token operator">=</span><span class="token string">"centos-test"</span>$ govc vm.create <span class="token parameter variable">-ds</span><span class="token operator">=</span><span class="token string">'datastore*'</span> <span class="token parameter variable">-net</span><span class="token operator">=</span><span class="token string">'VM Network'</span> <span class="token parameter variable">-net.adapter</span><span class="token operator">=</span>vmxnet3 <span class="token parameter variable">-disk</span> 1G <span class="token parameter variable">-on</span><span class="token operator">=</span>false <span class="token variable">$&#123;VM_NAME&#125;</span>$ govc vm.change <span class="token parameter variable">-cpu.reservation</span><span class="token operator">=</span>%d -memory-pin<span class="token operator">=</span>true <span class="token parameter variable">-vm</span> <span class="token variable">$&#123;VM_NAME&#125;</span>$ govc vm.change <span class="token parameter variable">-g</span> centos7_64Guest <span class="token parameter variable">-c</span> %d <span class="token parameter variable">-m</span> <span class="token number">16384</span> <span class="token parameter variable">-latency</span> high <span class="token parameter variable">-vm</span> <span class="token variable">$&#123;VM_NAME&#125;</span>$ govc device.cdrom.add <span class="token parameter variable">-vm</span> <span class="token variable">$&#123;VM_NAME&#125;</span>$ govc device.cdrom.insert <span class="token parameter variable">-vm</span> <span class="token variable">$&#123;VM_NAME&#125;</span> <span class="token parameter variable">-device</span> cdrom-3000$ govc device.connect <span class="token parameter variable">-vm</span> <span class="token variable">$&#123;VM_NAME&#125;</span> cdrom-3000$ govc vm.power <span class="token parameter variable">-on</span><span class="token operator">=</span>true <span class="token variable">$&#123;VM_NAME&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://gitbook.curiouser.top/origin/vsphere-govc.html">vSphere go 命令行管理工具 govc</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;最近由于工作原因需要在 ESXi
        
      
    
    </summary>
    
    
      <category term="技术" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="ESXi" scheme="https://blog.k8s.li/tags/ESXi/"/>
    
      <category term="govc" scheme="https://blog.k8s.li/tags/govc/"/>
    
      <category term="vCenter" scheme="https://blog.k8s.li/tags/vCenter/"/>
    
      <category term="vSphere" scheme="https://blog.k8s.li/tags/vSphere/"/>
    
  </entry>
  
  <entry>
    <title>流水线中使用 docker in pod 方式构建容器镜像</title>
    <link href="https://blog.k8s.li/docker-in-pod.html"/>
    <id>https://blog.k8s.li/docker-in-pod.html</id>
    <published>2022-03-14T16:00:00.000Z</published>
    <updated>2022-03-15T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>上个月参加了 Rancher 社区举办的 《<a href="https://www.bilibili.com/video/BV1Xa411C78k">Dockershim 即将被移除，你准备好了么？</a>》直播分享后，得知自 1.24 版本之后，Kubernetes 社区将正式放弃对 docker CRI 的支持，docker CRI 这部分代码则由 <a href="https://github.com/Mirantis/cri-dockerd"> cri-dockerd</a> 项目来接盘。目前众多主流的 Kubernetes 私有化部署工具（比如 <a href="https://github.com/kubernetes-sigs/kubespray">kubespray</a>、<a href="https://github.com/kubesphere/kubekey">kubekey</a>、<a href="https://github.com/fanux/sealos">sealos</a>）也逐渐地不再将 docker 作为首选的容器运行时而纷纷转向了 containerd，去 docker 也成为了目前云原生社区热门的讨论话题。</p><p>docker 虽然作为一个 CRI 在 Kubernetes 社区一直被人诟病，但我们要知道 CRI 仅仅是 docker 的一部分功能而已。对于本地开发测试或者 CI&#x2F;CD 流水线镜像构建来讲，依然有很多地方严重地依赖着 docker。比如 GitHub 上容器镜像构建的 Action 里， docker 官方的 <a href="https://github.com/docker/build-push-action">build-push-action</a> 是众多项目首选的方式。即便是 docker 的竞争对手 <a href="https://github.com/containers/podman">podman</a> + <a href="https://github.com/containers/skopeo">skopeo</a> + <a href="https://github.com/containers/buildah">buildah</a> 三剑客它们自身的容器镜像也是采用 docker 来构建的 <a href="https://github.com/containers/buildah/blob/main/.github/workflows/multi-arch-build.yaml">multi-arch-build.yaml</a>：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">jobs</span><span class="token punctuation">:</span>  <span class="token key atrule">multi</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> multi<span class="token punctuation">-</span>arch image build    <span class="token key atrule">env</span><span class="token punctuation">:</span>      <span class="token key atrule">REPONAME</span><span class="token punctuation">:</span> buildah  <span class="token comment"># No easy way to parse this out of $GITHUB_REPOSITORY</span>      <span class="token comment"># Server/namespace value used to format FQIN</span>      <span class="token key atrule">REPONAME_QUAY_REGISTRY</span><span class="token punctuation">:</span> quay.io/buildah      <span class="token key atrule">CONTAINERS_QUAY_REGISTRY</span><span class="token punctuation">:</span> quay.io/containers      <span class="token comment"># list of architectures for build</span>      <span class="token key atrule">PLATFORMS</span><span class="token punctuation">:</span> linux/amd64<span class="token punctuation">,</span>linux/s390x<span class="token punctuation">,</span>linux/ppc64le<span class="token punctuation">,</span>linux/arm64      <span class="token comment"># Command to execute in container to obtain project version number</span>      <span class="token key atrule">VERSION_CMD</span><span class="token punctuation">:</span> <span class="token string">"buildah --version"</span>    <span class="token comment"># build several images (upstream, testing, stable) in parallel</span>    <span class="token key atrule">strategy</span><span class="token punctuation">:</span>      <span class="token comment"># By default, failure of one matrix item cancels all others</span>      <span class="token key atrule">fail-fast</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">matrix</span><span class="token punctuation">:</span>        <span class="token comment"># Builds are located under contrib/&lt;reponame>image/&lt;source> directory</span>        <span class="token key atrule">source</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> upstream          <span class="token punctuation">-</span> testing          <span class="token punctuation">-</span> stable    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest    <span class="token comment"># internal registry caches build for inspection before push</span>    <span class="token key atrule">services</span><span class="token punctuation">:</span>      <span class="token key atrule">registry</span><span class="token punctuation">:</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/libpod/registry<span class="token punctuation">:</span><span class="token number">2</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> 5000<span class="token punctuation">:</span><span class="token number">5000</span>    <span class="token key atrule">steps</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up QEMU        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>qemu<span class="token punctuation">-</span>action@v1      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Docker Buildx        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v1        <span class="token key atrule">with</span><span class="token punctuation">:</span>          <span class="token key atrule">driver-opts</span><span class="token punctuation">:</span> network=host          <span class="token key atrule">install</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build and locally push image        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v2        <span class="token key atrule">with</span><span class="token punctuation">:</span>          <span class="token key atrule">context</span><span class="token punctuation">:</span> contrib/$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.REPONAME <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>image/$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> matrix.source <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">file</span><span class="token punctuation">:</span> ./contrib/$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.REPONAME <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>image/$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> matrix.source <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/Dockerfile          <span class="token key atrule">platforms</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.PLATFORMS <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">push</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">tags</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span>5000/$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.REPONAME <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> matrix.source <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Jenkins-流水线"><a href="#Jenkins-流水线" class="headerlink" title="Jenkins 流水线"></a>Jenkins 流水线</h2><p>我们的 CI&#x2F;CD 流水线是使用 Jenkins + Kubernetes plugin 的方式在 Kubernetes 上动态地创建 Pod 作为 Jenkins Slave。在使用 docker 作为容器时的情况下，Jenkins  Slave Pod 将宿主机上的 <code>/var/run/docker.sock</code> 文件通过 hostPath 的方式挂载到 pod 容器内，容器内的 docker CLI 就能通过该 sock 与宿主机的 docker 守护进程进行通信，这样在 pod 容器内就可以无缝地使用 docker build 、push 等命令了。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">// Kubernetes pod template to run.podTemplate(    <span class="token key atrule">cloud</span><span class="token punctuation">:</span> <span class="token string">"kubernetes"</span><span class="token punctuation">,</span>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">label</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">yaml</span><span class="token punctuation">:</span> """<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> debian    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"$&#123;JENKINS_POD_IMAGE_NAME&#125;"</span>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dockersock      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/docker.sock  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jnlp    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"\$(JENKINS_SECRET)"</span><span class="token punctuation">,</span> <span class="token string">"\$(JENKINS_NAME)"</span><span class="token punctuation">]</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"jenkins/inbound-agent:4.3-4-alpine"</span>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dockersock      <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/run/docker.sock"""<span class="token punctuation">,</span>)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当不再使用 docker 作为 Kubernetes 的容器运行时之后，宿主机上则就没有了 docker 守护进程，挂载 <code>/var/run/docker.sock</code> 的方式也就凉凉了，因此我们需要找到一些替代的方法。</p><p>目前能想到的有两种方案：方案一是替代掉 docker 使用其他镜像构建工具比如 <a href="https://github.com/containers/podman">podman</a> + <a href="https://github.com/containers/skopeo">skopeo</a> + <a href="https://github.com/containers/buildah">buildah</a>。陈少文博主在《<a href="https://www.chenshaowen.com/blog/using-podman-to-build-images-under-kubernetes-and-jenkins.html">基于 Kubernetes 的 Jenkins 服务也可以去 Docker 了</a>》详细地讲过该方案。但我们的 Makefile 里缝合了一些 docker buildKit 的特性参数并不能地通过 <code>alias docker=podman</code> 别名的方式简单粗暴地给替换掉 😂。</p><p>比如 podman 构建镜像就不支持 <code>--output type=local,dest=path</code>  <a href="https://github.com/containers/buildah/issues/3789">Support custom build outputs #3789</a> 这种特性。目前看来 podman 想要完全取代掉 docker 的老大哥地位仍还有很长的路要走，尤其 podman 还没有解决自身的镜像是由 docker 来构建的这个尴尬难题。</p><p>方案二就是继续使用 docker 作为镜像构建工具，虽然集群节点上没有了 docker 守护进程，但这并不意味着在 Kubernetes 集群里就无法使用 docker 了。我们可以换种方式将 docker 作为一个 pod 运行在 kubernetes 集群中，而非以 systemd 的方式部署在节点上。然后通过 service IP 或 Node IP 访问 docker 的 TCP 端口进行通信，这样也能无缝地继续使用 docker 。于是在 dind (docker-in-docker) 的基础上就有了 dinp (docker-in-pod) 的套娃操作，其实二者本质上都是相同的，只不过是部署方式和访问方式不太相同而已。</p><p>对比一下这两种方案，方案一通过 <code>alias docker=podman</code> 使用 podman 替代 docker 有点投机取巧，在正式的生产环境流水线中应该很少会被采用，除非你的 Makefile 或者镜像构建脚本中没有依赖 docker 的特性参数，能够完全兼容 podman；方案二比较稳定可靠，它无非就是将之前的宿主机节点上的 docker 守护进程替换成了集群内的 Pod，对于使用者而言只需要修改一下访问 docker 的方式，即 <code>DOCKER_HOST</code> 环境变量即可。因此本文选用方案二来给大家介绍几种在 K8s 集群里部署和使用 dind&#x2F;dinp 的方式。</p><h2 id="docker-in-pod"><a href="#docker-in-pod" class="headerlink" title="docker in pod"></a>docker in pod</h2><p>不同于 docker in docker，docker in pod 并不关心底层的容器运行时是什么，可以是 docker 也可以是 containerd。在 pod 内运行和使用 docker 个人总结出以下三种比较合适的方式，可以根据不同的场景选择一个合适的：</p><h3 id="sidecar"><a href="#sidecar" class="headerlink" title="sidecar"></a>sidecar</h3><p>将 dind 容器作为 <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/#using-pods">sidecar 容器</a> 来运行，主容器通过 localhost 的方式访问 docker 的 2375&#x2F;2376 TCP 端口。这种方案的好处就是如果创建了多个 Pod，各个 Pod 之间是相互独立的，dind 容器不会共享给其他 pod 使用，隔离性比较好。缺点也比较明显，每一个 Pod 都带一个 dind 容器占用的系统资源比较多，有点大材小用的感觉；</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>sidecar<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>20.10.12    <span class="token key atrule">name</span><span class="token punctuation">:</span> debug    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"sleep"</span><span class="token punctuation">,</span> <span class="token string">"3600"</span><span class="token punctuation">]</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_VERIFY      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_HOST      <span class="token key atrule">value</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">2375</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dind    <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>20.10.12<span class="token punctuation">-</span>dind<span class="token punctuation">-</span>rootless    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"--insecure-registry=$(REGISTRY)"</span><span class="token punctuation">]</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token comment"># 如果镜像仓库域名为自签证书，需要在这里配置 insecure-registry</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REGISTRY      <span class="token key atrule">value</span><span class="token punctuation">:</span> hub.k8s.li    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_CERTDIR      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_HOST      <span class="token key atrule">value</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">2375</span>    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>      <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token comment"># 使用 docker info 命令就绪探针来确保 dind 容器正常启动 </span>    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">exec</span><span class="token punctuation">:</span>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>      <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="daemonset"><a href="#daemonset" class="headerlink" title="daemonset"></a>daemonset</h3><p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/">daemonset</a> 则是在集群的每一个 Node 节点上运行一个 dind Pod，并且使用 hostNetwork 方式来暴露 2375&#x2F;2376 TCP 端口。使用者则通过 <code>status.hostIP</code> 访问宿主机的 2375&#x2F;2376 TCP 端口来与 docker 进行通信；另外再通过 hostPath 挂载的方式来将 dind 容器内的 <code>/var/lib/docker</code> 数据持久化存储下来，能够缓存一些数据提高镜像构建的效率。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>daemonset  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>daemonset  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>daemonset    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dind        <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>20.10.12<span class="token punctuation">-</span>dind        <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"--insecure-registry=$(REGISTRY)"</span><span class="token punctuation">]</span>        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REGISTRY          <span class="token key atrule">value</span><span class="token punctuation">:</span> hub.k8s.li        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_CERTDIR          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>storage          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span>  /var/lib/docker        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">60</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">10</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>storage        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/docker<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="deployment"><a href="#deployment" class="headerlink" title="deployment"></a>deployment</h3><p>Deployment 方式则是在集群中部署一个或多个 dind Pod，使用者通过 service IP 来访问 docker 的 2375&#x2F;2376 端口，如果是以非 TLS 方式启动 dind 容器，使用 service IP 来访问 docker 要比前面的 daemonset 使用 host IP 安全性要好一些。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>deployment  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>deployment<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>deployment  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>deployment    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dind        <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>20.10.12<span class="token punctuation">-</span>dind        <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"--insecure-registry=$(REGISTRY)"</span><span class="token punctuation">]</span>        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REGISTRY          <span class="token key atrule">value</span><span class="token punctuation">:</span> hub.k8s.li        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_CERTDIR          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_HOST          <span class="token key atrule">value</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">2375</span>        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>storage          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span>  /var/lib/docker        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">60</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">10</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>storage        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/docker<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token comment"># 定义 service name，使用者通过它来访问 docker 的 2375 端口</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>deployment<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>deployment  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2375</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">2375</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h2><p>在 Jenkins 的 podTemplate 模版里，可以根据 dinp 部署方式的不同选用以下几种不同的模版：</p><h3 id="sidecare"><a href="#sidecare" class="headerlink" title="sidecare"></a>sidecare</h3><p>Pod 内容器共享同一个网络协议栈，因此可以通过 localhost 来访问 docker 的 TCP 端口，另外最好使用 rootless 模式启动 dind 容器，这样能在同一节点上运行多个这样的 Pod 实例。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">def JOB_NAME = "$<span class="token punctuation">&#123;</span>env.JOB_BASE_NAME<span class="token punctuation">&#125;</span>"def BUILD_NUMBER = "$<span class="token punctuation">&#123;</span>env.BUILD_NUMBER<span class="token punctuation">&#125;</span>"def POD_NAME = "jenkins<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>JOB_NAME<span class="token punctuation">&#125;</span><span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>BUILD_NUMBER<span class="token punctuation">&#125;</span>"<span class="token key atrule">def K8S_CLUSTER = params.k8s_cluster ?</span><span class="token punctuation">:</span> kubernetes// Kubernetes pod template to run.podTemplate(    <span class="token key atrule">cloud</span><span class="token punctuation">:</span> K8S_CLUSTER<span class="token punctuation">,</span>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">label</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">yaml</span><span class="token punctuation">:</span> """<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> runner    <span class="token key atrule">image</span><span class="token punctuation">:</span> golang<span class="token punctuation">:</span>1.17<span class="token punctuation">-</span>buster    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_HOST      <span class="token key atrule">vaule</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">2375</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_VERIFY      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jnlp    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"\$(JENKINS_SECRET)"</span><span class="token punctuation">,</span> <span class="token string">"\$(JENKINS_NAME)"</span><span class="token punctuation">]</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"jenkins/inbound-agent:4.11.2-4-alpine"</span>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dind    <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>20.10.12<span class="token punctuation">-</span>dind<span class="token punctuation">-</span>rootless    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"--insecure-registry=$(REGISTRY)"</span><span class="token punctuation">]</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REGISTRY      <span class="token key atrule">value</span><span class="token punctuation">:</span> hub.k8s.li    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_CERTDIR      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>      <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">exec</span><span class="token punctuation">:</span>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>      <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>"""<span class="token punctuation">,</span>) <span class="token punctuation">&#123;</span>    node(POD_NAME) <span class="token punctuation">&#123;</span>        container("runner") <span class="token punctuation">&#123;</span>            stage("Checkout") <span class="token punctuation">&#123;</span>                retry(10) <span class="token punctuation">&#123;</span>                    checkout(<span class="token punctuation">[</span>                        <span class="token key atrule">$class</span><span class="token punctuation">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span>                        <span class="token key atrule">branches</span><span class="token punctuation">:</span> scm.branches<span class="token punctuation">,</span>                        <span class="token key atrule">doGenerateSubmoduleConfigurations</span><span class="token punctuation">:</span> scm.doGenerateSubmoduleConfigurations<span class="token punctuation">,</span>                        <span class="token key atrule">extensions</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token key atrule">$class</span><span class="token punctuation">:</span> <span class="token string">'CloneOption'</span><span class="token punctuation">,</span> <span class="token key atrule">noTags</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">shallow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">depth</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token key atrule">reference</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token key atrule">userRemoteConfigs</span><span class="token punctuation">:</span> scm.userRemoteConfigs<span class="token punctuation">,</span>                    <span class="token punctuation">]</span>)                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            stage("Build") <span class="token punctuation">&#123;</span>                sh """                <span class="token comment"># make docker-build</span>                docker build <span class="token punctuation">-</span>t app<span class="token punctuation">:</span>v1.0.0<span class="token punctuation">-</span>alpha.1 .                """            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="daemonset-1"><a href="#daemonset-1" class="headerlink" title="daemonset"></a>daemonset</h3><p>由于使用的是 hostNetwork，因此可以通过 host IP 来访问 docker 的 TCP 端口，当然也可以像 deployment 那样通过 service Name 来访问，在这里就不演示了。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">def JOB_NAME = "$<span class="token punctuation">&#123;</span>env.JOB_BASE_NAME<span class="token punctuation">&#125;</span>"def BUILD_NUMBER = "$<span class="token punctuation">&#123;</span>env.BUILD_NUMBER<span class="token punctuation">&#125;</span>"def POD_NAME = "jenkins<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>JOB_NAME<span class="token punctuation">&#125;</span><span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>BUILD_NUMBER<span class="token punctuation">&#125;</span>"<span class="token key atrule">def K8S_CLUSTER = params.k8s_cluster ?</span><span class="token punctuation">:</span> kubernetes// Kubernetes pod template to run.podTemplate(    <span class="token key atrule">cloud</span><span class="token punctuation">:</span> K8S_CLUSTER<span class="token punctuation">,</span>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">label</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">yaml</span><span class="token punctuation">:</span> """<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> runner    <span class="token key atrule">image</span><span class="token punctuation">:</span> golang<span class="token punctuation">:</span>1.17<span class="token punctuation">-</span>buster    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_HOST      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>        <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>          <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.hostIP    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_VERIFY      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jnlp    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"\$(JENKINS_SECRET)"</span><span class="token punctuation">,</span> <span class="token string">"\$(JENKINS_NAME)"</span><span class="token punctuation">]</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"jenkins/inbound-agent:4.11.2-4-alpine"</span>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent"""<span class="token punctuation">,</span>) <span class="token punctuation">&#123;</span>    node(POD_NAME) <span class="token punctuation">&#123;</span>        container("runner") <span class="token punctuation">&#123;</span>            stage("Checkout") <span class="token punctuation">&#123;</span>                retry(10) <span class="token punctuation">&#123;</span>                    checkout(<span class="token punctuation">[</span>                        <span class="token key atrule">$class</span><span class="token punctuation">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span>                        <span class="token key atrule">branches</span><span class="token punctuation">:</span> scm.branches<span class="token punctuation">,</span>                        <span class="token key atrule">doGenerateSubmoduleConfigurations</span><span class="token punctuation">:</span> scm.doGenerateSubmoduleConfigurations<span class="token punctuation">,</span>                        <span class="token key atrule">extensions</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token key atrule">$class</span><span class="token punctuation">:</span> <span class="token string">'CloneOption'</span><span class="token punctuation">,</span> <span class="token key atrule">noTags</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">shallow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">depth</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token key atrule">reference</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token key atrule">userRemoteConfigs</span><span class="token punctuation">:</span> scm.userRemoteConfigs<span class="token punctuation">,</span>                    <span class="token punctuation">]</span>)                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            stage("Build") <span class="token punctuation">&#123;</span>                sh """                <span class="token comment"># make docker-build</span>                docker build <span class="token punctuation">-</span>t app<span class="token punctuation">:</span>v1.0.0<span class="token punctuation">-</span>alpha.1 .                """            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="deployment-1"><a href="#deployment-1" class="headerlink" title="deployment"></a>deployment</h3><p>通过 service name 访问 docker，其他参数和 daemonset 都是相同的</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">def JOB_NAME = "$<span class="token punctuation">&#123;</span>env.JOB_BASE_NAME<span class="token punctuation">&#125;</span>"def BUILD_NUMBER = "$<span class="token punctuation">&#123;</span>env.BUILD_NUMBER<span class="token punctuation">&#125;</span>"def POD_NAME = "jenkins<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>JOB_NAME<span class="token punctuation">&#125;</span><span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>BUILD_NUMBER<span class="token punctuation">&#125;</span>"<span class="token key atrule">def K8S_CLUSTER = params.k8s_cluster ?</span><span class="token punctuation">:</span> kubernetes// Kubernetes pod template to run.podTemplate(    <span class="token key atrule">cloud</span><span class="token punctuation">:</span> K8S_CLUSTER<span class="token punctuation">,</span>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">label</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">yaml</span><span class="token punctuation">:</span> """<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> runner    <span class="token key atrule">image</span><span class="token punctuation">:</span> golang<span class="token punctuation">:</span>1.17<span class="token punctuation">-</span>buster    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_HOST       <span class="token key atrule">value</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//dinp<span class="token punctuation">-</span>deployment<span class="token punctuation">:</span><span class="token number">2375</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_VERIFY      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jnlp    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"\$(JENKINS_SECRET)"</span><span class="token punctuation">,</span> <span class="token string">"\$(JENKINS_NAME)"</span><span class="token punctuation">]</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"jenkins/inbound-agent:4.11.2-4-alpine"</span>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent"""<span class="token punctuation">,</span>) <span class="token punctuation">&#123;</span>    node(POD_NAME) <span class="token punctuation">&#123;</span>        container("runner") <span class="token punctuation">&#123;</span>            stage("Checkout") <span class="token punctuation">&#123;</span>                retry(10) <span class="token punctuation">&#123;</span>                    checkout(<span class="token punctuation">[</span>                        <span class="token key atrule">$class</span><span class="token punctuation">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span>                        <span class="token key atrule">branches</span><span class="token punctuation">:</span> scm.branches<span class="token punctuation">,</span>                        <span class="token key atrule">doGenerateSubmoduleConfigurations</span><span class="token punctuation">:</span> scm.doGenerateSubmoduleConfigurations<span class="token punctuation">,</span>                        <span class="token key atrule">extensions</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token key atrule">$class</span><span class="token punctuation">:</span> <span class="token string">'CloneOption'</span><span class="token punctuation">,</span> <span class="token key atrule">noTags</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">shallow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">depth</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token key atrule">reference</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token key atrule">userRemoteConfigs</span><span class="token punctuation">:</span> scm.userRemoteConfigs<span class="token punctuation">,</span>                    <span class="token punctuation">]</span>)                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            stage("Build") <span class="token punctuation">&#123;</span>                sh """                <span class="token comment"># make docker-build</span>                docker build <span class="token punctuation">-</span>t app<span class="token punctuation">:</span>v1.0.0<span class="token punctuation">-</span>alpha.1 .                """            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="readinessProbe"><a href="#readinessProbe" class="headerlink" title="readinessProbe"></a>readinessProbe</h3><p>有些时候 dind 无法正常启动，所以一定要设置就绪探针，来确保 diind 容器能够正常启动</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>  <span class="token key atrule">exec</span><span class="token punctuation">:</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>  <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2375-x2F-2376-端口"><a href="#2375-x2F-2376-端口" class="headerlink" title="2375&#x2F;2376 端口"></a>2375&#x2F;2376 端口</h3><p>docker 默认是以 TLS 方式启动，监听端口为 2376，如果设置环境变量 <code>DOCKER_TLS_CERTDIR</code> 为空则就以非 TLS 模式启动，监听端口为 2375，这时就不会校验 TLS 证书。如果使用 2376 端口，则就需要一个持久化存储来将 docker 生成的证书共享给客户端，这点比较麻烦。因此如果不想瞎折腾还是使用 2375 非 TLS 方式吧 😂。</p><h3 id="dinp-必须以开启-privileged-true"><a href="#dinp-必须以开启-privileged-true" class="headerlink" title="dinp 必须以开启 privileged: true"></a>dinp 必须以开启 privileged: true</h3><p>以 pod 方式运行 docker，无论是否是 rootless 模式，都要在 pod 容器的 <code>securityContext</code> 中设置 <code>privileged: true</code>，否则 pod 无法正常启动。而且 rootless 模式也有一定的限制，需要依赖一些内核的特性，目前也只是实验阶段，没有特殊的需求还是尽量不要使用 rootless 特性吧。</p><pre class="line-numbers language-none"><code class="language-none">[root@localhost ~]# kubectl logs -f dinp-sidecarerror: a container name must be specified for pod dinp-sidecar, choose one of: [debug dind][root@localhost ~]# kubectl logs -f dinp-sidecar -c dindDevice &quot;ip_tables&quot; does not exist.ip_tables              27126  4 iptable_raw,iptable_mangle,iptable_filter,iptable_natmodprobe: can&#39;t change directory to &#39;&#x2F;lib&#x2F;modules&#39;: No such file or directoryWARN[0000] failed to mount sysfs, falling back to read-only mount: operation not permittedWARN[0000] failed to mount sysfs: operation not permittedopen: No such file or directory[rootlesskit:child ] error: executing [[ip tuntap add name tap0 mode tap] [ip link set tap0 address 02:50:00:00:00:01]]: exit status 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="rootless-user-max-user-namespaces"><a href="#rootless-user-max-user-namespaces" class="headerlink" title="rootless user.max_user_namespaces"></a>rootless user.max_user_namespaces</h3><p>rootless 模式下需要依赖一些内核参数 <a href="https://docs.docker.com/engine/security/rootless/">Run the Docker daemon as a non-root user (Rootless mode)</a>。在 CentOS 7.9 上会出现 <a href="https://github.com/docker-library/docker/issues/201">dind-rootless: failed to start up dind rootless in k8s due to max_user_namespaces</a> 问题。解决方案是在修改一下 <code>user.max_user_namespaces=28633</code> 内核参数。</p><blockquote><p>Add user.max_user_namespaces&#x3D;28633 to &#x2F;etc&#x2F;sysctl.conf (or &#x2F;etc&#x2F;sysctl.d) and run sudo sysctl -p</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -w</span>NAME                              READY   STATUS   RESTARTS     AGEdinp-deployment-cf488bfd8-g8vxx   <span class="token number">0</span>/1     CrashLoopBackOff   <span class="token number">1</span> <span class="token punctuation">(</span>2s ago<span class="token punctuation">)</span>   4s<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -f dinp-deployment-cf488bfd8-m5cms</span>Device <span class="token string">"ip_tables"</span> does not exist.ip_tables              <span class="token number">27126</span>  <span class="token number">5</span> iptable_raw,iptable_mangle,iptable_filter,iptable_natmodprobe: can<span class="token string">'t change directory to '</span>/lib/modules<span class="token string">': No such file or directoryerror: attempting to run rootless dockerd but need '</span>user.max_user_namespaces' <span class="token punctuation">(</span>/proc/sys/user/max_user_namespaces<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> to a sufficiently large value<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="非-rootless-模式下同一-node-节点只能运行一个-dinp"><a href="#非-rootless-模式下同一-node-节点只能运行一个-dinp" class="headerlink" title="非 rootless 模式下同一 node 节点只能运行一个 dinp"></a>非 rootless 模式下同一 node 节点只能运行一个 dinp</h3><p>如果是使用 deployment 方式部署 dinp，一个 node 节点上只能有一个 dinp Pod，多余的 Pod 无法正常启动。因此如果想要运行多个 dinp Pod，建议使用 daemonset 方式运行它；</p><pre class="line-numbers language-none"><code class="language-none">[root@localhost ~]# kubectl get deployNAME              READY   UP-TO-DATE   AVAILABLE   AGEdinp-deployment   1&#x2F;3     3            1           4m16s[root@localhost ~]# kubectl get pod -wNAME                               READY   STATUS    RESTARTS      AGEdinp-deployment-547bd9bb6d-2mn6c   0&#x2F;1     Running   3 (61s ago)   4m9sdinp-deployment-547bd9bb6d-8ht8l   1&#x2F;1     Running   0             4m9sdinp-deployment-547bd9bb6d-x5vpv   0&#x2F;1     Running   3 (61s ago)   4m9s[root@localhost ~]# kubectl logs -f dinp-deployment-547bd9bb6d-2mn6cINFO[2022-03-14T14:14:10.905652548Z] Starting upWARN[2022-03-14T14:14:10.906986721Z] could not change group &#x2F;var&#x2F;run&#x2F;docker.sock to docker: group docker not foundWARN[2022-03-14T14:14:10.907249071Z] Binding to IP address without --tlsverify is insecure and gives root access on this machine to everyone who has access to your network.  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;WARN[2022-03-14T14:14:10.907269951Z] Binding to an IP address, even on localhost, can also give access to scripts run in a browser. Be safe out there!  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;WARN[2022-03-14T14:14:11.908057635Z] Binding to an IP address without --tlsverify is deprecated. Startup is intentionally being slowed down to show this message  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;WARN[2022-03-14T14:14:11.908103696Z] Please consider generating tls certificates with client validation to prevent exposing unauthenticated root access to your network  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;WARN[2022-03-14T14:14:11.908114541Z] You can override this by explicitly specifying &#39;--tls&#x3D;false&#39; or &#39;--tlsverify&#x3D;false&#39;  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;WARN[2022-03-14T14:14:11.908125477Z] Support for listening on TCP without authentication or explicit intent to run without authentication will be removed in the next release  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;INFO[2022-03-14T14:14:26.914587276Z] libcontainerd: started new containerd process  pid&#x3D;41INFO[2022-03-14T14:14:26.914697125Z] parsed scheme: &quot;unix&quot;                         module&#x3D;grpcINFO[2022-03-14T14:14:26.914710376Z] scheme &quot;unix&quot; not registered, fallback to default scheme  module&#x3D;grpcINFO[2022-03-14T14:14:26.914785052Z] ccResolverWrapper: sending update to cc: &#123;[&#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;] &lt;nil&gt; &lt;nil&gt;&#125;  module&#x3D;grpcINFO[2022-03-14T14:14:26.914796039Z] ClientConn switching balancer to &quot;pick_first&quot;  module&#x3D;grpcINFO[2022-03-14T14:14:26.930311832Z] starting containerd                           revision&#x3D;7b11cfaabd73bb80907dd23182b9347b4245eb5d version&#x3D;v1.4.12INFO[2022-03-14T14:14:26.953641900Z] loading plugin &quot;io.containerd.content.v1.content&quot;...  type&#x3D;io.containerd.content.v1INFO[2022-03-14T14:14:26.953721059Z] loading plugin &quot;io.containerd.snapshotter.v1.aufs&quot;...  type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960295816Z] skip loading plugin &quot;io.containerd.snapshotter.v1.aufs&quot;...  error&#x3D;&quot;aufs is not supported (modprobe aufs failed: exit status 1 \&quot;ip: can&#39;t find device &#39;aufs&#39;\\nmodprobe: can&#39;t change directory to &#39;&#x2F;lib&#x2F;modules&#39;: No such file or directory\\n\&quot;): skip plugin&quot; type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960329840Z] loading plugin &quot;io.containerd.snapshotter.v1.btrfs&quot;...  type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960524514Z] skip loading plugin &quot;io.containerd.snapshotter.v1.btrfs&quot;...  error&#x3D;&quot;path &#x2F;var&#x2F;lib&#x2F;docker&#x2F;containerd&#x2F;daemon&#x2F;io.containerd.snapshotter.v1.btrfs (xfs) must be a btrfs filesystem to be used with the btrfs snapshotter: skip plugin&quot; type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960537441Z] loading plugin &quot;io.containerd.snapshotter.v1.devmapper&quot;...  type&#x3D;io.containerd.snapshotter.v1WARN[2022-03-14T14:14:26.960558843Z] failed to load plugin io.containerd.snapshotter.v1.devmapper  error&#x3D;&quot;devmapper not configured&quot;INFO[2022-03-14T14:14:26.960569516Z] loading plugin &quot;io.containerd.snapshotter.v1.native&quot;...  type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960593224Z] loading plugin &quot;io.containerd.snapshotter.v1.overlayfs&quot;...  type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960678728Z] loading plugin &quot;io.containerd.snapshotter.v1.zfs&quot;...  type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960814844Z] skip loading plugin &quot;io.containerd.snapshotter.v1.zfs&quot;...  error&#x3D;&quot;path &#x2F;var&#x2F;lib&#x2F;docker&#x2F;containerd&#x2F;daemon&#x2F;io.containerd.snapshotter.v1.zfs must be a zfs filesystem to be used with the zfs snapshotter: skip plugin&quot; type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960827133Z] loading plugin &quot;io.containerd.metadata.v1.bolt&quot;...  type&#x3D;io.containerd.metadata.v1WARN[2022-03-14T14:14:26.960839223Z] could not use snapshotter devmapper in metadata plugin  error&#x3D;&quot;devmapper not configured&quot;INFO[2022-03-14T14:14:26.960848698Z] metadata content store policy set             policy&#x3D;sharedWARN[2022-03-14T14:14:27.915528371Z] grpc: addrConn.createTransport failed to connect to &#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;. Err :connection error: desc &#x3D; &quot;transport: error while dialing: dial unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock: timeout&quot;. Reconnecting...  module&#x3D;grpcWARN[2022-03-14T14:14:30.722257725Z] grpc: addrConn.createTransport failed to connect to &#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;. Err :connection error: desc &#x3D; &quot;transport: error while dialing: dial unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock: timeout&quot;. Reconnecting...  module&#x3D;grpcWARN[2022-03-14T14:14:35.549453706Z] grpc: addrConn.createTransport failed to connect to &#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;. Err :connection error: desc &#x3D; &quot;transport: error while dialing: dial unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock: timeout&quot;. Reconnecting...  module&#x3D;grpcWARN[2022-03-14T14:14:41.759010407Z] grpc: addrConn.createTransport failed to connect to &#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;. Err :connection error: desc &#x3D; &quot;transport: error while dialing: dial unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock: timeout&quot;. Reconnecting...  module&#x3D;grpcfailed to start containerd: timeout waiting for containerd to start<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="x2F-var-x2F-lib-x2F-docker-不支持共享存储"><a href="#x2F-var-x2F-lib-x2F-docker-不支持共享存储" class="headerlink" title="&#x2F;var&#x2F;lib&#x2F;docker 不支持共享存储"></a>&#x2F;var&#x2F;lib&#x2F;docker 不支持共享存储</h3><p>陈少文博主曾在 《<a href="https://www.chenshaowen.com/blog/can-we-mount-var-lib-docker-to-remote-storage.html">&#x2F;var&#x2F;lib&#x2F;docker 能不能挂载远端存储</a>》提到过 docker 目前并支持将 <code>/var/lib/docker</code> 挂载远程存储使用，因此建议使用 hostPath 的方式保存 docker 的持久化存储数据。</p><blockquote><p>本次测试使用的 Docker 版本为 20.10.6，不能将 <code>/var/lib/docker</code> 挂载远程存储使用。主要原因是容器的实现依赖于内核的能力(xttrs)，而类似 NFS Server 这种远程存储无法提供这些能力。如果采用 Device Mapper 进行映射，使用磁盘挂载存在可行性，但只能用于迁移而不能实现共享。</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">INFO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.750810130Z<span class="token punctuation">]</span> ClientConn switching balancer to <span class="token string">"pick_first"</span>  <span class="token assign-left variable">module</span><span class="token operator">=</span>grpcERRO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.781932359Z<span class="token punctuation">]</span> failed to <span class="token function">mount</span> overlay: invalid argument     storage-driver<span class="token operator">=</span>overlay2ERRO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.782078828Z<span class="token punctuation">]</span> exec: <span class="token string">"fuse-overlayfs"</span><span class="token builtin class-name">:</span> executable <span class="token function">file</span> not found <span class="token keyword">in</span> <span class="token environment constant">$PATH</span>  storage-driver<span class="token operator">=</span>fuse-overlayfsERRO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.793311119Z<span class="token punctuation">]</span> AUFS was not found <span class="token keyword">in</span> /proc/filesystems       storage-driver<span class="token operator">=</span>aufsERRO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.813505621Z<span class="token punctuation">]</span> failed to <span class="token function">mount</span> overlay: invalid argument     storage-driver<span class="token operator">=</span>overlayERRO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.813529990Z<span class="token punctuation">]</span> Failed to built-in GetDriver graph devicemapper /var/lib/dockerINFO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.897769363Z<span class="token punctuation">]</span> Loading containers: start.WARN<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.919252078Z<span class="token punctuation">]</span> Running modprobe bridge br_netfilter failed with message: ip: can<span class="token string">'t find device '</span>bridge'<span class="token punctuation">[</span>root@localhost dinp<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it dinp-sidecar -c debug sh</span>/ <span class="token comment"># docker pull alpine</span>Using default tag: latestError response from daemon: error creating temporary lease: <span class="token function">file</span> resize error: truncate /var/lib/docker/containerd/daemon/io.containerd.metadata.v1.bolt/meta.db: bad <span class="token function">file</span> descriptor: unknown<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://www.bilibili.com/video/BV1Xa411C78k">Dockershim 即将被移除，你准备好了么？</a></li><li><a href="https://draveness.me/whys-the-design-kubernetes-deprecate-docker/">为什么 Kubernetes 要替换 Docker</a></li><li><a href="https://applatix.com/case-docker-docker-kubernetes-part-2">A case for Docker-in-Docker on Kubernetes</a></li><li><a href="https://docs.docker.com/engine/security/rootless/">Run the Docker daemon as a non-root user (Rootless mode)</a></li><li><a href="https://github.com/docker-library/docker">Docker Official Image packaging for Docker</a></li><li><a href="https://www.chenshaowen.com/blog/can-we-mount-var-lib-docker-to-remote-storage.html">&#x2F;var&#x2F;lib&#x2F;docker 能不能挂载远端存储</a></li><li><a href="https://www.chenshaowen.com/blog/how-to-use-docker-in-docker.html">如何在 Docker 中使用 Docker</a></li><li><a href="https://www.chenshaowen.com/blog/using-podman-to-build-images-under-kubernetes-and-jenkins.html">基于 Kubernetes 的 Jenkins 服务也可以去 Docker 了</a></li><li><a href="https://github.com/docker-library/docker/issues/201">dind-rootless: failed to start up dind rootless in k8s due to max_user_namespaces #201</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;上个月参加了 Rancher 社区举办的 《&lt;a
        
      
    
    </summary>
    
    
      <category term="技术" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubernetes" scheme="https://blog.k8s.li/tags/kubernetes/"/>
    
      <category term="docker" scheme="https://blog.k8s.li/tags/docker/"/>
    
      <category term="dind" scheme="https://blog.k8s.li/tags/dind/"/>
    
      <category term="dinp" scheme="https://blog.k8s.li/tags/dinp/"/>
    
      <category term="jenkins" scheme="https://blog.k8s.li/tags/jenkins/"/>
    
  </entry>
  
  <entry>
    <title>使用 kubectl 自动归档 argo workflow 日志</title>
    <link href="https://blog.k8s.li/archive-argo-workflow-log-by-kubectl.html"/>
    <id>https://blog.k8s.li/archive-argo-workflow-log-by-kubectl.html</id>
    <published>2022-02-27T16:00:00.000Z</published>
    <updated>2022-02-27T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>项目上使用到 <a href="https://github.com/argoproj/argo-workflows">argo-workflow</a> 作为工作流引擎来编排运行一些 <a href="https://www.smartx.com/solution/virtualization/">超融合</a> 集群部署相关的任务，整套环境运行在一个单节点的 K3s 上。之所以选择 argo-workflow + K3s 的搭配主要是想尽可能少地占用系统资源，因为这套环境将来会运行在各种硬件配置不同的笔记本电脑上 😂。综合调研了一些常见的 K8s 部署工具最终就选择了系统资源占用较少的 K3s。</p><p>现在项目的一个需求就是在集群部署完成或失败之后需要将 workflow 的日志归档保存下来。虽然可以在 workflow 的 spec 字段中使用 <code>archiveLogs: true</code> 来让 argo 帮我们自动归档日志，但这个特性依赖于一个 S3 对象存储 <a href="https://argoproj.github.io/argo-workflows/configure-artifact-repository/">Artifact Repository</a> 。这就意味着还要再部署一个支持 S3 对象存储的组件比如 <a href="https://min.io/">Minio</a> ，直接把我给整不会了 🌚</p><p><img data-src="https://p.k8s.li/2021-08-31-pass-tob-k8s-offline-deploy-2.jpeg"></p><p>其实嘛这个需求很简单的，我就想保存一个日志文件而已，你还再让我安装一个 <a href="https://min.io/">Minio</a>，实在是太过分了！本来系统的资源十分有限，需要尽可能减少安装一些不必要依赖，为的就是将资源利用率将到最低。但现在为了归档存储一个日志文件储而大动干戈装一个 minio 实在是不划算。这就好比你费了好大功夫部署一套 3 节点的 kubernetes 集群，然而就为了运行一个静态博客那样滑稽 😂</p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Deployed my blog on Kubernetes <a href="https://t.co/XHXWLrmYO4">pic.twitter.com/XHXWLrmYO4</a></p>&mdash; For DevOps Eyes Only (@dexhorthy) <a href="https://twitter.com/dexhorthy/status/856639005462417409?ref_src=twsrc%5Etfw">April 24, 2017</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>对于咱这种 <code>用不起</code> S3 对象存储的穷人家孩子，还是想一些其他办法吧，毕竟自己动手丰衣足食。</p><h2 id="kubectl"><a href="#kubectl" class="headerlink" title="kubectl"></a>kubectl</h2><p>实现起来也比较简单，对于咱这种 YAML 工程师来说，kubectl 自然再熟悉不过了。想要获取 workflow 的日志，只需要通过 kubectl logs 命令获取出 workflow 所创的 pod 日志就行了呀，要什么 S3 对象存储 😖</p><h3 id="筛选-pod"><a href="#筛选-pod" class="headerlink" title="筛选 pod"></a>筛选 pod</h3><p>对于同一个 workflow 来将，每个 stage 所创建出来的 pod name 有一定的规律。在定义 workflow 的时候，<a href="https://argoproj.github.io/argo-workflows/fields/#objectmeta">generateName</a> 参数通常使用 <code>$&#123;name&#125;-</code> 格式。以 <code>-</code> 作为分隔符，最后一个字段是随机生成的一个数字 ID，倒数第二个字段则是 argo 随机生成的 workflow ID，剩余前面的字符则是我们定义的 generateName。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Workflow<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">generateName</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">archive-log-test-jzt8n-3498199655                          <span class="token number">0</span>/2     Completed   <span class="token number">0</span>               4m18sarchive-log-test-jzt8n-3618624526                          <span class="token number">0</span>/2     Completed   <span class="token number">0</span>               4m8sarchive-log-test-jzt8n-2123203324                          <span class="token number">0</span>/2     Completed   <span class="token number">0</span>               3m58s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在 pod 的 labels 中同样也包含着该 workflow 所对应的 ID，因此我们可以根据此 labels 过滤出该 workflow 所创建出来的 pod。</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">workflows.argoproj.io/node-id</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span>jzt8n<span class="token punctuation">-</span><span class="token number">3498199655</span>    <span class="token key atrule">workflows.argoproj.io/node-name</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span>jzt8n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.list<span class="token punctuation">-</span>default<span class="token punctuation">-</span>running<span class="token punctuation">-</span>pods  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2022-02-28T12:53:32Z"</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">workflows.argoproj.io/completed</span><span class="token punctuation">:</span> <span class="token string">"true"</span>    <span class="token key atrule">workflows.argoproj.io/workflow</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span>jzt8n  <span class="token key atrule">name</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span>jzt8n<span class="token punctuation">-</span><span class="token number">3498199655</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">ownerReferences</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1    <span class="token key atrule">blockOwnerDeletion</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">controller</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Workflow    <span class="token key atrule">name</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span>jzt8n    <span class="token key atrule">uid</span><span class="token punctuation">:</span> e91df2cb<span class="token punctuation">-</span>b567<span class="token punctuation">-</span>4cf0<span class="token punctuation">-</span>9be5<span class="token punctuation">-</span>3dd6c72854cd  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"1251330"</span>  <span class="token key atrule">uid</span><span class="token punctuation">:</span> ce37a709<span class="token punctuation">-</span>8236<span class="token punctuation">-</span>445b<span class="token punctuation">-</span>8d00<span class="token punctuation">-</span>a7926fa18ed0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过 <code>-l lables</code> 过滤出一个 workflow 所创建的 pod；通过 <code>--sort-by</code> 以创建时间进行排序；通过 <code>-o name</code> 只输出 pod 的 name：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get pods <span class="token parameter variable">-l</span> workflows.argoproj.io/workflow<span class="token operator">=</span>archive-log-test-jzt8n --sort-by<span class="token operator">=</span><span class="token string">'.metadata.creationTimestamp'</span> <span class="token parameter variable">-o</span> namepod/archive-log-test-jzt8n-3498199655pod/archive-log-test-jzt8n-3618624526pod/archive-log-test-jzt8n-2123203324<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="获取日志"><a href="#获取日志" class="headerlink" title="获取日志"></a>获取日志</h3><p>通过上面的步骤我们就可以获取到一个 workflow 所创建的 pod 列表。然后再通过 kubectl logs 命令获取 pod 中 main 容器的日志，为方便区分日志的所对应的 workflow ，我们就以 workflow 的 ID 为前缀名。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl logs archive-log-test-jzt8n-3618624526 <span class="token parameter variable">-c</span> main<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">LOG_PATH</span><span class="token operator">=</span>/var/log<span class="token assign-left variable">NAME</span><span class="token operator">=</span>archive-log-test-jzt8nkubectl get pods <span class="token parameter variable">-l</span> workflows.argoproj.io/workflow<span class="token operator">=</span><span class="token variable">$&#123;NAME&#125;</span> <span class="token punctuation">\</span>--sort-by<span class="token operator">=</span><span class="token string">'.metadata.creationTimestamp'</span> <span class="token parameter variable">-o</span> name <span class="token punctuation">\</span><span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-I</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token parameter variable">-t</span> kubectl logs <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token parameter variable">-c</span> main <span class="token operator">>></span> <span class="token variable">$&#123;LOG_PATH&#125;</span>/<span class="token variable">$&#123;NAME&#125;</span>.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="workflow"><a href="#workflow" class="headerlink" title="workflow"></a>workflow</h3><p>根据 argo-workflow 官方提供的 <a href="https://github.com/argoproj/argo-workflows/blob/master/examples/exit-handlers.yaml"><strong>exit-handlers.yaml</strong></a> example，我们就照葫芦画瓢搓一个 workflow 退出后自动调用使用 kubectl 获取 workflow 日志的一个 step，定义的 exit-handler 内容如下：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> exit<span class="token punctuation">-</span>handler    <span class="token key atrule">container</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"kubectl"</span>      <span class="token key atrule">image</span><span class="token punctuation">:</span> lachlanevenson/k8s<span class="token punctuation">-</span>kubectl<span class="token punctuation">:</span>v1.23.2      <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> sh        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">          kubectl get pods -l workflows.argoproj.io/workflow=$&#123;POD_NAME%-*&#125; \          --sort-by=".metadata.creationTimestamp" -o name | grep -v $&#123;POD_NAME&#125; \          | xargs -I &#123;&#125; -t kubectl logs &#123;&#125; -c main >> $&#123;LOG_PATH&#125;/$&#123;POD_NAME%-*&#125;.log</span>      <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> LOG_PATH          <span class="token key atrule">value</span><span class="token punctuation">:</span> /var/log/workflow      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>datastore          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/workflow    <span class="token key atrule">retryStrategy</span><span class="token punctuation">:</span>      <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token string">"5"</span>      <span class="token key atrule">retryPolicy</span><span class="token punctuation">:</span> OnFailure<span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> default<span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>datastore    <span class="token key atrule">nfs</span><span class="token punctuation">:</span>      <span class="token key atrule">server</span><span class="token punctuation">:</span> NFS_SERVER      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/workflow/log<span class="token key atrule">onExit</span><span class="token punctuation">:</span> exit<span class="token punctuation">-</span>handler<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>将上述定义的 <code>exit-handler</code> 内容复制粘贴到你的 workflow spec 配置中就可以。由于日志需要持久化存储，我这里使用的是 NFS 存储，也可以根据自己的需要换成其他存储，只需要修改一下 <code>volumes</code> 配置即可。</p><p>完整的 <a href="https://gist.github.com/muzi502/9b26c6854c509c42ecd7f7004436ca23">workflow example</a> 如下：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Workflow<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">generateName</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">templates</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test      <span class="token key atrule">steps</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> list<span class="token punctuation">-</span>default<span class="token punctuation">-</span>running<span class="token punctuation">-</span>pods            <span class="token key atrule">template</span><span class="token punctuation">:</span> kubectl            <span class="token key atrule">arguments</span><span class="token punctuation">:</span>              <span class="token key atrule">parameters</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> namespace                  <span class="token key atrule">value</span><span class="token punctuation">:</span> default        <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> list<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>system<span class="token punctuation">-</span>running<span class="token punctuation">-</span>pods            <span class="token key atrule">template</span><span class="token punctuation">:</span> kubectl            <span class="token key atrule">arguments</span><span class="token punctuation">:</span>              <span class="token key atrule">parameters</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> namespace                  <span class="token key atrule">value</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubectl      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>        <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> namespace      <span class="token key atrule">container</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"kubectl"</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> lachlanevenson/k8s<span class="token punctuation">-</span>kubectl<span class="token punctuation">:</span>v1.23.2        <span class="token key atrule">command</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> sh          <span class="token punctuation">-</span> <span class="token punctuation">-</span>c          <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">            kubectl get pods --field-selector=status.phase=Running -n &#123;&#123;inputs.parameters.namespace&#125;&#125;</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> exit<span class="token punctuation">-</span>handler      <span class="token key atrule">container</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"kubectl"</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> lachlanevenson/k8s<span class="token punctuation">-</span>kubectl<span class="token punctuation">:</span>v1.23.2        <span class="token key atrule">command</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> sh          <span class="token punctuation">-</span> <span class="token punctuation">-</span>c          <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">            kubectl get pods -l workflows.argoproj.io/workflow=$&#123;POD_NAME%-*&#125; \            --sort-by=".metadata.creationTimestamp" -o name | grep -v $&#123;POD_NAME&#125; \            | xargs -I &#123;&#125; -t kubectl logs &#123;&#125; -c main >> $&#123;LOG_PATH&#125;/$&#123;POD_NAME%-*&#125;.log</span>        <span class="token key atrule">env</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>              <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> LOG_PATH            <span class="token key atrule">value</span><span class="token punctuation">:</span> /var/log/workflow        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>datastore            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/workflow      <span class="token key atrule">retryStrategy</span><span class="token punctuation">:</span>        <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token string">"5"</span>        <span class="token key atrule">retryPolicy</span><span class="token punctuation">:</span> OnFailure  <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> default  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>datastore      <span class="token key atrule">nfs</span><span class="token punctuation">:</span>        <span class="token key atrule">server</span><span class="token punctuation">:</span> NFS_SERVER        <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/workflow/log  <span class="token key atrule">onExit</span><span class="token punctuation">:</span> exit<span class="token punctuation">-</span>handler<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;项目上使用到 &lt;a
        
      
    
    </summary>
    
    
      <category term="技术" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubectl" scheme="https://blog.k8s.li/tags/kubectl/"/>
    
      <category term="argo-workflow" scheme="https://blog.k8s.li/tags/argo-workflow/"/>
    
  </entry>
  
  <entry>
    <title>VMware Tanzu kubernetes 发行版部署尝鲜</title>
    <link href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html"/>
    <id>https://blog.k8s.li/deploy-tanzu-k8s-cluster.html</id>
    <published>2022-02-05T16:00:00.000Z</published>
    <updated>2022-02-05T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>之前接触的 Kubernetes 集群部署工具大多数都是依赖于 ssh 连接到待部署的节点上进行部署操作，这样就要求部署前需要提前准备好集群节点，且要保证这些节点的网络互通以及时钟同步等问题。类似于 kubespray 或者 kubekey 这些部署工具是不会去管这些底层的 IaaS 资源的创建，是要自己提前准备好。但是在一些企业私有云环境中，使用了如 <a href="https://docs.vmware.com/cn/VMware-vSphere/index.html">VMware vShpere</a> 或 <a href="https://www.openstack.org/">OpenStack</a> 这些虚拟化平台，是可以将 K8s 集群部署与 IaaS 资源创建这两步统一起来的，这样就可以避免手动创建和配置虚拟机这些繁琐的步骤。</p><p>目前将 IaaS 资源创建与 K8s 集群部署结合起来也有比较成熟的方案，比如基于 <a href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> 项目的 <a href="https://github.com/vmware-tanzu">tanzu</a> 。本文就以 <a href="https://github.com/vmware-tanzu/community-edition">VMware Tanzu 社区版</a> 为例在一台物理服务器上，从安装 ESXi OS 到部署完成 Tanzu Workload 集群，来体验一下这种部署方案的与众不同之处。</p><h2 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h2><ul><li>下载依赖文件</li><li>安装 govc 依赖</li><li>安装 ESXi OS</li><li>安装 vCenter</li><li>配置 vCenter</li><li>创建 bootstrap 虚拟机</li><li>初始化 bootstrap 节点</li><li>部署 Tanzu Manager 集群</li><li>部署 Tanzu Workload 集群</li></ul><h3 id="劝退三连-😂"><a href="#劝退三连-😂" class="headerlink" title="劝退三连 😂"></a>劝退三连 😂</h3><ul><li>需要有一个 <a href="https://customerconnect.vmware.com/login">VMware 的账户</a> 用于下载一些 ISO 镜像和虚拟机模版;</li><li>需要有一台物理服务器，推荐最低配置 8C 32G，至少 256GB 存储；</li><li>需要一台 DHCP 服务器，由于默认是使用 DHCP 获取 IP 来分配给虚拟机的，因此 ESXi 所在的 VM Network  网络中必须有一台 DHCP 服务器用于给虚拟机分配 IP；</li></ul><h3 id="下载依赖文件"><a href="#下载依赖文件" class="headerlink" title="下载依赖文件"></a>下载依赖文件</h3><p>整个部署流程所需要的依文件赖如下，可以先将这些依赖下载到本地的机器上，方便后续使用。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@devbox:/root/tanzu <span class="token comment"># tree -sh</span><span class="token builtin class-name">.</span>├── <span class="token punctuation">[</span>  12M<span class="token punctuation">]</span>  govc_Linux_x86_64.tar.gz├── <span class="token punctuation">[</span> 895M<span class="token punctuation">]</span>  photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova├── <span class="token punctuation">[</span> 225M<span class="token punctuation">]</span>  photon-ova-4.0-c001795b80.ova├── <span class="token punctuation">[</span> 170M<span class="token punctuation">]</span>  tce-linux-amd64-v0.9.1.tar.gz├── <span class="token punctuation">[</span> <span class="token number">9</span>.0G<span class="token punctuation">]</span>  VMware-VCSA-all-7.0.3-18778458.iso└── <span class="token punctuation">[</span> 390M<span class="token punctuation">]</span>  VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>文件</th><th>用途</th><th>下载方式</th></tr></thead><tbody><tr><td><a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=ESXI70U2A&productId=974&rPId=46384">VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso</a></td><td>安装 ESXi OS</td><td>VMware 需账户</td></tr><tr><td><a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=VC70U3C&productId=974&rPId=83853">VMware-VCSA-all-7.0.3-19234570.iso</a></td><td>安装 vCenter</td><td>VMware 需账户</td></tr><tr><td><a href="https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova">photon-ova-4.0-c001795b80.ova</a></td><td>bootstrap 节点</td><td>VMware</td></tr><tr><td><a href="https://customerconnect.vmware.com/downloads/get-download?downloadGroup=TCE-090">photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</a></td><td>tanzu 集群节点</td><td>VMware 需账户</td></tr><tr><td><a href="https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz">tce-linux-amd64-v0.9.1.tar.gz</a></td><td>tanzu 社区版</td><td>GitHub release</td></tr><tr><td><a href="https://github.com/vmware/govmomi/releases/download/v0.27.3/govc_Linux_x86_64.tar.gz">govc_Linux_x86_64.tar.gz</a></td><td>安装&#x2F;配置 vCenter</td><td>GitHub release</td></tr></tbody></table><p>注意 ESXi 和 vCenter 的版本最好是 7.0 及以上，我只在 ESXi 7.0.2 和 vCenter 7.0.3 上测试过，其他版本可能会有些差异；另外 ESXi 的版本不建议使用最新的 7.0.3，因为有比较严重的 bug，官方也建议用户生产环境不要使用该版本了 <a href="https://kb.vmware.com/s/article/86287">vSphere 7.0 Update 3 Critical Known Issues - Workarounds &amp; Fix (86287)</a> 。</p><h3 id="安装-govc-及依赖"><a href="#安装-govc-及依赖" class="headerlink" title="安装 govc 及依赖"></a>安装 govc 及依赖</h3><p>在本地机器上安装好 govc 和 jq，这两个工具后面在配置 vCenter 的时候会用到。</p><ul><li>macOS</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ brew <span class="token function">install</span> govc jq<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>Debian&#x2F;Ubuntu</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">tar</span> <span class="token parameter variable">-xf</span> govc_Linux_x86_64.tar.gz <span class="token parameter variable">-C</span> /usr/local/bin$ <span class="token function">apt</span> <span class="token function">install</span> jq <span class="token parameter variable">-y</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>其他 Linux 可以在 govc 和 jq 的 GitHub 上下载对应的安装文件进行安装。</li></ul><h3 id="安装-ESXi-OS"><a href="#安装-ESXi-OS" class="headerlink" title="安装 ESXi OS"></a>安装 ESXi OS</h3><p>ESXi OS 的安装网上有很多教程，没有太多值得讲解的地方，因此就参照一下其他大佬写的博客或者官方的安装文档 <a href="https://docs.vmware.com/cn/VMware-vSphere/7.0/vsphere-esxi-701-installation-setup-guide.pdf">VMware ESXi 安装和设置</a> 来就行；需要注意一点，ESXi OS 安装时 VMFSL 分区将会占用大量的存储空间，这将会使得 ESXi OS 安装所在的磁盘最终创建出来的 datastore 比预期小很多，而且这个 VMFSL 分区在安装好之后就很难再做调整了。因此如果磁盘存储空间比较紧张，在安装 ESXi OS 之前可以考虑下如何去掉这个分区；或者和我一样将 ESXI OS 安装在了一个 16G 的 USB Dom 盘上，不过生产环境不建议采用这种方案 😂（其实个人觉着安装在 U 盘上问题不大，ESXi OS 启动之后是加载到内存中运行的，不会对 U 盘有大量的读写操作，只不过在机房中 U 盘被人不小心拔走就凉了。</p><ul><li>设置 govc 环境变量</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ESXi 节点的 IP</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">ESXI_IP</span><span class="token operator">=</span><span class="token string">"192.168.18.47"</span><span class="token comment"># ESXi 登录的用户名，初次安装后默认为 root</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_USERNAME</span><span class="token operator">=</span><span class="token string">"root"</span><span class="token comment"># 在 ESXi 安装时设置的 root 密码</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_PASSWORD</span><span class="token operator">=</span><span class="token string">"admin@2022"</span><span class="token comment"># 允许不安全的 SSL 连接</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_INSECURE</span><span class="token operator">=</span>true<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_URL</span><span class="token operator">=</span><span class="token string">"https://<span class="token variable">$&#123;ESXI_IP&#125;</span>"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_DATASTORE</span><span class="token operator">=</span>datastore1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>测试 govc 是否能正常连接 ESXi 主机</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Name:              localhost.local  Path:            /ha-datacenter/host/localhost/localhost  Manufacturer:    Dell  Logical CPUs:    <span class="token number">20</span> CPUs @ 2394MHz  Processor type:  Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Xeon<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Silver 4210R CPU @ <span class="token number">2</span>.40GHz  CPU usage:       <span class="token number">579</span> MHz <span class="token punctuation">(</span><span class="token number">1.2</span>%<span class="token punctuation">)</span>  Memory:          261765MB  Memory usage:    <span class="token number">16457</span> MB <span class="token punctuation">(</span><span class="token number">6.3</span>%<span class="token punctuation">)</span>  Boot time:       <span class="token number">2022</span>-02-02 <span class="token number">11</span>:53:59.630124 +0000 UTC  State:           connected<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="安装-vCenter"><a href="#安装-vCenter" class="headerlink" title="安装 vCenter"></a>安装 vCenter</h3><p>按照 VMware 官方的 vCenter 安装文档 <a href="https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vcenter.install.doc/GUID-8DC3866D-5087-40A2-8067-1361A2AF95BD.html">关于 vCenter Server 安装和设置</a> 来安装实在是过于繁琐，其实官方的 ISO 安装方式无非是运行一个 installer web 服务，然后在浏览器上配置好 vCenter 虚拟机的参数，再将填写的配置信息在部署 vcsa 虚拟机的时候注入到 ova 的配置参数中。</p><p>知道这个安装过程的原理之后我们也可以自己配置 vCenter 的参数信息，然后通过 govc 来部署 ova；这比使用 UI 的方式简单方便很多，最终只需要填写一个配置文件，一条命令就可以部署完成啦。</p><ul><li>首先是挂载 vCenter 的 ISO，找到 vcsa ova 文件，它是 vCenter 虚拟机的模版</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">mount</span> <span class="token parameter variable">-o</span> loop VMware-VCSA-all-7.0.3-18778458.iso /mnt$ <span class="token function">ls</span> /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova/mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>根据自己的环境信息修改下面安装脚本中的相关配置：</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span><span class="token assign-left variable">VCSA_OVA_FILE</span><span class="token operator">=</span><span class="token variable">$1</span><span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> errexit<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> nounset<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> pipefail<span class="token comment"># ESXi 的 IP 地址</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">ESXI_IP</span><span class="token operator">=</span><span class="token string">"192.168.18.47"</span><span class="token comment"># ESXi 的用户名</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_USERNAME</span><span class="token operator">=</span><span class="token string">"root"</span><span class="token comment"># ESXI 的密码</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_PASSWORD</span><span class="token operator">=</span><span class="token string">"admin@2020"</span><span class="token comment"># 安装 vCenter 虚拟机使用的 datastore 名称</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_DATASTORE</span><span class="token operator">=</span>datastore1<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_INSECURE</span><span class="token operator">=</span>true<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_URL</span><span class="token operator">=</span><span class="token string">"https://<span class="token variable">$&#123;ESXI_IP&#125;</span>"</span><span class="token comment"># vCenter 的登录密码</span><span class="token assign-left variable">VM_PASSWORD</span><span class="token operator">=</span><span class="token string">"admin@2020"</span><span class="token comment"># vCenter 的 IP 地址</span><span class="token assign-left variable">VM_IP</span><span class="token operator">=</span><span class="token number">192.168</span>.20.92<span class="token comment"># vCenter 虚拟机的名称</span><span class="token assign-left variable">VM_NAME</span><span class="token operator">=</span>vCenter-Server-Appliance<span class="token comment"># vCenter 虚拟机使用的网络</span><span class="token assign-left variable">VM_NETWORK</span><span class="token operator">=</span><span class="token string">"VM Network"</span><span class="token comment"># DNS 服务器</span><span class="token assign-left variable">VM_DNS</span><span class="token operator">=</span><span class="token string">"223.6.6.6"</span><span class="token comment"># NTP 服务器</span><span class="token assign-left variable">VM_NTP</span><span class="token operator">=</span><span class="token string">"0.pool.ntp.org"</span><span class="token function-name function">deploy_vcsa_vm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token assign-left variable">config</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>govc host.info <span class="token parameter variable">-k</span> <span class="token parameter variable">-json</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">'.HostSystems[].Config'</span><span class="token variable">)</span></span>    <span class="token assign-left variable">gateway</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>jq <span class="token parameter variable">-r</span> <span class="token string">'.Network.IpRouteConfig.DefaultGateway'</span> <span class="token operator">&lt;&lt;&lt;</span><span class="token string">"<span class="token variable">$config</span>"</span><span class="token variable">)</span></span>    <span class="token assign-left variable">route</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>jq <span class="token parameter variable">-r</span> <span class="token string">'.Network.RouteTableInfo.IpRoute[] | select(.DeviceName == "vmk0") | select(.Gateway == "0.0.0.0")'</span> <span class="token operator">&lt;&lt;&lt;</span><span class="token string">"<span class="token variable">$config</span>"</span><span class="token variable">)</span></span>    <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>jq <span class="token parameter variable">-r</span> <span class="token string">'.PrefixLength'</span> <span class="token operator">&lt;&lt;&lt;</span><span class="token string">"<span class="token variable">$route</span>"</span><span class="token variable">)</span></span>    <span class="token assign-left variable">opts</span><span class="token operator">=</span><span class="token punctuation">(</span>        <span class="token assign-left variable">cis.vmdir.password</span><span class="token operator">=</span><span class="token variable">$&#123;VM_PASSWORD&#125;</span>        <span class="token assign-left variable">cis.appliance.root.passwd</span><span class="token operator">=</span><span class="token variable">$&#123;VM_PASSWORD&#125;</span>        <span class="token assign-left variable">cis.appliance.root.shell</span><span class="token operator">=</span>/bin/bash        <span class="token assign-left variable">cis.deployment.node.type</span><span class="token operator">=</span>embedded        cis.vmdir.domain-name<span class="token operator">=</span>vsphere.local        cis.vmdir.site-name<span class="token operator">=</span>VCSA        <span class="token assign-left variable">cis.appliance.net.addr.family</span><span class="token operator">=</span>ipv4        <span class="token assign-left variable">cis.appliance.ssh.enabled</span><span class="token operator">=</span>True        <span class="token assign-left variable">cis.ceip_enabled</span><span class="token operator">=</span>False        <span class="token assign-left variable">cis.deployment.autoconfig</span><span class="token operator">=</span>True        <span class="token assign-left variable">cis.appliance.net.addr</span><span class="token operator">=</span><span class="token variable">$&#123;VM_IP&#125;</span>        <span class="token assign-left variable">cis.appliance.net.prefix</span><span class="token operator">=</span><span class="token variable">$&#123;prefix&#125;</span>        <span class="token assign-left variable">cis.appliance.net.dns.servers</span><span class="token operator">=</span><span class="token variable">$&#123;VM_DNS&#125;</span>        <span class="token assign-left variable">cis.appliance.net.gateway</span><span class="token operator">=</span><span class="token variable">$gateway</span>        <span class="token assign-left variable">cis.appliance.ntp.servers</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;VM_NTP&#125;</span>"</span>        <span class="token assign-left variable">cis.appliance.net.mode</span><span class="token operator">=</span>static    <span class="token punctuation">)</span>    <span class="token assign-left variable">props</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">printf</span> -- <span class="token string">"guestinfo.%s<span class="token entity" title="\n">\n</span>"</span> <span class="token string">"<span class="token variable">$&#123;opts<span class="token punctuation">[</span>@<span class="token punctuation">]</span>&#125;</span>"</span> <span class="token operator">|</span> jq <span class="token parameter variable">--slurp</span> <span class="token parameter variable">-R</span> 'split<span class="token punctuation">(</span><span class="token string">"<span class="token entity" title="\n">\n</span>"</span><span class="token punctuation">)</span> <span class="token operator">|</span> map<span class="token punctuation">(</span>select<span class="token punctuation">(</span>. <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token variable">)</span></span> <span class="token operator">|</span> map<span class="token punctuation">(</span>split<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">))</span> <span class="token operator">|</span> map<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"Key"</span><span class="token builtin class-name">:</span> .<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, <span class="token string">"Value"</span><span class="token builtin class-name">:</span> .<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>'<span class="token punctuation">)</span>    <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> govc import.<span class="token variable">$&#123;VCSA_OVA_FILE<span class="token operator">##</span>*.&#125;</span> <span class="token parameter variable">-options</span> - <span class="token string">"<span class="token variable">$&#123;VCSA_OVA_FILE&#125;</span>"</span></span>    &#123;    "Name": "<span class="token variable">$&#123;VM_NAME&#125;</span>",    "Deployment": "tiny",    "DiskProvisioning": "thin",    "IPProtocol": "IPv4",    "Annotation": "VMware vCenter Server Appliance",    "PowerOn": false,    "WaitForIP": false,    "InjectOvfEnv": true,    "NetworkMapping": [        &#123;        "Name": "Network 1",        "Network": "<span class="token variable">$&#123;VM_NETWORK&#125;</span>"        &#125;    ],    "PropertyMapping": <span class="token variable">$&#123;props&#125;</span>    &#125;EOF</span><span class="token punctuation">&#125;</span>deploy_vcsa_vmgovc vm.change <span class="token parameter variable">-vm</span> <span class="token string">"<span class="token variable">$&#123;VM_NAME&#125;</span>"</span> <span class="token parameter variable">-g</span> vmwarePhoton64Guestgovc vm.power <span class="token parameter variable">-on</span> <span class="token string">"<span class="token variable">$&#123;VM_NAME&#125;</span>"</span>govc vm.ip <span class="token parameter variable">-a</span> <span class="token string">"<span class="token variable">$&#123;VM_NAME&#125;</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>通过脚本安装 vCenter，指定第一参数为 OVA 的绝对路径。运行完后将会自动将 ova 导入到 vCenter，并启动虚拟机；</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 执行该脚本，第一个参数传入 vCenter ISO 中 vcsa ova 文件的绝对路径</span>$ <span class="token function">bash</span> install-vcsa.sh /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova<span class="token punctuation">[</span>03-02-22 <span class="token number">18</span>:40:19<span class="token punctuation">]</span> Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk1.vmdk<span class="token punctuation">..</span>. OK<span class="token punctuation">[</span>03-02-22 <span class="token number">18</span>:41:09<span class="token punctuation">]</span> Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk<span class="token punctuation">..</span>. <span class="token punctuation">(</span><span class="token number">29</span>%, <span class="token number">52</span>.5MiB/s<span class="token punctuation">)</span><span class="token punctuation">[</span>03-02-22 <span class="token number">18</span>:43:08<span class="token punctuation">]</span> Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk<span class="token punctuation">..</span>. OK<span class="token punctuation">[</span>03-02-22 <span class="token number">18</span>:43:08<span class="token punctuation">]</span> Injecting OVF environment<span class="token punctuation">..</span>.Powering on VirtualMachine:3<span class="token punctuation">..</span>. OKfe80::20c:29ff:fe03:2f80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>设置 vCenter 登录的环境变量，我们使用 govc 来配置 vCenter，通过浏览器 Web UI 的方式配置起来效率有点低，不如 govc 命令一把梭方便 😂</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_URL</span><span class="token operator">=</span><span class="token string">"https://192.168.20.92"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_USERNAME</span><span class="token operator">=</span><span class="token string">"administrator@vsphere.local"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_PASSWORD</span><span class="token operator">=</span><span class="token string">"admin@2022"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_INSECURE</span><span class="token operator">=</span>true<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_DATASTORE</span><span class="token operator">=</span>datastore1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>虚拟机启动后将自动进行 vCenter 的安装配置，等待一段时间 vCenter 安装好之后，使用 govc about 查看 vCenter 的信息，如果能正确或渠道说明 vCenter 就安装好了；</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ govc aboutFullName:     VMware vCenter Server <span class="token number">7.0</span>.3 build-18778458Name:         VMware vCenter ServerVendor:       VMware, Inc.Version:      <span class="token number">7.0</span>.3Build:        <span class="token number">18778458</span>OS type:      linux-x64API type:     VirtualCenterAPI version:  <span class="token number">7.0</span>.3.0Product ID:   vpxUUID:         0b49e119-e38f-4fbc-84a8-d7a0e548027d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="配置-vCenter"><a href="#配置-vCenter" class="headerlink" title="配置 vCenter"></a>配置 vCenter</h3><p>这一步骤主要是配置 vCenter：创建 Datacenter、cluster、folder 等资源，并将 ESXi 主机添加到 cluster 中；</p><ul><li>配置 vCenter</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建 Datacenter 数据中心</span>$ govc datacenter.create SH-IDC<span class="token comment"># 创建 Cluster 集群</span>$ govc cluster.create <span class="token parameter variable">-dc</span><span class="token operator">=</span>SH-IDC Tanzu-Cluster<span class="token comment"># 将 ESXi 主机添加到 Cluster 当中</span>$ govc cluster.add <span class="token parameter variable">-dc</span><span class="token operator">=</span>SH-IDC <span class="token parameter variable">-cluster</span><span class="token operator">=</span>Tanzu-Cluster <span class="token parameter variable">-hostname</span><span class="token operator">=</span><span class="token number">192.168</span>.18.47 <span class="token parameter variable">--username</span><span class="token operator">=</span>root <span class="token parameter variable">-password</span><span class="token operator">=</span><span class="token string">'admin@2020'</span> <span class="token parameter variable">-noverify</span><span class="token comment"># 创建 folder，用于将 Tanzu 的节点虚拟机存放到该文件夹下</span>$ govc folder.create /SH-IDC/vm/Tanzu-node<span class="token comment"># 导入 tanzu 汲取节点的虚拟机 ova 模版</span>$ govc import.ova <span class="token parameter variable">-dc</span><span class="token operator">=</span><span class="token string">'SH-IDC'</span> <span class="token parameter variable">-ds</span><span class="token operator">=</span><span class="token string">'datastore1'</span> photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova<span class="token comment"># 将虚拟机转换为模版，后续 tanzu 集群将以该模版创建虚拟机</span>$ govc vm.markastemplate photon-3-kube-v1.21.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="初始化-bootstrap-节点"><a href="#初始化-bootstrap-节点" class="headerlink" title="初始化 bootstrap 节点"></a>初始化 bootstrap 节点</h3><p>bootstrap 节点节点是用于运行 tanzu 部署工具的节点，官方是支持 Linux&#x2F;macOS&#x2F;Windows 三种操作系统的，但有一些比较严格的要求：</p><table><thead><tr><th>Arch: x86; ARM is currently unsupported</th></tr></thead><tbody><tr><td>RAM: 6 GB</td></tr><tr><td>CPU: 2</td></tr><tr><td><a href="https://docs.docker.com/engine/install/">Docker</a> Add your non-root user account to the docker user group. Create the group if it does not already exist. This lets the Tanzu CLI access the Docker socket, which is owned by the root user. For more information, see steps 1 to 4 in the <a href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user">Manage Docker as a non-root user</a> procedure in the Docker documentation.</td></tr><tr><td><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/">Kubectl</a></td></tr><tr><td>Latest version of Chrome, Firefox, Safari, Internet Explorer, or Edge</td></tr><tr><td>System time is synchronized with a Network Time Protocol (NTP) server.</td></tr><tr><td>Ensure your bootstrap machine is using <a href="https://man7.org/linux/man-pages/man7/cgroups.7.html">cgroup v1</a>. For more information, see <a href="https://tanzucommunityedition.io/docs/latest/support-matrix/#check-and-set-the-cgroup">Check and set the cgroup</a>.</td></tr></tbody></table><p>在这里为了避免这些麻烦的配置，我就直接使用的 VMware 官方的 <a href="https://github.com/vmware/photon/wiki/Downloading-Photon-OS#photon-os-40-rev2-binaries">Photon OS 4.0 Rev2</a> ，下载 OVA 格式的镜像直接导入到 ESXi 主机启动一台虚拟机即可，能节省不少麻烦的配置；还有一个好处就是在一台单独的虚拟机上运行 tanzu 部署工具不会污染本地的开发环境。</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">wget</span> https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova<span class="token comment"># 导入 OVA 虚拟机模版</span>$ govc import.ova <span class="token parameter variable">-ds</span><span class="token operator">=</span><span class="token string">'datastore1'</span> <span class="token parameter variable">-name</span> bootstrap-node photon-ova-4.0-c001795b80.ova<span class="token comment"># 修改一下虚拟机的配置，调整为 4C8G</span>$ govc vm.change <span class="token parameter variable">-c</span> <span class="token number">4</span> <span class="token parameter variable">-m</span> <span class="token number">8192</span> <span class="token parameter variable">-vm</span> bootstrap-node<span class="token comment"># 开启虚拟机</span>$ govc vm.power <span class="token parameter variable">-on</span> bootstrap-node<span class="token comment"># 查看虚拟机获取到的 IPv4 地址</span>$ govc vm.ip <span class="token parameter variable">-a</span> <span class="token parameter variable">-wait</span> 1m bootstrap-node$ <span class="token function">ssh</span> root@192.168.74.10<span class="token comment"># 密码默认为 changeme，输入完密码之后提示在输入一遍 changeme，然后再修改新的密码</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># cat /etc/os-release</span><span class="token assign-left variable">NAME</span><span class="token operator">=</span><span class="token string">"VMware Photon OS"</span><span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token string">"4.0"</span><span class="token assign-left variable">ID</span><span class="token operator">=</span>photon<span class="token assign-left variable">VERSION_ID</span><span class="token operator">=</span><span class="token number">4.0</span><span class="token assign-left variable">PRETTY_NAME</span><span class="token operator">=</span><span class="token string">"VMware Photon OS/Linux"</span><span class="token assign-left variable">ANSI_COLOR</span><span class="token operator">=</span><span class="token string">"1;34"</span><span class="token assign-left variable">HOME_URL</span><span class="token operator">=</span><span class="token string">"https://vmware.github.io/photon/"</span><span class="token assign-left variable">BUG_REPORT_URL</span><span class="token operator">=</span><span class="token string">"https://github.com/vmware/photon/issues"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>安装部署时需要的一些工具（切，Photon OS 里竟然连个 tar 命令都没有 😠</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># tdnf install sudo tar -y</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># curl -LO https://dl.k8s.io/release/v1.21.2/bin/linux/amd64/kubectl</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>启动 docker，bootstrap 节点会以 kind 的方式运行一个 K8s 集群，需要用到 docker。虽然可以使用外部的 k8s 集群，但不是很推荐，因为 cluster-api 依赖 k8s 的版本，不能太高也不能太低；</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># systemctl enable docker --now</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>从 <a href="https://github.com/vmware-tanzu/community-edition/releases/tag/v0.9.1">vmware-tanzu&#x2F;community-edition</a> 下载 tanzu 社区版的安装包，然后解压后安装；</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># curl -LO  https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># tar -xf tce-linux-amd64-v0.9.1.tar.gz</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># cd tce-linux-amd64-v0.9.1/</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># bash install.sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>然而不幸地翻车了， install.sh 脚本中禁止 root 用户运行</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">+ <span class="token assign-left variable">ALLOW_INSTALL_AS_ROOT</span><span class="token operator">=</span>+ <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>+ <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">''</span> <span class="token operator">!=</span> <span class="token punctuation">\</span>t<span class="token punctuation">\</span>r<span class="token punctuation">\</span>u<span class="token punctuation">\</span>e <span class="token punctuation">]</span><span class="token punctuation">]</span>+ <span class="token builtin class-name">echo</span> <span class="token string">'Do not run this script as root'</span>Do not run this script as root+ <span class="token builtin class-name">exit</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我就偏偏要以 root 用户来运行怎么惹 😡</p><p><img data-src="https://p.k8s.li/2022-01-22-deploy-tanzu-k8s-cluster-01.jpg"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># sed 去掉第一个 exit 1 就可以了</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># sed -i.bak "s/exit 1//" install.sh</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># bash install.sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>安装好之后会输出 <code>Installation complete!</code>（讲真官方的 install.sh 脚本输出很不友好，污染我的 terminal</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">+ tanzu init<span class="token operator">|</span> initializing ✔  successfully initialized CLI++ tanzu plugin repo list++ <span class="token function">grep</span> tce+ <span class="token assign-left variable">TCE_REPO</span><span class="token operator">=</span>+ <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">''</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>+ tanzu plugin repo <span class="token function">add</span> <span class="token parameter variable">--name</span> tce --gcp-bucket-name tce-tanzu-cli-plugins --gcp-root-path artifacts++ tanzu plugin repo list++ <span class="token function">grep</span> core-admin+ <span class="token assign-left variable">TCE_REPO</span><span class="token operator">=</span>+ <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">''</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>+ tanzu plugin repo <span class="token function">add</span> <span class="token parameter variable">--name</span> core-admin --gcp-bucket-name tce-tanzu-cli-framework-admin --gcp-root-path artifacts-admin+ <span class="token builtin class-name">echo</span> <span class="token string">'Installation complete!'</span>Installation complete<span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="部署管理集群"><a href="#部署管理集群" class="headerlink" title="部署管理集群"></a>部署管理集群</h3><p>先是部署一个 tanzu 的管理集群，有两种方式，一种是通过 <a href="https://tanzucommunityedition.io/docs/latest/getting-started/">官方文档</a> 提到的通过 Web UI 的方式。目前这个 UI 界面比较拉垮，它主要是用来让用户填写一些配置参数，然后调用后台的 tanzu 命令来部署集群。并把集群部署的日志和进度展示出来；部署完成之后，这个 UI 又不能管理这些集群，又不支持部署 workload 集群（</p><p>另一种就是通过 tanzu 命令指定配置文件来部署，这种方式不需要通过浏览器在 web 页面上傻乎乎地点来点去填一些参数，只需要提前填写好一个 yaml 格式的配置文件即可。下面我们就采用 tanzu 命令来部署集群，管理集群的配置文件模版如下：</p><ul><li>tanzu-mgt-cluster.yaml</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Cluster Pod IP 的 CIDR</span><span class="token key atrule">CLUSTER_CIDR</span><span class="token punctuation">:</span> 100.96.0.0/11<span class="token comment"># Service 的 CIDR</span><span class="token key atrule">SERVICE_CIDR</span><span class="token punctuation">:</span> 100.64.0.0/13<span class="token comment"># 集群的名称</span><span class="token key atrule">CLUSTER_NAME</span><span class="token punctuation">:</span> tanzu<span class="token punctuation">-</span>control<span class="token punctuation">-</span>plan<span class="token comment"># 集群的类型</span><span class="token key atrule">CLUSTER_PLAN</span><span class="token punctuation">:</span> dev<span class="token comment"># 集群节点的 arch</span><span class="token key atrule">OS_ARCH</span><span class="token punctuation">:</span> amd64<span class="token comment"># 集群节点的 OS 名称</span><span class="token key atrule">OS_NAME</span><span class="token punctuation">:</span> photon<span class="token comment"># 集群节点 OS 版本</span><span class="token key atrule">OS_VERSION</span><span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token comment"># 基础设施资源的提供方</span><span class="token key atrule">INFRASTRUCTURE_PROVIDER</span><span class="token punctuation">:</span> vsphere<span class="token comment"># 集群的 VIP</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_ENDPOINT</span><span class="token punctuation">:</span> 192.168.75.194<span class="token comment"># control-plan 节点的磁盘大小</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_DISK_GIB</span><span class="token punctuation">:</span> <span class="token string">"20"</span><span class="token comment"># control-plan 节点的内存大小</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_MEM_MIB</span><span class="token punctuation">:</span> <span class="token string">"8192"</span><span class="token comment"># control-plan 节点的 CPU 核心数量</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_NUM_CPUS</span><span class="token punctuation">:</span> <span class="token string">"4"</span><span class="token comment"># work 节点的磁盘大小</span><span class="token key atrule">VSPHERE_WORKER_DISK_GIB</span><span class="token punctuation">:</span> <span class="token string">"20"</span><span class="token comment"># work 节点的内存大小</span><span class="token key atrule">VSPHERE_WORKER_MEM_MIB</span><span class="token punctuation">:</span> <span class="token string">"4096"</span><span class="token comment"># work 节点的 CPU 核心数量</span><span class="token key atrule">VSPHERE_WORKER_NUM_CPUS</span><span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token comment"># vCenter 的 Datacenter 路径</span><span class="token key atrule">VSPHERE_DATACENTER</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC<span class="token comment"># 虚拟机创建的 Datastore 路径</span><span class="token key atrule">VSPHERE_DATASTORE</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/datastore/datastore1<span class="token comment"># 虚拟机创建的文件夹</span><span class="token key atrule">VSPHERE_FOLDER</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/vm/Tanzu<span class="token punctuation">-</span>node<span class="token comment"># 虚拟机使用的网络</span><span class="token key atrule">VSPHERE_NETWORK</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/network/VM Network<span class="token comment"># 虚拟机关联的资源池</span><span class="token key atrule">VSPHERE_RESOURCE_POOL</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/host/Tanzu<span class="token punctuation">-</span>Cluster/Resources<span class="token comment"># vCenter 的 IP</span><span class="token key atrule">VSPHERE_SERVER</span><span class="token punctuation">:</span> 192.168.75.110<span class="token comment"># vCenter 的用户名</span><span class="token key atrule">VSPHERE_USERNAME</span><span class="token punctuation">:</span> administrator@vsphere.local<span class="token comment"># vCenter 的密码，以 base64 编码</span><span class="token key atrule">VSPHERE_PASSWORD</span><span class="token punctuation">:</span> &lt;encoded<span class="token punctuation">:</span>base64password<span class="token punctuation">></span><span class="token comment"># vCenter 的证书指纹，可以通过 govc about.cert -json | jq -r '.ThumbprintSHA1' 获取</span><span class="token key atrule">VSPHERE_TLS_THUMBPRINT</span><span class="token punctuation">:</span> EB<span class="token punctuation">:</span>F3<span class="token punctuation">:</span>D8<span class="token punctuation">:</span>7A<span class="token punctuation">:</span>E8<span class="token punctuation">:</span>3D<span class="token punctuation">:</span>1A<span class="token punctuation">:</span>59<span class="token punctuation">:</span>B0<span class="token punctuation">:</span>DE<span class="token punctuation">:</span>73<span class="token punctuation">:</span>96<span class="token punctuation">:</span>DC<span class="token punctuation">:</span>B9<span class="token punctuation">:</span>5F<span class="token punctuation">:</span>13<span class="token punctuation">:</span>86<span class="token punctuation">:</span>EF<span class="token punctuation">:</span>B6<span class="token punctuation">:</span><span class="token number">27</span><span class="token comment"># 虚拟机注入的 ssh 公钥，需要用它来 ssh 登录集群节点</span><span class="token key atrule">VSPHERE_SSH_AUTHORIZED_KEY</span><span class="token punctuation">:</span> ssh<span class="token punctuation">-</span>rsa<span class="token comment"># 一些默认参数</span><span class="token key atrule">AVI_ENABLE</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">IDENTITY_MANAGEMENT_TYPE</span><span class="token punctuation">:</span> none<span class="token key atrule">ENABLE_AUDIT_LOGGING</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">ENABLE_CEIP_PARTICIPATION</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">TKG_HTTP_PROXY_ENABLED</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">DEPLOY_TKG_ON_VSPHERE7</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>通过 tanzu CLI 部署管理集群</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ tanzu management-cluster create <span class="token parameter variable">--file</span> tanzu-mgt-cluster.yaml <span class="token parameter variable">-v6</span><span class="token comment"># 如果没有配置 VSPHERE_TLS_THUMBPRINT 会有一个确认 vSphere thumbprint 的交互，输入 Y 就可以</span>Validating the pre-requisites<span class="token punctuation">..</span>.Do you want to <span class="token builtin class-name">continue</span> with the vSphere thumbprint EB:F3:D8:7A:E8:3D:1A:59:B0:DE:73:96:DC:B9:5F:13:86:EF:B6:27 <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>: y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="部署日志"><a href="#部署日志" class="headerlink" title="部署日志"></a>部署日志</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># tanzu management-cluster create --file tanzu-mgt-cluster.yaml -v 6</span>compatibility <span class="token function">file</span> <span class="token punctuation">(</span>/root/.config/tanzu/tkg/compatibility/tkg-compatibility.yaml<span class="token punctuation">)</span> already exists, skipping downloadBOM files inside /root/.config/tanzu/tkg/bom already exists, skipping downloadCEIP Opt-in status: <span class="token boolean">false</span>Validating the pre-requisites<span class="token punctuation">..</span>.vSphere <span class="token number">7.0</span> Environment Detected.You have connected to a vSphere <span class="token number">7.0</span> environment <span class="token function">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includesan integrated Tanzu Kubernetes Grid Service <span class="token function">which</span> turns a vSphere cluster into a platform <span class="token keyword">for</span> running Kubernetes workloads <span class="token keyword">in</span> dedicatedresource pools. Configuring Tanzu Kubernetes Grid Service is <span class="token keyword">done</span> through vSphere HTML5 client.Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="token keyword">in</span> vSphere <span class="token number">7.0</span> environments. Alternatively you maydeploy a non-integrated Tanzu Kubernetes Grid instance on vSphere <span class="token number">7.0</span>.Deploying TKG management cluster on vSphere <span class="token number">7.0</span> <span class="token punctuation">..</span>.Identity Provider not configured. Some authentication features won<span class="token string">'t work.Checking if VSPHERE_CONTROL_PLANE_ENDPOINT 192.168.20.94 is already in useSetting up management cluster...Validating configuration...Using infrastructure provider vsphere:v0.7.10Generating cluster configuration...Setting up bootstrapper...Fetching configuration for kind node image...kindConfig: &amp;&#123;&#123;Cluster kind.x-k8s.io/v1alpha4&#125;  [&#123;  map[] [&#123;/var/run/docker.sock /var/run/docker.sock false false &#125;] [] [] []&#125;] &#123; 0  100.96.0.0/11 100.64.0.0/13 false &#125; map[] map[] [apiVersion: kubeadm.k8s.io/v1beta2kind: ClusterConfigurationimageRepository: projects.registry.vmware.com/tkgetcd:  local:    imageRepository: projects.registry.vmware.com/tkg    imageTag: v3.4.13_vmware.15dns:  type: CoreDNS  imageRepository: projects.registry.vmware.com/tkg  imageTag: v1.8.0_vmware.5] [] [] []&#125;Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210Creating cluster "tkg-kind-c7vj6kds0a6sf43e6210" ...Ensuring node image (projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1) ...Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 ...Preparing nodes ...Writing configuration ...Starting control-plane ...Installing CNI ...Installing StorageClass ...Waiting 2m0s for control-plane = Ready ...Ready after 19sBootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOLInstalling providers on bootstrapper...Fetching providersInstalling cert-manager Version="v1.1.0"Waiting for cert-manager to be available...Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"Waiting for provider infrastructure-vsphereWaiting for provider control-plane-kubeadmWaiting for provider cluster-apiWaiting for provider bootstrap-kubeadmWaiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and runningpods are not yet running for deployment '</span>capi-kubeadm-control-plane-controller-manager<span class="token string">' in namespace '</span>capi-kubeadm-control-plane-system<span class="token string">', retryingPassed waiting on provider bootstrap-kubeadm after 25.205820854spods are not yet running for deployment '</span>capi-controller-manager<span class="token string">' in namespace '</span>capi-webhook-system<span class="token string">', retryingPassed waiting on provider infrastructure-vsphere after 30.185406332sPassed waiting on provider cluster-api after 30.213216243sSuccess waiting on all providers.Start creating management cluster...patch cluster object with operation status:&#123;"metadata": &#123;"annotations": &#123;"TKGOperationInfo" : "&#123;\"Operation\":\"Create\",\"OperationStartTimestamp\":\"2022-02-06 02:35:34.30219421 +0000 UTC\",\"OperationTimeout\":1800&#125;","TKGOperationLastObservedTimestamp" : "2022-02-06 02:35:34.30219421 +0000 UTC"&#125;&#125;&#125;cluster control plane is still being initialized, retryingGetting secret for clusterWaiting for resource tanzu-control-plan-kubeconfig of type *v1.Secret to be up and runningSaving management cluster kubeconfig into /root/.kube/configInstalling providers on management cluster...Fetching providersInstalling cert-manager Version="v1.1.0"Waiting for cert-manager to be available...Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"Waiting for provider control-plane-kubeadmWaiting for provider bootstrap-kubeadmWaiting for provider infrastructure-vsphereWaiting for provider cluster-apiWaiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and runningPassed waiting on provider control-plane-kubeadm after 10.046865402sWaiting for resource antrea-controller of type *v1.Deployment to be up and runningMoving all Cluster API objects from bootstrap cluster to management cluster...Performing move...Discovering Cluster API objectsMoving Cluster API objects Clusters=1Creating objects in the target clusterDeleting objects from the source clusterWaiting for additional components to be up and running...Waiting for packages to be up and running...Waiting for package: antreaWaiting for package: metrics-serverWaiting for package: tanzu-addons-managerWaiting for package: vsphere-cpiWaiting for package: vsphere-csiWaiting for resource antrea of type *v1alpha1.PackageInstall to be up and runningWaiting for resource vsphere-cpi of type *v1alpha1.PackageInstall to be up and runningWaiting for resource vsphere-csi of type *v1alpha1.PackageInstall to be up and runningWaiting for resource metrics-server of type *v1alpha1.PackageInstall to be up and runningWaiting for resource tanzu-addons-manager of type *v1alpha1.PackageInstall to be up and runningSuccessfully reconciled package: antreaSuccessfully reconciled package: vsphere-csiSuccessfully reconciled package: metrics-serverContext set for management cluster tanzu-control-plan as '</span>tanzu-control-plan-admin@tanzu-control-plan'.Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210Management cluster created<span class="token operator">!</span>You can now create your first workload cluster by running the following:  tanzu cluster create <span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token parameter variable">-f</span> <span class="token punctuation">[</span>file<span class="token punctuation">]</span>Some addons might be getting installed<span class="token operator">!</span> Check their status by running the following:  kubectl get apps <span class="token parameter variable">-A</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>部署完成之后，将管理集群的 kubeconfig 文件复制到 kubectl 默认的目录下</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># cp $&#123;HOME&#125;/.kube-tkg/config $&#123;HOME&#125;/.kube/config</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>查看集群状态信息</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 管理集群的 cluster 资源信息，管理集群的 CR 默认保存在了 tkg-system namespace 下</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get cluster -A</span>NAMESPACE    NAME                 PHASEtkg-system   tanzu-control-plan   Provisioned<span class="token comment"># 管理集群的 machine 资源信息</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get machine -A</span>NAMESPACE    NAME                                       PROVIDERID                                       PHASE         VERSIONtkg-system   tanzu-control-plan-control-plane-gs4bl     vsphere://4239c450-f621-d78e-3c44-4ac8890c0cd3   Running       v1.21.2+vmware.1tkg-system   tanzu-control-plan-md-0-7cdc97c7c6-kxcnx   vsphere://4239d776-c04c-aacc-db12-3380542a6d03   Provisioned   v1.21.2+vmware.1<span class="token comment"># 运行的组件状态</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get pod -A</span>NAMESPACE                           NAME                                                             READY   STATUS    RESTARTS   AGEcapi-kubeadm-bootstrap-system       capi-kubeadm-bootstrap-controller-manager-6494884869-wlzhx       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m37scapi-kubeadm-control-plane-system   capi-kubeadm-control-plane-controller-manager-857d687b9d-tpznv   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m35scapi-system                         capi-controller-manager-778bd4dfb9-tkvwg                         <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m41scapi-webhook-system                 capi-controller-manager-9995bdc94-svjm2                          <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m41scapi-webhook-system                 capi-kubeadm-bootstrap-controller-manager-68845b65f8-sllgv       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m38scapi-webhook-system                 capi-kubeadm-control-plane-controller-manager-9847c6747-vvz6g    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m35scapi-webhook-system                 capv-controller-manager-55bf67fbd5-4t46v                         <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m31scapv-system                         capv-controller-manager-587fbf697f-bbzs9                         <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m31scert-manager                        cert-manager-77f6fb8fd5-8tq6n                                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11mcert-manager                        cert-manager-cainjector-6bd4cff7bb-6vlzx                         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11mcert-manager                        cert-manager-webhook-fbfcb9d6c-qpkbc                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11mkube-system                         antrea-agent-5m9d4                                               <span class="token number">2</span>/2     Running   <span class="token number">0</span>          6mkube-system                         antrea-agent-8mpr7                                               <span class="token number">2</span>/2     Running   <span class="token number">0</span>          5m40skube-system                         antrea-controller-5bbcb98667-hklss                               <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m50skube-system                         coredns-8dcb5c56b-ckvb7                                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         coredns-8dcb5c56b-d98hf                                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         etcd-tanzu-control-plan-control-plane-gs4bl                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         kube-apiserver-tanzu-control-plan-control-plane-gs4bl            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         kube-controller-manager-tanzu-control-plan-control-plane-gs4bl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         kube-proxy-d4wq4                                                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         kube-proxy-nhkgg                                                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11mkube-system                         kube-scheduler-tanzu-control-plan-control-plane-gs4bl            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         kube-vip-tanzu-control-plan-control-plane-gs4bl                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         metrics-server-59fcb9fcf-xjznj                                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m29skube-system                         vsphere-cloud-controller-manager-kzffm                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m50skube-system                         vsphere-csi-controller-74675c9488-q9h5c                          <span class="token number">6</span>/6     Running   <span class="token number">0</span>          6m31skube-system                         vsphere-csi-node-dmvvr                                           <span class="token number">3</span>/3     Running   <span class="token number">0</span>          6m31skube-system                         vsphere-csi-node-k6x98                                           <span class="token number">3</span>/3     Running   <span class="token number">0</span>          6m31stkg-system                          kapp-controller-6499b8866-xnql7                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10mtkg-system                          tanzu-addons-controller-manager-657c587556-rpbjm                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m58stkg-system                          tanzu-capabilities-controller-manager-6ff97656b8-cq7m7           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11mtkr-system                          tkr-controller-manager-6bc455b5d4-wm98s                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="部署流程-1"><a href="#部署流程-1" class="headerlink" title="部署流程"></a>部署流程</h3><p>结合 <a href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go">tanzu 的源码</a> 和部署输出的日志我们大体可以得知，tanzu 管理集群部署大致分为如下几步：</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go</span><span class="token comment">// management cluster init step constants</span><span class="token keyword">const</span> <span class="token punctuation">(</span>StepConfigPrerequisite                 <span class="token operator">=</span> <span class="token string">"Configure prerequisite"</span>StepValidateConfiguration              <span class="token operator">=</span> <span class="token string">"Validate configuration"</span>StepGenerateClusterConfiguration       <span class="token operator">=</span> <span class="token string">"Generate cluster configuration"</span>StepSetupBootstrapCluster              <span class="token operator">=</span> <span class="token string">"Setup bootstrap cluster"</span>StepInstallProvidersOnBootstrapCluster <span class="token operator">=</span> <span class="token string">"Install providers on bootstrap cluster"</span>StepCreateManagementCluster            <span class="token operator">=</span> <span class="token string">"Create management cluster"</span>StepInstallProvidersOnRegionalCluster  <span class="token operator">=</span> <span class="token string">"Install providers on management cluster"</span>StepMoveClusterAPIObjects              <span class="token operator">=</span> <span class="token string">"Move cluster-api objects from bootstrap cluster to management cluster"</span><span class="token punctuation">)</span><span class="token comment">// InitRegionSteps management cluster init step sequence</span><span class="token keyword">var</span> InitRegionSteps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span>StepConfigPrerequisite<span class="token punctuation">,</span>StepValidateConfiguration<span class="token punctuation">,</span>StepGenerateClusterConfiguration<span class="token punctuation">,</span>StepSetupBootstrapCluster<span class="token punctuation">,</span>StepInstallProvidersOnBootstrapCluster<span class="token punctuation">,</span>StepCreateManagementCluster<span class="token punctuation">,</span>StepInstallProvidersOnRegionalCluster<span class="token punctuation">,</span>StepMoveClusterAPIObjects<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ConfigPrerequisite 准备阶段，会下载 <code>tkg-compatibility</code> 和 <code>tkg-bom</code> 镜像，用于检查环境的兼容性；</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Downloading TKG compatibility <span class="token function">file</span> from <span class="token string">'projects.registry.vmware.com/tkg/framework-zshippable/tkg-compatibility'</span>Downloading the TKG Bill of Materials <span class="token punctuation">(</span>BOM<span class="token punctuation">)</span> <span class="token function">file</span> from <span class="token string">'projects.registry.vmware.com/tkg/tkg-bom:v1.4.0'</span>Downloading the TKr Bill of Materials <span class="token punctuation">(</span>BOM<span class="token punctuation">)</span> <span class="token function">file</span> from <span class="token string">'projects.registry.vmware.com/tkg/tkr-bom:v1.21.2_vmware.1-tkg.1'</span>ERROR <span class="token number">2022</span>/02/06 02:24:46 svType <span class="token operator">!=</span> tvType<span class="token punctuation">;</span> <span class="token assign-left variable">key</span><span class="token operator">=</span>release, <span class="token assign-left variable">st</span><span class="token operator">=</span>map<span class="token punctuation">[</span>string<span class="token punctuation">]</span>interface <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>, <span class="token assign-left variable">tt</span><span class="token operator">=</span><span class="token operator">&lt;</span>nil<span class="token operator">></span>, <span class="token assign-left variable">sv</span><span class="token operator">=</span>map<span class="token punctuation">[</span>version:<span class="token punctuation">]</span>, <span class="token assign-left variable">tv</span><span class="token operator">=</span><span class="token operator">&lt;</span>nil<span class="token operator">></span>CEIP Opt-in status: <span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ValidateConfiguration 配置文件校验，根据填写的参数校验配置是否正确，以及检查 vCenter 当中有无匹配的虚拟机模版；</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Validating the pre-requisites<span class="token punctuation">..</span>.vSphere <span class="token number">7.0</span> Environment Detected.You have connected to a vSphere <span class="token number">7.0</span> environment <span class="token function">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includesan integrated Tanzu Kubernetes Grid Service <span class="token function">which</span> turns a vSphere cluster into a platform <span class="token keyword">for</span> running Kubernetes workloads <span class="token keyword">in</span> dedicatedresource pools. Configuring Tanzu Kubernetes Grid Service is <span class="token keyword">done</span> through vSphere HTML5 client.Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="token keyword">in</span> vSphere <span class="token number">7.0</span> environments. Alternatively you maydeploy a non-integrated Tanzu Kubernetes Grid instance on vSphere <span class="token number">7.0</span>.Deploying TKG management cluster on vSphere <span class="token number">7.0</span> <span class="token punctuation">..</span>.Identity Provider not configured. Some authentication features won't work.Checking <span class="token keyword">if</span> VSPHERE_CONTROL_PLANE_ENDPOINT <span class="token number">192.168</span>.20.94 is already <span class="token keyword">in</span> useSetting up management cluster<span class="token punctuation">..</span>.Validating configuration<span class="token punctuation">..</span>.Using infrastructure provider vsphere:v0.7.10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>GenerateClusterConfiguration 生成集群配置文件信息；</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Generating cluster configuration<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>SetupBootstrapCluster 设置 bootstrap 集群，目前默认为 kind。会运行一个 docker 容器，里面套娃运行着一个 k8s 集群；这个 bootstrap k8s 集群只是临时运行 cluster-api 来部署管理集群用的，部署完成之后 bootstrap 集群也就没用了，会自动删掉；</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Setting up bootstrapper<span class="token punctuation">..</span>.Fetching configuration <span class="token keyword">for</span> kind <span class="token function">node</span> image<span class="token punctuation">..</span>.kindConfig: <span class="token operator">&amp;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>Cluster kind.x-k8s.io/v1alpha4<span class="token punctuation">&#125;</span>  <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>  map<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>/var/run/docker.sock /var/run/docker.sock <span class="token boolean">false</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span>  <span class="token number">100.96</span>.0.0/11 <span class="token number">100.64</span>.0.0/13 <span class="token boolean">false</span> <span class="token punctuation">&#125;</span> map<span class="token punctuation">[</span><span class="token punctuation">]</span> map<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>apiVersion: kubeadm.k8s.io/v1beta2kind: ClusterConfigurationimageRepository: projects.registry.vmware.com/tkgetcd:  local:    imageRepository: projects.registry.vmware.com/tkg    imageTag: v3.4.13_vmware.15dns:  type: CoreDNS  imageRepository: projects.registry.vmware.com/tkg  imageTag: v1.8.0_vmware.5<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210Creating cluster <span class="token string">"tkg-kind-c7vj6kds0a6sf43e6210"</span> <span class="token punctuation">..</span>.Ensuring <span class="token function">node</span> image <span class="token punctuation">(</span>projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1<span class="token punctuation">)</span> <span class="token punctuation">..</span>.Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 <span class="token punctuation">..</span>.Preparing nodes <span class="token punctuation">..</span>.Writing configuration <span class="token punctuation">..</span>.Starting control-plane <span class="token punctuation">..</span>.Installing CNI <span class="token punctuation">..</span>.Installing StorageClass <span class="token punctuation">..</span>.Waiting 2m0s <span class="token keyword">for</span> control-plane <span class="token operator">=</span> Ready <span class="token punctuation">..</span>.Ready after 19sBootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>InstallProvidersOnBootstrapCluster 在 bootstrap 集群上安装 cluste-api 相关组件；</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Installing providers on bootstrapper<span class="token punctuation">..</span>.Fetching providers<span class="token comment"># 安装 cert-manager 主要是为了生成 k8s 集群部署所依赖的那一堆证书</span>Installing cert-manager <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v1.1.0"</span>Waiting <span class="token keyword">for</span> cert-manager to be available<span class="token punctuation">..</span>.Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"cluster-api"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-system"</span>Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"bootstrap-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-bootstrap-system"</span>Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"control-plane-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-control-plane-system"</span>Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"infrastructure-vsphere"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.7.10"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capv-system"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"cluster-api"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"CoreProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"kubeadm"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"BootstrapProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"kubeadm"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"ControlPlaneProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"vsphere"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"InfrastructureProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.7.10"</span>Waiting <span class="token keyword">for</span> provider infrastructure-vsphereWaiting <span class="token keyword">for</span> provider control-plane-kubeadmWaiting <span class="token keyword">for</span> provider cluster-apiWaiting <span class="token keyword">for</span> provider bootstrap-kubeadmPassed waiting on provider infrastructure-vsphere after <span class="token number">30</span>.185406332sPassed waiting on provider cluster-api after <span class="token number">30</span>.213216243sSuccess waiting on all providers.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>CreateManagementCluster 创建管理集群，这一步主要是创建虚拟机、初始化节点、运行 kubeadm 部署 k8s 集群；</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Start creating management cluster<span class="token punctuation">..</span>.patch cluster object with operation status:<span class="token punctuation">&#123;</span><span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"annotations"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"TKGOperationInfo"</span> <span class="token builtin class-name">:</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>Operation<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>Create<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>OperationStartTimestamp<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>2022-02-06 02:35:34.30219421 +0000 UTC<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>OperationTimeout<span class="token entity" title="\&quot;">\"</span>:1800&#125;"</span>,<span class="token string">"TKGOperationLastObservedTimestamp"</span> <span class="token builtin class-name">:</span> <span class="token string">"2022-02-06 02:35:34.30219421 +0000 UTC"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>cluster control plane is still being initialized, retryingGetting secret <span class="token keyword">for</span> clusterWaiting <span class="token keyword">for</span> resource tanzu-control-plan-kubeconfig of <span class="token builtin class-name">type</span> *v1.Secret to be up and runningSaving management cluster kubeconfig into /root/.kube/config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>InstallProvidersOnRegionalCluster 在管理集群上安装 cluster-api 相关组件；</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Installing providers on management cluster<span class="token punctuation">..</span>.Fetching providersInstalling cert-manager <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v1.1.0"</span>Waiting <span class="token keyword">for</span> cert-manager to be available<span class="token punctuation">..</span>.Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"cluster-api"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-system"</span>Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"bootstrap-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-bootstrap-system"</span>Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"control-plane-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-control-plane-system"</span>Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"infrastructure-vsphere"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.7.10"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capv-system"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"cluster-api"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"CoreProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"kubeadm"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"BootstrapProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"kubeadm"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"ControlPlaneProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"vsphere"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"InfrastructureProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.7.10"</span>Waiting <span class="token keyword">for</span> provider control-plane-kubeadmWaiting <span class="token keyword">for</span> provider bootstrap-kubeadmWaiting <span class="token keyword">for</span> provider infrastructure-vsphereWaiting <span class="token keyword">for</span> provider cluster-apiWaiting <span class="token keyword">for</span> resource capv-controller-manager of <span class="token builtin class-name">type</span> *v1.Deployment to be up and runningPassed waiting on provider infrastructure-vsphere after <span class="token number">20</span>.091935635sPassed waiting on provider cluster-api after <span class="token number">20</span>.109419304sSuccess waiting on all providers.Waiting <span class="token keyword">for</span> the management cluster to get ready <span class="token keyword">for</span> move<span class="token punctuation">..</span>.Waiting <span class="token keyword">for</span> resource tanzu-control-plan of <span class="token builtin class-name">type</span> *v1alpha3.Cluster to be up and runningWaiting <span class="token keyword">for</span> resources <span class="token builtin class-name">type</span> *v1alpha3.MachineDeploymentList to be up and runningWaiting <span class="token keyword">for</span> resources <span class="token builtin class-name">type</span> *v1alpha3.MachineList to be up and runningWaiting <span class="token keyword">for</span> addons installation<span class="token punctuation">..</span>.Waiting <span class="token keyword">for</span> resources <span class="token builtin class-name">type</span> *v1alpha3.ClusterResourceSetList to be up and runningWaiting <span class="token keyword">for</span> resource antrea-controller of <span class="token builtin class-name">type</span> *v1.Deployment to be up and running<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>MoveClusterAPIObjects 将 bootstrap 集群上 cluster-api 相关的资源转移到管理集群上。这一步的目的是为了达到 self-hosted 自托管的功能：即管理集群自身的扩缩容也是通过 cluster-api 来完成，这样就不用再依赖先前的那个 bootstrap 集群了；</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Moving all Cluster API objects from bootstrap cluster to management cluster<span class="token punctuation">..</span>.Performing move<span class="token punctuation">..</span>.Discovering Cluster API objectsMoving Cluster API objects <span class="token assign-left variable">Clusters</span><span class="token operator">=</span><span class="token number">1</span>Creating objects <span class="token keyword">in</span> the target clusterDeleting objects from the <span class="token builtin class-name">source</span> clusterContext <span class="token builtin class-name">set</span> <span class="token keyword">for</span> management cluster tanzu-control-plan as <span class="token string">'tanzu-control-plan-admin@tanzu-control-plan'</span><span class="token builtin class-name">.</span>Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210Management cluster created<span class="token operator">!</span>You can now create your first workload cluster by running the following:  tanzu cluster create <span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token parameter variable">-f</span> <span class="token punctuation">[</span>file<span class="token punctuation">]</span>Some addons might be getting installed<span class="token operator">!</span> Check their status by running the following:  kubectl get apps <span class="token parameter variable">-A</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>部署完成后会删除 bootstrap 集群，因为 bootstrap 集群中的资源已经转移到了管理集群中，它继续存在的意义不大。</p><h2 id="部署-workload-集群"><a href="#部署-workload-集群" class="headerlink" title="部署 workload 集群"></a>部署 workload 集群</h2><p>上面我们只是部署好了一个 tanzu 管理集群，我们真正的工作负载并不适合运行在这个集群上，因此我们还需要再部署一个 workload 集群，类似于 k8s 集群中的 worker 节点。部署 workload 集群的时候不再依赖 bootstrap 集群，而是使用管理集群。</p><p>根据官方文档 <a href="https://tanzucommunityedition.io/docs/latest/vsphere-wl-template/">vSphere Workload Cluster Template</a> 中给出的模版创建一个配置文件，然后再通过 tanzu 命令来部署即可。配置文件内容如下：</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Cluster Pod IP 的 CIDR</span><span class="token key atrule">CLUSTER_CIDR</span><span class="token punctuation">:</span> 100.96.0.0/11<span class="token comment"># Service 的 CIDR</span><span class="token key atrule">SERVICE_CIDR</span><span class="token punctuation">:</span> 100.64.0.0/13<span class="token comment"># 集群的名称</span><span class="token key atrule">CLUSTER_NAME</span><span class="token punctuation">:</span> tanzu<span class="token punctuation">-</span>workload<span class="token punctuation">-</span>cluster<span class="token comment"># 集群的类型</span><span class="token key atrule">CLUSTER_PLAN</span><span class="token punctuation">:</span> dev<span class="token comment"># 集群节点的 arch</span><span class="token key atrule">OS_ARCH</span><span class="token punctuation">:</span> amd64<span class="token comment"># 集群节点的 OS 名称</span><span class="token key atrule">OS_NAME</span><span class="token punctuation">:</span> photon<span class="token comment"># 集群节点 OS 版本</span><span class="token key atrule">OS_VERSION</span><span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token comment"># 基础设施资源的提供方</span><span class="token key atrule">INFRASTRUCTURE_PROVIDER</span><span class="token punctuation">:</span> vsphere<span class="token comment"># cluster, machine 等自定义资源创建的 namespace</span><span class="token key atrule">NAMESPACE</span><span class="token punctuation">:</span> default<span class="token comment"># CNI 选用类型，目前应该只支持 VMware 自家的 antrea</span><span class="token key atrule">CNI</span><span class="token punctuation">:</span> antrea<span class="token comment"># 集群的 VIP</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_ENDPOINT</span><span class="token punctuation">:</span> 192.168.20.95<span class="token comment"># control-plan 节点的磁盘大小</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_DISK_GIB</span><span class="token punctuation">:</span> <span class="token string">"20"</span><span class="token comment"># control-plan 节点的内存大小</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_MEM_MIB</span><span class="token punctuation">:</span> <span class="token string">"8192"</span><span class="token comment"># control-plan 节点的 CPU 核心数量</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_NUM_CPUS</span><span class="token punctuation">:</span> <span class="token string">"4"</span><span class="token comment"># work 节点的磁盘大小</span><span class="token key atrule">VSPHERE_WORKER_DISK_GIB</span><span class="token punctuation">:</span> <span class="token string">"20"</span><span class="token comment"># work 节点的内存大小</span><span class="token key atrule">VSPHERE_WORKER_MEM_MIB</span><span class="token punctuation">:</span> <span class="token string">"4096"</span><span class="token comment"># work 节点的 CPU 核心数量</span><span class="token key atrule">VSPHERE_WORKER_NUM_CPUS</span><span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token comment"># vCenter 的 Datacenter 路径</span><span class="token key atrule">VSPHERE_DATACENTER</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC<span class="token comment"># 虚拟机创建的 Datastore 路径</span><span class="token key atrule">VSPHERE_DATASTORE</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/datastore/datastore1<span class="token comment"># 虚拟机创建的文件夹</span><span class="token key atrule">VSPHERE_FOLDER</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/vm/Tanzu<span class="token punctuation">-</span>node<span class="token comment"># 虚拟机使用的网络</span><span class="token key atrule">VSPHERE_NETWORK</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/network/VM Network<span class="token comment"># 虚拟机关联的资源池</span><span class="token key atrule">VSPHERE_RESOURCE_POOL</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/host/Tanzu<span class="token punctuation">-</span>Cluster/Resources<span class="token comment"># vCenter 的 IP</span><span class="token key atrule">VSPHERE_SERVER</span><span class="token punctuation">:</span> 192.168.20.92<span class="token comment"># vCenter 的用户名</span><span class="token key atrule">VSPHERE_USERNAME</span><span class="token punctuation">:</span> administrator@vsphere.local<span class="token comment"># vCenter 的密码，以 base64 编码</span><span class="token key atrule">VSPHERE_PASSWORD</span><span class="token punctuation">:</span> &lt;encoded<span class="token punctuation">:</span>YWRtaW5AMjAyMA==<span class="token punctuation">></span><span class="token comment"># vCenter 的证书指纹，可以通过 govc about.cert -json | jq -r '.ThumbprintSHA1' 获取</span><span class="token key atrule">VSPHERE_TLS_THUMBPRINT</span><span class="token punctuation">:</span> CB<span class="token punctuation">:</span>23<span class="token punctuation">:</span>48<span class="token punctuation">:</span>E8<span class="token punctuation">:</span>93<span class="token punctuation">:</span>34<span class="token punctuation">:</span>AD<span class="token punctuation">:</span>27<span class="token punctuation">:</span>D8<span class="token punctuation">:</span>FD<span class="token punctuation">:</span>88<span class="token punctuation">:</span>1C<span class="token punctuation">:</span>D7<span class="token punctuation">:</span>08<span class="token punctuation">:</span>4B<span class="token punctuation">:</span>47<span class="token punctuation">:</span>9B<span class="token punctuation">:</span>12<span class="token punctuation">:</span>F4<span class="token punctuation">:</span>E0<span class="token comment"># 虚拟机注入的 ssh 公钥，需要用它来 ssh 登录集群节点</span><span class="token key atrule">VSPHERE_SSH_AUTHORIZED_KEY</span><span class="token punctuation">:</span> ssh<span class="token punctuation">-</span>rsa<span class="token comment"># 一些默认参数</span><span class="token key atrule">AVI_ENABLE</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">IDENTITY_MANAGEMENT_TYPE</span><span class="token punctuation">:</span> none<span class="token key atrule">ENABLE_AUDIT_LOGGING</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">ENABLE_CEIP_PARTICIPATION</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">TKG_HTTP_PROXY_ENABLED</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">DEPLOY_TKG_ON_VSPHERE7</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token comment"># 是否开启虚拟机健康检查</span><span class="token key atrule">ENABLE_MHC</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">MHC_UNKNOWN_STATUS_TIMEOUT</span><span class="token punctuation">:</span> 5m<span class="token key atrule">MHC_FALSE_STATUS_TIMEOUT</span><span class="token punctuation">:</span> 12m<span class="token comment"># 是否部署 vsphere cis 组件</span><span class="token key atrule">ENABLE_DEFAULT_STORAGE_CLASS</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token comment"># 是否开启集群自动扩缩容</span><span class="token key atrule">ENABLE_AUTOSCALER</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>通过 tanzu 命令来部署 workload 集群</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># tanzu cluster create tanzu-workload-cluster --file tanzu-workload-cluster.yaml</span>Validating configuration<span class="token punctuation">..</span>.Warning: Pinniped configuration not found. Skipping pinniped configuration <span class="token keyword">in</span> workload cluster. Please refer to the documentation to check <span class="token keyword">if</span> you can configure pinniped on workload cluster manuallyCreating workload cluster <span class="token string">'tanzu-workload-cluster'</span><span class="token punctuation">..</span>.Waiting <span class="token keyword">for</span> cluster to be initialized<span class="token punctuation">..</span>.Waiting <span class="token keyword">for</span> cluster nodes to be available<span class="token punctuation">..</span>.Waiting <span class="token keyword">for</span> cluster autoscaler to be available<span class="token punctuation">..</span>.Unable to <span class="token function">wait</span> <span class="token keyword">for</span> autoscaler deployment to be ready. reason: deployments.apps <span class="token string">"tanzu-workload-cluster-cluster-autoscaler"</span> not foundWaiting <span class="token keyword">for</span> addons installation<span class="token punctuation">..</span>.Waiting <span class="token keyword">for</span> packages to be up and running<span class="token punctuation">..</span>.Workload cluster <span class="token string">'tanzu-workload-cluster'</span> created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>部署完成之后查看一下集群的 CR 信息</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get cluster</span>NAME                     PHASEtanzu-workload-cluster   Provisioned<span class="token comment"># machine 状态处于 Running 说明节点已经正常运行了</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get machine</span>NAME                                          PROVIDERID                                       PHASE     VERSIONtanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="扩容集群"><a href="#扩容集群" class="headerlink" title="扩容集群"></a>扩容集群</h2><p>集群部署好之后，如果想对集群节点进行扩缩容，我们可以像 deployment 的一样，只需要修改一些 CR 的信息即可。cluster-api 相关组件会 watch 到这些 CR 的变化，并根据它的 spec 信息进行一系列调谐操作。如果当前集群节点数量低于所定义的节点副本数量，则会自动调用对应的 Provider 创建虚拟机，并对虚拟机进行初始化操作，将它转换为 k8s 里的一个 node 资源；</p><h3 id="扩容-control-plan-节点"><a href="#扩容-control-plan-节点" class="headerlink" title="扩容 control-plan 节点"></a>扩容 control-plan 节点</h3><p>即扩容 master 节点，通过修改 <code>KubeadmControlPlane</code> 这个 CR 中的 <code>replicas</code> 副本数即可：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl scale kcp tanzu-workload-cluster-control-plane --replicas=3</span><span class="token comment"># 可以看到 machine 已经处于 Provisioning 状态，说明集群节点对应的虚拟机正在创建中</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get machine</span>NAME                                          PROVIDERID                                       PHASE          VERSIONtanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running        v1.21.2+vmware.1tanzu-workload-cluster-control-plane-mkmd2                                                     Provisioning   v1.21.2+vmware.1tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running        v1.21.2+vmware.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="扩容-work-节点"><a href="#扩容-work-节点" class="headerlink" title="扩容 work 节点"></a>扩容 work 节点</h3><p>扩容 worker 节点，通过修改 <code>MachineDeployment</code> 这个 CR 中的 <code>replicas</code> 副本数即可：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl scale md tanzu-workload-cluster-md-0 --replicas=3</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get machine</span>NAME                                          PROVIDERID                                       PHASE     VERSIONtanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1tanzu-workload-cluster-control-plane-mkmd2    vsphere://4239278c-0503-f03a-08b8-df92286bcdd7   Running   v1.21.2+vmware.1tanzu-workload-cluster-control-plane-rt5mb    vsphere://4239c882-2fe5-a394-60c0-616941a6363e   Running   v1.21.2+vmware.1tanzu-workload-cluster-md-0-8555bbbfc-4hlqk   vsphere://42395deb-e706-8b4b-a44f-c755c222575c   Running   v1.21.2+vmware.1tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1tanzu-workload-cluster-md-0-8555bbbfc-ftmlp   vsphere://42399640-8e94-85e5-c4bd-8436d84966e0   Running   v1.21.2+vmware.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>本文只是介绍了 tanzu 集群部署的大体流程，里面包含了 cluster-api 相关的概念在本文并没有做深入的分析，因为实在是太复杂了 😂，到现在我还是没太理解其中的一些原理，因此后续我再单独写一篇博客来讲解一些 cluster-api 相关的内容，到那时候在结合本文来看就容易理解很多。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://github.com/vmware-tanzu/community-edition">community-edition</a></li><li><a href="https://github.com/vmware/photon">vmware&#x2F;photon</a></li><li><a href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go">tanzu-framework</a></li><li><a href="https://github.com/kubernetes-sigs/cluster-api-provider-vsphere">cluster-api-provider-vsphere</a></li><li><a href="https://tanzucommunityedition.io/docs/latest/workload-clusters/">Deploying a workload cluster</a></li><li><a href="https://tanzucommunityedition.io/docs/latest/verify-deployment/">Examine the Management Cluster Deployment</a></li><li><a href="https://tanzucommunityedition.io/docs/latest/vsphere/">Prepare to Deploy a Management or Standalone Clusters to vSphere</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;之前接触的 Kubernetes
        
      
    
    </summary>
    
    
      <category term="技术" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="ESXi" scheme="https://blog.k8s.li/tags/ESXi/"/>
    
      <category term="Tanzu" scheme="https://blog.k8s.li/tags/Tanzu/"/>
    
      <category term="Kubernetes" scheme="https://blog.k8s.li/tags/Kubernetes/"/>
    
      <category term="Cluster-api" scheme="https://blog.k8s.li/tags/Cluster-api/"/>
    
  </entry>
  
</feed>
