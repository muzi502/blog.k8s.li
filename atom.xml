<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Reimu&#39;s blog</title>
  <icon>https://blog.k8s.li/icon.png</icon>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.k8s.li/"/>
  <updated>2022-03-30T16:00:00.000Z</updated>
  <id>https://blog.k8s.li/</id>
  
  <author>
    <name>木子</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>搬砖工具 govc 使用记录</title>
    <link href="https://blog.k8s.li/govc-usage.html"/>
    <id>https://blog.k8s.li/govc-usage.html</id>
    <published>2022-03-30T16:00:00.000Z</published>
    <updated>2022-03-30T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>最近由于工作原因需要在 ESXi 主机上完成一些参数配置、虚拟交换机/网创建、虚拟机创建、VIB 安装、PCI 直通、虚拟机创建等工作，于是抽空整理了一下在使用 govc 时踩的一些坑。</p><h2 id="govc"><a href="#govc" class="headerlink" title="govc"></a>govc</h2><p><a href="https://github.com/vmware/govmomi/tree/master/govc" target="_blank" rel="noopener">govc</a> 是 VMware 官方 <a href="https://github.com/vmware/govmom" target="_blank" rel="noopener">govmomi</a> 库的一个封装实现。使用它可以完成对 ESXi 主机或 vCenter 的一些操作。比如创建虚拟机、管理快照等。基本上能在 ESXi 或 vCenter 上的操作，在 govmomi 中都有对应的实现。目前 govc 支持的 ESXi / vCenter 版本有 7.0, 6.7, 6.5 , 6.0 (5.x 版本太老了，干脆放弃吧)，另外也支持 VMware Workstation 的某些版本。</p><p>使用 govc 连接 ESXi 主机或 vCenter 可以通过设置环境变量或者命令行参数，建议使用环境变量，如果通过命令行 flag 的话，将明文规定用户名和密码输出来有一定的安全风险。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Options:</span><br><span class="line">  -cert=                           Certificate [GOVC_CERTIFICATE]</span><br><span class="line">  -dc=                             Datacenter [GOVC_DATACENTER]</span><br><span class="line">  -debug=false                     Store debug logs [GOVC_DEBUG]</span><br><span class="line">  -dump=false                      Enable Go output</span><br><span class="line">  -host=                           Host system [GOVC_HOST]</span><br><span class="line">  -host.dns=                       Find host by FQDN</span><br><span class="line">  -host.ip=                        Find host by IP address</span><br><span class="line">  -host.ipath=                     Find host by inventory path</span><br><span class="line">  -host.uuid=                      Find host by UUID</span><br><span class="line">  -json=false                      Enable JSON output</span><br><span class="line">  -k=false                         Skip verification of server certificate [GOVC_INSECURE]</span><br><span class="line">  -key=                            Private key [GOVC_PRIVATE_KEY]</span><br><span class="line">  -persist-session=true            Persist session to disk [GOVC_PERSIST_SESSION]</span><br><span class="line">  -tls-ca-certs=                   TLS CA certificates file [GOVC_TLS_CA_CERTS]</span><br><span class="line">  -tls-known-hosts=                TLS known hosts file [GOVC_TLS_KNOWN_HOSTS]</span><br><span class="line">  -trace=false                     Write SOAP/REST traffic to stderr</span><br><span class="line">  -u=https://root@esxi.yoi.li/sdk  ESX or vCenter URL [GOVC_URL]</span><br><span class="line">  -verbose=false                   Write request/response data to stderr</span><br><span class="line">  -vim-namespace=vim25             Vim namespace [GOVC_VIM_NAMESPACE]</span><br><span class="line">  -vim-version=7.0                 Vim version [GOVC_VIM_VERSION]</span><br><span class="line">  -xml=false                       Enable XML output</span><br></pre></td></tr></table></figure><p>通过 <code>GOVC_URL</code> 环境变量指定 ESXi 主机或 vCenter 的 URL，登录的用户名和密码可设置在 GOVC_URL 中或者单独设置 <code>GOVC_USERNAME</code> 和 <code>GOVC_PASSWORD</code>。如果 https 证书是自签的域名或者 IP 需要通过设置 <code>GOVC_INSECURE=true</code> 参数来允许不安全的 https 连接。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> GOVC_URL=<span class="string">"https://root:password@esxi.k8s.li"</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> govc about</span></span><br><span class="line">FullName:     VMware ESXi 7.0.2 build-17867351</span><br><span class="line">Name:         VMware ESXi</span><br><span class="line">Vendor:       VMware, Inc.</span><br><span class="line">Version:      7.0.2</span><br><span class="line">Build:        17867351</span><br><span class="line">OS type:      vmnix-x86</span><br><span class="line">API type:     HostAgent</span><br><span class="line">API version:  7.0.2.0</span><br><span class="line">Product ID:   embeddedEsx</span><br><span class="line">UUID:</span><br></pre></td></tr></table></figure><p>如果用户名和密码当中有特殊字符比如 <code>\ @ /</code>，建议分别设置 <code>GOVC_URL</code>、<code>GOVC_USERNAME</code> 和 <code>GOVC_PASSWORD</code> 这样能避免特殊字符在 <code>GOVC_URL</code> 出现一些奇奇怪怪的问题。</p><h2 id="获取主机信息"><a href="#获取主机信息" class="headerlink" title="获取主机信息"></a>获取主机信息</h2><h3 id="govc-host-info"><a href="#govc-host-info" class="headerlink" title="govc host.info"></a><code>govc host.info</code></h3><p>通过 host.info 自命命令可以得到 ESXi 主机的基本信息，</p><ul><li>Path: 当前主机在集群中的资源路径</li><li>Manufacturer: 硬件设备制造商</li><li>Logical CPUs: 逻辑 CPU 的数量，以及 CPU 的基础频率</li><li>Processor type: CPU 的具体型号，由于我的是 ES 版的 E-2126G，所以无法显示出具体的型号 🤣</li><li>CPU usage:  CPU 使用的负载情况</li><li>Memory:  主机安装的内存大小</li><li>Memory usage:  内存使用的负载情况</li><li>Boot time: 开机时间</li><li>State:  连接状态</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ govc host.info</span><br><span class="line">Name:              hp-esxi.lan</span><br><span class="line">  Path:            /ha-datacenter/host/hp-esxi.lan/hp-esxi.lan</span><br><span class="line">  Manufacturer:    HPE</span><br><span class="line">  Logical CPUs:    6 CPUs @ 3000MHz</span><br><span class="line">  Processor <span class="built_in">type</span>:  Genuine Intel(R) CPU 0000 @ 3.00GHz</span><br><span class="line">  CPU usage:       3444 MHz (19.1%)</span><br><span class="line">  Memory:          32613MB</span><br><span class="line">  Memory usage:    26745 MB (82.0%)</span><br><span class="line">  Boot time:       2021-12-05 06:11:53.42802 +0000 UTC</span><br><span class="line">  State:           connected</span><br></pre></td></tr></table></figure><p>如果加上 -json 参数会得到一个至少 3w 行的 json 输出，里面包含的 ESXi 主机的所有信息，然后可以使用 jq 命令去过滤出一些自己所需要的参数。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox ~</span><br><span class="line">╰─<span class="comment"># govc host.info -json=true &gt; host_info.json</span></span><br><span class="line">╭─root@esxi-debian-devbox ~</span><br><span class="line">╰─<span class="comment"># wc host_info.json</span></span><br><span class="line">  34522   73430 1188718 host_info.json</span><br><span class="line">╭─root@esxi-debian-devbox ~</span><br><span class="line">╰─<span class="comment"># govc host.info -json | jq '.HostSystems[0].Summary.Hardware'</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"Vendor"</span>: <span class="string">"HPE"</span>,</span><br><span class="line">  <span class="string">"Model"</span>: <span class="string">"ProLiant MicroServer Gen10 Plus"</span>,</span><br><span class="line">  <span class="string">"Uuid"</span>: <span class="string">"30363150"</span>,</span><br><span class="line">  <span class="string">"MemorySize"</span>: 34197471232,</span><br><span class="line">  <span class="string">"CpuModel"</span>: <span class="string">"Genuine Intel(R) CPU 0000 @ 3.00GHz"</span>,</span><br><span class="line">  <span class="string">"CpuMhz"</span>: 3000,</span><br><span class="line">  <span class="string">"NumCpuPkgs"</span>: 1,</span><br><span class="line">  <span class="string">"NumCpuCores"</span>: 6,</span><br><span class="line">  <span class="string">"NumCpuThreads"</span>: 6,</span><br><span class="line">  <span class="string">"NumNics"</span>: 4,</span><br><span class="line">  <span class="string">"NumHBAs"</span>: 3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果加上 -dump 参数，则会以 Golang 结构体的格式来输出，输出的内容也是包含了 ESXi 主机的所有信息，用它可以比较方便地定位某个信息的结构体，这一点对基于 govmomi 来开发其他的功能来说十分方便。尤其是在写单元测试的时候，可以从这里 dump 出一些数据来进行 mock。需要注意的是，并不是所有的子命令都支持 json 格式的输出。</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">mo.HostSystem&#123;</span><br><span class="line">    ManagedEntity: mo.ManagedEntity&#123;</span><br><span class="line">        ExtensibleManagedObject: mo.ExtensibleManagedObject&#123;</span><br><span class="line">            Self:           types.ManagedObjectReference&#123;Type:<span class="string">"HostSystem"</span>, Value:<span class="string">"ha-host"</span>&#125;,</span><br><span class="line">            Value:          <span class="literal">nil</span>,</span><br><span class="line">            AvailableField: <span class="literal">nil</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        Parent:        &amp;types.ManagedObjectReference&#123;Type:<span class="string">"ComputeResource"</span>, Value:<span class="string">"ha-compute-res"</span>&#125;,</span><br><span class="line">        CustomValue:   <span class="literal">nil</span>,</span><br><span class="line">        OverallStatus: <span class="string">"green"</span>,</span><br><span class="line">        ConfigStatus:  <span class="string">"yellow"</span>,</span><br><span class="line">        ConfigIssue:   []types.BaseEvent&#123;</span><br><span class="line">            &amp;types.RemoteTSMEnabledEvent&#123;</span><br><span class="line">                HostEvent: types.HostEvent&#123;</span><br><span class="line">                    Event: types.Event&#123;</span><br><span class="line">                        Key:             <span class="number">1</span>,</span><br><span class="line">                        ChainId:         <span class="number">0</span>,</span><br><span class="line">                        CreatedTime:     time.Now(),</span><br><span class="line">                        UserName:        <span class="string">""</span>,</span><br><span class="line">                        Datacenter:      (*types.DatacenterEventArgument)(<span class="literal">nil</span>),</span><br><span class="line">                        ComputeResource: (*types.ComputeResourceEventArgument)(<span class="literal">nil</span>),</span><br><span class="line">                        Host:            &amp;types.HostEventArgument&#123;</span><br><span class="line">                            EntityEventArgument: types.EntityEventArgument&#123;</span><br><span class="line">                                EventArgument: types.EventArgument&#123;&#125;,</span><br><span class="line">                                Name:          <span class="string">"hp-esxi.lan"</span>,</span><br><span class="line">                            &#125;,</span><br><span class="line">                            Host: types.ManagedObjectReference&#123;Type:<span class="string">"HostSystem"</span>, Value:<span class="string">"ha-host"</span>&#125;,</span><br><span class="line">                        &#125;,</span><br><span class="line">                        Vm:                   (*types.VmEventArgument)(<span class="literal">nil</span>),</span><br><span class="line">                        Ds:                   (*types.DatastoreEventArgument)(<span class="literal">nil</span>),</span><br><span class="line">                        Net:                  (*types.NetworkEventArgument)(<span class="literal">nil</span>),</span><br><span class="line">                        Dvs:                  (*types.DvsEventArgument)(<span class="literal">nil</span>),</span><br><span class="line">                        FullFormattedMessage: <span class="string">"SSH for the host hp-esxi.lan has been enabled"</span>,</span><br><span class="line">                        ChangeTag:            <span class="string">""</span>,</span><br><span class="line">                    &#125;,</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure><p>在写单元测试的时候，我经常用它来 mock 一些特殊硬件设备的信息，这比自己手写这些结构体要方便很多。比如以 <code>mpx.vmhba&lt;Adapter&gt;:C&lt;Channel&gt;:T&lt;Target&gt;:L&lt;LUN&gt;</code> 命名的硬盘可以通过  <code>PlugStoreTopology</code> 这个结构体来获取该硬盘的 NAA 号：</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getDiskIDByHostPlugStoreTopology</span><span class="params">(hpst *types.HostPlugStoreTopology, diskName <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, path := <span class="keyword">range</span> hpst.Path &#123;</span><br><span class="line"><span class="keyword">if</span> path.Name == diskName &#123;</span><br><span class="line">s := strings.Split(path.Target, <span class="string">"-sas."</span>)</span><br><span class="line"><span class="keyword">return</span> s[<span class="built_in">len</span>(s)<span class="number">-1</span>]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单元测试代码如下：</span></span><br><span class="line"><span class="keyword">var</span> plugStoreTopology = &amp;types.HostPlugStoreTopology&#123;</span><br><span class="line">Path: []types.HostPlugStoreTopologyPath&#123;</span><br><span class="line">&#123;</span><br><span class="line">Key:           <span class="string">"key-vim.host.PlugStoreTopology.Path-vmhba0:C0:T1:L0"</span>,</span><br><span class="line">Name:          <span class="string">"vmhba0:C0:T1:L0"</span>,</span><br><span class="line">ChannelNumber: <span class="number">0</span>,</span><br><span class="line">TargetNumber:  <span class="number">1</span>,</span><br><span class="line">LunNumber:     <span class="number">0</span>,</span><br><span class="line">Adapter:       <span class="string">"key-vim.host.PlugStoreTopology.Adapter-vmhba0"</span>,</span><br><span class="line">Target:        <span class="string">"key-vim.host.PlugStoreTopology.Target-sas.500056b3d93828c0"</span>,</span><br><span class="line">Device:        <span class="string">"key-vim.host.PlugStoreTopology.Device-020000000055cd2e414dc39d4e494e54454c20"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGetDiskIDByHostPlugStoreTopology</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="keyword">string</span></span><br><span class="line">want <span class="keyword">string</span></span><br><span class="line">&#125;&#123;</span><br><span class="line">&#123;</span><br><span class="line">name: <span class="string">"vmhba0:C0:T1:L0"</span>,</span><br><span class="line">want: <span class="string">"500056b3d93828c0"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">name: <span class="string">"vmhba0:C0:T2:L0"</span>,</span><br><span class="line">want: <span class="string">""</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">name: <span class="string">""</span>,</span><br><span class="line">want: <span class="string">""</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> got := getDiskIDByHostPlugStoreTopology(plugStoreTopology, tt.name); got != tt.want &#123;</span><br><span class="line">t.Errorf(<span class="string">"getDiskIDByHostPlugStoreTopology() = %v, want %v"</span>, got, tt.want)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再比如 NVMe 硬盘可以通过 <code>NvmeTopology</code> 这个数据对象获取它的序列号</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getNVMeIDByHostNvmeTopology</span><span class="params">(hnt *types.HostNvmeTopology, diskName <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, adapter := <span class="keyword">range</span> hnt.Adapter &#123;</span><br><span class="line"><span class="keyword">for</span> _, controller := <span class="keyword">range</span> adapter.ConnectedController &#123;</span><br><span class="line"><span class="keyword">for</span> _, ns := <span class="keyword">range</span> controller.AttachedNamespace &#123;</span><br><span class="line"><span class="keyword">if</span> ns.Name == diskName &#123;</span><br><span class="line"><span class="keyword">return</span> strings.TrimSpace(controller.SerialNumber)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单元测试代码如下：</span></span><br><span class="line"><span class="keyword">var</span> nvmeTopology = &amp;types.HostNvmeTopology&#123;</span><br><span class="line">Adapter: []types.HostNvmeTopologyInterface&#123;</span><br><span class="line">&#123;</span><br><span class="line">Key:     <span class="string">"key-vim.host.NvmeTopology.Interface-vmhba0"</span>,</span><br><span class="line">Adapter: <span class="string">"key-vim.host.PcieHba-vmhba0"</span>,</span><br><span class="line">ConnectedController: []types.HostNvmeController&#123;</span><br><span class="line">&#123;</span><br><span class="line">Key:                     <span class="string">"key-vim.host.NvmeController-256"</span>,</span><br><span class="line">ControllerNumber:        <span class="number">256</span>,</span><br><span class="line">Subnqn:                  <span class="string">"nqn.2021-06.com.intel:PHAB123502CU1P9SGN  "</span>,</span><br><span class="line">Name:                    <span class="string">"nqn.2021-06.com.intel:PHAB123502CU1P9SGN"</span>,</span><br><span class="line">AssociatedAdapter:       <span class="string">"key-vim.host.PcieHba-vmhba0"</span>,</span><br><span class="line">TransportType:           <span class="string">"pcie"</span>,</span><br><span class="line">FusedOperationSupported: <span class="literal">false</span>,</span><br><span class="line">NumberOfQueues:          <span class="number">2</span>,</span><br><span class="line">QueueSize:               <span class="number">1024</span>,</span><br><span class="line">AttachedNamespace: []types.HostNvmeNamespace&#123;</span><br><span class="line">&#123;</span><br><span class="line">Key:              <span class="string">"key-vim.host.NvmeNamespace-t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CB406E4D25C@256"</span>,</span><br><span class="line">Name:             <span class="string">"t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CB406E4D25C"</span>,</span><br><span class="line">Id:               <span class="number">1</span>,</span><br><span class="line">BlockSize:        <span class="number">512</span>,</span><br><span class="line">CapacityInBlocks: <span class="number">3125627568</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">VendorId:        <span class="string">"0x8086"</span>,</span><br><span class="line">Model:           <span class="string">"Dell Ent NVMe P5600 MU U.2 1.6TB        "</span>,</span><br><span class="line">SerialNumber:    <span class="string">"PHAB123502CU1P9SGN  "</span>,</span><br><span class="line">FirmwareVersion: <span class="string">"1.0.0   PCIe"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">Key:     <span class="string">"key-vim.host.NvmeTopology.Interface-vmhba1"</span>,</span><br><span class="line">Adapter: <span class="string">"key-vim.host.PcieHba-vmhba1"</span>,</span><br><span class="line">ConnectedController: []types.HostNvmeController&#123;</span><br><span class="line">&#123;</span><br><span class="line">Key:                     <span class="string">"key-vim.host.NvmeController-257"</span>,</span><br><span class="line">ControllerNumber:        <span class="number">257</span>,</span><br><span class="line">Subnqn:                  <span class="string">"nqn.2021-06.com.intel:PHAB123602H81P9SGN  "</span>,</span><br><span class="line">Name:                    <span class="string">"nqn.2021-06.com.intel:PHAB123602H81P9SGN"</span>,</span><br><span class="line">AssociatedAdapter:       <span class="string">"key-vim.host.PcieHba-vmhba1"</span>,</span><br><span class="line">TransportType:           <span class="string">"pcie"</span>,</span><br><span class="line">FusedOperationSupported: <span class="literal">false</span>,</span><br><span class="line">NumberOfQueues:          <span class="number">2</span>,</span><br><span class="line">QueueSize:               <span class="number">1024</span>,</span><br><span class="line">AttachedNamespace: []types.HostNvmeNamespace&#123;</span><br><span class="line">&#123;</span><br><span class="line">Key:              <span class="string">"key-vim.host.NvmeNamespace-t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CEE23E4D25C@257"</span>,</span><br><span class="line">Name:             <span class="string">"t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CEE23E4D25C"</span>,</span><br><span class="line">Id:               <span class="number">1</span>,</span><br><span class="line">BlockSize:        <span class="number">512</span>,</span><br><span class="line">CapacityInBlocks: <span class="number">3125627568</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">VendorId:        <span class="string">"0x8086"</span>,</span><br><span class="line">Model:           <span class="string">"Dell Ent NVMe P5600 MU U.2 1.6TB        "</span>,</span><br><span class="line">SerialNumber:    <span class="string">"PHAB123602H81P9SGN  "</span>,</span><br><span class="line">FirmwareVersion: <span class="string">"1.0.0   PCIe"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestGetNVMeIDByHostNvmeTopology</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">tests := []<span class="keyword">struct</span> &#123;</span><br><span class="line">name <span class="keyword">string</span></span><br><span class="line">want <span class="keyword">string</span></span><br><span class="line">&#125;&#123;</span><br><span class="line">&#123;</span><br><span class="line">name: <span class="string">"t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CEE23E4D25C"</span>,</span><br><span class="line">want: <span class="string">"PHAB123602H81P9SGN"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">name: <span class="string">"t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB"</span>,</span><br><span class="line">want: <span class="string">""</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">name: <span class="string">""</span>,</span><br><span class="line">want: <span class="string">""</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, tt := <span class="keyword">range</span> tests &#123;</span><br><span class="line">t.Run(tt.name, <span class="function"><span class="keyword">func</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> got := getNVMeIDByHostNvmeTopology(nvmeTopology, tt.name); got != tt.want &#123;</span><br><span class="line">t.Errorf(<span class="string">"getNVMeIDByHostNvmeTopology() = %v, want %v"</span>, got, tt.want)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="配置-ESXi-主机参数"><a href="#配置-ESXi-主机参数" class="headerlink" title="配置 ESXi 主机参数"></a>配置 ESXi 主机参数</h2><p>通过 <code>host.option.ls</code> 可以列出当前 ESXi 主机所有的配置选项</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ govc host.option.ls</span><br><span class="line">Annotations.WelcomeMessage:</span><br><span class="line">BufferCache.FlushInterval:                          30000</span><br><span class="line">BufferCache.HardMaxDirty:                           95</span><br><span class="line">BufferCache.PerFileHardMaxDirty:                    50</span><br><span class="line">BufferCache.SoftMaxDirty:                           15</span><br><span class="line">CBRC.DCacheMemReserved:                             400</span><br><span class="line">CBRC.Enable:                                        <span class="literal">false</span></span><br><span class="line">COW.COWMaxHeapSizeMB:                               192</span><br><span class="line">COW.COWMaxREPageCacheszMB:                          256</span><br><span class="line">COW.COWMinREPageCacheszMB:                          0</span><br><span class="line">COW.COWREPageCacheEviction:                         1</span><br><span class="line">Config.Defaults.host.TAAworkaround:                 <span class="literal">true</span></span><br><span class="line">Config.Defaults.monitor.if_pschange_mc_workaround:  <span class="literal">false</span></span><br><span class="line">Config.Defaults.security.host.ruissl:               <span class="literal">true</span></span><br><span class="line">Config.Defaults.vGPU.consolidation:                 <span class="literal">false</span></span><br><span class="line">Config.Etc.issue:</span><br><span class="line">Config.Etc.motd:                                    The time and date of this login have been sent to the system logs.</span><br></pre></td></tr></table></figure><p>通过 <code>host.option.set</code> 可以设置 ESXi 主机参数，例如如果想要配置 NFS 存储心跳超时时间可以通过如下方式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ govc host.option.set NFS.HeartbeatTimeout 30</span><br></pre></td></tr></table></figure><h2 id="开启-ssh-服务"><a href="#开启-ssh-服务" class="headerlink" title="开启 ssh 服务"></a>开启 ssh 服务</h2><p>通过 <code>host.service</code> 可以对 ESXi 主机上的服务进行相关操作。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> govc host.service</span></span><br><span class="line">Where ACTION is one of: start, stop, restart, status, enable, disable</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动 ssh 服务</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> govc host.service start TSM-SSH</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 将 ssh 服务设置为开机自启</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> govc host.service <span class="built_in">enable</span> TSM-SSH</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看 ssh 服务的状态</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> govc host.service status TSM-SSH</span></span><br></pre></td></tr></table></figure><h2 id="创建虚拟机"><a href="#创建虚拟机" class="headerlink" title="创建虚拟机"></a>创建虚拟机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ VM_NAME=<span class="string">"centos-test"</span></span><br><span class="line">$ govc vm.create -ds=<span class="string">'datastore*'</span> -net=<span class="string">'VM Network'</span> -net.adapter=vmxnet3 -disk 1G -on=<span class="literal">false</span> <span class="variable">$&#123;VM_NAME&#125;</span></span><br><span class="line">$ govc vm.change -cpu.reservation=%d -memory-pin=<span class="literal">true</span> -vm <span class="variable">$&#123;VM_NAME&#125;</span></span><br><span class="line">$ govc vm.change -g centos7_64Guest -c %d -m 16384 -latency high -vm <span class="variable">$&#123;VM_NAME&#125;</span></span><br><span class="line">$ govc device.cdrom.add -vm <span class="variable">$&#123;VM_NAME&#125;</span></span><br><span class="line">$ govc device.cdrom.insert -vm <span class="variable">$&#123;VM_NAME&#125;</span> -device cdrom-3000</span><br><span class="line">$ govc device.connect -vm <span class="variable">$&#123;VM_NAME&#125;</span> cdrom-3000</span><br><span class="line">$ govc vm.power -on=<span class="literal">true</span> <span class="variable">$&#123;VM_NAME&#125;</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://gitbook.curiouser.top/origin/vsphere-govc.html" target="_blank" rel="noopener">vSphere go 命令行管理工具 govc</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;最近由于工作原因需要在 ESXi
        
      
    
    </summary>
    
    
      <category term="技术" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="ESXi" scheme="https://blog.k8s.li/tags/ESXi/"/>
    
      <category term="govc" scheme="https://blog.k8s.li/tags/govc/"/>
    
      <category term="vCenter" scheme="https://blog.k8s.li/tags/vCenter/"/>
    
      <category term="vSphere" scheme="https://blog.k8s.li/tags/vSphere/"/>
    
  </entry>
  
  <entry>
    <title>流水线中使用 docker in pod 方式构建容器镜像</title>
    <link href="https://blog.k8s.li/docker-in-pod.html"/>
    <id>https://blog.k8s.li/docker-in-pod.html</id>
    <published>2022-03-14T16:00:00.000Z</published>
    <updated>2022-03-15T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>上个月参加了 Rancher 社区举办的 《<a href="https://www.bilibili.com/video/BV1Xa411C78k" target="_blank" rel="noopener">Dockershim 即将被移除，你准备好了么？</a>》直播分享后，得知自 1.24 版本之后，Kubernetes 社区将正式放弃对 docker CRI 的支持，docker CRI 这部分代码则由 <a href="https://github.com/Mirantis/cri-dockerd" target="_blank" rel="noopener"> cri-dockerd</a> 项目来接盘。目前众多主流的 Kubernetes 私有化部署工具（比如 <a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener">kubespray</a>、<a href="https://github.com/kubesphere/kubekey" target="_blank" rel="noopener">kubekey</a>、<a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a>）也逐渐地不再将 docker 作为首选的容器运行时而纷纷转向了 containerd，去 docker 也成为了目前云原生社区热门的讨论话题。</p><p>docker 虽然作为一个 CRI 在 Kubernetes 社区一直被人诟病，但我们要知道 CRI 仅仅是 docker 的一部分功能而已。对于本地开发测试或者 CI/CD 流水线镜像构建来讲，依然有很多地方严重地依赖着 docker。比如 GitHub 上容器镜像构建的 Action 里， docker 官方的 <a href="https://github.com/docker/build-push-action" target="_blank" rel="noopener">build-push-action</a> 是众多项目首选的方式。即便是 docker 的竞争对手 <a href="https://github.com/containers/podman" target="_blank" rel="noopener">podman</a> + <a href="https://github.com/containers/skopeo" target="_blank" rel="noopener">skopeo</a> + <a href="https://github.com/containers/buildah" target="_blank" rel="noopener">buildah</a> 三剑客它们自身的容器镜像也是采用 docker 来构建的 <a href="https://github.com/containers/buildah/blob/main/.github/workflows/multi-arch-build.yaml" target="_blank" rel="noopener">multi-arch-build.yaml</a>：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">multi:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">multi-arch</span> <span class="string">image</span> <span class="string">build</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">REPONAME:</span> <span class="string">buildah</span>  <span class="comment"># No easy way to parse this out of $GITHUB_REPOSITORY</span></span><br><span class="line">      <span class="comment"># Server/namespace value used to format FQIN</span></span><br><span class="line">      <span class="attr">REPONAME_QUAY_REGISTRY:</span> <span class="string">quay.io/buildah</span></span><br><span class="line">      <span class="attr">CONTAINERS_QUAY_REGISTRY:</span> <span class="string">quay.io/containers</span></span><br><span class="line">      <span class="comment"># list of architectures for build</span></span><br><span class="line">      <span class="attr">PLATFORMS:</span> <span class="string">linux/amd64,linux/s390x,linux/ppc64le,linux/arm64</span></span><br><span class="line">      <span class="comment"># Command to execute in container to obtain project version number</span></span><br><span class="line">      <span class="attr">VERSION_CMD:</span> <span class="string">"buildah --version"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># build several images (upstream, testing, stable) in parallel</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="comment"># By default, failure of one matrix item cancels all others</span></span><br><span class="line">      <span class="attr">fail-fast:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="comment"># Builds are located under contrib/&lt;reponame&gt;image/&lt;source&gt; directory</span></span><br><span class="line">        <span class="attr">source:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">upstream</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">testing</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">stable</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="comment"># internal registry caches build for inspection before push</span></span><br><span class="line">    <span class="attr">services:</span></span><br><span class="line">      <span class="attr">registry:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/libpod/registry:2</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">5000</span><span class="string">:5000</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">QEMU</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/setup-qemu-action@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Docker</span> <span class="string">Buildx</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/setup-buildx-action@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">driver-opts:</span> <span class="string">network=host</span></span><br><span class="line">          <span class="attr">install:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">locally</span> <span class="string">push</span> <span class="string">image</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/build-push-action@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">context:</span> <span class="string">contrib/$&#123;&#123;</span> <span class="string">env.REPONAME</span> <span class="string">&#125;&#125;image/$&#123;&#123;</span> <span class="string">matrix.source</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">file:</span> <span class="string">./contrib/$&#123;&#123;</span> <span class="string">env.REPONAME</span> <span class="string">&#125;&#125;image/$&#123;&#123;</span> <span class="string">matrix.source</span> <span class="string">&#125;&#125;/Dockerfile</span></span><br><span class="line">          <span class="attr">platforms:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.PLATFORMS</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">push:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">tags:</span> <span class="string">localhost:5000/$&#123;&#123;</span> <span class="string">env.REPONAME</span> <span class="string">&#125;&#125;/$&#123;&#123;</span> <span class="string">matrix.source</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><h2 id="Jenkins-流水线"><a href="#Jenkins-流水线" class="headerlink" title="Jenkins 流水线"></a>Jenkins 流水线</h2><p>我们的 CI/CD 流水线是使用 Jenkins + Kubernetes plugin 的方式在 Kubernetes 上动态地创建 Pod 作为 Jenkins Slave。在使用 docker 作为容器时的情况下，Jenkins  Slave Pod 将宿主机上的 <code>/var/run/docker.sock</code> 文件通过 hostPath 的方式挂载到 pod 容器内，容器内的 docker CLI 就能通过该 sock 与宿主机的 docker 守护进程进行通信，这样在 pod 容器内就可以无缝地使用 docker build 、push 等命令了。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">//</span> <span class="string">Kubernetes</span> <span class="string">pod</span> <span class="string">template</span> <span class="string">to</span> <span class="string">run.</span></span><br><span class="line"><span class="string">podTemplate(</span></span><br><span class="line">    <span class="attr">cloud:</span> <span class="string">"kubernetes"</span><span class="string">,</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">"default"</span><span class="string">,</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">POD_NAME,</span></span><br><span class="line">    <span class="attr">label:</span> <span class="string">POD_NAME,</span></span><br><span class="line">    <span class="attr">yaml:</span> <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: debian</span></span><br><span class="line"><span class="string">    image: "</span><span class="string">$&#123;JENKINS_POD_IMAGE_NAME&#125;"</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dockersock</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/var/run/docker.sock</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jnlp</span></span><br><span class="line">    <span class="attr">args:</span> <span class="string">["\$(JENKINS_SECRET)",</span> <span class="string">"\$(JENKINS_NAME)"</span><span class="string">]</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"jenkins/inbound-agent:4.3-4-alpine"</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dockersock</span></span><br><span class="line">      <span class="attr">hostPath:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/var/run/docker.sock</span></span><br><span class="line"><span class="string">""</span><span class="string">",</span></span><br><span class="line"><span class="string">)</span></span><br></pre></td></tr></table></figure><p>当不再使用 docker 作为 Kubernetes 的容器运行时之后，宿主机上则就没有了 docker 守护进程，挂载 <code>/var/run/docker.sock</code> 的方式也就凉凉了，因此我们需要找到一些替代的方法。</p><p>目前能想到的有两种方案：方案一是替代掉 docker 使用其他镜像构建工具比如 <a href="https://github.com/containers/podman" target="_blank" rel="noopener">podman</a> + <a href="https://github.com/containers/skopeo" target="_blank" rel="noopener">skopeo</a> + <a href="https://github.com/containers/buildah" target="_blank" rel="noopener">buildah</a>。陈少文博主在《<a href="https://www.chenshaowen.com/blog/using-podman-to-build-images-under-kubernetes-and-jenkins.html" target="_blank" rel="noopener">基于 Kubernetes 的 Jenkins 服务也可以去 Docker 了</a>》详细地讲过该方案。但我们的 Makefile 里缝合了一些 docker buildKit 的特性参数并不能地通过 <code>alias docker=podman</code> 别名的方式简单粗暴地给替换掉 😂。</p><p>比如 podman 构建镜像就不支持 <code>--output type=local,dest=path</code>  <a href="https://github.com/containers/buildah/issues/3789" target="_blank" rel="noopener">Support custom build outputs #3789</a> 这种特性。目前看来 podman 想要完全取代掉 docker 的老大哥地位仍还有很长的路要走，尤其 podman 还没有解决自身的镜像是由 docker 来构建的这个尴尬难题。</p><p>方案二就是继续使用 docker 作为镜像构建工具，虽然集群节点上没有了 docker 守护进程，但这并不意味着在 Kubernetes 集群里就无法使用 docker 了。我们可以换种方式将 docker 作为一个 pod 运行在 kubernetes 集群中，而非以 systemd 的方式部署在节点上。然后通过 service IP 或 Node IP 访问 docker 的 TCP 端口进行通信，这样也能无缝地继续使用 docker 。于是在 dind (docker-in-docker) 的基础上就有了 dinp (docker-in-pod) 的套娃操作，其实二者本质上都是相同的，只不过是部署方式和访问方式不太相同而已。</p><p>对比一下这两种方案，方案一通过 <code>alias docker=podman</code> 使用 podman 替代 docker 有点投机取巧，在正式的生产环境流水线中应该很少会被采用，除非你的 Makefile 或者镜像构建脚本中没有依赖 docker 的特性参数，能够完全兼容 podman；方案二比较稳定可靠，它无非就是将之前的宿主机节点上的 docker 守护进程替换成了集群内的 Pod，对于使用者而言只需要修改一下访问 docker 的方式，即 <code>DOCKER_HOST</code> 环境变量即可。因此本文选用方案二来给大家介绍几种在 K8s 集群里部署和使用 dind/dinp 的方式。</p><h2 id="docker-in-pod"><a href="#docker-in-pod" class="headerlink" title="docker in pod"></a>docker in pod</h2><p>不同于 docker in docker，docker in pod 并不关心底层的容器运行时是什么，可以是 docker 也可以是 containerd。在 pod 内运行和使用 docker 个人总结出以下三种比较合适的方式，可以根据不同的场景选择一个合适的：</p><h3 id="sidecar"><a href="#sidecar" class="headerlink" title="sidecar"></a>sidecar</h3><p>将 dind 容器作为 <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/#using-pods" target="_blank" rel="noopener">sidecar 容器</a> 来运行，主容器通过 localhost 的方式访问 docker 的 2375/2376 TCP 端口。这种方案的好处就是如果创建了多个 Pod，各个 Pod 之间是相互独立的，dind 容器不会共享给其他 pod 使用，隔离性比较好。缺点也比较明显，每一个 Pod 都带一个 dind 容器占用的系统资源比较多，有点大材小用的感觉；</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dinp-sidecar</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">docker:20.10.12</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">debug</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["sleep",</span> <span class="string">"3600"</span><span class="string">]</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DOCKER_TLS_VERIFY</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">""</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DOCKER_HOST</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">tcp://localhost:2375</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dind</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker:20.10.12-dind-rootless</span></span><br><span class="line">    <span class="attr">args:</span> <span class="string">["--insecure-registry=$(REGISTRY)"]</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="comment"># 如果镜像仓库域名为自签证书，需要在这里配置 insecure-registry</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REGISTRY</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">hub.k8s.li</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DOCKER_TLS_CERTDIR</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">""</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DOCKER_HOST</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">tcp://localhost:2375</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 使用 docker info 命令就绪探针来确保 dind 容器正常启动 </span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">["docker",</span> <span class="string">"info"</span><span class="string">]</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">6</span></span><br></pre></td></tr></table></figure><h3 id="daemonset"><a href="#daemonset" class="headerlink" title="daemonset"></a>daemonset</h3><p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/" target="_blank" rel="noopener">daemonset</a> 则是在集群的每一个 Node 节点上运行一个 dind Pod，并且使用 hostNetwork 方式来暴露 2375/2376 TCP 端口。使用者则通过 <code>status.hostIP</code> 访问宿主机的 2375/2376 TCP 端口来与 docker 进行通信；另外再通过 hostPath 挂载的方式来将 dind 容器内的 <code>/var/lib/docker</code> 数据持久化存储下来，能够缓存一些数据提高镜像构建的效率。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dinp-daemonset</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">dinp-daemonset</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">dinp-daemonset</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dind</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker:20.10.12-dind</span></span><br><span class="line">        <span class="attr">args:</span> <span class="string">["--insecure-registry=$(REGISTRY)"]</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REGISTRY</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">hub.k8s.li</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DOCKER_TLS_CERTDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">""</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span>  <span class="string">/var/lib/docker</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span> <span class="string">["docker",</span> <span class="string">"info"</span><span class="string">]</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">6</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span> <span class="string">["docker",</span> <span class="string">"info"</span><span class="string">]</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-storage</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker</span></span><br></pre></td></tr></table></figure><h3 id="deployment"><a href="#deployment" class="headerlink" title="deployment"></a>deployment</h3><p>Deployment 方式则是在集群中部署一个或多个 dind Pod，使用者通过 service IP 来访问 docker 的 2375/2376 端口，如果是以非 TLS 方式启动 dind 容器，使用 service IP 来访问 docker 要比前面的 daemonset 使用 host IP 安全性要好一些。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dinp-deployment</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dinp-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">dinp-deployment</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">dinp-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dind</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker:20.10.12-dind</span></span><br><span class="line">        <span class="attr">args:</span> <span class="string">["--insecure-registry=$(REGISTRY)"]</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REGISTRY</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">hub.k8s.li</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DOCKER_TLS_CERTDIR</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">""</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DOCKER_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">tcp://localhost:2375</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span>  <span class="string">/var/lib/docker</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span> <span class="string">["docker",</span> <span class="string">"info"</span><span class="string">]</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">6</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">exec:</span></span><br><span class="line">            <span class="attr">command:</span> <span class="string">["docker",</span> <span class="string">"info"</span><span class="string">]</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">docker-storage</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 定义 service name，使用者通过它来访问 docker 的 2375 端口</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dinp-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dinp-deployment</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">2375</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">2375</span></span><br></pre></td></tr></table></figure><h2 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h2><p>在 Jenkins 的 podTemplate 模版里，可以根据 dinp 部署方式的不同选用以下几种不同的模版：</p><h3 id="sidecare"><a href="#sidecare" class="headerlink" title="sidecare"></a>sidecare</h3><p>Pod 内容器共享同一个网络协议栈，因此可以通过 localhost 来访问 docker 的 TCP 端口，另外最好使用 rootless 模式启动 dind 容器，这样能在同一节点上运行多个这样的 Pod 实例。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">def</span> <span class="string">JOB_NAME</span> <span class="string">=</span> <span class="string">"$&#123;env.JOB_BASE_NAME&#125;"</span></span><br><span class="line"><span class="string">def</span> <span class="string">BUILD_NUMBER</span> <span class="string">=</span> <span class="string">"$&#123;env.BUILD_NUMBER&#125;"</span></span><br><span class="line"><span class="string">def</span> <span class="string">POD_NAME</span> <span class="string">=</span> <span class="string">"jenkins-$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125;"</span></span><br><span class="line"><span class="string">def</span> <span class="string">K8S_CLUSTER</span> <span class="string">=</span> <span class="string">params.k8s_cluster</span> <span class="string">?:</span> <span class="string">kubernetes</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">Kubernetes</span> <span class="string">pod</span> <span class="string">template</span> <span class="string">to</span> <span class="string">run.</span></span><br><span class="line"><span class="string">podTemplate(</span></span><br><span class="line">    <span class="attr">cloud:</span> <span class="string">K8S_CLUSTER,</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">"default"</span><span class="string">,</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">POD_NAME,</span></span><br><span class="line">    <span class="attr">label:</span> <span class="string">POD_NAME,</span></span><br><span class="line">    <span class="attr">yaml:</span> <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: runner</span></span><br><span class="line"><span class="string">    image: golang:1.17-buster</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    tty: true</span></span><br><span class="line"><span class="string">    env:</span></span><br><span class="line"><span class="string">    - name: DOCKER_HOST</span></span><br><span class="line"><span class="string">      vaule: tcp://localhost:2375</span></span><br><span class="line"><span class="string">    - name: DOCKER_TLS_VERIFY</span></span><br><span class="line"><span class="string">      value: "</span><span class="string">"</span></span><br><span class="line"><span class="string">  - name: jnlp</span></span><br><span class="line"><span class="string">    args: ["</span><span class="string">\$(JENKINS_SECRET)",</span> <span class="string">"\$(JENKINS_NAME)"</span><span class="string">]</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"jenkins/inbound-agent:4.11.2-4-alpine"</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dind</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker:20.10.12-dind-rootless</span></span><br><span class="line">    <span class="attr">args:</span> <span class="string">["--insecure-registry=$(REGISTRY)"]</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">REGISTRY</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">hub.k8s.li</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DOCKER_TLS_CERTDIR</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">["docker",</span> <span class="string">"info"</span><span class="string">]</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">6</span></span><br><span class="line"><span class="string">""</span><span class="string">",</span></span><br><span class="line"><span class="string">) &#123;</span></span><br><span class="line"><span class="string">    node(POD_NAME) &#123;</span></span><br><span class="line"><span class="string">        container("</span><span class="string">runner")</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">stage("Checkout")</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">retry(10)</span> <span class="string">&#123;</span></span><br><span class="line">                    <span class="string">checkout([</span></span><br><span class="line">                        <span class="string">$class:</span> <span class="string">'GitSCM'</span><span class="string">,</span></span><br><span class="line">                        <span class="attr">branches:</span> <span class="string">scm.branches,</span></span><br><span class="line">                        <span class="attr">doGenerateSubmoduleConfigurations:</span> <span class="string">scm.doGenerateSubmoduleConfigurations,</span></span><br><span class="line">                        <span class="attr">extensions:</span> <span class="string">[[$class:</span> <span class="string">'CloneOption'</span><span class="string">,</span> <span class="attr">noTags:</span> <span class="literal">false</span><span class="string">,</span> <span class="attr">shallow:</span> <span class="literal">false</span><span class="string">,</span> <span class="attr">depth:</span> <span class="number">0</span><span class="string">,</span> <span class="attr">reference:</span> <span class="string">''</span><span class="string">]],</span></span><br><span class="line">                        <span class="attr">userRemoteConfigs:</span> <span class="string">scm.userRemoteConfigs,</span></span><br><span class="line">                    <span class="string">])</span></span><br><span class="line">                <span class="string">&#125;</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">            <span class="string">stage("Build")</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">sh</span> <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">                # make docker-build</span></span><br><span class="line"><span class="string">                docker build -t app:v1.0.0-alpha.1 .</span></span><br><span class="line"><span class="string">                "</span><span class="string">""</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="daemonset-1"><a href="#daemonset-1" class="headerlink" title="daemonset"></a>daemonset</h3><p>由于使用的是 hostNetwork，因此可以通过 host IP 来访问 docker 的 TCP 端口，当然也可以像 deployment 那样通过 service Name 来访问，在这里就不演示了。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">def</span> <span class="string">JOB_NAME</span> <span class="string">=</span> <span class="string">"$&#123;env.JOB_BASE_NAME&#125;"</span></span><br><span class="line"><span class="string">def</span> <span class="string">BUILD_NUMBER</span> <span class="string">=</span> <span class="string">"$&#123;env.BUILD_NUMBER&#125;"</span></span><br><span class="line"><span class="string">def</span> <span class="string">POD_NAME</span> <span class="string">=</span> <span class="string">"jenkins-$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125;"</span></span><br><span class="line"><span class="string">def</span> <span class="string">K8S_CLUSTER</span> <span class="string">=</span> <span class="string">params.k8s_cluster</span> <span class="string">?:</span> <span class="string">kubernetes</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">Kubernetes</span> <span class="string">pod</span> <span class="string">template</span> <span class="string">to</span> <span class="string">run.</span></span><br><span class="line"><span class="string">podTemplate(</span></span><br><span class="line">    <span class="attr">cloud:</span> <span class="string">K8S_CLUSTER,</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">"default"</span><span class="string">,</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">POD_NAME,</span></span><br><span class="line">    <span class="attr">label:</span> <span class="string">POD_NAME,</span></span><br><span class="line">    <span class="attr">yaml:</span> <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: runner</span></span><br><span class="line"><span class="string">    image: golang:1.17-buster</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    tty: true</span></span><br><span class="line"><span class="string">    env:</span></span><br><span class="line"><span class="string">    - name: DOCKER_HOST</span></span><br><span class="line"><span class="string">      valueFrom:</span></span><br><span class="line"><span class="string">        fieldRef:</span></span><br><span class="line"><span class="string">          fieldPath: status.hostIP</span></span><br><span class="line"><span class="string">    - name: DOCKER_TLS_VERIFY</span></span><br><span class="line"><span class="string">      value: "</span><span class="string">"</span></span><br><span class="line"><span class="string">  - name: jnlp</span></span><br><span class="line"><span class="string">    args: ["</span><span class="string">\$(JENKINS_SECRET)",</span> <span class="string">"\$(JENKINS_NAME)"</span><span class="string">]</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"jenkins/inbound-agent:4.11.2-4-alpine"</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="string">""</span><span class="string">",</span></span><br><span class="line"><span class="string">) &#123;</span></span><br><span class="line"><span class="string">    node(POD_NAME) &#123;</span></span><br><span class="line"><span class="string">        container("</span><span class="string">runner")</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">stage("Checkout")</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">retry(10)</span> <span class="string">&#123;</span></span><br><span class="line">                    <span class="string">checkout([</span></span><br><span class="line">                        <span class="string">$class:</span> <span class="string">'GitSCM'</span><span class="string">,</span></span><br><span class="line">                        <span class="attr">branches:</span> <span class="string">scm.branches,</span></span><br><span class="line">                        <span class="attr">doGenerateSubmoduleConfigurations:</span> <span class="string">scm.doGenerateSubmoduleConfigurations,</span></span><br><span class="line">                        <span class="attr">extensions:</span> <span class="string">[[$class:</span> <span class="string">'CloneOption'</span><span class="string">,</span> <span class="attr">noTags:</span> <span class="literal">false</span><span class="string">,</span> <span class="attr">shallow:</span> <span class="literal">false</span><span class="string">,</span> <span class="attr">depth:</span> <span class="number">0</span><span class="string">,</span> <span class="attr">reference:</span> <span class="string">''</span><span class="string">]],</span></span><br><span class="line">                        <span class="attr">userRemoteConfigs:</span> <span class="string">scm.userRemoteConfigs,</span></span><br><span class="line">                    <span class="string">])</span></span><br><span class="line">                <span class="string">&#125;</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">            <span class="string">stage("Build")</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">sh</span> <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">                # make docker-build</span></span><br><span class="line"><span class="string">                docker build -t app:v1.0.0-alpha.1 .</span></span><br><span class="line"><span class="string">                "</span><span class="string">""</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="deployment-1"><a href="#deployment-1" class="headerlink" title="deployment"></a>deployment</h3><p>通过 service name 访问 docker，其他参数和 daemonset 都是相同的</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">def</span> <span class="string">JOB_NAME</span> <span class="string">=</span> <span class="string">"$&#123;env.JOB_BASE_NAME&#125;"</span></span><br><span class="line"><span class="string">def</span> <span class="string">BUILD_NUMBER</span> <span class="string">=</span> <span class="string">"$&#123;env.BUILD_NUMBER&#125;"</span></span><br><span class="line"><span class="string">def</span> <span class="string">POD_NAME</span> <span class="string">=</span> <span class="string">"jenkins-$&#123;JOB_NAME&#125;-$&#123;BUILD_NUMBER&#125;"</span></span><br><span class="line"><span class="string">def</span> <span class="string">K8S_CLUSTER</span> <span class="string">=</span> <span class="string">params.k8s_cluster</span> <span class="string">?:</span> <span class="string">kubernetes</span></span><br><span class="line"></span><br><span class="line"><span class="string">//</span> <span class="string">Kubernetes</span> <span class="string">pod</span> <span class="string">template</span> <span class="string">to</span> <span class="string">run.</span></span><br><span class="line"><span class="string">podTemplate(</span></span><br><span class="line">    <span class="attr">cloud:</span> <span class="string">K8S_CLUSTER,</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">"default"</span><span class="string">,</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">POD_NAME,</span></span><br><span class="line">    <span class="attr">label:</span> <span class="string">POD_NAME,</span></span><br><span class="line">    <span class="attr">yaml:</span> <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: runner</span></span><br><span class="line"><span class="string">    image: golang:1.17-buster</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    tty: true</span></span><br><span class="line"><span class="string">    env:</span></span><br><span class="line"><span class="string">    - name: DOCKER_HOST</span></span><br><span class="line"><span class="string">       value: tcp://dinp-deployment:2375</span></span><br><span class="line"><span class="string">    - name: DOCKER_TLS_VERIFY</span></span><br><span class="line"><span class="string">      value: "</span><span class="string">"</span></span><br><span class="line"><span class="string">  - name: jnlp</span></span><br><span class="line"><span class="string">    args: ["</span><span class="string">\$(JENKINS_SECRET)",</span> <span class="string">"\$(JENKINS_NAME)"</span><span class="string">]</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">"jenkins/inbound-agent:4.11.2-4-alpine"</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="string">""</span><span class="string">",</span></span><br><span class="line"><span class="string">) &#123;</span></span><br><span class="line"><span class="string">    node(POD_NAME) &#123;</span></span><br><span class="line"><span class="string">        container("</span><span class="string">runner")</span> <span class="string">&#123;</span></span><br><span class="line">            <span class="string">stage("Checkout")</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">retry(10)</span> <span class="string">&#123;</span></span><br><span class="line">                    <span class="string">checkout([</span></span><br><span class="line">                        <span class="string">$class:</span> <span class="string">'GitSCM'</span><span class="string">,</span></span><br><span class="line">                        <span class="attr">branches:</span> <span class="string">scm.branches,</span></span><br><span class="line">                        <span class="attr">doGenerateSubmoduleConfigurations:</span> <span class="string">scm.doGenerateSubmoduleConfigurations,</span></span><br><span class="line">                        <span class="attr">extensions:</span> <span class="string">[[$class:</span> <span class="string">'CloneOption'</span><span class="string">,</span> <span class="attr">noTags:</span> <span class="literal">false</span><span class="string">,</span> <span class="attr">shallow:</span> <span class="literal">false</span><span class="string">,</span> <span class="attr">depth:</span> <span class="number">0</span><span class="string">,</span> <span class="attr">reference:</span> <span class="string">''</span><span class="string">]],</span></span><br><span class="line">                        <span class="attr">userRemoteConfigs:</span> <span class="string">scm.userRemoteConfigs,</span></span><br><span class="line">                    <span class="string">])</span></span><br><span class="line">                <span class="string">&#125;</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">            <span class="string">stage("Build")</span> <span class="string">&#123;</span></span><br><span class="line">                <span class="string">sh</span> <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">                # make docker-build</span></span><br><span class="line"><span class="string">                docker build -t app:v1.0.0-alpha.1 .</span></span><br><span class="line"><span class="string">                "</span><span class="string">""</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="readinessProbe"><a href="#readinessProbe" class="headerlink" title="readinessProbe"></a>readinessProbe</h3><p>有些时候 dind 无法正常启动，所以一定要设置就绪探针，来确保 diind 容器能够正常启动</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">readinessProbe:</span></span><br><span class="line">  <span class="attr">exec:</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["docker",</span> <span class="string">"info"</span><span class="string">]</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">6</span></span><br></pre></td></tr></table></figure><h3 id="2375-2376-端口"><a href="#2375-2376-端口" class="headerlink" title="2375/2376 端口"></a>2375/2376 端口</h3><p>docker 默认是以 TLS 方式启动，监听端口为 2376，如果设置环境变量 <code>DOCKER_TLS_CERTDIR</code> 为空则就以非 TLS 模式启动，监听端口为 2375，这时就不会校验 TLS 证书。如果使用 2376 端口，则就需要一个持久化存储来将 docker 生成的证书共享给客户端，这点比较麻烦。因此如果不想瞎折腾还是使用 2375 非 TLS 方式吧 😂。</p><h3 id="dinp-必须以开启-privileged-true"><a href="#dinp-必须以开启-privileged-true" class="headerlink" title="dinp 必须以开启 privileged: true"></a>dinp 必须以开启 privileged: true</h3><p>以 pod 方式运行 docker，无论是否是 rootless 模式，都要在 pod 容器的 <code>securityContext</code> 中设置 <code>privileged: true</code>，否则 pod 无法正常启动。而且 rootless 模式也有一定的限制，需要依赖一些内核的特性，目前也只是实验阶段，没有特殊的需求还是尽量不要使用 rootless 特性吧。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# kubectl logs -f dinp-sidecar</span><br><span class="line">error: a container name must be specified for pod dinp-sidecar, choose one of: [debug dind]</span><br><span class="line">[root@localhost ~]# kubectl logs -f dinp-sidecar -c dind</span><br><span class="line">Device &quot;ip_tables&quot; does not exist.</span><br><span class="line">ip_tables              27126  4 iptable_raw,iptable_mangle,iptable_filter,iptable_nat</span><br><span class="line">modprobe: can&#39;t change directory to &#39;&#x2F;lib&#x2F;modules&#39;: No such file or directory</span><br><span class="line">WARN[0000] failed to mount sysfs, falling back to read-only mount: operation not permitted</span><br><span class="line">WARN[0000] failed to mount sysfs: operation not permitted</span><br><span class="line">open: No such file or directory</span><br><span class="line">[rootlesskit:child ] error: executing [[ip tuntap add name tap0 mode tap] [ip link set tap0 address 02:50:00:00:00:01]]: exit status 1</span><br></pre></td></tr></table></figure><h3 id="rootless-user-max-user-namespaces"><a href="#rootless-user-max-user-namespaces" class="headerlink" title="rootless user.max_user_namespaces"></a>rootless user.max_user_namespaces</h3><p>rootless 模式下需要依赖一些内核参数 <a href="https://docs.docker.com/engine/security/rootless/" target="_blank" rel="noopener">Run the Docker daemon as a non-root user (Rootless mode)</a>。在 CentOS 7.9 上会出现 <a href="https://github.com/docker-library/docker/issues/201" target="_blank" rel="noopener">dind-rootless: failed to start up dind rootless in k8s due to max_user_namespaces</a> 问题。解决方案是在修改一下 <code>user.max_user_namespaces=28633</code> 内核参数。</p><blockquote><p>Add user.max_user_namespaces=28633 to /etc/sysctl.conf (or /etc/sysctl.d) and run sudo sysctl -p</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># kubectl get pod -w</span></span><br><span class="line">NAME                              READY   STATUS   RESTARTS     AGE</span><br><span class="line">dinp-deployment-cf488bfd8-g8vxx   0/1     CrashLoopBackOff   1 (2s ago)   4s</span><br><span class="line">[root@localhost ~]<span class="comment"># kubectl logs -f dinp-deployment-cf488bfd8-m5cms</span></span><br><span class="line">Device <span class="string">"ip_tables"</span> does not exist.</span><br><span class="line">ip_tables              27126  5 iptable_raw,iptable_mangle,iptable_filter,iptable_nat</span><br><span class="line">modprobe: can<span class="string">'t change directory to '</span>/lib/modules<span class="string">': No such file or directory</span></span><br><span class="line"><span class="string">error: attempting to run rootless dockerd but need '</span>user.max_user_namespaces<span class="string">' (/proc/sys/user/max_user_namespaces) set to a sufficiently large value</span></span><br></pre></td></tr></table></figure><h3 id="非-rootless-模式下同一-node-节点只能运行一个-dinp"><a href="#非-rootless-模式下同一-node-节点只能运行一个-dinp" class="headerlink" title="非 rootless 模式下同一 node 节点只能运行一个 dinp"></a>非 rootless 模式下同一 node 节点只能运行一个 dinp</h3><p>如果是使用 deployment 方式部署 dinp，一个 node 节点上只能有一个 dinp Pod，多余的 Pod 无法正常启动。因此如果想要运行多个 dinp Pod，建议使用 daemonset 方式运行它；</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# kubectl get deploy</span><br><span class="line">NAME              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">dinp-deployment   1&#x2F;3     3            1           4m16s</span><br><span class="line">[root@localhost ~]# kubectl get pod -w</span><br><span class="line">NAME                               READY   STATUS    RESTARTS      AGE</span><br><span class="line">dinp-deployment-547bd9bb6d-2mn6c   0&#x2F;1     Running   3 (61s ago)   4m9s</span><br><span class="line">dinp-deployment-547bd9bb6d-8ht8l   1&#x2F;1     Running   0             4m9s</span><br><span class="line">dinp-deployment-547bd9bb6d-x5vpv   0&#x2F;1     Running   3 (61s ago)   4m9s</span><br><span class="line">[root@localhost ~]# kubectl logs -f dinp-deployment-547bd9bb6d-2mn6c</span><br><span class="line">INFO[2022-03-14T14:14:10.905652548Z] Starting up</span><br><span class="line">WARN[2022-03-14T14:14:10.906986721Z] could not change group &#x2F;var&#x2F;run&#x2F;docker.sock to docker: group docker not found</span><br><span class="line">WARN[2022-03-14T14:14:10.907249071Z] Binding to IP address without --tlsverify is insecure and gives root access on this machine to everyone who has access to your network.  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;</span><br><span class="line">WARN[2022-03-14T14:14:10.907269951Z] Binding to an IP address, even on localhost, can also give access to scripts run in a browser. Be safe out there!  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;</span><br><span class="line">WARN[2022-03-14T14:14:11.908057635Z] Binding to an IP address without --tlsverify is deprecated. Startup is intentionally being slowed down to show this message  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;</span><br><span class="line">WARN[2022-03-14T14:14:11.908103696Z] Please consider generating tls certificates with client validation to prevent exposing unauthenticated root access to your network  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;</span><br><span class="line">WARN[2022-03-14T14:14:11.908114541Z] You can override this by explicitly specifying &#39;--tls&#x3D;false&#39; or &#39;--tlsverify&#x3D;false&#39;  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;</span><br><span class="line">WARN[2022-03-14T14:14:11.908125477Z] Support for listening on TCP without authentication or explicit intent to run without authentication will be removed in the next release  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;</span><br><span class="line">INFO[2022-03-14T14:14:26.914587276Z] libcontainerd: started new containerd process  pid&#x3D;41</span><br><span class="line">INFO[2022-03-14T14:14:26.914697125Z] parsed scheme: &quot;unix&quot;                         module&#x3D;grpc</span><br><span class="line">INFO[2022-03-14T14:14:26.914710376Z] scheme &quot;unix&quot; not registered, fallback to default scheme  module&#x3D;grpc</span><br><span class="line">INFO[2022-03-14T14:14:26.914785052Z] ccResolverWrapper: sending update to cc: &#123;[&#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;] &lt;nil&gt; &lt;nil&gt;&#125;  module&#x3D;grpc</span><br><span class="line">INFO[2022-03-14T14:14:26.914796039Z] ClientConn switching balancer to &quot;pick_first&quot;  module&#x3D;grpc</span><br><span class="line">INFO[2022-03-14T14:14:26.930311832Z] starting containerd                           revision&#x3D;7b11cfaabd73bb80907dd23182b9347b4245eb5d version&#x3D;v1.4.12</span><br><span class="line">INFO[2022-03-14T14:14:26.953641900Z] loading plugin &quot;io.containerd.content.v1.content&quot;...  type&#x3D;io.containerd.content.v1</span><br><span class="line">INFO[2022-03-14T14:14:26.953721059Z] loading plugin &quot;io.containerd.snapshotter.v1.aufs&quot;...  type&#x3D;io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-03-14T14:14:26.960295816Z] skip loading plugin &quot;io.containerd.snapshotter.v1.aufs&quot;...  error&#x3D;&quot;aufs is not supported (modprobe aufs failed: exit status 1 \&quot;ip: can&#39;t find device &#39;aufs&#39;\\nmodprobe: can&#39;t change directory to &#39;&#x2F;lib&#x2F;modules&#39;: No such file or directory\\n\&quot;): skip plugin&quot; type&#x3D;io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-03-14T14:14:26.960329840Z] loading plugin &quot;io.containerd.snapshotter.v1.btrfs&quot;...  type&#x3D;io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-03-14T14:14:26.960524514Z] skip loading plugin &quot;io.containerd.snapshotter.v1.btrfs&quot;...  error&#x3D;&quot;path &#x2F;var&#x2F;lib&#x2F;docker&#x2F;containerd&#x2F;daemon&#x2F;io.containerd.snapshotter.v1.btrfs (xfs) must be a btrfs filesystem to be used with the btrfs snapshotter: skip plugin&quot; type&#x3D;io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-03-14T14:14:26.960537441Z] loading plugin &quot;io.containerd.snapshotter.v1.devmapper&quot;...  type&#x3D;io.containerd.snapshotter.v1</span><br><span class="line">WARN[2022-03-14T14:14:26.960558843Z] failed to load plugin io.containerd.snapshotter.v1.devmapper  error&#x3D;&quot;devmapper not configured&quot;</span><br><span class="line">INFO[2022-03-14T14:14:26.960569516Z] loading plugin &quot;io.containerd.snapshotter.v1.native&quot;...  type&#x3D;io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-03-14T14:14:26.960593224Z] loading plugin &quot;io.containerd.snapshotter.v1.overlayfs&quot;...  type&#x3D;io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-03-14T14:14:26.960678728Z] loading plugin &quot;io.containerd.snapshotter.v1.zfs&quot;...  type&#x3D;io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-03-14T14:14:26.960814844Z] skip loading plugin &quot;io.containerd.snapshotter.v1.zfs&quot;...  error&#x3D;&quot;path &#x2F;var&#x2F;lib&#x2F;docker&#x2F;containerd&#x2F;daemon&#x2F;io.containerd.snapshotter.v1.zfs must be a zfs filesystem to be used with the zfs snapshotter: skip plugin&quot; type&#x3D;io.containerd.snapshotter.v1</span><br><span class="line">INFO[2022-03-14T14:14:26.960827133Z] loading plugin &quot;io.containerd.metadata.v1.bolt&quot;...  type&#x3D;io.containerd.metadata.v1</span><br><span class="line">WARN[2022-03-14T14:14:26.960839223Z] could not use snapshotter devmapper in metadata plugin  error&#x3D;&quot;devmapper not configured&quot;</span><br><span class="line">INFO[2022-03-14T14:14:26.960848698Z] metadata content store policy set             policy&#x3D;shared</span><br><span class="line">WARN[2022-03-14T14:14:27.915528371Z] grpc: addrConn.createTransport failed to connect to &#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;. Err :connection error: desc &#x3D; &quot;transport: error while dialing: dial unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock: timeout&quot;. Reconnecting...  module&#x3D;grpc</span><br><span class="line">WARN[2022-03-14T14:14:30.722257725Z] grpc: addrConn.createTransport failed to connect to &#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;. Err :connection error: desc &#x3D; &quot;transport: error while dialing: dial unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock: timeout&quot;. Reconnecting...  module&#x3D;grpc</span><br><span class="line">WARN[2022-03-14T14:14:35.549453706Z] grpc: addrConn.createTransport failed to connect to &#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;. Err :connection error: desc &#x3D; &quot;transport: error while dialing: dial unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock: timeout&quot;. Reconnecting...  module&#x3D;grpc</span><br><span class="line">WARN[2022-03-14T14:14:41.759010407Z] grpc: addrConn.createTransport failed to connect to &#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;. Err :connection error: desc &#x3D; &quot;transport: error while dialing: dial unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock: timeout&quot;. Reconnecting...  module&#x3D;grpc</span><br><span class="line">failed to start containerd: timeout waiting for containerd to start</span><br></pre></td></tr></table></figure><h3 id="var-lib-docker-不支持共享存储"><a href="#var-lib-docker-不支持共享存储" class="headerlink" title="/var/lib/docker 不支持共享存储"></a>/var/lib/docker 不支持共享存储</h3><p>陈少文博主曾在 《<a href="https://www.chenshaowen.com/blog/can-we-mount-var-lib-docker-to-remote-storage.html" target="_blank" rel="noopener">/var/lib/docker 能不能挂载远端存储</a>》提到过 docker 目前并支持将 <code>/var/lib/docker</code> 挂载远程存储使用，因此建议使用 hostPath 的方式保存 docker 的持久化存储数据。</p><blockquote><p>本次测试使用的 Docker 版本为 20.10.6，不能将 <code>/var/lib/docker</code> 挂载远程存储使用。主要原因是容器的实现依赖于内核的能力(xttrs)，而类似 NFS Server 这种远程存储无法提供这些能力。如果采用 Device Mapper 进行映射，使用磁盘挂载存在可行性，但只能用于迁移而不能实现共享。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">INFO[2022-03-13T13:43:08.750810130Z] ClientConn switching balancer to <span class="string">"pick_first"</span>  module=grpc</span><br><span class="line">ERRO[2022-03-13T13:43:08.781932359Z] failed to mount overlay: invalid argument     storage-driver=overlay2</span><br><span class="line">ERRO[2022-03-13T13:43:08.782078828Z] <span class="built_in">exec</span>: <span class="string">"fuse-overlayfs"</span>: executable file not found <span class="keyword">in</span> <span class="variable">$PATH</span>  storage-driver=fuse-overlayfs</span><br><span class="line">ERRO[2022-03-13T13:43:08.793311119Z] AUFS was not found <span class="keyword">in</span> /proc/filesystems       storage-driver=aufs</span><br><span class="line">ERRO[2022-03-13T13:43:08.813505621Z] failed to mount overlay: invalid argument     storage-driver=overlay</span><br><span class="line">ERRO[2022-03-13T13:43:08.813529990Z] Failed to built-in GetDriver graph devicemapper /var/lib/docker</span><br><span class="line">INFO[2022-03-13T13:43:08.897769363Z] Loading containers: start.</span><br><span class="line">WARN[2022-03-13T13:43:08.919252078Z] Running modprobe bridge br_netfilter failed with message: ip: can<span class="string">'t find device '</span>bridge<span class="string">'</span></span><br><span class="line"><span class="string">[root@localhost dinp]# kubectl exec -it dinp-sidecar -c debug sh</span></span><br><span class="line"><span class="string">/ # docker pull alpine</span></span><br><span class="line"><span class="string">Using default tag: latest</span></span><br><span class="line"><span class="string">Error response from daemon: error creating temporary lease: file resize error: truncate /var/lib/docker/containerd/daemon/io.containerd.metadata.v1.bolt/meta.db: bad file descriptor: unknown</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://www.bilibili.com/video/BV1Xa411C78k" target="_blank" rel="noopener">Dockershim 即将被移除，你准备好了么？</a></li><li><a href="https://draveness.me/whys-the-design-kubernetes-deprecate-docker/" target="_blank" rel="noopener">为什么 Kubernetes 要替换 Docker</a></li><li><a href="https://applatix.com/case-docker-docker-kubernetes-part-2" target="_blank" rel="noopener">A case for Docker-in-Docker on Kubernetes</a></li><li><a href="https://docs.docker.com/engine/security/rootless/" target="_blank" rel="noopener">Run the Docker daemon as a non-root user (Rootless mode)</a></li><li><a href="https://github.com/docker-library/docker" target="_blank" rel="noopener">Docker Official Image packaging for Docker</a></li><li><a href="https://www.chenshaowen.com/blog/can-we-mount-var-lib-docker-to-remote-storage.html" target="_blank" rel="noopener">/var/lib/docker 能不能挂载远端存储</a></li><li><a href="https://www.chenshaowen.com/blog/how-to-use-docker-in-docker.html" target="_blank" rel="noopener">如何在 Docker 中使用 Docker</a></li><li><a href="https://www.chenshaowen.com/blog/using-podman-to-build-images-under-kubernetes-and-jenkins.html" target="_blank" rel="noopener">基于 Kubernetes 的 Jenkins 服务也可以去 Docker 了</a></li><li><a href="https://github.com/docker-library/docker/issues/201" target="_blank" rel="noopener">dind-rootless: failed to start up dind rootless in k8s due to max_user_namespaces #201</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;上个月参加了 Rancher 社区举办的 《&lt;a
        
      
    
    </summary>
    
    
      <category term="技术" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubernetes" scheme="https://blog.k8s.li/tags/kubernetes/"/>
    
      <category term="docker" scheme="https://blog.k8s.li/tags/docker/"/>
    
      <category term="dind" scheme="https://blog.k8s.li/tags/dind/"/>
    
      <category term="dinp" scheme="https://blog.k8s.li/tags/dinp/"/>
    
      <category term="jenkins" scheme="https://blog.k8s.li/tags/jenkins/"/>
    
  </entry>
  
  <entry>
    <title>使用 kubectl 自动归档 argo workflow 日志</title>
    <link href="https://blog.k8s.li/archive-argo-workflow-log-by-kubectl.html"/>
    <id>https://blog.k8s.li/archive-argo-workflow-log-by-kubectl.html</id>
    <published>2022-02-27T16:00:00.000Z</published>
    <updated>2022-02-27T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>项目上使用到 <a href="https://github.com/argoproj/argo-workflows" target="_blank" rel="noopener">argo-workflow</a> 作为工作流引擎来编排运行一些 <a href="https://www.smartx.com/solution/virtualization/" target="_blank" rel="noopener">超融合</a> 集群部署相关的任务，整套环境运行在一个单节点的 K3s 上。之所以选择 argo-workflow + K3s 的搭配主要是想尽可能少地占用系统资源，因为这套环境将来会运行在各种硬件配置不同的笔记本电脑上 😂。综合调研了一些常见的 K8s 部署工具最终就选择了系统资源占用较少的 K3s。</p><p>现在项目的一个需求就是在集群部署完成或失败之后需要将 workflow 的日志归档保存下来。虽然可以在 workflow 的 spec 字段中使用 <code>archiveLogs: true</code> 来让 argo 帮我们自动归档日志，但这个特性依赖于一个 S3 对象存储 <a href="https://argoproj.github.io/argo-workflows/configure-artifact-repository/" target="_blank" rel="noopener">Artifact Repository</a> 。这就意味着还要再部署一个支持 S3 对象存储的组件比如 <a href="https://min.io/" target="_blank" rel="noopener">Minio</a> ，直接把我给整不会了 🌚</p><p><img src="https://p.k8s.li/2021-08-31-pass-tob-k8s-offline-deploy-2.jpeg" alt=""></p><p>其实嘛这个需求很简单的，我就想保存一个日志文件而已，你还再让我安装一个 <a href="https://min.io/" target="_blank" rel="noopener">Minio</a>，实在是太过分了！本来系统的资源十分有限，需要尽可能减少安装一些不必要依赖，为的就是将资源利用率将到最低。但现在为了归档存储一个日志文件储而大动干戈装一个 minio 实在是不划算。这就好比你费了好大功夫部署一套 3 节点的 kubernetes 集群，然而就为了运行一个静态博客那样滑稽 😂</p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Deployed my blog on Kubernetes <a href="https://t.co/XHXWLrmYO4" target="_blank" rel="noopener">pic.twitter.com/XHXWLrmYO4</a></p>&mdash; For DevOps Eyes Only (@dexhorthy) <a href="https://twitter.com/dexhorthy/status/856639005462417409?ref_src=twsrc%5Etfw" target="_blank" rel="noopener">April 24, 2017</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>对于咱这种 <code>用不起</code> S3 对象存储的穷人家孩子，还是想一些其他办法吧，毕竟自己动手丰衣足食。</p><h2 id="kubectl"><a href="#kubectl" class="headerlink" title="kubectl"></a>kubectl</h2><p>实现起来也比较简单，对于咱这种 YAML 工程师来说，kubectl 自然再熟悉不过了。想要获取 workflow 的日志，只需要通过 kubectl logs 命令获取出 workflow 所创的 pod 日志就行了呀，要什么 S3 对象存储 😖</p><h3 id="筛选-pod"><a href="#筛选-pod" class="headerlink" title="筛选 pod"></a>筛选 pod</h3><p>对于同一个 workflow 来将，每个 stage 所创建出来的 pod name 有一定的规律。在定义 workflow 的时候，<a href="https://argoproj.github.io/argo-workflows/fields/#objectmeta" target="_blank" rel="noopener">generateName</a> 参数通常使用 <code>${name}-</code> 格式。以 <code>-</code> 作为分隔符，最后一个字段是随机生成的一个数字 ID，倒数第二个字段则是 argo 随机生成的 workflow ID，剩余前面的字符则是我们定义的 generateName。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">argoproj.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Workflow</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">generateName:</span> <span class="string">archive-log-test-</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">archive-log-test-jzt8n-3498199655                          0/2     Completed   0               4m18s</span><br><span class="line">archive-log-test-jzt8n-3618624526                          0/2     Completed   0               4m8s</span><br><span class="line">archive-log-test-jzt8n-2123203324                          0/2     Completed   0               3m58s</span><br></pre></td></tr></table></figure><p>在 pod 的 labels 中同样也包含着该 workflow 所对应的 ID，因此我们可以根据此 labels 过滤出该 workflow 所创建出来的 pod。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">workflows.argoproj.io/node-id:</span> <span class="string">archive-log-test-jzt8n-3498199655</span></span><br><span class="line">    <span class="attr">workflows.argoproj.io/node-name:</span> <span class="string">archive-log-test-jzt8n[0].list-default-running-pods</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">"2022-02-28T12:53:32Z"</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">workflows.argoproj.io/completed:</span> <span class="string">"true"</span></span><br><span class="line">    <span class="attr">workflows.argoproj.io/workflow:</span> <span class="string">archive-log-test-jzt8n</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">archive-log-test-jzt8n-3498199655</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">ownerReferences:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiVersion:</span> <span class="string">argoproj.io/v1alpha1</span></span><br><span class="line">    <span class="attr">blockOwnerDeletion:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">controller:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Workflow</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">archive-log-test-jzt8n</span></span><br><span class="line">    <span class="attr">uid:</span> <span class="string">e91df2cb-b567-4cf0-9be5-3dd6c72854cd</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">"1251330"</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">ce37a709-8236-445b-8d00-a7926fa18ed0</span></span><br></pre></td></tr></table></figure><p>通过 <code>-l lables</code> 过滤出一个 workflow 所创建的 pod；通过 <code>--sort-by</code> 以创建时间进行排序；通过 <code>-o name</code> 只输出 pod 的 name：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -l workflows.argoproj.io/workflow=archive-log-test-jzt8n --sort-by=<span class="string">'.metadata.creationTimestamp'</span> -o name</span><br><span class="line">pod/archive-log-test-jzt8n-3498199655</span><br><span class="line">pod/archive-log-test-jzt8n-3618624526</span><br><span class="line">pod/archive-log-test-jzt8n-2123203324</span><br></pre></td></tr></table></figure><h3 id="获取日志"><a href="#获取日志" class="headerlink" title="获取日志"></a>获取日志</h3><p>通过上面的步骤我们就可以获取到一个 workflow 所创建的 pod 列表。然后再通过 kubectl logs 命令获取 pod 中 main 容器的日志，为方便区分日志的所对应的 workflow ，我们就以 workflow 的 ID 为前缀名。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs archive-log-test-jzt8n-3618624526 -c main</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOG_PATH=/var/<span class="built_in">log</span></span><br><span class="line">NAME=archive-log-test-jzt8n</span><br><span class="line">kubectl get pods -l workflows.argoproj.io/workflow=<span class="variable">$&#123;NAME&#125;</span> \</span><br><span class="line">--sort-by=<span class="string">'.metadata.creationTimestamp'</span> -o name \</span><br><span class="line">| xargs -I &#123;&#125; -t kubectl logs &#123;&#125; -c main &gt;&gt; <span class="variable">$&#123;LOG_PATH&#125;</span>/<span class="variable">$&#123;NAME&#125;</span>.<span class="built_in">log</span></span><br></pre></td></tr></table></figure><h3 id="workflow"><a href="#workflow" class="headerlink" title="workflow"></a>workflow</h3><p>根据 argo-workflow 官方提供的 <a href="https://github.com/argoproj/argo-workflows/blob/master/examples/exit-handlers.yaml" target="_blank" rel="noopener"><strong>exit-handlers.yaml</strong></a> example，我们就照葫芦画瓢搓一个 workflow 退出后自动调用使用 kubectl 获取 workflow 日志的一个 step，定义的 exit-handler 内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">exit-handler</span></span><br><span class="line">    <span class="attr">container:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">"kubectl"</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">lachlanevenson/k8s-kubectl:v1.23.2</span></span><br><span class="line">      <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line">          <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-l</span> <span class="string">workflows.argoproj.io/workflow=$&#123;POD_NAME%-*&#125;</span> <span class="string">\</span></span><br><span class="line">          <span class="string">--sort-by=".metadata.creationTimestamp"</span> <span class="string">-o</span> <span class="string">name</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-v</span> <span class="string">$&#123;POD_NAME&#125;</span> <span class="string">\</span></span><br><span class="line">          <span class="string">|</span> <span class="string">xargs</span> <span class="string">-I</span> <span class="string">&#123;&#125;</span> <span class="string">-t</span> <span class="string">kubectl</span> <span class="string">logs</span> <span class="string">&#123;&#125;</span> <span class="string">-c</span> <span class="string">main</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;LOG_PATH&#125;/$&#123;POD_NAME%-*&#125;.log</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOG_PATH</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">/var/log/workflow</span></span><br><span class="line">      <span class="attr">resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-datastore</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log/workflow</span></span><br><span class="line">    <span class="attr">retryStrategy:</span></span><br><span class="line">      <span class="attr">limit:</span> <span class="string">"5"</span></span><br><span class="line">      <span class="attr">retryPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line"><span class="attr">entrypoint:</span> <span class="string">archive-log-test</span></span><br><span class="line"><span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-datastore</span></span><br><span class="line">    <span class="attr">nfs:</span></span><br><span class="line">      <span class="attr">server:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data/workflow/log</span></span><br><span class="line"><span class="attr">onExit:</span> <span class="string">exit-handler</span></span><br></pre></td></tr></table></figure><p>将上述定义的 <code>exit-handler</code> 内容复制粘贴到你的 workflow spec 配置中就可以。由于日志需要持久化存储，我这里使用的是 NFS 存储，也可以根据自己的需要换成其他存储，只需要修改一下 <code>volumes</code> 配置即可。</p><p>完整的 <a href="https://gist.github.com/muzi502/9b26c6854c509c42ecd7f7004436ca23" target="_blank" rel="noopener">workflow example</a> 如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">argoproj.io/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Workflow</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">generateName:</span> <span class="string">archive-log-test-</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">templates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">archive-log-test</span></span><br><span class="line">      <span class="attr">steps:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">list-default-running-pods</span></span><br><span class="line">            <span class="attr">template:</span> <span class="string">kubectl</span></span><br><span class="line">            <span class="attr">arguments:</span></span><br><span class="line">              <span class="attr">parameters:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">namespace</span></span><br><span class="line">                  <span class="attr">value:</span> <span class="string">default</span></span><br><span class="line">        <span class="bullet">-</span> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">list-kube-system-running-pods</span></span><br><span class="line">            <span class="attr">template:</span> <span class="string">kubectl</span></span><br><span class="line">            <span class="attr">arguments:</span></span><br><span class="line">              <span class="attr">parameters:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">namespace</span></span><br><span class="line">                  <span class="attr">value:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubectl</span></span><br><span class="line">      <span class="attr">inputs:</span></span><br><span class="line">        <span class="attr">parameters:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">namespace</span></span><br><span class="line">      <span class="attr">container:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"kubectl"</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">lachlanevenson/k8s-kubectl:v1.23.2</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line">            <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">--field-selector=status.phase=Running</span> <span class="string">-n</span> <span class="string">&#123;&#123;inputs.parameters.namespace&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">exit-handler</span></span><br><span class="line">      <span class="attr">container:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"kubectl"</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">lachlanevenson/k8s-kubectl:v1.23.2</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line">            <span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-l</span> <span class="string">workflows.argoproj.io/workflow=$&#123;POD_NAME%-*&#125;</span> <span class="string">\</span></span><br><span class="line">            <span class="string">--sort-by=".metadata.creationTimestamp"</span> <span class="string">-o</span> <span class="string">name</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">-v</span> <span class="string">$&#123;POD_NAME&#125;</span> <span class="string">\</span></span><br><span class="line">            <span class="string">|</span> <span class="string">xargs</span> <span class="string">-I</span> <span class="string">&#123;&#125;</span> <span class="string">-t</span> <span class="string">kubectl</span> <span class="string">logs</span> <span class="string">&#123;&#125;</span> <span class="string">-c</span> <span class="string">main</span> <span class="string">&gt;&gt;</span> <span class="string">$&#123;LOG_PATH&#125;/$&#123;POD_NAME%-*&#125;.log</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOG_PATH</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">/var/log/workflow</span></span><br><span class="line">        <span class="attr">resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-datastore</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/var/log/workflow</span></span><br><span class="line">      <span class="attr">retryStrategy:</span></span><br><span class="line">        <span class="attr">limit:</span> <span class="string">"5"</span></span><br><span class="line">        <span class="attr">retryPolicy:</span> <span class="string">OnFailure</span></span><br><span class="line">  <span class="attr">entrypoint:</span> <span class="string">archive-log-test</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-datastore</span></span><br><span class="line">      <span class="attr">nfs:</span></span><br><span class="line">        <span class="attr">server:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/data/workflow/log</span></span><br><span class="line">  <span class="attr">onExit:</span> <span class="string">exit-handler</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;项目上使用到 &lt;a
        
      
    
    </summary>
    
    
      <category term="技术" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubectl" scheme="https://blog.k8s.li/tags/kubectl/"/>
    
      <category term="argo-workflow" scheme="https://blog.k8s.li/tags/argo-workflow/"/>
    
  </entry>
  
  <entry>
    <title>VMware Tanzu kubernetes 发行版部署尝鲜</title>
    <link href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html"/>
    <id>https://blog.k8s.li/deploy-tanzu-k8s-cluster.html</id>
    <published>2022-02-05T16:00:00.000Z</published>
    <updated>2022-02-05T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>之前接触的 Kubernetes 集群部署工具大多数都是依赖于 ssh 连接到待部署的节点上进行部署操作，这样就要求部署前需要提前准备好集群节点，且要保证这些节点的网络互通以及时钟同步等问题。类似于 kubespray 或者 kubekey 这些部署工具是不会去管这些底层的 IaaS 资源的创建，是要自己提前准备好。但是在一些企业私有云环境中，使用了如 <a href="https://docs.vmware.com/cn/VMware-vSphere/index.html" target="_blank" rel="noopener">VMware vShpere</a> 或 <a href="https://www.openstack.org/" target="_blank" rel="noopener">OpenStack</a> 这些虚拟化平台，是可以将 K8s 集群部署与 IaaS 资源创建这两步统一起来的，这样就可以避免手动创建和配置虚拟机这些繁琐的步骤。</p><p>目前将 IaaS 资源创建与 K8s 集群部署结合起来也有比较成熟的方案，比如基于 <a href="https://github.com/kubernetes-sigs/cluster-api" target="_blank" rel="noopener">cluster-api</a> 项目的 <a href="https://github.com/vmware-tanzu" target="_blank" rel="noopener">tanzu</a> 。本文就以 <a href="https://github.com/vmware-tanzu/community-edition" target="_blank" rel="noopener">VMware Tanzu 社区版</a> 为例在一台物理服务器上，从安装 ESXi OS 到部署完成 Tanzu Workload 集群，来体验一下这种部署方案的与众不同之处。</p><h2 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h2><ul><li>下载依赖文件</li><li>安装 govc 依赖</li><li>安装 ESXi OS</li><li>安装 vCenter</li><li>配置 vCenter</li><li>创建 bootstrap 虚拟机</li><li>初始化 bootstrap 节点</li><li>部署 Tanzu Manager 集群</li><li>部署 Tanzu Workload 集群</li></ul><h3 id="劝退三连-😂"><a href="#劝退三连-😂" class="headerlink" title="劝退三连 😂"></a>劝退三连 😂</h3><ul><li>需要有一个 <a href="https://customerconnect.vmware.com/login" target="_blank" rel="noopener">VMware 的账户</a> 用于下载一些 ISO 镜像和虚拟机模版;</li><li>需要有一台物理服务器，推荐最低配置 8C 32G，至少 256GB 存储；</li><li>需要一台 DHCP 服务器，由于默认是使用 DHCP 获取 IP 来分配给虚拟机的，因此 ESXi 所在的 VM Network  网络中必须有一台 DHCP 服务器用于给虚拟机分配 IP；</li></ul><h3 id="下载依赖文件"><a href="#下载依赖文件" class="headerlink" title="下载依赖文件"></a>下载依赖文件</h3><p>整个部署流程所需要的依文件赖如下，可以先将这些依赖下载到本地的机器上，方便后续使用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@devbox:/root/tanzu <span class="comment"># tree -sh</span></span><br><span class="line">.</span><br><span class="line">├── [  12M]  govc_Linux_x86_64.tar.gz</span><br><span class="line">├── [ 895M]  photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</span><br><span class="line">├── [ 225M]  photon-ova-4.0-c001795b80.ova</span><br><span class="line">├── [ 170M]  tce-linux-amd64-v0.9.1.tar.gz</span><br><span class="line">├── [ 9.0G]  VMware-VCSA-all-7.0.3-18778458.iso</span><br><span class="line">└── [ 390M]  VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso</span><br></pre></td></tr></table></figure><table><thead><tr><th>文件</th><th>用途</th><th>下载方式</th></tr></thead><tbody><tr><td><a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=ESXI70U2A&productId=974&rPId=46384" target="_blank" rel="noopener">VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso</a></td><td>安装 ESXi OS</td><td>VMware 需账户</td></tr><tr><td><a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=VC70U3C&productId=974&rPId=83853" target="_blank" rel="noopener">VMware-VCSA-all-7.0.3-19234570.iso</a></td><td>安装 vCenter</td><td>VMware 需账户</td></tr><tr><td><a href="https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova" target="_blank" rel="noopener">photon-ova-4.0-c001795b80.ova</a></td><td>bootstrap 节点</td><td>VMware</td></tr><tr><td><a href="https://customerconnect.vmware.com/downloads/get-download?downloadGroup=TCE-090" target="_blank" rel="noopener">photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</a></td><td>tanzu 集群节点</td><td>VMware 需账户</td></tr><tr><td><a href="https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz" target="_blank" rel="noopener">tce-linux-amd64-v0.9.1.tar.gz</a></td><td>tanzu 社区版</td><td>GitHub release</td></tr><tr><td><a href="https://github.com/vmware/govmomi/releases/download/v0.27.3/govc_Linux_x86_64.tar.gz" target="_blank" rel="noopener">govc_Linux_x86_64.tar.gz</a></td><td>安装/配置 vCenter</td><td>GitHub release</td></tr></tbody></table><p>注意 ESXi 和 vCenter 的版本最好是 7.0 及以上，我只在 ESXi 7.0.2 和 vCenter 7.0.3 上测试过，其他版本可能会有些差异；另外 ESXi 的版本不建议使用最新的 7.0.3，因为有比较严重的 bug，官方也建议用户生产环境不要使用该版本了 <a href="https://kb.vmware.com/s/article/86287" target="_blank" rel="noopener">vSphere 7.0 Update 3 Critical Known Issues - Workarounds &amp; Fix (86287)</a> 。</p><h3 id="安装-govc-及依赖"><a href="#安装-govc-及依赖" class="headerlink" title="安装 govc 及依赖"></a>安装 govc 及依赖</h3><p>在本地机器上安装好 govc 和 jq，这两个工具后面在配置 vCenter 的时候会用到。</p><ul><li>macOS</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install govc jq</span><br></pre></td></tr></table></figure><ul><li>Debian/Ubuntu</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tar -xf govc_Linux_x86_64.tar.gz -C /usr/<span class="built_in">local</span>/bin</span><br><span class="line">$ apt install jq -y</span><br></pre></td></tr></table></figure><ul><li>其他 Linux 可以在 govc 和 jq 的 GitHub 上下载对应的安装文件进行安装。</li></ul><h3 id="安装-ESXi-OS"><a href="#安装-ESXi-OS" class="headerlink" title="安装 ESXi OS"></a>安装 ESXi OS</h3><p>ESXi OS 的安装网上有很多教程，没有太多值得讲解的地方，因此就参照一下其他大佬写的博客或者官方的安装文档 <a href="https://docs.vmware.com/cn/VMware-vSphere/7.0/vsphere-esxi-701-installation-setup-guide.pdf" target="_blank" rel="noopener">VMware ESXi 安装和设置</a> 来就行；需要注意一点，ESXi OS 安装时 VMFSL 分区将会占用大量的存储空间，这将会使得 ESXi OS 安装所在的磁盘最终创建出来的 datastore 比预期小很多，而且这个 VMFSL 分区在安装好之后就很难再做调整了。因此如果磁盘存储空间比较紧张，在安装 ESXi OS 之前可以考虑下如何去掉这个分区；或者和我一样将 ESXI OS 安装在了一个 16G 的 USB Dom 盘上，不过生产环境不建议采用这种方案 😂（其实个人觉着安装在 U 盘上问题不大，ESXi OS 启动之后是加载到内存中运行的，不会对 U 盘有大量的读写操作，只不过在机房中 U 盘被人不小心拔走就凉了。</p><ul><li>设置 govc 环境变量</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ESXi 节点的 IP</span></span><br><span class="line"><span class="built_in">export</span> ESXI_IP=<span class="string">"192.168.18.47"</span></span><br><span class="line"><span class="comment"># ESXi 登录的用户名，初次安装后默认为 root</span></span><br><span class="line"><span class="built_in">export</span> GOVC_USERNAME=<span class="string">"root"</span></span><br><span class="line"><span class="comment"># 在 ESXi 安装时设置的 root 密码</span></span><br><span class="line"><span class="built_in">export</span> GOVC_PASSWORD=<span class="string">"admin@2022"</span></span><br><span class="line"><span class="comment"># 允许不安全的 SSL 连接</span></span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://<span class="variable">$&#123;ESXI_IP&#125;</span>"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=datastore1</span><br></pre></td></tr></table></figure><ul><li>测试 govc 是否能正常连接 ESXi 主机</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Name:              localhost.local</span><br><span class="line">  Path:            /ha-datacenter/host/localhost/localhost</span><br><span class="line">  Manufacturer:    Dell</span><br><span class="line">  Logical CPUs:    20 CPUs @ 2394MHz</span><br><span class="line">  Processor <span class="built_in">type</span>:  Intel(R) Xeon(R) Silver 4210R CPU @ 2.40GHz</span><br><span class="line">  CPU usage:       579 MHz (1.2%)</span><br><span class="line">  Memory:          261765MB</span><br><span class="line">  Memory usage:    16457 MB (6.3%)</span><br><span class="line">  Boot time:       2022-02-02 11:53:59.630124 +0000 UTC</span><br><span class="line">  State:           connected</span><br></pre></td></tr></table></figure><h3 id="安装-vCenter"><a href="#安装-vCenter" class="headerlink" title="安装 vCenter"></a>安装 vCenter</h3><p>按照 VMware 官方的 vCenter 安装文档 <a href="https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vcenter.install.doc/GUID-8DC3866D-5087-40A2-8067-1361A2AF95BD.html" target="_blank" rel="noopener">关于 vCenter Server 安装和设置</a> 来安装实在是过于繁琐，其实官方的 ISO 安装方式无非是运行一个 installer web 服务，然后在浏览器上配置好 vCenter 虚拟机的参数，再将填写的配置信息在部署 vcsa 虚拟机的时候注入到 ova 的配置参数中。</p><p>知道这个安装过程的原理之后我们也可以自己配置 vCenter 的参数信息，然后通过 govc 来部署 ova；这比使用 UI 的方式简单方便很多，最终只需要填写一个配置文件，一条命令就可以部署完成啦。</p><ul><li>首先是挂载 vCenter 的 ISO，找到 vcsa ova 文件，它是 vCenter 虚拟机的模版</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mount -o loop VMware-VCSA-all-7.0.3-18778458.iso /mnt</span><br><span class="line">$ ls /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova</span><br><span class="line">/mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova</span><br></pre></td></tr></table></figure><ul><li>根据自己的环境信息修改下面安装脚本中的相关配置：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">VCSA_OVA_FILE=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -o errexit</span><br><span class="line"><span class="built_in">set</span> -o nounset</span><br><span class="line"><span class="built_in">set</span> -o pipefail</span><br><span class="line"></span><br><span class="line"><span class="comment"># ESXi 的 IP 地址</span></span><br><span class="line"><span class="built_in">export</span> ESXI_IP=<span class="string">"192.168.18.47"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ESXi 的用户名</span></span><br><span class="line"><span class="built_in">export</span> GOVC_USERNAME=<span class="string">"root"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ESXI 的密码</span></span><br><span class="line"><span class="built_in">export</span> GOVC_PASSWORD=<span class="string">"admin@2020"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 vCenter 虚拟机使用的 datastore 名称</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=datastore1</span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://<span class="variable">$&#123;ESXI_IP&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter 的登录密码</span></span><br><span class="line">VM_PASSWORD=<span class="string">"admin@2020"</span></span><br><span class="line"><span class="comment"># vCenter 的 IP 地址</span></span><br><span class="line">VM_IP=192.168.20.92</span><br><span class="line"><span class="comment"># vCenter 虚拟机的名称</span></span><br><span class="line">VM_NAME=vCenter-Server-Appliance</span><br><span class="line"><span class="comment"># vCenter 虚拟机使用的网络</span></span><br><span class="line">VM_NETWORK=<span class="string">"VM Network"</span></span><br><span class="line"><span class="comment"># DNS 服务器</span></span><br><span class="line">VM_DNS=<span class="string">"223.6.6.6"</span></span><br><span class="line"><span class="comment"># NTP 服务器</span></span><br><span class="line">VM_NTP=<span class="string">"0.pool.ntp.org"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">deploy_vcsa_vm</span></span>()&#123;</span><br><span class="line">    config=$(govc host.info -k -json | jq -r <span class="string">'.HostSystems[].Config'</span>)</span><br><span class="line">    gateway=$(jq -r <span class="string">'.Network.IpRouteConfig.DefaultGateway'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$config</span>"</span>)</span><br><span class="line">    route=$(jq -r <span class="string">'.Network.RouteTableInfo.IpRoute[] | select(.DeviceName == "vmk0") | select(.Gateway == "0.0.0.0")'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$config</span>"</span>)</span><br><span class="line">    prefix=$(jq -r <span class="string">'.PrefixLength'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$route</span>"</span>)</span><br><span class="line">    opts=(</span><br><span class="line">        cis.vmdir.password=<span class="variable">$&#123;VM_PASSWORD&#125;</span></span><br><span class="line">        cis.appliance.root.passwd=<span class="variable">$&#123;VM_PASSWORD&#125;</span></span><br><span class="line">        cis.appliance.root.shell=/bin/bash</span><br><span class="line">        cis.deployment.node.type=embedded</span><br><span class="line">        cis.vmdir.domain-name=vsphere.local</span><br><span class="line">        cis.vmdir.site-name=VCSA</span><br><span class="line">        cis.appliance.net.addr.family=ipv4</span><br><span class="line">        cis.appliance.ssh.enabled=True</span><br><span class="line">        cis.ceip_enabled=False</span><br><span class="line">        cis.deployment.autoconfig=True</span><br><span class="line">        cis.appliance.net.addr=<span class="variable">$&#123;VM_IP&#125;</span></span><br><span class="line">        cis.appliance.net.prefix=<span class="variable">$&#123;prefix&#125;</span></span><br><span class="line">        cis.appliance.net.dns.servers=<span class="variable">$&#123;VM_DNS&#125;</span></span><br><span class="line">        cis.appliance.net.gateway=<span class="variable">$gateway</span></span><br><span class="line">        cis.appliance.ntp.servers=<span class="string">"<span class="variable">$&#123;VM_NTP&#125;</span>"</span></span><br><span class="line">        cis.appliance.net.mode=static</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    props=$(<span class="built_in">printf</span> -- <span class="string">"guestinfo.%s\n"</span> <span class="string">"<span class="variable">$&#123;opts[@]&#125;</span>"</span> | jq --slurp -R <span class="string">'split("\n") | map(select(. != "")) | map(split("=")) | map(&#123;"Key": .[0], "Value": .[1]&#125;)'</span>)</span><br><span class="line"></span><br><span class="line">    cat &lt;&lt;EOF | govc import.<span class="variable">$&#123;VCSA_OVA_FILE##*.&#125;</span> -options - <span class="string">"<span class="variable">$&#123;VCSA_OVA_FILE&#125;</span>"</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span>,</span><br><span class="line">    <span class="string">"Deployment"</span>: <span class="string">"tiny"</span>,</span><br><span class="line">    <span class="string">"DiskProvisioning"</span>: <span class="string">"thin"</span>,</span><br><span class="line">    <span class="string">"IPProtocol"</span>: <span class="string">"IPv4"</span>,</span><br><span class="line">    <span class="string">"Annotation"</span>: <span class="string">"VMware vCenter Server Appliance"</span>,</span><br><span class="line">    <span class="string">"PowerOn"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"WaitForIP"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"InjectOvfEnv"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"NetworkMapping"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"Network 1"</span>,</span><br><span class="line">        <span class="string">"Network"</span>: <span class="string">"<span class="variable">$&#123;VM_NETWORK&#125;</span>"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"PropertyMapping"</span>: <span class="variable">$&#123;props&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">deploy_vcsa_vm</span><br><span class="line">govc vm.change -vm <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span> -g vmwarePhoton64Guest</span><br><span class="line">govc vm.power -on <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span></span><br><span class="line">govc vm.ip -a <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span></span><br></pre></td></tr></table></figure><ul><li>通过脚本安装 vCenter，指定第一参数为 OVA 的绝对路径。运行完后将会自动将 ova 导入到 vCenter，并启动虚拟机；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行该脚本，第一个参数传入 vCenter ISO 中 vcsa ova 文件的绝对路径</span></span><br><span class="line">$ bash install-vcsa.sh /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova</span><br><span class="line"></span><br><span class="line">[03-02-22 18:40:19] Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk1.vmdk... OK</span><br><span class="line">[03-02-22 18:41:09] Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk... (29%, 52.5MiB/s)</span><br><span class="line">[03-02-22 18:43:08] Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk... OK</span><br><span class="line">[03-02-22 18:43:08] Injecting OVF environment...</span><br><span class="line">Powering on VirtualMachine:3... OK</span><br><span class="line">fe80::20c:29ff:fe03:2f80</span><br></pre></td></tr></table></figure><ul><li>设置 vCenter 登录的环境变量，我们使用 govc 来配置 vCenter，通过浏览器 Web UI 的方式配置起来效率有点低，不如 govc 命令一把梭方便 😂</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://192.168.20.92"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_USERNAME=<span class="string">"administrator@vsphere.local"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_PASSWORD=<span class="string">"admin@2022"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=datastore1</span><br></pre></td></tr></table></figure><ul><li>虚拟机启动后将自动进行 vCenter 的安装配置，等待一段时间 vCenter 安装好之后，使用 govc about 查看 vCenter 的信息，如果能正确或渠道说明 vCenter 就安装好了；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ govc about</span><br><span class="line">FullName:     VMware vCenter Server 7.0.3 build-18778458</span><br><span class="line">Name:         VMware vCenter Server</span><br><span class="line">Vendor:       VMware, Inc.</span><br><span class="line">Version:      7.0.3</span><br><span class="line">Build:        18778458</span><br><span class="line">OS <span class="built_in">type</span>:      linux-x64</span><br><span class="line">API <span class="built_in">type</span>:     VirtualCenter</span><br><span class="line">API version:  7.0.3.0</span><br><span class="line">Product ID:   vpx</span><br><span class="line">UUID:         0b49e119-e38f-4fbc-84a8-d7a0e548027d</span><br></pre></td></tr></table></figure><h3 id="配置-vCenter"><a href="#配置-vCenter" class="headerlink" title="配置 vCenter"></a>配置 vCenter</h3><p>这一步骤主要是配置 vCenter：创建 Datacenter、cluster、folder 等资源，并将 ESXi 主机添加到 cluster 中；</p><ul><li>配置 vCenter</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 Datacenter 数据中心</span></span><br><span class="line">$ govc datacenter.create SH-IDC</span><br><span class="line"><span class="comment"># 创建 Cluster 集群</span></span><br><span class="line">$ govc cluster.create -dc=SH-IDC Tanzu-Cluster</span><br><span class="line"><span class="comment"># 将 ESXi 主机添加到 Cluster 当中</span></span><br><span class="line">$ govc cluster.add -dc=SH-IDC -cluster=Tanzu-Cluster -hostname=192.168.18.47 --username=root -password=<span class="string">'admin@2020'</span> -noverify</span><br><span class="line"><span class="comment"># 创建 folder，用于将 Tanzu 的节点虚拟机存放到该文件夹下</span></span><br><span class="line">$ govc folder.create /SH-IDC/vm/Tanzu-node</span><br><span class="line"><span class="comment"># 导入 tanzu 汲取节点的虚拟机 ova 模版</span></span><br><span class="line">$ govc import.ova -dc=<span class="string">'SH-IDC'</span> -ds=<span class="string">'datastore1'</span> photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</span><br><span class="line"><span class="comment"># 将虚拟机转换为模版，后续 tanzu 集群将以该模版创建虚拟机</span></span><br><span class="line">$ govc vm.markastemplate photon-3-kube-v1.21.2</span><br></pre></td></tr></table></figure><h3 id="初始化-bootstrap-节点"><a href="#初始化-bootstrap-节点" class="headerlink" title="初始化 bootstrap 节点"></a>初始化 bootstrap 节点</h3><p>bootstrap 节点节点是用于运行 tanzu 部署工具的节点，官方是支持 Linux/macOS/Windows 三种操作系统的，但有一些比较严格的要求：</p><table><thead><tr><th>Arch: x86; ARM is currently unsupported</th></tr></thead><tbody><tr><td>RAM: 6 GB</td></tr><tr><td>CPU: 2</td></tr><tr><td><a href="https://docs.docker.com/engine/install/" target="_blank" rel="noopener">Docker</a> Add your non-root user account to the docker user group. Create the group if it does not already exist. This lets the Tanzu CLI access the Docker socket, which is owned by the root user. For more information, see steps 1 to 4 in the <a href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user" target="_blank" rel="noopener">Manage Docker as a non-root user</a> procedure in the Docker documentation.</td></tr><tr><td><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/" target="_blank" rel="noopener">Kubectl</a></td></tr><tr><td>Latest version of Chrome, Firefox, Safari, Internet Explorer, or Edge</td></tr><tr><td>System time is synchronized with a Network Time Protocol (NTP) server.</td></tr><tr><td>Ensure your bootstrap machine is using <a href="https://man7.org/linux/man-pages/man7/cgroups.7.html" target="_blank" rel="noopener">cgroup v1</a>. For more information, see <a href="https://tanzucommunityedition.io/docs/latest/support-matrix/#check-and-set-the-cgroup" target="_blank" rel="noopener">Check and set the cgroup</a>.</td></tr></tbody></table><p>在这里为了避免这些麻烦的配置，我就直接使用的 VMware 官方的 <a href="https://github.com/vmware/photon/wiki/Downloading-Photon-OS#photon-os-40-rev2-binaries" target="_blank" rel="noopener">Photon OS 4.0 Rev2</a> ，下载 OVA 格式的镜像直接导入到 ESXi 主机启动一台虚拟机即可，能节省不少麻烦的配置；还有一个好处就是在一台单独的虚拟机上运行 tanzu 部署工具不会污染本地的开发环境。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova</span><br><span class="line"><span class="comment"># 导入 OVA 虚拟机模版</span></span><br><span class="line">$ govc import.ova -ds=<span class="string">'datastore1'</span> -name bootstrap-node photon-ova-4.0-c001795b80.ova</span><br><span class="line"><span class="comment"># 修改一下虚拟机的配置，调整为 4C8G</span></span><br><span class="line">$ govc vm.change -c 4 -m 8192 -vm bootstrap-node</span><br><span class="line"><span class="comment"># 开启虚拟机</span></span><br><span class="line">$ govc vm.power -on bootstrap-node</span><br><span class="line"><span class="comment"># 查看虚拟机获取到的 IPv4 地址</span></span><br><span class="line">$ govc vm.ip -a -<span class="built_in">wait</span> 1m bootstrap-node</span><br><span class="line">$ ssh root@192.168.74.10</span><br><span class="line"><span class="comment"># 密码默认为 changeme，输入完密码之后提示在输入一遍 changeme，然后再修改新的密码</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># cat /etc/os-release</span></span><br><span class="line">NAME=<span class="string">"VMware Photon OS"</span></span><br><span class="line">VERSION=<span class="string">"4.0"</span></span><br><span class="line">ID=photon</span><br><span class="line">VERSION_ID=4.0</span><br><span class="line">PRETTY_NAME=<span class="string">"VMware Photon OS/Linux"</span></span><br><span class="line">ANSI_COLOR=<span class="string">"1;34"</span></span><br><span class="line">HOME_URL=<span class="string">"https://vmware.github.io/photon/"</span></span><br><span class="line">BUG_REPORT_URL=<span class="string">"https://github.com/vmware/photon/issues"</span></span><br></pre></td></tr></table></figure><ul><li>安装部署时需要的一些工具（切，Photon OS 里竟然连个 tar 命令都没有 😠</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># tdnf install sudo tar -y</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># curl -LO https://dl.k8s.io/release/v1.21.2/bin/linux/amd64/kubectl</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl</span></span><br></pre></td></tr></table></figure><ul><li>启动 docker，bootstrap 节点会以 kind 的方式运行一个 K8s 集群，需要用到 docker。虽然可以使用外部的 k8s 集群，但不是很推荐，因为 cluster-api 依赖 k8s 的版本，不能太高也不能太低；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># systemctl enable docker --now</span></span><br></pre></td></tr></table></figure><ul><li>从 <a href="https://github.com/vmware-tanzu/community-edition/releases/tag/v0.9.1" target="_blank" rel="noopener">vmware-tanzu/community-edition</a> 下载 tanzu 社区版的安装包，然后解压后安装；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># curl -LO  https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># tar -xf tce-linux-amd64-v0.9.1.tar.gz</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># cd tce-linux-amd64-v0.9.1/</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># bash install.sh</span></span><br></pre></td></tr></table></figure><p>然而不幸地翻车了， install.sh 脚本中禁止 root 用户运行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ ALLOW_INSTALL_AS_ROOT=</span><br><span class="line">+ [[ 0 -eq 0 ]]</span><br><span class="line">+ [[ <span class="string">''</span> != \t\r\u\e ]]</span><br><span class="line">+ <span class="built_in">echo</span> <span class="string">'Do not run this script as root'</span></span><br><span class="line">Do not run this script as root</span><br><span class="line">+ <span class="built_in">exit</span> 1</span><br></pre></td></tr></table></figure><p>我就偏偏要以 root 用户来运行怎么惹 😡</p><p><img src="https://p.k8s.li/2022-01-22-deploy-tanzu-k8s-cluster-01.jpg" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sed 去掉第一个 exit 1 就可以了</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># sed -i.bak "s/exit 1//" install.sh</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># bash install.sh</span></span><br></pre></td></tr></table></figure><p>安装好之后会输出 <code>Installation complete!</code>（讲真官方的 install.sh 脚本输出很不友好，污染我的 terminal</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+ tanzu init</span><br><span class="line">| initializing ✔  successfully initialized CLI</span><br><span class="line">++ tanzu plugin repo list</span><br><span class="line">++ grep tce</span><br><span class="line">+ TCE_REPO=</span><br><span class="line">+ [[ -z <span class="string">''</span> ]]</span><br><span class="line">+ tanzu plugin repo add --name tce --gcp-bucket-name tce-tanzu-cli-plugins --gcp-root-path artifacts</span><br><span class="line">++ tanzu plugin repo list</span><br><span class="line">++ grep core-admin</span><br><span class="line">+ TCE_REPO=</span><br><span class="line">+ [[ -z <span class="string">''</span> ]]</span><br><span class="line">+ tanzu plugin repo add --name core-admin --gcp-bucket-name tce-tanzu-cli-framework-admin --gcp-root-path artifacts-admin</span><br><span class="line">+ <span class="built_in">echo</span> <span class="string">'Installation complete!'</span></span><br><span class="line">Installation complete!</span><br></pre></td></tr></table></figure><h3 id="部署管理集群"><a href="#部署管理集群" class="headerlink" title="部署管理集群"></a>部署管理集群</h3><p>先是部署一个 tanzu 的管理集群，有两种方式，一种是通过 <a href="https://tanzucommunityedition.io/docs/latest/getting-started/" target="_blank" rel="noopener">官方文档</a> 提到的通过 Web UI 的方式。目前这个 UI 界面比较拉垮，它主要是用来让用户填写一些配置参数，然后调用后台的 tanzu 命令来部署集群。并把集群部署的日志和进度展示出来；部署完成之后，这个 UI 又不能管理这些集群，又不支持部署 workload 集群（</p><p>另一种就是通过 tanzu 命令指定配置文件来部署，这种方式不需要通过浏览器在 web 页面上傻乎乎地点来点去填一些参数，只需要提前填写好一个 yaml 格式的配置文件即可。下面我们就采用 tanzu 命令来部署集群，管理集群的配置文件模版如下：</p><ul><li>tanzu-mgt-cluster.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cluster Pod IP 的 CIDR</span></span><br><span class="line"><span class="attr">CLUSTER_CIDR:</span> <span class="number">100.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/11</span></span><br><span class="line"><span class="comment"># Service 的 CIDR</span></span><br><span class="line"><span class="attr">SERVICE_CIDR:</span> <span class="number">100.64</span><span class="number">.0</span><span class="number">.0</span><span class="string">/13</span></span><br><span class="line"><span class="comment"># 集群的名称</span></span><br><span class="line"><span class="attr">CLUSTER_NAME:</span> <span class="string">tanzu-control-plan</span></span><br><span class="line"><span class="comment"># 集群的类型</span></span><br><span class="line"><span class="attr">CLUSTER_PLAN:</span> <span class="string">dev</span></span><br><span class="line"><span class="comment"># 集群节点的 arch</span></span><br><span class="line"><span class="attr">OS_ARCH:</span> <span class="string">amd64</span></span><br><span class="line"><span class="comment"># 集群节点的 OS 名称</span></span><br><span class="line"><span class="attr">OS_NAME:</span> <span class="string">photon</span></span><br><span class="line"><span class="comment"># 集群节点 OS 版本</span></span><br><span class="line"><span class="attr">OS_VERSION:</span> <span class="string">"3"</span></span><br><span class="line"><span class="comment"># 基础设施资源的提供方</span></span><br><span class="line"><span class="attr">INFRASTRUCTURE_PROVIDER:</span> <span class="string">vsphere</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群的 VIP</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_ENDPOINT:</span> <span class="number">192.168</span><span class="number">.75</span><span class="number">.194</span></span><br><span class="line"><span class="comment"># control-plan 节点的磁盘大小</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># control-plan 节点的内存大小</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_MEM_MIB:</span> <span class="string">"8192"</span></span><br><span class="line"><span class="comment"># control-plan 节点的 CPU 核心数量</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_NUM_CPUS:</span> <span class="string">"4"</span></span><br><span class="line"><span class="comment"># work 节点的磁盘大小</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># work 节点的内存大小</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_MEM_MIB:</span> <span class="string">"4096"</span></span><br><span class="line"><span class="comment"># work 节点的 CPU 核心数量</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_NUM_CPUS:</span> <span class="string">"2"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter 的 Datacenter 路径</span></span><br><span class="line"><span class="attr">VSPHERE_DATACENTER:</span> <span class="string">/SH-IDC</span></span><br><span class="line"><span class="comment"># 虚拟机创建的 Datastore 路径</span></span><br><span class="line"><span class="attr">VSPHERE_DATASTORE:</span> <span class="string">/SH-IDC/datastore/datastore1</span></span><br><span class="line"><span class="comment"># 虚拟机创建的文件夹</span></span><br><span class="line"><span class="attr">VSPHERE_FOLDER:</span> <span class="string">/SH-IDC/vm/Tanzu-node</span></span><br><span class="line"><span class="comment"># 虚拟机使用的网络</span></span><br><span class="line"><span class="attr">VSPHERE_NETWORK:</span> <span class="string">/SH-IDC/network/VM</span> <span class="string">Network</span></span><br><span class="line"><span class="comment"># 虚拟机关联的资源池</span></span><br><span class="line"><span class="attr">VSPHERE_RESOURCE_POOL:</span> <span class="string">/SH-IDC/host/Tanzu-Cluster/Resources</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter 的 IP</span></span><br><span class="line"><span class="attr">VSPHERE_SERVER:</span> <span class="number">192.168</span><span class="number">.75</span><span class="number">.110</span></span><br><span class="line"><span class="comment"># vCenter 的用户名</span></span><br><span class="line"><span class="attr">VSPHERE_USERNAME:</span> <span class="string">administrator@vsphere.local</span></span><br><span class="line"><span class="comment"># vCenter 的密码，以 base64 编码</span></span><br><span class="line"><span class="attr">VSPHERE_PASSWORD:</span> <span class="string">&lt;encoded:base64password&gt;</span></span><br><span class="line"><span class="comment"># vCenter 的证书指纹，可以通过 govc about.cert -json | jq -r '.ThumbprintSHA1' 获取</span></span><br><span class="line"><span class="attr">VSPHERE_TLS_THUMBPRINT:</span> <span class="string">EB:F3:D8:7A:E8:3D:1A:59:B0:DE:73:96:DC:B9:5F:13:86:EF:B6:27</span></span><br><span class="line"><span class="comment"># 虚拟机注入的 ssh 公钥，需要用它来 ssh 登录集群节点</span></span><br><span class="line"><span class="attr">VSPHERE_SSH_AUTHORIZED_KEY:</span> <span class="string">ssh-rsa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一些默认参数</span></span><br><span class="line"><span class="attr">AVI_ENABLE:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">IDENTITY_MANAGEMENT_TYPE:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">ENABLE_AUDIT_LOGGING:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">ENABLE_CEIP_PARTICIPATION:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">TKG_HTTP_PROXY_ENABLED:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">DEPLOY_TKG_ON_VSPHERE7:</span> <span class="string">"true"</span></span><br></pre></td></tr></table></figure><ul><li>通过 tanzu CLI 部署管理集群</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tanzu management-cluster create --file tanzu-mgt-cluster.yaml -v6</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果没有配置 VSPHERE_TLS_THUMBPRINT 会有一个确认 vSphere thumbprint 的交互，输入 Y 就可以</span></span><br><span class="line">Validating the pre-requisites...</span><br><span class="line">Do you want to <span class="built_in">continue</span> with the vSphere thumbprint EB:F3:D8:7A:E8:3D:1A:59:B0:DE:73:96:DC:B9:5F:13:86:EF:B6:27 [y/N]: y</span><br></pre></td></tr></table></figure><h3 id="部署日志"><a href="#部署日志" class="headerlink" title="部署日志"></a>部署日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># tanzu management-cluster create --file tanzu-mgt-cluster.yaml -v 6</span></span><br><span class="line">compatibility file (/root/.config/tanzu/tkg/compatibility/tkg-compatibility.yaml) already exists, skipping download</span><br><span class="line">BOM files inside /root/.config/tanzu/tkg/bom already exists, skipping download</span><br><span class="line">CEIP Opt-in status: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Validating the pre-requisites...</span><br><span class="line"></span><br><span class="line">vSphere 7.0 Environment Detected.</span><br><span class="line"></span><br><span class="line">You have connected to a vSphere 7.0 environment <span class="built_in">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includes</span><br><span class="line">an integrated Tanzu Kubernetes Grid Service <span class="built_in">which</span> turns a vSphere cluster into a platform <span class="keyword">for</span> running Kubernetes workloads <span class="keyword">in</span> dedicated</span><br><span class="line">resource pools. Configuring Tanzu Kubernetes Grid Service is <span class="keyword">done</span> through vSphere HTML5 client.</span><br><span class="line"></span><br><span class="line">Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="keyword">in</span> vSphere 7.0 environments. Alternatively you may</span><br><span class="line">deploy a non-integrated Tanzu Kubernetes Grid instance on vSphere 7.0.</span><br><span class="line">Deploying TKG management cluster on vSphere 7.0 ...</span><br><span class="line">Identity Provider not configured. Some authentication features won<span class="string">'t work.</span></span><br><span class="line"><span class="string">Checking if VSPHERE_CONTROL_PLANE_ENDPOINT 192.168.20.94 is already in use</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Setting up management cluster...</span></span><br><span class="line"><span class="string">Validating configuration...</span></span><br><span class="line"><span class="string">Using infrastructure provider vsphere:v0.7.10</span></span><br><span class="line"><span class="string">Generating cluster configuration...</span></span><br><span class="line"><span class="string">Setting up bootstrapper...</span></span><br><span class="line"><span class="string">Fetching configuration for kind node image...</span></span><br><span class="line"><span class="string">kindConfig:</span></span><br><span class="line"><span class="string"> &amp;&#123;&#123;Cluster kind.x-k8s.io/v1alpha4&#125;  [&#123;  map[] [&#123;/var/run/docker.sock /var/run/docker.sock false false &#125;] [] [] []&#125;] &#123; 0  100.96.0.0/11 100.64.0.0/13 false &#125; map[] map[] [apiVersion: kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="string">kind: ClusterConfiguration</span></span><br><span class="line"><span class="string">imageRepository: projects.registry.vmware.com/tkg</span></span><br><span class="line"><span class="string">etcd:</span></span><br><span class="line"><span class="string">  local:</span></span><br><span class="line"><span class="string">    imageRepository: projects.registry.vmware.com/tkg</span></span><br><span class="line"><span class="string">    imageTag: v3.4.13_vmware.15</span></span><br><span class="line"><span class="string">dns:</span></span><br><span class="line"><span class="string">  type: CoreDNS</span></span><br><span class="line"><span class="string">  imageRepository: projects.registry.vmware.com/tkg</span></span><br><span class="line"><span class="string">  imageTag: v1.8.0_vmware.5] [] [] []&#125;</span></span><br><span class="line"><span class="string">Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span></span><br><span class="line"><span class="string">Creating cluster "tkg-kind-c7vj6kds0a6sf43e6210" ...</span></span><br><span class="line"><span class="string">Ensuring node image (projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1) ...</span></span><br><span class="line"><span class="string">Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 ...</span></span><br><span class="line"><span class="string">Preparing nodes ...</span></span><br><span class="line"><span class="string">Writing configuration ...</span></span><br><span class="line"><span class="string">Starting control-plane ...</span></span><br><span class="line"><span class="string">Installing CNI ...</span></span><br><span class="line"><span class="string">Installing StorageClass ...</span></span><br><span class="line"><span class="string">Waiting 2m0s for control-plane = Ready ...</span></span><br><span class="line"><span class="string">Ready after 19s</span></span><br><span class="line"><span class="string">Bootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOL</span></span><br><span class="line"><span class="string">Installing providers on bootstrapper...</span></span><br><span class="line"><span class="string">Fetching providers</span></span><br><span class="line"><span class="string">Installing cert-manager Version="v1.1.0"</span></span><br><span class="line"><span class="string">Waiting for cert-manager to be available...</span></span><br><span class="line"><span class="string">Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"</span></span><br><span class="line"><span class="string">Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"</span></span><br><span class="line"><span class="string">Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"</span></span><br><span class="line"><span class="string">Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"</span></span><br><span class="line"><span class="string">installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"</span></span><br><span class="line"><span class="string">Waiting for provider infrastructure-vsphere</span></span><br><span class="line"><span class="string">Waiting for provider control-plane-kubeadm</span></span><br><span class="line"><span class="string">Waiting for provider cluster-api</span></span><br><span class="line"><span class="string">Waiting for provider bootstrap-kubeadm</span></span><br><span class="line"><span class="string">Waiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and running</span></span><br><span class="line"><span class="string">pods are not yet running for deployment '</span>capi-kubeadm-control-plane-controller-manager<span class="string">' in namespace '</span>capi-kubeadm-control-plane-system<span class="string">', retrying</span></span><br><span class="line"><span class="string">Passed waiting on provider bootstrap-kubeadm after 25.205820854s</span></span><br><span class="line"><span class="string">pods are not yet running for deployment '</span>capi-controller-manager<span class="string">' in namespace '</span>capi-webhook-system<span class="string">', retrying</span></span><br><span class="line"><span class="string">Passed waiting on provider infrastructure-vsphere after 30.185406332s</span></span><br><span class="line"><span class="string">Passed waiting on provider cluster-api after 30.213216243s</span></span><br><span class="line"><span class="string">Success waiting on all providers.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Start creating management cluster...</span></span><br><span class="line"><span class="string">patch cluster object with operation status:</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">"metadata": &#123;</span></span><br><span class="line"><span class="string">"annotations": &#123;</span></span><br><span class="line"><span class="string">"TKGOperationInfo" : "&#123;\"Operation\":\"Create\",\"OperationStartTimestamp\":\"2022-02-06 02:35:34.30219421 +0000 UTC\",\"OperationTimeout\":1800&#125;",</span></span><br><span class="line"><span class="string">"TKGOperationLastObservedTimestamp" : "2022-02-06 02:35:34.30219421 +0000 UTC"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">cluster control plane is still being initialized, retrying</span></span><br><span class="line"><span class="string">Getting secret for cluster</span></span><br><span class="line"><span class="string">Waiting for resource tanzu-control-plan-kubeconfig of type *v1.Secret to be up and running</span></span><br><span class="line"><span class="string">Saving management cluster kubeconfig into /root/.kube/config</span></span><br><span class="line"><span class="string">Installing providers on management cluster...</span></span><br><span class="line"><span class="string">Fetching providers</span></span><br><span class="line"><span class="string">Installing cert-manager Version="v1.1.0"</span></span><br><span class="line"><span class="string">Waiting for cert-manager to be available...</span></span><br><span class="line"><span class="string">Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"</span></span><br><span class="line"><span class="string">Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"</span></span><br><span class="line"><span class="string">Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"</span></span><br><span class="line"><span class="string">Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"</span></span><br><span class="line"><span class="string">installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"</span></span><br><span class="line"><span class="string">Waiting for provider control-plane-kubeadm</span></span><br><span class="line"><span class="string">Waiting for provider bootstrap-kubeadm</span></span><br><span class="line"><span class="string">Waiting for provider infrastructure-vsphere</span></span><br><span class="line"><span class="string">Waiting for provider cluster-api</span></span><br><span class="line"><span class="string">Waiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and running</span></span><br><span class="line"><span class="string">Passed waiting on provider control-plane-kubeadm after 10.046865402s</span></span><br><span class="line"><span class="string">Waiting for resource antrea-controller of type *v1.Deployment to be up and running</span></span><br><span class="line"><span class="string">Moving all Cluster API objects from bootstrap cluster to management cluster...</span></span><br><span class="line"><span class="string">Performing move...</span></span><br><span class="line"><span class="string">Discovering Cluster API objects</span></span><br><span class="line"><span class="string">Moving Cluster API objects Clusters=1</span></span><br><span class="line"><span class="string">Creating objects in the target cluster</span></span><br><span class="line"><span class="string">Deleting objects from the source cluster</span></span><br><span class="line"><span class="string">Waiting for additional components to be up and running...</span></span><br><span class="line"><span class="string">Waiting for packages to be up and running...</span></span><br><span class="line"><span class="string">Waiting for package: antrea</span></span><br><span class="line"><span class="string">Waiting for package: metrics-server</span></span><br><span class="line"><span class="string">Waiting for package: tanzu-addons-manager</span></span><br><span class="line"><span class="string">Waiting for package: vsphere-cpi</span></span><br><span class="line"><span class="string">Waiting for package: vsphere-csi</span></span><br><span class="line"><span class="string">Waiting for resource antrea of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource vsphere-cpi of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource vsphere-csi of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource metrics-server of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource tanzu-addons-manager of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Successfully reconciled package: antrea</span></span><br><span class="line"><span class="string">Successfully reconciled package: vsphere-csi</span></span><br><span class="line"><span class="string">Successfully reconciled package: metrics-server</span></span><br><span class="line"><span class="string">Context set for management cluster tanzu-control-plan as '</span>tanzu-control-plan-admin@tanzu-control-plan<span class="string">'.</span></span><br><span class="line"><span class="string">Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Management cluster created!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can now create your first workload cluster by running the following:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  tanzu cluster create [name] -f [file]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Some addons might be getting installed! Check their status by running the following:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  kubectl get apps -A</span></span><br></pre></td></tr></table></figure><ul><li>部署完成之后，将管理集群的 kubeconfig 文件复制到 kubectl 默认的目录下</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># cp $&#123;HOME&#125;/.kube-tkg/config $&#123;HOME&#125;/.kube/config</span></span><br></pre></td></tr></table></figure><ul><li>查看集群状态信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 管理集群的 cluster 资源信息，管理集群的 CR 默认保存在了 tkg-system namespace 下</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get cluster -A</span></span><br><span class="line">NAMESPACE    NAME                 PHASE</span><br><span class="line">tkg-system   tanzu-control-plan   Provisioned</span><br><span class="line"><span class="comment"># 管理集群的 machine 资源信息</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine -A</span></span><br><span class="line">NAMESPACE    NAME                                       PROVIDERID                                       PHASE         VERSION</span><br><span class="line">tkg-system   tanzu-control-plan-control-plane-gs4bl     vsphere://4239c450-f621-d78e-3c44-4ac8890c0cd3   Running       v1.21.2+vmware.1</span><br><span class="line">tkg-system   tanzu-control-plan-md-0-7cdc97c7c6-kxcnx   vsphere://4239d776-c04c-aacc-db12-3380542a6d03   Provisioned   v1.21.2+vmware.1</span><br><span class="line"><span class="comment"># 运行的组件状态</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE                           NAME                                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">capi-kubeadm-bootstrap-system       capi-kubeadm-bootstrap-controller-manager-6494884869-wlzhx       2/2     Running   0          8m37s</span><br><span class="line">capi-kubeadm-control-plane-system   capi-kubeadm-control-plane-controller-manager-857d687b9d-tpznv   2/2     Running   0          8m35s</span><br><span class="line">capi-system                         capi-controller-manager-778bd4dfb9-tkvwg                         2/2     Running   0          8m41s</span><br><span class="line">capi-webhook-system                 capi-controller-manager-9995bdc94-svjm2                          2/2     Running   0          8m41s</span><br><span class="line">capi-webhook-system                 capi-kubeadm-bootstrap-controller-manager-68845b65f8-sllgv       2/2     Running   0          8m38s</span><br><span class="line">capi-webhook-system                 capi-kubeadm-control-plane-controller-manager-9847c6747-vvz6g    2/2     Running   0          8m35s</span><br><span class="line">capi-webhook-system                 capv-controller-manager-55bf67fbd5-4t46v                         2/2     Running   0          8m31s</span><br><span class="line">capv-system                         capv-controller-manager-587fbf697f-bbzs9                         2/2     Running   0          8m31s</span><br><span class="line">cert-manager                        cert-manager-77f6fb8fd5-8tq6n                                    1/1     Running   0          11m</span><br><span class="line">cert-manager                        cert-manager-cainjector-6bd4cff7bb-6vlzx                         1/1     Running   0          11m</span><br><span class="line">cert-manager                        cert-manager-webhook-fbfcb9d6c-qpkbc                             1/1     Running   0          11m</span><br><span class="line">kube-system                         antrea-agent-5m9d4                                               2/2     Running   0          6m</span><br><span class="line">kube-system                         antrea-agent-8mpr7                                               2/2     Running   0          5m40s</span><br><span class="line">kube-system                         antrea-controller-5bbcb98667-hklss                               1/1     Running   0          5m50s</span><br><span class="line">kube-system                         coredns-8dcb5c56b-ckvb7                                          1/1     Running   0          12m</span><br><span class="line">kube-system                         coredns-8dcb5c56b-d98hf                                          1/1     Running   0          12m</span><br><span class="line">kube-system                         etcd-tanzu-control-plan-control-plane-gs4bl                      1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-apiserver-tanzu-control-plan-control-plane-gs4bl            1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-controller-manager-tanzu-control-plan-control-plane-gs4bl   1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-proxy-d4wq4                                                 1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-proxy-nhkgg                                                 1/1     Running   0          11m</span><br><span class="line">kube-system                         kube-scheduler-tanzu-control-plan-control-plane-gs4bl            1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-vip-tanzu-control-plan-control-plane-gs4bl                  1/1     Running   0          12m</span><br><span class="line">kube-system                         metrics-server-59fcb9fcf-xjznj                                   1/1     Running   0          6m29s</span><br><span class="line">kube-system                         vsphere-cloud-controller-manager-kzffm                           1/1     Running   0          5m50s</span><br><span class="line">kube-system                         vsphere-csi-controller-74675c9488-q9h5c                          6/6     Running   0          6m31s</span><br><span class="line">kube-system                         vsphere-csi-node-dmvvr                                           3/3     Running   0          6m31s</span><br><span class="line">kube-system                         vsphere-csi-node-k6x98                                           3/3     Running   0          6m31s</span><br><span class="line">tkg-system                          kapp-controller-6499b8866-xnql7                                  1/1     Running   0          10m</span><br><span class="line">tkg-system                          tanzu-addons-controller-manager-657c587556-rpbjm                 1/1     Running   0          7m58s</span><br><span class="line">tkg-system                          tanzu-capabilities-controller-manager-6ff97656b8-cq7m7           1/1     Running   0          11m</span><br><span class="line">tkr-system                          tkr-controller-manager-6bc455b5d4-wm98s                          1/1     Running   0          10m</span><br></pre></td></tr></table></figure><h3 id="部署流程-1"><a href="#部署流程-1" class="headerlink" title="部署流程"></a>部署流程</h3><p>结合 <a href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go" target="_blank" rel="noopener">tanzu 的源码</a> 和部署输出的日志我们大体可以得知，tanzu 管理集群部署大致分为如下几步：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// management cluster init step constants</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">StepConfigPrerequisite                 = <span class="string">"Configure prerequisite"</span></span><br><span class="line">StepValidateConfiguration              = <span class="string">"Validate configuration"</span></span><br><span class="line">StepGenerateClusterConfiguration       = <span class="string">"Generate cluster configuration"</span></span><br><span class="line">StepSetupBootstrapCluster              = <span class="string">"Setup bootstrap cluster"</span></span><br><span class="line">StepInstallProvidersOnBootstrapCluster = <span class="string">"Install providers on bootstrap cluster"</span></span><br><span class="line">StepCreateManagementCluster            = <span class="string">"Create management cluster"</span></span><br><span class="line">StepInstallProvidersOnRegionalCluster  = <span class="string">"Install providers on management cluster"</span></span><br><span class="line">StepMoveClusterAPIObjects              = <span class="string">"Move cluster-api objects from bootstrap cluster to management cluster"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// InitRegionSteps management cluster init step sequence</span></span><br><span class="line"><span class="keyword">var</span> InitRegionSteps = []<span class="keyword">string</span>&#123;</span><br><span class="line">StepConfigPrerequisite,</span><br><span class="line">StepValidateConfiguration,</span><br><span class="line">StepGenerateClusterConfiguration,</span><br><span class="line">StepSetupBootstrapCluster,</span><br><span class="line">StepInstallProvidersOnBootstrapCluster,</span><br><span class="line">StepCreateManagementCluster,</span><br><span class="line">StepInstallProvidersOnRegionalCluster,</span><br><span class="line">StepMoveClusterAPIObjects,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ConfigPrerequisite 准备阶段，会下载 <code>tkg-compatibility</code> 和 <code>tkg-bom</code> 镜像，用于检查环境的兼容性；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Downloading TKG compatibility file from <span class="string">'projects.registry.vmware.com/tkg/framework-zshippable/tkg-compatibility'</span></span><br><span class="line">Downloading the TKG Bill of Materials (BOM) file from <span class="string">'projects.registry.vmware.com/tkg/tkg-bom:v1.4.0'</span></span><br><span class="line">Downloading the TKr Bill of Materials (BOM) file from <span class="string">'projects.registry.vmware.com/tkg/tkr-bom:v1.21.2_vmware.1-tkg.1'</span></span><br><span class="line">ERROR 2022/02/06 02:24:46 svType != tvType; key=release, st=map[string]interface &#123;&#125;, tt=&lt;nil&gt;, sv=map[version:], tv=&lt;nil&gt;</span><br><span class="line">CEIP Opt-in status: <span class="literal">false</span></span><br></pre></td></tr></table></figure><ul><li>ValidateConfiguration 配置文件校验，根据填写的参数校验配置是否正确，以及检查 vCenter 当中有无匹配的虚拟机模版；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Validating the pre-requisites...</span><br><span class="line"></span><br><span class="line">vSphere 7.0 Environment Detected.</span><br><span class="line"></span><br><span class="line">You have connected to a vSphere 7.0 environment <span class="built_in">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includes</span><br><span class="line">an integrated Tanzu Kubernetes Grid Service <span class="built_in">which</span> turns a vSphere cluster into a platform <span class="keyword">for</span> running Kubernetes workloads <span class="keyword">in</span> dedicated</span><br><span class="line">resource pools. Configuring Tanzu Kubernetes Grid Service is <span class="keyword">done</span> through vSphere HTML5 client.</span><br><span class="line"></span><br><span class="line">Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="keyword">in</span> vSphere 7.0 environments. Alternatively you may</span><br><span class="line">deploy a non-integrated Tanzu Kubernetes Grid instance on vSphere 7.0.</span><br><span class="line">Deploying TKG management cluster on vSphere 7.0 ...</span><br><span class="line">Identity Provider not configured. Some authentication features won<span class="string">'t work.</span></span><br><span class="line"><span class="string">Checking if VSPHERE_CONTROL_PLANE_ENDPOINT 192.168.20.94 is already in use</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Setting up management cluster...</span></span><br><span class="line"><span class="string">Validating configuration...</span></span><br><span class="line"><span class="string">Using infrastructure provider vsphere:v0.7.10</span></span><br></pre></td></tr></table></figure><ul><li>GenerateClusterConfiguration 生成集群配置文件信息；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Generating cluster configuration...</span><br></pre></td></tr></table></figure><ul><li>SetupBootstrapCluster 设置 bootstrap 集群，目前默认为 kind。会运行一个 docker 容器，里面套娃运行着一个 k8s 集群；这个 bootstrap k8s 集群只是临时运行 cluster-api 来部署管理集群用的，部署完成之后 bootstrap 集群也就没用了，会自动删掉；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Setting up bootstrapper...</span><br><span class="line">Fetching configuration <span class="keyword">for</span> kind node image...</span><br><span class="line">kindConfig:</span><br><span class="line"> &amp;&#123;&#123;Cluster kind.x-k8s.io/v1alpha4&#125;  [&#123;  map[] [&#123;/var/run/docker.sock /var/run/docker.sock <span class="literal">false</span> <span class="literal">false</span> &#125;] [] [] []&#125;] &#123; 0  100.96.0.0/11 100.64.0.0/13 <span class="literal">false</span> &#125; map[] map[] [apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">imageRepository: projects.registry.vmware.com/tkg</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    imageRepository: projects.registry.vmware.com/tkg</span><br><span class="line">    imageTag: v3.4.13_vmware.15</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">  imageRepository: projects.registry.vmware.com/tkg</span><br><span class="line">  imageTag: v1.8.0_vmware.5] [] [] []&#125;</span><br><span class="line">Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span><br><span class="line">Creating cluster <span class="string">"tkg-kind-c7vj6kds0a6sf43e6210"</span> ...</span><br><span class="line">Ensuring node image (projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1) ...</span><br><span class="line">Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 ...</span><br><span class="line">Preparing nodes ...</span><br><span class="line">Writing configuration ...</span><br><span class="line">Starting control-plane ...</span><br><span class="line">Installing CNI ...</span><br><span class="line">Installing StorageClass ...</span><br><span class="line">Waiting 2m0s <span class="keyword">for</span> control-plane = Ready ...</span><br><span class="line">Ready after 19s</span><br><span class="line">Bootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOL</span><br></pre></td></tr></table></figure><ul><li>InstallProvidersOnBootstrapCluster 在 bootstrap 集群上安装 cluste-api 相关组件；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Installing providers on bootstrapper...</span><br><span class="line">Fetching providers</span><br><span class="line"><span class="comment"># 安装 cert-manager 主要是为了生成 k8s 集群部署所依赖的那一堆证书</span></span><br><span class="line">Installing cert-manager Version=<span class="string">"v1.1.0"</span></span><br><span class="line">Waiting <span class="keyword">for</span> cert-manager to be available...</span><br><span class="line">Installing Provider=<span class="string">"cluster-api"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-system"</span></span><br><span class="line">Installing Provider=<span class="string">"bootstrap-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-bootstrap-system"</span></span><br><span class="line">Installing Provider=<span class="string">"control-plane-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-control-plane-system"</span></span><br><span class="line">Installing Provider=<span class="string">"infrastructure-vsphere"</span> Version=<span class="string">"v0.7.10"</span> TargetNamespace=<span class="string">"capv-system"</span></span><br><span class="line">installed  Component==<span class="string">"cluster-api"</span>  Type==<span class="string">"CoreProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"BootstrapProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"ControlPlaneProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"vsphere"</span>  Type==<span class="string">"InfrastructureProvider"</span>  Version==<span class="string">"v0.7.10"</span></span><br><span class="line">Waiting <span class="keyword">for</span> provider infrastructure-vsphere</span><br><span class="line">Waiting <span class="keyword">for</span> provider control-plane-kubeadm</span><br><span class="line">Waiting <span class="keyword">for</span> provider cluster-api</span><br><span class="line">Waiting <span class="keyword">for</span> provider bootstrap-kubeadm</span><br><span class="line">Passed waiting on provider infrastructure-vsphere after 30.185406332s</span><br><span class="line">Passed waiting on provider cluster-api after 30.213216243s</span><br><span class="line">Success waiting on all providers.</span><br></pre></td></tr></table></figure><ul><li>CreateManagementCluster 创建管理集群，这一步主要是创建虚拟机、初始化节点、运行 kubeadm 部署 k8s 集群；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Start creating management cluster...</span><br><span class="line">patch cluster object with operation status:</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"metadata"</span>: &#123;</span><br><span class="line"><span class="string">"annotations"</span>: &#123;</span><br><span class="line"><span class="string">"TKGOperationInfo"</span> : <span class="string">"&#123;\"Operation\":\"Create\",\"OperationStartTimestamp\":\"2022-02-06 02:35:34.30219421 +0000 UTC\",\"OperationTimeout\":1800&#125;"</span>,</span><br><span class="line"><span class="string">"TKGOperationLastObservedTimestamp"</span> : <span class="string">"2022-02-06 02:35:34.30219421 +0000 UTC"</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">cluster control plane is still being initialized, retrying</span><br><span class="line">Getting secret <span class="keyword">for</span> cluster</span><br><span class="line">Waiting <span class="keyword">for</span> resource tanzu-control-plan-kubeconfig of <span class="built_in">type</span> *v1.Secret to be up and running</span><br><span class="line">Saving management cluster kubeconfig into /root/.kube/config</span><br></pre></td></tr></table></figure><ul><li>InstallProvidersOnRegionalCluster 在管理集群上安装 cluster-api 相关组件；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Installing providers on management cluster...</span><br><span class="line">Fetching providers</span><br><span class="line">Installing cert-manager Version=<span class="string">"v1.1.0"</span></span><br><span class="line">Waiting <span class="keyword">for</span> cert-manager to be available...</span><br><span class="line">Installing Provider=<span class="string">"cluster-api"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-system"</span></span><br><span class="line">Installing Provider=<span class="string">"bootstrap-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-bootstrap-system"</span></span><br><span class="line">Installing Provider=<span class="string">"control-plane-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-control-plane-system"</span></span><br><span class="line">Installing Provider=<span class="string">"infrastructure-vsphere"</span> Version=<span class="string">"v0.7.10"</span> TargetNamespace=<span class="string">"capv-system"</span></span><br><span class="line">installed  Component==<span class="string">"cluster-api"</span>  Type==<span class="string">"CoreProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"BootstrapProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"ControlPlaneProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"vsphere"</span>  Type==<span class="string">"InfrastructureProvider"</span>  Version==<span class="string">"v0.7.10"</span></span><br><span class="line">Waiting <span class="keyword">for</span> provider control-plane-kubeadm</span><br><span class="line">Waiting <span class="keyword">for</span> provider bootstrap-kubeadm</span><br><span class="line">Waiting <span class="keyword">for</span> provider infrastructure-vsphere</span><br><span class="line">Waiting <span class="keyword">for</span> provider cluster-api</span><br><span class="line">Waiting <span class="keyword">for</span> resource capv-controller-manager of <span class="built_in">type</span> *v1.Deployment to be up and running</span><br><span class="line">Passed waiting on provider infrastructure-vsphere after 20.091935635s</span><br><span class="line">Passed waiting on provider cluster-api after 20.109419304s</span><br><span class="line">Success waiting on all providers.</span><br><span class="line">Waiting <span class="keyword">for</span> the management cluster to get ready <span class="keyword">for</span> move...</span><br><span class="line">Waiting <span class="keyword">for</span> resource tanzu-control-plan of <span class="built_in">type</span> *v1alpha3.Cluster to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> resources <span class="built_in">type</span> *v1alpha3.MachineDeploymentList to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> resources <span class="built_in">type</span> *v1alpha3.MachineList to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> addons installation...</span><br><span class="line">Waiting <span class="keyword">for</span> resources <span class="built_in">type</span> *v1alpha3.ClusterResourceSetList to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> resource antrea-controller of <span class="built_in">type</span> *v1.Deployment to be up and running</span><br></pre></td></tr></table></figure><ul><li>MoveClusterAPIObjects 将 bootstrap 集群上 cluster-api 相关的资源转移到管理集群上。这一步的目的是为了达到 self-hosted 自托管的功能：即管理集群自身的扩缩容也是通过 cluster-api 来完成，这样就不用再依赖先前的那个 bootstrap 集群了；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Moving all Cluster API objects from bootstrap cluster to management cluster...</span><br><span class="line">Performing move...</span><br><span class="line">Discovering Cluster API objects</span><br><span class="line">Moving Cluster API objects Clusters=1</span><br><span class="line">Creating objects <span class="keyword">in</span> the target cluster</span><br><span class="line">Deleting objects from the <span class="built_in">source</span> cluster</span><br><span class="line">Context <span class="built_in">set</span> <span class="keyword">for</span> management cluster tanzu-control-plan as <span class="string">'tanzu-control-plan-admin@tanzu-control-plan'</span>.</span><br><span class="line">Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span><br><span class="line"></span><br><span class="line">Management cluster created!</span><br><span class="line"></span><br><span class="line">You can now create your first workload cluster by running the following:</span><br><span class="line"></span><br><span class="line">  tanzu cluster create [name] -f [file]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Some addons might be getting installed! Check their status by running the following:</span><br><span class="line"></span><br><span class="line">  kubectl get apps -A</span><br></pre></td></tr></table></figure><p>部署完成后会删除 bootstrap 集群，因为 bootstrap 集群中的资源已经转移到了管理集群中，它继续存在的意义不大。</p><h2 id="部署-workload-集群"><a href="#部署-workload-集群" class="headerlink" title="部署 workload 集群"></a>部署 workload 集群</h2><p>上面我们只是部署好了一个 tanzu 管理集群，我们真正的工作负载并不适合运行在这个集群上，因此我们还需要再部署一个 workload 集群，类似于 k8s 集群中的 worker 节点。部署 workload 集群的时候不再依赖 bootstrap 集群，而是使用管理集群。</p><p>根据官方文档 <a href="https://tanzucommunityedition.io/docs/latest/vsphere-wl-template/" target="_blank" rel="noopener">vSphere Workload Cluster Template</a> 中给出的模版创建一个配置文件，然后再通过 tanzu 命令来部署即可。配置文件内容如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cluster Pod IP 的 CIDR</span></span><br><span class="line"><span class="attr">CLUSTER_CIDR:</span> <span class="number">100.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/11</span></span><br><span class="line"><span class="comment"># Service 的 CIDR</span></span><br><span class="line"><span class="attr">SERVICE_CIDR:</span> <span class="number">100.64</span><span class="number">.0</span><span class="number">.0</span><span class="string">/13</span></span><br><span class="line"><span class="comment"># 集群的名称</span></span><br><span class="line"><span class="attr">CLUSTER_NAME:</span> <span class="string">tanzu-workload-cluster</span></span><br><span class="line"><span class="comment"># 集群的类型</span></span><br><span class="line"><span class="attr">CLUSTER_PLAN:</span> <span class="string">dev</span></span><br><span class="line"><span class="comment"># 集群节点的 arch</span></span><br><span class="line"><span class="attr">OS_ARCH:</span> <span class="string">amd64</span></span><br><span class="line"><span class="comment"># 集群节点的 OS 名称</span></span><br><span class="line"><span class="attr">OS_NAME:</span> <span class="string">photon</span></span><br><span class="line"><span class="comment"># 集群节点 OS 版本</span></span><br><span class="line"><span class="attr">OS_VERSION:</span> <span class="string">"3"</span></span><br><span class="line"><span class="comment"># 基础设施资源的提供方</span></span><br><span class="line"><span class="attr">INFRASTRUCTURE_PROVIDER:</span> <span class="string">vsphere</span></span><br><span class="line"><span class="comment"># cluster, machine 等自定义资源创建的 namespace</span></span><br><span class="line"><span class="attr">NAMESPACE:</span> <span class="string">default</span></span><br><span class="line"><span class="comment"># CNI 选用类型，目前应该只支持 VMware 自家的 antrea</span></span><br><span class="line"><span class="attr">CNI:</span> <span class="string">antrea</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群的 VIP</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_ENDPOINT:</span> <span class="number">192.168</span><span class="number">.20</span><span class="number">.95</span></span><br><span class="line"><span class="comment"># control-plan 节点的磁盘大小</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># control-plan 节点的内存大小</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_MEM_MIB:</span> <span class="string">"8192"</span></span><br><span class="line"><span class="comment"># control-plan 节点的 CPU 核心数量</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_NUM_CPUS:</span> <span class="string">"4"</span></span><br><span class="line"><span class="comment"># work 节点的磁盘大小</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># work 节点的内存大小</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_MEM_MIB:</span> <span class="string">"4096"</span></span><br><span class="line"><span class="comment"># work 节点的 CPU 核心数量</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_NUM_CPUS:</span> <span class="string">"2"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter 的 Datacenter 路径</span></span><br><span class="line"><span class="attr">VSPHERE_DATACENTER:</span> <span class="string">/SH-IDC</span></span><br><span class="line"><span class="comment"># 虚拟机创建的 Datastore 路径</span></span><br><span class="line"><span class="attr">VSPHERE_DATASTORE:</span> <span class="string">/SH-IDC/datastore/datastore1</span></span><br><span class="line"><span class="comment"># 虚拟机创建的文件夹</span></span><br><span class="line"><span class="attr">VSPHERE_FOLDER:</span> <span class="string">/SH-IDC/vm/Tanzu-node</span></span><br><span class="line"><span class="comment"># 虚拟机使用的网络</span></span><br><span class="line"><span class="attr">VSPHERE_NETWORK:</span> <span class="string">/SH-IDC/network/VM</span> <span class="string">Network</span></span><br><span class="line"><span class="comment"># 虚拟机关联的资源池</span></span><br><span class="line"><span class="attr">VSPHERE_RESOURCE_POOL:</span> <span class="string">/SH-IDC/host/Tanzu-Cluster/Resources</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter 的 IP</span></span><br><span class="line"><span class="attr">VSPHERE_SERVER:</span> <span class="number">192.168</span><span class="number">.20</span><span class="number">.92</span></span><br><span class="line"><span class="comment"># vCenter 的用户名</span></span><br><span class="line"><span class="attr">VSPHERE_USERNAME:</span> <span class="string">administrator@vsphere.local</span></span><br><span class="line"><span class="comment"># vCenter 的密码，以 base64 编码</span></span><br><span class="line"><span class="attr">VSPHERE_PASSWORD:</span> <span class="string">&lt;encoded:YWRtaW5AMjAyMA==&gt;</span></span><br><span class="line"><span class="comment"># vCenter 的证书指纹，可以通过 govc about.cert -json | jq -r '.ThumbprintSHA1' 获取</span></span><br><span class="line"><span class="attr">VSPHERE_TLS_THUMBPRINT:</span> <span class="string">CB:23:48:E8:93:34:AD:27:D8:FD:88:1C:D7:08:4B:47:9B:12:F4:E0</span></span><br><span class="line"><span class="comment"># 虚拟机注入的 ssh 公钥，需要用它来 ssh 登录集群节点</span></span><br><span class="line"><span class="attr">VSPHERE_SSH_AUTHORIZED_KEY:</span> <span class="string">ssh-rsa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一些默认参数</span></span><br><span class="line"><span class="attr">AVI_ENABLE:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">IDENTITY_MANAGEMENT_TYPE:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">ENABLE_AUDIT_LOGGING:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">ENABLE_CEIP_PARTICIPATION:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">TKG_HTTP_PROXY_ENABLED:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">DEPLOY_TKG_ON_VSPHERE7:</span> <span class="string">"true"</span></span><br><span class="line"><span class="comment"># 是否开启虚拟机健康检查</span></span><br><span class="line"><span class="attr">ENABLE_MHC:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">MHC_UNKNOWN_STATUS_TIMEOUT:</span> <span class="string">5m</span></span><br><span class="line"><span class="attr">MHC_FALSE_STATUS_TIMEOUT:</span> <span class="string">12m</span></span><br><span class="line"><span class="comment"># 是否部署 vsphere cis 组件</span></span><br><span class="line"><span class="attr">ENABLE_DEFAULT_STORAGE_CLASS:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 是否开启集群自动扩缩容</span></span><br><span class="line"><span class="attr">ENABLE_AUTOSCALER:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><ul><li>通过 tanzu 命令来部署 workload 集群</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># tanzu cluster create tanzu-workload-cluster --file tanzu-workload-cluster.yaml</span></span><br><span class="line">Validating configuration...</span><br><span class="line">Warning: Pinniped configuration not found. Skipping pinniped configuration <span class="keyword">in</span> workload cluster. Please refer to the documentation to check <span class="keyword">if</span> you can configure pinniped on workload cluster manually</span><br><span class="line">Creating workload cluster <span class="string">'tanzu-workload-cluster'</span>...</span><br><span class="line">Waiting <span class="keyword">for</span> cluster to be initialized...</span><br><span class="line">Waiting <span class="keyword">for</span> cluster nodes to be available...</span><br><span class="line">Waiting <span class="keyword">for</span> cluster autoscaler to be available...</span><br><span class="line">Unable to <span class="built_in">wait</span> <span class="keyword">for</span> autoscaler deployment to be ready. reason: deployments.apps <span class="string">"tanzu-workload-cluster-cluster-autoscaler"</span> not found</span><br><span class="line">Waiting <span class="keyword">for</span> addons installation...</span><br><span class="line">Waiting <span class="keyword">for</span> packages to be up and running...</span><br><span class="line">Workload cluster <span class="string">'tanzu-workload-cluster'</span> created</span><br></pre></td></tr></table></figure><ul><li>部署完成之后查看一下集群的 CR 信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get cluster</span></span><br><span class="line">NAME                     PHASE</span><br><span class="line">tanzu-workload-cluster   Provisioned</span><br><span class="line"><span class="comment"># machine 状态处于 Running 说明节点已经正常运行了</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine</span></span><br><span class="line">NAME                                          PROVIDERID                                       PHASE     VERSION</span><br><span class="line">tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1</span><br></pre></td></tr></table></figure><h2 id="扩容集群"><a href="#扩容集群" class="headerlink" title="扩容集群"></a>扩容集群</h2><p>集群部署好之后，如果想对集群节点进行扩缩容，我们可以像 deployment 的一样，只需要修改一些 CR 的信息即可。cluster-api 相关组件会 watch 到这些 CR 的变化，并根据它的 spec 信息进行一系列调谐操作。如果当前集群节点数量低于所定义的节点副本数量，则会自动调用对应的 Provider 创建虚拟机，并对虚拟机进行初始化操作，将它转换为 k8s 里的一个 node 资源；</p><h3 id="扩容-control-plan-节点"><a href="#扩容-control-plan-节点" class="headerlink" title="扩容 control-plan 节点"></a>扩容 control-plan 节点</h3><p>即扩容 master 节点，通过修改 <code>KubeadmControlPlane</code> 这个 CR 中的 <code>replicas</code> 副本数即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl scale kcp tanzu-workload-cluster-control-plane --replicas=3</span></span><br><span class="line"><span class="comment"># 可以看到 machine 已经处于 Provisioning 状态，说明集群节点对应的虚拟机正在创建中</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine</span></span><br><span class="line">NAME                                          PROVIDERID                                       PHASE          VERSION</span><br><span class="line">tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running        v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-control-plane-mkmd2                                                     Provisioning   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running        v1.21.2+vmware.1</span><br></pre></td></tr></table></figure><h3 id="扩容-work-节点"><a href="#扩容-work-节点" class="headerlink" title="扩容 work 节点"></a>扩容 work 节点</h3><p>扩容 worker 节点，通过修改 <code>MachineDeployment</code> 这个 CR 中的 <code>replicas</code> 副本数即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl scale md tanzu-workload-cluster-md-0 --replicas=3</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine</span></span><br><span class="line">NAME                                          PROVIDERID                                       PHASE     VERSION</span><br><span class="line">tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-control-plane-mkmd2    vsphere://4239278c-0503-f03a-08b8-df92286bcdd7   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-control-plane-rt5mb    vsphere://4239c882-2fe5-a394-60c0-616941a6363e   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-4hlqk   vsphere://42395deb-e706-8b4b-a44f-c755c222575c   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-ftmlp   vsphere://42399640-8e94-85e5-c4bd-8436d84966e0   Running   v1.21.2+vmware.1</span><br></pre></td></tr></table></figure><h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>本文只是介绍了 tanzu 集群部署的大体流程，里面包含了 cluster-api 相关的概念在本文并没有做深入的分析，因为实在是太复杂了 😂，到现在我还是没太理解其中的一些原理，因此后续我再单独写一篇博客来讲解一些 cluster-api 相关的内容，到那时候在结合本文来看就容易理解很多。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://github.com/vmware-tanzu/community-edition" target="_blank" rel="noopener">community-edition</a></li><li><a href="https://github.com/vmware/photon" target="_blank" rel="noopener">vmware/photon</a></li><li><a href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go" target="_blank" rel="noopener">tanzu-framework</a></li><li><a href="https://github.com/kubernetes-sigs/cluster-api-provider-vsphere" target="_blank" rel="noopener">cluster-api-provider-vsphere</a></li><li><a href="https://tanzucommunityedition.io/docs/latest/workload-clusters/" target="_blank" rel="noopener">Deploying a workload cluster</a></li><li><a href="https://tanzucommunityedition.io/docs/latest/verify-deployment/" target="_blank" rel="noopener">Examine the Management Cluster Deployment</a></li><li><a href="https://tanzucommunityedition.io/docs/latest/vsphere/" target="_blank" rel="noopener">Prepare to Deploy a Management or Standalone Clusters to vSphere</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;之前接触的 Kubernetes
        
      
    
    </summary>
    
    
      <category term="技术" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="ESXi" scheme="https://blog.k8s.li/tags/ESXi/"/>
    
      <category term="Tanzu" scheme="https://blog.k8s.li/tags/Tanzu/"/>
    
      <category term="Kubernetes" scheme="https://blog.k8s.li/tags/Kubernetes/"/>
    
      <category term="Cluster-api" scheme="https://blog.k8s.li/tags/Cluster-api/"/>
    
  </entry>
  
  <entry>
    <title>使用 overlay2 或 bind 重新构建 ISO 镜像</title>
    <link href="https://blog.k8s.li/rebuild-iso-image.html"/>
    <id>https://blog.k8s.li/rebuild-iso-image.html</id>
    <published>2022-01-24T16:00:00.000Z</published>
    <updated>2022-01-25T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>笔者之前在字节跳动的时候是负责 PaaS 容器云平台的私有化部署相关的工作，所以经常会和一些容器镜像打交道，对容器镜像也有一些研究，之前还写过不少博客文章。比如 <a href="https://blog.k8s.li/Exploring-container-image.html">深入浅出容器镜像的一生 🤔</a>、<a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 在打包发布流水线中的应用</a> 等等。</p><p>自从换了新工作之后，则开始负责 <a href="https://www.smartx.com/smartx-hci/" target="_blank" rel="noopener">超融合产品</a> 集群部署相关工作，因此也会接触很多 <code>镜像</code>，不过这个镜像是操作系统的 ISO 镜像而不是容器镜像 😂。虽然两者都统称为镜像，但两者有着本质的区别。</p><p>首先两者构建的方式有本质的很大的区别，ISO 镜像一般使用 <code>mkisofs</code> 或者 <code>genisoimage</code> 等命令将一个包含操作系统安装所有文件目录构建为一个 ISO 镜像；而容器镜像构建则是根据 <code>Dockerfile</code> 文件使用相应的容器镜像构建工具来一层一层构建；</p><p>另外 ISO 镜像挂载后是只读的，这就意味着如果想要修改 ISO 镜像中的一个文件（比如 kickstart 文件），则需要先将 ISO 镜像中的所有内容负责到一个可以读写的目录中，在这个读写的目录中进行修改和重新构建 ISO 操作。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox ~/build</span><br><span class="line">╰─<span class="comment"># mount -o loop CentOS-7-x86_64-Minimal-2009.iso /mnt/iso</span></span><br><span class="line">mount: /mnt/iso: WARNING: device write-protected, mounted <span class="built_in">read</span>-only.</span><br><span class="line">╭─root@esxi-debian-devbox ~/build</span><br><span class="line">╰─<span class="comment"># touch /mnt/iso/kickstart.cfg</span></span><br><span class="line">touch: cannot touch <span class="string">'/mnt/iso/kickstart.cfg'</span>: Read-only file system</span><br></pre></td></tr></table></figure><p>在日常工作中经常会对一些已有的 ISO 镜像进行重新构建，重新构建 ISO 的效率根据不同的方式也会有所不同，本文就整理了三种不同重新构建 ISO 镜像的方案供大家参考。</p><h2 id="常规方式"><a href="#常规方式" class="headerlink" title="常规方式"></a>常规方式</h2><p>以下是按照 RedHat 官方文档 <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/anaconda_customization_guide/sect-iso-images" target="_blank" rel="noopener"> WORKING WITH ISO IMAGES</a> 中的操作步骤进行 ISO 重新构建。</p><ul><li>首先我们下载一个 ISO 文件，这里以 <a href="https://mirrors.tuna.tsinghua.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso" target="_blank" rel="noopener">CentOS-7-x86_64-Minimal-2009.iso</a> 为例，下载好之后将它挂载到本地 <code>/mn/iso</code> 目录下；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox ~/build</span><br><span class="line">╰─<span class="comment"># mount -o loop CentOS-7-x86_64-Minimal-2009.iso /mnt/iso</span></span><br><span class="line">mount: /mnt/iso: WARNING: device write-protected, mounted <span class="built_in">read</span>-only.</span><br></pre></td></tr></table></figure><ul><li>将 ISO 里的所有文件复制到另一个目录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox ~/build</span><br><span class="line">╰─<span class="comment"># rsync -avrut --force /mnt/iso/ /mnt/build/</span></span><br></pre></td></tr></table></figure><ul><li>进入到该目录下修改或新增文件，然后重新构建 ISO 镜像</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 genisoimage 命令构建 ISO 镜像，在 CentOS 上可以使用 mkisofs 命令，参数上会有一些差异</span></span><br><span class="line">╭─root@esxi-debian-devbox ~/build</span><br><span class="line">╰─<span class="comment"># genisoimage -U -r -v -T -J -joliet-long -V "CentOS 7 x86_64" -volset "CentOS 7 x86_64" -A "CentOS 7 x86_64" -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -no-emul-boot -o /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso .</span></span><br><span class="line">Total translation table size: 124658</span><br><span class="line">Total rockridge attributes bytes: 55187</span><br><span class="line">Total directory bytes: 100352</span><br><span class="line">Path table size(bytes): 140</span><br><span class="line">Done with: The File(s)                             Block(s)    527985</span><br><span class="line">Writing:   Ending Padblock                         Start Block 528101</span><br><span class="line">Done with: Ending Padblock                         Block(s)    150</span><br><span class="line">Max brk space used a4000</span><br><span class="line">528251 extents written (1031 MB)</span><br><span class="line"><span class="comment"># 给 ISO 镜像生成 md5 校验</span></span><br><span class="line">╭─root@esxi-debian-devbox ~/build</span><br><span class="line">╰─<span class="comment"># implantisomd5 /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso</span></span><br><span class="line">Inserting md5sum into iso image...</span><br><span class="line">md5 = 9ddf5277bcb1d8679c367dfa93f9b162</span><br><span class="line">Inserting fragment md5sums into iso image...</span><br><span class="line">fragmd5 = f39e2822ec1ae832a69ae399ea4bd3e891eeb31e9deb9c536f529c15bbeb</span><br><span class="line">frags = 20</span><br><span class="line">Setting supported flag to 0</span><br></pre></td></tr></table></figure><p>对于 ISO 镜像比较小或者该操作不是很频繁的情况下按照这种方式是最省事儿的，但如果是 ISO 镜像比较大，或者是在 CI/CD 流水线中频繁地重新构建镜像，每次都要 cp 复制原 ISO 镜像的内容确实比较浪费时间。那有没有一个更加高效的方法呢 🤔️</p><p>经过一番摸索，折腾出来两种可以避免使用 cp 复制这种占用大量 IO 操作的构建方案，可以根据不同的场景进行选择。</p><h2 id="overlay2"><a href="#overlay2" class="headerlink" title="overlay2"></a>overlay2</h2><p>熟悉 docker 镜像的应该都知道镜像是只读的，使用镜像的时候则是通过联合挂载的方式将镜像的每一层 layer 挂载为只读层，将容器实际运行的目录挂载为读写层，而容器运行期间在读写层的所有操作不会影响到镜像原有的内容。容器镜像挂载的方式使用最多的是 overlay2 技术，在 <a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 在打包发布流水线中的应用</a> 和 <a href="https://blog.k8s.li/Exploring-container-image.html">深入浅出容器镜像的一生 🤔</a> 中咱曾对它进行过比较深入的研究和使用，对 overlay2 技术感兴趣的可以翻看一下这两篇博客，本文就不再详解其中的技术原理了，只对使用 overlay2 技术重新构建 ISO 镜像的可行性进行一下分析。</p><ul><li>首先是创建 overlay2 挂载所需要的几个目录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox ~</span><br><span class="line">╰─<span class="comment"># mkdir -p /mnt/overlay2/&#123;lower,upper,work,merged&#125;</span></span><br><span class="line">╭─root@esxi-debian-devbox ~</span><br><span class="line">╰─<span class="comment"># cd /mnt/overlay2</span></span><br></pre></td></tr></table></figure><ul><li>接着将 ISO 镜像挂载到 overlay2 的只读层 <code>lower</code> 目录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox /mnt/overlay2</span><br><span class="line">╰─<span class="comment"># mount -o loop  /root/build/CentOS-7-x86_64-Minimal-2009.iso lower</span></span><br><span class="line">mount: /mnt/overlay2/lower: WARNING: device write-protected, mounted <span class="built_in">read</span>-only.</span><br></pre></td></tr></table></figure><ul><li>使用 mount 命令挂载 overlay2 文件系统，挂载点为 <code>merged</code> 目录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox /mnt/overlay2</span><br><span class="line">╰─<span class="comment"># mount -t overlay overlay -o lowerdir=lower,upperdir=upper,workdir=work merged</span></span><br><span class="line">╭─root@esxi-debian-devbox /mnt/overlay2</span><br><span class="line">╰─<span class="comment"># cd merged</span></span><br></pre></td></tr></table></figure><ul><li>新增一个 kickstart.cfg 文件，然后重新构建 ISO 镜像</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox /mnt/overlay2/merged</span><br><span class="line">╰─<span class="comment"># echo '# this is a kickstart config file' &gt; kickstart.cfg</span></span><br><span class="line">╭─root@esxi-debian-devbox /mnt/overlay2/merged</span><br><span class="line">╰─<span class="comment"># genisoimage -U -r -v -T -J -joliet-long -V "CentOS 7 x86_64" -volset "CentOS 7 x86_64" -A "CentOS 7 x86_64" -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -no-emul-boot -o /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso .</span></span><br><span class="line">Total translation table size: 124658</span><br><span class="line">Total rockridge attributes bytes: 55187</span><br><span class="line">Total directory bytes: 100352</span><br><span class="line">Path table size(bytes): 140</span><br><span class="line">Done with: The File(s)                             Block(s)    527985</span><br><span class="line">Writing:   Ending Padblock                         Start Block 528101</span><br><span class="line">Done with: Ending Padblock                         Block(s)    150</span><br><span class="line">Max brk space used a4000</span><br><span class="line">528251 extents written (1031 MB)</span><br></pre></td></tr></table></figure><ul><li>挂载新的 ISO 镜像验证后发现确实可行</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox /mnt/overlay2/merged</span><br><span class="line">╰─<span class="comment"># mount -o loop /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso /mnt/newiso</span></span><br><span class="line">mount: /mnt/newiso: WARNING: device write-protected, mounted <span class="built_in">read</span>-only.</span><br><span class="line">╭─root@esxi-debian-devbox /mnt/overlay2/merged</span><br><span class="line">╰─<span class="comment"># cat /mnt/newiso/kickstart.cfg</span></span><br><span class="line"><span class="comment"># this is a kickstart config file</span></span><br></pre></td></tr></table></figure><h2 id="mount-–bind"><a href="#mount-–bind" class="headerlink" title="mount –bind"></a>mount –bind</h2><p>前面讲到了使用 overlay2 的方式避免复制原镜像内容进行重新构建镜像的方案，但是 overlay2 对于不是很熟悉的人来讲还是比较复杂，光 lowerdir、upperdir、workdir、mergeddir 这四个文件夹的作用和原理就把人直接给整不会了。那么还有没有更为简单一点的方式呢？</p><p>别说还真有，只不过这种方式的用途比较局限。如果仅仅是用于修改 ISO 中的一个文件或者目录，可以将该文件或目录以 <code>bind</code> 挂载的方式将它挂载到 ISO 目录目录对应的文件上。</p><p>原理就是虽然 ISO 目录本身是只读的，但它里面的文件和目录是可以作为一个挂载点的。也就是说我把文件 A 挂载到文件 B，并不是在修改文件 B，这就是 Unix/Linux 文件系统十分奇妙的地方。同样运用 bind 挂载的还有 docker 的 volume 以及 pod 的 volume 也是运用同样的原理，以 bind 的方式将宿主机上的目录或文件挂载到容器运行对应的目录上。对于修改只读 ISO 里的文件/目录我们当然也可以这样做。废话不多说来实践验证一下：</p><ul><li>首先依旧是将 ISO 镜像挂载到 <code>/mn/iso</code> 目录</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox ~/build</span><br><span class="line">╰─<span class="comment"># mount -o loop CentOS-7-x86_64-Minimal-2009.iso /mnt/iso</span></span><br><span class="line">mount: /mnt/iso: WARNING: device write-protected, mounted <span class="built_in">read</span>-only.</span><br></pre></td></tr></table></figure><ul><li>接着创建一个 <code>/mnt/files/ks.cfg</code> 文件，并写入我们需要的内容</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox ~/build</span><br><span class="line">╰─<span class="comment"># mkdir -p /mnt/files</span></span><br><span class="line">╭─root@esxi-debian-devbox ~/build</span><br><span class="line">╰─<span class="comment"># echo '# this is a kickstart config file' &gt; /mnt/files/ks.cfg</span></span><br></pre></td></tr></table></figure><ul><li>接着以 mount –bind 的方式挂载新建的文件到 ISO 的 EULA 文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox /mnt/build</span><br><span class="line">╰─<span class="comment"># mount --bind /mnt/files/ks.cfg /mnt/iso/EULA</span></span><br><span class="line">╭─root@esxi-debian-devbox /mnt/build</span><br><span class="line">╰─<span class="comment"># cat /mnt/iso/EULA</span></span><br><span class="line"><span class="comment"># this is a kickstart config file</span></span><br></pre></td></tr></table></figure><ul><li>可以看到原来 ISO 文件中的 EULA 文件已经被成功替换成了我们修改的文件，然后再重新构建一下该 ISO 镜像</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox /mnt/iso</span><br><span class="line">╰─<span class="comment"># genisoimage -U -r -v -T -J -joliet-long -V "CentOS 7 x86_64" -volset "CentOS 7 x86_64" -A "CentOS 7 x86_64" -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -no-emul-boot -o /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso .</span></span><br></pre></td></tr></table></figure><ul><li>然后我们再重新挂载新的 ISO 文件验证一下是否可以</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox /mnt/iso</span><br><span class="line">╰─<span class="comment"># mkdir /mnt/newiso</span></span><br><span class="line">╭─root@esxi-debian-devbox /mnt/iso</span><br><span class="line">╰─<span class="comment"># mount -o loop /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso /mnt/newiso</span></span><br><span class="line">mount: /mnt/newiso: WARNING: device write-protected, mounted <span class="built_in">read</span>-only.</span><br><span class="line">╭─root@esxi-debian-devbox /mnt/iso</span><br><span class="line">╰─<span class="comment"># cat /mnt/newiso/EULA</span></span><br><span class="line"><span class="comment"># this is a kickstart config file</span></span><br></pre></td></tr></table></figure><p>验证通过，确实可以！不过这种方式很局限，比较适用于修改单个文件如 <code>kickstart.cfg</code>，如果是要新增文件那还是使用上文提到的 overlay2 的方式更为方便一些。</p><h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><p>虽然 ISO 镜像和容器镜像二者有着本质的差别，但对于只读和联合挂载的这些特性二者可以相互借鉴滴。</p><p>不止如此 overlay2 这种联合挂载的特性，还可以用在其他地方。比如我有一个公共的 NFS 共享服务器，共享着一些目录，所有人都可以以 root 用户并以读写的权限进行 NFS 挂载。这种情况下很难保障一些重要的文件和数据被误删。这时候就可以使用 overlay2 的方式将一些重要的文件数据挂载为 overlay2 的 lowerdir 只读层，保证这些数据就如容器镜像一样，每次挂载使用的时候都作为一个只读层。所有的读写操作都在 overlay2 的 merged 那一层，不会真正影响到只读层的内容。</p><p>草草地水了一篇博客，是不是没有用的知识又增加了 😂</p><h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul><li><a href="https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt" target="_blank" rel="noopener">overlayfs.txt</a></li><li><a href="https://arkingc.github.io/2017/05/05/2017-05-05-docker-filesystem-overlay/" target="_blank" rel="noopener">Docker 存储驱动—Overlay/Overlay2「译」</a></li><li><a href="https://blog.k8s.li/Exploring-container-image.html">深入浅出容器镜像的一生 🤔</a></li><li><a href="https://zdyxry.github.io/2019/01/12/%E8%81%8A%E4%B8%80%E8%81%8A-ISO-9660/" target="_blank" rel="noopener">聊一聊 ISO 9660</a></li><li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/anaconda_customization_guide/sect-iso-images" target="_blank" rel="noopener">WORKING WITH ISO IMAGES</a></li><li><a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 在打包发布流水线中的应用</a></li><li><a href="https://blog.k8s.li/mount-bind.html">mount 命令之 –bind 挂载参数</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;笔者之前在字节跳动的时候是负责 PaaS
        
      
    
    </summary>
    
    
      <category term="技术" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="overlay2" scheme="https://blog.k8s.li/tags/overlay2/"/>
    
      <category term="ISO" scheme="https://blog.k8s.li/tags/ISO/"/>
    
  </entry>
  
  <entry>
    <title>Kubespray 2.18 版本特性预览</title>
    <link href="https://blog.k8s.li/kubespray-2.18.html"/>
    <id>https://blog.k8s.li/kubespray-2.18.html</id>
    <published>2022-01-04T16:00:00.000Z</published>
    <updated>2022-04-29T12:23:49.336Z</updated>
    
    <content type="html"><![CDATA[<p>最近 kubernetes-sig 社区的 <a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener">kubespray</a> 项目正式 release 了 <a href="https://github.com/kubernetes-sigs/kubespray/releases/tag/v2.18.0" target="_blank" rel="noopener">v2.18.0</a> 版本，同时对应 <a href="https://github.com/cncf/k8s-conformance" target="_blank" rel="noopener">k8s-conformance</a> 的 <a href="https://github.com/cncf/k8s-conformance/pull/1748" target="_blank" rel="noopener">v1.21</a> 和 <a href="https://github.com/cncf/k8s-conformance/pull/1760" target="_blank" rel="noopener">v1.22</a> 版本 kubespray 也都已经得到 CNCF 的一致性认证。于是今天就借这个新版本 release 的机会整理一下 2.18 版本的 kubespray 有哪些有趣的变化。</p><h2 id="组件版本"><a href="#组件版本" class="headerlink" title="组件版本"></a>组件版本</h2><p>以下是 v2.18.0 版本中 kubespray 部署组件的一些版本信息：</p><h3 id="K8s-核心组件"><a href="#K8s-核心组件" class="headerlink" title="K8s 核心组件"></a>K8s 核心组件</h3><ul><li>kubespray 支持的 Kubernetes 支持从 v1.22.0 到 v1.23.1 之间的所有正式版本，默认部署的版本为 v1.22.5，并且 <a href="https://github.com/cncf/k8s-conformance/pull/1760" target="_blank" rel="noopener">v1.22</a> 版本得到了 CNCF 官方的一致性认证；</li><li>etcd 从原来的 v3.4.13 升级到了 v3.5.0；</li><li>coredns 版本升级到了 v1.8.0，它的搭档 dnsautoscaler 则为 1.8.5；</li><li>pod_infra 即 pause 镜像的版本没有变化依旧为 3.3；</li></ul><table><thead><tr><th>Addon</th><th align="left">Version</th></tr></thead><tbody><tr><td>kube</td><td align="left">v1.22.5</td></tr><tr><td>pod_infra</td><td align="left">3.3</td></tr><tr><td>etcd</td><td align="left">v3.5.0</td></tr><tr><td>coredns</td><td align="left">v1.8.0</td></tr></tbody></table><h3 id="容器运行时"><a href="#容器运行时" class="headerlink" title="容器运行时"></a>容器运行时</h3><p>目前市面上所有的 Kubernetes 集群部署工具中，对容器运行时的支持 kubespray 无疑是最丰富的。部署能支持 docker、containerd、crun、kata、cri-o。默认的容器运行时已经从之前的 docker 切换到了 containerd，containerd 的版本是 v1.5.8。</p><table><thead><tr><th>Addon</th><th>Version</th></tr></thead><tbody><tr><td>containerd</td><td>1.5.8</td></tr><tr><td>docker</td><td>20.10</td></tr><tr><td>docker_containerd</td><td>1.4.12</td></tr><tr><td>crun</td><td>1.3</td></tr><tr><td>runc</td><td>v1.0.3</td></tr><tr><td>crio</td><td>1.22</td></tr><tr><td>kata_containers</td><td>2.2.3</td></tr><tr><td>gvisor</td><td>20210921</td></tr></tbody></table><h3 id="CNI"><a href="#CNI" class="headerlink" title="CNI"></a>CNI</h3><p>同样，目前市面上所有的 Kubernetes 集群部署工具中，对 CNI 的支持 kubespray 也无疑是最为丰富的，能支持 9 种 CNI 以及多种 CNI 组合部署的 <a href="https://github.com/intel/multus-cni" target="_blank" rel="noopener">multus</a> 。</p><table><thead><tr><th>Addon</th><th>Version</th></tr></thead><tbody><tr><td>calico</td><td>v3.20.3</td></tr><tr><td>flannel</td><td>v0.15.1</td></tr><tr><td>flannel_cni</td><td>v1.0.0</td></tr><tr><td>cni</td><td>v1.0.1</td></tr><tr><td>weave</td><td>2.8.1</td></tr><tr><td>cilium</td><td>v1.9.11</td></tr><tr><td>kube_ovn</td><td>v1.8.1</td></tr><tr><td>kube_router</td><td>v1.3.2</td></tr><tr><td>multus_cni</td><td>0.4.0</td></tr><tr><td>multus</td><td>v3.8</td></tr></tbody></table><h3 id="Kubernetes-app"><a href="#Kubernetes-app" class="headerlink" title="Kubernetes-app"></a>Kubernetes-app</h3><p>同时，kubespray 还支持一些 CLI 工具以及第三方应用的部署。</p><ul><li>CLI 工具</li></ul><p>一些 CLI 工具，比如 helm、nerdctl、krew、crictl。其中 nerdctl 的部署支持是咱在 <a href="https://github.com/kubernetes-sigs/kubespray/pull/7500" target="_blank" rel="noopener">#7500</a> 中加入支持的，目的是为 containerd 用户提供一个相对友好的命令行操作体验，以替代 docker CLI。</p><table><thead><tr><th>addon</th><th>version</th></tr></thead><tbody><tr><td>helm</td><td>v3.7.1</td></tr><tr><td>nerdctl</td><td>0.15.0</td></tr><tr><td>krew</td><td>v0.4.2</td></tr><tr><td>crictl</td><td>v1.22.0</td></tr></tbody></table><ul><li>app</li></ul><p>个人感觉部署一些像 <code>dnsautoscaler</code>、 <code>argoCD</code> 这样的应用，还是使用 helm 比较好。因为基于 ansible 的 kubespray 维护这么多第三方组件，以及它们的升级管理都远不如 helm 方便。因此考虑到这些组件的升级维护成本，个人还是不太建议使用 kubespray 来部署这些组件。</p><table><thead><tr><th>Addon</th><th>Version</th></tr></thead><tbody><tr><td>dnsautoscaler</td><td>1.8.5</td></tr><tr><td>netcheck</td><td>v1.2.2</td></tr><tr><td>nodelocaldns</td><td>1.21.1</td></tr><tr><td>metrics_server</td><td>v0.5.0</td></tr><tr><td>cert_manager</td><td>v1.5.4</td></tr><tr><td>addon_resizer</td><td>1.8.11</td></tr><tr><td>cinder_blockstorage</td><td>v3</td></tr><tr><td>external_vsphere</td><td>6.7u3</td></tr><tr><td>nvidia_driver</td><td>390.87</td></tr><tr><td>oci_cloud_controller</td><td>0.7.0</td></tr><tr><td>metallb</td><td>v0.10.3</td></tr><tr><td>argocd</td><td>v2.1.6</td></tr></tbody></table><h2 id="支持的-OS"><a href="#支持的-OS" class="headerlink" title="支持的 OS"></a>支持的 OS</h2><table><thead><tr><th>distribution</th><th>version</th></tr></thead><tbody><tr><td>Amazon Linux</td><td>2</td></tr><tr><td>Fedora CoreOS</td><td>34.x/35.x</td></tr><tr><td>Flatcar Container Linux by Kinvolk</td><td></td></tr><tr><td>Alma Linux</td><td>8</td></tr><tr><td>Rocky Linux</td><td>8</td></tr><tr><td>CentOS/RHEL</td><td>7/8</td></tr><tr><td>Oracle Linux</td><td>7/8</td></tr><tr><td>Debian</td><td>8/9/10/11</td></tr><tr><td>Ubuntu</td><td>16.04/18.04/20.04</td></tr><tr><td>Fedora</td><td>34/35</td></tr><tr><td>openSUSE</td><td>Leap 15.x/Tumbleweed</td></tr></tbody></table><h2 id="主要变化"><a href="#主要变化" class="headerlink" title="主要变化"></a>主要变化</h2><h3 id="废除"><a href="#废除" class="headerlink" title="废除"></a>废除</h3><ul><li>在 <a href="https://github.com/kubernetes-sigs/kubespray/pull/8086" target="_blank" rel="noopener">#8086</a> 中移除了对 Ambassador 的支持；</li><li>在 <a href="https://github.com/kubernetes-sigs/kubespray/pull/8327" target="_blank" rel="noopener">#8327</a> 中移除了对 registry-proxy 的支持；</li><li>在 <a href="https://github.com/kubernetes-sigs/kubespray/pull/8246" target="_blank" rel="noopener">#8246</a> 中移除了对 Fedora 33 的支持，因为  Fedora 33 在 2021-11-30 就已经 EOL 了，所以被废弃支持也理所当然；</li><li>在 <a href="https://github.com/kubernetes-sigs/kubespray/pull/8265" target="_blank" rel="noopener">#8265</a> 中移除了对 Mitogen 的支持，Mitogen 的作用就是用来优化 Ansible 的性能，但 Mitogen 对于一些新的 Linux 发行版支持的额并不是很友好，在 Kubespray 中维护的成本也比较大，因此社区就废弃它了；</li></ul><h3 id="新特性"><a href="#新特性" class="headerlink" title="新特性"></a>新特性</h3><ul><li>在 <a href="https://github.com/kubernetes-sigs/kubespray/pull/7895" target="_blank" rel="noopener">#7895</a> 中新增了 ArgoCD 的部署支持，通过设置 <code>argocd_enabled</code> 即可在部署集群的时候安装 ArgoCD。不过个人认为，ArgoCD 这玩意儿不太适合放在 K8s 部署当中来，看看 <a href="https://github.com/kubesphere/ks-installer" target="_blank" rel="noopener">ks-installer</a> 的代码你就能明白了 😂。</li><li>在 <a href="https://github.com/kubernetes-sigs/kubespray/pull/8175" target="_blank" rel="noopener">#8175</a> 中默认使用 containerd 作为默认的容器运行时，替代掉了 docker。不过需要注意的是，当前版本的 kubespray 是使用 <a href="https://github.com/containerd/containerd" target="_blank" rel="noopener">containerd</a> 官方 repo release 的二进制安装包，但二进制安装包并没有 arm64 版本的。所以如果要部署的集群节点包含 arm64 的机器，最好还是使用 docker 作为容器运行时。</li><li>在 <a href="https://github.com/kubernetes-sigs/kubespray/pull/8291" target="_blank" rel="noopener">#8291</a> 新增了 registry 部署支持多种 ServiceTypes 的支持；</li><li>在 <a href="https://github.com/kubernetes-sigs/kubespray/pull/8229" target="_blank" rel="noopener">#8229</a> 中新增了支持 registry 认证的方式，私有化部署的时候使用带有认证的 registry 会用到；</li></ul><h3 id="已知问题"><a href="#已知问题" class="headerlink" title="已知问题"></a>已知问题</h3><ul><li>在 <a href="https://github.com/kubernetes-sigs/kubespray/pull/8239" target="_blank" rel="noopener">#8239</a> 中 <a href="https://github.com/cristicalin" target="_blank" rel="noopener">cristicalin</a> 大佬引入了一个修改，如果是 containerd 运行时，则使用 nerdctl 下载镜像。这将会导致配置了 containerd registry mirrors 的参数将会失效。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;最近 kubernetes-sig 社区的 &lt;a
        
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>时光痕迹：2021 年总结</title>
    <link href="https://blog.k8s.li/2021.html"/>
    <id>https://blog.k8s.li/2021.html</id>
    <published>2022-01-02T16:00:00.000Z</published>
    <updated>2022-04-29T12:23:49.336Z</updated>
    
    <content type="html"><![CDATA[<p>2021 依旧是人类社会<strong>倒车和加速灭亡</strong>的一年，全球范围内新冠病毒依旧在肆虐，新的变异又接踵而来，疫情并没有多少消退的迹象。而现在国内西安疫情又爆发开来，无法预想未来究竟能变成什么样子。</p><h2 id="阅读"><a href="#阅读" class="headerlink" title="阅读"></a>阅读</h2><p>2021 年 9 月份的时候将书单从原来的 Markdown 文本迁移到了 Notion 上，体验十分棒。Notion 的表格数据库功能十分强大，对书单来说简直就是一件神器。抽空整理了一下书单  <a href="https://reading.k8s.li" target="_blank" rel="noopener">reading.k8s.li</a>  ，2021 年大概读完了 97 本书。其中科普 27 本、漫画 17 本、历史 13 本、政治 11 本、轻小说 8 本、社科 7 本、心理学 5 本、技术 5 本、法律 2 本。之所以能读完这么多书大概是因为如下 😂：</p><ul><li>单身独居，自己一个人生活，没人打扰；</li><li>不喜欢社交，不喜欢群聊闲聊扯淡撕逼；</li><li>不玩游戏不刷短视频，没有其他爱好；</li><li>周末和节假日大多数宅在家里玩儿；</li></ul><p>其中我觉着单身独居是最主要的原因，比如 <a href="https://twitter.com/yihong0618" target="_blank" rel="noopener">伊洪</a> 老哥也是如此：</p><p><img src="https://p.k8s.li/image-20220103202406764.png" alt="image-20220103202406764"></p><p>根据个人的喜好，就分享以下 10 本我个人觉着十分有意思的书给大家：</p><p><img src="https://p.k8s.li/image-20220103202406766.png" alt="Snipaste_2021-12-31_19-28-11"></p><p>由于读书笔记的篇幅太长，后面有空的话我会和去年的《<a href="https://blog.k8s.li/2020-booklist.html">2020 年读书笔记和思考</a>》一样，再写一篇 2021 年的读书笔记来分享给大家（大概率是在春节期间写了）。</p><h2 id="工作"><a href="#工作" class="headerlink" title="工作"></a>工作</h2><h3 id="字节跳动"><a href="#字节跳动" class="headerlink" title="字节跳动"></a>字节跳动</h3><p>今年最大的变化就是换了新工作，这也是第二次换工作。本来没有打算离职，但是被迫<del>字节</del>跳动了一年之后，感觉太累了，并没有想象中的那么快乐。</p><p>不得不吐槽一下字节的基础设施做的实在是太烂了，比如镜像仓库各种奇葩的问题。当时还因为这破玩意儿出过版本发布的错误，导致组件编译的 base 镜像出错，后来又不得不重新发布一个版本来擦屁股。</p><p>还有当时 PaaS 容器云平台私有化产品版本发布的时候，领导非得将打包发布的时间点定在临近晚上下班的时候。这就会导致我们组（苦命发版工具人）忙活到晚上十一二点，真的是十分不爽。就是因为一些公共事务没有做好，一些问题在组件自身的 CI/CD 流水线中并不能及时暴露，等到最终最后版本发布的时候，各种奇葩的问题突突突地冒出来。比如缺镜像、镜像错误、helm chart 错误、版本错误等。然后出了问题之后又要 @ 各个组件的 owner 去解决问题，它们修改好之后我们再重新打包部署新的环境来验证。每到发版日就十分痛苦，一些基础设施和公共事务没有做好，等到最后我们发版工具人来擦屁股。这让我想起了另一位推友分享的经历：</p><p><img src="https://p.k8s.li/image-20220104082135898.png" alt="image-20220104082135898"></p><h3 id="裸辞离职"><a href="#裸辞离职" class="headerlink" title="裸辞离职"></a>裸辞离职</h3><p>四月底和 leader 绩效沟通完后感觉不太满意于是内心就决定了要离职。不过因为当时一些组织架构的调整，我所做的工作没有一个合适的人来接盘。再加上新产品刚进入设计阶段，新产品平台底层的 K8s 部署以及私有化打包发布相关的工作没有其他人能够 take 起来，最尴尬的是这部分工作当时只有我一个人能完整地做出来。如果在五月底离职的话，可能会对新产品的开发带来一定影响。因此当时考虑了一下，还是等到新产品稳定发版以及把负责的工作交接给新人之后再离开吧。</p><p>就这样自己一个人又重新负责起了整个 PaaS 平台的私有化部署和打包发布相关的工作，这段时间也收获挺多的，顺便给 kubernetes-sig 社区的 kubespray 项目贡献了十几个 <a href="https://github.com/kubernetes-sigs/kubespray/pulls?q=is%3Apr+author%3Amuzi502+is%3Aclosed" target="_blank" rel="noopener">PR</a>。等到七月底的时候，新产品已经进入了稳定开发的阶段，在第一个 alpha.1 版本时就搞定了私有化部署和私有化打包的流水线，又经过三个 sprint 的迭代后，终于稳定了下来。之后就整理了一些平时积累的文档，交接给了其他同事，然后办理离职手续走人。</p><p>裸辞的原因也有很多：想走出心理舒适圈，换个环境能让自己成长起来；当时对工作也有了一点厌倦，想好好休息一下；当时的状态也不是很好，如果那时候准备面试的话，感觉效果不太好；很久没有回家了，想在家好好休息一段时间。当时也没有选择休假，而是将所有的假期都折算成双倍工资了，感觉这样更划算一些。如果是休假的话，保不准在休假的时候仍要在飞书上处理一些同事的问题。感觉这样就挺烦人的，所以干脆就直接走人，飞书都没了还怎么联系我。</p><p>离职的第二天就收拾行李回老家，因为老爸的生日快到了，也想尽快回家和家人团聚。</p><p>之后就一直在家划水摸鱼啦，期间花了两周左右的时间完成了两个开源项目：一个是用于构建 yum/apt/dnf 离线源的工具 <a href="https://github.com/k8sli/os-packages" target="_blank" rel="noopener">k8sli/os-packages</a> ，以及无网环境中离线部署 k8s 的工具  <a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">k8sli/kubeplay</a> 。</p><h3 id="面试"><a href="#面试" class="headerlink" title="面试"></a>面试</h3><p>正式开始准备面试是在 9 月初的时候，已经划水摸鱼一个月了，感觉休息的也差不多了。还是赶紧找工作面试吧，在起初的一周是通过一些心仪公司的官网上投递的简历，不幸的是收到的回复很少。当时心里有点慌，写了篇求职《<a href="https://blog.k8s.li/jobs.html">求职贴：运维开发 ｜SRE</a>》介绍了一下自己的现状，终于收到了一些小伙伴们的内推。</p><p><img src="https://p.k8s.li/image-20211231205927088.png" alt="image-20211231205927088"></p><p>在此还是十分感谢帮助我内推的小伙伴，在我即将走投无路的时候有你们的推荐才有了我现在的工作机会。大大小小的面试总共进行了 25 次吧，差不多通过了一半，拿到 4 个书面 offer，最终去了一家做 IaaS 虚拟化和分布式块存储产品的 toB 公司。</p><p>因为之前是在字节跳动做 PaaS toB 产品的集群部署和私有化交付相关工作，在新工作则是做 IaaS toB 产品的集群部署相关工作，都是“集群部署”相关的，因此和以往的经历比较匹配。对于像咱这种喜欢折腾的垃圾佬来说，还是硬件服务器、操作系统、虚拟化、分布式存储等方面的内容比较有意思，玩起来可开心惹 🤣。</p><p>更为重要的一点是新工作不再像以前那样运维技术为主了，而至以后端研发为主。其实我很早之前就想写一些 Go/Python 后端项目的代码了，只不过一直没找到一个合适的机会（其实是偷懒的借口 🌚）。在字节的时候也没有太多后端开发的经验，所以当初面试的时候因为开发能力较弱被刷掉了很多，也让一些面试官极其失望。</p><p>幸运的是面试的时候也遇到了一个非常 nice 的公司愿意花时间培养我这方面的能力，leader 也十分信任我的学习能力，让我从零开始承担一个项目的后端开发，给了我这么一个宝贵的机会来学习和弥补开发能力不足的短板。</p><h2 id="生活"><a href="#生活" class="headerlink" title="生活"></a>生活</h2><p>生活上依旧是单身独居，自己一个人生活实在是太爽了，越来越习惯这种生活，好想永远地就这样生活下去，没有催婚的烦恼 😖。独自一个人生活最重要的就是学会<strong>如何对抗虚无</strong>。只要找些有意义的事情来做（比如读书），就不会觉着生活无味或者有空虚感。回想起大学四年，基本上我也是的独自一人去图书馆看书、独自一人吃饭、独自一人去自习室，感觉和现在没有太多差别，只不过从上课学习换成了工作搬砖，其他时间的生活节奏基本上没有太大的变化。</p><p>还有一点就是尽量的远离社交媒体，不要过度地依赖它们，更不要放纵自己不停地刷推或者短视频来娱乐消遣。其实这些东西并不能给我们带来真正意义上的快乐，有一部纪录片《<a href="https://www.netflix.com/sg-zh/title/81254224" target="_blank" rel="noopener">监视资本主义：智能陷阱</a>》里面也谈到过过度依赖社交媒体的后果。</p><h3 id="杭州过年"><a href="#杭州过年" class="headerlink" title="杭州过年"></a>杭州过年</h3><p>因为疫情的原因 2021 年就没回家过年，再加上越是农村那种破地方防疫措施就是越离谱，看看现在西安的防疫措施你们就能明白了为什么不想回家。于是就懒得折腾，选择独自一人留在杭州过年，顺便还能领取杭州市政府的留杭补贴 1000 块钱。杭州市在这一块做的还真不错，去年还领了人才补贴的 1w 块钱，从老大哥手里薅羊毛，真鸡儿刺激。</p><h3 id="环太湖骑行"><a href="#环太湖骑行" class="headerlink" title="环太湖骑行"></a>环太湖骑行</h3><p>为了不让五一假期再像过年那样一直烂在家里，就独自一人从杭州骑行到湖州、常州、无锡、苏州、太湖一带游玩，真的是很久没有那么开心过了。回来之后还更新了一篇博客《<a href="https://blog.k8s.li/taihu.html">五一假期环太湖骑行之旅</a>》，旅程的风景真的不错，感兴趣的话可以去读一下。</p><h3 id="上海租房"><a href="#上海租房" class="headerlink" title="上海租房"></a>上海租房</h3><p>新工作的办公地点是在上海，因为不支持远程办公所以不得不从杭州搬家来到上海。在中介老哥的带领下找了一个月租 3100 元的卧室 + 独卫的房子（包水电费），整体感觉十分满意。房子比较特殊，是三室一厅。我住在其中的一个大卧室，房东他父母住在另一个卧室，剩余的一个卧室是空着的，除了我以外没有其他的租客。出于对老人安全的考虑，房东只允许我自己一个人住，不能带外人来。对我来说也没啥，独来独往的生活反正也不会有其他人来找我玩儿。</p><p>卧室面积 3.3 * 4.3m=14.19 平、玄关 1.1 * 1m=1.1 平、卫生间 2.3 * 2.1m=4.38 平。加起来总共差不多 20 平。感觉这个面积感觉比杭州那个带阳台的卧室大很多。一个 1.5 * 2m 的床、靠墙再放置两张 60* 120 cm 的宜家桌子、床的右侧又能放下一张 0.6 * 1.4m 米的书桌，还有一个 0.5 *2m 的衣柜。</p><p>现在终于住上了自己所期待的那种房子，回想起大学刚毕业那一年住的还是 300 块钱的上下铺青旅，就感觉当时十分寒酸 😭。</p><p><img src="https://p.k8s.li/image-20220103165850671.png" alt="image-20220103165850671"></p><p>房间里还有一个带书架的电脑桌，放下一个 27 寸的显示器刚刚好。另外把我那台 HPE Gen10 Plus 服务器安置在了书桌下面。虽然靠近床头，但 NAS 里硬盘的噪音还算能接受，不至于吵得睡不着觉。有时候在想要不要整个 12U 的机柜来着，但规划了一下感觉还是没有太大的必要，先这样凑活着用吧。</p><p><img src="https://p.k8s.li/image-20220103202406765.jpg" alt="IMG_2177"></p><p>搬进来之后的第二天在闲鱼上花了 300 块钱捡来了一个原价 1699 的米家扫地机器人，又花了 200 块钱捡了一个米家空气净化器（贫穷如我，只能靠捡和薅来提升生活幸福感了）。感觉这两个家用电器还是挺值的，扫地机器人省去了打扫卫生的麻烦事儿，生活幸福感 +++。</p><h2 id="2022"><a href="#2022" class="headerlink" title="2022"></a>2022</h2><p>就像作家方方所说的那样：<a href="http://fangfang.blog.caixin.com/archives/220746" target="_blank" rel="noopener">时代的一粒灰，落在个人头上就是一座山</a> 。外婆在 2020 年新冠疫情刚爆发的那段时间不幸离开了这个世界，而那段时间的经历也彻底改变了我看待生死的想法。仿佛一切都没有那么重要了，也让我深刻地明白了<strong>这个世界上没有什么东西无法不能失去的，也没有什么非得必须要得到的</strong>。即便是某一天我不幸去世，也没有太多遗憾和悔恨。所以去他的未来计划，和往常一样好好搬砖工作和看书学习，这样就够了。</p><p>另外祝大家新的一年快快乐乐 🥳</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;2021
        
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Tencent Cloud lighthouse Firewall tool</title>
    <link href="https://blog.k8s.li/cfwctl.html"/>
    <id>https://blog.k8s.li/cfwctl.html</id>
    <published>2021-12-14T16:00:00.000Z</published>
    <updated>2021-12-14T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>上次去北京出差，为了便捷地访问家里内网中的一些服务，就在腾讯云服务器上部署了一个 frps 服务，在本地内网的 Openwrt 路由器上安装 frpc 客户端，将内网中的一台 Windows 服务器穿透到腾讯云服务器上。然后通过 Windows RDP 远程连接到这台 Windows 机器上，来使用内网的一些服务。之前也尝试过 WireGuard，但是使用了一段时间体验下来感觉还是通过内网穿透的方式比较稳定和流畅。于是最终的方式还是选用 frp 内网穿透的方案。</p><p>本着方便省事儿的原则就放心大胆地开放了云服务器的安全组规则。不幸的是，由于这样的疏忽，某一天我的 Windows 虚拟机被弱口令（admin2020）给爆破了。巨大的损失就是挂载到 Windows 虚拟机上的 NAS 存储被勒索病毒进行了加密 😂。不过好在最最重要的数据全部存到了 OneDrive 上，NAS 上损失的都是一些下载的电影、书籍以及一些 ISO、虚拟机模版之类的文件。一下子损失了 8TB 的数据很心疼，毕竟是自己辛辛苦苦搜集的资源，但是仔细想一下，这些资源都不是自己的，基本上都是从下载下来的，还可以通过同样的方式找回来。或许是之前看过《断舍离》的缘故，也看的开了，难受了一小会儿之后就好过来了。毕竟这个世界上，没有无法不能失去的东西，也没有非得必须要得到的东西。</p><p>有了此次教训，就开始考虑对手上的云主机资源进行安全加固，将一些与内网互通的云主机安全组/防火墙的通用去除了允许所有，只添加本地公网 IP 的允许规则。但是对于家庭宽带用户来讲，公网 IP 并不是一个固定的 IP，而是会一直不断变化，总不能每次变化之后再登录到云主机控制台手动添加一下吧。于是就想着有没有自动化的方式来自动添加和更新安全组/防火墙规则呢？</p><h2 id="Terraform"><a href="#Terraform" class="headerlink" title="Terraform"></a>Terraform</h2><p>第一个想到的方案便是 terraform，主流的云厂商都有对应的 provider 支持，腾讯云应该也是能够支持的。不过看了官方的 <a href="https://github.com/tencentcloudstack/terraform-provider-tencentcloud" target="_blank" rel="noopener">terraform-provider-tencentcloud</a> repo 文档之后，并没有找到给 lighthouse 主机配置防火墙规则的支持，遂放弃。</p><h2 id="cfwctl"><a href="#cfwctl" class="headerlink" title="cfwctl"></a>cfwctl</h2><p>既然 terraform 不支持，那就自己造轮子写一个吧，就叫它 Cloud Firewall Control Tool，简称 <a href="https://github.com/muzi502/cfwctl" target="_blank" rel="noopener">cfwctl</a>。腾讯云官方的 API 文档还可以，还能在线生成代码，用起来也十分方便。考虑到会将该工具运行到运行到 arm64 的路由器上，因此跨平台运行 cfwctl 使用 golang 来实现无疑是个不错的选择，正好也能来练练手。</p><p>执行的操作其实很简单，先是通过某种方式获取本地机器的公网 IP，然后将该 IP 添加到对应实例的防火墙规则当中，并在规则描述中添加标识符来标记。目前自己只需要添加规则，先凑活着用一段时间，看下效果如何。目前只支持腾讯云的 lighthouse 实例，后续有机会再增加几个别的云厂商支持。</p><h3 id="获取公网-IP"><a href="#获取公网-IP" class="headerlink" title="获取公网 IP"></a>获取公网 IP</h3><p>首先要获取到我们本地网路的公网 IP，由于公网 IP 可能一直是变化的，所以我们每次更新防火墙规则之前都需要获取最新的公网 IP。以下是具体实现的代码：</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"io/ioutil"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line"><span class="string">"regexp"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 IPv4 的正则表达式，目的是从获取公网 IP 的  API 返回结果中过滤出 IPv4 地址</span></span><br><span class="line"><span class="keyword">const</span> ipv4_regex = <span class="string">`(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))&#123;3&#125;`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义几个几个提供获取公网 IPv4 地址的 API URL</span></span><br><span class="line"><span class="keyword">var</span> urlList = []<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"https://ip.me"</span></span><br><span class="line"><span class="string">"http://ip.sb"</span>,</span><br><span class="line"><span class="string">"http://ip.cip.cc"</span>,</span><br><span class="line"><span class="string">"http://myip.ipip.net"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetPublicIP</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, url := <span class="keyword">range</span> urlList &#123;</span><br><span class="line">    <span class="comment">// 创建一个 http client</span></span><br><span class="line">client := &amp;http.Client&#123;&#125;</span><br><span class="line">    <span class="comment">// 设置 client 的请求方法为 GET 以及请求的 URL</span></span><br><span class="line">request, err := http.NewRequest(<span class="string">"GET"</span>, url, <span class="literal">nil</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// 设置 Client 的 User-Agent 为 curl，不然一些 API 会返回 html 的结果</span></span><br><span class="line">request.Header.Set(<span class="string">"User-Agent"</span>, <span class="string">"curl/7.54.0"</span>)</span><br><span class="line">resp, err := client.Do(request)</span><br><span class="line"><span class="keyword">if</span> resp.StatusCode != <span class="number">200</span> &amp;&amp; err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">body, err := ioutil.ReadAll(resp.Body)</span><br><span class="line">    <span class="comment">// 从 API 返回结果中用正则匹配出 IPv4 地址</span></span><br><span class="line">reg := regexp.MustCompile(ipv4_regex)</span><br><span class="line">ipList := reg.FindAllString(<span class="keyword">string</span>(body), <span class="number">-1</span>)</span><br><span class="line">    <span class="comment">// 如果匹配结果中有 IPv4 地址，则返回第一个元素即可</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(ipList) &gt; <span class="number">0</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"my public ip is %s\n"</span>, ipList[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">return</span> ipList[<span class="number">0</span>]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="添加-Firewall-规则"><a href="#添加-Firewall-规则" class="headerlink" title="添加 Firewall 规则"></a>添加 Firewall 规则</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/common"</span></span><br><span class="line"><span class="string">"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/common/errors"</span></span><br><span class="line"><span class="string">"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/common/profile"</span></span><br><span class="line">lighthouse <span class="string">"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/lighthouse/v20200324"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 API 请求的 URL</span></span><br><span class="line"><span class="keyword">const</span> endpoint = <span class="string">"lighthouse.tencentcloudapi.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义请求 API 的 Client 结构体</span></span><br><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> &#123;</span><br><span class="line">SecretId  <span class="keyword">string</span></span><br><span class="line">SecretKey <span class="keyword">string</span></span><br><span class="line">InstaceId <span class="keyword">string</span></span><br><span class="line">Region    <span class="keyword">string</span></span><br><span class="line">Endpoint  <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过该方法从环境变量中读取 Ck Sk 等信息，并返回一个 client 对象</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewClient</span><span class="params">()</span> <span class="title">Client</span></span> &#123;</span><br><span class="line">client := Client&#123;</span><br><span class="line">SecretId:  os.Getenv(<span class="string">"TENCENTCLOUD_SECRET_ID"</span>),</span><br><span class="line">SecretKey: os.Getenv(<span class="string">"TENCENTCLOUD_SECRET_KEY"</span>),</span><br><span class="line">InstaceId: os.Getenv(<span class="string">"TENCENTCLOUD_INSTANCE_ID"</span>),</span><br><span class="line">Region:    os.Getenv(<span class="string">"TENCENTCLOUD_REGION"</span>),</span><br><span class="line">Endpoint:  endpoint,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> client.SecretId == <span class="string">""</span> || client.SecretKey == <span class="string">""</span> || client.InstaceId == <span class="string">""</span> || client.Region == <span class="string">""</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">"Please set TENCENTCLOUD_SECRET_ID, TENCENTCLOUD_SECRET_KEY, TENCENTCLOUD_INSTANCE_ID, TENCENTCLOUD_REGION"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义添加防火墙规则的方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Client)</span> <span class="title">AddRules</span><span class="params">(firewallRules []*lighthouse.FirewallRule)</span></span> &#123;</span><br><span class="line">credential := common.NewCredential(c.SecretId, c.SecretKey)</span><br><span class="line">cpf := profile.NewClientProfile()</span><br><span class="line">cpf.HttpProfile.Endpoint = endpoint</span><br><span class="line">client, _ := lighthouse.NewClient(credential, c.Region, cpf)</span><br><span class="line"></span><br><span class="line">request := lighthouse.NewCreateFirewallRulesRequest()</span><br><span class="line">request.InstanceId = common.StringPtr(c.InstaceId)</span><br><span class="line">request.FirewallRules = firewallRules</span><br><span class="line"></span><br><span class="line">response, err := client.CreateFirewallRules(request)</span><br><span class="line"><span class="keyword">if</span> _, ok := err.(*errors.TencentCloudSDKError); ok &#123;</span><br><span class="line">fmt.Printf(<span class="string">"An API error has returned: %s"</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">"%s"</span>, response.ToJsonString())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="获取防火墙规则"><a href="#获取防火墙规则" class="headerlink" title="获取防火墙规则"></a>获取防火墙规则</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Client)</span> <span class="title">GetRules</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">credential := common.NewCredential(c.SecretId, c.SecretKey)</span><br><span class="line">cpf := profile.NewClientProfile()</span><br><span class="line">cpf.HttpProfile.Endpoint = endpoint</span><br><span class="line">client, _ := lighthouse.NewClient(credential, c.Region, cpf)</span><br><span class="line"></span><br><span class="line">request := lighthouse.NewDescribeFirewallRulesRequest()</span><br><span class="line"></span><br><span class="line">request.InstanceId = common.StringPtr(c.InstaceId)</span><br><span class="line"></span><br><span class="line">response, err := client.DescribeFirewallRules(request)</span><br><span class="line"><span class="keyword">if</span> _, ok := err.(*errors.TencentCloudSDKError); ok &#123;</span><br><span class="line">fmt.Printf(<span class="string">"An API error has returned: %s"</span>, err)</span><br><span class="line"><span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> response.ToJsonString()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ul><li>在本地的 <code>~/.bashrc</code> 或者 <code>~/.zshrc</code> 文件中设置一些 AKSK 信息、实例 ID、region 信息等参数；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> TENCENTCLOUD_SECRET_ID=<span class="string">"AKiiiplQntjJbcMp1"</span></span><br><span class="line"><span class="built_in">export</span> TENCENTCLOUD_SECRET_KEY=<span class="string">"SKkkkiiwwlwjmmG5"</span></span><br><span class="line"><span class="built_in">export</span> TENCENTCLOUD_INSTANCE_ID=<span class="string">"lhins-qjxazjaa"</span></span><br><span class="line"><span class="built_in">export</span> TENCENTCLOUD_REGION=<span class="string">"ap-beijing"</span></span><br></pre></td></tr></table></figure><ul><li>设置好环境变量之后，再编译运行看下能否成功</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ go build -o cfwctl</span><br><span class="line">$ chmod +x cfwctl</span><br><span class="line">$ cfwctl add</span><br><span class="line"></span><br><span class="line">my public ip is 193.191.231.82</span><br><span class="line">&#123;<span class="string">"Response"</span>:&#123;<span class="string">"RequestId"</span>:<span class="string">"30e71243-1793-112e-9e41-b310ec599b90"</span>&#125;&#125;%</span><br></pre></td></tr></table></figure><ul><li>如果是 arm64 的 OpenWrt 环境，在本地开发机上进行跨平台编译，然后将编译好的 cfwctl 二进制文件 scp 到路由器上，再添加 cron job 定时任务即可，这样就能自动定时更新防火墙规则来。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ CGO_ENABLED=0  GOOS=linux  GOARCH=arm64 go build -o cfwctl</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;上次去北京出差，为了便捷地访问家里内网中的一些服务，就在腾
        
      
    
    </summary>
    
    
      <category term="技术" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="云服务器" scheme="https://blog.k8s.li/tags/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>Python 处理 kindle 标注文本</title>
    <link href="https://blog.k8s.li/python-kindle.html"/>
    <id>https://blog.k8s.li/python-kindle.html</id>
    <published>2021-11-29T16:00:00.000Z</published>
    <updated>2022-04-29T12:23:49.332Z</updated>
    
    <content type="html"><![CDATA[<h2 id="kindle-标注"><a href="#kindle-标注" class="headerlink" title="kindle 标注"></a>kindle 标注</h2><p>大学毕业之后不再像在校时那样能随便去图书馆看书，就从传统纸质书的阅转换到了 kindle 上来。这两年就一直习惯使用 kindle 来看书，读书过程中遇到一些不错的句子或段落往往会标注记录下来。这样时间一长，现在的 Kindle 上就积累了 共 189 本书和 3522 条笔记 😂。本人有个习惯就是会进行笔记整理，通过这些标注来回忆当时读书时的一些想法，整理一下读书笔记。Kindle 标注的文本都是以 txt 格式方式存储在 Kindle 的 <code>/documents/My Clippings.txt</code> 文件中。由于 txt 格式的文本数据阅读起来实在是太费劲了，于是之前参考了 <a href="https://github.com/cyang812/kindleNote" target="_blank" rel="noopener">kindleNote</a> 和 <a href="https://bookfere.com/tools#ClippingsFere" target="_blank" rel="noopener">书伴网 Clippings Fere 工具</a> 缝合了一个工具 <strong><a href="https://github.com/muzi502/kindle" target="_blank" rel="noopener">muzi502/kindle</a></strong>。用它来将 txt 格式的标注文本渲染成 html 的格式。这样每一本书就能有一个单独的 html 页面来展示标注的内容，阅读起来就十分方便。最近花了点时间重构了一下该工具，并新增了 svg 日历图的生成方式，本文就介绍一下这个工具的实现思路和方法。</p><h2 id="分隔"><a href="#分隔" class="headerlink" title="分隔"></a>分隔</h2><p>由于 Kindle 的标注文本有一定的规律可循，实现起来还是比较方便滴。大致思路就是先读取 Kindle 的标注文件 <code>My Clippings.txt</code>，然后根据分隔符 <code>==========</code> 分割每一个标注；每个标注包含着书名、标注时间、标注内容等信息，规律如下：</p><ul><li>第一行：书籍的名称以及作者，可以以半角括号来拆分出书名和作者；</li><li>第二行：标注的位置和时间，以 <code>|</code> 拆分出标注位置和标注时间；</li><li>第三行：空行，可以将这一行去除掉，即取出标注文件中所有的空行；</li><li>第四行：标注文本内容，Kindle 标注的正文是没有换行的，即便是连续标注了几段也都会压缩在一行里面；</li><li>第五行： 即分隔符 <code>==========</code> ，所有的标注都是以它来进行分隔；</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">娱乐至死 ([美]尼尔·波兹曼)</span><br><span class="line">- 您在位置 <span class="comment">#109-110的标注 | 添加于 2019年10月27日星期日 下午11:09:01</span></span><br><span class="line"></span><br><span class="line">电视需要的内容和其他媒体截然不同。电视无法表现政治哲学，电视的形式注定了它同政治哲学是水火不相容的。</span><br><span class="line">==========</span><br><span class="line">娱乐至死 ([美]尼尔·波兹曼)</span><br><span class="line">- 您在位置 <span class="comment">#110-112的标注 | 添加于 2019年10月27日星期日 下午11:09:19</span></span><br><span class="line"></span><br><span class="line">信息、内容，或者如果你愿意，可以称之为构成“今日新闻”的“素材”，在一个缺乏媒介的世界里是不存在的——是不能存在的。</span><br><span class="line">==========</span><br><span class="line">娱乐至死 ([美]尼尔·波兹曼)</span><br><span class="line">- 您在位置 <span class="comment">#114-115的标注 | 添加于 2019年10月27日星期日 下午11:09:52</span></span><br><span class="line"></span><br><span class="line">电报使无背景的信息能够以难以置信的速度跨越广阔的空间。</span><br><span class="line">==========</span><br><span class="line">通往奴役之路 (弗里德里希·奥古斯特·冯·哈耶克)</span><br><span class="line">- 您在位置 <span class="comment">#259-261的标注 | 添加于 2019年11月8日星期五 下午12:50:33</span></span><br><span class="line"></span><br><span class="line">在安排我们的事务时，应该尽可能多地运用自发的社会力量，而尽可能少地借助于强制，这个基本原则能够作千变万化的应用。深思熟虑地创造一种使竞争能尽可能地有益进行的体制，和被动地接受既定的制度，二者之间的差别尤其悬殊。</span><br><span class="line">==========</span><br><span class="line">通往奴役之路 (弗里德里希·奥古斯特·冯·哈耶克)</span><br><span class="line">- 您在位置 <span class="comment">#312-318的标注 | 添加于 2019年11月8日星期五 下午12:54:46</span></span><br><span class="line"></span><br><span class="line">尽管绝大部分的新思想，尤其是社会主义，并非起源于德国，但正是在德国它们得到完善，并在19世纪的最后25年和20世纪的最初25年，得到最充分的发展。现在，人们常常忽略了，德国在这一时期社会主义的理论和实际的发展中起了多么巨大的领导作用；在社会主义成为这个国家的一个严重问题以前的那一代，德国国会中已有一个很大的社会主义政党；并且在不久以前，社会主义学说的发展，几乎完全是在德国和奥地利进行的，以致于今天俄国人的讨论，在很大程度上是从德国人中止的地方进行的；绝大部分英国的社会主义者尚未意识到，他们才开始发现的大多数问题，德国社会主义者很早以前已彻底讨论过了。</span><br><span class="line">==========</span><br><span class="line">见识城邦·童年的消逝（媒介文化研究大师尼尔·波兹曼20年经典畅销作品） (尼尔·波兹曼)</span><br><span class="line">- 您在位置 <span class="comment">#536-539的标注 | 添加于 2019年11月21日星期四 上午6:47:26</span></span><br><span class="line"></span><br><span class="line">列奥·洛文塔尔（Leo Lowenthal）说道：“自从文艺复兴以来，关于人类本性的普遍哲学是建立在这样的构想之上的：每个个人都是离经叛道者。在很大程度上，个人的存在就在于坚持个性，反对社会的限制和规范要求。”</span><br><span class="line">==========</span><br></pre></td></tr></table></figure><ul><li>首先定义一个书籍列表，列表中的每个元素为一个字典，字典中记录的信息如下：</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"name"</span>: book_name,</span><br><span class="line">    <span class="attr">"author"</span>: book_author,</span><br><span class="line">    <span class="attr">"url"</span>: book_url,</span><br><span class="line">    <span class="attr">"nums"</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">"marks"</span>: [],</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>每本书的标注列表</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"time"</span>: mark_time,</span><br><span class="line">    <span class="attr">"address"</span>: mark_address,</span><br><span class="line">    <span class="attr">"content"</span>: mark_content</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>转换后的 json 格式</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"娱乐至死 "</span>,</span><br><span class="line">    <span class="attr">"author"</span>: <span class="string">"尼尔·波兹曼"</span>,</span><br><span class="line">    <span class="attr">"url"</span>: <span class="string">"dd0875de349e84eb7e6a2402c64bd95a"</span>,</span><br><span class="line">    <span class="attr">"nums"</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">"marks"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"time"</span>: <span class="string">" 添加于 2019年10月27日星期日 下午11:09:01"</span>,</span><br><span class="line">        <span class="attr">"address"</span>: <span class="string">"您在位置 #109-110的标注"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"电视需要的内容和其他媒体截然不同。电视无法表现政治哲学，电视的形式注定了它同政治哲学是水火不相容的。"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"time"</span>: <span class="string">" 添加于 2019年10月27日星期日 下午11:09:19"</span>,</span><br><span class="line">        <span class="attr">"address"</span>: <span class="string">"您在位置 #110-112的标注"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"信息、内容，或者如果你愿意，可以称之为构成“今日新闻”的“素材”，在一个缺乏媒介的世界里是不存在的——是不能存在的。"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"time"</span>: <span class="string">" 添加于 2019年10月27日星期日 下午11:09:52"</span>,</span><br><span class="line">        <span class="attr">"address"</span>: <span class="string">"您在位置 #114-115的标注"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"电报使无背景的信息能够以难以置信的速度跨越广阔的空间。"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"通往奴役之路 "</span>,</span><br><span class="line">    <span class="attr">"author"</span>: <span class="string">"弗里德里希·奥古斯特·冯·哈耶克"</span>,</span><br><span class="line">    <span class="attr">"url"</span>: <span class="string">"646a2a825b48c4c9df653a42aa72b702"</span>,</span><br><span class="line">    <span class="attr">"nums"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"marks"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"time"</span>: <span class="string">" 添加于 2019年11月8日星期五 下午12:50:33"</span>,</span><br><span class="line">        <span class="attr">"address"</span>: <span class="string">"您在位置 #259-261的标注"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"在安排我们的事务时，应该尽可能多地运用自发的社会力量，而尽可能少地借助于强制，这个基本原则能够作千变万化的应用。深思熟虑地创造一种使竞争能尽可能地有益进行的体制，和被动地接受既定的制度，二者之间的差别尤其悬殊。"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"time"</span>: <span class="string">" 添加于 2019年11月8日星期五 下午12:54:46"</span>,</span><br><span class="line">        <span class="attr">"address"</span>: <span class="string">"您在位置 #312-318的标注"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"尽管绝大部分的新思想，尤其是社会主义，并非起源于德国，但正是在德国它们得到完善，并在19世纪的最后25年和20世纪的最初25年，得到最充分的发展。现在，人们常常忽略了，德国在这一时期社会主义的理论和实际的发展中起了多么巨大的领导作用；在社会主义成为这个国家的一个严重问题以前的那一代，德国国会中已有一个很大的社会主义政党；并且在不久以前，社会主义学说的发展，几乎完全是在德国和奥地利进行的，以致于今天俄国人的讨论，在很大程度上是从德国人中止的地方进行的；绝大部分英国的社会主义者尚未意识到，他们才开始发现的大多数问题，德国社会主义者很早以前已彻底讨论过了。"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"见识城邦·童年的消逝"</span>,</span><br><span class="line">    <span class="attr">"author"</span>: <span class="string">"尼尔·波兹曼"</span>,</span><br><span class="line">    <span class="attr">"url"</span>: <span class="string">"1e1c307ca9d857c047d33df2a808e557"</span>,</span><br><span class="line">    <span class="attr">"nums"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"marks"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"time"</span>: <span class="string">" 添加于 2019年11月21日星期四 上午6:47:26"</span>,</span><br><span class="line">        <span class="attr">"address"</span>: <span class="string">"您在位置 #536-539的标注"</span>,</span><br><span class="line">        <span class="attr">"content"</span>: <span class="string">"列奥·洛文塔尔（Leo Lowenthal）说道：“自从文艺复兴以来，关于人类本性的普遍哲学是建立在这样的构想之上的：每个个人都是离经叛道者。在很大程度上，个人的存在就在于坚持个性，反对社会的限制和规范要求。”"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h2 id="txt-to-json"><a href="#txt-to-json" class="headerlink" title="txt to json"></a>txt to json</h2><p>有了上面的思路之后，我们就可以对 Kindle 的标注文本进行处理。先将 txt 格式的文本转换成 json 结构化的数据。然后再使用这个结构化的 json 进行后续的处理操作。对于文本的处理，选择 Python 比较合适。因为在 Python 中字符串对象有很多操作方法，比如分割、匹配、替换等等，都要比其他语言方便一些；以下就是具体实现的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义分隔符</span></span><br><span class="line">DELIMITER = <span class="string">u"==========\n"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照分隔符对所有标注进行分割，并存放在该数组中</span></span><br><span class="line">all_marks = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照书籍来对标注进行分组存放</span></span><br><span class="line">all_books = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义一个函数用于获取当前书籍在 all_books 列表中的索引</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_book_index</span><span class="params">(book_name)</span>:</span></span><br><span class="line">    <span class="string">"""get book's index"""</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(all_books)):</span><br><span class="line">        <span class="keyword">if</span> all_books[i][<span class="string">"name"</span>] == book_name:</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="comment"># 如果书籍并不存在，说明还没有插入该元素，就将该元素插入到最后一个元素</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义渲染处理标注文本的函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_clippings</span><span class="params">(file_name)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> all_marks</span><br><span class="line">    <span class="keyword">global</span> all_books</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 以 utf-8 格式打开标注文件并并将内容读取到 content 变量中</span></span><br><span class="line">    <span class="keyword">with</span> open(file_name, <span class="string">"r"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = f.read()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对读入的内容去除空行，即将 '\n\n' 替换为 '\n'，方便后续处理</span></span><br><span class="line">    content = content.replace(<span class="string">"\n\n"</span>, <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对去除空行的内容以分隔符进行分隔，得到的是一个列表，每个元素就是一个标注</span></span><br><span class="line">    all_marks = content.split(DELIMITER)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(all_marks)):</span><br><span class="line">        <span class="comment"># 以换行符进行分隔，将每个标注拆分成四个元素</span></span><br><span class="line">        mark = all_marks[i].split(<span class="string">"\n"</span>)</span><br><span class="line">        <span class="comment"># 如果该标注中元素的数量为 4 说明就是一个正确的标注，否则就是无效的</span></span><br><span class="line">        <span class="keyword">if</span> len(mark) == <span class="number">4</span>:</span><br><span class="line"></span><br><span class="line">          <span class="comment"># 对标注的第一个元素，即书名部分进行 md5 计算，用于将它设置为后续的 url 路径，以及 html 文件名</span></span><br><span class="line">            book_url = md5(mark[<span class="number">0</span>].encode(<span class="string">"utf-8"</span>)).hexdigest()</span><br><span class="line">            <span class="comment"># 去除掉书名中一些特殊的字符，用来拆分出简短的书名</span></span><br><span class="line">            book_info = re.split(<span class="string">r"[()&lt;&gt;|\[\]（）《》【】｜]\s*"</span>, mark[<span class="number">0</span>])</span><br><span class="line">            <span class="comment"># 获取书名，一般为第一个元素，目的是为了去除 kinlde 中文商店下载的又长又臭的书名</span></span><br><span class="line">            book_name = book_info[<span class="number">0</span>] <span class="keyword">if</span> str(book_info[<span class="number">0</span>]) != <span class="string">""</span> <span class="keyword">else</span> (mark[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 获取该书的作者</span></span><br><span class="line">            book_author = book_info[<span class="number">-2</span>] <span class="keyword">if</span> len(book_info) &gt; <span class="number">1</span> <span class="keyword">else</span> <span class="string">""</span></span><br><span class="line"></span><br><span class="line">            mark_info = mark[<span class="number">1</span>].split(<span class="string">"|"</span>)</span><br><span class="line">  <span class="comment"># 获取该书的标记时间和标注位置</span></span><br><span class="line">            mark_time = mark_info[<span class="number">1</span>]</span><br><span class="line">            mark_address = mark_info[<span class="number">0</span>].strip(<span class="string">"- "</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 获取该标注的正文内容</span></span><br><span class="line">            mark_content = mark[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 查询该书的列表索引，将该标记插入到该书的 marks 列表中</span></span><br><span class="line">            book_index = get_book_index(book_name)</span><br><span class="line">            <span class="keyword">if</span> book_index == <span class="number">-1</span>:</span><br><span class="line">                all_books.append(</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">"name"</span>: book_name,</span><br><span class="line">                        <span class="string">"author"</span>: book_author,</span><br><span class="line">                        <span class="string">"url"</span>: book_url,</span><br><span class="line">                        <span class="string">"nums"</span>: <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"marks"</span>: [],</span><br><span class="line">                    &#125;</span><br><span class="line">                )</span><br><span class="line">            all_books[book_index][<span class="string">"marks"</span>].append(</span><br><span class="line">                &#123;<span class="string">"time"</span>: mark_time, <span class="string">"address"</span>: mark_address, <span class="string">"content"</span>: mark_content&#125;</span><br><span class="line">            )</span><br><span class="line">            <span class="comment"># 更新该书的标记数量</span></span><br><span class="line">            all_books[book_index][<span class="string">"nums"</span>] += <span class="number">1</span></span><br><span class="line">    <span class="comment"># 使用 lambda 函数以标注数量为 key 对所有书籍进行倒序排序</span></span><br><span class="line">    all_books.sort(key=<span class="keyword">lambda</span> x: x[<span class="string">"nums"</span>], reverse=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 以下就是将 all_books 列表以 json 格式写入到一个 json 文件中，或许会有一些其他的用途，比如前端展示</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        json_str = json.dumps(all_books, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">"clippings.json"</span>, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(json_str)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    file_path = <span class="string">"source.txt"</span> <span class="keyword">if</span> len(sys.argv) == <span class="number">1</span> <span class="keyword">else</span> sys.argv[<span class="number">1</span>]</span><br><span class="line">    render_clippings(file_path)</span><br></pre></td></tr></table></figure><h2 id="json-to-html"><a href="#json-to-html" class="headerlink" title="json to html"></a>json to html</h2><p>接下来再将上述得到的 json 内容写入到 html 文件中。渲染 html 的方式有两种，一种是通过 jinja2 的模版进行渲染，一种是通过字符串替换拼凑 html 内容。两种各有各的好处，jinjia2 实现起来比较优雅一些，但是会引入一个 jinjia2 的依赖；第二种方式就无任何依赖，适用性回好一些；下面就讲一下使用第二种方式的实现；</p><ul><li>将 html 内容按照元素的分布进行拆分，定义如下几个几个特殊的变量</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">HTML_HEAD = <span class="string">"""&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;meta charset="utf-8" /&gt;</span></span><br><span class="line"><span class="string">&lt;title&gt; Kindle 读书笔记 &lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;</span></span><br><span class="line"><span class="string">&lt;link href="../style/css/bootstrap.min.css" rel="stylesheet" type="text/css" /&gt;</span></span><br><span class="line"><span class="string">&lt;link href="../style/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css" /&gt;</span></span><br><span class="line"><span class="string">&lt;link href="../style/css/custom.css" rel="stylesheet" type="text/css" /&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">INDEX_TITLE = <span class="string">"""</span></span><br><span class="line"><span class="string">&lt;div class="container"&gt;</span></span><br><span class="line"><span class="string">&lt;header class="header col-md-12"&gt;</span></span><br><span class="line"><span class="string">&lt;div class="page-header"&gt;</span></span><br><span class="line"><span class="string">                &lt;embed src="date.svg" type="image/svg+xml" /&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;&lt;small&gt;&lt;span class="glyphicon glyphicon-book" aria-hidden="true"&gt;&lt;/span&gt; Kindle 读书笔记 &lt;/small&gt; &lt;span class="badge"&gt;更新于 UPDATE &lt;/span&gt; &lt;span class="badge"&gt; 共 BOOKS_SUM 本书，SENTENCE_SUM 条笔记&lt;/span&gt;&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/header&gt;</span></span><br><span class="line"><span class="string">&lt;div class="col-md-12"&gt;</span></span><br><span class="line"><span class="string">        &lt;div class="list-group"&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">BOOK_TITLE = <span class="string">"""</span></span><br><span class="line"><span class="string">&lt;div class="container"&gt;</span></span><br><span class="line"><span class="string">&lt;header class="header col-md-12"&gt;</span></span><br><span class="line"><span class="string">&lt;div class="page-header"&gt;</span></span><br><span class="line"><span class="string">&lt;h1&gt;&lt;small&gt;&lt;span class="glyphicon glyphicon-book" aria-hidden="true"&gt;&lt;/span&gt;BookName&lt;/small&gt; &lt;span class="badge"&gt;&lt;/span&gt;&lt;/h1&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/header&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        &lt;div class="col-md-2"&gt;</span></span><br><span class="line"><span class="string">&lt;ul class="nav nav-pills nav-stacked go-back"&gt;</span></span><br><span class="line"><span class="string">&lt;li role="presentation" class="active text-center"&gt;</span></span><br><span class="line"><span class="string">&lt;a href="../index.html" style="border-radius: 50%;"&gt;&lt;span class="glyphicon glyphicon-backward" aria-hidden="true"&gt;&lt;/span&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;/ul&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">MARK_CONTENT = <span class="string">"""</span></span><br><span class="line"><span class="string">    &lt;div class="col-md-12"&gt;</span></span><br><span class="line"><span class="string">&lt;article&gt;</span></span><br><span class="line"><span class="string">&lt;div class="panel panel-default"&gt;</span></span><br><span class="line"><span class="string">&lt;div class="panel-body mk88"&gt;&lt;p&gt;SENTENCE_TXT</span></span><br><span class="line"><span class="string">                    &lt;/p&gt;&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;div class="panel-footer text-right"&gt;</span></span><br><span class="line"><span class="string">&lt;span class="label label-primary"&gt;&lt;span class="glyphicon glyphicon-tag" aria-hidden="true"&gt;&lt;/span&gt; 标注&lt;/span&gt;</span></span><br><span class="line"><span class="string">&lt;span class="label label-default"&gt;&lt;span class="glyphicon glyphicon-bookmark" aria-hidden="true"&gt;&lt;/span&gt;SENTENCE_ADDR&lt;/span&gt;</span></span><br><span class="line"><span class="string">&lt;span class="label label-default"&gt;&lt;span class="glyphicon glyphicon-time" aria-hidden="true"&gt;&lt;/span&gt;SENTENCE_TIME&lt;/span&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/article&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">ITEM_CONTENT = <span class="string">"""          &lt;a href="HTML_URL" class="list-group-item"&gt;&lt;span class="glyphicon glyphicon-book" aria-hidden="true"&gt;&lt;/span&gt;HTML_FILE_NAME&lt;span class="glyphicon glyphicon-tag" aria-hidden="true"&gt;SENTENCE_COUNT&lt;/span&gt;&lt;/a&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">FOOTER_CONTENT = <span class="string">"""</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure><ul><li>渲染 index.html 文件</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_index_html</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">"index.html"</span>, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(HTML_HEAD.replace(<span class="string">"../"</span>, <span class="string">""</span>))</span><br><span class="line">        <span class="comment"># 替换书籍的总数量和标注的总数量</span></span><br><span class="line">        f.write(</span><br><span class="line">            INDEX_TITLE.replace(<span class="string">"SENTENCE_SUM"</span>, str(len(all_marks)))</span><br><span class="line">            .replace(<span class="string">"UPDATE"</span>, time.strftime(<span class="string">"%Y-%m-%d %H:%M"</span>, time.localtime()))</span><br><span class="line">            .replace(<span class="string">"BOOKS_SUM"</span>, str(len(all_books)))</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 根据预先定义的标识字符替换每本书籍的书籍名、作者、标注数量、URL</span></span><br><span class="line">        <span class="keyword">for</span> book <span class="keyword">in</span> all_books:</span><br><span class="line">            f.write(</span><br><span class="line">                ITEM_CONTENT.replace(<span class="string">"HTML_URL"</span>, <span class="string">"books/"</span> + book[<span class="string">"url"</span>] + <span class="string">".html"</span>)</span><br><span class="line">                .replace(<span class="string">"HTML_FILE_NAME"</span>, book[<span class="string">"name"</span>] + <span class="string">" ["</span> + book[<span class="string">"author"</span>] + <span class="string">"]"</span>)</span><br><span class="line">                .replace(<span class="string">"SENTENCE_COUNT"</span>, str(book[<span class="string">"nums"</span>]))</span><br><span class="line">            )</span><br><span class="line">        f.write(FOOTER_CONTENT)</span><br></pre></td></tr></table></figure><ul><li>渲染 book 书籍页面</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_books_html</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> os.path.exists(<span class="string">"books"</span>):</span><br><span class="line">        shutil.rmtree(<span class="string">"books"</span>)</span><br><span class="line">    os.mkdir(<span class="string">"books"</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(all_books)):</span><br><span class="line">        book_url = all_books[i][<span class="string">"url"</span>]</span><br><span class="line">        book_name = all_books[i][<span class="string">"name"</span>]</span><br><span class="line">        book_author = all_books[i][<span class="string">"author"</span>]</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">"books/"</span> + book_url + <span class="string">".html"</span>, <span class="string">"w"</span>, encoding=<span class="string">"utf-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(HTML_HEAD)</span><br><span class="line">            f.write(</span><br><span class="line">                BOOK_TITLE.replace(<span class="string">"BookName"</span>, book_name + <span class="string">" ["</span> + book_author + <span class="string">"]"</span>)</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(len(all_books[i][<span class="string">"marks"</span>])):</span><br><span class="line">                mark = all_books[i][<span class="string">"marks"</span>][j]</span><br><span class="line">                f.write(</span><br><span class="line">                    MARK_CONTENT.replace(<span class="string">"SENTENCE_TXT"</span>, mark[<span class="string">"content"</span>])</span><br><span class="line">                    .replace(<span class="string">"SENTENCE_ADDR"</span>, mark[<span class="string">"address"</span>])</span><br><span class="line">                    .replace(<span class="string">"SENTENCE_TIME"</span>, mark[<span class="string">"time"</span>])</span><br><span class="line">                )</span><br><span class="line">            f.write(FOOTER_CONTENT)</span><br></pre></td></tr></table></figure><h2 id="date-to-svg"><a href="#date-to-svg" class="headerlink" title="date to svg"></a>date to svg</h2><p>前段时间看到 yihong 大佬的 <strong><a href="https://github.com/yihong0618/GitHubPoster" target="_blank" rel="noopener">GitHubPoster</a></strong> 支持了 json 格式的数据，只要提供类似类似如下格式的数据，就可以生成相应的 svg 了。真的是一个很棒的特性，这样我们就可以根据每天标记的数量来生成一个对应的 svg 图了。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"2019-05-28"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"2019-06-10"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"2019-07-18"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"2019-07-23"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"2019-07-24"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"2019-07-29"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"2019-08-12"</span>: <span class="number">1</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><blockquote class="twitter-tweet"><p lang="zh" dir="ltr">支持了自定义 json 的源数据，生成了某个 tg 现充群的群聊的 poster <a href="https://t.co/nhSe3qlVe0" target="_blank" rel="noopener">https://t.co/nhSe3qlVe0</a> <a href="https://t.co/bkijsFDtzC" target="_blank" rel="noopener">pic.twitter.com/bkijsFDtzC</a></p>&mdash; yihong0618 (@yihong0618) <a href="https://twitter.com/yihong0618/status/1466275108952051716?ref_src=twsrc%5Etfw" target="_blank" rel="noopener">December 2, 2021</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><ul><li>生成 <code>date.json</code> 数据文件</li></ul><p>生成一个{日期: 数量} 格式的字典其实挺简单，不过对于 kindle 标注的时间格式需要稍微处理一下，转换成一个标准的时间格式。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">render_date_json</span><span class="params">()</span>:</span></span><br><span class="line">    all_dates = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(all_marks)):</span><br><span class="line">        mark = all_marks[i].split(<span class="string">"\n"</span>)</span><br><span class="line">        <span class="comment"># 如果一个标注有 4 行说明它就是一个正确的标注</span></span><br><span class="line">        <span class="keyword">if</span> len(mark) == <span class="number">4</span>:</span><br><span class="line">            <span class="comment"># 第二行就是标注的时间，以年月日关键字进行分隔，第一个元素就是年，第二个就是月，第三个就是日</span></span><br><span class="line">            date = re.split(<span class="string">r"[年月日]\s*"</span>,mark[<span class="number">1</span>].split(<span class="string">"|"</span>)[<span class="number">1</span>].split(<span class="string">" "</span>)[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 在 1-9 月前面补充一个 0</span></span><br><span class="line">            month = date[<span class="number">1</span>] <span class="keyword">if</span> len(date[<span class="number">1</span>]) == <span class="number">2</span> <span class="keyword">else</span> <span class="string">"0"</span> + date[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 在 1-9 日前面补充一个 0</span></span><br><span class="line">            day = date[<span class="number">2</span>] <span class="keyword">if</span> len(date[<span class="number">2</span>]) == <span class="number">2</span> <span class="keyword">else</span> <span class="string">"0"</span> + date[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 最后拼凑成 2021-12-05 这样的时间格式</span></span><br><span class="line">            date = date[<span class="number">0</span>] + <span class="string">"-"</span> + month + <span class="string">"-"</span> + day</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果当前日期没有在字典中，则将它添加到字典中</span></span><br><span class="line">            <span class="keyword">if</span> date <span class="keyword">not</span> <span class="keyword">in</span> all_dates:</span><br><span class="line">                all_dates[date] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 对天数的 value 值进行自增 1</span></span><br><span class="line">            all_dates[date] += <span class="number">1</span></span><br><span class="line">    <span class="comment"># 将数据写入 json 文件当中</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        json_str = json.dumps(all_dates, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">"date.json"</span>, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(json_str)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>生成好 json 格式的数据之后，接下来我们就使用 GitHubPoster 来生成相应的 svg 文件。由于 GitHubPoster 的依赖项太多，且还没有支持 docker 方式来运行，在本地安装也不是很方便，因此为了方便起见我们将它放在 GitHub action 中运行。这样只要每次更新标注文本的源文件就可以自动更新 html 页面并生成最新的 svg 图片了。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Build</span> <span class="string">kindle</span> <span class="string">note</span> <span class="string">website</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">gh-pages</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Python</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-python@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">python-version:</span> <span class="number">3.6</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">dependencies</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="comment"># 安装 github_poster 及其依赖</span></span><br><span class="line">          <span class="string">pip3</span> <span class="string">install</span> <span class="string">-U</span> <span class="string">github_poster</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 生成 html 文件</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">.html</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">python3</span> <span class="string">kindle.py</span></span><br><span class="line"></span><br><span class="line">       <span class="comment"># 生成 svg 文件</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">svg</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">github_poster</span> <span class="string">json</span> <span class="string">--json_file</span> <span class="string">date.json</span> <span class="string">--year</span> <span class="number">2021</span> <span class="string">--me</span> <span class="string">kindleReading</span> <span class="string">--background-color</span> <span class="string">'#ffffff'</span></span><br><span class="line">          <span class="string">mv</span> <span class="string">OUT_FOLDER/json.svg</span> <span class="string">date.svg</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># 设置 commit 信息为 GitHub action bot，并提交 commit 和 push 到 origin 上</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Config</span> <span class="string">git</span> <span class="string">user</span> <span class="string">and</span> <span class="string">user.email</span> <span class="string">and</span> <span class="string">push</span> <span class="string">commit</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">git</span> <span class="string">config</span> <span class="string">user.name</span> <span class="string">github-actions</span></span><br><span class="line">          <span class="string">git</span> <span class="string">config</span> <span class="string">user.email</span> <span class="number">41898282</span><span class="string">+github-actions[bot]@users.noreply.github.com</span></span><br><span class="line">          <span class="string">git</span> <span class="string">add</span> <span class="string">.</span></span><br><span class="line">          <span class="string">git</span> <span class="string">commit</span> <span class="string">-am</span> <span class="string">"Auto build by GitHub Actions $(date)"</span></span><br><span class="line">          <span class="string">git</span> <span class="string">push</span> <span class="string">origin</span> <span class="string">-f</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;kindle-标注&quot;&gt;&lt;a
        
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>使用 apcupsd 完成 UPS 断电后 ESXi 稳妥关机方案</title>
    <link href="https://blog.k8s.li/apcupsd-on-openwrt-with-esxi.html"/>
    <id>https://blog.k8s.li/apcupsd-on-openwrt-with-esxi.html</id>
    <published>2021-10-24T16:00:00.000Z</published>
    <updated>2021-10-24T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="APC-UPS-BK650M2-CH"><a href="#APC-UPS-BK650M2-CH" class="headerlink" title="APC UPS BK650M2-CH"></a>APC UPS BK650M2-CH</h2><p>上个月还在杭州的时候，房东家里的空气开关出现了故障，导致每天停电十几次，我那一百多块钱捡来的垃圾 UPS 断电之后续命不到 5 分钟就凉凉了。来到上海换了新家后，准备花 500 元左右买个好一点的 UPS，给我的 NAS 服务器找个好伴侣。这次的 UPS 不再买一百块钱的垃圾货了，实在是太坑人了呜呜呜，那台垃圾 UPS 已经在闲鱼上 50 包邮卖掉了。</p><p>市面上 500 左右的畅销 UPS 无非就是施耐德 APC 的 <a href="https://www.apc.com/shop/cn/zh/products/APC-BACK-UPS-BK-650VA-4-2-USB-230V-USB-/P-BK650M2-CH" target="_blank" rel="noopener">BK650M2-CH</a> 和国产山特的 <a href="https://www.santak.com.cn/product/santak-tg-box-ups.html" target="_blank" rel="noopener">TG-BOX 600/850</a> 。两者价位差不太多，从配置上来看  <a href="https://www.santak.com.cn/product/santak-tg-box-ups.html" target="_blank" rel="noopener">TG-BOX 600/850</a> 稍微好一点。但考虑到 APC 的 apcupsd 在 Linux 平台上兼容性比较好，因此我最终还是选择了 <a href="https://www.apc.com/shop/cn/zh/products/APC-BACK-UPS-BK-650VA-4-2-USB-230V-USB-/P-BK650M2-CH" target="_blank" rel="noopener">BK650M2-CH</a> ；另一方面还是本人不太喜欢和信任国产货，被小粉红看到会不会被骂成恨国党（手动狗头。</p><p>之前在使用垃圾 UPS 的时候有过一个很 low 的 UPS 断电关机 NAS 的方案，就是通过 ping 的方式来判断是否停电，然后就预估个时间就断电关机。不过这种方案使用起来十分不方便，尤其是当网络抽风的时候，NAS 就无缘无故地关机了；或者有时候 UPS 电池用尽了，关机脚本还没有触发。因此还是需要通过 UPS 本身的串口协议来获取当前 UPS 的状态比较好一些，比用 ping 的方式高到不知道哪里去了。</p><h2 id="ESXi-USB-直通翻车"><a href="#ESXi-USB-直通翻车" class="headerlink" title="ESXi USB 直通翻车"></a>ESXi USB 直通翻车</h2><p>使用 UPS 自带的 USB 线缆插到 NAS 主机 USB 接口之后，ESXi 的 USB 设备列表里也能正确地识别到了该设备。但将该设备添加到 Linux 虚拟机上之后，apcupsd 却无法获取该 UPS 的设备信息，而且在内核日志中一直会出现 <code>USB disconnect</code> 的信息，emmm，怀疑是 ESXi 直通 USB 的问题，遂放弃。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[  124.759971] usb 1-2.1: USB disconnect, device number 4</span><br><span class="line">[  126.840674] usb 1-2.1: new full-speed USB device number 5 using uhci_hcd</span><br><span class="line">[  127.364001] usb 1-2.1: New USB device found, idVendor=051d, idProduct=0002, bcdDevice= 1.06</span><br><span class="line">[  127.364006] usb 1-2.1: New USB device strings: Mfr=1, Product=2, SerialNumber=3</span><br><span class="line">[  127.364009] usb 1-2.1: Product: Back-UPS BK650M2-CH FW:294803G -292804G</span><br><span class="line">[  127.364011] usb 1-2.1: Manufacturer: American Power Conversion</span><br><span class="line">[  127.364013] usb 1-2.1: SerialNumber: 9B2118A06920</span><br><span class="line">[  127.403811] hid-generic 0003:051D:0002.0003: hiddev0,hidraw1: USB HID v1.10 Device [American Power Conversion Back-UPS BK650M2-CH FW:294803G -292804G ] on usb-0000:02:01.0-2.1/input0</span><br><span class="line">[  248.394259] usb 1-2.1: USB disconnect, device number 5</span><br><span class="line">[  250.589751] usb 1-2.1: new full-speed USB device number 6 using uhci_hcd</span><br><span class="line">[  251.123039] usb 1-2.1: New USB device found, idVendor=051d, idProduct=0002, bcdDevice= 1.06</span><br><span class="line">[  251.123044] usb 1-2.1: New USB device strings: Mfr=1, Product=2, SerialNumber=3</span><br><span class="line">[  251.123048] usb 1-2.1: Product: Back-UPS BK650M2-CH FW:294803G -292804G</span><br><span class="line">[  251.123050] usb 1-2.1: Manufacturer: American Power Conversion</span><br><span class="line">[  251.123052] usb 1-2.1: SerialNumber: 9B2118A06920</span><br><span class="line">[  251.160223] hid-generic 0003:051D:0002.0004: hiddev0,hidraw1: USB HID v1.10 Device [American Power Conversion Back-UPS BK650M2-CH FW:294803G -292804G ] on usb-0000:02:01.0-2.1/input0</span><br><span class="line">[  268.621010] usb 1-2.1: USB disconnect, device number 6</span><br></pre></td></tr></table></figure><p>不幸 USB 直通给虚拟机的方案翻车了，于是想着要不将 USB 线缆连接到我的 R4S 软路由上 🤔️。连接到软路由上要比在 ESXi 主机上好一些，这样在来电之后写的监控脚本也能检测到 UPS 已经通电了，这样就可以自动启动 NAS 主机以及上面的一些 VM。于是就琢磨了以下的方案，线路图如下：</p><p><img src="https://p.k8s.li/2021-10-25-apcupsd-on-openwrt-with-esxi.png" alt="image-20211025224325577"></p><p>我的 NAS 服务器、交换机、R4S 软路由的电源都连接到 UPS 上。R6300v2 通过无线桥接的方式连接到房东家的  Wi-Fi。无线桥接之后，R6300v2 就变成了一台”无线交换机”，连接到它的设备将会从房东家 Wi-Fi 路由器的 DHCP 那里获取到同一网段的 IP。R4S 的 WAN 口通过网线连接到 R6300v2 的 LAN 口上，这样 R4S 就能通过 R6300v2 连接到房东家的 Wi-Fi，从而连接到公网。</p><p>在这里 R6300v2 的电源未使用 UPS，而通过市电连接，因为停电之后估计房东家的 Wi-Fi 也连不上，连接到 UPS 电源意义不大，其实也用不多少电。断电之后，运行在 R4S 软路由上的 apcupsd 进程会探测到 UPS 电源处于 offline 的状态。等到 UPS 剩余电量还剩 30% 时（或者其他自定义指标）就触发自己定义的断电关机脚本。然后剩余 30% 的电量就供给 R4S 软路由使用至少 5 个小时，这段时间应该很快就能来电。等监测到 UPS 通电之后，再触发自定义的 UPS 来电启动脚本。</p><p>大致的流程梳理好之后，那么接下来就开始搞事情。</p><h2 id="apcupsd-on-openwrt"><a href="#apcupsd-on-openwrt" class="headerlink" title="apcupsd on openwrt"></a>apcupsd on openwrt</h2><p>首先就是在 R4S openwrt 上安装和配置 apcupsd，安装和配置的详细内容可参考几万字的官方手册 <a href="http://www.apcupsd.org/manual/" target="_blank" rel="noopener">apcupsd.org/manual</a> （劝退 😂。</p><h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><p>先将 USP 自带的那根 USB 线缆 RJ45 的那一头查到 UPS 的上，再将 USB 那一头插到路由器的 USB 口上。</p><ul><li>安装 apcupsd 以及 usbutils 等相关依赖包</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ OpenWrt in ~ [21:00:20]</span></span><br><span class="line">$ opkg update</span><br><span class="line">$ opkg install usbutils kmod-hid kmod-hid-generic kmod-usb-hid apcupsd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装完之后，会在 /etc/apcupsd 目录下生成如下文件</span></span><br><span class="line"><span class="comment"># root @ OpenWrt in ~ [21:01:32]</span></span><br><span class="line">$ tree /etc/apcupsd</span><br><span class="line">/etc/apcupsd</span><br><span class="line">├── apccontrol <span class="comment"># UPS 状态触发脚本</span></span><br><span class="line">├── apcupsd.conf <span class="comment"># apcupsd 配置文件</span></span><br><span class="line">├── apcupsd_mail.conf <span class="comment"># email 发送配置文件，断电都断网了，有它也没啥用呀</span></span><br><span class="line">├── changeme <span class="comment"># UPS 需要进行充电时触发的脚本</span></span><br><span class="line">├── commfailure <span class="comment"># 连接 UPS 设备失败后触发的脚本</span></span><br><span class="line">├── commok <span class="comment"># 连接 UPS 设备之后触发的脚本</span></span><br><span class="line">├── offbattery <span class="comment"># UPS 来电之后触发的脚本</span></span><br><span class="line">└── onbattery <span class="comment"># 断电之后 UPS 进入使用电池状态后触发的脚本</span></span><br></pre></td></tr></table></figure><ul><li>使用 <code>lsusb</code> 或者 <code>dmesg</code> 命令查看 USB 设备是否正常连接以及内核加载 USB 设备的信息。如果 USB 设备能正常识别到，那就没问题啦。如果没出现的话，那就重启大法好！看看重启之后能不能识别到 UPS 设备信息。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ OpenWrt in ~ [21:04:29]</span></span><br><span class="line">$ lsusb</span><br><span class="line">Bus 005 Device 003: ID 051d:0002 American Power Conversion Uninterruptible Power Supply</span><br><span class="line"><span class="comment"># root @ OpenWrt in ~ [21:04:29]</span></span><br><span class="line">$ dmesg</span><br><span class="line">[   64.485003] usb 5-1: new full-speed USB device number 2 using xhci-hcd</span><br><span class="line">[   64.669133] hid-generic 0003:051D:0002.0001: hiddev96,hidraw0: USB HID v1.10 Device [American Power Conversion Back-UPS BK650M2-CH FW:294803G -292804G ] on usb-xhci-hcd.0.auto-1/input0</span><br><span class="line">[ 1260.590529] usb 5-1: USB disconnect, device number 2</span><br><span class="line">[ 1261.285846] usb 5-1: new full-speed USB device number 3 using xhci-hcd</span><br><span class="line">[ 1261.468989] hid-generic 0003:051D:0002.0002: hiddev96,hidraw0: USB HID v1.10 Device [American Power Conversion Back-UPS BK650M2-CH FW:294803G -292804G ] on usb-xhci-hcd.0.auto-1/input0</span><br></pre></td></tr></table></figure><ul><li>修改 <code>/etc/default/apcupsd</code></li></ul><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 因为不是使用 systemd 启动 apcupsd 的，需要将它修改为 yes</span></span><br><span class="line"><span class="attr">ISCONFIGURED</span>=<span class="literal">yes</span></span><br></pre></td></tr></table></figure><ul><li>配置 <code>/etc/apcupsd/apcupsd.conf</code></li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 养成好习惯，先备份一下远配置文件</span></span><br><span class="line">$ cp /etc/apcupsd/apcupsd.conf&#123;,.bak&#125;</span><br><span class="line">$ vim /etc/apcupsd/apcupsd.conf</span><br><span class="line"><span class="comment"># 自定义你的 UPS 名称，使用默认的也可以</span></span><br><span class="line">UPSNAME BK650M2-CH</span><br><span class="line"><span class="comment"># 设置 UPS 的连接线缆为 USB 模式</span></span><br><span class="line">UPSCABLE usb</span><br><span class="line"><span class="comment"># 设置 UPS 的通讯模式为 USB 模式</span></span><br><span class="line">UPSTYPE usb</span><br><span class="line"><span class="comment"># DEVICE 这行需要注释掉或者去掉 /dev/ttyS0</span></span><br><span class="line"><span class="comment"># DEVICE /dev/ttyS0</span></span><br><span class="line">NETSERVER on</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以下三个参数定义了何时触发 doshutdown 关机事件</span></span><br><span class="line"><span class="comment"># 当剩余电池电量低于指定百分比</span></span><br><span class="line">BATTERYLEVEL 30</span><br><span class="line"><span class="comment"># 当UPS内部计算的电池剩余运行时间低于指定的分钟数</span></span><br><span class="line">MINUTES 15</span><br><span class="line"><span class="comment"># 发生电源故障后，进入 UPS 电池模式时间</span></span><br><span class="line">TIMEOUT 0</span><br></pre></td></tr></table></figure><p>配置文件具体的参数信息可参考官方手册 <a href="http://www.apcupsd.org/manual/#configuration-directive-reference" target="_blank" rel="noopener">configuration-directive-reference</a>，一般情况下只需要配置上面我提到的那几个参数就可以，感兴趣的可以仔细阅读一些官方手册。</p><ul><li>开机自启</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /etc/init.d/apcupsd <span class="built_in">enable</span></span><br><span class="line">$ /etc/init.d/apcupsd start</span><br></pre></td></tr></table></figure><h3 id="UPS-状态参数"><a href="#UPS-状态参数" class="headerlink" title="UPS 状态参数"></a>UPS 状态参数</h3><ul><li>使用 <code>apcaccess</code> 查看是否能连接到 UPS 设备，以下是正常通电时的信息：</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ OpenWrt in ~ [21:04:29]</span></span><br><span class="line">$ apcaccess</span><br><span class="line">APC      : 001,036,0860</span><br><span class="line">DATE     : 2021-10-24 21:02:51 +0800</span><br><span class="line">HOSTNAME : OpenWrt</span><br><span class="line">VERSION  : 3.14.14 (31 May 2016) unknown</span><br><span class="line">UPSNAME  : ups1</span><br><span class="line">CABLE    : USB Cable</span><br><span class="line">DRIVER   : USB UPS Driver</span><br><span class="line">UPSMODE  : Stand Alone</span><br><span class="line">STARTTIME: 2021-10-24 21:02:49 +0800</span><br><span class="line">MODEL    : Back-UPS BK650M2-CH</span><br><span class="line">STATUS   : ONLINE</span><br><span class="line">LINEV    : 224.0 Volts</span><br><span class="line">LOADPCT  : 14.0 Percent</span><br><span class="line">BCHARGE  : 100.0 Percent</span><br><span class="line">TIMELEFT : 46.8 Minutes</span><br><span class="line">MBATTCHG : 5 Percent</span><br><span class="line">MINTIMEL : 3 Minutes</span><br><span class="line">MAXTIME  : 0 Seconds</span><br><span class="line">SENSE    : Low</span><br><span class="line">LOTRANS  : 160.0 Volts</span><br><span class="line">HITRANS  : 278.0 Volts</span><br><span class="line">ALARMDEL : 30 Seconds</span><br><span class="line">BATTV    : 13.5 Volts</span><br><span class="line">LASTXFER : No transfers since turnon</span><br><span class="line">NUMXFERS : 0</span><br><span class="line">TONBATT  : 0 Seconds</span><br><span class="line">CUMONBATT: 0 Seconds</span><br><span class="line">XOFFBATT : N/A</span><br><span class="line">SELFTEST : NO</span><br><span class="line">BATTDATE : 2001-01-01</span><br><span class="line">NOMINV   : 220 Volts</span><br><span class="line">NOMBATTV : 12.0 Volts</span><br><span class="line">NOMPOWER : 390 Watts</span><br><span class="line">FIRMWARE : 294803G -292804G</span><br><span class="line">END APC  : 2021-10-24 21:04:36 +0800</span><br></pre></td></tr></table></figure><ul><li>尝试拔下 UPS 电源，断电之后的状态信息</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root @ OpenWrt in ~ [21:06:39]</span></span><br><span class="line">$ apcaccess</span><br><span class="line">APC      : 001,037,0899</span><br><span class="line">DATE     : 2021-10-24 21:05:33 +0800</span><br><span class="line">HOSTNAME : OpenWrt</span><br><span class="line">VERSION  : 3.14.14 (31 May 2016) unknown</span><br><span class="line">UPSNAME  : ups1</span><br><span class="line">CABLE    : USB Cable</span><br><span class="line">DRIVER   : USB UPS Driver</span><br><span class="line">UPSMODE  : Stand Alone</span><br><span class="line">STARTTIME: 2021-10-24 21:02:49 +0800</span><br><span class="line">MODEL    : Back-UPS BK650M2-CH</span><br><span class="line">STATUS   : ONBATT</span><br><span class="line">LINEV    : 0.0 Volts</span><br><span class="line">LOADPCT  : 15.0 Percent</span><br><span class="line">BCHARGE  : 100.0 Percent</span><br><span class="line">TIMELEFT : 46.8 Minutes</span><br><span class="line">MBATTCHG : 5 Percent</span><br><span class="line">MINTIMEL : 3 Minutes</span><br><span class="line">MAXTIME  : 0 Seconds</span><br><span class="line">SENSE    : Low</span><br><span class="line">LOTRANS  : 160.0 Volts</span><br><span class="line">HITRANS  : 278.0 Volts</span><br><span class="line">ALARMDEL : 30 Seconds</span><br><span class="line">BATTV    : 12.8 Volts</span><br><span class="line">LASTXFER : No transfers since turnon</span><br><span class="line">NUMXFERS : 1</span><br><span class="line">XONBATT  : 2021-10-24 21:05:33 +0800</span><br><span class="line">TONBATT  : 27 Seconds</span><br><span class="line">CUMONBATT: 27 Seconds</span><br><span class="line">XOFFBATT : N/A</span><br><span class="line">SELFTEST : NO</span><br><span class="line">BATTDATE : 2001-01-01</span><br><span class="line">NOMINV   : 220 Volts</span><br><span class="line">NOMBATTV : 12.0 Volts</span><br><span class="line">NOMPOWER : 390 Watts</span><br><span class="line">FIRMWARE : 294803G -292804G</span><br><span class="line">END APC  : 2021-10-24 21:06:00 +0800</span><br></pre></td></tr></table></figure><p>全部的 UPS 状态参数可参考官方手册 <a href="http://www.apcupsd.org/manual/#status-report-fields" target="_blank" rel="noopener">status-report-fields</a> ，不过对于我们来讲，以下几个参数比较重要：</p><table><thead><tr><th>参数</th><th>意义</th><th>来电</th><th>断电</th></tr></thead><tbody><tr><td>STATUS</td><td>UPS 状态</td><td>ONLINE</td><td>ONBATT</td></tr><tr><td>LINEV</td><td>接入电压</td><td>224.0 Volts</td><td>0.0 Volts</td></tr><tr><td>BCHARGE</td><td>电池剩余</td><td>100.0 Percent</td><td>&lt; 100.0 Percent</td></tr><tr><td>XONBATT</td><td>上次</td><td>N/A</td><td>~</td></tr><tr><td>TONBATT</td><td>当前电池使用时间</td><td>N/A</td><td>~</td></tr><tr><td>CUMONBATT</td><td>当前电池使用总时间</td><td>N/A</td><td>~</td></tr></tbody></table><h3 id="apccontrol"><a href="#apccontrol" class="headerlink" title="apccontrol"></a>apccontrol</h3><p><code>apccontrol</code> 里定义了 UPS 事件触发后要执行的操作，完整的内容可参考官方手册 <a href="http://www.apcupsd.org/manual/#customizing-event-handling" target="_blank" rel="noopener">apcupsd</a> 。对于我们来讲 <code>doshutdown</code> 这个事件是比较重要的：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">doshutdown</span><br><span class="line">When the UPS is running on batteries and one of the limits expires (time, run, load), this event is generated to cause the machine to shutdown.</span><br><span class="line"></span><br><span class="line">Default: Shuts down the system using shutdown -h or similar</span><br></pre></td></tr></table></figure><p>当出现如下事件的时候则会调用 doshutdown 后的执行内容：</p><ol><li>UPS 电池即将用尽</li><li>UPS 运行在电池模式下剩余时间低于所定义的 <code>MINUTES</code> 值</li><li>UPS 电池剩余百分比低于所定义的 <code>BATTERYLEVEL</code> 值</li><li>UPS. 运行在电池模式下所超出的时间 <code>TIMEOUT</code> 值</li></ol><blockquote><p>When one of the conditions listed below occurs, apcupsd issues a shutdown command by calling <code>/etc/apcupsd/apccontrol doshutdown</code>, which should perform a shutdown of your system using the system shutdown(8) command. You can modify the behavior as described in <a href="http://www.apcupsd.org/manual/#customizing-event-handling" target="_blank" rel="noopener">Customizing Event Handling</a>.</p><p>The conditions that trigger the shutdown can be any of the following:</p><ul><li>Running time on batteries have expired (<code>TIMEOUT</code>)</li><li>The battery runtime remaining is below the configured value (<code>BATTERYLEVEL</code>)</li><li>The estimated remaining runtime is below the configured value (<code>MINUTES</code>)</li><li>The UPS signals that the batteries are exhausted.</li></ul></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   doshutdown)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"UPS <span class="variable">$&#123;2&#125;</span> initiated Shutdown Sequence"</span> | <span class="variable">$&#123;WALL&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"apcupsd UPS <span class="variable">$&#123;2&#125;</span> initiated shutdown"</span></span><br><span class="line">bash /opt/bin/shutdown_esxi.sh</span><br><span class="line">;;</span><br></pre></td></tr></table></figure><p>然后我们就可以在 doshutdown 里面加入我们要执行的关机脚本，比如 <code>shutdown_esxi.sh</code>。至于如何优雅地关闭 ESXi 主机，推荐使用 govc 这个 CLI 工具。不太建议直接 ssh 到 ESXi 主机，然后 /sbin/shudown.sh &amp;&amp; poweroff 一把梭子就完事儿了。这样一顿操作猛有可能会对我们的虚拟机造成一定的影响，我们可以通过 govc 或者 vim-cmd 命令对虚拟机进行挂起或者保存快照的操作，来保存虚拟机断电之前的状态，等所有虚拟机安全关机之后，再关闭 ESXi 主机，这样比较稳妥一点。以下两种关闭 ESXi 的方式任选一种即即可：</p><h2 id="govc"><a href="#govc" class="headerlink" title="govc"></a>govc</h2><p>由于我的 apcupsd 是运行在 R4S 软路由上，如果将关机脚本保存在 R4S 软路由上，可以使用 govc 这个工具，然后通过 ESXi 的 https API 来对虚拟机和 ESXi 主机进行相关操作。</p><ul><li>下载并安装安装 govc</li></ul><p>在 <a href="https://github.com/vmware/govmomi/releases" target="_blank" rel="noopener">vmware/govmomi/releases</a> 下载页面找到与自己 CPU 体系架构相匹配的下载地址，比如我的 aarch64 的 CPU 使用如下地址：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/vmware/govmomi/releases/download/v0.27.1/govc_Linux_arm64.tar.gz</span><br><span class="line">$ tar xf govc_Linux_arm64.tar.gz</span><br><span class="line">$ mv govc /usr/bin</span><br></pre></td></tr></table></figure><ul><li>配置 ESXi 连接信息，使用 <code>govc host.info</code> 命令查看是否能正常连接到 ESXi 主机</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> GOVC_URL=<span class="string">"https://root:passw0rd@esxi.yoi.li"</span></span><br><span class="line">$ <span class="built_in">export</span> GOVC_DATASTORE=<span class="string">"NVME"</span></span><br><span class="line"></span><br><span class="line">$ govc host.info</span><br><span class="line">Name:              hp-esxi.lan</span><br><span class="line">  Path:            /ha-datacenter/host/hp-esxi.lan/hp-esxi.lan</span><br><span class="line">  Manufacturer:    HPE</span><br><span class="line">  Logical CPUs:    6 CPUs @ 3000MHz</span><br><span class="line">  Processor <span class="built_in">type</span>:  Genuine Intel(R) CPU 0000 @ 3.00GHz</span><br><span class="line">  CPU usage:       960 MHz (5.3%)</span><br><span class="line">  Memory:          32613MB</span><br><span class="line">  Memory usage:    29512 MB (90.5%)</span><br><span class="line">  Boot time:       2021-10-24 13:57:04.396892 +0000 UTC</span><br><span class="line">  State:           connected</span><br></pre></td></tr></table></figure><ul><li>获取 ESXi 主机上虚拟机的列表</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ govc ls /ha-datacenter/vm</span><br><span class="line">/ha-datacenter/vm/NAS</span><br><span class="line">/ha-datacenter/vm/kube-control-02</span><br><span class="line">/ha-datacenter/vm/kube-control-03</span><br><span class="line">/ha-datacenter/vm/kube-node-01</span><br><span class="line">/ha-datacenter/vm/kube-registry-01</span><br><span class="line">/ha-datacenter/vm/WG0</span><br><span class="line">/ha-datacenter/vm/Windows</span><br><span class="line">/ha-datacenter/vm/OP</span><br><span class="line">/ha-datacenter/vm/Devbox</span><br><span class="line">/ha-datacenter/vm/kube-control-01</span><br></pre></td></tr></table></figure><ul><li>VM 的电源相关操作</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将虚拟机挂起</span></span><br><span class="line">$ govc vm.power -s NAS</span><br></pre></td></tr></table></figure><ul><li>在 VM 里执行命令</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先设置终端登录的用户名和密码</span></span><br><span class="line">$ <span class="built_in">export</span> GOVC_GUEST_LOGIN=<span class="string">"root:passw0rd"</span></span><br><span class="line"><span class="comment"># 先让缓冲区数据写入到磁盘，然后再使用 shutdown 安全地关机</span></span><br><span class="line">$ govc guest.run -vm NAS <span class="string">"sync &amp;&amp; shutdown -h now"</span></span><br></pre></td></tr></table></figure><ul><li>使用 esxcli 命令查看 VM 进程，以确保虚拟机真正的关闭了。只有当 esxcli vm process list 输出结果为空的时候，ESXi 上所有的 VM 才真正的退出，这时就可以放心大胆地关闭 ESXi 主机了。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">╭─root@esxi-debian-devbox ~</span><br><span class="line">╰─<span class="comment"># govc host.esxcli vm process list</span></span><br><span class="line">ConfigFile:   /vmfs/volumes/6118f30c-3e1989cb-77c4-b47af1db548c/NAS/NAS.vmx</span><br><span class="line">DisplayName:  NAS</span><br><span class="line">ProcessID:    0</span><br><span class="line">UUID:         56 4d 7a 57 4c 17 4e 68-07 25 03 5e 4b 0f 8c 96</span><br><span class="line">VMXCartelID:  1121973</span><br><span class="line">WorldID:      1121976</span><br><span class="line"></span><br><span class="line">ConfigFile:   /vmfs/volumes/6118f30c-3e1989cb-77c4-b47af1db548c/Devbox/Devbox.vmx</span><br><span class="line">DisplayName:  Devbox</span><br><span class="line">ProcessID:    0</span><br><span class="line">UUID:         56 4d 91 74 02 b7 b7 59-2b 48 e3 21 d2 a6 b2 9d</span><br><span class="line">VMXCartelID:  1122777</span><br><span class="line">WorldID:      1122778</span><br></pre></td></tr></table></figure><ul><li>关闭 ESXi 主机</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过调用 esxcli 命令来关机</span></span><br><span class="line">$ govc host.esxcli system shutdown</span><br><span class="line"><span class="comment"># 通过 host.shutdown 来关机，不过翻车了</span></span><br><span class="line">╭─root@esxi-debian-devbox ~</span><br><span class="line">╰─<span class="comment"># govc host.shutdown -host "esxi.yoi.li"</span></span><br><span class="line">govc: no argument</span><br></pre></td></tr></table></figure><ul><li>关机脚本 <code>shutdown_esxi.sh</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://root:passw0rd@esxi.yoi.li"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=<span class="string">"NVME"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_GUEST_LOGIN=<span class="string">"root:passw0rd"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># suspend all vms</span></span><br><span class="line">govc find . -<span class="built_in">type</span> m -runtime.powerState poweredOn | awk -F <span class="string">'/'</span> <span class="string">'&#123;print $NF&#125;'</span> \</span><br><span class="line">| grep -v NAS | xargs -L1 -&#123;&#125; govc vm.power -<span class="built_in">suspend</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># sync data to disk and shutdown vm</span></span><br><span class="line">govc vm.info NAS | grep -q poweredOn &amp;&amp; govc guest.run -vm NAS <span class="string">"sync &amp;&amp; shutdown -h now"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># wait all vm exit</span></span><br><span class="line"><span class="keyword">for</span>((i=0;i&lt;12;i++)); <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> ! esxcli vm process list | grep UUID; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    sleep 10</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">govc host.esxcli system shutdown</span><br></pre></td></tr></table></figure><ul><li>修改 <code>/etc/apcupsd/apccontrol</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   doshutdown)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"UPS <span class="variable">$&#123;2&#125;</span> initiated Shutdown Sequence"</span> | <span class="variable">$&#123;WALL&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"apcupsd UPS <span class="variable">$&#123;2&#125;</span> initiated shutdown"</span></span><br><span class="line"><span class="string">"bash /opt/bin/shutdown_esxi.sh"</span></span><br><span class="line">;;</span><br></pre></td></tr></table></figure><h2 id="vim-cmd"><a href="#vim-cmd" class="headerlink" title="vim-cmd"></a>vim-cmd</h2><p>由于 vim-cmd 命令只能在 ESXi 主机上运行，因此我们需要将该关机脚本保存到 ESXI 主机上，或者通过 scp 的方式将该脚本传输到 ESXi 主机上，然后执行该脚本完成关机操作。</p><ul><li>修改 <code>/etc/apcupsd/apccontrol</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   doshutdown)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"UPS <span class="variable">$&#123;2&#125;</span> initiated Shutdown Sequence"</span> | <span class="variable">$&#123;WALL&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"apcupsd UPS <span class="variable">$&#123;2&#125;</span> initiated shutdown"</span></span><br><span class="line">scp shutdown_esxi.sh root@esxi.yoi.li:/</span><br><span class="line">ssh root@esxi.yoi.li <span class="string">"sh /shutdown_esxi.sh"</span></span><br><span class="line">;;</span><br></pre></td></tr></table></figure><ul><li><code>shutdown_esxi.sh</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">LOG_PATH=/vmfs/volumes/NVME/.<span class="built_in">log</span>/suspend.log</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$(TZ=UTC-8 date +%Y-%m-%d" "%H:%M:%S)</span>"</span> &gt;&gt; <span class="variable">$&#123;LOG_PATH&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">poweroff_vms</span></span>()&#123;</span><br><span class="line">    <span class="keyword">for</span> vm <span class="keyword">in</span> $(vim-cmd vmsvc/getallvms | grep -E <span class="string">'NAS'</span> | awk <span class="string">'&#123;print $1&#125;'</span> | xargs); <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> vim-cmd vmsvc/power.getstate <span class="variable">$&#123;vm&#125;</span> | grep <span class="string">'Powered on'</span>; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"<span class="variable">$(TZ=UTC-8 date +%Y-%m-%d" "%H:%M:%S)</span> shutdown vm <span class="variable">$&#123;vm&#125;</span>"</span> &gt;&gt; <span class="variable">$&#123;LOG_PATH&#125;</span></span><br><span class="line">            vim-cmd vmsvc/power.shutdown <span class="variable">$&#123;vm&#125;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">suspend_vms</span></span>()&#123;</span><br><span class="line">    <span class="keyword">for</span> vm <span class="keyword">in</span> $(vim-cmd vmsvc/getallvms | grep -Ev <span class="string">'NAS|Vmid'</span> | awk <span class="string">'&#123;print $1&#125;'</span> | xargs); <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> vim-cmd vmsvc/power.getstate <span class="variable">$&#123;vm&#125;</span> | grep <span class="string">'Powered on'</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$(TZ=UTC-8 date +%Y-%m-%d" "%H:%M:%S)</span> suppend vm <span class="variable">$&#123;vm&#125;</span>"</span> &gt;&gt; <span class="variable">$&#123;LOG_PATH&#125;</span></span><br><span class="line">        vim-cmd vmsvc/power.suspend <span class="variable">$&#123;vm&#125;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">suspend_vms</span><br><span class="line">poweroff_vms</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Poweroff at <span class="variable">$(TZ=UTC-8 date +%Y-%m-%d" "%H:%M:%S)</span>"</span> &gt;&gt; <span class="variable">$&#123;LOG_PATH&#125;</span></span><br><span class="line">/bin/host_shutdown.sh</span><br></pre></td></tr></table></figure><p>通过 ssh 的方式执行该脚本需要 ESXi 主机开启 ssh 服务并做好 ssh 免密登录，这部分内容可参考 <a href="https://kb.vmware.com/s/article/1002866?lang=zh_CN" target="_blank" rel="noopener">允许使用公钥/私钥身份验证对 ESXi/ESX 主机进行 SSH 访问</a>。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="http://www.apcupsd.org/manual/" target="_blank" rel="noopener">apcupsd 官方文档</a></li><li><a href="https://wiki.debian.org/apcupsd" target="_blank" rel="noopener">apcupsd debian wiki</a></li><li><a href="https://linuxtoy.org/archives/howto-use-apcupsd-to-automatically-shutdown-system-during-outrage.html" target="_blank" rel="noopener">使用 apcupsd 实现 UPS 断电自动关机</a></li><li><a href="https://github.com/vmware/govmomi/blob/master/govc/USAGE.md" target="_blank" rel="noopener">govc usage</a></li><li><a href="https://gitbook.curiouser.top/origin/vsphere-govc.html" target="_blank" rel="noopener">vSphere go 命令行管理工具 govc</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;APC-UPS-BK650M2-CH&quot;&gt;&lt;a
        
      
    
    </summary>
    
    
      <category term="技术" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="NAS" scheme="https://blog.k8s.li/tags/NAS/"/>
    
      <category term="垃圾佬" scheme="https://blog.k8s.li/tags/%E5%9E%83%E5%9C%BE%E4%BD%AC/"/>
    
      <category term="UPS" scheme="https://blog.k8s.li/tags/UPS/"/>
    
  </entry>
  
</feed>
