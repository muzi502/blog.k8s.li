<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Reimu&#39;s blog</title>
  <icon>https://blog.k8s.li/icon.png</icon>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.k8s.li/"/>
  <updated>2022-05-24T16:00:00.000Z</updated>
  <id>https://blog.k8s.li/</id>
  
  <author>
    <name>Reimu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ä½¿ç”¨ Packer æ„å»ºè™šæ‹Ÿæœºé•œåƒè¸©çš„å‘</title>
    <link href="https://blog.k8s.li/packer-vsphere-example.html"/>
    <id>https://blog.k8s.li/packer-vsphere-example.html</id>
    <published>2022-05-24T16:00:00.000Z</published>
    <updated>2022-05-24T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸ä¹…å‰å†™è¿‡ä¸€ç¯‡åšå®¢ã€Š<a href="https://blog.k8s.li/redfish-esxi-os-installer.html">ä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OS</a>ã€‹åˆ†äº«äº†å¦‚ä½•ä½¿ç”¨ Redfish ç»™ç‰©ç†æœåŠ¡å™¨è‡ªåŠ¨åŒ–å®‰è£… ESXi OSã€‚è™½ç„¶åœ¨æˆ‘ä»¬å†…éƒ¨åšåˆ°äº†ä¸€é”®å®‰è£…&#x2F;é‡è£… ESXi OSï¼Œä½†æƒ³è¦å°†è¿™å¥—æ–¹æ¡ˆåº”ç”¨åœ¨å®¢æˆ·çš„ç§æœ‰äº‘æœºæˆ¿ç¯å¢ƒä¸­è¿˜æ˜¯æœ‰å¾ˆå¤§çš„éš¾åº¦ã€‚</p><p>é¦–å…ˆè¿™å¥—å·¥å…·å¿…é¡»è¿è¡Œåœ¨ Linux ä¸­æ‰è¡Œï¼Œå¯¹äº Bare Metal è£¸æœåŠ¡å™¨æ¥è®²è¿˜æ²¡æœ‰å®‰è£…ä»»ä½• OSï¼Œè¿™å°±å¼•ç”³å‡ºäº†é¸¡ç”Ÿè›‹è›‹ç”Ÿé¸¡çš„å°´å°¬éš¾é¢˜ã€‚è™½ç„¶å¯ä»¥ç»™å…¶ä¸­çš„ä¸€å°ç‰©ç†æœåŠ¡å™¨å®‰è£…ä¸Šä¸€ä¸ª Linux å‘è¡Œç‰ˆæ¯”å¦‚ CentOSï¼Œç„¶åå†å°†è¿™å¥—è‡ªåŠ¨åŒ–å®‰è£… ESXi OS çš„å·¥å…·æ­å»ºä¸Šå»ï¼Œä½†è¿™ä¼šé¢å¤–å ç”¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ï¼Œå®¢æˆ·ä¹Ÿè‚¯å®šä¸æ„¿æ„æ¥å—ã€‚</p><p>çœŸå®çš„å®æ–½åœºæ™¯ä¸­ï¼Œå¯è¡Œçš„æ–¹æ¡ˆå°±æ˜¯å°†è¿™å¥—å·¥å…·è¿è¡Œåœ¨å®æ–½äººå‘˜çš„ç¬”è®°æœ¬ç”µè„‘æˆ–è€…å®¢æˆ·æä¾›çš„å°å¼æœºä¸Šã€‚è¿™åˆå¼•ç”³å‡ºäº†ä¸€ä¸ªå¦å¤–çš„éš¾é¢˜ï¼šå®æ–½äººå‘˜çš„ç¬”è®°æœ¬ç”µè„‘æˆ–è€…å®¢æˆ·æä¾›çš„å°å¼æœºè¿è¡Œçš„å¤§éƒ½æ˜¯ Windows ç³»ç»Ÿï¼Œåœ¨ Windows ä¸Šå®‰è£… Ansibleã€Makeã€Python3 ç­‰ä¸€å †ä¾èµ–ï¼Œæƒ³æƒ³å°±ä¸å¤ªç°å®ï¼Œè€Œä¸”ç¨³å®šæ€§å’Œå…¼å®¹æ€§å¾ˆéš¾å¾—åˆ°ä¿éšœï¼Œä»¥åŠå¼€å‘ç¯å¢ƒå’Œè¿è¡Œç¯å¢ƒä¸ä¸€è‡´å¯¼è‡´ä¸€äº›å…¶ä»–çš„å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ã€‚è™½ç„¶è¯¥å·¥å…·æ”¯æŒå®¹å™¨åŒ–è¿è¡Œèƒ½å¤Ÿè§£å†³å¼€å‘ç¯å¢ƒå’Œè¿è¡Œç¯å¢ƒä¸ä¸€è‡´çš„é—®é¢˜ï¼Œä½†åœ¨ Windows ä¸Šå®‰è£… docker ä¹Ÿæ¯”è¾ƒç¹çå’Œéº»çƒ¦ã€‚</p><p>è¿™æ—¶å€™å°±è¦æ¬å‡ºè®¡ç®—æœºç§‘å­¦ä¸­çš„è‡³ç†åè¨€: <strong>è®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªé—´æ¥çš„ä¸­é—´å±‚æ¥è§£å†³</strong>ã€‚</p><blockquote><p><strong>Any problem in computer science can be solved by another layer of indirection.</strong></p></blockquote><p>æ—¢ç„¶æˆ‘ä»¬è¿™å¥—å·¥å…·ç›®å‰åªèƒ½åœ¨ Linux ä¸Šç¨³å®šè¿è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸å¦‚å°±å°†è¿™å¥—å·¥å…·å’Œå®ƒæ‰€è¿è¡Œçš„ç¯å¢ƒå°è£…åœ¨ä¸€ä¸ªâ€œä¸­é—´å®¹å™¨â€é‡Œï¼Œæ¯”å¦‚è™šæ‹Ÿæœºã€‚ä½¿ç”¨è€…åªéœ€è¦å®‰è£…åƒ <a href="https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html">VMware Workstation</a> æˆ–è€… <a href="https://www.virtualbox.org/">Oracle VirtualBox</a> è™šæ‹ŸåŒ–ç®¡ç†è½¯ä»¶è¿è¡Œè¿™å°è™šæ‹Ÿæœºä¸å°±è¡Œäº†ã€‚ä¸€åˆ‡çš†å¯å¥—å¨ƒï¼ˆğŸ¤£</p><p>å…¶å®åŸç†å°±åƒ docker å®¹å™¨é‚£æ ·ï¼Œæˆ‘ä»¬å°†è¿™å¥—å·¥å…·å’Œå®ƒæ‰€ä¾èµ–çš„è¿è¡Œç¯å¢ƒåœ¨æ„å»ºè™šæ‹Ÿæœºçš„æ—¶å€™å°†å®ƒä»¬å…¨éƒ¨æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œä½¿ç”¨è€…åªéœ€è¦æƒ³åŠæ³•å°†è¿™ä¸ªè™šæ‹Ÿæœºè¿è¡Œèµ·æ¥ï¼Œå°±èƒ½ä¸€é”®ä½¿ç”¨æˆ‘ä»¬è¿™ä¸ªå·¥å…·ï¼Œä¸å¿…å†æ‰‹åŠ¨å®‰è£… Ansible å’Œ Python3 ç­‰ä¸€å †ä¾èµ–äº†ï¼ŒçœŸæ­£åšåˆ°å¼€ç®±å³ç”¨ã€‚</p><p>äºæ˜¯æœ¬æ–‡åˆ†äº«ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ <a href="https://www.packer.io/">Packer</a> åœ¨ <a href="https://www.vmware.com/products/vsphere.html">VMware vSphere</a> ç¯å¢ƒä¸Šæ„å»ºè™šæ‹Ÿæœºé•œåƒçš„æ–¹æ¡ˆï¼Œä»¥åŠå¦‚ä½•åœ¨è¿™ä¸ªè™šæ‹Ÿæœºä¸­è¿è¡Œä¸€ä¸ª k3s é›†ç¾¤ï¼Œç„¶åé€šè¿‡ <a href="https://github.com/argoproj/argo-workflows">argo-workflow</a> å·¥ä½œæµå¼•æ“è¿è¡Œ <a href="https://github.com/muzi502/redfish-esxi-os-installer">redfish-esxi-os-installer</a> æ¥å¯¹è£¸é‡‘å±æœåŠ¡å™¨è¿›è¡Œè‡ªåŠ¨åŒ–å®‰è£… ESXi OS çš„æ“ä½œã€‚</p><h2 id="åŠé€€ä¸‰è¿-ğŸ˜‚"><a href="#åŠé€€ä¸‰è¿-ğŸ˜‚" class="headerlink" title="åŠé€€ä¸‰è¿ ğŸ˜‚"></a>åŠé€€ä¸‰è¿ ğŸ˜‚</h2><ul><li>æå‰ä¸‹è½½å¥½ Base OS çš„ ISO é•œåƒï¼Œæ¯”å¦‚ <a href="https://mirrors.tuna.tsinghua.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso">CentOS-7-x86_64-Minimal-2009.iso</a></li><li>éœ€è¦ä¸€ä¸ª <a href="https://www.vmware.com/products/vcenter-server.html">vCenter Server</a> ä»¥åŠä¸€å° <a href="https://www.vmware.com/products/esxi-and-esx.html">VMware ESXi</a> ä¸»æœº</li><li>ESXi çš„ VM Network ç½‘ç»œä¸­éœ€è¦æœ‰ä¸€å° DHCP æœåŠ¡å™¨ç”¨äºç»™ VM åˆ†é… IP</li></ul><h2 id="Packer"><a href="#Packer" class="headerlink" title="Packer"></a>Packer</h2><p>å¾ˆæ—©ä¹‹å‰ç©å„¿ VMware ESXi çš„æ—¶å€™è¿˜æ²¡æœ‰æ¥è§¦åˆ° Packerï¼Œé‚£æ—¶å€™åªèƒ½ä½¿ç”¨<a href="https://blog.k8s.li/esxi-vmbase.html">æ‰‹æ“è™šæ‹Ÿæœºæ¨¡ç‰ˆ</a>çš„æ–¹å¼ï¼Œè´¹æ—¶è´¹åŠ›è¿˜å®¹æ˜“å‡ºé”™ï¼Œä¸‹é¢å°±ä»‹ç»ä¸€ä¸‹è¿™ä¸ªè‡ªåŠ¨åŒ–æ„å»ºè™šæ‹Ÿæœºé•œåƒçš„å·¥å…·ã€‚</p><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p><a href="https://github.com/hashicorp/packer">Packer</a> æ˜¯ <a href="https://www.hashicorp.com/">hashicorp</a> å…¬å¸å¼€æºçš„ä¸€ä¸ªè™šæ‹Ÿæœºé•œåƒæ„å»ºå·¥å…·ï¼Œä¸å®ƒç±»ä¼¼çš„å·¥å…·è¿˜æœ‰ <a href="https://github.com/openstack/diskimage-builder">OpenStack diskimage-builder</a>ã€<a href="https://aws.amazon.com/image-builder/">AWS EC2 Image Builder</a> ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªåªæ”¯æŒè‡ªå®¶çš„å¹³å°ã€‚Packer èƒ½å¤Ÿæ”¯æŒä¸»æµçš„å…¬æœ‰äº‘ã€ç§æœ‰äº‘ä»¥åŠæ··åˆäº‘ï¼Œæ¯”å®ƒä¿©é«˜åˆ°ä¸çŸ¥é“å“ªé‡Œå»äº†ã€‚å¯ä»¥è¿™ä¹ˆæ¥ç†è§£ï¼šPacker åœ¨ IaaS è™šæ‹ŸåŒ–é¢†åŸŸçš„åœ°ä½å°±åƒ Docker åœ¨ PaaS å®¹å™¨è™šæ‹Ÿä¸­é‚£æ ·é‡è¦ï¼Œä¸€ä¸ªæ˜¯è™šæ‹Ÿæœºé•œåƒçš„æ„å»ºï¼Œå¦ä¸€ä¸ªå®¹å™¨é•œåƒçš„æ„å»ºï¼Œæœ‰è¶£çš„æ˜¯ä¸¤è€…éƒ½æ˜¯åœ¨ 2013 å¹´æˆç«‹çš„é¡¹ç›®ã€‚</p><p>Kubernetes ç¤¾åŒºçš„ <a href="https://github.com/kubernetes-sigs/image-builder">image-builder</a> é¡¹ç›®å°±æ˜¯ä½¿ç”¨ Packer æ„å»ºä¸€äº›å…¬æœ‰äº‘åŠç§æœ‰äº‘çš„è™šæ‹Ÿæœºæ¨¡ç‰ˆæä¾›ç»™ <a href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> é¡¹ç›®ä½¿ç”¨ï¼Œååˆ†æ¨èå¤§å®¶å»çœ‹ä¸‹è¿™ä¸ªé¡¹ç›®çš„ä»£ç ï¼Œåˆšå¼€å§‹æˆ‘ä¹Ÿæ˜¯ä»è¿™ä¸ªé¡¹ç›®ç†Ÿæ‚‰ Packer çš„ï¼Œå¹¶ä»ä¸­æŠ„è¢­å€Ÿé‰´äº†å¾ˆå¤šå†…å®¹ ğŸ˜…ã€‚</p><p>ä¸‹é¢å°±ä»‹ç»ä¸€ä¸‹ Packer çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•</p><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>å¯¹äº Linux å‘è¡Œç‰ˆï¼Œå»ºè®®ç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶å®‰è£…åŒ…æ¥å®‰è£…ï¼Œé€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£…æ„Ÿè§‰æœ‰ç‚¹éº»çƒ¦</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">wget</span> https://releases.hashicorp.com/packer/1.8.0/packer_1.8.0_linux_amd64.zip$ <span class="token function">unzip</span> packer_1.8.0_linux_amd64.zip$ <span class="token function">mv</span> packer /usr/local/bin/packer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ˜¯ macOS ç”¨æˆ·ç›´æ¥ <code>brew install packer</code> å‘½ä»¤ä¸€æŠŠæ¢­å°±èƒ½å®‰è£…å¥½</p><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>ä¸åŒäº Docker æœ‰ä¸€ä¸ª Dockerfile æ–‡ä»¶æ¥å®šä¹‰å¦‚ä½•æ„å»ºå®¹å™¨é•œåƒï¼ŒPacker æ„å»ºè™šæ‹Ÿæœºé•œåƒåˆ™æ˜¯ç”±ä¸€ç³»åˆ—çš„é…ç½®æ–‡ä»¶ç¼åˆè€Œæˆï¼Œä¸»è¦ç”± <a href="https://www.packer.io/docs/terminology#builders">Builders</a> ã€<a href="https://www.packer.io/docs/terminology#provisioners">Provisioners</a> ã€<a href="https://www.packer.io/docs/terminology#post-processors">Post-processors</a> è¿™ä¸‰éƒ¨åˆ†ç»„æˆã€‚å…¶ä¸­ Builder ä¸»è¦æ˜¯ä¸ IaaS Provider æ„å»ºå™¨ç›¸å…³çš„ä¸€äº›å‚æ•°ï¼›Provisioner ç”¨æ¥é…ç½®æ„å»ºè¿‡ç¨‹ä¸­éœ€è¦è¿è¡Œçš„ä¸€äº›ä»»åŠ¡ï¼›Post-processors ç”¨äºé…ç½®æ„å»ºåŠ¨ä½œå®Œæˆåçš„ä¸€äº›åå¤„ç†æ“ä½œï¼›ä¸‹é¢å°±ä¾æ¬¡ä»‹ç»ä¸€ä¸‹è¿™å‡ ä¸ªé…ç½®çš„è¯¦ç»†ä½¿ç”¨è¯´æ˜ï¼š</p><p>å¦å¤– Packer æ¨èçš„é…ç½®è¯­æ³•æ˜¯ <a href="https://www.packer.io/guides/hcl">HCL2</a>ï¼Œä½†ä¸ªäººè§‰ç€ HCL çš„è¯­æ³•é£æ ¼æ€ªæ€ªçš„ï¼Œä¸å¦‚ json é‚£æ ·æ•´æ´å¥½çœ‹ ğŸ˜…ï¼Œå› æ­¤ä¸‹é¢æˆ‘ç»Ÿä¸€ä½¿ç”¨ json æ¥è¿›è¡Œé…ç½®ï¼Œå…¶å®å‚æ•°éƒ½ä¸€æ ·ï¼Œåªæ˜¯æ ¼å¼ä¸ç›¸åŒè€Œå·²ã€‚</p><h4 id="vars-x2F-var-file"><a href="#vars-x2F-var-file" class="headerlink" title="vars&#x2F;var-file"></a>vars&#x2F;var-file</h4><p>Packer çš„å˜é‡é…ç½®æ–‡ä»¶æœ‰ç‚¹ç±»ä¼¼äº Ansible ä¸­çš„ varsã€‚ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„æ–¹å¼å°±æ˜¯æŒ‰ç…§æ¯ä¸ªå‚æ•°çš„ä½œç”¨åŸŸè¿›è¡Œåˆ†ç±»æ•´ç†ï¼Œå°†å®ƒä»¬ç»Ÿä¸€æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™æ ·ç»´æŠ¤èµ·æ¥ä¼šæ›´æ–¹ä¾¿ä¸€äº›ã€‚å‚è€ƒäº† image-builder é¡¹ç›®ä¸­çš„ <a href="https://github.com/kubernetes-sigs/image-builder/tree/master/images/capi/packer/ova">ova</a> æ„å»ºåæˆ‘æ ¹æ®å‚æ•°çš„ä¸åŒä½œç”¨åˆ’åˆ†æˆäº†å¦‚ä¸‹å‡ ä¸ªé…ç½®æ–‡ä»¶ï¼š</p><ul><li><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/vcenter.json">vcenter.json</a>ï¼šä¸»è¦ç”¨äºé…ç½®ä¸€äº›ä¸ vCenter ç›¸å…³çš„å‚æ•°ï¼Œæ¯”å¦‚ datastoreã€datacenterã€resource_poolã€vcenter_server ç­‰ï¼›å¦å¤–åƒ vcenter çš„ç”¨æˆ·åå’Œå¯†ç å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡çš„æ–¹å¼ï¼Œé¿å…æ˜æ–‡ç¼–ç åœ¨æ–‡ä»¶å½“ä¸­ï¼›</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"folder"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>  <span class="token property">"resource_pool"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>  <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>  <span class="token property">"datacenter"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>  <span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>  <span class="token property">"convert_to_template"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>  <span class="token property">"create_snapshot"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>  <span class="token property">"linked_clone"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>  <span class="token property">"network"</span><span class="token operator">:</span> <span class="token string">"VM Network"</span><span class="token punctuation">,</span>  <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"password"</span><span class="token punctuation">,</span>  <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"administrator@vsphere.local"</span><span class="token punctuation">,</span>  <span class="token property">"vcenter_server"</span><span class="token operator">:</span> <span class="token string">"vcenter.k8s.li"</span><span class="token punctuation">,</span>  <span class="token property">"insecure_connection"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/centos7.json">centos7.json</a>ï¼šä¸»è¦ç”¨äºé…ç½®ä¸€äº›é€šè¿‡ ISO å®‰è£… CentOS çš„å‚æ•°ï¼Œæ¯”å¦‚ ISO çš„ä¸‹è½½åœ°å€ã€ISO çš„ checksumã€kickstart æ–‡ä»¶è·¯å¾„ã€å…³æœºå‘½ä»¤ã€isolinux å¯åŠ¨å‚æ•°ç­‰ï¼›</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"boot_command_prefix"</span><span class="token operator">:</span> <span class="token string">"&lt;tab> text ks=hd:fd0:"</span><span class="token punctuation">,</span>  <span class="token property">"boot_command_suffix"</span><span class="token operator">:</span> <span class="token string">"/7/ks.cfg&lt;enter>&lt;wait>"</span><span class="token punctuation">,</span>  <span class="token property">"boot_media_path"</span><span class="token operator">:</span> <span class="token string">"/HTTP"</span><span class="token punctuation">,</span>  <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"centos-7"</span><span class="token punctuation">,</span>  <span class="token property">"distro_arch"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>  <span class="token property">"distro_name"</span><span class="token operator">:</span> <span class="token string">"centos"</span><span class="token punctuation">,</span>  <span class="token property">"distro_version"</span><span class="token operator">:</span> <span class="token string">"7"</span><span class="token punctuation">,</span>  <span class="token property">"floppy_dirs"</span><span class="token operator">:</span> <span class="token string">"./kickstart/&#123;&#123;user `distro_name`&#125;&#125;/http/"</span><span class="token punctuation">,</span>  <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"centos7-64"</span><span class="token punctuation">,</span>  <span class="token property">"iso_checksum"</span><span class="token operator">:</span> <span class="token string">"07b94e6b1a0b0260b94c83d6bb76b26bf7a310dc78d7a9c7432809fb9bc6194a"</span><span class="token punctuation">,</span>  <span class="token property">"iso_checksum_type"</span><span class="token operator">:</span> <span class="token string">"sha256"</span><span class="token punctuation">,</span>  <span class="token property">"iso_url"</span><span class="token operator">:</span> <span class="token string">"https://mirrors.edge.kernel.org/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso"</span><span class="token punctuation">,</span>  <span class="token property">"os_display_name"</span><span class="token operator">:</span> <span class="token string">"CentOS 7"</span><span class="token punctuation">,</span>  <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"shutdown -h now"</span><span class="token punctuation">,</span>  <span class="token property">"vsphere_guest_os_type"</span><span class="token operator">:</span> <span class="token string">"centos7_64Guest"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/photon3.json">photon3.json</a>ï¼šä¸»è¦ç”¨äºé…ç½®ä¸€äº›é€šè¿‡ ISO å®‰è£… Photon3 OS çš„å‚æ•°ï¼Œå’Œä¸Šé¢çš„ centos7.json ä½œç”¨åŸºæœ¬ä¸€è‡´ï¼›</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"boot_command_prefix"</span><span class="token operator">:</span> <span class="token string">"&lt;esc>&lt;wait> vmlinuz initrd=initrd.img root/dev/ram0 loglevel=3 photon.media=cdrom ks="</span><span class="token punctuation">,</span>  <span class="token property">"boot_command_suffix"</span><span class="token operator">:</span> <span class="token string">"/3/ks.json&lt;enter>&lt;wait>"</span><span class="token punctuation">,</span>  <span class="token property">"boot_media_path"</span><span class="token operator">:</span> <span class="token string">"http://&#123;&#123; .HTTPIP &#125;&#125;:&#123;&#123; .HTTPPort &#125;&#125;"</span><span class="token punctuation">,</span>  <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"photon-3"</span><span class="token punctuation">,</span>  <span class="token property">"distro_arch"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>  <span class="token property">"distro_name"</span><span class="token operator">:</span> <span class="token string">"photon"</span><span class="token punctuation">,</span>  <span class="token property">"distro_version"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>  <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"vmware-photon-64"</span><span class="token punctuation">,</span>  <span class="token property">"http_directory"</span><span class="token operator">:</span> <span class="token string">"./kickstart/&#123;&#123;user `distro_name`&#125;&#125;/http/"</span><span class="token punctuation">,</span>  <span class="token property">"iso_checksum"</span><span class="token operator">:</span> <span class="token string">"c2883a42e402a2330d9c39b4d1e071cf9b3b5898"</span><span class="token punctuation">,</span>  <span class="token property">"iso_checksum_type"</span><span class="token operator">:</span> <span class="token string">"sha1"</span><span class="token punctuation">,</span>  <span class="token property">"iso_url"</span><span class="token operator">:</span> <span class="token string">"https://packages.vmware.com/photon/3.0/Rev3/iso/photon-minimal-3.0-a383732.iso"</span><span class="token punctuation">,</span>  <span class="token property">"os_display_name"</span><span class="token operator">:</span> <span class="token string">"VMware Photon OS 64-bit"</span><span class="token punctuation">,</span>  <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"shutdown now"</span><span class="token punctuation">,</span>  <span class="token property">"vsphere_guest_os_type"</span><span class="token operator">:</span> <span class="token string">"vmwarePhoton64Guest"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/common.json">common.json</a>ï¼šä¸€äº›å…¬å…±å‚æ•°ï¼Œæ¯”å¦‚è™šæ‹Ÿæœºçš„ ssh ç”¨æˆ·åå’Œå¯†ç ï¼ˆè¦å’Œ kickstart ä¸­è®¾ç½®çš„ä¿æŒä¸€è‡´ï¼‰ã€è™šæ‹Ÿæœºçš„ä¸€äº›ç¡¬ä»¶é…ç½®å¦‚ CPUã€å†…å­˜ã€ç¡¬ç›˜ã€è™šæ‹Ÿæœºç‰ˆæœ¬ã€ç½‘å¡ç±»å‹ã€å­˜å‚¨æ§åˆ¶å™¨ç±»å‹ç­‰ï¼›</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"ssh_username"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>  <span class="token property">"ssh_password"</span><span class="token operator">:</span> <span class="token string">"password"</span><span class="token punctuation">,</span>  <span class="token property">"boot_wait"</span><span class="token operator">:</span> <span class="token string">"15s"</span><span class="token punctuation">,</span>  <span class="token property">"disk_controller_type"</span><span class="token operator">:</span> <span class="token string">"lsilogic"</span><span class="token punctuation">,</span>  <span class="token property">"disk_thin_provisioned"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>  <span class="token property">"disk_type_id"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>  <span class="token property">"firmware"</span><span class="token operator">:</span> <span class="token string">"bios"</span><span class="token punctuation">,</span>  <span class="token property">"cpu"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>  <span class="token property">"cpu_cores"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>  <span class="token property">"memory"</span><span class="token operator">:</span> <span class="token string">"4096"</span><span class="token punctuation">,</span>  <span class="token property">"disk_size"</span><span class="token operator">:</span> <span class="token string">"65536"</span><span class="token punctuation">,</span>  <span class="token property">"network_card"</span><span class="token operator">:</span> <span class="token string">"e1000"</span><span class="token punctuation">,</span>  <span class="token property">"ssh_timeout"</span><span class="token operator">:</span> <span class="token string">"3m"</span><span class="token punctuation">,</span>  <span class="token property">"vmx_version"</span><span class="token operator">:</span> <span class="token string">"14"</span><span class="token punctuation">,</span>  <span class="token property">"base_build_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `template`&#125;&#125;"</span><span class="token punctuation">,</span>  <span class="token property">"build_timestamp"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;timestamp&#125;&#125;"</span><span class="token punctuation">,</span>  <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"k3s"</span><span class="token punctuation">,</span>  <span class="token property">"build_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ova_name`&#125;&#125;"</span><span class="token punctuation">,</span>  <span class="token property">"export_manifest"</span><span class="token operator">:</span> <span class="token string">"none"</span><span class="token punctuation">,</span>  <span class="token property">"output_dir"</span><span class="token operator">:</span> <span class="token string">"./output/&#123;&#123;user `build_version`&#125;&#125;"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Builder"><a href="#Builder" class="headerlink" title="Builder"></a>Builder</h4><p>Builder å°±æ˜¯å‘Šè¯‰ Packer è¦ä½¿ç”¨ä»€ä¹ˆç±»å‹çš„æ„å»ºå™¨æ„å»ºä»€ä¹ˆæ ·çš„è™šæ‹Ÿæœºé•œåƒï¼Œä¸»è¦æ˜¯ä¸åº•å±‚ IaaS èµ„æºæä¾›å•†ç›¸å…³çš„é…ç½®ã€‚æ¯”å¦‚ <a href="https://www.packer.io/plugins/builders/vsphere">vSphere Builder</a> ä¸­æœ‰å¦‚ä¸‹ä¸¤ç§æ„å»ºå™¨ï¼š</p><ul><li><a href="https://www.packer.io/docs/builders/vsphere/vsphere-iso">vsphere-iso</a> ä» ISO å®‰è£… OS å¼€å§‹æ„å»ºï¼Œé€šå¸¸æƒ…å†µä¸‹æ„å»ºä¸ºä¸€ä¸ªè™šæ‹Ÿæœºæˆ–è™šæ‹Ÿæœºæ¨¡ç‰ˆ</li><li><a href="https://www.packer.io/docs/builders/vsphere/vsphere-clone">vsphere-clone</a> é€šè¿‡ clone è™šæ‹Ÿæœºçš„æ–¹å¼è¿›è¡Œæ„å»ºï¼Œé€šå¸¸æƒ…å†µä¸‹æ„å»ºäº§ç‰©ä¸ºå¯¼å‡ºåçš„ OVF&#x2F;OVA æ–‡ä»¶</li></ul><p>ä¸åŒç±»å‹çš„ Builder é…ç½®å‚æ•°ä¹Ÿä¼šæœ‰æ‰€ä¸åŒï¼Œæ¯ä¸ªå‚æ•°çš„è¯¦ç»†ç”¨é€”å’Œè¯´æ˜å¯ä»¥å‚è€ƒ <a href="https://www.packer.io/plugins">Packer å®˜æ–¹çš„æ–‡æ¡£</a>ï¼Œåœ¨è¿™é‡Œå°±ä¸ä¸€ä¸€è¯´æ˜äº†ã€‚å› ä¸º Packer çš„å‚æ•°é…ç½®æ˜¯åœ¨æ˜¯å¤ªå¤šå¤ªå¤æ‚äº†ï¼Œå¾ˆéš¾ä¸‰è¨€ä¸¤è¯­è®²æ¸…æ¥šã€‚æœ€ä½³çš„æ–¹å¼å°±æ˜¯é˜…è¯»å®˜æ–¹çš„æ–‡æ¡£å’Œä¸€äº›å…¶ä»–é¡¹ç›®çš„å®ç°æ–¹å¼ï¼Œç…§è‘«èŠ¦ç”»ç“¢å­¦å°±è¡Œã€‚</p><p><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/builder.json">builders.json</a>ï¼šé‡Œé¢çš„é…ç½®å‚æ•°å¤§å¤šéƒ½æ˜¯å¼•ç”¨çš„ var-file ä¸­çš„å‚æ•°ï¼Œå°†è¿™äº›å‚æ•°å•ç‹¬æŠ½å‡ºæ¥çš„å¥½å¤„å°±æ˜¯ä¸åŒçš„ builder ä¹‹é—´å¯ä»¥å¤ç”¨ä¸€äº›å…¬å…±å‚æ•°ã€‚æ¯”å¦‚ vsphere-iso å’Œ vsphere-clone è¿™ä¸¤ç§ä¸åŒçš„ builder ä¸ vCenter ç›¸å…³çš„ datacenterã€datastoreã€vcenter_server ç­‰å‚æ•°éƒ½æ˜¯å…¶å®ç›¸åŒçš„ã€‚</p><ul><li><a href="https://www.packer.io/docs/builders/vsphere/vsphere-iso">vsphere-iso</a> ï¼šé€šè¿‡ ISO å®‰è£… OS æ„å»ºä¸€ä¸ªè™šæ‹Ÿæœºæˆ–è™šæ‹Ÿæœºæ¨¡ç‰ˆ</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"builders"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"CPUs"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"RAM"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `memory`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"boot_command"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"&#123;&#123;user `boot_command_prefix`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token string">"&#123;&#123;user `boot_media_path`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token string">"&#123;&#123;user `boot_command_suffix`&#125;&#125;"</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"boot_wait"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `boot_wait`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cluster`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"communicator"</span><span class="token operator">:</span> <span class="token string">"ssh"</span><span class="token punctuation">,</span>      <span class="token property">"convert_to_template"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `convert_to_template`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"cpu_cores"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu_cores`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"create_snapshot"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `create_snapshot`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"datacenter"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datacenter`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datastore`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"disk_controller_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_controller_type`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"firmware"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `firmware`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"floppy_dirs"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `floppy_dirs`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"folder"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `folder`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vsphere_guest_os_type`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `host`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"http_directory"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `http_directory`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"insecure_connection"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `insecure_connection`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"iso_checksum"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `iso_checksum_type`&#125;&#125;:&#123;&#123;user `iso_checksum`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"iso_urls"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `iso_url`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"vsphere-iso-base"</span><span class="token punctuation">,</span>      <span class="token property">"network_adapters"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>          <span class="token property">"network"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `network`&#125;&#125;"</span><span class="token punctuation">,</span>          <span class="token property">"network_card"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `network_card`&#125;&#125;"</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `password`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"echo '&#123;&#123;user `ssh_password`&#125;&#125;' | sudo -S -E sh -c '&#123;&#123;user `shutdown_command`&#125;&#125;'"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_clear_authorized_keys"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_password`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_timeout"</span><span class="token operator">:</span> <span class="token string">"4h"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_username`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"storage"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token punctuation">&#123;</span>          <span class="token property">"disk_size"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_size`&#125;&#125;"</span><span class="token punctuation">,</span>          <span class="token property">"disk_thin_provisioned"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_thin_provisioned`&#125;&#125;"</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"vsphere-iso"</span><span class="token punctuation">,</span>      <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `username`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"vcenter_server"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vcenter_server`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"vm_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `base_build_version`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"vm_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vmx_version`&#125;&#125;"</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="https://www.packer.io/docs/builders/vsphere/vsphere-clone">vsphere-clone</a>ï¼šé€šè¿‡ clone è™šæ‹Ÿæœºæ„å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå¹¶å¯¼å‡ºè™šæ‹Ÿæœº OVF æ¨¡ç‰ˆ</li></ul><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"builders"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"CPUs"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"RAM"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `memory`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cluster`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"communicator"</span><span class="token operator">:</span> <span class="token string">"ssh"</span><span class="token punctuation">,</span>      <span class="token property">"convert_to_template"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `convert_to_template`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"cpu_cores"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu_cores`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"create_snapshot"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `create_snapshot`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"datacenter"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datacenter`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datastore`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"export"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"force"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token property">"manifest"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `export_manifest`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"output_directory"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `output_dir`&#125;&#125;"</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token property">"folder"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `folder`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `host`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"insecure_connection"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `insecure_connection`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"linked_clone"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `linked_clone`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"vsphere-clone"</span><span class="token punctuation">,</span>      <span class="token property">"network"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `network`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `password`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"echo '&#123;&#123;user `ssh_password`&#125;&#125;' | sudo -S -E sh -c '&#123;&#123;user `shutdown_command`&#125;&#125;'"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_password`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_timeout"</span><span class="token operator">:</span> <span class="token string">"4h"</span><span class="token punctuation">,</span>      <span class="token property">"ssh_username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_username`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"template"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `template`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"vsphere-clone"</span><span class="token punctuation">,</span>      <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `username`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"vcenter_server"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vcenter_server`&#125;&#125;"</span><span class="token punctuation">,</span>      <span class="token property">"vm_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `build_version`&#125;&#125;"</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="Provisioner"><a href="#Provisioner" class="headerlink" title="Provisioner"></a><a href="https://www.packer.io/docs/provisioners">Provisioner</a></h4><p>Provisioner å°±æ˜¯å‘Šè¯‰ Packer è¦å¦‚ä½•æ„å»ºé•œåƒï¼Œæœ‰ç‚¹ç±»ä¼¼äº Dockerile ä¸­çš„ RUN&#x2F;COPY&#x2F;ADD ç­‰æŒ‡ä»¤ï¼Œç”¨äºæ‰§è¡Œä¸€äº›å‘½ä»¤&#x2F;è„šæœ¬ã€å¾€è™šæ‹Ÿæœºé‡Œæ·»åŠ ä¸€äº›æ–‡ä»¶ã€è°ƒç”¨ç¬¬ä¸‰æ–¹æ’ä»¶æ‰§è¡Œä¸€äº›æ“ä½œç­‰ã€‚</p><p>åœ¨è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­æˆ‘å…ˆä½¿ç”¨ file æ¨¡å—å°†ä¸€äº›è„šæœ¬å’Œä¾èµ–æ–‡ä»¶ä¸Šä¼ åˆ°è™šæ‹Ÿæœºä¸­ï¼Œç„¶åä½¿ç”¨ shell æ¨¡å—åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œ install.sh å®‰è£…è„šæœ¬ã€‚å¦‚æœæ„å»ºçš„ builder æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚éœ€è¦æ”¯æŒå¤šä¸ª Linux å‘è¡Œç‰ˆï¼Œè¿™ç§åœºæ™¯å»ºè®®ä½¿ç”¨ Ansibleã€‚ç”±äºæˆ‘åœ¨ ISO å®‰è£… OS çš„æ„å»ºæµç¨‹ä¸­å·²ç»å°†ä¸€äº›ä¸ OS å‘è¡Œç‰ˆç›¸å…³çš„æ“ä½œå®Œæˆäº†ï¼Œåœ¨è¿™é‡Œä½¿ç”¨ shell æ‰§è¡Œçš„æ“ä½œä¸éœ€è¦åŒºåˆ†å“ªä¸ª Linux å‘è¡Œç‰ˆï¼Œæ‰€ä»¥å°±æ²¡æœ‰ä½¿ç”¨ ansibleã€‚</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"provisioners"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>      <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"scripts"</span><span class="token punctuation">,</span>      <span class="token property">"destination"</span><span class="token operator">:</span> <span class="token string">"/root"</span><span class="token punctuation">,</span>      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"vsphere-iso-base"</span>      <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>      <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"resources"</span><span class="token punctuation">,</span>      <span class="token property">"destination"</span><span class="token operator">:</span> <span class="token string">"/root"</span><span class="token punctuation">,</span>      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"vsphere-iso-base"</span>      <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"shell"</span><span class="token punctuation">,</span>      <span class="token property">"environment_vars"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"INSECURE_REGISTRY=&#123;&#123;user `insecure_registry`&#125;&#125;"</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"inline"</span><span class="token operator">:</span> <span class="token string">"bash /root/scripts/install.sh"</span><span class="token punctuation">,</span>      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"vsphere-iso-base"</span>      <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="post-processors"><a href="#post-processors" class="headerlink" title="post-processors"></a>post-processors</h3><p>ä¸€äº›æ„å»ºåçš„æ“ä½œï¼Œ æ¯”å¦‚ <code>&quot;type&quot;: &quot;manifest&quot;</code> å¯ä»¥å¯¼å‡ºä¸€äº›æ„å»ºè¿‡ç¨‹ä¸­çš„é…ç½®å‚æ•°ï¼Œç»™åç»­çš„å…¶ä»–æ“ä½œæ¥ä½¿ç”¨ã€‚å†æ¯”å¦‚ <code>&quot;type&quot;: &quot;shell-local&quot;</code> å°±æ˜¯æ‰§è¡Œä¸€äº› shell è„šæœ¬ï¼Œåœ¨è¿™é‡Œå°±æ˜¯æ‰§è¡Œä¸€ä¸ª Python è„šæœ¬å°† OVF è½¬æ¢æˆ OVAã€‚</p><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>  <span class="token property">"post-processors"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"custom_data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>        <span class="token property">"release_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `release_version`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"build_date"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;isotime&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `build_name`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"build_timestamp"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `build_timestamp`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"build_type"</span><span class="token operator">:</span> <span class="token string">"node"</span><span class="token punctuation">,</span>        <span class="token property">"cpu"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"memory"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `memory`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"disk_size"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_size`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"distro_arch"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `distro_arch` &#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"distro_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `distro_name` &#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"distro_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `distro_version` &#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"firmware"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `firmware`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `guest_os_type`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"os_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `os_display_name`&#125;&#125;"</span><span class="token punctuation">,</span>        <span class="token property">"vsphere_guest_os_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vsphere_guest_os_type`&#125;&#125;"</span>      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"packer-manifest"</span><span class="token punctuation">,</span>      <span class="token property">"output"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `output_dir`&#125;&#125;/packer-manifest.json"</span><span class="token punctuation">,</span>      <span class="token property">"strip_path"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"manifest"</span><span class="token punctuation">,</span>      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"vsphere-iso-base"</span>      <span class="token punctuation">]</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>    <span class="token punctuation">&#123;</span>      <span class="token property">"inline"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"python3 ./scripts/ova.py --vmx &#123;&#123;user `vmx_version`&#125;&#125; --ovf_template &#123;&#123;user `ovf_template`&#125;&#125; --build_dir=&#123;&#123;user `output_dir`&#125;&#125;"</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>        <span class="token string">"vsphere-iso-base"</span>      <span class="token punctuation">]</span><span class="token punctuation">,</span>      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"vsphere"</span><span class="token punctuation">,</span>      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"shell-local"</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ„å»º"><a href="#æ„å»º" class="headerlink" title="æ„å»º"></a>æ„å»º</h3><p><a href="https://github.com/muzi502/packer-vsphere-example">packer-vsphere-example</a> é¡¹ç›®çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>/packer-vsphere-exampleâ”œâ”€â”€ kickstart        <span class="token comment"># kickstart é…ç½®æ–‡ä»¶å­˜æ”¾ç›®å½•</span>â”œâ”€â”€ Makefile         <span class="token comment"># makefileï¼Œmake å‘½ä»¤çš„æ“ä½œçš„å…¥å£</span>â”œâ”€â”€ packer           <span class="token comment"># packer é…ç½®æ–‡ä»¶</span>â”‚   â”œâ”€â”€ builder.json <span class="token comment"># packer builder é…ç½®æ–‡ä»¶</span>â”‚   â”œâ”€â”€ centos7.json <span class="token comment"># centos iso å®‰è£… os çš„é…ç½®</span>â”‚   â”œâ”€â”€ common.json  <span class="token comment"># ä¸€äº›å…¬å…±é…ç½®å‚æ•°</span>â”‚   â”œâ”€â”€ photon3.json <span class="token comment"># photon3 iso å®‰è£… os çš„é…ç½®</span>â”‚   â””â”€â”€ vcenter.json <span class="token comment"># vcenter ç›¸å…³çš„é…ç½®</span>â”œâ”€â”€ resources        <span class="token comment"># ä¸€äº› k8s manifests æ–‡ä»¶</span>â””â”€â”€ scripts          <span class="token comment"># æ„å»ºè¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„è„šæœ¬æ–‡ä»¶</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸ docker ç±»ä¼¼ï¼Œpacker æ‰§è¡Œæ„å»ºæ“ä½œçš„å­å‘½ä»¤åŒæ ·ä¹Ÿæ˜¯ buildï¼Œå³ <code>packer build</code>ï¼Œä¸è¿‡ packer build å‘½ä»¤æ”¯æŒçš„é€‰é¡¹å¹¶æ²¡æœ‰ docker é‚£ä¹ˆä¸°å¯Œã€‚æœ€æ ¸å¿ƒé€‰é¡¹å°±æ˜¯ -except, -only, -var,  -var-file è¿™å‡ ä¸ªï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ packer buildOptions:<span class="token comment"># æ§åˆ¶ç»ˆç«¯é¢œè‰²è¾“å‡º</span>  -color<span class="token operator">=</span>false                  Disable color output. <span class="token punctuation">(</span>Default: color<span class="token punctuation">)</span>  <span class="token comment"># debug æ¨¡å¼ï¼Œç±»ä¼¼äºæ–­ç‚¹çš„æ–¹å¼è¿è¡Œ</span>  -debug                        Debug mode enabled <span class="token keyword">for</span> builds.  <span class="token comment"># æ’é™¤ä¸€äº› builderï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible çš„ --skip-tags</span>  -except<span class="token operator">=</span>foo,bar,baz           Run all builds and post-processors other than these.  <span class="token comment"># æŒ‡å®šè¿è¡ŒæŸäº› builderï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible çš„ --tags</span>  -only<span class="token operator">=</span>foo,bar,baz             Build only the specified builds.  <span class="token comment"># å¼ºåˆ¶æ„å»ºï¼Œå¦‚æœæ„å»ºç›®æ ‡å·²ç»å­˜åœ¨åˆ™å¼ºåˆ¶åˆ é™¤é‡æ–°æ„å»º</span>  -force                        Force a build to <span class="token builtin class-name">continue</span> <span class="token keyword">if</span> artifacts exist, deletes existing artifacts.  -machine-readable             Produce machine-readable output.  <span class="token comment"># å‡ºç°é”™è¯¯ä¹‹åçš„åŠ¨ä½œï¼Œcleanup æ¸…ç†æ‰€æœ‰æ“ä½œã€abort ä¸­æ–­æ‰§è¡Œã€ask è¯¢é—®ã€</span>  -on-error<span class="token operator">=</span><span class="token punctuation">[</span>cleanup<span class="token operator">|</span>abort<span class="token operator">|</span>ask<span class="token operator">|</span>run-cleanup-provisioner<span class="token punctuation">]</span> If the build fails do: clean up <span class="token punctuation">(</span>default<span class="token punctuation">)</span>, abort, ask, or run-cleanup-provisioner.  <span class="token comment"># å¹¶è¡Œè¿è¡Œçš„ builder æ•°é‡ï¼Œé»˜è®¤æ²¡æœ‰é™åˆ¶ï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible ä¸­çš„ --forks å‚æ•°</span>  -parallel-builds<span class="token operator">=</span><span class="token number">1</span>            Number of builds to run <span class="token keyword">in</span> parallel. <span class="token number">1</span> disables parallelization. <span class="token number">0</span> means no limit <span class="token punctuation">(</span>Default: <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># UI è¾“å‡ºçš„æ—¶é—´æˆ³</span>  -timestamp-ui                 Enable prefixing of each ui output with an RFC3339 timestamp.  <span class="token comment"># å˜é‡å‚æ•°ï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible çš„ -e é€‰é¡¹</span>  -var <span class="token string">'key=value'</span>              Variable <span class="token keyword">for</span> templates, can be used multiple times.  <span class="token comment"># å˜é‡æ–‡ä»¶ï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible çš„ -e@ é€‰é¡¹</span>  -var-file<span class="token operator">=</span>path                JSON or HCL2 <span class="token function">file</span> containing user variables.<span class="token comment"># æŒ‡å®šä¸€äº› var å‚æ•°ä»¥åŠ var-file æ–‡ä»¶ï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯ builder çš„é…ç½®æ–‡ä»¶è·¯å¾„</span>$ packer build  --var <span class="token assign-left variable">ova_name</span><span class="token operator">=</span>k3s-photon3-c4ca93f --var <span class="token assign-left variable">release_version</span><span class="token operator">=</span>c4ca93f --var <span class="token assign-left variable">ovf_template</span><span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/scripts/ovf_template.xml --var <span class="token assign-left variable">template</span><span class="token operator">=</span>base-os-photon3 --var <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token variable">$&#123;VCENTER_USERNAME&#125;</span> --var <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token variable">$&#123;VCENTER_PASSWORD&#125;</span> --var <span class="token assign-left variable">vcenter_server</span><span class="token operator">=</span><span class="token variable">$&#123;VCENTER_SERVER&#125;</span> --var <span class="token assign-left variable">build_name</span><span class="token operator">=</span>k3s-photon3 --var <span class="token assign-left variable">output_dir</span><span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/output/k3s-photon3-c4ca93f -only vsphere-clone -var-file<span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/vcenter.json -var-file<span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/photon3.json -var-file<span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/common.json /root/usr/src/github.com/muzi502/packer-vsphere-example/packer/builder.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢é‚£ä¸ªåˆé•¿åˆè‡­çš„ packer build å‘½ä»¤æˆ‘ä»¬åœ¨ <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/Makefile">Makefile</a> é‡Œå°è£…ä¸€ä¸‹ï¼Œé‚£ä¹ˆå¤šçš„å‚æ•°é€‰é¡¹æ‰‹åŠ¨è¾“èµ·æ¥èƒ½æŠŠäººæ°”ç–¯ ğŸ˜‚</p><ul><li>é¦–å…ˆå®šä¹‰ä¸€äº›é»˜è®¤çš„å‚æ•°ï¼Œæ¯”å¦‚æ„å»ºç‰ˆæœ¬ã€æ„å»ºæ—¶é—´ã€base æ¨¡ç‰ˆåç§°ã€å¯¼å‡º ova æ–‡ä»¶åç§°ç­‰ç­‰ã€‚</li></ul><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># Ensure Make is run with bash shell as some syntax below is bash-specific</span>SHELL<span class="token operator">:=</span>/usr/bin/env bash.DEFAULT_GOAL<span class="token operator">:=</span>help<span class="token comment"># Full directory of where the Makefile resides</span>ROOT_DIR <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> dirname <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">realpath</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">firstword</span> <span class="token variable">$</span><span class="token punctuation">(</span>MAKEFILE_LIST<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>RELEASE_VERSION       <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> git describe --tags --always --dirty<span class="token punctuation">)</span>RELEASE_TIME          <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> date -u +<span class="token string">'%Y-%m-%dT%H:%M:%SZ'</span><span class="token punctuation">)</span>PACKER_IMAGE          <span class="token operator">?=</span> hashicorp/packer<span class="token punctuation">:</span>1.8PACKER_CONFIG_DIR     <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/packerPACKER_FORCE          <span class="token operator">?=</span> falsePACKER_OVA_PREFIX     <span class="token operator">?=</span> k3sPACKER_BASE_OS        <span class="token operator">?=</span> centos7PACKER_OUTPUT_DIR     <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/outputPACKER_TEMPLATE_NAME  <span class="token operator">?=</span> base-os-<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span>OVF_TEMPLATE          <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/scripts/ovf_template.xmlPACKER_OVA_NAME       <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_PREFIX<span class="token punctuation">)</span>-<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span>-<span class="token variable">$</span><span class="token punctuation">(</span>RELEASE_VERSION<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ç„¶åå®šä¹‰ vars å’Œ var-file å‚æ•°</li></ul><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># æ˜¯å¦ä¸ºå¼ºåˆ¶æ„å»ºï¼Œå¢åŠ  force å‚æ•°</span><span class="token keyword">ifeq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_FORCE<span class="token punctuation">)</span>, true<span class="token punctuation">)</span>  PACKER_FORCE_ARG <span class="token operator">=</span> --force<span class="token operator">=</span>true<span class="token keyword">endif</span><span class="token comment"># å®šä¹‰ vars å¯å˜å‚æ•°ï¼Œæ¯”å¦‚ vcenter ç”¨æˆ·åã€å¯†ç  ç­‰å‚æ•°</span>PACKER_VARS <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_FORCE_ARG<span class="token punctuation">)</span> \            <span class="token comment"># æ˜¯å¦å¼ºåˆ¶æ„å»º</span>--var ova_name<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_NAME<span class="token punctuation">)</span> \          <span class="token comment"># OVA æ–‡ä»¶å</span>--var release_version<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>RELEASE_VERSION<span class="token punctuation">)</span> \   <span class="token comment"># å‘å¸ƒç‰ˆæœ¬</span>--var ovf_template<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>OVF_TEMPLATE<span class="token punctuation">)</span> \         <span class="token comment"># OVF æ¨¡ç‰ˆæ–‡ä»¶</span>--var template<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_TEMPLATE_NAME<span class="token punctuation">)</span> \     <span class="token comment"># OVA çš„ base è™šæ‹Ÿæœºæ¨¡ç‰ˆåç§°</span>--var username<span class="token operator">=</span><span class="token variable">$$</span><span class="token punctuation">&#123;</span>VCENTER_USERNAME<span class="token punctuation">&#125;</span> \        <span class="token comment"># vCenter ç”¨æˆ·åï¼ˆç¯å¢ƒå˜é‡ï¼‰</span>--var password<span class="token operator">=</span><span class="token variable">$$</span><span class="token punctuation">&#123;</span>VCENTER_PASSWORD<span class="token punctuation">&#125;</span> \        <span class="token comment"># vCenter å¯†ç ï¼ˆç¯å¢ƒå˜é‡ï¼‰</span>--var vcenter_server<span class="token operator">=</span><span class="token variable">$$</span><span class="token punctuation">&#123;</span>VCENTER_SERVER<span class="token punctuation">&#125;</span> \    <span class="token comment"># vCenter è®¿é—®åœ°å€ï¼ˆç¯å¢ƒå˜é‡ï¼‰</span>--var build_name<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_PREFIX<span class="token punctuation">)</span>-<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span> \  <span class="token comment"># æ„å»ºåç§°</span>--var output_dir<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OUTPUT_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_NAME<span class="token punctuation">)</span>   <span class="token comment"># OVA å¯¼å‡ºçš„ç›®å½•</span><span class="token comment"># å®šä¹‰ var-file å‚æ•°</span>PACKER_VAR_FILES <span class="token operator">=</span> -var-file<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/vcenter.json \ <span class="token comment"># vCenter çš„å‚æ•°é…ç½®</span>-var-file<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span>.json \        <span class="token comment"># OS çš„å‚æ•°é…ç½®</span>-var-file<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/common.json                     <span class="token comment"># ä¸€äº›å…¬å…±é…ç½®</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æœ€åå®šä¹‰ make targrt</li></ul><pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> build-template<span class="token comment"># é€šè¿‡ ISO å®‰è£… OS æ„å»ºä¸€ä¸ª base è™šæ‹Ÿæœº</span><span class="token target symbol">build-template</span><span class="token punctuation">:</span> <span class="token comment">## build the base os template by iso</span>packer build <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VARS<span class="token punctuation">)</span> -only vsphere-iso-base <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VAR_FILES<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/builder.json<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> build-ovf<span class="token comment"># é€šè¿‡ clone æ–¹å¼æ„å»ºå¹¶å¯¼å‡º OVF/OVA</span><span class="token target symbol">build-ovf</span><span class="token punctuation">:</span> <span class="token comment">## build the ovf template by clone the base os template</span>packer build <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VARS<span class="token punctuation">)</span> -only vsphere-clone <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VAR_FILES<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/builder.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ„å»º BASE æ¨¡ç‰ˆ</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># é€šè¿‡ PACKER_BASE_OS å‚æ•°è®¾ç½® base os æ˜¯ photon3 è¿˜æ˜¯ centos7</span>$ <span class="token function">make</span> build-template <span class="token assign-left variable">PACKER_BASE_OS</span><span class="token operator">=</span>photon3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>æ„å»º OVF æ¨¡ç‰ˆå¹¶å¯¼å‡ºä¸º OVA</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># é€šè¿‡ PACKER_BASE_OS å‚æ•°è®¾ç½® base os æ˜¯ photon3 è¿˜æ˜¯ centos7</span>$ <span class="token function">make</span> build-ovf <span class="token assign-left variable">PACKER_BASE_OS</span><span class="token operator">=</span>photon3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="æ„å»ºæµç¨‹"><a href="#æ„å»ºæµç¨‹" class="headerlink" title="æ„å»ºæµç¨‹"></a>æ„å»ºæµç¨‹</h2><p>å°† Packer çš„é…ç½®æ–‡ä»¶ä»¥åŠ Makefile å°è£…å¥½ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿è¡Œ <code>make build-template</code> å’Œ <code>make build-ovf</code> å‘½ä»¤æ¥æ„å»ºè™šæ‹Ÿæœºæ¨¡ç‰ˆäº†ï¼Œæ•´ä½“çš„æ„å»ºæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>å…ˆä½¿ç”¨ ISO æ„å»ºä¸€ä¸ªä¸ä¸šåŠ¡æ— å…³çš„ base è™šæ‹Ÿæœº</li><li>åœ¨ base è™šæ‹Ÿæœºä¹‹ä¸Šé€šè¿‡ vsphere-clone æ–¹å¼æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœº</li><li>å¯¼å‡º OVF è™šæ‹Ÿæœºæ–‡ä»¶ï¼Œæ‰“åŒ…æˆ OVA æ ¼å¼çš„è™šæ‹Ÿæœºæ¨¡ç‰ˆ</li></ul><h3 id="é€šè¿‡-vsphere-iso-æ„å»º-Base-è™šæ‹Ÿæœº"><a href="#é€šè¿‡-vsphere-iso-æ„å»º-Base-è™šæ‹Ÿæœº" class="headerlink" title="é€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœº"></a>é€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœº</h3><p>base è™šæ‹Ÿæœºæœ‰ç‚¹ç±»ä¼¼äº Dockerfile ä¸­çš„ FROM base é•œåƒã€‚åœ¨ Packer ä¸­æˆ‘ä»¬å¯ä»¥æŠŠä¸€äº›å¾ˆå°‘ä¼šæ”¹åŠ¨çš„å†…å®¹åšæˆä¸€ä¸ª base è™šæ‹Ÿæœºã€‚ç„¶åä»è¿™ä¸ª base è™šæ‹Ÿæœºå…‹éš†å‡ºä¸€å°æ–°çš„è™šæ‹Ÿæœºæ¥å®Œæˆæ¥ä¸‹æ¥çš„æ„å»ºæµç¨‹ï¼Œè¿™æ ·èƒ½å¤ŸèŠ‚çœæ•´ä½“çš„æ„å»ºè€—æ—¶ï¼Œä½¿å¾—æ„å»ºæ•ˆç‡æ›´é«˜ä¸€äº›ã€‚</p><ul><li>centos7 æ„å»ºè¾“å‡ºæ—¥å¿—</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vsphere-iso-base: output will be <span class="token keyword">in</span> this color.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: File /root/.cache/packer/e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso already uploaded<span class="token punctuation">;</span> continuing<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: File <span class="token punctuation">[</span>Packer<span class="token punctuation">]</span> packer_cache//e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso already exists<span class="token punctuation">;</span> skipping upload.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: the vm/template Packer/base-os-centos7 already exists, but deleting it due to -force flag<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating VM<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Customizing hardware<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Mounting ISO images<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding configuration parameters<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating floppy disk<span class="token punctuation">..</span>.    vsphere-iso-base: Copying files flatly from floppy_files    vsphere-iso-base: Done copying files from floppy_files    vsphere-iso-base: Collecting paths from floppy_dirs    vsphere-iso-base: Resulting paths from floppy_dirs <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>./kickstart/centos/http/<span class="token punctuation">]</span>    vsphere-iso-base: Recursively copying <span class="token builtin class-name">:</span> ./kickstart/centos/http/    vsphere-iso-base: Done copying paths from floppy_dirs    vsphere-iso-base: Copying files from floppy_content    vsphere-iso-base: Done copying files from floppy_content<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Uploading created floppy image<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding generated Floppy<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Set boot order temporary<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Power on VM<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting 15s <span class="token keyword">for</span> boot<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Typing boot command<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting <span class="token keyword">for</span> IP<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: IP address: <span class="token number">192.168</span>.29.46<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Using SSH communicator to connect: <span class="token number">192.168</span>.29.46<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting <span class="token keyword">for</span> SSH to become available<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Connected to SSH<span class="token operator">!</span><span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Executing <span class="token function">shutdown</span> command<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Deleting Floppy drives<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Deleting Floppy image<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Eject CD-ROM drives<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating snapshot<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Clear boot order<span class="token punctuation">..</span>.Build <span class="token string">'vsphere-iso-base'</span> finished after <span class="token number">6</span> minutes <span class="token number">42</span> seconds.<span class="token operator">==</span><span class="token operator">></span> Wait completed after <span class="token number">6</span> minutes <span class="token number">42</span> seconds<span class="token operator">==</span><span class="token operator">></span> Builds finished. The artifacts of successful builds are:--<span class="token operator">></span> vsphere-iso-base: base-os-centos7<span class="token punctuation">[</span>root@localhost:/vmfs/volumes/622aec5b-de94a27c-948e-00505680fb1d<span class="token punctuation">]</span> <span class="token function">ls</span> packer_cache/51511394170e64707b662ca8db012be4d23e121f.iso  d3e175624fc2d704975ce9a149f8f270e4768727.iso  e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso<span class="token punctuation">[</span>root@localhost:/vmfs/volumes/622aec5b-de94a27c-948e-00505680fb1d<span class="token punctuation">]</span> <span class="token function">ls</span> -alh base-os-centos7/total <span class="token number">4281536</span>drwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">72</span>.0K Apr  <span class="token number">1</span> 09:17 <span class="token builtin class-name">.</span>drwxr-xr-t    <span class="token number">1</span> root     root       <span class="token number">76</span>.0K Apr  <span class="token number">1</span> 09:17 <span class="token punctuation">..</span>-rw-------    <span class="token number">1</span> root     root        <span class="token number">4</span>.0G Apr  <span class="token number">1</span> 09:17 base-os-centos7-3ea6b205.vswp-rw-r--r--    <span class="token number">1</span> root     root         <span class="token number">253</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7-65ff34a3.hlog-rw-------    <span class="token number">1</span> root     root       <span class="token number">64</span>.0G Apr  <span class="token number">1</span> 09:17 base-os-centos7-flat.vmdk-rw-------    <span class="token number">1</span> root     root        <span class="token number">8</span>.5K Apr  <span class="token number">1</span> 09:17 base-os-centos7.nvram-rw-------    <span class="token number">1</span> root     root         <span class="token number">482</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmdk-rw-r--r--    <span class="token number">1</span> root     root           <span class="token number">0</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmsd-rwxr-xr-x    <span class="token number">1</span> root     root        <span class="token number">2</span>.3K Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmx-rw-------    <span class="token number">1</span> root     root           <span class="token number">0</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmx.lck-rwxr-xr-x    <span class="token number">1</span> root     root        <span class="token number">2</span>.2K Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmx~-rw-------    <span class="token number">1</span> root     root        <span class="token number">1</span>.4M Apr  <span class="token number">1</span> 09:17 packer-tmp-created-floppy.flp-rw-r--r--    <span class="token number">1</span> root     root       <span class="token number">96</span>.1K Apr  <span class="token number">1</span> 09:17 vmware.logroot@devbox-fedora:/root <span class="token comment"># scp 192.168.24.43:/vmfs/volumes/Packer/base-os-centos7/packer-tmp-created-floppy.flp .</span>root@devbox-fedora:/root <span class="token comment"># mount packer-tmp-created-floppy.flp /mnt</span>root@devbox-fedora:/root <span class="token comment"># readlink /dev/disk/by-label/packer</span><span class="token punctuation">..</span>/<span class="token punctuation">..</span>/loop2root@devbox-fedora:/root <span class="token comment"># ls /mnt/HTTP/7/KS.CFG</span>KS.CFG<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Photon3 æ„å»ºè¾“å‡ºæ—¥å¿—</li></ul><pre class="line-numbers language-none"><code class="language-none">vsphere-iso-base: output will be in this color.&#x3D;&#x3D;&gt; vsphere-iso-base: File &#x2F;root&#x2F;.cache&#x2F;packer&#x2F;d3e175624fc2d704975ce9a149f8f270e4768727.iso already uploaded; continuing&#x3D;&#x3D;&gt; vsphere-iso-base: File [Packer] packer_cache&#x2F;&#x2F;d3e175624fc2d704975ce9a149f8f270e4768727.iso already exists; skipping upload.&#x3D;&#x3D;&gt; vsphere-iso-base: the vm&#x2F;template Packer&#x2F;base-os-photon3 already exists, but deleting it due to -force flag&#x3D;&#x3D;&gt; vsphere-iso-base: Creating VM...&#x3D;&#x3D;&gt; vsphere-iso-base: Customizing hardware...&#x3D;&#x3D;&gt; vsphere-iso-base: Mounting ISO images...&#x3D;&#x3D;&gt; vsphere-iso-base: Adding configuration parameters...&#x3D;&#x3D;&gt; vsphere-iso-base: Starting HTTP server on port 8674&#x3D;&#x3D;&gt; vsphere-iso-base: Set boot order temporary...&#x3D;&#x3D;&gt; vsphere-iso-base: Power on VM...&#x3D;&#x3D;&gt; vsphere-iso-base: Waiting 15s for boot...&#x3D;&#x3D;&gt; vsphere-iso-base: HTTP server is working at http:&#x2F;&#x2F;192.168.29.171:8674&#x2F;&#x3D;&#x3D;&gt; vsphere-iso-base: Typing boot command...&#x3D;&#x3D;&gt; vsphere-iso-base: Waiting for IP...&#x3D;&#x3D;&gt; vsphere-iso-base: IP address: 192.168.29.208&#x3D;&#x3D;&gt; vsphere-iso-base: Using SSH communicator to connect: 192.168.29.208&#x3D;&#x3D;&gt; vsphere-iso-base: Waiting for SSH to become available...&#x3D;&#x3D;&gt; vsphere-iso-base: Connected to SSH!&#x3D;&#x3D;&gt; vsphere-iso-base: Executing shutdown command...&#x3D;&#x3D;&gt; vsphere-iso-base: Deleting Floppy drives...&#x3D;&#x3D;&gt; vsphere-iso-base: Eject CD-ROM drives...&#x3D;&#x3D;&gt; vsphere-iso-base: Creating snapshot...&#x3D;&#x3D;&gt; vsphere-iso-base: Clear boot order...Build &#39;vsphere-iso-base&#39; finished after 5 minutes 24 seconds.&#x3D;&#x3D;&gt; Wait completed after 5 minutes 24 seconds&#x3D;&#x3D;&gt; Builds finished. The artifacts of successful builds are:--&gt; vsphere-iso-base: base-os-photon3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ <code>packer build</code> å‘½ä»¤çš„è¾“å‡ºæˆ‘ä»¬å¤§è‡´å¯ä»¥æ¨æ–­å‡ºé€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœºçš„ä¸»è¦æ­¥éª¤å’ŒåŸç†ï¼š</p><ul><li>ä¸‹è½½ ISO æ–‡ä»¶åˆ°æœ¬åœ°çš„ ${HOME}&#x2F;.cache&#x2F;packer ç›®å½•ï¼Œå¹¶ä»¥ checksum.iso æ–¹å¼ä¿å­˜ï¼Œè¿™æ ·çš„å¥½å¤„å°±æ˜¯ä¾¿äºç¼“å­˜ ISO æ–‡ä»¶ï¼Œé¿å…é‡å¤ä¸‹è½½ï¼›</li><li>ä¸Šä¼ æœ¬åœ° ISO æ–‡ä»¶åˆ° vCenter çš„ datastore ä¸­ï¼Œé»˜è®¤ä¿å­˜åœ¨ datastore çš„ packer_cache ç›®å½•ä¸‹ï¼Œå¦‚æœ ISO æ–‡ä»¶å·²ç»å­˜åœ¨äº†ï¼Œåˆ™ä¼šè·³è¿‡ä¸Šä¼ çš„æµç¨‹ï¼›</li><li>åˆ›å»ºè™šæ‹Ÿæœºï¼Œé…ç½®è™šæ‹Ÿæœºç¡¬ä»¶ï¼ŒæŒ‚è½½ä¸Šä¼ çš„ ISO æ–‡ä»¶åˆ°è™šæ‹Ÿæœºä¸Šçš„ CD&#x2F;ROMï¼Œè®¾ç½® boot å¯åŠ¨é¡¹ä¸º CD&#x2F;ROM</li><li>å¦‚æœ <a href="https://www.packer.io/plugins/builders/vsphere/vsphere-iso#boot-configuration">boot_media_path</a> æ˜¯ http ç±»å‹çš„åˆ™åœ¨æœ¬åœ°éšæœºç›‘å¬ä¸€ä¸ª TCP ç«¯å£æ¥è¿è¡Œä¸€ä¸ª http æœåŠ¡ï¼Œç”¨äºæä¾› kickstart æ–‡ä»¶çš„ HTTP ä¸‹è½½åŠŸèƒ½ï¼›å¦‚æœæ˜¯ç›®å½•ç±»å‹çš„åˆ™å°† kickstart æ–‡ä»¶åˆ›å»ºæˆä¸€ä¸ªè½¯ç›˜æ–‡ä»¶ï¼Œå¹¶å°†è¯¥æ–‡ä»¶ä¸Šä¼ åˆ° datastore ä¸­ï¼Œå°†è½¯ç›˜æ–‡ä»¶æ’å…¥åˆ°è™šæ‹Ÿæœºä¸­ï¼›</li><li>è™šæ‹Ÿæœºå¼€æœºå¯åŠ¨åˆ° ISO å¼•å¯¼é¡µé¢ï¼Œé€šè¿‡ vCenter API å‘é€é”®ç›˜è¾“å…¥ï¼Œæ’å…¥ kickstart æ–‡ä»¶çš„è·¯å¾„ï¼›</li><li>é€šè¿‡ vCenter API å‘é€å›è½¦é”®ç›˜è¾“å…¥ï¼ŒISO ä¸­çš„ OS å®‰è£…ç¨‹åºè¯»å– kickstart è¿›è¡Œ OS å®‰è£…ï¼›</li><li>åœ¨ kickstart è„šæœ¬é‡Œå®‰è£… <a href="https://github.com/vmware/open-vm-tools">open-vm-tools</a> å·¥å…·ï¼›</li><li>ç­‰å¾… OS å®‰è£…å®Œæˆï¼Œå®‰è£…å®Œæˆé‡å¯åè¿›å…¥å®‰è£…å¥½çš„ OSï¼ŒOS å¯åŠ¨åé€šè¿‡ DHCP è·å– IP åœ°å€ï¼›</li><li>é€šè¿‡ vm-tools è·å–åˆ°è™šæ‹Ÿæœºçš„ IP åœ°å€ï¼Œç„¶å ssh è¿æ¥åˆ°è™šæ‹Ÿæœºæ‰§è¡Œå…³æœºå‘½ä»¤ï¼›</li><li>è™šæ‹Ÿæœºå…³æœºï¼Œå¸è½½ ISO å’Œè½¯é©±ç­‰ä¸éœ€è¦çš„è®¾å¤‡ï¼›</li><li>åˆ›å»ºå¿«ç…§æˆ–è€…å°†è™šæ‹Ÿæœºè½¬æ¢ä¸ºæ¨¡ç‰ˆï¼›</li></ul><p>ä¸ªäººè§‰ç€è¿™é‡Œæ¯”è¾ƒå¥½ç©å„¿å°±æ˜¯å±…ç„¶å¯ä»¥é€šè¿‡ vCenter æˆ– ESXi çš„ <a href="https://vdc-repo.vmware.com/vmwb-repository/dcr-public/1ef6c336-7bef-477d-b9bb-caa1767d7e30/82521f49-9d9a-42b7-b19b-9e6cd9b30db1/vim.VirtualMachine.html#putUsbScanCodes">PutUsbScanCodes</a> API æ¥ç»™è™šæ‹Ÿæœºå‘é€ä¸€äº›é”®ç›˜è¾“å…¥çš„æŒ‡ä»¤ï¼Œæ„Ÿè§‰è¿™ç®€ç›´å¤ªç¥å¥‡å•¦ ğŸ˜‚ã€‚ä¹‹å‰æˆ‘ä»¬çš„é¡¹ç›®æ˜¯å°† kickstart æ–‡ä»¶æ„å»ºæˆä¸€ä¸ª ISO æ–‡ä»¶ï¼Œç„¶åé€šè¿‡é‡æ–°æ„å»ºæº ISO çš„æ–¹å¼æ¥ä¿®æ”¹ isolinux å¯åŠ¨å‚æ•°ã€‚åæ¥æ„Ÿè§‰è¿™ç§é‡æ–°æ„å»º ISO çš„æ–¹å¼å¤ªè ¢äº†ï¼Œäºæ˜¯å°±å‚è€ƒ Packer çš„æ€è·¯ä½¿ç”¨ govc é‡Œå†…ç½®çš„ <a href="https://github.com/vmware/govmomi/blob/master/govc/vm/keystrokes.go">vm.keystrokes</a> å‘½ä»¤æ¥ç»™è™šæ‹Ÿæœºå‘é€é”®ç›˜æŒ‡ä»¤ï¼Œå®ŒæˆæŒ‡å®š kickstart æ–‡ä»¶è·¯å¾„å‚æ•°å¯åŠ¨çš„æ“ä½œã€‚å…·ä½“çš„ govc æ“ä½œå‘½ä»¤å¯ä»¥å‚è€ƒå¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å‘é€ tab é”®ï¼Œè¿›å…¥åˆ° ISO å¯åŠ¨å‚æ•°ç¼–è¾‘é¡µé¢</span>$ govc vm.keystrokes -vm<span class="token operator">=</span><span class="token string">'centos-vm-192'</span> -c<span class="token operator">=</span><span class="token string">'KEY_TAB'</span><span class="token comment"># å‘é€ Right Control + U é”®æ¸…ç©ºè¾“å…¥æ¡†</span>$ govc vm.keystrokes -vm<span class="token operator">=</span><span class="token string">'centos-vm-192'</span> -rc<span class="token operator">=</span>true -c<span class="token operator">=</span><span class="token string">'KEY_U'</span><span class="token comment"># è¾“å…¥ isolinux çš„å¯åŠ¨å‚æ•°é…ç½®ï¼Œé€šè¿‡ ks=hd:LABEL=KS:/ks.cfg æŒ‡å®š kickstart è·¯å¾„ï¼ŒLABEL ä¸ºæ„å»º ISO æ—¶è®¾ç½®çš„ lable</span>$ govc vm.keystrokes -vm<span class="token operator">=</span><span class="token string">'centos-vm-192'</span> -s<span class="token operator">=</span><span class="token string">'vmlinuz initrd=initrd.img ks=hd:LABEL=KS:/ks.cfg inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 quiet console=ttyS0'</span><span class="token comment"># æŒ‰ä¸‹å›è½¦é”®ï¼Œå¼€å§‹å®‰è£… OS</span>$ govc vm.keystrokes -vm<span class="token operator">=</span><span class="token string">'centos-vm-192'</span> -c<span class="token operator">=</span><span class="token string">'KEY_ENTER'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é€šè¿‡-vsphere-clone-æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º-OVF-x2F-OVA"><a href="#é€šè¿‡-vsphere-clone-æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º-OVF-x2F-OVA" class="headerlink" title="é€šè¿‡ vsphere-clone æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º OVF&#x2F;OVA"></a>é€šè¿‡ vsphere-clone æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º OVF&#x2F;OVA</h3><p>é€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœºä¹‹åï¼Œæˆ‘ä»¬å°±ä½¿ç”¨è¿™ä¸ª base è™šæ‹Ÿæœºå…‹éš†å‡ºä¸€å°æ–°çš„è™šæ‹Ÿæœºï¼Œç”¨æ¥æ„å»ºæˆ‘ä»¬çš„ä¸šåŠ¡è™šæ‹Ÿæœºé•œåƒï¼Œå°† k3s, argo-workflow, redfish-esxi-os-installer è¿™ä¸€å †å·¥å…·æ‰“åŒ…è¿›å»ï¼›</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vsphere-clone: output will be <span class="token keyword">in</span> this color.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Cloning VM<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Customizing hardware<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Power on VM<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Waiting <span class="token keyword">for</span> IP<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: IP address: <span class="token number">192.168</span>.30.112<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Using SSH communicator to connect: <span class="token number">192.168</span>.30.112<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Waiting <span class="token keyword">for</span> SSH to become available<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Connected to SSH<span class="token operator">!</span><span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Uploading scripts <span class="token operator">=</span><span class="token operator">></span> /root<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Uploading resources <span class="token operator">=</span><span class="token operator">></span> /root<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Provisioning with shell script: /tmp/packer-shell557168976<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Executing <span class="token function">shutdown</span> command<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Creating snapshot<span class="token punctuation">..</span>.    vsphere-clone: Starting export<span class="token punctuation">..</span>.    vsphere-clone: Downloading: k3s-photon3-c4ca93f-disk-0.vmdk    vsphere-clone: Exporting file: k3s-photon3-c4ca93f-disk-0.vmdk    vsphere-clone: Writing ovf<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Running post-processor: packer-manifest <span class="token punctuation">(</span>type manifest<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Running post-processor: vsphere <span class="token punctuation">(</span>type shell-local<span class="token punctuation">)</span><span class="token operator">==</span><span class="token operator">></span> vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: Running <span class="token builtin class-name">local</span> shell script: /tmp/packer-shell2376077966    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: <span class="token builtin class-name">cd</span> /root/usr/src/github.com/muzi502/packer-vsphere-example/output/k3s-photon3-c4ca93f    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: create ovf k3s-photon3-c4ca93f.ovf    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: create ova manifest k3s-photon3-c4ca93f.mf    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: creating OVA using <span class="token function">tar</span>    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: <span class="token punctuation">[</span><span class="token string">'tar'</span>, <span class="token string">'-c'</span>, <span class="token string">'-f'</span>, <span class="token string">'k3s-photon3-c4ca93f.ova'</span>, <span class="token string">'k3s-photon3-c4ca93f.ovf'</span>, <span class="token string">'k3s-photon3-c4ca93f.mf'</span>, <span class="token string">'k3s-photon3-c4ca93f-disk-0.vmdk'</span><span class="token punctuation">]</span>    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: create ova checksum k3s-photon3-c4ca93f.ova.sha256Build <span class="token string">'vsphere-clone'</span> finished after <span class="token number">14</span> minutes <span class="token number">16</span> seconds.<span class="token operator">==</span><span class="token operator">></span> Wait completed after <span class="token number">14</span> minutes <span class="token number">16</span> seconds<span class="token operator">==</span><span class="token operator">></span> Builds finished. The artifacts of successful builds are:--<span class="token operator">></span> vsphere-clone: k3s-photon3-c4ca93f--<span class="token operator">></span> vsphere-clone: k3s-photon3-c4ca93f--<span class="token operator">></span> vsphere-clone: k3s-photon3-c4ca93f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ packer build å‘½ä»¤çš„è¾“å‡ºæˆ‘ä»¬å¤§è‡´å¯ä»¥æ¨æ–­å‡ºæ„å»ºæµç¨‹ï¼š</p><ul><li>clone è™šæ‹Ÿæœºï¼Œä¿®æ”¹è™šæ‹Ÿæœºçš„ç¡¬ä»¶é…ç½®</li><li>è™šæ‹Ÿæœºå¼€æœºï¼Œé€šè¿‡ vm-tools è·å–è™šæ‹Ÿæœºçš„ IP åœ°å€</li><li>è·å–åˆ°è™šæ‹Ÿæœºçš„ IP åœ°å€åç­‰å¾… ssh èƒ½å¤Ÿæ­£å¸¸è¿æ¥</li><li>ssh èƒ½å¤Ÿæ­£å¸¸è¿æ¥åï¼Œé€šè¿‡ scp çš„æ–¹å¼ä¸Šä¼ æ–‡ä»¶</li><li>ssh è¿œç¨‹æ‰§è¡Œè™šæ‹Ÿæœºé‡Œçš„ <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/install.sh">install.sh</a> è„šæœ¬</li><li>æ‰§è¡Œè™šæ‹Ÿæœºå…³æœºå‘½ä»¤</li><li>åˆ›å»ºè™šæ‹Ÿæœºå¿«ç…§</li><li>å¯¼å‡ºè™šæ‹Ÿæœº OVF æ–‡ä»¶</li><li>å¯¼å‡ºæ„å»ºé…ç½®å‚æ•°çš„ manifest.json æ–‡ä»¶</li><li>æ‰§è¡Œ <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/ova.py">ova.py</a> è„šæœ¬ï¼Œæ ¹æ® manifest.json é…ç½®å‚æ•°å°† OVF æ ¼å¼è½¬æ¢æˆ OVA</li></ul><p>è‡³æ­¤ï¼Œæ•´ä¸ªçš„è™šæ‹Ÿæœºæ¨¡ç‰ˆçš„æ„å»ºæµç¨‹ç®—æ˜¯å®Œæˆäº†ï¼Œæœ€ç»ˆæˆ‘ä»¬çš„åˆ°ä¸€ä¸ª OVA æ ¼å¼çš„è™šæ‹Ÿæœºæ¨¡ç‰ˆã€‚ä½¿ç”¨çš„æ—¶å€™åªéœ€è¦åœ¨æœ¬åœ°æœºå™¨ä¸Šå®‰è£…å¥½ VMware Workstation æˆ–è€… Oracle VirtualBox å°±èƒ½ä¸€é”®å¯¼å…¥è¯¥è™šæ‹Ÿæœºï¼Œå¼€æœºåå°±å¯ä»¥ä½¿ç”¨å•¦ï¼Œç®—æ˜¯åšåˆ°äº†å¼€ç®±å³ç”¨çš„æ•ˆæœã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">outputâ””â”€â”€ k3s-photon3-c4ca93f    â”œâ”€â”€ k3s-photon3-c4ca93f-disk-0.vmdk    â”œâ”€â”€ k3s-photon3-c4ca93f.mf    â”œâ”€â”€ k3s-photon3-c4ca93f.ova    â”œâ”€â”€ k3s-photon3-c4ca93f.ova.sha256    â”œâ”€â”€ k3s-photon3-c4ca93f.ovf    â””â”€â”€ packer-manifest.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="argo-workflow-å’Œ-k3s"><a href="#argo-workflow-å’Œ-k3s" class="headerlink" title="argo-workflow å’Œ k3s"></a>argo-workflow å’Œ k3s</h2><p>åœ¨è™šæ‹Ÿæœºå†…ä½¿ç”¨ redfish-esxi-os-installer æœ‰ç‚¹ç‰¹æ®Šï¼Œæ˜¯å°†å®ƒæ”¾åœ¨ argo-workflow çš„ Pod å†…æ¥æ‰§è¡Œçš„ã€‚åœ¨ workflow æ¨¡ç‰ˆæ–‡ä»¶ <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/resources/workflow/workflow.yaml">workflow.yaml</a> ä¸­æˆ‘ä»¬å®šä¹‰äº†è‹¥å¹²ä¸ª steps æ¥è¿è¡Œ redfish-esxi-os-installerã€‚</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Workflow<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">generateName</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">-</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer  <span class="token key atrule">templates</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer    <span class="token key atrule">steps</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command            <span class="token key atrule">value</span><span class="token punctuation">:</span> pre<span class="token punctuation">-</span>check        <span class="token key atrule">name</span><span class="token punctuation">:</span> Precheck        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command            <span class="token key atrule">value</span><span class="token punctuation">:</span> build<span class="token punctuation">-</span>iso        <span class="token key atrule">name</span><span class="token punctuation">:</span> BuildISO        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command            <span class="token key atrule">value</span><span class="token punctuation">:</span> mount<span class="token punctuation">-</span>iso        <span class="token key atrule">name</span><span class="token punctuation">:</span> MountISO        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command            <span class="token key atrule">value</span><span class="token punctuation">:</span> reboot        <span class="token key atrule">name</span><span class="token punctuation">:</span> Reboot        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command            <span class="token key atrule">value</span><span class="token punctuation">:</span> post<span class="token punctuation">-</span>check        <span class="token key atrule">name</span><span class="token punctuation">:</span> Postcheck        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command            <span class="token key atrule">value</span><span class="token punctuation">:</span> umount<span class="token punctuation">-</span>iso        <span class="token key atrule">name</span><span class="token punctuation">:</span> UmountISO        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer  <span class="token punctuation">-</span> <span class="token key atrule">container</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> installer      <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/muzi502/redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">:</span>v0.1.0<span class="token punctuation">-</span>alpha.1      <span class="token key atrule">command</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> bash      <span class="token punctuation">-</span> <span class="token punctuation">-</span>c      <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">        make inventory &amp;&amp; make &#123;&#123;inputs.parameters.command&#125;&#125;</span>      <span class="token key atrule">env</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>          <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>            <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> HOST_IP        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>          <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>            <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.hostIP      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SRC_ISO_DIR        <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/iso      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> HTTP_DIR        <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/iso/redfish      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> HTTP_URL        <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$(HOST_IP)/files/iso/redfish      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ESXI_ISO        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>          <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">-</span>config            <span class="token key atrule">key</span><span class="token punctuation">:</span> esxi_iso      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>        <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /ansible/config.yaml        <span class="token key atrule">name</span><span class="token punctuation">:</span> config        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">subPath</span><span class="token punctuation">:</span> config.yaml      <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data        <span class="token key atrule">name</span><span class="token punctuation">:</span> data    <span class="token key atrule">inputs</span><span class="token punctuation">:</span>      <span class="token key atrule">parameters</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command    <span class="token key atrule">name</span><span class="token punctuation">:</span> installer    <span class="token key atrule">retryStrategy</span><span class="token punctuation">:</span>      <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token string">"2"</span>      <span class="token key atrule">retryPolicy</span><span class="token punctuation">:</span> OnFailure  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">configMap</span><span class="token punctuation">:</span>      <span class="token key atrule">items</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> config        <span class="token key atrule">path</span><span class="token punctuation">:</span> config.yaml      <span class="token key atrule">name</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">-</span>config    <span class="token key atrule">name</span><span class="token punctuation">:</span> config  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”±äºç›®å‰æ²¡æœ‰ Web UI å’Œåç«¯ Server æ‰€ä»¥è¿˜æ˜¯éœ€è¦æ‰‹åŠ¨ç¼–è¾‘ <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/resources/workflow/configmap.yaml">&#x2F;root&#x2F;resources&#x2F;workflow&#x2F;configmap.yaml</a> é…ç½®æ–‡ä»¶ï¼Œç„¶åå†æ‰§è¡Œ <code>kubectl create -f /root/resources/workflow</code> å‘½ä»¤åˆ›å»º workflow å·¥ä½œæµã€‚</p><p>workflow åˆ›å»ºäº†ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡ argo å‘½ä»¤æŸ¥çœ‹ workflow æ‰§è¡Œçš„è¿›åº¦å’ŒçŠ¶æ€</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@localhost <span class="token punctuation">[</span> ~/resources/workflow <span class="token punctuation">]</span><span class="token comment"># argo get redfish-esxi-os-installer-tjjqz</span>Name:                redfish-esxi-os-installer-tjjqzNamespace:           defaultServiceAccount:      <span class="token builtin class-name">unset</span> <span class="token punctuation">(</span>will run with the default ServiceAccount<span class="token punctuation">)</span>Status:              SucceededConditions: PodRunning          False Completed           TrueCreated:             Mon May <span class="token number">23</span> <span class="token number">11</span>:07:31 +0000 <span class="token punctuation">(</span><span class="token number">16</span> minutes ago<span class="token punctuation">)</span>Started:             Mon May <span class="token number">23</span> <span class="token number">11</span>:07:31 +0000 <span class="token punctuation">(</span><span class="token number">16</span> minutes ago<span class="token punctuation">)</span>Finished:            Mon May <span class="token number">23</span> <span class="token number">11</span>:23:38 +0000 <span class="token punctuation">(</span><span class="token number">19</span> seconds ago<span class="token punctuation">)</span>Duration:            <span class="token number">16</span> minutes <span class="token number">7</span> secondsProgress:            <span class="token number">6</span>/6ResourcesDuration:   29m45s*<span class="token punctuation">(</span><span class="token number">1</span> cpu<span class="token punctuation">)</span>,29m45s*<span class="token punctuation">(</span>100Mi memory<span class="token punctuation">)</span>STEP                                TEMPLATE                   PODNAME                                     DURATION  MESSAGE âœ” redfish-esxi-os-installer-tjjqz  redfish-esxi-os-installer â”œâ”€â”€â”€âœ” Precheck<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-647555770   11s â”œâ”€â”€â”€âœ” BuildISO<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-3078771217  14s â”œâ”€â”€â”€âœ” MountISO<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-4099695623  19s â”œâ”€â”€â”€âœ” Reboot<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                    installer                  redfish-esxi-os-installer-tjjqz-413209187   7s â”œâ”€â”€â”€âœ” Postcheck<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                 installer                  redfish-esxi-os-installer-tjjqz-2674696793  14m â””â”€â”€â”€âœ” UmountISO<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                 installer                  redfish-esxi-os-installer-tjjqz-430254503   13s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="argo-workflow"><a href="#argo-workflow" class="headerlink" title="argo-workflow"></a>argo-workflow</h3><p>ä¹‹æ‰€ä»¥ä½¿ç”¨ argo-workflow è€Œä¸æ˜¯ä½¿ç”¨åƒ dockerã€nerdctl è¿™äº›å‘½ä»¤è¡Œå·¥å…·æ¥è¿è¡Œ redfish-esxi-os-installer ï¼Œæ˜¯å› ä¸ºé€šè¿‡ argo-workflow æ¥ç¼–æ’æˆ‘ä»¬çš„å®‰è£…éƒ¨ç½²ä»»åŠ¡èƒ½å¤Ÿæ¯”è¾ƒæ–¹ä¾¿åœ°å®ç°å¤šä¸ªä»»åŠ¡åŒæ—¶è¿è¡Œã€è·å–ä»»åŠ¡æ‰§è¡Œçš„è¿›åº¦åŠæ—¥å¿—ã€è·å–ä»»åŠ¡æ‰§è¡Œçš„è€—æ—¶ã€åœæ­¢é‡è¯•ç­‰åŠŸèƒ½ã€‚ä½¿ç”¨ argo-workflow æ¥ç¼–æ’æˆ‘ä»¬çš„å®‰è£…éƒ¨ç½²ä»»åŠ¡ï¼Œå¹¶é€šè¿‡ argo-workflow çš„ RESTful API è·å–éƒ¨ç½²ä»»åŠ¡çš„è¿›åº¦æ—¥å¿—ç­‰ä¿¡æ¯ï¼Œè¿™æ ·åšæ›´äº‘åŸç”Ÿä¸€äº›ï¼ˆğŸ¤£</p><p><img data-src="https://p.k8s.li/2022-05-23-packer-vsphere-example-01.png" alt="argo-workfloe-apis"></p><p>åœ¨æˆ‘ä»¬å†…éƒ¨å…¶å®æœ€ç»ˆç›®çš„æ˜¯å‡†å¤‡å°†è¯¥æ–¹æ¡ˆåšæˆä¸€ä¸ªäº§å“åŒ–çš„å·¥å…·ï¼Œæä¾›ä¸€ä¸ª Web UI ç”¨æ¥è¿›è¡Œé…ç½®éƒ¨ç½²å‚æ•°ä»¥åŠå±•ç¤ºéƒ¨ç½²çš„è¿›åº¦æ—¥å¿—ç­‰åŠŸèƒ½ã€‚å½“åˆè®¾è®¡æ–¹æ¡ˆçš„æ—¶å€™ä¹Ÿæ˜¯å‚è€ƒäº†ä¸€ä¸‹  <a href="https://github.com/vmware-tanzu/community-edition">VMware Tanzu ç¤¾åŒºç‰ˆ</a> ï¼šéƒ¨ç½² Tanzu ç®¡ç†é›†ç¾¤çš„æ—¶å€™éœ€è¦æœ‰ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ k8s é›†ç¾¤ï¼Œæˆ–è€…é€šè¿‡ Tanzu æ–°éƒ¨ç½²ä¸€ä¸ª kind é›†ç¾¤ã€‚éƒ¨ç½²ä¸€ä¸ª tanzu ç®¡ç†é›†ç¾¤å¯ä»¥é€šè¿‡ tanzu å‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Tanzu Web UI çš„æ–¹å¼ï¼ŒTanzu Web UI çš„æ–¹å¼å…¶å®å°±æ˜¯ä¸€ä¸ªåå‘äºäº§å“åŒ–çš„å·¥å…·ã€‚åœ¨ <a href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ</a> æˆ‘æ›¾åˆ†äº«è¿‡ Tanzu çš„éƒ¨ç½²æ–¹å¼ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥å»çœ‹ä¸€ä¸‹ã€‚</p><p><img data-src="https://p.k8s.li/2022-05-23-packer-vsphere-example-02.png" alt="tanzu-cluster"></p><p>è¯¥æ–¹æ¡ˆä¸»è¦æ˜¯é¢å‘ä¸€äº›äº§å“åŒ–çš„åœºæ™¯ï¼Œç”±äºå¼•å…¥äº† K8s è¿™ä¸ªåºç„¶å¤§ç‰©ï¼Œæ•´ä½“çš„æŠ€æœ¯æ ˆä¼šå¤æ‚ä¸€äº›ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›å¥½å¤„å•¦ ğŸ˜…ã€‚</p><h3 id="k8s-and-k3s"><a href="#k8s-and-k3s" class="headerlink" title="k8s and k3s"></a>k8s and k3s</h3><p>argo-workflow éœ€è¦ä¾èµ–ä¸€ä¸ª k8s é›†ç¾¤æ‰èƒ½è¿è¡Œï¼Œæˆ‘ä»¬å†…éƒ¨æµ‹è¯•äº† kubekeyã€sealosã€kubesprayã€k3s å‡ ç§å¸¸è§çš„éƒ¨ç½²å·¥å…·ã€‚ç»¼åˆè¯„å®šä¸‹æ¥ k3s é›†ç¾¤å ç”¨çš„èµ„æºæœ€å°‘ã€‚å‚è€ƒ <a href="https://docs.rancher.cn/docs/k3s/installation/installation-requirements/resource-profiling/_index/">K3s èµ„æºåˆ†æ</a> ç»™å‡ºçš„èµ„æºè¦æ±‚ï¼Œæœ€å°åªéœ€è¦ 768M å†…å­˜å°±èƒ½è¿è¡Œã€‚å¯¹äºç¡¬ä»¶èµ„æºä¸å¤ªå……è¶³çš„ç¬”è®°æœ¬ç”µè„‘æ¥è®²ï¼Œk3s æ— ç–‘æ˜¯ç›®å‰æœ€ä½³çš„æ–¹æ¡ˆã€‚</p><p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªååˆ†é‡è¦çš„åŸå› å°±æ˜¯ k3s server æ›´æ¢å• control plan èŠ‚ç‚¹çš„ IP åœ°å€ååˆ†æ–¹ä¾¿ï¼Œå¯¹ç”¨æˆ·æ¥è¯´æ˜¯æ— æ„ŸçŸ¥çš„ã€‚è¿™æ ·å°±å¯ä»¥å°†å®‰è£… k3s çš„æ“ä½œåœ¨æ„å»º OVA çš„æ—¶å€™å®Œæˆï¼Œè€Œä¸æ˜¯åœ¨ä½¿ç”¨çš„æ—¶å€™æ‰‹åŠ¨æ‰§è¡Œå®‰è£…è„šæœ¬æ¥å®‰è£…ã€‚</p><p>åªè¦å¼€æœºè¿è¡Œè™šæ‹Ÿæœºèƒ½å¤Ÿé€šè¿‡ DHCP åˆ†é…åˆ°ä¸€ä¸ªå†…ç½‘ IPv4 åœ°å€æˆ–è€…æ‰‹åŠ¨é…ç½®ä¸€ä¸ªé™æ€ IPï¼Œk3s å°±èƒ½å¤Ÿæ­£å¸¸è¿è¡Œèµ·æ¥ï¼Œèƒ½å¤ŸçœŸæ­£åšåˆ°å¼€ç®±å³ç”¨ï¼Œè€Œä¸æ˜¯åƒ kubekeyã€sealosã€kubespray é‚£æ ·å‚»ä¹ä¹åœ°å¡«å†™ä¸€ä¸ªå¤æ‚æ— æ¯”çš„é…ç½®æ–‡ä»¶ï¼Œç„¶åå†æ‰§è¡Œä¸€äº›å‘½ä»¤æ¥å®‰è£… k8s é›†ç¾¤ã€‚è¿™ç§å¯¼å…¥è™šæ‹Ÿæœºå¼€å³ç”¨çš„æ–¹å¼ï¼Œå¯¹ç”¨æˆ·æ¥è®²ååˆ†å‹å¥½ã€‚</p><p>å½“ç„¶åœ¨ä½¿ç”¨ kubekeyã€sealosã€kubespray åœ¨æ„å»ºè™šæ‹Ÿæœºçš„æ—¶å€™å®‰è£…å¥½ k8s é›†ç¾¤ä¹Ÿä¸æ˜¯ä¸å¯è¡Œï¼Œåªä¸è¿‡æˆ‘ä»¬æ„å»ºæ—¶å€™è™šæ‹Ÿæœºçš„ IP åœ°å€ï¼ˆæ¯”å¦‚ 10.172.20.223ï¼‰å’Œä½¿ç”¨æ—¶çš„ IP åœ°å€ï¼ˆæ¯”å¦‚ 192.168.20.11ï¼‰åŸºæœ¬ä¸Šæ˜¯ä¸ä¼šç›¸åŒçš„ã€‚ç»™ k8s control plain èŠ‚ç‚¹æ›´æ¢ IP çš„æ“ä½œ <a href="https://www.qikqiak.com/">é˜³æ˜åšä¸»</a> æ›¾åœ¨ <a href="https://www.qikqiak.com/post/how-to-change-k8s-node-ip/">å¦‚ä½•ä¿®æ”¹ Kubernetes èŠ‚ç‚¹ IP åœ°å€?</a> æ–‡ç« ä¸­åˆ†äº«è¿‡ä»–çš„ç»å†ï¼Œçœ‹å®Œåç›´æ¥æŠŠæˆ‘æ•´ä¸ä¼šäº†ï¼Œæ„Ÿè§‰æ“ä½œèµ·æ¥å®åœ¨æ˜¯å¤ªéº»çƒ¦äº†ï¼Œè¿˜ä¸å¦‚é‡æ–°éƒ¨ç½²ä¸€å¥—æ–°çš„ k8s æ–¹ä¾¿å‘¢ ğŸ˜‚</p><p>å…¶å®æ„å»ºè™šæ‹Ÿæœºæ¨¡ç‰ˆçš„æ—¶å€™å®‰è£… k8s çš„æ€è·¯æœ€åˆæˆ‘æ˜¯å€Ÿé‰´çš„ <a href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> é¡¹ç›® ğŸ˜‚ã€‚å³å°†éƒ¨ç½² k8s ä¾èµ–çš„ä¸€äº›æ–‡ä»¶å’Œå®¹å™¨é•œåƒæ„å»ºåœ¨è™šæ‹Ÿæœºæ¨¡ç‰ˆå½“ä¸­ï¼Œéƒ¨ç½² k8s çš„æ—¶å€™ä¸éœ€è¦å†è”ç½‘ä¸‹è½½è¿™äº›ä¾èµ–èµ„æºäº†ã€‚ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬é€šè¿‡ k3s ç›´æ¥æå‰å°† k8s é›†ç¾¤éƒ¨ç½²å¥½äº†ï¼Œä¹Ÿå°±çœå»äº†è®©ç”¨æˆ·æ‰§è¡Œéƒ¨ç½²çš„æ“ä½œã€‚</p><p>ç»¼ä¸Šï¼Œé€‰ç”¨ k3s ä½œä¸ºè¯¥æ–¹æ¡ˆçš„ K8s åº•åº§æ— ç–‘æ˜¯æœ€ä½³çš„å•¦ï¼ˆ</p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="ä½¿ç”¨æ„Ÿå—"><a href="#ä½¿ç”¨æ„Ÿå—" class="headerlink" title="ä½¿ç”¨æ„Ÿå—"></a>ä½¿ç”¨æ„Ÿå—</h3><p>ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´åæ„Ÿè§‰ Packer çš„å¤æ‚åº¦å’Œä¸Šæ‰‹éš¾åº¦è¦æ¯” Docker æ„å»ºå®¹å™¨é•œåƒè¦é«˜å‡ºä¸€ä¸ªæ•°é‡çº§ã€‚å¯èƒ½æ˜¯å› ä¸ºè™šæ‹Ÿæœºå¹¶ä¸åƒå®¹å™¨é•œåƒé‚£æ ·æœ‰ <a href="https://opencontainers.org/">OCI</a> è¿™ç§ç»Ÿä¸€çš„æ„å»ºã€åˆ†å‘ã€è¿è¡Œå·¥ä¸šæ ‡å‡†ã€‚è™šæ‹Ÿæœºçš„åˆ›å»ºå…‹éš†ç­‰æ“ä½œä¸åº•å±‚çš„ IaaS ä¾›åº”å•†è€¦åˆçš„ååˆ†ç´§å¯†ï¼Œè¿™å°±å¯¼è‡´ä¸åŒ IaaS ä¾›åº”å•†æ¯”å¦‚ vSphereã€kvm&#x2F;qemu ä»–ä»¬ä¹‹é—´èƒ½å¤Ÿå¤ç”¨çš„é…ç½®å‚æ•°å¹¶ä¸å¤šã€‚æ¯”å¦‚ vSphere é‡Œæœ‰ datastoreã€datacenterã€resource_poolã€folder ç­‰æ¦‚å¿µï¼Œä½† kvm&#x2F;qemu ä¸­ç¼ºæ²¡æœ‰ï¼Œè¿™å°±å¯¼è‡´å¾ˆéš¾å°†å®ƒä»¬ç»Ÿä¸€æˆä¸€ä¸ªé…ç½®ã€‚</p><h3 id="OVA-æ ¼å¼"><a href="#OVA-æ ¼å¼" class="headerlink" title="OVA æ ¼å¼"></a>OVA æ ¼å¼</h3><p>ä½¿ç”¨ OVA è€Œä¸æ˜¯ vagrant.boxã€vmdkã€rawã€qcow2 ç­‰å…¶ä»–æ ¼å¼æ˜¯å› ä¸º OVA æ”¯æŒæ”¯æŒä¸€é”®å¯¼å…¥çš„ç‰¹æ€§ï¼Œåœ¨ Windows ä¸Šä½¿ç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ã€‚æ¯•ç«Ÿ Windows ä¸Šå®‰è£… Vagrant æˆ–è€… qemu&#x2F;KVM ä¹Ÿå¤Ÿä½ æŠ˜è…¾çš„äº†ï¼Œ<a href="https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html">VMware Workstation</a> æˆ–è€… <a href="https://www.virtualbox.org/">Oracle VirtualBox</a> ä½¿ç”¨å¾—æ›´å¹¿æ³›ä¸€äº›ã€‚</p><p>å¦å¤– Packer å¹¶ä¸æ”¯æŒç›´æ¥å°†è™šæ‹Ÿæœºå¯¼å‡ºä¸º OVA çš„æ–¹å¼ï¼Œé»˜è®¤æƒ…å†µä¸‹åªä¼šé€šè¿‡ vCenter çš„ API å¯¼å‡ºä¸º ovfã€‚å¦‚æœéœ€è¦ OVA æ ¼å¼ï¼Œéœ€è¦å°† OVF æ‰“åŒ…æˆ OVAã€‚åœ¨ ISSUE <a href="https://github.com/hashicorp/packer/issues/9645">Add support for exporting to OVA in vsphere-iso builder #9645</a> ä¹Ÿæœ‰äººåé¦ˆäº†æ”¯æŒ OVA å¯¼å‡ºçš„éœ€æ±‚ï¼Œä½† Packer è‡³ä»Šä»æœªæ”¯æŒã€‚å°† OVF è½¬æ¢ä¸º OVA æˆ‘æ˜¯å‚è€ƒçš„ image-builder é¡¹ç›®çš„ <a href="https://github.com/kubernetes-sigs/image-builder/blob/master/images/capi/hack/image-build-ova.py"><strong>image-build-ova.py</strong> </a> æ¥å®Œæˆçš„ã€‚</p><h3 id="å®‰è£…-open-vm-tool-å¤±è´¥"><a href="#å®‰è£…-open-vm-tool-å¤±è´¥" class="headerlink" title="å®‰è£… open-vm-tool å¤±è´¥"></a>å®‰è£… open-vm-tool å¤±è´¥</h3><p>ç”±äº ISO ä¸­å¹¶ä¸åŒ…å« open-vm-tool è½¯ä»¶åŒ…ï¼Œè¿™å°±éœ€è¦åœ¨ ISO å®‰è£… OS çš„è¿‡ç¨‹ä¸­è”ç½‘å®‰è£… open-vm-toolsã€‚å¦‚æœå®‰è£…çš„æ—¶å€™ç½‘ç»œæŠ–åŠ¨äº†å°±å¯èƒ½ä¼šå¯¼è‡´ open-vm-tools å®‰è£…å¤±è´¥ã€‚open-vm-tools å®‰è£…å¤±è´¥ packer æ˜¯æ— æ³•æ„ŸçŸ¥åˆ°çš„ï¼Œåªèƒ½ä¸€ç›´ç­‰åˆ°è·å–è™šæ‹Ÿæœº IP è¶…æ—¶åé€€å‡ºæ‰§è¡Œã€‚ç›®å‰æ²¡æœ‰å¾ˆå¥½çš„åŠæ³•ï¼Œåªèƒ½åœ¨ kickstart é‡Œå®‰è£… open-vm-tools çš„æ—¶å€™è¿›è¡Œé‡è¯•ç›´åˆ° open-vm-tools å®‰è£…æˆåŠŸã€‚</p><h3 id="å‡å°‘å¯¼å‡ºå-vmdk-æ–‡ä»¶å¤§å°"><a href="#å‡å°‘å¯¼å‡ºå-vmdk-æ–‡ä»¶å¤§å°" class="headerlink" title="å‡å°‘å¯¼å‡ºå vmdk æ–‡ä»¶å¤§å°"></a>å‡å°‘å¯¼å‡ºå vmdk æ–‡ä»¶å¤§å°</h3><p>æ›¾ç»åœ¨ <a href="https://blog.k8s.li/esxi-vmbase.html">æ‰‹æ“è™šæ‹Ÿæœºæ¨¡æ¿</a> æ–‡ç« ä¸­åˆ†æè¿‡é€šè¿‡ dd ç½®é›¶çš„æ–¹å¼å¯ä»¥å¤§å¹…å‡å°‘è™šæ‹Ÿæœºå¯¼å‡ºåçš„ vmdk æ–‡ä»¶å¤§</p><blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">464M Aug <span class="token number">28</span> <span class="token number">16</span>:15 Ubuntu1804-2.ova <span class="token comment"># ç½®é›¶åçš„å¤§å°</span><span class="token number">1</span>.3G Aug <span class="token number">28</span> <span class="token number">15</span>:48 Ubuntu1804.ova   <span class="token comment"># ç½®é›¶å‰çš„å¤§å°</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ dd ç½®é›¶ä¹‹å‰è¦å…ˆåœæ­¢ k3s æœåŠ¡ï¼Œä¸ç„¶ç½®é›¶çš„æ—¶å€™ä¼šå æ»¡ root æ ¹åˆ†åŒºå¯¼è‡´ kubelet å¯åŠ¨ GC å°†ä¸€äº›é•œåƒç»™åˆ é™¤æ‰ã€‚ä¹‹å‰å¯¼å‡ºè™šæ‹Ÿæœºåå‘ç°å°‘äº†ä¸€äº›é•œåƒï¼Œæ’æŸ¥äº†å¥½ä¹…æ‰å‘ç°æ˜¯ kubelet GC æŠŠæˆ‘çš„é•œåƒç»™åˆ æ‰äº†ï¼Œè¸©äº†ä¸ªå¤§å‘ï¼Œå¯æ°”æ­»æˆ‘äº† ğŸ˜¡</p><p>å¦å¤–ä¹Ÿå¯ä»¥åˆ é™¤ä¸€äº›ä¸å¿…è¦çš„æ–‡ä»¶ï¼Œæ¯”å¦‚ containerd ä¸­ <code>io.containerd.content.v1.content/blobs/sha256</code> ä¸€äº›é•œåƒ layer çš„åŸå§‹ blob æ–‡ä»¶æ˜¯ä¸éœ€è¦çš„ï¼Œå¯ä»¥å°†å®ƒä»¬ç»™åˆ é™¤æ‰ï¼Œè¿™æ ·èƒ½å¤Ÿå‡å°‘éƒ¨åˆ†ç£ç›˜ç©ºé—´å ç”¨ï¼›</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token comment"># stop k3s server for for prevent it starting the garbage collection to delete images</span>  systemctl stop k3s  <span class="token comment"># Ensure on next boot that network devices get assigned unique IDs.</span>  <span class="token function">sed</span> -i <span class="token string">'/^\(HWADDR\|UUID\)=/d'</span> /etc/sysconfig/network-scripts/ifcfg-* <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">||</span> <span class="token boolean">true</span>  <span class="token comment"># Clean up network interface persistence</span>  <span class="token function">find</span> /var/log -type f -exec truncate --size<span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">\</span><span class="token punctuation">;</span>  <span class="token function">rm</span> -rf /tmp/* /var/tmp/*  <span class="token comment"># cleanup all blob files of registry download image</span>  <span class="token function">find</span> /var/lib/rancher/k3s/agent/containerd/io.containerd.content.v1.content/blobs/sha256 -size +1M -type f -delete  <span class="token comment"># zero out the rest of the free space using dd, then delete the written file.</span>  <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/EMPTY <span class="token assign-left variable">bs</span><span class="token operator">=</span>4M <span class="token assign-left variable">status</span><span class="token operator">=</span>progress <span class="token operator">||</span> <span class="token function">rm</span> -f /EMPTY  <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/data/EMPTY <span class="token assign-left variable">bs</span><span class="token operator">=</span>4M <span class="token assign-left variable">status</span><span class="token operator">=</span>progress <span class="token operator">||</span> <span class="token function">rm</span> -f /data/EMPTY  <span class="token comment"># run sync so Packer doesn't quit too early, before the large file is deleted.</span>  <span class="token function">sync</span>  yum clean all<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Photon3"><a href="#Photon3" class="headerlink" title="Photon3"></a>Photon3</h3><p>ä¹‹å‰åœ¨ <a href="https://blog.k8s.li/Photon-OS.html">è½»é‡çº§å®¹å™¨ä¼˜åŒ–å‹ Linux å‘è¡Œç‰ˆ Photon OS</a> é‡Œåˆ†äº«è¿‡ VMware çš„ Linux å‘è¡Œç‰ˆ <a href="https://vmware.github.io/photon/assets/files/html/3.0/">Photon</a>ã€‚ä¸åŒäºä¼ ç»Ÿçš„ Linux å‘è¡Œç‰ˆ Photon çš„ç³»ç»Ÿååˆ†ç²¾ç®€ï¼Œä½¿ç”¨å®ƒæ›¿ä»£ CentOS èƒ½å¤Ÿä¸€å®šç¨‹åº¦ä¸Šå‡å°‘ç³»ç»Ÿèµ„æºçš„å ç”¨ï¼Œå¯¼å‡ºåçš„ vmdk æ–‡ä»¶ä¹Ÿè¦æ¯” CentOS å°ä¸€äº›ã€‚</p><h3 id="goss"><a href="#goss" class="headerlink" title="goss"></a><a href="https://github.com/aelsabbahy/goss">goss</a></h3><p>åœ¨æ„å»ºçš„è¿‡ç¨‹ä¸­æˆ‘ä»¬åœ¨ k3s é›†ç¾¤ä¸Šå®‰è£…äº†ä¸€äº›å…¶ä»–çš„ç»„ä»¶ï¼Œæ¯”å¦‚æä¾›æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½æœåŠ¡çš„ filebrowser ä»¥åŠ workflow å·¥ä½œæµå¼•æ“ argo-workflowï¼Œä¸ºäº†ä¿è¯è¿™äº›æœåŠ¡çš„æ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡ä¸åŒçš„æ–¹å¼å»æ£€æŸ¥è¿™äº›æœåŠ¡æ˜¯å¦æ­£å¸¸ã€‚ä¸€èˆ¬æ˜¯é€šè¿‡ kubectl get ç­‰å‘½ä»¤æŸ¥çœ‹ deploymentã€podã€daemonset ç­‰æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œæˆ–è€…é€šè¿‡ curl è®¿é—®è¿™äº›è¿™äº›æœåŠ¡çš„å¥åº·æ£€æŸ¥ APIã€‚</p><p>ç”±äºæ£€æŸ¥é¡¹æ¯”è¾ƒå¤šä¸”ååˆ†ç¹çï¼Œä½¿ç”¨ä¼ ç»Ÿçš„ shell è„šæœ¬æ¥åšè¿™å¹¶ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œéœ€è¦è§£ææ¯ä¸ªå‘½ä»¤çš„é€€å‡ºç ä»¥åŠè¿”å›å€¼ã€‚å› æ­¤æˆ‘ä»¬ä½¿ç”¨ <a href="https://github.com/aelsabbahy/goss">goss</a> é€šè¿‡ YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶æ¥å®šä¹‰ä¸€äº›æ£€æŸ¥é¡¹ï¼Œè®©å®ƒæ‰¹é‡æ¥æ‰§è¡Œè¿™äº›æ£€æŸ¥ï¼Œè€Œä¸ç”¨åœ¨ shell å¯¹æ¯ä¸ªæ£€æŸ¥é¡¹å†™ä¸€å †çš„ awk&#x2F;grep ç­‰å‘½ä»¤æ¥ check äº†ã€‚</p><ul><li><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/goss/k3s.yaml">k3s.yaml</a>ï¼šç”¨äºæ£€æŸ¥ k3s ä»¥åŠå®ƒé»˜è®¤è‡ªå¸¦çš„æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># DNS ç±»å‹çš„æ£€æŸ¥</span><span class="token key atrule">dns</span><span class="token punctuation">:</span>  <span class="token comment"># æ£€æŸ¥ coredns æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è§£æåˆ° kubernetes apiserver çš„ service IP åœ°å€</span>  <span class="token key atrule">kubernetes.default.svc.cluster.local</span><span class="token punctuation">:</span>    <span class="token key atrule">resolvable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">addrs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> 10.43.0.1    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.43.0.10    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token comment"># TCP/UDP ç«¯å£ç±»å‹çš„æ£€æŸ¥</span><span class="token key atrule">addr</span><span class="token punctuation">:</span>  <span class="token comment"># æ£€æŸ¥ coredns çš„ UDP 53 ç«¯å£æ˜¯å¦æ­£å¸¸</span>  <span class="token key atrule">udp://10.43.0.10:53</span><span class="token punctuation">:</span>    <span class="token key atrule">reachable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token comment"># æ£€æŸ¥ cni0 ç½‘æ¡¥æ˜¯å¦å­˜åœ¨</span><span class="token key atrule">interface</span><span class="token punctuation">:</span>  <span class="token key atrule">cni0</span><span class="token punctuation">:</span>    <span class="token key atrule">exists</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">addrs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> 10.42.0.1/24<span class="token comment"># æœ¬æœºç«¯å£ç±»å‹çš„æ£€æŸ¥</span><span class="token key atrule">port</span><span class="token punctuation">:</span>  <span class="token comment"># æ£€æŸ¥ ssh 22 ç«¯å£æ˜¯å¦æ­£å¸¸</span>  <span class="token key atrule">tcp:22</span><span class="token punctuation">:</span>    <span class="token key atrule">listening</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">ip</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> 0.0.0.0    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># æ£€æŸ¥ kubernetes apiserver 6443 ç«¯å£æ˜¯å¦æ­£å¸¸</span>  <span class="token key atrule">tcp6:6443</span><span class="token punctuation">:</span>    <span class="token key atrule">listening</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token comment"># æ£€æŸ¥ä¸€äº› systemd æœåŠ¡çš„æ£€æŸ¥</span><span class="token key atrule">service</span><span class="token punctuation">:</span>  <span class="token comment"># é»˜è®¤ç¦ç”¨ firewalld æœåŠ¡</span>  <span class="token key atrule">firewalld</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">running</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># ç¡®ä¿ sshd æœåŠ¡æ­£å¸¸è¿è¡Œ</span>  <span class="token key atrule">sshd</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">running</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># æ£€æŸ¥ k3s æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</span>  <span class="token key atrule">k3s</span><span class="token punctuation">:</span>    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">running</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token comment"># å®šä¹‰ä¸€äº› shell å‘½ä»¤æ‰§è¡Œçš„æ£€æŸ¥</span><span class="token key atrule">command</span><span class="token punctuation">:</span>  <span class="token comment"># æ£€æŸ¥ kubernetes cheduler ç»„ä»¶æ˜¯å¦æ­£å¸¸</span>  <span class="token key atrule">check_k8s_scheduler_health</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> curl <span class="token punctuation">-</span>k https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10259/healthz    <span class="token comment"># é€€å‡ºç æ˜¯å¦ä¸º 0</span>    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token comment"># æ ‡å‡†è¾“å‡ºä¸­æ˜¯å¦åŒ…å«æ­£ç¡®çš„è¾“å‡ºå€¼</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ok"</span><span class="token punctuation">]</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># æ£€æŸ¥ kubernetes controller-manager æ˜¯å¦æ­£å¸¸</span>  <span class="token key atrule">check_k8s_controller-manager_health</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> curl <span class="token punctuation">-</span>k https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10257/healthz    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ok"</span><span class="token punctuation">]</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># æ£€æŸ¥ cluster-info  ä¸­è¾“å‡ºçš„ç»„ä»¶è¿è¡ŒçŠ¶æ€æ˜¯å¦æ­£å¸¸</span>  <span class="token key atrule">check_cluster_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl cluster<span class="token punctuation">-</span>info <span class="token punctuation">|</span> grep 'is running'    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> CoreDNS      <span class="token punctuation">-</span> Kubernetes control plane    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å¤„äº Ready çŠ¶æ€</span>  <span class="token key atrule">check_node_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get node <span class="token punctuation">-</span>o jsonpath='<span class="token punctuation">&#123;</span>.items<span class="token punctuation">[</span><span class="token punctuation">]</span>.status<span class="token punctuation">&#125;</span>' <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.conditions<span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">]</span>.type'    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> Ready    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># æ£€æŸ¥èŠ‚ç‚¹ IP æ˜¯å¦æ­£ç¡®</span>  <span class="token key atrule">check_node_address</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get node <span class="token punctuation">-</span>o wide <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.status.addresses<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">|</span> select(.type == "InternalIP") <span class="token punctuation">|</span> .address'    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># æ£€æŸ¥ traefik loadBalancer çš„ IP åœ°å€æ˜¯å¦æ­£ç¡®</span>  <span class="token key atrule">check_traefik_address</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system get svc traefik <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.status.loadBalancer.ingress<span class="token punctuation">[</span><span class="token punctuation">]</span>.ip'    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># æ£€æŸ¥ containerd å®¹å™¨è¿è¡Œæ˜¯å¦æ­£å¸¸</span>  <span class="token key atrule">check_container_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> crictl ps <span class="token punctuation">-</span><span class="token punctuation">-</span>output=json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.containers<span class="token punctuation">[</span><span class="token punctuation">]</span>.metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> coredns      <span class="token punctuation">-</span> /lb<span class="token punctuation">-</span>.<span class="token important">*-443/</span>      <span class="token punctuation">-</span> /lb<span class="token punctuation">-</span>.<span class="token important">*-80/</span>      <span class="token punctuation">-</span> traefik    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># æ£€æŸ¥ kube-system namespace ä¸‹çš„ pod æ˜¯å¦æ­£å¸¸</span>  <span class="token key atrule">check_kube_system_namespace_pod_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get pod <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">|</span> select((.status.phase <span class="token tag">!=</span> "Running") and (.status.phase <span class="token tag">!=</span> "Succeeded") and (.status.phase <span class="token tag">!=</span> "Completed"))'    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"!string"</span><span class="token punctuation">]</span>  <span class="token comment"># æ£€æŸ¥ k8s deployment æœåŠ¡æ˜¯å¦éƒ½æ­£å¸¸</span>  <span class="token key atrule">check_k8s_deployment_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get deploy <span class="token punctuation">-</span><span class="token punctuation">-</span>all<span class="token punctuation">-</span>namespaces <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">|</span> select(.status.replicas == .status.availableReplicas) <span class="token punctuation">|</span> .metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> coredns      <span class="token punctuation">-</span> traefik    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># æ£€æŸ¥ svclb-traefik daemonset æ˜¯å¦æ­£å¸¸</span>  <span class="token key atrule">check_k8s_daemonset_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get daemonset <span class="token punctuation">-</span><span class="token punctuation">-</span>all<span class="token punctuation">-</span>namespaces <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">|</span> select(.status.replicas == .status.availableReplicas) <span class="token punctuation">|</span> .metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> svclb<span class="token punctuation">-</span>traefik    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/goss/goss.yaml">goss.yaml</a>ï¼šç”¨äºæ£€æŸ¥æˆ‘ä»¬éƒ¨ç½²çš„ä¸€äº›æœåŠ¡æ˜¯å¦æ­£å¸¸</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># é€šè¿‡ include å…¶ä»– gossfile æ–¹å¼å°†ä¸Šé¢å®šä¹‰çš„ k3s.yaml æ£€æŸ¥é¡¹ä¹ŸåŒ…å«è¿›æ¥</span><span class="token key atrule">gossfile</span><span class="token punctuation">:</span>  <span class="token key atrule">k3s.yaml</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token key atrule">dns</span><span class="token punctuation">:</span>  <span class="token comment"># æ£€æŸ¥éƒ¨ç½²çš„ filebrowser deployment çš„ service IP æ˜¯å¦èƒ½æ­£å¸¸è§£æåˆ°</span>  <span class="token key atrule">filebrowser.default.svc.cluster.local</span><span class="token punctuation">:</span>    <span class="token key atrule">resolvable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.43.0.10    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># æ£€æŸ¥éƒ¨ç½²çš„ argo-workflow deployment çš„ service IP æ˜¯å¦èƒ½æ­£å¸¸è§£æåˆ°</span>  <span class="token key atrule">argo-workflow-argo-workflows-server.default.svc.cluster.local</span><span class="token punctuation">:</span>    <span class="token key atrule">resolvable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.43.0.10    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token comment"># ä¸€äº› HTTP è¯·æ±‚æ–¹å¼çš„æ£€æŸ¥</span><span class="token key atrule">http</span><span class="token punctuation">:</span>  <span class="token comment"># æ£€æŸ¥ filebrowser æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œç±»ä¼¼äº pod é‡Œçš„å­˜æ´»æ¢é’ˆ</span>  http<span class="token punctuation">:</span>//<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/filebrowser/<span class="token punctuation">:</span>    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token number">200</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">method</span><span class="token punctuation">:</span> GET  <span class="token comment"># æ£€æŸ¥ argo-workflow æ˜¯å¦æ­£å¸¸è¿è¡Œ</span>  http<span class="token punctuation">:</span>//<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/workflows/api/v1/version<span class="token punctuation">:</span>    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token number">200</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>    <span class="token key atrule">method</span><span class="token punctuation">:</span> GET<span class="token comment"># åŒæ ·ä¹Ÿæ˜¯ä¸€äº› shell å‘½ä»¤çš„æ£€æŸ¥é¡¹ç›®</span><span class="token key atrule">command</span><span class="token punctuation">:</span>  <span class="token comment"># æ£€æŸ¥å®¹å™¨é•œåƒæ˜¯å¦é½å…¨ï¼Œé¿å…ç¼ºé•œåƒçš„é—®é¢˜</span>  <span class="token key atrule">check_container_images</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> crictl images <span class="token punctuation">-</span><span class="token punctuation">-</span>output=json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.images<span class="token punctuation">[</span><span class="token punctuation">]</span>.repoTags<span class="token punctuation">[</span><span class="token punctuation">]</span>' <span class="token punctuation">|</span> awk <span class="token punctuation">-</span>F '/' '<span class="token punctuation">&#123;</span>print $NF<span class="token punctuation">&#125;</span>' <span class="token punctuation">|</span> awk <span class="token punctuation">-</span>F '<span class="token punctuation">:</span>' '<span class="token punctuation">&#123;</span>print $1<span class="token punctuation">&#125;</span>' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> argocli      <span class="token punctuation">-</span> argoexec      <span class="token punctuation">-</span> workflow<span class="token punctuation">-</span>controller      <span class="token punctuation">-</span> filebrowser      <span class="token punctuation">-</span> nginx    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># æ£€æŸ¥å®¹å™¨è¿è¡Œçš„çŠ¶æ€æ˜¯å¦æ­£å¸¸</span>  <span class="token key atrule">check_container_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> crictl ps <span class="token punctuation">-</span><span class="token punctuation">-</span>output=json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.containers<span class="token punctuation">[</span><span class="token punctuation">]</span>.metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> argo<span class="token punctuation">-</span>server      <span class="token punctuation">-</span> controller      <span class="token punctuation">-</span> nginx      <span class="token punctuation">-</span> filebrowser    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment"># æ£€æŸ¥ä¸€äº› deployment çš„çŠ¶æ€æ˜¯å¦æ­£å¸¸</span>  <span class="token key atrule">check_k8s_deployment_status</span><span class="token punctuation">:</span>    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get deploy <span class="token punctuation">-</span>n default <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">|</span> select(.status.replicas == .status.availableReplicas) <span class="token punctuation">|</span> .metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> argo<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>argo<span class="token punctuation">-</span>workflows<span class="token punctuation">-</span>server      <span class="token punctuation">-</span> argo<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>argo<span class="token punctuation">-</span>workflows<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>controller      <span class="token punctuation">-</span> filebrowser    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token comment"># ä¸€äº›ç¡¬ä»¶å‚æ•°çš„æ£€æŸ¥ï¼Œæ¯”å¦‚ CPU æ ¸å¿ƒæ•°ã€å†…å­˜å¤§å°ã€å¯ç”¨å†…å­˜å¤§å°</span><span class="token key atrule">matching</span><span class="token punctuation">:</span>  <span class="token key atrule">check_vm_cpu_core</span><span class="token punctuation">:</span>    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.cpu_core_number <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">matches</span><span class="token punctuation">:</span>      <span class="token key atrule">gt</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">check_vm_memory_size</span><span class="token punctuation">:</span>    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.memory_size <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">matches</span><span class="token punctuation">:</span>      <span class="token key atrule">gt</span><span class="token punctuation">:</span> <span class="token number">1880000</span>  <span class="token key atrule">check_available_memory_size</span><span class="token punctuation">:</span>    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.available_memory_size <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>    <span class="token key atrule">matches</span><span class="token punctuation">:</span>      <span class="token key atrule">gt</span><span class="token punctuation">:</span> <span class="token number">600000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦å¤– goss ä¹Ÿæ¯”è¾ƒé€‚åˆåšä¸€äº›å·¡æ£€çš„å·¥ä½œã€‚æ¯”å¦‚åœ¨ä¸€ä¸ª k8s é›†ç¾¤ä¸­è¿›è¡Œå·¡æ£€ï¼šæ£€æŸ¥é›†ç¾¤å†… pod çš„çŠ¶æ€ã€kubernetes ç»„ä»¶çš„çŠ¶æ€ã€CNI è¿è¡ŒçŠ¶æ€ã€èŠ‚ç‚¹çš„ç½‘ç»œã€ç£ç›˜å­˜å‚¨ç©ºé—´ã€CPU è´Ÿè½½ã€å†…æ ¸å‚æ•°ã€daemonset æœåŠ¡çŠ¶æ€ç­‰ï¼Œéƒ½å¯ä»¥å‚ç…§ä¸Šè¿°æ–¹å¼å®šä¹‰ä¸€ç³»åˆ—çš„æ£€æŸ¥é¡¹ï¼Œä½¿ç”¨ goss æ¥å¸®æˆ‘ä»¬è‡ªåŠ¨å®Œæˆå·¡æ£€ã€‚</p><h3 id="å¯¼å…¥-OVA-è™šæ‹Ÿæœºå-Pod-çŠ¶æ€å¼‚å¸¸"><a href="#å¯¼å…¥-OVA-è™šæ‹Ÿæœºå-Pod-çŠ¶æ€å¼‚å¸¸" class="headerlink" title="å¯¼å…¥ OVA è™šæ‹Ÿæœºå Pod çŠ¶æ€å¼‚å¸¸"></a>å¯¼å…¥ OVA è™šæ‹Ÿæœºå Pod çŠ¶æ€å¼‚å¸¸</h3><p>å°† OVA è™šæ‹Ÿæœºåœ¨ VMware Workstation ä¸Šå¯¼å…¥ä¹‹åï¼Œç”±äºè™šæ‹Ÿæœº IP çš„å˜åŒ–å¯èƒ½ä¼šå¯¼è‡´ä¸€äº› Pod å¤„äºå¼‚å¸¸çš„çŠ¶æ€ï¼Œè¿™æ—¶å€™å°±éœ€è¦å¯¹è¿™äº› Pod è¿›è¡Œå¼ºåˆ¶åˆ é™¤ï¼Œå¼ºåˆ¶é‡å¯ä¸€ä¸‹æ‰èƒ½æ¢å¤æ­£å¸¸ã€‚å› æ­¤éœ€è¦éœ€è¦åœ¨è™šæ‹Ÿæœºé‡Œå¢åŠ ä¸€ä¸ª <a href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/prepare.sh">prepare.sh</a> è„šæœ¬ç”¨æ¥é‡å¯è¿™äº›çŠ¶æ€å¼‚å¸¸çš„ Podã€‚å½“å¯¼å…¥ OVA è™šæ‹Ÿæœºåè¿è¡Œè¿™ä¸ªè„šæœ¬è®©æ‰€æœ‰çš„ Pod éƒ½æ­£å¸¸è¿è¡Œèµ·æ¥ï¼Œç„¶åå†è°ƒç”¨ goss æ¥æ£€æŸ¥å…¶ä»–æœåŠ¡æ˜¯å¦æ­£å¸¸ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token builtin class-name">set</span> -o errexit<span class="token builtin class-name">set</span> -o nounset<span class="token builtin class-name">set</span> -o pipefailkubectl get pods --no-headers -n kube-system <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">'0/2|0/1|Error|Unknown|CreateContainerError|CrashLoopBackOff'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span> <span class="token operator">|</span> <span class="token function">xargs</span> -t -I <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> kubectl delete pod -n kube-system --grace-period<span class="token operator">=</span><span class="token number">0</span> --force <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> /dev/null  <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token boolean">true</span>kubectl get pods --no-headers -n default <span class="token operator">|</span> <span class="token function">grep</span> -E <span class="token string">'0/1|Error|Unknown|CreateContainerError|CrashLoopBackOff'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span> <span class="token operator">|</span> <span class="token function">xargs</span> -t -I <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> kubectl delete pod -n default --grace-period<span class="token operator">=</span><span class="token number">0</span> --force <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> /dev/null  <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token boolean">true</span><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span>  <span class="token keyword">if</span> kubectl get pods --no-headers --all-namespaces <span class="token operator">|</span> <span class="token function">grep</span> -Ev <span class="token string">'Running|Completed'</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> <span class="token string">"Waiting for service readiness"</span>    <span class="token function">sleep</span> <span class="token number">10</span>  <span class="token keyword">else</span>    <span class="token builtin class-name">break</span>  <span class="token keyword">fi</span><span class="token keyword">done</span><span class="token builtin class-name">cd</span> <span class="token variable">$&#123;<span class="token environment constant">HOME</span>&#125;</span>/.goss<span class="token function">cat</span> <span class="token operator">></span> vars.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOFip_address: <span class="token variable"><span class="token variable">$(</span><span class="token function">ip</span> r get <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">"s/ uid.*//g"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $NF&#125;'</span> <span class="token operator">|</span> <span class="token function">head</span> -n1<span class="token variable">)</span></span>cpu_core_number: <span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> -c ^processor /proc/cpuinfo<span class="token variable">)</span></span>memory_size: <span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token string">'^MemTotal:'</span> /proc/meminfo <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span><span class="token variable">)</span></span>available_memory_size: <span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token string">'^MemAvailable:'</span> /proc/meminfo <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span><span class="token variable">)</span></span>EOF</span>goss --vars vars.yaml -g goss.yaml validate --retry-timeout<span class="token operator">=</span>10s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://www.escapelife.site/posts/754ba85c.html">K3S å·¥å…·è¿›é˜¶å®Œå…¨æŒ‡å—</a></li><li><a href="https://docs.rancher.cn/docs/k3s/installation/installation-requirements/resource-profiling/_index/">K3s èµ„æºåˆ†æ</a></li><li><a href="https://github.com/aelsabbahy/goss/blob/master/docs/manual.md">goss</a>ï¼šgoss é…ç½®æ–‡æ¡£</li><li><a href="https://github.com/alexellis/awesome-baremetal">awesome-baremetal</a>ï¼šä¸€äº›ä¸è£¸é‡‘å±æœåŠ¡å™¨ç›¸å…³çš„å·¥å…·æ±‡æ€»</li><li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax">Kickstart Syntax Reference</a>ï¼šCentOS&#x2F;Red Hat kickstart è¯­æ³•</li><li><a href="https://vmware.github.io/photon/assets/files/html/3.0/photon_user/kickstart.html">Kickstart Support in Photon OS</a>ï¼šPhoton OS çš„ kickstart è¯­æ³•</li></ul><h3 id="Packer-ç›¸å…³"><a href="#Packer-ç›¸å…³" class="headerlink" title="Packer ç›¸å…³"></a>Packer ç›¸å…³</h3><ul><li><a href="https://github.com/chef/bento">bento</a>ï¼šæ˜¯ä¸€ä¸ª Packer æœ€ä½³å®è·µçš„æ¨¡ç‰ˆä»“åº“ï¼Œä¸è¿‡å®ƒçš„ builder æ˜¯ Vagrantï¼Œä½†å¯ä»¥ä»ä¸­å€Ÿé‰´ä¸€äº› Linux å‘è¡Œç‰ˆçš„è‡ªåŠ¨åŒ–å®‰è£…è„šæœ¬ï¼Œæ¯”å¦‚ CentOS çš„ <a href="https://github.com/chef/bento/tree/main/packer_templates/centos/http">kickstart</a> æ–‡ä»¶ã€‚</li><li><a href="https://mp.weixin.qq.com/s/FnnMnu9i6gFNrAjIlzaNnQ">åŸºäº Packer+Ansible å®ç°äº‘å¹³å°é»„é‡‘é•œåƒç»Ÿä¸€æ„å»ºå’Œå‘å¸ƒ</a></li><li><a href="https://github.com/kubernetes-sigs/image-builder/tree/master/images/capi">Image Builder for Cluster API</a></li><li><a href="https://image-builder.sigs.k8s.io/capi/providers/vsphere.html#building-images-for-vsphere">Building Images for vSphere</a></li><li><a href="https://www.packer.io/plugins/builders/vsphere/vsphere-clone">VMware vSphere Clone Builder</a></li><li><a href="https://www.packer.io/plugins/builders/vsphere/vsphere-iso">Packer Builder for VMware vSphere</a></li><li><a href="https://github.com/hashicorp/packer-plugin-vsphere">packer-plugin-vsphere</a></li><li><a href="https://github.com/vmware-samples/packer-examples-for-vsphere">packer-examples-for-vsphere</a></li><li><a href="https://docs.rockylinux.org/guides/automation/templates-automation-packer-vsphere/">Automatic template creation with Packer and deployment with Ansible in a VMware vSphere environment</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ä¸ä¹…å‰å†™è¿‡ä¸€ç¯‡åšå®¢ã€Š&lt;a
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="argo-workflow" scheme="https://blog.k8s.li/tags/argo-workflow/"/>
    
      <category term="vSphere" scheme="https://blog.k8s.li/tags/vSphere/"/>
    
      <category term="packer" scheme="https://blog.k8s.li/tags/packer/"/>
    
      <category term="esxi" scheme="https://blog.k8s.li/tags/esxi/"/>
    
      <category term="k3s" scheme="https://blog.k8s.li/tags/k3s/"/>
    
      <category term="redfish" scheme="https://blog.k8s.li/tags/redfish/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OS</title>
    <link href="https://blog.k8s.li/redfish-esxi-os-installer.html"/>
    <id>https://blog.k8s.li/redfish-esxi-os-installer.html</id>
    <published>2022-04-29T16:00:00.000Z</published>
    <updated>2022-04-29T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä»å»å¹´åä¸€æœˆåº•åˆ°ç°åœ¨ä¸€ç›´åœ¨åšåœ¨  <a href="https://www.vmware.com/products/esxi-and-esx.html">VMware ESXi</a>  ä¸Šéƒ¨ç½² <a href="https://www.smartx.com/smartx-hci/">è¶…èåˆé›†ç¾¤</a> çš„äº§å“åŒ–å·¥å…·ï¼Œä¹Ÿæ˜¯åœ¨æœ€è¿‘å®Œæˆäº†å‰åç«¯çš„è”è°ƒï¼Œäº”ä¸€èŠ‚åå¼€å§‹è¿›å…¥æµ‹è¯•é˜¶æ®µã€‚ä¸ºäº†æµ‹è¯•ä¸åŒçš„ VMware ESXi ç‰ˆæœ¬å’Œæˆ‘ä»¬äº§å“çš„å…¼å®¹æ€§ï¼Œéœ€è¦å¾ˆé¢‘ç¹åœ°åœ¨ä¸€äº›ç‰©ç†æœåŠ¡å™¨ï¼ˆå¦‚æˆ´å°”ã€è”æƒ³ã€æƒ æ™®ã€æµªæ½®ã€è¶…å¾®ç­‰ï¼‰ä¸Šå®‰è£… VMware ESXi OSã€‚</p><p>ä¹‹å‰ä¸€ç›´éƒ½æ˜¯ç™»å½• IPMI ç®¡ç†é¡µé¢ï¼ŒæŒ‚è½½è¿œç¨‹çš„ ISO æ–‡ä»¶æ‰‹åŠ¨å®‰è£…ã€‚å®‰è£…å®Œæˆä¹‹åè¿˜éœ€è¦é…ç½® ESXi ç®¡ç†ç½‘ç»œçš„ IP åœ°å€ã€‚æ•´ä½“çš„å®‰è£…æµç¨‹æ¯”è¾ƒç¹çï¼Œè€Œä¸”ç‰©ç†æœåŠ¡å™¨æ¯æ¬¡é‡å¯å’Œå¼€æœºéƒ½ååˆ†è€—æ—¶ï¼Œå¯¹ç»å¸¸è¦å®‰è£… ESXi çš„ QE å°ä¼™ä¼´æ¥è®²ååˆ†ç—›è‹¦ã€‚</p><p>ä¸ºäº†åç»­æµ‹è¯•èµ·æ¥çˆ½å¿«ä¸€ç‚¹ï¼Œä¸ç”¨å†ä¸ºå®‰è£… ESXi OS è€Œçƒ¦æ¼ï¼Œäºæ˜¯å°±åŸºäº Redfish å¿«é€Ÿå®ç°äº†ä¸€å¥—è‡ªåŠ¨åŒ–å®‰è£… ESXi OS çš„å·¥å…· <a href="https://github.com/muzi502/redfish-esxi-os-installer">redfish-esxi-os-installer</a>ã€‚é€šè¿‡å®ƒæˆ‘ä»¬å†…éƒ¨çš„æˆ´å°”ã€è”æƒ³ã€HPE æœåŠ¡å™¨å®‰è£… ESXi OS åªéœ€è¦å¡«å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶å¹¶é€‰æ‹©éœ€è¦å®‰è£…çš„ ESXi ISOï¼Œè¿è¡Œä¸€ä¸‹ Jenkins Job ç­‰å¾…åå‡ åˆ†é’Ÿå°±èƒ½è‡ªåŠ¨å®‰è£…å¥½ã€‚åŸæœ¬éœ€è¦ä¸€ä¸ªå¤šå°æ—¶çš„å·¥ä½œé‡ï¼Œç°åœ¨åªéœ€è¦è¿è¡Œä¸€ä¸‹ Jenkins Job å¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨å®‰è£…å¥½ ESXi OS å•¦ ğŸ˜‚ï¼ŒçœŸæ˜¯çˆ½æ­ªæ­ªã€‚</p><p>äº”ä¸€å‡æœŸåˆšå¼€å§‹ï¼Œæ­£å¥½æœ‰æ—¶é—´æŠ½ç©ºæ•´ç†ä¸€ä¸‹æœ€è¿‘å­¦åˆ°çš„ä¸œè¥¿ï¼Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹è¿™å¥—è‡ªåŠ¨åŒ–å®‰è£… ESXi OS å·¥å…·ã€‚</p><h2 id="éœ€æ±‚åˆ†æ"><a href="#éœ€æ±‚åˆ†æ" class="headerlink" title="éœ€æ±‚åˆ†æ"></a>éœ€æ±‚åˆ†æ</h2><ul><li>æ”¯æŒæœåŠ¡å™¨ï¼šè”æƒ³&#x2F;æˆ´å°”&#x2F;HPEï¼ˆè¶…å¾®å’Œæµªæ½®ä¼˜å…ˆçº§ä¸é«˜ï¼Œæš‚æ—¶ä¸æ”¯æŒï¼‰ï¼›</li><li>ä¸€é”®è‡ªåŠ¨åŒ–å®‰è£…&#x2F;é‡è£… ESXi OSï¼Œæœ€å¥½èƒ½é…ç½®å¥½ Jenkins Jobï¼›</li><li>æŒ‡å®š ESXi OS å®‰è£…çš„ç‰©ç†ç›˜ï¼šç”±äºç‰©ç†æœåŠ¡å™¨æœ‰å¤šå—ç¡¬ç›˜ï¼ŒESXi OS éœ€è¦å®‰è£…åœ¨æŒ‡å®šçš„ç¡¬ç›˜ä¸Šã€‚ä¸€èˆ¬ä¸º SATA DOM ç›˜ã€‚æ¯”å¦‚æˆ´å°”çš„ <a href="https://downloads.dell.com/manuals/all-products/esuprt_solutions_int/esuprt_solutions_int_solutions_resources/servers-solution-resources_white-papers10_en-us.pdf">DELLBOSS</a>ï¼Œè”æƒ³çš„ <a href="https://lenovopress.com/lp0769.pdf">ThinkSystem M.2</a> ã€‚è¿™ç±» DOM ç›˜çš„å¥½å¤„å°±åœ¨äºä¸å ç”¨å¤šä½™çš„ HBA å¡æˆ– PCI æ’æ§½ï¼Œæœ‰ç‚¹ç±»ä¼¼äºå®¶ç”¨å°å¼æœºä¸»æ¿ä¸Šçš„ M.2 ç¡¬ç›˜ä½æ’æ§½ï¼›</li><li>æŒ‡å®šç½‘å¡å¹¶é…ç½®é™æ€ IP åœ°å€ï¼šç”±äºæˆ‘ä»¬çš„ç‰©ç†æœåŠ¡å™¨ä¸Šæœ‰å¤šå—ç½‘å¡ï¼Œä¸”ä¸åŒçš„ç½‘å¡æœ‰ä¸åŒçš„ç½‘ç»œç”¨é€”ï¼Œå› æ­¤éœ€è¦æŒ‡å®šæŸå—ç‰©ç†ç½‘å¡ä¸º ESXi ç®¡ç†ç½‘ç»œæ‰€ä½¿ç”¨çš„ç½‘å¡ã€‚</li><li>ä¸º ESXi ç®¡ç†ç½‘è·¯é…ç½®é™æ€ IPã€å­ç½‘æ©ç ã€ç½‘å…³ï¼Œä¾¿äºéƒ¨ç½²å¥½ä¹‹åç›´æ¥å°±èƒ½é€šè¿‡è¯¥ IP è®¿é—® ESXiã€‚è€Œä¸æ˜¯é€šè¿‡ DHCP åˆ†é…ä¸€ä¸ª IPï¼Œç„¶åå†ç™»å½• IPMI ç®¡ç†é¡µé¢æ‰‹åŠ¨æŸ¥çœ‹ ESXi çš„ IPï¼›</li></ul><h2 id="æŠ€æœ¯è°ƒç ”"><a href="#æŠ€æœ¯è°ƒç ”" class="headerlink" title="æŠ€æœ¯è°ƒç ”"></a>æŠ€æœ¯è°ƒç ”</h2><p>ç›®å‰å¸‚é¢ä¸Šä¸»æµçš„è£¸é‡‘å±æœåŠ¡å™¨è‡ªåŠ¨åŒ–å®‰è£… OS çš„å·¥å…·æœ‰ PXE å’Œ IPMI&#x2F;Redfish ä¸¤ç§ã€‚</p><h3 id="PXE"><a href="#PXE" class="headerlink" title="PXE"></a>PXE</h3><p>è™½ç„¶å†…éƒ¨ä¹Ÿæœ‰ PXE æœåŠ¡å¯ç”¨ï¼Œä½†é‡å¯æœåŠ¡å™¨å’Œè®¾ç½®æœåŠ¡å™¨çš„å¼•å¯¼é¡¹ä¸º PXE å¯åŠ¨ä»ç„¶éœ€è¦æ‰‹åŠ¨ç™»å½• IPMI ç®¡ç†é¡µé¢è¿›è¡Œæ“ä½œï¼Œæ— æ³•åšåˆ°è‡ªåŠ¨é‡å¯å’Œè‡ªåŠ¨é‡è£…ï¼Œä»æœ‰ä¸€å®šçš„å·¥ä½œé‡ã€‚è€Œä¸” PXE å®‰è£… OS æ— æ³•è§£å†³ä¸ºæ¯å°æœåŠ¡å™¨é…ç½®å„è‡ªçš„å®‰è£…ç›˜å’Œç®¡ç†ç½‘ç»œç½‘å¡åŠé™æ€ IP åœ°å€çš„é—®é¢˜ï¼Œé‚æ”¾å¼ƒã€‚</p><h3 id="IPMI-x2F-Redfish"><a href="#IPMI-x2F-Redfish" class="headerlink" title="IPMI&#x2F;Redfish"></a>IPMI&#x2F;Redfish</h3><p><a href="https://www.dmtf.org/standards/redfish">Redfish</a> çš„æ¦‚å¿µå’ŒåŸç†ä»€ä¹ˆçš„å°±æ‡’å¾—ä»‹ç»äº†ï¼Œä¸‹é¢å°±ç›´æ¥å‰½çªƒä¸€ä¸‹å®˜æ–¹çš„æ–‡æ¡£å§ ğŸ˜…ï¼š</p><blockquote><p><code>DMTF</code> çš„ <code>RedfishÂ®</code> æ˜¯ä¸€ä¸ªæ ‡å‡† <code>API</code>ï¼Œæ—¨åœ¨ä¸ºèåˆã€æ··åˆ <code>IT</code> å’Œè½¯ä»¶å®šä¹‰æ•°æ®ä¸­å¿ƒï¼ˆ<code>SDDC</code>ï¼‰æä¾›ç®€å•å’Œå®‰å…¨ç®¡ç†ã€‚</p><p>åœ¨ <code>Redfish</code> å‡ºç°ä¹‹å‰ï¼Œç°ä»£æ•°æ®ä¸­å¿ƒç¯å¢ƒä¸­ç¼ºä¹äº’æ“ä½œç®¡ç†æ ‡å‡†ã€‚éšç€æœºæ„è¶Šæ¥è¶Šé’çäºå¤§è§„æ¨¡çš„è§£å†³æ–¹æ¡ˆï¼Œä¼ ç»Ÿæ ‡å‡†ä¸è¶³ä»¥æˆåŠŸç®¡ç†å¤§é‡ç®€å•çš„å¤šèŠ‚ç‚¹æœåŠ¡å™¨æˆ–æ··åˆåŸºç¡€è®¾æ–½ã€‚<code>IPMI</code> æ˜¯ä¸€ç§è¾ƒæ—©çš„å¸¦å¤–ç®¡ç†æ ‡å‡†ï¼Œä»…é™äºâ€œæœ€å°å…¬å…±é›†â€å‘½ä»¤é›†ï¼ˆä¾‹å¦‚ï¼Œå¼€æœº&#x2F;å…³æœº&#x2F;é‡å¯ã€æ¸©åº¦å€¼ã€æ–‡æœ¬æ§åˆ¶å°ç­‰ï¼‰ï¼Œç”±äºä¾›åº”å•†æ‰©å±•åœ¨æ‰€æœ‰å¹³å°ä¸Šå¹¶ä¸å¸¸è§ï¼Œå¯¼è‡´äº†å®¢æˆ·å¸¸ç”¨çš„åŠŸèƒ½é›†å‡å°‘ã€‚è®¸å¤šç”¨æˆ·å¼€å‘äº†è‡ªå·±çš„ç´§å¯†é›†æˆå·¥å…·ï¼Œä½†æ˜¯ä¹Ÿä¸å¾—ä¸ä¾èµ–å¸¦å†…ç®¡ç†è½¯ä»¶ã€‚</p><p>è€Œå¯¹äºä¼ä¸šçº§ç”¨æˆ·æ¥è¯´ï¼Œè®¾å¤‡éƒ½æ˜¯ä¸Šåƒå°ï¼Œå…¶éœ€è¦ç»Ÿä¸€çš„ç®¡ç†ç•Œé¢ï¼Œå°±è¦å¯¹æ¥ä¸åŒä¾›åº”å•†çš„ <code>API</code>ã€‚å½“åŸºæœ¬ <code>IPMI</code> åŠŸèƒ½å·²ç»ä¸å¤ªå¥½æ»¡è¶³å¤§è§„æ¨¡ <code>Scale-out</code> ç¯å¢ƒæ—¶ï¼Œå¦‚ä½•ä»¥æ›´ä¾¿æ·çš„æ–¹å¼è°ƒç”¨æœåŠ¡å™¨é«˜çº§ç®¡ç†åŠŸèƒ½å°±æ˜¯ä¸€ä¸ªæ–°çš„éœ€æ±‚ã€‚</p><p>ä¸ºäº†å¯»æ±‚ä¸€ä¸ªåŸºäºå¹¿æ³›ä½¿ç”¨çš„å·¥å…·æ¥åŠ å¿«å‘å±•çš„ç°ä»£æ¥å£ï¼Œç°å¦‚ä»Šï¼Œå®¢æˆ·éœ€è¦ä¸€ä¸ªä½¿ç”¨äº’è”ç½‘å’Œ <code>web</code> æœåŠ¡ç¯å¢ƒä¸­å¸¸è§çš„åè®®ã€ç»“æ„å’Œå®‰å…¨æ¨¡å‹å®šä¹‰çš„ <code>API</code>ã€‚</p><p><code>Redfish</code> å¯æ‰©å±•å¹³å°ç®¡ç† <code>API</code>ï¼ˆ<code>The Redfish Scalable Platforms Management API</code>ï¼‰æ˜¯ä¸€ç§æ–°çš„è§„èŒƒï¼Œå…¶ä½¿ç”¨ <code>RESTful</code> æ¥å£è¯­ä¹‰æ¥è®¿é—®å®šä¹‰åœ¨æ¨¡å‹æ ¼å¼ä¸­çš„æ•°æ®ï¼Œç”¨äºæ‰§è¡Œå¸¦å¤–ç³»ç»Ÿç®¡ç† ï¼ˆ<code>out of band systems management</code>ï¼‰ã€‚å…¶é€‚ç”¨äºå¤§è§„æ¨¡çš„æœåŠ¡å™¨ï¼Œä»ç‹¬ç«‹çš„æœåŠ¡å™¨åˆ°æœºæ¶å¼å’Œåˆ€ç‰‡å¼çš„æœåŠ¡å™¨ç¯å¢ƒï¼Œè€Œä¸”ä¹ŸåŒæ ·é€‚ç”¨äºå¤§è§„æ¨¡çš„äº‘ç¯å¢ƒã€‚</p><p><code>Redfish</code> çš„ç¬¬ <code>1</code> ç‰ˆä¾§é‡äºæœåŠ¡å™¨ï¼Œä¸º <code>IPMI-over-LAN</code> æä¾›äº†ä¸€ä¸ªå®‰å…¨ã€å¤šèŠ‚ç‚¹çš„æ›¿ä»£å“ã€‚éšåçš„ <code>Redfish</code> ç‰ˆæœ¬å¢åŠ äº†å¯¹ç½‘ç»œæ¥å£(ä¾‹å¦‚ <code>NIC</code>ã€<code>CNA</code> å’Œ <code>FC HBA</code>)ã€<code>PCIe</code> äº¤æ¢ã€æœ¬åœ°å­˜å‚¨ã€<code>NVDIMM</code>ã€å¤šåŠŸèƒ½é€‚é…å™¨å’Œå¯ç»„åˆæ€§ä»¥åŠå›ºä»¶æ›´æ–°æœåŠ¡ã€è½¯ä»¶æ›´æ–°æ¨é€æ–¹æ³•å’Œå®‰å…¨ç‰¹æƒæ˜ å°„çš„ç®¡ç†ã€‚æ­¤å¤–ï¼Œ<code>Redfish</code> ä¸»æœºæ¥å£è§„èŒƒå…è®¸åœ¨æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œåº”ç”¨ç¨‹åºå’Œå·¥å…·ï¼ŒåŒ…æ‹¬åœ¨å¯åŠ¨å‰ï¼ˆå›ºä»¶ï¼‰é˜¶æ®µ-ä¸ <code>Redfish</code> ç®¡ç†æœåŠ¡æ²Ÿé€šã€‚</p><p>åœ¨å®šä¹‰ <code>Redfish</code> æ ‡å‡†æ—¶ï¼Œåè®®ä¸æ•°æ®æ¨¡å‹å¯åˆ†å¼€å¹¶å…è®¸ç‹¬ç«‹åœ°ä¿®æ”¹ã€‚ä»¥æ¨¡å¼ä¸ºåŸºç¡€çš„æ•°æ®æ¨¡å‹æ˜¯å¯ä¼¸ç¼©å’Œå¯æ‰©å±•çš„ï¼Œå¹¶ä¸”éšç€è¡Œä¸šçš„å‘å±•ï¼Œå®ƒå°†è¶Šæ¥è¶Šå…·æœ‰äººç±»å¯è¯»æ€§å®šä¹‰ã€‚</p></blockquote><p>é€šè¿‡ Redfish æˆ‘ä»¬å¯ä»¥å¯¹æœåŠ¡å™¨è¿›è¡ŒæŒ‚è½½&#x2F;å¸è½½ ISOã€è®¾ç½® BIOS å¯åŠ¨é¡¹ã€å¼€æœº&#x2F;å…³æœº&#x2F;é‡å¯ç­‰æ“ä½œã€‚åªéœ€è¦ä½¿ç”¨ä¸€äº›ç‰¹å®šçš„ ansible æ¨¡å—ï¼Œå°†å®ƒä»¬ç¼åˆèµ·æ¥å°±èƒ½å°†æ•´ä¸ªæµç¨‹è·‘é€šã€‚</p><p>å†…éƒ¨çš„æœåŠ¡å™¨æˆ´å°”ã€è”æƒ³ã€HPE çš„è¾ƒå¤šï¼Œè¿™ä¸‰å®¶å‚å•†å¯¹ Redfish æ”¯æŒçš„ä¹Ÿæ¯”è¾ƒå®Œå–„ã€‚äºæ˜¯è¿™ä¸ª ESXi OS è‡ªåŠ¨åŒ–å®‰è£…å·¥å…· <a href="https://github.com/muzi502/redfish-esxi-os-installer">redfish-esxi-os-installer</a> å°±åŸºäº Redfish å¹¶ç»“åˆ Jenkins å®ç°äº†ä¸€å¥—è‡ªåŠ¨åŒ–å®‰è£… ESXi OS çš„æ–¹æ¡ˆï¼Œä¸‹é¢å°±è¯¦ç»†ä»‹ç»ä¸€ä¸‹è¿™å¥—æ–¹æ¡ˆçš„å®‰è£…æµç¨‹å’ŒæŠ€æœ¯å®ç°ç»†èŠ‚ã€‚</p><h2 id="å®‰è£…æµç¨‹"><a href="#å®‰è£…æµç¨‹" class="headerlink" title="å®‰è£…æµç¨‹"></a>å®‰è£…æµç¨‹</h2><ol><li>è·å–ç¡¬ç›˜å’Œç½‘å¡ç¡¬ä»¶è®¾å¤‡ä¿¡æ¯</li><li>æ ¹æ®ç¡¬ä»¶è®¾å¤‡ä¿¡æ¯å¡«å†™é…ç½®æ–‡ä»¶</li><li>æ ¹æ®é…ç½®æ–‡ä»¶ç”Ÿæˆ ansible inventory æ–‡ä»¶</li><li>æ ¹æ®é…ç½®æ–‡ä»¶ä¸ºæ¯å°ä¸»æœºç”Ÿæˆ kickstart æ–‡ä»¶</li><li>å°†ç”Ÿæˆå¥½çš„ kickstart æ–‡ä»¶æ‰“åŒ…æ”¾åˆ° ESXi ISO å½“ä¸­</li><li>ä¸ºæ¯å°ä¸»æœºé‡æ–°æ„å»ºä¸€ä¸ª ESXi ISO æ–‡ä»¶</li><li>é€šè¿‡ redfish å¼¹å‡ºå·²æœ‰çš„ ISO é•œåƒ</li><li>é€šè¿‡ redfish æ’å…¥è¿œç¨‹çš„ ISO é•œåƒ</li><li>è®¾ç½® one-boot å¯åŠ¨å¼•å¯¼é¡¹ä¸ºè™šæ‹Ÿå…‰é©±</li><li>é‡å¯æœåŠ¡å™¨åˆ° ESXI ISO</li><li>ESXi installer è°ƒç”¨ Kickstart è„šæœ¬å®‰è£… OS</li><li>ç­‰å¾… ESXi OS å®‰è£…å®Œæˆ</li></ol><h3 id="è·å–ç¡¬ä»¶ä¿¡æ¯"><a href="#è·å–ç¡¬ä»¶ä¿¡æ¯" class="headerlink" title="è·å–ç¡¬ä»¶ä¿¡æ¯"></a>è·å–ç¡¬ä»¶ä¿¡æ¯</h3><p>è¯¥æ­¥éª¤ä¸»è¦æ˜¯è·å– ESXi OS æ‰€è¦å®‰è£…çš„ç¡¬ç›˜å’Œç®¡ç†ç½‘ç»œç½‘å¡è®¾å¤‡ä¿¡æ¯ã€‚</p><h4 id="è·å–ç¡¬ç›˜å‹å·-x2F-åºåˆ—å·"><a href="#è·å–ç¡¬ç›˜å‹å·-x2F-åºåˆ—å·" class="headerlink" title="è·å–ç¡¬ç›˜å‹å·&#x2F;åºåˆ—å·"></a>è·å–ç¡¬ç›˜å‹å·&#x2F;åºåˆ—å·</h4><p>è¦æŒ‡å®š ESXi OS å®‰è£…çš„ç¡¬ç›˜ï¼Œå¯ä»¥é€šè¿‡ç¡¬ç›˜å‹å·æˆ–åºåˆ—å·çš„æ–¹å¼ã€‚å¦‚æœå½“å‰æœåŠ¡å™¨å·²ç»å®‰è£…äº† ESXiï¼Œç™»å½•åˆ° ESXi åˆ™å¯ä»¥æŸ¥çœ‹åˆ°æ‰€å®‰è£…ç¡¬ç›˜çš„å‹å·ï¼š</p><ul><li>æ¯”å¦‚è¿™å°æˆ´å°”çš„æœåŠ¡å™¨ ESXi OS å®‰è£…çš„ç¡¬ç›˜å‹å·æ˜¯ <code>DELLBOSS VD</code>ï¼ˆæ³¨æ„ä¸­é—´çš„ç©ºæ ¼ä¸è¦çœç•¥ï¼‰ï¼›</li></ul><p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-01.png" alt="img"></p><ul><li>æ¯”å¦‚è¿™å°è”æƒ³æœåŠ¡å™¨çš„ SATA DOM ç›˜å‹å·ä¸º <code>ThinkSystem M.2</code></li></ul><p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-06.png" alt="img"></p><ul><li>å¦‚æœå®‰è£…çš„æ˜¯ Linuxï¼Œå¯ä»¥é€šè¿‡ <a href="https://www.smartmontools.org/">smartctl</a> å·¥å…·æŸ¥çœ‹æ‰€è¦å®‰è£…ç¡¬ç›˜çš„å‹å·å³ <code>Device Model</code>ï¼Œæ¯”å¦‚ï¼š</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-nas ~â•°â”€<span class="token comment"># smartctl -x /dev/sdb</span>smartctl <span class="token number">6.6</span> <span class="token number">2017</span>-11-05 r4594 <span class="token punctuation">[</span>x86_64-linux-4.19.0-18-amd64<span class="token punctuation">]</span> <span class="token punctuation">(</span>local build<span class="token punctuation">)</span>Copyright <span class="token punctuation">(</span>C<span class="token punctuation">)</span> <span class="token number">2002</span>-17, Bruce Allen, Christian Franke, www.smartmontools.org<span class="token operator">==</span><span class="token operator">=</span> START OF INFORMATION SECTION <span class="token operator">==</span><span class="token operator">=</span>Device Model:     HGST HUH721212ALE604Serial Number:    5PJAMUHDLU WWN Device Id: <span class="token number">5</span> 000cca 291e10521<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-04.png" alt="img"></p><p>å¦‚æœæœ‰å¤šå—å‹å·ç›¸åŒçš„ç¡¬ç›˜ï¼ŒESXi ä¼šé»˜è®¤é€‰æ‹©ç¬¬ä¸€å—ï¼Œå¦‚æœè¦æŒ‡å®šæŸä¸€å—ç¡¬ç›˜åˆ™ä½¿ç”¨ WWN å·çš„æ–¹å¼ï¼Œè·å– WWN ID çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-nas ~â•°â”€<span class="token comment"># smartctl -x /dev/sdb | sed -n "s/LU WWN Device Id:/naa./p" | tr -d ' '</span>naa.5000cca291e10521<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h4 id="è·å–ç½‘å¡è®¾å¤‡å-x2F-MAC-åœ°å€"><a href="#è·å–ç½‘å¡è®¾å¤‡å-x2F-MAC-åœ°å€" class="headerlink" title="è·å–ç½‘å¡è®¾å¤‡å&#x2F;MAC åœ°å€"></a>è·å–ç½‘å¡è®¾å¤‡å&#x2F;MAC åœ°å€</h4><ul><li>å¦‚æœå½“å‰ç‰©ç†æœåŠ¡å™¨å·²ç»å®‰è£…äº† ESXiï¼Œåˆ™ç™»å½• ESXi ä¸»æœºæŸ¥çœ‹ ESXi é»˜è®¤çš„ç®¡ç†ç½‘ç»œ vSwitch0 è™šæ‹Ÿäº¤æ¢æœºæ‰€è¿æ¥çš„ç‰©ç†ç½‘å¡è®¾å¤‡åï¼Œæ¯”å¦‚è¿™å°æœåŠ¡å™¨ç½‘å¡è®¾å¤‡åä¸º <code>vmnic4</code></li></ul><p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-05.png" alt="img"></p><ul><li>å¦ä¸€ç§æ–¹å¼åˆ™æ˜¯ç™»å½•æœåŠ¡å™¨çš„ IPMI ç®¡ç†é¡µé¢ï¼ŒæŸ¥çœ‹å¯¹åº”ç½‘å¡çš„ MAC åœ°å€</li></ul><p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-02.png" alt="img"></p><h3 id="å¡«å†™é…ç½®æ–‡ä»¶"><a href="#å¡«å†™é…ç½®æ–‡ä»¶" class="headerlink" title="å¡«å†™é…ç½®æ–‡ä»¶"></a>å¡«å†™é…ç½®æ–‡ä»¶</h3><p>é€šè¿‡ä»¥ä¸Šæ–¹å¼ç¡®å®šå¥½ ESXi OS æ‰€å®‰è£…çš„ç¡¬ç›˜å‹å·æˆ–åºåˆ—å·ï¼Œä»¥åŠ ESXi é»˜è®¤ç®¡ç†ç½‘ç»œ vSwitch0 æ‰€å…³è”çš„ç‰©ç†ç½‘å¡è®¾å¤‡åæˆ– MAC åœ°å€ä¹‹åï¼Œæˆ‘ä»¬å°±å°†è¿™äº›é…ç½®å‚æ•°å¡«å…¥åˆ°è¯¥é…ç½®æ–‡ä»¶å½“ä¸­ã€‚åé¢çš„å·¥å…·ä¼šä½¿ç”¨è¯¥é…ç½®ä¸ºæ¯å°æœºå™¨ç”Ÿæˆä¸åŒçš„ kickstart æ–‡ä»¶ï¼Œåœ¨ kickstart æ–‡ä»¶ä¸­æŒ‡å®š ESXi OS å®‰è£…çš„ç¡¬ç›˜ï¼ŒESXi ç®¡ç†ç½‘ç»œæ‰€ä½¿ç”¨çš„ç½‘å¡ï¼Œä»¥åŠè®¾ç½®é™æ€ IPã€å­ç½‘æ©ç ã€ç½‘å…³ã€ä¸»æœºåç­‰å‚æ•°ã€‚</p><ul><li><a href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/config-example.yaml">config.yaml</a></li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">hosts</span><span class="token punctuation">:</span><span class="token punctuation">-</span> <span class="token key atrule">ipmi</span><span class="token punctuation">:</span>    <span class="token key atrule">vendor</span><span class="token punctuation">:</span> lenovo                  <span class="token comment"># æœåŠ¡å™¨å‚å•†å [dell, lenovo, hpe]</span>    <span class="token key atrule">address</span><span class="token punctuation">:</span> 10.172.70.186          <span class="token comment"># IPMI IP åœ°å€</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> username              <span class="token comment"># IPMI ç”¨æˆ·å</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> password              <span class="token comment"># IPMI å¯†ç </span>  <span class="token key atrule">esxi</span><span class="token punctuation">:</span>    <span class="token key atrule">esxi_disk</span><span class="token punctuation">:</span> ThinkSystem M.2      <span class="token comment"># ESXi OS æ‰€å®‰è£…ç¡¬ç›˜çš„å‹å·æˆ–åºåˆ—å·</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> password              <span class="token comment"># ESXi çš„ root ç”¨æˆ·å¯†ç </span>    <span class="token key atrule">address</span><span class="token punctuation">:</span> 10.172.69.86           <span class="token comment"># ESXi ç®¡ç†ç½‘ç»œ IP åœ°å€</span>    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 10.172.64.1            <span class="token comment"># ESXi ç®¡ç†ç½‘ç»œç½‘å…³</span>    <span class="token key atrule">netmask</span><span class="token punctuation">:</span> 255.255.240.0          <span class="token comment"># ESXi ç®¡ç†ç½‘ç»œå­ç½‘æ©ç </span>    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> esxi<span class="token punctuation">-</span>69<span class="token punctuation">-</span><span class="token number">86</span>            <span class="token comment"># ESXi ä¸»æœºåï¼ˆå¯é€‰ï¼‰</span>    <span class="token key atrule">mgtnic</span><span class="token punctuation">:</span> vmnic4                  <span class="token comment"># ESXi ç®¡ç†ç½‘ç»œç½‘å¡åç§°æˆ–MAC åœ°å€</span><span class="token punctuation">-</span> <span class="token key atrule">ipmi</span><span class="token punctuation">:</span>    <span class="token key atrule">vendor</span><span class="token punctuation">:</span> dell    <span class="token key atrule">address</span><span class="token punctuation">:</span> 10.172.18.191    <span class="token key atrule">username</span><span class="token punctuation">:</span> username    <span class="token key atrule">password</span><span class="token punctuation">:</span> password  <span class="token key atrule">esxi</span><span class="token punctuation">:</span>    <span class="token key atrule">esxi_disk</span><span class="token punctuation">:</span> DELLBOSS VD    <span class="token key atrule">password</span><span class="token punctuation">:</span> password    <span class="token key atrule">address</span><span class="token punctuation">:</span> 10.172.18.95    <span class="token key atrule">gateway</span><span class="token punctuation">:</span> 10.172.16.1    <span class="token key atrule">netmask</span><span class="token punctuation">:</span> 255.255.240.0    <span class="token key atrule">mgtnic</span><span class="token punctuation">:</span> B4<span class="token punctuation">:</span>96<span class="token punctuation">:</span>91<span class="token punctuation">:</span>A7<span class="token punctuation">:</span>3F<span class="token punctuation">:</span>D6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ç”Ÿæˆ-inventory-æ–‡ä»¶"><a href="#ç”Ÿæˆ-inventory-æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆ inventory æ–‡ä»¶"></a>ç”Ÿæˆ inventory æ–‡ä»¶</h3><p>åœ¨ <a href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/tools.sh">tools.sh</a> è„šæœ¬ä¸­é€šè¿‡ <a href="https://github.com/mikefarah/yq">yq</a> å‘½ä»¤è¡Œå·¥å…·è§£æ <code>config.yaml</code> é…ç½®æ–‡ä»¶ï¼Œå¾—åˆ°æ¯å°ä¸»æœºçš„é…ç½®ä¿¡æ¯ï¼Œå¹¶æ ¹æ®è¯¥ä¿¡æ¯ç”Ÿæˆä¸€ä¸ª ansible çš„ inventory æ–‡ä»¶</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">rendder_host_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">index</span><span class="token operator">=</span><span class="token variable">$1</span>    <span class="token assign-left variable">vendor</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].ipmi.vendor"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">os_disk</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.esxi_disk"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>"</span>    <span class="token assign-left variable">esxi_mgtnic</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.mgtnic"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">esxi_address</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.address"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">esxi_gateway</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.gateway"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">esxi_netmask</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.netmask"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">esxi_password</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.password"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">ipmi_address</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].ipmi.address"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">ipmi_username</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].ipmi.username"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">ipmi_password</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].ipmi.password"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>    <span class="token assign-left variable">esxi_hostname</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>yq -e <span class="token builtin class-name">eval</span> <span class="token string">".hosts.[<span class="token variable">$index</span>].esxi.hostname"</span> $<span class="token punctuation">&#123;</span>CONFIG<span class="token punctuation">&#125;</span> <span class="token operator"><span class="token file-descriptor important">2</span>></span> /dev/null <span class="token operator">||</span> <span class="token boolean">true</span><span class="token variable">)</span></span>"</span><span class="token punctuation">&#125;</span><span class="token keyword">function</span> <span class="token function-name function">gen_inventory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> <span class="token variable">$&#123;INVENTORY&#125;</span></span>_hpe__dell__lenovo_[all:children]hpedelllenovoEOF</span>    <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">0</span> `expr $<span class="token punctuation">&#123;</span>nums<span class="token punctuation">&#125;</span> - <span class="token number">1</span>`<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>        rendder_host_info <span class="token variable">$&#123;i&#125;</span>        <span class="token assign-left variable">host_info</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;ipmi_address&#125;</span> username=<span class="token variable">$&#123;ipmi_username&#125;</span> password=<span class="token variable">$&#123;ipmi_password&#125;</span> esxi_address=<span class="token variable">$&#123;esxi_address&#125;</span> esxi_password=<span class="token variable">$&#123;esxi_password&#125;</span>"</span>        <span class="token function">sed</span> -i <span class="token string">"/_<span class="token variable">$&#123;vendor&#125;</span>_/a <span class="token variable">$&#123;host_info&#125;</span>"</span> <span class="token variable">$&#123;INVENTORY&#125;</span>    <span class="token keyword">done</span>    <span class="token function">sed</span> -i <span class="token string">"s#^_dell_#[dell]#g;s#^_lenovo_#[lenovo]#g;s#_hpe_#[hpe]#g"</span> <span class="token variable">$&#123;INVENTORY&#125;</span>    <span class="token builtin class-name">echo</span> <span class="token string">"gen inventory success"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”Ÿæˆåçš„ inventory æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼Œæ ¹æ®ä¸åŒçš„å‚å•†åç§°è¿›è¡Œåˆ†ç»„</p><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">hpe</span><span class="token punctuation">]</span></span><span class="token key attr-name">10.172.18.191 username</span><span class="token punctuation">=</span><span class="token value attr-value">username password=password esxi_address=10.172.18.95 esxi_password=password</span><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">dell</span><span class="token punctuation">]</span></span><span class="token key attr-name">10.172.18.192 username</span><span class="token punctuation">=</span><span class="token value attr-value">username password=password esxi_address=10.172.18.96 esxi_password=password</span><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">lenovo</span><span class="token punctuation">]</span></span><span class="token key attr-name">10.172.18.193 username</span><span class="token punctuation">=</span><span class="token value attr-value">username password=password esxi_address=10.172.18.97 esxi_password=password</span><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">all:children</span><span class="token punctuation">]</span></span>hpedelllenovo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ£€æŸ¥-Redfish-ç™»å½•æ˜¯å¦æ­£å¸¸"><a href="#æ£€æŸ¥-Redfish-ç™»å½•æ˜¯å¦æ­£å¸¸" class="headerlink" title="æ£€æŸ¥ Redfish ç™»å½•æ˜¯å¦æ­£å¸¸"></a>æ£€æŸ¥ Redfish ç™»å½•æ˜¯å¦æ­£å¸¸</h3><p>é€šè¿‡ Redfish çš„ GetSystemInventory å‘½ä»¤è·å–æœåŠ¡å™¨çš„ inventory æ¸…å•æ¥æ£€æŸ¥ç™»å½• Redfish æ˜¯å¦æ­£å¸¸ï¼Œç”¨æˆ·åæˆ–å¯†ç æ˜¯å¦æ­£ç¡®ã€‚</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Getting system inventory  <span class="token key atrule">community.general.redfish_info</span><span class="token punctuation">:</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> Systems    <span class="token key atrule">command</span><span class="token punctuation">:</span> GetSystemInventory    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ç”Ÿæˆ-kickstart-æ–‡ä»¶"><a href="#ç”Ÿæˆ-kickstart-æ–‡ä»¶" class="headerlink" title="ç”Ÿæˆ kickstart æ–‡ä»¶"></a>ç”Ÿæˆ kickstart æ–‡ä»¶</h3><p>åœ¨ <a href="">tools.sh</a> åŒæ ·ä½¿ç”¨ yq å‘½ä»¤è¡Œå·¥å…·æ¸²æŸ“é…ç½®æ–‡ä»¶ï¼Œå¾—åˆ°æ¯å°ä¸»æœºçš„é…ç½®ä¿¡æ¯ï¼Œä¸ºæ¯å°ä¸»æœºç”Ÿæˆä¸€ä¸ªç‰¹å®šçš„ kickstart æ–‡ä»¶ã€‚</p><p>åœ¨ kickstart æ–‡ä»¶ä¸­æˆ‘ä»¬æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>install --overwritevmfs --firstdisk=&quot;$&#123;ESXI_DISK&#125;&quot;</code> é…ç½® ESXi OS å®‰è£…åœ¨å“ªä¸€å—ç¡¬ç›˜ä¸Šï¼›</p><p>é€šè¿‡ <code>network --bootproto=static</code> ä¸º ESXi ç®¡ç†ç½‘ç»œé…ç½®é™æ€ IPã€å­ç½‘æ©ç ã€ç½‘å…³ã€ä¸»æœºåã€ç‰©ç†ç½‘å¡ç­‰å‚æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½¿ç”¨ MAC åœ°å€æŒ‡å®šç½‘å¡ï¼ŒMAC åœ°å€å¿…é¡»ä¸ºå¤§å†™ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ tr è¿›è¡Œäº†ä¸€ä¸‹å¤§å°å†™è½¬æ¢ï¼›</p><p>é€šè¿‡ <code>clearpart --alldrives --overwritevmfs</code> å¯ä»¥æ¸…é™¤æ‰€æœ‰ç¡¬ç›˜ä¸Šçš„åˆ†åŒºï¼Œæˆ‘ä»¬å®‰è£…æ—¶ä¸€èˆ¬æ˜¯å°†å®ƒä»¬å…¨éƒ¨æ¸…ç†æ‰ï¼Œæ–¹ä¾¿è¿›è¡Œæµ‹è¯•ï¼›</p><p>æœ€åå†å¼€å¯ SSH æœåŠ¡å¹¶å¼€å¯ sshServer çš„é˜²ç«å¢™ï¼Œæ–¹ä¾¿åç»­æµ‹è¯•ä½¿ç”¨ï¼›</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">gen_iso_ks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">ISO_KS</span><span class="token operator">=</span><span class="token variable">$1</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">ESXI_DISK</span><span class="token operator">=</span><span class="token variable">$&#123;os_disk&#125;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">IP_ADDRESS</span><span class="token operator">=</span><span class="token variable">$&#123;esxi_address&#125;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">NETMASK</span><span class="token operator">=</span><span class="token variable">$&#123;esxi_netmask&#125;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">GATEWAY</span><span class="token operator">=</span><span class="token variable">$&#123;esxi_gateway&#125;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">DNS_SERVER</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;GATEWAY&#125;</span>"</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">PASSWORD</span><span class="token operator">=</span><span class="token variable">$&#123;esxi_password&#125;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable"><span class="token environment constant">HOSTNAME</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $<span class="token punctuation">&#123;</span>esxi_hostname<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">"s/null/esxi-<span class="token variable">$&#123;esxi_address<span class="token operator">/</span><span class="token operator">/</span>.<span class="token operator">/</span>-&#125;</span>/"</span><span class="token variable">)</span></span>"</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">MGTNIC</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $<span class="token punctuation">&#123;</span>esxi_mgtnic<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">'[a-z]'</span> <span class="token string">'[A-Z]'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/VMNIC/vmnic/g'</span><span class="token variable">)</span></span>    <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> <span class="token variable">$&#123;ISO_KS&#125;</span></span>vmaccepteula# Set the root password for the DCUI and Tech Support Moderootpw <span class="token variable">$&#123;PASSWORD&#125;</span># Set the keyboardkeyboard 'US Default'# wipe exisiting VMFS store # CAREFUL!clearpart --alldrives --overwritevmfs# Install on the first local disk available on machineinstall --overwritevmfs --firstdisk="<span class="token variable">$&#123;ESXI_DISK&#125;</span>"# Set the network to DHCP on the first network adapternetwork --bootproto=static --hostname=<span class="token variable">$&#123;<span class="token environment constant">HOSTNAME</span>&#125;</span> --ip=<span class="token variable">$&#123;IP_ADDRESS&#125;</span> --gateway=<span class="token variable">$&#123;GATEWAY&#125;</span> --nameserver=<span class="token variable">$&#123;DNS_SERVER&#125;</span> --netmask=<span class="token variable">$&#123;NETMASK&#125;</span> --device="<span class="token variable">$&#123;MGTNIC&#125;</span>"reboot%firstboot --interpreter=busybox# Enable SSHvim-cmd hostsvc/enable_sshvim-cmd hostsvc/start_sshesxcli network firewall ruleset set --enabled=false --ruleset-id=sshServerEOF</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é‡æ–°æ„å»º-ESXi-ISO"><a href="#é‡æ–°æ„å»º-ESXi-ISO" class="headerlink" title="é‡æ–°æ„å»º ESXi ISO"></a>é‡æ–°æ„å»º ESXi ISO</h3><p>è¿™ä¸€æ­¥çš„æ“ä½œä¸»è¦æ˜¯ä¿®æ”¹ ESXi ISO çš„å¯åŠ¨é¡¹é…ç½®ï¼Œé…ç½® ks æ–‡ä»¶çš„è·¯å¾„ï¼Œä¸»è¦æ˜¯ä¿®æ”¹ ISO æ–‡ä»¶é‡Œçš„ <code> boot.cfg</code> å’Œ <code>efi/boot/boot.cfg</code> æ–‡ä»¶ã€‚åœ¨å¯åŠ¨å‚æ•°ä¸­åŠ å…¥ <code>ks=cdrom:/KS.CFG</code> ç”¨äºæŒ‡å®š ESXi OS å®‰è£…é€šè¿‡è¯»å– kickstart è„šæœ¬çš„æ–¹å¼æ¥å®Œæˆã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> -i -e <span class="token string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> boot.cfg<span class="token function">sed</span> -i -e <span class="token string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> efi/boot/boot.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å¦å¤–åœ¨ VMware çš„ KB <a href="https://kb.vmware.com/s/article/81166">Boot option to configure the size of ESXi system partitions (81166)</a> ä¸­ï¼Œæåˆ°è¿‡å¯ä»¥è®¾ç½® <code>systemMediaSize=small</code> æ¥è°ƒæ•´ VMFS-L åˆ†åŒºçš„å¤§å°ã€‚ESXi 7.0 ç‰ˆæœ¬ä¹‹åä¼šé»˜è®¤åˆ›å»ºä¸€ä¸ª VMFS-L åˆ†åŒºï¼Œå¦‚æœ SATA DOM ç›˜æ¯”è¾ƒå°çš„è¯æ¯”å¦‚åªæœ‰ 128Gï¼Œå»ºè®®è®¾ç½®æ­¤å‚æ•°ã€‚ä¸ç„¶å¯èƒ½ä¼šå¯¼è‡´å®‰è£…å®Œ ESXi OS ä¹‹åç£ç›˜å‰©ä½™çš„ç©ºé—´éƒ½è¢« VMFS-L åˆ†åŒºç»™å ç”¨ï¼Œå¯¼è‡´æ²¡æœ‰ä¸€ä¸ªæœ¬åœ°çš„æ•°æ®å­˜å‚¨å¯ä»¥ä½¿ç”¨ã€‚</p><p>ä¿®æ”¹å¥½ ESXi çš„å¯åŠ¨é…ç½®ä¹‹åï¼Œæˆ‘ä»¬å†ä½¿ç”¨ genisoimage å‘½ä»¤é‡æ–°æ„å»ºä¸€ä¸ª ESXi ISO æ–‡ä»¶ï¼Œå°†æ„å»ºå¥½çš„ ISO æ–‡ä»¶æ”¾åˆ°ä¸€ä¸ª http æ–‡ä»¶æœåŠ¡çš„ç›®å½•ä¸‹ï¼Œå¦‚ nginx çš„ <code>/usr/share/nginx/html/iso</code>ã€‚åé¢å°†ä¼šé€šè¿‡ http çš„æ–¹å¼å°† ISO æŒ‚è½½åˆ°æœåŠ¡å™¨çš„è™šæ‹Ÿå…‰é©±ä¸Šã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">rebuild_esxi_iso</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">dest_iso_mount_dir</span><span class="token operator">=</span><span class="token variable">$1</span>    <span class="token builtin class-name">local</span> <span class="token assign-left variable">dest_iso_path</span><span class="token operator">=</span><span class="token variable">$2</span>    <span class="token function">pushd</span> <span class="token variable">$&#123;dest_iso_mount_dir&#125;</span> <span class="token operator">></span> /dev/null    <span class="token function">sed</span> -i -e <span class="token string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> boot.cfg    <span class="token function">sed</span> -i -e <span class="token string">'s#cdromBoot#ks=cdrom:/KS.CFG systemMediaSize=small#g'</span> efi/boot/boot.cfg    genisoimage -J <span class="token punctuation">\</span>                -R  <span class="token punctuation">\</span>                -o <span class="token variable">$&#123;dest_iso_path&#125;</span> <span class="token punctuation">\</span>                -relaxed-filenames <span class="token punctuation">\</span>                -b isolinux.bin <span class="token punctuation">\</span>                -c boot.cat <span class="token punctuation">\</span>                -no-emul-boot <span class="token punctuation">\</span>                -boot-load-size <span class="token number">4</span> <span class="token punctuation">\</span>                -boot-info-table <span class="token punctuation">\</span>                -eltorito-alt-boot <span class="token punctuation">\</span>                -eltorito-boot efiboot.img <span class="token punctuation">\</span>                -quiet --no-emul-boot <span class="token punctuation">\</span>                <span class="token builtin class-name">.</span> <span class="token operator">></span> /dev/null  <span class="token function">popd</span> <span class="token operator">></span> /dev/null<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‡æ–°æ„å»ºå¥½ ESXi ISO ä¹‹åçš„ nginx ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># tree /usr/share/nginx/html/iso/</span>/usr/share/nginx/html/iso/â”œâ”€â”€ redfishâ”‚   â”œâ”€â”€ <span class="token number">172.20</span>.18.191â”‚   â”‚   â””â”€â”€ VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="token comment"># é‡æ–°æ„å»ºçš„ ISO</span>â”‚   â”œâ”€â”€ <span class="token number">172.20</span>.18.192â”‚   â”‚   â””â”€â”€ VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="token comment"># é‡æ–°æ„å»ºçš„ ISO</span>â”‚   â”œâ”€â”€ <span class="token number">172.20</span>.18.193â”‚   â”‚   â””â”€â”€ VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="token comment"># é‡æ–°æ„å»ºçš„ ISO</span>â”‚   â””â”€â”€ <span class="token number">172.20</span>.70.186â”‚       â””â”€â”€ VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso <span class="token comment"># é‡æ–°æ„å»ºçš„ ISO</span>â”œâ”€â”€ VMware-VMvisor-Installer-6.7.0.update03-14320388.x86_64.iso <span class="token comment"># åŸ ISO</span>â”œâ”€â”€ VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso         <span class="token comment"># åŸ ISO</span>â””â”€â”€ VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso         <span class="token comment"># åŸ ISO</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é€šè¿‡-redfish-å¼¹å‡ºå·²æœ‰çš„-Virtual-Media"><a href="#é€šè¿‡-redfish-å¼¹å‡ºå·²æœ‰çš„-Virtual-Media" class="headerlink" title="é€šè¿‡ redfish å¼¹å‡ºå·²æœ‰çš„ Virtual Media"></a>é€šè¿‡ redfish å¼¹å‡ºå·²æœ‰çš„ Virtual Media</h3><p>redfish æ’å…¥&#x2F;å¼¹å‡º ISO æ“ä½œæœ‰ç°æˆå¯ç”¨çš„ ansible æ¨¡å—å¯ä»¥ä½¿ç”¨ï¼Œä¸å¿…é‡å¤é€ è½®å­ã€‚ä¸åŒçš„æœåŠ¡å™¨å‚å•†è°ƒç”¨çš„æ¨¡å—å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œä¸è¿‡å‚æ•°åŸºæœ¬ä¸Šæ˜¯ç›¸åŒçš„ã€‚</p><p>å¦‚æœå½“å‰æœåŠ¡å™¨ä¸Šå·²ç»æŒ‚è½½äº†ä¸€äº›å…¶ä»–çš„ ISOï¼Œè¦å°†ä»–ä»¬å…¨éƒ¨å¼¹å‡ºæ‰è¡Œï¼Œä¸ç„¶åœ¨æŒ‚è½½ ISO çš„æ—¶å€™ä¼šå¤±è´¥é€€å‡ºï¼Œå¹¶ä¸”ä¹Ÿèƒ½é¿å…å¤šä¸ª ISO é‡å¯å¯åŠ¨çš„æ—¶å€™å¼•èµ·å†²çªå¯åŠ¨åˆ°å¦ä¸€ä¸ª ISO ä¸­ã€‚</p><ul><li>è”æƒ³æœåŠ¡å™¨çš„ VirtualMediaEject å‘½ä»¤å¯ä»¥å¼¹å‡ºæ‰€æœ‰çš„ ISO</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Lenovo <span class="token punctuation">|</span> Eject all Virtual Media  <span class="token key atrule">community.general.xcc_redfish_command</span><span class="token punctuation">:</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> Manager    <span class="token key atrule">command</span><span class="token punctuation">:</span> VirtualMediaEject    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">resource_id</span><span class="token punctuation">:</span> <span class="token string">"1"</span>  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso  <span class="token punctuation">-</span> umount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æˆ´å°”å’Œ HPE æœåŠ¡å™¨åœ¨å¼¹å‡º ISO çš„æ—¶å€™éœ€è¦å…ˆçŸ¥é“åŸæœ‰ ISO çš„ URLã€‚å› æ­¤å…ˆé€šè¿‡ <code>GetVirtualMedia</code> å‘½ä»¤è·å–åˆ°ä¸€ä¸ª ISO çš„ URL åˆ—è¡¨ï¼Œç„¶åå†æ ¹æ®è¿™ä¸ªåˆ—è¡¨ä¸€ä¸€å¼¹å‡ºã€‚</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Get virtual media details  <span class="token key atrule">community.general.redfish_info</span><span class="token punctuation">:</span>    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"GetVirtualMedia"</span>  <span class="token key atrule">register</span><span class="token punctuation">:</span> result  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso  <span class="token punctuation">-</span> umount<span class="token punctuation">-</span>iso  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Eject virtual media  <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"VirtualMediaEject"</span>    <span class="token key atrule">virtual_media</span><span class="token punctuation">:</span>      <span class="token key atrule">image_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; item &#125;&#125;"</span>  <span class="token key atrule">with_items</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; result.redfish_facts.virtual_media.entries[0][1] | selectattr('ConnectedVia', 'equalto','URI') | map(attribute='Image') | list &#125;&#125;"</span>  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso  <span class="token punctuation">-</span> umount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨å¼¹å‡ºä¸€ä¸ª ISO çš„æ—¶å€™éœ€è¦å…ˆçŸ¥é“ ISO çš„ URLï¼Œæ„Ÿè§‰æœ‰ç‚¹å¥‡è‘© ğŸ˜‚ã€‚æ›´åˆç†çš„åº”è¯¥æ˜¯éœ€è¦ä¸€ä¸ªæŒ‚è½½ç‚¹çš„æ ‡è¯†ï¼Œå°±åƒæ¯” Linux ä¸Šçš„æŒ‚è½½ç‚¹ã€‚åœ¨ umount æŒ‚è½½çš„è®¾å¤‡æ—¶ï¼Œåªéœ€è¦çŸ¥é“æŒ‚è½½ç‚¹å³å¯ï¼Œä¸éœ€è¦çŸ¥é“æŒ‚è½½çš„è®¾å¤‡æ˜¯ä»€ä¹ˆã€‚åœ¨ ISSUE <a href="https://github.com/ansible-collections/community.general/issues/3042">VirtualMediaEject should not require image_url </a> ä¸­æœ‰å¤§ä½¬åé¦ˆè¿‡åœ¨å¼¹å‡º ISO çš„æ—¶å€™ä¸åº”è¯¥éœ€è¦ image urlï¼Œä¸è¿‡è¢« maintainer ç»™å¦å†³äº† ğŸ˜…ã€‚</p><blockquote><p>Yes, at least with the behavior weâ€™ve implemented today the image URL is needed since the expectation is the user is specifying the image URL for the ISO to eject. I think we need to consider some things first before making changes.</p><p>If the image URL is not given, then what exactly should be ejected? All virtual media your example indicates? This seems a bit heavy handed in my opinion, but others might like this behavior. Redfish itself doesnâ€™t support an â€œeject allâ€ type of operation, and I suspect the script youâ€™re referencing is either using OEM actions or is just looping on all slots and ejecting everything.</p><p>Should a user be allowed specify an alternative identifier (such as the â€œIdâ€ of the virtual media instance) in order to control what slot is ejected?</p><p>Certainly would like opinions from others for desired behavior. I do like the idea of keeping the mandatory argument list as minimal as possible, but would like to agree upon the desired behavior first.</p></blockquote><h3 id="é€šè¿‡-Redfish-æ’å…¥-ISO"><a href="#é€šè¿‡-Redfish-æ’å…¥-ISO" class="headerlink" title="é€šè¿‡ Redfish æ’å…¥ ISO"></a>é€šè¿‡ Redfish æ’å…¥ ISO</h3><ul><li>è”æƒ³æœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯ <code>community.general.xcc_redfish_command</code> æ¨¡å—ï¼Œredfish çš„ command ä¸º VirtualMediaInsertï¼›</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Lenovo <span class="token punctuation">|</span> Insert <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> image_url <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> Virtual Media  <span class="token key atrule">community.general.xcc_redfish_command</span><span class="token punctuation">:</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> Manager    <span class="token key atrule">command</span><span class="token punctuation">:</span> VirtualMediaInsert    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">virtual_media</span><span class="token punctuation">:</span>      <span class="token key atrule">image_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; image_url &#125;&#125;"</span>      <span class="token key atrule">media_types</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> CD        <span class="token punctuation">-</span> DVD    <span class="token key atrule">resource_id</span><span class="token punctuation">:</span> <span class="token string">"1"</span>  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æˆ´å°”å’Œ HPE æœåŠ¡å™¨æŒ‚è½½ ISO ä½¿ç”¨çš„åˆ™æ˜¯ <code>community.general.redfish_command</code> æ¨¡å—ï¼Œcommand å’Œè”æƒ³çš„ç›¸åŒï¼›</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Insert <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> image_url <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO as virtual media device <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>   <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>   <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>   <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>   <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>   <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"VirtualMediaInsert"</span>   <span class="token key atrule">virtual_media</span><span class="token punctuation">:</span>     <span class="token key atrule">image_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; image_url &#125;&#125;"</span>     <span class="token key atrule">media_types</span><span class="token punctuation">:</span>       <span class="token punctuation">-</span> CD       <span class="token punctuation">-</span> DVD <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¦‚æœä½¿ç”¨ <code>community.general.redfish_command</code> æ¨¡å—ä¸ºè”æƒ³çš„æœåŠ¡å™¨æŒ‚è½½ ISO ä¼šæç¤º 4xx é”™è¯¯ï¼Œå¿…é¡»ä½¿ç”¨ <code>community.general.xcc_redfish_command</code> æ¨¡å—æ‰è¡Œã€‚</p><h3 id="è®¾ç½®å¯åŠ¨é¡¹ä¸ºè™šæ‹Ÿå…‰é©±"><a href="#è®¾ç½®å¯åŠ¨é¡¹ä¸ºè™šæ‹Ÿå…‰é©±" class="headerlink" title="è®¾ç½®å¯åŠ¨é¡¹ä¸ºè™šæ‹Ÿå…‰é©±"></a>è®¾ç½®å¯åŠ¨é¡¹ä¸ºè™šæ‹Ÿå…‰é©±</h3><p>æ­¤è¿‡ç¨‹æ˜¯å°†æœåŠ¡å™¨çš„å¯åŠ¨é¡¹è®¾ç½®ä¸ºè™šæ‹Ÿå…‰é©±ï¼Œä¸åŒå‚å•†çš„æœåŠ¡å™¨è°ƒç”¨çš„ ansible æ¨¡å—å¯èƒ½ä¹Ÿä¼šæœ‰æ‰€ä¸åŒã€‚</p><ul><li>è”æƒ³å’Œ HPE æœåŠ¡å™¨</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set one<span class="token punctuation">-</span>time boot device to <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> bootdevice <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>  <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> Systems    <span class="token key atrule">command</span><span class="token punctuation">:</span> SetOneTimeBoot    <span class="token key atrule">bootdevice</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; bootdevice &#125;&#125;"</span>    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">20</span>  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'dell'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æˆ´å°”æœåŠ¡å™¨</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>  Dell <span class="token punctuation">|</span> set iDRAC attribute for one<span class="token punctuation">-</span>time boot from virtual CD  <span class="token key atrule">community.general.idrac_redfish_config</span><span class="token punctuation">:</span>    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"SetManagerAttributes"</span>    <span class="token key atrule">manager_attributes</span><span class="token punctuation">:</span>      <span class="token key atrule">ServerBoot.1.BootOnce</span><span class="token punctuation">:</span> <span class="token string">"Enabled"</span>      <span class="token key atrule">ServerBoot.1.FirstBootDevice</span><span class="token punctuation">:</span> <span class="token string">"VCD-DVD"</span>  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname in groups<span class="token punctuation">[</span><span class="token string">'dell'</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é‡å¯æœåŠ¡å™¨"><a href="#é‡å¯æœåŠ¡å™¨" class="headerlink" title="é‡å¯æœåŠ¡å™¨"></a>é‡å¯æœåŠ¡å™¨</h3><p>é‡å¯æœåŠ¡å™¨ç›´æ¥è°ƒç”¨ <code>community.general.redfish_command</code> æ¨¡å—å°±å¯ä»¥ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé‡å¯æœåŠ¡å™¨ä¹‹å‰è¦ä¿è¯æœåŠ¡å™¨å½“å‰çŠ¶æ€ä¸ºå¼€å¯çŠ¶æ€ï¼Œå› æ­¤è°ƒç”¨ä¸€ä¸‹ redfish çš„ PowerOn å‘½ä»¤å¯¹æœåŠ¡å™¨è¿›è¡Œå¼€æœºï¼Œå¦‚æœå·²å¤„äºå¼€æœºçŠ¶æ€åˆ™æ— å½±å“ï¼Œç„¶åå†è°ƒç”¨ PowerForceRestart å‘½ä»¤é‡å¯æœåŠ¡å™¨ã€‚</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">name</span><span class="token punctuation">:</span> Power Force Restart the host  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Turn system power on    <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>      <span class="token key atrule">category</span><span class="token punctuation">:</span> Systems      <span class="token key atrule">command</span><span class="token punctuation">:</span> PowerOn      <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>      <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Reboot system    <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>      <span class="token key atrule">category</span><span class="token punctuation">:</span> Systems      <span class="token key atrule">command</span><span class="token punctuation">:</span> PowerForceRestart      <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>      <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">20</span>  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> reboot<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¿™é‡Œè¿˜æœ‰ä¼˜åŒ–çš„ç©ºé—´ï¼Œå°±æ˜¯æ ¹æ®ç”µæºçš„çŠ¶æ€å†³å®šæ˜¯é‡å¯è¿˜æ˜¯å¼€æœºï¼Œä¸è¿‡æœ‰ç‚¹éº»çƒ¦æ‡’å¾—å¼„äº† ğŸ˜…</p><h3 id="ç­‰å¾…-ESXi-OS-å®‰è£…å®Œæˆ"><a href="#ç­‰å¾…-ESXi-OS-å®‰è£…å®Œæˆ" class="headerlink" title="ç­‰å¾… ESXi OS å®‰è£…å®Œæˆ"></a>ç­‰å¾… ESXi OS å®‰è£…å®Œæˆ</h3><p>æœåŠ¡å™¨é‡å¯ä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡ govc å‘½ä»¤ä¸æ–­å°è¯•è¿æ¥ ESXi ä¸»æœºï¼Œå¦‚æœèƒ½å¤Ÿæ­£å¸¸è¿æ¥åˆ™è¯´æ˜ ESXi OS å·²ç»å®‰è£…å®Œæˆäº†ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ç­‰å¾… 15 åˆ†é’Ÿå·¦å³å°±èƒ½å®‰è£…å®Œæˆï¼ŒæœŸé—´éœ€è¦é‡å¯æœåŠ¡å™¨ä¸¤æ¬¡ï¼Œæ¯æ¬¡é‡å¯å¤§æ¦‚éœ€è¦ 5 åˆ†é’Ÿå·¦å³ï¼Œå®é™…ä¸Š ESXi è¿›å…¥å®‰è£…é¡µé¢åˆ°å®‰è£…å®Œæˆåªéœ€è¦ 5 åˆ†é’Ÿå·¦å³ï¼ŒæœåŠ¡å™¨å¼€æœºè‡ªæ£€å ç”¨çš„æ—¶é—´ä¼šç¨å¾®é•¿ä¸€ç‚¹ã€‚</p><p><img data-src="https://p.k8s.li/2022-04-30-redfish-auto-install-esxi-os-03.png" alt="image-20220428210819057"></p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">name</span><span class="token punctuation">:</span> Wait for the ESXi OS installation to complete  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">vars</span><span class="token punctuation">:</span>    <span class="token key atrule">esxi_username</span><span class="token punctuation">:</span> <span class="token string">"root"</span>    <span class="token key atrule">govc_url</span><span class="token punctuation">:</span> <span class="token string">"https://&#123;&#123; esxi_username &#125;&#125;:&#123;&#123; esxi_password &#125;&#125;@&#123;&#123; esxi_address &#125;&#125;"</span>  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"Wait for &#123;&#123; inventory_hostname &#125;&#125; install ESXi &#123;&#123; esxi_address &#125;&#125; host to be complete"</span>    <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">"govc about -k=true -u=&#123;&#123; govc_url&#125;&#125;"</span>    <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">60</span>    <span class="token key atrule">delay</span><span class="token punctuation">:</span> <span class="token number">30</span>    <span class="token key atrule">register</span><span class="token punctuation">:</span> result    <span class="token key atrule">until</span><span class="token punctuation">:</span> result.rc == 0  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> post<span class="token punctuation">-</span>check<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Makefile-å°è£…"><a href="#Makefile-å°è£…" class="headerlink" title="Makefile å°è£…"></a>Makefile å°è£…</h2><p>ä¸ºäº†æ–¹ä¾¿æ“ä½œï¼Œå°†ä¸Šè¿°æµç¨‹ä½¿ç”¨ Makefile è¿›è¡Œå°è£…ä¸€ä¸‹ï¼Œå¦‚æœä¸é…ç½® Jenkins Job çš„è¯ï¼Œå¯ä»¥åœ¨æœ¬åœ°å¡«å†™å¥½ <code>config.yaml</code> é…ç½®æ–‡ä»¶ï¼Œç„¶åè¿è¡Œ make å‘½ä»¤æ¥è¿›è¡Œç›¸å…³æ“ä½œã€‚</p><h3 id="vars"><a href="#vars" class="headerlink" title="vars"></a>vars</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">SRC_ISO_DIR     ?<span class="token operator">=</span> /usr/share/nginx/html/isoHTTP_DIR        ?<span class="token operator">=</span> /usr/share/nginx/html/iso/redfishHTTP_URL        ?<span class="token operator">=</span> http://172.20.17.20/iso/redfishESXI_ISO        ?<span class="token operator">=</span> VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.isoSRC_ISO_DIR   <span class="token comment"># åŸ ESXi ISO çš„å­˜æ”¾ç›®å½•</span>ESXI_ISO      <span class="token comment"># ESXi ISO çš„æ–‡ä»¶åï¼Œå¦‚ VMware-VMvisor-Installer-7.0U3d-19482537.x86_64.iso</span>HTTP_DIR      <span class="token comment"># HTTP æœåŠ¡å™¨çš„é™æ€æ–‡ä»¶å­˜æ”¾ç›®å½•ï¼Œæ¯”å¦‚ /usr/share/nginx/html æˆ– /var/www/html</span>              <span class="token comment"># é‡æ–°æ„å»ºå¥½çš„ ISO æ–‡ä»¶å°†å­˜æ”¾åˆ°è¿™ä¸ªç›®å½•å½“ä¸­</span>HTTP_URL      <span class="token comment"># HTTP æœåŠ¡å™¨çš„ URL åœ°å€ï¼Œæ¯”å¦‚ http://172.20.29.171/iso/redfish</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="target"><a href="#target" class="headerlink" title="target"></a>target</h3><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">make docke<span class="token punctuation">-</span>run  <span class="token comment"># åœ¨ docker å®¹å™¨é‡Œè¿è¡Œæ‰€æœ‰æ“ä½œï¼Œå¥½å¤„å°±æ˜¯ä¸ç”¨å†å®‰è£…ä¸€å † ansible ç­‰å·¥å…·çš„ä¾èµ–</span>make inventory  <span class="token comment"># æ ¹æ® config.yaml é…ç½®æ–‡ä»¶ç”Ÿæˆ ansible çš„ inventory æ–‡ä»¶</span>make pre<span class="token punctuation">-</span>check  <span class="token comment"># æ£€æŸ¥ç”Ÿæˆçš„ inventory æ–‡ä»¶æ˜¯å¦æ­£ç¡®ï¼Œè¿æ¥ redfish æ˜¯å¦æ­£å¸¸</span>make build<span class="token punctuation">-</span>iso  <span class="token comment"># ä¸ºæ¯å°ä¸»æœºç”Ÿæˆ kickstart æ–‡ä»¶å¹¶é‡æ–°æ„å»º ESXi OS ISO æ–‡ä»¶</span>make mount<span class="token punctuation">-</span>iso  <span class="token comment"># å°†æ„å»ºå¥½çš„ ISO æ–‡ä»¶é€šè¿‡ redfish æŒ‚è½½åˆ°ç‰©ç†æœåŠ¡å™¨çš„è™šæ‹Ÿå…‰é©±ï¼Œå¹¶è®¾å¤‡å¯åŠ¨é¡¹</span>make reboot     <span class="token comment"># é‡å¯æœåŠ¡å™¨ï¼Œè¿›å…¥åˆ°è™šæ‹Ÿå…‰é©±å¯åŠ¨ ESXi inatller</span>make post<span class="token punctuation">-</span>check <span class="token comment"># ç­‰å¾… ESXi OS å®‰è£…å®Œæˆ</span>make install<span class="token punctuation">-</span>os <span class="token comment"># è¿è¡Œ pre-check, mount-iso, reboot, post-check</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Jenkins-Job"><a href="#Jenkins-Job" class="headerlink" title="Jenkins Job"></a>Jenkins Job</h2><p>è™½ç„¶åœ¨ Makefile é‡Œå°è£…äº†æ¯”è¾ƒæ–¹ä¾¿çš„å‘½ä»¤æ“ä½œï¼Œä½†æ˜¯å¯¹äºä¸å¤ªç†Ÿæ‚‰è¿™å¥—æµç¨‹çš„ä½¿ç”¨äººå‘˜æ¥è®²è¿˜æ˜¯ä¸å¤Ÿä¾¿æ·ã€‚å¯¹äºä½¿ç”¨äººå‘˜æ¥è®²ä¸éœ€è¦çŸ¥é“å…·ä½“çš„æµç¨‹æ˜¯ä»€ä¹ˆï¼Œå› æ­¤è¿˜éœ€è¦æä¾›ä¸€ä¸ªæ›´ä¸ºä¾¿æ·çš„å…¥å£æ¥ä½¿ç”¨è¿™å¥—å·¥å…·ï¼Œå¯¹å¤–å±è”½æ‰æŠ€æœ¯å®ç°çš„ç»†èŠ‚ã€‚</p><p>åœ¨æˆ‘ä»¬å†…éƒ¨ï¼Œè€ç‰Œ CI å·¥å…· Jenkins å¤§å”ååˆ†å—æ¬¢è¿ï¼Œä½¿ç”¨çš„ååˆ†æ™®éã€‚ä¹‹å‰åŒäº‹ä¹Ÿå¸¸è°ƒä¾ƒï¼š<code>æˆ‘ä»¬å†…éƒ¨çš„ Jenkins è™½ç„¶è¾¾ä¸åˆ°äººæ‰‹ä¸€ä¸ªçš„æ•°é‡ï¼Œä½†æ¯ä¸ªå›¢é˜Ÿæœ‰ä¸¤ä¸‰ä¸ªè‡ªå·±çš„ Jenkins å†æ­£å¸¸ä¸è¿‡äº†</code>ğŸ¤£ã€‚å› æ­¤æä¾›äº†ä¸€ä¸ª Jenkins Job æ¥è¿è¡Œè¿™å¥—å®‰è£…å·¥å…·å†å®Œç¾ä¸è¿‡äº†ã€‚è¿™æ ·ä½¿ç”¨äººå‘˜å°±ä¸ç”¨å† clone repo ä»£ç ï¼Œå‚»ä¹ä¹åœ°è¿è¡Œä¸€äº› make å‘½ä»¤äº†ï¼Œæ¯•ç«Ÿä¸€ä¸ª Jenkins build çš„æŒ‰é’®æ¯” make å‘½ä»¤å¥½å¥½ç”¨å¾—å¤ªå¤šã€‚</p><p>æˆ‘ä»¬ç»„çš„ Jenkins æ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯ä½¿ç”¨ kubernetes Pod ä½œä¸ºåŠ¨æ€ Jenkins slave èŠ‚ç‚¹ï¼Œå³æ¯è¿è¡Œä¸€ä¸ª Jenkins Job å°±ä¼šæ ¹æ®å®šä¹‰çš„ Pod æ¨¡ç‰ˆåˆ›å»ºä¸€ä¸ª Pod åˆ°æŒ‡å®šçš„ Kubernetes é›†ç¾¤ä¸­ï¼Œç„¶å Jenkinsfile ä¸­å®šä¹‰çš„ stage éƒ½ä¼šè¿è¡Œåœ¨è¿™ä¸ª Pod å®¹å™¨å†…ã€‚è¿™äº›å†…å®¹å¯ä»¥å‚è€ƒä¸€ä¸‹æˆ‘ä¹‹å‰å†™çš„ <a href="https://blog.k8s.li/jenkins-with-kubernetes.html">Jenkins å¤§å”ä¸ kubernetes èˆ¹é•¿æ‰‹ç‰µæ‰‹ ğŸ§‘â€ğŸ¤â€ğŸ§‘</a>ã€‚</p><h3 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h3><p>å¦‚æœä½ ç†Ÿæ‚‰ Jenkins çš„è¯ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ª Jenkins Job ï¼Œå¹¶åœ¨ Job ä¸­è®¾ç½®å¥½å¦‚ä¸‹å‡ ä¸ªå‚æ•°ï¼Œå¹¶å°†è¿™ä¸ª <a href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/jenkins/Jenkinsfile">Jenkinsfile</a> ä¸­çš„å†…å®¹å¤åˆ¶åˆ° Jenkins Job çš„é…ç½®ä¸­ã€‚</p><table><thead><tr><th>å‚æ•°å</th><th>å‚æ•°ç±»å‹</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>esxi_iso</td><td>ArrayList</td><td>ESXi ISO æ–‡ä»¶ååˆ—è¡¨</td></tr><tr><td>http_server</td><td>String</td><td>HTTP æœåŠ¡å™¨çš„ IP åœ°å€</td></tr><tr><td>http_dir</td><td>String</td><td>HTTP æœåŠ¡å™¨çš„æ–‡ä»¶ç›®å½•è·¯å¾„</td></tr><tr><td>config_yaml</td><td>Text</td><td>config.yaml é…ç½®æ–‡ä»¶å†…å®¹</td></tr></tbody></table><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// params of jenkins jobdef ESXI_ISO <span class="token operator">=</span> params.esxi_isodef CONFIG_YAML <span class="token operator">=</span> params.config_yamldef HTTP_SERVER <span class="token operator">=</span> params.http_server// default params <span class="token keyword">for</span> the jobdef HTTP_DIR  <span class="token operator">=</span> params.http_dir ?: <span class="token string">"/usr/share/nginx/html"</span>def SRC_ISO_DIR <span class="token operator">=</span> params.src_iso_dir ?: <span class="token string">"<span class="token variable">$&#123;HTTP_DIR&#125;</span>/iso"</span>def DEST_ISO_DIR <span class="token operator">=</span> params.dest_iso_dir ?: <span class="token string">"<span class="token variable">$&#123;HTTP_DIR&#125;</span>/iso/redfish"</span>def WORKSPACE <span class="token operator">=</span> env.WORKSPACEdef JOB_NAME <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;env.JOB_BASE_NAME&#125;</span>"</span>def BUILD_NUMBER <span class="token operator">=</span> <span class="token string">"<span class="token variable">$&#123;env.BUILD_NUMBER&#125;</span>"</span>def POD_NAME <span class="token operator">=</span> <span class="token string">"jenkins-<span class="token variable">$&#123;JOB_NAME&#125;</span>-<span class="token variable">$&#123;BUILD_NUMBER&#125;</span>"</span>def POD_IMAGE <span class="token operator">=</span> params.pod_image ?: <span class="token string">"ghcr.io/muzi502/redfish-esxi-os-installer:v0.1.0-alpha.1"</span>// Kubernetes pod template to run.podTemplate<span class="token punctuation">(</span>    cloud: <span class="token string">"kubernetes"</span>,    namespace: <span class="token string">"default"</span>,    name: POD_NAME,    label: POD_NAME,    yaml: <span class="token string">""</span>"apiVersion: v1kind: Podspec:  containers:  - name: runner    image: <span class="token variable">$&#123;POD_IMAGE&#125;</span>    imagePullPolicy: Always    tty: <span class="token boolean">true</span>    volumeMounts:    - name: http-dir      mountPath: <span class="token variable">$&#123;HTTP_DIR&#125;</span>    securityContext:      privileged: <span class="token boolean">true</span>    env:    - name: ESXI_ISO      value: <span class="token variable">$&#123;ESXI_ISO&#125;</span>    - name: SRC_ISO_DIR      value: <span class="token variable">$&#123;SRC_ISO_DIR&#125;</span>    - name: HTTP_DIR      value: <span class="token variable">$&#123;DEST_ISO_DIR&#125;</span>    - name: HTTP_URL      value: http://<span class="token variable">$&#123;HTTP_SERVER&#125;</span>/iso/redfish  - name: jnlp    args: <span class="token punctuation">[</span><span class="token string">"\<span class="token variable"><span class="token variable">$(</span>JENKINS_SECRET<span class="token variable">)</span></span>"</span>, <span class="token string">"\<span class="token variable"><span class="token variable">$(</span>JENKINS_NAME<span class="token variable">)</span></span>"</span><span class="token punctuation">]</span>    image: <span class="token string">"jenkins/inbound-agent:4.11.2-4-alpine"</span>    imagePullPolicy: IfNotPresent  volumes:  - name: http-dir    nfs:      server: <span class="token variable">$&#123;HTTP_SERVER&#125;</span>      path: <span class="token variable">$&#123;HTTP_DIR&#125;</span><span class="token string">""</span>",<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    node<span class="token punctuation">(</span>POD_NAME<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        try <span class="token punctuation">&#123;</span>            container<span class="token punctuation">(</span><span class="token string">"runner"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                writeFile file: <span class="token string">'config.yaml'</span>, text: <span class="token string">"<span class="token variable">$&#123;CONFIG_YAML&#125;</span>"</span>                stage<span class="token punctuation">(</span><span class="token string">"Inventory"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">sh</span> <span class="token string">""</span>"                    <span class="token function">cp</span> -rf /ansible/* <span class="token builtin class-name">.</span>                    <span class="token function">make</span> inventory                    <span class="token string">""</span>"                <span class="token punctuation">&#125;</span>                stage<span class="token punctuation">(</span><span class="token string">"Precheck"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">sh</span> <span class="token string">""</span>"                    <span class="token function">make</span> pre-check                    <span class="token string">""</span>"                <span class="token punctuation">&#125;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>params.build_iso<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    stage<span class="token punctuation">(</span><span class="token string">"Build-iso"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token function">sh</span> <span class="token string">""</span>"                        <span class="token function">make</span> build-iso                        <span class="token string">""</span>"                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>                stage<span class="token punctuation">(</span><span class="token string">"Mount-iso"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">sh</span> <span class="token string">""</span>"                    <span class="token function">make</span> mount-iso                    <span class="token string">""</span>"                <span class="token punctuation">&#125;</span>                stage<span class="token punctuation">(</span><span class="token string">"Reboot"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">sh</span> <span class="token string">""</span>"                    <span class="token function">make</span> <span class="token function">reboot</span>                    <span class="token function">sleep</span> <span class="token number">60</span>                    <span class="token string">""</span>"                <span class="token punctuation">&#125;</span>                stage<span class="token punctuation">(</span><span class="token string">"Postcheck"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                    <span class="token function">sh</span> <span class="token string">""</span>"                    <span class="token function">make</span> post-check                    <span class="token string">""</span>"                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            stage<span class="token punctuation">(</span><span class="token string">"Success"</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                MESSAGE <span class="token operator">=</span> <span class="token string">"ã€Succeedã€‘Jenkins Job <span class="token variable">$&#123;JOB_NAME&#125;</span>-<span class="token variable">$&#123;BUILD_NUMBER&#125;</span> Link: <span class="token variable">$&#123;BUILD_URL&#125;</span>"</span>                // slackSend<span class="token punctuation">(</span>channel: <span class="token string">'$&#123;SLACK_CHANNE&#125;'</span>, color: <span class="token string">'good'</span>, message: <span class="token string">"<span class="token variable">$&#123;MESSAGE&#125;</span>"</span><span class="token punctuation">)</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span> catch <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            MESSAGE <span class="token operator">=</span> <span class="token string">"ã€Failedã€‘Jenkins Job <span class="token variable">$&#123;JOB_NAME&#125;</span>-<span class="token variable">$&#123;BUILD_NUMBER&#125;</span> Link: <span class="token variable">$&#123;BUILD_URL&#125;</span>"</span>            // slackSend<span class="token punctuation">(</span>channel: <span class="token string">'$&#123;SLACK_CHANNE&#125;'</span>, color: <span class="token string">'warning'</span>, message: <span class="token string">"<span class="token variable">$&#123;MESSAGE&#125;</span>"</span><span class="token punctuation">)</span>            throw e        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ–è€…å‚è€ƒ <a href="https://stackoverflow.com/questions/8424228/export-import-jobs-in-jenkins">Export&#x2F;import jobs in Jenkins</a> å°†è¿™ä¸ª <a href="https://github.com/muzi502/redfish-esxi-os-installer/blob/master/jenkins/config.xml">Job</a> çš„é…ç½®å¯¼å…¥åˆ° Jenkins å½“ä¸­ï¼Œå¹¶è®¾ç½®å¥½ä¸Šé¢æåˆ°çš„å‡ ä¸ªå‚æ•°ã€‚</p><p><img data-src="https://p.k8s.li/2022-04-30-redfish-esxi-os-installer-07.png" alt="image-20220429201859704"></p><h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><h3 id="ç¡¬ä»¶ä¿¡æ¯æ”¶é›†"><a href="#ç¡¬ä»¶ä¿¡æ¯æ”¶é›†" class="headerlink" title="ç¡¬ä»¶ä¿¡æ¯æ”¶é›†"></a>ç¡¬ä»¶ä¿¡æ¯æ”¶é›†</h3><p>æ•´ä½“ä¸Šè¯¥æ–¹æ¡ˆæœ‰ä¸€ç‚¹ä¸è¶³çš„å°±æ˜¯éœ€è¦äººä¸ºåœ°ç¡®è®¤ ESXi OS å®‰è£…ç¡¬ç›˜çš„å‹å·&#x2F;åºåˆ—å·ï¼Œä»¥åŠ ESXi ç®¡ç†ç½‘ç»œæ‰€ä½¿ç”¨çš„ç‰©ç†ç½‘å¡ã€‚å…¶å®æ˜¯å¯ä»¥é€šè¿‡ redfish çš„ API æ¥ç»Ÿä¸€åœ°è·å–ï¼Œç„¶åå†æ ¹æ®è¿™äº›ç¡¬ä»¶è®¾å¤‡ä¿¡æ¯è¿›è¡Œé€‰æ‹©ï¼Œè¿™æ ·å°±ä¸ç”¨ç™»å½•åˆ°æ¯ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šè¿›è¡ŒæŸ¥çœ‹äº†ã€‚</p><p>ä½†è€ƒè™‘åˆ°å®ç°æˆæœ¬ï¼Œå·¥ä½œé‡ä¼šç¿»å€ï¼Œè€Œä¸”æˆ‘ä»¬çš„æœåŠ¡å™¨éƒ½æ˜¯å›ºå®šçš„ï¼Œåªè¦äººä¸ºç¡®è®¤ä¸€æ¬¡å°±å¯ä»¥ï¼Œä¸‹ä¸€æ¬¡é‡è£… ESXi OS çš„æ—¶å€™åªéœ€è¦å¤åˆ¶ç²˜è´´ä¸Šä¸€æ¬¡çš„ç¡¬ä»¶é…ç½®å³å¯ï¼Œæ‰€ä»¥ç›®å‰å¹¶æ²¡æœ‰æ‰“ç®—åšè·å–ç¡¬ä»¶ä¿¡æ¯çš„åŠŸèƒ½ã€‚</p><p>è€Œä¸”å³ä¾¿æ˜¯å°†ç¡¬ä»¶ä¿¡æ¯è·å–å‡ºæ¥ï¼Œå¦‚æœæ²¡æœ‰ä¸€ä¸ªå¯è§†åŒ–çš„ Web UI å±•ç¤ºè¿™äº›è®¾å¤‡ä¿¡æ¯ï¼Œä¹Ÿå¾ˆéš¾ä»ä¸€å †ç¡¬ä»¶æ•°æ®ä¸­æ‰¾å‡ºç‰¹å®šçš„è®¾å¤‡ï¼Œå¯¹è¿™äº›æ•°æ®è¿›è¡Œ UI å±•ç¤ºå·¥ä½œé‡ä¹Ÿä¼šç¿»å€ï¼Œå› æ­¤æš‚æ—¶ä¸å†è€ƒè™‘è¿™ä¸ªåŠŸèƒ½äº†ã€‚</p><h3 id="æŒ‚è½½-ISO-ä¹‹å‰å…ˆç¡®ä¿-ISO-å­˜åœ¨"><a href="#æŒ‚è½½-ISO-ä¹‹å‰å…ˆç¡®ä¿-ISO-å­˜åœ¨" class="headerlink" title="æŒ‚è½½ ISO ä¹‹å‰å…ˆç¡®ä¿ ISO å­˜åœ¨"></a>æŒ‚è½½ ISO ä¹‹å‰å…ˆç¡®ä¿ ISO å­˜åœ¨</h3><p>æœ‰äº›æœåŠ¡å™¨æ¯”å¦‚ HPE åœ¨æŒ‚è½½ä¸€ä¸ªä¸å­˜åœ¨çš„ ISO æ—¶å¹¶ä¸ä¼šæŠ¥é”™ï¼Œå½“æ—¶æˆ‘æ’æŸ¥äº†å¥½ä¹…æ‰å‘ç° ğŸ˜‚ï¼Œæˆ‘ä¸€ç›´ä»¥ä¸ºæ˜¯å¯åŠ¨é¡¹è®¾ç½®çš„é—®é¢˜ã€‚å› æ­¤åœ¨æŒ‚è½½ ISO ä¹‹å‰æˆ‘ä»¬å¯ä»¥é€šè¿‡ curl çš„æ–¹å¼æ£€æŸ¥ä¸€ä¸‹ ISO çš„ URL æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœ 404 ä¸å­˜åœ¨çš„è¯å°±æŠ¥é”™é€€å‡ºã€‚</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all  <span class="token key atrule">name</span><span class="token punctuation">:</span> Mount  <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> image_url <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Check <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> image_url <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO file exists    <span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">"curl -sI &#123;&#123; image_url &#125;&#125;"</span>    <span class="token key atrule">register</span><span class="token punctuation">:</span> response    <span class="token key atrule">failed_when</span><span class="token punctuation">:</span> <span class="token string">"'200 OK' not in response.stdout or '404 Not Found' in response.stdout"</span>    <span class="token key atrule">tags</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å•ç‹¬æ„å»º-Kickstart-ISO"><a href="#å•ç‹¬æ„å»º-Kickstart-ISO" class="headerlink" title="å•ç‹¬æ„å»º Kickstart ISO"></a>å•ç‹¬æ„å»º Kickstart ISO</h3><p>ç›®å‰çš„æ–¹æ¡ˆæ˜¯ä¸ºå°† ESXi çš„ kickstart æ–‡ä»¶ KS.CFG æ”¾åˆ°äº† ESXi OS ISO é•œåƒé‡Œï¼Œç”±äºæ¯å°ä¸»æœºçš„ kickstart æ–‡ä»¶éƒ½ä¸ç›¸åŒï¼Œè¿™å°±éœ€è¦ä¸ºæ¯å°æœåŠ¡å™¨æ„å»ºä¸€ä¸ª ISO æ–‡ä»¶ï¼Œå¦‚æœæœºå™¨æ•°é‡æ¯”è¾ƒå¤šçš„è¯ï¼Œå¯èƒ½ä¼šå ç”¨å¤§é‡çš„ç£ç›˜å­˜å‚¨ç©ºé—´ï¼Œæ•ˆç‡ä¸Šä¼šæœ‰äº›é—®é¢˜ã€‚ä¹Ÿå°è¯•è¿‡å°† kickstart æ–‡ä»¶å•ç‹¬æ”¾åˆ°ä¸€ä¸ª ISO ä¸­ï¼Œå¤§ä½“çš„æ€è·¯å¦‚ä¸‹ï¼š</p><ul><li>æ„å»º kickstart ISO æ–‡ä»¶ï¼Œ-V å‚æ•°æŒ‡å®š ISO çš„ label åç§°ä¸º KS</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ genisoimage -o /tmp/ks.iso -V KS ks.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>ä¿®æ”¹ ESXi å¯åŠ¨é…ç½®ï¼Œå°† ks æ–‡ä»¶è·¯å¾„é€šè¿‡ label çš„æ–¹å¼æŒ‡å‘åˆšæ‰æ„å»ºçš„ ISO</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">sed</span> -i -e <span class="token string">'s#cdromBoot#ks=hd:KS:/ks.cfg systemMediaSize=small#g'</span> boot.cfg$ <span class="token function">sed</span> -i -e <span class="token string">'s#cdromBoot#ks=hd:KS:/ks.cfg systemMediaSize=small#g'</span> efi/boot/boot.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>ä¿®æ”¹ä¸€ä¸‹ playbookï¼Œæ’å…¥ä¸¤ä¸ª ISO</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Insert <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO as virtual media device  <span class="token key atrule">community.general.redfish_command</span><span class="token punctuation">:</span>    <span class="token key atrule">baseuri</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; baseuri &#125;&#125;"</span>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; username &#125;&#125;"</span>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; password &#125;&#125;"</span>    <span class="token key atrule">category</span><span class="token punctuation">:</span> <span class="token string">"Manager"</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"VirtualMediaInsert"</span>    <span class="token key atrule">virtual_media</span><span class="token punctuation">:</span>      <span class="token key atrule">image_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; item &#125;&#125;"</span>      <span class="token key atrule">media_types</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> CD        <span class="token punctuation">-</span> DVD  <span class="token key atrule">with_items</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token string">"&#123;&#123; esxi_iso_url &#125;&#125;"</span>  <span class="token punctuation">-</span> <span class="token string">"&#123;&#123; ks_iso_url &#125;&#125;"</span>  <span class="token key atrule">when</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> inventory_hostname not in groups<span class="token punctuation">[</span><span class="token string">'lenovo'</span><span class="token punctuation">]</span>  <span class="token key atrule">tags</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> mount<span class="token punctuation">-</span>iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç­‰è¿™äº›éƒ½ä¿®æ”¹å¥½ä¹‹åæˆ‘æ»¡æ€€æœŸå¾…åœ°è¿è¡Œäº† make mount-iso å‘½ä»¤ç­‰åˆ°å¥‡è¿¹çš„å‘ç”Ÿï¼Œæ²¡æƒ³åˆ°ç›´æ¥ç¿»è½¦äº†ï¼ä¸æ”¯æŒæŒ‚è½½ä¸¤ä¸ª ISOï¼Œç™½ç™½é«˜å…´ä¸€åœºï¼ŒçœŸæ°”äºº ğŸ˜¡</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">TASK <span class="token punctuation">[</span>Insert <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> item <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span> ISO as virtual media device<span class="token punctuation">]</span> <span class="token important">******************************************************************************************</span><span class="token key atrule">changed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.191<span class="token punctuation">]</span> =<span class="token punctuation">></span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/VMware<span class="token punctuation">-</span>VMvisor<span class="token punctuation">-</span>Installer<span class="token punctuation">-</span>7.0U3d<span class="token punctuation">-</span>19482537.x86_64.iso)<span class="token key atrule">changed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.192<span class="token punctuation">]</span> =<span class="token punctuation">></span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/VMware<span class="token punctuation">-</span>VMvisor<span class="token punctuation">-</span>Installer<span class="token punctuation">-</span>7.0U3d<span class="token punctuation">-</span>19482537.x86_64.iso)<span class="token key atrule">changed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.193<span class="token punctuation">]</span> =<span class="token punctuation">></span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/VMware<span class="token punctuation">-</span>VMvisor<span class="token punctuation">-</span>Installer<span class="token punctuation">-</span>7.0U3d<span class="token punctuation">-</span>19482537.x86_64.iso)<span class="token key atrule">failed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.193<span class="token punctuation">]</span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/10.172.18.193/ks.iso) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span><span class="token key atrule">"ansible_loop_var"</span><span class="token punctuation">:</span> <span class="token string">"item"</span><span class="token punctuation">,</span> <span class="token key atrule">"changed"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">"item"</span><span class="token punctuation">:</span> <span class="token string">"http://10.172.29.171/iso/redfish/10.172.18.193/ks.iso"</span><span class="token punctuation">,</span> <span class="token key atrule">"msg"</span><span class="token punctuation">:</span> <span class="token string">"Unable to find an available VirtualMedia resource supporting ['CD', 'DVD']"</span><span class="token punctuation">&#125;</span><span class="token key atrule">failed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.192<span class="token punctuation">]</span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/10.172.18.192/ks.iso) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span><span class="token key atrule">"ansible_loop_var"</span><span class="token punctuation">:</span> <span class="token string">"item"</span><span class="token punctuation">,</span> <span class="token key atrule">"changed"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">"item"</span><span class="token punctuation">:</span> <span class="token string">"http://10.172.29.171/iso/redfish/10.172.18.192/ks.iso"</span><span class="token punctuation">,</span> <span class="token key atrule">"msg"</span><span class="token punctuation">:</span> <span class="token string">"Unable to find an available VirtualMedia resource supporting ['CD', 'DVD']"</span><span class="token punctuation">&#125;</span><span class="token key atrule">failed</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>10.172.18.191<span class="token punctuation">]</span> (item=http<span class="token punctuation">:</span>//10.172.29.171/iso/redfish/10.172.18.191/ks.iso) =<span class="token punctuation">></span> <span class="token punctuation">&#123;</span><span class="token key atrule">"ansible_loop_var"</span><span class="token punctuation">:</span> <span class="token string">"item"</span><span class="token punctuation">,</span> <span class="token key atrule">"changed"</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">"item"</span><span class="token punctuation">:</span> <span class="token string">"http://10.172.29.171/iso/redfish/10.172.18.191/ks.iso"</span><span class="token punctuation">,</span> <span class="token key atrule">"msg"</span><span class="token punctuation">:</span> <span class="token string">"Unable to find an available VirtualMedia resource supporting ['CD', 'DVD']"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ–è®¸å°† ISO æ›¿æ¢æˆè½¯ç›˜  floppy  çš„æ–¹å¼å¯èƒ½è¡Œå¾—é€šï¼Œä¸è¿‡å½“æˆ‘çœ‹äº† <a href="https://stackoverflow.com/questions/11202706/create-a-virtual-floppy-image-without-mount">create-a-virtual-floppy-image-without-mount</a> åç›´æ¥æŠŠæˆ‘æ•´ä¸ä¼šäº†ï¼Œæ²¡æƒ³åˆ›å»ºä¸€ä¸ªè½¯ç›˜æ–‡ä»¶åˆ°è¿™ä¹ˆéº»çƒ¦ï¼Œè¿˜æ˜¯ç›´æ¥æ”¾å¼ƒè¯¥æ–¹æ¡ˆå§ ğŸŒšã€‚</p><p>å¤šè¯´ä¸€å¥ï¼Œä¹‹æ‰€ä»¥æƒ³åˆ°ä½¿ç”¨è½¯ç›˜çš„æ–¹å¼æ˜¯å› ä¸ºä¹‹å‰åœ¨ç© <a href="https://github.com/hashicorp/packer">Packer</a> çš„æ—¶å€™ï¼Œç ”ç©¶è¿‡å®ƒå°±æ˜¯å°† kickstart æ–‡ä»¶åˆ¶ä½œæˆä¸€ä¸ªè½¯ç›˜ï¼Œæ’å…¥åˆ°è™šæ‹Ÿæœºä¸­ã€‚è™šæ‹Ÿæœºå¼€æœºåé€šè¿‡ vCenter API å‘é€é”®ç›˜è¾“å…¥ï¼Œæ’å…¥ kickstart çš„è·¯å¾„ï¼Œanaconda æ‰§è¡Œè‡ªåŠ¨åŒ–å®‰è£… OSã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating VM<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Customizing hardware<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Mounting ISO images<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding configuration parameters<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating floppy disk<span class="token punctuation">..</span>.    vsphere-iso-base: Copying files flatly from floppy_files    vsphere-iso-base: Done copying files from floppy_files    vsphere-iso-base: Collecting paths from floppy_dirs    vsphere-iso-base: Resulting paths from floppy_dirs <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>./kickstart/centos/http/<span class="token punctuation">]</span>    vsphere-iso-base: Recursively copying <span class="token builtin class-name">:</span> ./kickstart/centos/http/    vsphere-iso-base: Done copying paths from floppy_dirs    vsphere-iso-base: Copying files from floppy_content    vsphere-iso-base: Done copying files from floppy_content<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Uploading created floppy image<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding generated Floppy<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Set boot order temporary<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Power on VM<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting 15s <span class="token keyword">for</span> boot<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Typing boot command<span class="token punctuation">..</span>.<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting <span class="token keyword">for</span> IP<span class="token punctuation">..</span>.root@devbox-fedora:/root <span class="token comment"># scp 192.168.24.43:/vmfs/volumes/Packer/base-os-centos7/packer-tmp-created-floppy.flp .</span>packer-tmp-created-floppy.flp                                                                                <span class="token number">100</span>% 1440KB  <span class="token number">89</span>.4MB/s   00:00root@devbox-fedora:/root <span class="token comment"># mount packer-tmp-created-floppy.flp /mnt</span>root@devbox-fedora:/root <span class="token comment"># readlink /dev/disk/by-label/packer</span><span class="token punctuation">..</span>/<span class="token punctuation">..</span>/loop2root@devbox-fedora:/root <span class="token comment"># df -h /mnt</span>Filesystem      Size  Used Avail Use% Mounted on/dev/loop2      <span class="token number">1</span>.4M   16K  <span class="token number">1</span>.4M   <span class="token number">2</span>% /mntroot@devbox-fedora:/root <span class="token comment">#</span>root@devbox-fedora:/root <span class="token comment"># ls /mnt</span>HTTProot@devbox-fedora:/root <span class="token comment"># ls /mnt/HTTP</span><span class="token number">7</span>root@devbox-fedora:/root <span class="token comment"># ls /mnt/HTTP/7</span>KS.CFG<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é€šè¿‡-http-æ–¹å¼è¯»å–-kickstart"><a href="#é€šè¿‡-http-æ–¹å¼è¯»å–-kickstart" class="headerlink" title="é€šè¿‡ http æ–¹å¼è¯»å– kickstart"></a>é€šè¿‡ http æ–¹å¼è¯»å– kickstart</h3><p>ä¸ä¸€å®šå¯è¡Œï¼Œåœ¨é€šè¿‡ http æ–¹å¼è¯»å– kickstart æ–‡ä»¶ä¹‹å‰ï¼ŒESXi OS installer éœ€è¦æœ‰ä¸€ä¸ª IP åœ°å€æ‰è¡Œã€‚å¦‚æœæœåŠ¡å™¨å¦‚æœæœ‰å¤šå—ç½‘å¡çš„è¯ï¼Œå°±å¾ˆéš¾ç¡®å®šæ˜¯å¦åˆ†é…åˆ°ä¸€ä¸ª IPï¼Œä½¿ç”¨é»˜è®¤ DHCP çš„æ–¹å¼å¹¶ä¸ä¸€å®šèƒ½è·å–åˆ°æ­£ç¡®çš„ IP åœ°å€ã€‚å› æ­¤è¯»å– kickstart æ–‡ä»¶çš„æ–¹å¼è¿˜æ˜¯å»ºè®®ä½¿ç”¨ ISO çš„æ–¹å¼ï¼Œè¿™æ ·åœ¨å®‰è£… OS æ—¶å¯¹ç½‘ç»œç¯å¢ƒæ— ä¾èµ–ï¼Œæ›´ç¨³å®šä¸€äº›ã€‚</p><h3 id="æ”¯æŒå…¶ä»–-OS-çš„å®‰è£…"><a href="#æ”¯æŒå…¶ä»–-OS-çš„å®‰è£…" class="headerlink" title="æ”¯æŒå…¶ä»– OS çš„å®‰è£…"></a>æ”¯æŒå…¶ä»– OS çš„å®‰è£…</h3><p>ç›®å‰è¯¥æ–¹æ¡ˆåªæ”¯æŒ ESXi OS çš„å®‰è£…ï¼Œå…¶ä»– OS çš„è‡ªåŠ¨åŒ–å®‰è£…å…¶å®åŸç†æ˜¯ä¸€æ ·çš„ã€‚æ¯”å¦‚ CentOS åŒæ ·ä¹Ÿæ˜¯ä¿®æ”¹ kickstart æ–‡ä»¶ã€‚å¦‚æœè¦æŒ‡å®š OS æ‰€å®‰è£…çš„ç£ç›˜å¯ä»¥å‚è€ƒä¸€ä¸‹æˆ´å°”å®˜æ–¹çš„ä¸€ç¯‡æ–‡æ¡£ <a href="https://www.dell.com/support/kbdoc/zh-hk/000177584/automating-operating-system-deployment-to-dell-boss-techniques-for-different-operating-systems">Automating Operating System Deployment to Dell BOSS â€“ Techniques for Different Operating Systems</a> ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">%include /tmp/bootdisk.cfg%pre<span class="token comment"># Use DELLBOSS device for OS install if present.</span><span class="token assign-left variable">BOSS_DEV</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">find</span> /dev -name <span class="token string">"*DELLBOSS*"</span> -printf %P<span class="token string">"<span class="token entity" title="\n">\n</span>"</span> <span class="token operator">|</span> <span class="token function">egrep</span> -v -e part -e scsi<span class="token operator">|</span> <span class="token function">head</span> -1<span class="token variable">)</span></span><span class="token keyword">if</span> <span class="token punctuation">[</span> -n <span class="token string">"<span class="token variable">$BOSS_DEV</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token builtin class-name">echo</span> ignoredisk --only-use<span class="token operator">=</span><span class="token string">"<span class="token variable">$BOSS_DEV</span>"</span> <span class="token operator">></span> /tmp/bootdisk.cfg<span class="token keyword">fi</span>%end<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœè¦ä¸ºæŸå—ç‰©ç†ç½‘å¡é…ç½® IP åœ°å€ï¼Œå¯ä»¥æ ¹æ® MAC åœ°å€æ‰¾åˆ°å¯¹åº”çš„ç‰©ç†ç½‘å¡ï¼Œç„¶åå°†é™æ€ IP é…ç½®å†™å…¥åˆ°ç½‘å¡é…ç½®æ–‡ä»¶å½“ä¸­ã€‚æ¯”å¦‚ CentOS åœ¨ kickstart ä¸­ä¸ºæŸå—ç‰©ç†ç½‘å¡é…ç½®é™æ€ IPï¼Œå¯ä»¥é‡‡ç”¨å¦‚ä¸‹æ–¹å¼ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">MAC_ADDRESS åœ¨ç”Ÿæˆ kickstart æ–‡ä»¶çš„æ—¶å€™æ ¹æ® config.yaml åŠ¨æ€ä¿®æ”¹çš„<span class="token comment"># MAC_ADDRESS=B4:96:91:A7:3F:D6</span><span class="token comment"># æ ¹æ® MAC åœ°å€è·å–åˆ°ç½‘å¡è®¾å¤‡çš„åç§°</span><span class="token assign-left variable">NIC</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> -l $<span class="token punctuation">&#123;</span>MAC_ADDRESS<span class="token punctuation">&#125;</span> /sys/class/net/*/address <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">'/'</span> <span class="token string">'&#123;print $5&#125;'</span><span class="token variable">)</span></span><span class="token comment"># å°†ç½‘å¡é™æ€ IP é…ç½®å†™å…¥åˆ°æ–‡ä»¶å½“ä¸­</span><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">></span> /etc/sysconfig/network-scripts/ifcfg-<span class="token variable">$&#123;NIC&#125;</span></span>TYPE=EhternetBOOTPROTO=staticDEFROUTE=yesNAME=<span class="token variable">$&#123;NIC&#125;</span>DEVICE=<span class="token variable">$&#123;NIC&#125;</span>ONBOOT=yesIPADDR=<span class="token variable">$&#123;IP&#125;</span>NETMASK=<span class="token variable">$&#123;NETMASK&#125;</span>GATEWAY=<span class="token variable">$&#123;GATEWAY&#125;</span>EOF</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç”±äºæ—¶é—´å…³ç³»ï¼Œåœ¨è¿™é‡Œå°±ä¸å†è¿›è¡Œæ·±å…¥è®²è§£äº†ï¼Œåœ¨è¿™é‡Œåªæ˜¯æä¾›ä¸€ä¸ªæ–¹æ³•å’Œæ€è·¯ã€‚è‡³äº Debian&#x2F;Ubuntu å‘è¡Œç‰ˆï¼Œè¿˜æ˜¯ä½ ä»¬è‡ªå·±æ‘¸ç´¢å§ï¼Œå› ä¸ºæˆ‘å·¥ä½œä¸­ç¡®å®æ²¡æœ‰åœ¨ç‰©ç†æœåŠ¡å™¨ä¸Šå®‰è£…è¿™äº›å‘è¡Œç‰ˆçš„åœºæ™¯ï¼Œæ¯•ç«Ÿå›½å†…ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒä¸­ä½¿ç”¨ CentOS&#x2F;RedHat ç³»åˆ—å‘è¡Œç‰ˆçš„å ç»å¤§å¤šæ•°ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><h3 id="Redfish-ç›¸å…³"><a href="#Redfish-ç›¸å…³" class="headerlink" title="Redfish ç›¸å…³"></a>Redfish ç›¸å…³</h3><ul><li><a href="https://www.dmtf.org/standards/redfish">DMTFâ€™s Redfish</a></li><li><a href="https://www.dmtf.org/sites/default/files/DSP2044%20Redfish%20%E7%99%BD%E7%9A%AE%E4%B9%A6%201.0.0.pdf">Redfish ç™½çš®ä¹¦</a></li><li><a href="https://wsgzao.github.io/post/redfish/">Redfish ä¸‹ä¸€ä»£æ•°æ®ä¸­å¿ƒç®¡ç†æ ‡å‡†è¯¦è§£å’Œå®è·µ</a></li><li><a href="https://github.com/dell/redfish-ansible-module">redfish-ansible-module</a></li><li><a href="https://github.com/lenovo/python-redfish-lenovo">python-redfish-lenovo</a></li><li><a href="https://docs.ansible.com/ansible/latest/collections/community/general/xcc_redfish_command_module.html">xcc_redfish_command module</a></li><li><a href="https://sysmgt.lenovofiles.com/help/index.jsp?topic=/com.lenovo.systems.management.xcc.doc/rest_api.html">Lenovo XClarity Controller Redfish REST API</a></li><li><a href="https://docs.vmware.com/en/VMware-vSphere/7.0/com.vmware.esxi.upgrade.doc/GUID-61A14EBB-5CF3-43EE-87EF-DB8EC6D83698.html">Installation and Upgrade Script Commands</a></li><li><a href="https://www.hpe.com/psnow/doc/4AA6-1727ENW">Redfish API implementation on HPE servers with iLO RESTful API technical white paper</a></li><li><a href="https://github.com/ansible-collections/community.general/issues/3042">VirtualMediaEject should not require image_url </a></li></ul><h3 id="VMware-ESXi-ç›¸å…³"><a href="#VMware-ESXi-ç›¸å…³" class="headerlink" title="VMware ESXi ç›¸å…³"></a>VMware ESXi ç›¸å…³</h3><ul><li><a href="https://communities.vmware.com/t5/ESXi-Discussions/Reducing-Esxi-7-VMFSL/td-p/2808955">Reducing Esxi 7 VMFSL</a></li><li><a href="https://kb.vmware.com/s/article/1014953">Identifying disks when working with VMware ESXi (1014953)</a></li><li><a href="https://downloads.dell.com/manuals/all-products/esuprt_solutions_int/esuprt_solutions_int_solutions_resources/servers-solution-resources_white-papers10_en-us.pdf">PowerEdge Boot Optimized Storage Solution BOSS - Dell</a></li><li><a href="https://www.reddit.com/r/vmware/comments/2a5jv7/esxi_kickstart_script_to_grep_for_correct_lun/">ESXi Kickstart script to grep for correct LUN? (iSCSI, Boot from SAN)</a></li><li><a href="https://www.dell.com/support/kbdoc/zh-hk/000177584/automating-operating-system-deployment-to-dell-boss-techniques-for-different-operating-systems">Automating Operating System Deployment to Dell BOSS â€“ Techniques for Different Operating Systems</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ä»å»å¹´åä¸€æœˆåº•åˆ°ç°åœ¨ä¸€ç›´åœ¨åšåœ¨  &lt;a
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="ESXi" scheme="https://blog.k8s.li/tags/ESXi/"/>
    
      <category term="Redfish" scheme="https://blog.k8s.li/tags/Redfish/"/>
    
      <category term="Dell æœåŠ¡å™¨" scheme="https://blog.k8s.li/tags/Dell-%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
      <category term="HPE æœåŠ¡å™¨" scheme="https://blog.k8s.li/tags/HPE-%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
      <category term="Lenovo æœåŠ¡å™¨" scheme="https://blog.k8s.li/tags/Lenovo-%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
      <category term="è£¸é‡‘å±æœåŠ¡å™¨" scheme="https://blog.k8s.li/tags/%E8%A3%B8%E9%87%91%E5%B1%9E%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
  </entry>
  
  <entry>
    <title>æ¬ç –å·¥å…· govc ä½¿ç”¨è®°å½•</title>
    <link href="https://blog.k8s.li/govc-usage.html"/>
    <id>https://blog.k8s.li/govc-usage.html</id>
    <published>2022-03-30T16:00:00.000Z</published>
    <updated>2022-03-30T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ç”±äºå·¥ä½œåŸå› éœ€è¦åœ¨ ESXi ä¸»æœºä¸Šå®Œæˆä¸€äº›å‚æ•°é…ç½®ã€è™šæ‹Ÿäº¤æ¢æœº&#x2F;ç½‘åˆ›å»ºã€è™šæ‹Ÿæœºåˆ›å»ºã€VIB å®‰è£…ã€PCI ç›´é€šã€è™šæ‹Ÿæœºåˆ›å»ºç­‰å·¥ä½œï¼Œäºæ˜¯æŠ½ç©ºæ•´ç†äº†ä¸€ä¸‹åœ¨ä½¿ç”¨ govc æ—¶è¸©çš„ä¸€äº›å‘ã€‚</p><h2 id="govc"><a href="#govc" class="headerlink" title="govc"></a>govc</h2><p><a href="https://github.com/vmware/govmomi/tree/master/govc">govc</a> æ˜¯ VMware å®˜æ–¹ <a href="https://github.com/vmware/govmom">govmomi</a> åº“çš„ä¸€ä¸ªå°è£…å®ç°ã€‚ä½¿ç”¨å®ƒå¯ä»¥å®Œæˆå¯¹ ESXi ä¸»æœºæˆ– vCenter çš„ä¸€äº›æ“ä½œã€‚æ¯”å¦‚åˆ›å»ºè™šæ‹Ÿæœºã€ç®¡ç†å¿«ç…§ç­‰ã€‚åŸºæœ¬ä¸Šèƒ½åœ¨ ESXi æˆ– vCenter ä¸Šçš„æ“ä½œï¼Œåœ¨ govmomi ä¸­éƒ½æœ‰å¯¹åº”çš„å®ç°ã€‚ç›®å‰ govc æ”¯æŒçš„ ESXi &#x2F; vCenter ç‰ˆæœ¬æœ‰ 7.0, 6.7, 6.5 , 6.0 (5.x ç‰ˆæœ¬å¤ªè€äº†ï¼Œå¹²è„†æ”¾å¼ƒå§)ï¼Œå¦å¤–ä¹Ÿæ”¯æŒ VMware Workstation çš„æŸäº›ç‰ˆæœ¬ã€‚</p><p>ä½¿ç”¨ govc è¿æ¥ ESXi ä¸»æœºæˆ– vCenter å¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡æˆ–è€…å‘½ä»¤è¡Œå‚æ•°ï¼Œå»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œå¦‚æœé€šè¿‡å‘½ä»¤è¡Œ flag çš„è¯ï¼Œå°†æ˜æ–‡è§„å®šç”¨æˆ·åå’Œå¯†ç è¾“å‡ºæ¥æœ‰ä¸€å®šçš„å®‰å…¨é£é™©ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Options:  -cert<span class="token operator">=</span>                           Certificate <span class="token punctuation">[</span>GOVC_CERTIFICATE<span class="token punctuation">]</span>  -dc<span class="token operator">=</span>                             Datacenter <span class="token punctuation">[</span>GOVC_DATACENTER<span class="token punctuation">]</span>  -debug<span class="token operator">=</span>false                     Store debug logs <span class="token punctuation">[</span>GOVC_DEBUG<span class="token punctuation">]</span>  -dump<span class="token operator">=</span>false                      Enable Go output  -host<span class="token operator">=</span>                           Host system <span class="token punctuation">[</span>GOVC_HOST<span class="token punctuation">]</span>  -host.dns<span class="token operator">=</span>                       Find <span class="token function">host</span> by FQDN  -host.ip<span class="token operator">=</span>                        Find <span class="token function">host</span> by IP address  -host.ipath<span class="token operator">=</span>                     Find <span class="token function">host</span> by inventory path  -host.uuid<span class="token operator">=</span>                      Find <span class="token function">host</span> by UUID  -json<span class="token operator">=</span>false                      Enable JSON output  -k<span class="token operator">=</span>false                         Skip verification of server certificate <span class="token punctuation">[</span>GOVC_INSECURE<span class="token punctuation">]</span>  -key<span class="token operator">=</span>                            Private key <span class="token punctuation">[</span>GOVC_PRIVATE_KEY<span class="token punctuation">]</span>  -persist-session<span class="token operator">=</span>true            Persist session to disk <span class="token punctuation">[</span>GOVC_PERSIST_SESSION<span class="token punctuation">]</span>  -tls-ca-certs<span class="token operator">=</span>                   TLS CA certificates <span class="token function">file</span> <span class="token punctuation">[</span>GOVC_TLS_CA_CERTS<span class="token punctuation">]</span>  -tls-known-hosts<span class="token operator">=</span>                TLS known hosts <span class="token function">file</span> <span class="token punctuation">[</span>GOVC_TLS_KNOWN_HOSTS<span class="token punctuation">]</span>  -trace<span class="token operator">=</span>false                     Write SOAP/REST traffic to stderr  -u<span class="token operator">=</span>https://root@esxi.yoi.li/sdk  ESX or vCenter URL <span class="token punctuation">[</span>GOVC_URL<span class="token punctuation">]</span>  -verbose<span class="token operator">=</span>false                   Write request/response data to stderr  -vim-namespace<span class="token operator">=</span>vim25             Vim namespace <span class="token punctuation">[</span>GOVC_VIM_NAMESPACE<span class="token punctuation">]</span>  -vim-version<span class="token operator">=</span><span class="token number">7.0</span>                 Vim version <span class="token punctuation">[</span>GOVC_VIM_VERSION<span class="token punctuation">]</span>  -xml<span class="token operator">=</span>false                       Enable XML output<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ <code>GOVC_URL</code> ç¯å¢ƒå˜é‡æŒ‡å®š ESXi ä¸»æœºæˆ– vCenter çš„ URLï¼Œç™»å½•çš„ç”¨æˆ·åå’Œå¯†ç å¯è®¾ç½®åœ¨ GOVC_URL ä¸­æˆ–è€…å•ç‹¬è®¾ç½® <code>GOVC_USERNAME</code> å’Œ <code>GOVC_PASSWORD</code>ã€‚å¦‚æœ https è¯ä¹¦æ˜¯è‡ªç­¾çš„åŸŸåæˆ–è€… IP éœ€è¦é€šè¿‡è®¾ç½® <code>GOVC_INSECURE=true</code> å‚æ•°æ¥å…è®¸ä¸å®‰å…¨çš„ https è¿æ¥ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_URL</span><span class="token operator">=</span><span class="token string">"https://root:password@esxi.k8s.li"</span>$ <span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_INSECURE</span><span class="token operator">=</span>true$ govc aboutFullName:     VMware ESXi <span class="token number">7.0</span>.2 build-17867351Name:         VMware ESXiVendor:       VMware, Inc.Version:      <span class="token number">7.0</span>.2Build:        <span class="token number">17867351</span>OS type:      vmnix-x86API type:     HostAgentAPI version:  <span class="token number">7.0</span>.2.0Product ID:   embeddedEsxUUID:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœç”¨æˆ·åå’Œå¯†ç å½“ä¸­æœ‰ç‰¹æ®Šå­—ç¬¦æ¯”å¦‚ <code> \ @ /</code>ï¼Œå»ºè®®åˆ†åˆ«è®¾ç½® <code>GOVC_URL</code>ã€<code>GOVC_USERNAME</code> å’Œ <code>GOVC_PASSWORD</code> è¿™æ ·èƒ½é¿å…ç‰¹æ®Šå­—ç¬¦åœ¨ <code>GOVC_URL</code> å‡ºç°ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ã€‚</p><h2 id="è·å–ä¸»æœºä¿¡æ¯"><a href="#è·å–ä¸»æœºä¿¡æ¯" class="headerlink" title="è·å–ä¸»æœºä¿¡æ¯"></a>è·å–ä¸»æœºä¿¡æ¯</h2><h3 id="govc-host-info"><a href="#govc-host-info" class="headerlink" title="govc host.info"></a><code>govc host.info</code></h3><p>é€šè¿‡ host.info è‡ªå‘½å‘½ä»¤å¯ä»¥å¾—åˆ° ESXi ä¸»æœºçš„åŸºæœ¬ä¿¡æ¯ï¼Œ</p><ul><li>Path: å½“å‰ä¸»æœºåœ¨é›†ç¾¤ä¸­çš„èµ„æºè·¯å¾„</li><li>Manufacturer: ç¡¬ä»¶è®¾å¤‡åˆ¶é€ å•†</li><li>Logical CPUs: é€»è¾‘ CPU çš„æ•°é‡ï¼Œä»¥åŠ CPU çš„åŸºç¡€é¢‘ç‡</li><li>Processor type: CPU çš„å…·ä½“å‹å·ï¼Œç”±äºæˆ‘çš„æ˜¯ ES ç‰ˆçš„ E-2126Gï¼Œæ‰€ä»¥æ— æ³•æ˜¾ç¤ºå‡ºå…·ä½“çš„å‹å· ğŸ¤£</li><li>CPU usage:  CPU ä½¿ç”¨çš„è´Ÿè½½æƒ…å†µ</li><li>Memory:  ä¸»æœºå®‰è£…çš„å†…å­˜å¤§å°</li><li>Memory usage:  å†…å­˜ä½¿ç”¨çš„è´Ÿè½½æƒ…å†µ</li><li>Boot time: å¼€æœºæ—¶é—´</li><li>State:  è¿æ¥çŠ¶æ€</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ govc host.infoName:              hp-esxi.lan  Path:            /ha-datacenter/host/hp-esxi.lan/hp-esxi.lan  Manufacturer:    HPE  Logical CPUs:    <span class="token number">6</span> CPUs @ 3000MHz  Processor type:  Genuine Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> CPU 0000 @ <span class="token number">3</span>.00GHz  CPU usage:       <span class="token number">3444</span> MHz <span class="token punctuation">(</span><span class="token number">19.1</span>%<span class="token punctuation">)</span>  Memory:          32613MB  Memory usage:    <span class="token number">26745</span> MB <span class="token punctuation">(</span><span class="token number">82.0</span>%<span class="token punctuation">)</span>  Boot time:       <span class="token number">2021</span>-12-05 06:11:53.42802 +0000 UTC  State:           connected<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœåŠ ä¸Š -json å‚æ•°ä¼šå¾—åˆ°ä¸€ä¸ªè‡³å°‘ 3w è¡Œçš„ json è¾“å‡ºï¼Œé‡Œé¢åŒ…å«çš„ ESXi ä¸»æœºçš„æ‰€æœ‰ä¿¡æ¯ï¼Œç„¶åå¯ä»¥ä½¿ç”¨ jq å‘½ä»¤å»è¿‡æ»¤å‡ºä¸€äº›è‡ªå·±æ‰€éœ€è¦çš„å‚æ•°ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox ~â•°â”€<span class="token comment"># govc host.info -json=true > host_info.json</span>â•­â”€root@esxi-debian-devbox ~â•°â”€<span class="token comment"># wc host_info.json</span>  <span class="token number">34522</span>   <span class="token number">73430</span> <span class="token number">1188718</span> host_info.jsonâ•­â”€root@esxi-debian-devbox ~â•°â”€<span class="token comment"># govc host.info -json | jq '.HostSystems[0].Summary.Hardware'</span><span class="token punctuation">&#123;</span>  <span class="token string">"Vendor"</span><span class="token builtin class-name">:</span> <span class="token string">"HPE"</span>,  <span class="token string">"Model"</span><span class="token builtin class-name">:</span> <span class="token string">"ProLiant MicroServer Gen10 Plus"</span>,  <span class="token string">"Uuid"</span><span class="token builtin class-name">:</span> <span class="token string">"30363150"</span>,  <span class="token string">"MemorySize"</span><span class="token builtin class-name">:</span> <span class="token number">34197471232</span>,  <span class="token string">"CpuModel"</span><span class="token builtin class-name">:</span> <span class="token string">"Genuine Intel(R) CPU 0000 @ 3.00GHz"</span>,  <span class="token string">"CpuMhz"</span><span class="token builtin class-name">:</span> <span class="token number">3000</span>,  <span class="token string">"NumCpuPkgs"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,  <span class="token string">"NumCpuCores"</span><span class="token builtin class-name">:</span> <span class="token number">6</span>,  <span class="token string">"NumCpuThreads"</span><span class="token builtin class-name">:</span> <span class="token number">6</span>,  <span class="token string">"NumNics"</span><span class="token builtin class-name">:</span> <span class="token number">4</span>,  <span class="token string">"NumHBAs"</span><span class="token builtin class-name">:</span> <span class="token number">3</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœåŠ ä¸Š -dump å‚æ•°ï¼Œåˆ™ä¼šä»¥ Golang ç»“æ„ä½“çš„æ ¼å¼æ¥è¾“å‡ºï¼Œè¾“å‡ºçš„å†…å®¹ä¹Ÿæ˜¯åŒ…å«äº† ESXi ä¸»æœºçš„æ‰€æœ‰ä¿¡æ¯ï¼Œç”¨å®ƒå¯ä»¥æ¯”è¾ƒæ–¹ä¾¿åœ°å®šä½æŸä¸ªä¿¡æ¯çš„ç»“æ„ä½“ï¼Œè¿™ä¸€ç‚¹å¯¹åŸºäº govmomi æ¥å¼€å‘å…¶ä»–çš„åŠŸèƒ½æ¥è¯´ååˆ†æ–¹ä¾¿ã€‚å°¤å…¶æ˜¯åœ¨å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œå¯ä»¥ä»è¿™é‡Œ dump å‡ºä¸€äº›æ•°æ®æ¥è¿›è¡Œ mockã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„å­å‘½ä»¤éƒ½æ”¯æŒ json æ ¼å¼çš„è¾“å‡ºã€‚</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">mo.HostSystem&#123;    ManagedEntity: mo.ManagedEntity&#123;        ExtensibleManagedObject: mo.ExtensibleManagedObject&#123;            Self:           types.ManagedObjectReference&#123;Type:&quot;HostSystem&quot;, Value:&quot;ha-host&quot;&#125;,            Value:          nil,            AvailableField: nil,        &#125;,        Parent:        &amp;types.ManagedObjectReference&#123;Type:&quot;ComputeResource&quot;, Value:&quot;ha-compute-res&quot;&#125;,        CustomValue:   nil,        OverallStatus: &quot;green&quot;,        ConfigStatus:  &quot;yellow&quot;,        ConfigIssue:   []types.BaseEvent&#123;            &amp;types.RemoteTSMEnabledEvent&#123;                HostEvent: types.HostEvent&#123;                    Event: types.Event&#123;                        Key:             1,                        ChainId:         0,                        CreatedTime:     time.Now(),                        UserName:        &quot;&quot;,                        Datacenter:      (*types.DatacenterEventArgument)(nil),                        ComputeResource: (*types.ComputeResourceEventArgument)(nil),                        Host:            &amp;types.HostEventArgument&#123;                            EntityEventArgument: types.EntityEventArgument&#123;                                EventArgument: types.EventArgument&#123;&#125;,                                Name:          &quot;hp-esxi.lan&quot;,                            &#125;,                            Host: types.ManagedObjectReference&#123;Type:&quot;HostSystem&quot;, Value:&quot;ha-host&quot;&#125;,                        &#125;,                        Vm:                   (*types.VmEventArgument)(nil),                        Ds:                   (*types.DatastoreEventArgument)(nil),                        Net:                  (*types.NetworkEventArgument)(nil),                        Dvs:                  (*types.DvsEventArgument)(nil),                        FullFormattedMessage: &quot;SSH for the host hp-esxi.lan has been enabled&quot;,                        ChangeTag:            &quot;&quot;,                    &#125;,                &#125;,            &#125;,        &#125;,<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ç»å¸¸ç”¨å®ƒæ¥ mock ä¸€äº›ç‰¹æ®Šç¡¬ä»¶è®¾å¤‡çš„ä¿¡æ¯ï¼Œè¿™æ¯”è‡ªå·±æ‰‹å†™è¿™äº›ç»“æ„ä½“è¦æ–¹ä¾¿å¾ˆå¤šã€‚æ¯”å¦‚ä»¥ <code>mpx.vmhba&lt;Adapter&gt;:C&lt;Channel&gt;:T&lt;Target&gt;:L&lt;LUN&gt; </code> å‘½åçš„ç¡¬ç›˜å¯ä»¥é€šè¿‡  <code>PlugStoreTopology</code> è¿™ä¸ªç»“æ„ä½“æ¥è·å–è¯¥ç¡¬ç›˜çš„ NAA å·ï¼š</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">func getDiskIDByHostPlugStoreTopology(hpst *types.HostPlugStoreTopology, diskName string) string &#123;for _, path :&#x3D; range hpst.Path &#123;if path.Name &#x3D;&#x3D; diskName &#123;s :&#x3D; strings.Split(path.Target, &quot;-sas.&quot;)return s[len(s)-1]&#125;&#125;return &quot;&quot;&#125;&#x2F;&#x2F; å•å…ƒæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼švar plugStoreTopology &#x3D; &amp;types.HostPlugStoreTopology&#123;Path: []types.HostPlugStoreTopologyPath&#123;&#123;Key:           &quot;key-vim.host.PlugStoreTopology.Path-vmhba0:C0:T1:L0&quot;,Name:          &quot;vmhba0:C0:T1:L0&quot;,ChannelNumber: 0,TargetNumber:  1,LunNumber:     0,Adapter:       &quot;key-vim.host.PlugStoreTopology.Adapter-vmhba0&quot;,Target:        &quot;key-vim.host.PlugStoreTopology.Target-sas.500056b3d93828c0&quot;,Device:        &quot;key-vim.host.PlugStoreTopology.Device-020000000055cd2e414dc39d4e494e54454c20&quot;,&#125;,&#125;,&#125;func TestGetDiskIDByHostPlugStoreTopology(t *testing.T) &#123;tests :&#x3D; []struct &#123;name stringwant string&#125;&#123;&#123;name: &quot;vmhba0:C0:T1:L0&quot;,want: &quot;500056b3d93828c0&quot;,&#125;,&#123;name: &quot;vmhba0:C0:T2:L0&quot;,want: &quot;&quot;,&#125;,&#123;name: &quot;&quot;,want: &quot;&quot;,&#125;,&#125;for _, tt :&#x3D; range tests &#123;t.Run(tt.name, func(t *testing.T) &#123;if got :&#x3D; getDiskIDByHostPlugStoreTopology(plugStoreTopology, tt.name); got !&#x3D; tt.want &#123;t.Errorf(&quot;getDiskIDByHostPlugStoreTopology() &#x3D; %v, want %v&quot;, got, tt.want)&#125;&#125;)&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†æ¯”å¦‚ NVMe ç¡¬ç›˜å¯ä»¥é€šè¿‡ <code>NvmeTopology</code> è¿™ä¸ªæ•°æ®å¯¹è±¡è·å–å®ƒçš„åºåˆ—å·</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">func getNVMeIDByHostNvmeTopology(hnt *types.HostNvmeTopology, diskName string) string &#123;for _, adapter :&#x3D; range hnt.Adapter &#123;for _, controller :&#x3D; range adapter.ConnectedController &#123;for _, ns :&#x3D; range controller.AttachedNamespace &#123;if ns.Name &#x3D;&#x3D; diskName &#123;return strings.TrimSpace(controller.SerialNumber)&#125;&#125;&#125;&#125;return &quot;&quot;&#125;&#x2F;&#x2F; å•å…ƒæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼švar nvmeTopology &#x3D; &amp;types.HostNvmeTopology&#123;Adapter: []types.HostNvmeTopologyInterface&#123;&#123;Key:     &quot;key-vim.host.NvmeTopology.Interface-vmhba0&quot;,Adapter: &quot;key-vim.host.PcieHba-vmhba0&quot;,ConnectedController: []types.HostNvmeController&#123;&#123;Key:                     &quot;key-vim.host.NvmeController-256&quot;,ControllerNumber:        256,Subnqn:                  &quot;nqn.2021-06.com.intel:PHAB123502CU1P9SGN  &quot;,Name:                    &quot;nqn.2021-06.com.intel:PHAB123502CU1P9SGN&quot;,AssociatedAdapter:       &quot;key-vim.host.PcieHba-vmhba0&quot;,TransportType:           &quot;pcie&quot;,FusedOperationSupported: false,NumberOfQueues:          2,QueueSize:               1024,AttachedNamespace: []types.HostNvmeNamespace&#123;&#123;Key:              &quot;key-vim.host.NvmeNamespace-t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CB406E4D25C@256&quot;,Name:             &quot;t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CB406E4D25C&quot;,Id:               1,BlockSize:        512,CapacityInBlocks: 3125627568,&#125;,&#125;,VendorId:        &quot;0x8086&quot;,Model:           &quot;Dell Ent NVMe P5600 MU U.2 1.6TB        &quot;,SerialNumber:    &quot;PHAB123502CU1P9SGN  &quot;,FirmwareVersion: &quot;1.0.0   PCIe&quot;,&#125;,&#125;,&#125;,&#123;Key:     &quot;key-vim.host.NvmeTopology.Interface-vmhba1&quot;,Adapter: &quot;key-vim.host.PcieHba-vmhba1&quot;,ConnectedController: []types.HostNvmeController&#123;&#123;Key:                     &quot;key-vim.host.NvmeController-257&quot;,ControllerNumber:        257,Subnqn:                  &quot;nqn.2021-06.com.intel:PHAB123602H81P9SGN  &quot;,Name:                    &quot;nqn.2021-06.com.intel:PHAB123602H81P9SGN&quot;,AssociatedAdapter:       &quot;key-vim.host.PcieHba-vmhba1&quot;,TransportType:           &quot;pcie&quot;,FusedOperationSupported: false,NumberOfQueues:          2,QueueSize:               1024,AttachedNamespace: []types.HostNvmeNamespace&#123;&#123;Key:              &quot;key-vim.host.NvmeNamespace-t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CEE23E4D25C@257&quot;,Name:             &quot;t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CEE23E4D25C&quot;,Id:               1,BlockSize:        512,CapacityInBlocks: 3125627568,&#125;,&#125;,VendorId:        &quot;0x8086&quot;,Model:           &quot;Dell Ent NVMe P5600 MU U.2 1.6TB        &quot;,SerialNumber:    &quot;PHAB123602H81P9SGN  &quot;,FirmwareVersion: &quot;1.0.0   PCIe&quot;,&#125;,&#125;,&#125;,&#125;,&#125;func TestGetNVMeIDByHostNvmeTopology(t *testing.T) &#123;tests :&#x3D; []struct &#123;name stringwant string&#125;&#123;&#123;name: &quot;t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB________00035CEE23E4D25C&quot;,want: &quot;PHAB123602H81P9SGN&quot;,&#125;,&#123;name: &quot;t10.NVMe____Dell_Ent_NVMe_P5600_MU_U.2_1.6TB&quot;,want: &quot;&quot;,&#125;,&#123;name: &quot;&quot;,want: &quot;&quot;,&#125;,&#125;for _, tt :&#x3D; range tests &#123;t.Run(tt.name, func(t *testing.T) &#123;if got :&#x3D; getNVMeIDByHostNvmeTopology(nvmeTopology, tt.name); got !&#x3D; tt.want &#123;t.Errorf(&quot;getNVMeIDByHostNvmeTopology() &#x3D; %v, want %v&quot;, got, tt.want)&#125;&#125;)&#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="é…ç½®-ESXi-ä¸»æœºå‚æ•°"><a href="#é…ç½®-ESXi-ä¸»æœºå‚æ•°" class="headerlink" title="é…ç½® ESXi ä¸»æœºå‚æ•°"></a>é…ç½® ESXi ä¸»æœºå‚æ•°</h2><p>é€šè¿‡ <code>host.option.ls</code> å¯ä»¥åˆ—å‡ºå½“å‰ ESXi ä¸»æœºæ‰€æœ‰çš„é…ç½®é€‰é¡¹</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ govc host.option.lsAnnotations.WelcomeMessage:BufferCache.FlushInterval:                          <span class="token number">30000</span>BufferCache.HardMaxDirty:                           <span class="token number">95</span>BufferCache.PerFileHardMaxDirty:                    <span class="token number">50</span>BufferCache.SoftMaxDirty:                           <span class="token number">15</span>CBRC.DCacheMemReserved:                             <span class="token number">400</span>CBRC.Enable:                                        <span class="token boolean">false</span>COW.COWMaxHeapSizeMB:                               <span class="token number">192</span>COW.COWMaxREPageCacheszMB:                          <span class="token number">256</span>COW.COWMinREPageCacheszMB:                          <span class="token number">0</span>COW.COWREPageCacheEviction:                         <span class="token number">1</span>Config.Defaults.host.TAAworkaround:                 <span class="token boolean">true</span>Config.Defaults.monitor.if_pschange_mc_workaround:  <span class="token boolean">false</span>Config.Defaults.security.host.ruissl:               <span class="token boolean">true</span>Config.Defaults.vGPU.consolidation:                 <span class="token boolean">false</span>Config.Etc.issue:Config.Etc.motd:                                    The <span class="token function">time</span> and <span class="token function">date</span> of this login have been sent to the system logs.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ <code>host.option.set</code> å¯ä»¥è®¾ç½® ESXi ä¸»æœºå‚æ•°ï¼Œä¾‹å¦‚å¦‚æœæƒ³è¦é…ç½® NFS å­˜å‚¨å¿ƒè·³è¶…æ—¶æ—¶é—´å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ govc host.option.set NFS.HeartbeatTimeout <span class="token number">30</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="å¼€å¯-ssh-æœåŠ¡"><a href="#å¼€å¯-ssh-æœåŠ¡" class="headerlink" title="å¼€å¯ ssh æœåŠ¡"></a>å¼€å¯ ssh æœåŠ¡</h2><p>é€šè¿‡ <code>host.service</code> å¯ä»¥å¯¹ ESXi ä¸»æœºä¸Šçš„æœåŠ¡è¿›è¡Œç›¸å…³æ“ä½œã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ govc host.serviceWhere ACTION is one of: start, stop, restart, status, enable, disable<span class="token comment"># å¯åŠ¨ ssh æœåŠ¡</span>$ govc host.service start TSM-SSH<span class="token comment"># å°† ssh æœåŠ¡è®¾ç½®ä¸ºå¼€æœºè‡ªå¯</span>$ govc host.service <span class="token builtin class-name">enable</span> TSM-SSH<span class="token comment"># æŸ¥çœ‹ ssh æœåŠ¡çš„çŠ¶æ€</span>$ govc host.service status TSM-SSH<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="åˆ›å»ºè™šæ‹Ÿæœº"><a href="#åˆ›å»ºè™šæ‹Ÿæœº" class="headerlink" title="åˆ›å»ºè™šæ‹Ÿæœº"></a>åˆ›å»ºè™šæ‹Ÿæœº</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token assign-left variable">VM_NAME</span><span class="token operator">=</span><span class="token string">"centos-test"</span>$ govc vm.create -ds<span class="token operator">=</span><span class="token string">'datastore*'</span> -net<span class="token operator">=</span><span class="token string">'VM Network'</span> -net.adapter<span class="token operator">=</span>vmxnet3 -disk 1G -on<span class="token operator">=</span>false <span class="token variable">$&#123;VM_NAME&#125;</span>$ govc vm.change -cpu.reservation<span class="token operator">=</span>%d -memory-pin<span class="token operator">=</span>true -vm <span class="token variable">$&#123;VM_NAME&#125;</span>$ govc vm.change -g centos7_64Guest -c %d -m <span class="token number">16384</span> -latency high -vm <span class="token variable">$&#123;VM_NAME&#125;</span>$ govc device.cdrom.add -vm <span class="token variable">$&#123;VM_NAME&#125;</span>$ govc device.cdrom.insert -vm <span class="token variable">$&#123;VM_NAME&#125;</span> -device cdrom-3000$ govc device.connect -vm <span class="token variable">$&#123;VM_NAME&#125;</span> cdrom-3000$ govc vm.power -on<span class="token operator">=</span>true <span class="token variable">$&#123;VM_NAME&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://gitbook.curiouser.top/origin/vsphere-govc.html">vSphere go å‘½ä»¤è¡Œç®¡ç†å·¥å…· govc</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;æœ€è¿‘ç”±äºå·¥ä½œåŸå› éœ€è¦åœ¨ ESXi
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="ESXi" scheme="https://blog.k8s.li/tags/ESXi/"/>
    
      <category term="govc" scheme="https://blog.k8s.li/tags/govc/"/>
    
      <category term="vCenter" scheme="https://blog.k8s.li/tags/vCenter/"/>
    
      <category term="vSphere" scheme="https://blog.k8s.li/tags/vSphere/"/>
    
  </entry>
  
  <entry>
    <title>æµæ°´çº¿ä¸­ä½¿ç”¨ docker in pod æ–¹å¼æ„å»ºå®¹å™¨é•œåƒ</title>
    <link href="https://blog.k8s.li/docker-in-pod.html"/>
    <id>https://blog.k8s.li/docker-in-pod.html</id>
    <published>2022-03-14T16:00:00.000Z</published>
    <updated>2022-03-15T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šä¸ªæœˆå‚åŠ äº† Rancher ç¤¾åŒºä¸¾åŠçš„ ã€Š<a href="https://www.bilibili.com/video/BV1Xa411C78k">Dockershim å³å°†è¢«ç§»é™¤ï¼Œä½ å‡†å¤‡å¥½äº†ä¹ˆï¼Ÿ</a>ã€‹ç›´æ’­åˆ†äº«åï¼Œå¾—çŸ¥è‡ª 1.24 ç‰ˆæœ¬ä¹‹åï¼ŒKubernetes ç¤¾åŒºå°†æ­£å¼æ”¾å¼ƒå¯¹ docker CRI çš„æ”¯æŒï¼Œdocker CRI è¿™éƒ¨åˆ†ä»£ç åˆ™ç”± <a href="https://github.com/Mirantis/cri-dockerd"> cri-dockerd</a> é¡¹ç›®æ¥æ¥ç›˜ã€‚ç›®å‰ä¼—å¤šä¸»æµçš„ Kubernetes ç§æœ‰åŒ–éƒ¨ç½²å·¥å…·ï¼ˆæ¯”å¦‚ <a href="https://github.com/kubernetes-sigs/kubespray">kubespray</a>ã€<a href="https://github.com/kubesphere/kubekey">kubekey</a>ã€<a href="https://github.com/fanux/sealos">sealos</a>ï¼‰ä¹Ÿé€æ¸åœ°ä¸å†å°† docker ä½œä¸ºé¦–é€‰çš„å®¹å™¨è¿è¡Œæ—¶è€Œçº·çº·è½¬å‘äº† containerdï¼Œå» docker ä¹Ÿæˆä¸ºäº†ç›®å‰äº‘åŸç”Ÿç¤¾åŒºçƒ­é—¨çš„è®¨è®ºè¯é¢˜ã€‚</p><p>docker è™½ç„¶ä½œä¸ºä¸€ä¸ª CRI åœ¨ Kubernetes ç¤¾åŒºä¸€ç›´è¢«äººè¯Ÿç—…ï¼Œä½†æˆ‘ä»¬è¦çŸ¥é“ CRI ä»…ä»…æ˜¯ docker çš„ä¸€éƒ¨åˆ†åŠŸèƒ½è€Œå·²ã€‚å¯¹äºæœ¬åœ°å¼€å‘æµ‹è¯•æˆ–è€… CI&#x2F;CD æµæ°´çº¿é•œåƒæ„å»ºæ¥è®²ï¼Œä¾ç„¶æœ‰å¾ˆå¤šåœ°æ–¹ä¸¥é‡åœ°ä¾èµ–ç€ dockerã€‚æ¯”å¦‚ GitHub ä¸Šå®¹å™¨é•œåƒæ„å»ºçš„ Action é‡Œï¼Œ docker å®˜æ–¹çš„ <a href="https://github.com/docker/build-push-action">build-push-action</a> æ˜¯ä¼—å¤šé¡¹ç›®é¦–é€‰çš„æ–¹å¼ã€‚å³ä¾¿æ˜¯ docker çš„ç«äº‰å¯¹æ‰‹ <a href="https://github.com/containers/podman">podman</a> + <a href="https://github.com/containers/skopeo">skopeo</a> + <a href="https://github.com/containers/buildah">buildah</a> ä¸‰å‰‘å®¢å®ƒä»¬è‡ªèº«çš„å®¹å™¨é•œåƒä¹Ÿæ˜¯é‡‡ç”¨ docker æ¥æ„å»ºçš„ <a href="https://github.com/containers/buildah/blob/main/.github/workflows/multi-arch-build.yaml">multi-arch-build.yaml</a>ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">jobs</span><span class="token punctuation">:</span>  <span class="token key atrule">multi</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> multi<span class="token punctuation">-</span>arch image build    <span class="token key atrule">env</span><span class="token punctuation">:</span>      <span class="token key atrule">REPONAME</span><span class="token punctuation">:</span> buildah  <span class="token comment"># No easy way to parse this out of $GITHUB_REPOSITORY</span>      <span class="token comment"># Server/namespace value used to format FQIN</span>      <span class="token key atrule">REPONAME_QUAY_REGISTRY</span><span class="token punctuation">:</span> quay.io/buildah      <span class="token key atrule">CONTAINERS_QUAY_REGISTRY</span><span class="token punctuation">:</span> quay.io/containers      <span class="token comment"># list of architectures for build</span>      <span class="token key atrule">PLATFORMS</span><span class="token punctuation">:</span> linux/amd64<span class="token punctuation">,</span>linux/s390x<span class="token punctuation">,</span>linux/ppc64le<span class="token punctuation">,</span>linux/arm64      <span class="token comment"># Command to execute in container to obtain project version number</span>      <span class="token key atrule">VERSION_CMD</span><span class="token punctuation">:</span> <span class="token string">"buildah --version"</span>    <span class="token comment"># build several images (upstream, testing, stable) in parallel</span>    <span class="token key atrule">strategy</span><span class="token punctuation">:</span>      <span class="token comment"># By default, failure of one matrix item cancels all others</span>      <span class="token key atrule">fail-fast</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>      <span class="token key atrule">matrix</span><span class="token punctuation">:</span>        <span class="token comment"># Builds are located under contrib/&lt;reponame>image/&lt;source> directory</span>        <span class="token key atrule">source</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> upstream          <span class="token punctuation">-</span> testing          <span class="token punctuation">-</span> stable    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest    <span class="token comment"># internal registry caches build for inspection before push</span>    <span class="token key atrule">services</span><span class="token punctuation">:</span>      <span class="token key atrule">registry</span><span class="token punctuation">:</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/libpod/registry<span class="token punctuation">:</span><span class="token number">2</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> 5000<span class="token punctuation">:</span><span class="token number">5000</span>    <span class="token key atrule">steps</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up QEMU        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>qemu<span class="token punctuation">-</span>action@v1      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Docker Buildx        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v1        <span class="token key atrule">with</span><span class="token punctuation">:</span>          <span class="token key atrule">driver-opts</span><span class="token punctuation">:</span> network=host          <span class="token key atrule">install</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build and locally push image        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v2        <span class="token key atrule">with</span><span class="token punctuation">:</span>          <span class="token key atrule">context</span><span class="token punctuation">:</span> contrib/$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.REPONAME <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>image/$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> matrix.source <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">file</span><span class="token punctuation">:</span> ./contrib/$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.REPONAME <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>image/$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> matrix.source <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/Dockerfile          <span class="token key atrule">platforms</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.PLATFORMS <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>          <span class="token key atrule">push</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>          <span class="token key atrule">tags</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span>5000/$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.REPONAME <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> matrix.source <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Jenkins-æµæ°´çº¿"><a href="#Jenkins-æµæ°´çº¿" class="headerlink" title="Jenkins æµæ°´çº¿"></a>Jenkins æµæ°´çº¿</h2><p>æˆ‘ä»¬çš„ CI&#x2F;CD æµæ°´çº¿æ˜¯ä½¿ç”¨ Jenkins + Kubernetes plugin çš„æ–¹å¼åœ¨ Kubernetes ä¸ŠåŠ¨æ€åœ°åˆ›å»º Pod ä½œä¸º Jenkins Slaveã€‚åœ¨ä½¿ç”¨ docker ä½œä¸ºå®¹å™¨æ—¶çš„æƒ…å†µä¸‹ï¼ŒJenkins  Slave Pod å°†å®¿ä¸»æœºä¸Šçš„ <code>/var/run/docker.sock</code> æ–‡ä»¶é€šè¿‡ hostPath çš„æ–¹å¼æŒ‚è½½åˆ° pod å®¹å™¨å†…ï¼Œå®¹å™¨å†…çš„ docker CLI å°±èƒ½é€šè¿‡è¯¥ sock ä¸å®¿ä¸»æœºçš„ docker å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé€šä¿¡ï¼Œè¿™æ ·åœ¨ pod å®¹å™¨å†…å°±å¯ä»¥æ— ç¼åœ°ä½¿ç”¨ docker build ã€push ç­‰å‘½ä»¤äº†ã€‚</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">// Kubernetes pod template to run.podTemplate(    <span class="token key atrule">cloud</span><span class="token punctuation">:</span> <span class="token string">"kubernetes"</span><span class="token punctuation">,</span>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">label</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">yaml</span><span class="token punctuation">:</span> """<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> debian    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"$&#123;JENKINS_POD_IMAGE_NAME&#125;"</span>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dockersock      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/docker.sock  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jnlp    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"\$(JENKINS_SECRET)"</span><span class="token punctuation">,</span> <span class="token string">"\$(JENKINS_NAME)"</span><span class="token punctuation">]</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"jenkins/inbound-agent:4.3-4-alpine"</span>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dockersock      <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/run/docker.sock"""<span class="token punctuation">,</span>)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å½“ä¸å†ä½¿ç”¨ docker ä½œä¸º Kubernetes çš„å®¹å™¨è¿è¡Œæ—¶ä¹‹åï¼Œå®¿ä¸»æœºä¸Šåˆ™å°±æ²¡æœ‰äº† docker å®ˆæŠ¤è¿›ç¨‹ï¼ŒæŒ‚è½½ <code>/var/run/docker.sock</code> çš„æ–¹å¼ä¹Ÿå°±å‡‰å‡‰äº†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€äº›æ›¿ä»£çš„æ–¹æ³•ã€‚</p><p>ç›®å‰èƒ½æƒ³åˆ°çš„æœ‰ä¸¤ç§æ–¹æ¡ˆï¼šæ–¹æ¡ˆä¸€æ˜¯æ›¿ä»£æ‰ docker ä½¿ç”¨å…¶ä»–é•œåƒæ„å»ºå·¥å…·æ¯”å¦‚ <a href="https://github.com/containers/podman">podman</a> + <a href="https://github.com/containers/skopeo">skopeo</a> + <a href="https://github.com/containers/buildah">buildah</a>ã€‚é™ˆå°‘æ–‡åšä¸»åœ¨ã€Š<a href="https://www.chenshaowen.com/blog/using-podman-to-build-images-under-kubernetes-and-jenkins.html">åŸºäº Kubernetes çš„ Jenkins æœåŠ¡ä¹Ÿå¯ä»¥å» Docker äº†</a>ã€‹è¯¦ç»†åœ°è®²è¿‡è¯¥æ–¹æ¡ˆã€‚ä½†æˆ‘ä»¬çš„ Makefile é‡Œç¼åˆäº†ä¸€äº› docker buildKit çš„ç‰¹æ€§å‚æ•°å¹¶ä¸èƒ½åœ°é€šè¿‡ <code>alias docker=podman</code> åˆ«åçš„æ–¹å¼ç®€å•ç²—æš´åœ°ç»™æ›¿æ¢æ‰ ğŸ˜‚ã€‚</p><p>æ¯”å¦‚ podman æ„å»ºé•œåƒå°±ä¸æ”¯æŒ <code>--output type=local,dest=path</code>  <a href="https://github.com/containers/buildah/issues/3789">Support custom build outputs #3789</a> è¿™ç§ç‰¹æ€§ã€‚ç›®å‰çœ‹æ¥ podman æƒ³è¦å®Œå…¨å–ä»£æ‰ docker çš„è€å¤§å“¥åœ°ä½ä»è¿˜æœ‰å¾ˆé•¿çš„è·¯è¦èµ°ï¼Œå°¤å…¶ podman è¿˜æ²¡æœ‰è§£å†³è‡ªèº«çš„é•œåƒæ˜¯ç”± docker æ¥æ„å»ºçš„è¿™ä¸ªå°´å°¬éš¾é¢˜ã€‚</p><p>æ–¹æ¡ˆäºŒå°±æ˜¯ç»§ç»­ä½¿ç”¨ docker ä½œä¸ºé•œåƒæ„å»ºå·¥å…·ï¼Œè™½ç„¶é›†ç¾¤èŠ‚ç‚¹ä¸Šæ²¡æœ‰äº† docker å®ˆæŠ¤è¿›ç¨‹ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€åœ¨ Kubernetes é›†ç¾¤é‡Œå°±æ— æ³•ä½¿ç”¨ docker äº†ã€‚æˆ‘ä»¬å¯ä»¥æ¢ç§æ–¹å¼å°† docker ä½œä¸ºä¸€ä¸ª pod è¿è¡Œåœ¨ kubernetes é›†ç¾¤ä¸­ï¼Œè€Œéä»¥ systemd çš„æ–¹å¼éƒ¨ç½²åœ¨èŠ‚ç‚¹ä¸Šã€‚ç„¶åé€šè¿‡ service IP æˆ– Node IP è®¿é—® docker çš„ TCP ç«¯å£è¿›è¡Œé€šä¿¡ï¼Œè¿™æ ·ä¹Ÿèƒ½æ— ç¼åœ°ç»§ç»­ä½¿ç”¨ docker ã€‚äºæ˜¯åœ¨ dind (docker-in-docker) çš„åŸºç¡€ä¸Šå°±æœ‰äº† dinp (docker-in-pod) çš„å¥—å¨ƒæ“ä½œï¼Œå…¶å®äºŒè€…æœ¬è´¨ä¸Šéƒ½æ˜¯ç›¸åŒçš„ï¼Œåªä¸è¿‡æ˜¯éƒ¨ç½²æ–¹å¼å’Œè®¿é—®æ–¹å¼ä¸å¤ªç›¸åŒè€Œå·²ã€‚</p><p>å¯¹æ¯”ä¸€ä¸‹è¿™ä¸¤ç§æ–¹æ¡ˆï¼Œæ–¹æ¡ˆä¸€é€šè¿‡ <code>alias docker=podman</code> ä½¿ç”¨ podman æ›¿ä»£ docker æœ‰ç‚¹æŠ•æœºå–å·§ï¼Œåœ¨æ­£å¼çš„ç”Ÿäº§ç¯å¢ƒæµæ°´çº¿ä¸­åº”è¯¥å¾ˆå°‘ä¼šè¢«é‡‡ç”¨ï¼Œé™¤éä½ çš„ Makefile æˆ–è€…é•œåƒæ„å»ºè„šæœ¬ä¸­æ²¡æœ‰ä¾èµ– docker çš„ç‰¹æ€§å‚æ•°ï¼Œèƒ½å¤Ÿå®Œå…¨å…¼å®¹ podmanï¼›æ–¹æ¡ˆäºŒæ¯”è¾ƒç¨³å®šå¯é ï¼Œå®ƒæ— éå°±æ˜¯å°†ä¹‹å‰çš„å®¿ä¸»æœºèŠ‚ç‚¹ä¸Šçš„ docker å®ˆæŠ¤è¿›ç¨‹æ›¿æ¢æˆäº†é›†ç¾¤å†…çš„ Podï¼Œå¯¹äºä½¿ç”¨è€…è€Œè¨€åªéœ€è¦ä¿®æ”¹ä¸€ä¸‹è®¿é—® docker çš„æ–¹å¼ï¼Œå³ <code>DOCKER_HOST</code> ç¯å¢ƒå˜é‡å³å¯ã€‚å› æ­¤æœ¬æ–‡é€‰ç”¨æ–¹æ¡ˆäºŒæ¥ç»™å¤§å®¶ä»‹ç»å‡ ç§åœ¨ K8s é›†ç¾¤é‡Œéƒ¨ç½²å’Œä½¿ç”¨ dind&#x2F;dinp çš„æ–¹å¼ã€‚</p><h2 id="docker-in-pod"><a href="#docker-in-pod" class="headerlink" title="docker in pod"></a>docker in pod</h2><p>ä¸åŒäº docker in dockerï¼Œdocker in pod å¹¶ä¸å…³å¿ƒåº•å±‚çš„å®¹å™¨è¿è¡Œæ—¶æ˜¯ä»€ä¹ˆï¼Œå¯ä»¥æ˜¯ docker ä¹Ÿå¯ä»¥æ˜¯ containerdã€‚åœ¨ pod å†…è¿è¡Œå’Œä½¿ç”¨ docker ä¸ªäººæ€»ç»“å‡ºä»¥ä¸‹ä¸‰ç§æ¯”è¾ƒåˆé€‚çš„æ–¹å¼ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ï¼š</p><h3 id="sidecar"><a href="#sidecar" class="headerlink" title="sidecar"></a>sidecar</h3><p>å°† dind å®¹å™¨ä½œä¸º <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/#using-pods">sidecar å®¹å™¨</a> æ¥è¿è¡Œï¼Œä¸»å®¹å™¨é€šè¿‡ localhost çš„æ–¹å¼è®¿é—® docker çš„ 2375&#x2F;2376 TCP ç«¯å£ã€‚è¿™ç§æ–¹æ¡ˆçš„å¥½å¤„å°±æ˜¯å¦‚æœåˆ›å»ºäº†å¤šä¸ª Podï¼Œå„ä¸ª Pod ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œdind å®¹å™¨ä¸ä¼šå…±äº«ç»™å…¶ä»– pod ä½¿ç”¨ï¼Œéš”ç¦»æ€§æ¯”è¾ƒå¥½ã€‚ç¼ºç‚¹ä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼Œæ¯ä¸€ä¸ª Pod éƒ½å¸¦ä¸€ä¸ª dind å®¹å™¨å ç”¨çš„ç³»ç»Ÿèµ„æºæ¯”è¾ƒå¤šï¼Œæœ‰ç‚¹å¤§æå°ç”¨çš„æ„Ÿè§‰ï¼›</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>sidecar<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>20.10.12    <span class="token key atrule">name</span><span class="token punctuation">:</span> debug    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"sleep"</span><span class="token punctuation">,</span> <span class="token string">"3600"</span><span class="token punctuation">]</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_VERIFY      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_HOST      <span class="token key atrule">value</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">2375</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dind    <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>20.10.12<span class="token punctuation">-</span>dind<span class="token punctuation">-</span>rootless    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"--insecure-registry=$(REGISTRY)"</span><span class="token punctuation">]</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token comment"># å¦‚æœé•œåƒä»“åº“åŸŸåä¸ºè‡ªç­¾è¯ä¹¦ï¼Œéœ€è¦åœ¨è¿™é‡Œé…ç½® insecure-registry</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REGISTRY      <span class="token key atrule">value</span><span class="token punctuation">:</span> hub.k8s.li    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_CERTDIR      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_HOST      <span class="token key atrule">value</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">2375</span>    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>      <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token comment"># ä½¿ç”¨ docker info å‘½ä»¤å°±ç»ªæ¢é’ˆæ¥ç¡®ä¿ dind å®¹å™¨æ­£å¸¸å¯åŠ¨ </span>    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">exec</span><span class="token punctuation">:</span>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>      <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="daemonset"><a href="#daemonset" class="headerlink" title="daemonset"></a>daemonset</h3><p><a href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/">daemonset</a> åˆ™æ˜¯åœ¨é›†ç¾¤çš„æ¯ä¸€ä¸ª Node èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª dind Podï¼Œå¹¶ä¸”ä½¿ç”¨ hostNetwork æ–¹å¼æ¥æš´éœ² 2375&#x2F;2376 TCP ç«¯å£ã€‚ä½¿ç”¨è€…åˆ™é€šè¿‡ <code>status.hostIP</code> è®¿é—®å®¿ä¸»æœºçš„ 2375&#x2F;2376 TCP ç«¯å£æ¥ä¸ docker è¿›è¡Œé€šä¿¡ï¼›å¦å¤–å†é€šè¿‡ hostPath æŒ‚è½½çš„æ–¹å¼æ¥å°† dind å®¹å™¨å†…çš„ <code>/var/lib/docker</code> æ•°æ®æŒä¹…åŒ–å­˜å‚¨ä¸‹æ¥ï¼Œèƒ½å¤Ÿç¼“å­˜ä¸€äº›æ•°æ®æé«˜é•œåƒæ„å»ºçš„æ•ˆç‡ã€‚</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>daemonset  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>daemonset  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>daemonset    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dind        <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>20.10.12<span class="token punctuation">-</span>dind        <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"--insecure-registry=$(REGISTRY)"</span><span class="token punctuation">]</span>        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REGISTRY          <span class="token key atrule">value</span><span class="token punctuation">:</span> hub.k8s.li        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_CERTDIR          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>storage          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span>  /var/lib/docker        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">60</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">10</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>storage        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/docker<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="deployment"><a href="#deployment" class="headerlink" title="deployment"></a>deployment</h3><p>Deployment æ–¹å¼åˆ™æ˜¯åœ¨é›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ªæˆ–å¤šä¸ª dind Podï¼Œä½¿ç”¨è€…é€šè¿‡ service IP æ¥è®¿é—® docker çš„ 2375&#x2F;2376 ç«¯å£ï¼Œå¦‚æœæ˜¯ä»¥é TLS æ–¹å¼å¯åŠ¨ dind å®¹å™¨ï¼Œä½¿ç”¨ service IP æ¥è®¿é—® docker è¦æ¯”å‰é¢çš„ daemonset ä½¿ç”¨ host IP å®‰å…¨æ€§è¦å¥½ä¸€äº›ã€‚</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>deployment  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>deployment<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>deployment  <span class="token key atrule">template</span><span class="token punctuation">:</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>deployment    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dind        <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>20.10.12<span class="token punctuation">-</span>dind        <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"--insecure-registry=$(REGISTRY)"</span><span class="token punctuation">]</span>        <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REGISTRY          <span class="token key atrule">value</span><span class="token punctuation">:</span> hub.k8s.li        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_CERTDIR          <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_HOST          <span class="token key atrule">value</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">2375</span>        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>storage          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span>  /var/lib/docker        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>          <span class="token key atrule">exec</span><span class="token punctuation">:</span>            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">60</span>          <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">10</span>      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>storage        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>          <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/docker<span class="token punctuation">---</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token comment"># å®šä¹‰ service nameï¼Œä½¿ç”¨è€…é€šè¿‡å®ƒæ¥è®¿é—® docker çš„ 2375 ç«¯å£</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>deployment<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> dinp<span class="token punctuation">-</span>deployment  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2375</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">2375</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Jenkinsfile"><a href="#Jenkinsfile" class="headerlink" title="Jenkinsfile"></a>Jenkinsfile</h2><p>åœ¨ Jenkins çš„ podTemplate æ¨¡ç‰ˆé‡Œï¼Œå¯ä»¥æ ¹æ® dinp éƒ¨ç½²æ–¹å¼çš„ä¸åŒé€‰ç”¨ä»¥ä¸‹å‡ ç§ä¸åŒçš„æ¨¡ç‰ˆï¼š</p><h3 id="sidecare"><a href="#sidecare" class="headerlink" title="sidecare"></a>sidecare</h3><p>Pod å†…å®¹å™¨å…±äº«åŒä¸€ä¸ªç½‘ç»œåè®®æ ˆï¼Œå› æ­¤å¯ä»¥é€šè¿‡ localhost æ¥è®¿é—® docker çš„ TCP ç«¯å£ï¼Œå¦å¤–æœ€å¥½ä½¿ç”¨ rootless æ¨¡å¼å¯åŠ¨ dind å®¹å™¨ï¼Œè¿™æ ·èƒ½åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œå¤šä¸ªè¿™æ ·çš„ Pod å®ä¾‹ã€‚</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">def JOB_NAME = "$<span class="token punctuation">&#123;</span>env.JOB_BASE_NAME<span class="token punctuation">&#125;</span>"def BUILD_NUMBER = "$<span class="token punctuation">&#123;</span>env.BUILD_NUMBER<span class="token punctuation">&#125;</span>"def POD_NAME = "jenkins<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>JOB_NAME<span class="token punctuation">&#125;</span><span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>BUILD_NUMBER<span class="token punctuation">&#125;</span>"<span class="token key atrule">def K8S_CLUSTER = params.k8s_cluster ?</span><span class="token punctuation">:</span> kubernetes// Kubernetes pod template to run.podTemplate(    <span class="token key atrule">cloud</span><span class="token punctuation">:</span> K8S_CLUSTER<span class="token punctuation">,</span>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">label</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">yaml</span><span class="token punctuation">:</span> """<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> runner    <span class="token key atrule">image</span><span class="token punctuation">:</span> golang<span class="token punctuation">:</span>1.17<span class="token punctuation">-</span>buster    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_HOST      <span class="token key atrule">vaule</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">2375</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_VERIFY      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jnlp    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"\$(JENKINS_SECRET)"</span><span class="token punctuation">,</span> <span class="token string">"\$(JENKINS_NAME)"</span><span class="token punctuation">]</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"jenkins/inbound-agent:4.11.2-4-alpine"</span>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dind    <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>20.10.12<span class="token punctuation">-</span>dind<span class="token punctuation">-</span>rootless    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"--insecure-registry=$(REGISTRY)"</span><span class="token punctuation">]</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REGISTRY      <span class="token key atrule">value</span><span class="token punctuation">:</span> hub.k8s.li    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_CERTDIR      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>    <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>      <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>      <span class="token key atrule">exec</span><span class="token punctuation">:</span>        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>      <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>"""<span class="token punctuation">,</span>) <span class="token punctuation">&#123;</span>    node(POD_NAME) <span class="token punctuation">&#123;</span>        container("runner") <span class="token punctuation">&#123;</span>            stage("Checkout") <span class="token punctuation">&#123;</span>                retry(10) <span class="token punctuation">&#123;</span>                    checkout(<span class="token punctuation">[</span>                        <span class="token key atrule">$class</span><span class="token punctuation">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span>                        <span class="token key atrule">branches</span><span class="token punctuation">:</span> scm.branches<span class="token punctuation">,</span>                        <span class="token key atrule">doGenerateSubmoduleConfigurations</span><span class="token punctuation">:</span> scm.doGenerateSubmoduleConfigurations<span class="token punctuation">,</span>                        <span class="token key atrule">extensions</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token key atrule">$class</span><span class="token punctuation">:</span> <span class="token string">'CloneOption'</span><span class="token punctuation">,</span> <span class="token key atrule">noTags</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">shallow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">depth</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token key atrule">reference</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token key atrule">userRemoteConfigs</span><span class="token punctuation">:</span> scm.userRemoteConfigs<span class="token punctuation">,</span>                    <span class="token punctuation">]</span>)                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            stage("Build") <span class="token punctuation">&#123;</span>                sh """                <span class="token comment"># make docker-build</span>                docker build <span class="token punctuation">-</span>t app<span class="token punctuation">:</span>v1.0.0<span class="token punctuation">-</span>alpha.1 .                """            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="daemonset-1"><a href="#daemonset-1" class="headerlink" title="daemonset"></a>daemonset</h3><p>ç”±äºä½¿ç”¨çš„æ˜¯ hostNetworkï¼Œå› æ­¤å¯ä»¥é€šè¿‡ host IP æ¥è®¿é—® docker çš„ TCP ç«¯å£ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åƒ deployment é‚£æ ·é€šè¿‡ service Name æ¥è®¿é—®ï¼Œåœ¨è¿™é‡Œå°±ä¸æ¼”ç¤ºäº†ã€‚</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">def JOB_NAME = "$<span class="token punctuation">&#123;</span>env.JOB_BASE_NAME<span class="token punctuation">&#125;</span>"def BUILD_NUMBER = "$<span class="token punctuation">&#123;</span>env.BUILD_NUMBER<span class="token punctuation">&#125;</span>"def POD_NAME = "jenkins<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>JOB_NAME<span class="token punctuation">&#125;</span><span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>BUILD_NUMBER<span class="token punctuation">&#125;</span>"<span class="token key atrule">def K8S_CLUSTER = params.k8s_cluster ?</span><span class="token punctuation">:</span> kubernetes// Kubernetes pod template to run.podTemplate(    <span class="token key atrule">cloud</span><span class="token punctuation">:</span> K8S_CLUSTER<span class="token punctuation">,</span>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">label</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">yaml</span><span class="token punctuation">:</span> """<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> runner    <span class="token key atrule">image</span><span class="token punctuation">:</span> golang<span class="token punctuation">:</span>1.17<span class="token punctuation">-</span>buster    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_HOST      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>        <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>          <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.hostIP    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_VERIFY      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jnlp    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"\$(JENKINS_SECRET)"</span><span class="token punctuation">,</span> <span class="token string">"\$(JENKINS_NAME)"</span><span class="token punctuation">]</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"jenkins/inbound-agent:4.11.2-4-alpine"</span>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent"""<span class="token punctuation">,</span>) <span class="token punctuation">&#123;</span>    node(POD_NAME) <span class="token punctuation">&#123;</span>        container("runner") <span class="token punctuation">&#123;</span>            stage("Checkout") <span class="token punctuation">&#123;</span>                retry(10) <span class="token punctuation">&#123;</span>                    checkout(<span class="token punctuation">[</span>                        <span class="token key atrule">$class</span><span class="token punctuation">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span>                        <span class="token key atrule">branches</span><span class="token punctuation">:</span> scm.branches<span class="token punctuation">,</span>                        <span class="token key atrule">doGenerateSubmoduleConfigurations</span><span class="token punctuation">:</span> scm.doGenerateSubmoduleConfigurations<span class="token punctuation">,</span>                        <span class="token key atrule">extensions</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token key atrule">$class</span><span class="token punctuation">:</span> <span class="token string">'CloneOption'</span><span class="token punctuation">,</span> <span class="token key atrule">noTags</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">shallow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">depth</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token key atrule">reference</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token key atrule">userRemoteConfigs</span><span class="token punctuation">:</span> scm.userRemoteConfigs<span class="token punctuation">,</span>                    <span class="token punctuation">]</span>)                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            stage("Build") <span class="token punctuation">&#123;</span>                sh """                <span class="token comment"># make docker-build</span>                docker build <span class="token punctuation">-</span>t app<span class="token punctuation">:</span>v1.0.0<span class="token punctuation">-</span>alpha.1 .                """            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="deployment-1"><a href="#deployment-1" class="headerlink" title="deployment"></a>deployment</h3><p>é€šè¿‡ service name è®¿é—® dockerï¼Œå…¶ä»–å‚æ•°å’Œ daemonset éƒ½æ˜¯ç›¸åŒçš„</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">def JOB_NAME = "$<span class="token punctuation">&#123;</span>env.JOB_BASE_NAME<span class="token punctuation">&#125;</span>"def BUILD_NUMBER = "$<span class="token punctuation">&#123;</span>env.BUILD_NUMBER<span class="token punctuation">&#125;</span>"def POD_NAME = "jenkins<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>JOB_NAME<span class="token punctuation">&#125;</span><span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span>BUILD_NUMBER<span class="token punctuation">&#125;</span>"<span class="token key atrule">def K8S_CLUSTER = params.k8s_cluster ?</span><span class="token punctuation">:</span> kubernetes// Kubernetes pod template to run.podTemplate(    <span class="token key atrule">cloud</span><span class="token punctuation">:</span> K8S_CLUSTER<span class="token punctuation">,</span>    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">label</span><span class="token punctuation">:</span> POD_NAME<span class="token punctuation">,</span>    <span class="token key atrule">yaml</span><span class="token punctuation">:</span> """<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> runner    <span class="token key atrule">image</span><span class="token punctuation">:</span> golang<span class="token punctuation">:</span>1.17<span class="token punctuation">-</span>buster    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent    <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">env</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_HOST       <span class="token key atrule">value</span><span class="token punctuation">:</span> tcp<span class="token punctuation">:</span>//dinp<span class="token punctuation">-</span>deployment<span class="token punctuation">:</span><span class="token number">2375</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKER_TLS_VERIFY      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">""</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> jnlp    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"\$(JENKINS_SECRET)"</span><span class="token punctuation">,</span> <span class="token string">"\$(JENKINS_NAME)"</span><span class="token punctuation">]</span>    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"jenkins/inbound-agent:4.11.2-4-alpine"</span>    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent"""<span class="token punctuation">,</span>) <span class="token punctuation">&#123;</span>    node(POD_NAME) <span class="token punctuation">&#123;</span>        container("runner") <span class="token punctuation">&#123;</span>            stage("Checkout") <span class="token punctuation">&#123;</span>                retry(10) <span class="token punctuation">&#123;</span>                    checkout(<span class="token punctuation">[</span>                        <span class="token key atrule">$class</span><span class="token punctuation">:</span> <span class="token string">'GitSCM'</span><span class="token punctuation">,</span>                        <span class="token key atrule">branches</span><span class="token punctuation">:</span> scm.branches<span class="token punctuation">,</span>                        <span class="token key atrule">doGenerateSubmoduleConfigurations</span><span class="token punctuation">:</span> scm.doGenerateSubmoduleConfigurations<span class="token punctuation">,</span>                        <span class="token key atrule">extensions</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token key atrule">$class</span><span class="token punctuation">:</span> <span class="token string">'CloneOption'</span><span class="token punctuation">,</span> <span class="token key atrule">noTags</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">shallow</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span class="token punctuation">,</span> <span class="token key atrule">depth</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token key atrule">reference</span><span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                        <span class="token key atrule">userRemoteConfigs</span><span class="token punctuation">:</span> scm.userRemoteConfigs<span class="token punctuation">,</span>                    <span class="token punctuation">]</span>)                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>            stage("Build") <span class="token punctuation">&#123;</span>                sh """                <span class="token comment"># make docker-build</span>                docker build <span class="token punctuation">-</span>t app<span class="token punctuation">:</span>v1.0.0<span class="token punctuation">-</span>alpha.1 .                """            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="readinessProbe"><a href="#readinessProbe" class="headerlink" title="readinessProbe"></a>readinessProbe</h3><p>æœ‰äº›æ—¶å€™ dind æ— æ³•æ­£å¸¸å¯åŠ¨ï¼Œæ‰€ä»¥ä¸€å®šè¦è®¾ç½®å°±ç»ªæ¢é’ˆï¼Œæ¥ç¡®ä¿ diind å®¹å™¨èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>  <span class="token key atrule">exec</span><span class="token punctuation">:</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"docker"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">]</span>  <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>  <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="2375-x2F-2376-ç«¯å£"><a href="#2375-x2F-2376-ç«¯å£" class="headerlink" title="2375&#x2F;2376 ç«¯å£"></a>2375&#x2F;2376 ç«¯å£</h3><p>docker é»˜è®¤æ˜¯ä»¥ TLS æ–¹å¼å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ä¸º 2376ï¼Œå¦‚æœè®¾ç½®ç¯å¢ƒå˜é‡ <code>DOCKER_TLS_CERTDIR</code> ä¸ºç©ºåˆ™å°±ä»¥é TLS æ¨¡å¼å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ä¸º 2375ï¼Œè¿™æ—¶å°±ä¸ä¼šæ ¡éªŒ TLS è¯ä¹¦ã€‚å¦‚æœä½¿ç”¨ 2376 ç«¯å£ï¼Œåˆ™å°±éœ€è¦ä¸€ä¸ªæŒä¹…åŒ–å­˜å‚¨æ¥å°† docker ç”Ÿæˆçš„è¯ä¹¦å…±äº«ç»™å®¢æˆ·ç«¯ï¼Œè¿™ç‚¹æ¯”è¾ƒéº»çƒ¦ã€‚å› æ­¤å¦‚æœä¸æƒ³çæŠ˜è…¾è¿˜æ˜¯ä½¿ç”¨ 2375 é TLS æ–¹å¼å§ ğŸ˜‚ã€‚</p><h3 id="dinp-å¿…é¡»ä»¥å¼€å¯-privileged-true"><a href="#dinp-å¿…é¡»ä»¥å¼€å¯-privileged-true" class="headerlink" title="dinp å¿…é¡»ä»¥å¼€å¯ privileged: true"></a>dinp å¿…é¡»ä»¥å¼€å¯ privileged: true</h3><p>ä»¥ pod æ–¹å¼è¿è¡Œ dockerï¼Œæ— è®ºæ˜¯å¦æ˜¯ rootless æ¨¡å¼ï¼Œéƒ½è¦åœ¨ pod å®¹å™¨çš„ <code>securityContext</code> ä¸­è®¾ç½® <code>privileged: true</code>ï¼Œå¦åˆ™ pod æ— æ³•æ­£å¸¸å¯åŠ¨ã€‚è€Œä¸” rootless æ¨¡å¼ä¹Ÿæœ‰ä¸€å®šçš„é™åˆ¶ï¼Œéœ€è¦ä¾èµ–ä¸€äº›å†…æ ¸çš„ç‰¹æ€§ï¼Œç›®å‰ä¹Ÿåªæ˜¯å®éªŒé˜¶æ®µï¼Œæ²¡æœ‰ç‰¹æ®Šçš„éœ€æ±‚è¿˜æ˜¯å°½é‡ä¸è¦ä½¿ç”¨ rootless ç‰¹æ€§å§ã€‚</p><pre class="line-numbers language-none"><code class="language-none">[root@localhost ~]# kubectl logs -f dinp-sidecarerror: a container name must be specified for pod dinp-sidecar, choose one of: [debug dind][root@localhost ~]# kubectl logs -f dinp-sidecar -c dindDevice &quot;ip_tables&quot; does not exist.ip_tables              27126  4 iptable_raw,iptable_mangle,iptable_filter,iptable_natmodprobe: can&#39;t change directory to &#39;&#x2F;lib&#x2F;modules&#39;: No such file or directoryWARN[0000] failed to mount sysfs, falling back to read-only mount: operation not permittedWARN[0000] failed to mount sysfs: operation not permittedopen: No such file or directory[rootlesskit:child ] error: executing [[ip tuntap add name tap0 mode tap] [ip link set tap0 address 02:50:00:00:00:01]]: exit status 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="rootless-user-max-user-namespaces"><a href="#rootless-user-max-user-namespaces" class="headerlink" title="rootless user.max_user_namespaces"></a>rootless user.max_user_namespaces</h3><p>rootless æ¨¡å¼ä¸‹éœ€è¦ä¾èµ–ä¸€äº›å†…æ ¸å‚æ•° <a href="https://docs.docker.com/engine/security/rootless/">Run the Docker daemon as a non-root user (Rootless mode)</a>ã€‚åœ¨ CentOS 7.9 ä¸Šä¼šå‡ºç° <a href="https://github.com/docker-library/docker/issues/201">dind-rootless: failed to start up dind rootless in k8s due to max_user_namespaces</a> é—®é¢˜ã€‚è§£å†³æ–¹æ¡ˆæ˜¯åœ¨ä¿®æ”¹ä¸€ä¸‹ <code>user.max_user_namespaces=28633</code> å†…æ ¸å‚æ•°ã€‚</p><blockquote><p>Add user.max_user_namespaces&#x3D;28633 to &#x2F;etc&#x2F;sysctl.conf (or &#x2F;etc&#x2F;sysctl.d) and run sudo sysctl -p</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -w</span>NAME                              READY   STATUS   RESTARTS     AGEdinp-deployment-cf488bfd8-g8vxx   <span class="token number">0</span>/1     CrashLoopBackOff   <span class="token number">1</span> <span class="token punctuation">(</span>2s ago<span class="token punctuation">)</span>   4s<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># kubectl logs -f dinp-deployment-cf488bfd8-m5cms</span>Device <span class="token string">"ip_tables"</span> does not exist.ip_tables              <span class="token number">27126</span>  <span class="token number">5</span> iptable_raw,iptable_mangle,iptable_filter,iptable_natmodprobe: can<span class="token string">'t change directory to '</span>/lib/modules<span class="token string">': No such file or directoryerror: attempting to run rootless dockerd but need '</span>user.max_user_namespaces' <span class="token punctuation">(</span>/proc/sys/user/max_user_namespaces<span class="token punctuation">)</span> <span class="token builtin class-name">set</span> to a sufficiently large value<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é-rootless-æ¨¡å¼ä¸‹åŒä¸€-node-èŠ‚ç‚¹åªèƒ½è¿è¡Œä¸€ä¸ª-dinp"><a href="#é-rootless-æ¨¡å¼ä¸‹åŒä¸€-node-èŠ‚ç‚¹åªèƒ½è¿è¡Œä¸€ä¸ª-dinp" class="headerlink" title="é rootless æ¨¡å¼ä¸‹åŒä¸€ node èŠ‚ç‚¹åªèƒ½è¿è¡Œä¸€ä¸ª dinp"></a>é rootless æ¨¡å¼ä¸‹åŒä¸€ node èŠ‚ç‚¹åªèƒ½è¿è¡Œä¸€ä¸ª dinp</h3><p>å¦‚æœæ˜¯ä½¿ç”¨ deployment æ–¹å¼éƒ¨ç½² dinpï¼Œä¸€ä¸ª node èŠ‚ç‚¹ä¸Šåªèƒ½æœ‰ä¸€ä¸ª dinp Podï¼Œå¤šä½™çš„ Pod æ— æ³•æ­£å¸¸å¯åŠ¨ã€‚å› æ­¤å¦‚æœæƒ³è¦è¿è¡Œå¤šä¸ª dinp Podï¼Œå»ºè®®ä½¿ç”¨ daemonset æ–¹å¼è¿è¡Œå®ƒï¼›</p><pre class="line-numbers language-none"><code class="language-none">[root@localhost ~]# kubectl get deployNAME              READY   UP-TO-DATE   AVAILABLE   AGEdinp-deployment   1&#x2F;3     3            1           4m16s[root@localhost ~]# kubectl get pod -wNAME                               READY   STATUS    RESTARTS      AGEdinp-deployment-547bd9bb6d-2mn6c   0&#x2F;1     Running   3 (61s ago)   4m9sdinp-deployment-547bd9bb6d-8ht8l   1&#x2F;1     Running   0             4m9sdinp-deployment-547bd9bb6d-x5vpv   0&#x2F;1     Running   3 (61s ago)   4m9s[root@localhost ~]# kubectl logs -f dinp-deployment-547bd9bb6d-2mn6cINFO[2022-03-14T14:14:10.905652548Z] Starting upWARN[2022-03-14T14:14:10.906986721Z] could not change group &#x2F;var&#x2F;run&#x2F;docker.sock to docker: group docker not foundWARN[2022-03-14T14:14:10.907249071Z] Binding to IP address without --tlsverify is insecure and gives root access on this machine to everyone who has access to your network.  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;WARN[2022-03-14T14:14:10.907269951Z] Binding to an IP address, even on localhost, can also give access to scripts run in a browser. Be safe out there!  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;WARN[2022-03-14T14:14:11.908057635Z] Binding to an IP address without --tlsverify is deprecated. Startup is intentionally being slowed down to show this message  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;WARN[2022-03-14T14:14:11.908103696Z] Please consider generating tls certificates with client validation to prevent exposing unauthenticated root access to your network  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;WARN[2022-03-14T14:14:11.908114541Z] You can override this by explicitly specifying &#39;--tls&#x3D;false&#39; or &#39;--tlsverify&#x3D;false&#39;  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;WARN[2022-03-14T14:14:11.908125477Z] Support for listening on TCP without authentication or explicit intent to run without authentication will be removed in the next release  host&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:2375&quot;INFO[2022-03-14T14:14:26.914587276Z] libcontainerd: started new containerd process  pid&#x3D;41INFO[2022-03-14T14:14:26.914697125Z] parsed scheme: &quot;unix&quot;                         module&#x3D;grpcINFO[2022-03-14T14:14:26.914710376Z] scheme &quot;unix&quot; not registered, fallback to default scheme  module&#x3D;grpcINFO[2022-03-14T14:14:26.914785052Z] ccResolverWrapper: sending update to cc: &#123;[&#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;] &lt;nil&gt; &lt;nil&gt;&#125;  module&#x3D;grpcINFO[2022-03-14T14:14:26.914796039Z] ClientConn switching balancer to &quot;pick_first&quot;  module&#x3D;grpcINFO[2022-03-14T14:14:26.930311832Z] starting containerd                           revision&#x3D;7b11cfaabd73bb80907dd23182b9347b4245eb5d version&#x3D;v1.4.12INFO[2022-03-14T14:14:26.953641900Z] loading plugin &quot;io.containerd.content.v1.content&quot;...  type&#x3D;io.containerd.content.v1INFO[2022-03-14T14:14:26.953721059Z] loading plugin &quot;io.containerd.snapshotter.v1.aufs&quot;...  type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960295816Z] skip loading plugin &quot;io.containerd.snapshotter.v1.aufs&quot;...  error&#x3D;&quot;aufs is not supported (modprobe aufs failed: exit status 1 \&quot;ip: can&#39;t find device &#39;aufs&#39;\\nmodprobe: can&#39;t change directory to &#39;&#x2F;lib&#x2F;modules&#39;: No such file or directory\\n\&quot;): skip plugin&quot; type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960329840Z] loading plugin &quot;io.containerd.snapshotter.v1.btrfs&quot;...  type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960524514Z] skip loading plugin &quot;io.containerd.snapshotter.v1.btrfs&quot;...  error&#x3D;&quot;path &#x2F;var&#x2F;lib&#x2F;docker&#x2F;containerd&#x2F;daemon&#x2F;io.containerd.snapshotter.v1.btrfs (xfs) must be a btrfs filesystem to be used with the btrfs snapshotter: skip plugin&quot; type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960537441Z] loading plugin &quot;io.containerd.snapshotter.v1.devmapper&quot;...  type&#x3D;io.containerd.snapshotter.v1WARN[2022-03-14T14:14:26.960558843Z] failed to load plugin io.containerd.snapshotter.v1.devmapper  error&#x3D;&quot;devmapper not configured&quot;INFO[2022-03-14T14:14:26.960569516Z] loading plugin &quot;io.containerd.snapshotter.v1.native&quot;...  type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960593224Z] loading plugin &quot;io.containerd.snapshotter.v1.overlayfs&quot;...  type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960678728Z] loading plugin &quot;io.containerd.snapshotter.v1.zfs&quot;...  type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960814844Z] skip loading plugin &quot;io.containerd.snapshotter.v1.zfs&quot;...  error&#x3D;&quot;path &#x2F;var&#x2F;lib&#x2F;docker&#x2F;containerd&#x2F;daemon&#x2F;io.containerd.snapshotter.v1.zfs must be a zfs filesystem to be used with the zfs snapshotter: skip plugin&quot; type&#x3D;io.containerd.snapshotter.v1INFO[2022-03-14T14:14:26.960827133Z] loading plugin &quot;io.containerd.metadata.v1.bolt&quot;...  type&#x3D;io.containerd.metadata.v1WARN[2022-03-14T14:14:26.960839223Z] could not use snapshotter devmapper in metadata plugin  error&#x3D;&quot;devmapper not configured&quot;INFO[2022-03-14T14:14:26.960848698Z] metadata content store policy set             policy&#x3D;sharedWARN[2022-03-14T14:14:27.915528371Z] grpc: addrConn.createTransport failed to connect to &#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;. Err :connection error: desc &#x3D; &quot;transport: error while dialing: dial unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock: timeout&quot;. Reconnecting...  module&#x3D;grpcWARN[2022-03-14T14:14:30.722257725Z] grpc: addrConn.createTransport failed to connect to &#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;. Err :connection error: desc &#x3D; &quot;transport: error while dialing: dial unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock: timeout&quot;. Reconnecting...  module&#x3D;grpcWARN[2022-03-14T14:14:35.549453706Z] grpc: addrConn.createTransport failed to connect to &#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;. Err :connection error: desc &#x3D; &quot;transport: error while dialing: dial unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock: timeout&quot;. Reconnecting...  module&#x3D;grpcWARN[2022-03-14T14:14:41.759010407Z] grpc: addrConn.createTransport failed to connect to &#123;unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock  &lt;nil&gt; 0 &lt;nil&gt;&#125;. Err :connection error: desc &#x3D; &quot;transport: error while dialing: dial unix:&#x2F;&#x2F;&#x2F;var&#x2F;run&#x2F;docker&#x2F;containerd&#x2F;containerd.sock: timeout&quot;. Reconnecting...  module&#x3D;grpcfailed to start containerd: timeout waiting for containerd to start<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="x2F-var-x2F-lib-x2F-docker-ä¸æ”¯æŒå…±äº«å­˜å‚¨"><a href="#x2F-var-x2F-lib-x2F-docker-ä¸æ”¯æŒå…±äº«å­˜å‚¨" class="headerlink" title="&#x2F;var&#x2F;lib&#x2F;docker ä¸æ”¯æŒå…±äº«å­˜å‚¨"></a>&#x2F;var&#x2F;lib&#x2F;docker ä¸æ”¯æŒå…±äº«å­˜å‚¨</h3><p>é™ˆå°‘æ–‡åšä¸»æ›¾åœ¨ ã€Š<a href="https://www.chenshaowen.com/blog/can-we-mount-var-lib-docker-to-remote-storage.html">&#x2F;var&#x2F;lib&#x2F;docker èƒ½ä¸èƒ½æŒ‚è½½è¿œç«¯å­˜å‚¨</a>ã€‹æåˆ°è¿‡ docker ç›®å‰å¹¶æ”¯æŒå°† <code>/var/lib/docker</code> æŒ‚è½½è¿œç¨‹å­˜å‚¨ä½¿ç”¨ï¼Œå› æ­¤å»ºè®®ä½¿ç”¨ hostPath çš„æ–¹å¼ä¿å­˜ docker çš„æŒä¹…åŒ–å­˜å‚¨æ•°æ®ã€‚</p><blockquote><p>æœ¬æ¬¡æµ‹è¯•ä½¿ç”¨çš„ Docker ç‰ˆæœ¬ä¸º 20.10.6ï¼Œä¸èƒ½å°† <code>/var/lib/docker</code> æŒ‚è½½è¿œç¨‹å­˜å‚¨ä½¿ç”¨ã€‚ä¸»è¦åŸå› æ˜¯å®¹å™¨çš„å®ç°ä¾èµ–äºå†…æ ¸çš„èƒ½åŠ›(xttrs)ï¼Œè€Œç±»ä¼¼ NFS Server è¿™ç§è¿œç¨‹å­˜å‚¨æ— æ³•æä¾›è¿™äº›èƒ½åŠ›ã€‚å¦‚æœé‡‡ç”¨ Device Mapper è¿›è¡Œæ˜ å°„ï¼Œä½¿ç”¨ç£ç›˜æŒ‚è½½å­˜åœ¨å¯è¡Œæ€§ï¼Œä½†åªèƒ½ç”¨äºè¿ç§»è€Œä¸èƒ½å®ç°å…±äº«ã€‚</p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">INFO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.750810130Z<span class="token punctuation">]</span> ClientConn switching balancer to <span class="token string">"pick_first"</span>  <span class="token assign-left variable">module</span><span class="token operator">=</span>grpcERRO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.781932359Z<span class="token punctuation">]</span> failed to <span class="token function">mount</span> overlay: invalid argument     storage-driver<span class="token operator">=</span>overlay2ERRO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.782078828Z<span class="token punctuation">]</span> exec: <span class="token string">"fuse-overlayfs"</span><span class="token builtin class-name">:</span> executable <span class="token function">file</span> not found <span class="token keyword">in</span> <span class="token environment constant">$PATH</span>  storage-driver<span class="token operator">=</span>fuse-overlayfsERRO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.793311119Z<span class="token punctuation">]</span> AUFS was not found <span class="token keyword">in</span> /proc/filesystems       storage-driver<span class="token operator">=</span>aufsERRO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.813505621Z<span class="token punctuation">]</span> failed to <span class="token function">mount</span> overlay: invalid argument     storage-driver<span class="token operator">=</span>overlayERRO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.813529990Z<span class="token punctuation">]</span> Failed to built-in GetDriver graph devicemapper /var/lib/dockerINFO<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.897769363Z<span class="token punctuation">]</span> Loading containers: start.WARN<span class="token punctuation">[</span><span class="token number">2022</span>-03-13T13:43:08.919252078Z<span class="token punctuation">]</span> Running modprobe bridge br_netfilter failed with message: ip: can<span class="token string">'t find device '</span>bridge'<span class="token punctuation">[</span>root@localhost dinp<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it dinp-sidecar -c debug sh</span>/ <span class="token comment"># docker pull alpine</span>Using default tag: latestError response from daemon: error creating temporary lease: <span class="token function">file</span> resize error: truncate /var/lib/docker/containerd/daemon/io.containerd.metadata.v1.bolt/meta.db: bad <span class="token function">file</span> descriptor: unknown<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://www.bilibili.com/video/BV1Xa411C78k">Dockershim å³å°†è¢«ç§»é™¤ï¼Œä½ å‡†å¤‡å¥½äº†ä¹ˆï¼Ÿ</a></li><li><a href="https://draveness.me/whys-the-design-kubernetes-deprecate-docker/">ä¸ºä»€ä¹ˆ Kubernetes è¦æ›¿æ¢ Docker</a></li><li><a href="https://applatix.com/case-docker-docker-kubernetes-part-2">A case for Docker-in-Docker on Kubernetes</a></li><li><a href="https://docs.docker.com/engine/security/rootless/">Run the Docker daemon as a non-root user (Rootless mode)</a></li><li><a href="https://github.com/docker-library/docker">Docker Official Image packaging for Docker</a></li><li><a href="https://www.chenshaowen.com/blog/can-we-mount-var-lib-docker-to-remote-storage.html">&#x2F;var&#x2F;lib&#x2F;docker èƒ½ä¸èƒ½æŒ‚è½½è¿œç«¯å­˜å‚¨</a></li><li><a href="https://www.chenshaowen.com/blog/how-to-use-docker-in-docker.html">å¦‚ä½•åœ¨ Docker ä¸­ä½¿ç”¨ Docker</a></li><li><a href="https://www.chenshaowen.com/blog/using-podman-to-build-images-under-kubernetes-and-jenkins.html">åŸºäº Kubernetes çš„ Jenkins æœåŠ¡ä¹Ÿå¯ä»¥å» Docker äº†</a></li><li><a href="https://github.com/docker-library/docker/issues/201">dind-rootless: failed to start up dind rootless in k8s due to max_user_namespaces #201</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ä¸Šä¸ªæœˆå‚åŠ äº† Rancher ç¤¾åŒºä¸¾åŠçš„ ã€Š&lt;a
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubernetes" scheme="https://blog.k8s.li/tags/kubernetes/"/>
    
      <category term="docker" scheme="https://blog.k8s.li/tags/docker/"/>
    
      <category term="dind" scheme="https://blog.k8s.li/tags/dind/"/>
    
      <category term="dinp" scheme="https://blog.k8s.li/tags/dinp/"/>
    
      <category term="jenkins" scheme="https://blog.k8s.li/tags/jenkins/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ kubectl è‡ªåŠ¨å½’æ¡£ argo workflow æ—¥å¿—</title>
    <link href="https://blog.k8s.li/archive-argo-workflow-log-by-kubectl.html"/>
    <id>https://blog.k8s.li/archive-argo-workflow-log-by-kubectl.html</id>
    <published>2022-02-27T16:00:00.000Z</published>
    <updated>2022-02-27T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>é¡¹ç›®ä¸Šä½¿ç”¨åˆ° <a href="https://github.com/argoproj/argo-workflows">argo-workflow</a> ä½œä¸ºå·¥ä½œæµå¼•æ“æ¥ç¼–æ’è¿è¡Œä¸€äº› <a href="https://www.smartx.com/solution/virtualization/">è¶…èåˆ</a> é›†ç¾¤éƒ¨ç½²ç›¸å…³çš„ä»»åŠ¡ï¼Œæ•´å¥—ç¯å¢ƒè¿è¡Œåœ¨ä¸€ä¸ªå•èŠ‚ç‚¹çš„ K3s ä¸Šã€‚ä¹‹æ‰€ä»¥é€‰æ‹© argo-workflow + K3s çš„æ­é…ä¸»è¦æ˜¯æƒ³å°½å¯èƒ½å°‘åœ°å ç”¨ç³»ç»Ÿèµ„æºï¼Œå› ä¸ºè¿™å¥—ç¯å¢ƒå°†æ¥ä¼šè¿è¡Œåœ¨å„ç§ç¡¬ä»¶é…ç½®ä¸åŒçš„ç¬”è®°æœ¬ç”µè„‘ä¸Š ğŸ˜‚ã€‚ç»¼åˆè°ƒç ”äº†ä¸€äº›å¸¸è§çš„ K8s éƒ¨ç½²å·¥å…·æœ€ç»ˆå°±é€‰æ‹©äº†ç³»ç»Ÿèµ„æºå ç”¨è¾ƒå°‘çš„ K3sã€‚</p><p>ç°åœ¨é¡¹ç›®çš„ä¸€ä¸ªéœ€æ±‚å°±æ˜¯åœ¨é›†ç¾¤éƒ¨ç½²å®Œæˆæˆ–å¤±è´¥ä¹‹åéœ€è¦å°† workflow çš„æ—¥å¿—å½’æ¡£ä¿å­˜ä¸‹æ¥ã€‚è™½ç„¶å¯ä»¥åœ¨ workflow çš„ spec å­—æ®µä¸­ä½¿ç”¨ <code>archiveLogs: true</code> æ¥è®© argo å¸®æˆ‘ä»¬è‡ªåŠ¨å½’æ¡£æ—¥å¿—ï¼Œä½†è¿™ä¸ªç‰¹æ€§ä¾èµ–äºä¸€ä¸ª S3 å¯¹è±¡å­˜å‚¨ <a href="https://argoproj.github.io/argo-workflows/configure-artifact-repository/">Artifact Repository</a> ã€‚è¿™å°±æ„å‘³ç€è¿˜è¦å†éƒ¨ç½²ä¸€ä¸ªæ”¯æŒ S3 å¯¹è±¡å­˜å‚¨çš„ç»„ä»¶æ¯”å¦‚ <a href="https://min.io/">Minio</a> ï¼Œç›´æ¥æŠŠæˆ‘ç»™æ•´ä¸ä¼šäº† ğŸŒš</p><p><img data-src="https://p.k8s.li/2021-08-31-pass-tob-k8s-offline-deploy-2.jpeg"></p><p>å…¶å®å˜›è¿™ä¸ªéœ€æ±‚å¾ˆç®€å•çš„ï¼Œæˆ‘å°±æƒ³ä¿å­˜ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶è€Œå·²ï¼Œä½ è¿˜å†è®©æˆ‘å®‰è£…ä¸€ä¸ª <a href="https://min.io/">Minio</a>ï¼Œå®åœ¨æ˜¯å¤ªè¿‡åˆ†äº†ï¼æœ¬æ¥ç³»ç»Ÿçš„èµ„æºååˆ†æœ‰é™ï¼Œéœ€è¦å°½å¯èƒ½å‡å°‘å®‰è£…ä¸€äº›ä¸å¿…è¦ä¾èµ–ï¼Œä¸ºçš„å°±æ˜¯å°†èµ„æºåˆ©ç”¨ç‡å°†åˆ°æœ€ä½ã€‚ä½†ç°åœ¨ä¸ºäº†å½’æ¡£å­˜å‚¨ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶å‚¨è€Œå¤§åŠ¨å¹²æˆˆè£…ä¸€ä¸ª minio å®åœ¨æ˜¯ä¸åˆ’ç®—ã€‚è¿™å°±å¥½æ¯”ä½ è´¹äº†å¥½å¤§åŠŸå¤«éƒ¨ç½²ä¸€å¥— 3 èŠ‚ç‚¹çš„ kubernetes é›†ç¾¤ï¼Œç„¶è€Œå°±ä¸ºäº†è¿è¡Œä¸€ä¸ªé™æ€åšå®¢é‚£æ ·æ»‘ç¨½ ğŸ˜‚</p><blockquote class="twitter-tweet"><p lang="en" dir="ltr">Deployed my blog on Kubernetes <a href="https://t.co/XHXWLrmYO4">pic.twitter.com/XHXWLrmYO4</a></p>&mdash; For DevOps Eyes Only (@dexhorthy) <a href="https://twitter.com/dexhorthy/status/856639005462417409?ref_src=twsrc%5Etfw">April 24, 2017</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><p>å¯¹äºå’±è¿™ç§ <code>ç”¨ä¸èµ·</code> S3 å¯¹è±¡å­˜å‚¨çš„ç©·äººå®¶å­©å­ï¼Œè¿˜æ˜¯æƒ³ä¸€äº›å…¶ä»–åŠæ³•å§ï¼Œæ¯•ç«Ÿè‡ªå·±åŠ¨æ‰‹ä¸°è¡£è¶³é£Ÿã€‚</p><h2 id="kubectl"><a href="#kubectl" class="headerlink" title="kubectl"></a>kubectl</h2><p>å®ç°èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå¯¹äºå’±è¿™ç§ YAML å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œkubectl è‡ªç„¶å†ç†Ÿæ‚‰ä¸è¿‡äº†ã€‚æƒ³è¦è·å– workflow çš„æ—¥å¿—ï¼Œåªéœ€è¦é€šè¿‡ kubectl logs å‘½ä»¤è·å–å‡º workflow æ‰€åˆ›çš„ pod æ—¥å¿—å°±è¡Œäº†å‘€ï¼Œè¦ä»€ä¹ˆ S3 å¯¹è±¡å­˜å‚¨ ğŸ˜–</p><h3 id="ç­›é€‰-pod"><a href="#ç­›é€‰-pod" class="headerlink" title="ç­›é€‰ pod"></a>ç­›é€‰ pod</h3><p>å¯¹äºåŒä¸€ä¸ª workflow æ¥å°†ï¼Œæ¯ä¸ª stage æ‰€åˆ›å»ºå‡ºæ¥çš„ pod name æœ‰ä¸€å®šçš„è§„å¾‹ã€‚åœ¨å®šä¹‰ workflow çš„æ—¶å€™ï¼Œ<a href="https://argoproj.github.io/argo-workflows/fields/#objectmeta">generateName</a> å‚æ•°é€šå¸¸ä½¿ç”¨ <code>$&#123;name&#125;-</code> æ ¼å¼ã€‚ä»¥ <code>-</code> ä½œä¸ºåˆ†éš”ç¬¦ï¼Œæœ€åä¸€ä¸ªå­—æ®µæ˜¯éšæœºç”Ÿæˆçš„ä¸€ä¸ªæ•°å­— IDï¼Œå€’æ•°ç¬¬äºŒä¸ªå­—æ®µåˆ™æ˜¯ argo éšæœºç”Ÿæˆçš„ workflow IDï¼Œå‰©ä½™å‰é¢çš„å­—ç¬¦åˆ™æ˜¯æˆ‘ä»¬å®šä¹‰çš„ generateNameã€‚</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Workflow<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">generateName</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">archive-log-test-jzt8n-3498199655                          <span class="token number">0</span>/2     Completed   <span class="token number">0</span>               4m18sarchive-log-test-jzt8n-3618624526                          <span class="token number">0</span>/2     Completed   <span class="token number">0</span>               4m8sarchive-log-test-jzt8n-2123203324                          <span class="token number">0</span>/2     Completed   <span class="token number">0</span>               3m58s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>åœ¨ pod çš„ labels ä¸­åŒæ ·ä¹ŸåŒ…å«ç€è¯¥ workflow æ‰€å¯¹åº”çš„ IDï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ ¹æ®æ­¤ labels è¿‡æ»¤å‡ºè¯¥ workflow æ‰€åˆ›å»ºå‡ºæ¥çš„ podã€‚</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">workflows.argoproj.io/node-id</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span>jzt8n<span class="token punctuation">-</span><span class="token number">3498199655</span>    <span class="token key atrule">workflows.argoproj.io/node-name</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span>jzt8n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.list<span class="token punctuation">-</span>default<span class="token punctuation">-</span>running<span class="token punctuation">-</span>pods  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2022-02-28T12:53:32Z"</span>  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">workflows.argoproj.io/completed</span><span class="token punctuation">:</span> <span class="token string">"true"</span>    <span class="token key atrule">workflows.argoproj.io/workflow</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span>jzt8n  <span class="token key atrule">name</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span>jzt8n<span class="token punctuation">-</span><span class="token number">3498199655</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default  <span class="token key atrule">ownerReferences</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1    <span class="token key atrule">blockOwnerDeletion</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">controller</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Workflow    <span class="token key atrule">name</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span>jzt8n    <span class="token key atrule">uid</span><span class="token punctuation">:</span> e91df2cb<span class="token punctuation">-</span>b567<span class="token punctuation">-</span>4cf0<span class="token punctuation">-</span>9be5<span class="token punctuation">-</span>3dd6c72854cd  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"1251330"</span>  <span class="token key atrule">uid</span><span class="token punctuation">:</span> ce37a709<span class="token punctuation">-</span>8236<span class="token punctuation">-</span>445b<span class="token punctuation">-</span>8d00<span class="token punctuation">-</span>a7926fa18ed0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é€šè¿‡ <code>-l lables</code> è¿‡æ»¤å‡ºä¸€ä¸ª workflow æ‰€åˆ›å»ºçš„ podï¼›é€šè¿‡ <code>--sort-by</code> ä»¥åˆ›å»ºæ—¶é—´è¿›è¡Œæ’åºï¼›é€šè¿‡ <code>-o name</code> åªè¾“å‡º pod çš„ nameï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl get pods -l workflows.argoproj.io/workflow<span class="token operator">=</span>archive-log-test-jzt8n --sort-by<span class="token operator">=</span><span class="token string">'.metadata.creationTimestamp'</span> -o namepod/archive-log-test-jzt8n-3498199655pod/archive-log-test-jzt8n-3618624526pod/archive-log-test-jzt8n-2123203324<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="è·å–æ—¥å¿—"><a href="#è·å–æ—¥å¿—" class="headerlink" title="è·å–æ—¥å¿—"></a>è·å–æ—¥å¿—</h3><p>é€šè¿‡ä¸Šé¢çš„æ­¥éª¤æˆ‘ä»¬å°±å¯ä»¥è·å–åˆ°ä¸€ä¸ª workflow æ‰€åˆ›å»ºçš„ pod åˆ—è¡¨ã€‚ç„¶åå†é€šè¿‡ kubectl logs å‘½ä»¤è·å– pod ä¸­ main å®¹å™¨çš„æ—¥å¿—ï¼Œä¸ºæ–¹ä¾¿åŒºåˆ†æ—¥å¿—çš„æ‰€å¯¹åº”çš„ workflow ï¼Œæˆ‘ä»¬å°±ä»¥ workflow çš„ ID ä¸ºå‰ç¼€åã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ kubectl logs archive-log-test-jzt8n-3618624526 -c main<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">LOG_PATH</span><span class="token operator">=</span>/var/log<span class="token assign-left variable">NAME</span><span class="token operator">=</span>archive-log-test-jzt8nkubectl get pods -l workflows.argoproj.io/workflow<span class="token operator">=</span><span class="token variable">$&#123;NAME&#125;</span> <span class="token punctuation">\</span>--sort-by<span class="token operator">=</span><span class="token string">'.metadata.creationTimestamp'</span> -o name <span class="token punctuation">\</span><span class="token operator">|</span> <span class="token function">xargs</span> -I <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> -t kubectl logs <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> -c main <span class="token operator">>></span> <span class="token variable">$&#123;LOG_PATH&#125;</span>/<span class="token variable">$&#123;NAME&#125;</span>.log<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="workflow"><a href="#workflow" class="headerlink" title="workflow"></a>workflow</h3><p>æ ¹æ® argo-workflow å®˜æ–¹æä¾›çš„ <a href="https://github.com/argoproj/argo-workflows/blob/master/examples/exit-handlers.yaml"><strong>exit-handlers.yaml</strong></a> exampleï¼Œæˆ‘ä»¬å°±ç…§è‘«èŠ¦ç”»ç“¢æ“ä¸€ä¸ª workflow é€€å‡ºåè‡ªåŠ¨è°ƒç”¨ä½¿ç”¨ kubectl è·å– workflow æ—¥å¿—çš„ä¸€ä¸ª stepï¼Œå®šä¹‰çš„ exit-handler å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> exit<span class="token punctuation">-</span>handler    <span class="token key atrule">container</span><span class="token punctuation">:</span>      <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"kubectl"</span>      <span class="token key atrule">image</span><span class="token punctuation">:</span> lachlanevenson/k8s<span class="token punctuation">-</span>kubectl<span class="token punctuation">:</span>v1.23.2      <span class="token key atrule">command</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> sh        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">          kubectl get pods -l workflows.argoproj.io/workflow=$&#123;POD_NAME%-*&#125; \          --sort-by=".metadata.creationTimestamp" -o name | grep -v $&#123;POD_NAME&#125; \          | xargs -I &#123;&#125; -t kubectl logs &#123;&#125; -c main >> $&#123;LOG_PATH&#125;/$&#123;POD_NAME%-*&#125;.log</span>      <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>              <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> LOG_PATH          <span class="token key atrule">value</span><span class="token punctuation">:</span> /var/log/workflow      <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>datastore          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/workflow    <span class="token key atrule">retryStrategy</span><span class="token punctuation">:</span>      <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token string">"5"</span>      <span class="token key atrule">retryPolicy</span><span class="token punctuation">:</span> OnFailure<span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> default<span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>datastore    <span class="token key atrule">nfs</span><span class="token punctuation">:</span>      <span class="token key atrule">server</span><span class="token punctuation">:</span> NFS_SERVER      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/workflow/log<span class="token key atrule">onExit</span><span class="token punctuation">:</span> exit<span class="token punctuation">-</span>handler<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å°†ä¸Šè¿°å®šä¹‰çš„ <code>exit-handler</code> å†…å®¹å¤åˆ¶ç²˜è´´åˆ°ä½ çš„ workflow spec é…ç½®ä¸­å°±å¯ä»¥ã€‚ç”±äºæ—¥å¿—éœ€è¦æŒä¹…åŒ–å­˜å‚¨ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ NFS å­˜å‚¨ï¼Œä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦æ¢æˆå…¶ä»–å­˜å‚¨ï¼Œåªéœ€è¦ä¿®æ”¹ä¸€ä¸‹ <code>volumes</code> é…ç½®å³å¯ã€‚</p><p>å®Œæ•´çš„ <a href="https://gist.github.com/muzi502/9b26c6854c509c42ecd7f7004436ca23">workflow example</a> å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Workflow<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">generateName</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test<span class="token punctuation">-</span>  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">templates</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test      <span class="token key atrule">steps</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> list<span class="token punctuation">-</span>default<span class="token punctuation">-</span>running<span class="token punctuation">-</span>pods            <span class="token key atrule">template</span><span class="token punctuation">:</span> kubectl            <span class="token key atrule">arguments</span><span class="token punctuation">:</span>              <span class="token key atrule">parameters</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> namespace                  <span class="token key atrule">value</span><span class="token punctuation">:</span> default        <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> list<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>system<span class="token punctuation">-</span>running<span class="token punctuation">-</span>pods            <span class="token key atrule">template</span><span class="token punctuation">:</span> kubectl            <span class="token key atrule">arguments</span><span class="token punctuation">:</span>              <span class="token key atrule">parameters</span><span class="token punctuation">:</span>                <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> namespace                  <span class="token key atrule">value</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubectl      <span class="token key atrule">inputs</span><span class="token punctuation">:</span>        <span class="token key atrule">parameters</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> namespace      <span class="token key atrule">container</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"kubectl"</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> lachlanevenson/k8s<span class="token punctuation">-</span>kubectl<span class="token punctuation">:</span>v1.23.2        <span class="token key atrule">command</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> sh          <span class="token punctuation">-</span> <span class="token punctuation">-</span>c          <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">            kubectl get pods --field-selector=status.phase=Running -n &#123;&#123;inputs.parameters.namespace&#125;&#125;</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> exit<span class="token punctuation">-</span>handler      <span class="token key atrule">container</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">"kubectl"</span>        <span class="token key atrule">image</span><span class="token punctuation">:</span> lachlanevenson/k8s<span class="token punctuation">-</span>kubectl<span class="token punctuation">:</span>v1.23.2        <span class="token key atrule">command</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> sh          <span class="token punctuation">-</span> <span class="token punctuation">-</span>c          <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">            kubectl get pods -l workflows.argoproj.io/workflow=$&#123;POD_NAME%-*&#125; \            --sort-by=".metadata.creationTimestamp" -o name | grep -v $&#123;POD_NAME&#125; \            | xargs -I &#123;&#125; -t kubectl logs &#123;&#125; -c main >> $&#123;LOG_PATH&#125;/$&#123;POD_NAME%-*&#125;.log</span>        <span class="token key atrule">env</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME            <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>              <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> LOG_PATH            <span class="token key atrule">value</span><span class="token punctuation">:</span> /var/log/workflow        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>datastore            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/log/workflow      <span class="token key atrule">retryStrategy</span><span class="token punctuation">:</span>        <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token string">"5"</span>        <span class="token key atrule">retryPolicy</span><span class="token punctuation">:</span> OnFailure  <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> archive<span class="token punctuation">-</span>log<span class="token punctuation">-</span>test  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> default  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>datastore      <span class="token key atrule">nfs</span><span class="token punctuation">:</span>        <span class="token key atrule">server</span><span class="token punctuation">:</span> NFS_SERVER        <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/workflow/log  <span class="token key atrule">onExit</span><span class="token punctuation">:</span> exit<span class="token punctuation">-</span>handler<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;é¡¹ç›®ä¸Šä½¿ç”¨åˆ° &lt;a
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubectl" scheme="https://blog.k8s.li/tags/kubectl/"/>
    
      <category term="argo-workflow" scheme="https://blog.k8s.li/tags/argo-workflow/"/>
    
  </entry>
  
  <entry>
    <title>VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ</title>
    <link href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html"/>
    <id>https://blog.k8s.li/deploy-tanzu-k8s-cluster.html</id>
    <published>2022-02-05T16:00:00.000Z</published>
    <updated>2022-02-05T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰æ¥è§¦çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·å¤§å¤šæ•°éƒ½æ˜¯ä¾èµ–äº ssh è¿æ¥åˆ°å¾…éƒ¨ç½²çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œéƒ¨ç½²æ“ä½œï¼Œè¿™æ ·å°±è¦æ±‚éƒ¨ç½²å‰éœ€è¦æå‰å‡†å¤‡å¥½é›†ç¾¤èŠ‚ç‚¹ï¼Œä¸”è¦ä¿è¯è¿™äº›èŠ‚ç‚¹çš„ç½‘ç»œäº’é€šä»¥åŠæ—¶é’ŸåŒæ­¥ç­‰é—®é¢˜ã€‚ç±»ä¼¼äº kubespray æˆ–è€… kubekey è¿™äº›éƒ¨ç½²å·¥å…·æ˜¯ä¸ä¼šå»ç®¡è¿™äº›åº•å±‚çš„ IaaS èµ„æºçš„åˆ›å»ºï¼Œæ˜¯è¦è‡ªå·±æå‰å‡†å¤‡å¥½ã€‚ä½†æ˜¯åœ¨ä¸€äº›ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒä¸­ï¼Œä½¿ç”¨äº†å¦‚ <a href="https://docs.vmware.com/cn/VMware-vSphere/index.html">VMware vShpere</a> æˆ– <a href="https://www.openstack.org/">OpenStack</a> è¿™äº›è™šæ‹ŸåŒ–å¹³å°ï¼Œæ˜¯å¯ä»¥å°† K8s é›†ç¾¤éƒ¨ç½²ä¸ IaaS èµ„æºåˆ›å»ºè¿™ä¸¤æ­¥ç»Ÿä¸€èµ·æ¥çš„ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æ‰‹åŠ¨åˆ›å»ºå’Œé…ç½®è™šæ‹Ÿæœºè¿™äº›ç¹ççš„æ­¥éª¤ã€‚</p><p>ç›®å‰å°† IaaS èµ„æºåˆ›å»ºä¸ K8s é›†ç¾¤éƒ¨ç½²ç»“åˆèµ·æ¥ä¹Ÿæœ‰æ¯”è¾ƒæˆç†Ÿçš„æ–¹æ¡ˆï¼Œæ¯”å¦‚åŸºäº <a href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> é¡¹ç›®çš„ <a href="https://github.com/vmware-tanzu">tanzu</a> ã€‚æœ¬æ–‡å°±ä»¥ <a href="https://github.com/vmware-tanzu/community-edition">VMware Tanzu ç¤¾åŒºç‰ˆ</a> ä¸ºä¾‹åœ¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šï¼Œä»å®‰è£… ESXi OS åˆ°éƒ¨ç½²å®Œæˆ Tanzu Workload é›†ç¾¤ï¼Œæ¥ä½“éªŒä¸€ä¸‹è¿™ç§éƒ¨ç½²æ–¹æ¡ˆçš„ä¸ä¼—ä¸åŒä¹‹å¤„ã€‚</p><h2 id="éƒ¨ç½²æµç¨‹"><a href="#éƒ¨ç½²æµç¨‹" class="headerlink" title="éƒ¨ç½²æµç¨‹"></a>éƒ¨ç½²æµç¨‹</h2><ul><li>ä¸‹è½½ä¾èµ–æ–‡ä»¶</li><li>å®‰è£… govc ä¾èµ–</li><li>å®‰è£… ESXi OS</li><li>å®‰è£… vCenter</li><li>é…ç½® vCenter</li><li>åˆ›å»º bootstrap è™šæ‹Ÿæœº</li><li>åˆå§‹åŒ– bootstrap èŠ‚ç‚¹</li><li>éƒ¨ç½² Tanzu Manager é›†ç¾¤</li><li>éƒ¨ç½² Tanzu Workload é›†ç¾¤</li></ul><h3 id="åŠé€€ä¸‰è¿-ğŸ˜‚"><a href="#åŠé€€ä¸‰è¿-ğŸ˜‚" class="headerlink" title="åŠé€€ä¸‰è¿ ğŸ˜‚"></a>åŠé€€ä¸‰è¿ ğŸ˜‚</h3><ul><li>éœ€è¦æœ‰ä¸€ä¸ª <a href="https://customerconnect.vmware.com/login">VMware çš„è´¦æˆ·</a> ç”¨äºä¸‹è½½ä¸€äº› ISO é•œåƒå’Œè™šæ‹Ÿæœºæ¨¡ç‰ˆ;</li><li>éœ€è¦æœ‰ä¸€å°ç‰©ç†æœåŠ¡å™¨ï¼Œæ¨èæœ€ä½é…ç½® 8C 32Gï¼Œè‡³å°‘ 256GB å­˜å‚¨ï¼›</li><li>éœ€è¦ä¸€å° DHCP æœåŠ¡å™¨ï¼Œç”±äºé»˜è®¤æ˜¯ä½¿ç”¨ DHCP è·å– IP æ¥åˆ†é…ç»™è™šæ‹Ÿæœºçš„ï¼Œå› æ­¤ ESXi æ‰€åœ¨çš„ VM Network  ç½‘ç»œä¸­å¿…é¡»æœ‰ä¸€å° DHCP æœåŠ¡å™¨ç”¨äºç»™è™šæ‹Ÿæœºåˆ†é… IPï¼›</li></ul><h3 id="ä¸‹è½½ä¾èµ–æ–‡ä»¶"><a href="#ä¸‹è½½ä¾èµ–æ–‡ä»¶" class="headerlink" title="ä¸‹è½½ä¾èµ–æ–‡ä»¶"></a>ä¸‹è½½ä¾èµ–æ–‡ä»¶</h3><p>æ•´ä¸ªéƒ¨ç½²æµç¨‹æ‰€éœ€è¦çš„ä¾æ–‡ä»¶èµ–å¦‚ä¸‹ï¼Œå¯ä»¥å…ˆå°†è¿™äº›ä¾èµ–ä¸‹è½½åˆ°æœ¬åœ°çš„æœºå™¨ä¸Šï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@devbox:/root/tanzu <span class="token comment"># tree -sh</span><span class="token builtin class-name">.</span>â”œâ”€â”€ <span class="token punctuation">[</span>  12M<span class="token punctuation">]</span>  govc_Linux_x86_64.tar.gzâ”œâ”€â”€ <span class="token punctuation">[</span> 895M<span class="token punctuation">]</span>  photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ovaâ”œâ”€â”€ <span class="token punctuation">[</span> 225M<span class="token punctuation">]</span>  photon-ova-4.0-c001795b80.ovaâ”œâ”€â”€ <span class="token punctuation">[</span> 170M<span class="token punctuation">]</span>  tce-linux-amd64-v0.9.1.tar.gzâ”œâ”€â”€ <span class="token punctuation">[</span> <span class="token number">9</span>.0G<span class="token punctuation">]</span>  VMware-VCSA-all-7.0.3-18778458.isoâ””â”€â”€ <span class="token punctuation">[</span> 390M<span class="token punctuation">]</span>  VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><table><thead><tr><th>æ–‡ä»¶</th><th>ç”¨é€”</th><th>ä¸‹è½½æ–¹å¼</th></tr></thead><tbody><tr><td><a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=ESXI70U2A&productId=974&rPId=46384">VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso</a></td><td>å®‰è£… ESXi OS</td><td>VMware éœ€è´¦æˆ·</td></tr><tr><td><a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=VC70U3C&productId=974&rPId=83853">VMware-VCSA-all-7.0.3-19234570.iso</a></td><td>å®‰è£… vCenter</td><td>VMware éœ€è´¦æˆ·</td></tr><tr><td><a href="https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova">photon-ova-4.0-c001795b80.ova</a></td><td>bootstrap èŠ‚ç‚¹</td><td>VMware</td></tr><tr><td><a href="https://customerconnect.vmware.com/downloads/get-download?downloadGroup=TCE-090">photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</a></td><td>tanzu é›†ç¾¤èŠ‚ç‚¹</td><td>VMware éœ€è´¦æˆ·</td></tr><tr><td><a href="https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz">tce-linux-amd64-v0.9.1.tar.gz</a></td><td>tanzu ç¤¾åŒºç‰ˆ</td><td>GitHub release</td></tr><tr><td><a href="https://github.com/vmware/govmomi/releases/download/v0.27.3/govc_Linux_x86_64.tar.gz">govc_Linux_x86_64.tar.gz</a></td><td>å®‰è£…&#x2F;é…ç½® vCenter</td><td>GitHub release</td></tr></tbody></table><p>æ³¨æ„ ESXi å’Œ vCenter çš„ç‰ˆæœ¬æœ€å¥½æ˜¯ 7.0 åŠä»¥ä¸Šï¼Œæˆ‘åªåœ¨ ESXi 7.0.2 å’Œ vCenter 7.0.3 ä¸Šæµ‹è¯•è¿‡ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰äº›å·®å¼‚ï¼›å¦å¤– ESXi çš„ç‰ˆæœ¬ä¸å»ºè®®ä½¿ç”¨æœ€æ–°çš„ 7.0.3ï¼Œå› ä¸ºæœ‰æ¯”è¾ƒä¸¥é‡çš„ bugï¼Œå®˜æ–¹ä¹Ÿå»ºè®®ç”¨æˆ·ç”Ÿäº§ç¯å¢ƒä¸è¦ä½¿ç”¨è¯¥ç‰ˆæœ¬äº† <a href="https://kb.vmware.com/s/article/86287">vSphere 7.0 Update 3 Critical Known Issues - Workarounds &amp; Fix (86287)</a> ã€‚</p><h3 id="å®‰è£…-govc-åŠä¾èµ–"><a href="#å®‰è£…-govc-åŠä¾èµ–" class="headerlink" title="å®‰è£… govc åŠä¾èµ–"></a>å®‰è£… govc åŠä¾èµ–</h3><p>åœ¨æœ¬åœ°æœºå™¨ä¸Šå®‰è£…å¥½ govc å’Œ jqï¼Œè¿™ä¸¤ä¸ªå·¥å…·åé¢åœ¨é…ç½® vCenter çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</p><ul><li>macOS</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ brew <span class="token function">install</span> govc jq<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>Debian&#x2F;Ubuntu</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">tar</span> -xf govc_Linux_x86_64.tar.gz -C /usr/local/bin$ <span class="token function">apt</span> <span class="token function">install</span> jq -y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>å…¶ä»– Linux å¯ä»¥åœ¨ govc å’Œ jq çš„ GitHub ä¸Šä¸‹è½½å¯¹åº”çš„å®‰è£…æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚</li></ul><h3 id="å®‰è£…-ESXi-OS"><a href="#å®‰è£…-ESXi-OS" class="headerlink" title="å®‰è£… ESXi OS"></a>å®‰è£… ESXi OS</h3><p>ESXi OS çš„å®‰è£…ç½‘ä¸Šæœ‰å¾ˆå¤šæ•™ç¨‹ï¼Œæ²¡æœ‰å¤ªå¤šå€¼å¾—è®²è§£çš„åœ°æ–¹ï¼Œå› æ­¤å°±å‚ç…§ä¸€ä¸‹å…¶ä»–å¤§ä½¬å†™çš„åšå®¢æˆ–è€…å®˜æ–¹çš„å®‰è£…æ–‡æ¡£ <a href="https://docs.vmware.com/cn/VMware-vSphere/7.0/vsphere-esxi-701-installation-setup-guide.pdf">VMware ESXi å®‰è£…å’Œè®¾ç½®</a> æ¥å°±è¡Œï¼›éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼ŒESXi OS å®‰è£…æ—¶ VMFSL åˆ†åŒºå°†ä¼šå ç”¨å¤§é‡çš„å­˜å‚¨ç©ºé—´ï¼Œè¿™å°†ä¼šä½¿å¾— ESXi OS å®‰è£…æ‰€åœ¨çš„ç£ç›˜æœ€ç»ˆåˆ›å»ºå‡ºæ¥çš„ datastore æ¯”é¢„æœŸå°å¾ˆå¤šï¼Œè€Œä¸”è¿™ä¸ª VMFSL åˆ†åŒºåœ¨å®‰è£…å¥½ä¹‹åå°±å¾ˆéš¾å†åšè°ƒæ•´äº†ã€‚å› æ­¤å¦‚æœç£ç›˜å­˜å‚¨ç©ºé—´æ¯”è¾ƒç´§å¼ ï¼Œåœ¨å®‰è£… ESXi OS ä¹‹å‰å¯ä»¥è€ƒè™‘ä¸‹å¦‚ä½•å»æ‰è¿™ä¸ªåˆ†åŒºï¼›æˆ–è€…å’Œæˆ‘ä¸€æ ·å°† ESXI OS å®‰è£…åœ¨äº†ä¸€ä¸ª 16G çš„ USB Dom ç›˜ä¸Šï¼Œä¸è¿‡ç”Ÿäº§ç¯å¢ƒä¸å»ºè®®é‡‡ç”¨è¿™ç§æ–¹æ¡ˆ ğŸ˜‚ï¼ˆå…¶å®ä¸ªäººè§‰ç€å®‰è£…åœ¨ U ç›˜ä¸Šé—®é¢˜ä¸å¤§ï¼ŒESXi OS å¯åŠ¨ä¹‹åæ˜¯åŠ è½½åˆ°å†…å­˜ä¸­è¿è¡Œçš„ï¼Œä¸ä¼šå¯¹ U ç›˜æœ‰å¤§é‡çš„è¯»å†™æ“ä½œï¼Œåªä¸è¿‡åœ¨æœºæˆ¿ä¸­ U ç›˜è¢«äººä¸å°å¿ƒæ‹”èµ°å°±å‡‰äº†ã€‚</p><ul><li>è®¾ç½® govc ç¯å¢ƒå˜é‡</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ESXi èŠ‚ç‚¹çš„ IP</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">ESXI_IP</span><span class="token operator">=</span><span class="token string">"192.168.18.47"</span><span class="token comment"># ESXi ç™»å½•çš„ç”¨æˆ·åï¼Œåˆæ¬¡å®‰è£…åé»˜è®¤ä¸º root</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_USERNAME</span><span class="token operator">=</span><span class="token string">"root"</span><span class="token comment"># åœ¨ ESXi å®‰è£…æ—¶è®¾ç½®çš„ root å¯†ç </span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_PASSWORD</span><span class="token operator">=</span><span class="token string">"admin@2022"</span><span class="token comment"># å…è®¸ä¸å®‰å…¨çš„ SSL è¿æ¥</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_INSECURE</span><span class="token operator">=</span>true<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_URL</span><span class="token operator">=</span><span class="token string">"https://<span class="token variable">$&#123;ESXI_IP&#125;</span>"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_DATASTORE</span><span class="token operator">=</span>datastore1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æµ‹è¯• govc æ˜¯å¦èƒ½æ­£å¸¸è¿æ¥ ESXi ä¸»æœº</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Name:              localhost.local  Path:            /ha-datacenter/host/localhost/localhost  Manufacturer:    Dell  Logical CPUs:    <span class="token number">20</span> CPUs @ 2394MHz  Processor type:  Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Xeon<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Silver 4210R CPU @ <span class="token number">2</span>.40GHz  CPU usage:       <span class="token number">579</span> MHz <span class="token punctuation">(</span><span class="token number">1.2</span>%<span class="token punctuation">)</span>  Memory:          261765MB  Memory usage:    <span class="token number">16457</span> MB <span class="token punctuation">(</span><span class="token number">6.3</span>%<span class="token punctuation">)</span>  Boot time:       <span class="token number">2022</span>-02-02 <span class="token number">11</span>:53:59.630124 +0000 UTC  State:           connected<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®‰è£…-vCenter"><a href="#å®‰è£…-vCenter" class="headerlink" title="å®‰è£… vCenter"></a>å®‰è£… vCenter</h3><p>æŒ‰ç…§ VMware å®˜æ–¹çš„ vCenter å®‰è£…æ–‡æ¡£ <a href="https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vcenter.install.doc/GUID-8DC3866D-5087-40A2-8067-1361A2AF95BD.html">å…³äº vCenter Server å®‰è£…å’Œè®¾ç½®</a> æ¥å®‰è£…å®åœ¨æ˜¯è¿‡äºç¹çï¼Œå…¶å®å®˜æ–¹çš„ ISO å®‰è£…æ–¹å¼æ— éæ˜¯è¿è¡Œä¸€ä¸ª installer web æœåŠ¡ï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸Šé…ç½®å¥½ vCenter è™šæ‹Ÿæœºçš„å‚æ•°ï¼Œå†å°†å¡«å†™çš„é…ç½®ä¿¡æ¯åœ¨éƒ¨ç½² vcsa è™šæ‹Ÿæœºçš„æ—¶å€™æ³¨å…¥åˆ° ova çš„é…ç½®å‚æ•°ä¸­ã€‚</p><p>çŸ¥é“è¿™ä¸ªå®‰è£…è¿‡ç¨‹çš„åŸç†ä¹‹åæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±é…ç½® vCenter çš„å‚æ•°ä¿¡æ¯ï¼Œç„¶åé€šè¿‡ govc æ¥éƒ¨ç½² ovaï¼›è¿™æ¯”ä½¿ç”¨ UI çš„æ–¹å¼ç®€å•æ–¹ä¾¿å¾ˆå¤šï¼Œæœ€ç»ˆåªéœ€è¦å¡«å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¸€æ¡å‘½ä»¤å°±å¯ä»¥éƒ¨ç½²å®Œæˆå•¦ã€‚</p><ul><li>é¦–å…ˆæ˜¯æŒ‚è½½ vCenter çš„ ISOï¼Œæ‰¾åˆ° vcsa ova æ–‡ä»¶ï¼Œå®ƒæ˜¯ vCenter è™šæ‹Ÿæœºçš„æ¨¡ç‰ˆ</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">mount</span> -o loop VMware-VCSA-all-7.0.3-18778458.iso /mnt$ <span class="token function">ls</span> /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova/mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>æ ¹æ®è‡ªå·±çš„ç¯å¢ƒä¿¡æ¯ä¿®æ”¹ä¸‹é¢å®‰è£…è„šæœ¬ä¸­çš„ç›¸å…³é…ç½®ï¼š</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span><span class="token assign-left variable">VCSA_OVA_FILE</span><span class="token operator">=</span><span class="token variable">$1</span><span class="token builtin class-name">set</span> -o errexit<span class="token builtin class-name">set</span> -o nounset<span class="token builtin class-name">set</span> -o pipefail<span class="token comment"># ESXi çš„ IP åœ°å€</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">ESXI_IP</span><span class="token operator">=</span><span class="token string">"192.168.18.47"</span><span class="token comment"># ESXi çš„ç”¨æˆ·å</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_USERNAME</span><span class="token operator">=</span><span class="token string">"root"</span><span class="token comment"># ESXI çš„å¯†ç </span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_PASSWORD</span><span class="token operator">=</span><span class="token string">"admin@2020"</span><span class="token comment"># å®‰è£… vCenter è™šæ‹Ÿæœºä½¿ç”¨çš„ datastore åç§°</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_DATASTORE</span><span class="token operator">=</span>datastore1<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_INSECURE</span><span class="token operator">=</span>true<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_URL</span><span class="token operator">=</span><span class="token string">"https://<span class="token variable">$&#123;ESXI_IP&#125;</span>"</span><span class="token comment"># vCenter çš„ç™»å½•å¯†ç </span><span class="token assign-left variable">VM_PASSWORD</span><span class="token operator">=</span><span class="token string">"admin@2020"</span><span class="token comment"># vCenter çš„ IP åœ°å€</span><span class="token assign-left variable">VM_IP</span><span class="token operator">=</span><span class="token number">192.168</span>.20.92<span class="token comment"># vCenter è™šæ‹Ÿæœºçš„åç§°</span><span class="token assign-left variable">VM_NAME</span><span class="token operator">=</span>vCenter-Server-Appliance<span class="token comment"># vCenter è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œ</span><span class="token assign-left variable">VM_NETWORK</span><span class="token operator">=</span><span class="token string">"VM Network"</span><span class="token comment"># DNS æœåŠ¡å™¨</span><span class="token assign-left variable">VM_DNS</span><span class="token operator">=</span><span class="token string">"223.6.6.6"</span><span class="token comment"># NTP æœåŠ¡å™¨</span><span class="token assign-left variable">VM_NTP</span><span class="token operator">=</span><span class="token string">"0.pool.ntp.org"</span><span class="token function-name function">deploy_vcsa_vm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token assign-left variable">config</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>govc host.info -k -json <span class="token operator">|</span> jq -r <span class="token string">'.HostSystems[].Config'</span><span class="token variable">)</span></span>    <span class="token assign-left variable">gateway</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>jq -r <span class="token string">'.Network.IpRouteConfig.DefaultGateway'</span> <span class="token operator">&lt;&lt;&lt;</span><span class="token string">"<span class="token variable">$config</span>"</span><span class="token variable">)</span></span>    <span class="token assign-left variable">route</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>jq -r <span class="token string">'.Network.RouteTableInfo.IpRoute[] | select(.DeviceName == "vmk0") | select(.Gateway == "0.0.0.0")'</span> <span class="token operator">&lt;&lt;&lt;</span><span class="token string">"<span class="token variable">$config</span>"</span><span class="token variable">)</span></span>    <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>jq -r <span class="token string">'.PrefixLength'</span> <span class="token operator">&lt;&lt;&lt;</span><span class="token string">"<span class="token variable">$route</span>"</span><span class="token variable">)</span></span>    <span class="token assign-left variable">opts</span><span class="token operator">=</span><span class="token punctuation">(</span>        cis.vmdir.password<span class="token operator">=</span><span class="token variable">$&#123;VM_PASSWORD&#125;</span>        cis.appliance.root.passwd<span class="token operator">=</span><span class="token variable">$&#123;VM_PASSWORD&#125;</span>        cis.appliance.root.shell<span class="token operator">=</span>/bin/bash        cis.deployment.node.type<span class="token operator">=</span>embedded        cis.vmdir.domain-name<span class="token operator">=</span>vsphere.local        cis.vmdir.site-name<span class="token operator">=</span>VCSA        cis.appliance.net.addr.family<span class="token operator">=</span>ipv4        cis.appliance.ssh.enabled<span class="token operator">=</span>True        cis.ceip_enabled<span class="token operator">=</span>False        cis.deployment.autoconfig<span class="token operator">=</span>True        cis.appliance.net.addr<span class="token operator">=</span><span class="token variable">$&#123;VM_IP&#125;</span>        cis.appliance.net.prefix<span class="token operator">=</span><span class="token variable">$&#123;prefix&#125;</span>        cis.appliance.net.dns.servers<span class="token operator">=</span><span class="token variable">$&#123;VM_DNS&#125;</span>        cis.appliance.net.gateway<span class="token operator">=</span><span class="token variable">$gateway</span>        cis.appliance.ntp.servers<span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;VM_NTP&#125;</span>"</span>        cis.appliance.net.mode<span class="token operator">=</span>static    <span class="token punctuation">)</span>    <span class="token assign-left variable">props</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">printf</span> -- <span class="token string">"guestinfo.%s<span class="token entity" title="\n">\n</span>"</span> <span class="token string">"<span class="token variable">$&#123;opts<span class="token punctuation">[</span>@<span class="token punctuation">]</span>&#125;</span>"</span> <span class="token operator">|</span> jq --slurp -R 'split<span class="token punctuation">(</span><span class="token string">"<span class="token entity" title="\n">\n</span>"</span><span class="token punctuation">)</span> <span class="token operator">|</span> map<span class="token punctuation">(</span>select<span class="token punctuation">(</span>. <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token variable">)</span></span> <span class="token operator">|</span> map<span class="token punctuation">(</span>split<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">))</span> <span class="token operator">|</span> map<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"Key"</span><span class="token builtin class-name">:</span> .<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, <span class="token string">"Value"</span><span class="token builtin class-name">:</span> .<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>'<span class="token punctuation">)</span>    <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> govc import.<span class="token variable">$&#123;VCSA_OVA_FILE<span class="token operator">##</span>*.&#125;</span> -options - <span class="token string">"<span class="token variable">$&#123;VCSA_OVA_FILE&#125;</span>"</span></span>    &#123;    "Name": "<span class="token variable">$&#123;VM_NAME&#125;</span>",    "Deployment": "tiny",    "DiskProvisioning": "thin",    "IPProtocol": "IPv4",    "Annotation": "VMware vCenter Server Appliance",    "PowerOn": false,    "WaitForIP": false,    "InjectOvfEnv": true,    "NetworkMapping": [        &#123;        "Name": "Network 1",        "Network": "<span class="token variable">$&#123;VM_NETWORK&#125;</span>"        &#125;    ],    "PropertyMapping": <span class="token variable">$&#123;props&#125;</span>    &#125;EOF</span><span class="token punctuation">&#125;</span>deploy_vcsa_vmgovc vm.change -vm <span class="token string">"<span class="token variable">$&#123;VM_NAME&#125;</span>"</span> -g vmwarePhoton64Guestgovc vm.power -on <span class="token string">"<span class="token variable">$&#123;VM_NAME&#125;</span>"</span>govc vm.ip -a <span class="token string">"<span class="token variable">$&#123;VM_NAME&#125;</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>é€šè¿‡è„šæœ¬å®‰è£… vCenterï¼ŒæŒ‡å®šç¬¬ä¸€å‚æ•°ä¸º OVA çš„ç»å¯¹è·¯å¾„ã€‚è¿è¡Œå®Œåå°†ä¼šè‡ªåŠ¨å°† ova å¯¼å…¥åˆ° vCenterï¼Œå¹¶å¯åŠ¨è™šæ‹Ÿæœºï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æ‰§è¡Œè¯¥è„šæœ¬ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ vCenter ISO ä¸­ vcsa ova æ–‡ä»¶çš„ç»å¯¹è·¯å¾„</span>$ <span class="token function">bash</span> install-vcsa.sh /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova<span class="token punctuation">[</span>03-02-22 <span class="token number">18</span>:40:19<span class="token punctuation">]</span> Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk1.vmdk<span class="token punctuation">..</span>. OK<span class="token punctuation">[</span>03-02-22 <span class="token number">18</span>:41:09<span class="token punctuation">]</span> Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk<span class="token punctuation">..</span>. <span class="token punctuation">(</span><span class="token number">29</span>%, <span class="token number">52</span>.5MiB/s<span class="token punctuation">)</span><span class="token punctuation">[</span>03-02-22 <span class="token number">18</span>:43:08<span class="token punctuation">]</span> Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk<span class="token punctuation">..</span>. OK<span class="token punctuation">[</span>03-02-22 <span class="token number">18</span>:43:08<span class="token punctuation">]</span> Injecting OVF environment<span class="token punctuation">..</span>.Powering on VirtualMachine:3<span class="token punctuation">..</span>. OKfe80::20c:29ff:fe03:2f80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>è®¾ç½® vCenter ç™»å½•çš„ç¯å¢ƒå˜é‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ govc æ¥é…ç½® vCenterï¼Œé€šè¿‡æµè§ˆå™¨ Web UI çš„æ–¹å¼é…ç½®èµ·æ¥æ•ˆç‡æœ‰ç‚¹ä½ï¼Œä¸å¦‚ govc å‘½ä»¤ä¸€æŠŠæ¢­æ–¹ä¾¿ ğŸ˜‚</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_URL</span><span class="token operator">=</span><span class="token string">"https://192.168.20.92"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_USERNAME</span><span class="token operator">=</span><span class="token string">"administrator@vsphere.local"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_PASSWORD</span><span class="token operator">=</span><span class="token string">"admin@2022"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_INSECURE</span><span class="token operator">=</span>true<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_DATASTORE</span><span class="token operator">=</span>datastore1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>è™šæ‹Ÿæœºå¯åŠ¨åå°†è‡ªåŠ¨è¿›è¡Œ vCenter çš„å®‰è£…é…ç½®ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ vCenter å®‰è£…å¥½ä¹‹åï¼Œä½¿ç”¨ govc about æŸ¥çœ‹ vCenter çš„ä¿¡æ¯ï¼Œå¦‚æœèƒ½æ­£ç¡®æˆ–æ¸ é“è¯´æ˜ vCenter å°±å®‰è£…å¥½äº†ï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ govc aboutFullName:     VMware vCenter Server <span class="token number">7.0</span>.3 build-18778458Name:         VMware vCenter ServerVendor:       VMware, Inc.Version:      <span class="token number">7.0</span>.3Build:        <span class="token number">18778458</span>OS type:      linux-x64API type:     VirtualCenterAPI version:  <span class="token number">7.0</span>.3.0Product ID:   vpxUUID:         0b49e119-e38f-4fbc-84a8-d7a0e548027d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é…ç½®-vCenter"><a href="#é…ç½®-vCenter" class="headerlink" title="é…ç½® vCenter"></a>é…ç½® vCenter</h3><p>è¿™ä¸€æ­¥éª¤ä¸»è¦æ˜¯é…ç½® vCenterï¼šåˆ›å»º Datacenterã€clusterã€folder ç­‰èµ„æºï¼Œå¹¶å°† ESXi ä¸»æœºæ·»åŠ åˆ° cluster ä¸­ï¼›</p><ul><li>é…ç½® vCenter</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># åˆ›å»º Datacenter æ•°æ®ä¸­å¿ƒ</span>$ govc datacenter.create SH-IDC<span class="token comment"># åˆ›å»º Cluster é›†ç¾¤</span>$ govc cluster.create -dc<span class="token operator">=</span>SH-IDC Tanzu-Cluster<span class="token comment"># å°† ESXi ä¸»æœºæ·»åŠ åˆ° Cluster å½“ä¸­</span>$ govc cluster.add -dc<span class="token operator">=</span>SH-IDC -cluster<span class="token operator">=</span>Tanzu-Cluster -hostname<span class="token operator">=</span><span class="token number">192.168</span>.18.47 --username<span class="token operator">=</span>root -password<span class="token operator">=</span><span class="token string">'admin@2020'</span> -noverify<span class="token comment"># åˆ›å»º folderï¼Œç”¨äºå°† Tanzu çš„èŠ‚ç‚¹è™šæ‹Ÿæœºå­˜æ”¾åˆ°è¯¥æ–‡ä»¶å¤¹ä¸‹</span>$ govc folder.create /SH-IDC/vm/Tanzu-node<span class="token comment"># å¯¼å…¥ tanzu æ±²å–èŠ‚ç‚¹çš„è™šæ‹Ÿæœº ova æ¨¡ç‰ˆ</span>$ govc import.ova -dc<span class="token operator">=</span><span class="token string">'SH-IDC'</span> -ds<span class="token operator">=</span><span class="token string">'datastore1'</span> photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova<span class="token comment"># å°†è™šæ‹Ÿæœºè½¬æ¢ä¸ºæ¨¡ç‰ˆï¼Œåç»­ tanzu é›†ç¾¤å°†ä»¥è¯¥æ¨¡ç‰ˆåˆ›å»ºè™šæ‹Ÿæœº</span>$ govc vm.markastemplate photon-3-kube-v1.21.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="åˆå§‹åŒ–-bootstrap-èŠ‚ç‚¹"><a href="#åˆå§‹åŒ–-bootstrap-èŠ‚ç‚¹" class="headerlink" title="åˆå§‹åŒ– bootstrap èŠ‚ç‚¹"></a>åˆå§‹åŒ– bootstrap èŠ‚ç‚¹</h3><p>bootstrap èŠ‚ç‚¹èŠ‚ç‚¹æ˜¯ç”¨äºè¿è¡Œ tanzu éƒ¨ç½²å·¥å…·çš„èŠ‚ç‚¹ï¼Œå®˜æ–¹æ˜¯æ”¯æŒ Linux&#x2F;macOS&#x2F;Windows ä¸‰ç§æ“ä½œç³»ç»Ÿçš„ï¼Œä½†æœ‰ä¸€äº›æ¯”è¾ƒä¸¥æ ¼çš„è¦æ±‚ï¼š</p><table><thead><tr><th>Arch: x86; ARM is currently unsupported</th></tr></thead><tbody><tr><td>RAM: 6 GB</td></tr><tr><td>CPU: 2</td></tr><tr><td><a href="https://docs.docker.com/engine/install/">Docker</a> Add your non-root user account to the docker user group. Create the group if it does not already exist. This lets the Tanzu CLI access the Docker socket, which is owned by the root user. For more information, see steps 1 to 4 in the <a href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user">Manage Docker as a non-root user</a> procedure in the Docker documentation.</td></tr><tr><td><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/">Kubectl</a></td></tr><tr><td>Latest version of Chrome, Firefox, Safari, Internet Explorer, or Edge</td></tr><tr><td>System time is synchronized with a Network Time Protocol (NTP) server.</td></tr><tr><td>Ensure your bootstrap machine is using <a href="https://man7.org/linux/man-pages/man7/cgroups.7.html">cgroup v1</a>. For more information, see <a href="https://tanzucommunityedition.io/docs/latest/support-matrix/#check-and-set-the-cgroup">Check and set the cgroup</a>.</td></tr></tbody></table><p>åœ¨è¿™é‡Œä¸ºäº†é¿å…è¿™äº›éº»çƒ¦çš„é…ç½®ï¼Œæˆ‘å°±ç›´æ¥ä½¿ç”¨çš„ VMware å®˜æ–¹çš„ <a href="https://github.com/vmware/photon/wiki/Downloading-Photon-OS#photon-os-40-rev2-binaries">Photon OS 4.0 Rev2</a> ï¼Œä¸‹è½½ OVA æ ¼å¼çš„é•œåƒç›´æ¥å¯¼å…¥åˆ° ESXi ä¸»æœºå¯åŠ¨ä¸€å°è™šæ‹Ÿæœºå³å¯ï¼Œèƒ½èŠ‚çœä¸å°‘éº»çƒ¦çš„é…ç½®ï¼›è¿˜æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯åœ¨ä¸€å°å•ç‹¬çš„è™šæ‹Ÿæœºä¸Šè¿è¡Œ tanzu éƒ¨ç½²å·¥å…·ä¸ä¼šæ±¡æŸ“æœ¬åœ°çš„å¼€å‘ç¯å¢ƒã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">wget</span> https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova<span class="token comment"># å¯¼å…¥ OVA è™šæ‹Ÿæœºæ¨¡ç‰ˆ</span>$ govc import.ova -ds<span class="token operator">=</span><span class="token string">'datastore1'</span> -name bootstrap-node photon-ova-4.0-c001795b80.ova<span class="token comment"># ä¿®æ”¹ä¸€ä¸‹è™šæ‹Ÿæœºçš„é…ç½®ï¼Œè°ƒæ•´ä¸º 4C8G</span>$ govc vm.change -c <span class="token number">4</span> -m <span class="token number">8192</span> -vm bootstrap-node<span class="token comment"># å¼€å¯è™šæ‹Ÿæœº</span>$ govc vm.power -on bootstrap-node<span class="token comment"># æŸ¥çœ‹è™šæ‹Ÿæœºè·å–åˆ°çš„ IPv4 åœ°å€</span>$ govc vm.ip -a -wait 1m bootstrap-node$ <span class="token function">ssh</span> root@192.168.74.10<span class="token comment"># å¯†ç é»˜è®¤ä¸º changemeï¼Œè¾“å…¥å®Œå¯†ç ä¹‹åæç¤ºåœ¨è¾“å…¥ä¸€é changemeï¼Œç„¶åå†ä¿®æ”¹æ–°çš„å¯†ç </span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># cat /etc/os-release</span><span class="token assign-left variable">NAME</span><span class="token operator">=</span><span class="token string">"VMware Photon OS"</span><span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token string">"4.0"</span><span class="token assign-left variable">ID</span><span class="token operator">=</span>photon<span class="token assign-left variable">VERSION_ID</span><span class="token operator">=</span><span class="token number">4.0</span><span class="token assign-left variable">PRETTY_NAME</span><span class="token operator">=</span><span class="token string">"VMware Photon OS/Linux"</span><span class="token assign-left variable">ANSI_COLOR</span><span class="token operator">=</span><span class="token string">"1;34"</span><span class="token assign-left variable">HOME_URL</span><span class="token operator">=</span><span class="token string">"https://vmware.github.io/photon/"</span><span class="token assign-left variable">BUG_REPORT_URL</span><span class="token operator">=</span><span class="token string">"https://github.com/vmware/photon/issues"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å®‰è£…éƒ¨ç½²æ—¶éœ€è¦çš„ä¸€äº›å·¥å…·ï¼ˆåˆ‡ï¼ŒPhoton OS é‡Œç«Ÿç„¶è¿ä¸ª tar å‘½ä»¤éƒ½æ²¡æœ‰ ğŸ˜ </li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># tdnf install sudo tar -y</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># curl -LO https://dl.k8s.io/release/v1.21.2/bin/linux/amd64/kubectl</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>å¯åŠ¨ dockerï¼Œbootstrap èŠ‚ç‚¹ä¼šä»¥ kind çš„æ–¹å¼è¿è¡Œä¸€ä¸ª K8s é›†ç¾¤ï¼Œéœ€è¦ç”¨åˆ° dockerã€‚è™½ç„¶å¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ k8s é›†ç¾¤ï¼Œä½†ä¸æ˜¯å¾ˆæ¨èï¼Œå› ä¸º cluster-api ä¾èµ– k8s çš„ç‰ˆæœ¬ï¼Œä¸èƒ½å¤ªé«˜ä¹Ÿä¸èƒ½å¤ªä½ï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># systemctl enable docker --now</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>ä» <a href="https://github.com/vmware-tanzu/community-edition/releases/tag/v0.9.1">vmware-tanzu&#x2F;community-edition</a> ä¸‹è½½ tanzu ç¤¾åŒºç‰ˆçš„å®‰è£…åŒ…ï¼Œç„¶åè§£å‹åå®‰è£…ï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># curl -LO  https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># tar -xf tce-linux-amd64-v0.9.1.tar.gz</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># cd tce-linux-amd64-v0.9.1/</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># bash install.sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>ç„¶è€Œä¸å¹¸åœ°ç¿»è½¦äº†ï¼Œ install.sh è„šæœ¬ä¸­ç¦æ­¢ root ç”¨æˆ·è¿è¡Œ</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">+ <span class="token assign-left variable">ALLOW_INSTALL_AS_ROOT</span><span class="token operator">=</span>+ <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0</span> -eq <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>+ <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">''</span> <span class="token operator">!=</span> <span class="token punctuation">\</span>t<span class="token punctuation">\</span>r<span class="token punctuation">\</span>u<span class="token punctuation">\</span>e <span class="token punctuation">]</span><span class="token punctuation">]</span>+ <span class="token builtin class-name">echo</span> <span class="token string">'Do not run this script as root'</span>Do not run this script as root+ <span class="token builtin class-name">exit</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æˆ‘å°±ååè¦ä»¥ root ç”¨æˆ·æ¥è¿è¡Œæ€ä¹ˆæƒ¹ ğŸ˜¡</p><p><img data-src="https://p.k8s.li/2022-01-22-deploy-tanzu-k8s-cluster-01.jpg"></p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># sed å»æ‰ç¬¬ä¸€ä¸ª exit 1 å°±å¯ä»¥äº†</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># sed -i.bak "s/exit 1//" install.sh</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># bash install.sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å®‰è£…å¥½ä¹‹åä¼šè¾“å‡º <code>Installation complete!</code>ï¼ˆè®²çœŸå®˜æ–¹çš„ install.sh è„šæœ¬è¾“å‡ºå¾ˆä¸å‹å¥½ï¼Œæ±¡æŸ“æˆ‘çš„ terminal</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">+ tanzu init<span class="token operator">|</span> initializing âœ”  successfully initialized CLI++ tanzu plugin repo list++ <span class="token function">grep</span> tce+ <span class="token assign-left variable">TCE_REPO</span><span class="token operator">=</span>+ <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token string">''</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>+ tanzu plugin repo <span class="token function">add</span> --name tce --gcp-bucket-name tce-tanzu-cli-plugins --gcp-root-path artifacts++ tanzu plugin repo list++ <span class="token function">grep</span> core-admin+ <span class="token assign-left variable">TCE_REPO</span><span class="token operator">=</span>+ <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token string">''</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>+ tanzu plugin repo <span class="token function">add</span> --name core-admin --gcp-bucket-name tce-tanzu-cli-framework-admin --gcp-root-path artifacts-admin+ <span class="token builtin class-name">echo</span> <span class="token string">'Installation complete!'</span>Installation complete<span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="éƒ¨ç½²ç®¡ç†é›†ç¾¤"><a href="#éƒ¨ç½²ç®¡ç†é›†ç¾¤" class="headerlink" title="éƒ¨ç½²ç®¡ç†é›†ç¾¤"></a>éƒ¨ç½²ç®¡ç†é›†ç¾¤</h3><p>å…ˆæ˜¯éƒ¨ç½²ä¸€ä¸ª tanzu çš„ç®¡ç†é›†ç¾¤ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡ <a href="https://tanzucommunityedition.io/docs/latest/getting-started/">å®˜æ–¹æ–‡æ¡£</a> æåˆ°çš„é€šè¿‡ Web UI çš„æ–¹å¼ã€‚ç›®å‰è¿™ä¸ª UI ç•Œé¢æ¯”è¾ƒæ‹‰å®ï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥è®©ç”¨æˆ·å¡«å†™ä¸€äº›é…ç½®å‚æ•°ï¼Œç„¶åè°ƒç”¨åå°çš„ tanzu å‘½ä»¤æ¥éƒ¨ç½²é›†ç¾¤ã€‚å¹¶æŠŠé›†ç¾¤éƒ¨ç½²çš„æ—¥å¿—å’Œè¿›åº¦å±•ç¤ºå‡ºæ¥ï¼›éƒ¨ç½²å®Œæˆä¹‹åï¼Œè¿™ä¸ª UI åˆä¸èƒ½ç®¡ç†è¿™äº›é›†ç¾¤ï¼Œåˆä¸æ”¯æŒéƒ¨ç½² workload é›†ç¾¤ï¼ˆ</p><p>å¦ä¸€ç§å°±æ˜¯é€šè¿‡ tanzu å‘½ä»¤æŒ‡å®šé…ç½®æ–‡ä»¶æ¥éƒ¨ç½²ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦é€šè¿‡æµè§ˆå™¨åœ¨ web é¡µé¢ä¸Šå‚»ä¹ä¹åœ°ç‚¹æ¥ç‚¹å»å¡«ä¸€äº›å‚æ•°ï¼Œåªéœ€è¦æå‰å¡«å†™å¥½ä¸€ä¸ª yaml æ ¼å¼çš„é…ç½®æ–‡ä»¶å³å¯ã€‚ä¸‹é¢æˆ‘ä»¬å°±é‡‡ç”¨ tanzu å‘½ä»¤æ¥éƒ¨ç½²é›†ç¾¤ï¼Œç®¡ç†é›†ç¾¤çš„é…ç½®æ–‡ä»¶æ¨¡ç‰ˆå¦‚ä¸‹ï¼š</p><ul><li>tanzu-mgt-cluster.yaml</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Cluster Pod IP çš„ CIDR</span><span class="token key atrule">CLUSTER_CIDR</span><span class="token punctuation">:</span> 100.96.0.0/11<span class="token comment"># Service çš„ CIDR</span><span class="token key atrule">SERVICE_CIDR</span><span class="token punctuation">:</span> 100.64.0.0/13<span class="token comment"># é›†ç¾¤çš„åç§°</span><span class="token key atrule">CLUSTER_NAME</span><span class="token punctuation">:</span> tanzu<span class="token punctuation">-</span>control<span class="token punctuation">-</span>plan<span class="token comment"># é›†ç¾¤çš„ç±»å‹</span><span class="token key atrule">CLUSTER_PLAN</span><span class="token punctuation">:</span> dev<span class="token comment"># é›†ç¾¤èŠ‚ç‚¹çš„ arch</span><span class="token key atrule">OS_ARCH</span><span class="token punctuation">:</span> amd64<span class="token comment"># é›†ç¾¤èŠ‚ç‚¹çš„ OS åç§°</span><span class="token key atrule">OS_NAME</span><span class="token punctuation">:</span> photon<span class="token comment"># é›†ç¾¤èŠ‚ç‚¹ OS ç‰ˆæœ¬</span><span class="token key atrule">OS_VERSION</span><span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token comment"># åŸºç¡€è®¾æ–½èµ„æºçš„æä¾›æ–¹</span><span class="token key atrule">INFRASTRUCTURE_PROVIDER</span><span class="token punctuation">:</span> vsphere<span class="token comment"># é›†ç¾¤çš„ VIP</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_ENDPOINT</span><span class="token punctuation">:</span> 192.168.75.194<span class="token comment"># control-plan èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_DISK_GIB</span><span class="token punctuation">:</span> <span class="token string">"20"</span><span class="token comment"># control-plan èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_MEM_MIB</span><span class="token punctuation">:</span> <span class="token string">"8192"</span><span class="token comment"># control-plan èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_NUM_CPUS</span><span class="token punctuation">:</span> <span class="token string">"4"</span><span class="token comment"># work èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span><span class="token key atrule">VSPHERE_WORKER_DISK_GIB</span><span class="token punctuation">:</span> <span class="token string">"20"</span><span class="token comment"># work èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span><span class="token key atrule">VSPHERE_WORKER_MEM_MIB</span><span class="token punctuation">:</span> <span class="token string">"4096"</span><span class="token comment"># work èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span><span class="token key atrule">VSPHERE_WORKER_NUM_CPUS</span><span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token comment"># vCenter çš„ Datacenter è·¯å¾„</span><span class="token key atrule">VSPHERE_DATACENTER</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC<span class="token comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„ Datastore è·¯å¾„</span><span class="token key atrule">VSPHERE_DATASTORE</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/datastore/datastore1<span class="token comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„æ–‡ä»¶å¤¹</span><span class="token key atrule">VSPHERE_FOLDER</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/vm/Tanzu<span class="token punctuation">-</span>node<span class="token comment"># è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œ</span><span class="token key atrule">VSPHERE_NETWORK</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/network/VM Network<span class="token comment"># è™šæ‹Ÿæœºå…³è”çš„èµ„æºæ± </span><span class="token key atrule">VSPHERE_RESOURCE_POOL</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/host/Tanzu<span class="token punctuation">-</span>Cluster/Resources<span class="token comment"># vCenter çš„ IP</span><span class="token key atrule">VSPHERE_SERVER</span><span class="token punctuation">:</span> 192.168.75.110<span class="token comment"># vCenter çš„ç”¨æˆ·å</span><span class="token key atrule">VSPHERE_USERNAME</span><span class="token punctuation">:</span> administrator@vsphere.local<span class="token comment"># vCenter çš„å¯†ç ï¼Œä»¥ base64 ç¼–ç </span><span class="token key atrule">VSPHERE_PASSWORD</span><span class="token punctuation">:</span> &lt;encoded<span class="token punctuation">:</span>base64password<span class="token punctuation">></span><span class="token comment"># vCenter çš„è¯ä¹¦æŒ‡çº¹ï¼Œå¯ä»¥é€šè¿‡ govc about.cert -json | jq -r '.ThumbprintSHA1' è·å–</span><span class="token key atrule">VSPHERE_TLS_THUMBPRINT</span><span class="token punctuation">:</span> EB<span class="token punctuation">:</span>F3<span class="token punctuation">:</span>D8<span class="token punctuation">:</span>7A<span class="token punctuation">:</span>E8<span class="token punctuation">:</span>3D<span class="token punctuation">:</span>1A<span class="token punctuation">:</span>59<span class="token punctuation">:</span>B0<span class="token punctuation">:</span>DE<span class="token punctuation">:</span>73<span class="token punctuation">:</span>96<span class="token punctuation">:</span>DC<span class="token punctuation">:</span>B9<span class="token punctuation">:</span>5F<span class="token punctuation">:</span>13<span class="token punctuation">:</span>86<span class="token punctuation">:</span>EF<span class="token punctuation">:</span>B6<span class="token punctuation">:</span><span class="token number">27</span><span class="token comment"># è™šæ‹Ÿæœºæ³¨å…¥çš„ ssh å…¬é’¥ï¼Œéœ€è¦ç”¨å®ƒæ¥ ssh ç™»å½•é›†ç¾¤èŠ‚ç‚¹</span><span class="token key atrule">VSPHERE_SSH_AUTHORIZED_KEY</span><span class="token punctuation">:</span> ssh<span class="token punctuation">-</span>rsa<span class="token comment"># ä¸€äº›é»˜è®¤å‚æ•°</span><span class="token key atrule">AVI_ENABLE</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">IDENTITY_MANAGEMENT_TYPE</span><span class="token punctuation">:</span> none<span class="token key atrule">ENABLE_AUDIT_LOGGING</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">ENABLE_CEIP_PARTICIPATION</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">TKG_HTTP_PROXY_ENABLED</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">DEPLOY_TKG_ON_VSPHERE7</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>é€šè¿‡ tanzu CLI éƒ¨ç½²ç®¡ç†é›†ç¾¤</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ tanzu management-cluster create --file tanzu-mgt-cluster.yaml -v6<span class="token comment"># å¦‚æœæ²¡æœ‰é…ç½® VSPHERE_TLS_THUMBPRINT ä¼šæœ‰ä¸€ä¸ªç¡®è®¤ vSphere thumbprint çš„äº¤äº’ï¼Œè¾“å…¥ Y å°±å¯ä»¥</span>Validating the pre-requisites<span class="token punctuation">..</span>.Do you want to <span class="token builtin class-name">continue</span> with the vSphere thumbprint EB:F3:D8:7A:E8:3D:1A:59:B0:DE:73:96:DC:B9:5F:13:86:EF:B6:27 <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>: y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="éƒ¨ç½²æ—¥å¿—"><a href="#éƒ¨ç½²æ—¥å¿—" class="headerlink" title="éƒ¨ç½²æ—¥å¿—"></a>éƒ¨ç½²æ—¥å¿—</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># tanzu management-cluster create --file tanzu-mgt-cluster.yaml -v 6</span>compatibility <span class="token function">file</span> <span class="token punctuation">(</span>/root/.config/tanzu/tkg/compatibility/tkg-compatibility.yaml<span class="token punctuation">)</span> already exists, skipping downloadBOM files inside /root/.config/tanzu/tkg/bom already exists, skipping downloadCEIP Opt-in status: <span class="token boolean">false</span>Validating the pre-requisites<span class="token punctuation">..</span>.vSphere <span class="token number">7.0</span> Environment Detected.You have connected to a vSphere <span class="token number">7.0</span> environment <span class="token function">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includesan integrated Tanzu Kubernetes Grid Service <span class="token function">which</span> turns a vSphere cluster into a platform <span class="token keyword">for</span> running Kubernetes workloads <span class="token keyword">in</span> dedicatedresource pools. Configuring Tanzu Kubernetes Grid Service is <span class="token keyword">done</span> through vSphere HTML5 client.Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="token keyword">in</span> vSphere <span class="token number">7.0</span> environments. Alternatively you maydeploy a non-integrated Tanzu Kubernetes Grid instance on vSphere <span class="token number">7.0</span>.Deploying TKG management cluster on vSphere <span class="token number">7.0</span> <span class="token punctuation">..</span>.Identity Provider not configured. Some authentication features won<span class="token string">'t work.Checking if VSPHERE_CONTROL_PLANE_ENDPOINT 192.168.20.94 is already in useSetting up management cluster...Validating configuration...Using infrastructure provider vsphere:v0.7.10Generating cluster configuration...Setting up bootstrapper...Fetching configuration for kind node image...kindConfig: &amp;&#123;&#123;Cluster kind.x-k8s.io/v1alpha4&#125;  [&#123;  map[] [&#123;/var/run/docker.sock /var/run/docker.sock false false &#125;] [] [] []&#125;] &#123; 0  100.96.0.0/11 100.64.0.0/13 false &#125; map[] map[] [apiVersion: kubeadm.k8s.io/v1beta2kind: ClusterConfigurationimageRepository: projects.registry.vmware.com/tkgetcd:  local:    imageRepository: projects.registry.vmware.com/tkg    imageTag: v3.4.13_vmware.15dns:  type: CoreDNS  imageRepository: projects.registry.vmware.com/tkg  imageTag: v1.8.0_vmware.5] [] [] []&#125;Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210Creating cluster "tkg-kind-c7vj6kds0a6sf43e6210" ...Ensuring node image (projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1) ...Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 ...Preparing nodes ...Writing configuration ...Starting control-plane ...Installing CNI ...Installing StorageClass ...Waiting 2m0s for control-plane = Ready ...Ready after 19sBootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOLInstalling providers on bootstrapper...Fetching providersInstalling cert-manager Version="v1.1.0"Waiting for cert-manager to be available...Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"Waiting for provider infrastructure-vsphereWaiting for provider control-plane-kubeadmWaiting for provider cluster-apiWaiting for provider bootstrap-kubeadmWaiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and runningpods are not yet running for deployment '</span>capi-kubeadm-control-plane-controller-manager<span class="token string">' in namespace '</span>capi-kubeadm-control-plane-system<span class="token string">', retryingPassed waiting on provider bootstrap-kubeadm after 25.205820854spods are not yet running for deployment '</span>capi-controller-manager<span class="token string">' in namespace '</span>capi-webhook-system<span class="token string">', retryingPassed waiting on provider infrastructure-vsphere after 30.185406332sPassed waiting on provider cluster-api after 30.213216243sSuccess waiting on all providers.Start creating management cluster...patch cluster object with operation status:&#123;"metadata": &#123;"annotations": &#123;"TKGOperationInfo" : "&#123;\"Operation\":\"Create\",\"OperationStartTimestamp\":\"2022-02-06 02:35:34.30219421 +0000 UTC\",\"OperationTimeout\":1800&#125;","TKGOperationLastObservedTimestamp" : "2022-02-06 02:35:34.30219421 +0000 UTC"&#125;&#125;&#125;cluster control plane is still being initialized, retryingGetting secret for clusterWaiting for resource tanzu-control-plan-kubeconfig of type *v1.Secret to be up and runningSaving management cluster kubeconfig into /root/.kube/configInstalling providers on management cluster...Fetching providersInstalling cert-manager Version="v1.1.0"Waiting for cert-manager to be available...Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"Waiting for provider control-plane-kubeadmWaiting for provider bootstrap-kubeadmWaiting for provider infrastructure-vsphereWaiting for provider cluster-apiWaiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and runningPassed waiting on provider control-plane-kubeadm after 10.046865402sWaiting for resource antrea-controller of type *v1.Deployment to be up and runningMoving all Cluster API objects from bootstrap cluster to management cluster...Performing move...Discovering Cluster API objectsMoving Cluster API objects Clusters=1Creating objects in the target clusterDeleting objects from the source clusterWaiting for additional components to be up and running...Waiting for packages to be up and running...Waiting for package: antreaWaiting for package: metrics-serverWaiting for package: tanzu-addons-managerWaiting for package: vsphere-cpiWaiting for package: vsphere-csiWaiting for resource antrea of type *v1alpha1.PackageInstall to be up and runningWaiting for resource vsphere-cpi of type *v1alpha1.PackageInstall to be up and runningWaiting for resource vsphere-csi of type *v1alpha1.PackageInstall to be up and runningWaiting for resource metrics-server of type *v1alpha1.PackageInstall to be up and runningWaiting for resource tanzu-addons-manager of type *v1alpha1.PackageInstall to be up and runningSuccessfully reconciled package: antreaSuccessfully reconciled package: vsphere-csiSuccessfully reconciled package: metrics-serverContext set for management cluster tanzu-control-plan as '</span>tanzu-control-plan-admin@tanzu-control-plan'.Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210Management cluster created<span class="token operator">!</span>You can now create your first workload cluster by running the following:  tanzu cluster create <span class="token punctuation">[</span>name<span class="token punctuation">]</span> -f <span class="token punctuation">[</span>file<span class="token punctuation">]</span>Some addons might be getting installed<span class="token operator">!</span> Check their status by running the following:  kubectl get apps -A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>éƒ¨ç½²å®Œæˆä¹‹åï¼Œå°†ç®¡ç†é›†ç¾¤çš„ kubeconfig æ–‡ä»¶å¤åˆ¶åˆ° kubectl é»˜è®¤çš„ç›®å½•ä¸‹</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># cp $&#123;HOME&#125;/.kube-tkg/config $&#123;HOME&#125;/.kube/config</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ç®¡ç†é›†ç¾¤çš„ cluster èµ„æºä¿¡æ¯ï¼Œç®¡ç†é›†ç¾¤çš„ CR é»˜è®¤ä¿å­˜åœ¨äº† tkg-system namespace ä¸‹</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get cluster -A</span>NAMESPACE    NAME                 PHASEtkg-system   tanzu-control-plan   Provisioned<span class="token comment"># ç®¡ç†é›†ç¾¤çš„ machine èµ„æºä¿¡æ¯</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get machine -A</span>NAMESPACE    NAME                                       PROVIDERID                                       PHASE         VERSIONtkg-system   tanzu-control-plan-control-plane-gs4bl     vsphere://4239c450-f621-d78e-3c44-4ac8890c0cd3   Running       v1.21.2+vmware.1tkg-system   tanzu-control-plan-md-0-7cdc97c7c6-kxcnx   vsphere://4239d776-c04c-aacc-db12-3380542a6d03   Provisioned   v1.21.2+vmware.1<span class="token comment"># è¿è¡Œçš„ç»„ä»¶çŠ¶æ€</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get pod -A</span>NAMESPACE                           NAME                                                             READY   STATUS    RESTARTS   AGEcapi-kubeadm-bootstrap-system       capi-kubeadm-bootstrap-controller-manager-6494884869-wlzhx       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m37scapi-kubeadm-control-plane-system   capi-kubeadm-control-plane-controller-manager-857d687b9d-tpznv   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m35scapi-system                         capi-controller-manager-778bd4dfb9-tkvwg                         <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m41scapi-webhook-system                 capi-controller-manager-9995bdc94-svjm2                          <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m41scapi-webhook-system                 capi-kubeadm-bootstrap-controller-manager-68845b65f8-sllgv       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m38scapi-webhook-system                 capi-kubeadm-control-plane-controller-manager-9847c6747-vvz6g    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m35scapi-webhook-system                 capv-controller-manager-55bf67fbd5-4t46v                         <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m31scapv-system                         capv-controller-manager-587fbf697f-bbzs9                         <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m31scert-manager                        cert-manager-77f6fb8fd5-8tq6n                                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11mcert-manager                        cert-manager-cainjector-6bd4cff7bb-6vlzx                         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11mcert-manager                        cert-manager-webhook-fbfcb9d6c-qpkbc                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11mkube-system                         antrea-agent-5m9d4                                               <span class="token number">2</span>/2     Running   <span class="token number">0</span>          6mkube-system                         antrea-agent-8mpr7                                               <span class="token number">2</span>/2     Running   <span class="token number">0</span>          5m40skube-system                         antrea-controller-5bbcb98667-hklss                               <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m50skube-system                         coredns-8dcb5c56b-ckvb7                                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         coredns-8dcb5c56b-d98hf                                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         etcd-tanzu-control-plan-control-plane-gs4bl                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         kube-apiserver-tanzu-control-plan-control-plane-gs4bl            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         kube-controller-manager-tanzu-control-plan-control-plane-gs4bl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         kube-proxy-d4wq4                                                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         kube-proxy-nhkgg                                                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11mkube-system                         kube-scheduler-tanzu-control-plan-control-plane-gs4bl            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         kube-vip-tanzu-control-plan-control-plane-gs4bl                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12mkube-system                         metrics-server-59fcb9fcf-xjznj                                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m29skube-system                         vsphere-cloud-controller-manager-kzffm                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m50skube-system                         vsphere-csi-controller-74675c9488-q9h5c                          <span class="token number">6</span>/6     Running   <span class="token number">0</span>          6m31skube-system                         vsphere-csi-node-dmvvr                                           <span class="token number">3</span>/3     Running   <span class="token number">0</span>          6m31skube-system                         vsphere-csi-node-k6x98                                           <span class="token number">3</span>/3     Running   <span class="token number">0</span>          6m31stkg-system                          kapp-controller-6499b8866-xnql7                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10mtkg-system                          tanzu-addons-controller-manager-657c587556-rpbjm                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m58stkg-system                          tanzu-capabilities-controller-manager-6ff97656b8-cq7m7           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11mtkr-system                          tkr-controller-manager-6bc455b5d4-wm98s                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="éƒ¨ç½²æµç¨‹-1"><a href="#éƒ¨ç½²æµç¨‹-1" class="headerlink" title="éƒ¨ç½²æµç¨‹"></a>éƒ¨ç½²æµç¨‹</h3><p>ç»“åˆ <a href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go">tanzu çš„æºç </a> å’Œéƒ¨ç½²è¾“å‡ºçš„æ—¥å¿—æˆ‘ä»¬å¤§ä½“å¯ä»¥å¾—çŸ¥ï¼Œtanzu ç®¡ç†é›†ç¾¤éƒ¨ç½²å¤§è‡´åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥ï¼š</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go</span><span class="token comment">// management cluster init step constants</span><span class="token keyword">const</span> <span class="token punctuation">(</span>StepConfigPrerequisite                 <span class="token operator">=</span> <span class="token string">"Configure prerequisite"</span>StepValidateConfiguration              <span class="token operator">=</span> <span class="token string">"Validate configuration"</span>StepGenerateClusterConfiguration       <span class="token operator">=</span> <span class="token string">"Generate cluster configuration"</span>StepSetupBootstrapCluster              <span class="token operator">=</span> <span class="token string">"Setup bootstrap cluster"</span>StepInstallProvidersOnBootstrapCluster <span class="token operator">=</span> <span class="token string">"Install providers on bootstrap cluster"</span>StepCreateManagementCluster            <span class="token operator">=</span> <span class="token string">"Create management cluster"</span>StepInstallProvidersOnRegionalCluster  <span class="token operator">=</span> <span class="token string">"Install providers on management cluster"</span>StepMoveClusterAPIObjects              <span class="token operator">=</span> <span class="token string">"Move cluster-api objects from bootstrap cluster to management cluster"</span><span class="token punctuation">)</span><span class="token comment">// InitRegionSteps management cluster init step sequence</span><span class="token keyword">var</span> InitRegionSteps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span>StepConfigPrerequisite<span class="token punctuation">,</span>StepValidateConfiguration<span class="token punctuation">,</span>StepGenerateClusterConfiguration<span class="token punctuation">,</span>StepSetupBootstrapCluster<span class="token punctuation">,</span>StepInstallProvidersOnBootstrapCluster<span class="token punctuation">,</span>StepCreateManagementCluster<span class="token punctuation">,</span>StepInstallProvidersOnRegionalCluster<span class="token punctuation">,</span>StepMoveClusterAPIObjects<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ConfigPrerequisite å‡†å¤‡é˜¶æ®µï¼Œä¼šä¸‹è½½ <code>tkg-compatibility</code> å’Œ <code>tkg-bom</code> é•œåƒï¼Œç”¨äºæ£€æŸ¥ç¯å¢ƒçš„å…¼å®¹æ€§ï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Downloading TKG compatibility <span class="token function">file</span> from <span class="token string">'projects.registry.vmware.com/tkg/framework-zshippable/tkg-compatibility'</span>Downloading the TKG Bill of Materials <span class="token punctuation">(</span>BOM<span class="token punctuation">)</span> <span class="token function">file</span> from <span class="token string">'projects.registry.vmware.com/tkg/tkg-bom:v1.4.0'</span>Downloading the TKr Bill of Materials <span class="token punctuation">(</span>BOM<span class="token punctuation">)</span> <span class="token function">file</span> from <span class="token string">'projects.registry.vmware.com/tkg/tkr-bom:v1.21.2_vmware.1-tkg.1'</span>ERROR <span class="token number">2022</span>/02/06 02:24:46 svType <span class="token operator">!=</span> tvType<span class="token punctuation">;</span> <span class="token assign-left variable">key</span><span class="token operator">=</span>release, <span class="token assign-left variable">st</span><span class="token operator">=</span>map<span class="token punctuation">[</span>string<span class="token punctuation">]</span>interface <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>, <span class="token assign-left variable">tt</span><span class="token operator">=</span><span class="token operator">&lt;</span>nil<span class="token operator">></span>, <span class="token assign-left variable">sv</span><span class="token operator">=</span>map<span class="token punctuation">[</span>version:<span class="token punctuation">]</span>, <span class="token assign-left variable">tv</span><span class="token operator">=</span><span class="token operator">&lt;</span>nil<span class="token operator">></span>CEIP Opt-in status: <span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>ValidateConfiguration é…ç½®æ–‡ä»¶æ ¡éªŒï¼Œæ ¹æ®å¡«å†™çš„å‚æ•°æ ¡éªŒé…ç½®æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠæ£€æŸ¥ vCenter å½“ä¸­æœ‰æ— åŒ¹é…çš„è™šæ‹Ÿæœºæ¨¡ç‰ˆï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Validating the pre-requisites<span class="token punctuation">..</span>.vSphere <span class="token number">7.0</span> Environment Detected.You have connected to a vSphere <span class="token number">7.0</span> environment <span class="token function">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includesan integrated Tanzu Kubernetes Grid Service <span class="token function">which</span> turns a vSphere cluster into a platform <span class="token keyword">for</span> running Kubernetes workloads <span class="token keyword">in</span> dedicatedresource pools. Configuring Tanzu Kubernetes Grid Service is <span class="token keyword">done</span> through vSphere HTML5 client.Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="token keyword">in</span> vSphere <span class="token number">7.0</span> environments. Alternatively you maydeploy a non-integrated Tanzu Kubernetes Grid instance on vSphere <span class="token number">7.0</span>.Deploying TKG management cluster on vSphere <span class="token number">7.0</span> <span class="token punctuation">..</span>.Identity Provider not configured. Some authentication features won't work.Checking <span class="token keyword">if</span> VSPHERE_CONTROL_PLANE_ENDPOINT <span class="token number">192.168</span>.20.94 is already <span class="token keyword">in</span> useSetting up management cluster<span class="token punctuation">..</span>.Validating configuration<span class="token punctuation">..</span>.Using infrastructure provider vsphere:v0.7.10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>GenerateClusterConfiguration ç”Ÿæˆé›†ç¾¤é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Generating cluster configuration<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>SetupBootstrapCluster è®¾ç½® bootstrap é›†ç¾¤ï¼Œç›®å‰é»˜è®¤ä¸º kindã€‚ä¼šè¿è¡Œä¸€ä¸ª docker å®¹å™¨ï¼Œé‡Œé¢å¥—å¨ƒè¿è¡Œç€ä¸€ä¸ª k8s é›†ç¾¤ï¼›è¿™ä¸ª bootstrap k8s é›†ç¾¤åªæ˜¯ä¸´æ—¶è¿è¡Œ cluster-api æ¥éƒ¨ç½²ç®¡ç†é›†ç¾¤ç”¨çš„ï¼Œéƒ¨ç½²å®Œæˆä¹‹å bootstrap é›†ç¾¤ä¹Ÿå°±æ²¡ç”¨äº†ï¼Œä¼šè‡ªåŠ¨åˆ æ‰ï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Setting up bootstrapper<span class="token punctuation">..</span>.Fetching configuration <span class="token keyword">for</span> kind <span class="token function">node</span> image<span class="token punctuation">..</span>.kindConfig: <span class="token operator">&amp;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>Cluster kind.x-k8s.io/v1alpha4<span class="token punctuation">&#125;</span>  <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>  map<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>/var/run/docker.sock /var/run/docker.sock <span class="token boolean">false</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span>  <span class="token number">100.96</span>.0.0/11 <span class="token number">100.64</span>.0.0/13 <span class="token boolean">false</span> <span class="token punctuation">&#125;</span> map<span class="token punctuation">[</span><span class="token punctuation">]</span> map<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>apiVersion: kubeadm.k8s.io/v1beta2kind: ClusterConfigurationimageRepository: projects.registry.vmware.com/tkgetcd:  local:    imageRepository: projects.registry.vmware.com/tkg    imageTag: v3.4.13_vmware.15dns:  type: CoreDNS  imageRepository: projects.registry.vmware.com/tkg  imageTag: v1.8.0_vmware.5<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210Creating cluster <span class="token string">"tkg-kind-c7vj6kds0a6sf43e6210"</span> <span class="token punctuation">..</span>.Ensuring <span class="token function">node</span> image <span class="token punctuation">(</span>projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1<span class="token punctuation">)</span> <span class="token punctuation">..</span>.Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 <span class="token punctuation">..</span>.Preparing nodes <span class="token punctuation">..</span>.Writing configuration <span class="token punctuation">..</span>.Starting control-plane <span class="token punctuation">..</span>.Installing CNI <span class="token punctuation">..</span>.Installing StorageClass <span class="token punctuation">..</span>.Waiting 2m0s <span class="token keyword">for</span> control-plane <span class="token operator">=</span> Ready <span class="token punctuation">..</span>.Ready after 19sBootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>InstallProvidersOnBootstrapCluster åœ¨ bootstrap é›†ç¾¤ä¸Šå®‰è£… cluste-api ç›¸å…³ç»„ä»¶ï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Installing providers on bootstrapper<span class="token punctuation">..</span>.Fetching providers<span class="token comment"># å®‰è£… cert-manager ä¸»è¦æ˜¯ä¸ºäº†ç”Ÿæˆ k8s é›†ç¾¤éƒ¨ç½²æ‰€ä¾èµ–çš„é‚£ä¸€å †è¯ä¹¦</span>Installing cert-manager <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v1.1.0"</span>Waiting <span class="token keyword">for</span> cert-manager to be available<span class="token punctuation">..</span>.Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"cluster-api"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-system"</span>Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"bootstrap-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-bootstrap-system"</span>Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"control-plane-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-control-plane-system"</span>Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"infrastructure-vsphere"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.7.10"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capv-system"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"cluster-api"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"CoreProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"kubeadm"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"BootstrapProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"kubeadm"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"ControlPlaneProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"vsphere"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"InfrastructureProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.7.10"</span>Waiting <span class="token keyword">for</span> provider infrastructure-vsphereWaiting <span class="token keyword">for</span> provider control-plane-kubeadmWaiting <span class="token keyword">for</span> provider cluster-apiWaiting <span class="token keyword">for</span> provider bootstrap-kubeadmPassed waiting on provider infrastructure-vsphere after <span class="token number">30</span>.185406332sPassed waiting on provider cluster-api after <span class="token number">30</span>.213216243sSuccess waiting on all providers.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>CreateManagementCluster åˆ›å»ºç®¡ç†é›†ç¾¤ï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯åˆ›å»ºè™šæ‹Ÿæœºã€åˆå§‹åŒ–èŠ‚ç‚¹ã€è¿è¡Œ kubeadm éƒ¨ç½² k8s é›†ç¾¤ï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Start creating management cluster<span class="token punctuation">..</span>.patch cluster object with operation status:<span class="token punctuation">&#123;</span><span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"annotations"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span><span class="token string">"TKGOperationInfo"</span> <span class="token builtin class-name">:</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>Operation<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>Create<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>OperationStartTimestamp<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>2022-02-06 02:35:34.30219421 +0000 UTC<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>OperationTimeout<span class="token entity" title="\&quot;">\"</span>:1800&#125;"</span>,<span class="token string">"TKGOperationLastObservedTimestamp"</span> <span class="token builtin class-name">:</span> <span class="token string">"2022-02-06 02:35:34.30219421 +0000 UTC"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>cluster control plane is still being initialized, retryingGetting secret <span class="token keyword">for</span> clusterWaiting <span class="token keyword">for</span> resource tanzu-control-plan-kubeconfig of <span class="token builtin class-name">type</span> *v1.Secret to be up and runningSaving management cluster kubeconfig into /root/.kube/config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>InstallProvidersOnRegionalCluster åœ¨ç®¡ç†é›†ç¾¤ä¸Šå®‰è£… cluster-api ç›¸å…³ç»„ä»¶ï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Installing providers on management cluster<span class="token punctuation">..</span>.Fetching providersInstalling cert-manager <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v1.1.0"</span>Waiting <span class="token keyword">for</span> cert-manager to be available<span class="token punctuation">..</span>.Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"cluster-api"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-system"</span>Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"bootstrap-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-bootstrap-system"</span>Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"control-plane-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-control-plane-system"</span>Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"infrastructure-vsphere"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.7.10"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capv-system"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"cluster-api"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"CoreProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"kubeadm"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"BootstrapProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"kubeadm"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"ControlPlaneProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"vsphere"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"InfrastructureProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.7.10"</span>Waiting <span class="token keyword">for</span> provider control-plane-kubeadmWaiting <span class="token keyword">for</span> provider bootstrap-kubeadmWaiting <span class="token keyword">for</span> provider infrastructure-vsphereWaiting <span class="token keyword">for</span> provider cluster-apiWaiting <span class="token keyword">for</span> resource capv-controller-manager of <span class="token builtin class-name">type</span> *v1.Deployment to be up and runningPassed waiting on provider infrastructure-vsphere after <span class="token number">20</span>.091935635sPassed waiting on provider cluster-api after <span class="token number">20</span>.109419304sSuccess waiting on all providers.Waiting <span class="token keyword">for</span> the management cluster to get ready <span class="token keyword">for</span> move<span class="token punctuation">..</span>.Waiting <span class="token keyword">for</span> resource tanzu-control-plan of <span class="token builtin class-name">type</span> *v1alpha3.Cluster to be up and runningWaiting <span class="token keyword">for</span> resources <span class="token builtin class-name">type</span> *v1alpha3.MachineDeploymentList to be up and runningWaiting <span class="token keyword">for</span> resources <span class="token builtin class-name">type</span> *v1alpha3.MachineList to be up and runningWaiting <span class="token keyword">for</span> addons installation<span class="token punctuation">..</span>.Waiting <span class="token keyword">for</span> resources <span class="token builtin class-name">type</span> *v1alpha3.ClusterResourceSetList to be up and runningWaiting <span class="token keyword">for</span> resource antrea-controller of <span class="token builtin class-name">type</span> *v1.Deployment to be up and running<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>MoveClusterAPIObjects å°† bootstrap é›†ç¾¤ä¸Š cluster-api ç›¸å…³çš„èµ„æºè½¬ç§»åˆ°ç®¡ç†é›†ç¾¤ä¸Šã€‚è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯ä¸ºäº†è¾¾åˆ° self-hosted è‡ªæ‰˜ç®¡çš„åŠŸèƒ½ï¼šå³ç®¡ç†é›†ç¾¤è‡ªèº«çš„æ‰©ç¼©å®¹ä¹Ÿæ˜¯é€šè¿‡ cluster-api æ¥å®Œæˆï¼Œè¿™æ ·å°±ä¸ç”¨å†ä¾èµ–å…ˆå‰çš„é‚£ä¸ª bootstrap é›†ç¾¤äº†ï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Moving all Cluster API objects from bootstrap cluster to management cluster<span class="token punctuation">..</span>.Performing move<span class="token punctuation">..</span>.Discovering Cluster API objectsMoving Cluster API objects <span class="token assign-left variable">Clusters</span><span class="token operator">=</span><span class="token number">1</span>Creating objects <span class="token keyword">in</span> the target clusterDeleting objects from the <span class="token builtin class-name">source</span> clusterContext <span class="token builtin class-name">set</span> <span class="token keyword">for</span> management cluster tanzu-control-plan as <span class="token string">'tanzu-control-plan-admin@tanzu-control-plan'</span><span class="token builtin class-name">.</span>Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210Management cluster created<span class="token operator">!</span>You can now create your first workload cluster by running the following:  tanzu cluster create <span class="token punctuation">[</span>name<span class="token punctuation">]</span> -f <span class="token punctuation">[</span>file<span class="token punctuation">]</span>Some addons might be getting installed<span class="token operator">!</span> Check their status by running the following:  kubectl get apps -A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éƒ¨ç½²å®Œæˆåä¼šåˆ é™¤ bootstrap é›†ç¾¤ï¼Œå› ä¸º bootstrap é›†ç¾¤ä¸­çš„èµ„æºå·²ç»è½¬ç§»åˆ°äº†ç®¡ç†é›†ç¾¤ä¸­ï¼Œå®ƒç»§ç»­å­˜åœ¨çš„æ„ä¹‰ä¸å¤§ã€‚</p><h2 id="éƒ¨ç½²-workload-é›†ç¾¤"><a href="#éƒ¨ç½²-workload-é›†ç¾¤" class="headerlink" title="éƒ¨ç½² workload é›†ç¾¤"></a>éƒ¨ç½² workload é›†ç¾¤</h2><p>ä¸Šé¢æˆ‘ä»¬åªæ˜¯éƒ¨ç½²å¥½äº†ä¸€ä¸ª tanzu ç®¡ç†é›†ç¾¤ï¼Œæˆ‘ä»¬çœŸæ­£çš„å·¥ä½œè´Ÿè½½å¹¶ä¸é€‚åˆè¿è¡Œåœ¨è¿™ä¸ªé›†ç¾¤ä¸Šï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å†éƒ¨ç½²ä¸€ä¸ª workload é›†ç¾¤ï¼Œç±»ä¼¼äº k8s é›†ç¾¤ä¸­çš„ worker èŠ‚ç‚¹ã€‚éƒ¨ç½² workload é›†ç¾¤çš„æ—¶å€™ä¸å†ä¾èµ– bootstrap é›†ç¾¤ï¼Œè€Œæ˜¯ä½¿ç”¨ç®¡ç†é›†ç¾¤ã€‚</p><p>æ ¹æ®å®˜æ–¹æ–‡æ¡£ <a href="https://tanzucommunityedition.io/docs/latest/vsphere-wl-template/">vSphere Workload Cluster Template</a> ä¸­ç»™å‡ºçš„æ¨¡ç‰ˆåˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç„¶åå†é€šè¿‡ tanzu å‘½ä»¤æ¥éƒ¨ç½²å³å¯ã€‚é…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Cluster Pod IP çš„ CIDR</span><span class="token key atrule">CLUSTER_CIDR</span><span class="token punctuation">:</span> 100.96.0.0/11<span class="token comment"># Service çš„ CIDR</span><span class="token key atrule">SERVICE_CIDR</span><span class="token punctuation">:</span> 100.64.0.0/13<span class="token comment"># é›†ç¾¤çš„åç§°</span><span class="token key atrule">CLUSTER_NAME</span><span class="token punctuation">:</span> tanzu<span class="token punctuation">-</span>workload<span class="token punctuation">-</span>cluster<span class="token comment"># é›†ç¾¤çš„ç±»å‹</span><span class="token key atrule">CLUSTER_PLAN</span><span class="token punctuation">:</span> dev<span class="token comment"># é›†ç¾¤èŠ‚ç‚¹çš„ arch</span><span class="token key atrule">OS_ARCH</span><span class="token punctuation">:</span> amd64<span class="token comment"># é›†ç¾¤èŠ‚ç‚¹çš„ OS åç§°</span><span class="token key atrule">OS_NAME</span><span class="token punctuation">:</span> photon<span class="token comment"># é›†ç¾¤èŠ‚ç‚¹ OS ç‰ˆæœ¬</span><span class="token key atrule">OS_VERSION</span><span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token comment"># åŸºç¡€è®¾æ–½èµ„æºçš„æä¾›æ–¹</span><span class="token key atrule">INFRASTRUCTURE_PROVIDER</span><span class="token punctuation">:</span> vsphere<span class="token comment"># cluster, machine ç­‰è‡ªå®šä¹‰èµ„æºåˆ›å»ºçš„ namespace</span><span class="token key atrule">NAMESPACE</span><span class="token punctuation">:</span> default<span class="token comment"># CNI é€‰ç”¨ç±»å‹ï¼Œç›®å‰åº”è¯¥åªæ”¯æŒ VMware è‡ªå®¶çš„ antrea</span><span class="token key atrule">CNI</span><span class="token punctuation">:</span> antrea<span class="token comment"># é›†ç¾¤çš„ VIP</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_ENDPOINT</span><span class="token punctuation">:</span> 192.168.20.95<span class="token comment"># control-plan èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_DISK_GIB</span><span class="token punctuation">:</span> <span class="token string">"20"</span><span class="token comment"># control-plan èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_MEM_MIB</span><span class="token punctuation">:</span> <span class="token string">"8192"</span><span class="token comment"># control-plan èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span><span class="token key atrule">VSPHERE_CONTROL_PLANE_NUM_CPUS</span><span class="token punctuation">:</span> <span class="token string">"4"</span><span class="token comment"># work èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span><span class="token key atrule">VSPHERE_WORKER_DISK_GIB</span><span class="token punctuation">:</span> <span class="token string">"20"</span><span class="token comment"># work èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span><span class="token key atrule">VSPHERE_WORKER_MEM_MIB</span><span class="token punctuation">:</span> <span class="token string">"4096"</span><span class="token comment"># work èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span><span class="token key atrule">VSPHERE_WORKER_NUM_CPUS</span><span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token comment"># vCenter çš„ Datacenter è·¯å¾„</span><span class="token key atrule">VSPHERE_DATACENTER</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC<span class="token comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„ Datastore è·¯å¾„</span><span class="token key atrule">VSPHERE_DATASTORE</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/datastore/datastore1<span class="token comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„æ–‡ä»¶å¤¹</span><span class="token key atrule">VSPHERE_FOLDER</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/vm/Tanzu<span class="token punctuation">-</span>node<span class="token comment"># è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œ</span><span class="token key atrule">VSPHERE_NETWORK</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/network/VM Network<span class="token comment"># è™šæ‹Ÿæœºå…³è”çš„èµ„æºæ± </span><span class="token key atrule">VSPHERE_RESOURCE_POOL</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/host/Tanzu<span class="token punctuation">-</span>Cluster/Resources<span class="token comment"># vCenter çš„ IP</span><span class="token key atrule">VSPHERE_SERVER</span><span class="token punctuation">:</span> 192.168.20.92<span class="token comment"># vCenter çš„ç”¨æˆ·å</span><span class="token key atrule">VSPHERE_USERNAME</span><span class="token punctuation">:</span> administrator@vsphere.local<span class="token comment"># vCenter çš„å¯†ç ï¼Œä»¥ base64 ç¼–ç </span><span class="token key atrule">VSPHERE_PASSWORD</span><span class="token punctuation">:</span> &lt;encoded<span class="token punctuation">:</span>YWRtaW5AMjAyMA==<span class="token punctuation">></span><span class="token comment"># vCenter çš„è¯ä¹¦æŒ‡çº¹ï¼Œå¯ä»¥é€šè¿‡ govc about.cert -json | jq -r '.ThumbprintSHA1' è·å–</span><span class="token key atrule">VSPHERE_TLS_THUMBPRINT</span><span class="token punctuation">:</span> CB<span class="token punctuation">:</span>23<span class="token punctuation">:</span>48<span class="token punctuation">:</span>E8<span class="token punctuation">:</span>93<span class="token punctuation">:</span>34<span class="token punctuation">:</span>AD<span class="token punctuation">:</span>27<span class="token punctuation">:</span>D8<span class="token punctuation">:</span>FD<span class="token punctuation">:</span>88<span class="token punctuation">:</span>1C<span class="token punctuation">:</span>D7<span class="token punctuation">:</span>08<span class="token punctuation">:</span>4B<span class="token punctuation">:</span>47<span class="token punctuation">:</span>9B<span class="token punctuation">:</span>12<span class="token punctuation">:</span>F4<span class="token punctuation">:</span>E0<span class="token comment"># è™šæ‹Ÿæœºæ³¨å…¥çš„ ssh å…¬é’¥ï¼Œéœ€è¦ç”¨å®ƒæ¥ ssh ç™»å½•é›†ç¾¤èŠ‚ç‚¹</span><span class="token key atrule">VSPHERE_SSH_AUTHORIZED_KEY</span><span class="token punctuation">:</span> ssh<span class="token punctuation">-</span>rsa<span class="token comment"># ä¸€äº›é»˜è®¤å‚æ•°</span><span class="token key atrule">AVI_ENABLE</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">IDENTITY_MANAGEMENT_TYPE</span><span class="token punctuation">:</span> none<span class="token key atrule">ENABLE_AUDIT_LOGGING</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">ENABLE_CEIP_PARTICIPATION</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">TKG_HTTP_PROXY_ENABLED</span><span class="token punctuation">:</span> <span class="token string">"false"</span><span class="token key atrule">DEPLOY_TKG_ON_VSPHERE7</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span class="token comment"># æ˜¯å¦å¼€å¯è™šæ‹Ÿæœºå¥åº·æ£€æŸ¥</span><span class="token key atrule">ENABLE_MHC</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token key atrule">MHC_UNKNOWN_STATUS_TIMEOUT</span><span class="token punctuation">:</span> 5m<span class="token key atrule">MHC_FALSE_STATUS_TIMEOUT</span><span class="token punctuation">:</span> 12m<span class="token comment"># æ˜¯å¦éƒ¨ç½² vsphere cis ç»„ä»¶</span><span class="token key atrule">ENABLE_DEFAULT_STORAGE_CLASS</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token comment"># æ˜¯å¦å¼€å¯é›†ç¾¤è‡ªåŠ¨æ‰©ç¼©å®¹</span><span class="token key atrule">ENABLE_AUTOSCALER</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>é€šè¿‡ tanzu å‘½ä»¤æ¥éƒ¨ç½² workload é›†ç¾¤</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># tanzu cluster create tanzu-workload-cluster --file tanzu-workload-cluster.yaml</span>Validating configuration<span class="token punctuation">..</span>.Warning: Pinniped configuration not found. Skipping pinniped configuration <span class="token keyword">in</span> workload cluster. Please refer to the documentation to check <span class="token keyword">if</span> you can configure pinniped on workload cluster manuallyCreating workload cluster <span class="token string">'tanzu-workload-cluster'</span><span class="token punctuation">..</span>.Waiting <span class="token keyword">for</span> cluster to be initialized<span class="token punctuation">..</span>.Waiting <span class="token keyword">for</span> cluster nodes to be available<span class="token punctuation">..</span>.Waiting <span class="token keyword">for</span> cluster autoscaler to be available<span class="token punctuation">..</span>.Unable to <span class="token function">wait</span> <span class="token keyword">for</span> autoscaler deployment to be ready. reason: deployments.apps <span class="token string">"tanzu-workload-cluster-cluster-autoscaler"</span> not foundWaiting <span class="token keyword">for</span> addons installation<span class="token punctuation">..</span>.Waiting <span class="token keyword">for</span> packages to be up and running<span class="token punctuation">..</span>.Workload cluster <span class="token string">'tanzu-workload-cluster'</span> created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>éƒ¨ç½²å®Œæˆä¹‹åæŸ¥çœ‹ä¸€ä¸‹é›†ç¾¤çš„ CR ä¿¡æ¯</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get cluster</span>NAME                     PHASEtanzu-workload-cluster   Provisioned<span class="token comment"># machine çŠ¶æ€å¤„äº Running è¯´æ˜èŠ‚ç‚¹å·²ç»æ­£å¸¸è¿è¡Œäº†</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get machine</span>NAME                                          PROVIDERID                                       PHASE     VERSIONtanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æ‰©å®¹é›†ç¾¤"><a href="#æ‰©å®¹é›†ç¾¤" class="headerlink" title="æ‰©å®¹é›†ç¾¤"></a>æ‰©å®¹é›†ç¾¤</h2><p>é›†ç¾¤éƒ¨ç½²å¥½ä¹‹åï¼Œå¦‚æœæƒ³å¯¹é›†ç¾¤èŠ‚ç‚¹è¿›è¡Œæ‰©ç¼©å®¹ï¼Œæˆ‘ä»¬å¯ä»¥åƒ deployment çš„ä¸€æ ·ï¼Œåªéœ€è¦ä¿®æ”¹ä¸€äº› CR çš„ä¿¡æ¯å³å¯ã€‚cluster-api ç›¸å…³ç»„ä»¶ä¼š watch åˆ°è¿™äº› CR çš„å˜åŒ–ï¼Œå¹¶æ ¹æ®å®ƒçš„ spec ä¿¡æ¯è¿›è¡Œä¸€ç³»åˆ—è°ƒè°æ“ä½œã€‚å¦‚æœå½“å‰é›†ç¾¤èŠ‚ç‚¹æ•°é‡ä½äºæ‰€å®šä¹‰çš„èŠ‚ç‚¹å‰¯æœ¬æ•°é‡ï¼Œåˆ™ä¼šè‡ªåŠ¨è°ƒç”¨å¯¹åº”çš„ Provider åˆ›å»ºè™šæ‹Ÿæœºï¼Œå¹¶å¯¹è™šæ‹Ÿæœºè¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œå°†å®ƒè½¬æ¢ä¸º k8s é‡Œçš„ä¸€ä¸ª node èµ„æºï¼›</p><h3 id="æ‰©å®¹-control-plan-èŠ‚ç‚¹"><a href="#æ‰©å®¹-control-plan-èŠ‚ç‚¹" class="headerlink" title="æ‰©å®¹ control-plan èŠ‚ç‚¹"></a>æ‰©å®¹ control-plan èŠ‚ç‚¹</h3><p>å³æ‰©å®¹ master èŠ‚ç‚¹ï¼Œé€šè¿‡ä¿®æ”¹ <code>KubeadmControlPlane</code> è¿™ä¸ª CR ä¸­çš„ <code>replicas</code> å‰¯æœ¬æ•°å³å¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl scale kcp tanzu-workload-cluster-control-plane --replicas=3</span><span class="token comment"># å¯ä»¥çœ‹åˆ° machine å·²ç»å¤„äº Provisioning çŠ¶æ€ï¼Œè¯´æ˜é›†ç¾¤èŠ‚ç‚¹å¯¹åº”çš„è™šæ‹Ÿæœºæ­£åœ¨åˆ›å»ºä¸­</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get machine</span>NAME                                          PROVIDERID                                       PHASE          VERSIONtanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running        v1.21.2+vmware.1tanzu-workload-cluster-control-plane-mkmd2                                                     Provisioning   v1.21.2+vmware.1tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running        v1.21.2+vmware.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ‰©å®¹-work-èŠ‚ç‚¹"><a href="#æ‰©å®¹-work-èŠ‚ç‚¹" class="headerlink" title="æ‰©å®¹ work èŠ‚ç‚¹"></a>æ‰©å®¹ work èŠ‚ç‚¹</h3><p>æ‰©å®¹ worker èŠ‚ç‚¹ï¼Œé€šè¿‡ä¿®æ”¹ <code>MachineDeployment</code> è¿™ä¸ª CR ä¸­çš„ <code>replicas</code> å‰¯æœ¬æ•°å³å¯ï¼š</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl scale md tanzu-workload-cluster-md-0 --replicas=3</span>root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get machine</span>NAME                                          PROVIDERID                                       PHASE     VERSIONtanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1tanzu-workload-cluster-control-plane-mkmd2    vsphere://4239278c-0503-f03a-08b8-df92286bcdd7   Running   v1.21.2+vmware.1tanzu-workload-cluster-control-plane-rt5mb    vsphere://4239c882-2fe5-a394-60c0-616941a6363e   Running   v1.21.2+vmware.1tanzu-workload-cluster-md-0-8555bbbfc-4hlqk   vsphere://42395deb-e706-8b4b-a44f-c755c222575c   Running   v1.21.2+vmware.1tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1tanzu-workload-cluster-md-0-8555bbbfc-ftmlp   vsphere://42399640-8e94-85e5-c4bd-8436d84966e0   Running   v1.21.2+vmware.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h2><p>æœ¬æ–‡åªæ˜¯ä»‹ç»äº† tanzu é›†ç¾¤éƒ¨ç½²çš„å¤§ä½“æµç¨‹ï¼Œé‡Œé¢åŒ…å«äº† cluster-api ç›¸å…³çš„æ¦‚å¿µåœ¨æœ¬æ–‡å¹¶æ²¡æœ‰åšæ·±å…¥çš„åˆ†æï¼Œå› ä¸ºå®åœ¨æ˜¯å¤ªå¤æ‚äº† ğŸ˜‚ï¼Œåˆ°ç°åœ¨æˆ‘è¿˜æ˜¯æ²¡å¤ªç†è§£å…¶ä¸­çš„ä¸€äº›åŸç†ï¼Œå› æ­¤åç»­æˆ‘å†å•ç‹¬å†™ä¸€ç¯‡åšå®¢æ¥è®²è§£ä¸€äº› cluster-api ç›¸å…³çš„å†…å®¹ï¼Œåˆ°é‚£æ—¶å€™åœ¨ç»“åˆæœ¬æ–‡æ¥çœ‹å°±å®¹æ˜“ç†è§£å¾ˆå¤šã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://github.com/vmware-tanzu/community-edition">community-edition</a></li><li><a href="https://github.com/vmware/photon">vmware&#x2F;photon</a></li><li><a href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go">tanzu-framework</a></li><li><a href="https://github.com/kubernetes-sigs/cluster-api-provider-vsphere">cluster-api-provider-vsphere</a></li><li><a href="https://tanzucommunityedition.io/docs/latest/workload-clusters/">Deploying a workload cluster</a></li><li><a href="https://tanzucommunityedition.io/docs/latest/verify-deployment/">Examine the Management Cluster Deployment</a></li><li><a href="https://tanzucommunityedition.io/docs/latest/vsphere/">Prepare to Deploy a Management or Standalone Clusters to vSphere</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ä¹‹å‰æ¥è§¦çš„ Kubernetes
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="ESXi" scheme="https://blog.k8s.li/tags/ESXi/"/>
    
      <category term="Tanzu" scheme="https://blog.k8s.li/tags/Tanzu/"/>
    
      <category term="Kubernetes" scheme="https://blog.k8s.li/tags/Kubernetes/"/>
    
      <category term="Cluster-api" scheme="https://blog.k8s.li/tags/Cluster-api/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ overlay2 æˆ– bind é‡æ–°æ„å»º ISO é•œåƒ</title>
    <link href="https://blog.k8s.li/rebuild-iso-image.html"/>
    <id>https://blog.k8s.li/rebuild-iso-image.html</id>
    <published>2022-01-24T16:00:00.000Z</published>
    <updated>2022-01-25T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç¬”è€…ä¹‹å‰åœ¨å­—èŠ‚è·³åŠ¨çš„æ—¶å€™æ˜¯è´Ÿè´£ PaaS å®¹å™¨äº‘å¹³å°çš„ç§æœ‰åŒ–éƒ¨ç½²ç›¸å…³çš„å·¥ä½œï¼Œæ‰€ä»¥ç»å¸¸ä¼šå’Œä¸€äº›å®¹å™¨é•œåƒæ‰“äº¤é“ï¼Œå¯¹å®¹å™¨é•œåƒä¹Ÿæœ‰ä¸€äº›ç ”ç©¶ï¼Œä¹‹å‰è¿˜å†™è¿‡ä¸å°‘åšå®¢æ–‡ç« ã€‚æ¯”å¦‚ <a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿ ğŸ¤”</a>ã€<a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 åœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­çš„åº”ç”¨</a> ç­‰ç­‰ã€‚</p><p>è‡ªä»æ¢äº†æ–°å·¥ä½œä¹‹åï¼Œåˆ™å¼€å§‹è´Ÿè´£ <a href="https://www.smartx.com/smartx-hci/">è¶…èåˆäº§å“</a> é›†ç¾¤éƒ¨ç½²ç›¸å…³å·¥ä½œï¼Œå› æ­¤ä¹Ÿä¼šæ¥è§¦å¾ˆå¤š <code>é•œåƒ</code>ï¼Œä¸è¿‡è¿™ä¸ªé•œåƒæ˜¯æ“ä½œç³»ç»Ÿçš„ ISO é•œåƒè€Œä¸æ˜¯å®¹å™¨é•œåƒ ğŸ˜‚ã€‚è™½ç„¶ä¸¤è€…éƒ½ç»Ÿç§°ä¸ºé•œåƒï¼Œä½†ä¸¤è€…æœ‰ç€æœ¬è´¨çš„åŒºåˆ«ã€‚</p><p>é¦–å…ˆä¸¤è€…æ„å»ºçš„æ–¹å¼æœ‰æœ¬è´¨çš„å¾ˆå¤§çš„åŒºåˆ«ï¼ŒISO é•œåƒä¸€èˆ¬ä½¿ç”¨ <code>mkisofs</code> æˆ–è€… <code>genisoimage</code> ç­‰å‘½ä»¤å°†ä¸€ä¸ªåŒ…å«æ“ä½œç³»ç»Ÿå®‰è£…æ‰€æœ‰æ–‡ä»¶ç›®å½•æ„å»ºä¸ºä¸€ä¸ª ISO é•œåƒï¼›è€Œå®¹å™¨é•œåƒæ„å»ºåˆ™æ˜¯æ ¹æ® <code>Dockerfile</code> æ–‡ä»¶ä½¿ç”¨ç›¸åº”çš„å®¹å™¨é•œåƒæ„å»ºå·¥å…·æ¥ä¸€å±‚ä¸€å±‚æ„å»ºï¼›</p><p>å¦å¤– ISO é•œåƒæŒ‚è½½åæ˜¯åªè¯»çš„ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœæƒ³è¦ä¿®æ”¹ ISO é•œåƒä¸­çš„ä¸€ä¸ªæ–‡ä»¶ï¼ˆæ¯”å¦‚ kickstart æ–‡ä»¶ï¼‰ï¼Œåˆ™éœ€è¦å…ˆå°† ISO é•œåƒä¸­çš„æ‰€æœ‰å†…å®¹è´Ÿè´£åˆ°ä¸€ä¸ªå¯ä»¥è¯»å†™çš„ç›®å½•ä¸­ï¼Œåœ¨è¿™ä¸ªè¯»å†™çš„ç›®å½•ä¸­è¿›è¡Œä¿®æ”¹å’Œé‡æ–°æ„å»º ISO æ“ä½œã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox ~/buildâ•°â”€<span class="token comment"># mount -o loop CentOS-7-x86_64-Minimal-2009.iso /mnt/iso</span>mount: /mnt/iso: WARNING: device write-protected, mounted read-only.â•­â”€root@esxi-debian-devbox ~/buildâ•°â”€<span class="token comment"># touch /mnt/iso/kickstart.cfg</span>touch: cannot <span class="token function">touch</span> <span class="token string">'/mnt/iso/kickstart.cfg'</span><span class="token builtin class-name">:</span> Read-only <span class="token function">file</span> system<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨æ—¥å¸¸å·¥ä½œä¸­ç»å¸¸ä¼šå¯¹ä¸€äº›å·²æœ‰çš„ ISO é•œåƒè¿›è¡Œé‡æ–°æ„å»ºï¼Œé‡æ–°æ„å»º ISO çš„æ•ˆç‡æ ¹æ®ä¸åŒçš„æ–¹å¼ä¹Ÿä¼šæœ‰æ‰€ä¸åŒï¼Œæœ¬æ–‡å°±æ•´ç†äº†ä¸‰ç§ä¸åŒé‡æ–°æ„å»º ISO é•œåƒçš„æ–¹æ¡ˆä¾›å¤§å®¶å‚è€ƒã€‚</p><h2 id="å¸¸è§„æ–¹å¼"><a href="#å¸¸è§„æ–¹å¼" class="headerlink" title="å¸¸è§„æ–¹å¼"></a>å¸¸è§„æ–¹å¼</h2><p>ä»¥ä¸‹æ˜¯æŒ‰ç…§ RedHat å®˜æ–¹æ–‡æ¡£ <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/anaconda_customization_guide/sect-iso-images"> WORKING WITH ISO IMAGES</a> ä¸­çš„æ“ä½œæ­¥éª¤è¿›è¡Œ ISO é‡æ–°æ„å»ºã€‚</p><ul><li>é¦–å…ˆæˆ‘ä»¬ä¸‹è½½ä¸€ä¸ª ISO æ–‡ä»¶ï¼Œè¿™é‡Œä»¥ <a href="https://mirrors.tuna.tsinghua.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso">CentOS-7-x86_64-Minimal-2009.iso</a> ä¸ºä¾‹ï¼Œä¸‹è½½å¥½ä¹‹åå°†å®ƒæŒ‚è½½åˆ°æœ¬åœ° <code>/mn/iso</code> ç›®å½•ä¸‹ï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox ~/buildâ•°â”€<span class="token comment"># mount -o loop CentOS-7-x86_64-Minimal-2009.iso /mnt/iso</span>mount: /mnt/iso: WARNING: device write-protected, mounted read-only.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>å°† ISO é‡Œçš„æ‰€æœ‰æ–‡ä»¶å¤åˆ¶åˆ°å¦ä¸€ä¸ªç›®å½•</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox ~/buildâ•°â”€<span class="token comment"># rsync -avrut --force /mnt/iso/ /mnt/build/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>è¿›å…¥åˆ°è¯¥ç›®å½•ä¸‹ä¿®æ”¹æˆ–æ–°å¢æ–‡ä»¶ï¼Œç„¶åé‡æ–°æ„å»º ISO é•œåƒ</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ä½¿ç”¨ genisoimage å‘½ä»¤æ„å»º ISO é•œåƒï¼Œåœ¨ CentOS ä¸Šå¯ä»¥ä½¿ç”¨ mkisofs å‘½ä»¤ï¼Œå‚æ•°ä¸Šä¼šæœ‰ä¸€äº›å·®å¼‚</span>â•­â”€root@esxi-debian-devbox ~/buildâ•°â”€<span class="token comment"># genisoimage -U -r -v -T -J -joliet-long -V "CentOS 7 x86_64" -volset "CentOS 7 x86_64" -A "CentOS 7 x86_64" -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -no-emul-boot -o /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso .</span>Total translation table size: <span class="token number">124658</span>Total rockridge attributes bytes: <span class="token number">55187</span>Total directory bytes: <span class="token number">100352</span>Path table size<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>: <span class="token number">140</span>Done with: The File<span class="token punctuation">(</span>s<span class="token punctuation">)</span>                             Block<span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token number">527985</span>Writing:   Ending Padblock                         Start Block <span class="token number">528101</span>Done with: Ending Padblock                         Block<span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token number">150</span>Max brk space used a4000<span class="token number">528251</span> extents written <span class="token punctuation">(</span><span class="token number">1031</span> MB<span class="token punctuation">)</span><span class="token comment"># ç»™ ISO é•œåƒç”Ÿæˆ md5 æ ¡éªŒ</span>â•­â”€root@esxi-debian-devbox ~/buildâ•°â”€<span class="token comment"># implantisomd5 /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso</span>Inserting md5sum into iso image<span class="token punctuation">..</span>.md5 <span class="token operator">=</span> 9ddf5277bcb1d8679c367dfa93f9b162Inserting fragment md5sums into iso image<span class="token punctuation">..</span>.fragmd5 <span class="token operator">=</span> f39e2822ec1ae832a69ae399ea4bd3e891eeb31e9deb9c536f529c15bbebfrags <span class="token operator">=</span> <span class="token number">20</span>Setting supported flag to <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¯¹äº ISO é•œåƒæ¯”è¾ƒå°æˆ–è€…è¯¥æ“ä½œä¸æ˜¯å¾ˆé¢‘ç¹çš„æƒ…å†µä¸‹æŒ‰ç…§è¿™ç§æ–¹å¼æ˜¯æœ€çœäº‹å„¿çš„ï¼Œä½†å¦‚æœæ˜¯ ISO é•œåƒæ¯”è¾ƒå¤§ï¼Œæˆ–è€…æ˜¯åœ¨ CI&#x2F;CD æµæ°´çº¿ä¸­é¢‘ç¹åœ°é‡æ–°æ„å»ºé•œåƒï¼Œæ¯æ¬¡éƒ½è¦ cp å¤åˆ¶åŸ ISO é•œåƒçš„å†…å®¹ç¡®å®æ¯”è¾ƒæµªè´¹æ—¶é—´ã€‚é‚£æœ‰æ²¡æœ‰ä¸€ä¸ªæ›´åŠ é«˜æ•ˆçš„æ–¹æ³•å‘¢ ğŸ¤”ï¸</p><p>ç»è¿‡ä¸€ç•ªæ‘¸ç´¢ï¼ŒæŠ˜è…¾å‡ºæ¥ä¸¤ç§å¯ä»¥é¿å…ä½¿ç”¨ cp å¤åˆ¶è¿™ç§å ç”¨å¤§é‡ IO æ“ä½œçš„æ„å»ºæ–¹æ¡ˆï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯è¿›è¡Œé€‰æ‹©ã€‚</p><h2 id="overlay2"><a href="#overlay2" class="headerlink" title="overlay2"></a>overlay2</h2><p>ç†Ÿæ‚‰ docker é•œåƒçš„åº”è¯¥éƒ½çŸ¥é“é•œåƒæ˜¯åªè¯»çš„ï¼Œä½¿ç”¨é•œåƒçš„æ—¶å€™åˆ™æ˜¯é€šè¿‡è”åˆæŒ‚è½½çš„æ–¹å¼å°†é•œåƒçš„æ¯ä¸€å±‚ layer æŒ‚è½½ä¸ºåªè¯»å±‚ï¼Œå°†å®¹å™¨å®é™…è¿è¡Œçš„ç›®å½•æŒ‚è½½ä¸ºè¯»å†™å±‚ï¼Œè€Œå®¹å™¨è¿è¡ŒæœŸé—´åœ¨è¯»å†™å±‚çš„æ‰€æœ‰æ“ä½œä¸ä¼šå½±å“åˆ°é•œåƒåŸæœ‰çš„å†…å®¹ã€‚å®¹å™¨é•œåƒæŒ‚è½½çš„æ–¹å¼ä½¿ç”¨æœ€å¤šçš„æ˜¯ overlay2 æŠ€æœ¯ï¼Œåœ¨ <a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 åœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­çš„åº”ç”¨</a> å’Œ <a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿ ğŸ¤”</a> ä¸­å’±æ›¾å¯¹å®ƒè¿›è¡Œè¿‡æ¯”è¾ƒæ·±å…¥çš„ç ”ç©¶å’Œä½¿ç”¨ï¼Œå¯¹ overlay2 æŠ€æœ¯æ„Ÿå…´è¶£çš„å¯ä»¥ç¿»çœ‹ä¸€ä¸‹è¿™ä¸¤ç¯‡åšå®¢ï¼Œæœ¬æ–‡å°±ä¸å†è¯¦è§£å…¶ä¸­çš„æŠ€æœ¯åŸç†äº†ï¼Œåªå¯¹ä½¿ç”¨ overlay2 æŠ€æœ¯é‡æ–°æ„å»º ISO é•œåƒçš„å¯è¡Œæ€§è¿›è¡Œä¸€ä¸‹åˆ†æã€‚</p><ul><li>é¦–å…ˆæ˜¯åˆ›å»º overlay2 æŒ‚è½½æ‰€éœ€è¦çš„å‡ ä¸ªç›®å½•</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox ~â•°â”€<span class="token comment"># mkdir -p /mnt/overlay2/&#123;lower,upper,work,merged&#125;</span>â•­â”€root@esxi-debian-devbox ~â•°â”€<span class="token comment"># cd /mnt/overlay2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ¥ç€å°† ISO é•œåƒæŒ‚è½½åˆ° overlay2 çš„åªè¯»å±‚ <code>lower</code> ç›®å½•</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox /mnt/overlay2â•°â”€<span class="token comment"># mount -o loop  /root/build/CentOS-7-x86_64-Minimal-2009.iso lower</span>mount: /mnt/overlay2/lower: WARNING: device write-protected, mounted read-only.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>ä½¿ç”¨ mount å‘½ä»¤æŒ‚è½½ overlay2 æ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‚è½½ç‚¹ä¸º <code>merged</code> ç›®å½•</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox /mnt/overlay2â•°â”€<span class="token comment"># mount -t overlay overlay -o lowerdir=lower,upperdir=upper,workdir=work merged</span>â•­â”€root@esxi-debian-devbox /mnt/overlay2â•°â”€<span class="token comment"># cd merged</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ–°å¢ä¸€ä¸ª kickstart.cfg æ–‡ä»¶ï¼Œç„¶åé‡æ–°æ„å»º ISO é•œåƒ</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox /mnt/overlay2/mergedâ•°â”€<span class="token comment"># echo '# this is a kickstart config file' > kickstart.cfg</span>â•­â”€root@esxi-debian-devbox /mnt/overlay2/mergedâ•°â”€<span class="token comment"># genisoimage -U -r -v -T -J -joliet-long -V "CentOS 7 x86_64" -volset "CentOS 7 x86_64" -A "CentOS 7 x86_64" -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -no-emul-boot -o /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso .</span>Total translation table size: <span class="token number">124658</span>Total rockridge attributes bytes: <span class="token number">55187</span>Total directory bytes: <span class="token number">100352</span>Path table size<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>: <span class="token number">140</span>Done with: The File<span class="token punctuation">(</span>s<span class="token punctuation">)</span>                             Block<span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token number">527985</span>Writing:   Ending Padblock                         Start Block <span class="token number">528101</span>Done with: Ending Padblock                         Block<span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token number">150</span>Max brk space used a4000<span class="token number">528251</span> extents written <span class="token punctuation">(</span><span class="token number">1031</span> MB<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æŒ‚è½½æ–°çš„ ISO é•œåƒéªŒè¯åå‘ç°ç¡®å®å¯è¡Œ</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox /mnt/overlay2/mergedâ•°â”€<span class="token comment"># mount -o loop /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso /mnt/newiso</span>mount: /mnt/newiso: WARNING: device write-protected, mounted read-only.â•­â”€root@esxi-debian-devbox /mnt/overlay2/mergedâ•°â”€<span class="token comment"># cat /mnt/newiso/kickstart.cfg</span><span class="token comment"># this is a kickstart config file</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="mount-â€“bind"><a href="#mount-â€“bind" class="headerlink" title="mount â€“bind"></a>mount â€“bind</h2><p>å‰é¢è®²åˆ°äº†ä½¿ç”¨ overlay2 çš„æ–¹å¼é¿å…å¤åˆ¶åŸé•œåƒå†…å®¹è¿›è¡Œé‡æ–°æ„å»ºé•œåƒçš„æ–¹æ¡ˆï¼Œä½†æ˜¯ overlay2 å¯¹äºä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„äººæ¥è®²è¿˜æ˜¯æ¯”è¾ƒå¤æ‚ï¼Œå…‰ lowerdirã€upperdirã€workdirã€mergeddir è¿™å››ä¸ªæ–‡ä»¶å¤¹çš„ä½œç”¨å’ŒåŸç†å°±æŠŠäººç›´æ¥ç»™æ•´ä¸ä¼šäº†ã€‚é‚£ä¹ˆè¿˜æœ‰æ²¡æœ‰æ›´ä¸ºç®€å•ä¸€ç‚¹çš„æ–¹å¼å‘¢ï¼Ÿ</p><p>åˆ«è¯´è¿˜çœŸæœ‰ï¼Œåªä¸è¿‡è¿™ç§æ–¹å¼çš„ç”¨é€”æ¯”è¾ƒå±€é™ã€‚å¦‚æœä»…ä»…æ˜¯ç”¨äºä¿®æ”¹ ISO ä¸­çš„ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•ï¼Œå¯ä»¥å°†è¯¥æ–‡ä»¶æˆ–ç›®å½•ä»¥ <code>bind</code> æŒ‚è½½çš„æ–¹å¼å°†å®ƒæŒ‚è½½åˆ° ISO ç›®å½•ç›®å½•å¯¹åº”çš„æ–‡ä»¶ä¸Šã€‚</p><p>åŸç†å°±æ˜¯è™½ç„¶ ISO ç›®å½•æœ¬èº«æ˜¯åªè¯»çš„ï¼Œä½†å®ƒé‡Œé¢çš„æ–‡ä»¶å’Œç›®å½•æ˜¯å¯ä»¥ä½œä¸ºä¸€ä¸ªæŒ‚è½½ç‚¹çš„ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘æŠŠæ–‡ä»¶ A æŒ‚è½½åˆ°æ–‡ä»¶ Bï¼Œå¹¶ä¸æ˜¯åœ¨ä¿®æ”¹æ–‡ä»¶ Bï¼Œè¿™å°±æ˜¯ Unix&#x2F;Linux æ–‡ä»¶ç³»ç»Ÿååˆ†å¥‡å¦™çš„åœ°æ–¹ã€‚åŒæ ·è¿ç”¨ bind æŒ‚è½½çš„è¿˜æœ‰ docker çš„ volume ä»¥åŠ pod çš„ volume ä¹Ÿæ˜¯è¿ç”¨åŒæ ·çš„åŸç†ï¼Œä»¥ bind çš„æ–¹å¼å°†å®¿ä¸»æœºä¸Šçš„ç›®å½•æˆ–æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨è¿è¡Œå¯¹åº”çš„ç›®å½•ä¸Šã€‚å¯¹äºä¿®æ”¹åªè¯» ISO é‡Œçš„æ–‡ä»¶&#x2F;ç›®å½•æˆ‘ä»¬å½“ç„¶ä¹Ÿå¯ä»¥è¿™æ ·åšã€‚åºŸè¯ä¸å¤šè¯´æ¥å®è·µéªŒè¯ä¸€ä¸‹ï¼š</p><ul><li>é¦–å…ˆä¾æ—§æ˜¯å°† ISO é•œåƒæŒ‚è½½åˆ° <code>/mn/iso</code> ç›®å½•</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox ~/buildâ•°â”€<span class="token comment"># mount -o loop CentOS-7-x86_64-Minimal-2009.iso /mnt/iso</span>mount: /mnt/iso: WARNING: device write-protected, mounted read-only.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>æ¥ç€åˆ›å»ºä¸€ä¸ª <code>/mnt/files/ks.cfg</code> æ–‡ä»¶ï¼Œå¹¶å†™å…¥æˆ‘ä»¬éœ€è¦çš„å†…å®¹</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox ~/buildâ•°â”€<span class="token comment"># mkdir -p /mnt/files</span>â•­â”€root@esxi-debian-devbox ~/buildâ•°â”€<span class="token comment"># echo '# this is a kickstart config file' > /mnt/files/ks.cfg</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>æ¥ç€ä»¥ mount â€“bind çš„æ–¹å¼æŒ‚è½½æ–°å»ºçš„æ–‡ä»¶åˆ° ISO çš„ EULA æ–‡ä»¶</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox /mnt/buildâ•°â”€<span class="token comment"># mount --bind /mnt/files/ks.cfg /mnt/iso/EULA</span>â•­â”€root@esxi-debian-devbox /mnt/buildâ•°â”€<span class="token comment"># cat /mnt/iso/EULA</span><span class="token comment"># this is a kickstart config file</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¯ä»¥çœ‹åˆ°åŸæ¥ ISO æ–‡ä»¶ä¸­çš„ EULA æ–‡ä»¶å·²ç»è¢«æˆåŠŸæ›¿æ¢æˆäº†æˆ‘ä»¬ä¿®æ”¹çš„æ–‡ä»¶ï¼Œç„¶åå†é‡æ–°æ„å»ºä¸€ä¸‹è¯¥ ISO é•œåƒ</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox /mnt/isoâ•°â”€<span class="token comment"># genisoimage -U -r -v -T -J -joliet-long -V "CentOS 7 x86_64" -volset "CentOS 7 x86_64" -A "CentOS 7 x86_64" -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -no-emul-boot -o /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso .</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>ç„¶åæˆ‘ä»¬å†é‡æ–°æŒ‚è½½æ–°çš„ ISO æ–‡ä»¶éªŒè¯ä¸€ä¸‹æ˜¯å¦å¯ä»¥</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@esxi-debian-devbox /mnt/isoâ•°â”€<span class="token comment"># mkdir /mnt/newiso</span>â•­â”€root@esxi-debian-devbox /mnt/isoâ•°â”€<span class="token comment"># mount -o loop /mnt/CentOS-7-x86_64-Minimal-2009-dev.iso /mnt/newiso</span>mount: /mnt/newiso: WARNING: device write-protected, mounted read-only.â•­â”€root@esxi-debian-devbox /mnt/isoâ•°â”€<span class="token comment"># cat /mnt/newiso/EULA</span><span class="token comment"># this is a kickstart config file</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>éªŒè¯é€šè¿‡ï¼Œç¡®å®å¯ä»¥ï¼ä¸è¿‡è¿™ç§æ–¹å¼å¾ˆå±€é™ï¼Œæ¯”è¾ƒé€‚ç”¨äºä¿®æ”¹å•ä¸ªæ–‡ä»¶å¦‚ <code>kickstart.cfg</code>ï¼Œå¦‚æœæ˜¯è¦æ–°å¢æ–‡ä»¶é‚£è¿˜æ˜¯ä½¿ç”¨ä¸Šæ–‡æåˆ°çš„ overlay2 çš„æ–¹å¼æ›´ä¸ºæ–¹ä¾¿ä¸€äº›ã€‚</p><h2 id="æ”¶è·"><a href="#æ”¶è·" class="headerlink" title="æ”¶è·"></a>æ”¶è·</h2><p>è™½ç„¶ ISO é•œåƒå’Œå®¹å™¨é•œåƒäºŒè€…æœ‰ç€æœ¬è´¨çš„å·®åˆ«ï¼Œä½†å¯¹äºåªè¯»å’Œè”åˆæŒ‚è½½çš„è¿™äº›ç‰¹æ€§äºŒè€…å¯ä»¥ç›¸äº’å€Ÿé‰´æ»´ã€‚</p><p>ä¸æ­¢å¦‚æ­¤ overlay2 è¿™ç§è”åˆæŒ‚è½½çš„ç‰¹æ€§ï¼Œè¿˜å¯ä»¥ç”¨åœ¨å…¶ä»–åœ°æ–¹ã€‚æ¯”å¦‚æˆ‘æœ‰ä¸€ä¸ªå…¬å…±çš„ NFS å…±äº«æœåŠ¡å™¨ï¼Œå…±äº«ç€ä¸€äº›ç›®å½•ï¼Œæ‰€æœ‰äººéƒ½å¯ä»¥ä»¥ root ç”¨æˆ·å¹¶ä»¥è¯»å†™çš„æƒé™è¿›è¡Œ NFS æŒ‚è½½ã€‚è¿™ç§æƒ…å†µä¸‹å¾ˆéš¾ä¿éšœä¸€äº›é‡è¦çš„æ–‡ä»¶å’Œæ•°æ®è¢«è¯¯åˆ ã€‚è¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨ overlay2 çš„æ–¹å¼å°†ä¸€äº›é‡è¦çš„æ–‡ä»¶æ•°æ®æŒ‚è½½ä¸º overlay2 çš„ lowerdir åªè¯»å±‚ï¼Œä¿è¯è¿™äº›æ•°æ®å°±å¦‚å®¹å™¨é•œåƒä¸€æ ·ï¼Œæ¯æ¬¡æŒ‚è½½ä½¿ç”¨çš„æ—¶å€™éƒ½ä½œä¸ºä¸€ä¸ªåªè¯»å±‚ã€‚æ‰€æœ‰çš„è¯»å†™æ“ä½œéƒ½åœ¨ overlay2 çš„ merged é‚£ä¸€å±‚ï¼Œä¸ä¼šçœŸæ­£å½±å“åˆ°åªè¯»å±‚çš„å†…å®¹ã€‚</p><p>è‰è‰åœ°æ°´äº†ä¸€ç¯‡åšå®¢ï¼Œæ˜¯ä¸æ˜¯æ²¡æœ‰ç”¨çš„çŸ¥è¯†åˆå¢åŠ äº† ğŸ˜‚</p><h2 id="æ¨èé˜…è¯»"><a href="#æ¨èé˜…è¯»" class="headerlink" title="æ¨èé˜…è¯»"></a>æ¨èé˜…è¯»</h2><ul><li><a href="https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt">overlayfs.txt</a></li><li><a href="https://arkingc.github.io/2017/05/05/2017-05-05-docker-filesystem-overlay/">Docker å­˜å‚¨é©±åŠ¨â€”Overlay&#x2F;Overlay2ã€Œè¯‘ã€</a></li><li><a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿ ğŸ¤”</a></li><li><a href="https://zdyxry.github.io/2019/01/12/%E8%81%8A%E4%B8%80%E8%81%8A-ISO-9660/">èŠä¸€èŠ ISO 9660</a></li><li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/anaconda_customization_guide/sect-iso-images">WORKING WITH ISO IMAGES</a></li><li><a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 åœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­çš„åº”ç”¨</a></li><li><a href="https://blog.k8s.li/mount-bind.html">mount å‘½ä»¤ä¹‹ â€“bind æŒ‚è½½å‚æ•°</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ç¬”è€…ä¹‹å‰åœ¨å­—èŠ‚è·³åŠ¨çš„æ—¶å€™æ˜¯è´Ÿè´£ PaaS
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="overlay2" scheme="https://blog.k8s.li/tags/overlay2/"/>
    
      <category term="ISO" scheme="https://blog.k8s.li/tags/ISO/"/>
    
  </entry>
  
  <entry>
    <title>Kubespray 2.18 ç‰ˆæœ¬ç‰¹æ€§é¢„è§ˆ</title>
    <link href="https://blog.k8s.li/kubespray-2.18.html"/>
    <id>https://blog.k8s.li/kubespray-2.18.html</id>
    <published>2022-01-04T16:00:00.000Z</published>
    <updated>2022-05-30T14:37:53.855Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘ kubernetes-sig ç¤¾åŒºçš„ <a href="https://github.com/kubernetes-sigs/kubespray">kubespray</a> é¡¹ç›®æ­£å¼ release äº† <a href="https://github.com/kubernetes-sigs/kubespray/releases/tag/v2.18.0">v2.18.0</a> ç‰ˆæœ¬ï¼ŒåŒæ—¶å¯¹åº” <a href="https://github.com/cncf/k8s-conformance">k8s-conformance</a> çš„ <a href="https://github.com/cncf/k8s-conformance/pull/1748">v1.21</a> å’Œ <a href="https://github.com/cncf/k8s-conformance/pull/1760">v1.22</a> ç‰ˆæœ¬ kubespray ä¹Ÿéƒ½å·²ç»å¾—åˆ° CNCF çš„ä¸€è‡´æ€§è®¤è¯ã€‚äºæ˜¯ä»Šå¤©å°±å€Ÿè¿™ä¸ªæ–°ç‰ˆæœ¬ release çš„æœºä¼šæ•´ç†ä¸€ä¸‹ 2.18 ç‰ˆæœ¬çš„ kubespray æœ‰å“ªäº›æœ‰è¶£çš„å˜åŒ–ã€‚</p><h2 id="ç»„ä»¶ç‰ˆæœ¬"><a href="#ç»„ä»¶ç‰ˆæœ¬" class="headerlink" title="ç»„ä»¶ç‰ˆæœ¬"></a>ç»„ä»¶ç‰ˆæœ¬</h2><p>ä»¥ä¸‹æ˜¯ v2.18.0 ç‰ˆæœ¬ä¸­ kubespray éƒ¨ç½²ç»„ä»¶çš„ä¸€äº›ç‰ˆæœ¬ä¿¡æ¯ï¼š</p><h3 id="K8s-æ ¸å¿ƒç»„ä»¶"><a href="#K8s-æ ¸å¿ƒç»„ä»¶" class="headerlink" title="K8s æ ¸å¿ƒç»„ä»¶"></a>K8s æ ¸å¿ƒç»„ä»¶</h3><ul><li>kubespray æ”¯æŒçš„ Kubernetes æ”¯æŒä» v1.22.0 åˆ° v1.23.1 ä¹‹é—´çš„æ‰€æœ‰æ­£å¼ç‰ˆæœ¬ï¼Œé»˜è®¤éƒ¨ç½²çš„ç‰ˆæœ¬ä¸º v1.22.5ï¼Œå¹¶ä¸” <a href="https://github.com/cncf/k8s-conformance/pull/1760">v1.22</a> ç‰ˆæœ¬å¾—åˆ°äº† CNCF å®˜æ–¹çš„ä¸€è‡´æ€§è®¤è¯ï¼›</li><li>etcd ä»åŸæ¥çš„ v3.4.13 å‡çº§åˆ°äº† v3.5.0ï¼›</li><li>coredns ç‰ˆæœ¬å‡çº§åˆ°äº† v1.8.0ï¼Œå®ƒçš„æ­æ¡£ dnsautoscaler åˆ™ä¸º 1.8.5ï¼›</li><li>pod_infra å³ pause é•œåƒçš„ç‰ˆæœ¬æ²¡æœ‰å˜åŒ–ä¾æ—§ä¸º 3.3ï¼›</li></ul><table><thead><tr><th>Addon</th><th align="left">Version</th></tr></thead><tbody><tr><td>kube</td><td align="left">v1.22.5</td></tr><tr><td>pod_infra</td><td align="left">3.3</td></tr><tr><td>etcd</td><td align="left">v3.5.0</td></tr><tr><td>coredns</td><td align="left">v1.8.0</td></tr></tbody></table><h3 id="å®¹å™¨è¿è¡Œæ—¶"><a href="#å®¹å™¨è¿è¡Œæ—¶" class="headerlink" title="å®¹å™¨è¿è¡Œæ—¶"></a>å®¹å™¨è¿è¡Œæ—¶</h3><p>ç›®å‰å¸‚é¢ä¸Šæ‰€æœ‰çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·ä¸­ï¼Œå¯¹å®¹å™¨è¿è¡Œæ—¶çš„æ”¯æŒ kubespray æ— ç–‘æ˜¯æœ€ä¸°å¯Œçš„ã€‚éƒ¨ç½²èƒ½æ”¯æŒ dockerã€containerdã€crunã€kataã€cri-oã€‚é»˜è®¤çš„å®¹å™¨è¿è¡Œæ—¶å·²ç»ä»ä¹‹å‰çš„ docker åˆ‡æ¢åˆ°äº† containerdï¼Œcontainerd çš„ç‰ˆæœ¬æ˜¯ v1.5.8ã€‚</p><table><thead><tr><th>Addon</th><th>Version</th></tr></thead><tbody><tr><td>containerd</td><td>1.5.8</td></tr><tr><td>docker</td><td>20.10</td></tr><tr><td>docker_containerd</td><td>1.4.12</td></tr><tr><td>crun</td><td>1.3</td></tr><tr><td>runc</td><td>v1.0.3</td></tr><tr><td>crio</td><td>1.22</td></tr><tr><td>kata_containers</td><td>2.2.3</td></tr><tr><td>gvisor</td><td>20210921</td></tr></tbody></table><h3 id="CNI"><a href="#CNI" class="headerlink" title="CNI"></a>CNI</h3><p>åŒæ ·ï¼Œç›®å‰å¸‚é¢ä¸Šæ‰€æœ‰çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·ä¸­ï¼Œå¯¹ CNI çš„æ”¯æŒ kubespray ä¹Ÿæ— ç–‘æ˜¯æœ€ä¸ºä¸°å¯Œçš„ï¼Œèƒ½æ”¯æŒ 9 ç§ CNI ä»¥åŠå¤šç§ CNI ç»„åˆéƒ¨ç½²çš„ <a href="https://github.com/intel/multus-cni">multus</a> ã€‚</p><table><thead><tr><th>Addon</th><th>Version</th></tr></thead><tbody><tr><td>calico</td><td>v3.20.3</td></tr><tr><td>flannel</td><td>v0.15.1</td></tr><tr><td>flannel_cni</td><td>v1.0.0</td></tr><tr><td>cni</td><td>v1.0.1</td></tr><tr><td>weave</td><td>2.8.1</td></tr><tr><td>cilium</td><td>v1.9.11</td></tr><tr><td>kube_ovn</td><td>v1.8.1</td></tr><tr><td>kube_router</td><td>v1.3.2</td></tr><tr><td>multus_cni</td><td>0.4.0</td></tr><tr><td>multus</td><td>v3.8</td></tr></tbody></table><h3 id="Kubernetes-app"><a href="#Kubernetes-app" class="headerlink" title="Kubernetes-app"></a>Kubernetes-app</h3><p>åŒæ—¶ï¼Œkubespray è¿˜æ”¯æŒä¸€äº› CLI å·¥å…·ä»¥åŠç¬¬ä¸‰æ–¹åº”ç”¨çš„éƒ¨ç½²ã€‚</p><ul><li>CLI å·¥å…·</li></ul><p>ä¸€äº› CLI å·¥å…·ï¼Œæ¯”å¦‚ helmã€nerdctlã€krewã€crictlã€‚å…¶ä¸­ nerdctl çš„éƒ¨ç½²æ”¯æŒæ˜¯å’±åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/7500">#7500</a> ä¸­åŠ å…¥æ”¯æŒçš„ï¼Œç›®çš„æ˜¯ä¸º containerd ç”¨æˆ·æä¾›ä¸€ä¸ªç›¸å¯¹å‹å¥½çš„å‘½ä»¤è¡Œæ“ä½œä½“éªŒï¼Œä»¥æ›¿ä»£ docker CLIã€‚</p><table><thead><tr><th>addon</th><th>version</th></tr></thead><tbody><tr><td>helm</td><td>v3.7.1</td></tr><tr><td>nerdctl</td><td>0.15.0</td></tr><tr><td>krew</td><td>v0.4.2</td></tr><tr><td>crictl</td><td>v1.22.0</td></tr></tbody></table><ul><li>app</li></ul><p>ä¸ªäººæ„Ÿè§‰éƒ¨ç½²ä¸€äº›åƒ <code>dnsautoscaler</code>ã€ <code>argoCD</code> è¿™æ ·çš„åº”ç”¨ï¼Œè¿˜æ˜¯ä½¿ç”¨ helm æ¯”è¾ƒå¥½ã€‚å› ä¸ºåŸºäº ansible çš„ kubespray ç»´æŠ¤è¿™ä¹ˆå¤šç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œä»¥åŠå®ƒä»¬çš„å‡çº§ç®¡ç†éƒ½è¿œä¸å¦‚ helm æ–¹ä¾¿ã€‚å› æ­¤è€ƒè™‘åˆ°è¿™äº›ç»„ä»¶çš„å‡çº§ç»´æŠ¤æˆæœ¬ï¼Œä¸ªäººè¿˜æ˜¯ä¸å¤ªå»ºè®®ä½¿ç”¨ kubespray æ¥éƒ¨ç½²è¿™äº›ç»„ä»¶ã€‚</p><table><thead><tr><th>Addon</th><th>Version</th></tr></thead><tbody><tr><td>dnsautoscaler</td><td>1.8.5</td></tr><tr><td>netcheck</td><td>v1.2.2</td></tr><tr><td>nodelocaldns</td><td>1.21.1</td></tr><tr><td>metrics_server</td><td>v0.5.0</td></tr><tr><td>cert_manager</td><td>v1.5.4</td></tr><tr><td>addon_resizer</td><td>1.8.11</td></tr><tr><td>cinder_blockstorage</td><td>v3</td></tr><tr><td>external_vsphere</td><td>6.7u3</td></tr><tr><td>nvidia_driver</td><td>390.87</td></tr><tr><td>oci_cloud_controller</td><td>0.7.0</td></tr><tr><td>metallb</td><td>v0.10.3</td></tr><tr><td>argocd</td><td>v2.1.6</td></tr></tbody></table><h2 id="æ”¯æŒçš„-OS"><a href="#æ”¯æŒçš„-OS" class="headerlink" title="æ”¯æŒçš„ OS"></a>æ”¯æŒçš„ OS</h2><table><thead><tr><th>distribution</th><th>version</th></tr></thead><tbody><tr><td>Amazon Linux</td><td>2</td></tr><tr><td>Fedora CoreOS</td><td>34.x&#x2F;35.x</td></tr><tr><td>Flatcar Container Linux by Kinvolk</td><td></td></tr><tr><td>Alma Linux</td><td>8</td></tr><tr><td>Rocky Linux</td><td>8</td></tr><tr><td>CentOS&#x2F;RHEL</td><td>7&#x2F;8</td></tr><tr><td>Oracle Linux</td><td>7&#x2F;8</td></tr><tr><td>Debian</td><td>8&#x2F;9&#x2F;10&#x2F;11</td></tr><tr><td>Ubuntu</td><td>16.04&#x2F;18.04&#x2F;20.04</td></tr><tr><td>Fedora</td><td>34&#x2F;35</td></tr><tr><td>openSUSE</td><td>Leap 15.x&#x2F;Tumbleweed</td></tr></tbody></table><h2 id="ä¸»è¦å˜åŒ–"><a href="#ä¸»è¦å˜åŒ–" class="headerlink" title="ä¸»è¦å˜åŒ–"></a>ä¸»è¦å˜åŒ–</h2><h3 id="åºŸé™¤"><a href="#åºŸé™¤" class="headerlink" title="åºŸé™¤"></a>åºŸé™¤</h3><ul><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8086">#8086</a> ä¸­ç§»é™¤äº†å¯¹ Ambassador çš„æ”¯æŒï¼›</li><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8327">#8327</a> ä¸­ç§»é™¤äº†å¯¹ registry-proxy çš„æ”¯æŒï¼›</li><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8246">#8246</a> ä¸­ç§»é™¤äº†å¯¹ Fedora 33 çš„æ”¯æŒï¼Œå› ä¸º  Fedora 33 åœ¨ 2021-11-30 å°±å·²ç» EOL äº†ï¼Œæ‰€ä»¥è¢«åºŸå¼ƒæ”¯æŒä¹Ÿç†æ‰€å½“ç„¶ï¼›</li><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8265">#8265</a> ä¸­ç§»é™¤äº†å¯¹ Mitogen çš„æ”¯æŒï¼ŒMitogen çš„ä½œç”¨å°±æ˜¯ç”¨æ¥ä¼˜åŒ– Ansible çš„æ€§èƒ½ï¼Œä½† Mitogen å¯¹äºä¸€äº›æ–°çš„ Linux å‘è¡Œç‰ˆæ”¯æŒçš„é¢å¹¶ä¸æ˜¯å¾ˆå‹å¥½ï¼Œåœ¨ Kubespray ä¸­ç»´æŠ¤çš„æˆæœ¬ä¹Ÿæ¯”è¾ƒå¤§ï¼Œå› æ­¤ç¤¾åŒºå°±åºŸå¼ƒå®ƒäº†ï¼›</li></ul><h3 id="æ–°ç‰¹æ€§"><a href="#æ–°ç‰¹æ€§" class="headerlink" title="æ–°ç‰¹æ€§"></a>æ–°ç‰¹æ€§</h3><ul><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/7895">#7895</a> ä¸­æ–°å¢äº† ArgoCD çš„éƒ¨ç½²æ”¯æŒï¼Œé€šè¿‡è®¾ç½® <code>argocd_enabled</code> å³å¯åœ¨éƒ¨ç½²é›†ç¾¤çš„æ—¶å€™å®‰è£… ArgoCDã€‚ä¸è¿‡ä¸ªäººè®¤ä¸ºï¼ŒArgoCD è¿™ç©æ„å„¿ä¸å¤ªé€‚åˆæ”¾åœ¨ K8s éƒ¨ç½²å½“ä¸­æ¥ï¼Œçœ‹çœ‹ <a href="https://github.com/kubesphere/ks-installer">ks-installer</a> çš„ä»£ç ä½ å°±èƒ½æ˜ç™½äº† ğŸ˜‚ã€‚</li><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8175">#8175</a> ä¸­é»˜è®¤ä½¿ç”¨ containerd ä½œä¸ºé»˜è®¤çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œæ›¿ä»£æ‰äº† dockerã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“å‰ç‰ˆæœ¬çš„ kubespray æ˜¯ä½¿ç”¨ <a href="https://github.com/containerd/containerd">containerd</a> å®˜æ–¹ repo release çš„äºŒè¿›åˆ¶å®‰è£…åŒ…ï¼Œä½†äºŒè¿›åˆ¶å®‰è£…åŒ…å¹¶æ²¡æœ‰ arm64 ç‰ˆæœ¬çš„ã€‚æ‰€ä»¥å¦‚æœè¦éƒ¨ç½²çš„é›†ç¾¤èŠ‚ç‚¹åŒ…å« arm64 çš„æœºå™¨ï¼Œæœ€å¥½è¿˜æ˜¯ä½¿ç”¨ docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ã€‚</li><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8291">#8291</a> æ–°å¢äº† registry éƒ¨ç½²æ”¯æŒå¤šç§ ServiceTypes çš„æ”¯æŒï¼›</li><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8229">#8229</a> ä¸­æ–°å¢äº†æ”¯æŒ registry è®¤è¯çš„æ–¹å¼ï¼Œç§æœ‰åŒ–éƒ¨ç½²çš„æ—¶å€™ä½¿ç”¨å¸¦æœ‰è®¤è¯çš„ registry ä¼šç”¨åˆ°ï¼›</li></ul><h3 id="å·²çŸ¥é—®é¢˜"><a href="#å·²çŸ¥é—®é¢˜" class="headerlink" title="å·²çŸ¥é—®é¢˜"></a>å·²çŸ¥é—®é¢˜</h3><ul><li>åœ¨ <a href="https://github.com/kubernetes-sigs/kubespray/pull/8239">#8239</a> ä¸­ <a href="https://github.com/cristicalin">cristicalin</a> å¤§ä½¬å¼•å…¥äº†ä¸€ä¸ªä¿®æ”¹ï¼Œå¦‚æœæ˜¯ containerd è¿è¡Œæ—¶ï¼Œåˆ™ä½¿ç”¨ nerdctl ä¸‹è½½é•œåƒã€‚è¿™å°†ä¼šå¯¼è‡´é…ç½®äº† containerd registry mirrors çš„å‚æ•°å°†ä¼šå¤±æ•ˆã€‚</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;æœ€è¿‘ kubernetes-sig ç¤¾åŒºçš„ &lt;a
        
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>æ—¶å…‰ç—•è¿¹ï¼š2021 å¹´æ€»ç»“</title>
    <link href="https://blog.k8s.li/2021.html"/>
    <id>https://blog.k8s.li/2021.html</id>
    <published>2022-01-02T16:00:00.000Z</published>
    <updated>2022-05-30T14:37:53.851Z</updated>
    
    <content type="html"><![CDATA[<p>2021 ä¾æ—§æ˜¯äººç±»ç¤¾ä¼š<strong>å€’è½¦å’ŒåŠ é€Ÿç­äº¡</strong>çš„ä¸€å¹´ï¼Œå…¨çƒèŒƒå›´å†…æ–°å† ç—…æ¯’ä¾æ—§åœ¨è‚†è™ï¼Œæ–°çš„å˜å¼‚åˆæ¥è¸µè€Œæ¥ï¼Œç–«æƒ…å¹¶æ²¡æœ‰å¤šå°‘æ¶ˆé€€çš„è¿¹è±¡ã€‚è€Œç°åœ¨å›½å†…è¥¿å®‰ç–«æƒ…åˆçˆ†å‘å¼€æ¥ï¼Œæ— æ³•é¢„æƒ³æœªæ¥ç©¶ç«Ÿèƒ½å˜æˆä»€ä¹ˆæ ·å­ã€‚</p><h2 id="é˜…è¯»"><a href="#é˜…è¯»" class="headerlink" title="é˜…è¯»"></a>é˜…è¯»</h2><p>2021 å¹´ 9 æœˆä»½çš„æ—¶å€™å°†ä¹¦å•ä»åŸæ¥çš„ Markdown æ–‡æœ¬è¿ç§»åˆ°äº† Notion ä¸Šï¼Œä½“éªŒååˆ†æ£’ã€‚Notion çš„è¡¨æ ¼æ•°æ®åº“åŠŸèƒ½ååˆ†å¼ºå¤§ï¼Œå¯¹ä¹¦å•æ¥è¯´ç®€ç›´å°±æ˜¯ä¸€ä»¶ç¥å™¨ã€‚æŠ½ç©ºæ•´ç†äº†ä¸€ä¸‹ä¹¦å•  <a href="https://reading.k8s.li/">reading.k8s.li</a>  ï¼Œ2021 å¹´å¤§æ¦‚è¯»å®Œäº† 97 æœ¬ä¹¦ã€‚å…¶ä¸­ç§‘æ™® 27 æœ¬ã€æ¼«ç”» 17 æœ¬ã€å†å² 13 æœ¬ã€æ”¿æ²» 11 æœ¬ã€è½»å°è¯´ 8 æœ¬ã€ç¤¾ç§‘ 7 æœ¬ã€å¿ƒç†å­¦ 5 æœ¬ã€æŠ€æœ¯ 5 æœ¬ã€æ³•å¾‹ 2 æœ¬ã€‚ä¹‹æ‰€ä»¥èƒ½è¯»å®Œè¿™ä¹ˆå¤šä¹¦å¤§æ¦‚æ˜¯å› ä¸ºå¦‚ä¸‹ ğŸ˜‚ï¼š</p><ul><li>å•èº«ç‹¬å±…ï¼Œè‡ªå·±ä¸€ä¸ªäººç”Ÿæ´»ï¼Œæ²¡äººæ‰“æ‰°ï¼›</li><li>ä¸å–œæ¬¢ç¤¾äº¤ï¼Œä¸å–œæ¬¢ç¾¤èŠé—²èŠæ‰¯æ·¡æ’•é€¼ï¼›</li><li>ä¸ç©æ¸¸æˆä¸åˆ·çŸ­è§†é¢‘ï¼Œæ²¡æœ‰å…¶ä»–çˆ±å¥½ï¼›</li><li>å‘¨æœ«å’ŒèŠ‚å‡æ—¥å¤§å¤šæ•°å®…åœ¨å®¶é‡Œç©å„¿ï¼›</li></ul><p>å…¶ä¸­æˆ‘è§‰ç€å•èº«ç‹¬å±…æ˜¯æœ€ä¸»è¦çš„åŸå› ï¼Œæ¯”å¦‚ <a href="https://twitter.com/yihong0618">ä¼Šæ´ª</a> è€å“¥ä¹Ÿæ˜¯å¦‚æ­¤ï¼š</p><p><img data-src="https://p.k8s.li/image-20220103202406764.png" alt="image-20220103202406764"></p><p>æ ¹æ®ä¸ªäººçš„å–œå¥½ï¼Œå°±åˆ†äº«ä»¥ä¸‹ 10 æœ¬æˆ‘ä¸ªäººè§‰ç€ååˆ†æœ‰æ„æ€çš„ä¹¦ç»™å¤§å®¶ï¼š</p><p><img data-src="https://p.k8s.li/image-20220103202406766.png" alt="Snipaste_2021-12-31_19-28-11"></p><p>ç”±äºè¯»ä¹¦ç¬”è®°çš„ç¯‡å¹…å¤ªé•¿ï¼Œåé¢æœ‰ç©ºçš„è¯æˆ‘ä¼šå’Œå»å¹´çš„ã€Š<a href="https://blog.k8s.li/2020-booklist.html">2020 å¹´è¯»ä¹¦ç¬”è®°å’Œæ€è€ƒ</a>ã€‹ä¸€æ ·ï¼Œå†å†™ä¸€ç¯‡ 2021 å¹´çš„è¯»ä¹¦ç¬”è®°æ¥åˆ†äº«ç»™å¤§å®¶ï¼ˆå¤§æ¦‚ç‡æ˜¯åœ¨æ˜¥èŠ‚æœŸé—´å†™äº†ï¼‰ã€‚</p><h2 id="å·¥ä½œ"><a href="#å·¥ä½œ" class="headerlink" title="å·¥ä½œ"></a>å·¥ä½œ</h2><h3 id="å­—èŠ‚è·³åŠ¨"><a href="#å­—èŠ‚è·³åŠ¨" class="headerlink" title="å­—èŠ‚è·³åŠ¨"></a>å­—èŠ‚è·³åŠ¨</h3><p>ä»Šå¹´æœ€å¤§çš„å˜åŒ–å°±æ˜¯æ¢äº†æ–°å·¥ä½œï¼Œè¿™ä¹Ÿæ˜¯ç¬¬äºŒæ¬¡æ¢å·¥ä½œã€‚æœ¬æ¥æ²¡æœ‰æ‰“ç®—ç¦»èŒï¼Œä½†æ˜¯è¢«è¿«<del>å­—èŠ‚</del>è·³åŠ¨äº†ä¸€å¹´ä¹‹åï¼Œæ„Ÿè§‰å¤ªç´¯äº†ï¼Œå¹¶æ²¡æœ‰æƒ³è±¡ä¸­çš„é‚£ä¹ˆå¿«ä¹ã€‚</p><p>ä¸å¾—ä¸åæ§½ä¸€ä¸‹å­—èŠ‚çš„åŸºç¡€è®¾æ–½åšçš„å®åœ¨æ˜¯å¤ªçƒ‚äº†ï¼Œæ¯”å¦‚é•œåƒä»“åº“å„ç§å¥‡è‘©çš„é—®é¢˜ã€‚å½“æ—¶è¿˜å› ä¸ºè¿™ç ´ç©æ„å„¿å‡ºè¿‡ç‰ˆæœ¬å‘å¸ƒçš„é”™è¯¯ï¼Œå¯¼è‡´ç»„ä»¶ç¼–è¯‘çš„ base é•œåƒå‡ºé”™ï¼Œåæ¥åˆä¸å¾—ä¸é‡æ–°å‘å¸ƒä¸€ä¸ªç‰ˆæœ¬æ¥æ“¦å±è‚¡ã€‚</p><p>è¿˜æœ‰å½“æ—¶ PaaS å®¹å™¨äº‘å¹³å°ç§æœ‰åŒ–äº§å“ç‰ˆæœ¬å‘å¸ƒçš„æ—¶å€™ï¼Œé¢†å¯¼éå¾—å°†æ‰“åŒ…å‘å¸ƒçš„æ—¶é—´ç‚¹å®šåœ¨ä¸´è¿‘æ™šä¸Šä¸‹ç­çš„æ—¶å€™ã€‚è¿™å°±ä¼šå¯¼è‡´æˆ‘ä»¬ç»„ï¼ˆè‹¦å‘½å‘ç‰ˆå·¥å…·äººï¼‰å¿™æ´»åˆ°æ™šä¸Šåä¸€äºŒç‚¹ï¼ŒçœŸçš„æ˜¯ååˆ†ä¸çˆ½ã€‚å°±æ˜¯å› ä¸ºä¸€äº›å…¬å…±äº‹åŠ¡æ²¡æœ‰åšå¥½ï¼Œä¸€äº›é—®é¢˜åœ¨ç»„ä»¶è‡ªèº«çš„ CI&#x2F;CD æµæ°´çº¿ä¸­å¹¶ä¸èƒ½åŠæ—¶æš´éœ²ï¼Œç­‰åˆ°æœ€ç»ˆæœ€åç‰ˆæœ¬å‘å¸ƒçš„æ—¶å€™ï¼Œå„ç§å¥‡è‘©çš„é—®é¢˜çªçªçªåœ°å†’å‡ºæ¥ã€‚æ¯”å¦‚ç¼ºé•œåƒã€é•œåƒé”™è¯¯ã€helm chart é”™è¯¯ã€ç‰ˆæœ¬é”™è¯¯ç­‰ã€‚ç„¶åå‡ºäº†é—®é¢˜ä¹‹ååˆè¦ @ å„ä¸ªç»„ä»¶çš„ owner å»è§£å†³é—®é¢˜ï¼Œå®ƒä»¬ä¿®æ”¹å¥½ä¹‹åæˆ‘ä»¬å†é‡æ–°æ‰“åŒ…éƒ¨ç½²æ–°çš„ç¯å¢ƒæ¥éªŒè¯ã€‚æ¯åˆ°å‘ç‰ˆæ—¥å°±ååˆ†ç—›è‹¦ï¼Œä¸€äº›åŸºç¡€è®¾æ–½å’Œå…¬å…±äº‹åŠ¡æ²¡æœ‰åšå¥½ï¼Œç­‰åˆ°æœ€åæˆ‘ä»¬å‘ç‰ˆå·¥å…·äººæ¥æ“¦å±è‚¡ã€‚è¿™è®©æˆ‘æƒ³èµ·äº†å¦ä¸€ä½æ¨å‹åˆ†äº«çš„ç»å†ï¼š</p><p><img data-src="https://p.k8s.li/image-20220104082135898.png" alt="image-20220104082135898"></p><h3 id="è£¸è¾ç¦»èŒ"><a href="#è£¸è¾ç¦»èŒ" class="headerlink" title="è£¸è¾ç¦»èŒ"></a>è£¸è¾ç¦»èŒ</h3><p>å››æœˆåº•å’Œ leader ç»©æ•ˆæ²Ÿé€šå®Œåæ„Ÿè§‰ä¸å¤ªæ»¡æ„äºæ˜¯å†…å¿ƒå°±å†³å®šäº†è¦ç¦»èŒã€‚ä¸è¿‡å› ä¸ºå½“æ—¶ä¸€äº›ç»„ç»‡æ¶æ„çš„è°ƒæ•´ï¼Œæˆ‘æ‰€åšçš„å·¥ä½œæ²¡æœ‰ä¸€ä¸ªåˆé€‚çš„äººæ¥æ¥ç›˜ã€‚å†åŠ ä¸Šæ–°äº§å“åˆšè¿›å…¥è®¾è®¡é˜¶æ®µï¼Œæ–°äº§å“å¹³å°åº•å±‚çš„ K8s éƒ¨ç½²ä»¥åŠç§æœ‰åŒ–æ‰“åŒ…å‘å¸ƒç›¸å…³çš„å·¥ä½œæ²¡æœ‰å…¶ä»–äººèƒ½å¤Ÿ take èµ·æ¥ï¼Œæœ€å°´å°¬çš„æ˜¯è¿™éƒ¨åˆ†å·¥ä½œå½“æ—¶åªæœ‰æˆ‘ä¸€ä¸ªäººèƒ½å®Œæ•´åœ°åšå‡ºæ¥ã€‚å¦‚æœåœ¨äº”æœˆåº•ç¦»èŒçš„è¯ï¼Œå¯èƒ½ä¼šå¯¹æ–°äº§å“çš„å¼€å‘å¸¦æ¥ä¸€å®šå½±å“ã€‚å› æ­¤å½“æ—¶è€ƒè™‘äº†ä¸€ä¸‹ï¼Œè¿˜æ˜¯ç­‰åˆ°æ–°äº§å“ç¨³å®šå‘ç‰ˆä»¥åŠæŠŠè´Ÿè´£çš„å·¥ä½œäº¤æ¥ç»™æ–°äººä¹‹åå†ç¦»å¼€å§ã€‚</p><p>å°±è¿™æ ·è‡ªå·±ä¸€ä¸ªäººåˆé‡æ–°è´Ÿè´£èµ·äº†æ•´ä¸ª PaaS å¹³å°çš„ç§æœ‰åŒ–éƒ¨ç½²å’Œæ‰“åŒ…å‘å¸ƒç›¸å…³çš„å·¥ä½œï¼Œè¿™æ®µæ—¶é—´ä¹Ÿæ”¶è·æŒºå¤šçš„ï¼Œé¡ºä¾¿ç»™ kubernetes-sig ç¤¾åŒºçš„ kubespray é¡¹ç›®è´¡çŒ®äº†åå‡ ä¸ª <a href="https://github.com/kubernetes-sigs/kubespray/pulls?q=is:pr+author:muzi502+is:closed">PR</a>ã€‚ç­‰åˆ°ä¸ƒæœˆåº•çš„æ—¶å€™ï¼Œæ–°äº§å“å·²ç»è¿›å…¥äº†ç¨³å®šå¼€å‘çš„é˜¶æ®µï¼Œåœ¨ç¬¬ä¸€ä¸ª alpha.1 ç‰ˆæœ¬æ—¶å°±æå®šäº†ç§æœ‰åŒ–éƒ¨ç½²å’Œç§æœ‰åŒ–æ‰“åŒ…çš„æµæ°´çº¿ï¼Œåˆç»è¿‡ä¸‰ä¸ª sprint çš„è¿­ä»£åï¼Œç»ˆäºç¨³å®šäº†ä¸‹æ¥ã€‚ä¹‹åå°±æ•´ç†äº†ä¸€äº›å¹³æ—¶ç§¯ç´¯çš„æ–‡æ¡£ï¼Œäº¤æ¥ç»™äº†å…¶ä»–åŒäº‹ï¼Œç„¶ååŠç†ç¦»èŒæ‰‹ç»­èµ°äººã€‚</p><p>è£¸è¾çš„åŸå› ä¹Ÿæœ‰å¾ˆå¤šï¼šæƒ³èµ°å‡ºå¿ƒç†èˆ’é€‚åœˆï¼Œæ¢ä¸ªç¯å¢ƒèƒ½è®©è‡ªå·±æˆé•¿èµ·æ¥ï¼›å½“æ—¶å¯¹å·¥ä½œä¹Ÿæœ‰äº†ä¸€ç‚¹åŒå€¦ï¼Œæƒ³å¥½å¥½ä¼‘æ¯ä¸€ä¸‹ï¼›å½“æ—¶çš„çŠ¶æ€ä¹Ÿä¸æ˜¯å¾ˆå¥½ï¼Œå¦‚æœé‚£æ—¶å€™å‡†å¤‡é¢è¯•çš„è¯ï¼Œæ„Ÿè§‰æ•ˆæœä¸å¤ªå¥½ï¼›å¾ˆä¹…æ²¡æœ‰å›å®¶äº†ï¼Œæƒ³åœ¨å®¶å¥½å¥½ä¼‘æ¯ä¸€æ®µæ—¶é—´ã€‚å½“æ—¶ä¹Ÿæ²¡æœ‰é€‰æ‹©ä¼‘å‡ï¼Œè€Œæ˜¯å°†æ‰€æœ‰çš„å‡æœŸéƒ½æŠ˜ç®—æˆåŒå€å·¥èµ„äº†ï¼Œæ„Ÿè§‰è¿™æ ·æ›´åˆ’ç®—ä¸€äº›ã€‚å¦‚æœæ˜¯ä¼‘å‡çš„è¯ï¼Œä¿ä¸å‡†åœ¨ä¼‘å‡çš„æ—¶å€™ä»è¦åœ¨é£ä¹¦ä¸Šå¤„ç†ä¸€äº›åŒäº‹çš„é—®é¢˜ã€‚æ„Ÿè§‰è¿™æ ·å°±æŒºçƒ¦äººçš„ï¼Œæ‰€ä»¥å¹²è„†å°±ç›´æ¥èµ°äººï¼Œé£ä¹¦éƒ½æ²¡äº†è¿˜æ€ä¹ˆè”ç³»æˆ‘ã€‚</p><p>ç¦»èŒçš„ç¬¬äºŒå¤©å°±æ”¶æ‹¾è¡Œæå›è€å®¶ï¼Œå› ä¸ºè€çˆ¸çš„ç”Ÿæ—¥å¿«åˆ°äº†ï¼Œä¹Ÿæƒ³å°½å¿«å›å®¶å’Œå®¶äººå›¢èšã€‚</p><p>ä¹‹åå°±ä¸€ç›´åœ¨å®¶åˆ’æ°´æ‘¸é±¼å•¦ï¼ŒæœŸé—´èŠ±äº†ä¸¤å‘¨å·¦å³çš„æ—¶é—´å®Œæˆäº†ä¸¤ä¸ªå¼€æºé¡¹ç›®ï¼šä¸€ä¸ªæ˜¯ç”¨äºæ„å»º yum&#x2F;apt&#x2F;dnf ç¦»çº¿æºçš„å·¥å…· <a href="https://github.com/k8sli/os-packages">k8sli&#x2F;os-packages</a> ï¼Œä»¥åŠæ— ç½‘ç¯å¢ƒä¸­ç¦»çº¿éƒ¨ç½² k8s çš„å·¥å…·  <a href="https://github.com/k8sli/kubeplay">k8sli&#x2F;kubeplay</a> ã€‚</p><h3 id="é¢è¯•"><a href="#é¢è¯•" class="headerlink" title="é¢è¯•"></a>é¢è¯•</h3><p>æ­£å¼å¼€å§‹å‡†å¤‡é¢è¯•æ˜¯åœ¨ 9 æœˆåˆçš„æ—¶å€™ï¼Œå·²ç»åˆ’æ°´æ‘¸é±¼ä¸€ä¸ªæœˆäº†ï¼Œæ„Ÿè§‰ä¼‘æ¯çš„ä¹Ÿå·®ä¸å¤šäº†ã€‚è¿˜æ˜¯èµ¶ç´§æ‰¾å·¥ä½œé¢è¯•å§ï¼Œåœ¨èµ·åˆçš„ä¸€å‘¨æ˜¯é€šè¿‡ä¸€äº›å¿ƒä»ªå…¬å¸çš„å®˜ç½‘ä¸ŠæŠ•é€’çš„ç®€å†ï¼Œä¸å¹¸çš„æ˜¯æ”¶åˆ°çš„å›å¤å¾ˆå°‘ã€‚å½“æ—¶å¿ƒé‡Œæœ‰ç‚¹æ…Œï¼Œå†™äº†ç¯‡æ±‚èŒã€Š<a href="https://blog.k8s.li/jobs.html">æ±‚èŒè´´ï¼šè¿ç»´å¼€å‘ ï½œSRE</a>ã€‹ä»‹ç»äº†ä¸€ä¸‹è‡ªå·±çš„ç°çŠ¶ï¼Œç»ˆäºæ”¶åˆ°äº†ä¸€äº›å°ä¼™ä¼´ä»¬çš„å†…æ¨ã€‚</p><p><img data-src="https://p.k8s.li/image-20211231205927088.png" alt="image-20211231205927088"></p><p>åœ¨æ­¤è¿˜æ˜¯ååˆ†æ„Ÿè°¢å¸®åŠ©æˆ‘å†…æ¨çš„å°ä¼™ä¼´ï¼Œåœ¨æˆ‘å³å°†èµ°æŠ•æ— è·¯çš„æ—¶å€™æœ‰ä½ ä»¬çš„æ¨èæ‰æœ‰äº†æˆ‘ç°åœ¨çš„å·¥ä½œæœºä¼šã€‚å¤§å¤§å°å°çš„é¢è¯•æ€»å…±è¿›è¡Œäº† 25 æ¬¡å§ï¼Œå·®ä¸å¤šé€šè¿‡äº†ä¸€åŠï¼Œæ‹¿åˆ° 4 ä¸ªä¹¦é¢ offerï¼Œæœ€ç»ˆå»äº†ä¸€å®¶åš IaaS è™šæ‹ŸåŒ–å’Œåˆ†å¸ƒå¼å—å­˜å‚¨äº§å“çš„ toB å…¬å¸ã€‚</p><p>å› ä¸ºä¹‹å‰æ˜¯åœ¨å­—èŠ‚è·³åŠ¨åš PaaS toB äº§å“çš„é›†ç¾¤éƒ¨ç½²å’Œç§æœ‰åŒ–äº¤ä»˜ç›¸å…³å·¥ä½œï¼Œåœ¨æ–°å·¥ä½œåˆ™æ˜¯åš IaaS toB äº§å“çš„é›†ç¾¤éƒ¨ç½²ç›¸å…³å·¥ä½œï¼Œéƒ½æ˜¯â€œé›†ç¾¤éƒ¨ç½²â€ç›¸å…³çš„ï¼Œå› æ­¤å’Œä»¥å¾€çš„ç»å†æ¯”è¾ƒåŒ¹é…ã€‚å¯¹äºåƒå’±è¿™ç§å–œæ¬¢æŠ˜è…¾çš„åƒåœ¾ä½¬æ¥è¯´ï¼Œè¿˜æ˜¯ç¡¬ä»¶æœåŠ¡å™¨ã€æ“ä½œç³»ç»Ÿã€è™šæ‹ŸåŒ–ã€åˆ†å¸ƒå¼å­˜å‚¨ç­‰æ–¹é¢çš„å†…å®¹æ¯”è¾ƒæœ‰æ„æ€ï¼Œç©èµ·æ¥å¯å¼€å¿ƒæƒ¹ ğŸ¤£ã€‚</p><p>æ›´ä¸ºé‡è¦çš„ä¸€ç‚¹æ˜¯æ–°å·¥ä½œä¸å†åƒä»¥å‰é‚£æ ·è¿ç»´æŠ€æœ¯ä¸ºä¸»äº†ï¼Œè€Œè‡³ä»¥åç«¯ç ”å‘ä¸ºä¸»ã€‚å…¶å®æˆ‘å¾ˆæ—©ä¹‹å‰å°±æƒ³å†™ä¸€äº› Go&#x2F;Python åç«¯é¡¹ç›®çš„ä»£ç äº†ï¼Œåªä¸è¿‡ä¸€ç›´æ²¡æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„æœºä¼šï¼ˆå…¶å®æ˜¯å·æ‡’çš„å€Ÿå£ ğŸŒšï¼‰ã€‚åœ¨å­—èŠ‚çš„æ—¶å€™ä¹Ÿæ²¡æœ‰å¤ªå¤šåç«¯å¼€å‘çš„ç»éªŒï¼Œæ‰€ä»¥å½“åˆé¢è¯•çš„æ—¶å€™å› ä¸ºå¼€å‘èƒ½åŠ›è¾ƒå¼±è¢«åˆ·æ‰äº†å¾ˆå¤šï¼Œä¹Ÿè®©ä¸€äº›é¢è¯•å®˜æå…¶å¤±æœ›ã€‚</p><p>å¹¸è¿çš„æ˜¯é¢è¯•çš„æ—¶å€™ä¹Ÿé‡åˆ°äº†ä¸€ä¸ªéå¸¸ nice çš„å…¬å¸æ„¿æ„èŠ±æ—¶é—´åŸ¹å…»æˆ‘è¿™æ–¹é¢çš„èƒ½åŠ›ï¼Œleader ä¹Ÿååˆ†ä¿¡ä»»æˆ‘çš„å­¦ä¹ èƒ½åŠ›ï¼Œè®©æˆ‘ä»é›¶å¼€å§‹æ‰¿æ‹…ä¸€ä¸ªé¡¹ç›®çš„åç«¯å¼€å‘ï¼Œç»™äº†æˆ‘è¿™ä¹ˆä¸€ä¸ªå®è´µçš„æœºä¼šæ¥å­¦ä¹ å’Œå¼¥è¡¥å¼€å‘èƒ½åŠ›ä¸è¶³çš„çŸ­æ¿ã€‚</p><h2 id="ç”Ÿæ´»"><a href="#ç”Ÿæ´»" class="headerlink" title="ç”Ÿæ´»"></a>ç”Ÿæ´»</h2><p>ç”Ÿæ´»ä¸Šä¾æ—§æ˜¯å•èº«ç‹¬å±…ï¼Œè‡ªå·±ä¸€ä¸ªäººç”Ÿæ´»å®åœ¨æ˜¯å¤ªçˆ½äº†ï¼Œè¶Šæ¥è¶Šä¹ æƒ¯è¿™ç§ç”Ÿæ´»ï¼Œå¥½æƒ³æ°¸è¿œåœ°å°±è¿™æ ·ç”Ÿæ´»ä¸‹å»ï¼Œæ²¡æœ‰å‚¬å©šçš„çƒ¦æ¼ ğŸ˜–ã€‚ç‹¬è‡ªä¸€ä¸ªäººç”Ÿæ´»æœ€é‡è¦çš„å°±æ˜¯å­¦ä¼š<strong>å¦‚ä½•å¯¹æŠ—è™šæ— </strong>ã€‚åªè¦æ‰¾äº›æœ‰æ„ä¹‰çš„äº‹æƒ…æ¥åšï¼ˆæ¯”å¦‚è¯»ä¹¦ï¼‰ï¼Œå°±ä¸ä¼šè§‰ç€ç”Ÿæ´»æ— å‘³æˆ–è€…æœ‰ç©ºè™šæ„Ÿã€‚å›æƒ³èµ·å¤§å­¦å››å¹´ï¼ŒåŸºæœ¬ä¸Šæˆ‘ä¹Ÿæ˜¯çš„ç‹¬è‡ªä¸€äººå»å›¾ä¹¦é¦†çœ‹ä¹¦ã€ç‹¬è‡ªä¸€äººåƒé¥­ã€ç‹¬è‡ªä¸€äººå»è‡ªä¹ å®¤ï¼Œæ„Ÿè§‰å’Œç°åœ¨æ²¡æœ‰å¤ªå¤šå·®åˆ«ï¼Œåªä¸è¿‡ä»ä¸Šè¯¾å­¦ä¹ æ¢æˆäº†å·¥ä½œæ¬ç –ï¼Œå…¶ä»–æ—¶é—´çš„ç”Ÿæ´»èŠ‚å¥åŸºæœ¬ä¸Šæ²¡æœ‰å¤ªå¤§çš„å˜åŒ–ã€‚</p><p>è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯å°½é‡çš„è¿œç¦»ç¤¾äº¤åª’ä½“ï¼Œä¸è¦è¿‡åº¦åœ°ä¾èµ–å®ƒä»¬ï¼Œæ›´ä¸è¦æ”¾çºµè‡ªå·±ä¸åœåœ°åˆ·æ¨æˆ–è€…çŸ­è§†é¢‘æ¥å¨±ä¹æ¶ˆé£ã€‚å…¶å®è¿™äº›ä¸œè¥¿å¹¶ä¸èƒ½ç»™æˆ‘ä»¬å¸¦æ¥çœŸæ­£æ„ä¹‰ä¸Šçš„å¿«ä¹ï¼Œæœ‰ä¸€éƒ¨çºªå½•ç‰‡ã€Š<a href="https://www.netflix.com/sg-zh/title/81254224">ç›‘è§†èµ„æœ¬ä¸»ä¹‰ï¼šæ™ºèƒ½é™·é˜±</a>ã€‹é‡Œé¢ä¹Ÿè°ˆåˆ°è¿‡è¿‡åº¦ä¾èµ–ç¤¾äº¤åª’ä½“çš„åæœã€‚</p><h3 id="æ­å·è¿‡å¹´"><a href="#æ­å·è¿‡å¹´" class="headerlink" title="æ­å·è¿‡å¹´"></a>æ­å·è¿‡å¹´</h3><p>å› ä¸ºç–«æƒ…çš„åŸå›  2021 å¹´å°±æ²¡å›å®¶è¿‡å¹´ï¼Œå†åŠ ä¸Šè¶Šæ˜¯å†œæ‘é‚£ç§ç ´åœ°æ–¹é˜²ç–«æªæ–½å°±æ˜¯è¶Šç¦»è°±ï¼Œçœ‹çœ‹ç°åœ¨è¥¿å®‰çš„é˜²ç–«æªæ–½ä½ ä»¬å°±èƒ½æ˜ç™½äº†ä¸ºä»€ä¹ˆä¸æƒ³å›å®¶ã€‚äºæ˜¯å°±æ‡’å¾—æŠ˜è…¾ï¼Œé€‰æ‹©ç‹¬è‡ªä¸€äººç•™åœ¨æ­å·è¿‡å¹´ï¼Œé¡ºä¾¿è¿˜èƒ½é¢†å–æ­å·å¸‚æ”¿åºœçš„ç•™æ­è¡¥è´´ 1000 å—é’±ã€‚æ­å·å¸‚åœ¨è¿™ä¸€å—åšçš„è¿˜çœŸä¸é”™ï¼Œå»å¹´è¿˜é¢†äº†äººæ‰è¡¥è´´çš„ 1w å—é’±ï¼Œä»è€å¤§å“¥æ‰‹é‡Œè–…ç¾Šæ¯›ï¼ŒçœŸé¸¡å„¿åˆºæ¿€ã€‚</p><h3 id="ç¯å¤ªæ¹–éª‘è¡Œ"><a href="#ç¯å¤ªæ¹–éª‘è¡Œ" class="headerlink" title="ç¯å¤ªæ¹–éª‘è¡Œ"></a>ç¯å¤ªæ¹–éª‘è¡Œ</h3><p>ä¸ºäº†ä¸è®©äº”ä¸€å‡æœŸå†åƒè¿‡å¹´é‚£æ ·ä¸€ç›´çƒ‚åœ¨å®¶é‡Œï¼Œå°±ç‹¬è‡ªä¸€äººä»æ­å·éª‘è¡Œåˆ°æ¹–å·ã€å¸¸å·ã€æ— é”¡ã€è‹å·ã€å¤ªæ¹–ä¸€å¸¦æ¸¸ç©ï¼ŒçœŸçš„æ˜¯å¾ˆä¹…æ²¡æœ‰é‚£ä¹ˆå¼€å¿ƒè¿‡äº†ã€‚å›æ¥ä¹‹åè¿˜æ›´æ–°äº†ä¸€ç¯‡åšå®¢ã€Š<a href="https://blog.k8s.li/taihu.html">äº”ä¸€å‡æœŸç¯å¤ªæ¹–éª‘è¡Œä¹‹æ—…</a>ã€‹ï¼Œæ—…ç¨‹çš„é£æ™¯çœŸçš„ä¸é”™ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥å»è¯»ä¸€ä¸‹ã€‚</p><h3 id="ä¸Šæµ·ç§Ÿæˆ¿"><a href="#ä¸Šæµ·ç§Ÿæˆ¿" class="headerlink" title="ä¸Šæµ·ç§Ÿæˆ¿"></a>ä¸Šæµ·ç§Ÿæˆ¿</h3><p>æ–°å·¥ä½œçš„åŠå…¬åœ°ç‚¹æ˜¯åœ¨ä¸Šæµ·ï¼Œå› ä¸ºä¸æ”¯æŒè¿œç¨‹åŠå…¬æ‰€ä»¥ä¸å¾—ä¸ä»æ­å·æ¬å®¶æ¥åˆ°ä¸Šæµ·ã€‚åœ¨ä¸­ä»‹è€å“¥çš„å¸¦é¢†ä¸‹æ‰¾äº†ä¸€ä¸ªæœˆç§Ÿ 3100 å…ƒçš„å§å®¤ + ç‹¬å«çš„æˆ¿å­ï¼ˆåŒ…æ°´ç”µè´¹ï¼‰ï¼Œæ•´ä½“æ„Ÿè§‰ååˆ†æ»¡æ„ã€‚æˆ¿å­æ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯ä¸‰å®¤ä¸€å…ã€‚æˆ‘ä½åœ¨å…¶ä¸­çš„ä¸€ä¸ªå¤§å§å®¤ï¼Œæˆ¿ä¸œä»–çˆ¶æ¯ä½åœ¨å¦ä¸€ä¸ªå§å®¤ï¼Œå‰©ä½™çš„ä¸€ä¸ªå§å®¤æ˜¯ç©ºç€çš„ï¼Œé™¤äº†æˆ‘ä»¥å¤–æ²¡æœ‰å…¶ä»–çš„ç§Ÿå®¢ã€‚å‡ºäºå¯¹è€äººå®‰å…¨çš„è€ƒè™‘ï¼Œæˆ¿ä¸œåªå…è®¸æˆ‘è‡ªå·±ä¸€ä¸ªäººä½ï¼Œä¸èƒ½å¸¦å¤–äººæ¥ã€‚å¯¹æˆ‘æ¥è¯´ä¹Ÿæ²¡å•¥ï¼Œç‹¬æ¥ç‹¬å¾€çš„ç”Ÿæ´»åæ­£ä¹Ÿä¸ä¼šæœ‰å…¶ä»–äººæ¥æ‰¾æˆ‘ç©å„¿ã€‚</p><p>å§å®¤é¢ç§¯ 3.3 * 4.3m&#x3D;14.19 å¹³ã€ç„å…³ 1.1 * 1m&#x3D;1.1 å¹³ã€å«ç”Ÿé—´ 2.3 * 2.1m&#x3D;4.38 å¹³ã€‚åŠ èµ·æ¥æ€»å…±å·®ä¸å¤š 20 å¹³ã€‚æ„Ÿè§‰è¿™ä¸ªé¢ç§¯æ„Ÿè§‰æ¯”æ­å·é‚£ä¸ªå¸¦é˜³å°çš„å§å®¤å¤§å¾ˆå¤šã€‚ä¸€ä¸ª 1.5 * 2m çš„åºŠã€é å¢™å†æ”¾ç½®ä¸¤å¼  60* 120 cm çš„å®œå®¶æ¡Œå­ã€åºŠçš„å³ä¾§åˆèƒ½æ”¾ä¸‹ä¸€å¼  0.6 * 1.4m ç±³çš„ä¹¦æ¡Œï¼Œè¿˜æœ‰ä¸€ä¸ª 0.5 *2m çš„è¡£æŸœã€‚</p><p>ç°åœ¨ç»ˆäºä½ä¸Šäº†è‡ªå·±æ‰€æœŸå¾…çš„é‚£ç§æˆ¿å­ï¼Œå›æƒ³èµ·å¤§å­¦åˆšæ¯•ä¸šé‚£ä¸€å¹´ä½çš„è¿˜æ˜¯ 300 å—é’±çš„ä¸Šä¸‹é“ºé’æ—…ï¼Œå°±æ„Ÿè§‰å½“æ—¶ååˆ†å¯’é…¸ ğŸ˜­ã€‚</p><p><img data-src="https://p.k8s.li/image-20220103165850671.png" alt="image-20220103165850671"></p><p>æˆ¿é—´é‡Œè¿˜æœ‰ä¸€ä¸ªå¸¦ä¹¦æ¶çš„ç”µè„‘æ¡Œï¼Œæ”¾ä¸‹ä¸€ä¸ª 27 å¯¸çš„æ˜¾ç¤ºå™¨åˆšåˆšå¥½ã€‚å¦å¤–æŠŠæˆ‘é‚£å° HPE Gen10 Plus æœåŠ¡å™¨å®‰ç½®åœ¨äº†ä¹¦æ¡Œä¸‹é¢ã€‚è™½ç„¶é è¿‘åºŠå¤´ï¼Œä½† NAS é‡Œç¡¬ç›˜çš„å™ªéŸ³è¿˜ç®—èƒ½æ¥å—ï¼Œä¸è‡³äºåµå¾—ç¡ä¸ç€è§‰ã€‚æœ‰æ—¶å€™åœ¨æƒ³è¦ä¸è¦æ•´ä¸ª 12U çš„æœºæŸœæ¥ç€ï¼Œä½†è§„åˆ’äº†ä¸€ä¸‹æ„Ÿè§‰è¿˜æ˜¯æ²¡æœ‰å¤ªå¤§çš„å¿…è¦ï¼Œå…ˆè¿™æ ·å‡‘æ´»ç€ç”¨å§ã€‚</p><p><img data-src="https://p.k8s.li/image-20220103202406765.jpg" alt="IMG_2177"></p><p>æ¬è¿›æ¥ä¹‹åçš„ç¬¬äºŒå¤©åœ¨é—²é±¼ä¸ŠèŠ±äº† 300 å—é’±æ¡æ¥äº†ä¸€ä¸ªåŸä»· 1699 çš„ç±³å®¶æ‰«åœ°æœºå™¨äººï¼ŒåˆèŠ±äº† 200 å—é’±æ¡äº†ä¸€ä¸ªç±³å®¶ç©ºæ°”å‡€åŒ–å™¨ï¼ˆè´«ç©·å¦‚æˆ‘ï¼Œåªèƒ½é æ¡å’Œè–…æ¥æå‡ç”Ÿæ´»å¹¸ç¦æ„Ÿäº†ï¼‰ã€‚æ„Ÿè§‰è¿™ä¸¤ä¸ªå®¶ç”¨ç”µå™¨è¿˜æ˜¯æŒºå€¼çš„ï¼Œæ‰«åœ°æœºå™¨äººçœå»äº†æ‰“æ‰«å«ç”Ÿçš„éº»çƒ¦äº‹å„¿ï¼Œç”Ÿæ´»å¹¸ç¦æ„Ÿ +++ã€‚</p><h2 id="2022"><a href="#2022" class="headerlink" title="2022"></a>2022</h2><p>å°±åƒä½œå®¶æ–¹æ–¹æ‰€è¯´çš„é‚£æ ·ï¼š<a href="http://fangfang.blog.caixin.com/archives/220746">æ—¶ä»£çš„ä¸€ç²’ç°ï¼Œè½åœ¨ä¸ªäººå¤´ä¸Šå°±æ˜¯ä¸€åº§å±±</a> ã€‚å¤–å©†åœ¨ 2020 å¹´æ–°å† ç–«æƒ…åˆšçˆ†å‘çš„é‚£æ®µæ—¶é—´ä¸å¹¸ç¦»å¼€äº†è¿™ä¸ªä¸–ç•Œï¼Œè€Œé‚£æ®µæ—¶é—´çš„ç»å†ä¹Ÿå½»åº•æ”¹å˜äº†æˆ‘çœ‹å¾…ç”Ÿæ­»çš„æƒ³æ³•ã€‚ä»¿ä½›ä¸€åˆ‡éƒ½æ²¡æœ‰é‚£ä¹ˆé‡è¦äº†ï¼Œä¹Ÿè®©æˆ‘æ·±åˆ»åœ°æ˜ç™½äº†<strong>è¿™ä¸ªä¸–ç•Œä¸Šæ²¡æœ‰ä»€ä¹ˆä¸œè¥¿æ— æ³•ä¸èƒ½å¤±å»çš„ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆéå¾—å¿…é¡»è¦å¾—åˆ°çš„</strong>ã€‚å³ä¾¿æ˜¯æŸä¸€å¤©æˆ‘ä¸å¹¸å»ä¸–ï¼Œä¹Ÿæ²¡æœ‰å¤ªå¤šé—æ†¾å’Œæ‚”æ¨ã€‚æ‰€ä»¥å»ä»–çš„æœªæ¥è®¡åˆ’ï¼Œå’Œå¾€å¸¸ä¸€æ ·å¥½å¥½æ¬ç –å·¥ä½œå’Œçœ‹ä¹¦å­¦ä¹ ï¼Œè¿™æ ·å°±å¤Ÿäº†ã€‚</p><p>å¦å¤–ç¥å¤§å®¶æ–°çš„ä¸€å¹´å¿«å¿«ä¹ä¹ ğŸ¥³</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;2021
        
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>Tencent Cloud lighthouse Firewall tool</title>
    <link href="https://blog.k8s.li/cfwctl.html"/>
    <id>https://blog.k8s.li/cfwctl.html</id>
    <published>2021-12-14T16:00:00.000Z</published>
    <updated>2021-12-14T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šæ¬¡å»åŒ—äº¬å‡ºå·®ï¼Œä¸ºäº†ä¾¿æ·åœ°è®¿é—®å®¶é‡Œå†…ç½‘ä¸­çš„ä¸€äº›æœåŠ¡ï¼Œå°±åœ¨è…¾è®¯äº‘æœåŠ¡å™¨ä¸Šéƒ¨ç½²äº†ä¸€ä¸ª frps æœåŠ¡ï¼Œåœ¨æœ¬åœ°å†…ç½‘çš„ Openwrt è·¯ç”±å™¨ä¸Šå®‰è£… frpc å®¢æˆ·ç«¯ï¼Œå°†å†…ç½‘ä¸­çš„ä¸€å° Windows æœåŠ¡å™¨ç©¿é€åˆ°è…¾è®¯äº‘æœåŠ¡å™¨ä¸Šã€‚ç„¶åé€šè¿‡ Windows RDP è¿œç¨‹è¿æ¥åˆ°è¿™å° Windows æœºå™¨ä¸Šï¼Œæ¥ä½¿ç”¨å†…ç½‘çš„ä¸€äº›æœåŠ¡ã€‚ä¹‹å‰ä¹Ÿå°è¯•è¿‡ WireGuardï¼Œä½†æ˜¯ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´ä½“éªŒä¸‹æ¥æ„Ÿè§‰è¿˜æ˜¯é€šè¿‡å†…ç½‘ç©¿é€çš„æ–¹å¼æ¯”è¾ƒç¨³å®šå’Œæµç•…ã€‚äºæ˜¯æœ€ç»ˆçš„æ–¹å¼è¿˜æ˜¯é€‰ç”¨ frp å†…ç½‘ç©¿é€çš„æ–¹æ¡ˆã€‚</p><p>æœ¬ç€æ–¹ä¾¿çœäº‹å„¿çš„åŸåˆ™å°±æ”¾å¿ƒå¤§èƒ†åœ°å¼€æ”¾äº†äº‘æœåŠ¡å™¨çš„å®‰å…¨ç»„è§„åˆ™ã€‚ä¸å¹¸çš„æ˜¯ï¼Œç”±äºè¿™æ ·çš„ç–å¿½ï¼ŒæŸä¸€å¤©æˆ‘çš„ Windows è™šæ‹Ÿæœºè¢«å¼±å£ä»¤ï¼ˆadmin2020ï¼‰ç»™çˆ†ç ´äº†ã€‚å·¨å¤§çš„æŸå¤±å°±æ˜¯æŒ‚è½½åˆ° Windows è™šæ‹Ÿæœºä¸Šçš„ NAS å­˜å‚¨è¢«å‹’ç´¢ç—…æ¯’è¿›è¡Œäº†åŠ å¯† ğŸ˜‚ã€‚ä¸è¿‡å¥½åœ¨æœ€æœ€é‡è¦çš„æ•°æ®å…¨éƒ¨å­˜åˆ°äº† OneDrive ä¸Šï¼ŒNAS ä¸ŠæŸå¤±çš„éƒ½æ˜¯ä¸€äº›ä¸‹è½½çš„ç”µå½±ã€ä¹¦ç±ä»¥åŠä¸€äº› ISOã€è™šæ‹Ÿæœºæ¨¡ç‰ˆä¹‹ç±»çš„æ–‡ä»¶ã€‚ä¸€ä¸‹å­æŸå¤±äº† 8TB çš„æ•°æ®å¾ˆå¿ƒç–¼ï¼Œæ¯•ç«Ÿæ˜¯è‡ªå·±è¾›è¾›è‹¦è‹¦æœé›†çš„èµ„æºï¼Œä½†æ˜¯ä»”ç»†æƒ³ä¸€ä¸‹ï¼Œè¿™äº›èµ„æºéƒ½ä¸æ˜¯è‡ªå·±çš„ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ä»ä¸‹è½½ä¸‹æ¥çš„ï¼Œè¿˜å¯ä»¥é€šè¿‡åŒæ ·çš„æ–¹å¼æ‰¾å›æ¥ã€‚æˆ–è®¸æ˜¯ä¹‹å‰çœ‹è¿‡ã€Šæ–­èˆç¦»ã€‹çš„ç¼˜æ•…ï¼Œä¹Ÿçœ‹çš„å¼€äº†ï¼Œéš¾å—äº†ä¸€å°ä¼šå„¿ä¹‹åå°±å¥½è¿‡æ¥äº†ã€‚æ¯•ç«Ÿè¿™ä¸ªä¸–ç•Œä¸Šï¼Œæ²¡æœ‰æ— æ³•ä¸èƒ½å¤±å»çš„ä¸œè¥¿ï¼Œä¹Ÿæ²¡æœ‰éå¾—å¿…é¡»è¦å¾—åˆ°çš„ä¸œè¥¿ã€‚</p><p>æœ‰äº†æ­¤æ¬¡æ•™è®­ï¼Œå°±å¼€å§‹è€ƒè™‘å¯¹æ‰‹ä¸Šçš„äº‘ä¸»æœºèµ„æºè¿›è¡Œå®‰å…¨åŠ å›ºï¼Œå°†ä¸€äº›ä¸å†…ç½‘äº’é€šçš„äº‘ä¸»æœºå®‰å…¨ç»„&#x2F;é˜²ç«å¢™çš„é€šç”¨å»é™¤äº†å…è®¸æ‰€æœ‰ï¼Œåªæ·»åŠ æœ¬åœ°å…¬ç½‘ IP çš„å…è®¸è§„åˆ™ã€‚ä½†æ˜¯å¯¹äºå®¶åº­å®½å¸¦ç”¨æˆ·æ¥è®²ï¼Œå…¬ç½‘ IP å¹¶ä¸æ˜¯ä¸€ä¸ªå›ºå®šçš„ IPï¼Œè€Œæ˜¯ä¼šä¸€ç›´ä¸æ–­å˜åŒ–ï¼Œæ€»ä¸èƒ½æ¯æ¬¡å˜åŒ–ä¹‹åå†ç™»å½•åˆ°äº‘ä¸»æœºæ§åˆ¶å°æ‰‹åŠ¨æ·»åŠ ä¸€ä¸‹å§ã€‚äºæ˜¯å°±æƒ³ç€æœ‰æ²¡æœ‰è‡ªåŠ¨åŒ–çš„æ–¹å¼æ¥è‡ªåŠ¨æ·»åŠ å’Œæ›´æ–°å®‰å…¨ç»„&#x2F;é˜²ç«å¢™è§„åˆ™å‘¢ï¼Ÿ</p><h2 id="Terraform"><a href="#Terraform" class="headerlink" title="Terraform"></a>Terraform</h2><p>ç¬¬ä¸€ä¸ªæƒ³åˆ°çš„æ–¹æ¡ˆä¾¿æ˜¯ terraformï¼Œä¸»æµçš„äº‘å‚å•†éƒ½æœ‰å¯¹åº”çš„ provider æ”¯æŒï¼Œè…¾è®¯äº‘åº”è¯¥ä¹Ÿæ˜¯èƒ½å¤Ÿæ”¯æŒçš„ã€‚ä¸è¿‡çœ‹äº†å®˜æ–¹çš„ <a href="https://github.com/tencentcloudstack/terraform-provider-tencentcloud">terraform-provider-tencentcloud</a> repo æ–‡æ¡£ä¹‹åï¼Œå¹¶æ²¡æœ‰æ‰¾åˆ°ç»™ lighthouse ä¸»æœºé…ç½®é˜²ç«å¢™è§„åˆ™çš„æ”¯æŒï¼Œé‚æ”¾å¼ƒã€‚</p><h2 id="cfwctl"><a href="#cfwctl" class="headerlink" title="cfwctl"></a>cfwctl</h2><p>æ—¢ç„¶ terraform ä¸æ”¯æŒï¼Œé‚£å°±è‡ªå·±é€ è½®å­å†™ä¸€ä¸ªå§ï¼Œå°±å«å®ƒ Cloud Firewall Control Toolï¼Œç®€ç§° <a href="https://github.com/muzi502/cfwctl">cfwctl</a>ã€‚è…¾è®¯äº‘å®˜æ–¹çš„ API æ–‡æ¡£è¿˜å¯ä»¥ï¼Œè¿˜èƒ½åœ¨çº¿ç”Ÿæˆä»£ç ï¼Œç”¨èµ·æ¥ä¹Ÿååˆ†æ–¹ä¾¿ã€‚è€ƒè™‘åˆ°ä¼šå°†è¯¥å·¥å…·è¿è¡Œåˆ°è¿è¡Œåˆ° arm64 çš„è·¯ç”±å™¨ä¸Šï¼Œå› æ­¤è·¨å¹³å°è¿è¡Œ cfwctl ä½¿ç”¨ golang æ¥å®ç°æ— ç–‘æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œæ­£å¥½ä¹Ÿèƒ½æ¥ç»ƒç»ƒæ‰‹ã€‚</p><p>æ‰§è¡Œçš„æ“ä½œå…¶å®å¾ˆç®€å•ï¼Œå…ˆæ˜¯é€šè¿‡æŸç§æ–¹å¼è·å–æœ¬åœ°æœºå™¨çš„å…¬ç½‘ IPï¼Œç„¶åå°†è¯¥ IP æ·»åŠ åˆ°å¯¹åº”å®ä¾‹çš„é˜²ç«å¢™è§„åˆ™å½“ä¸­ï¼Œå¹¶åœ¨è§„åˆ™æè¿°ä¸­æ·»åŠ æ ‡è¯†ç¬¦æ¥æ ‡è®°ã€‚ç›®å‰è‡ªå·±åªéœ€è¦æ·»åŠ è§„åˆ™ï¼Œå…ˆå‡‘æ´»ç€ç”¨ä¸€æ®µæ—¶é—´ï¼Œçœ‹ä¸‹æ•ˆæœå¦‚ä½•ã€‚ç›®å‰åªæ”¯æŒè…¾è®¯äº‘çš„ lighthouse å®ä¾‹ï¼Œåç»­æœ‰æœºä¼šå†å¢åŠ å‡ ä¸ªåˆ«çš„äº‘å‚å•†æ”¯æŒã€‚</p><h3 id="è·å–å…¬ç½‘-IP"><a href="#è·å–å…¬ç½‘-IP" class="headerlink" title="è·å–å…¬ç½‘ IP"></a>è·å–å…¬ç½‘ IP</h3><p>é¦–å…ˆè¦è·å–åˆ°æˆ‘ä»¬æœ¬åœ°ç½‘è·¯çš„å…¬ç½‘ IPï¼Œç”±äºå…¬ç½‘ IP å¯èƒ½ä¸€ç›´æ˜¯å˜åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡æ›´æ–°é˜²ç«å¢™è§„åˆ™ä¹‹å‰éƒ½éœ€è¦è·å–æœ€æ–°çš„å…¬ç½‘ IPã€‚ä»¥ä¸‹æ˜¯å…·ä½“å®ç°çš„ä»£ç ï¼š</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">package mainimport (&quot;fmt&quot;&quot;io&#x2F;ioutil&quot;&quot;net&#x2F;http&quot;&quot;regexp&quot;)&#x2F;&#x2F; å®šä¹‰ IPv4 çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œç›®çš„æ˜¯ä»è·å–å…¬ç½‘ IP çš„  API è¿”å›ç»“æœä¸­è¿‡æ»¤å‡º IPv4 åœ°å€const ipv4_regex &#x3D; &#96;(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))&#123;3&#125;&#96;&#x2F;&#x2F; å®šä¹‰å‡ ä¸ªå‡ ä¸ªæä¾›è·å–å…¬ç½‘ IPv4 åœ°å€çš„ API URLvar urlList &#x3D; []string&#123;&quot;https:&#x2F;&#x2F;ip.me&quot;&quot;http:&#x2F;&#x2F;ip.sb&quot;,&quot;http:&#x2F;&#x2F;ip.cip.cc&quot;,&quot;http:&#x2F;&#x2F;myip.ipip.net&quot;,&#125;func GetPublicIP() string &#123;for _, url :&#x3D; range urlList &#123;    &#x2F;&#x2F; åˆ›å»ºä¸€ä¸ª http clientclient :&#x3D; &amp;http.Client&#123;&#125;    &#x2F;&#x2F; è®¾ç½® client çš„è¯·æ±‚æ–¹æ³•ä¸º GET ä»¥åŠè¯·æ±‚çš„ URLrequest, err :&#x3D; http.NewRequest(&quot;GET&quot;, url, nil)if err !&#x3D; nil &#123;continue&#125;    &#x2F;&#x2F; è®¾ç½® Client çš„ User-Agent ä¸º curlï¼Œä¸ç„¶ä¸€äº› API ä¼šè¿”å› html çš„ç»“æœrequest.Header.Set(&quot;User-Agent&quot;, &quot;curl&#x2F;7.54.0&quot;)resp, err :&#x3D; client.Do(request)if resp.StatusCode !&#x3D; 200 &amp;&amp; err !&#x3D; nil &#123;continue&#125;defer resp.Body.Close()body, err :&#x3D; ioutil.ReadAll(resp.Body)    &#x2F;&#x2F; ä» API è¿”å›ç»“æœä¸­ç”¨æ­£åˆ™åŒ¹é…å‡º IPv4 åœ°å€reg :&#x3D; regexp.MustCompile(ipv4_regex)ipList :&#x3D; reg.FindAllString(string(body), -1)    &#x2F;&#x2F; å¦‚æœåŒ¹é…ç»“æœä¸­æœ‰ IPv4 åœ°å€ï¼Œåˆ™è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ å³å¯if len(ipList) &gt; 0 &#123;fmt.Printf(&quot;my public ip is %s\n&quot;, ipList[0])return ipList[0]&#125;&#125;return &quot;&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="æ·»åŠ -Firewall-è§„åˆ™"><a href="#æ·»åŠ -Firewall-è§„åˆ™" class="headerlink" title="æ·»åŠ  Firewall è§„åˆ™"></a>æ·»åŠ  Firewall è§„åˆ™</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span><span class="token string">"fmt"</span><span class="token string">"os"</span><span class="token string">"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/common"</span><span class="token string">"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/common/errors"</span><span class="token string">"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/common/profile"</span>lighthouse <span class="token string">"github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/lighthouse/v20200324"</span><span class="token punctuation">)</span><span class="token comment">// å®šä¹‰ API è¯·æ±‚çš„ URL</span><span class="token keyword">const</span> endpoint <span class="token operator">=</span> <span class="token string">"lighthouse.tencentcloudapi.com"</span><span class="token comment">// å®šä¹‰è¯·æ±‚ API çš„ Client ç»“æ„ä½“</span><span class="token keyword">type</span> Client <span class="token keyword">struct</span> <span class="token punctuation">&#123;</span>SecretId  <span class="token builtin">string</span>SecretKey <span class="token builtin">string</span>InstaceId <span class="token builtin">string</span>Region    <span class="token builtin">string</span>Endpoint  <span class="token builtin">string</span><span class="token punctuation">&#125;</span><span class="token comment">// é€šè¿‡è¯¥æ–¹æ³•ä»ç¯å¢ƒå˜é‡ä¸­è¯»å– Ck Sk ç­‰ä¿¡æ¯ï¼Œå¹¶è¿”å›ä¸€ä¸ª client å¯¹è±¡</span><span class="token keyword">func</span> <span class="token function">NewClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> Client <span class="token punctuation">&#123;</span>client <span class="token operator">:=</span> Client<span class="token punctuation">&#123;</span>SecretId<span class="token punctuation">:</span>  os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"TENCENTCLOUD_SECRET_ID"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>SecretKey<span class="token punctuation">:</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"TENCENTCLOUD_SECRET_KEY"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>InstaceId<span class="token punctuation">:</span> os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"TENCENTCLOUD_INSTANCE_ID"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Region<span class="token punctuation">:</span>    os<span class="token punctuation">.</span><span class="token function">Getenv</span><span class="token punctuation">(</span><span class="token string">"TENCENTCLOUD_REGION"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Endpoint<span class="token punctuation">:</span>  endpoint<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> client<span class="token punctuation">.</span>SecretId <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">||</span> client<span class="token punctuation">.</span>SecretKey <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">||</span> client<span class="token punctuation">.</span>InstaceId <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">||</span> client<span class="token punctuation">.</span>Region <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">&#123;</span><span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"Please set TENCENTCLOUD_SECRET_ID, TENCENTCLOUD_SECRET_KEY, TENCENTCLOUD_INSTANCE_ID, TENCENTCLOUD_REGION"</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> client<span class="token punctuation">&#125;</span><span class="token comment">// å®šä¹‰æ·»åŠ é˜²ç«å¢™è§„åˆ™çš„æ–¹æ³•</span><span class="token keyword">func</span> <span class="token punctuation">(</span>c Client<span class="token punctuation">)</span> <span class="token function">AddRules</span><span class="token punctuation">(</span>firewallRules <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>lighthouse<span class="token punctuation">.</span>FirewallRule<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>credential <span class="token operator">:=</span> common<span class="token punctuation">.</span><span class="token function">NewCredential</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>SecretId<span class="token punctuation">,</span> c<span class="token punctuation">.</span>SecretKey<span class="token punctuation">)</span>cpf <span class="token operator">:=</span> profile<span class="token punctuation">.</span><span class="token function">NewClientProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>cpf<span class="token punctuation">.</span>HttpProfile<span class="token punctuation">.</span>Endpoint <span class="token operator">=</span> endpointclient<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lighthouse<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>credential<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Region<span class="token punctuation">,</span> cpf<span class="token punctuation">)</span>request <span class="token operator">:=</span> lighthouse<span class="token punctuation">.</span><span class="token function">NewCreateFirewallRulesRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>request<span class="token punctuation">.</span>InstanceId <span class="token operator">=</span> common<span class="token punctuation">.</span><span class="token function">StringPtr</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>InstaceId<span class="token punctuation">)</span>request<span class="token punctuation">.</span>FirewallRules <span class="token operator">=</span> firewallRulesresponse<span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">CreateFirewallRules</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>errors<span class="token punctuation">.</span>TencentCloudSDKError<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">&#123;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"An API error has returned: %s"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span><span class="token function">panic</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">&#125;</span>fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">ToJsonString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="è·å–é˜²ç«å¢™è§„åˆ™"><a href="#è·å–é˜²ç«å¢™è§„åˆ™" class="headerlink" title="è·å–é˜²ç«å¢™è§„åˆ™"></a>è·å–é˜²ç«å¢™è§„åˆ™</h3><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">func (c Client) GetRules() string &#123;credential :&#x3D; common.NewCredential(c.SecretId, c.SecretKey)cpf :&#x3D; profile.NewClientProfile()cpf.HttpProfile.Endpoint &#x3D; endpointclient, _ :&#x3D; lighthouse.NewClient(credential, c.Region, cpf)request :&#x3D; lighthouse.NewDescribeFirewallRulesRequest()request.InstanceId &#x3D; common.StringPtr(c.InstaceId)response, err :&#x3D; client.DescribeFirewallRules(request)if _, ok :&#x3D; err.(*errors.TencentCloudSDKError); ok &#123;fmt.Printf(&quot;An API error has returned: %s&quot;, err)return &quot;&quot;&#125;if err !&#x3D; nil &#123;panic(err)&#125;return response.ToJsonString()&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><ul><li>åœ¨æœ¬åœ°çš„ <code>~/.bashrc</code> æˆ–è€… <code>~/.zshrc</code> æ–‡ä»¶ä¸­è®¾ç½®ä¸€äº› AKSK ä¿¡æ¯ã€å®ä¾‹ IDã€region ä¿¡æ¯ç­‰å‚æ•°ï¼›</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">TENCENTCLOUD_SECRET_ID</span><span class="token operator">=</span><span class="token string">"AKiiiplQntjJbcMp1"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">TENCENTCLOUD_SECRET_KEY</span><span class="token operator">=</span><span class="token string">"SKkkkiiwwlwjmmG5"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">TENCENTCLOUD_INSTANCE_ID</span><span class="token operator">=</span><span class="token string">"lhins-qjxazjaa"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable">TENCENTCLOUD_REGION</span><span class="token operator">=</span><span class="token string">"ap-beijing"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>è®¾ç½®å¥½ç¯å¢ƒå˜é‡ä¹‹åï¼Œå†ç¼–è¯‘è¿è¡Œçœ‹ä¸‹èƒ½å¦æˆåŠŸ</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ go build -o cfwctl$ <span class="token function">chmod</span> +x cfwctl$ cfwctl <span class="token function">add</span>my public <span class="token function">ip</span> is <span class="token number">193.191</span>.231.82<span class="token punctuation">&#123;</span><span class="token string">"Response"</span>:<span class="token punctuation">&#123;</span><span class="token string">"RequestId"</span><span class="token builtin class-name">:</span><span class="token string">"30e71243-1793-112e-9e41-b310ec599b90"</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>%<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>å¦‚æœæ˜¯ arm64 çš„ OpenWrt ç¯å¢ƒï¼Œåœ¨æœ¬åœ°å¼€å‘æœºä¸Šè¿›è¡Œè·¨å¹³å°ç¼–è¯‘ï¼Œç„¶åå°†ç¼–è¯‘å¥½çš„ cfwctl äºŒè¿›åˆ¶æ–‡ä»¶ scp åˆ°è·¯ç”±å™¨ä¸Šï¼Œå†æ·»åŠ  cron job å®šæ—¶ä»»åŠ¡å³å¯ï¼Œè¿™æ ·å°±èƒ½è‡ªåŠ¨å®šæ—¶æ›´æ–°é˜²ç«å¢™è§„åˆ™æ¥ã€‚</li></ul><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token assign-left variable">CGO_ENABLED</span><span class="token operator">=</span><span class="token number">0</span>  <span class="token assign-left variable">GOOS</span><span class="token operator">=</span>linux  <span class="token assign-left variable">GOARCH</span><span class="token operator">=</span>arm64 go build -o cfwctl<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;ä¸Šæ¬¡å»åŒ—äº¬å‡ºå·®ï¼Œä¸ºäº†ä¾¿æ·åœ°è®¿é—®å®¶é‡Œå†…ç½‘ä¸­çš„ä¸€äº›æœåŠ¡ï¼Œå°±åœ¨è…¾
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="äº‘æœåŠ¡å™¨" scheme="https://blog.k8s.li/tags/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
  </entry>
  
</feed>
