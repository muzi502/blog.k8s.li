<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>æœ¨å­</title>
  <icon>https://blog.k8s.li/icon.png</icon>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.k8s.li/"/>
  <updated>2021-08-29T16:00:00.000Z</updated>
  <id>https://blog.k8s.li/</id>
  
  <author>
    <name>æœ¨å­</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ä¸‡å­—é•¿æ–‡è¯¦è§£ PaaS toB åœºæ™¯ä¸‹ K8s ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆ</title>
    <link href="https://blog.k8s.li/pass-tob-k8s-offline-deploy.html"/>
    <id>https://blog.k8s.li/pass-tob-k8s-offline-deploy.html</id>
    <published>2021-08-29T16:00:00.000Z</published>
    <updated>2021-08-29T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒå½“ä¸­ï¼Œå‡ºäºå¯¹æ•°æ®å®‰å…¨çš„è€ƒè™‘ä»¥åŠæ»¡è¶³ <a href="http://www.djbh.net/" target="_blank" rel="noopener">ç½‘ç»œå®‰å…¨ç­‰çº§ä¿æŠ¤</a> çš„è¦æ±‚ï¼Œå¾€å¾€ä¼šå¯¹å†…éƒ¨ç¯å¢ƒä¸­çš„æœåŠ¡å™¨åšå‡ºä¸¥æ ¼çš„è®¿é—®é™åˆ¶ã€‚ä¸€èˆ¬æ¥è®²ç”Ÿäº§ç¯å¢ƒéƒ½ä¼šç¦æ­¢è®¿é—®å¤–éƒ¨ç½‘ç»œï¼Œå¼€å‘äººå‘˜è¦è®¿é—®ç”Ÿäº§ç¯å¢ƒä¹Ÿå¿…é¡»é€šè¿‡å ¡å’æœºæˆ–è€…å…¶ä»–æ–¹å¼è¿›è¡Œå®‰å…¨å®¡è®¡ç™»å½•ã€‚åœ¨è¿™ç§æ— ç½‘ï¼ˆæ— æ³•è®¿é—®å…¬ç½‘ï¼‰çš„ç¯å¢ƒä¸­ï¼Œæƒ³è¦éƒ¨ç½²å¥½ä¸€ä¸ª K8s é›†ç¾¤å¹¶ä¸æ˜¯ä¸€ä»¶è½»æ¾çš„äº‹å„¿ã€‚å¸‚é¢ä¸Š K8s éƒ¨ç½²å·¥å…·ä¹Ÿå¤šä¸èƒœæ•°ï¼Œå¯¹äºç¦»çº¿éƒ¨ç½²çš„æ”¯æŒæƒ…å†µä¹Ÿå„ä¸ç›¸åŒï¼š</p><table><thead><tr><th align="center">Item</th><th align="center">Language</th><th align="center">Star</th><th align="center">Fork</th><th align="left">ç¦»çº¿éƒ¨ç½²æ”¯æŒæƒ…å†µ</th></tr></thead><tbody><tr><td align="center"><a href="https://github.com/kubernetes/kops" target="_blank" rel="noopener">kops</a></td><td align="center">Golang</td><td align="center">13.2k</td><td align="center">4.1k</td><td align="left">ä¸æ”¯æŒ</td></tr><tr><td align="center"><a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener">kubespray</a></td><td align="center">Ansible</td><td align="center">11.1k</td><td align="center">4.7k</td><td align="left">æ”¯æŒï¼Œéœ€è‡ªè¡Œæ„å»ºå®‰è£…åŒ…</td></tr><tr><td align="center"><a href="https://github.com/easzlab/kubeasz" target="_blank" rel="noopener">kubeasz</a></td><td align="center">Ansible</td><td align="center">7.2k</td><td align="center">2.7k</td><td align="left">æ”¯æŒï¼Œéœ€è‡ªè¡Œæ„å»ºå®‰è£…åŒ…</td></tr><tr><td align="center"><a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a></td><td align="center">Golang</td><td align="center">4.1k</td><td align="center">790</td><td align="left">æ”¯æŒï¼Œéœ€ä»˜è´¹å……å€¼ä¼šå‘˜</td></tr><tr><td align="center"><a href="https://github.com/rancher/rke" target="_blank" rel="noopener">RKE</a></td><td align="center">Golang</td><td align="center">2.5k</td><td align="center">480</td><td align="left">ä¸æ”¯æŒï¼Œéœ€è‡ªè¡Œå®‰è£… docker</td></tr><tr><td align="center"><a href="https://github.com/alibaba/sealer" target="_blank" rel="noopener">sealer</a></td><td align="center">Golang</td><td align="center">503</td><td align="center">112</td><td align="left">æ”¯æŒï¼Œæºè‡ª <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a></td></tr><tr><td align="center"><a href="https://github.com/kubesphere/kubekey" target="_blank" rel="noopener">kubekey</a></td><td align="center">Golang</td><td align="center">471</td><td align="center">155</td><td align="left">éƒ¨åˆ†æ”¯æŒï¼Œä»…é•œåƒå¯ç¦»çº¿</td></tr></tbody></table><p>æ— ç½‘ç¯å¢ƒç¦»çº¿éƒ¨ç½² K8s å¾€å¾€æ˜¯ä½œä¸ºä¸€ä¸ªå•†ä¸šæœåŠ¡æˆ–è€…å•†ä¸šä»˜è´¹äº§å“æ¥å‡ºå”®ï¼ˆå¦‚ <a href="https://www.sealyun.com/" target="_blank" rel="noopener">sealos</a> ï¼‰ï¼Œå¾ˆå°‘æœ‰å¼€æºå…è´¹çš„è§£å†³æ–¹æ¡ˆï¼›æˆ–è€…è™½ç„¶æä¾›äº†ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆï¼Œä½†æƒ³è¦æ“ä½œèµ·æ¥ååˆ†ç¹çï¼Œå¾ˆéš¾é¡ºç•…åœ°åšåˆ°ä¸€é”®éƒ¨ç½²ï¼›åˆæˆ–è€…åªæ”¯æŒéƒ¨åˆ†ç¦»çº¿éƒ¨ç½²ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†èµ„æºéœ€è¦åœ¨éƒ¨ç½²çš„æ—¶å€™é€šè¿‡å…¬ç½‘è·å–ã€‚</p><p>é’ˆå¯¹ä¸Šè¿°é—®é¢˜ï¼Œæœ¬æ–‡è°ƒç ”ä¸»æµçš„ K8s éƒ¨ç½²å·¥å…·ï¼Œå¹¶åŸºäºè¿™äº›å·¥å…·è®¾è®¡å¹¶å®ç°ä¸€ç§ä»æ„å»ºç¦»çº¿å®‰è£…åŒ…åˆ°ä¸€é”®éƒ¨ç½² K8s é›†ç¾¤å…¨æµç¨‹çš„è§£å†³æ–¹æ¡ˆï¼Œä»¥æ»¡è¶³åœ¨æ— ç½‘çš„ç¯å¢ƒä¸­ä¸€é”®éƒ¨ç½² K8s é›†ç¾¤çš„éœ€æ±‚ï¼Œæ¯”è¾ƒé€‚åˆåŸºäº K8s çš„ PaaS toB äº§å“ä½¿ç”¨ã€‚</p><h2 id="ç¦»çº¿èµ„æº"><a href="#ç¦»çº¿èµ„æº" class="headerlink" title="ç¦»çº¿èµ„æº"></a>ç¦»çº¿èµ„æº</h2><p>æ€»ä½“æ¥è®²éƒ¨ç½²ä¸€ä¸ª K8s é›†ç¾¤å¤§è‡´éœ€è¦ä¾èµ–å¦‚ä¸‹ä¸‰ç§èµ„æºï¼š</p><ul><li>ç³»ç»Ÿ OS çš„ rpm/deb åŒ…ï¼šå¦‚ docker-ceã€containerdã€ipvsadmã€conntrack ç­‰ï¼›</li><li>äºŒè¿›åˆ¶æ–‡ä»¶ï¼šå¦‚ kubeletã€kubectlã€kubeadmã€crictl ç­‰ï¼›</li><li>ç»„ä»¶å®¹å™¨é•œåƒï¼šå¦‚ kube-apiserverã€kube-proxyã€corednsã€calicoã€flannel ç­‰ï¼›</li></ul><h3 id="OS-packages"><a href="#OS-packages" class="headerlink" title="OS packages"></a>OS packages</h3><p>è¿™ç±»å±äº OS ç³»ç»Ÿå±‚é¢çš„ä¾èµ–ï¼Œæ ¹æ®ä¸åŒç³»ç»Ÿæˆ–è€…æ”¯æŒçš„åŠŸèƒ½éœ€è¦ä½¿ç”¨ç›¸åº”çš„åŒ…ç®¡ç†å™¨å®‰è£…ç›¸åº”çš„ä¾èµ–åŒ…ï¼Œå¤§è‡´åˆ†ä¸ºå¦‚ä¸‹å‡ ç§ï¼š</p><ul><li>kubernetes ç»„ä»¶ä¾èµ–</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- conntrack           <span class="comment"># kube-proxy ä¾èµ–</span></span><br><span class="line">- ipset               <span class="comment"># kube-proxy ä½¿ç”¨ ipvs æ¨¡å¼éœ€è¦</span></span><br><span class="line">- ipvsadm             <span class="comment"># kube-proxy ä½¿ç”¨ ipvs æ¨¡å¼éœ€è¦</span></span><br><span class="line">- socat               <span class="comment"># ç”¨äº port forwarding</span></span><br></pre></td></tr></table></figure><blockquote><p><a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/implementation-details/" target="_blank" rel="noopener">Implementation details</a>:</p><p>[Error] if conntrack, ip, iptables, mount, nsenter commands are not present in the command path<br>[warning] if ebtables, ethtool, socat, tc, touch, crictl commands are not present in the command path</p></blockquote><ul><li>éƒ¨ç½²ä¾èµ–</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- ebtables            <span class="comment"># kubeadm ä¾èµ–å·¥å…·</span></span><br><span class="line">- ethtool             <span class="comment"># kubeadm ä¾èµ–å·¥å…·</span></span><br><span class="line">- chrony              <span class="comment"># æ—¶é’ŸåŒæ­¥å·¥å…·ï¼Œéƒ¨ç½²å‰èŠ‚ç‚¹çš„æ—¶å€™å¿…é¡»ä¸€è‡´ï¼Œä¸ç„¶è¯ä¹¦æˆ–è€… CNI æ’ä»¶ä¼šå‡ºç°é—®é¢˜</span></span><br></pre></td></tr></table></figure><ul><li>CRI å®¹å™¨è¿è¡Œè¿è¡Œæ—¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- containerd.io       <span class="comment"># å¯å•ç‹¬å®‰è£…/docker-ce ä¾èµ–</span></span><br><span class="line">- docker-ce           <span class="comment"># docker-ce</span></span><br><span class="line">- libseccomp          <span class="comment"># å®‰è£… containerd éœ€è¦</span></span><br><span class="line">- nvidia-container-runtime <span class="comment"># æ”¯æŒ GPU æ—¶éœ€è¦ä¾èµ–</span></span><br></pre></td></tr></table></figure><ul><li>å­˜å‚¨å®¢æˆ·ç«¯ä¾èµ–</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- nfs-utils/nfs-common <span class="comment"># åˆ›å»ºåŸºäº nfs çš„ PV éœ€è¦</span></span><br><span class="line">- ceph-common          <span class="comment"># ceph å®¢æˆ·ç«¯å®‰è£…åŒ…ï¼Œåˆ›å»ºåŸºäº ceph çš„ pv éœ€è¦</span></span><br><span class="line">- lvm2                 <span class="comment"># åˆ›å»ºåŸºäº ceph çš„ pv éœ€è¦</span></span><br><span class="line">- glusterfs-client     <span class="comment"># åˆ›å»ºåŸºäº glusterfs çš„ pv éœ€è¦</span></span><br><span class="line">- glusterfs-common     <span class="comment"># åˆ›å»ºåŸºäº glusterfs çš„ pv éœ€è¦</span></span><br><span class="line">- cifs-utils           <span class="comment"># åˆ›å»ºåŸºäº cifs çš„ pv éœ€è¦</span></span><br><span class="line">- fuse                 <span class="comment"># ceph æˆ–è€…å…¶ä»–å­˜å‚¨å®¢æˆ·ç«¯ä¾èµ–</span></span><br></pre></td></tr></table></figure><p>æƒ³è¦è§£å†³ä¸Šé¢è¿™äº›ä¾èµ–é¡¹ååˆ†æ£˜æ‰‹ï¼Œä¹Ÿæ˜¯ç¦»çº¿éƒ¨ç½²åœºæ™¯ä¸‹æœ€éš¾çš„ä¸€éƒ¨åˆ†ï¼Œè‡³ä»Šå¹¶æ²¡æœ‰ä¸€ä¸ªæˆç†Ÿçš„æ–¹æ¡ˆå®ç°è¿™äº›ä¾èµ–çš„ç¦»çº¿éƒ¨ç½²ï¼ŒåŸºæœ¬ä¸Šæ‰€æœ‰çš„ k8s éƒ¨ç½²å·¥å…·éƒ½æ²¡æœ‰æä¾›è¿™äº›åŒ…çš„ç¦»çº¿å®‰è£…æ–¹å¼ã€‚å¯¹äºè¿™äº›åŒ…çš„ä¾èµ–ï¼Œç›®å‰ä¸»è¦æœ‰é¿å…å®‰è£…è¿™äº›ä¾èµ–å’Œåˆ¶ä½œç¦»çº¿æºè¿™ä¸¤ç§è§£å†³æ–¹æ¡ˆã€‚</p><h4 id="sealos"><a href="#sealos" class="headerlink" title="sealos"></a>sealos</h4><p>åœ¨ <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a> ä¸­å°±æåŠ›é¿å…ä½¿ç”¨åŒ…ç®¡ç†å™¨æ¥å®‰è£…ä¾èµ–ï¼Œæ¯”å¦‚å®‰è£… containerd æ—¶çš„ä¾èµ– libseccomp ä½¿ç”¨çš„æ˜¯ç¼–è¯‘å¥½çš„ .so æ–‡ä»¶çš„æ–¹å¼ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ tar -tf kube1.20.0.tar.gz</span><br><span class="line">kube/</span><br><span class="line">kube/lib64/</span><br><span class="line">kube/lib64/README.md</span><br><span class="line">kube/lib64/libseccomp.so.2</span><br><span class="line">kube/lib64/libseccomp.so.2.3.1</span><br></pre></td></tr></table></figure><p>å®‰è£… docker ä½¿ç”¨çš„äºŒè¿›åˆ¶çš„æ–¹å¼ï¼Œä½† docker å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæ˜ç¡®è¯´æ˜<strong>ä¸å»ºè®®ä½¿ç”¨äºŒè¿›åˆ¶çš„æ–¹å¼æ¥å®‰è£… docker</strong>ï¼Œåº”è¯¥ä½¿ç”¨å‘è¡Œç‰ˆè‡ªå¸¦çš„åŒ…ç®¡ç†å™¨æ¥å®‰è£…ã€‚</p><blockquote><p>If you want to try Docker or use it in a testing environment, but youâ€™re not on a supported platform, you can try installing from static binaries. <strong>If possible, you should use packages built for your operating system</strong>, and use your operating systemâ€™s package management system to manage Docker installation and upgrades.</p><p><a href="https://docs.docker.com/engine/install/binaries/" target="_blank" rel="noopener">Install Docker Engine from binaries</a></p></blockquote><p>å®é™…ä¸Šä»»ä½•éƒ¨ç½²å·¥å…·éƒ½ä¼šå¯¹ç³»ç»Ÿ rpm/deb åŒ…éƒ½ä¼šæœ‰ä¸åŒç¨‹åº¦ä¸Šçš„ä¾èµ–ï¼Œæœ‰ä¸€éƒ¨åˆ†ä¾èµ–å¯ä»¥åƒ <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a>  è¿™æ ·é€šè¿‡æŸç§æ–¹å¼å»è§„é¿æ‰ã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„ä¾èµ–éƒ½èƒ½è§„é¿çš„ï¼Œæ¯”å¦‚æä¾›æŒ‚è½½ PV éœ€è¦ä¾èµ–çš„å­˜å‚¨å®¢æˆ·ç«¯ï¼ˆnfs-common/nfs-utilsï¼Œlvm2ï¼Œgluster-clientï¼‰è¿™äº›åŒ…ï¼ŒåŸºæœ¬ä¸Šæ˜¯æ²¡æœ‰ä»»ä½•è§„é¿çš„é€”å¾„ï¼Œå¿…é¡»é€šè¿‡åŒ…ç®¡ç†å™¨æ¥å®‰è£…æ‰è¡Œã€‚</p><p>å½“ç„¶å¦‚æœè¿™äº›å‰ç½®çš„ä¾èµ–é¡¹åœ¨éƒ¨ç½²å·¥å…·ä¹‹å¤–æ‰‹åŠ¨è§£å†³æˆ–è€…è®©ç”¨æˆ·è‡ªè¡Œå»è§£å†³ï¼Œé‚£ä¹ˆä½¿ç”¨ <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a>  è¿™ç§è½»é‡çº§çš„å·¥å…·æ¥éƒ¨ç½² K8s æ˜¯æ¯”è¾ƒåˆé€‚çš„ã€‚ä½†å¯¹äºä¸€äº› PaaS toB çš„äº§å“è€Œè¨€ï¼Œè®©ç”¨æˆ·è‡ªå·±å»æ‰‹åŠ¨è§£å†³è¿™äº›ä¾èµ–ææ€•ä¸å¤ªå¥½ã€‚ç«™åœ¨å®¢æˆ·çš„è§’åº¦æ¥è€ƒè™‘æ—¢ç„¶å¹³å°æä¾›äº†è¿™éƒ¨åˆ†åŠŸèƒ½ï¼Œå°±åº”è¯¥åœ¨éƒ¨ç½²çš„æ—¶å€™è§£å†³æ‰€æœ‰çš„ä¾èµ–é—®é¢˜ï¼Œè€Œä¸æ˜¯è®©æˆ‘è‡ªå·±æ‰‹åŠ¨ä¸´æ—¶æ¥è§£å†³ã€‚</p><h4 id="kubekey"><a href="#kubekey" class="headerlink" title="kubekey"></a>kubekey</h4><p>åœ¨ kubekey ä¸­ä¸€äº›ä¾èµ–é¡¹ç›®åˆ™æ˜¯è¦æ±‚ç”¨æˆ·è‡ªè¡Œå®‰è£…ï¼Œå¹¶æ²¡æœ‰æä¾›ç¦»çº¿å®‰è£…çš„æ–¹å¼ï¼š</p><blockquote><ul><li>å»ºè®®æ‚¨ä½¿ç”¨å¹²å‡€çš„æ“ä½œç³»ç»Ÿï¼ˆä¸å®‰è£…ä»»ä½•å…¶ä»–è½¯ä»¶ï¼‰ï¼Œå¦åˆ™å¯èƒ½ä¼šæœ‰å†²çªã€‚</li><li>è¯·ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹çš„ç¡¬ç›˜è‡³å°‘æœ‰ <strong>100G</strong>ã€‚</li><li>æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»éƒ½èƒ½é€šè¿‡ <code>SSH</code> è®¿é—®ã€‚</li><li>æ‰€æœ‰èŠ‚ç‚¹æ—¶é—´åŒæ­¥ã€‚</li><li>æ‰€æœ‰èŠ‚ç‚¹éƒ½åº”ä½¿ç”¨ <code>sudo</code>/<code>curl</code>/<code>openssl</code>ã€‚</li></ul><p>KubeKey èƒ½å¤ŸåŒæ—¶å®‰è£… Kubernetes å’Œ KubeSphereã€‚æ ¹æ®è¦å®‰è£…çš„ Kubernetes ç‰ˆæœ¬ï¼Œéœ€è¦å®‰è£…çš„ä¾èµ–é¡¹å¯èƒ½ä¼šä¸åŒã€‚æ‚¨å¯ä»¥å‚è€ƒä¸‹æ–¹åˆ—è¡¨ï¼ŒæŸ¥çœ‹æ˜¯å¦éœ€è¦æå‰åœ¨æ‚¨çš„èŠ‚ç‚¹ä¸Šå®‰è£…ç›¸å…³ä¾èµ–é¡¹ã€‚</p><table><thead><tr><th align="left">ä¾èµ–é¡¹</th><th align="left">Kubernetes ç‰ˆæœ¬ â‰¥ 1.18</th><th align="left">Kubernetes ç‰ˆæœ¬ &lt; 1.18</th></tr></thead><tbody><tr><td align="left"><code>socat</code></td><td align="left">å¿…é¡»</td><td align="left">å¯é€‰ä½†å»ºè®®</td></tr><tr><td align="left"><code>conntrack</code></td><td align="left">å¿…é¡»</td><td align="left">å¯é€‰ä½†å»ºè®®</td></tr><tr><td align="left"><code>ebtables</code></td><td align="left">å¯é€‰ä½†å»ºè®®</td><td align="left">å¯é€‰ä½†å»ºè®®</td></tr><tr><td align="left"><code>ipset</code></td><td align="left">å¯é€‰ä½†å»ºè®®</td><td align="left">å¯é€‰ä½†å»ºè®®</td></tr></tbody></table><p>å¤‡æ³¨</p><ul><li>åœ¨ç¦»çº¿ç¯å¢ƒä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç§æœ‰åŒ…ã€RPM åŒ…ï¼ˆé€‚ç”¨äº CentOSï¼‰æˆ–è€… Deb åŒ…ï¼ˆé€‚ç”¨äº Debianï¼‰æ¥å®‰è£…è¿™äº›ä¾èµ–é¡¹ã€‚</li><li>å»ºè®®æ‚¨äº‹å…ˆåˆ›å»ºä¸€ä¸ªæ“ä½œç³»ç»Ÿé•œåƒæ–‡ä»¶ï¼Œå¹¶ä¸”å®‰è£…å¥½æ‰€æœ‰ç›¸å…³ä¾èµ–é¡¹ã€‚è¿™æ ·ï¼Œæ‚¨ä¾¿å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥é•œåƒæ–‡ä»¶åœ¨æ¯å°æœºå™¨ä¸Šå®‰è£…æ“ä½œç³»ç»Ÿï¼Œæé«˜éƒ¨ç½²æ•ˆç‡ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒä»»ä½•ä¾èµ–é¡¹é—®é¢˜ã€‚</li></ul><p>æ‚¨çš„é›†ç¾¤å¿…é¡»æœ‰ä¸€ä¸ªå¯ç”¨çš„å®¹å™¨è¿è¡Œæ—¶ã€‚åœ¨ç¦»çº¿ç¯å¢ƒä¸­åˆ›å»ºé›†ç¾¤ä¹‹å‰ï¼Œæ‚¨å¿…é¡»æ‰‹åŠ¨å®‰è£… Docker æˆ–å…¶ä»–å®¹å™¨è¿è¡Œæ—¶ã€‚</p><p><a href="https://github.com/kubesphere/kubekey#requirements-and-recommendations" target="_blank" rel="noopener">Requirements and Recommendations</a></p></blockquote><h4 id="æ„å»ºç¦»çº¿æº"><a href="#æ„å»ºç¦»çº¿æº" class="headerlink" title="æ„å»ºç¦»çº¿æº"></a>æ„å»ºç¦»çº¿æº</h4><p>å¯¹äºç³»ç»Ÿ rpm/deb åŒ…çš„ä¾èµ–ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¸è¸å®å®åœ°ä½¿ç”¨åŒ…ç®¡ç†å™¨æ¥å®‰è£…è¿™äº›åŒ…è¾ƒä¸ºå¦¥å½“ï¼Œå› æ­¤æˆ‘ä»¬æœ‰å¿…è¦ä¸ºè¿™äº›ä¾èµ–çš„ rpm/deb åŒ…æ„å»ºæˆç¦»çº¿æºï¼Œéƒ¨ç½²çš„æ—¶å€™ä½¿ç”¨è¿™ä¸ªç¦»çº¿æºæ¥å®‰è£…è¿™äº›ä¾èµ–ã€‚åœ¨ ã€Š<a href="https://blog.k8s.li/make-offline-mirrors.html">ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</a>ã€‹ä¸€æ–‡ä¸­æ›¾åˆ†æè¿‡åˆ¶ä½œå’Œä½¿ç”¨ç¦»çº¿æºè¿™ä¹ˆéš¾çš„åŸå› ï¼š</p><blockquote><p>ä½œä¸ºå¹³å°éƒ¨ç½²å·¥å…·çš„å¼€å‘è€…ï¼Œå§‹ç»ˆè¢«ç¦»çº¿éƒ¨ç½²è¿™ä¸ªéš¾é¢˜å›°æ‰°ç€ã€‚åœ¨çº¿çš„å®¹å™¨é•œåƒå’ŒäºŒè¿›åˆ¶æ–‡ä»¶æ¯”è¾ƒå¥½è§£å†³ï¼Œå› ä¸ºè¿™äº›èµ„æºæ˜¯ä¸ OS æ— å…³çš„ï¼Œåªè¦ä¸‹è½½ä¸‹æ¥æ”¾åˆ°å®‰è£…åŒ…é‡Œï¼Œéƒ¨ç½²çš„æ—¶å€™å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨å’Œé•œåƒä»“åº“æœåŠ¡æä¾›è¿™äº›èµ„æºçš„ä¸‹è½½å³å¯ã€‚</p><p>ä½†æ˜¯å¯¹äº yum/apt ä¹‹ç±»çš„è½¯ä»¶æ¥è®²å¹¶ä¸é‚£ä¹ˆç®€å•ï¼š</p><ul><li>é¦–å…ˆç”±äºå„ä¸ªåŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»æ¯”è¾ƒå¤æ‚ï¼Œå¹¶ä¸èƒ½å°†å®ƒä»¬ç›´æ¥ä¸‹è½½ä¸‹æ¥ï¼›</li><li>å…¶æ¬¡å³ä¾¿ä¸‹è½½ä¸‹æ¥ä¹‹åä¹Ÿæ— æ³•ç›´æ¥é€šè¿‡ yum/apt çš„æ–¹å¼å®‰è£…æŒ‡å®šçš„è½¯ä»¶åŒ…ï¼Œè™½ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ scp çš„æ–¹å¼å°†è¿™äº›åŒ…å¤åˆ¶åˆ°éƒ¨ç½²èŠ‚ç‚¹ï¼Œé€šè¿‡ rpm æˆ– dpkg çš„æ–¹å¼æ¥å®‰è£…ä¸Šï¼Œä½†è¿™æ ·å¹¶ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œè€Œä¸”é€šç”¨æ€§èƒ½ä¹Ÿä¸æ˜¯å¾ˆå¥½ï¼›</li><li>æœ€åéœ€è¦é€‚é…çš„ Linux å‘è¡Œç‰ˆå’ŒåŒ…ç®¡ç†å™¨ç§ç±»ä¹Ÿæœ‰å¤šç§ï¼Œè€Œä¸”æœ‰äº›åŒ…çš„åŒ…åæˆ–è€…ç‰ˆæœ¬å·åœ¨ä¸åŒçš„åŒ…ç®¡ç†ä¹‹é—´ä¹Ÿç›¸å·®ç”šå¤§ï¼Œæ— æ³•åšåˆ°ç»Ÿä¸€ç®¡ç†ã€‚</li><li>ç¦»çº¿æºåŒæ—¶é€‚é…é€‚é… ARM64 å’Œ AMD64 æœ‰ä¸€å®šçš„éš¾åº¦</li></ul></blockquote><p>å¥½åœ¨æ–‡ä¸­ä¹Ÿç»™å‡ºäº†ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œå³é€šè¿‡ Dockerfile æ¥æ„å»ºç¦»çº¿æºï¼Œå…·ä½“çš„å®ç°ç»†èŠ‚å¯ä»¥ç¿»çœ‹ã€Š<a href="https://blog.k8s.li/make-offline-mirrors.html">ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</a>ã€‹ä¸€æ–‡ã€‚ä½¿ç”¨è¿™ä¸ªæ–¹æ¡ˆå¯ä»¥è§£å†³ PaaS æˆ–è€… IaaS å±‚é¢çš„ç¦»çº¿æºåˆ¶ä½œçš„éš¾é¢˜ï¼ŒåŒæ ·ä¹Ÿé€‚ç”¨äºæˆ‘ä»¬éƒ¨ç½² K8s é›†ç¾¤çš„åœºæ™¯ï¼Œè€Œä¸”é‡‡ç”¨ Dockerfile çš„æ–¹å¼æ¥æ„å»ºç¦»çº¿æºå¯ä»¥å®Œç¾åœ°è§£å†³åŒæ—¶é€‚é… arm64 å’Œ amd64 çš„éš¾é¢˜ã€‚</p><h3 id="files"><a href="#files" class="headerlink" title="files"></a>files</h3><p>ä¸€äº›éƒ¨ç½²è¿‡ç¨‹ä¸­éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- kubelet</span><br><span class="line">- kubeadm</span><br><span class="line">- kubectl</span><br><span class="line">- etcd            <span class="comment"># systemd æ–¹å¼éƒ¨ç½² etcd æ—¶éœ€è¦çš„å®‰è£…åŒ…</span></span><br><span class="line">- crictl          <span class="comment"># k8s å®˜æ–¹çš„ CRI CLI å·¥å…·</span></span><br><span class="line">- calicoctl       <span class="comment"># calico çš„ CLI å·¥å…·</span></span><br><span class="line">- helm            <span class="comment"># å®‰è£… helm éœ€è¦çš„äºŒè¿›åˆ¶å®‰è£…åŒ…</span></span><br><span class="line">- nerdctl         <span class="comment"># containerd çš„ CLI å·¥å…·</span></span><br><span class="line">- cni-plugins     <span class="comment"># CNI æ’ä»¶</span></span><br><span class="line">- cuda            <span class="comment"># GPU ä¾èµ–</span></span><br><span class="line">- nvidia_driver   <span class="comment"># GPU é©±åŠ¨</span></span><br></pre></td></tr></table></figure><h4 id="sealos-1"><a href="#sealos-1" class="headerlink" title="sealos"></a>sealos</h4><p>sealos å¯¹äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤„ç†æ¯”è¾ƒå¥½ï¼Œå…¨éƒ¨æ‰“åŒ…åœ¨ç¦»çº¿å®‰è£…åŒ…é‡Œï¼Œéƒ¨ç½²çš„æ—¶å€™ä¼šåˆ†å‘åˆ°é›†ç¾¤èŠ‚ç‚¹ä¸Šï¼Œæ•´ä¸ªéƒ¨ç½²è¿‡ç¨‹éƒ½æ— éœ€è®¿é—®å…¬ç½‘ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tar -tf kube1.20.0.tar.gz</span><br><span class="line">kube/bin/kubelet</span><br><span class="line">kube/bin/kubectl</span><br><span class="line">kube/bin/conntrack</span><br><span class="line">kube/bin/kubeadm</span><br></pre></td></tr></table></figure><h4 id="kubekey-1"><a href="#kubekey-1" class="headerlink" title="kubekey"></a>kubekey</h4><p>åœ¨ kubekey çš„æºç å½“ä¸­ï¼Œæ˜¯å°†æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶çš„ URL ç¡¬ç¼–ç åœ¨ä»£ç å½“ä¸­çš„ã€‚å¦‚æœåœ¨éƒ¨ç½²çš„æ—¶å€™éœ€è¦æ ¹æ®éƒ¨ç½²ç¯å¢ƒæ¥ä¿®æ”¹äºŒè¿›åˆ¶æ–‡ä»¶çš„ä¸‹è½½åœ°å€ï¼Œæ¯”å¦‚ä»å†…ç½‘ nginx æœåŠ¡å™¨ä¸Šä¸‹è½½ï¼Œå°±éœ€è¦ä¿®æ”¹è¿™éƒ¨åˆ†æºç æŠŠ <code>https://kubernetes-release.pek3b.qingstor.com</code> ä¿®æ”¹æˆå†…ç½‘åœ°å€ï¼Œæ¯”å¦‚ <code>http://172.20.0.25:8080/files</code> ï¼Œç„¶è€Œåœ¨éƒ¨ç½²çš„æ—¶å€™é‡æ–°ç¼–è¯‘ kubekey çš„ä»£ç åˆå¿…é¡»èƒ½è®¿é—®å…¬ç½‘æ‰è¡Œï¼Œè¿™å°±å¾ˆåƒµç¡¬ã€‚æ‰€ä»¥ä»¥ç›®å‰å¼€æºçš„ kubekey æ¥çœ‹ï¼Œæ˜¯æ²¡æœ‰åŠæ³•åšåˆ°æ— ç½‘ç¯å¢ƒä¸­æ„‰å¿«åœ°éƒ¨ç½² k8s çš„ï¼Œå¯èƒ½å•†ä¸šç‰ˆçš„æ”¯æŒï¼ˆçŒœæµ‹ã€‚</p><ul><li><a href="https://github.com/kubesphere/kubekey/blob/master/pkg/kubernetes/preinstall/preinstall.go" target="_blank" rel="noopener">kubekey/blob/master/pkg/kubernetes/preinstall/preinstall.go</a></li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FilesDownloadHTTP defines the kubernetes' binaries that need to be downloaded in advance and downloads them.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FilesDownloadHTTP</span><span class="params">(mgr *manager.Manager, filepath, version, arch <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">kkzone := os.Getenv(<span class="string">"KKZONE"</span>)</span><br><span class="line">etcd := files.KubeBinary&#123;Name: <span class="string">"etcd"</span>, Arch: arch, Version: kubekeyapiv1alpha1.DefaultEtcdVersion&#125;</span><br><span class="line">kubeadm := files.KubeBinary&#123;Name: <span class="string">"kubeadm"</span>, Arch: arch, Version: version&#125;</span><br><span class="line">kubelet := files.KubeBinary&#123;Name: <span class="string">"kubelet"</span>, Arch: arch, Version: version&#125;</span><br><span class="line">kubectl := files.KubeBinary&#123;Name: <span class="string">"kubectl"</span>, Arch: arch, Version: version&#125;</span><br><span class="line">kubecni := files.KubeBinary&#123;Name: <span class="string">"kubecni"</span>, Arch: arch, Version: kubekeyapiv1alpha1.DefaultCniVersion&#125;</span><br><span class="line">helm := files.KubeBinary&#123;Name: <span class="string">"helm"</span>, Arch: arch, Version: kubekeyapiv1alpha1.DefaultHelmVersion&#125;</span><br><span class="line"></span><br><span class="line">etcd.Path = fmt.Sprintf(<span class="string">"%s/etcd-%s-linux-%s.tar.gz"</span>, filepath, kubekeyapiv1alpha1.DefaultEtcdVersion, arch)</span><br><span class="line">kubeadm.Path = fmt.Sprintf(<span class="string">"%s/kubeadm"</span>, filepath)</span><br><span class="line">kubelet.Path = fmt.Sprintf(<span class="string">"%s/kubelet"</span>, filepath)</span><br><span class="line">kubectl.Path = fmt.Sprintf(<span class="string">"%s/kubectl"</span>, filepath)</span><br><span class="line">kubecni.Path = fmt.Sprintf(<span class="string">"%s/cni-plugins-linux-%s-%s.tgz"</span>, filepath, arch, kubekeyapiv1alpha1.DefaultCniVersion)</span><br><span class="line">helm.Path = fmt.Sprintf(<span class="string">"%s/helm"</span>, filepath)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> kkzone == <span class="string">"cn"</span> &#123;</span><br><span class="line">etcd.Url = fmt.Sprintf(<span class="string">"https://kubernetes-release.pek3b.qingstor.com/etcd/release/download/%s/etcd-%s-linux-%s.tar.gz"</span>, etcd.Version, etcd.Version, etcd.Arch)</span><br><span class="line">kubeadm.Url = fmt.Sprintf(<span class="string">"https://kubernetes-release.pek3b.qingstor.com/release/%s/bin/linux/%s/kubeadm"</span>, kubeadm.Version, kubeadm.Arch)</span><br><span class="line">kubelet.Url = fmt.Sprintf(<span class="string">"https://kubernetes-release.pek3b.qingstor.com/release/%s/bin/linux/%s/kubelet"</span>, kubelet.Version, kubelet.Arch)</span><br><span class="line">kubectl.Url = fmt.Sprintf(<span class="string">"https://kubernetes-release.pek3b.qingstor.com/release/%s/bin/linux/%s/kubectl"</span>, kubectl.Version, kubectl.Arch)</span><br><span class="line">kubecni.Url = fmt.Sprintf(<span class="string">"https://containernetworking.pek3b.qingstor.com/plugins/releases/download/%s/cni-plugins-linux-%s-%s.tgz"</span>, kubecni.Version, kubecni.Arch, kubecni.Version)</span><br><span class="line">helm.Url = fmt.Sprintf(<span class="string">"https://kubernetes-helm.pek3b.qingstor.com/linux-%s/%s/helm"</span>, helm.Arch, helm.Version)</span><br><span class="line">helm.GetCmd = mgr.DownloadCommand(helm.Path, helm.Url)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">etcd.Url = fmt.Sprintf(<span class="string">"https://github.com/coreos/etcd/releases/download/%s/etcd-%s-linux-%s.tar.gz"</span>, etcd.Version, etcd.Version, etcd.Arch)</span><br><span class="line">kubeadm.Url = fmt.Sprintf(<span class="string">"https://storage.googleapis.com/kubernetes-release/release/%s/bin/linux/%s/kubeadm"</span>, kubeadm.Version, kubeadm.Arch)</span><br><span class="line">kubelet.Url = fmt.Sprintf(<span class="string">"https://storage.googleapis.com/kubernetes-release/release/%s/bin/linux/%s/kubelet"</span>, kubelet.Version, kubelet.Arch)</span><br><span class="line">kubectl.Url = fmt.Sprintf(<span class="string">"https://storage.googleapis.com/kubernetes-release/release/%s/bin/linux/%s/kubectl"</span>, kubectl.Version, kubectl.Arch)</span><br><span class="line">kubecni.Url = fmt.Sprintf(<span class="string">"https://github.com/containernetworking/plugins/releases/download/%s/cni-plugins-linux-%s-%s.tgz"</span>, kubecni.Version, kubecni.Arch, kubecni.Version)</span><br><span class="line">helm.Url = fmt.Sprintf(<span class="string">"https://get.helm.sh/helm-%s-linux-%s.tar.gz"</span>, helm.Version, helm.Arch)</span><br><span class="line">getCmd := mgr.DownloadCommand(fmt.Sprintf(<span class="string">"%s/helm-%s-linux-%s.tar.gz"</span>, filepath, helm.Version, helm.Arch), helm.Url)</span><br><span class="line">helm.GetCmd = fmt.Sprintf(<span class="string">"%s &amp;&amp; cd %s &amp;&amp; tar -zxf helm-%s-linux-%s.tar.gz &amp;&amp; mv linux-%s/helm . &amp;&amp; rm -rf *linux-%s*"</span>, getCmd, filepath, helm.Version, helm.Arch, helm.Arch, helm.Arch)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤å¤– kubekey åœ¨å®‰è£… docker æ—¶ï¼Œæ˜¯ç›´æ¥è°ƒç”¨çš„ <a href="https://get.docker.com/" target="_blank" rel="noopener">docker å®˜æ–¹çš„è„šæœ¬</a> æ¥å®‰è£…ï¼Œå®‰è£…è¿‡ç¨‹ä¹Ÿå¿…é¡»è®¿é—®å…¬ç½‘æ‰è¡Œã€‚</p><ul><li><a href="https://github.com/kubesphere/kubekey/blob/master/pkg/container-engine/docker/docker.go" target="_blank" rel="noopener">kubekey/blob/master/pkg/container-engine/docker/docker.go</a></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">installDockerOnNode</span><span class="params">(mgr *manager.Manager, _ *kubekeyapiv1alpha1.HostCfg)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">dockerConfig, err := GenerateDockerConfig(mgr)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line">dockerConfigBase64 := base64.StdEncoding.EncodeToString([]<span class="keyword">byte</span>(dockerConfig))</span><br><span class="line">output, err1 := mgr.Runner.ExecuteCmd(fmt.Sprintf(<span class="string">"sudo -E /bin/sh -c \"if [ -z $(which docker) ] || [ ! -e /var/run/docker.sock ]; then curl https://kubernetes.pek3b.qingstor.com/tools/kubekey/docker-install.sh | sh &amp;&amp; systemctl enable docker; if [ ! -f /etc/docker/daemon.json ]; then mkdir -p /etc/docker &amp;&amp; echo %s | base64 -d &gt; /etc/docker/daemon.json; fi; systemctl daemon-reload &amp;&amp; systemctl restart docker; fi\""</span>, dockerConfigBase64), <span class="number">0</span>, <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">if</span> err1 != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errors.Wrap(errors.WithStack(err1), fmt.Sprintf(<span class="string">"Failed to install docker:\n%s"</span>, output))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ docker å®˜æ–¹çš„å®‰è£…è„šæœ¬æ¥å®‰è£… docker æ˜¯æœ‰ä¸€ä¸ªæ˜æ˜¾çš„é—®é¢˜å°±æ˜¯ï¼šæ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶ï¼Œä¸èƒ½æŒ‡å®š docker çš„ç‰ˆæœ¬ï¼Œæ¯æ¬¡å®‰è£…çš„ docker ç‰ˆæœ¬éƒ½æ˜¯æœ€æ–°çš„ stable ç‰ˆæœ¬ã€‚æ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶å°±ä¼šå¯¼è‡´ä¸åŒæ—¶é—´éƒ¨ç½²çš„é›†ç¾¤æˆ–è€…åŠ å…¥çš„èŠ‚ç‚¹ï¼Œdocker ç‰ˆæœ¬å¯èƒ½å°±ä¸ä¸€æ ·ï¼Œåœ¨è¿™é‡Œå¯èƒ½ä¼šåŸ‹ä¸‹ä¸€äº›å‘ï¼Œå¯èƒ½ä¼šå¸¦æ¥ä¸€å®šçš„ç»´æŠ¤æˆæœ¬æˆ–è€…å°†æ¥å‡çº§æ—¶é‡åˆ°é—®é¢˜ã€‚</p><p>ç¼–è¯‘è¿‡ kubernetes ç»„ä»¶çš„å¯èƒ½éƒ½çŸ¥é“ k8s æºç å½“ä¸­å­˜åœ¨ä¸€ä¸ª <a href="https://github.com/kubernetes/kubernetes/blob/master/build/dependencies.yaml" target="_blank" rel="noopener">build/dependencies.yaml</a> çš„æ–‡ä»¶ï¼Œé‡Œé¢è®°å½•çš„æ˜¯ k8s ç»„ä»¶ä¸å…¶ä»–ç»„ä»¶ (å¦‚ docker, etcd, coredns, cni, pause) æ‰€åŒ¹é…çš„æœ€ä½³ç‰ˆæœ¬ã€‚</p><blockquote><p>On each of your nodes, install the Docker for your Linux distribution as per <a href="https://docs.docker.com/engine/install/#server" target="_blank" rel="noopener">Install Docker Engine</a>. You can find the latest validated version of Docker in this <a href="https://git.k8s.io/kubernetes/build/dependencies.yaml" target="_blank" rel="noopener">dependencies</a> file.</p></blockquote><ul><li><a href="https://github.com/kubernetes/kubernetes/blob/release-1.20/build/dependencies.yaml" target="_blank" rel="noopener">kubernetes/blob/release-1.20/build/dependencies.yaml</a></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="comment"># zeitgeist (https://github.com/kubernetes-sigs/zeitgeist) was inspired by</span></span><br><span class="line">  <span class="comment"># (and now replaces) the cmd/verifydependencies tool to verify external</span></span><br><span class="line">  <span class="comment"># dependencies across the repo.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># The zeitgeist dependencies.yaml file format is intended to be</span></span><br><span class="line">  <span class="comment"># backwards-compatible with the original tooling.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># In instances where the file format may change across versions, this meta</span></span><br><span class="line">  <span class="comment"># dependency check exists to ensure we're pinned to a known good version.</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># ref: https://github.com/kubernetes/kubernetes/pull/98845</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Docker</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"docker"</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">19.03</span></span><br><span class="line">    <span class="attr">refPaths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">vendor/k8s.io/system-validators/validators/docker_validator.go</span></span><br><span class="line">      <span class="attr">match:</span> <span class="string">latestValidatedDockerVersion</span></span><br></pre></td></tr></table></figure><p>ä»¥ 1.20.x ç‰ˆæœ¬çš„ k8s ä¸ºä¾‹ï¼Œå®ƒæ‰€ä¾èµ–çš„ docker ç‰ˆæœ¬ä¸º 19.03ï¼Œè€Œç°åœ¨æœ€æ–°çš„ docker ç‰ˆæœ¬å¦‚ 20.10.8ï¼Œå¹¶ä¸æ˜¯ K8s å®˜æ–¹æ‰€å»ºè®®çš„æœ€ä½³ç‰ˆæœ¬ã€‚æ€»ä¹‹ï¼Œæˆ‘ä»¬åœ¨éƒ¨ç½² K8s æ—¶ï¼Œå¯ä»¥å‚è€ƒ <a href="https://github.com/kubernetes/kubernetes/blob/master/build/dependencies.yaml" target="_blank" rel="noopener">build/dependencies.yaml</a> æ¥ç¡®å®šä¸ K8s ç›¸å…³çš„ç»„ä»¶åº”è¯¥é€‰æ‹©å“ªä¸€ä¸ªæœ€ä½³çš„ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯éšä¾¿è£…ä¸€ä¸ªæœ€æ–°çš„ç‰ˆæœ¬å°±å®Œäº‹å„¿äº†ã€‚</p><h4 id="kubespray"><a href="#kubespray" class="headerlink" title="kubespray"></a>kubespray</h4><p>åœ¨ kubespray ä¸­ï¼Œæ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶çš„ URL éƒ½æ˜¯é€šè¿‡å˜é‡çš„æ–¹å¼å®šä¹‰çš„ï¼Œæƒ³è¦åšåˆ°ç¦»çº¿éƒ¨ç½²ååˆ†ç®€å•ï¼Œåªéœ€è¦é€šè¿‡ ansible å˜é‡ä¼˜å…ˆçº§çš„ç‰¹æ€§ï¼Œå°†å®ƒä»¬åœ¨ group_vars é€šè¿‡ overrides çš„æ–¹å¼è¦†ç›–å³å¯ã€‚æ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download URLs</span></span><br><span class="line"><span class="attr">kubelet_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubelet"</span></span><br><span class="line"><span class="attr">kubectl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubectl"</span></span><br><span class="line"><span class="attr">kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubeadm"</span></span><br></pre></td></tr></table></figure><h3 id="images"><a href="#images" class="headerlink" title="images"></a>images</h3><p>ä¸€äº›å¦‚ kube-proxyã€kube-apiserverã€corednsã€calico ç»„ä»¶é•œåƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">k8s.gcr.io/kube-apiserver:v1.20.7</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.20.7</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.20.7</span><br><span class="line">k8s.gcr.io/kube-registry-proxy:0.4</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.20.7</span><br><span class="line">k8s.gcr.io/pause:3.3</span><br><span class="line">k8s.gcr.io/coredns:1.7.0</span><br><span class="line">k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64:1.8.3</span><br><span class="line">k8s.gcr.io/dns/k8s-dns-node-cache:1.17.1</span><br></pre></td></tr></table></figure><h4 id="sealos-2"><a href="#sealos-2" class="headerlink" title="sealos"></a>sealos</h4><p>sealos å°†è¿™äº›é•œåƒä½¿ç”¨ docker save çš„æ–¹å¼æ‰“åŒ…æˆä¸€ä¸ª tar åŒ…ï¼Œåœ¨éƒ¨ç½²çš„æ—¶å€™ä½¿ç”¨ docker/ctr load çš„æ–¹å¼å°†é•œåƒå¯¼å…¥åˆ°å®¹å™¨è¿è¡Œæ—¶çš„å­˜å‚¨ç›®å½•å½“ä¸­ï¼Œæºç å¦‚ä¸‹ï¼š</p><ul><li><a href="https://github.com/fanux/sealos/blob/develop/install/send.go" target="_blank" rel="noopener">fanux/sealos/blob/develop/install/send.go</a></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SendPackage is send new pkg to all nodes.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *SealosUpgrade)</span> <span class="title">SendPackage</span><span class="params">()</span></span> &#123;</span><br><span class="line">all := <span class="built_in">append</span>(u.Masters, u.Nodes...)</span><br><span class="line">pkg := path.Base(u.NewPkgUrl)</span><br><span class="line"><span class="comment">// rm old sealos in package avoid old version problem. if sealos not exist in package then skip rm</span></span><br><span class="line"><span class="keyword">var</span> kubeHook <span class="keyword">string</span></span><br><span class="line"><span class="keyword">if</span> For120(Version) &#123;</span><br><span class="line"><span class="comment">// TODO update need load modprobe -- br_netfilter modprobe -- bridge.</span></span><br><span class="line"><span class="comment">// https://github.com/fanux/cloud-kernel/issues/23</span></span><br><span class="line">kubeHook = fmt.Sprintf(<span class="string">"cd /root &amp;&amp; rm -rf kube &amp;&amp; tar zxvf %s  &amp;&amp; cd /root/kube/shell &amp;&amp; rm -f ../bin/sealos &amp;&amp; (ctr -n=k8s.io image import ../images/images.tar || true) &amp;&amp; cp -f ../bin/* /usr/bin/ "</span>, pkg)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">kubeHook = fmt.Sprintf(<span class="string">"cd /root &amp;&amp; rm -rf kube &amp;&amp; tar zxvf %s  &amp;&amp; cd /root/kube/shell &amp;&amp; rm -f ../bin/sealos &amp;&amp; (docker load -i ../images/images.tar || true) &amp;&amp; cp -f ../bin/* /usr/bin/ "</span>, pkg)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PkgUrl = SendPackage(pkg, all, <span class="string">"/root"</span>, <span class="literal">nil</span>, &amp;kubeHook)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ç§æ–¹å¼åŠ è½½é•œåƒæœ‰ä¸€ä¸ªæ¯”è¾ƒæ˜æ˜¾çš„é™åˆ¶å°±æ˜¯ kube-apiserver çš„ admission å‡†å…¥æ§åˆ¶ä¸­ä¸èƒ½åŠ å…¥ <code>AlwaysPullImages</code> å‚æ•°ã€‚ä¸ç„¶ä¸è¿™äº›é•œåƒç›¸å…³çš„ pod é‡æ–°è°ƒåº¦æˆ–è€…é‡å¯ä¹‹åä¼šé‡æ–°ä»æºé•œåƒä»“åº“æ‹‰å–é•œåƒï¼Œåœ¨æ— ç½‘æˆ–è€…ç½‘ç»œé™åˆ¶çš„ç¯å¢ƒä¸­å¯èƒ½æ— æ³•æ‹‰å–é•œåƒå¯¼è‡´è¿™äº› Pod å¯åŠ¨å¤±è´¥ï¼Œä»è€Œå¯¼è‡´é›†ç¾¤å¼‚å¸¸ã€‚</p><p>è€Œåœ¨å¤šç§Ÿæˆ·åœºæ™¯ä¸‹ï¼Œå‡ºäºå®‰å…¨çš„è€ƒè™‘  <code>AlwaysPullImages</code> å‡†å…¥æ§åˆ¶å¾€å¾€æ˜¯è¦å¼€å¯çš„ã€‚å› æ­¤ sealos å¯èƒ½å¹¶ä¸é€‚ç”¨äºå¤šç§Ÿæˆ·æˆ–è€…å¯¹æ­¤æœ‰è¦æ±‚çš„ç¯å¢ƒä¸­ï¼ˆæœ€å¸¸è§çš„å°±æ˜¯ PaaS å¹³å°ï¼‰ã€‚</p><blockquote><p>è¯¥å‡†å…¥æ§åˆ¶å™¨ä¼šä¿®æ”¹æ¯ä¸€ä¸ªæ–°åˆ›å»ºçš„ Pod çš„é•œåƒæ‹‰å–ç­–ç•¥ä¸º Always ã€‚ è¿™åœ¨å¤šç§Ÿæˆ·é›†ç¾¤ä¸­æ˜¯æœ‰ç”¨çš„ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥æ”¾å¿ƒï¼Œä»–ä»¬çš„ç§æœ‰é•œåƒåªèƒ½è¢«é‚£äº›æœ‰å‡­è¯çš„äººä½¿ç”¨ã€‚ å¦‚æœæ²¡æœ‰è¿™ä¸ªå‡†å…¥æ§åˆ¶å™¨ï¼Œä¸€æ—¦é•œåƒè¢«æ‹‰å–åˆ°èŠ‚ç‚¹ä¸Šï¼Œä»»ä½•ç”¨æˆ·çš„ Pod éƒ½å¯ä»¥é€šè¿‡å·²äº†è§£åˆ°çš„é•œåƒçš„åç§°ï¼ˆå‡è®¾ Pod è¢«è°ƒåº¦åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ä¸Šï¼‰æ¥ä½¿ç”¨å®ƒï¼Œè€Œä¸éœ€è¦å¯¹é•œåƒè¿›è¡Œä»»ä½•æˆæƒæ£€æŸ¥ã€‚ å½“å¯ç”¨è¿™ä¸ªå‡†å…¥æ§åˆ¶å™¨æ—¶ï¼Œæ€»æ˜¯åœ¨å¯åŠ¨å®¹å™¨ä¹‹å‰æ‹‰å–é•œåƒï¼Œè¿™æ„å‘³ç€éœ€è¦æœ‰æ•ˆçš„å‡­è¯ã€‚</p></blockquote><h4 id="kubekey-2"><a href="#kubekey-2" class="headerlink" title="kubekey"></a>kubekey</h4><p><a href="https://kubesphere.io/docs/installing-on-linux/introduction/air-gapped-installation/" target="_blank" rel="noopener">kubekey å®˜æ–¹çš„æ–‡æ¡£</a> ä¸­æœ‰æåˆ°ç»„ä»¶é•œåƒç¦»çº¿éƒ¨ç½²çš„æ–¹å¼ï¼Œä¸è¿‡ååˆ†ç¹ç(åŠé€€ğŸ˜‚)ï¼Œåœ¨ <a href="https://github.com/kubesphere/kubekey/issues/597" target="_blank" rel="noopener">Offline installation is too troublesome #597</a> ä¸­ä¹Ÿæœ‰äººåæ§½è¿™ä¸ªé—®é¢˜ã€‚ä¸è¿‡ç›®å‰ kubekey å¼€å‘å›¢é˜Ÿå·²ç»åœ¨é‡æ„è¿™éƒ¨åˆ†å†…å®¹äº†ï¼Œè‡³äºç»“æœå¦‚ä½•ï¼Œåªèƒ½ç­‰äº†ã€‚</p><h4 id="é•œåƒä»“åº“"><a href="#é•œåƒä»“åº“" class="headerlink" title="é•œåƒä»“åº“"></a>é•œåƒä»“åº“</h4><p>åœ¨ç§æœ‰äº‘ç¯å¢ƒä¸­ï¼Œä¼ä¸šä¸€èˆ¬éƒ½ä¼šæœ‰è‡ªå·±çš„é•œåƒä»“åº“ï¼ˆæ¯”å¦‚ harbor ï¼‰ç”¨äºå­˜æ”¾ä¸šåŠ¡ç»„ä»¶é•œåƒæˆ–è€…ä¸€äº›å…¶ä»–å¹³å°ä¾èµ–çš„é•œåƒã€‚å†åŠ ä¸Š Docker Hub è‡ªä»å»å¹´å¼€å§‹å°±åŠ å…¥äº† pull é•œåƒæ¬¡æ•°çš„é™åˆ¶ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨ Docker Hub ä¸Šé¢çš„é•œåƒæ¥éƒ¨ç½²é›†ç¾¤ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå› ä¸º <a href="https://www.docker.com/increase-rate-limit" target="_blank" rel="noopener">429 toomanyrequests</a> æˆ–è€…ä¸€äº›ç½‘ç»œåŸå› å¯¼è‡´æ‹‰å–é•œåƒå¤±è´¥ã€‚å› æ­¤å¯¹äº k8s é›†ç¾¤éƒ¨ç½²è€Œè¨€ï¼Œå»ºè®®ä½¿ç”¨å†…éƒ¨è‡ªå·±çš„é•œåƒä»“åº“ï¼Œè€Œéå…¬ç½‘ä¸Šé•œåƒä»“åº“ã€‚å¦‚æœæ²¡æœ‰çš„è¯å¯ä»¥ä½¿ç”¨ harbor æˆ–è€… docker registry åœ¨æœ¬åœ°éƒ¨ç½²ä¸€ä¸ªé•œåƒä»“åº“ã€‚æˆ‘ä»¬å°†éƒ¨ç½²ä¾èµ–çš„é•œåƒå¯¼å…¥åˆ°å·²ç»å­˜åœ¨çš„é•œåƒä»“åº“ä¸­ï¼Œéƒ¨ç½²çš„æ—¶å€™ä»è¯¥é•œåƒä»“åº“æ‹‰å–å³å¯ã€‚</p><h2 id="éƒ¨ç½²å·¥å…·é€‰æ‹©"><a href="#éƒ¨ç½²å·¥å…·é€‰æ‹©" class="headerlink" title="éƒ¨ç½²å·¥å…·é€‰æ‹©"></a>éƒ¨ç½²å·¥å…·é€‰æ‹©</h2><p>ä¸Šé¢ç®€å•æ¢³ç†äº†ä¸€ä¸‹éƒ¨ç½² k8s é›†ç¾¤è¿‡ç¨‹ä¸­æ‰€ä¾èµ–çš„çš„åœ¨çº¿èµ„æºï¼Œä»¥åŠå¦‚ä½•å°†å®ƒä»¬åˆ¶ä½œæˆç¦»çº¿èµ„æºçš„ä¸€äº›åˆ†æã€‚ä¸Šé¢æåŠçš„éƒ¨ç½²å·¥å…·å„æœ‰å„çš„ä¼˜ç¼ºç‚¹ï¼Œé’ˆå¯¹ä»¥ä¸‹ä¸¤ç§ä¸åŒçš„åœºæ™¯å¯ä»¥é€‰æ‹©ä¸åŒçš„éƒ¨ç½²å·¥å…·ã€‚</p><h3 id="sealos-3"><a href="#sealos-3" class="headerlink" title="sealos"></a>sealos</h3><p>å¦‚æœä»…ä»…æ˜¯éƒ¨ç½²ä¸€ä¸ªç®€å•çš„ k8s é›†ç¾¤ï¼Œå¯¹é›†ç¾¤æ²¡æœ‰å¤ªå¤šå®šåˆ¶åŒ–çš„éœ€æ±‚ï¼Œé‚£ä¹ˆä½¿ç”¨ <a href="https://github.com/fanux/sealos" target="_blank" rel="noopener">sealos</a> å¯èƒ½æ˜¯æœ€ä½³çš„é€‰æ‹©ï¼Œåªä¸è¿‡å®ƒæ˜¯æ”¶è´¹çš„ï¼Œ<a href="https://www.sealyun.com/" target="_blank" rel="noopener">éœ€è¦å……å€¼ä¼šå‘˜</a> ğŸ˜‚ã€‚</p><blockquote><h3 id="ç°åœ¨å¼€å§‹-ï¿¥99-ï¿¥69-å¹´"><a href="#ç°åœ¨å¼€å§‹-ï¿¥99-ï¿¥69-å¹´" class="headerlink" title="ç°åœ¨å¼€å§‹ ï¿¥99 ï¿¥69/å¹´"></a>ç°åœ¨å¼€å§‹ <del>ï¿¥99</del> ï¿¥69/å¹´</h3><p>æ¬¢è¿æˆä¸ºå¹´è´¹ä¼šå‘˜ï¼Œä»»æ„ä¸‹è½½æ‰€æœ‰ç‰ˆæœ¬è½¯ä»¶åŒ…!</p><blockquote><p>@F-liuhui ç¦»çº¿åŒ…å±…ç„¶è¦æ”¶è´¹ï¼Ÿé‚£è¿˜æ˜¯å¼€æºé¡¹ç›®å—ï¼Ÿ</p></blockquote><p>å¼€æºä¸ä»˜è´¹ä¸å†²çªï¼Œ100%å¼€æº 100%ä»˜è´¹</p><p><a href="https://www.sealyun.com/" target="_blank" rel="noopener">sealyun.com</a></p></blockquote><p>å¦‚æœåŠ¨æ‰‹èƒ½åŠ›å¼ºçš„è¯ï¼Œå¯ä»¥æ ¹æ® selaos ç¦»çº¿å®‰è£…åŒ…çš„ç›®å½•ç»“æ„ä½¿ç”¨ GitHub Actions æ¥æ„å»ºï¼Œå®ç°èµ·æ¥ä¹Ÿä¸æ˜¯å¾ˆéš¾ã€‚åªä¸è¿‡ç ¸åˆ«äººé¥­ç¢—çš„äº‹å„¿è¿˜æ˜¯ä¸åšä¸ºå¥½ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥é€‰æ‹©å¦ä¸€ç§æ–¹æ¡ˆæ¥å®ç°ï¼Œè¿™æ ·ä¹Ÿèƒ½é¿å…ä¸€äº›å•†ä¸šçº çº·é—®é¢˜ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ tar -tf kube1.20.0.tar.gz</span><br><span class="line">kube/</span><br><span class="line">kube/lib64/</span><br><span class="line">kube/lib64/README.md</span><br><span class="line">kube/lib64/libseccomp.so.2</span><br><span class="line">kube/lib64/libseccomp.so.2.3.1</span><br><span class="line">kube/shell/</span><br><span class="line">kube/shell/containerd.sh</span><br><span class="line">kube/shell/init.sh</span><br><span class="line">kube/shell/master.sh</span><br><span class="line">kube/README.md</span><br><span class="line">kube/bin/</span><br><span class="line">kube/bin/kubelet</span><br><span class="line">kube/bin/kubectl</span><br><span class="line">kube/bin/conntrack</span><br><span class="line">kube/bin/kubeadm</span><br><span class="line">kube/bin/kubelet-pre-start.sh</span><br><span class="line">kube/conf/</span><br><span class="line">kube/conf/kubeadm.yaml</span><br><span class="line">kube/conf/kubelet.service</span><br><span class="line">kube/conf/calico.yaml</span><br><span class="line">kube/conf/10-kubeadm.conf</span><br><span class="line">kube/conf/net/</span><br><span class="line">kube/conf/net/calico.yaml</span><br><span class="line">kube/containerd/</span><br><span class="line">kube/containerd/README.md</span><br><span class="line">kube/containerd/cri-containerd-cni-linux-amd64.tar.gz</span><br><span class="line">kube/images/</span><br><span class="line">kube/images/images.tar</span><br><span class="line">kube/images/README.md</span><br></pre></td></tr></table></figure><h3 id="kubekey-3"><a href="#kubekey-3" class="headerlink" title="kubekey"></a>kubekey</h3><p>ç”±äº kubekey éƒ¨ç½²æ—¶äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦å…¬ç½‘è·å–ï¼Œdocker æ— æ³•ç¦»çº¿éƒ¨ç½²ä»¥åŠéœ€è¦æ‰‹åŠ¨å®‰è£…ä¸€äº›å‰ç½®ä¾èµ–ï¼Œæ²¡æœ‰åŠæ³•åšåˆ°å®Œæ•´çš„ç¦»çº¿éƒ¨ç½²ï¼Œå› æ­¤ç¦»çº¿éƒ¨ç½²çš„æ–¹æ¡ˆä¹Ÿå°±ç›´æ¥æ”¾å¼ƒæ‰äº†ï¼ŒæŠ½ç©ºä»–ä»¬æä¸ª Issue æˆ– PR çœ‹çœ‹èƒ½å¦æ”¯æŒè¿™éƒ¨åˆ† ğŸ˜…ã€‚</p><h3 id="kubespray-1"><a href="#kubespray-1" class="headerlink" title="kubespray"></a>kubespray</h3><p>å¦‚æœæƒ³æ‰¾ä¸€ä¸ªå³å¼€æºåˆå…è´¹çš„ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆï¼Œæˆ–è€…å¯¹é›†ç¾¤éƒ¨ç½²æœ‰ç‰¹æ®Šçš„è¦æ±‚ï¼Œæ¯”å¦‚åŸºäº K8s çš„ PaaS toB äº§å“ï¼Œéœ€è¦åœ¨éƒ¨ç½²æ—¶å®‰è£…å¹³å°æœ¬èº«éœ€è¦çš„ä¸€äº›ä¾èµ–ï¼ˆå¦‚å­˜å‚¨å®¢æˆ·ç«¯ã€GPU é©±åŠ¨ç­‰ï¼‰ã€‚é‚£ä¹ˆä¸å¦¨å…ˆçœ‹ä¸€ä¸‹ kubernetes-sig ç¤¾åŒºçš„ <a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener">kubespray</a> å¦‚ä½• ğŸ¤”ï¼Œä¸»è¦çš„ç‰¹æ€§å¦‚ä¸‹ï¼š</p><ul><li>æ”¯æŒçš„ 10 ç§ CNI æ’ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- cni-plugins v0.9.1</span><br><span class="line">- calico v3.17.4</span><br><span class="line">- canal (given calico/flannel versions)</span><br><span class="line">- cilium v1.9.9</span><br><span class="line">- flanneld v0.14.0</span><br><span class="line">- kube-ovn v1.7.1</span><br><span class="line">- kube-router v1.3.0</span><br><span class="line">- multus v3.7.2</span><br><span class="line">- ovn4nfv v1.1.0</span><br><span class="line">- weave v2.8.1</span><br></pre></td></tr></table></figure><ul><li>æ”¯æŒ 3 ç§å®¹å™¨è¿è¡Œæ—¶ä»¥åŠ <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/kata-containers.md" target="_blank" rel="noopener">Kata Containers</a> è¿˜æœ‰ nvidia-gpu-device-plugin ç­‰</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- docker v20.10</span><br><span class="line">- containerd v1.4.6</span><br><span class="line">- cri-o v1.21</span><br></pre></td></tr></table></figure><ul><li>é€‚é…äº† 10 ç§ Linux å‘è¡Œç‰ˆï¼Œè¦†ç›–äº†ç»å¤§å¤šæ•°ç§æœ‰äº‘åœºæ™¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- Flatcar Container Linux by Kinvolk</span><br><span class="line">- Debian Buster, Jessie, Stretch, Wheezy</span><br><span class="line">- Ubuntu 16.04, 18.04, 20.04</span><br><span class="line">- CentOS/RHEL 7, 8</span><br><span class="line">- Fedora 33, 34</span><br><span class="line">- Fedora CoreOS (see fcos Note)</span><br><span class="line">- openSUSE Leap 15.x/Tumbleweed</span><br><span class="line">- Oracle Linux 7, 8</span><br><span class="line">- Alma Linux 8</span><br><span class="line">- Amazon Linux 2</span><br></pre></td></tr></table></figure><ul><li>ä¸°å¯Œçš„æ’ä»¶å’Œæ‰©å±•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## å·¥å…·ç±»</span></span><br><span class="line">- helm</span><br><span class="line">- krew</span><br><span class="line">- nerdctl</span><br><span class="line"></span><br><span class="line"><span class="comment">## ä¸€äº› controller å’Œ provisioner</span></span><br><span class="line">- ambassador: v1.5</span><br><span class="line">- cephfs-provisioner v2.1.0-k8s1.11</span><br><span class="line">- rbd-provisioner v2.1.1-k8s1.11</span><br><span class="line">- cert-manager v0.16.1</span><br><span class="line">- coredns v1.8.0</span><br><span class="line">- ingress-nginx v0.43.0</span><br></pre></td></tr></table></figure><ul><li>ä¾èµ–çš„æ–‡ä»¶å’Œé•œåƒæ”¯æŒç¦»çº¿éƒ¨ç½² <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/docs/offline-environment.md" target="_blank" rel="noopener">Offline environment</a></li></ul><p>kubespray å¯¹æ‰€æœ‰çš„ä¾èµ–èµ„æºéƒ½åšåˆ°äº†ç¦»çº¿ä¸‹è½½çš„æ”¯æŒï¼šæ¯”å¦‚æ‰€æœ‰ä¾èµ–æ–‡ä»¶çš„ URL éƒ½é€šè¿‡å˜é‡çš„æ–¹å¼æ¥å®šä¹‰ï¼Œè€Œé kubekey é‚£æ ·ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼›æ‰€æœ‰é•œåƒçš„ repo å’Œ tag éƒ½æ˜¯é€šè¿‡å˜é‡çš„æ–¹å¼æ¥å®šä¹‰ã€‚è¿™æ ·çš„å¥½å¤„å°±æ˜¯åœ¨éƒ¨ç½²çš„æ—¶å€™å¯ä»¥æ ¹æ®å®¢æˆ·ç¯å¢ƒçš„çš„é•œåƒä»“åº“åœ°å€å’Œæ–‡ä»¶æœåŠ¡å™¨çš„ URL åœ°å€æ¥å¡«å†™ç›¸åº”çš„å‚æ•°ï¼Œæ— éœ€é€šè¿‡å…¬ç½‘æ¥è·å–ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Registry overrides</span></span><br><span class="line"><span class="attr">kube_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_host &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">gcr_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_host &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">docker_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_host &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">quay_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_host &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/kubeadm"</span></span><br><span class="line"><span class="attr">kubectl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/kubectl"</span></span><br><span class="line"><span class="attr">kubelet_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/kubelet"</span></span><br><span class="line"><span class="comment"># etcd is optional if you **DON'T** use etcd_deployment=host</span></span><br><span class="line"><span class="attr">etcd_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/etcd/etcd-<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>-linux-amd64.tar.gz"</span></span><br><span class="line"><span class="attr">cni_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/cni/cni-plugins-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>-<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>.tgz"</span></span><br><span class="line"><span class="attr">crictl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/cri-tools/crictl-<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="comment"># If using Calico</span></span><br><span class="line"><span class="attr">calicoctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; files_repo &#125;&#125;</span>/kubernetes/calico/<span class="template-variable">&#123;&#123; calico_ctl_version &#125;&#125;</span>/calicoctl-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><p>å’Œä¸Šè¿°å‡ ç§éƒ¨ç½²å·¥å…·å¯¹æ¯”ä¸éš¾å‘ç°ï¼Œkubespray çµæ´»æ€§å’Œå¯æ‰©å±•æ€§è¦é¢†å…ˆå…¶ä»–å·¥å…·ï¼ˆæ”¯æŒ 10 ç§ CNIã€10ç§ Linux  å‘è¡Œç‰ˆã€3 ç§ CRIã€ä»¥åŠå¤šç§æ’ä»¶å’Œæ‰©å±•ï¼‰å¹¶åœ¨å‚æ•°å±‚é¢ä¸Šåšåˆ°äº†ç¦»çº¿éƒ¨ç½²çš„æ”¯æŒã€‚å› æ­¤æˆ‘ä»¬é¦–å…ˆé€‰ç”¨ kubespray ä½œä¸ºé›†ç¾¤éƒ¨ç½²çš„åº•å±‚å·¥å…·ã€‚</p><p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ kubespray è™½ç„¶åœ¨å‚æ•°é…ç½®ä¸Šæ”¯æŒç¦»çº¿éƒ¨ç½²ï¼Œä½†æ˜¯ä»åˆ¶ä½œç¦»çº¿å®‰è£…åŒ…åˆ°ä¸€é”®éƒ¨ç½²ï¼Œç›®å‰ä¸ºæ­¢è¿˜æœªæœ‰ä¸€ä¸ªå®Œæ•´çš„å®ç°æ–¹æ¡ˆã€‚å› æ­¤éœ€è¦ä¸º kubespray è®¾è®¡ä¸€å¥—ä»ç¦»çº¿å®‰è£…åŒ…çš„æ„å»ºåˆ°é›†ç¾¤ä¸€é”®éƒ¨ç½²çš„æµç¨‹å’Œæ–¹æ¡ˆï¼Œä¸ºæ­¤æˆ‘ä»¬æ–°å»ºä¸€ä¸ªåä¸º <a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">kubeplay</a> çš„ repo æ¥å®Œæˆè¿™éƒ¨åˆ†å†…å®¹ã€‚</p><p>å¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ kubesphere æ—©æœŸçš„ç‰ˆæœ¬ v2.x ä½¿ç”¨ä¹Ÿæ˜¯ kubespray éƒ¨ç½²çš„ k8sï¼Œè‡³ä»Š ks-installer ä»£ç ä¸­ä»æ®‹ç•™ç€ <a href="https://github.com/kubesphere/ks-installer/commits/master/roles/download/tasks" target="_blank" rel="noopener">éƒ¨åˆ† kubespray çš„ä»£ç </a> ï¼Œåˆ°äº† 3.0 çš„æ—¶å€™å¼€å§‹ä½¿ç”¨è‡ªç ”çš„ kubekey æ¥éƒ¨ç½² K8s äº†ã€‚</p><blockquote><p>åŸºäº Ansible çš„å®‰è£…ç¨‹åºå…·æœ‰å¤§é‡è½¯ä»¶ä¾èµ–æ€§ï¼Œä¾‹å¦‚ Pythonã€‚KubeKey æ˜¯ä½¿ç”¨ Go è¯­è¨€å¼€å‘çš„ï¼Œå¯ä»¥æ¶ˆé™¤åœ¨å„ç§ç¯å¢ƒä¸­å‡ºç°çš„é—®é¢˜ï¼Œä»è€Œæé«˜å®‰è£…æˆåŠŸç‡ã€‚</p><p><a href="https://github.com/kubesphere/kubekey/blob/master/README_zh-CN.md" target="_blank" rel="noopener">README_zh-CN.md</a></p></blockquote><p>ä¸è¿‡ ansible çš„ä¾èµ–é—®é¢˜å½“æ—¶ä¸ºä»€ä¹ˆæ²¡æœ‰è€ƒè™‘é‡‡ç”¨å®¹å™¨åŒ–çš„æ–¹å¼è¿è¡Œ kubespray ğŸ¤”ï¼Œè‡³äº ansible çš„æ€§èƒ½é—®é¢˜ä¹Ÿä¸æ˜¯æ²¡æœ‰ä¼˜åŒ–çš„ä½™åœ°ã€‚</p><h2 id="kubeplay"><a href="#kubeplay" class="headerlink" title="kubeplay"></a><a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">kubeplay</a></h2><p>kubeplay è¿™ä¸ªé¡¹ç›®ä¸»è¦æ˜¯å®ç° K8s ç¦»çº¿å®‰è£…åŒ…çš„æ„å»ºå’Œä¸€é”®éƒ¨ç½²åŠŸèƒ½ï¼Œç›®å‰åªé€‚é…äº† kubesprayï¼Œç­‰åˆ°åé¢ä¼šé€‚é…ä¸€äº›å…¶ä»–éƒ¨ç½²å·¥å…·å¦‚ kubekeyã€‚</p><h3 id="æ‰“åŒ…æ–¹å¼"><a href="#æ‰“åŒ…æ–¹å¼" class="headerlink" title="æ‰“åŒ…æ–¹å¼"></a>æ‰“åŒ…æ–¹å¼</h3><p>ç”±äºéƒ¨ç½²ä¾èµ–çš„äºŒè¿›åˆ¶æ–‡ä»¶å’Œç»„ä»¶é•œåƒå¤§éƒ½å­˜æ”¾åœ¨ GitHub ã€Docker Hubã€gcr.ioï¼ˆGoogle Container Registryï¼‰ã€quay.io è¿™äº›å›½å¤–çš„å¹³å°ä¸Šï¼Œåœ¨å›½å†…ç¯å¢ƒè·å–è¿™äº›èµ„æºæ˜¯æœ‰ä¸€å®šçš„ç½‘ç»œé™åˆ¶ã€‚è€Œ GitHub æ‰˜ç®¡çš„ runner è¿è¡Œåœ¨å›½å¤–çš„æœºæˆ¿å½“ä¸­ï¼Œå¯ä»¥å¾ˆé¡ºç•…åœ°è·å–è¿™äº›èµ„æºã€‚å› æ­¤æˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ GitHub Actions æ¥è¿›è¡Œç¦»çº¿å®‰è£…åŒ…çš„æ„å»ºã€‚</p><p>åƒ selos é‚£æ ·å°†å®‰è£…åŒ…å­˜æ”¾åœ¨é˜¿é‡Œäº‘ OSS ä¸Šï¼Œåœ¨å›½å†…èƒ½ååˆ†é¡ºç•…åœ°é«˜é€Ÿä¸‹è½½ï¼Œæ”¶è´¹ä¹Ÿæ˜¯ç†æ‰€å½“ç„¶ã€‚ä½†æˆ‘ä»¬çš„æ–¹æ¡ˆæ˜¯ 100% å¼€æº 100% å…è´¹ï¼Œæ¯ä¸ªäººéƒ½å¯ä»¥ fork ä»£ç åˆ°è‡ªå·±çš„ repoï¼Œæ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œæ„å»ºã€‚å› æ­¤é€‰æ‹© GitHub æ¥æ„å»ºå’Œå­˜æ”¾æˆ‘ä»¬çš„å®‰è£…åŒ…æ˜¯æœ€åˆé€‚çš„é€‰æ‹©ï¼Œè¿™æ ·ä¹Ÿä¸ç”¨å»é¢å¤–è€ƒè™‘å®‰è£…åŒ…ä¸‹è½½çš„é—®é¢˜ã€‚è‡³äºä» GitHub ä¸Šä¸‹è½½å®‰è£…åŒ…æ…¢çš„é—®é¢˜ï¼Œé‚£åº”è¯¥ç”±ä½¿ç”¨è€…è‡ªè¡Œå»è§£å†³ï¼Œè€Œéæœ¬æ–¹æ¡ˆæ‰€å…³å¿ƒçš„é—®é¢˜ã€‚</p><blockquote><p>Qï¼šå¦‚ä½•æ‘†è„±ç½‘ç»œçš„ä¾èµ–æ¥åˆ›å»ºä¸ª Docker çš„ image å‘¢ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªæ˜¯ Docker ç”¨æˆ·è‡ªå·±çš„åŸºæœ¬æƒåˆ©ï¼Ÿ</p><p>Aï¼šè¿™ä¸ªåŸºæœ¬æƒåˆ©æˆ‘è§‰å¾—è¿˜æ˜¯è¦é—® GFW ï¼Œå›½å¤–çš„å¼€å‘äººå‘˜æ˜¯éå¸¸éš¾ç†è§£æœ‰äº›ä»–ä»¬è®¤ä¸ºè·Ÿæ°´ç”µä¸€æ ·æ™®åŠçš„åŸºç¡€è®¾æ–½åœ¨æŸäº›åœ°æ–¹è¿˜æ˜¯å¾ˆå›°éš¾çš„ã€‚</p><p>æ­¤å¤„å¼•ç”¨ <a href="http://dockone.io/article/722" target="_blank" rel="noopener">DockOneæŠ€æœ¯åˆ†äº«ï¼ˆäºŒåå››ï¼‰ï¼šå®¹å™¨å’ŒIaaSï¼šè°åŠ¨äº†è°çš„å¥¶é…ª</a></p></blockquote><p>é€‰æ‹©å¥½çš„æ„å»ºåœºæ‰€ä¸º GitHub Actions ä¹‹åæˆ‘ä»¬å†å°†è¿™äº›ç¦»çº¿èµ„æºè¿›è¡Œæ‹†åˆ†ï¼Œç›®çš„æ˜¯ä¸ºäº†å®ç°å„ä¸ªç¦»çº¿èµ„æºä¹‹é—´çš„è§£è€¦ï¼Œè¿™æ ·åšçµæ´»æ€§æ›´å¥½ä¸€äº›ï¼Œæ¯”å¦‚èƒ½å¤Ÿé€‚é…å¤šç§ OSã€æ”¯æŒå¤šä¸ª k8s ç‰ˆæœ¬ç­‰ã€‚ä¸»è¦æ‹†åˆ†æˆå¦‚ä¸‹å‡ ä¸ªæ¨¡å—ã€‚</p><table><thead><tr><th>æ¨¡å—</th><th>Repo</th><th>ç”¨é€”</th><th>è¿è¡Œ/ä½¿ç”¨æ–¹å¼</th></tr></thead><tbody><tr><td>compose</td><td><a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">kubeplay</a></td><td>ç”¨äºéƒ¨ç½² nginx å’Œ registry æœåŠ¡</td><td>nerdctl compose</td></tr><tr><td>os-tools</td><td><a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">kubeplay</a></td><td>éƒ¨ç½² compose æ—¶çš„ä¸€äº›ä¾èµ–å·¥å…·</td><td>äºŒè¿›åˆ¶å®‰è£…</td></tr><tr><td>os-packages</td><td><a href="https://github.com/k8sli/os-packages" target="_blank" rel="noopener">os-packages</a></td><td>æä¾› rpm/deb ç¦»çº¿æº</td><td>nginx æä¾› http æ–¹å¼ä¸‹è½½</td></tr><tr><td>kubespray</td><td><a href="https://github.com/k8sli/kubespray" target="_blank" rel="noopener">kubespray</a></td><td>ç”¨äºéƒ¨ç½²/æ‰©ç¼©å®¹ k8s é›†ç¾¤</td><td>å®¹å™¨æˆ–è€… pod</td></tr><tr><td>kubespray-files</td><td><a href="https://github.com/k8sli/kubespray" target="_blank" rel="noopener">kubespray</a></td><td>æä¾›äºŒè¿›åˆ¶æ–‡ä»¶ä¾èµ–</td><td>nginx æä¾› http æ–¹å¼ä¸‹è½½</td></tr><tr><td>kubespray-images</td><td><a href="https://github.com/k8sli/kubespray" target="_blank" rel="noopener">kubespray</a></td><td>æä¾›ç»„ä»¶é•œåƒ</td><td>registry æä¾›é•œåƒä¸‹è½½</td></tr></tbody></table><p>æ‹†åˆ†å®Œæˆä¹‹åï¼Œæˆ‘ä»¬æœ€ç»ˆè¿˜æ˜¯éœ€è¦å°†å®ƒä»¬ç»„åˆæˆä¸€ä¸ªå®Œæˆçš„ç¦»çº¿å®‰è£…åŒ…ã€‚ä¸ºäº†å‡å°‘ç»´æŠ¤æˆæœ¬ï¼Œæˆ‘ä»¬å°†æ¯ä¸ªæ¨¡å—çš„æ„å»ºæ“ä½œéƒ½æ”¾åœ¨ Dockerfile ä¸­ï¼Œå³ <code>All in Dockerfile</code> ğŸ¤£ã€‚è¿™æ ·æ¯ä¸ªæ¨¡å—çš„ GitHub Actions æµæ°´çº¿æœ€ç»ˆäº¤ä»˜çš„éƒ½æ˜¯ä¸€ä¸ªé•œåƒï¼Œç„¶åé•œåƒéƒ½æ¨é€åˆ°  <code>ghcr.io</code> ä¸Šï¼Œè¿™æ ·å°±è§£å†³äº†æ¨¡å—é—´äº§ç‰©ä¼ é€’ä»¥åŠé•œåƒç¼“å­˜çš„é—®é¢˜ã€‚æœ€ç»ˆé€šè¿‡ä¸€ä¸ªæœ€ç»ˆçš„ <a href="https://github.com/k8sli/kubeplay/blob/main/Dockerfile" target="_blank" rel="noopener">Dockerfile</a> å°†è¿™äº›æ¨¡å—çš„é•œåƒå…¨éƒ¨ COPY åˆ°ä¸€ä¸ªé•œåƒå½“ä¸­ï¼Œåªè¦æ‰“åŒ…è¿™ä¸ªæœ€ç»ˆçš„é•œåƒä¸ºç¦»çº¿å®‰è£…åŒ…å³å¯ï¼›å¦ä¸€ä¸ªå¥½å¤„å°±ä½¿ç”¨ buildx æ„å»ºè¿™äº›ç¦»çº¿èµ„æºå°±åŸç”Ÿæ”¯æŒå¤š CPU ä½“ç³»æ¶æ„ï¼Œèƒ½å¤ŸåŒæ—¶é€‚é… amd64 å’Œ arm64 ä½“ç³»æ¶æ„ï¼Œè¿™æ · arm64 ä¹Ÿèƒ½æ„‰å¿«åœ°ç©è€äº†ï¼ŒçœŸæ˜¯ä¸€ä¸¾ä¸¤å¾—ã€‚</p><p>ä¸‹é¢å°±è¯¦ç»†è®²è§£æ¯ä¸ªæ¨¡å—çš„åŠŸèƒ½ä»¥åŠæ˜¯å¦‚ä½•æ‰“åŒ…çš„ï¼š</p><h3 id="compose"><a href="#compose" class="headerlink" title="compose"></a>compose</h3><p>compose æ¨¡å—é‡Œé¢ä¸»è¦è¿ä¸¤ä¸ªæœåŠ¡ï¼š ç”¨äºæä¾›æ–‡ä»¶ä¸‹è½½çš„ nginx å’Œç»„ä»¶é•œåƒæ‹‰å–çš„ registryã€‚è¿™ä¸¤ä¸ªæˆ‘ä»¬ä¾æ—§æ˜¯å®¹å™¨åŒ–ä»¥ç±»ä¼¼ docker-compose çš„æ–¹å¼æ¥éƒ¨ç½²ï¼Œè€Œæ‰€ä¾èµ–çš„ä¹Ÿåªæœ‰ä¸¤ä¸ªé•œåƒå’Œä¸€äº›é…ç½®æ–‡ä»¶è€Œå·²ã€‚</p><ul><li><a href="https://github.com/k8sli/kubeplay/blob/main/compose.yaml" target="_blank" rel="noopener">kubeplay/blob/main/compose.yaml</a></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.1'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.20-alpine</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./resources/nginx:/usr/share/nginx</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config/compose/certs/domain.crt:/etc/nginx/conf.d/domain.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config/compose/certs/domain.key:/etc/nginx/conf.d/domain.key</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config/compose/nginx.conf:/etc/nginx/conf.d/default.conf</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="comment"># 443 ç«¯å£åå‘ä»£ç† registr çš„ 5000 ç«¯å£ï¼Œä»…ç”¨äº pull é•œåƒ</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">443</span><span class="string">:443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2.7.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./resources/registry:/var/lib/registry</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="comment"># åªå…è®¸æœ¬åœ° 5000 ç«¯å£ push é•œåƒ</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5000:5000</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªé•œåƒæˆ‘ä»¬ä½¿ç”¨ skopeo copy çš„æ–¹å¼ä¿å­˜ä¸º tar åŒ…ï¼Œéƒ¨ç½²çš„æ—¶å€™ load åˆ°å®¹å™¨è¿è¡Œæ—¶çš„å­˜å‚¨ä¸­ã€‚</p><blockquote><p>Qï¼šä¸ºä»€ä¹ˆè¦ç”¨ skopeo è€Œä¸æ˜¯ dockerï¼Ÿ</p><p>Aï¼šå› ä¸º Dockerfile æ„å»ºè¿‡ç¨‹ä¸­ä¸æ”¯æŒè¿è¡Œ docker å‘½ä»¤ save é•œåƒ</p></blockquote><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:latest as downloader</span><br><span class="line"><span class="keyword">ARG</span> SKOPEO_VERSION=v1.<span class="number">4.0</span></span><br><span class="line"><span class="keyword">ARG</span> NGINX_VERSION=<span class="number">1.20</span>-alpine</span><br><span class="line"><span class="keyword">ARG</span> RERGISRRY_VERSION=<span class="number">2.7</span>.<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /tools</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add wget ca-certificates \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -k https://github.com/k8sli/skopeo/releases/download/v1.4.0/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> -O /tools/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /tools/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ln -s /tools/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> /usr/bin/skopeo</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /images</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=<span class="literal">false</span> --override-arch <span class="variable">$&#123;ARCH&#125;</span> --additional-tag nginx:<span class="variable">$&#123;NGINX_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">       docker://docker.io/library/nginx:<span class="variable">$&#123;NGINX_VERSION&#125;</span> docker-archive:nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span>.tar \</span></span><br><span class="line"><span class="bash">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=<span class="literal">false</span> --override-arch <span class="variable">$&#123;ARCH&#125;</span> --additional-tag registry:<span class="variable">$&#123;RERGISRRY_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">       docker://docker.io/library/registry:<span class="variable">$&#123;RERGISRRY_VERSION&#125;</span> docker-archive:registry-<span class="variable">$&#123;RERGISRRY_VERSION&#125;</span>.tar</span></span><br></pre></td></tr></table></figure><p>åœ¨éƒ¨ç½²çš„æ—¶å€™æˆ‘ä»¬ä½¿ç”¨ nerdctl compose çš„æ–¹å¼å¯åŠ¨å³å¯ï¼Œä½¿ç”¨æ–¹å¼æœ‰ç‚¹ç±»ä¼¼äº docker-composeã€‚</p><blockquote><p>Q: ä¸ºä»€ä¹ˆä¸ç”¨ docker å’Œ docker-compose</p><p>Aï¼šK8s å» docker æ˜¯å¤§åŠ¿æ‰€è¶‹ï¼Œé€‰æ‹© containerd æ›´ç¬¦åˆä¸»æµå‘å±•æ–¹å‘</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†é•œåƒ load è¿› containerd å­˜å‚¨</span></span><br><span class="line">$ find <span class="variable">$&#123;IMAGES_DIR&#125;</span> -<span class="built_in">type</span> f -name <span class="string">'*.tar'</span> | xargs -L1 nerdctl load -i</span><br><span class="line"><span class="comment"># nerdctl compose å¯åŠ¨ nginx å’Œ registry</span></span><br><span class="line">$ nerdctl compose -f compose.yaml up</span><br></pre></td></tr></table></figure><h3 id="os-packages"><a href="#os-packages" class="headerlink" title="os-packages"></a>os-packages</h3><p>è¿™éƒ¨åˆ†æ˜¯ rpm/deb ç¦»çº¿æºçš„æ„å»ºï¼Œå…¶è¯¦ç»†çš„è¿‡ç¨‹å’ŒåŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„åšå®¢ ã€Š<a href="https://blog.k8s.li/make-offline-mirrors.html">ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</a>ã€‹ï¼Œä¸‹é¢åªåˆ—ä¸¾ä¸€ä¸‹ CentOS7 ç¦»çº¿æºçš„æ„å»ºé…ç½®ï¼š</p><ul><li><a href="https://github.com/k8sli/os-packages/blob/main/build/Dockerfile.os.centos7" target="_blank" rel="noopener">Dockerfile</a></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7.9</span>.<span class="number">2009</span> as os-centos7</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=<span class="number">7</span></span><br><span class="line"><span class="keyword">ARG</span> DOCKER_MIRROR_URL=<span class="string">"https://download.docker.com"</span></span><br><span class="line"><span class="keyword">ARG</span> BUILD_TOOLS=<span class="string">"yum-utils createrepo epel-release wget"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…æ„å»ºå·¥å…·ï¼Œé…ç½® docker å®˜æ–¹ yum æº</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -q -y <span class="variable">$&#123;BUILD_TOOLS&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; yum-config-manager --add-repo <span class="variable">$&#123;DOCKER_MIRROR_URL&#125;</span>/linux/centos/docker-ce.repo \</span></span><br><span class="line"><span class="bash">    &amp;&amp; yum makecache</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /centos/<span class="variable">$OS_VERSION</span>/os</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml .</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=mikefarah/yq:4.11.1 /usr/bin/yq /usr/bin/yq</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ®é…ç½®æ–‡ä»¶è§£æè¯¥ OS éœ€è¦æ„å»ºçš„åŒ…ï¼Œå¹¶è·å–è¿™äº›åŒ…çš„ä¸‹è½½ url</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> <span class="string">'.common[],.yum[],.centos7[],.kubespray.common[],.kubespray.yum[]'</span> packages.yaml &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sort -u packages.list | xargs repotrack --urls | sort -u &gt; packages.urls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡ wget çš„æ–¹å¼ä¸‹è½½ rpm åŒ…ï¼Œä½¿ç”¨ createrepo åˆ›å»º repo ç´¢å¼•æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -x -P <span class="variable">$&#123;ARCH&#125;</span> -i packages.urls \</span></span><br><span class="line"><span class="bash">    &amp;&amp; createrepo -d <span class="variable">$&#123;ARCH&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æ„å»ºçš„å†…å®¹ COPY æˆå•ç‹¬çš„ä¸€å±‚</span></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=os-centos7 /centos /centos</span></span><br></pre></td></tr></table></figure><ul><li><a href="https://github.com/k8sli/os-packages/blob/main/packages.yaml" target="_blank" rel="noopener">packages.yaml</a> é…ç½®æ–‡ä»¶</li></ul><p>è¿™ä¸ªæ˜¯éœ€è¦å®‰è£…åŒ…çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥æ ¹æ®å¹³å°æˆ–è€…å®¢æˆ·çš„ä¸€äº›è¦æ±‚é…ç½®ä¸Šä¸åŒçš„åŒ…</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kubespray:</span></span><br><span class="line">  <span class="attr">common:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">curl</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">rsync</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">socat</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">unzip</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">e2fsprogs</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">xfsprogs</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ebtables</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">bash-completion</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ipvsadm</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ipset</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">conntrack</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nss</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">libselinux-python</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">device-mapper-libs</span></span><br><span class="line">  <span class="attr">apt:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">python-apt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">python3-apt</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">aufs-tools</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">apt-transport-https</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">software-properties-common</span></span><br><span class="line"></span><br><span class="line"><span class="attr">common:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cifs-utils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lsof</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lvm2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">openssl</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">sshpass</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">vim</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">wget</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ethtool</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">net-tools</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rsync</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">chrony</span></span><br><span class="line"></span><br><span class="line"><span class="attr">yum:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfs-utils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">yum-utils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">createrepo</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">epel-release</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nc</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">httpd-tools</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apt:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfs-common</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apt-transport-https</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ca-certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">gnupg</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lsb-release</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">aptitude</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">dpkg-dev</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">gnupg2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">netcat</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apache2-utils</span></span><br><span class="line"></span><br><span class="line"><span class="attr">centos7:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">containerd.io-1.4.6</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ubuntu:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">containerd.io=1.4.6-1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">debian10:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">containerd.io=1.4.6-1</span></span><br></pre></td></tr></table></figure><blockquote><p>å¯¹äº toB äº§å“ï¼Œå»ºè®®å°†ä¸‹é¢è¿™äº›å¸¸è§çš„è¿ç»´è°ƒè¯•å·¥å…·ï¼ˆå¦‚ tcpdump, strace, lsof, net-tools ç­‰ï¼‰ä¹Ÿæ„å»ºåœ¨ç¦»çº¿æºä¸­ã€‚è¿™æ ·ä¹Ÿä¸è‡³äºåœ¨å®¢æˆ·çš„ç¯å¢ƒä¸­æ’æŸ¥é—®é¢˜çš„æ—¶å€™æœºå™¨ä¸Šè¿ä¸ª tcpdump éƒ½æ²¡æœ‰ï¼Œå°¤å…¶æ˜¯åœ¨æ— ç½‘çš„ç¯å¢ƒä¸­ï¼Œå¦‚æœæ²¡æœ‰è¿™äº›å¸¸ç”¨çš„è¿ç»´å·¥å…·ï¼Œæ’æŸ¥é—®é¢˜å°†ä¼šååˆ†æ£˜æ‰‹ã€‚</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tools:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">bash-completion</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">chrony</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cifs-utils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">curl</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">dstat</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">e2fsprogs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ebtables</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">expect</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">gdb</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">htop</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">iftop</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">iotop</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ipset</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ipvsadm</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">jq</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lsof</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lvm2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ncdu</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">net-tools</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nethogs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nload</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ntpdate</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">openssl</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pciutils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">psmisc</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rsync</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">smartmontools</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">socat</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">sshpass</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">strace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">sysstat</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tcpdump</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">telnet</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tmux</span></span><br></pre></td></tr></table></figure><h3 id="kubespray-2"><a href="#kubespray-2" class="headerlink" title="kubespray"></a>kubespray</h3><p>kubespray æ˜¯éƒ¨ç½² K8s é›†ç¾¤ã€å¢åŠ èŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹ã€ç§»é™¤é›†ç¾¤ç­‰æ¶‰åŠå¯¹é›†ç¾¤æ“ä½œçš„ä¸»è¦å·¥å…·ã€‚æˆ‘ä»¬ä¾æ—§é‡‡ç”¨å®¹å™¨åŒ–çš„æ–¹å¼è¿è¡Œ kubesprayï¼Œä¸»è¦æœ‰ä»¥ä¸‹åœºæ™¯ä¼šç”¨åˆ° kubesprayï¼š</p><ul><li>åœ¨éƒ¨ç½²å·¥å…·è¿è¡ŒèŠ‚ç‚¹ï¼Œä½¿ç”¨ nerdctl æ¥è¿è¡Œ kubespray å®¹å™¨éƒ¨ç½²  K8s é›†ç¾¤</li><li>K8s é›†ç¾¤éƒ¨ç½²å®Œæ¯•åï¼Œä»¥ Job pod çš„æ–¹å¼è¿è¡Œéƒ¨ç½²å¦ä¸€ä¸ª K8s é›†ç¾¤ï¼Œå®ç°å¤šé›†ç¾¤éƒ¨ç½²çš„åŸºæœ¬èƒ½åŠ›</li><li>K8s é›†ç¾¤éƒ¨ç½²å®Œæ¯•åï¼Œä»¥ Job pod çš„æ–¹å¼è¿è¡Œ kubespray å¯¹è¯¥é›†ç¾¤é›†ç¾¤èŠ‚ç‚¹è¿›è¡Œæ‰©ç¼©å®¹</li></ul><p>Job pod æ–¹å¼å¯¹é›†ç¾¤è¿›è¡Œæ‰©ç¼©å®¹çš„è®¾è®¡çš„æ˜¯ä¸ºäº†ä»ä¸€å®šç¨‹åº¦ä¸Šè§£å†³éƒ¨ç½²å¤§è§„æ¨¡é›†ç¾¤æ—¶ ansible æ€§èƒ½é—®é¢˜ã€‚å³æˆ‘ä»¬ä¸€å¼€å§‹ä¸å¿…å°±éƒ¨ç½²ä¸€ä¸ªä¸ŠåƒèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œè€Œæ˜¯å…ˆæŠŠä¸€ä¸ªè§„æ¨¡è¾ƒå°çš„é›†ç¾¤éƒ¨ç½²èµ·æ¥ï¼Œç„¶åé€šè¿‡åˆ›å»ºæ‰¹é‡çš„ Job çš„æ–¹å¼è¿è¡Œ kubespray å†å°†é›†ç¾¤æ…¢æ…¢æ‰©å®¹èµ·æ¥ï¼Œæ¯”å¦‚æ‰©å®¹åˆ°ä¸Šåƒå°èŠ‚ç‚¹ã€‚</p><p>kubespray å®˜æ–¹çš„ Dockerfile æ„å»ºå‡ºæ¥çš„é•œåƒæœ‰ 1.4GBï¼Œå®åœ¨æ˜¯å¤ªå¤§äº†ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¼˜åŒ–ä¸€ä¸‹ï¼Œå‡å°‘é•œåƒå¤§å°</p><ul><li>kubespray BASE é•œåƒ</li></ul><p>é¦–å…ˆæ„å»ºä¸€ä¸ª base é•œåƒï¼Œå¯¹äºä¸ç»å¸¸å˜åŠ¨çš„å†…å®¹æˆ‘ä»¬æŠŠå®ƒå°è£…åœ¨ä¸€ä¸ª base é•œåƒé‡Œï¼Œåªæœ‰å½“ç›¸å…³ä¾èµ–æ›´æ–°äº†æ‰éœ€è¦é‡æ–°æ„å»ºè¿™ä¸ª base é•œåƒï¼Œ<code>Dockerfile.base</code> å¦‚ä¸‹ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3</span> as builder</span><br><span class="line"><span class="keyword">ARG</span> KUBE_VERSION=v1.<span class="number">21.3</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> requirements.txt requirements.txt</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> tests/requirements.txt tests/requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> <span class="string">'shellcheck-py==0.7.2.1'</span> &gt;&gt; requirements.txt \</span></span><br><span class="line"><span class="bash">    &amp;&amp; grep -E <span class="string">'^yamllint|^ansible-lint'</span> tests/requirements.txt &gt;&gt; requirements.txt \</span></span><br><span class="line"><span class="bash">    &amp;&amp; pip3 install --user -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -O /root/.<span class="built_in">local</span>/bin/kubectl -q https://dl.k8s.io/<span class="variable">$&#123;KUBE_VERSION&#125;</span>/bin/linux/<span class="variable">$&#123;ARCH&#125;</span>/kubectl \</span></span><br><span class="line"><span class="bash">&amp;&amp; chmod a+x /root/.<span class="built_in">local</span>/bin/kubectl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> python:<span class="number">3</span>-slim</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> DEBIAN_FRONTEND=noninteractive apt-get update -y -qq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install -y -qq --no-install-recommends \</span></span><br><span class="line"><span class="bash">        ca-certificates libssl-dev openssh-client sshpass curl gnupg2 rsync \</span></span><br><span class="line"><span class="bash">        jq moreutils vim iputils-ping wget tcpdump xz-utils \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /root/.<span class="built_in">local</span> /usr/<span class="built_in">local</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /kubespray</span></span><br></pre></td></tr></table></figure><ul><li><a href="">kubespray é•œåƒ</a></li></ul><p>FROM çš„ base é•œåƒå°±ä½¿ç”¨æˆ‘ä»¬åˆšåˆšæ„å»ºå¥½çš„é•œåƒï¼Œç›¸å…³ä¾èµ–å·²ç»åœ¨ base é•œåƒä¸­å®‰è£…å¥½äº†ï¼Œè¿™é‡Œæ„å»ºçš„æ—¶å€™åªéœ€è¦æŠŠ repo æºç å¤åˆ¶åˆ° /kubespray ç›®å½•ä¸‹å³å¯ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ARG</span> BASE_IMAGE=ghcr.io/k8sli/kubespray-base</span><br><span class="line"><span class="keyword">ARG</span> BASE_IMAGE_VERSION=latest</span><br><span class="line"><span class="keyword">FROM</span> $BASE_IMAGE:$BASE_IMAGE_VERSION</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /kubespray</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br></pre></td></tr></table></figure><ul><li>kubespray é›†ç¾¤éƒ¨ç½²å…¥å£ <code>run.sh</code></li></ul><p>å°†é›†ç¾¤éƒ¨ç½²ã€å¢åŠ èŠ‚ç‚¹ã€åˆ é™¤èŠ‚ç‚¹ã€åˆ é™¤é›†ç¾¤ç­‰æ“ä½œå°è£…æˆä¸€ä¸ªå…¥å£çš„è„šæœ¬ï¼Œæä¾›å¤–éƒ¨å·¥å…·è°ƒç”¨è¯¥è„šæœ¬ï¼Œä¸ç„¶å¤–éƒ¨è°ƒç”¨çš„æ—¶å€™ç›´æ¥è¿è¡Œ <code>ansible-playbook</code> å‘½ä»¤å®åœ¨æ˜¯ä¸å¤ªæ–¹ä¾¿ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">TYPE=<span class="variable">$1</span></span><br><span class="line">NODES=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line">KUBE_ROOT=<span class="string">"<span class="variable">$(cd "$(dirname "$0")</span>"</span> &amp;&amp; <span class="built_in">pwd</span>)<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;TYPE:=deploy-cluster&#125;</span></span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;ANSIBLE_FORKS:=10&#125;</span></span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;BECOME_USER:=root&#125;</span></span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;ANSIBLE_LOG_FORMAT:=yaml&#125;</span></span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;INVENTORY:=$&#123;KUBE_ROOT&#125;</span>/config/inventory&#125;</span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;ENV_FILE:=$&#123;KUBE_ROOT&#125;</span>/config/env.yml&#125;</span></span><br><span class="line"><span class="string">: <span class="variable">$&#123;INSTALL_STEPS_FILE:=$&#123;KUBE_ROOT&#125;</span>/config/.install_steps&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export ANSIBLE_STDOUT_CALLBACK=<span class="variable">$&#123;ANSIBLE_LOG_FORMAT&#125;</span></span></span><br><span class="line"><span class="string">export ANSIBLE_ARGS="</span>-f <span class="variable">$&#123;ANSIBLE_FORKS&#125;</span> --become --become-user=<span class="variable">$&#123;BECOME_USER&#125;</span> -i <span class="variable">$&#123;INVENTORY&#125;</span> -e @<span class="variable">$&#123;ENV_FILE&#125;</span><span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># Set logging colors</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">NORMAL_COL=<span class="variable">$(tput sgr0)</span></span></span><br><span class="line"><span class="string">RED_COL=<span class="variable">$(tput setaf 1)</span></span></span><br><span class="line"><span class="string">WHITE_COL=<span class="variable">$(tput setaf 7)</span></span></span><br><span class="line"><span class="string">GREEN_COL=<span class="variable">$(tput setaf 76)</span></span></span><br><span class="line"><span class="string">YELLOW_COL=<span class="variable">$(tput setaf 202)</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">debuglog()&#123; printf "</span><span class="variable">$&#123;WHITE_COL&#125;</span>%s<span class="variable">$&#123;NORMAL_COL&#125;</span>\n<span class="string">" "</span><span class="variable">$@</span><span class="string">"; &#125;</span></span><br><span class="line"><span class="string">infolog()&#123; printf "</span><span class="variable">$&#123;GREEN_COL&#125;</span>âœ” %s<span class="variable">$&#123;NORMAL_COL&#125;</span>\n<span class="string">" "</span><span class="variable">$@</span><span class="string">"; &#125;</span></span><br><span class="line"><span class="string">warnlog()&#123; printf "</span><span class="variable">$&#123;YELLOW_COL&#125;</span>âœ %s<span class="variable">$&#123;NORMAL_COL&#125;</span>\n<span class="string">" "</span><span class="variable">$@</span><span class="string">"; &#125;</span></span><br><span class="line"><span class="string">errorlog()&#123; printf "</span><span class="variable">$&#123;RED_COL&#125;</span>âœ– %s<span class="variable">$&#123;NORMAL_COL&#125;</span>\n<span class="string">" "</span><span class="variable">$@</span><span class="string">"; &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">set -eo pipefail</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if [[ ! -f <span class="variable">$&#123;INVENTORY&#125;</span> ]]; then</span></span><br><span class="line"><span class="string">  errorlog "</span><span class="variable">$&#123;INVENTORY&#125;</span> file is missing, please check the inventory file is exists<span class="string">"</span></span><br><span class="line"><span class="string">  exit 1</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">deploy_cluster()&#123;</span></span><br><span class="line"><span class="string">:</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">main()&#123;</span></span><br><span class="line"><span class="string">  case <span class="variable">$TYPE</span> in</span></span><br><span class="line"><span class="string">    deploy-cluster)</span></span><br><span class="line"><span class="string">      infolog "</span><span class="comment">######  start deploy kubernetes cluster  ######"</span></span><br><span class="line">      deploy_cluster</span><br><span class="line">      infolog <span class="string">"######  kubernetes cluster successfully installed  ######"</span></span><br><span class="line">      ;;</span><br><span class="line">    remove-cluster)</span><br><span class="line">      infolog <span class="string">"######  start remove kubernetes cluster  ######"</span></span><br><span class="line">      <span class="keyword">if</span> ansible-playbook <span class="variable">$&#123;ANSIBLE_ARGS&#125;</span> <span class="variable">$&#123;KUBE_ROOT&#125;</span>/reset.yml &gt;/dev/stdout 2&gt;/dev/stderr; <span class="keyword">then</span></span><br><span class="line">        rm -f <span class="variable">$&#123;INSTALL_STEP_FILE&#125;</span></span><br><span class="line">        infolog <span class="string">"######  kubernetes cluster successfully removed ######"</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">      ;;</span><br><span class="line">    add-node)</span><br><span class="line">      check_nodename</span><br><span class="line">      infolog <span class="string">"######  start add worker to kubernetes cluster  ######"</span></span><br><span class="line">      ansible-playbook <span class="variable">$&#123;ANSIBLE_ARGS&#125;</span> --<span class="built_in">limit</span>=<span class="string">"<span class="variable">$&#123;NODES&#125;</span>"</span> <span class="variable">$&#123;KUBE_ROOT&#125;</span>/playbooks/10-scale-nodes.yml &gt;/dev/stdout 2&gt;/dev/stderr</span><br><span class="line">      ;;</span><br><span class="line">    remove-node)</span><br><span class="line">      check_nodename</span><br><span class="line">      infolog <span class="string">"######  start remove worker from kubernetes cluster  ######"</span></span><br><span class="line">      ansible-playbook <span class="variable">$&#123;ANSIBLE_ARGS&#125;</span> -e node=<span class="string">"<span class="variable">$&#123;NODES&#125;</span>"</span> -e reset_nodes=<span class="literal">true</span> <span class="variable">$&#123;KUBE_ROOT&#125;</span>/remove-node.yml &gt;/dev/stdout 2&gt;/dev/stderr</span><br><span class="line">      ;;</span><br><span class="line">    *)</span><br><span class="line">      errorlog <span class="string">"unknow [TYPE] parameter: <span class="variable">$&#123;TYPE&#125;</span>"</span></span><br><span class="line">      ;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure><ul><li>åˆ†å±‚éƒ¨ç½² <a href="https://github.com/k8sli/kubespray/tree/main/playbooks" target="_blank" rel="noopener">playbooks</a></li></ul><p>ä¸åŒäº kubespray å®˜æ–¹ä½¿ç”¨ä¸€ä¸ªå®Œæ•´çš„ <a href="https://github.com/kubernetes-sigs/kubespray/blob/master/cluster.yml" target="_blank" rel="noopener">cluster.yaml</a> æ¥å®Œæˆæ•´ä¸ª K8s é›†ç¾¤çš„éƒ¨ç½²ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå¼•å…¥äº†åˆ†å±‚éƒ¨ç½²çš„ç‰¹æ€§ã€‚å³å°†é›†ç¾¤éƒ¨ç½²åˆ†æˆè‹¥å¹²ä¸ªç›¸äº’ç‹¬ç«‹çš„ playbookï¼Œç„¶ååœ¨å„ä¸ª playbook é‡Œå¼•å…¥æˆ‘ä»¬å¢åŠ çš„ roles ä»¥åŠäºŒå¼€å†…å®¹ã€‚è¿™æ ·çš„å¥½å¤„å°±æ˜¯èƒ½å’Œ kubespray ä¸Šæ¸¸çš„ä»£ç ä¿æŒç›¸äº’ç‹¬ç«‹ï¼Œåœ¨ rebase æˆ–è€… cherry-pick ä¸Šæ¸¸æœ€æ–°çš„ä»£ç èƒ½å¤Ÿé¿å…å‡ºç°å†²çªçš„ç°è±¡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">playbooks</span><br><span class="line">â”œâ”€â”€ 00-default-ssh-config.yml    <span class="comment"># é…ç½® ssh è¿æ¥</span></span><br><span class="line">â”œâ”€â”€ 01-cluster-bootstrap-os.yml  <span class="comment"># åˆå§‹åŒ–é›†ç¾¤èŠ‚ç‚¹</span></span><br><span class="line">â”œâ”€â”€ 02-cluster-etcd.yml          <span class="comment"># éƒ¨ç½² etcd é›†ç¾¤</span></span><br><span class="line">â”œâ”€â”€ 03-cluster-kubernetes.yml    <span class="comment"># éƒ¨ç½² k8s master å’Œ node</span></span><br><span class="line">â”œâ”€â”€ 04-cluster-network.yml       <span class="comment"># éƒ¨ç½² CNI æ’ä»¶</span></span><br><span class="line">â”œâ”€â”€ 05-cluster-apps.yml          <span class="comment"># éƒ¨ç½²ä¸€äº› addon ç»„ä»¶å¦‚ coredns</span></span><br><span class="line">â””â”€â”€ 10-scale-nodes.yml           <span class="comment"># å¢åˆ èŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure><p>åˆ†å±‚éƒ¨ç½²çš„æ—¶å€™é€šè¿‡ä¸€ä¸ªæ–‡ä»¶æ¥è®°å½•å·²ç»éƒ¨ç½²æˆåŠŸçš„æ­¥éª¤ï¼Œè¿™æ ·å¦‚æœæœ¬æ¬¡å› ä¸ºä¸€äº›åŸå› å¯¼è‡´éƒ¨ç½²å¤±è´¥ï¼ˆå¦‚ç½‘ç»œä¸­æ–­ï¼‰ï¼Œé‚£ä¹ˆä¸‹æ¬¡é‡æ–°éƒ¨ç½²çš„æ—¶å€™ä¼šè·³è¿‡å·²ç»éƒ¨ç½²å¥½çš„æ­¥éª¤ï¼Œä»å¤±è´¥çš„åœ°æ–¹ç»§ç»­éƒ¨ç½²ï¼Œä»¥æå‡æ•´ä½“çš„éƒ¨ç½²æ•ˆç‡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">deploy_cluster</span></span>()&#123;</span><br><span class="line">  touch <span class="variable">$&#123;INSTALL_STEPS_FILE&#125;</span></span><br><span class="line">  STEPS=<span class="string">"00-default-ssh-config 01-cluster-bootstrap-os 02-cluster-etcd 03-cluster-kubernetes 04-cluster-network 05-cluster-apps"</span></span><br><span class="line">  <span class="keyword">for</span> step <span class="keyword">in</span> <span class="variable">$&#123;STEPS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> ! grep -q <span class="string">"<span class="variable">$&#123;step&#125;</span>"</span> <span class="variable">$&#123;INSTALL_STEPS_FILE&#125;</span>; <span class="keyword">then</span></span><br><span class="line">      infolog <span class="string">"start deploy <span class="variable">$&#123;step&#125;</span>"</span></span><br><span class="line">      <span class="keyword">if</span> ansible-playbook <span class="variable">$&#123;ANSIBLE_ARGS&#125;</span> <span class="variable">$&#123;KUBE_ROOT&#125;</span>/playbooks/<span class="variable">$&#123;step&#125;</span>.yml; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$&#123;step&#125;</span> &gt;&gt; <span class="variable">$&#123;INSTALL_STEPS_FILE&#125;</span></span><br><span class="line">        infolog <span class="string">"<span class="variable">$&#123;step&#125;</span> successfully installed"</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        errorlog <span class="string">"<span class="variable">$&#123;step&#125;</span> installation failed"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      warnlog <span class="string">"<span class="variable">$&#123;step&#125;</span> is already installed, so skipped..."</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶å’Œé•œåƒ"><a href="#æ–‡ä»¶å’Œé•œåƒ" class="headerlink" title="æ–‡ä»¶å’Œé•œåƒ"></a>æ–‡ä»¶å’Œé•œåƒ</h3><p>æˆ‘ä»¬éœ€è¦æå–å‡º kubespray éƒ¨ç½²çš„æ—¶å€™ä¾èµ–çš„æ–‡ä»¶å’Œé•œåƒï¼Œç”Ÿæˆä¸€ä¸ªæ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ï¼Œç„¶åæ ¹æ®è¿™äº›åˆ—è¡¨ä¸‹è½½å¹¶æ„å»ºåˆ°ä¸€ä¸ªé•œåƒé‡Œã€‚</p><ul><li>æ–‡ä»¶</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download URLs</span></span><br><span class="line"><span class="attr">kubelet_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubelet"</span></span><br><span class="line"><span class="attr">kubectl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubectl"</span></span><br><span class="line"><span class="attr">kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubeadm"</span></span><br><span class="line"><span class="attr">etcd_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/coreos/etcd/releases/download/<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>/etcd-<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">cni_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containernetworking/plugins/releases/download/<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>/cni-plugins-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>-<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>.tgz"</span></span><br><span class="line"><span class="attr">calicoctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calicoctl/releases/download/<span class="template-variable">&#123;&#123; calico_ctl_version &#125;&#125;</span>/calicoctl-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_crds_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calico/archive/<span class="template-variable">&#123;&#123; calico_version &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crictl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kubernetes-sigs/cri-tools/releases/download/<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>/crictl-<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">helm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/get.helm.sh/helm-<span class="template-variable">&#123;&#123; helm_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">nerdctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containerd/nerdctl/releases/download/v<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>/nerdctl-<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">patched_kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/k8sli/kubernetes/releases/download/<span class="template-variable">&#123;&#123; kubeadm_patch_version &#125;&#125;</span>/kubeadm-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><p>åœ¨æ„å»ºå®‰è£…åŒ…çš„æ—¶å€™ï¼Œå°† download_url å˜é‡è®¾ç½®ä¸º <code>https://</code> ï¼Œåœ¨éƒ¨ç½²çš„æ—¶å€™å°† <code>download_url</code> è®¾ç½®ä¸ºå†…ç½‘ æ–‡ä»¶æœåŠ¡å™¨æœåŠ¡å™¨çš„ URLï¼Œæ¯”å¦‚ <code>https://172.20.0.25:8080/files</code>ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°æ–‡ä»¶æ„å»ºå’Œéƒ¨ç½²ä½¿ç”¨çš„ç»Ÿä¸€ï¼ŒèŠ‚çœç»´æŠ¤æˆæœ¬ã€‚</p><ul><li>é•œåƒ</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Define image repo and tag overwrite role/download/default/main.yml</span></span><br><span class="line"><span class="attr">pod_infra_image_tag:</span> <span class="string">"<span class="template-variable">&#123;&#123; pod_infra_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">pod_infra_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span>/pause"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kube_proxy_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span>/kube-proxy"</span></span><br><span class="line"><span class="attr">kube_apiserver_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span>/kube-apiserver"</span></span><br><span class="line"><span class="attr">kube_scheduler_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span>/kube-scheduler"</span></span><br><span class="line"><span class="attr">kube_controller_manager_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span>/kube-controller-manager"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">coredns_image_tag:</span> <span class="string">"<span class="template-variable">&#123;&#123; coredns_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">dnsautoscaler_image_tag:</span> <span class="string">"<span class="template-variable">&#123;&#123; dnsautoscaler_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">coredns_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_image_repo &#125;&#125;</span>/coredns"</span></span><br><span class="line"><span class="attr">dnsautoscaler_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span>/cluster-proportional-autoscaler-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Full image name for generate images list</span></span><br><span class="line"><span class="attr">kube_proxy_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_proxy_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kube_apiserver_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_apiserver_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kube_scheduler_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_scheduler_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kube_controller_manager_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_controller_manager_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">coredns_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; coredns_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; coredns_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">dnsautoscaler_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; dnsautoscaler_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; dnsautoscaler_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">nginx_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; nginx_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; nginx_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">pod_infra_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; pod_infra_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; pod_infra_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_policy_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; calico_policy_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; calico_policy_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_cni_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; calico_cni_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; calico_cni_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_node_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; calico_node_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; calico_node_image_tag &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">flannel_image_name:</span> <span class="string">"<span class="template-variable">&#123;&#123; flannel_image_repo &#125;&#125;</span>:<span class="template-variable">&#123;&#123; flannel_image_tag &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><ul><li><code>generate.sh</code> åˆ—è¡¨ç”Ÿæˆè„šæœ¬</li></ul><p>æˆ‘ä»¬æ ¹æ®ä¸Šé¢ group_vars ä¸­å®šä¹‰çš„ç‰ˆæœ¬å·å’Œä¸€äº›å‚æ•°ï¼Œä½¿ç”¨è„šæœ¬çš„æ–¹å¼è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ï¼Œæ„å»ºçš„æ—¶å€™æ ¹æ®è¿™äº›åˆ—è¡¨æ¥ä¸‹è½½æ‰€éœ€è¦çš„æ–‡ä»¶å’Œé•œåƒã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line"></span><br><span class="line">SCRIPT_PATH=$(<span class="built_in">cd</span> $(dirname <span class="variable">$0</span>); <span class="built_in">pwd</span>)</span><br><span class="line">REPO_PATH=<span class="string">"<span class="variable">$&#123;SCRIPT_PATH%/build&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">: <span class="variable">$&#123;IMAGE_ARCH:="amd64"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;ANSIBLE_ARCHITECTURE:="x86_64"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;DOWNLOAD_YML:="config/group_vars/all/download.yml"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ARCH used in convert &#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125; to &#123;&#123;arch&#125;&#125;</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$&#123;IMAGE_ARCH&#125;</span>"</span> != <span class="string">"amd64"</span> ]]; <span class="keyword">then</span> ARCH=<span class="string">"-<span class="variable">$&#123;IMAGE_ARCH&#125;</span>"</span>; <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">cat &gt; /tmp/generate.sh &lt;&lt; EOF</span><br><span class="line">arch=<span class="variable">$&#123;ARCH&#125;</span></span><br><span class="line">download_url=https:/</span><br><span class="line">image_arch=<span class="variable">$&#123;IMAGE_ARCH&#125;</span></span><br><span class="line">ansible_system=linux</span><br><span class="line">ansible_architecture=<span class="variable">$&#123;ANSIBLE_ARCHITECTURE&#125;</span></span><br><span class="line">registry_project=library</span><br><span class="line">registry_domain=localhost</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate all component version by $DOWNLOAD_YML</span></span><br><span class="line">grep <span class="string">'_version:'</span> <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">| sed <span class="string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> | tr -d <span class="string">' '</span> &gt;&gt; /tmp/generate.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate download files url list</span></span><br><span class="line">grep <span class="string">'_download_url:'</span> <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">| sed <span class="string">'s/: /=/g;s/ //g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g;s/|lower//g;s/^.*_url=/echo /g'</span> &gt;&gt; /tmp/generate.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate download images list</span></span><br><span class="line">grep -E <span class="string">'_image_tag:|_image_repo:|_image_name:'</span> <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">| sed <span class="string">"s#&#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125;#&#123;&#123;arch&#125;&#125;#g"</span> \</span><br><span class="line">| sed <span class="string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> | tr -d <span class="string">' '</span> &gt;&gt; /tmp/generate.sh</span><br><span class="line"></span><br><span class="line">grep <span class="string">'_image_name:'</span> <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">| cut -d <span class="string">':'</span> -f1 | sed <span class="string">'s/^/echo $/g'</span> &gt;&gt; /tmp/generate.sh</span><br></pre></td></tr></table></figure><p>ä¸ºäº†åŒæ—¶æ”¯æŒ amd64 å’Œ arm64 çš„ CPU æ¶æ„ï¼Œéœ€è¦ä¸ºä¸¤ç§æ¶æ„å„è‡ªç”Ÿæˆåˆ—è¡¨ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹ã€‚åœ¨è¿™é‡Œè¸©çš„ä¸€ä¸ªå‘å°±æ˜¯ä¸åŒçš„ç»„ä»¶é•œåƒçš„å‘½åæ–¹æ³•åƒå·®ä¸‡åˆ«ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å››ç§æƒ…å†µï¼š</p><ul><li>åƒ kube-apiserver è¿™äº› k8s ç»„ä»¶çš„é•œåƒï¼Œé•œåƒåç§°å’Œé•œåƒ tag æ˜¯ä¸éœ€è¦åŠ ä¸Š CPU ä½“ç³»æ¶æ„çš„ï¼›</li><li>cluster-proportional-autoscaler çš„é•œåƒåˆ™æ˜¯åœ¨é•œåƒçš„åç§°åé¢åŠ ä¸Šäº† CPU ä½“ç³»æ¶æ„çš„åç§°å¦‚ cluster-proportional-autoscaler-amd64ï¼Œcluster-proportional-autoscaler-arm64ï¼›</li><li>flannel åˆ™æ˜¯å°† CPU ä½“ç³»æ¶æ„åç§°å®šä¹‰åœ¨é•œåƒ tag åé¢æ¯”å¦‚ <code>flannel:v0.14.0-amd64</code>ï¼›</li><li>è¿˜æœ‰ calico æ›´å¥‡è‘©ï¼Œamd64 æ¶æ„çš„é•œåƒä¸éœ€è¦åŠ ä½“ç³»æ¶æ„çš„åç§°å¦‚ <code>calico/cni:v3.18.4</code>ï¼Œè€Œ arm64 çš„åˆ™å¿…é¡»è¦åœ¨é•œåƒ tag åé¢å¸¦ä¸Š CPU ä½“ç³»æ¶æ„æ¯”å¦‚ <code>calico/cni:v3.18.4-arm64</code>ï¼›</li></ul><p><img src="https://p.k8s.li/2021-08-31-pass-tob-k8s-offline-deploy-2.jpeg" alt=""></p><p>åœ¨è¿™é‡Œéœ€è¦å¼ºè°ƒä¸€ä¸‹ï¼Œæ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ä¸€å®šè¦ä½¿ç”¨è‡ªåŠ¨åŒ–çš„æ–¹å¼æ¥ç®¡ç†ï¼Œåˆ‡å‹¿æ‰‹åŠ¨æ›´æ–°ï¼Œè¿™æ ·èƒ½èŠ‚çœå¤§é‡çš„ç»´æŠ¤æˆæœ¬ï¼Œä¸ç„¶çš„è¯æ¯æ¬¡éƒ½æ‰‹åŠ¨å»æ›´æ–°è¿™äº›åˆ—è¡¨æˆæœ¬å®åœ¨æ˜¯å¤ªé«˜äº†ï¼Œè€Œä¸”ç‰¹åˆ«å®¹æ˜“å‡ºå‡ºé”™æˆ–è€…é—æ¼æŸä¸ªç»„ä»¶ã€‚</p><h3 id="kubespray-files"><a href="#kubespray-files" class="headerlink" title="kubespray-files"></a>kubespray-files</h3><p>æˆ‘ä»¬å°† kubespray éƒ¨ç½²æ‰€ä¾èµ–çš„äºŒè¿›åˆ¶æ–‡ä»¶æ„å»ºåœ¨ä¸€ä¸ªåä¸º kubespray-files çš„é•œåƒå½“ä¸­ï¼š</p><ul><li>ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">https://get.helm.sh/helm-v3.6.3-linux-amd64.tar.gz</span><br><span class="line">https://github.com/containerd/nerdctl/releases/download/v0.8.1/nerdctl-0.8.1-linux-amd64.tar.gz</span><br><span class="line">https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">https://github.com/coreos/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">https://github.com/k8sli/kubernetes/releases/download/v1.21.3-patch-1.0/kubeadm-linux-amd64</span><br><span class="line">https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.21.0/crictl-v1.21.0-linux-amd64.tar.gz</span><br><span class="line">https://github.com/projectcalico/calico/archive/v3.18.4.tar.gz</span><br><span class="line">https://github.com/projectcalico/calicoctl/releases/download/v3.18.4/calicoctl-linux-amd64</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.21.3/bin/linux/amd64/kubeadm</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.21.3/bin/linux/amd64/kubectl</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.21.3/bin/linux/amd64/kubelet</span><br></pre></td></tr></table></figure><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:latest as files</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk --no-cache add wget ca-certificates</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /build</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> build/kubespray-files/files_*.list /build/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed <span class="string">'/#/d'</span> *<span class="variable">$&#123;ARCH&#125;</span>.list &gt; all_files.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -x -P /files -i all_files.list</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=files /files /files</span></span><br></pre></td></tr></table></figure><ul><li>æ„å»ºåçš„ç›®å½•ç»“æ„ï¼Œé€šè¿‡ç›®å½•å±‚çº§çš„æ–¹å¼ä¿ç•™åŸæœ‰çš„ URL åœ°å€ï¼Œç»´æŠ¤å’Œä½¿ç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">files/</span><br><span class="line">â”œâ”€â”€ get.helm.sh</span><br><span class="line">â”‚Â Â  â””â”€â”€ helm-v3.6.3-linux-amd64.tar.gz</span><br><span class="line">â”œâ”€â”€ github.com</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containerd</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ nerdctl</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.8.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ nerdctl-0.8.1-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containernetworking</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ plugins</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.9.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ coreos</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ etcd</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v3.4.13</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ k8sli</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ kubernetes</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v1.21.3-patch-1.0</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ kubeadm-linux-amd64</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kubernetes-sigs</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ cri-tools</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v1.21.0</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ crictl-v1.21.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â””â”€â”€ projectcalico</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ calico</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ archive</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ v3.18.4.tar.gz</span><br><span class="line">â”‚Â Â      â””â”€â”€ calicoctl</span><br><span class="line">â”‚Â Â          â””â”€â”€ releases</span><br><span class="line">â”‚Â Â              â””â”€â”€ download</span><br><span class="line">â”‚Â Â                  â””â”€â”€ v3.18.4</span><br><span class="line">â”‚Â Â                      â””â”€â”€ calicoctl-linux-amd64</span><br><span class="line">â””â”€â”€ storage.googleapis.com</span><br><span class="line">    â””â”€â”€ kubernetes-release</span><br><span class="line">        â””â”€â”€ release</span><br><span class="line">            â””â”€â”€ v1.21.3</span><br><span class="line">                â””â”€â”€ bin</span><br><span class="line">                    â””â”€â”€ linux</span><br><span class="line">                        â””â”€â”€ amd64</span><br><span class="line">                            â”œâ”€â”€ kubeadm</span><br><span class="line">                            â”œâ”€â”€ kubectl</span><br><span class="line">                            â””â”€â”€ kubelet</span><br></pre></td></tr></table></figure><h3 id="kubespray-images"><a href="#kubespray-images" class="headerlink" title="kubespray-images"></a>kubespray-images</h3><p>æˆ‘ä»¬åŒæ ·å°† kubespray éƒ¨ç½²æ‰€éœ€è¦çš„ç»„ä»¶é•œåƒæ„å»ºåœ¨ä¸€ä¸ªåä¸º kubespray-images çš„é•œåƒå½“ä¸­ï¼š</p><ul><li>é•œåƒåˆ—è¡¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">library/calico-cni:v3.18.4</span><br><span class="line">library/calico-kube-controllers:v3.18.4</span><br><span class="line">library/calico-node:v3.18.4</span><br><span class="line">library/calico-pod2daemon-flexvol:v3.18.4</span><br><span class="line">library/cluster-proportional-autoscaler-amd64:1.8.3</span><br><span class="line">library/coredns:v1.8.0</span><br><span class="line">library/flannel:v0.14.0-amd64</span><br><span class="line">library/kube-apiserver:v1.21.3</span><br><span class="line">library/kube-controller-manager:v1.21.3</span><br><span class="line">library/kube-proxy:v1.21.3</span><br><span class="line">library/kube-scheduler:v1.21.3</span><br><span class="line">library/nginx:1.19</span><br><span class="line">library/pause:3.3</span><br></pre></td></tr></table></figure><ul><li>Dockerfile</li></ul><p>åœ¨ Dockerfile é‡Œå®Œæˆæ‰€æœ‰é•œåƒçš„ä¸‹è½½ï¼Œå¹¶ä½¿ç”¨ ã€Š<a href="https://blog.k8s.li/skopeo-to-registry.html">å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</a>ã€‹æ–‡ä¸­æåˆ°çš„éªšæ“ä½œï¼Œåˆ©ç”¨ registry å­˜å‚¨å¤ç”¨ç›¸åŒ layer çš„ç‰¹æ€§ï¼Œå°† skopeo sync ä¸‹è½½çš„é•œåƒè½¬æ¢æˆ registry å­˜å‚¨çš„ç»“æ„ã€‚è¿™æ ·åœ¨éƒ¨ç½²çš„æ—¶å€™ç›´æ¥æŠŠè¿™ä¸ª registry å­˜å‚¨ç›®å½•æŒ‚è½½è¿› registry å®¹å™¨çš„ <code>/var/lib/registry</code> å³å¯ã€‚ç‰¹ç‚¹æ˜¯æ€§èƒ½æ–¹é¢æ— è®ºæ˜¯æ„å»ºå’Œéƒ¨ç½²ï¼Œéƒ½æ¯”å¸¸è§„ä½¿ç”¨ docker save å’Œ docker load çš„æ–¹å¼è¦å¿«è‡³å°‘ 5 åˆ° 10 å€ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">FROM alpine:3.12 as images</span><br><span class="line">ARG SKOPEO_VERSION=v1.4.0</span><br><span class="line">ARG YQ_VERSION=v4.11.2</span><br><span class="line">RUN ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span><br><span class="line">    &amp;&amp; apk --no-cache add bash wget ca-certificates \</span><br><span class="line">    &amp;&amp; wget -q -k https://github.com/mikefarah/yq/releases/download/<span class="variable">$&#123;YQ_VERSION&#125;</span>/yq_linux_<span class="variable">$&#123;ARCH&#125;</span> -O /usr/<span class="built_in">local</span>/bin/yq \</span><br><span class="line">    &amp;&amp; wget -q -k https://github.com/k8sli/skopeo/releases/download/<span class="variable">$&#123;SKOPEO_VERSION&#125;</span>/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> -O /usr/<span class="built_in">local</span>/bin/skopeo \</span><br><span class="line">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/*</span><br><span class="line"></span><br><span class="line">WORKDIR /build</span><br><span class="line">COPY build/kubespray-images/*  /build/</span><br><span class="line">RUN ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span><br><span class="line">    &amp;&amp; IMAGE_ARCH=<span class="variable">$&#123;ARCH&#125;</span> bash build.sh</span><br><span class="line"></span><br><span class="line">FROM scratch</span><br><span class="line">COPY --from=images /build/docker /docker</span><br></pre></td></tr></table></figure><ul><li>images_origin.yaml é•œåƒé…ç½®æ–‡ä»¶</li></ul><p>è€ƒè™‘åˆ°æœ‰å°†é•œåƒå¯¼å…¥åˆ°å·²ç»å­˜åœ¨çš„é•œåƒä»“åº“ä¸­çš„åœºæ™¯ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹é•œåƒä»“åº“çš„ repoã€‚å› ä¸º <code>library</code> è¿™ä¸ª repo åœ¨ harbor ä¸­æ˜¯é»˜è®¤è‡ªå¸¦çš„ï¼Œåœ¨å¯¼å…¥åˆ° harbor çš„è¿‡ç¨‹ä¸­ä¹Ÿä¸éœ€è¦åˆ›å»ºä¸€äº›é¢å¤–çš„ project ï¼Œæ‰€ä»¥å°†æ‰€æœ‰é•œåƒçš„ repo å…¨éƒ¨ç»Ÿä¸€ä¸º <code>library</code> æ›´é€šç”¨ä¸€äº›ã€‚</p><p>è¿™é‡Œç”¨ä¸€ä¸ª yaml é…ç½®æ–‡ä»¶æ¥è®°å½•åŸé•œåƒåœ°å€å’Œ library é•œåƒçš„åœ°å€çš„å¯¹åº”å…³ç³»ã€‚æ¯”å¦‚ä¸Šæ¸¸çš„ <code>k8s.gcr.io/kube-apiserver</code> æ˜ å°„ä¸º <code>library/kube-apiserver</code>ï¼Œ <code>quay.io/calico/node</code> æ˜ å°„ä¸º <code>library/calico-node</code>ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># kubeadm core images</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-apiserver</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/kube-apiserver</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-controller-manager</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/kube-controller-manager</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-proxy</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/kube-proxy</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-scheduler</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/kube-scheduler</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/coredns/coredns</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/coredns</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/pause</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/pause</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes addons</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/dns/k8s-dns-node-cache</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/k8s-dns-node-cache</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/cluster-proportional-autoscaler-amd64</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/cpa/cluster-proportional-autoscaler-arm64</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/cluster-proportional-autoscaler-arm64</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># network plugin</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/cni</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/calico-cni</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/node</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/calico-node</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/kube-controllers</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/calico-kube-controllers</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/pod2daemon-flexvol</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/calico-pod2daemon-flexvol</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/typha</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/calico-typha</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/coreos/flannel</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/flannel</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx for daemonset and offline</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/nginx</span></span><br></pre></td></tr></table></figure><h3 id="kubeplay-1"><a href="#kubeplay-1" class="headerlink" title="kubeplay"></a>kubeplay</h3><p>kubeplay éƒ¨ç½²çš„ä»£ç ä¸»è¦æ˜¯ç”±ä¸€äº› shell è„šæœ¬å’Œé…ç½®æ–‡ä»¶æ„æˆï¼Œç”¨äºå®Œæˆ nginx æœåŠ¡å’Œ registry æœåŠ¡çš„éƒ¨ç½²ï¼Œä»¥åŠæœ€åè°ƒç”¨ kubespray æ¥å®Œæˆé›†ç¾¤éƒ¨ç½²ã€‚</p><ul><li>ä»£ç ç»“æ„</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubeplay/</span><br><span class="line">â”œâ”€â”€ Dockerfile          <span class="comment"># æ„å»ºå®Œæ•´å®‰è£…åŒ…çš„ Dockerfile</span></span><br><span class="line">â”œâ”€â”€ compose.yaml        <span class="comment"># compose å¯åŠ¨é…ç½® yaml æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ compose</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ nginx.conf  <span class="comment"># nginx é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”‚Â Â  â””â”€â”€ rootCA.cnf      <span class="comment"># ç”Ÿæˆé•œåƒä»“åº“è¯ä¹¦ç”¨åˆ°çš„ openssl é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ config-sample.yaml  <span class="comment"># ä¸»é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ install.sh          <span class="comment"># å®‰è£…æ“ä½œç„¶å</span></span><br><span class="line">â””â”€â”€ library             <span class="comment"># ä¸€äº› shell å‡½æ•°åº“</span></span><br></pre></td></tr></table></figure><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:latest as downloader</span><br><span class="line"><span class="keyword">ARG</span> SKOPEO_VERSION=v1.<span class="number">4.0</span></span><br><span class="line"><span class="keyword">ARG</span> YQ_VERSION=v4.<span class="number">11.2</span></span><br><span class="line"><span class="keyword">ARG</span> NERDCTL_VERSION=<span class="number">0.11</span>.<span class="number">0</span></span><br><span class="line"><span class="keyword">ARG</span> NGINX_VERSION=<span class="number">1.20</span>-alpine</span><br><span class="line"><span class="keyword">ARG</span> RERGISRRY_VERSION=<span class="number">2.7</span>.<span class="number">1</span></span><br><span class="line"><span class="keyword">ARG</span> KUBESPRAY_VERSION=latest</span><br><span class="line"><span class="keyword">ARG</span> KUBESPRAY_IMAGE=ghcr.io/k8sli/kubespray</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½éƒ¨ç½²æ—¶éœ€è¦çš„å·¥å…·ï¼Œå¦‚ yqã€skopeoã€nerdctl-fullsss</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /tools</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk --no-cache add wget ca-certificates \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -k https://github.com/mikefarah/yq/releases/download/<span class="variable">$&#123;YQ_VERSION&#125;</span>/yq_linux_<span class="variable">$&#123;ARCH&#125;</span>  -O /tools/yq-linux-<span class="variable">$&#123;ARCH&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -k https://github.com/k8sli/skopeo/releases/download/v1.4.0/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> -O /tools/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget -q -k https://github.com/containerd/nerdctl/releases/download/v<span class="variable">$&#123;NERDCTL_VERSION&#125;</span>/nerdctl-full-<span class="variable">$&#123;NERDCTL_VERSION&#125;</span>-linux-<span class="variable">$&#123;ARCH&#125;</span>.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /tools/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ln -s /tools/skopeo-linux-<span class="variable">$&#123;ARCH&#125;</span> /usr/bin/skopeo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ä¸€äº›é•œåƒï¼Œå¦‚ nginxã€registryã€kubespray</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /images</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> ARCH=$(uname -m | sed <span class="string">'s/x86_64/amd64/;s/aarch64/arm64/'</span>) \</span></span><br><span class="line"><span class="bash">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=<span class="literal">false</span> --override-arch <span class="variable">$&#123;ARCH&#125;</span> --additional-tag nginx:<span class="variable">$&#123;NGINX_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">       docker://docker.io/library/nginx:<span class="variable">$&#123;NGINX_VERSION&#125;</span> docker-archive:nginx-<span class="variable">$&#123;NGINX_VERSION&#125;</span>.tar \</span></span><br><span class="line"><span class="bash">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=<span class="literal">false</span> --override-arch <span class="variable">$&#123;ARCH&#125;</span> --additional-tag registry:<span class="variable">$&#123;RERGISRRY_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">       docker://docker.io/library/registry:<span class="variable">$&#123;RERGISRRY_VERSION&#125;</span> docker-archive:registry-<span class="variable">$&#123;RERGISRRY_VERSION&#125;</span>.tar \</span></span><br><span class="line"><span class="bash">    &amp;&amp; skopeo copy --insecure-policy --src-tls-verify=<span class="literal">false</span> --override-arch <span class="variable">$&#123;ARCH&#125;</span> --additional-tag kubespray:<span class="variable">$&#123;KUBESPRAY_VERSION&#125;</span> \</span></span><br><span class="line"><span class="bash">       docker://<span class="variable">$&#123;KUBESPRAY_IMAGE&#125;</span>:<span class="variable">$&#123;KUBESPRAY_VERSION&#125;</span> docker-archive:kubespray-<span class="variable">$&#123;KUBESPRAY_VERSION&#125;</span>.tar</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"> <span class="comment"># å°†å…¶å®ƒæ¨¡å—ä¸­çš„å†…å®¹å¤åˆ¶åˆ° scratch é•œåƒä¸­ï¼Œæ„å»ºçš„æ—¶å€™å¯¼å‡ºä¸º local æ–¹å¼</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=downloader /tools /resources/nginx/tools</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=downloader /images /resources/images</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=<span class="variable">$&#123;OS_PACKAGES_IMAGE&#125;</span>:<span class="variable">$&#123;OS_PACKAGE_REPO_TAG&#125;</span> / /resources/nginx</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=<span class="variable">$&#123;KUBESPRAY_FILES_IMAGE&#125;</span>:<span class="variable">$&#123;KUBESPRAY_REPO_TAG&#125;</span> / /resources/nginx</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=<span class="variable">$&#123;KUBESPRAY_IMAGES_IMAGE&#125;</span>:<span class="variable">$&#123;KUBESPRAY_REPO_TAG&#125;</span> / /resources/registry</span></span><br></pre></td></tr></table></figure><h3 id="æ„å»º"><a href="#æ„å»º" class="headerlink" title="æ„å»º"></a>æ„å»º</h3><p>ç”±äºæœ€ç»ˆçš„æ„å»ºæ¶‰åŠå¤šä¸ªæ¨¡å—å’Œ repoï¼Œå…¶æµç¨‹æ¯”è¾ƒå¤æ‚ï¼Œè¯¦ç»†çš„ä»£ç å¯å‚è€ƒæºç  <a href="https://github.com/k8sli/kubeplay/blob/main/.github/workflows/build.yaml" target="_blank" rel="noopener">build.yaml</a> ï¼Œåœ¨è¿™é‡Œåªè®²å‡ ä¸ªå…³é”®çš„éƒ¨åˆ†</p><ul><li>checkout repoï¼Œå°† kubespray å’Œ os-packages repo clone åˆ°å·¥ä½œç›®å½•</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build-package:</span></span><br><span class="line">    <span class="comment"># ä»¥ tag çš„äº‹ä»¶è§¦å‘æ„å»ºæµæ°´çº¿</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">startsWith(github.ref,</span> <span class="string">'refs/tags/'</span><span class="string">)</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-20.04</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># fetch all git repo tag for define image tag</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">kubespray</span> <span class="string">repo</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">main</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">kubespray</span></span><br><span class="line">          <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.repository_owner</span> <span class="string">&#125;&#125;/kubespray</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">os-packages</span> <span class="string">repo</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">main</span></span><br><span class="line">          <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">os-packages</span></span><br><span class="line">          <span class="attr">repository:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.repository_owner</span> <span class="string">&#125;&#125;/os-packages</span></span><br></pre></td></tr></table></figure><ul><li>è·å– kubespray å’Œ os-packages çš„ repo tagï¼Œæ ¹æ®å®ƒæ¥ç¡®å®š os-packages, kubespray-files, kubespray-images è¿™ä¸ªä¸‰ä¸ªé•œåƒçš„ tagï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª All in One çš„ Dockerfile ç”¨äºå®Œæˆåç»­å®‰è£…åŒ…çš„æ„å»ºã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–ä¸€äº›ç»„ä»¶çš„ç‰ˆæœ¬å’Œå˜é‡ä¼ é€’ç»™ Dockerfile</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prepare</span> <span class="string">for</span> <span class="string">build</span> <span class="string">images</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">git</span> <span class="string">describe</span> <span class="string">--tags</span> <span class="string">--always</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/IMAGE_TAG=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line"></span><br><span class="line">    <span class="string">cd</span> <span class="string">kubespray</span> <span class="string">&amp;&amp;</span> <span class="string">git</span> <span class="string">describe</span> <span class="string">--tags</span> <span class="string">--always</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/KUBESPRAY_VERSION=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span> <span class="string">&amp;&amp;</span> <span class="string">cd</span> <span class="string">..</span></span><br><span class="line">    <span class="string">cd</span> <span class="string">os-packages</span> <span class="string">&amp;&amp;</span> <span class="string">git</span> <span class="string">describe</span> <span class="string">--tags</span> <span class="string">--always</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/OS_PACKAGE_REPO_TAG=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span> <span class="string">&amp;&amp;</span> <span class="string">cd</span> <span class="string">..</span></span><br><span class="line">    <span class="string">cp</span> <span class="string">-rf</span> <span class="string">kubespray/config</span> <span class="string">config/kubespray</span> <span class="string">&amp;&amp;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">kubespray</span> <span class="string">os-packages</span></span><br><span class="line"></span><br><span class="line">    <span class="string">source</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">echo</span> <span class="string">""</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="string">echo</span> <span class="string">"COPY --from=$&#123;OS_PACKAGES_IMAGE&#125;:$&#123;OS_PACKAGE_REPO_TAG&#125; / /resources/nginx"</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="string">echo</span> <span class="string">"COPY --from=$&#123;KUBESPRAY_FILES_IMAGE&#125;:$&#123;KUBESPRAY_VERSION&#125; / /resources/nginx"</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="string">echo</span> <span class="string">"COPY --from=$&#123;KUBESPRAY_IMAGES_IMAGE&#125;:$&#123;KUBESPRAY_VERSION&#125; / /resources/registry"</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line"></span><br><span class="line">    <span class="string">sed</span> <span class="string">-n</span> <span class="string">'s|image: nginx:|NGINX_VERSION=|p'</span> <span class="string">compose.yaml</span> <span class="string">|</span> <span class="string">tr</span> <span class="string">-d</span> <span class="string">' '</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">sed</span> <span class="string">-n</span> <span class="string">'s|image: registry:|RERGISRRY_VERSION=|p'</span> <span class="string">compose.yaml</span> <span class="string">|</span> <span class="string">tr</span> <span class="string">-d</span> <span class="string">' '</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <code>outputs: type=local,dest=./</code> æ„å»ºé•œåƒåˆ°æœ¬åœ°ç›®å½•è€Œé push åˆ° registry</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">kubeplay</span> <span class="string">image</span> <span class="string">to</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">docker/build-push-action@v2</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">platforms:</span> <span class="string">linux/amd64,linux/arm64</span></span><br><span class="line">    <span class="attr">build-args:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">NGINX_VERSION=$&#123;&#123;</span> <span class="string">env.NGINX_VERSION</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">RERGISRRY_VERSION=$&#123;&#123;</span> <span class="string">env.RERGISRRY_VERSION</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">KUBESPRAY_IMAGE=$&#123;&#123;</span> <span class="string">env.KUBESPRAY_IMAGE</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">KUBESPRAY_VERSION=$&#123;&#123;</span> <span class="string">env.KUBESPRAY_VERSION</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">outputs:</span> <span class="string">type=local,dest=./</span></span><br></pre></td></tr></table></figure><ul><li>æ‰“åŒ…å¹¶ä¸Šä¼ å®‰è£…åŒ…åˆ° GitHub release å­˜å‚¨</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prepare</span> <span class="string">for</span> <span class="string">upload</span> <span class="string">package</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">rm</span> <span class="string">-rf</span> <span class="string">linux_&#123;amd64,arm64&#125;/&#123;Dockerfile,LICENSE&#125;</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">linux_amd64</span> <span class="string">kubeplay</span></span><br><span class="line">    <span class="string">tar</span> <span class="string">-I</span> <span class="string">pigz</span> <span class="string">-cf</span> <span class="string">kubeplay-$&#123;IMAGE_TAG&#125;-linux-amd64.tar.gz</span> <span class="string">kubeplay</span> <span class="string">--remove-files</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">linux_arm64</span> <span class="string">kubeplay</span></span><br><span class="line">    <span class="string">tar</span> <span class="string">-I</span> <span class="string">pigz</span> <span class="string">-cf</span> <span class="string">kubeplay-$&#123;IMAGE_TAG&#125;-linux-arm64.tar.gz</span> <span class="string">kubeplay</span> <span class="string">--remove-files</span></span><br><span class="line">    <span class="string">sha256sum</span> <span class="string">kubeplay-$&#123;IMAGE_TAG&#125;-linux-&#123;amd64,arm64&#125;.tar.gz</span> <span class="string">&gt;</span> <span class="string">sha256sum.txt</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span> <span class="string">and</span> <span class="string">upload</span> <span class="string">packages</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">softprops/action-gh-release@v1</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">files:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">sha256sum.txt</span></span><br><span class="line">      <span class="string">kubeplay-$&#123;&#123;</span> <span class="string">env.IMAGE_TAG</span> <span class="string">&#125;&#125;-linux-amd64.tar.gz</span></span><br><span class="line">      <span class="string">kubeplay-$&#123;&#123;</span> <span class="string">env.IMAGE_TAG</span> <span class="string">&#125;&#125;-linux-arm64.tar.gz</span></span><br></pre></td></tr></table></figure><p>ç”±æ­¤ä¸€ä¸ªå®Œæ•´çš„ç¦»çº¿å®‰è£…åŒ…å°±æ„å»ºå®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å†è®²ä¸€ä¸‹å®‰è£…æµç¨‹</p><h2 id="å®‰è£…æµç¨‹"><a href="#å®‰è£…æµç¨‹" class="headerlink" title="å®‰è£…æµç¨‹"></a>å®‰è£…æµç¨‹</h2><p>åœ¨ <a href="https://github.com/k8sli/kubeplay/releases" target="_blank" rel="noopener">GitHub release é¡µé¢</a> å°†æˆ‘ä»¬çš„ç¦»çº¿å®‰è£…åŒ…ä¸‹è½½åˆ°æœ¬åœ°ï¼Œéœ€è¦æ ¹æ® CPU æ¶æ„çš„ç±»å‹é€‰æ‹©ç›¸åº”çš„å®‰è£…åŒ…ã€‚</p><p><img src="https://p.k8s.li/2021-08-24-offline-deploy-k8s-1.png" alt="image"></p><p>ä¸‹è½½å®Œæˆä¹‹åå†å°†å®‰è£…åŒ…é€šè¿‡ scp æˆ–è€…å…¶ä»–æ–¹å¼ä¸Šä¼ åˆ°å†…ç½‘çš„éƒ¨ç½²èŠ‚ç‚¹ä¸Šï¼Œéƒ¨ç½²çš„æ–‡æ¡£å¯å‚è€ƒ <a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">README</a> ã€‚è¿‡ç¨‹ååˆ†ç®€å•ï¼šåªéœ€è¦å¡«å†™å¥½ <code>config.yaml</code> é…ç½®æ–‡ä»¶ç„¶åæ‰§è¡Œ <code>bash install.sh</code> å³å¯å®Œæˆ K8s é›†ç¾¤çš„ä¸€é”®éƒ¨ç½²ã€‚</p><p>ä¸‹é¢ä»æºç è€Œé README æ–‡æ¡£çš„è§’åº¦æ¥è®²ä¸€ä¸‹éƒ¨ç½²æµç¨‹çš„å®ç°ç»†èŠ‚</p><h3 id="å®‰è£…åŒ…ç»“æ„"><a href="#å®‰è£…åŒ…ç»“æ„" class="headerlink" title="å®‰è£…åŒ…ç»“æ„"></a>å®‰è£…åŒ…ç»“æ„</h3><ul><li>é…ç½®æ–‡ä»¶ <code>config.yaml</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx ç«¯å£å’Œ registry åŸŸåé…ç½®å‚æ•°</span></span><br><span class="line"><span class="attr">compose:</span></span><br><span class="line">  <span class="comment"># Compose bootstrap node ip, default is local internal ip</span></span><br><span class="line">  <span class="attr">internal_ip:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.25</span></span><br><span class="line">  <span class="comment"># Nginx http server bind port for download files and packages</span></span><br><span class="line">  <span class="attr">nginx_http_port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="comment"># Registry domain for CRI runtime download images</span></span><br><span class="line">  <span class="attr">registry_domain:</span> <span class="string">kube.registry.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubespray å‚æ•°</span></span><br><span class="line"><span class="attr">kubespray:</span></span><br><span class="line">  <span class="comment"># Kubernetes version by default, only support v1.20.6</span></span><br><span class="line">  <span class="attr">kube_version:</span> <span class="string">v1.21.3</span></span><br><span class="line">  <span class="comment"># For deploy HA cluster you must configure a external apiserver access ip</span></span><br><span class="line">  <span class="attr">external_apiserver_access_ip:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">  <span class="comment"># Set network plugin to calico with vxlan mode by default</span></span><br><span class="line">  <span class="attr">kube_network_plugin:</span> <span class="string">calico</span></span><br><span class="line">  <span class="comment">#Container runtime, only support containerd if offline deploy</span></span><br><span class="line">  <span class="attr">container_manager:</span> <span class="string">containerd</span></span><br><span class="line">  <span class="comment"># Now only support host if use containerd as CRI runtime</span></span><br><span class="line">  <span class="attr">etcd_deployment_type:</span> <span class="string">host</span></span><br><span class="line">  <span class="comment"># Settings for etcd event server</span></span><br><span class="line">  <span class="attr">etcd_events_cluster_setup:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">etcd_events_cluster_enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹ ssh ç™»å½• inventory é…ç½®</span></span><br><span class="line"><span class="comment"># Cluster nodes inventory info</span></span><br><span class="line"><span class="attr">inventory:</span></span><br><span class="line">  <span class="attr">all:</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">ansible_port:</span> <span class="number">22</span></span><br><span class="line">      <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">ansible_ssh_pass:</span> <span class="string">Password</span></span><br><span class="line">      <span class="comment"># ansible_ssh_private_key_file: /kubespray/config/id_rsa</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">      <span class="attr">node1:</span></span><br><span class="line">        <span class="attr">ansible_host:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.21</span></span><br><span class="line">      <span class="attr">node2:</span></span><br><span class="line">        <span class="attr">ansible_host:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.22</span></span><br><span class="line">      <span class="attr">node3:</span></span><br><span class="line">        <span class="attr">ansible_host:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.23</span></span><br><span class="line">      <span class="attr">node4:</span></span><br><span class="line">        <span class="attr">ansible_host:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.24</span></span><br><span class="line">    <span class="attr">children:</span></span><br><span class="line">      <span class="attr">kube_control_plane:</span></span><br><span class="line">        <span class="attr">hosts:</span></span><br><span class="line">          <span class="attr">node1:</span></span><br><span class="line">          <span class="attr">node2:</span></span><br><span class="line">          <span class="attr">node3:</span></span><br><span class="line">      <span class="attr">kube_node:</span></span><br><span class="line">        <span class="attr">hosts:</span></span><br><span class="line">          <span class="attr">node1:</span></span><br><span class="line">          <span class="attr">node2:</span></span><br><span class="line">          <span class="attr">node3:</span></span><br><span class="line">          <span class="attr">node4:</span></span><br><span class="line">      <span class="attr">etcd:</span></span><br><span class="line">        <span class="attr">hosts:</span></span><br><span class="line">          <span class="attr">node1:</span></span><br><span class="line">          <span class="attr">node2:</span></span><br><span class="line">          <span class="attr">node3:</span></span><br><span class="line">      <span class="attr">k8s_cluster:</span></span><br><span class="line">        <span class="attr">children:</span></span><br><span class="line">          <span class="attr">kube_control_plane:</span></span><br><span class="line">          <span class="attr">kube_node:</span></span><br><span class="line">      <span class="attr">gpu:</span></span><br><span class="line">        <span class="attr">hosts:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">calico_rr:</span></span><br><span class="line">        <span class="attr">hosts:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€äº›é»˜è®¤çš„é…ç½®ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ— éœ€ä¿®æ”¹</span></span><br><span class="line"><span class="comment">### Default parameters ###</span></span><br><span class="line"><span class="comment">## This filed not need config, will auto update,</span></span><br><span class="line"><span class="comment">## if no special requirement, do not modify these parameters.</span></span><br><span class="line"><span class="attr">default:</span></span><br><span class="line">  <span class="comment"># NTP server ip address or domain, default is internal_ip</span></span><br><span class="line">  <span class="attr">ntp_server:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">internal_ip</span></span><br><span class="line">  <span class="comment"># Registry ip address, default is internal_ip</span></span><br><span class="line">  <span class="attr">registry_ip:</span> <span class="string">internal_ip</span></span><br><span class="line">  <span class="comment"># Offline resource url for download files, default is internal_ip:nginx_http_port</span></span><br><span class="line">  <span class="attr">offline_resources_url:</span> <span class="string">internal_ip:nginx_http_port</span></span><br><span class="line">  <span class="comment"># Use nginx and registry provide all offline resources</span></span><br><span class="line">  <span class="attr">offline_resources_enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Image repo in registry</span></span><br><span class="line">  <span class="attr">image_repository:</span> <span class="string">library</span></span><br><span class="line">  <span class="comment"># Kubespray container image for deploy user cluster or scale</span></span><br><span class="line">  <span class="attr">kubespray_image:</span> <span class="string">"kubespray"</span></span><br><span class="line">  <span class="comment"># Auto generate self-signed certificate for registry domain</span></span><br><span class="line">  <span class="attr">generate_domain_crt:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># For nodes pull image, use 443 as default</span></span><br><span class="line">  <span class="attr">registry_https_port:</span> <span class="number">443</span></span><br><span class="line">  <span class="comment"># For push image to this registry, use 5000 as default, and only bind at 127.0.0.1</span></span><br><span class="line">  <span class="attr">registry_push_port:</span> <span class="number">5000</span></span><br><span class="line">  <span class="comment"># Set false to disable download all container images on all nodes</span></span><br><span class="line">  <span class="attr">download_container:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><ul><li>å®‰è£…åŒ…ç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">kubeplay/</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ compose.yaml                 <span class="comment"># compose é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ compose</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ nginx.conf           <span class="comment"># nginx é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kubespray</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ env.yml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ group_vars           <span class="comment"># kubespray group_vars  é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ inventory.ini</span><br><span class="line">â”‚Â Â  â””â”€â”€ rootCA.cnf               <span class="comment"># openssl é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ config-sample.yaml           <span class="comment"># ä¸»é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ install.sh                   <span class="comment"># å®‰è£…åŒ…å…¥å£è„šæœ¬</span></span><br><span class="line">â”œâ”€â”€ library</span><br><span class="line">â””â”€â”€ resources                    <span class="comment"># æ‰€æœ‰ç¦»çº¿èµ„æº</span></span><br><span class="line">    â”œâ”€â”€ images</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ kubespray-v2.16.tar  <span class="comment"># kubespray é•œåƒ</span></span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ nginx-1.20-alpine.tar<span class="comment"># nginx é•œåƒ</span></span><br><span class="line">    â”‚Â Â  â””â”€â”€ registry-2.7.1.tar   <span class="comment"># registry é•œåƒ</span></span><br><span class="line">    â”œâ”€â”€ nginx                    <span class="comment"># rpm/deb åŒ…ä»¥åŠä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ centos               <span class="comment"># centos rpm åŒ…</span></span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ debian               <span class="comment"># debian deb åŒ…</span></span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ files                <span class="comment"># ä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ repos                <span class="comment"># yum/apt é…ç½®æ–‡ä»¶</span></span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ tools                <span class="comment"># ä¸€äº›éƒ¨ç½²æ—¶ä¾èµ–çš„å·¥å…·</span></span><br><span class="line">    â”‚Â Â  â””â”€â”€ ubuntu               <span class="comment"># ubuntu deb åŒ…</span></span><br><span class="line">    â””â”€â”€ registry</span><br><span class="line">        â””â”€â”€ docker               <span class="comment"># ç»„ä»¶é•œåƒ registry å­˜å‚¨ç›®å½•</span></span><br></pre></td></tr></table></figure><h3 id="compose-èŠ‚ç‚¹"><a href="#compose-èŠ‚ç‚¹" class="headerlink" title="compose èŠ‚ç‚¹"></a>compose èŠ‚ç‚¹</h3><p>éœ€è¦å•ç‹¬åˆ’åˆ†å‡ºä¸€ä¸ªèŠ‚ç‚¹ç”¨æˆ·éƒ¨ç½² nginx å’Œé•œåƒä»“åº“æœåŠ¡ï¼Œå¹¶åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œ kubespray æ¥éƒ¨ç½² K8s é›†ç¾¤ã€‚å¤§è‡´æµç¨‹çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">deploy_compose</span></span>()&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="variable">$&#123;ID&#125;</span> <span class="keyword">in</span></span><br><span class="line">    Debian|debian)</span><br><span class="line">      system::debian::config_repo</span><br><span class="line">      ;;</span><br><span class="line">    CentOS|centos)</span><br><span class="line">      system::centos::disable_selinux</span><br><span class="line">      system::centos::config_repo</span><br><span class="line">      ;;</span><br><span class="line">    Ubuntu|ubuntu)</span><br><span class="line">      system::ubuntu::config_repo</span><br><span class="line">      ;;</span><br><span class="line">    *)</span><br><span class="line">      errorlog <span class="string">"Not support system: <span class="variable">$&#123;ID&#125;</span>"</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">      ;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line">  system::disable_firewalld</span><br><span class="line">  system::install_pkgs</span><br><span class="line">  common::install_tools</span><br><span class="line">  common::rudder_config</span><br><span class="line">  common::update_hosts</span><br><span class="line">  common::generate_domain_certs</span><br><span class="line">  common::load_images</span><br><span class="line">  common::compose_up</span><br><span class="line">  common::health_check</span><br><span class="line">  system::install_chrony</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">main</span></span>()&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="variable">$&#123;INSTALL_TYPE&#125;</span> <span class="keyword">in</span></span><br><span class="line">    all)</span><br><span class="line">      deploy_compose</span><br><span class="line">      common::push_kubespray_image</span><br><span class="line">      common::run_kubespray <span class="string">"bash /kubespray/run.sh deploy-cluster"</span></span><br><span class="line">      ;;</span><br><span class="line">    *)</span><br><span class="line">      echowarn <span class="string">"unknow [TYPE] parameter: <span class="variable">$&#123;INSTALL_TYPE&#125;</span>"</span></span><br><span class="line">      common::usage</span><br><span class="line">      ;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆåˆå§‹åŒ–èŠ‚ç‚¹ï¼Œå…³é—­é˜²ç«å¢™å’Œ <code>SELinux</code></li><li>é…ç½®éƒ¨ç½²èŠ‚ç‚¹ yum/apt ç¦»çº¿æº</li><li>å®‰è£…ä¸€äº›éƒ¨ç½²ä¾èµ–åŒ…ï¼Œå¦‚ chronyã€ libseccomp  ç­‰</li><li>å®‰è£…ä¸€äº›å·¥å…·å¦‚ yq, skopeo, kubectl ç­‰</li><li>å®‰è£… nerdctl-full (containerd)</li><li>ä½¿ç”¨ nerdctl load -i çš„æ–¹å¼å¯¼å…¥nginx, registry, kubespray é•œåƒ</li><li>ä½¿ç”¨ yq æ¸²æŸ“é…ç½®æ–‡ä»¶ï¼Œç”Ÿæˆ kubespray éœ€è¦çš„ env æ–‡ä»¶å’Œ inventory æ–‡ä»¶</li><li>ç”Ÿæˆé•œåƒä»“åº“åŸŸåè¯ä¹¦å¹¶å°†è‡ªç­¾è¯ä¹¦æ·»åŠ åˆ°ä¸»æœºçš„ CA trust ä¿¡ä»»å½“ä¸­</li><li>åœ¨ <code>/etc/hosts</code> ä¸­æ·»åŠ é•œåƒä»“åº“åŸŸå hosts æ˜ å°„</li><li>ä½¿ç”¨ nerdctl compose å¯åŠ¨ nginx å’Œ registry æœåŠ¡</li><li>éƒ¨ç½²æ—¶é’ŸåŒæ­¥æœåŠ¡ chrony</li><li>æ£€æŸ¥å„ä¸ªæœåŠ¡çš„çŠ¶æ€</li><li>æœ€åä½¿ç”¨ nerdctl run å¯åŠ¨ kubespray å®¹å™¨æ¥éƒ¨ç½² k8s é›†ç¾¤</li></ul><h3 id="kubespray-3"><a href="#kubespray-3" class="headerlink" title="kubespray"></a>kubespray</h3><p>éƒ¨ç½²çš„æµç¨‹ä¸ŠåŸºæœ¬ä¸Šå’Œ kubespray å®˜æ–¹å¤§ä½“ä¸€è‡´ï¼Œåªä¸è¿‡æˆ‘ä»¬å¼•å…¥é‡Œåˆ†å±‚éƒ¨ç½²çš„ç‰¹æ€§</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">deploy_cluster</span></span>()&#123;</span><br><span class="line">  touch <span class="variable">$&#123;INSTALL_STEPS_FILE&#125;</span></span><br><span class="line">  STEPS=<span class="string">"00-default-ssh-config 01-cluster-bootstrap-os 02-cluster-etcd 03-cluster-kubernetes 04-cluster-network 05-cluster-apps"</span></span><br><span class="line">  <span class="keyword">for</span> step <span class="keyword">in</span> <span class="variable">$&#123;STEPS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> ! grep -q <span class="string">"<span class="variable">$&#123;step&#125;</span>"</span> <span class="variable">$&#123;INSTALL_STEPS_FILE&#125;</span>; <span class="keyword">then</span></span><br><span class="line">      infolog <span class="string">"start deploy <span class="variable">$&#123;step&#125;</span>"</span></span><br><span class="line">      <span class="keyword">if</span> ansible-playbook <span class="variable">$&#123;ANSIBLE_ARGS&#125;</span> <span class="variable">$&#123;KUBE_ROOT&#125;</span>/playbooks/<span class="variable">$&#123;step&#125;</span>.yml; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="variable">$&#123;step&#125;</span> &gt;&gt; <span class="variable">$&#123;INSTALL_STEPS_FILE&#125;</span></span><br><span class="line">        infolog <span class="string">"<span class="variable">$&#123;step&#125;</span> successfully installed"</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        errorlog <span class="string">"<span class="variable">$&#123;step&#125;</span> installation failed"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      warnlog <span class="string">"<span class="variable">$&#123;step&#125;</span> is already installed, so skipped..."</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é…ç½®å ¡å’æœº ssh ç™»å½•ï¼ˆå¯é€‰ï¼‰</li><li>é…ç½®èŠ‚ç‚¹ yum/apt æºä¸º nginx æœåŠ¡æä¾›çš„æº</li><li>å°†è‡ªç­¾çš„åŸŸåè¯ä¹¦æ·»åŠ åˆ°ä¸»æœºçš„ CA trust ä¿¡ä»»å½“ä¸­</li><li>åœ¨ <code>/etc/hosts</code> ä¸­æ·»åŠ é•œåƒä»“åº“åŸŸå hosts æ˜ å°„</li><li>å…³é—­é˜²ç«å¢™ï¼Œå®‰è£…æ—¶é’ŸåŒæ­¥æœåŠ¡ï¼Œè¿›è¡ŒåŒæ­¥æ—¶é’Ÿ</li><li>åˆå§‹åŒ–é›†ç¾¤èŠ‚ç‚¹ï¼Œå®‰è£…éƒ¨ç½²ä¾èµ–</li><li>å®‰è£…å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸‹è½½æ–‡ä»¶å’Œç»„ä»¶é•œåƒ</li><li>éƒ¨ç½² etcd é›†ç¾¤</li><li>éƒ¨ç½² K8s é›†ç¾¤</li><li>éƒ¨ç½² CNI æ’ä»¶</li><li>å®‰è£…ä¸€äº›é¢å¤–çš„ addon ç»„ä»¶å¦‚ (coredns)</li></ul><p>è‡³æ­¤æ•´ä¸ªæ‰“åŒ…å’Œéƒ¨ç½²æµç¨‹å°±å®Œæ¯•äº†ï¼Œä¸‹é¢å†è®²å‡ ä¸ªæ‰“åŒ…/éƒ¨ç½²å¸¸è§çš„é—®é¢˜</p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="kubeadm-è¯ä¹¦"><a href="#kubeadm-è¯ä¹¦" class="headerlink" title="kubeadm è¯ä¹¦"></a>kubeadm è¯ä¹¦</h3><p>é€šè¿‡ä¿®æ”¹ kubeadm æºç çš„æ–¹å¼å°†è¯ä¹¦ç»­å‘½åˆ° 10 å¹´ï¼Œå¼€å¯ <code>kubeadm_patch_enabled</code> å‚æ•°éƒ¨ç½²æ—¶å°±å°† kubeadm æ›¿æ¢ä¸ºä¿®æ”¹åçš„ kubeadmã€‚å…³äº kubeadm çš„ä¿®æ”¹å’Œæ„å»ºå’Œå‚è€ƒæˆ‘ä¹‹å‰å†™è¿‡çš„ã€Š<a href="https://blog.k8s.li/build-k8s-binary-by-github-actions.html">ä½¿ç”¨ GitHub Actions ç¼–è¯‘ kubernetes ç»„ä»¶</a>ã€‹ã€‚</p><ul><li><a href="https://github.com/k8sli/kubespray/blob/main/roles/cluster/download/tasks/main.yml" target="_blank" rel="noopener">roles/cluster/download/tasks/main.yml</a></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Relpace</span> <span class="string">kubeadm</span> <span class="string">binary</span> <span class="string">file</span> <span class="string">as</span> <span class="string">patched</span> <span class="string">version</span></span><br><span class="line">  <span class="attr">get_url:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">"<span class="template-variable">&#123;&#123; patched_kubeadm_download_url &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">"<span class="template-variable">&#123;&#123; bin_dir &#125;&#125;</span>/kubeadm"</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0755</span></span><br><span class="line">    <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kubeadm</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">kubeadm_patch_enabled</span> <span class="string">|</span> <span class="string">default(true)</span> <span class="string">|</span> <span class="string">bool</span></span><br></pre></td></tr></table></figure><h3 id="é•œåƒç¼“å­˜"><a href="#é•œåƒç¼“å­˜" class="headerlink" title="é•œåƒç¼“å­˜"></a>é•œåƒç¼“å­˜</h3><p>os-packages, kubespray-base, kubespray-files, kubespray-images è¿™å››ä¸ªé•œåƒåœ¨æ„å»ºçš„æ—¶å€™éƒ½ä¼šé‡‡ç”¨ md5 å€¼çš„æ–¹å¼æ ¡éªŒæ˜¯å¦éœ€è¦é‡æ–°æ„å»ºé•œåƒï¼Œè¿™æ ·èƒ½å¤Ÿå¤§å¤§æå‡ CI çš„æ‰§è¡Œæ•ˆç‡ï¼Œä¸‹é¢ä»¥ kubespray-base è¿™ä¸ªé•œåƒä¸ºä¾‹ä»‹ç»å…¶åŸç†å’Œå®ç°ï¼š</p><ul><li>åœ¨æ„å»ºé•œåƒå‰ä¼šæœ‰ä¸€ä¸ª md5 è®¡ç®—å’Œæ ¡éªŒçš„æ­¥éª¤ï¼Œå°†ä¸è¯¥é•œåƒç´§å¯†ç›¸å…³çš„æ–‡ä»¶å†…å®¹è¿›è¡Œæ±‡æ€»å¹¶ç”Ÿæˆ md5 å€¼ï¼Œå¹¶å°†è¿™ä¸ªå€¼å¾—ä»¥ label çš„æ–¹å¼ä¿å­˜åœ¨é•œåƒçš„å…ƒæ•°æ®ä¿¡æ¯å½“ä¸­ã€‚å¦‚æœè¯¥å€¼ä¸ä¸Šä¸ªæœ€æ–°çš„é•œåƒä¸­çš„ md5 å€¼ç›¸ç­‰ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦é‡æ–°æ„å»ºè¯¥é•œåƒï¼Œåªéœ€è¦è¿›è¡Œ retag å³å¯ã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prepare</span> <span class="string">for</span> <span class="string">build</span> <span class="string">images</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">git</span> <span class="string">describe</span> <span class="string">--tags</span> <span class="string">--always</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/IMAGE_TAG=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">git</span> <span class="string">branch</span> <span class="string">--show-current</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/BRANCH_NAME=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">git</span> <span class="string">branch</span> <span class="string">--show-current</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/master/latest/;s/main/latest/;s/^/IMAGE_TAG_BY_BRANCH=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">sed</span> <span class="string">-n</span> <span class="string">'s/^kube_version: /KUBE_VERSION=/p'</span> <span class="string">roles/kubespray-defaults/defaults/main.yaml</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">cat</span> <span class="string">build/kubespray-base/Dockerfile</span> <span class="string">requirements.txt</span> <span class="string">tests/requirements.txt</span> <span class="string">.github/workflows/build.yaml</span> <span class="string">\</span></span><br><span class="line">    <span class="string">|</span> <span class="string">md5sum</span> <span class="string">|</span> <span class="string">tr</span> <span class="string">-d</span> <span class="string">'\ -'</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/BASE_MD5=md5-/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line"></span><br><span class="line">    <span class="string">source</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">if</span> <span class="string">skopeo</span> <span class="string">inspect</span> <span class="string">docker://$&#123;BASE_IMAGE_REPO&#125;:$&#123;BRANCH_NAME&#125;</span> <span class="string">&gt;</span> <span class="string">mainfest.json;</span> <span class="string">then</span></span><br><span class="line">      <span class="string">jq</span> <span class="string">-r</span> <span class="string">'.Labels.BASE_MD5'</span> <span class="string">mainfest.json</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/LATEST_BASE_MD5=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">else</span></span><br><span class="line">      <span class="string">echo</span> <span class="string">'LATEST_BASE_MD5=null'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">    <span class="string">fi</span></span><br></pre></td></tr></table></figure><ul><li>å¦‚æœå½“å‰md5 çš„å€¼ä¸æœ€æ–°çš„ md5 å€¼ç›¸ç­‰ï¼Œå°±é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„ Dockerfile æ¥è¿›è¡Œé•œåƒ retag çš„æ“ä½œã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Replace</span> <span class="string">Dockerfile</span> <span class="string">if</span> <span class="string">MD5</span> <span class="string">not</span> <span class="string">update</span></span><br><span class="line">  <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.BASE_MD5</span> <span class="string">==</span> <span class="string">env.LATEST_BASE_MD5</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">echo</span> <span class="string">"FROM $<span class="template-variable">&#123;&#123; env.BASE_IMAGE_REPO &#125;&#125;</span>:$<span class="template-variable">&#123;&#123; env.BASE_MD5 &#125;&#125;</span>"</span> <span class="string">&gt;</span> <span class="string">build/kubespray-base/Dockerfile</span></span><br></pre></td></tr></table></figure><ul><li>æ„å»ºé•œåƒå¹¶å°† md5 å€¼ä½œä¸º labels å¡«å……åˆ°é•œåƒçš„å…ƒæ•°æ®ä¿¡æ¯å½“ä¸­ã€‚</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span> <span class="string">kubespray-base</span> <span class="string">images</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">docker/build-push-action@v2</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">push:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event_name</span> <span class="string">!=</span> <span class="string">'pull_request'</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">build/kubespray-base/Dockerfile</span></span><br><span class="line">    <span class="attr">platforms:</span> <span class="string">linux/amd64,linux/arm64</span></span><br><span class="line">    <span class="attr">cache-from:</span> <span class="string">type=local,src=/tmp/.buildx-cache</span></span><br><span class="line">    <span class="attr">cache-to:</span> <span class="string">type=local,dest=/tmp/.buildx-cache-new</span></span><br><span class="line">    <span class="attr">build-args:</span> <span class="string">KUBE_VERSION=$&#123;&#123;</span> <span class="string">env.KUBE_VERSION</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">labels:</span> <span class="string">BASE_MD5=$&#123;&#123;</span> <span class="string">env.BASE_MD5</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">$&#123;&#123;</span> <span class="string">env.BASE_IMAGE_REPO</span> <span class="string">&#125;&#125;:$&#123;&#123;</span> <span class="string">env.IMAGE_TAG</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">$&#123;&#123;</span> <span class="string">env.BASE_IMAGE_REPO</span> <span class="string">&#125;&#125;:$&#123;&#123;</span> <span class="string">env.BASE_MD5</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">$&#123;&#123;</span> <span class="string">env.BASE_IMAGE_REPO</span> <span class="string">&#125;&#125;:$&#123;&#123;</span> <span class="string">env.BRANCH_NAME</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="string">$&#123;&#123;</span> <span class="string">env.BASE_IMAGE_REPO</span> <span class="string">&#125;&#125;:$&#123;&#123;</span> <span class="string">env.IMAGE_TAG_BY_BRANCH</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¿™ç§æ–¹å¼çš„å¥½å¤„å°±åœ¨äºåœ¨ä¸éœ€è¦æ„å»ºé•œåƒçš„æ—¶å€™èƒ½å¤§å¹…åº¦æå‡ CI çš„è¿è¡Œæ•ˆç‡ã€‚</p><h2 id="æ¨èé˜…è¯»"><a href="#æ¨èé˜…è¯»" class="headerlink" title="æ¨èé˜…è¯»"></a>æ¨èé˜…è¯»</h2><ul><li><a href="https://blog.k8s.li/pass-platform-release.html">äº‘åŸç”Ÿ PaaS äº§å“å‘å¸ƒ&amp;éƒ¨ç½²æ–¹æ¡ˆ</a></li><li><a href="https://mp.weixin.qq.com/s/7hKkdBUXHFZt5q3KbpmU6Q" target="_blank" rel="noopener">æ”¿é‡‡äº‘åŸºäº sealer çš„ç§æœ‰åŒ–ä¸šåŠ¡äº¤ä»˜å®è·µ</a></li><li><a href="https://blog.k8s.li/make-offline-mirrors.html">ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</a></li><li><a href="https://blog.k8s.li/deploy-k8s-by-kubespray.html">ä½¿ç”¨ Kubespray æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤</a></li><li><a href="https://blog.k8s.li/select-registry-images.html">ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼</a></li><li><a href="https://blog.k8s.li/skopeo-to-registry.html">å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;åœ¨ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒå½“ä¸­ï¼Œå‡ºäºå¯¹æ•°æ®å®‰å…¨çš„è€ƒè™‘ä»¥åŠæ»¡è¶³ &lt;a
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubernetes" scheme="https://blog.k8s.li/tags/kubernetes/"/>
    
      <category term="k8s" scheme="https://blog.k8s.li/tags/k8s/"/>
    
      <category term="PaaS" scheme="https://blog.k8s.li/tags/PaaS/"/>
    
      <category term="toB" scheme="https://blog.k8s.li/tags/toB/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ GitHub Actions ç¼–è¯‘ kubernetes ç»„ä»¶</title>
    <link href="https://blog.k8s.li/build-k8s-binary-by-github-actions.html"/>
    <id>https://blog.k8s.li/build-k8s-binary-by-github-actions.html</id>
    <published>2021-08-25T16:00:00.000Z</published>
    <updated>2021-08-25T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä½¿ç”¨ kubernetes è¿‡ç¨‹ä¸­ç”±äºæŸäº›éœ€æ±‚å¾€å¾€è¦ä¿®æ”¹ä¸€ä¸‹ k8s å®˜æ–¹çš„æºç ï¼Œç„¶åé‡æ–°ç¼–è¯‘æ‰è¡Œã€‚æœ¬æ–‡å°±ä»¥ä¿®æ”¹ kubeadm ç”Ÿæˆè¯ä¹¦ä¸ºé»˜è®¤ 10 å¹´ä¸ºä¾‹ï¼Œæ¥è®²è§£å¦‚ä½•ä½¿ç”¨ GitHub Actions æ¥ç¼–è¯‘å’Œå‘å¸ƒç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><h2 id="æ„å»º"><a href="#æ„å»º" class="headerlink" title="æ„å»º"></a>æ„å»º</h2><h3 id="clone-repo"><a href="#clone-repo" class="headerlink" title="clone repo"></a>clone repo</h3><p>å°† kubernetes å®˜æ–¹æºç  fork åˆ°è‡ªå·±çš„ repo ä¸­</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/k8sli/kubernetes.git</span><br><span class="line">$ <span class="built_in">cd</span> kubernetes</span><br><span class="line">$ git remote add upstream https://github.com/kubernetes/kubernetes.git</span><br><span class="line">$ git fetch --all</span><br><span class="line">$ git checkout upstream/release-1.21</span><br><span class="line">$ git checkout -B kubeadm-1.21</span><br></pre></td></tr></table></figure><h3 id="workflow"><a href="#workflow" class="headerlink" title="workflow"></a>workflow</h3><ul><li><code>.github/workflows/kubeadm.yaml</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Build</span> <span class="string">kubeadm</span> <span class="string">binary</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">tag:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'v*'</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-20.04</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä»¥ tag çš„æ–¹å¼æƒ©è§¦å‘ job çš„è¿è¡Œ</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">startsWith(github.ref,</span> <span class="string">'refs/tags/'</span><span class="string">)</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">kubeadm</span> <span class="string">binary</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="comment"># è¿è¡Œ build/run.sh æ„å»ºè„šæœ¬æ¥ç¼–è¯‘ç›¸åº”å¹³å°ä¸Šçš„äºŒè¿›åˆ¶æ–‡ä»¶</span></span><br><span class="line">          <span class="string">build/run.sh</span> <span class="string">make</span> <span class="string">kubeadm</span> <span class="string">KUBE_BUILD_PLATFORMS=linux/amd64</span></span><br><span class="line">          <span class="string">build/run.sh</span> <span class="string">make</span> <span class="string">kubeadm</span> <span class="string">KUBE_BUILD_PLATFORMS=linux/arm64</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># æ„å»ºå¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶å­˜æ”¾åœ¨ _output/dockerized/bin/ ä¸­</span></span><br><span class="line">      <span class="comment"># æˆ‘ä»¬æ ¹æ®äºŒè¿›åˆ¶ç›®æ ‡æ–‡ä»¶çš„ç³»ç»Ÿåç§°+CPUä½“ç³»æ¶æ„åç§°è¿›è¡Œå‘½å</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prepare</span> <span class="string">for</span> <span class="string">upload</span></span><br><span class="line">        <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">mv</span> <span class="string">_output/dockerized/bin/linux/amd64/kubeadm</span> <span class="string">kubeadm-linux-amd64</span></span><br><span class="line">          <span class="string">mv</span> <span class="string">_output/dockerized/bin/linux/arm64/kubeadm</span> <span class="string">kubeadm-linux-arm64</span></span><br><span class="line">          <span class="string">sha256sum</span> <span class="string">kubeadm-linux-&#123;amd64,arm64&#125;</span> <span class="string">&gt;</span> <span class="string">sha256sum.txt</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># ä½¿ç”¨ softprops/action-gh-release æ¥å°†æ„å»ºäº§ç‰©ä¸Šä¼ åˆ° GitHub release å½“ä¸­</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span> <span class="string">and</span> <span class="string">upload</span> <span class="string">packages</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">softprops/action-gh-release@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">files:</span> <span class="string">|</span></span><br><span class="line">            <span class="string">sha256sum.txt</span></span><br><span class="line">            <span class="string">kubeadm-linux-amd64</span></span><br><span class="line">            <span class="string">kubeadm-linux-arm64</span></span><br></pre></td></tr></table></figure><ul><li><code>build/run.sh</code></li></ul><blockquote><p>: Run a command in a build docker container. Common invocations:</p><ul><li><code>build/run.sh make</code>: Build just linux binaries in the container. Pass options and packages as necessary.</li><li><code>build/run.sh make cross</code>: Build all binaries for all platforms. To build only a specific platform, add <code>KUBE_BUILD_PLATFORMS=&lt;os&gt;/&lt;arch&gt;</code></li><li><code>build/run.sh make kubectl KUBE_BUILD_PLATFORMS=darwin/amd64</code>: Build the specific binary for the specific platform (<code>kubectl</code> and <code>darwin/amd64</code> respectively in this example)</li><li><code>build/run.sh make test</code>: Run all unit tests</li><li><code>build/run.sh make test-integration</code>: Run integration test</li><li><code>build/run.sh make test-cmd</code>: Run CLI tests</li></ul></blockquote><h3 id="ä¿®æ”¹æºç "><a href="#ä¿®æ”¹æºç " class="headerlink" title="ä¿®æ”¹æºç "></a>ä¿®æ”¹æºç </h3><ul><li><code>cmd/kubeadm/app/constants/constants.go</code></li></ul><p>æ‰¾åˆ° <code>CertificateValidity</code> å˜é‡å°†å®ƒåœ¨ 375 å¤©åé¢åŠ ä¸ª 0ï¼Œå°±å°†è¯ä¹¦ç»­å‘½ä¸º 10 å¹´äº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// CertificateValidity defines the validity for all the signed certificates generated by kubeadm</span></span><br><span class="line">-CertificateValidity = time.Hour * <span class="number">24</span> * <span class="number">365</span></span><br><span class="line">+CertificateValidity = time.Hour * <span class="number">24</span> * <span class="number">3650</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">// CACertAndKeyBaseName defines certificate authority base name</span></span><br><span class="line"> CACertAndKeyBaseName = <span class="string">"ca"</span></span><br></pre></td></tr></table></figure><ul><li><code>git diff</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/.github/workflows/kubeadm.yaml b/.github/workflows/kubeadm.yaml</span><br><span class="line">new file mode 100644</span><br><span class="line">index 00000000000..376f37c0edf</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/.github/workflows/kubeadm.yaml</span><br><span class="line">@@ -0,0 +1,37 @@</span><br><span class="line">+---</span><br><span class="line">+name: Build kubeadm binary image</span><br><span class="line">+</span><br><span class="line">+on:</span><br><span class="line">+  push:</span><br><span class="line">+    tag:</span><br><span class="line">+      - <span class="string">'v*'</span></span><br><span class="line">+<span class="built_in">jobs</span>:</span><br><span class="line">+  build:</span><br><span class="line">+    runs-on: ubuntu-20.04</span><br><span class="line">+    <span class="keyword">if</span>: startsWith(github.ref, <span class="string">'refs/tags/'</span>)</span><br><span class="line">+    steps:</span><br><span class="line">+      - name: Checkout</span><br><span class="line">+        uses: actions/checkout@v2</span><br><span class="line">+</span><br><span class="line">+      - name: Build kubeadm binary</span><br><span class="line">+        shell: bash</span><br><span class="line">+        run: |</span><br><span class="line">+          build/run.sh make kubeadm KUBE_BUILD_PLATFORMS=linux/amd64</span><br><span class="line">+          build/run.sh make kubeadm KUBE_BUILD_PLATFORMS=linux/arm64</span><br><span class="line">+</span><br><span class="line">+      - name: Prepare <span class="keyword">for</span> upload</span><br><span class="line">+        shell: bash</span><br><span class="line">+        run: |</span><br><span class="line">+          mv _output/dockerized/bin/linux/amd64/kubeadm kubeadm-linux-amd64</span><br><span class="line">+          mv _output/dockerized/bin/linux/arm64/kubeadm kubeadm-linux-arm64</span><br><span class="line">+          sha256sum kubeadm-linux-&#123;amd64,arm64&#125; &gt; sha256sum.txt</span><br><span class="line">+</span><br><span class="line">+      - name: Release and upload packages</span><br><span class="line">+        uses: softprops/action-gh-release@v1</span><br><span class="line">+        env:</span><br><span class="line">+          GITHUB_TOKEN: <span class="variable">$&#123;&#123; secrets.GITHUB_TOKEN &#125;</span>&#125;</span><br><span class="line">+        with:</span><br><span class="line">+          files: |</span><br><span class="line">+            sha256sum.txt</span><br><span class="line">+            kubeadm-linux-amd64</span><br><span class="line">+            kubeadm-linux-arm64</span><br><span class="line">diff --git a/cmd/kubeadm/app/constants/constants.go b/cmd/kubeadm/app/constants/constants.go</span><br><span class="line">index aed3a713020..08a24d237f8 100644</span><br><span class="line">--- a/cmd/kubeadm/app/constants/constants.go</span><br><span class="line">+++ b/cmd/kubeadm/app/constants/constants.go</span><br><span class="line">@@ -46,7 +46,7 @@ const (</span><br><span class="line"> TempDirForKubeadm = <span class="string">"tmp"</span></span><br><span class="line"></span><br><span class="line"> // CertificateValidity defines the validity <span class="keyword">for</span> all the signed certificates generated by kubeadm</span><br><span class="line">-CertificateValidity = time.Hour * 24 * 365</span><br><span class="line">+CertificateValidity = time.Hour * 24 * 3650</span><br><span class="line"></span><br><span class="line"> // CACertAndKeyBaseName defines certificate authority base name</span><br><span class="line"> CACertAndKeyBaseName = <span class="string">"ca"</span></span><br></pre></td></tr></table></figure><h3 id="cherry-pick"><a href="#cherry-pick" class="headerlink" title="cherry-pick"></a>cherry-pick</h3><p>åœ¨åˆ†æ”¯ä¸Šå®Œæˆä¿®æ”¹ä¹‹åï¼Œæˆ‘ä»¬å°†è¿™ä¸ªä¿®æ”¹ cherry-pick åˆ°å…¶ä»–çš„ tag ä¸Šé¢å»ï¼Œä¸‹é¢ä»¥ v1.21.4 ä¸ºä¾‹å­ï¼šåœ¨ v1.21.4 tag çš„åŸºç¡€ä¹‹ä¸Šå°†ä¸Šè¿°çš„ä¿®æ”¹ cherry-pick è¿‡æ¥ï¼Œé‡æ–°æ‰“ä¸Šæ–°çš„ tagã€‚</p><ul><li>è·å–ä¸Šè¿°ä¿®æ”¹çš„ commit id</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ COMMIT_ID=$(git rev-parse HEAD)</span><br></pre></td></tr></table></figure><ul><li>checkout åˆ° v1.21.4 è¿™ä¸ª tag ä¸Š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout v1.21.4</span><br><span class="line">Note: checking out <span class="string">'v1.21.4'</span>.</span><br><span class="line"></span><br><span class="line">You are <span class="keyword">in</span> <span class="string">'detached HEAD'</span> state. You can look around, make experimental</span><br><span class="line">changes and commit them, and you can discard any commits you make <span class="keyword">in</span> this</span><br><span class="line">state without impacting any branches by performing another checkout.</span><br><span class="line"></span><br><span class="line">If you want to create a new branch to retain commits you create, you may</span><br><span class="line"><span class="keyword">do</span> so (now or later) by using -b with the checkout <span class="built_in">command</span> again. Example:</span><br><span class="line"></span><br><span class="line">HEAD is now at 3cce4a82b44 Release commit <span class="keyword">for</span> Kubernetes v1.21.4</span><br></pre></td></tr></table></figure><ul><li>å°†ä¿®æ”¹ cherry-pick åˆ°å½“å‰ tag ä¸Š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ git cherry-pick <span class="variable">$COMMIT_ID</span></span><br><span class="line">[detached HEAD baadbe03458] Update kubeadm CertificateValidity time to ten years</span><br><span class="line"> Date: Tue Aug 24 16:32:49 2021 +0800</span><br><span class="line"> 2 files changed, 38 insertions(+), 1 deletion(-)</span><br><span class="line"> create mode 100644 .github/workflows/kubeadm.yaml</span><br></pre></td></tr></table></figure><ul><li>é‡æ–°æ‰“ä¸Šæ–°çš„ tagï¼Œå¦‚ <code>v1.21.4-patch-1.0</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ git tag v1.21.4-patch-1.0 -f</span><br><span class="line">Updated tag <span class="string">'v1.21.4-patch-1.0'</span> (was 70bcbd6de6c)</span><br></pre></td></tr></table></figure><p><img src="https://p.k8s.li/2021-08-25-build-k8s-binary-by-github-actions-1.png" alt="image-20210826020226785"></p><ul><li>å°† tag push åˆ° repo ä¸­è§¦å‘ workflow</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ git push origin --tags -f</span><br><span class="line">Enumerating objects: 17, <span class="keyword">done</span>.</span><br><span class="line">Counting objects: 100% (17/17), <span class="keyword">done</span>.</span><br><span class="line">Delta compression using up to 4 threads</span><br><span class="line">Compressing objects: 100% (9/9), <span class="keyword">done</span>.</span><br><span class="line">Writing objects: 100% (10/10), 1.13 KiB | 192.00 KiB/s, <span class="keyword">done</span>.</span><br><span class="line">Total 10 (delta 7), reused 0 (delta 0)</span><br><span class="line">remote: Resolving deltas: 100% (7/7), completed with 7 <span class="built_in">local</span> objects.</span><br><span class="line">To github.com:k8sli/kubernetes.git</span><br><span class="line"> + c2a633e07ec...baadbe03458 v1.21.4-patch-1.0 -&gt; v1.21.4-patch-1.0 (forced update)</span><br></pre></td></tr></table></figure><p><img src="https://p.k8s.li/2021-08-25-build-k8s-binary-by-github-actions-2.png" alt="image-20210826020837194"></p><ul><li>æ•´ä¸ªæ„å»ºè¿‡ç¨‹å¤§æ¦‚éœ€è¦ 7 åˆ†é’Ÿå·¦å³ï¼Œæ•ˆç‡è¿˜æ˜¯è›®é«˜çš„ã€‚</li></ul><p><img src="https://p.k8s.li/2021-08-25-build-k8s-binary-by-github-actions-3.png" alt="image-20210826021451447"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸Šé¢åªå±•ç¤ºäº†ä»¥ä¸€ä¸ª tag ä¸ºå•ä½è¿›è¡Œæ„å»ºçš„æµç¨‹ï¼Œæƒ³è¦æ„å»ºå…¶ä»–ç‰ˆæœ¬çš„ kubeadm ï¼Œå¯ä»¥æŒ‰ç…§åŒæ ·çš„æµç¨‹å’Œæ–¹æ³•æ¥å®Œæˆã€‚å…¶å®å†™ä¸€ä¸ª shell è„šæœ¬æ¥å¤„ç†ä¹Ÿæ˜¯ååˆ†ç®€å•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -o errexit</span><br><span class="line"><span class="built_in">set</span> -o nounset</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ commit ID</span></span><br><span class="line">: <span class="variable">$&#123;COMMIT:="48e4b4c7c62a84ab4ec363588721011b73ee77e6"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰éœ€è¦é‡æ–°ç¼–è¯‘çš„ç‰ˆæœ¬å·</span></span><br><span class="line">: <span class="variable">$&#123;TAGS:="v1.22.1 v1.22.0 v1.21.4 v1.21.3 v1.20.10 v1.19.14 v1.18.10"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> tag <span class="keyword">in</span> <span class="variable">$&#123;TAGS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    git reset --hard <span class="variable">$&#123;tag&#125;</span></span><br><span class="line">    git cherry-pick <span class="variable">$&#123;COMMIT&#125;</span></span><br><span class="line">    git tag <span class="variable">$&#123;tag&#125;</span>-patch-1.0</span><br><span class="line">    git push origin <span class="variable">$&#123;tag&#125;</span>-patch-1.0</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p><img src="https://p.k8s.li/2021-08-25-build-k8s-binary-by-github-actions-5.png" alt="image-20210827021756974"></p><p>ä½¿ç”¨ GitHub Actions çš„å¥½å¤„å°±æ˜¯èƒ½å¤Ÿä¸ºæˆ‘ä»¬è§£å†³ä»£ç ç®¡ç†å’Œäº§ç‰©ç®¡ç†ï¼Œæ„å»ºå¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶å­˜æ”¾åœ¨ GitHub release å½“ä¸­ï¼Œä¸‹è½½å’Œä½¿ç”¨èµ·æ¥ååˆ†æ–¹ä¾¿ï¼Œä¸ç”¨åœ¨è‡ªå·±æä¸€å°å•ç‹¬çš„æœºå™¨æˆ–è€…å­˜å‚¨æœåŠ¡å™¨ï¼ŒèŠ‚çœå¾ˆå¤šäººåŠ›ç»´æŠ¤æˆæœ¬ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;åœ¨ä½¿ç”¨ kubernetes
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="k8s" scheme="https://blog.k8s.li/tags/k8s/"/>
    
      <category term="GitHub" scheme="https://blog.k8s.li/tags/GitHub/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ kubeplay æ¥ç¦»çº¿éƒ¨ç½² kubernetes é›†ç¾¤</title>
    <link href="https://blog.k8s.li/deploy-k8s-by-kubeplay.html"/>
    <id>https://blog.k8s.li/deploy-k8s-by-kubeplay.html</id>
    <published>2021-08-25T16:00:00.000Z</published>
    <updated>2021-08-25T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><a href="https://github.com/k8sli/kubeplay" target="_blank" rel="noopener">kubeplay</a> æ˜¯åŸºäº <a href="https://github.com/k8sli/kubespray" target="_blank" rel="noopener">kubespray</a> å®ç°çš„ç¦»çº¿éƒ¨ç½² kuberneres é›†ç¾¤çš„å·¥å…·</p><h3 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h3><ul><li>åŒ…å«æ‰€æœ‰ä¾èµ–ï¼Œä¸€æ¡å‘½ä»¤å³å¯å®Œæˆç¦»çº¿å®‰è£…</li><li>æ”¯æŒ amd64 å’Œ arm64 CPU æ¶æ„</li><li>kubeadm ç”Ÿæˆçš„è¯ä¹¦æœ‰æ•ˆæœŸè°ƒæ•´ä¸º 10 å¹´</li><li>å» docker åŒ–éƒ¨ç½²ï¼Œæ— ç¼è¿ç§»è‡³ containerd ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶</li><li>é€‚ç”¨äº toB ç§æœ‰åŒ–åœºæ™¯ï¼Œå¯ç¦»çº¿å®‰è£…å¹³å°æ‰€ä¾èµ–çš„ rpm/deb åŒ…ï¼ˆå¦‚å­˜å‚¨å®¢æˆ·ç«¯ï¼‰</li><li>å¤šé›†ç¾¤éƒ¨ç½²ï¼Œæ”¯æŒåœ¨ kubernetes é›†ç¾¤ä¸­ä»¥ Job Pod æ–¹å¼éƒ¨ç½² kubernetes é›†ç¾¤</li><li>ä½¿ç”¨ GitHub Actions æ„å»ºç¦»çº¿å®‰è£…åŒ…ï¼Œæ— éœ€å……å€¼ä¼šå‘˜ï¼Œ100% å¼€æº 100% å…è´¹</li></ul><h3 id="ç»„ä»¶ç‰ˆæœ¬"><a href="#ç»„ä»¶ç‰ˆæœ¬" class="headerlink" title="ç»„ä»¶ç‰ˆæœ¬"></a>ç»„ä»¶ç‰ˆæœ¬</h3><table><thead><tr><th>addon</th><th>version</th><th>ç”¨é€”</th></tr></thead><tbody><tr><td>kubernetes</td><td>v1.21.3</td><td>kubernetes</td></tr><tr><td>containerd</td><td>v1.4.6</td><td>å®¹å™¨è¿è¡Œæ—¶</td></tr><tr><td>etcd</td><td>v3.4.13</td><td>etcd æœåŠ¡</td></tr><tr><td>crictl</td><td>v1.21.0</td><td>CRI CLI å·¥å…·</td></tr><tr><td>pause</td><td>3.3</td><td>pause å®¹å™¨é•œåƒ</td></tr><tr><td>cni-plugins</td><td>v0.9.1</td><td>CNI æ’ä»¶</td></tr><tr><td>calico</td><td>v3.18.4</td><td>calico</td></tr><tr><td>autoscaler</td><td>1.8.3</td><td>DNS è‡ªåŠ¨æ‰©ç¼©å®¹</td></tr><tr><td>coredns</td><td>v1.8.0</td><td>é›†ç¾¤ DNS æœåŠ¡</td></tr><tr><td>flannel</td><td>v0.14.0</td><td>flannel</td></tr><tr><td>nginx</td><td>1.19</td><td>node èŠ‚ç‚¹åå‘ä»£ç† APIserver</td></tr><tr><td>canel</td><td>calico/flannel</td><td>é›†æˆ calico å’Œ flannel</td></tr><tr><td>helm</td><td>v3.6.3</td><td>helm CLI å·¥å…·</td></tr><tr><td>nerdctl</td><td>0.8.0</td><td>containerd CLI å·¥å…·</td></tr><tr><td>nerdctl-full</td><td>0.11.0</td><td>containerd å·¥å…·å…¨å®¶æ¡¶</td></tr><tr><td>registry</td><td>v2.7.1</td><td>æä¾›é•œåƒä¸‹è½½æœåŠ¡</td></tr><tr><td>skopeo</td><td>v1.4.0</td><td>é•œåƒæ¬è¿å·¥å…·</td></tr></tbody></table><h3 id="æ”¯æŒ-OS"><a href="#æ”¯æŒ-OS" class="headerlink" title="æ”¯æŒ OS"></a>æ”¯æŒ OS</h3><table><thead><tr><th>distribution</th><th>version</th><th>arch</th></tr></thead><tbody><tr><td>CentOS</td><td>7.9</td><td>amd64/arm64</td></tr><tr><td>Debian</td><td>10</td><td>amd64/arm64</td></tr><tr><td>Ubuntu</td><td>20.04</td><td>amd64/arm6</td></tr></tbody></table><h3 id="compose"><a href="#compose" class="headerlink" title="compose"></a>compose</h3><p>åœ¨éƒ¨ç½²å·¥å…·è¿è¡ŒèŠ‚ç‚¹ä½¿ç”¨ <a href="https://github.com/containerd/nerdctl" target="_blank" rel="noopener">nerdctl compose</a> å¯åŠ¨ nginx å’Œ registry å®¹å™¨ï¼Œåˆ†åˆ«æä¾›ç¦»çº¿èµ„æºä¸‹è½½å’Œé•œåƒåˆ†å‘æœåŠ¡ã€‚</p><h3 id="kubespray"><a href="#kubespray" class="headerlink" title="kubespray"></a>kubespray</h3><p>ä½¿ç”¨ kubernetes ç¤¾åŒºçš„ <a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener">kubespray</a> ä½œä¸ºé›†ç¾¤éƒ¨ç½²çš„åŠŸèƒ½ï¼Œéƒ¨ç½²è¿‡ç¨‹ä¸­æ‰€ä¾èµ–çš„èµ„æºä» compose èŠ‚ç‚¹è·å–ã€‚</p><h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><h3 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h3><p>åœ¨ GitHub çš„ release é¡µé¢ <a href="https://github.com/k8sli/kubeplay/releases" target="_blank" rel="noopener">k8sli/kubeplay/releases</a> ä¸‹è½½å¯¹åº”çš„ç¦»çº¿å®‰è£…åŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sha256sum                                    <span class="comment"># å®‰è£…åŒ… sha256sum æ ¡éªŒæ–‡ä»¶</span></span><br><span class="line">kubeplay-v0.1.0-alpha.1-linux-amd64.tar.gz   <span class="comment"># é€‚ç”¨äº amd64 CPU ä½“ç³»æ¶æ„</span></span><br><span class="line">kubeplay-v0.1.0-alpha.1-linux-arm64.tar.gz   <span class="comment"># é€‚ç”¨äº arm64 CPU ä½“ç³»æ¶æ„</span></span><br></pre></td></tr></table></figure><h3 id="è§£å‹"><a href="#è§£å‹" class="headerlink" title="è§£å‹"></a>è§£å‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ tar -xpf kubeplay-v0.1.0-alpha.1-linux-amd64.tar.gz</span><br><span class="line">$ <span class="built_in">cd</span> kubeplay</span><br><span class="line">$ vi config.yaml</span><br></pre></td></tr></table></figure><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p><code>config.yaml</code> é…ç½®æ–‡ä»¶ä¸»è¦åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†</p><ul><li>composeï¼šnginx å’Œ registry éƒ¨ç½²èŠ‚ç‚¹ä¿¡æ¯</li><li>kubesprayï¼škubespray éƒ¨ç½²é…ç½®</li><li>invenoryï¼škubernetes é›†ç¾¤èŠ‚ç‚¹ ssh ç™»å½•ä¿¡æ¯</li><li>defaultï¼šä¸€äº›é»˜è®¤çš„å‚æ•°</li></ul><h4 id="compose-1"><a href="#compose-1" class="headerlink" title="compose"></a>compose</h4><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>internal_ip</td><td>éƒ¨ç½²èŠ‚ç‚¹å†…ç½‘è®¿é—® IP</td><td>192.168.10.11</td></tr><tr><td>nginx_http_port</td><td>éƒ¨ç½² nginx æœåŠ¡æš´éœ²çš„ç«¯å£</td><td>8080</td></tr><tr><td>registry_domain</td><td>éƒ¨ç½² registry é•œåƒä»“åº“æœåŠ¡çš„åŸŸå</td><td>kube.registry.local</td></tr></tbody></table><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">compose:</span></span><br><span class="line">  <span class="comment"># Compose bootstrap node ip, default is local internal ip</span></span><br><span class="line">  <span class="attr">internal_ip:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.25</span></span><br><span class="line">  <span class="comment"># Nginx http server bind port for download files and packages</span></span><br><span class="line">  <span class="attr">nginx_http_port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="comment"># Registry domain for CRI runtime download images</span></span><br><span class="line">  <span class="attr">registry_domain:</span> <span class="string">kube.registry.local</span></span><br></pre></td></tr></table></figure><h4 id="kubespray-1"><a href="#kubespray-1" class="headerlink" title="kubespray"></a>kubespray</h4><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>kube_version</td><td>kubernetes ç‰ˆæœ¬å·</td><td>v1.21.3</td></tr><tr><td>external_apiserver_access_ip</td><td>é›†ç¾¤APIserverå¤–éƒ¨è®¿é—® IP</td><td>192.168.10.100</td></tr><tr><td>kube_network_plugin</td><td>é€‰ç”¨ CNI ç½‘ç»œæ’ä»¶åç§°</td><td>calico</td></tr><tr><td>container_manager</td><td>å®¹å™¨è¿è¡Œæ—¶</td><td>containerd</td></tr><tr><td>etcd_deployment_type</td><td>etcd éƒ¨ç½²æ–¹å¼</td><td>host</td></tr></tbody></table><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kubespray:</span></span><br><span class="line">  <span class="comment"># Kubernetes version by default, only support v1.20.6</span></span><br><span class="line">  <span class="attr">kube_version:</span> <span class="string">v1.21.3</span></span><br><span class="line">  <span class="comment"># For deploy HA cluster you must configure a external apiserver access ip</span></span><br><span class="line">  <span class="attr">external_apiserver_access_ip:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">  <span class="comment"># Set network plugin to calico with vxlan mode by default</span></span><br><span class="line">  <span class="attr">kube_network_plugin:</span> <span class="string">calico</span></span><br><span class="line">  <span class="comment">#Container runtime, only support containerd if offline deploy</span></span><br><span class="line">  <span class="attr">container_manager:</span> <span class="string">containerd</span></span><br><span class="line">  <span class="comment"># Now only support host if use containerd as CRI runtime</span></span><br><span class="line">  <span class="attr">etcd_deployment_type:</span> <span class="string">host</span></span><br><span class="line">  <span class="comment"># Settings for etcd event server</span></span><br><span class="line">  <span class="attr">etcd_events_cluster_setup:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">etcd_events_cluster_enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="inventory"><a href="#inventory" class="headerlink" title="inventory"></a>inventory</h4><p>inventory ä¸º kubernetes é›†ç¾¤èŠ‚ç‚¹çš„ ssh ç™»å½•é…ç½®ï¼Œæ”¯æŒ yaml, json, ini ä¸‰ç§æ ¼å¼ã€‚</p><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th><th>ç¤ºä¾‹</th></tr></thead><tbody><tr><td>ansible_port</td><td>ä¸»æœº ssh ç™»å½•ç«¯å£å·</td><td>22</td></tr><tr><td>ansible_user</td><td>ä¸»æœº ssh ç™»å½•ç”¨æˆ·å</td><td></td></tr><tr><td>ansible_ssh_pass</td><td>ä¸»æœº ssh ç™»å½•å¯†ç </td><td></td></tr><tr><td>ansible_ssh_private_key_file</td><td>å¦‚æœä½¿ç”¨ private key ç™»å½•</td><td>å¿…é¡»ä¸º<code>/kubespray/config/id_rsa</code></td></tr><tr><td>ansible_host</td><td>èŠ‚ç‚¹ IP</td><td></td></tr></tbody></table><ul><li>yaml æ ¼å¼</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cluster nodes inventory info</span></span><br><span class="line"><span class="attr">inventory:</span></span><br><span class="line">  <span class="attr">all:</span></span><br><span class="line">    <span class="attr">vars:</span></span><br><span class="line">      <span class="attr">ansible_port:</span> <span class="number">22</span></span><br><span class="line">      <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">ansible_ssh_pass:</span> <span class="string">Password</span></span><br><span class="line">      <span class="comment"># ansible_ssh_private_key_file: /kubespray/config/id_rsa</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">      <span class="attr">node1:</span></span><br><span class="line">        <span class="attr">ansible_host:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.21</span></span><br><span class="line">      <span class="attr">node2:</span></span><br><span class="line">        <span class="attr">ansible_host:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.22</span></span><br><span class="line">      <span class="attr">node3:</span></span><br><span class="line">        <span class="attr">ansible_host:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.23</span></span><br><span class="line">      <span class="attr">node4:</span></span><br><span class="line">        <span class="attr">ansible_host:</span> <span class="number">172.20</span><span class="number">.0</span><span class="number">.24</span></span><br><span class="line">    <span class="attr">children:</span></span><br><span class="line">      <span class="attr">kube_control_plane:</span></span><br><span class="line">        <span class="attr">hosts:</span></span><br><span class="line">          <span class="attr">node1:</span></span><br><span class="line">          <span class="attr">node2:</span></span><br><span class="line">          <span class="attr">node3:</span></span><br><span class="line">      <span class="attr">kube_node:</span></span><br><span class="line">        <span class="attr">hosts:</span></span><br><span class="line">          <span class="attr">node1:</span></span><br><span class="line">          <span class="attr">node2:</span></span><br><span class="line">          <span class="attr">node3:</span></span><br><span class="line">          <span class="attr">node4:</span></span><br><span class="line">      <span class="attr">etcd:</span></span><br><span class="line">        <span class="attr">hosts:</span></span><br><span class="line">          <span class="attr">node1:</span></span><br><span class="line">          <span class="attr">node2:</span></span><br><span class="line">          <span class="attr">node3:</span></span><br><span class="line">      <span class="attr">k8s_cluster:</span></span><br><span class="line">        <span class="attr">children:</span></span><br><span class="line">          <span class="attr">kube_control_plane:</span></span><br><span class="line">          <span class="attr">kube_node:</span></span><br><span class="line">      <span class="attr">gpu:</span></span><br><span class="line">        <span class="attr">hosts:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">calico_rr:</span></span><br><span class="line">        <span class="attr">hosts:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure><ul><li>json æ ¼å¼</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">inventory: |</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">"all"</span>: &#123;</span><br><span class="line">      <span class="attr">"vars"</span>: &#123;</span><br><span class="line">        <span class="attr">"ansible_port"</span>: <span class="number">22</span>,</span><br><span class="line">        <span class="attr">"ansible_user"</span>: <span class="string">"root"</span>,</span><br><span class="line">        <span class="attr">"ansible_ssh_pass"</span>: <span class="string">"Password"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"hosts"</span>: &#123;</span><br><span class="line">        <span class="attr">"node1"</span>: &#123;</span><br><span class="line">          <span class="attr">"ansible_host"</span>: <span class="string">"172.20.0.21"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"node2"</span>: &#123;</span><br><span class="line">          <span class="attr">"ansible_host"</span>: <span class="string">"172.20.0.22"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"node3"</span>: &#123;</span><br><span class="line">          <span class="attr">"ansible_host"</span>: <span class="string">"172.20.0.23"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"node4"</span>: &#123;</span><br><span class="line">          <span class="attr">"ansible_host"</span>: <span class="string">"172.20.0.24"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"children"</span>: &#123;</span><br><span class="line">        <span class="attr">"kube_control_plane"</span>: &#123;</span><br><span class="line">          <span class="attr">"hosts"</span>: &#123;</span><br><span class="line">            <span class="attr">"node1"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"node2"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"node3"</span>: <span class="literal">null</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"kube_node"</span>: &#123;</span><br><span class="line">          <span class="attr">"hosts"</span>: &#123;</span><br><span class="line">            <span class="attr">"node1"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"node2"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"node3"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"node4"</span>: <span class="literal">null</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"etcd"</span>: &#123;</span><br><span class="line">          <span class="attr">"hosts"</span>: &#123;</span><br><span class="line">            <span class="attr">"node1"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"node2"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"node3"</span>: <span class="literal">null</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"k8s_cluster"</span>: &#123;</span><br><span class="line">          <span class="attr">"children"</span>: &#123;</span><br><span class="line">            <span class="attr">"kube_control_plane"</span>: <span class="literal">null</span>,</span><br><span class="line">            <span class="attr">"kube_node"</span>: <span class="literal">null</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"gpu"</span>: &#123;</span><br><span class="line">          <span class="attr">"hosts"</span>: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"calico_rr"</span>: &#123;</span><br><span class="line">          <span class="attr">"hosts"</span>: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><ul><li>ini æ ¼å¼</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">inventory: |</span><br><span class="line">  <span class="section">[all:vars]</span></span><br><span class="line">  ansible_port=22</span><br><span class="line">  ansible_user=root</span><br><span class="line">  ansible_ssh_pass=Password</span><br><span class="line">  <span class="comment">#ansible_ssh_private_key_file=/kubespray/config/id_rsa</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[all]</span></span><br><span class="line">  kube-control-01 ansible_host=172.20.0.21</span><br><span class="line">  kube-control-02 ansible_host=172.20.0.23</span><br><span class="line">  kube-control-03 ansible_host=172.20.0.22</span><br><span class="line">  kube-node-01 ansible_host=172.20.0.24</span><br><span class="line"></span><br><span class="line">  <span class="section">[bastion]</span></span><br><span class="line">  <span class="comment"># bastion-01 ansible_host=x.x.x.x ansible_user=some_user</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[kube_control_plane]</span></span><br><span class="line">  kube-control-01</span><br><span class="line">  kube-control-02</span><br><span class="line">  kube-control-03</span><br><span class="line"></span><br><span class="line">  <span class="section">[etcd]</span></span><br><span class="line">  kube-control-01</span><br><span class="line">  kube-control-02</span><br><span class="line">  kube-control-03</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="section">[kube_node]</span></span><br><span class="line">  kube-control-01</span><br><span class="line">  kube-control-02</span><br><span class="line">  kube-control-03</span><br><span class="line">  kube-node-01</span><br><span class="line"></span><br><span class="line">  <span class="section">[calico_rr]</span></span><br><span class="line"></span><br><span class="line">  <span class="section">[k8s_cluster:children]</span></span><br><span class="line">  kube_control_plane</span><br><span class="line">  kube_node</span><br><span class="line">  calico_rr</span><br></pre></td></tr></table></figure><h4 id="default"><a href="#default" class="headerlink" title="default"></a>default</h4><p>ä»¥ä¸‹å‡ ä¸ªé»˜è®¤çš„å‚æ•°åœ¨æ²¡æœ‰ç‰¹æ®Šè¦æ±‚çš„æƒ…å†µä¸‹ä¸å»ºè®®ä¿®æ”¹ï¼Œç›´æ¥ä¿æŒé»˜è®¤å³å¯ã€‚<code>ntp_server</code> å‚æ•°ä¸ºé»˜è®¤å€¼æ—¶ä¼šè‡ªåŠ¨æ›¿æ¢æˆ compose ä¸­çš„ <code>internal_ip</code> å€¼ï¼›<code>registry_ip</code> å’Œ <code>offline_resources_url</code> è¿™ä¸¤ä¸ªå‚æ•°ä¼šæ ¹æ® compose ä¸­çš„å‚æ•°è‡ªåŠ¨ç”Ÿæˆæ— éœ€ä¿®æ”¹ã€‚</p><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th><th align="center">ç¤ºä¾‹</th></tr></thead><tbody><tr><td>ntp_server</td><td>ntp æ—¶é’ŸåŒæ­¥æœåŠ¡å™¨åŸŸåæˆ– IP</td><td align="center">-</td></tr><tr><td>registry_ip</td><td>é•œåƒä»“åº“èŠ‚ç‚¹ IP</td><td align="center">-</td></tr><tr><td>offline_resources_url</td><td>æä¾›ç¦»çº¿èµ„æºä¸‹è½½çš„ URL åœ°å€</td><td align="center">-</td></tr><tr><td>offline_resources_enabled</td><td>æ˜¯å¦ä¸ºç¦»çº¿éƒ¨ç½²</td><td align="center">true</td></tr><tr><td>generate_domain_crt</td><td>æ˜¯å¦ä¸ºé•œåƒä»“åº“åŸŸåç”Ÿæˆè‡ªç­¾è¯ä¹¦</td><td align="center">true</td></tr><tr><td>image_repository</td><td>é•œåƒä»“åº“çš„ repo æˆ– project</td><td align="center">library</td></tr><tr><td>registry_https_port</td><td>é•œåƒä»“åº“çš„ç«¯å£å·ï¼Œè¯¥ç«¯å£å·²ç¦æ­¢ PUSH é•œåƒ</td><td align="center">443</td></tr><tr><td>registry_push_port</td><td>ç”¨äº PUSH é•œåƒçš„ registry ç«¯å£å·</td><td align="center">5000</td></tr><tr><td>download_container</td><td>æ˜¯å¦åœ¨æ‰€æœ‰èŠ‚ç‚¹ pull ä¸‹æ‰€æœ‰ç»„ä»¶çš„é•œåƒ</td><td align="center">false</td></tr></tbody></table><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">default:</span></span><br><span class="line">  <span class="comment"># NTP server ip address or domain, default is internal_ip</span></span><br><span class="line">  <span class="attr">ntp_server:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">internal_ip</span></span><br><span class="line">  <span class="comment"># Registry ip address, default is internal_ip</span></span><br><span class="line">  <span class="attr">registry_ip:</span> <span class="string">internal_ip</span></span><br><span class="line">  <span class="comment"># Offline resource url for download files, default is internal_ip:nginx_http_port</span></span><br><span class="line">  <span class="attr">offline_resources_url:</span> <span class="string">internal_ip:nginx_http_port</span></span><br><span class="line">  <span class="comment"># Use nginx and registry provide all offline resources</span></span><br><span class="line">  <span class="attr">offline_resources_enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Image repo in registry</span></span><br><span class="line">  <span class="attr">image_repository:</span> <span class="string">library</span></span><br><span class="line">  <span class="comment"># Kubespray container image for deploy user cluster or scale</span></span><br><span class="line">  <span class="attr">kubespray_image:</span> <span class="string">"kubespray"</span></span><br><span class="line">  <span class="comment"># Auto generate self-signed certificate for registry domain</span></span><br><span class="line">  <span class="attr">generate_domain_crt:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># For nodes pull image, use 443 as default</span></span><br><span class="line">  <span class="attr">registry_https_port:</span> <span class="number">443</span></span><br><span class="line">  <span class="comment"># For push image to this registry, use 5000 as default, and only bind at 127.0.0.1</span></span><br><span class="line">  <span class="attr">registry_push_port:</span> <span class="number">5000</span></span><br><span class="line">  <span class="comment"># Set false to disable download all container images on all nodes</span></span><br><span class="line">  <span class="attr">download_container:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="éƒ¨ç½²é›†ç¾¤"><a href="#éƒ¨ç½²é›†ç¾¤" class="headerlink" title="éƒ¨ç½²é›†ç¾¤"></a>éƒ¨ç½²é›†ç¾¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bash install.sh</span><br></pre></td></tr></table></figure><h3 id="å¢åŠ èŠ‚ç‚¹"><a href="#å¢åŠ èŠ‚ç‚¹" class="headerlink" title="å¢åŠ èŠ‚ç‚¹"></a>å¢åŠ èŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bash install.sh add-node <span class="variable">$NODE_NAMES</span></span><br></pre></td></tr></table></figure><h3 id="åˆ é™¤èŠ‚ç‚¹"><a href="#åˆ é™¤èŠ‚ç‚¹" class="headerlink" title="åˆ é™¤èŠ‚ç‚¹"></a>åˆ é™¤èŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bash install.sh remove-node <span class="variable">$NODE_NAME</span></span><br></pre></td></tr></table></figure><h3 id="ç§»é™¤é›†ç¾¤"><a href="#ç§»é™¤é›†ç¾¤" class="headerlink" title="ç§»é™¤é›†ç¾¤"></a>ç§»é™¤é›†ç¾¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bash install.sh remove-cluster</span><br></pre></td></tr></table></figure><h3 id="ç§»é™¤æ‰€æœ‰ç»„ä»¶"><a href="#ç§»é™¤æ‰€æœ‰ç»„ä»¶" class="headerlink" title="ç§»é™¤æ‰€æœ‰ç»„ä»¶"></a>ç§»é™¤æ‰€æœ‰ç»„ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bash install.sh remove</span><br></pre></td></tr></table></figure><h2 id="æœªå®Œåç»­è¡¥å……"><a href="#æœªå®Œåç»­è¡¥å……" class="headerlink" title="æœªå®Œåç»­è¡¥å……"></a>æœªå®Œåç»­è¡¥å……</h2>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;ç®€ä»‹&quot;&gt;&lt;a href=&quot;#ç®€ä»‹&quot;
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="k8s" scheme="https://blog.k8s.li/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>æ¬ç –å¸¸ç”¨çš„ shell ç‰‡æ®µè®°å½•</title>
    <link href="https://blog.k8s.li/shell-snippet.html"/>
    <id>https://blog.k8s.li/shell-snippet.html</id>
    <published>2021-07-19T16:00:00.000Z</published>
    <updated>2021-07-19T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>å¶ç„¶é—´çœ‹åˆ°äº† <a href="https://izsk.me/" target="_blank" rel="noopener"><strong>Z.S.K.â€™s Records</strong></a> å¤§ä½¬çš„ä¸€ç¯‡åšå®¢ ã€Š<a href="https://izsk.me/2021/03/21/shell-funny-snippet/" target="_blank" rel="noopener">æœ‰è¶£çš„Shell Snippet</a>ã€‹ï¼Œçªå‘å¥‡æƒ³ä¹Ÿå‡†å¤‡å†™ç¯‡æ–‡ç« æ¥è®°å½•ä¸€ä¸‹å¸¸ç”¨çš„ä¸€äº› shell ä»£ç ã€‚</p><h2 id="Bash"><a href="#Bash" class="headerlink" title="Bash"></a>Bash</h2><h3 id="å±•å¼€"><a href="#å±•å¼€" class="headerlink" title="{} å±•å¼€"></a>{} å±•å¼€</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> &#123;hack,build&#125;</span><br><span class="line">hack build</span><br></pre></td></tr></table></figure><h3 id="å˜é‡æ›¿æ¢"><a href="#å˜é‡æ›¿æ¢" class="headerlink" title="å˜é‡æ›¿æ¢"></a>å˜é‡æ›¿æ¢</h3><blockquote><p><a href="http://cn.linux.vbird.org/linux_basic/0320bash_2.php#variable_other" target="_blank" rel="noopener">http://cn.linux.vbird.org/linux_basic/0320bash_2.php#variable_other</a></p><p>æˆ‘ä»¬å°†è¿™éƒ¨ä»½ä½œä¸ªæ€»ç»“è¯´æ˜ä¸€ä¸‹ï¼š</p><table><thead><tr><th>å˜é‡é…ç½®æ–¹å¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>${å˜é‡#å…³é”®è¯} ${å˜é‡##å…³é”®è¯}</td><td>è‹¥å˜é‡å†…å®¹ä»å¤´å¼€å§‹çš„æ•°æ®ç¬¦åˆã€å…³é”®è¯ã€ï¼Œåˆ™å°†ç¬¦åˆçš„æœ€çŸ­æ•°æ®åˆ é™¤ è‹¥å˜é‡å†…å®¹ä»å¤´å¼€å§‹çš„æ•°æ®ç¬¦åˆã€å…³é”®è¯ã€ï¼Œåˆ™å°†ç¬¦åˆçš„æœ€é•¿æ•°æ®åˆ é™¤</td></tr><tr><td>${å˜é‡%å…³é”®è¯} ${å˜é‡%%å…³é”®è¯}</td><td>è‹¥å˜é‡å†…å®¹ä»å°¾å‘å‰çš„æ•°æ®ç¬¦åˆã€å…³é”®è¯ã€ï¼Œåˆ™å°†ç¬¦åˆçš„æœ€çŸ­æ•°æ®åˆ é™¤ è‹¥å˜é‡å†…å®¹ä»å°¾å‘å‰çš„æ•°æ®ç¬¦åˆã€å…³é”®è¯ã€ï¼Œåˆ™å°†ç¬¦åˆçš„æœ€é•¿æ•°æ®åˆ é™¤</td></tr><tr><td>${å˜é‡/æ—§å­—ç¬¦ä¸²/æ–°å­—ç¬¦ä¸²} ${å˜é‡//æ—§å­—ç¬¦ä¸²/æ–°å­—ç¬¦ä¸²}</td><td>è‹¥å˜é‡å†…å®¹ç¬¦åˆã€æ—§å­—ç¬¦ä¸²ã€åˆ™ã€ç¬¬ä¸€ä¸ªæ—§å­—ç¬¦ä¸²ä¼šè¢«æ–°å­—ç¬¦ä¸²å–ä»£ã€ è‹¥å˜é‡å†…å®¹ç¬¦åˆã€æ—§å­—ç¬¦ä¸²ã€åˆ™ã€å…¨éƒ¨çš„æ—§å­—ç¬¦ä¸²ä¼šè¢«æ–°å­—ç¬¦ä¸²å–ä»£ã€</td></tr></tbody></table></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ image=<span class="string">"library/nginx:1.19"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¯”å¦‚è¦è·å–é•œåƒçš„ tag å¸¸ç”¨çš„æ˜¯ echo ç„¶å awk/cut çš„æ–¹å¼</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$&#123;image&#125;</span> | awk -F <span class="string">':'</span> <span class="string">'&#123;print $2&#125;'</span> æ–¹å¼</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯ä»¥ç›´æ¥ä½¿ç”¨ bash å†…ç½®çš„å˜é‡æ›¿æ¢åŠŸèƒ½ï¼Œæˆªå–ç‰¹å®šå­—ç¬¦ä¸²</span></span><br><span class="line">$ image_name=<span class="variable">$&#123;image%%:*&#125;</span></span><br><span class="line">$ image_tag=<span class="variable">$&#123;image##*:&#125;</span></span><br><span class="line">$ image_repo=<span class="variable">$&#123;image%%/*&#125;</span></span><br></pre></td></tr></table></figure><h3 id="å˜é‡é…ç½®æ–¹å¼"><a href="#å˜é‡é…ç½®æ–¹å¼" class="headerlink" title="å˜é‡é…ç½®æ–¹å¼"></a>å˜é‡é…ç½®æ–¹å¼</h3><table><thead><tr><th>å˜é‡é…ç½®æ–¹å¼</th><th>str æ²¡æœ‰é…ç½®</th><th>str ä¸ºç©ºå­—ç¬¦ä¸²</th><th>str å·²é…ç½®éä¸ºç©ºå­—ç¬¦ä¸²</th></tr></thead><tbody><tr><td>var=${str-expr}</td><td>var=expr</td><td>var=</td><td>var=$str</td></tr><tr><td>var=${str:-expr}</td><td>var=expr</td><td>var=expr</td><td>var=$str</td></tr><tr><td>var=${str+expr}</td><td>var=</td><td>var=expr</td><td>var=expr</td></tr><tr><td>var=${str:+expr}</td><td>var=</td><td>var=</td><td>var=expr</td></tr><tr><td>var=${str=expr}</td><td>str=expr var=expr</td><td>str ä¸å˜ var=</td><td>str ä¸å˜ var=$str</td></tr><tr><td>var=${str:=expr}</td><td>str=expr var=expr</td><td>str=expr var=expr</td><td>str ä¸å˜ var=$str</td></tr><tr><td>var=${str?expr}</td><td>expr è¾“å‡ºè‡³ stderr</td><td>var=</td><td>var=$str</td></tr><tr><td>var=${str:?expr}</td><td>expr è¾“å‡ºè‡³ stderr</td><td>expr è¾“å‡ºè‡³ stderr</td><td>var=$str</td></tr></tbody></table><h3 id="åˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å«å­ä¸²"><a href="#åˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å«å­ä¸²" class="headerlink" title="åˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å«å­ä¸²"></a>åˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ˜¯å¦åŒ…å«å­ä¸²</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡ ** åŒ¹é…</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$&#123;var&#125;</span>"</span> == *<span class="string">"<span class="variable">$&#123;sub_string&#125;</span>"</span>* ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">'%s\n'</span> <span class="string">"sub_string is in var."</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é€šè¿‡ bash å†…ç½®çš„ =~ åˆ¤æ–­</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$&#123;sub_string&#125;</span>"</span> =~ <span class="string">"<span class="variable">$&#123;var&#125;</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">'%s\n'</span> <span class="string">"sub_string is in var."</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><h3 id="å®‰è£…-docker-ce"><a href="#å®‰è£…-docker-ce" class="headerlink" title="å®‰è£… docker-ce"></a>å®‰è£… docker-ce</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl -fsSL https://get.docker.com -o get-docker.sh</span><br><span class="line">$ bash get-docker.sh --mirror Aliyun</span><br></pre></td></tr></table></figure><p>å¦å¤–å¯é€šè¿‡ä¼ å…¥ DRY_RUN çš„å‚æ•°æ¥è¾“å‡ºé™…ä¼šæ‰§è¡Œçš„å†…å®¹ï¼Œè¿™ä¸ªè¾“å‡ºçš„å†…å®¹å¯ä»¥ç”¨æ¥é…ç½® docker-ce çš„æºï¼Œè€Œä¸å®‰è£… dockerã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ DRY_RUN=1 sh ./get-docker.sh --mirror Aliyun &gt; install.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># Executing docker install script, commit: 7cae5f8b0decc17d6571f9f52eb840fbc13b2737</span></span><br><span class="line">apt-get update -qq &gt;/dev/null</span><br><span class="line">DEBIAN_FRONTEND=noninteractive apt-get install -y -qq apt-transport-https ca-certificates curl &gt;/dev/null</span><br><span class="line">curl -fsSL <span class="string">"https://mirrors.aliyun.com/docker-ce/linux/debian/gpg"</span> | apt-key add -qq - &gt;/dev/null</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/debian buster stable"</span> &gt; /etc/apt/sources.list.d/docker.list</span><br><span class="line">apt-get update -qq &gt;/dev/null</span><br><span class="line">apt-get install -y -qq --no-install-recommends docker-ce &gt;/dev/null</span><br><span class="line">DEBIAN_FRONTEND=noninteractive apt-get install -y -qq docker-ce-rootless-extras &gt;/dev/null</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…-helm"><a href="#å®‰è£…-helm" class="headerlink" title="å®‰è£… helm"></a>å®‰è£… helm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…-docker-compose"><a href="#å®‰è£…-docker-compose" class="headerlink" title="å®‰è£… docker-compose"></a>å®‰è£… docker-compose</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl -L <span class="string">"https://github.com/docker/compose/releases/download/1.29.2/docker-compose-<span class="variable">$(uname -s)</span>-<span class="variable">$(uname -m)</span>"</span> -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"></span><br><span class="line">$ chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure><h2 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h2><h3 id="åŒ¹é…è¡Œçš„ä¸‹ä¸€è¡Œæ’å…¥"><a href="#åŒ¹é…è¡Œçš„ä¸‹ä¸€è¡Œæ’å…¥" class="headerlink" title="åŒ¹é…è¡Œçš„ä¸‹ä¸€è¡Œæ’å…¥"></a>åŒ¹é…è¡Œçš„ä¸‹ä¸€è¡Œæ’å…¥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i <span class="string">"/kube-node/a <span class="variable">$&#123;ip&#125;</span>"</span> <span class="built_in">test</span></span><br></pre></td></tr></table></figure><h3 id="è¾“å‡ºä¸¤ä¸ªåŒ¹é…è¡Œä¹‹é—´çš„å†…å®¹"><a href="#è¾“å‡ºä¸¤ä¸ªåŒ¹é…è¡Œä¹‹é—´çš„å†…å®¹" class="headerlink" title="è¾“å‡ºä¸¤ä¸ªåŒ¹é…è¡Œä¹‹é—´çš„å†…å®¹"></a>è¾“å‡ºä¸¤ä¸ªåŒ¹é…è¡Œä¹‹é—´çš„å†…å®¹</h3><p>åœ¨ä¸ä½¿ç”¨ yq æˆ–è€… jq çš„æƒ…å†µä¸‹ï¼Œéœ€è¦è¾“å‡º <code>downloads</code> åˆ—è¡¨ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œå³ <code>download:</code> å’Œ <code>download_defaults:</code>ä¹‹é—´çš„å†…å®¹</p><ul><li><a href="https://github.com/kubernetes-sigs/kubespray/blob/master/roles/download/defaults/main.yml" target="_blank" rel="noopener">download.yml</a></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dashboard_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_image_repo &#125;&#125;</span>/kubernetesui/dashboard-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">dashboard_image_tag:</span> <span class="string">"v2.2.0"</span></span><br><span class="line"><span class="attr">dashboard_metrics_scraper_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_image_repo &#125;&#125;</span>/kubernetesui/metrics-scraper"</span></span><br><span class="line"><span class="attr">dashboard_metrics_scraper_tag:</span> <span class="string">"v1.0.6"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">downloads:</span></span><br><span class="line">  <span class="attr">dashboard:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="string">"<span class="template-variable">&#123;&#123; dashboard_enabled &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">container:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; dashboard_image_repo &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="string">"<span class="template-variable">&#123;&#123; dashboard_image_tag &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">sha256:</span> <span class="string">"<span class="template-variable">&#123;&#123; dashboard_digest_checksum|default(None) &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">groups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube_control_plane</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">dashboard_metrics_scrapper:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="string">"<span class="template-variable">&#123;&#123; dashboard_enabled &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">container:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; dashboard_metrics_scraper_repo &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="string">"<span class="template-variable">&#123;&#123; dashboard_metrics_scraper_tag &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">sha256:</span> <span class="string">"<span class="template-variable">&#123;&#123; dashboard_digest_checksum|default(None) &#125;&#125;</span>"</span></span><br><span class="line">    <span class="attr">groups:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube_control_plane</span></span><br><span class="line"></span><br><span class="line"><span class="attr">download_defaults:</span></span><br><span class="line">  <span class="attr">container:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">file:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">None</span></span><br></pre></td></tr></table></figure><p>å¯ä½¿ç”¨ sed çš„æ–¹å¼è¿›è¡ŒåŒ¹é…è¾“å‡º <code>sed -n &#39;/$VAR1/,/$VAR2/p&#39;</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sed -n <span class="string">'/^downloads:/,/download_defaults:/p'</span></span><br></pre></td></tr></table></figure><h3 id="å¥‡å¶è¡Œåˆå¹¶"><a href="#å¥‡å¶è¡Œåˆå¹¶" class="headerlink" title="å¥‡å¶è¡Œåˆå¹¶"></a>å¥‡å¶è¡Œåˆå¹¶</h3><p>æ¥ç€ä¸Šä¸€ä¸ªé—®é¢˜ï¼Œé€šè¿‡ <code>sed -n &quot;s/repo: //p;s/tag: //p&quot;</code> åŒ¹é…å‡ºé•œåƒçš„ repo å’Œ tagï¼Œä½†ä¸€ä¸ªå®Œæ•´çš„é•œåƒçš„æ ¼å¼æ˜¯ <code>repo:tag</code>ï¼Œå› æ­¤éœ€è¦å°† repo å’Œ tag è¡Œè¿›è¡Œåˆå¹¶ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; dashboard_image_repo &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">tag:</span> <span class="string">"<span class="template-variable">&#123;&#123; dashboard_image_tag &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; dashboard_metrics_scraper_repo &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">tag:</span> <span class="string">"<span class="template-variable">&#123;&#123; dashboard_metrics_scraper_tag &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><p>å¯ä½¿ç”¨ <code>sed &#39;N;s#\n# #g&#39;</code> è¿›è¡Œå¥‡å¶è¡Œåˆå¹¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -n <span class="string">'/^downloads:/,/download_defaults:/p'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">| sed -n <span class="string">"s/repo: //p;s/tag: //p"</span> | tr -d <span class="string">' '</span> | sed <span class="string">'s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> \</span><br><span class="line">| sed <span class="string">'N;s#\n# #g'</span> | tr <span class="string">' '</span> <span class="string">':'</span> | sed <span class="string">'s/^/echo /g'</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/generate.sh</span><br></pre></td></tr></table></figure><h3 id="å»é™¤æ¢è¡Œç¬¦"><a href="#å»é™¤æ¢è¡Œç¬¦" class="headerlink" title="å»é™¤æ¢è¡Œç¬¦"></a>å»é™¤æ¢è¡Œç¬¦</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">':a;N;$!ba;s/\n/ /g'</span></span><br></pre></td></tr></table></figure><h2 id="grep-egrep"><a href="#grep-egrep" class="headerlink" title="grep/egrep"></a>grep/egrep</h2><h3 id="ç»Ÿè®¡åŒ¹é…è¡Œè¡Œæ•°"><a href="#ç»Ÿè®¡åŒ¹é…è¡Œè¡Œæ•°" class="headerlink" title="ç»Ÿè®¡åŒ¹é…è¡Œè¡Œæ•°"></a>ç»Ÿè®¡åŒ¹é…è¡Œè¡Œæ•°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ lsof -i | grep sshd | wc -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># grep é€šè¿‡ -c å‚æ•°å³å¯ç»Ÿè®¡åŒ¹é…è¡Œï¼Œä¸éœ€è¦ä½¿ç”¨ wc æ¥ç»Ÿè®¡</span></span><br><span class="line">$ lsof -i | grep -c sshd</span><br></pre></td></tr></table></figure><h3 id="åŒ¹é…-IPv4-åœ°å€"><a href="#åŒ¹é…-IPv4-åœ°å€" class="headerlink" title="åŒ¹é… IPv4 åœ°å€"></a>åŒ¹é… IPv4 åœ°å€</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ egrep --only-matching -E <span class="string">'([[:digit:]]&#123;1,3&#125;\.)&#123;3&#125;[[:digit:]]&#123;1,3&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h2><h3 id="å°†é•œåƒæ„å»ºåˆ°æœ¬åœ°ç›®å½•"><a href="#å°†é•œåƒæ„å»ºåˆ°æœ¬åœ°ç›®å½•" class="headerlink" title="å°†é•œåƒæ„å»ºåˆ°æœ¬åœ°ç›®å½•"></a>å°†é•œåƒæ„å»ºåˆ°æœ¬åœ°ç›®å½•</h3><p>å’Œ <code>FROM scratch</code>æ­é…èµ·æ¥ä½¿ç”¨ï¼Œå°±å¯ä»¥å°†æ„å»ºäº§ç‰© build åˆ°æœ¬åœ°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ DOCKER_BUILDKIT=1 docker build -o <span class="built_in">type</span>=<span class="built_in">local</span>,dest=<span class="variable">$PWD</span> -f Dockerfile .</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ä½¿ç”¨ Dockerfile æ„å»º skopeo é™æ€é“¾æ¥æ–‡ä»¶</p><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nixos/nix:<span class="number">2.3</span>.<span class="number">11</span> as builder</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /build</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> nix build -f nix</span></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /build/result/bin/skopeo /skopeo</span></span><br></pre></td></tr></table></figure><ul><li>build</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DOCKER_BUILDKIT=1 docker build -o <span class="built_in">type</span>=<span class="built_in">local</span>,dest=<span class="variable">$PWD</span> .</span><br></pre></td></tr></table></figure><h2 id="kubectl"><a href="#kubectl" class="headerlink" title="kubectl"></a>kubectl</h2><ul><li>è·å–é›†ç¾¤ä¸­æ‰€æœ‰ pod è¿è¡Œéœ€è¦çš„é•œåƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -A -o=custom-columns=<span class="string">'IMAGE:spec.containers[*].image'</span> | tr <span class="string">','</span> <span class="string">'\n'</span> | sort -u</span><br></pre></td></tr></table></figure><ul><li>è·å–æ‰€æœ‰ namespace çš„ events æ—¥å¿—å¹¶æŒ‰ç…§æ—¶é—´æˆ³æ’åº</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get events --all-namespaces -o wide --sort-by=.metadata.creationTimestamp</span><br></pre></td></tr></table></figure><ul><li>å¯¼å‡ºä¸€ä¸ª namespaces ä¸‹æ‰€æœ‰ pod çš„æ—¥å¿—</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -n kube-system | awk <span class="string">'&#123;print $1&#125;'</span> | xargs -L1 -I &#123;&#125; bash -c <span class="string">"kubectl -n kube-system logs &#123;&#125; &gt; &#123;&#125;.log"</span></span><br></pre></td></tr></table></figure><ul><li>å¯¼å‡º k8s ç»„ä»¶çš„ pod æ—¥å¿—</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -n kube-system | grep -E <span class="string">"kube-apiserver|kube-controller|kube-proxy|kube-scheduler|coredns"</span> | awk <span class="string">'&#123;print $1&#125;'</span> | xargs -L1 -I &#123;&#125; sh -c <span class="string">"kubectl -n kube-system logs &#123;&#125; &gt; &#123;&#125;.log"</span></span><br></pre></td></tr></table></figure><ul><li>è·å–é›†ç¾¤ä¸­èŠ‚ç‚¹çš„ IP</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes -o jsonpath=<span class="string">'&#123; $.items[*].status.addresses[?(@.type=="InternalIP")].address &#125;'</span></span><br></pre></td></tr></table></figure><ul><li>è·å–æ‰€æœ‰ Pod çš„ IP</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -o jsonpath=<span class="string">'&#123; $.items[*].status.podIP &#125;'</span></span><br></pre></td></tr></table></figure><ul><li>è·å–æ‰€æœ‰ node èŠ‚ç‚¹çš„å­ç½‘ä¿¡æ¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes -o jsonpath=<span class="string">'&#123;.items[*].spec.podCIDR&#125;'</span></span><br></pre></td></tr></table></figure><ul><li>è·å–æ‰€æœ‰ service çš„ IP</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get svc --no-headers --all-namespaces -o jsonpath=<span class="string">'&#123;$.items[*].spec.clusterIP&#125;'</span></span><br></pre></td></tr></table></figure><ul><li>æ ¹æ® CPU/RAM å ç”¨æ’åº</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cpu</span></span><br><span class="line">kubectl top pods --all-namespaces | sort --reverse --key 3 --numeric</span><br><span class="line"><span class="comment"># memory</span></span><br><span class="line">kubectl top pods --all-namespaces | sort --reverse --key 4 --numeric</span><br></pre></td></tr></table></figure><h2 id="yq-jq"><a href="#yq-jq" class="headerlink" title="yq/jq"></a>yq/jq</h2><h3 id="yq-æ ¹æ®æŸä¸ª-key-è·å–æŸä¸ª-value"><a href="#yq-æ ¹æ®æŸä¸ª-key-è·å–æŸä¸ª-value" class="headerlink" title="yq æ ¹æ®æŸä¸ª key è·å–æŸä¸ª value"></a>yq æ ¹æ®æŸä¸ª key è·å–æŸä¸ª value</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker registry for offline resources</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">docker.io/library/registry</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/registry</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># helm chartmuseum for offline resources</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">ghcr.io/helm/chartmuseum</span></span><br><span class="line">  <span class="attr">dest:</span> <span class="string">library/chartmuseum</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yq <span class="built_in">eval</span> <span class="string">'.[]|select(.dest=="library/chartmuseum") | .src'</span> images_origin.yaml</span><br></pre></td></tr></table></figure><h3 id="æ›¿æ¢æ•°ç»„ä¸­çš„å…ƒç´ "><a href="#æ›¿æ¢æ•°ç»„ä¸­çš„å…ƒç´ " class="headerlink" title="æ›¿æ¢æ•°ç»„ä¸­çš„å…ƒç´ "></a>æ›¿æ¢æ•°ç»„ä¸­çš„å…ƒç´ </h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.1'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.20-alpine</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./resources/nginx:/usr/share/nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">443</span><span class="string">:443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5000</span><span class="string">:5000</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx_http_port=<span class="string">"<span class="variable">$&#123;NGINX_HTTP_PORT&#125;</span>:8080"</span> yq <span class="built_in">eval</span> --inplace <span class="string">'.services.nginx.ports[0] = strenv(nginx_http_port)'</span> <span class="variable">$&#123;COMPOSE_YAML_FILE&#125;</span></span><br><span class="line">registry_https_port=<span class="string">"<span class="variable">$&#123;REGISTRY_HTTPS_PORT&#125;</span>:443"</span> yq <span class="built_in">eval</span> --inplace <span class="string">'.services.nginx.ports[1] = strenv(registry_https_port)'</span> <span class="variable">$&#123;COMPOSE_YAML_FILE&#125;</span></span><br><span class="line">registry_push_port=<span class="string">"<span class="variable">$&#123;REGISTRY_PUSH_PORT&#125;</span>:5000"</span> yq <span class="built_in">eval</span> --inplace <span class="string">'.services.nginx.ports[2] = strenv(registry_push_port)'</span> <span class="variable">$&#123;COMPOSE_YAML_FILE&#125;</span></span><br></pre></td></tr></table></figure><h3 id="jq-éå†-json-æ•°ç»„-åˆ—è¡¨å…ƒç´ "><a href="#jq-éå†-json-æ•°ç»„-åˆ—è¡¨å…ƒç´ " class="headerlink" title="jq éå† json æ•°ç»„/åˆ—è¡¨å…ƒç´ "></a>jq éå† json æ•°ç»„/åˆ—è¡¨å…ƒç´ </h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> pmd_name <span class="keyword">in</span> $(kubectl <span class="variable">$&#123;KUBECONFIG_ARG&#125;</span> get cpm --no-headers | cut -d <span class="string">' '</span> -f1); <span class="keyword">do</span></span><br><span class="line">    CPMD_NAME=<span class="string">"<span class="variable">$&#123;pmd_name&#125;</span>"</span></span><br><span class="line">    JSON=<span class="string">"<span class="variable">$&#123;RCTL_TMP_PATH&#125;</span>/<span class="variable">$&#123;pmd_name&#125;</span>.json"</span></span><br><span class="line">    kubectl <span class="variable">$&#123;KUBECONFIG_ARG&#125;</span> get cpm <span class="variable">$&#123;pmd_name&#125;</span> -o jsonpath=<span class="string">'&#123;.spec&#125;'</span> &gt; <span class="variable">$&#123;JSON&#125;</span></span><br><span class="line">    ((moudles_num=$(jq <span class="string">'.modules|length'</span> <span class="variable">$&#123;JSON&#125;</span>)-1))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> $(seq 0 <span class="variable">$&#123;moudles_num&#125;</span>); <span class="keyword">do</span></span><br><span class="line">        ((addons_num=$(jq <span class="string">".modules[<span class="variable">$&#123;i&#125;</span>].addons|length"</span> <span class="variable">$&#123;JSON&#125;</span>)-1))</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> $(seq 0 <span class="variable">$&#123;addons_num&#125;</span>); <span class="keyword">do</span></span><br><span class="line">            addon_name=$(jq -r <span class="string">".modules[<span class="variable">$&#123;i&#125;</span>].addons[<span class="variable">$&#123;j&#125;</span>].name"</span> <span class="variable">$&#123;JSON&#125;</span>)</span><br><span class="line">            <span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;CHART_NAME&#125;</span>"</span> = <span class="string">"<span class="variable">$&#123;addon_name&#125;</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">                PATCH_DATA=$(jq -c <span class="string">".modules[<span class="variable">$&#123;i&#125;</span>].addons[<span class="variable">$&#123;j&#125;</span>].version = \"<span class="variable">$&#123;VERSION&#125;</span>\""</span> <span class="variable">$&#123;JSON&#125;</span>)</span><br><span class="line">                <span class="built_in">break</span> 3</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="other"><a href="#other" class="headerlink" title="other"></a>other</h2><h3 id="åˆ¤æ–­ä¸¤ä¸ªç‰ˆæœ¬å·å¤§å°"><a href="#åˆ¤æ–­ä¸¤ä¸ªç‰ˆæœ¬å·å¤§å°" class="headerlink" title="åˆ¤æ–­ä¸¤ä¸ªç‰ˆæœ¬å·å¤§å°"></a>åˆ¤æ–­ä¸¤ä¸ªç‰ˆæœ¬å·å¤§å°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">printf</span> <span class="string">"%s\\n%s\\n"</span> v1.21 <span class="variable">$&#123;kube_version%.*&#125;</span> | sort --check=quiet --version-sort; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -n <span class="variable">$&#123;coredns_version&#125;</span>;<span class="keyword">else</span> <span class="built_in">echo</span> -n <span class="variable">$&#123;coredns_version/v/&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹-x509-è¯ä¹¦"><a href="#æŸ¥çœ‹-x509-è¯ä¹¦" class="headerlink" title="æŸ¥çœ‹ x509 è¯ä¹¦"></a>æŸ¥çœ‹ x509 è¯ä¹¦</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl x509 -noout -text -<span class="keyword">in</span> ca.cert</span><br></pre></td></tr></table></figure><h3 id="è·å–æ–‡ä»¶å¤§å°"><a href="#è·å–æ–‡ä»¶å¤§å°" class="headerlink" title="è·å–æ–‡ä»¶å¤§å°"></a>è·å–æ–‡ä»¶å¤§å°</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">stat</span> -c <span class="string">'%s'</span> file</span><br></pre></td></tr></table></figure><h3 id="è·å–æœ¬æœº-IP"><a href="#è·å–æœ¬æœº-IP" class="headerlink" title="è·å–æœ¬æœº IP"></a>è·å–æœ¬æœº IP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ip r get 1 | awk <span class="string">'NR==1 &#123;print $NF&#125;'</span></span><br><span class="line">$ ip r get 1 | sed <span class="string">"s/uid.*//g"</span> | awk <span class="string">'NR==1 &#123;print $NF&#125;'</span></span><br></pre></td></tr></table></figure><h2 id="function"><a href="#function" class="headerlink" title="function"></a>function</h2><p>ä¸€äº› shell è„šæœ¬ä¸­å¸¸ç”¨çš„å‡½æ•°</p><h3 id="tar-è¿›åº¦æ¡"><a href="#tar-è¿›åº¦æ¡" class="headerlink" title="tar è¿›åº¦æ¡"></a>tar è¿›åº¦æ¡</h3><p>é¿å… tar è§£å‹æ–‡ä»¶çš„æ—¶å€™æ±¡æŸ“ç»ˆç«¯ï¼Œå»ºè®®ä½¿ç”¨è¿›åº¦æ¡çš„æ–¹å¼å±•ç¤ºè§£å‹è¿‡ç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">untar</span></span>() &#123;</span><br><span class="line">  file_size=$(<span class="built_in">stat</span> -c <span class="string">'%s'</span> <span class="variable">$1</span>)</span><br><span class="line">  block_size=$(expr <span class="variable">$file_size</span> / 51200); block_size=$(expr <span class="variable">$block_size</span> + 1)</span><br><span class="line">  tar_info=<span class="string">"Untar <span class="variable">$1</span> progress:"</span></span><br><span class="line">  tar --blocking-factor=<span class="variable">$block_size</span> --checkpoint=1 --checkpoint-action=ttyout=<span class="string">"<span class="variable">$&#123;tar_info&#125;</span> %u%  \r"</span> -xpf <span class="variable">$1</span> -C <span class="variable">$2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ­£åˆ™åŒ¹é…-IP"><a href="#æ­£åˆ™åŒ¹é…-IP" class="headerlink" title="æ­£åˆ™åŒ¹é… IP"></a>æ­£åˆ™åŒ¹é… IP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># regular match ip</span></span><br><span class="line"><span class="function"><span class="title">match_ip</span></span>() &#123;</span><br><span class="line">    <span class="built_in">local</span> INPUT_IPS=$*</span><br><span class="line">    <span class="built_in">local</span> IPS=<span class="string">""</span></span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">echo</span> <span class="variable">$&#123;INPUT_IPS&#125;</span> | egrep --only-matching -E <span class="string">'([[:digit:]]&#123;1,3&#125;\.)&#123;3&#125;[[:digit:]]&#123;1,3&#125;-[[:digit:]]&#123;1,3&#125;'</span> &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        IPS=<span class="string">"<span class="variable">$(echo $&#123;INPUT_IPS&#125; | egrep --only-matching -E '([[:digit:]]&#123;1,3&#125;\.)</span>&#123;3&#125;[[:digit:]]&#123;1,3&#125;' | tr '\n' ' ')"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        ip_prefix=<span class="string">"<span class="variable">$(echo $&#123;INPUT_IPS&#125; | egrep --only-matching -E '([[:digit:]]&#123;1,3&#125;\.)</span>&#123;3&#125;[[:digit:]]&#123;1,3&#125;-[[:digit:]]&#123;1,3&#125;' | cut -d '.' -f1-3)"</span></span><br><span class="line">        ip_suffix=<span class="string">"<span class="variable">$(echo $&#123;INPUT_IPS&#125; | egrep --only-matching -E '([[:digit:]]&#123;1,3&#125;\.)</span>&#123;3&#125;[[:digit:]]&#123;1,3&#125;-[[:digit:]]&#123;1,3&#125;' | cut -d '.' -f4 | tr '-' ' ')"</span></span><br><span class="line">        <span class="keyword">for</span> suffix <span class="keyword">in</span> $(seq <span class="variable">$&#123;ip_suffix&#125;</span>); <span class="keyword">do</span> IPS=<span class="string">"<span class="variable">$&#123;IPS&#125;</span> <span class="variable">$&#123;ip_prefix&#125;</span>.<span class="variable">$&#123;suffix&#125;</span>"</span>; <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="variable">$&#123;IPS&#125;</span> | egrep --only-matching -E <span class="string">'([[:digit:]]&#123;1,3&#125;\.)&#123;3&#125;[[:digit:]]&#123;1,3&#125;'</span> | tr <span class="string">'\n'</span> <span class="string">' '</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ssh-ç™»å½•é…ç½®"><a href="#ssh-ç™»å½•é…ç½®" class="headerlink" title="ssh ç™»å½•é…ç½®"></a>ssh ç™»å½•é…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Host *</span><br><span class="line">  StrictHostKeyChecking no</span><br><span class="line">    UserKnownHostsFile=/dev/null</span><br><span class="line">    ForwardAgent yes</span><br><span class="line">    ServerAliveInterval 10</span><br><span class="line">    ServerAliveCountMax 10000</span><br><span class="line">    TCPKeepAlive no</span><br><span class="line">    ControlMaster auto</span><br><span class="line">    ControlPath ~/.ssh/session/%h-%p-%r</span><br><span class="line">    ControlPersist 12h</span><br><span class="line"></span><br><span class="line">Host nas</span><br><span class="line">    Hostname 172.20.0.10</span><br><span class="line">    Port 22</span><br><span class="line">    User root</span><br><span class="line">    IdentityFile ~/.ssh/<span class="built_in">local</span>-node.pem</span><br><span class="line"></span><br><span class="line">Host 172.20.0.*</span><br><span class="line">    Port 22</span><br><span class="line">    User root</span><br><span class="line">    IdentityFile ~/.ssh/<span class="built_in">local</span>-node.pem</span><br><span class="line"></span><br><span class="line">Host *github.com</span><br><span class="line">    Hostname github.com</span><br><span class="line">    User git</span><br><span class="line">    IdentityFile ~/.ssh/github_muzi.pem</span><br></pre></td></tr></table></figure><ul><li><code>StrictHostKeyChecking no</code>ï¼šç•¥è¿‡ HostKey æ£€æŸ¥ï¼Œé¿å…å‡ºç° <a href="https://superuser.com/questions/125324/how-can-i-avoid-sshs-host-verification-for-known-hosts" target="_blank" rel="noopener">How can I avoid SSHâ€™s host verification for known hosts?</a></li></ul><h3 id="ssh-å¯†ç ç™»å½•"><a href="#ssh-å¯†ç ç™»å½•" class="headerlink" title="ssh å¯†ç ç™»å½•"></a>ssh å¯†ç ç™»å½•</h3><p>æ—¥å¸¸å·¥ä½œä¸­å¸¸å¸¸éœ€è¦ ssh ç™»å½•åˆ°æœºæˆ¿çš„ä¸€äº›è™šæ‹Ÿæœºä¸Šï¼Œåˆå› ä¸ºä¸åŒçš„æœºå™¨å¯†ç ä¸åŒï¼Œé‚ä½¿ç”¨è¯¥è„šæœ¬ ssh ç™»å½•åˆ°èŠ‚ç‚¹ä¸Šã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">IP=<span class="variable">$&#123;1&#125;</span></span><br><span class="line">CMD=<span class="variable">$&#123;2&#125;</span></span><br><span class="line">USER=root</span><br><span class="line">ARGS=<span class="string">"-o StrictHostKeyChecking=no -o ControlMaster=auto -o ControlPersist=12h -o ConnectionAttempts=100"</span></span><br><span class="line">PASSWORDS=<span class="string">"admin123456 test123456 centos1234"</span></span><br><span class="line">ssh-keygen -R <span class="variable">$&#123;1&#125;</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">PASS=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> pass <span class="keyword">in</span> <span class="variable">$&#123;PASSWORDS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> sshpass -p <span class="variable">$&#123;pass&#125;</span> ssh <span class="variable">$&#123;ARGS&#125;</span> <span class="variable">$&#123;USER&#125;</span>@<span class="variable">$&#123;IP&#125;</span> <span class="string">"hostname"</span>; <span class="keyword">then</span> PASS=<span class="variable">$&#123;pass&#125;</span>; <span class="built_in">break</span> ; <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">sshpass -p <span class="variable">$&#123;PASS&#125;</span> ssh <span class="variable">$&#123;ARGS&#125;</span> <span class="variable">$&#123;USER&#125;</span>@<span class="variable">$&#123;IP&#125;</span> <span class="variable">$&#123;CMD&#125;</span></span><br><span class="line"><span class="built_in">exit</span> 0</span><br></pre></td></tr></table></figure><h3 id="è„šæœ¬ä¸­ç»Ÿè®¡å‡½æ•°è€—æ—¶"><a href="#è„šæœ¬ä¸­ç»Ÿè®¡å‡½æ•°è€—æ—¶" class="headerlink" title="è„šæœ¬ä¸­ç»Ÿè®¡å‡½æ•°è€—æ—¶"></a>è„šæœ¬ä¸­ç»Ÿè®¡å‡½æ•°è€—æ—¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">reset_global_timer</span></span>() &#123;</span><br><span class="line"><span class="built_in">export</span> SEC0=$(date --utc +%s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">reset_function_timer</span></span>()&#123;</span><br><span class="line">    <span class="built_in">export</span> SEC1=$(date --utc +%s)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">running_time()</span><br><span class="line">&#123;</span><br><span class="line">    SEC2=$(date --utc +%s); DIFFSEC=$((<span class="variable">$&#123;SEC2&#125;</span> - <span class="variable">$&#123;SEC1&#125;</span>)); <span class="built_in">printf</span> <span class="string">"\nSection Time: <span class="variable">$(date +%H:%M:%S -ud @$&#123;DIFFSEC&#125;)</span>\n"</span></span><br><span class="line">    SEC2=$(date --utc +%s); DIFFSEC=$((<span class="variable">$&#123;SEC2&#125;</span> - <span class="variable">$&#123;SEC0&#125;</span>)); <span class="built_in">printf</span> <span class="string">"Elapsed Time: <span class="variable">$(date +%H:%M:%S -ud @$&#123;DIFFSEC&#125;)</span>\n\n"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">reset_global_timer</span><br><span class="line">reset_function_timer</span><br><span class="line">running_time</span><br></pre></td></tr></table></figure><h2 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h2><ul><li>dpkg è·å–ç³»ç»Ÿå·²ç»å®‰è£…çš„åŒ…</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dpkg-query -W -f=<span class="string">'$&#123;binary:Package&#125;=$&#123;Version&#125;\n'</span></span><br></pre></td></tr></table></figure><ul><li>è·å– CPU æ¶æ„</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ARCHITECTURE=$(uname -m)</span><br><span class="line">host_architecture=$(dpkg --<span class="built_in">print</span>-architecture)</span><br></pre></td></tr></table></figure><h3 id="æ›¿æ¢ç³»ç»Ÿ-OS-æº"><a href="#æ›¿æ¢ç³»ç»Ÿ-OS-æº" class="headerlink" title="æ›¿æ¢ç³»ç»Ÿ OS æº"></a>æ›¿æ¢ç³»ç»Ÿ OS æº</h3><p> ä½¿ç”¨åä¸ºäº‘ yum æº</p><ul><li>CentOS 7</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.huaweicloud.com/repository/conf/CentOS-7-anon.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…åä¸ºäº‘ EPEL æº</span></span><br><span class="line">yum install epel-release -y</span><br><span class="line">sed -i <span class="string">"s/#baseurl/baseurl/g"</span> /etc/yum.repos.d/epel.repo</span><br><span class="line">sed -i <span class="string">"s/metalink/#metalink/g"</span> /etc/yum.repos.d/epel.repo</span><br><span class="line">sed -i <span class="string">"s@https\?://download.fedoraproject.org/pub@https://mirrors.huaweicloud.com@g"</span> /etc/yum.repos.d/epel.repo</span><br></pre></td></tr></table></figure><ul><li>Debian</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i <span class="string">'s/deb.debian.org/mirrors.huaweicloud.com/g'</span> /etc/apt/sources.list</span><br><span class="line">$ sed -i <span class="string">'s|security.debian.org/debian-security|mirrors.huaweicloud.com/debian-security|g'</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><ul><li>Ubuntu</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i <span class="string">'s/archive.ubuntu.com/mirrors.huaweicloud.com/g'</span> /etc/apt/sources.list</span><br></pre></td></tr></table></figure><ul><li>Alpine</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">"http://mirrors.huaweicloud.com/alpine/latest-stable/main/"</span> &gt; /etc/apk/repositories</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"http://mirrors.huaweicloud.com/alpine/latest-stable/community/"</span> &gt;&gt; /etc/apk/repositories</span><br></pre></td></tr></table></figure><h3 id="CA-è¯ä¹¦ä¿¡ä»»"><a href="#CA-è¯ä¹¦ä¿¡ä»»" class="headerlink" title="CA è¯ä¹¦ä¿¡ä»»"></a>CA è¯ä¹¦ä¿¡ä»»</h3><ul><li>CentOS</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ update-ca-trust force-enable</span><br><span class="line">$ cp domain.crt /etc/pki/ca-trust/<span class="built_in">source</span>/anchors/domain.crt</span><br><span class="line">$ update-ca-trust</span><br></pre></td></tr></table></figure><ul><li>Debian</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cp domain.crt /usr/share/ca-certificates/domain.crt</span><br><span class="line">$ <span class="built_in">echo</span> domain.crt &gt;&gt; /etc/ca-certificates.conf</span><br><span class="line">$ update-ca-certificates</span><br></pre></td></tr></table></figure><ul><li>Ubuntu</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cp domain.crt /usr/<span class="built_in">local</span>/share/ca-certificates/domain.crt</span><br><span class="line">$ update-ca-certificates</span><br></pre></td></tr></table></figure><h3 id="Git-æ“ä½œ"><a href="#Git-æ“ä½œ" class="headerlink" title="Git æ“ä½œ"></a>Git æ“ä½œ</h3><h4 id="ä¿®æ”¹å†å²-commit-ä¿¡æ¯"><a href="#ä¿®æ”¹å†å²-commit-ä¿¡æ¯" class="headerlink" title="ä¿®æ”¹å†å² commit ä¿¡æ¯"></a>ä¿®æ”¹å†å² commit ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">git filter-branch --env-filter <span class="string">'</span></span><br><span class="line"><span class="string">OLD_EMAIL="github-actions@github.com"</span></span><br><span class="line"><span class="string">CORRECT_NAME="github-actions"</span></span><br><span class="line"><span class="string">CORRECT_EMAIL="41898282+github-actions[bot]@users.noreply.github.com"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if [ "$GIT_COMMITTER_EMAIL" = "$OLD_EMAIL" ]</span></span><br><span class="line"><span class="string">then</span></span><br><span class="line"><span class="string">    export GIT_COMMITTER_NAME="$CORRECT_NAME"</span></span><br><span class="line"><span class="string">    export GIT_COMMITTER_EMAIL="$CORRECT_EMAIL"</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">if [ "$GIT_AUTHOR_EMAIL" = "$OLD_EMAIL" ]</span></span><br><span class="line"><span class="string">then</span></span><br><span class="line"><span class="string">    export GIT_AUTHOR_NAME="$CORRECT_NAME"</span></span><br><span class="line"><span class="string">    export GIT_AUTHOR_EMAIL="$CORRECT_EMAIL"</span></span><br><span class="line"><span class="string">fi</span></span><br><span class="line"><span class="string">'</span> --tag-name-filter cat -- --branches --tags</span><br></pre></td></tr></table></figure><h4 id="è·å–å½“å‰-repo-çš„æœ€æ–°-git-tag"><a href="#è·å–å½“å‰-repo-çš„æœ€æ–°-git-tag" class="headerlink" title="è·å–å½“å‰ repo çš„æœ€æ–° git tag"></a>è·å–å½“å‰ repo çš„æœ€æ–° git tag</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git describe --tags --always</span><br></pre></td></tr></table></figure><h4 id="åˆ é™¤-remote-repo-ä¸­çš„-tag"><a href="#åˆ é™¤-remote-repo-ä¸­çš„-tag" class="headerlink" title="åˆ é™¤ remote repo ä¸­çš„ tag"></a>åˆ é™¤ remote repo ä¸­çš„ tag</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git push --delete origin tag_name</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰</span></span><br><span class="line">$ git tag -l | xargs -L1 -I &#123;&#125; git push --delete origin &#123;&#125;</span><br></pre></td></tr></table></figure><h2 id="govc"><a href="#govc" class="headerlink" title="govc"></a>govc</h2><ul><li>æ‰¹é‡è¿˜åŸå¿«ç…§</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">: <span class="variable">$&#123;SP_NAME:="init"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;NODES:="kube-control-01 kube-control-02 kube-control-03 kube-node-01"&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> <span class="variable">$&#123;NODES&#125;</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> govc snapshot.revert -vm <span class="variable">$&#123;node&#125;</span> <span class="variable">$&#123;SP_NAME&#125;</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;node&#125;</span> snapshot revert successfully"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  govc vm.info <span class="variable">$&#123;node&#125;</span> | grep -q poweredOn || govc vm.power -on <span class="variable">$&#123;node&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="æœªå®Œå¾…ç»­"><a href="#æœªå®Œå¾…ç»­" class="headerlink" title="æœªå®Œå¾…ç»­"></a>æœªå®Œå¾…ç»­</h2><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://github.com/dylanaraps/pure-bash-bible" target="_blank" rel="noopener">pure-bash-bible</a></li><li><a href="http://cn.linux.vbird.org/linux_basic/0320bash_2.php#variable_other" target="_blank" rel="noopener">é¸Ÿå“¥ Linux ç§æˆ¿èœ</a></li><li><a href="https://mozillazg.com/2018/01/jq-use-examples-cookbook.html" target="_blank" rel="noopener">jq å¸¸ç”¨æ“ä½œ</a></li><li><a href="https://lyyao09.github.io/2019/08/02/tools/The-usage-of-yq-read-write/" target="_blank" rel="noopener">YAMLå¤„ç†å·¥å…·yqä¹‹è¯»å†™ç¯‡</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;å¶ç„¶é—´çœ‹åˆ°äº† &lt;a
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="Linux" scheme="https://blog.k8s.li/tags/Linux/"/>
    
      <category term="Bash" scheme="https://blog.k8s.li/tags/Bash/"/>
    
      <category term="shell" scheme="https://blog.k8s.li/tags/shell/"/>
    
  </entry>
  
  <entry>
    <title>é•œåƒæ¬è¿å·¥ skopeo</title>
    <link href="https://blog.k8s.li/skopeo.html"/>
    <id>https://blog.k8s.li/skopeo.html</id>
    <published>2021-07-10T16:00:00.000Z</published>
    <updated>2021-07-10T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ¬ç –å·¥å…·"><a href="#æ¬ç –å·¥å…·" class="headerlink" title="æ¬ç –å·¥å…·"></a>æ¬ç –å·¥å…·</h2><p>ä½œä¸ºå…¬å¸å†…éƒ¨ PaaS toB äº§å“çš„æ‰“åŒ…å‘å¸ƒäººå‘˜ï¼Œå®¹å™¨é•œåƒå¯¹æˆ‘ä»¬æ‰“å·¥äººè€Œè¨€å°±åƒæ˜¯å·¥åœ°ä¸Šçš„ç –å¤´ ğŸ§±ï¼Œè€Œæˆ‘çš„ä¸€éƒ¨åˆ†å·¥ä½œå°±æ˜¯å°†è¿™äº›ç –å¤´åœ¨å„ä¸ªä»“åº“ä¹‹é—´æ¬æ¥æ¬å»ï¼Œæœ€ç»ˆå°†è¿™äº›ç –å¤´æ‰“åŒ…æ”¾åœ¨äº§å“çš„å®‰è£…åŒ…ä¸­ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„ PaaS äº§å“å®‰è£…åŒ…ã€‚</p><p>è€Œé€‰æ‹©ä¸€ä¸ªå¥½çš„æ¬ç –å·¥å…·èƒ½èŠ‚çœæˆ‘ä»¬å¤§é‡çš„äººåŠ›å’Œ CPU ç®—åŠ›ï¼Œåœ¨æ—¥å¸¸å¼€å‘å·¥ä½œä¸­æˆ‘ä»¬ä¹Ÿå¸¸å¸¸ä¼šä½¿ç”¨ docker push å’Œ docker pull æ¥æ¨æ‹‰é•œåƒï¼Œè™½ç„¶æœ¬åœ° push &amp;&amp; pull ä¸€ä¸ªé•œåƒå¹¶ä¸æ˜¯ä»€ä¹ˆéš¾äº‹å„¿ï¼Œä½†å¯¹äºä¸€äº›ç‰¹å®šçš„åœºæ™¯å¦‚äº§å“æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­ï¼Œè¿˜ç»§ç»­å†ä½¿ç”¨ docker è¿™ä¸ªç¬¨é‡çš„å·¥å…·æ¥æ¨æ‹‰é•œåƒçš„è¯ï¼Œæ˜¯ååˆ†è´¹æ—¶è´¹åŠ›çš„ï¼Œå…·ä½“çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„åšå®¢ã€Š<a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”ŸğŸ¤”</a>ã€‹ã€‚</p><p>è‡ªä» Kubernetes 1.20 ä¹‹åï¼ŒK8s ç¤¾åŒºä¹Ÿå¼ƒç”¨äº† Docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œdocker-shim ç›¸å…³çš„ä»£ç å°†åœ¨ kubelet ä¸­ä¸å†ç»´æŠ¤ï¼Œéšåæ€èµ·äº†ä¸€æ³¢å» docker çš„æµªæ½®ã€‚é‚£ä¹ˆç°åœ¨æœ‰æ²¡æœ‰ä¸€ç§èƒ½å¤Ÿæ›¿ä»£ docker-cli çš„å·¥å…·æ¥ä¼ è¾“é•œåƒå‘¢ï¼Ÿä»Šå¤©ç»™å¤§å®¶ä»‹ç»ä¸€ä¸ªèƒ½å¤Ÿå®Œå…¨æ›¿ä»£ docker-cli æ¥æ¬è¿é•œåƒçš„å·¥å…·ï¼šskopeoã€‚è¿™ç©æ„å„¿æ¯” docker-cli é«˜åˆ°ä¸çŸ¥é“å“ªé‡Œå»äº†ï¼</p><h2 id="å®‰è£…æ–¹å¼"><a href="#å®‰è£…æ–¹å¼" class="headerlink" title="å®‰è£…æ–¹å¼"></a>å®‰è£…æ–¹å¼</h2><p>å®˜æ–¹çš„å®‰è£…æ–¹å¼å‚è€ƒå®‰è£…æ–‡æ¡£å³å¯ <a href="https://github.com/containers/skopeo/blob/main/install.md" target="_blank" rel="noopener">https://github.com/containers/skopeo/blob/main/install.md</a></p><p>ç”±äºæˆ‘çš„ VPS æœºå™¨æ˜¯ Ubuntu 1804 çš„ OS ï¼Œé…ç½® apt æºå¹¶æ²¡æˆåŠŸï¼Œå½“åœºç¿»è½¦ã€‚åœ¨å®˜æ–¹çš„ Makefile é‡Œåªæä¾›äº†åœ¨ nixos ä¸‹æ„å»ºé™æ€è¿æ¥çš„æ–¹å¼ï¼Œå…¶ä»– Linux å‘ç›¸ç‰ˆåªèƒ½ä½¿ç”¨åŠ¨æ€é“¾æ¥çš„æ–¹å¼æ¥ç¼–è¯‘ã€‚ä½†åŠ¨æ€é“¾æ¥çš„æ–¹å¼é€šç”¨æ€§å¤ªå·®ï¼Œæ¯”å¦‚åœ¨ ubuntu 18.04 ä¸Šä½¿ç”¨åŠ¨æ€é“¾æ¥ç¼–è¯‘çš„ skopeo åªèƒ½åœ¨ ubuntu ä¸Šä½¿ç”¨ï¼Œæ— æ³•åœ¨ centos ä¸Šä½¿ç”¨ã€‚å› ä¸ºåŠ¨æ€é“¾æ¥ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶åœ¨ä¸åŒçš„ OS ä¸Šæ‰€ä¾èµ–çš„åº“æ–‡ä»¶æ˜¯ä¸ä¸€æ ·çš„ã€‚æ‰€ä»¥è¿˜æ˜¯å¦è¾Ÿè¹Šå¾„ï¼Œäº²è‡ªç¼–è¯‘ä¸€ä¸ªã€‚</p><ul><li>Clone repo</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ SKOPEO_VERSION=v1.3.0</span><br><span class="line">$ git <span class="built_in">clone</span> --branch <span class="variable">$&#123;SKOPEO_VERSION&#125;</span> https://github.com/containers/skopeo</span><br><span class="line">$ <span class="built_in">cd</span> skopeo</span><br></pre></td></tr></table></figure><ul><li>docker  build</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ BUILD_IMAGE=nixos/nix:2.3.12</span><br><span class="line">$ docker run --rm -t -v <span class="variable">$PWD</span>:/build <span class="variable">$&#123;BUILD_IMAGE&#125;</span> \</span><br><span class="line">sh -c <span class="string">"cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo"</span></span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ <code>nixos/nix:2.3.12</code> æ¥æ„å»ºé™æ€é“¾æ¥çš„ skopeo äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦å®Œæ•´æ„å»º skopeo æ‰€æœ‰çš„ä¾èµ–ï¼Œæ¯”å¦‚ glibcã€systemdã€golang ç­‰ï¼Œæ‰€ä»¥æ„å»ºååˆ†è€—æ—¶ã€‚åœ¨ä¸€å° 4c8G çš„æœºå™¨ä¸Šæ„å»ºç”¨äº†å°†è¿‘åŠä¸ªå°æ—¶ï¼Œåœ¨ GitHub Action çš„ runner æœºå™¨ä¸Šæ„å»ºéœ€è¦å°†è¿‘<a href="https://github.com/k8sli/skopeo/actions/runs/1010266302" target="_blank" rel="noopener">ä¸€ä¸ªå°æ—¶</a>ã€‚</li></ul><p><img src="https://p.k8s.li/skopeo-github-action-build.png" alt="img"></p><ul><li>ä½¿ç”¨ GitHub Action æ„å»º</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">build</span> <span class="string">static</span> <span class="string">binary</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">push</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">BUILD_IMAGE:</span> <span class="string">"nixos/nix:2.3.12"</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">static</span> <span class="string">binary</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">docker</span> <span class="string">run</span> <span class="string">--rm</span> <span class="string">-t</span> <span class="string">-v</span> <span class="string">$PWD:/build</span> <span class="string">--name</span> <span class="string">builder</span> <span class="string">$&#123;BUILD_IMAGE&#125;</span> <span class="string">\</span></span><br><span class="line">          <span class="string">sh</span> <span class="string">-c</span> <span class="string">"cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo-linux-amd64"</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">softprops/action-gh-release@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">files:</span> <span class="string">skopeo-linux-amd64</span></span><br></pre></td></tr></table></figure><p>ä¸è¿‡ä¹Ÿå¯ä»¥ä½¿ç”¨ go build çš„æ–¹å¼æ„å»ºå‡ºé™æ€é“¾æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¦‚ä¸‹ <code>Dockerfile</code></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.14</span>-buster as skopeo-builder</span><br><span class="line"><span class="keyword">ARG</span> SKOPEO_VERSION=v1.<span class="number">2.0</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install -y -qq libdevmapper-dev libgpgme11-dev</span></span><br><span class="line"><span class="keyword">ENV</span> GOPATH=/</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /src/github.com/containers/skopeo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> git <span class="built_in">clone</span> --branch <span class="variable">$&#123;SKOPEO_VERSION&#125;</span> https://github.com/containers/skopeo . \</span></span><br><span class="line"><span class="bash"> &amp;&amp; CGO_ENABLE=0 GO111MODULE=on go build -mod=vendor <span class="string">"-buildmode=pie"</span> -ldflags <span class="string">'-extldflags "-static"'</span> -gcflags <span class="string">""</span> \</span></span><br><span class="line"><span class="bash"> -tags <span class="string">"exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp"</span> -o /usr/bin/skopeo ./cmd/skopeo</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.12</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=skopeo-builder /usr/bin/skopeo /usr/bin/skopeo</span></span><br><span class="line"><span class="comment"># FROM scratch</span></span><br><span class="line"><span class="comment"># COPY --from=skopeo-builder /usr/bin/skopeo /skopeo</span></span><br><span class="line"><span class="comment"># DOCKER_BUILDKIT=1 docker build -o type=local,dest=$PWD -f Dockerfile .</span></span><br></pre></td></tr></table></figure><ul><li><a href="https://github.com/k8sli/skopeo/blob/main/.github/workflows/build-static-binary.yaml" target="_blank" rel="noopener">é€šè¿‡ GitHub Action æ¥ç¼–è¯‘</a></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">build</span> <span class="string">static</span> <span class="string">binary</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'v*'</span></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">BUILDER_IMAGE:</span> <span class="string">ghcr.io/k8sli/nixos-nix:v2.3.12</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build-linux-amd64:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">ARCH:</span> <span class="string">"amd64"</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">QEMU</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/setup-qemu-action@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Docker</span> <span class="string">Buildx</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/setup-buildx-action@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">skopeo</span> <span class="string">binary</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">DIGEST=$(skopeo</span> <span class="string">--insecure-policy</span> <span class="string">--override-arch</span> <span class="string">$&#123;ARCH&#125;</span> <span class="string">inspect</span> <span class="string">docker://$&#123;BUILDER_IMAGE&#125;</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">'.Digest'</span><span class="string">)</span></span><br><span class="line">          <span class="string">docker</span> <span class="string">run</span> <span class="string">--rm</span> <span class="string">-t</span> <span class="string">-v</span> <span class="string">$PWD:/build</span> <span class="string">$&#123;BUILDER_IMAGE&#125;@$&#123;DIGEST&#125;</span> <span class="string">\</span></span><br><span class="line">          <span class="string">sh</span> <span class="string">-c</span> <span class="string">"cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo-linux-$<span class="template-variable">&#123;&#123; env.ARCH &#125;&#125;</span>"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">binary</span> <span class="string">artifact</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/upload-artifact@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">skopeo-linux-$&#123;&#123;</span> <span class="string">env.ARCH</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">skopeo-binary-$&#123;&#123;</span> <span class="string">github.run_number</span> <span class="string">&#125;&#125;-$&#123;&#123;</span> <span class="string">env.ARCH</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">build-linux-arm64:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">ARCH:</span> <span class="string">"arm64"</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">QEMU</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/setup-qemu-action@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Docker</span> <span class="string">Buildx</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/setup-buildx-action@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">skopeo</span> <span class="string">binary</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">DIGEST=$(skopeo</span> <span class="string">--insecure-policy</span> <span class="string">--override-arch</span> <span class="string">$&#123;ARCH&#125;</span> <span class="string">inspect</span> <span class="string">docker://$&#123;BUILDER_IMAGE&#125;</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">'.Digest'</span><span class="string">)</span></span><br><span class="line">          <span class="string">docker</span> <span class="string">run</span> <span class="string">--rm</span> <span class="string">-t</span> <span class="string">-v</span> <span class="string">$PWD:/build</span> <span class="string">$&#123;BUILDER_IMAGE&#125;@$&#123;DIGEST&#125;</span> <span class="string">\</span></span><br><span class="line">          <span class="string">sh</span> <span class="string">-c</span> <span class="string">"cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo-linux-$<span class="template-variable">&#123;&#123; env.ARCH &#125;&#125;</span>"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">binary</span> <span class="string">artifact</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/upload-artifact@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">skopeo-linux-$&#123;&#123;</span> <span class="string">env.ARCH</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">skopeo-binary-$&#123;&#123;</span> <span class="string">github.run_number</span> <span class="string">&#125;&#125;-$&#123;&#123;</span> <span class="string">env.ARCH</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">release:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">[build-linux-amd64,build-linux-arm64]</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Download</span> <span class="string">artifact</span> <span class="string">from</span> <span class="string">build-linux-amd64</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/download-artifact@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">skopeo-binary-$&#123;&#123;</span> <span class="string">github.run_number</span> <span class="string">&#125;&#125;-amd64</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Download</span> <span class="string">artifact</span> <span class="string">from</span> <span class="string">build-linux-arm64</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/download-artifact@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">skopeo-binary-$&#123;&#123;</span> <span class="string">github.run_number</span> <span class="string">&#125;&#125;-arm64</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span> <span class="string">and</span> <span class="string">upload</span> <span class="string">binary</span> <span class="string">files</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">softprops/action-gh-release@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">files:</span> <span class="string">|</span></span><br><span class="line">            <span class="string">skopeo-linux-amd64</span></span><br><span class="line">            <span class="string">skopeo-linux-arm64</span></span><br></pre></td></tr></table></figure><h2 id="ä¸Šæ‰‹ä½“éªŒ"><a href="#ä¸Šæ‰‹ä½“éªŒ" class="headerlink" title="ä¸Šæ‰‹ä½“éªŒ"></a>ä¸Šæ‰‹ä½“éªŒ</h2><ul><li>copyï¼šå¤åˆ¶ä¸€ä¸ªé•œåƒä» A åˆ° Bï¼Œè¿™é‡Œçš„ A å’Œ B å¯ä»¥ä¸ºæœ¬åœ° docker é•œåƒæˆ–è€… registry ä¸Šçš„é•œåƒï¼›</li><li>inspectï¼šæŸ¥çœ‹ä¸€ä¸ªé•œåƒçš„ manifest æˆ–è€… image config è¯¦ç»†ä¿¡æ¯ï¼›</li><li>deleteï¼šåˆ é™¤ä¸€ä¸ªé•œåƒ tagï¼Œå¯ä»¥æ˜¯æœ¬åœ° docker é•œåƒæˆ–è€… registry ä¸Šçš„é•œåƒï¼›</li><li>list-tagsï¼šåˆ—å‡ºä¸€ä¸ª registry ä¸ŠæŸä¸ªé•œåƒçš„æ‰€æœ‰ tagï¼›</li><li>loginï¼šç™»å½•åˆ°æŸä¸ª registryï¼Œå’Œ docker login ç±»ä¼¼ï¼›</li><li>logoutï¼š é€€å‡ºå·²ç»ç™»å½•åˆ°æŸä¸ª registry çš„ auth ä¿¡æ¯ï¼Œå’Œ docker logout ç±»ä¼¼ï¼›</li><li>manifest-digestï¼šå‡ åœˆä¸€ä¸ªæ–‡ä»¶çš„ sha256sum å€¼ï¼›</li><li>standalone-signã€standalone-verify è¿™ä¸¤ä¸ªæ˜¯å’Œé•œåƒåŠ å¯†ç›¸å…³çš„ï¼Œä½¿ç”¨çš„ä¸æ˜¯å¾ˆå¤šï¼›</li><li>syncï¼šåŒæ­¥ä¸€ä¸ªé•œåƒä» A åˆ° Bï¼Œæ„Ÿè§‰å’Œ copy ä¸€æ ·ï¼Œä½† sync æ”¯æŒçš„å‚æ•°æ›´å¤šï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ï¼›</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">completion             generate the autocompletion script <span class="keyword">for</span> the specified shell</span><br><span class="line">copy                   Copy an IMAGE-NAME from one location to another</span><br><span class="line">delete                 Delete image IMAGE-NAME</span><br><span class="line"><span class="built_in">help</span>                   Help about any <span class="built_in">command</span></span><br><span class="line">inspect                Inspect image IMAGE-NAME</span><br><span class="line">list-tags              List tags <span class="keyword">in</span> the transport/repository specified by the REPOSITORY-NAME</span><br><span class="line">login                  Login to a container registry</span><br><span class="line"><span class="built_in">logout</span>                 Logout of a container registry</span><br><span class="line">manifest-digest        Compute a manifest digest of a file</span><br><span class="line">standalone-sign        Create a signature using <span class="built_in">local</span> files</span><br><span class="line">standalone-verify      Verify a signature using <span class="built_in">local</span> files</span><br><span class="line">sync                   Synchronize one or more images</span><br></pre></td></tr></table></figure><h3 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h3><ul><li>command-timeoutï¼šå‘½ä»¤è¶…æ—¶æ—¶é—´</li><li>debugï¼šå¼€å¯ debug æ¨¡å¼ï¼Œè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—</li><li>insecure-policyï¼š ä½¿ç”¨éå®‰å…¨çš„ policyï¼Œå¦‚æœæ²¡æœ‰é…ç½® policy çš„è¯ï¼Œéœ€è¦åŠ ä¸Šè¯¥å‚æ•°</li><li>override-archï¼šå¤„ç†é•œåƒæ—¶è¦†ç›–å®¢æˆ·ç«¯ CPU ä½“ç³»æ¶æ„ï¼Œå¦‚åœ¨ amd64 çš„æœºå™¨ä¸Šç”¨ skopeo å¤„ç† arm64 çš„é•œåƒ</li><li>override-osï¼š å¤„ç†é•œåƒæ—¶è¦†ç›–å®¢æˆ·ç«¯ OS</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Flags:</span><br><span class="line">      --<span class="built_in">command</span>-timeout duration   timeout <span class="keyword">for</span> the <span class="built_in">command</span> execution</span><br><span class="line">      --debug                      <span class="built_in">enable</span> debug output</span><br><span class="line">  -h, --<span class="built_in">help</span>                       <span class="built_in">help</span> <span class="keyword">for</span> skopeo</span><br><span class="line">      --insecure-policy            run the tool without any policy check</span><br><span class="line">      --override-arch ARCH         use ARCH instead of the architecture of the machine <span class="keyword">for</span> choosing images</span><br><span class="line">      --override-os OS             use OS instead of the running OS <span class="keyword">for</span> choosing images</span><br><span class="line">      --override-variant VARIANT   use VARIANT instead of the running architecture variant <span class="keyword">for</span> choosing images</span><br><span class="line">      --policy string              Path to a trust policy file</span><br><span class="line">      --registries.d DIR           use registry configuration files <span class="keyword">in</span> DIR (e.g. <span class="keyword">for</span> container signature storage)</span><br><span class="line">      --tmpdir string              directory used to store temporary files</span><br><span class="line">  -v, --version                    Version <span class="keyword">for</span> Skopeo</span><br></pre></td></tr></table></figure><p>ä¸€ä¸‹æ˜¯æˆ‘åœ¨ä½¿ç”¨ skopeo å‘½ä»¤æ—¶å€™çš„ä¸€äº›å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--insecure-policy --src-tls-verify=<span class="literal">false</span> --dest-tls-verify=<span class="literal">false</span></span><br></pre></td></tr></table></figure><h3 id="IMAGE-NAMES-é•œåƒæ ¼å¼ğŸ¤”ï¸"><a href="#IMAGE-NAMES-é•œåƒæ ¼å¼ğŸ¤”ï¸" class="headerlink" title="IMAGE NAMES é•œåƒæ ¼å¼ğŸ¤”ï¸"></a>IMAGE NAMES é•œåƒæ ¼å¼ğŸ¤”ï¸</h3><p>åœ¨ä½¿ç”¨ skopeo ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“åœ¨å‘½ä»¤è¡Œä¸­é•œåƒçš„æ ¼å¼ï¼Œä¸‹é¢æ˜¯å®˜æ–¹è¯¦ç»†çš„æ–‡æ¡£æ ¼å¼ã€‚æ— è®ºæˆ‘ä»¬çš„ src é•œåƒè¿˜æ˜¯ dest é•œåƒéƒ½è¦æ»¡è¶³ä»¥ä¸‹æ ¼å¼æ‰å¯ä»¥ã€‚</p><blockquote><p>Most commands refer to container images, using a <em>transport<em><code>:</code></em>details</em> format. The following formats are supported:</p></blockquote><blockquote><p><strong>containers-storage:*</strong>docker-reference* An image located in a local containers/storage image store. Both the location and image store are specified in /etc/containers/storage.conf. (Backend for Podman, CRI-O, Buildah and friends)</p></blockquote><blockquote><p><strong>dir:*</strong>path* An existing local directory <em>path</em> storing the manifest, layer tarballs and signatures as individual files. This is a non-standardized format, primarily useful for debugging or noninvasive container inspection.</p></blockquote><blockquote><p><strong>docker://*</strong>docker-reference* An image in a registry implementing the â€œDocker Registry HTTP API V2â€. By default, uses the authorization state in either <code>$XDG_RUNTIME_DIR/containers/auth.json</code>, which is set using <code>(skopeo login)</code>. If the authorization state is not found there, <code>$HOME/.docker/config.json</code> is checked, which is set using <code>(docker login)</code>.</p></blockquote><blockquote><p><strong>docker-archive:*</strong>path<strong>***[</strong>:<em>*<em>docker-reference</em>] An image is stored in the <code>docker save</code> formatted file. *docker-reference</em> is only used when creating such a file, and it must not contain a digest.</p></blockquote><blockquote><p><strong>docker-daemon:*</strong>docker-reference* An image <em>docker-reference</em> stored in the docker daemon internal storage. <em>docker-reference</em> must contain either a tag or a digest. Alternatively, when reading images, the format can be docker-daemon:algo:digest (an image ID).</p></blockquote><blockquote><p><strong>oci:*</strong>path<strong><em>:</em></strong>tag* An image <em>tag</em> in a directory compliant with â€œOpen Container Image Layout Specificationâ€ at <em>path</em>.</p></blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™å‡ ç§é•œåƒçš„åå­—ï¼Œå¯¹åº”ç€é•œåƒå­˜åœ¨çš„æ–¹å¼ï¼Œä¸åŒå­˜åœ¨çš„æ–¹å¼å¯¹é•œåƒçš„ layer å¤„ç†çš„æ–¹å¼ä¹Ÿä¸ä¸€æ ·ï¼Œæ¯”å¦‚ <code>docker://</code> è¿™ç§æ–¹å¼æ˜¯å­˜åœ¨ registry ä¸Šçš„ï¼Œ<code>docker-daemon:</code> æ˜¯å­˜åœ¨æœ¬åœ° docker pull ä¸‹æ¥çš„ï¼Œå†æ¯”å¦‚ <code>docker-archive</code> æ˜¯é€šè¿‡ docker save å‡ºæ¥çš„é•œåƒã€‚åŒä¸€ä¸ªé•œåƒæœ‰è¿™å‡ ç§å­˜åœ¨çš„æ–¹å¼å°±åƒæ°´åˆ†å­æœ‰æ°”ä½“ã€æ¶²ä½“ã€å›ºä½“ä¸€æ ·ã€‚å¯ä»¥è¿™æ ·å»ç†è§£ï¼Œä»–ä»¬è¡¨è¿°çš„éƒ½æ˜¯åŒä¸€ä¸ªé•œåƒï¼Œåªä¸è¿‡æ˜¯å­˜åœ¨çš„æ–¹å¼ä¸ä¸€æ ·è€Œå·²ã€‚</p><p>IMAGE NAMESï¼ˆé•œåƒæ ¼å¼ï¼‰examplecontainers-storage:containers-storage:dir:dir:/PATHdocker://docker://k8s.gcr.io/kube-apiserver:v1.17.5docker-daemon:docker-daemon:alpine:latestdocker-archive:docker-archive:alpine.tar (docker save)oci:oci:alpine:latest</p><h3 id="skopeo-login"><a href="#skopeo-login" class="headerlink" title="skopeo login"></a>skopeo login</h3><p>åœ¨ä½¿ç”¨ skopeo å‰å¦‚æœ src æˆ– dest é•œåƒæ˜¯åœ¨ registry ä¸­çš„ï¼Œå¦‚æœé public çš„é•œåƒéœ€è¦ç›¸åº”çš„ auth è®¤è¯ï¼Œå¯ä»¥ä½¿ç”¨ docker login æˆ–è€… skopeo login çš„æ–¹å¼ç™»å½•åˆ° registryï¼Œç”Ÿæˆå¦‚ä¸‹æ ¼å¼çš„ registry ç™»å½•é…ç½®æ–‡ä»¶ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ jq "." ~/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"auths"</span>: &#123;</span><br><span class="line">    <span class="attr">"https://index.docker.io/v1/"</span>: &#123;</span><br><span class="line">      <span class="attr">"auth"</span>: <span class="string">"d2sdwdaqWMasss7bSVlJFpmQE43Sw=="</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"HttpHeaders"</span>: &#123;</span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"Docker-Client/19.03.5 (linux)"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"experimental"</span>: <span class="string">"enabled"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="skopeo-copy"><a href="#skopeo-copy" class="headerlink" title="skopeo copy"></a>skopeo copy</h3><blockquote><p>Copy an IMAGE-NAME from one location to another</p></blockquote><blockquote><p>å°†ä¸€ä¸ªé•œåƒä» A å¤åˆ¶åˆ° B</p></blockquote><p>æ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡Œçš„ location å°±æ˜¯æŒ‡çš„ä¸Šé¢æåˆ°çš„ <code>IMAGE NAMES</code> ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>skopeo copy src dest</code> å¯ä»¥æœ‰6*6=36 ç§ç»„åˆï¼æ¯”å¦‚æˆ‘å¯ä»¥å°†ä¸€ä¸ªé•œåƒä»ä¸€ä¸ª registry å¤åˆ¶åˆ°å¦ä¸€ä¸ª registryï¼š<code>skopeo copy docker://IMAGE_NAME docker://IMAGE_NAME</code>ï¼›æˆ–è€…å°†ä¸€ä¸ªé•œåƒä» registry ä¸­å¤åˆ¶åˆ°ä¸€ä¸ªæœ¬åœ°ç›®å½• <code>skopeo copy docker://k8s.gcr.io/pause:3.3 dir:pause:3.3</code></p><ul><li>ä» regsitry A åˆ° registry B å¤åˆ¶é•œåƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy docker://k8s.gcr.io/kube-apiserver:v1.17.5 docker://hub.k8s.li/kube-apiserver:v1.17.5 --dest-authfile /root/.docker/config.json</span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob 597de8ba0c30 <span class="keyword">done</span></span><br><span class="line">Copying blob e13a88fa950c <span class="keyword">done</span></span><br><span class="line">Copying config f640481f6d <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br></pre></td></tr></table></figure><blockquote><p>skopeo è¾“å‡ºçš„æ—¥å¿—æ˜¾ç¤ºæ˜¯ Copying blob 597de8ba0c30 done.å¯ä»¥çœ‹åˆ° skopeo æ˜¯ç›´æ¥ä» registry ä¸­ copy é•œåƒ layer çš„ blob æ–‡ä»¶ï¼Œä¼ è¾“æ˜¯é•œåƒåœ¨ registry ä¸­å­˜å‚¨çš„åŸå§‹æ ¼å¼ã€‚</p></blockquote><ul><li>å°†é•œåƒä» registry å¤åˆ¶åˆ°æœ¬åœ°ç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy docker://k8s.gcr.io/pause:3.3 dir:pause:3.3</span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob aeab776c4837 <span class="keyword">done</span></span><br><span class="line">Copying config 0184c1613d <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line">$ tree pause:3.3</span><br><span class="line">pause:3.3</span><br><span class="line">â”œâ”€â”€ 0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da</span><br><span class="line">â”œâ”€â”€ aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b</span><br><span class="line">â”œâ”€â”€ manifest.json</span><br><span class="line">â””â”€â”€ version</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é•œåƒçš„ manifest æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">$ jq <span class="string">'.'</span> pause:3.3/manifest.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"schemaVersion"</span>: 2,</span><br><span class="line">  <span class="string">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">  <span class="string">"config"</span>: &#123;</span><br><span class="line">    <span class="string">"mediaType"</span>: <span class="string">"application/vnd.docker.container.image.v1+json"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 743,</span><br><span class="line">    <span class="string">"digest"</span>: <span class="string">"sha256:0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"layers"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"mediaType"</span>: <span class="string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span>,</span><br><span class="line">      <span class="string">"size"</span>: 296517,</span><br><span class="line">      <span class="string">"digest"</span>: <span class="string">"sha256:aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ¹æ® manifest æ–‡ä»¶æŸ¥çœ‹é•œåƒçš„ image config æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">$ jq <span class="string">'.'</span> pause:3.3/0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">  <span class="string">"config"</span>: &#123;</span><br><span class="line">    <span class="string">"Env"</span>: [</span><br><span class="line">      <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"Entrypoint"</span>: [</span><br><span class="line">      <span class="string">"/pause"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"WorkingDir"</span>: <span class="string">"/"</span>,</span><br><span class="line">    <span class="string">"OnBuild"</span>: null</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"created"</span>: <span class="string">"2020-05-02T09:46:29.068489061Z"</span>,</span><br><span class="line">  <span class="string">"history"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"created"</span>: <span class="string">"2020-05-02T09:46:29.068489061Z"</span>,</span><br><span class="line">      <span class="string">"created_by"</span>: <span class="string">"ARG ARCH"</span>,</span><br><span class="line">      <span class="string">"comment"</span>: <span class="string">"buildkit.dockerfile.v0"</span>,</span><br><span class="line">      <span class="string">"empty_layer"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"created"</span>: <span class="string">"2020-05-02T09:46:29.068489061Z"</span>,</span><br><span class="line">      <span class="string">"created_by"</span>: <span class="string">"ADD bin/pause-amd64 /pause # buildkit"</span>,</span><br><span class="line">      <span class="string">"comment"</span>: <span class="string">"buildkit.dockerfile.v0"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"created"</span>: <span class="string">"2020-05-02T09:46:29.068489061Z"</span>,</span><br><span class="line">      <span class="string">"created_by"</span>: <span class="string">"ENTRYPOINT [\"/pause\"]"</span>,</span><br><span class="line">      <span class="string">"comment"</span>: <span class="string">"buildkit.dockerfile.v0"</span>,</span><br><span class="line">      <span class="string">"empty_layer"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">  <span class="string">"rootfs"</span>: &#123;</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"layers"</span>,</span><br><span class="line">    <span class="string">"diff_ids"</span>: [</span><br><span class="line">      <span class="string">"sha256:48a5e87615149095fad57d5db80f2cd9728b5562900eccb32842a45e8e8a61ae"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å°†é•œåƒä» registry å¤åˆ¶åˆ°æœ¬åœ°ç›®å½•ï¼Œä»¥ OCI æ ¼å¼ä¿å­˜</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy docker://k8s.gcr.io/pause:3.3 oci:images</span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob aeab776c4837 <span class="keyword">done</span></span><br><span class="line">Copying config fa5df7713f <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line">$ tree images</span><br><span class="line">images</span><br><span class="line">â”œâ”€â”€ blobs</span><br><span class="line">â”‚   â””â”€â”€ sha256</span><br><span class="line">â”‚       â”œâ”€â”€ 3450ba84b8fbfd12cbf58710c0b5678f4311a888d4d5c42b053faefa1af4f8be</span><br><span class="line">â”‚       â”œâ”€â”€ aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b</span><br><span class="line">â”‚       â””â”€â”€ fa5df7713fc78f96e377d236b353d33815073105bbacd381e50705e576ce4da5</span><br><span class="line">â”œâ”€â”€ index.json</span><br><span class="line">â””â”€â”€ oci-layout</span><br></pre></td></tr></table></figure><ul><li>æ›¿ä»£ docker push åŠŸèƒ½ï¼Œå°†é•œåƒä» docker æœ¬åœ°å­˜å‚¨ push åˆ° registry ä¸­</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy docker-daemon:alpine:3.12 docker://hub.k8s.li/library/alpine:3.12</span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob 32f366d666a5 <span class="keyword">done</span></span><br><span class="line">Copying config 13621d1b12 <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br></pre></td></tr></table></figure><h3 id="skopeo-sync"><a href="#skopeo-sync" class="headerlink" title="skopeo sync"></a>skopeo sync</h3><p>Skopeo sync çš„åŠŸèƒ½åŸºæœ¬ä¸Šç­‰åŒäºé˜¿é‡Œäº‘çš„ <a href="https://github.com/AliyunContainerService/image-syncer" target="_blank" rel="noopener">image-syncer</a> å·¥å…·ï¼Œä¸è¿‡ä¸ªäººè§‰ç€ skopeo è¦æ¯” image-syncer æ›´å¼ºå¤§ï¼Œçµæ´»æ€§æ›´å¼ºä¸€äº›ï¼Œæ±è¿˜åœ¨ä½¿ç”¨ image-syncer çš„è¯ï¼Œå¼ºçƒˆå»ºè®®ä½ ä½¿ç”¨ skopeo sync æ›¿ä»£å®ƒğŸ˜‚ã€‚</p><ul><li>skopeo sync é•œåƒåŒæ­¥æ–‡ä»¶</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">registry.example.com:</span></span><br><span class="line">    <span class="attr">images:</span></span><br><span class="line">        <span class="attr">busybox:</span> <span class="string">[]</span></span><br><span class="line">        <span class="attr">redis:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"1.0"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"2.0"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"sha256:111111"</span></span><br><span class="line">    <span class="attr">images-by-tag-regex:</span></span><br><span class="line">        <span class="attr">nginx:</span> <span class="string">^1\.13\.[12]-alpine-perl$</span></span><br><span class="line">    <span class="attr">credentials:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">john</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">this</span> <span class="string">is</span> <span class="string">a</span> <span class="string">secret</span></span><br><span class="line">    <span class="attr">tls-verify:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cert-dir:</span> <span class="string">/home/john/certs</span></span><br><span class="line"><span class="attr">quay.io:</span></span><br><span class="line">    <span class="attr">tls-verify:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">images:</span></span><br><span class="line">        <span class="attr">coreos/etcd:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">latest</span></span><br></pre></td></tr></table></figure><ul><li>Image-syncer é•œåƒåŒæ­¥é…ç½®æ–‡ä»¶</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># registry ç™»å½•é…ç½®</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line">    <span class="attr">"quay.io":</span> <span class="string">&#123;</span>        <span class="string">//</span> <span class="string">This</span> <span class="string">"registry"</span> <span class="string">or</span> <span class="string">"registry/namespace"</span> <span class="string">string</span> <span class="string">should</span> <span class="string">be</span> <span class="string">the</span> <span class="string">same</span> <span class="string">as</span> <span class="string">registry</span> <span class="string">or</span> <span class="string">registry/namespace</span> <span class="string">used</span> <span class="string">below</span> <span class="string">in</span> <span class="string">"images"</span> <span class="string">field.</span></span><br><span class="line">                            <span class="string">//</span> <span class="string">The</span> <span class="string">format</span> <span class="string">of</span> <span class="string">"registry/namespace"</span> <span class="string">will</span> <span class="string">be</span> <span class="string">more</span> <span class="string">prior</span> <span class="string">matched</span> <span class="string">than</span> <span class="string">"registry"</span></span><br><span class="line">        <span class="attr">"username":</span> <span class="string">"xxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"password":</span> <span class="string">"xxxxxxxxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"insecure":</span> <span class="literal">true</span>         <span class="string">//</span> <span class="string">"insecure"</span> <span class="string">field</span> <span class="string">needs</span> <span class="string">to</span> <span class="string">be</span> <span class="literal">true</span> <span class="string">if</span> <span class="string">this</span> <span class="string">registry</span> <span class="string">is</span> <span class="string">a</span> <span class="string">http</span> <span class="string">service,</span> <span class="string">default</span> <span class="string">value</span> <span class="string">is</span> <span class="literal">false</span><span class="string">,</span> <span class="string">version</span> <span class="string">of</span> <span class="string">image-syncer</span> <span class="string">need</span> <span class="string">to</span> <span class="string">be</span> <span class="string">later</span> <span class="string">than</span> <span class="string">v1.0.1</span> <span class="string">to</span> <span class="string">support</span> <span class="string">this</span> <span class="string">field</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="attr">"registry.cn-beijing.aliyuncs.com":</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">"username":</span> <span class="string">"xxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"password":</span> <span class="string">"xxxxxxxxx"</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="attr">"registry.hub.docker.com":</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">"username":</span> <span class="string">"xxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"password":</span> <span class="string">"xxxxxxxxxx"</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="attr">"quay.io/coreos":</span> <span class="string">&#123;</span>     <span class="string">//</span> <span class="string">"registry/namespace"</span> <span class="string">format</span> <span class="string">is</span> <span class="string">supported</span> <span class="string">after</span> <span class="string">v1.0.3</span> <span class="string">of</span> <span class="string">image-syncer</span></span><br><span class="line">        <span class="attr">"username":</span> <span class="string">"abc"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"password":</span> <span class="string">"xxxxxxxxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"insecure":</span> <span class="literal">true</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="comment"># é•œåƒé…ç½®</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line">    <span class="attr">"quay.io/coreos/kube-rbac-proxy":</span> <span class="string">"quay.io/ruohe/kube-rbac-proxy"</span><span class="string">,</span></span><br><span class="line">    <span class="string">"xxxx"</span><span class="string">:"xxxxx",</span></span><br><span class="line">    <span class="string">"xxx/xxx/xx:tag1,tag2,tag3"</span><span class="string">:"xxx/xxx/xx"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>å°†é•œä» registry A åŒæ­¥åˆ° registry B</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --src docker --dest docker k8s.gcr.io/pause:3.3 hub.k8s.li</span><br><span class="line">INFO[0000] Tag presence check                            imagename=<span class="string">"k8s.gcr.io/pause:3.3"</span> tagged=<span class="literal">true</span></span><br><span class="line">INFO[0000] Copying image tag 1/1                         from=<span class="string">"docker://k8s.gcr.io/pause:3.3"</span> to=<span class="string">"docker://hub.k8s.li/pause:3.3"</span></span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob aeab776c4837 <span class="keyword">done</span></span><br><span class="line">Copying config 0184c1613d <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line">INFO[0000] Synced 1 images from 1 sources</span><br></pre></td></tr></table></figure><ul><li>å°†ä¸€ä¸ªé•œåƒä» registry ä¸­åŒæ­¥åˆ°æœ¬åœ°ç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --src docker --dest dir k8s.gcr.io/pause:3.3 images</span><br><span class="line">images</span><br><span class="line">â””â”€â”€ pause:3.3</span><br><span class="line">    â”œâ”€â”€ 0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da</span><br><span class="line">    â”œâ”€â”€ aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b</span><br><span class="line">    â”œâ”€â”€ manifest.json</span><br><span class="line">    â””â”€â”€ version</span><br></pre></td></tr></table></figure><ul><li>å°†é•œåƒä»æœ¬åœ°ç›®å½•åŒæ­¥åˆ° registry ä¸­</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --src dir --dest docker images hub.k8s.li</span><br><span class="line">INFO[0000] Copying image ref 1/1                         from=<span class="string">"dir:images/pause:3.3"</span> to=<span class="string">"docker://hub.k8s.li/pause:3.3"</span></span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob aeab776c4837 [--------------------------------------] 0.0b / 0.0b</span><br><span class="line">Copying config 0184c1613d <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line">INFO[0002] Synced 1 images from 1 sources</span><br></pre></td></tr></table></figure><h3 id="skopeo-inspect"><a href="#skopeo-inspect" class="headerlink" title="skopeo inspect"></a>skopeo inspect</h3><p>è¿™ä¸ªå‘½ä»¤å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªé•œåƒçš„ image config æˆ–è€… manifests æ–‡ä»¶ï¼Œå’Œ docker inspect å‘½ä»¤å·®ä¸å¤šã€‚ä¸åŠ  â€“raw å‚æ•°é»˜è®¤æ˜¯æŸ¥çœ‹é•œåƒçš„ image config æ–‡ä»¶ï¼ŒåŠ ä¸Š â€“raw å‚æ•°å°±æ˜¯æŸ¥çœ‹é•œåƒçš„ manifest æ–‡ä»¶ã€‚</p><ul><li>æŸ¥çœ‹ docker æœ¬åœ°å­˜å‚¨ä¸­çš„ä¸€ä¸ªé•œåƒçš„ image config æ–‡ä»¶</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo inspect docker-daemon:alpine:latest</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Name"</span>: <span class="string">"docker.io/library/alpine"</span>,</span><br><span class="line">    <span class="attr">"Digest"</span>: <span class="string">"sha256:ab84514e85b179ff569fd0042969b04f68812f23e187a927cb84664b417e0d3e"</span>,</span><br><span class="line">    <span class="attr">"RepoTags"</span>: [],</span><br><span class="line">    <span class="attr">"Created"</span>: <span class="string">"2021-04-14T19:19:49.594730611Z"</span>,</span><br><span class="line">    <span class="attr">"DockerVersion"</span>: <span class="string">"19.03.12"</span>,</span><br><span class="line">    <span class="attr">"Labels"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"Architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">    <span class="attr">"Os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">    <span class="attr">"Layers"</span>: [</span><br><span class="line">        <span class="string">"sha256:32f366d666a541852cad754ee1cdb53a736110b550f0c2d5a46bc5ba519896b6"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Env"</span>: [</span><br><span class="line">        <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹ registry ä¸­ä¸€ä¸ªé•œåƒçš„ manifests æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥åˆ¤æ–­é•œåƒæ˜¯å¦å­˜åœ¨</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">skopeo inspect docker://alpine:latest --raw | jq '.'</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"manifests"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:1775bebec23e1f3ce486989bfc9ff3c4e951690df84aa9f926497d82f2ffca9d"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:1f66b8f3041ef8575260056dedd437ed94e7bfeea142ee39ff0d795f94ff2287"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"arm"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">        <span class="attr">"variant"</span>: <span class="string">"v6"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:8d99168167baa6a6a0d7851b9684625df9c1455116a9601835c2127df2aaa2f5"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"arm"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">        <span class="attr">"variant"</span>: <span class="string">"v7"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:53b74ddfc6225e3c8cc84d7985d0f34666e4e8b0b6892a9b2ad1f7516bc21b54"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"arm64"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">        <span class="attr">"variant"</span>: <span class="string">"v8"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:52a197664c8ed0b4be6d3b8372f1d21f3204822ba432583644c9ce07f7d6448f"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"386"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:b421672fe4e74a3c7eff2775736e854d69e8d38b2c337063f8699de9c408ddd3"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"ppc64le"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:8a22269106a31264874cc3a719c1e280e76d42dff1fa57bd9c7fe68dab574023"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"s390x"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.list.v2+json"</span>,</span><br><span class="line">  <span class="attr">"schemaVersion"</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="skopeo-delete"><a href="#skopeo-delete" class="headerlink" title="skopeo delete"></a>skopeo delete</h3><p>ä½¿ç”¨è¿™ä¸ªå‘½ä»¤å¯ä»¥åˆ é™¤é•œåƒ tagã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé€šè¿‡  registry API æ¥åˆ é™¤é•œåƒçš„ tag ä»…ä»…æ˜¯åˆ é™¤äº† tag å¯¹ manifests æ–‡ä»¶çš„å¼•ç”¨ï¼Œå¹¶éçœŸæ­£å°†é•œåƒåˆ é™¤æ‰ã€‚å¦‚æœæƒ³è¦åˆ é™¤é•œåƒçš„ layer è¿˜æ˜¯éœ€è¦é€šè¿‡ registry GC çš„æ–¹å¼ï¼Œå¯å‚è€ƒä¹‹å‰å†™è¿‡çš„ä¸€ç¯‡åšå®¢ã€Š<a href="https://blog.k8s.li/registry-gc.html">docker registry GC åŸç†åˆ†æ</a>ã€‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo delete docker:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;pause:3.2 --debug</span><br><span class="line">DEBU[0000] Returning credentials from &#x2F;home&#x2F;release&#x2F;.docker&#x2F;config.json</span><br><span class="line">DEBU[0000] Using registries.d directory &#x2F;etc&#x2F;containers&#x2F;registries.d for sigstore configuration</span><br><span class="line">DEBU[0000]  No signature storage configuration found for hub.k8s.li&#x2F;library&#x2F;pause:3.2</span><br><span class="line">DEBU[0000] Looking for TLS certificates and private keys in &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;hub.k8s.li&#x2F;library</span><br><span class="line">DEBU[0000] Loading registries configuration &quot;&#x2F;etc&#x2F;containers&#x2F;registries.conf&quot;</span><br><span class="line">DEBU[0000] GET https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;</span><br><span class="line">DEBU[0000] Ping https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F; status 401</span><br><span class="line">DEBU[0000] GET https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;library&#x2F;pause&#x2F;manifests&#x2F;3.2</span><br><span class="line">DEBU[0000] DELETE https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;library&#x2F;pause&#x2F;manifests&#x2F;sha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108</span><br></pre></td></tr></table></figure><h3 id="skopeo-list-tags"><a href="#skopeo-list-tags" class="headerlink" title="skopeo list-tags"></a>skopeo list-tags</h3><p>è¿™ä¸ªå‘½ä»¤å¯ç”¨äºåˆ—å‡º registry ä¸Šçš„æŸä¸ªé•œåƒçš„æ‰€æœ‰ tag ï¼Œä½¿ç”¨æ ‡å‡†çš„ registry API æ¥è·å–é•œåƒ tag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo list-tags docker:&#x2F;&#x2F;k8s.gcr.io&#x2F;pause</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Repository&quot;: &quot;k8s.gcr.io&#x2F;pause&quot;,</span><br><span class="line">    &quot;Tags&quot;: [</span><br><span class="line">        &quot;0.8.0&quot;,</span><br><span class="line">        &quot;1.0&quot;,</span><br><span class="line">        &quot;2.0&quot;,</span><br><span class="line">        &quot;3.0&quot;,</span><br><span class="line">        &quot;3.1&quot;,</span><br><span class="line">        &quot;3.2&quot;,</span><br><span class="line">        &quot;3.3&quot;,</span><br><span class="line">        &quot;3.4.1&quot;,</span><br><span class="line">        &quot;3.5&quot;,</span><br><span class="line">        &quot;go&quot;,</span><br><span class="line">        &quot;latest&quot;,</span><br><span class="line">        &quot;test&quot;,</span><br><span class="line">        &quot;test2&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><p>ä¸€ä¸‹ç»™å‡ºå‡ ä¸ª skopeo å·¥å…·çš„æœ€ä½³å®è·µ ğŸ˜Š</p><h3 id="é•œåƒåŒæ­¥"><a href="#é•œåƒåŒæ­¥" class="headerlink" title="é•œåƒåŒæ­¥"></a>é•œåƒåŒæ­¥</h3><p>å‡å¦‚ç»™ä½ ä¸€ä¸ªé•œåƒåˆ—è¡¨ï¼Œå¦‚ <a href="https://github.com/kubesphere/ks-installer/blob/master/scripts/images-list.txtã€‚å¦‚ä½•å°†å®ƒå¿«é€Ÿåœ°ä»ä¸€ä¸ª" target="_blank" rel="noopener">https://github.com/kubesphere/ks-installer/blob/master/scripts/images-list.txtã€‚å¦‚ä½•å°†å®ƒå¿«é€Ÿåœ°ä»ä¸€ä¸ª</a> registry åŒæ­¥åˆ°å¦ä¸€ä¸ª registry ä¸­å‘¢ï¼Ÿè¿˜æ˜¯ skopeo copy èµ°èµ·ï¼</p><ul><li>images-list.txt</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line">##k8s-images</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.19.8</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.19.8</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.19.8</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.19.8</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.19.9</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.19.9</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.19.9</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.19.9</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.18.8</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.18.8</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.18.8</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.18.8</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.17.9</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.17.9</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.17.9</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.17.9</span><br><span class="line">kubesphere&#x2F;pause:3.1</span><br><span class="line">kubesphere&#x2F;pause:3.2</span><br><span class="line">kubesphere&#x2F;etcd:v3.4.13</span><br><span class="line">calico&#x2F;cni:v3.16.3</span><br><span class="line">calico&#x2F;kube-controllers:v3.16.3</span><br><span class="line">calico&#x2F;node:v3.16.3</span><br><span class="line">calico&#x2F;pod2daemon-flexvol:v3.16.3</span><br><span class="line">calico&#x2F;typha:v3.16.3</span><br><span class="line">kubesphere&#x2F;flannel:v0.12.0</span><br><span class="line">coredns&#x2F;coredns:1.6.9</span><br><span class="line">kubesphere&#x2F;k8s-dns-node-cache:1.15.12</span><br><span class="line">openebs&#x2F;provisioner-localpv:2.10.1</span><br><span class="line">openebs&#x2F;linux-utils:2.10.0</span><br><span class="line">kubesphere&#x2F;nfs-client-provisioner:v3.1.0-k8s1.11</span><br><span class="line">##csi-images</span><br><span class="line">csiplugin&#x2F;csi-neonsan:v1.2.0</span><br><span class="line">csiplugin&#x2F;csi-neonsan-ubuntu:v1.2.0</span><br><span class="line">csiplugin&#x2F;csi-neonsan-centos:v1.2.0</span><br><span class="line">csiplugin&#x2F;csi-provisioner:v1.5.0</span><br><span class="line">csiplugin&#x2F;csi-attacher:v2.1.1</span><br><span class="line">csiplugin&#x2F;csi-resizer:v0.4.0</span><br><span class="line">csiplugin&#x2F;csi-snapshotter:v2.0.1</span><br><span class="line">csiplugin&#x2F;csi-node-driver-registrar:v1.2.0</span><br><span class="line">csiplugin&#x2F;csi-qingcloud:v1.2.0</span><br><span class="line">##kubesphere-images</span><br><span class="line">kubesphere&#x2F;ks-apiserver:v3.1.1</span><br><span class="line">kubesphere&#x2F;ks-console:v3.1.1</span><br><span class="line">kubesphere&#x2F;ks-controller-manager:v3.1.1</span><br><span class="line">kubesphere&#x2F;ks-installer:v3.1.1</span><br><span class="line">kubesphere&#x2F;kubectl:v1.20.0</span><br><span class="line">kubesphere&#x2F;kubectl:v1.19.0</span><br><span class="line">redis:5.0.12-alpine</span><br><span class="line">alpine:3.14</span><br><span class="line">haproxy:2.0.22-alpine</span><br><span class="line">nginx:1.14-alpine</span><br><span class="line">minio&#x2F;minio:RELEASE.2019-08-07T01-59-21Z</span><br><span class="line">minio&#x2F;mc:RELEASE.2019-08-07T23-14-43Z</span><br><span class="line">mirrorgooglecontainers&#x2F;defaultbackend-amd64:1.4</span><br><span class="line">kubesphere&#x2F;nginx-ingress-controller:v0.35.0</span><br><span class="line">osixia&#x2F;openldap:1.3.0</span><br><span class="line">csiplugin&#x2F;snapshot-controller:v3.0.3</span><br><span class="line">kubesphere&#x2F;kubefed:v0.7.0</span><br><span class="line">kubesphere&#x2F;tower:v0.2.0</span><br><span class="line">kubesphere&#x2F;prometheus-config-reloader:v0.42.1</span><br><span class="line">kubesphere&#x2F;prometheus-operator:v0.42.1</span><br><span class="line">prom&#x2F;alertmanager:v0.21.0</span><br><span class="line">prom&#x2F;prometheus:v2.26.0</span><br><span class="line">prom&#x2F;node-exporter:v0.18.1</span><br><span class="line">kubesphere&#x2F;ks-alerting-migration:v3.1.0</span><br><span class="line">jimmidyson&#x2F;configmap-reload:v0.3.0</span><br><span class="line">kubesphere&#x2F;notification-manager-operator:v1.0.0</span><br><span class="line">kubesphere&#x2F;notification-manager:v1.0.0</span><br><span class="line">kubesphere&#x2F;metrics-server:v0.4.2</span><br><span class="line">kubesphere&#x2F;kube-rbac-proxy:v0.8.0</span><br><span class="line">kubesphere&#x2F;kube-state-metrics:v1.9.7</span><br><span class="line">openebs&#x2F;provisioner-localpv:2.3.0</span><br><span class="line">thanosio&#x2F;thanos:v0.18.0</span><br><span class="line">grafana&#x2F;grafana:7.4.3</span><br><span class="line">##kubesphere-logging-images</span><br><span class="line">kubesphere&#x2F;elasticsearch-oss:6.7.0-1</span><br><span class="line">kubesphere&#x2F;elasticsearch-curator:v5.7.6</span><br><span class="line">kubesphere&#x2F;fluentbit-operator:v0.5.0</span><br><span class="line">kubesphere&#x2F;fluentbit-operator:migrator</span><br><span class="line">kubesphere&#x2F;fluent-bit:v1.6.9</span><br><span class="line">elastic&#x2F;filebeat:6.7.0</span><br><span class="line">kubesphere&#x2F;kube-auditing-operator:v0.1.2</span><br><span class="line">kubesphere&#x2F;kube-auditing-webhook:v0.1.2</span><br><span class="line">kubesphere&#x2F;kube-events-exporter:v0.1.0</span><br><span class="line">kubesphere&#x2F;kube-events-operator:v0.1.0</span><br><span class="line">kubesphere&#x2F;kube-events-ruler:v0.2.0</span><br><span class="line">kubesphere&#x2F;log-sidecar-injector:1.1</span><br><span class="line">docker:19.03</span><br><span class="line">##istio-images</span><br><span class="line">istio&#x2F;pilot:1.6.10</span><br><span class="line">istio&#x2F;proxyv2:1.6.10</span><br><span class="line">jaegertracing&#x2F;jaeger-agent:1.17</span><br><span class="line">jaegertracing&#x2F;jaeger-collector:1.17</span><br><span class="line">jaegertracing&#x2F;jaeger-es-index-cleaner:1.17</span><br><span class="line">jaegertracing&#x2F;jaeger-operator:1.17.1</span><br><span class="line">jaegertracing&#x2F;jaeger-query:1.17</span><br><span class="line">kubesphere&#x2F;kiali:v1.26.1</span><br><span class="line">kubesphere&#x2F;kiali-operator:v1.26.1</span><br><span class="line">##kubesphere-devops-images</span><br><span class="line">kubesphere&#x2F;ks-jenkins:2.249.1</span><br><span class="line">jenkins&#x2F;jnlp-slave:3.27-1</span><br><span class="line">kubesphere&#x2F;s2ioperator:v3.1.0</span><br><span class="line">kubesphere&#x2F;s2irun:v2.1.1</span><br><span class="line">kubesphere&#x2F;builder-base:v3.1.0</span><br><span class="line">kubesphere&#x2F;builder-nodejs:v3.1.0</span><br><span class="line">kubesphere&#x2F;builder-maven:v3.1.0</span><br><span class="line">kubesphere&#x2F;builder-go:v3.1.0</span><br><span class="line">kubesphere&#x2F;s2i-binary:v2.1.0</span><br><span class="line">kubesphere&#x2F;tomcat85-java11-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;tomcat85-java11-runtime:v2.1.0</span><br><span class="line">kubesphere&#x2F;tomcat85-java8-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;tomcat85-java8-runtime:v2.1.0</span><br><span class="line">kubesphere&#x2F;java-11-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;java-8-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;java-8-runtime:v2.1.0</span><br><span class="line">kubesphere&#x2F;java-11-runtime:v2.1.0</span><br><span class="line">kubesphere&#x2F;nodejs-8-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;nodejs-6-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;nodejs-4-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;python-36-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;python-35-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;python-34-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;python-27-centos7:v2.1.0</span><br><span class="line">##openpitrix-images</span><br><span class="line">kubespheredev&#x2F;openpitrix-jobs:v3.1.1</span><br><span class="line">##weave-scope-images</span><br><span class="line">weaveworks&#x2F;scope:1.13.0</span><br><span class="line">##kubeedge-images</span><br><span class="line">kubeedge&#x2F;cloudcore:v1.6.2</span><br><span class="line">kubesphere&#x2F;edge-watcher:v0.1.0</span><br><span class="line">kubesphere&#x2F;kube-rbac-proxy:v0.5.0</span><br><span class="line">kubesphere&#x2F;edge-watcher-agent:v0.1.0</span><br><span class="line">##example-images-images</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-productpage-v1:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-reviews-v1:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-reviews-v2:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-reviews-v3:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-details-v1:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-ratings-v1:1.16.3</span><br><span class="line">busybox:1.31.1</span><br><span class="line">joosthofman&#x2F;wget:1.0</span><br><span class="line">kubesphere&#x2F;netshoot:v1.0</span><br><span class="line">nginxdemos&#x2F;hello:plain-text</span><br><span class="line">wordpress:4.8-apache</span><br><span class="line">mirrorgooglecontainers&#x2F;hpa-example:latest</span><br><span class="line">java:openjdk-8-jre-alpine</span><br><span class="line">fluent&#x2F;fluentd:v1.4.2-2.0</span><br><span class="line">perl:latest</span><br></pre></td></tr></table></figure><ul><li>sync.sh</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">GREEN_COL=<span class="string">"\\033[32;1m"</span></span><br><span class="line">RED_COL=<span class="string">"\\033[1;31m"</span></span><br><span class="line">NORMAL_COL=<span class="string">"\\033[0;39m"</span></span><br><span class="line">SOURCE_REGISTRY=<span class="variable">$1</span></span><br><span class="line">TARGET_REGISTRY=<span class="variable">$2</span></span><br><span class="line">: <span class="variable">$&#123;IMAGES_LIST_FILE:="images-list.txt"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;TARGET_REGISTRY:="hub.k8s.li"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;SOURCE_REGISTRY:="docker.io"&#125;</span></span><br><span class="line"></span><br><span class="line">BLOBS_PATH=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">REPO_PATH=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line"></span><br><span class="line">CURRENT_NUM=0</span><br><span class="line">ALL_IMAGES=<span class="string">"<span class="variable">$(sed -n '/#/d;s/:/:/p' $&#123;IMAGES_LIST_FILE&#125; | sort -u)</span>"</span></span><br><span class="line">TOTAL_NUMS=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;ALL_IMAGES&#125;</span>"</span> | wc -l)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">skopeo_copy</span></span>() &#123;</span><br><span class="line"> <span class="keyword">if</span> skopeo copy --insecure-policy --src-tls-verify=<span class="literal">false</span> --dest-tls-verify=<span class="literal">false</span> \</span><br><span class="line"> --override-arch amd64 --override-os linux -q docker://<span class="variable">$1</span> docker://<span class="variable">$2</span>; <span class="keyword">then</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$GREEN_COL</span> Progress: <span class="variable">$&#123;CURRENT_NUM&#125;</span>/<span class="variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="variable">$1</span> to <span class="variable">$2</span> successful <span class="variable">$NORMAL_COL</span>"</span></span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$RED_COL</span> Progress: <span class="variable">$&#123;CURRENT_NUM&#125;</span>/<span class="variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="variable">$1</span> to <span class="variable">$2</span> failed <span class="variable">$NORMAL_COL</span>"</span></span><br><span class="line"> <span class="built_in">exit</span> 2</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> <span class="variable">$&#123;ALL_IMAGES&#125;</span>; <span class="keyword">do</span></span><br><span class="line"> <span class="built_in">let</span> CURRENT_NUM=<span class="variable">$&#123;CURRENT_NUM&#125;</span>+1</span><br><span class="line"> skopeo_copy <span class="variable">$&#123;SOURCE_REGISTRY&#125;</span>/<span class="variable">$&#123;image&#125;</span> <span class="variable">$&#123;TARGET_REGISTRY&#125;</span>/<span class="variable">$&#123;image&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><ul><li><code>bash sync.sh docker.io ``localhost:5000</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ bash sync.sh docker.io localhost:5000</span><br><span class="line">Progress: 1/143 sync docker.io/alpine:3.14 to localhost:5000/alpine:3.14 successful</span><br><span class="line">Progress: 2/143 sync docker.io/busybox:1.31.1 to localhost:5000/busybox:1.31.1 successful</span><br><span class="line">Progress: 3/143 sync docker.io/calico/cni:v3.16.3 to localhost:5000/calico/cni:v3.16.3 successful</span><br><span class="line">Progress: 4/143 sync docker.io/calico/kube-controllers:v3.16.3 to localhost:5000/calico/kube-controllers:v3.16.3 successful</span><br><span class="line">Progress: 141/143 sync docker.io/thanosio/thanos:v0.18.0 to localhost:5000/thanosio/thanos:v0.18.0 successful</span><br><span class="line">Progress: 142/143 sync docker.io/weaveworks/scope:1.13.0 to localhost:5000/weaveworks/scope:1.13.0 successful</span><br><span class="line">Progress: 143/143 sync docker.io/wordpress:4.8-apache to localhost:5000/wordpress:4.8-apache successful</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨-registry-å­˜å‚¨ç‰¹æ€§"><a href="#ä½¿ç”¨-registry-å­˜å‚¨ç‰¹æ€§" class="headerlink" title="ä½¿ç”¨ registry å­˜å‚¨ç‰¹æ€§"></a>ä½¿ç”¨ registry å­˜å‚¨ç‰¹æ€§</h3><p>å°†é•œåƒä» registry ä¸­åŒæ­¥åˆ°æœ¬åœ°ç›®å½•ï¼Œä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§ï¼Œå°†æœ¬åœ°ç›®å½•ä¸­çš„é•œåƒè½¬æ¢æˆ registry å­˜å‚¨çš„æ ¼å¼ã€‚è¿™æ ·å­çš„å¥½å¤„å°±æ˜¯å¯ä»¥å»é™¤ä¸€äº› skopeo dir ä¸­é‡å¤çš„ layersï¼Œå‡å°‘é•œåƒçš„æ€»å¤§å°ã€‚å…·ä½“çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™è¿‡çš„ ã€Š<a href="https://blog.k8s.li/skopeo-to-registry.html">å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</a>ã€‹</p><ul><li>sync.sh</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">GREEN_COL=<span class="string">"\\033[32;1m"</span></span><br><span class="line">RED_COL=<span class="string">"\\033[1;31m"</span></span><br><span class="line">NORMAL_COL=<span class="string">"\\033[0;39m"</span></span><br><span class="line">SOURCE_REGISTRY=<span class="variable">$1</span></span><br><span class="line">TARGET_REGISTRY=<span class="variable">$2</span></span><br><span class="line">IMAGES_DIR=<span class="variable">$2</span></span><br><span class="line">: <span class="variable">$&#123;IMAGES_DIR:="images"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;IMAGES_LIST_FILE:="images-list.txt"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;TARGET_REGISTRY:="hub.k8s.li"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;SOURCE_REGISTRY:="docker.io"&#125;</span></span><br><span class="line">BLOBS_PATH=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">REPO_PATH=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line">CURRENT_NUM=0</span><br><span class="line">ALL_IMAGES=<span class="string">"<span class="variable">$(sed -n '/#/d;s/:/:/p' $&#123;IMAGES_LIST_FILE&#125; | sort -u)</span>"</span></span><br><span class="line">TOTAL_NUMS=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;ALL_IMAGES&#125;</span>"</span> | wc -l)</span><br><span class="line"><span class="function"><span class="title">skopeo_sync</span></span>() &#123;</span><br><span class="line"> <span class="keyword">if</span> skopeo sync --insecure-policy --src-tls-verify=<span class="literal">false</span> --dest-tls-verify=<span class="literal">false</span> \</span><br><span class="line"> --override-arch amd64 --override-os linux --src docker --dest dir <span class="variable">$1</span> <span class="variable">$2</span> &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$GREEN_COL</span> Progress: <span class="variable">$&#123;CURRENT_NUM&#125;</span>/<span class="variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="variable">$1</span> to <span class="variable">$2</span> successful <span class="variable">$NORMAL_COL</span>"</span></span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$RED_COL</span> Progress: <span class="variable">$&#123;CURRENT_NUM&#125;</span>/<span class="variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="variable">$1</span> to <span class="variable">$2</span> failed <span class="variable">$NORMAL_COL</span>"</span></span><br><span class="line"> <span class="built_in">exit</span> 2</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">convert_images</span></span>() &#123;</span><br><span class="line"> rm -rf <span class="variable">$&#123;IMAGES_DIR&#125;</span>; mkdir -p <span class="variable">$&#123;IMAGES_DIR&#125;</span></span><br><span class="line"> <span class="keyword">for</span> image <span class="keyword">in</span> <span class="variable">$&#123;ALL_IMAGES&#125;</span>; <span class="keyword">do</span></span><br><span class="line"> <span class="built_in">let</span> CURRENT_NUM=<span class="variable">$&#123;CURRENT_NUM&#125;</span>+1</span><br><span class="line"> image_name=<span class="variable">$&#123;image%%:*&#125;</span></span><br><span class="line"> image_tag=<span class="variable">$&#123;image##*:&#125;</span></span><br><span class="line"> image_repo=<span class="variable">$&#123;image%%/*&#125;</span></span><br><span class="line"> skopeo_sync <span class="variable">$&#123;SOURCE_REGISTRY&#125;</span>/<span class="variable">$&#123;image&#125;</span> <span class="variable">$&#123;IMAGES_DIR&#125;</span>/<span class="variable">$&#123;image_repo&#125;</span></span><br><span class="line"> manifest=<span class="string">"<span class="variable">$&#123;IMAGES_DIR&#125;</span>/<span class="variable">$&#123;image&#125;</span>/manifest.json"</span></span><br><span class="line"> manifest_sha256=$(sha256sum <span class="variable">$&#123;manifest&#125;</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line"> mkdir -p <span class="variable">$&#123;BLOBS_PATH&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line"> ln -f <span class="variable">$&#123;manifest&#125;</span> <span class="variable">$&#123;BLOBS_PATH&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span>/data</span><br><span class="line"> <span class="comment"># make image repositories dir</span></span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/&#123;_uploads,_layers,_manifests&#125;</span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/&#123;current,index/sha256&#125;</span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line"> <span class="comment"># create image tag manifest link file</span></span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/current/link</span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br><span class="line"> <span class="comment"># link image layers file to registry blobs dir</span></span><br><span class="line"> <span class="keyword">for</span> layer <span class="keyword">in</span> $(sed <span class="string">'/v1Compatibility/d'</span> <span class="variable">$&#123;manifest&#125;</span> | grep -Eo <span class="string">"\b[a-f0-9]&#123;64&#125;\b"</span>); <span class="keyword">do</span></span><br><span class="line"> mkdir -p <span class="variable">$&#123;BLOBS_PATH&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;layer&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span>/link</span><br><span class="line"> ln -f <span class="variable">$&#123;IMAGES_DIR&#125;</span>/<span class="variable">$&#123;image&#125;</span>/<span class="variable">$&#123;layer&#125;</span> <span class="variable">$&#123;BLOBS_PATH&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data</span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">convert_images</span><br></pre></td></tr></table></figure><ul><li>install.sh</li></ul><p>ä½¿ç”¨è¿™ä¸ªè„šæœ¬å°† registry å­˜å‚¨ä¸­çš„é•œåƒè½¬æ¢æˆ skopeo dir çš„æ–¹å¼ï¼Œç„¶åå†å°†é•œåƒåŒæ­¥åˆ° registry ä¸­ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">REGISTRY_DOMAIN=<span class="string">"harbor.k8s.li"</span></span><br><span class="line">REGISTRY_PATH=<span class="string">"/var/lib/registry"</span></span><br><span class="line"><span class="comment"># åˆ‡æ¢åˆ° registry å­˜å‚¨ä¸»ç›®å½•ä¸‹</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;REGISTRY_PATH&#125;</span></span><br><span class="line"><span class="function"><span class="title">gen_skopeo_dir</span></span>() &#123;</span><br><span class="line">   <span class="comment"># å®šä¹‰ registry å­˜å‚¨çš„ blob ç›®å½• å’Œ repositories ç›®å½•ï¼Œæ–¹ä¾¿åé¢ä½¿ç”¨</span></span><br><span class="line">    BLOB_DIR=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">    REPO_DIR=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line">    <span class="comment"># å®šä¹‰ç”Ÿæˆ skopeo ç›®å½•</span></span><br><span class="line">    SKOPEO_DIR=<span class="string">"docker/skopeo"</span></span><br><span class="line">    <span class="comment"># é€šè¿‡ find å‡º current æ–‡ä»¶å¤¹å¯ä»¥å¾—åˆ°æ‰€æœ‰å¸¦ tag çš„é•œåƒï¼Œå› ä¸ºä¸€ä¸ª tag å¯¹åº”ä¸€ä¸ª current ç›®å½•</span></span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> $(find <span class="variable">$&#123;REPO_DIR&#125;</span> -<span class="built_in">type</span> d -name <span class="string">"current"</span>); <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># æ ¹æ®é•œåƒçš„ tag æå–é•œåƒçš„åå­—</span></span><br><span class="line">        name=$(<span class="built_in">echo</span> <span class="variable">$&#123;image&#125;</span> | awk -F <span class="string">'/'</span> <span class="string">'&#123;print $5"/"$6":"$9&#125;'</span>)</span><br><span class="line">        link=$(cat <span class="variable">$&#123;image&#125;</span>/link | sed <span class="string">'s/sha256://'</span>)</span><br><span class="line">        mfs=<span class="string">"<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;link:0:2&#125;</span>/<span class="variable">$&#123;link&#125;</span>/data"</span></span><br><span class="line">        <span class="comment"># åˆ›å»ºé•œåƒçš„ç¡¬é“¾æ¥éœ€è¦çš„ç›®å½•</span></span><br><span class="line">        mkdir -p <span class="string">"<span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>"</span></span><br><span class="line">        <span class="comment"># ç¡¬é“¾æ¥é•œåƒçš„ manifests æ–‡ä»¶åˆ°ç›®å½•çš„ manifest æ–‡ä»¶</span></span><br><span class="line">        ln <span class="variable">$&#123;mfs&#125;</span> <span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>/manifest.json</span><br><span class="line">        <span class="comment"># ä½¿ç”¨æ­£åˆ™åŒ¹é…å‡ºæ‰€æœ‰çš„ sha256 å€¼ï¼Œç„¶åæ’åºå»é‡</span></span><br><span class="line">        layers=$(grep -Eo <span class="string">"\b[a-f0-9]&#123;64&#125;\b"</span> <span class="variable">$&#123;mfs&#125;</span> | sort -n | uniq)</span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> <span class="variable">$&#123;layers&#125;</span>; <span class="keyword">do</span></span><br><span class="line">          <span class="comment"># ç¡¬é“¾æ¥ registry å­˜å‚¨ç›®å½•é‡Œçš„é•œåƒ layer å’Œ images config åˆ°é•œåƒçš„ dir ç›®å½•</span></span><br><span class="line">            ln <span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data <span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">sync_image</span></span>() &#123;</span><br><span class="line">    <span class="comment"># ä½¿ç”¨ skopeo sync å°† dir æ ¼å¼çš„é•œåƒåŒæ­¥åˆ° harbor</span></span><br><span class="line">    <span class="keyword">for</span> project <span class="keyword">in</span> $(ls <span class="variable">$&#123;SKOPEO_DIR&#125;</span>); <span class="keyword">do</span></span><br><span class="line">        skopeo sync --insecure-policy --src-tls-verify=<span class="literal">false</span> --dest-tls-verify=<span class="literal">false</span> \</span><br><span class="line">        --src dir --dest docker <span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;project&#125;</span> <span class="variable">$&#123;REGISTRY_DOMAIN&#125;</span>/<span class="variable">$&#123;project&#125;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line">gen_skopeo_dir</span><br></pre></td></tr></table></figure><h3 id="ä»-registry-å­˜å‚¨ä¸­-select-å‡ºé•œåƒ"><a href="#ä»-registry-å­˜å‚¨ä¸­-select-å‡ºé•œåƒ" class="headerlink" title="ä» registry å­˜å‚¨ä¸­ select å‡ºé•œåƒ"></a>ä» registry å­˜å‚¨ä¸­ select å‡ºé•œåƒ</h3><p>å…ˆå°†é•œåƒåŒæ­¥åˆ°ä¸€ä¸ª registry ä¸­ï¼Œå†å°†é•œåƒä» registry å­˜å‚¨ä¸­æå‡ºæ¥ã€‚è¿™ä¸ª registry å¯ä»¥å½“ä½œä¸€ä¸ªé•œåƒå­˜å‚¨çš„æ± å­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Linux ä¸­ç¡¬é“¾æ¥çš„ç‰¹æ€§å°†é•œåƒ<code>&quot;å¤åˆ¶&quot;</code>ä¸€ä»½å‡ºæ¥ï¼Œç„¶åå†æ‰“ä¸€ä¸ª tar åŒ…ã€‚è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯æ¯æ¬¡æ‰“åŒ…é•œåƒçš„æ—¶å€™éƒ½èƒ½å¤ç”¨å†å²çš„é•œåƒæ•°æ®ï¼Œè€Œä¸”æ€§èƒ½æå¿«ã€‚å…·ä½“çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„åšå®¢ã€Š<a href="https://blog.k8s.li/select-registry-images.html">ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼</a>ã€‹</p><ul><li>å…ˆå°†é•œåƒåŒæ­¥åˆ°ä¸€ä¸ªå›ºå®šçš„ registry ä¸­</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bash sync.sh docker.io localhost:5000</span><br></pre></td></tr></table></figure><ul><li>å†ä½¿ç”¨è¯¥è„šæœ¬å°†é•œåƒä» registry å­˜å‚¨ä¸­æå‡ºæ¥</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line">IMAGES_LIST=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">REGISTRY_PATH=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">OUTPUT_DIR=<span class="string">"<span class="variable">$3</span>"</span></span><br><span class="line">BLOB_DIR=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">REPO_DIR=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line">rm -rf <span class="variable">$&#123;OUTPUT_DIR&#125;</span>; mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span></span><br><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> $(find <span class="variable">$&#123;IMAGES_LIST&#125;</span> -<span class="built_in">type</span> f -name <span class="string">"*.list"</span> | xargs grep -Ev <span class="string">'^#|^/'</span> | grep <span class="string">':'</span>); <span class="keyword">do</span></span><br><span class="line">    image_tag=<span class="variable">$&#123;image##*:&#125;</span></span><br><span class="line">    image_name=<span class="variable">$&#123;image%%:*&#125;</span></span><br><span class="line">    tag_link=<span class="variable">$&#123;REGISTRY_PATH&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/current/link</span><br><span class="line">    manifest_sha256=$(sed <span class="string">'s/sha256://'</span> <span class="variable">$&#123;tag_link&#125;</span>)</span><br><span class="line">    manifest=<span class="variable">$&#123;REGISTRY_PATH&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span>/data</span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line">    ln -f <span class="variable">$&#123;manifest&#125;</span> <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span>/data</span><br><span class="line">    <span class="comment"># make image repositories dir</span></span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/&#123;_uploads,_layers,_manifests&#125;</span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/&#123;current,index/sha256&#125;</span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line">    <span class="comment"># create image tag manifest link file</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/current/link</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br><span class="line">    <span class="keyword">for</span> layer <span class="keyword">in</span> $(sed <span class="string">'/v1Compatibility/d'</span> <span class="variable">$&#123;manifest&#125;</span> | grep -Eo <span class="string">'\b[a-f0-9]&#123;64&#125;\b'</span> | sort -u); <span class="keyword">do</span></span><br><span class="line">        mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">        mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">        ln -f <span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;layer&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span>/link</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><h2 id="å»¶ä¼¸é˜…è¯»"><a href="#å»¶ä¼¸é˜…è¯»" class="headerlink" title="å»¶ä¼¸é˜…è¯»"></a>å»¶ä¼¸é˜…è¯»</h2><ul><li><a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”ŸğŸ¤”</a></li><li><a href="https://blog.k8s.li/registry-gc.html">docker registry GC åŸç†åˆ†æ</a></li><li><a href="https://blog.k8s.li/docker-registry-to-harbor.html">docker registry è¿ç§»è‡³ harbor</a></li><li><a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 åœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­çš„åº”ç”¨</a></li><li><a href="https://blog.k8s.li/skopeo-to-registry.html">å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</a></li><li><a href="https://blog.k8s.li/select-registry-images.html">ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;æ¬ç –å·¥å…·&quot;&gt;&lt;a href=&quot;#æ¬ç –å·¥å…·&quot;
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="registry" scheme="https://blog.k8s.li/tags/registry/"/>
    
      <category term="é•œåƒ" scheme="https://blog.k8s.li/tags/%E9%95%9C%E5%83%8F/"/>
    
      <category term="skopeo" scheme="https://blog.k8s.li/tags/skopeo/"/>
    
  </entry>
  
  <entry>
    <title>äº‘åŸç”Ÿ PaaS äº§å“å‘å¸ƒ&amp;éƒ¨ç½²æ–¹æ¡ˆ</title>
    <link href="https://blog.k8s.li/pass-platform-release.html"/>
    <id>https://blog.k8s.li/pass-platform-release.html</id>
    <published>2021-06-09T16:00:00.000Z</published>
    <updated>2021-06-09T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>å¯¹äºä¸€æ¬¾åŸºäº kubernetes çš„å®¹å™¨äº‘å¹³å°æ¥è®²ï¼Œå®ƒéœ€è¦ç»™ç”¨æˆ·æä¾›èµ„æºè°ƒåº¦ã€æœåŠ¡ç¼–æ’ã€åº”ç”¨éƒ¨ç½²ã€ç›‘æ§æ—¥å¿—ã€é…ç½®ç®¡ç†ã€é•œåƒæ„å»ºã€CI/CDã€å­˜å‚¨å’Œç½‘ç»œç®¡ç†ç­‰åŠŸèƒ½ã€‚ä¸€ä¸ª PaaS äº§å“æƒ³è¦å®ç°è¿™äº›é¢é¢ä¿±å…¨çš„åŠŸèƒ½å¹¶ä¸æ˜¯ä¸€ä»¶è½»æ¾çš„äº‹å„¿ã€‚ä»è½¯ä»¶ç ”å‘æµç¨‹ä¸Šæ¥è®²ï¼Œä¸åŒäºä¼ ç»Ÿçš„å•ä½“åº”ç”¨æˆ–å®¢æˆ·ç«¯åº”ç”¨ï¼Œå®¹å™¨äº‘å¹³å°æœ¬ä»åº•å±‚çš„ Kubernetes é›†ç¾¤éƒ¨ç½²åˆ°ä¸Šå±‚çš„ç”¨æˆ·åº”ç”¨éƒ¨ç½²ï¼Œæ‰€æ¶‰åŠåˆ°çš„æŠ€æœ¯æ ˆååˆ†å¤æ‚ï¼Œæœ€ç»ˆå¯¼è‡´å¹³å°çš„å¼€å‘æµç¨‹å˜å¾—ååˆ†ç¹çã€‚</p><p>å½“ç„¶ä¸šç•Œä¹Ÿæœ‰ä¸€äº›ä¸»æµè§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚å¹³å°ç»„ä»¶å®¹å™¨åŒ–éƒ¨ç½²ï¼Œä»¥åŠä½¿ç”¨å¾®æœåŠ¡æ¶æ„å°†å¹³å°æ‹†åˆ†æˆè‹¥å¹²ä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼Œæ¯”å¦‚ç›‘æ§å‘Šè­¦æ¨¡å—ã€åº”ç”¨ç®¡ç†æ¨¡å—ã€å¤šé›†ç¾¤ç®¡ç†æ¨¡å—ç­‰ç­‰ã€‚ä½¿ç”¨å¾®æœåŠ¡æ¶æ„å¯ä»¥è§£å†³å®¹å™¨äº‘å¹³å°æœ¬èº«çš„å¤æ‚æ€§ï¼Œå°†å¹³å°æ‹†åˆ†æˆå•ç‹¬çš„æ¨¡å—è¿›è¡Œç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²ï¼Œè¿™æ ·å¯ä»¥è®©æŸä¸€ç‰¹å®šçš„å›¢é˜Ÿä¸“é—¨è´Ÿè´£è¯¥æ¨¡å—çš„å¼€å‘ã€‚</p><p>è€Œä½¿ç”¨å¾®æœåŠ¡æ¶æ„ä¹‹åï¼Œä¹Ÿå¼•å…¥äº†æ–°çš„é—®é¢˜ï¼šç»„ä»¶æ•°é‡å¤šäº†ã€å¯¹åº”æ¨¡å—å¼€å‘äººå‘˜å¤šäº†ã€äº§å“ä»£ç ä»“åº“å¤šäº†ã€ç»„ä»¶é•œåƒå¤šäº†ã€éƒ¨ç½²å˜å¾—å¤æ‚äº†ç­‰ã€‚ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­å°±æ˜¯ <a href="https://github.com/kubesphere/ks-installer" target="_blank" rel="noopener">ks-installer</a>  è¿™ä¸ªå¼€æºé¡¹ç›®ï¼Œé‡Œé¢åŒ…å«äº† 20 å¤šä¸ªç»„ä»¶å’Œ 140 å¤šä¸ªå®¹å™¨é•œåƒã€‚æƒ³è¦ç®¡ç†è¿™ä¹ˆå¤šçš„ç»„ä»¶å’Œé•œåƒç»éæ˜“äº‹å„¿ï¼Œä¸ªäººè®¤ä¸ºè¿™éœ€è¦ä»äº§å“å‘å¸ƒå’Œå¹³å°éƒ¨ç½²ä¸¤ä¸ªç»´åº¦å»è§£å†³ä¼—å¤šç»„ä»¶ç®¡ç†çš„éš¾é¢˜ï¼Œå› æ­¤æœ¬æ–‡å°±æ¢³ç†äº†ä¸ªäººåœ¨ PaaS å®¹å™¨äº‘å¹³å°äº§å“å‘å¸ƒå’Œéƒ¨ç½²æ–¹é¢çš„ä¸€äº›ç»éªŒæ€»ç»“ã€‚</p><h2 id="æœ¯è¯­å®šä¹‰"><a href="#æœ¯è¯­å®šä¹‰" class="headerlink" title="æœ¯è¯­å®šä¹‰"></a>æœ¯è¯­å®šä¹‰</h2><p>æœ¬æ–‡ä¸­ä¼šæœ‰ä¸€äº›ä¸“ä¸šæœ¯è¯­ï¼Œåœ¨è¿™å…ˆè§£é‡Šä¸€ä¸‹ï¼š</p><table><thead><tr><th><strong>æœ¯è¯­</strong></th><th>å®šä¹‰</th></tr></thead><tbody><tr><td>Platform/å¹³å°</td><td>å³å¹³å°ï¼Œæœ¬æ–‡æŒ‡åŸºäº kubernetes çš„ PaaS å®¹å™¨äº‘å¹³å°</td></tr><tr><td>Addon/ç»„ä»¶</td><td>æŸä¸ªç‹¬ç«‹çš„æ¨¡å—ï¼Œä¸€ä¸ª PaaS å®¹å™¨äº‘å¹³å°ç”±å¤šä¸ªç»„ä»¶æ„æˆ</td></tr><tr><td>Chart/Charts</td><td>æŒ‡ä¸€ä¸ªæˆ–å¤šä¸ª Helm Chartï¼Œé‡Œé¢åŒ…å«å®šä¹‰ç»„ä»¶éƒ¨ç½²æ‰€éœ€è¦çš„ manifests æ–‡ä»¶</td></tr><tr><td>Helm</td><td>éƒ¨ç½²ç»„ä»¶ Charts æ‰€ä½¿ç”¨çš„å‘½ä»¤è¡Œå·¥å…·</td></tr><tr><td>Release/å‘å¸ƒ</td><td>æ”¶é›†äº§å“æ‰€åŒ…å«æ‰€æœ‰ç»„ä»¶çš„éƒ¨ç½²éœ€è¦çš„æ–‡ä»¶å’Œé•œåƒåˆ—è¡¨åˆ° git repo</td></tr><tr><td>Package/æ‰“åŒ…</td><td>æ ¹æ®å‘å¸ƒæµç¨‹ä¸­æ”¶é›†è¿‡æ¥çš„éƒ¨ç½²æ–‡ä»¶å’Œé•œåƒåˆ—è¡¨å°†å®ƒä»¬æ‰“åŒ…æˆç¦»çº¿å®‰è£…åŒ…</td></tr><tr><td>helm-controller</td><td>åŸºäº Helm å¼€å‘çš„æ§åˆ¶å™¨ï¼Œç”¨äºéƒ¨ç½²å¹³å°ç»„ä»¶</td></tr><tr><td>æ ‡å‡†äº§å“</td><td>æŒ‡ PaaS å®¹å™¨äº‘å¹³å°æœ¬èº«ï¼Œæ— ä»»ä½•å®šåˆ¶åŒ–å¼€å‘</td></tr><tr><td>OEM äº§å“</td><td>åŸºäºæ ‡å‡†äº§å“äºŒæ¬¡å¼€å‘æˆ–ä½¿ç”¨ OEM è¡¥ä¸åŒ…å®šåˆ¶åŒ–å¼€å‘çš„äºŒå¼€äº§å“</td></tr><tr><td>Jenkins æµæ°´çº¿</td><td>Release è‡ªåŠ¨åŒ–æ‰“åŒ…å‘å¸ƒäº§å“åŒ…ä½¿ç”¨çš„å·¥å…·</td></tr><tr><td>platform-release</td><td>äº§å“å‘å¸ƒä¸“ç”¨çš„ git repoï¼Œæ”¶é›†å’Œç®¡ç†å„ä¸ªç»„ä»¶å‘å¸ƒç›¸å…³çš„é…ç½®</td></tr><tr><td>PR/MR</td><td>Pull Request / Merge Request</td></tr></tbody></table><h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>å¯¹äºä¸€ä¸ªåŸºäº kubernetes çš„ PaaS å¹³å°æ¥è®²ï¼Œæ•´ä¸ªå¹³å°çš„éƒ¨ç½²å¯ä»¥å¤§è‡´åˆ’åˆ†ä¸ºå¹³å°åº•å±‚çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å’Œå¹³å°ç»„ä»¶çš„éƒ¨ç½²è¿™ä¸¤éƒ¨åˆ†ã€‚æ¯”å¦‚ Kubesphere 3.x è¿™ä¸ªäº§å“ï¼Œkubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·æ˜¯ä½¿ç”¨ Golang å¼€å‘çš„  <a href="https://github.com/kubesphere/kubekey" target="_blank" rel="noopener">kubekey</a>ï¼Œå¹³å°ç»„ä»¶éƒ¨ç½²å·¥å…·æ˜¯ä½¿ç”¨ Ansible å¼€å‘çš„ <a href="https://github.com/kubesphere/ks-installer" target="_blank" rel="noopener">ks-installer</a>ã€‚</p><p>ä¸ªäººè®¤ä¸º Kubesphere çš„éƒ¨ç½²æµç¨‹æ˜¯æ¯”è¾ƒåˆç†çš„ã€‚å¹³å°åº•å±‚çš„ Kubernetes é›†ç¾¤éƒ¨ç½²åšçš„å¾ˆç®€å•ï¼ˆä¸€ä¸ªäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶ï¼‰ï¼Œå¹³å°ç»„ä»¶éƒ¨ç½²å·¥å…·ä¾èµ–çš„ä¹Ÿä»…ä»…æ˜¯ä¸€ä¸ªå·²ç»éƒ¨ç½²å¥½çš„ Kubernetes é›†ç¾¤å’Œä¸€ä¸ªå­˜å‚¨ StorageClassã€‚è¿™æ ·å°±å¯ä»¥å®ç°å¹³å°ç»„ä»¶çš„éƒ¨ç½²ä¸åº•å±‚ Kubernetes é›†ç¾¤éƒ¨ç½²çš„è§£è€¦ï¼Œä½¿å¾—å¹³å°ç»„ä»¶å¯ä»¥éƒ¨ç½²åœ¨ä¸€ä¸ªå·²ç»éƒ¨ç½²å¥½çš„ kubernetes é›†ç¾¤ä¸­ï¼Œæ¯”å¦‚ AKSã€‚åŒæ—¶å¯¹äºç”¨æˆ·æ¥è®²ï¼Œå¹³å°ç»„ä»¶çš„éƒ¨ç½²ä¹Ÿå˜å¾—ååˆ†ç®€å•ï¼Œåªéœ€è¦å‡ æ¡ kubectl å‘½ä»¤å°±èƒ½è½»æ¾å®Œæˆã€‚</p><p>å› æ­¤åœ¨è®¾è®¡éƒ¨ç½²æ–¹æ¡ˆæ—¶ï¼Œç»“åˆå®¢æˆ·çš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯¹éƒ¨ç½²æ–¹æ¡ˆåšå‡ºå¦‚ä¸‹å‡ ç‚¹è¦æ±‚ï¼š</p><ul><li>éœ€è¦åšåˆ°ç¦»çº¿éƒ¨ç½²ï¼Œå³ç§æœ‰åŒ–éƒ¨ç½²æ—¶ä¸èƒ½ä¾èµ–ä»»ä½•åœ¨çº¿çš„èµ„æºï¼›</li><li>å¹³å°åº•å±‚ Kubernetes é›†ç¾¤éƒ¨ç½²ä¸å¹³å°ç»„ä»¶éƒ¨ç½²è¿›è¡Œè§£è€¦ï¼›</li><li>å¹³å°ç»„ä»¶éƒ¨ç½²ä»…ä»…ä¾èµ–äºä¸€ä¸ªå·²ç»éƒ¨ç½²å¥½çš„ Kubernetes é›†ç¾¤å’Œå­˜å‚¨ StorageClassï¼›</li><li>å¹³å°ç»„ä»¶éƒ¨ç½²çš„æ–¹å¼åšåˆ°ç»Ÿä¸€ï¼Œæ¯”å¦‚ Helm Chart éƒ¨ç½²ï¼›</li><li>å°½é‡å°†ä¸Šå±‚çš„ç»„ä»¶æ”¾åˆ°å¹³å°ç»„ä»¶é‡Œï¼Œä¸è¦æ”¾åœ¨ Kubernetes é›†ç¾¤éƒ¨ç½²ä¸­ï¼Œæ¯”å¦‚è´Ÿè½½å‡è¡¡å™¨ã€æŒä¹…åŒ–å­˜å‚¨ã€é•œåƒä»“åº“ç­‰ï¼›</li></ul><p>ä¸ºäº†æ»¡è¶³ä»¥ä¸Šå‡ ç‚¹éƒ¨ç½²çš„éœ€æ±‚ï¼Œæˆ‘ä»¬åˆå°†æ•´ä¸ªå¹³å°çš„éƒ¨ç½²æ‹†åˆ†æˆä¸‰éƒ¨åˆ†ï¼Œåœ¨äº§å“å‘å¸ƒçš„æ—¶å€™ä¼šä½¿ç”¨ Jenkins æµæ°´çº¿è‡ªåŠ¨åŒ–æ„å»ºå‡ºå¯¹åº”çš„ç¦»çº¿å®‰è£…åŒ…ï¼š</p><ul><li>offline-resourcesï¼šéƒ¨ç½² nginx æœåŠ¡å’Œé•œåƒä»“åº“æœåŠ¡ç”¨äºæä¾›ç¦»çº¿å®‰è£…ä¾èµ–çš„æ‰€æœ‰èµ„æºï¼›</li><li>Kubernetesï¼šåŸºäº Kubespray ä½¿ç”¨ offline-resources æä¾›çš„èµ„æºéƒ¨ç½² Kubernetes é›†ç¾¤ï¼›</li><li>platformï¼šåœ¨ Kubernetes é›†ç¾¤ä¹‹ä¸Šéƒ¨ç½²æˆ‘ä»¬çš„ PaaS å®¹å™¨äº‘å¹³å°ï¼›</li></ul><p>Kubernetes é›†ç¾¤éƒ¨ç½²å’Œå¹³å°éƒ¨ç½²æ˜¯ç›¸äº’åˆ†å¼€çš„ï¼Œä¸¤è€…åœ¨éƒ¨ç½²çš„å±‚é¢å°½é‡åœ°åšåˆ°äº†è§£è€¦ï¼Œå‘å¸ƒçš„æ—¶å€™ä¹Ÿåšåˆ°äº†è§£è€¦ï¼Œè¿™æ ·å°±å¯ä»¥é¿å… K8s éƒ¨ç½²å·¥å…·é‡Œæ›´æ–°ä¸€ä¸ªé•œåƒè€Œåˆè¦å°†å¹³å°å®‰è£…åŒ…è·Ÿç€ä¸€èµ·æ›´æ–°çš„æƒ…å†µã€‚</p><p>ä¸¤è€…å¯ä»¥ä½œä¸ºç‹¬ç«‹çš„äº§å“è¿›è¡Œäº¤ä»˜ï¼Œè€Œæ²¡æœ‰å’Œæˆ‘ä»¬çš„ PaaS å¹³å°ç»‘å®šåœ¨ä¸€èµ·ã€‚å› ä¸ºå…¬å¸å†…çš„å…¶ä»–å›¢é˜Ÿä¹Ÿæœ‰ K8s é›†ç¾¤éƒ¨ç½²çš„éœ€æ±‚ï¼Œè¿™æ ·ä¹Ÿèƒ½å°†æˆ‘ä»¬çš„ K8s é›†ç¾¤éƒ¨ç½²å·¥å…·å•ç‹¬äº¤ä»˜ç»™å…¶ä»–å›¢é˜Ÿä½¿ç”¨ã€‚å¹³å°ç»„ä»¶å¤šé›†ç¾¤éƒ¨ç½²çš„å·¥å…·ï¼Œä¹Ÿæ˜¯æ²¡æœ‰å’Œå¹³å°è‡ªèº«ç»‘å®šåœ¨ä¸€èµ·ã€‚åªè¦æ˜¯éƒ¨ç½²åœ¨ K8s ä¸Šå¹¶ä¸”ç»„ä»¶ä½¿ç”¨ Helm Chart éƒ¨ç½²ï¼Œéƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªå·¥å…·æ¥å®ç°å¤šé›†ç¾¤éƒ¨ç½²å’Œæ›´æ–°ã€‚</p><h3 id="offline-resources-æœåŠ¡"><a href="#offline-resources-æœåŠ¡" class="headerlink" title="offline-resources æœåŠ¡"></a>offline-resources æœåŠ¡</h3><p>offline-resources  å³ç¦»çº¿èµ„æºæœåŠ¡ï¼Œè¿™ä¸€æ­¥å¾ˆç®€å•ï¼šå°±ä¸€ä¸ªå®‰è£…åŒ…ï¼Œè§£å‹åä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œä¸€æ¡ <code>bash install.sh</code> å‘½ä»¤å°±èƒ½å®‰è£…å®Œæˆã€‚ç”±äºåœ¨ Kubernetes é›†ç¾¤éƒ¨ç½²å±‚é¢æˆ‘ä»¬å·²ç»å»é™¤å¯¹ Docker å®¹å™¨è¿è¡Œæ—¶çš„ä¾èµ–ï¼Œoffline-resources æœåŠ¡åŒæ ·ä¹Ÿè¦è€ƒè™‘å»é™¤å¯¹ Docker çš„ä¾èµ–ã€‚å› æ­¤æˆ‘ä»¬é€‰æ‹©äº† Containerd å®˜æ–¹çš„ CLI å·¥å…· <a href="https://github.com/containerd/nerdctl" target="_blank" rel="noopener">nerdctl</a> ï¼Œä½¿ç”¨ nerdctl-full çš„å®‰è£…åŒ…æ¥é…ç½®å¥½ Containerd è¿è¡Œæ—¶æ‰€éœ€çš„ä¾èµ–ï¼Œå¹¶ä½¿ç”¨ nerdctl compose æ–¹å¼ä¸€é”®å¯åŠ¨ Nginx å’Œé•œåƒä»“åº“æœåŠ¡ã€‚åç»­çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å’Œå¹³å°ç»„ä»¶éƒ¨ç½²éƒ½ä¼šä¾èµ– offline-resources æä¾›çš„ rpm/deb åŒ…ã€äºŒè¿›åˆ¶æ–‡ä»¶ã€å®¹å™¨é•œåƒç­‰èµ„æºã€‚</p><h3 id="Kubernetes-é›†ç¾¤éƒ¨ç½²"><a href="#Kubernetes-é›†ç¾¤éƒ¨ç½²" class="headerlink" title="Kubernetes é›†ç¾¤éƒ¨ç½²"></a>Kubernetes é›†ç¾¤éƒ¨ç½²</h3><p>Kubernetes é›†ç¾¤éƒ¨ç½²é‡‡ç”¨çš„æ˜¯ Kubernetes ç¤¾åŒºçš„ <a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener">Kubespray</a>ï¼Œå› ä¸ºå®ƒæ¯”è¾ƒé€‚ç”¨äºç§æœ‰åŒ–äº¤ä»˜çš„åœºæ™¯ï¼Œç›¸å…³ç‰¹æ€§å¦‚ä¸‹ï¼š</p><ul><li>æ”¯æŒçš„ K8s ä» 1.19.0ï½1.21.1 çš„æ‰€æœ‰ç‰ˆæœ¬ï¼›</li><li>æ”¯æŒ 10 ç§ä¸»æµçš„ Linux å‘è¡Œç‰ˆå’Œå…¬æœ‰äº‘ Linux å‘è¡Œç‰ˆï¼›</li><li>æ”¯æŒ 10 ç§ CNI æ’ä»¶ï¼›</li><li>æ”¯æŒ 4 ç§å®¹å™¨è¿è¡Œæ—¶ (Docker, Containerd, CRI-O, Kata)ã€‚</li></ul><p>æˆ‘ä»¬å¯¹ Kubespray è¿›è¡Œäº†äºŒæ¬¡å¼€å‘ï¼ŒåŠ å…¥äº†ç¦»çº¿éƒ¨ç½²éœ€è¦é€‚é…çš„å†…å®¹ï¼Œæ¯”å¦‚é…ç½®ç³»ç»Ÿ OS çš„ yum/apt çš„æºä¸º offline-resources æœåŠ¡æ‰€æä¾›çš„æºï¼›å°†é•œåƒä»“åº“çš„åŸŸå CA è¯ä¹¦åœ¨èŠ‚ç‚¹è¿›è¡Œä¿¡ä»»ï¼›å°†é›†ç¾¤éƒ¨ç½²æ‹†åˆ†æˆè‹¥å¹²ä¸ªå­æ­¥éª¤ï¼›ä¸€äº›å¹³å°è‡ªèº« self-host ç‰¹æ€§ç­‰ã€‚</p><p>åŒæ—¶æˆ‘ä»¬åˆå¯¹ Kubespray è¿›è¡Œå®¹å™¨åŒ–å°è£…ï¼Œåœ¨éƒ¨ç½²çš„æ—¶å€™ä¼šä½¿ç”¨è„šæœ¬è°ƒç”¨ nerdctl CLI å·¥å…·æ¥è¿è¡Œ Kubespray å®¹å™¨ï¼Œåªéœ€è¦ä¼ å…¥é›†ç¾¤èŠ‚ç‚¹ inventory æ–‡ä»¶å’Œä¸€ä¸ªé›†ç¾¤é…ç½®æ–‡ä»¶å°±èƒ½ä¸€é”®å®Œæˆ Kubernetes é›†ç¾¤éƒ¨ç½²ã€‚é›†ç¾¤éƒ¨ç½²å®Œæˆä¹‹åä¼šå°†é›†ç¾¤çš„ä¸€äº›ä¿¡æ¯å¦‚é•œåƒä»“åº“çš„åŸŸåã€CA è¯ä¹¦ã€è´Ÿè½½å‡è¡¡ VIP ç­‰ä¿¡æ¯ä¿å­˜ä¸ºä¸€ä¸ª system-info çš„ configmap ä¸ºåç»­çš„å¹³å°éƒ¨ç½²ä½¿ç”¨ã€‚</p><h3 id="å¹³å°ç»„ä»¶éƒ¨ç½²"><a href="#å¹³å°ç»„ä»¶éƒ¨ç½²" class="headerlink" title="å¹³å°ç»„ä»¶éƒ¨ç½²"></a>å¹³å°ç»„ä»¶éƒ¨ç½²</h3><p>å¹³å°ç»„ä»¶éƒ¨ç½²æˆ‘ä»¬å¹¶æ²¡æœ‰åƒ <a href="https://github.com/kubesphere/ks-installer" target="_blank" rel="noopener">ks-installer</a> é‚£æ ·ä¸ºæ¯ä¸€ä¸ªç»„ä»¶éƒ½å•ç‹¬å†™ä¸€ä¸ª Ansible çš„ rolesï¼Œç„¶å controller é€šè¿‡è°ƒç”¨ ansible-playbook æ¥éƒ¨ç½²è¿™äº›ç»„ä»¶ã€‚è€Œæ˜¯å°†æ‰€æœ‰å¹³å°ç»„ä»¶çš„éƒ¨ç½²æ–¹å¼éƒ½ç»Ÿä¸€æˆä¸º Helm Chartï¼Œæ²¡æœ‰å¯¹ä»»ä½•ç»„ä»¶åšç‰¹æ®Šå¤„ç†ã€‚åœ¨å®‰è£…çš„æ—¶å€™ä½¿ç”¨ Helm CLI æˆ–è€…åŸºäº Helm SDK å¼€å‘çš„ helm controller æ¥å°†æ‰€æœ‰çš„å¹³å°ç»„ä»¶è¿›è¡Œç»Ÿä¸€çš„éƒ¨ç½²å’Œæ›´æ–°ã€‚è¿™æ ·åœ¨å‘å¸ƒçš„æ—¶å€™å¯¹è¿™äº›ç»„ä»¶ä¹Ÿèƒ½é€šè¿‡ git repo åšåˆ°ç»Ÿä¸€çš„ç®¡ç†ã€‚è¿™æ ·çš„è®¾è®¡å¯¹ä¸€äº› OEM å®šåˆ¶åŒ–å¼€å‘æˆ–è€…å¢é‡è¡¥ä¸åŒ…çš„å‘å¸ƒä¹Ÿååˆ†å‹å¥½ã€‚</p><h2 id="å‘å¸ƒ"><a href="#å‘å¸ƒ" class="headerlink" title="å‘å¸ƒ"></a>å‘å¸ƒ</h2><p>ä»‹ç»å®Œäº†å¹³å°éƒ¨ç½²çš„æ•´ä½“æµç¨‹åæˆ‘ä»¬å†æ¥è°ˆä¸€ä¸‹å‘å¸ƒæµæ°´çº¿æ˜¯å¦‚ä¸‹è®¾è®¡å’Œå®ç°çš„ã€‚</p><p>æ ¹æ®å†…éƒ¨äº§å“ç‰ˆæœ¬è¿­ä»£çš„æµç¨‹è¦æ±‚ï¼Œå‘å¸ƒæµæ°´çº¿å¤§è‡´å¯ä»¥åˆ’åˆ†ä¸ºå¦‚ä¸‹å‡ éƒ¨åˆ†ï¼š</p><ul><li>RD åœ¨å‘å¸ƒå‰ä¸€å¤©å®Œæˆå†’çƒŸæµ‹è¯•ï¼Œå¹¶åœ¨å†…éƒ¨ DevOps å¹³å°æ„å»ºç»„ä»¶é•œåƒå’Œæ‰“ repo tagï¼›</li><li>æœ¬æ¬¡å‘å¸ƒå¦‚æœ‰å¢åˆ ç»„ä»¶çš„æƒ…å†µï¼Œç»„ä»¶è´Ÿè´£äººæäº¤ PR/MR åˆ°å‘å¸ƒ repo ä¿®æ”¹å‘å¸ƒé…ç½®ï¼›</li><li>RD å†’çƒŸå®Œæˆå’Œæ‰€æœ‰å‡†å¤‡å·¥ç»„å°±ç»ªä¹‹åï¼ŒPM é€šçŸ¥å‘å¸ƒäººå‘˜å¼€å§‹å‘å¸ƒï¼›</li><li>å‘å¸ƒäººå‘˜æ‰§è¡Œæµæ°´çº¿ä»»åŠ¡ï¼Œè‡ªåŠ¨åŒ–æ”¶é›†ç»„ä»¶æœ€æ–°çš„ repo tagï¼Œå¹¶å‘é€ç¾¤æ¶ˆæ¯é€šçŸ¥ç»„ä»¶ Onwer ç¡®è®¤ï¼›</li><li>ç»„ä»¶ repo tag ç¡®è®¤å®Œæ¯•ä¹‹åï¼Œåˆå¹¶ PR/MR åˆ°å‘å¸ƒåˆ†æ”¯ï¼Œè‡ªåŠ¨åŒ–æ”¶é›†ç»„ä»¶çš„ Chart æ–‡ä»¶ï¼›</li><li>æ ¹æ®æ”¶é›†çš„ Chart æ–‡ä»¶æ›´æ–°é•œåƒåˆ—è¡¨å’Œå¹³å°ç»„ä»¶éƒ¨ç½²é…ç½®æ–‡ä»¶ï¼Œä»¥åŠæ£€æŸ¥é•œåƒåˆ—è¡¨ä¸­çš„é•œåƒæ˜¯å¦å­˜åœ¨ï¼›</li><li>å°†æ”¶é›†çš„ Chart å’Œé•œåƒåˆ—è¡¨ç­‰æ–‡ä»¶æäº¤ PR/MR åˆå¹¶åˆ°å‘å¸ƒåˆ†æ”¯ï¼›</li><li>å‰©ä¸‹çš„å°±æ˜¯æ‰“åŒ…äº†ï¼Œæ‰“åŒ…å¯ä»¥çœ‹ä½œæ˜¯å‘å¸ƒçš„æ”¶å°¾ç¯èŠ‚ï¼Œå°†äº§å“æ‰“åŒ…æˆç¦»çº¿å®‰è£…åŒ…å¹¶ä¸Šä¼ åˆ°å­˜å‚¨æœåŠ¡å™¨ï¼›</li></ul><h3 id="offline-resources-å®‰è£…åŒ…å‘å¸ƒ"><a href="#offline-resources-å®‰è£…åŒ…å‘å¸ƒ" class="headerlink" title="offline-resources å®‰è£…åŒ…å‘å¸ƒ"></a>offline-resources å®‰è£…åŒ…å‘å¸ƒ</h3><p>å¯¹äºå¹³å°éƒ¨ç½²è€Œè¨€ï¼Œä¾èµ–çš„åœ¨çº¿èµ„æºä¸»è¦åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š</p><ul><li>ç¬¬ä¸€ç±»ï¼šä¸€äº› OS ä¾èµ–çš„åŒ…ï¼Œæ¯”å¦‚ç”¨åŒ…ç®¡ç†å™¨å®‰è£… Containerd, ceph-common, nfs-utils ç­‰</li><li>ç¬¬äºŒç±»ï¼šäºŒè¿›åˆ¶æ–‡ä»¶ï¼šæ¯”å¦‚ Kubelet, Kubeadm, Kubectl, CNIï¼Œè¿˜æœ‰ä¸€äº›å·¥å…·ç±»å¦‚ Helm, Skopeo ç­‰</li><li>ç¬¬ä¸‰ç±»ï¼šå®¹å™¨é•œåƒï¼Œæ¯”å¦‚ kube-apiserver, CoreDNS, å¹³å°ç»„ä»¶é•œåƒç­‰</li></ul><p>å¯¹äºè¿™ä¸‰ç§åœ¨çº¿çš„èµ„æºï¼Œæˆ‘ä»¬éƒ½ç»Ÿä¸€æˆ Docker build çš„æ–¹å¼ï¼Œä½¿ç”¨ä¸ä¹‹å¯¹åº”çš„è‡ªåŠ¨åŒ–å·¥å…·è¿›è¡Œæ„å»ºã€‚</p><ul><li>å¯¹äºç¬¬ä¸€ç§ï¼Œæˆ‘ä»¬é‡‡ç”¨é…ç½®æ–‡ä»¶ + Dockerfile çš„æ–¹å¼è¿›è¡Œä¸€é”®æ„å»ºå‡ºæ‰€æœ‰ä¾èµ–çš„ yum/apt åŒ…ï¼Œåˆ¶ä½œæˆç¦»çº¿æºã€‚å…·ä½“çš„å®ç°ç»†èŠ‚å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„åšå®¢ <a href="https://blog.k8s.li/make-offline-mirrors.html">ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº</a>ï¼›</li><li>å¯¹äºç¬¬äºŒç§ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®éƒ¨ç½²çš„é…ç½®æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåœ¨çº¿çš„æ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶æ”¾åˆ° Dockerfile é‡Œè¿›è¡Œæ„å»ºä¸‹è½½ï¼›</li><li>å¯¹äºç¬¬ä¸‰ç§ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯æ ¹æ®éƒ¨ç½²çš„é…ç½®æ–‡ä»¶ç”Ÿæˆä¸€äº›é•œåƒåˆ—è¡¨ï¼Œåœ¨ä¸€ä¸ª Dockerfile  é‡Œå°†é•œåƒæ‰“åŒ…å‡ºæ¥ã€‚</li></ul><p>æœ€åæˆ‘ä»¬å°†æ‰€æœ‰çš„ Dockerfile åˆå¹¶æˆä¸€ä¸ª all-in-one çš„ Dockerfileï¼Œå¹¶ä½¿ç”¨ Docker çš„å¤šé˜¶æ®µæ„å»ºå’Œ  <code>BUILDKIT</code>  çš„ç‰¹æ€§å……åˆ†åˆ©ç”¨äº†æ„å»ºç¼“å­˜ï¼Œä½¿å¾—æ„å»ºæ•ˆç‡æ¯”é Docker build çš„æ–¹å¼æé«˜äº†å¾ˆå¤šã€‚</p><h3 id="K8s-éƒ¨ç½²å®‰è£…åŒ…å‘å¸ƒ"><a href="#K8s-éƒ¨ç½²å®‰è£…åŒ…å‘å¸ƒ" class="headerlink" title="K8s éƒ¨ç½²å®‰è£…åŒ…å‘å¸ƒ"></a>K8s éƒ¨ç½²å®‰è£…åŒ…å‘å¸ƒ</h3><p>ç”±äº Kubernetes é›†ç¾¤éƒ¨ç½²æ¶‰åŠçš„ç ”å‘äººå‘˜åªæœ‰äº”å…­ä¸ªï¼Œå› æ­¤å°†å‘å¸ƒæµç¨‹æ¶‰åŠçš„ååˆ†è½»é‡ã€‚å¤§è‡´å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥ï¼š</p><ul><li>å‘å¸ƒäººå‘˜æ‰§è¡Œå‘å¸ƒæµæ°´çº¿ï¼Œæµæ°´çº¿æ ¹æ®éƒ¨ç½²çš„æºç ç”Ÿæˆé•œåƒåˆ—è¡¨å’Œæ–‡ä»¶åˆ—è¡¨ï¼Œè‹¥ä¸¤è€…æ›´æ–°äº†å°±è‡ªåŠ¨æäº¤ PR/MR åˆ°å‘å¸ƒåˆ†æ”¯ï¼›</li><li>ç ”å‘äººå‘˜ review PR/MR æ£€æŸ¥ç”Ÿæˆçš„é•œåƒåˆ—è¡¨å’Œæ–‡ä»¶åˆ—è¡¨æ˜¯å¦æ­£ç¡®ã€‚å› ä¸ºé•œåƒåˆ—è¡¨å’Œæ–‡ä»¶åˆ—è¡¨å°±æ˜¯é›†ç¾¤éƒ¨ç½²é‡Œæ‰€æœ‰ç»„ä»¶çš„ç‰ˆæœ¬ï¼Œå¯ä»¥æ ¹æ®è¿™äº›åˆ—è¡¨åˆ¤æ–­ç»„ä»¶ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®ï¼›</li><li>æµæ°´çº¿è‡ªåŠ¨æ£€æŸ¥é•œåƒåˆ—è¡¨ä¸­çš„é•œåƒæ˜¯å¦å­˜åœ¨ï¼Œæµæ°´çº¿æˆåŠŸä¹‹åï¼Œrepo è´Ÿè´£äººåˆå¹¶ PR/MRï¼›</li><li>åˆå¹¶å®Œæˆ MR ä¹‹åï¼Œä¼šæ‰“ä¸Šç›¸åº”ç‰ˆæœ¬çš„ repo tagï¼Œä¸ºåç»­è¡¥ä¸åŒ…å‘å¸ƒä½¿ç”¨ï¼›</li><li>æµæ°´çº¿æ„å»º Kubespray é•œåƒæ¨é€åˆ°å…¬å¸å†…éƒ¨çš„é•œåƒä»“åº“ï¼Œå¹¶å°†é•œåƒè¿½åŠ åˆ°é•œåƒåˆ—è¡¨ä¸­ï¼›</li><li>æµæ°´çº¿è°ƒç”¨ offline-resources æ„å»ºå·¥å…·ï¼Œæ ¹æ®é•œåƒåˆ—è¡¨æ‰“åŒ…é•œåƒã€æ ¹æ®æ–‡ä»¶åˆ—è¡¨ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ã€æ ¹æ®é…ç½®æ–‡ä»¶æ‰“åŒ…ç¦»çº¿å®‰è£…ä¾èµ–çš„ rpm/deb åŒ…ï¼›</li><li>å¤åˆ¶é…ç½®æ–‡ä»¶å’Œ install.sh è„šæœ¬åˆ°å®‰è£…åŒ…å†…ï¼Œå°†ä¸Šè¿°å†…å®¹æ‰“åŒ…æˆä¸€ä¸ªå®‰è£…åŒ…ï¼Œå¹¶ä¸Šä¼ è‡³å­˜å‚¨æœåŠ¡å™¨ï¼›</li><li>å‘é€ç¾¤æ¶ˆæ¯é€šçŸ¥æµæ°´çº¿å‘å¸ƒå®Œæˆã€‚</li></ul><h3 id="å¹³å°å®‰è£…åŒ…å‘å¸ƒæµç¨‹"><a href="#å¹³å°å®‰è£…åŒ…å‘å¸ƒæµç¨‹" class="headerlink" title="å¹³å°å®‰è£…åŒ…å‘å¸ƒæµç¨‹"></a>å¹³å°å®‰è£…åŒ…å‘å¸ƒæµç¨‹</h3><p>ç”±äºå¹³å°ç»„ä»¶æ•°é‡æ¯”è¾ƒå¤šï¼Œæ‰€æ¶‰åŠçš„ç ”å‘äººå‘˜ä¹Ÿè¾ƒå¤šï¼Œä¸ºäº†æé«˜å‘å¸ƒæ•ˆç‡å’Œå›¢é˜Ÿæ•´ä½“çš„ç ”å‘æ•ˆç‡ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰å¹³å°ç»„ä»¶éƒ½ç»Ÿä¸€ä½¿ç”¨ Helm Chart çš„æ–¹å¼æ¥éƒ¨ç½²ã€‚ä½¿ç”¨ Helm Chart çš„å¥½å¤„å°±åœ¨äºè¿™äº›æ–‡ä»¶éƒ½æ˜¯å£°æ˜å¼çš„ï¼Œç»„ä»¶çš„ç‰ˆæœ¬å¯ä»¥å®šä¹‰åœ¨è¿™äº› Chart.yaml æ–‡ä»¶ä¸­ï¼Œä¸ºåç»­ç»´æŠ¤å¹³å°å„ä¸ªç»„ä»¶çš„ç‰ˆæœ¬æä¾›äº†ä¾¿åˆ©ã€‚</p><p>ä¸ºäº†ç®¡ç†è¿™äº›å¹³å°ç»„å»ºçš„ Charts æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰ç»„ä»¶éƒ¨ç½²çš„ Chart ä½¿ç”¨è‡ªåŠ¨åŒ–çš„å·¥å…·ç»Ÿä¸€æ”¶é›†åˆ°ä¸€ä¸ª Git repo ä¸­ï¼Œåˆ©ç”¨ Git ä½œä¸ºå£°æ˜åŸºç¡€è®¾æ–½ä¸åº”ç”¨ç¨‹åºçš„å•ä¸€äº‹å®æ¥æºã€‚ä½¿ç”¨ git tag çš„æ–¹å¼ç®¡ç†å’Œè®°å½•å¹³å°çš„ç‰ˆæœ¬å’Œå„ä¸ªç»„ä»¶çš„ç‰ˆæœ¬ï¼›ä½¿ç”¨ git diff çš„æ–¹å¼åšå·®å¼‚æ¯”è¾ƒï¼Œä¸ºå¢é‡çš„è¡¥ä¸åŒ…å‘å¸ƒæä¾›äº†ä¾¿åˆ©ï¼›ä½¿ç”¨åˆ†æ”¯çš„æ–¹å¼æ¥ç®¡ç†ä¸åŒçš„ OEM å®šåˆ¶åŒ–å¼€å‘é¡¹ç›®ã€‚</p><h4 id="å‘å¸ƒé…ç½®"><a href="#å‘å¸ƒé…ç½®" class="headerlink" title="å‘å¸ƒé…ç½®"></a>å‘å¸ƒé…ç½®</h4><p>ä»¥ä¸‹è¿™äº›æ–‡ä»¶å’Œç›®å½•è®°å½•äº†å¦‚ä½•ä½¿ç”¨ git repo æ¥ç®¡ç†å¹³å°ç»„ä»¶çš„ï¼š</p><table><thead><tr><th>ç›®å½•/æ–‡ä»¶</th><th>ä½œç”¨</th><th>æ›´æ–°æ–¹å¼</th></tr></thead><tbody><tr><td>addons</td><td>ç”¨äºå­˜æ”¾å¹³å°ç»„ä»¶éƒ¨ç½²éœ€è¦çš„ Helm Chart</td><td>æ ¹æ® repos ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶è‡ªåŠ¨æ›´æ–°</td></tr><tr><td>repos</td><td>ç”¨äºå­˜æ”¾å¹³å°ç»„ä»¶ git  repo é…ç½®ï¼Œæ ¹æ®å®ƒæ¥æ”¶é›†ç»„ä»¶æŒ‡å®š repo æŒ‡å®šç‰ˆæœ¬å·çš„ Chart æ–‡ä»¶</td><td>å¢åˆ ç»„ä»¶éœ€è¦æ‰‹åŠ¨æ·»åŠ ç›¸åº”é…ç½®ï¼Œç»„ä»¶ç‰ˆæœ¬å·è‡ªåŠ¨æ›´æ–°</td></tr><tr><td>images</td><td>ç”¨äºå­˜æ”¾å¹³å°æ‰€éœ€é•œåƒçš„åˆ—è¡¨</td><td>æ ¹æ® addons ç›®å½•ä¸‹çš„ç»„ä»¶è‡ªåŠ¨æ›´æ–°</td></tr><tr><td>scripts</td><td>ç”¨äºå­˜æ”¾ä¸€äº›éƒ¨ç½²ä¾èµ–è„šæœ¬æ–‡ä»¶</td><td>æ‰‹åŠ¨æ›´æ–°æˆ–è‡ªåŠ¨ä»å…¶ä»– repo ä¸­æ”¶é›†</td></tr><tr><td>configs</td><td>ç”¨äºå­˜æ”¾å¹³å°æˆ–ç»„ä»¶éœ€è¦çš„é…ç½®æ–‡ä»¶</td><td>æ‰‹åŠ¨æ›´æ–°æˆ–è‡ªåŠ¨ä»å…¶ä»– repo ä¸­æ”¶é›†</td></tr><tr><td>version.yml</td><td>è®°å½•å¹³å°ç»„ä»¶ç‰ˆæœ¬</td><td>æ ¹æ®ç»„ä»¶ Chart ä¸­çš„ version è‡ªåŠ¨æ›´æ–°</td></tr><tr><td>install.sh</td><td>å¹³å°å®‰è£…è„šæœ¬</td><td>æ‰‹åŠ¨æ›´æ–°</td></tr></tbody></table><p>Git Repo çš„ç›®å½•ç»“æ„å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ tree platform-release</span><br><span class="line">platform-release</span><br><span class="line">â”œâ”€â”€ addons</span><br><span class="line">â”‚   â”œâ”€â”€ cyclone</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ templates</span><br><span class="line">â”‚   â”‚   â””â”€â”€ values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ mongo</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ templates</span><br><span class="line">â”‚   â”‚   â””â”€â”€ values.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ rook-ceph</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ crds</span><br><span class="line">â”‚   â”‚   â”œâ”€â”€ templates</span><br><span class="line">â”‚   â”‚   â””â”€â”€ values.yaml</span><br><span class="line">â”‚   â””â”€â”€ swagger-ui</span><br><span class="line">â”‚       â”œâ”€â”€ Chart.yaml</span><br><span class="line">â”‚       â”œâ”€â”€ templates</span><br><span class="line">â”‚       â””â”€â”€ values.yaml</span><br><span class="line">â”œâ”€â”€ configs</span><br><span class="line">â”‚   â”œâ”€â”€ mongo-config-secret.yaml.j2</span><br><span class="line">â”‚   â”œâ”€â”€ platform-config.yaml.j2</span><br><span class="line">â”‚   â””â”€â”€ platform-info.yaml.j2</span><br><span class="line">â”œâ”€â”€ env.yml</span><br><span class="line">â”œâ”€â”€ images</span><br><span class="line">â”‚   â”œâ”€â”€ images_app_store.list</span><br><span class="line">â”‚   â”œâ”€â”€ images_base.list</span><br><span class="line">â”‚   â”œâ”€â”€ images_extra.list</span><br><span class="line">â”‚   â””â”€â”€ images_platform.list</span><br><span class="line">â”œâ”€â”€ install.sh</span><br><span class="line">â”œâ”€â”€ repos</span><br><span class="line">â”‚   â”œâ”€â”€ app.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ auth.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ common.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ devops.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ insight.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ net.yaml</span><br><span class="line">â”‚   â”œâ”€â”€ resource.yaml</span><br><span class="line">â”‚   â””â”€â”€ web.yaml</span><br><span class="line">â””â”€â”€ scripts</span><br><span class="line"></span><br><span class="line">    â””â”€â”€ init.sh</span><br></pre></td></tr></table></figure><h4 id="ä¿®æ”¹-repo-é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹-repo-é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹ repo é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹ repo é…ç½®æ–‡ä»¶</h4><p>ç‰ˆæœ¬å‘å¸ƒå‰ï¼Œå¦‚æœæœ‰å¢åˆ ç»„ä»¶çš„æƒ…å†µï¼Œéœ€è¦å¯¹åº”ç»„ä»¶çš„è´Ÿè´£äººä¿®æ”¹è‡ªå·±è´Ÿè´£æ¨¡å—çš„å‘å¸ƒé…ç½®æ–‡ä»¶ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># GitHub ä¸Šrepo çš„åç§°ï¼Œå¦‚ï¼šmuzi502/xxx</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">repositoryFullName:</span> <span class="string">muzi502/cyclone</span></span><br><span class="line">  <span class="comment"># ç»„ä»¶çš„æœ€æ–° tag</span></span><br><span class="line">  <span class="attr">currentTag:</span> <span class="string">v0.5.3</span></span><br><span class="line">  <span class="comment"># ä»æŒ‡å®š repo æ‹‰å– helm chart çš„ç›®å½•</span></span><br><span class="line">  <span class="attr">chartPaths:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">manifests/cyclone</span>       <span class="comment"># æ‹‰å– chart çš„è·¯å¾„ï¼Œå¯ä»¥é…ç½®å¤šæ¡</span></span><br><span class="line">  <span class="attr">targetChartPath:</span> <span class="string">addons</span></span><br></pre></td></tr></table></figure><p>æ¯”å¦‚<code>repos/devops.yaml</code> ä¸­ç”¨äºé…ç½®æ”¶é›†æµæ°´çº¿ç»„ä»¶çš„ helm Chartã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">A</span> <span class="string">set</span> <span class="string">of</span> <span class="string">files</span> <span class="string">to</span> <span class="string">collect.</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">collect</span> <span class="string">set</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">repositoryFullName:</span> <span class="string">muzi502/cyclone</span></span><br><span class="line">  <span class="attr">baseVersion:</span> <span class="string">v1.2</span></span><br><span class="line">  <span class="attr">currentTag:</span> <span class="string">v1.2.0</span></span><br><span class="line">  <span class="attr">chartPaths:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">manifests/cyclone</span></span><br><span class="line">  <span class="attr">targetChartPath:</span> <span class="string">addons</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥åªéœ€è¦æ·»åŠ ä¸€æ¬¡å³å¯ï¼Œåç»­æ— å¢åˆ ç»„ä»¶çš„æƒ…å†µæ— éœ€å†å…³å¿ƒè¿™äº›é…ç½®ï¼Œé…ç½®ä¸­çš„ repo ç‰ˆæœ¬ä¹Ÿä¼šä½¿ç”¨è‡ªåŠ¨åŒ–çš„å·¥å…·æ¥å®Œæˆè‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤ï¼Œè¿™æ ·èƒ½å‡å°‘ç ”å‘ä»¬çš„ç»´æŠ¤æˆæœ¬ã€‚</p><h4 id="æ›´æ–°ç»„ä»¶-repo-ç‰ˆæœ¬"><a href="#æ›´æ–°ç»„ä»¶-repo-ç‰ˆæœ¬" class="headerlink" title="æ›´æ–°ç»„ä»¶ repo ç‰ˆæœ¬"></a>æ›´æ–°ç»„ä»¶ repo ç‰ˆæœ¬</h4><p>å‘å¸ƒå‰ç½®å·¥ä½œéƒ½å®Œæˆä¹‹åï¼ŒPM ä¼šé€šçŸ¥å‘å¸ƒäººå‘˜å¼€å§‹å‘å¸ƒã€‚å› ä¸ºå‚æ•°åŒ–æ„å»ºå’Œ Job é›†ä¸­å¼ç®¡ç†ç­‰å¼ºä¾èµ–çš„ç‰¹æ€§å…¶ä»– CI å·¥å…·æ— æ³•å¾ˆå¥½åœ°æ›¿ä»£ï¼Œç›®å‰æˆ‘ä»¬çš„å‘å¸ƒæµæ°´çº¿ä¾æ—§æ˜¯ä½¿ç”¨çš„ Jenkins ã€‚</p><p>å‘å¸ƒäººå‘˜åœ¨ Jenkins ä¸Šæ‰§è¡Œå‘å¸ƒæµæ°´çº¿çš„ä»»åŠ¡ï¼Œæµæ°´çº¿ä¸­é¦–å…ˆä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·è§£æ repo é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®ç»„ä»¶æ‰“ repo tag æ—¶å€™çš„ message ä¿¡æ¯æ”¶é›†æœ€æ–°çš„ tag ç‰ˆæœ¬å·ã€‚æ”¶é›†å®Œæ¯•ä¹‹åå‘å¸ƒæµæ°´çº¿è‡ªåŠ¨æäº¤ä¸€ä¸ª PR/MR åˆ° repo çš„å‘å¸ƒåˆ†æ”¯ã€‚å¹¶é€šè‡ªåŠ¨å‘é€ç¾¤æ¶ˆæ¯é€šçŸ¥è®©æ‰€æœ‰ repo çš„è´Ÿè´£äººç¡®è®¤æ”¶é›†åˆ°çš„ repo tag æ˜¯å¦æ­£ç¡®ã€‚ç¡®è®¤æ— è¯¯ä¹‹åï¼Œå°† PR/MR è‡ªåŠ¨åˆå¹¶åˆ°å‘å¸ƒåˆ†æ”¯ã€‚</p><h4 id="æ›´æ–°ç»„ä»¶-Chart-æ–‡ä»¶"><a href="#æ›´æ–°ç»„ä»¶-Chart-æ–‡ä»¶" class="headerlink" title="æ›´æ–°ç»„ä»¶ Chart æ–‡ä»¶"></a>æ›´æ–°ç»„ä»¶ Chart æ–‡ä»¶</h4><p>æ›´æ–°å®Œç»„ä»¶ repo çš„ tag ä¹‹åï¼Œè¿™æ ·å°±èƒ½ç¡®å®šæœ¬æ¬¡å‘å¸ƒéœ€è¦åˆ°å“ªäº› repo çš„å“ªä¸ª repo tag ä¸‹å»æ”¶é›†ç»„ä»¶éƒ¨ç½²çš„ Chart æ–‡ä»¶ï¼Œåœ¨è¿™ä¸€æ­¥ä¼šä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·ï¼Œæ ¹æ® repos ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶ï¼Œæ”¶é›†å¯¹åº”ç»„ä»¶çš„ Chart æ–‡ä»¶åˆ°å‘å¸ƒ repo çš„æŒ‡å®šç›®å½•ä¸‹ï¼Œä¸€èˆ¬é»˜è®¤ä¸º addons ç›®å½•ã€‚</p><h4 id="æ›´æ–°ç»„ä»¶ç‰ˆæœ¬é…ç½®æ–‡ä»¶"><a href="#æ›´æ–°ç»„ä»¶ç‰ˆæœ¬é…ç½®æ–‡ä»¶" class="headerlink" title="æ›´æ–°ç»„ä»¶ç‰ˆæœ¬é…ç½®æ–‡ä»¶"></a>æ›´æ–°ç»„ä»¶ç‰ˆæœ¬é…ç½®æ–‡ä»¶</h4><p>æ ¹æ®æ”¶é›†åˆ°çš„ç»„ä»¶ Chart ç‰ˆæœ¬å·æ›´æ–° <code>version.yml</code>è¿™ä¸ªç»„ä»¶ç‰ˆæœ¬é…ç½®æ–‡ä»¶ä¸­å¯¹åº”çš„ç‰ˆæœ¬ï¼Œéƒ¨ç½²çš„æ—¶å€™ä¼šæ ¹æ®è¿™ä¸ªæ–‡ä»¶å»éƒ¨ç½²å“ªäº›ç»„ä»¶ä»¥åŠéƒ¨ç½²ç»„ä»¶çš„ç‰ˆæœ¬æ˜¯ä»€ä¹ˆã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">modules:</span> <span class="comment"># æ¨¡å—åˆ—è¡¨ï¼Œä¸€ä¸ªå¹³å°å¯ä»¥æœ‰å¤šä¸ª modules</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="comment"># æ¨¡å—å</span></span><br><span class="line">    <span class="attr">description:</span> <span class="comment"># æ¨¡å—çš„æè¿°ä¿¡æ¯</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="comment"># æ˜¯å¦å¯ç”¨æ¨¡å—</span></span><br><span class="line">    <span class="attr">addons:</span> <span class="comment"># æ¨¡å—ä¸­çš„ç»„ä»¶åˆ—è¡¨</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="comment"># ç»„ä»¶çš„åç§°ï¼Œ å¿…é¡»å’Œç»„ä»¶åä»¥åŠ Chart.yaml name ä¿æŒä¸€è‡´</span></span><br><span class="line">      <span class="attr">description:</span> <span class="comment"># ç»„ä»¶çš„æè¿°ä¿¡æ¯</span></span><br><span class="line">      <span class="attr">enable:</span> <span class="comment"># æ˜¯å¦å¯ç”¨æ¨¡å—</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="comment"># ç»„ä»¶è¿è¡Œçš„ namespace</span></span><br><span class="line">      <span class="attr">version:</span> <span class="comment"># ç»„ä»¶çš„ç‰ˆæœ¬å·ï¼Œå¿…é¡»å’Œ repo tag Chart.yaml version ä¿æŒä¸€è‡´</span></span><br></pre></td></tr></table></figure><h4 id="æ›´æ–°å¹³å°é•œåƒåˆ—è¡¨"><a href="#æ›´æ–°å¹³å°é•œåƒåˆ—è¡¨" class="headerlink" title="æ›´æ–°å¹³å°é•œåƒåˆ—è¡¨"></a>æ›´æ–°å¹³å°é•œåƒåˆ—è¡¨</h4><p>ä½¿ç”¨ Helm Template æ¸²æŸ“å‡ºåŸç”Ÿçš„ K8s YAMLå†…å®¹ï¼Œä½¿ç”¨ grep è¿‡æ»¤å‡ºå¹³å°ç»„ä»¶éƒ¨ç½²æ‰€éœ€è¦çš„é•œåƒï¼Œå¹¶å°†è¾“å‡ºçš„ç»“æœé‡å®šå‘åˆ° <code>images/images_platform.list</code> æ–‡ä»¶ä¸­ï¼Œè¿™äº›é•œåƒæ˜¯éƒ¨ç½²éƒ¨ç½²ç»„ä»¶å¿…é¡»ç”¨åˆ°çš„é•œåƒã€‚å¦å¤–è¿˜æœ‰ä¸‰ç§å…¶ä»–çš„é•œåƒå¦‚ä¸‹ï¼š</p><ul><li>images_extra.listï¼šä¸€äº›é¢å¤–çš„é•œåƒç¬¬ä¸‰æ–¹é•œåƒã€‚</li><li>images_base.listï¼šä¸€äº›å¹³å° DevOps ç»„ä»¶ç”¨åˆ°çš„ base é•œåƒï¼Œæ¯”å¦‚ golang, nodejs, maven ç­‰ã€‚</li><li>images_app_store.listï¼š å¹³å°åº”ç”¨å•†åº—ä¸­åº”ç”¨éƒ¨ç½²éœ€è¦çš„é•œåƒï¼Œæ¯”å¦‚ Wordpressï¼ŒGitLabï¼ŒHarbor ç­‰ã€‚</li></ul><p>å¤„ç†è¿™äº›é•œåƒåˆ—è¡¨æ—¶ä¹Ÿå¾ˆç®€å•ï¼Œå³ä½¿ç”¨ find æŸ¥æ‰¾å„ä¸ªç»„ä»¶ Chart ä¸­çš„ images_xxx.list æ–‡ä»¶ï¼Œå°†è¿™äº›é•œåƒç»Ÿä¸€åˆå¹¶åˆ° images ç›®å½•ä¸‹å¯¹åº”çš„æ–‡ä»¶ä¸­ã€‚</p><p>åœ¨å‘å¸ƒ repo ä¸­è¿™äº›é•œåƒåˆ—è¡¨éƒ½æ˜¯è‡ªåŠ¨åŒ–å®Œæˆäº†ï¼Œå¹¶ä¸”ç¦æ­¢ä¸ªäººæ‰‹åŠ¨åœ¨å‘å¸ƒ repo ä¸­è¿›è¡Œæ›´æ–°ï¼Œè¿™æ ·èƒ½é¿å…ä¸€äº›äººä¸ºçš„ä½çº§é”™è¯¯ï¼Œæ¯”å¦‚é•œåƒç‰ˆæœ¬é”™è¯¯ã€‚æˆ‘ä»¬ä½¿ç”¨è¿™ç§æ–¹å¼æ¥ç®¡ç†å¹³å°æ‰€éœ€è¦çš„ 200 å¤šä¸ªé•œåƒï¼Œå¾ˆå°‘å› ä¸ºé•œåƒåˆ—è¡¨çš„é”™è¯¯è€Œå¯¼è‡´å‘å¸ƒäº‹æ•…ï¼Œæå¤§åœ°æé«˜äº†ç‰ˆæœ¬å‘å¸ƒçš„æ•ˆç‡ã€‚</p><h4 id="æäº¤æ”¶é›†äº§ç‰©"><a href="#æäº¤æ”¶é›†äº§ç‰©" class="headerlink" title="æäº¤æ”¶é›†äº§ç‰©"></a>æäº¤æ”¶é›†äº§ç‰©</h4><p>ä¸Šè¿°æ­¥éª¤éƒ½å®Œæˆä¹‹åä¼šå°†è¿™äº›æ”¶é›†çš„æ–‡ä»¶æäº¤ä¸€ä¸ª PR/MR åˆ°å‘å¸ƒ repoï¼Œå‘å¸ƒ repo ä¼šè§¦å‘ä¸€ä¸ªé¢å¤–çš„æµæ°´çº¿å»æ£€æŸ¥é•œåƒåˆ—è¡¨ä¸­çš„é•œåƒæ˜¯å¦å­˜åœ¨äºå†…éƒ¨çš„é•œåƒä»“åº“ä¸­ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¼šå‘é€ç¾¤æ¶ˆæ¯é€šçŸ¥ç ”å‘å‡†å¤‡å¥½é•œåƒã€‚</p><p>ç­‰é•œåƒéƒ½å‡†å¤‡å®Œæ¯•ä¹‹åï¼Œä¼šå°†è¿™ä¸ª PR/MR åˆå¹¶åˆ°å‘å¸ƒ repo ç›¸åº”çš„åˆ†æ”¯ã€‚åˆå¹¶å®Œ PR/MR ä¹‹åè‡³æ­¤ç ”å‘éœ€è¦å‚ä¸çš„å‘å¸ƒæµç¨‹å·²ç»å®Œæ¯•ï¼Œrepo çš„å‘å¸ƒåˆ†æ”¯æ— éœ€å†ä¿®æ”¹å…¶ä»–çš„å†…å®¹ï¼Œè¿™æ—¶ä¼šç»™å½“å‰å‘å¸ƒåˆ†æ”¯çš„æœ€æ–° commit æ‰“ä¸Šä¸€ä¸ª repo tagï¼Œrepo tag çš„åç§°å°±æ˜¯äº§å“çš„ç‰ˆæœ¬å·ï¼Œæ¯”å¦‚ <code>v2.10.2</code> ã€‚</p><p>åˆ°æ­¤ä¸ºæ­¢å®Œæˆäº†å‘å¸ƒç¯èŠ‚çš„ç»å¤§å¤šæ•°ä»»åŠ¡ï¼Œå‰©ä¸‹çš„åªæœ‰æ‰“åŒ…å®‰è£…åŒ…è¿™ä¸ªæ”¶å°¾å·¥ä½œã€‚</p><h4 id="æ‰“åŒ…æµç¨‹"><a href="#æ‰“åŒ…æµç¨‹" class="headerlink" title="æ‰“åŒ…æµç¨‹"></a>æ‰“åŒ…æµç¨‹</h4><p>ä»¥ä¸Šå‘å¸ƒæµç¨‹éœ€è¦ä¼—å¤šç ”å‘æ¥å‚ä¸ç¡®ä¿å‘å¸ƒç¯èŠ‚æ”¶é›†åˆ°çš„ç»„ä»¶ Chart å’Œé•œåƒæ˜¯æ­£ç¡®çš„ï¼Œæ”¶é›†å®Œæˆè¿™äº›æ–‡ä»¶ä¹‹åå°±ç»§ç»­è¿›è¡Œæ‰“åŒ…æ“ä½œã€‚æ‰“åŒ…çš„ç›®çš„æ˜¯å°†äº§å“éƒ¨ç½²ä¾èµ–çš„æ–‡ä»¶å’Œé•œåƒæ‰“åŒ…åœ¨ä¸€èµ·ï¼Œåˆ¶ä½œæˆä¸€ä¸ªç¦»çº¿å®‰è£…åŒ…ã€‚æ‰“åŒ…æµç¨‹å¾ˆç®€å•ï¼Œå¤§è‡´å¯åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p><ul><li>æ‰“åŒ… Helm Chart</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p charts &amp;&amp; rm -rf charts/* || <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> dir <span class="keyword">in</span> $(find <span class="variable">$&#123;ADDONS_PATH&#125;</span> -<span class="built_in">type</span> f | sed -n <span class="string">'s/Chart.yaml//p'</span>); <span class="keyword">do</span> helm package <span class="variable">$&#123;dir&#125;</span> -d charts; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">chown -R 10000:10000 charts &amp;&amp; tar -cpvf charts.tar.gz charts</span><br></pre></td></tr></table></figure><ul><li>æ‰“åŒ…é•œåƒ</li></ul><p>æ ¹æ® images ç›®å½•ä¸‹çš„é•œåƒåˆ—è¡¨å°†é•œåƒåŒæ­¥åˆ°ä¸€ä¸ªæŒ‡å®šçš„ Registry ä¸­ï¼Œä¸ºäº†æå‡æ‰“åŒ…æ•ˆç‡ï¼Œè¿™ä¸ª Registry é•¿æœŸä¿ç•™ã€‚ç„¶åä½¿ç”¨ç¡¬è¿æ¥çš„æ–¹å¼å°†é•œåƒæ–‡ä»¶ç›´æ¥ä»è¿™ä¸ª Registry å­˜å‚¨ç›®å½•ä¸­ç›´æ¥æå–å‡ºæ¥ï¼Œå¹¶æ‰“åŒ…æˆä¸€ä¸ª tar æ ¼å¼çš„æ–‡ä»¶æ”¾åˆ°äº§å“å®‰è£…åŒ…ä¸­ã€‚å…³äºé•œåƒåŒæ­¥çš„è¯¦ç»†åŸç†å’Œä¸€äº›ä¹‹å‰åšçš„ä¼˜åŒ–å¯ä»¥å‚è€ƒ <a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 åœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­çš„åº”ç”¨</a> å’Œ <a href="https://blog.k8s.li/select-registry-images.html">ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼</a>è¿™ä¸¤ç¯‡æ–‡ç« ã€‚</p><ul><li>æ‰“åŒ…ä¸Šä¼ </li></ul><p>é•œåƒå’Œç»„ä»¶ Chart éƒ½æ‰“åŒ…å®Œæˆä¹‹åï¼Œå†å°†ä¸€äº›å®‰è£…è„šæœ¬å’Œé…ç½®æ–‡ä»¶å¤åˆ¶åˆ°å®‰è£…åŒ…ä¸­ã€‚æœ€åå°†è¿™äº›å†…å®¹ä¸€å¹¶æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œå¹¶å°†å®ƒä¸Šä¼ ç‰¹æ€§çš„å­˜å‚¨æœåŠ¡å™¨ä¸Šã€‚ä¹‹åä¼šæœ‰ä¸“é—¨çš„æµ‹è¯•å›¢é˜Ÿæ¥å¯¹æ‰“å‡ºæ¥å®‰è£…åŒ…è¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡ä¹‹åå°±å¯ä»¥å¯¹å¤–å‘å¸ƒäº¤ä»˜ç»™å®¢æˆ·ä½¿ç”¨ã€‚</p><h4 id="å‘å¸ƒ-release-åˆ†æ”¯"><a href="#å‘å¸ƒ-release-åˆ†æ”¯" class="headerlink" title="å‘å¸ƒ release åˆ†æ”¯"></a>å‘å¸ƒ release åˆ†æ”¯</h4><p>è‡³æ­¤å¹³å°ç»„ä»¶å‘å¸ƒæµç¨‹åˆ°æ­¤å®Œæ¯•ï¼Œå½“ä¸€ä¸ªæ­£å¼çš„ç‰ˆæœ¬å‘å¸ƒå®Œæˆä¹‹åï¼Œæˆ‘ä»¬ä¼šé‡‡ç”¨ Kubernetes ç¤¾åŒºç‰ˆæœ¬ç®¡ç†çš„æ–¹å¼ç»™å‘å¸ƒ repo åˆ›å»ºä¸€ä¸ª release åˆ†æ”¯ï¼Œæ¯”å¦‚ release-2.10 åˆ†æ”¯ã€‚åç»­æ‰€æœ‰çš„è¡¥ä¸åŒ…å’Œä¸€äº› OEM å®šåˆ¶åŒ–å¼€å‘çš„é¡¹ç›®éƒ½ä¼šåŸºäºè¿™ç§ release åˆ†æ”¯æ¥è¿›è¡Œå¼€å‘ã€‚</p><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="é•œåƒç®¡ç†"><a href="#é•œåƒç®¡ç†" class="headerlink" title="é•œåƒç®¡ç†"></a>é•œåƒç®¡ç†</h3><p>ä¸ºäº†é€‚é…è¿™å¥—å‘å¸ƒæµç¨‹ï¼Œæˆ‘ä»¬å°† Kubernetes é›†ç¾¤éƒ¨ç½²å’Œå¹³å°ç»„éƒ¨ç½²å°†æ‰€ä½¿ç”¨çš„é•œåƒæ”¶æ•›åˆ° library å’Œ release ä¸¤ä¸ª projectï¼š</p><ul><li>å¯¹äºå¼€æºçš„é•œåƒï¼Œå³ç›´æ¥ä½¿ç”¨ docker.ioã€k8s.gcr.ioã€quay.io è¿™äº›å®˜æ–¹ registry ä¸­çš„é•œåƒï¼Œå°†ä¼šç»Ÿä¸€ä½¿ç”¨ library è¿™ä¸ª projectï¼Œæ¯”å¦‚ <code>library/nginx:1.19.0</code>ã€‚</li><li>å¯¹äºå¹³å°ç»„ä»¶è‡ªèº«çš„é•œåƒï¼Œå¦‚è‡ªç ”ç»„ä»¶ä½¿ç”¨è‡ªå·±çš„ Dockerfile build å‡ºæ¥çš„é•œåƒåˆ™ç»Ÿä¸€ä½¿ç”¨ release è¿™ä¸ª projectï¼Œæ¯”å¦‚ <code>release/cyclone:v1.2.0</code> ã€‚</li></ul><p>release project ä¸­çš„é•œåƒæ˜¯æˆ‘ä»¬å¹³å°ç»„ä»¶çš„é•œåƒï¼Œèƒ½å¾ˆæ–¹ä¾¿åœ°çŸ¥é“è¯¥é•œåƒæ¥è‡ªå“ªä¸ªç»„ä»¶ä»¥åŠæ˜¯å¦‚ä½•æ„å»ºçš„ã€‚ä½†å°†ä¸€äº›ä¸Šæ¸¸å®˜æ–¹çš„é•œåƒç»Ÿä¸€åˆ° library è¿™ä¸ª project ä¹‹åï¼Œå°±å¾ˆéš¾çŸ¥é“è¯¥é•œåƒçš„åŸé•œåƒæ˜¯ä»€ä¹ˆäº†ã€‚æ¯”å¦‚ <code>library/coredns:1.7.0</code> è¿™ä¸ªé•œåƒï¼Œä»…ä»…é€šè¿‡è¿™ä¸ªåå­—å¾ˆéš¾è¾¨åˆ«å‡ºå®ƒæ˜¯æ¥è‡ª docker.io è¿˜æ˜¯ k8s.gcr.ioã€‚å› æ­¤ä¸ºäº†è§£å†³è¿™ç±»é—®é¢˜å’Œæ–¹ä¾¿è¿½æº¯ä¸Šæ¸¸åŸé•œåƒï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ç»Ÿä¸€çš„é•œåƒåŒæ­¥é…ç½®æ–‡ä»¶æ¥å¤„ç†è¿™ç§è½¬æ¢å…³ç³»ï¼Œåœ¨æ‰“åŒ…å‘å¸ƒçš„æ—¶å€™æˆ‘ä»¬ä¼šå°†è¿™äº›é•œåƒè¿›è¡Œè‡ªåŠ¨åœ°è½¬æ¢å’Œå¤„ç†ï¼Œè¿™æ ·é¿å…äº†å¾ˆå¤šæ‰‹åŠ¨ push é•œåƒçš„éº»çƒ¦å’Œä½¿ç”¨é•œåƒé”™è¯¯çš„é—®é¢˜ã€‚</p><ul><li>images_origin.yaml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># kubeadm core images</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-apiserver</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/kube-apiserver</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-controller-manager</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/kube-controller-manager</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-proxy</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/kube-proxy</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/kube-scheduler</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/kube-scheduler</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/coredns</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/coredns</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/pause</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/pause</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes addons</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/dns/k8s-dns-node-cache</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/k8s-dns-node-cache</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/cluster-proportional-autoscaler-amd64</span></span><br><span class="line"><span class="comment"># network plugin</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/cni</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/calico-cni</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/kube-controllers</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/calico-kube-controllers</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/node</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/calico-node</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/calico/typha</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/calico-typha</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">quay.io/coreos/flannel</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/flannel</span></span><br><span class="line"><span class="comment"># nginx for daemonset and offline resources</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">docker.io/library/nginx</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/nginx</span></span><br><span class="line"><span class="comment"># docker registry for offline resources</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">docker.io/library/registry</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/registry</span></span><br><span class="line"><span class="comment"># helm chartmuseum for offline resources</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">src:</span> <span class="string">ghcr.io/helm/chartmuseum</span></span><br><span class="line"> <span class="attr">dest:</span> <span class="string">library/chartmuseum</span></span><br><span class="line"><span class="comment"># yq eval -j images.yml | jq -r '.[]|select(.dest=="'"$&#123;image&#125;"'") | .src'</span></span><br></pre></td></tr></table></figure><h3 id="è¡¥ä¸åŒ…ç®¡ç†"><a href="#è¡¥ä¸åŒ…ç®¡ç†" class="headerlink" title="è¡¥ä¸åŒ…ç®¡ç†"></a>è¡¥ä¸åŒ…ç®¡ç†</h3><p>äº§å“çš„æ­£å¼ç‰ˆæœ¬åœ¨å‘å¸ƒä¸ä¹…ä¹‹åï¼Œåœ¨å®¢æˆ·ä½¿ç”¨çš„è¿‡ç¨‹ä¸­å¦‚æœå‘ç°æ–°çš„ bug æˆ–è€…å®¢æˆ·æå‡ºä¸€äº›æ–°çš„éœ€æ±‚ã€‚æˆ‘ä»¬è¿™æ—¶ä¼šåŸºäºè¿™äº›éœ€æ±‚å‘å¸ƒä¸€ä¸ªçƒ­æ›´æ–°è¡¥ä¸åŒ…ï¼Œè€Œä¸æ˜¯å‘å¸ƒä¸€ä¸ªæ–°ç‰ˆæœ¬ã€‚å› ä¸ºçƒ­æ›´æ–°è¡¥ä¸åŒ…æ‰€æ¶‰åŠä¿®æ”¹çš„ç»„ä»¶æ¯”è¾ƒå°‘ï¼Œéœ€è¦å‚ä¸çš„ç ”å‘äººå‘˜ä¹Ÿæ¯”è¾ƒå°‘ï¼Œè¿™æ ·èƒ½å¤ŸèŠ‚çœå¾ˆå¤šäººåŠ›æˆæœ¬ã€‚åŒæ—¶é‡‡ç”¨è¡¥ä¸åŒ…çš„æ–¹å¼è¿›è¡Œçƒ­æ›´æ–°èƒ½å¤Ÿä¿éšœå®¢æˆ·ç¯å¢ƒçš„ç¨³å®šè¿è¡Œï¼Œå¹³å°ç¨³å®šæ€§ä¹Ÿèƒ½å¤Ÿå¾—åˆ°ä¿éšœã€‚</p><p>åœ¨å‘å¸ƒæµç¨‹ä¸­æˆ‘ä»¬æ›¾æåˆ°ï¼Œå‘å¸ƒè¿‡ç¨‹ä¸­ä¼šç»™ repo æ‰“ä¸Šä¸€ä¸ªäº§å“ç‰ˆæœ¬çš„ tagï¼Œæ¯”å¦‚ <code>v2.10.2</code>ï¼Œåœ¨è¿™é‡Œéœ€è¦å¼ºè°ƒä¸€ä¸‹ï¼Œ<strong>è¿™ç‰ˆæœ¬å·ç‰¹åˆ«é‡è¦ã€‚</strong>åç»­æ‰€æœ‰çš„è¡¥ä¸åŒ…å‘å¸ƒéƒ½ä¼šå¼ºä¾èµ–äºæ­¤ç‰ˆæœ¬å·ï¼Œå› æ­¤æˆ‘ä»¬ä¼šåœ¨ repo çš„ä¿æŠ¤ tag é‡Œå°†è¿™ç§æ­£å¼å‘å¸ƒçš„ repo tag è¿›è¡Œé”å®šä¿æŠ¤èµ·æ¥ï¼Œç¦æ­¢<code>--force</code> æ–¹å¼è¦†ç›–ã€‚åœ¨éƒ¨ç½²çš„æ—¶å€™ï¼Œè¿™ä¸ªç‰ˆæœ¬å·ä¹Ÿä¼šä»¥ configmap çš„æ–¹å¼è®°å½•èµ·æ¥ï¼Œç”¨äºåœ¨å‰ç«¯ web é¡µé¢ä¸Šå±•ç¤ºå¹³å°ç‰ˆæœ¬å’Œåç»­å®‰è£…è¡¥ä¸åŒ…æ—¶è¿›è¡Œç‰ˆæœ¬æ ¡éªŒã€‚</p><p>è¡¥ä¸åŒ…å‘å¸ƒçš„é¢‘ç‡ä¹Ÿæ˜¯è›®é«˜çš„ï¼Œä»å»å¹´äº”æœˆä»½åˆ°ç°åœ¨ä¸€å¹´å·¦å³çš„æ—¶é—´é‡Œï¼Œè‡ªå·±è´Ÿè´£çš„è¡¥ä¸åŒ…å‘å¸ƒæ•°é‡å¤§çº¦æœ‰ 50 ä¸ªå·¦å³ï¼Œå¹³å‡æ¯å‘¨ä¸€ä¸ªã€‚åŒä¸€ä¸ªç‰ˆæœ¬æˆ– OEM é¡¹ç›®ï¼Œè¡¥ä¸åŒ…å‘å¸ƒçš„æ•°é‡ä¹Ÿå¤§ä¸ç›¸åŒï¼ˆå°‘åˆ™ä¸‰å››ä¸ªï¼Œå¤šåˆ™åä¸ƒå…«ä¸ªï¼‰ã€‚å½“è¡¥ä¸åŒ…çš„æ•°é‡è¶Šæ¥è¶Šå¤šæ—¶ï¼Œå°±éœ€è¦ä¸€å¥—æœºåˆ¶æ¥ç®¡ç†è¿™äº›å¤æ‚ç¯å¢ƒçš„è¡¥ä¸åŒ…ã€‚ä¸ç„¶çš„è¯ç‰ˆæœ¬å‘å¸ƒå°†ä¼šå˜å¾—ååˆ†æ··ä¹±ï¼Œå¯¼è‡´å®¢æˆ·ç”Ÿäº§ç¯å¢ƒå®‰è£…ä¸Šé”™è¯¯ç‰ˆæœ¬çš„ç»„ä»¶ï¼Œç”±æ­¤å¯èƒ½å¯¼è‡´ç”Ÿäº§äº‹æ•…ã€‚</p><p>å› æ­¤åœ¨è®¾è®¡è¡¥ä¸åŒ…å‘å¸ƒæ–¹æ¡ˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¾æ—§å’Œæ ‡å‡†äº§å“çš„å‘å¸ƒæµç¨‹ç»“åˆèµ·æ¥ï¼Œä½¿ç”¨ git repo tag + åˆ†æ”¯çš„æ–¹å¼æ¥ç®¡ç†è¿™äº›è¡¥ä¸åŒ…çš„å‘å¸ƒå·¥ä½œã€‚æ•´ä½“çš„å‘å¸ƒæµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>PM å®‰æ’ç ”å‘äººå‘˜ä¿®å¤ç»„ä»¶ bugï¼›</li><li>ç»„ä»¶è´Ÿè´£äººå®Œæˆå†’çƒŸæµ‹è¯•ï¼Œå¹¶åœ¨å†…éƒ¨ DevOps å¹³å°æ‰“é•œåƒå’Œ repo tagï¼›</li><li>ç»„ä»¶è´Ÿè´£äººä¿®æ”¹å‘å¸ƒ repo ä¸­ addons ç›®å½•ä¸‹å¯¹åº”ç»„ä»¶çš„ chart æ–‡ä»¶ï¼›</li><li>PM é€šçŸ¥å‘å¸ƒäººå‘˜å¼€å§‹å‘å¸ƒè¡¥ä¸åŒ…ï¼›</li><li>å‘å¸ƒäººå‘˜è¿è¡Œæµæ°´çº¿ä»»åŠ¡è‡ªåŠ¨åŒ–æ‰“è¡¥ä¸åŒ…ï¼›</li><li>æµ‹è¯•äººå‘˜éªŒè¯è¡¥ä¸åŒ…çš„è´¨é‡ï¼›</li></ul><p>åœ¨æ‰“åŒ…è¡¥ä¸åŒ…çš„æ—¶å€™æˆ‘ä»¬é‡‡ç”¨ git diff çš„æ–¹å¼ï¼Œå°†æœ¬æ¬¡è¡¥ä¸åŒ…å‘å¸ƒæ‰€ä¿®æ”¹çš„ç»„ä»¶ Chart æ–‡ä»¶ç­›é€‰å‡ºæ¥ï¼Œåªå¯¹è¿™äº›ä¿®æ”¹çš„ç»„ä»¶è¿›è¡Œæ‰“åŒ…æ“ä½œã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> chart <span class="keyword">in</span> $(git diff --name-only --diff-filter=AM --ignore-space-at-eol --ignore-space-change <span class="variable">$&#123;DENPENDENCY_VERSION&#125;</span> <span class="variable">$&#123;NEW_VERSION&#125;</span> <span class="variable">$&#123;ADDONS_PATH&#125;</span> | sed -n <span class="string">'s/Chart.yaml//p'</span> | sort -u );<span class="keyword">do</span> cp -rf <span class="variable">$&#123;chart&#125;</span> <span class="variable">$&#123;HOTFIX_YAML_DIR&#125;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>å¯¹äºä¸€äº› OEM é¡¹ç›®ï¼Œæˆ‘ä»¬ä¼šåŸºäºäº§å“ç‰ˆæœ¬çš„åˆ†æ”¯åˆ›å»ºä¸€ä¸ªä¸è¯¥ OEM äº§å“ç›¸å¯¹åº”çš„å‘å¸ƒåˆ†æ”¯ï¼Œå¦‚ <code>release-2.10/muzi502</code>ï¼Œå³ä»£è¡¨ muzi502 è¿™ä¸ªå®¢æˆ·ä½¿ç”¨çš„äº§å“ç‰ˆæœ¬æ˜¯åŸºäº 2.10 ç‰ˆæœ¬çš„ã€‚åœ¨è¿™ä¸ªåˆ†æ”¯ä¸Šæˆ‘ä»¬åŸºäºä¸Šè¿°æ­¥éª¤è¿›è¡Œ OEM è¡¥ä¸åŒ…çš„å‘å¸ƒã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot;
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubernetes" scheme="https://blog.k8s.li/tags/kubernetes/"/>
    
      <category term="PaaS" scheme="https://blog.k8s.li/tags/PaaS/"/>
    
      <category term="toB" scheme="https://blog.k8s.li/tags/toB/"/>
    
  </entry>
  
  <entry>
    <title>2021 äº”ä¸€å‡æœŸç¯å¤ªæ¹–éª‘è¡Œä¹‹æ—…</title>
    <link href="https://blog.k8s.li/taihu.html"/>
    <id>https://blog.k8s.li/taihu.html</id>
    <published>2021-05-29T16:00:00.000Z</published>
    <updated>2021-05-29T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>è°ƒä¼‘ä¸¤å¤©ç»ˆäºè¿æ¥äº†äº”å¤©çš„äº”ä¸€å‡æœŸï¼Œå®é™…ä¸Šä»…ä»…æ”¾äº†ä¸€å¤©å‡æœŸï¼Œä¹Ÿæœ‰ç½‘å‹è°ƒä¾ƒåˆ° <strong>äººä»¬ 996 è¿ç»­å·¥ä½œ 12 å¤©ä»è€Œæ¢å– 5 å¤©å‡æœŸå»çºªå¿µè¿™ä¸ªå·¥äººè·å¾— 8 å°æ—¶å·¥ä½œåˆ¶çš„èŠ‚æ—¥</strong>ã€‚</p><p>æ˜¥èŠ‚çš„æ—¶å€™å°±åœ°è¿‡å¹´æ²¡æœ‰å›å®¶ï¼Œç‹¬è‡ªä¸€äººåœ¨æ­å·å‘†äº† 7 å¤©ï¼Œè¿™ 7 å¤©ä¸€ç›´å®…åœ¨å®¶é‡Œçœ‹ä¹¦å’Œè¿½ç•ªï¼Œç”šè‡³è¿å°åŒºçš„é—¨éƒ½æ²¡å‡ºå»è¿‡ã€‚ä¸ºäº†ä¸è®©å®è´µçš„äº”ä¸€å‡æœŸçƒ‚åœ¨å®¶é‡Œï¼Œåœ¨ 4 æœˆåˆçš„æ—¶å€™å°±å¼€å§‹è®¡åˆ’ç¯å¤ªæ¹–çš„éª‘è¡Œä¹‹æ—…ã€‚</p><p>è®°å¾—ä¸Šä¸€æ¬¡é•¿è¿œçš„éª‘è¡Œè¿˜æ˜¯é«˜è€ƒå®Œçš„é‚£ä¸ªæš‘å‡ï¼Œä¹Ÿæ˜¯ç‹¬è‡ªä¸€äººä»å®¶éª‘è½¦å»åŒ—äº¬ï¼Œæ¥å›ç”¨äº†äº”å¤©æ—¶é—´ã€‚ç®€å•ä¼°è®¡äº†ä¸€ä¸‹ä»æ­å·éª‘è¡Œåˆ°å¤ªæ¹–ï¼Œç„¶åç¯å¤ªæ¹–éª‘è¡Œä¸€å‘¨ï¼Œæ€»çš„è·¯ç¨‹å¤§æ¦‚ 520 å…¬é‡Œï¼Œä¹Ÿæ­£å¥½äº”å¤©çš„æ—¶é—´ã€‚ç­‰åˆ°å›æ¥çš„æ—¶å€™å¦‚æœèº«ä½“åƒä¸æ¶ˆå†è°ƒä¼‘å‡ å¤©ä¹Ÿæ²¡å•¥å¤§ç¢ã€‚äºæ˜¯ï¼Œä¸€ä¸ªç¯å¤ªæ¹–éª‘è¡Œçš„è®¡åˆ’æ…¢æ…¢åœ¨è„‘ä¸­é…é…¿äº†ï¼Œé‚£ä¹ˆå¼€å§‹å›é¡¾è¿™æ®µéª‘è¡Œä¹‹æ—…å§ï¼š</p><h2 id="å‡†å¤‡ç¯‡"><a href="#å‡†å¤‡ç¯‡" class="headerlink" title="å‡†å¤‡ç¯‡"></a>å‡†å¤‡ç¯‡</h2><p>å±±åœ°è½¦æ˜¯å»å¹´åˆšæ¥æ­å·æ—¶å°±ä¹°çš„ï¼Œåœ¨é—²é±¼ä¸ŠèŠ±äº† 800 å—é’±ä¹°çš„ 2012 æ¬¾ GIANT æ·å®‰ç‰¹ ATX770-Dï¼Œåˆ°ç°åœ¨ä¹Ÿæ˜¯æœ‰äº›å¹´å¤´äº†ã€‚ä¸Šä¸‹ç­éª‘è¡Œç”¨äº†ä¸€å¹´å¤šä¹Ÿæ²¡å•¥å¤§æ¯›ç—…ï¼Œè¿™ä¸€å¹´é—´å°±åè½®å¡”åŸºé‡Œçš„è½´æ‰¿åäº†ä¸€æ¬¡ï¼Œè‡ªå·±ä¹°æ¥å·¥å…·æ‹†å¼€ç»™è½´æ‰¿è¡¥ä¸Šç¼ºæŸçš„ç å­å¹¶ä¸Šå¥½é»„æ²¹å¯†å°å°±ä¿®å¥½äº†ã€‚</p><p><img src="https://p.k8s.li/20210501_021308214_iOS.jpg" alt=""></p><p>åœ¨äº”æœˆçš„æœ€åä¸¤å‘¨ä¸€ç›´åœ¨å‡†å¤‡éª‘è¡Œçš„è£…å¤‡ï¼ŒæŠŠåè½®çš„å¤–èƒæ¢äº†ä¸€æ¡æ–°çš„ï¼Œå› ä¸ºæ—§çš„ç£¨æŸå¤ªä¸¥é‡äº†ï¼Œä¸­é—´éƒ¨åˆ†åŸºæœ¬ç£¨å¹³äº†ï¼Œå¦‚æœä¸æ¢æ‰çš„è¯ä¿ä¸å‡†è¿™ä¸€è·¯ä¼šçˆ†èƒã€‚å¦å¤–åˆå‡†å¤‡äº†ä¸¤æ¡å†…èƒä»¥åº”å¯¹çˆ†èƒçš„æƒ…å†µã€‚åˆä¹°äº†ä¸€ä¸ªäºŒæ°§åŒ–ç¢³å……æ°”æ³µå’Œ 4 ç“¶äºŒæ°§åŒ–ç¢³è¡¥æ°”ç“¶ï¼Œä»¥åŠå¤šåŠŸèƒ½æ‰³æ‰‹ã€‚å°†è¿™ä¸€äº›ç»´ä¿®å·¥å…·å…¨éƒ¨æ”¾åˆ°äº†è½¦æ¶çš„ä¸‰è§’åŒ…é‡Œé¢ã€‚</p><p>å¦å¤–åœ¨æ­¤å¼ºçƒˆæ¨èè½¦æ¶ä¸ŠæŒ‚çš„ä¸‰è§’åŒ…ã€‚å®ƒçš„ç©ºé—´æ”¾ä¸‹ä¿®è½¦å¸¸ç”¨çš„å·¥å…·å’Œä¸€æ¡å†…èƒç»°ç»°æœ‰ä½™ï¼Œè¿™æ ·å³ä¾¿æ˜¯ä¸€åˆ°ä¸¤å¤©çš„çŸ­é€”éª‘è¡Œä¹Ÿèƒ½å¸¦é½è£…å¤‡è½»è£…ä¸Šé˜µï¼Œå”¯ä¸€ä¸è¶³çš„å°±æ˜¯è¦ç‰ºç‰²æ‰æ°´å£¶ä½ã€‚</p><p>ä¸ºäº†æ”¾ä¸‹ååº§æ¶çš„é©¼åŒ…ï¼ŒåˆèŠ±äº†ä¸‰åå¤šå—é’±ä¹°äº†åè½¦æ¶ï¼Œå°†é©¼åŒ…å›ºå®šåœ¨ä¸Šé¢ã€‚é©¼åŒ…é‡Œé¢å¸¦çš„ä¸œè¥¿è¿˜è›®å¤šçš„ï¼šå‡ ä»¶æ¢æ´—çš„è¡£æœã€é›¨è¡£å’Œé›¨ä¼ã€å……ç”µå®ã€æ¯›å·¾çº¸å·¾ç­‰ã€‚æ°´æ²¡æœ‰å¸¦å¤ªå¤šï¼Œåœ¨è·¯ä¸Šéšä¾¿ä¹°ç€å–å°±è¡Œã€‚</p><h2 id="å‡ºå‘ç¯‡"><a href="#å‡ºå‘ç¯‡" class="headerlink" title="å‡ºå‘ç¯‡"></a>å‡ºå‘ç¯‡</h2><p>å‡ºå‘å‰å¤©æ™šä¸Šä¸€ç›´ç¡ä¸ç€ï¼Œè„‘å­å®åœ¨æ˜¯å¤ªå…´å¥‹äº†ï¼Œè¿™ç§æ„Ÿè§‰å°±åƒæ˜¯é«˜ä¸­æ”¾å¯’æš‘å‡çš„å‰å¤©æ™šä¸Šä¸€æ ·ï¼Œç»ˆäºå¯ä»¥ç—›å¿«åœ°æ”¾æ¾ä¸€ä¸‹äº†ã€‚äº”ä¸€å½“å¤©æ—©ä¸Š 8 ç‚¹èµ·åºŠçš„ï¼Œæœ¬è®¡åˆ’ç€ 6 ç‚¹èµ·åºŠå‡ºå‘çš„ï¼Œå› ä¸ºæ—©ä¸Šå‡‰å¿«è½¦å°‘æ¯”è¾ƒé€‚åˆéª‘è¡Œã€‚æ”¶æ‹¾ä¸€ä¸‹è£…å¤‡ä¸‹æ¥¼å‡†å¤‡å‡ºå‘ï¼Œç¦»å¼€å°åŒºæ²¡å¤šä¹…åå°±å‘ç°ï¼šæˆ‘è‰¹ï¼Œä¿å‘½å¤´ç›”æ²¡å¸¦ï¼è¿™æ€ä¹ˆèƒ½è¡Œï¼Œäºæ˜¯å±é¢ é¢ åœ°è¿”å›å®¶é‡Œæ‹¿å¤´ç›”ã€‚è™½ç„¶å¤´ç›”æ˜¯å‡ åå—é’±çš„ç ´çƒ‚è´§ï¼Œä½†å…³é”®æ—¶åˆ»è¿˜æ˜¯èƒ½ä¿å°å‘½ä¸€æ¡æ»´ï¼Œè¿˜æ˜¯è¦æˆ´ä¸Šæ»´ã€‚</p><p>ç¬¬ä¸€å¤©å‡†å¤‡å…ˆéª‘è¡Œåˆ°æ¹–å·ï¼Œå› ä¸ºä¸´è¿‘å¤ªæ¹–çš„åŸå¸‚ä¸­ï¼Œæ¹–å·æ˜¯è·ç¦»æ­å·æœ€è¿‘çš„ä¸€ä¸ªï¼Œæ­£å¥½å¯ä»¥æŠŠæ¹–å·å½“ä½œç¯å¤ªæ¹–éª‘è¡Œçš„å‡ºå‘ç‚¹ï¼Œæœ€ç»ˆå†è¿”å›è¿™é‡Œã€‚ä»åœ°å›¾ä¸Šçœ‹ï¼Œæ­å·åˆ°å¤ªæ¹–é€‚åˆéª‘è¡Œçš„çš„æœ€ä½³è·¯çº¿å°±æ˜¯æ²¿ç€ç¬¤ï¼ˆtiaoï¼‰æºªæ—çš„å…¬è·¯ç›´è¾¾æ¹–å·ï¼Œæˆ‘ä»¬è¿™é‡Œæš‚å®šå®ƒæ¡è·¯ä¸ºç¬¤æºªè·¯ã€‚åªè¦è¿›å…¥åˆ°è¿™æ¡æ²¿æºªå…¬è·¯åŸºæœ¬ä¸Šæ— éœ€å¯¼èˆªå’Œåœ°å›¾å°±èƒ½åˆ°è¾¾æ¹–å·ï¼Œè€Œä¸”è¿™æ¡è·¯ä¸Šçš„è·¯ç»¿ç¯ç‰¹åˆ«å°‘ï¼Œè½¦è¾†ç›¸å¯¹äºå›½é“å’Œçœé“ä¹Ÿå°‘å¾ˆå¤šï¼Œè·¯è¾¹æœ‰å¤§ç‰‡çš„ç»¿åŒ–å¸¦æ ‘æ—å¯ä»¥é®é˜´ï¼Œä»¥åŠä¸´è¿‘æ°´è¾¹ç©ºæ°”è´¨é‡å’Œæ¹¿åº¦éƒ½ååˆ†å®‰é€¸ã€‚</p><p><img src="https://p.k8s.li/20210501_031349626_iOS.jpg" alt=""></p><p><img src="https://p.k8s.li/20210501_040031464_iOS.jpg" alt=""></p><h2 id="Day-1-æ­å·-â€“-gt-æ¹–å·-â€“-gt-é•¿å…´"><a href="#Day-1-æ­å·-â€“-gt-æ¹–å·-â€“-gt-é•¿å…´" class="headerlink" title="Day 1 æ­å· â€“&gt; æ¹–å· â€“&gt; é•¿å…´"></a>Day 1 æ­å· â€“&gt; æ¹–å· â€“&gt; é•¿å…´</h2><p>å¤§æ¦‚ä¸Šåˆä¹ç‚¹å·¦å³å°±è¿›å…¥åˆ°ç¬¤æºªè·¯ï¼Œå½“æ—¶éšèº«æºå¸¦çš„ä¸€ç“¶çŸ¿æ³‰æ°´ä¹Ÿä¸€å£é—·å–å®Œäº†ã€‚åé¢ä¸€ç›´æ²¿ç€è¿™æ¡è·¯éª‘è¡Œè·¯ä¸¤ä¸ªå°æ—¶ä¾æ—§æ²¡æœ‰åœ¨è·¯è¾¹æ‰¾åˆ°ä»»ä½•ä¸€å®¶è¶…å¸‚ï¼Œååˆ†åƒµç¡¬ã€‚åªå¥½çœ‹åœ°å›¾æ‰¾åˆ°å¾·æ¸…å¿çš„ä¸€ä¸ªå°ä¹¡é•‡ï¼Œäºæ˜¯ç»•é“è¿™ä¸ªè¿™ä¸ªå°ä¹¡é•‡é‡Œä¹°æ°´å’Œåƒé¥­ã€‚ä¸­åˆåƒå®Œé¥­ä¹‹åæ„Ÿè§‰å®åœ¨æ˜¯å¤ªçƒ­ï¼Œæ‰°æ‰°å¤´å‘ç°å¤´å‘å¥½é•¿ï¼Œå¤§æ¦‚æœ‰ä¸‰ä¸ªæœˆæ²¡æœ‰ç†å‘ ğŸ¥²ï¼Œæ˜¯æˆ‘å¤ªæ‡’äº†ï¼Œå¹³æ—¶å¾ˆå°‘åœ¨æ„è¿™ä»¶äº‹å„¿ã€‚è¿™ä¹ˆçƒ­çš„å¤©å¤´å‘å¤´é¡¶ç€è¿™ä¹ˆé•¿ä¹Ÿä¸æ˜¯ä¸ªå¥½åŠæ³•ï¼Œäºæ˜¯åœ¨è·¯è¾¹éšä¾¿æ‰¾è·¯ä¸€å®¶ç†å‘ç‚¹å‰ªçŸ­äº†å¤´å‘ã€‚</p><ul><li>ç†å®Œå‘ä¹‹åå·²ç»ä¸­åˆåäºŒç‚¹åŠäº†ï¼Œåº”è¯¥æ‰¾ä¸ªåœ°æ–¹ç¨ä½œä¼‘æ¯ä¸€ä¸‹ã€‚äºæ˜¯è¿˜æ˜¯è¿”å›åˆ°ç¬¤æºªè·¯ï¼Œåœ¨è·¯è¾¹çš„ç»¿åŒ–å¸¦æ ‘æ—é‡Œæ‰¾åˆ°è·¯ä¸ªåˆé€‚çš„å¤§çŸ³å¤´ã€‚å°†éšèº«æºå¸¦çš„æ¢æ´—è¡£æœå½“ä½œæ•å¤´ï¼Œé›¨è¡£åœ¨çŸ³å¤´ä¸Šä¸€æ‘Šå°±æ˜¯ä¸ªç®€æ˜“çš„å°åºŠäº†ï¼Œèººç€ä¼‘æ¯ä¸€ä¸ªåŠå°æ—¶å†å‡ºå‘ã€‚</li></ul><p><img src="https://p.k8s.li/20210501_050737596_iOS.jpg" alt=""></p><ul><li>åœ¨ç¬¤æºªè·¯è·¯è¾¹çš„ç»¿åŒ–å¸¦æ ‘æ—é‡Œæœ‰ç‰¹åˆ«å¤šçš„å¤§æ ‘è¢«é£å¹æ–­ï¼Œå¿ƒç–¼æ ‘æ ‘ ğŸ¥º</li></ul><p><img src="https://p.k8s.li/20210501_064702113_iOS.jpg" alt=""></p><ul><li>åˆ°äº†ä¸‹åˆäº”ç‚¹å·¦å³åˆ°è¾¾æ¹–å·çš„å¤ªæ¹–é£æ™¯åŒºï¼Œæ‹æ‘„åœ°ç‚¹ä¸ºæ¹–æ»¨è·¯é™„è¿‘çš„å…¬å›­</li></ul><p><img src="https://p.k8s.li/20210501_092945406_iOS.jpg" alt=""></p><p>åœ¨æ™¯åŒºä¼‘æ¯äº†åŠä¸ªå¤šå°æ—¶ä¹‹åï¼Œå¤©å·²ç»å¿«é»‘äº†ï¼ŒåŸæœ¬å‡†å¤‡å½“æ™šä½åœ¨æ¹–å·ï¼Œä½†å‘ç°é™„è¿‘äº”å…¬é‡Œå†…çš„é…’ä»·æ ¼æ™®éåœ¨ 3kï½5k ä¹‹é—´ã€‚æ¯•ç«Ÿæ˜¯ä¸´è¿‘å¤ªæ¹–é£æ™¯åŒºï¼Œè€Œä¸”æ˜¯äº”ä¸€é»„é‡‘å‘¨ï¼Œä»·æ ¼é«˜çš„ç¦»è°±å¯ä¸æ˜¯å’±è¿™ç§éŸ­èœå’Œä½ç«¯äººå£èƒ½å¤Ÿäº«å—çš„ ğŸ¥²ã€‚äºæ˜¯åœ¨æœä¸€ä¸‹åå…¬é‡Œå¤–çš„åŸåŒºï¼Œè™½ç„¶ä»·æ ¼èƒ½å¤Ÿæ¥å—ã€‚ä½†è¦éª‘è¡Œåå¤šå…¬é‡Œï¼Œè€Œä¸”åœ¨åŸåŒºéª‘è¡Œçº¢ç»¿ç¯ç‰¹åˆ«å¤šï¼Œååˆ†æµªè´¹æ—¶é—´ã€‚ç¬¬äºŒå¤©æ—©ä¸Šåˆå¾—éª‘è¡Œåå¤šå…¬é‡Œè¿”å›ç¯å¤ªæ¹–å…¬è·¯ï¼Œæ„Ÿè§‰æ¥å›äºŒåå¤šå…¬é‡Œè¿˜ä¸å¦‚å¾€å‰é¢æ¥ç€éª‘è¡Œï¼Œåœ¨è¿œä¸€ç‚¹çš„åœ°æ–¹æ‰¾ä¸€ä¸ªåˆé€‚çš„é…’åº—ä½ä¸‹ã€‚äºæ˜¯åœ¨åœ°å›¾ä¸Šå‘ç°é•¿å…´ç«è½¦ç«™è·ç¦»å¤ªæ¹–ååˆ†è¿‘ï¼Œç«è½¦ç«™é™„è¿‘è‚¯å®šæœ‰é…’åº—ã€‚äºæ˜¯æ¥ç€æ‰¾äº†è·ç¦»ç¯å¤ªæ¹–è·¯æœ€è¿‘çš„é…’åº—ã€‚è·ç¦»å½“å‰åœ°ç‚¹äºŒåå…¬é‡Œå·¦å³ï¼Œå¦‚æœç°åœ¨éª‘è¡Œçš„è¯ï¼Œä¸€å°æ—¶å·¦å³åº”è¯¥å°±èƒ½éª‘åˆ°é…’åº—ã€‚åº”è¯¥æ²¡é—®é¢˜ï¼Œå› ä¸ºå¤©å·²ç»å¿«é»‘äº†ï¼Œä¸å†èµ¶ç´§éª‘è¡Œçš„è¯å°†è¦å¤œé—´éª‘è¡Œï¼Œå¾ˆä¸å®‰å…¨ã€‚</p><p>äºæ˜¯å½“æ—¶åšäº†ä¸€ä¸ªå¾ˆè ¢çš„å†³å®šï¼Œç»§ç»­éª‘è¡Œï¼Œå¿˜è®°äº†åƒæ™šé¥­ã€‚æœ¬æ¥åˆé¥­åƒçš„å°±æ¯”è¾ƒå°‘ï¼Œä¹Ÿæ²¡æœ‰åŠæ—¶è¡¥å……èƒ½é‡ï¼Œä½“åŠ›å·²ç»å¿«åˆ°è¾¾äº†æé™ã€‚äºæ˜¯åœ¨ä½“åŠ›ä¸å ªçš„æƒ…å†µä¸‹åˆç»§ç»­éª‘è¡Œäº†äºŒåå…¬é‡Œã€‚åˆ°è¾¾é•¿å…´ç«è½¦ç«™é™„è¿‘åï¼Œè·ç¦»é…’åº—å°±ä¸åˆ°ä¸¤å…¬é‡Œçš„è·¯ç¨‹äº†ã€‚ä»¤æˆ‘æ„æƒ³ä¸åˆ°çš„æ˜¯ï¼Œåˆšè¿‡ç«è½¦ç«™ä¸ä¹…åï¼Œå°±å‡ºçªç„¶å‡ºç°å¤´æ™•æ¶å¿ƒçš„ä¸é€‚ã€‚åœä¸‹æ¥æ­‡æ¯äº†åŠä¸ªå°æ—¶æ‰ç¼“è¿‡æ¥ï¼Œä»¥è‡³äºæœ€åçš„ä¸¤å‘¨é‡ŒåŸºæœ¬ä¸Šæ˜¯æ¨ç€è½¦å­èµ°äº†åŠä¸ªå°æ—¶æ‰åˆ°çš„é…’åº—ã€‚åˆ°è¾¾é…’åº—å·²ç»å…«ç‚¹åŠäº†ï¼Œå·²ç»å¿«ä¹ä¸ªå°æ—¶æ²¡åƒä¸œè¥¿äº†ï¼Œæ„Ÿè§‰ç‰¹åˆ«ç´¯ã€å…¨èº«æ— åŠ›ã€‚</p><p>æŠŠè½¦å­æ¨åˆ°æˆ¿é—´é‡Œç®€å•æ´—æ¼±äº†ä¸€ä¸‹ï¼Œå°±å»æ¥¼ä¸‹çš„å¤œå¸‚åƒç‚¹é¥­ã€‚ç‚¹äº†ä¸€ç›˜å‡‰æ‹Œé»„ç“œå’Œå¹²é”…åŒ…èœï¼Œæ²¡æƒ³åˆ°ç­‰äº†åŠä¸ªå°æ—¶â€¦â€¦</p><p>åƒå®Œé¥­ååœ¨è¶…å¸‚ä¹°äº†å‡ ç“¶æ°´å’Œæ°´æœï¼Œå›åˆ°æˆ¿é—´çœ‹äº†ä¸€é›† <a href="">BBCï¼šå†°å†»æ˜ŸçƒÂ·å¦‚å±¥è–„å†°</a> çºªå½•ç‰‡å°±ç¡ç€äº†ã€‚</p><p><img src="https://p.k8s.li/20210501_141353000_iOS.png" alt=""></p><h2 id="Day-2-é•¿å…´-â€“-gt-æ— é”¡-â€“-gt-è‹å·"><a href="#Day-2-é•¿å…´-â€“-gt-æ— é”¡-â€“-gt-è‹å·" class="headerlink" title="Day 2 é•¿å…´ â€“&gt; æ— é”¡ â€“&gt; è‹å·"></a>Day 2 é•¿å…´ â€“&gt; æ— é”¡ â€“&gt; è‹å·</h2><p>ç¬¬äºŒå¤©æ—©ä¸Šä¸ƒç‚¹åŠèµ·åºŠï¼Œåœ¨æ¥¼ä¸‹çš„æ—©é¤åº—åƒæ—©é¥­ï¼Œä¹Ÿæ˜¯é…’åº—é™„èµ çš„ä¸€é¡¿æ—©é¤ã€‚åœ¨é…’åº—ä»¬å£å‘ç°äº†å¾ˆå¤šé©´å‹çš„å±±åœ°è½¦å’Œå…¬è·¯è½¦ï¼Œä¼°è®¡ä»–ä»¬æ˜¨æ™šä¹Ÿæ˜¯åœ¨è¿™é‡Œä¼‘æ¯çš„ã€‚åƒå®Œé¥­ä¹‹åæ”¶æ‹¾ä¸œè¥¿å‡ºå‘ï¼Œä¸‹ä¸€ç«™æ˜¯è‹å·ï¼Œæœ¬æƒ³ç€è¦å»æ— é”¡ï¼Œä½†ç”±äºæ—¶é—´ç¼˜æ•…è¿˜æ˜¯ä¸å»æ— é”¡äº†ï¼Œä»Šå¤©è¦éª‘è¡Œ 150 å¤šå…¬é‡Œåˆ°è¾¾è‹å·çš„è¥¿å±±é£æ™¯åŒºã€‚</p><p><img src="https://p.k8s.li/20210502_004340465_iOS.jpg" alt=""></p><p>åˆšåˆšå‡ºæ¥é…’åº—é—¨å£åˆ°è¾¾ 302 å›½é“åå°±å‘ç°ä»Šå¤©å¤©æ°”ååˆ†ä¸å¦™ï¼Œé€†é£ï¼éª‘è¡Œèµ·æ¥ç‰¹åˆ«è´¹åŠ²ï¼Œå¹³å‡æ—¶é€Ÿåªèƒ½ç»´æŒåœ¨ 18å…¬é‡Œ/å°æ—¶ï¼Œåªèƒ½å¥‹åŠ›éª‘è¡Œäº†ã€‚ä¸­åˆçš„æ—¶å€™åˆ°è¾¾äº†å®œå…´çš„ä¸€ä¸ªå°é•‡ï¼Œåœ¨é‚£é‡Œåƒäº†é¡¿åˆé¥­ï¼Œä¹‹åç»§ç»­éª‘è¡Œåˆ°äº†æ— é”¡å¸‚çš„åå…«æ¹¾æ¹¿åœ°å…¬å›­ï¼Œåœ¨å…¬å›­é‡Œçš„ä¸€ä¸ªæ¹–è¾¹ä¼‘æ¯äº†ä¸€ä¸ªå°æ—¶å€™å°±ç»§ç»­éª‘è¡Œã€‚åˆ°è¾¾æ— é”¡ä¹‹åæ²¡æœ‰ç»§ç»­æ²¿ç€å¤ªæ¹–å…¬è·¯éª‘è¡Œï¼Œè€Œæ˜¯é€‰æ‹©äº†æœ€çŸ­çš„è·¯çº¿åˆ°è¾¾è‹å·è¥¿å±±é£æ™¯åŒºã€‚</p><p><img src="https://p.k8s.li/20210502_010036044_iOS.jpg" alt=""></p><p>æ™šä¸Šåˆ°è¾¾è¥¿å±±é£æ™¯åŒºå·²ç»å…«ç‚¹å·¦å³äº†ï¼Œåˆ°è¾¾å‡¤å‡°å°æ™¯ç‚¹æ‰€åœ¨çš„å°å²›ä¹‹åï¼Œåœ¨æ™¯åŒºé‡Œçš„ä¸€å®¶é¥­åº—åƒé¡¿æ™šé¥­ï¼Œä¸€ä¸ªäººä¸‰èœä¸€æ±¤åƒå¾—ç‰¹åˆ«é¥±ã€‚ä¹‹ååˆç»§ç»­éª‘è¡Œåˆ°è¥¿å±±é£æ™¯åŒºé‡Œé¢çš„ä¸€å®¶æ°‘å®¿ã€‚åœ¨ç¾å›¢ä¸Šè®¢çš„ä»·æ ¼æ˜¯ 108Â¥ ä¸€ä¸ªå¤§åºŠå¤§é—´ã€‚</p><p><img src="https://p.k8s.li/20210502_110411190_iOS.jpg" alt=""></p><h2 id="Day-3-å¤ªæ¹–é£æ™¯åŒº-â€“-gt-è‹å·åŸåŒº"><a href="#Day-3-å¤ªæ¹–é£æ™¯åŒº-â€“-gt-è‹å·åŸåŒº" class="headerlink" title="Day 3 å¤ªæ¹–é£æ™¯åŒº â€“&gt; è‹å·åŸåŒº"></a>Day 3 å¤ªæ¹–é£æ™¯åŒº â€“&gt; è‹å·åŸåŒº</h2><p>æ—©ä¸Šä¸ƒç‚¹åŠèµ·åºŠï¼Œå°†é©¼åŒ…ä»å±±åœ°è½¦ä¸Šå¸äº†ä¸‹æ¥æ”¾åœ¨äº†æˆ¿é—´é‡Œã€‚ä»Šå¤©ä¸Šåˆåªåœ¨è¥¿å±±é£æ™¯åŒºç©å„¿ï¼Œä¸éœ€è¦å¸¦è¿™äº›è¡Œæï¼Œè¿™æ ·åœ¨å±±é‡Œéª‘è¡Œèµ·æ¥ä¹Ÿèƒ½æ”¾é£è‡ªæˆ‘ã€‚</p><ul><li>å»çš„ç¬¬ä¸€ä¸ªæ™¯ç‚¹æ˜¯æ—å±‹æ´ï¼Œä»·æ ¼æ˜¯ 50Â¥ï¼Œåœ¨æ—å±‹æ´å±±ä¸Šçš„ä¸€åº§å¡”çš„å†…éƒ¨æ‹æ‘„å¤ªæ¹–æ²¿å²¸çš„é£æ™¯</li></ul><p><img src="https://p.k8s.li/20210503_005522469_iOS.jpg" alt=""></p><p>ä¸Šåˆçš„æ—¶å€™å°±åœ¨è¥¿å±±é£æ™¯åŒºæ²¿ç€æ¹–è¾¹éª‘è¡Œç©å„¿äº†ä¸€åœˆï¼Œé€€æˆ¿ä¹‹åä¹ŸåäºŒç‚¹å¤šäº†ï¼Œäºæ˜¯åœ¨é™„è¿‘çš„ä¸€å®¶å…°å·æ‹‰é¢åƒäº†é¡¿è›‹ç‚’é¥­ã€‚</p><ul><li>éšååˆéª‘è¡Œåˆ°å¤ªæ¹–å‘¨è¾¹ä¼‘æ¯ä¸€æ®µæ—¶é—´</li></ul><p><img src="https://p.k8s.li/20210503_044026640_iOS.jpg" alt=""></p><p>ä¸‹åˆç»§ç»­éª‘è¡Œï¼Œä¸‰å·å·å’Œå››å·è¿™ä¸¤æ™šå®šçš„æ°‘å®¿åœ¨å¹³æ±Ÿå†å²è¡—åŒºé™„è¿‘ã€‚ä»è¥¿å±±é£æ™¯åŒºåˆ°é‚£é‡Œå¤§æ¦‚æœ‰ 65 å…¬é‡Œçš„éª‘è¡Œè·¯ç¨‹ã€‚ä¸‹åˆäº”ç‚¹å·¦å³åˆ°è¾¾ä½çš„åœ°æ–¹ã€‚ä»·æ ¼æ˜¯ 512Â¥ ä¸¤æ™šï¼Œæ„Ÿè§‰è¿˜æ˜¯æ¯”è¾ƒè´µçš„ï¼Œè€Œä¸”æ˜¯ä¸‰äººé—´ï¼Œå‡‘æ´»ä½ä¸¤æ™šå§ã€‚å…¶å®æœ¬äººå¯¹å’Œé™Œç”Ÿäººåˆä½å¹¶ä¸æ˜¯å¾ˆä»‹æ„ï¼Œè¿˜æ˜¯èƒ½æ¥å—ã€‚åœ¨æˆ‘å¤§å­¦åˆšæ¯•ä¸šä¹‹åï¼Œä¹Ÿæ˜¯ä½åœ¨å…¬å¸é™„è¿‘çš„ä¸€å®¶æ°‘å®¿ã€‚å½“æ—¶ä¸€ä¸ªä¸åˆ°åäº”å¹³ç±³çš„æˆ¿é—´é‡Œï¼Œä¸¤ä¸ªä¸Šä¸‹é“ºçš„åºŠï¼Œå’Œå››ä¸ªäººä½ä¸€å—ã€‚è™½ç„¶ååˆ†æ‹¥æŒ¤ä¹Ÿåˆå¾ˆå¤šä¸ä¾¿ï¼Œä½†ä»·æ ¼ååˆ†ä¾¿å®œï¼Œæ¯ä¸ªæœˆ 300Â¥ åŒ…æ‰€æœ‰è´¹ç”¨ï¼Œååˆ†é€‚åˆå½“æ—¶åˆšæ¯•ä¸šæ‰‹æ— åˆ†æ–‡çš„æˆ‘ã€‚</p><ul><li>æ™šä¸Šçš„æ—¶å€™è‡ªå·±ä¸€ä¸ªäººå»åƒäº†é¡¿æµ·åº•æç«é”…ï¼Œæ€»æ„Ÿè§‰åœ¨å¤–é¢è‡ªå·±ä¸€ä¸ªäººåƒé¥­ååˆ†å°´å°¬ ğŸ˜… ã€‚å¦‚ä»Šæ¯•ä¸šä¹Ÿå¿«ä¸¤å¹´äº†ï¼Œè¿™ä¸¤å¹´åŸºæœ¬ä¸Šæ˜¯ç‹¬è‡ªä¸€ä¸ªäººç”Ÿæ´»çš„ï¼Œè¿™ç§ç‹¬å¤„çš„æ„Ÿè§‰ä¹Ÿæ…¢æ…¢é€‚åº”äº†ï¼Œä¹Ÿè¶Šæ¥è¶Šäº«å—è¿™ç§ç‹¬å¤„çš„ç”Ÿæ´»äº†ã€‚</li></ul><p><img src="https://p.k8s.li/20210503_114832550_iOS.jpg" alt=""></p><ul><li>å¹³æ±Ÿå†å²è¡—åŒºå¤œæ™¯</li></ul><p><img src="https://p.k8s.li/20210503_124849278_iOS.jpg" alt=""></p><ul><li>å¹³æ±Ÿå†å²è¡—åŒºå¤œæ™¯</li></ul><p><img src="https://p.k8s.li/20210503_125244682_iOS.jpg" alt=""></p><h2 id="Day-4-è‹å·æ¸¸ç©"><a href="#Day-4-è‹å·æ¸¸ç©" class="headerlink" title="Day 4 è‹å·æ¸¸ç©"></a>Day 4 è‹å·æ¸¸ç©</h2><p>æ—©ä¸Šä¸ƒç‚¹åŠå°±èµ·åºŠäº†ï¼Œä¸Šåˆæ¸¸ç©çš„ç¬¬ä¸€ç«™æ˜¯ç•™å›­ï¼Œé¢„å®šçš„æ˜¯æ—©ä¸Š 8 ç‚¹åˆ° 9 ç‚¹çš„é—¨ç¥¨ï¼Œæ—©ä¸Šä¸‹èµ·äº†ä¸ä¸ç»†é›¨ï¼Œæ„Ÿè§‰å¤©æ°”ä¸å¤ªå¥½ã€‚åœ¨ç•™å›­é€›å®Œä¹‹ååˆå»äº†ç‹®å­æ—ï¼Œæ„Ÿè§‰è¿™ä¸¤ä¸ªå›­å­è¿˜å¯ä»¥ï¼Œæ™¯åŒºçš„äººå¹¶ä¸æ˜¯ç‰¹åˆ«å¤šã€‚</p><p><img src="https://p.k8s.li/20210504_010754779_iOS.jpg" alt=""></p><p>æœ¬æƒ³ç€ä¸‹åˆå»æ‹™æ”¿å›­ï¼Œä½†å½“å¤©å·²ç»æ²¡æœ‰é—¨ç¥¨äº†ï¼Œåªèƒ½é¢„å®šåˆ°äº”å·ä¸Šåˆçš„ã€‚äºæ˜¯ä¸‹åˆå°±å»äº†è™ä¸˜é£æ™¯åŒºã€‚</p><p><img src="https://p.k8s.li/20210504_084847466_iOS.jpg" alt=""></p><ul><li>è™ä¸˜é£æ™¯åŒºé™„è¿‘</li></ul><p><img src="https://p.k8s.li/20210504_085354580_iOS.jpg" alt=""></p><p><img src="https://p.k8s.li/20210504_085413326_iOS.jpg" alt=""></p><h2 id="Day-5-è‹å·-â€“-gt-æ¹–å·"><a href="#Day-5-è‹å·-â€“-gt-æ¹–å·" class="headerlink" title="Day 5 è‹å· â€“&gt; æ¹–å·"></a>Day 5 è‹å· â€“&gt; æ¹–å·</h2><p>æ—©ä¸Šå…«ç‚¹å°±å‡ºå‘å»äº†æ‹™æ”¿å›­ï¼Œåœ¨é‡Œé¢é€›çš„æ—¶é—´æ¯”è¾ƒé•¿ï¼Œç­‰åˆ°åç‚¹åŠçš„æ—¶å€™æ‰ä»é‡Œé¢å‡ºæ¥ã€‚</p><p><img src="https://p.k8s.li/20210505_010850949_iOS.jpg" alt=""></p><ul><li>æ„Ÿè§‰è¿™æ£µæ ‘ç‰¹åˆ«åƒäººçš„æ‰‹ ğŸ–ï¸ ğŸ¤”ï¸</li></ul><p><img src="https://p.k8s.li/20210505_011052002_iOS.jpg" alt=""></p><p>é€›å®Œæ‹™æ”¿å›­ä¹‹åå·²ç»å¿«åä¸€ç‚¹äº†ï¼Œå›åˆ°ä½çš„åœ°æ–¹æ”¶æ‹¾å®Œè¡Œæï¼Œåœ¨é™„è¿‘çš„ä¸€å®¶ç´ é£Ÿé¤å…åƒäº†é¡¿åˆé¥­ã€‚ä¹‹åç»§ç»­éª‘è¡Œï¼Œå‡†å¤‡è¿”å›äº†ï¼Œæ™šä¸Šå‡†å¤‡ä½åœ¨æ¹–å·ã€‚</p><p><img src="https://p.k8s.li/20210505_082143685_iOS.jpg" alt=""></p><ul><li>ä¸‹åˆäº”ç‚¹åŠçš„æ—¶å€™åˆ°è¾¾æ¹–å·æ»¨æ¹–å¤§é“ï¼Œå†æ¬¡æ¥åˆ°äº†å‡ºå‘ç‚¹ï¼Œç¯å¤ªæ¹–éª‘è¡Œæ€»ç®—é¡ºåˆ©ç»“æŸäº†ï¼Œåªå‰©ä¸‹æ˜å¤©ä¸€å¤©è¿”å›æ­å·çš„è·¯ç¨‹äº†ã€‚æ˜å¤©åˆ°å®¶åå†åœ¨å®¶ä¼‘æ¯ä¸€å¤©ï¼Œå› æ­¤ç»™ TL ç”³è¯·äº†ä¸¤å¤©å¹´å‡ï¼Œä¹Ÿå¾ˆé¡ºåˆ©æ»´æ‰¹å‡†äº†ã€‚</li></ul><p><img src="https://p.k8s.li/20210505_093503000_iOS.png" alt=""></p><ul><li>æ»¨æ¹–å¤§é“æ—çš„å…¬å›­ï¼Œæ¹–è¾¹å¤•é˜³è¥¿ä¸‹çš„æ™¯è‰²</li></ul><p><img src="https://p.k8s.li/20210505_095106128_iOS.jpg" alt=""></p><h2 id="Day-6-æ¹–å·-â€“-gt-æ­å·"><a href="#Day-6-æ¹–å·-â€“-gt-æ­å·" class="headerlink" title="Day 6 æ¹–å· â€“&gt; æ­å·"></a>Day 6 æ¹–å· â€“&gt; æ­å·</h2><p>æœ€åä¸€å¤©å°±æ˜¯ä»æ¹–å·è¿”å›æ­å·äº†ï¼Œè¿˜æ˜¯æ²¿ç€åŸè·¯è¿”å›ï¼Œä¸‹åˆä¸´è¿‘å…­ç‚¹é¡ºåˆ©åˆ°è¾¾æ­å·ã€‚</p><p>æ„Ÿè§‰è¿™å‡ å¤©åƒçš„å¤ªå¤šäº† ğŸ˜¤</p><table><thead><tr><th></th><th></th></tr></thead><tbody><tr><td>ä½å®¿</td><td>866</td></tr><tr><td>é—¨ç¥¨</td><td>295</td></tr><tr><td>é£Ÿç‰©</td><td>750</td></tr><tr><td>å…¶ä»–</td><td>182</td></tr><tr><td>æ€»è®¡</td><td>2093</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;è°ƒä¼‘ä¸¤å¤©ç»ˆäºè¿æ¥äº†äº”å¤©çš„äº”ä¸€å‡æœŸï¼Œå®é™…ä¸Šä»…ä»…æ”¾äº†ä¸€å¤©å‡æœŸï¼Œ
        
      
    
    </summary>
    
    
      <category term="ç”Ÿæ´»" scheme="https://blog.k8s.li/categories/%E7%94%9F%E6%B4%BB/"/>
    
    
      <category term="éª‘è¡Œ" scheme="https://blog.k8s.li/tags/%E9%AA%91%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ GitHub Actions è‡ªåŠ¨åŒ–æ„å»º yum/apt ç¦»çº¿æº</title>
    <link href="https://blog.k8s.li/make-offline-mirrors.html"/>
    <id>https://blog.k8s.li/make-offline-mirrors.html</id>
    <published>2021-05-22T16:00:00.000Z</published>
    <updated>2021-09-02T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç¦»çº¿éƒ¨ç½²"><a href="#ç¦»çº¿éƒ¨ç½²" class="headerlink" title="ç¦»çº¿éƒ¨ç½²"></a>ç¦»çº¿éƒ¨ç½²</h2><p>å¯¹äº PaaS toB äº§å“æ¥è®²ï¼Œå®¢æˆ·å¾€å¾€ä¼šè¦æ±‚äº§å“çš„éƒ¨ç½²æ–¹æ¡ˆå¿…é¡»åšåˆ°ç¦»çº¿å®‰è£…ï¼Œå³åœ¨éƒ¨ç½²æ—¶ä¸èƒ½ä¾èµ–ä»»ä½•åœ¨çº¿çš„èµ„æºï¼Œæ¯”å¦‚å®‰è£…ä¸€äº› OS è½¯ä»¶åŒ…æ—¶ä¾èµ–çš„ yum/apt æºï¼›docker.ioã€k8s.gcr.io ã€quay.io ä¸Šé¢çš„å®¹å™¨é•œåƒï¼›GitHub ä¸Šå¼€æºè½¯ä»¶çš„äºŒè¿›åˆ¶ä¸‹è½½æ–‡ä»¶ç­‰ã€‚</p><p>ä½œä¸ºå¹³å°éƒ¨ç½²å·¥å…·çš„å¼€å‘è€…ï¼Œå§‹ç»ˆè¢«ç¦»çº¿éƒ¨ç½²è¿™ä¸ªéš¾é¢˜å›°æ‰°ç€ã€‚åœ¨çº¿çš„å®¹å™¨é•œåƒå’ŒäºŒè¿›åˆ¶æ–‡ä»¶æ¯”è¾ƒå¥½è§£å†³ï¼Œå› ä¸ºè¿™äº›èµ„æºæ˜¯ä¸ OS æ— å…³çš„ï¼Œåªè¦ä¸‹è½½ä¸‹æ¥æ”¾åˆ°å®‰è£…åŒ…é‡Œï¼Œéƒ¨ç½²çš„æ—¶å€™å¯åŠ¨ä¸€ä¸ª HTTP æœåŠ¡å™¨å’Œé•œåƒä»“åº“æœåŠ¡æä¾›è¿™äº›èµ„æºçš„ä¸‹è½½å³å¯ã€‚</p><p>ä½†æ˜¯å¯¹äº yum/apt ä¹‹ç±»çš„è½¯ä»¶æ¥è®²å¹¶ä¸é‚£ä¹ˆç®€å•ï¼š</p><ul><li>é¦–å…ˆç”±äºå„ä¸ªåŒ…ä¹‹é—´çš„ä¾èµ–å…³ç³»æ¯”è¾ƒå¤æ‚ï¼Œå¹¶ä¸èƒ½å°†å®ƒä»¬ç›´æ¥ä¸‹è½½ä¸‹æ¥ï¼›</li><li>å…¶æ¬¡å³ä¾¿ä¸‹è½½ä¸‹æ¥ä¹‹åä¹Ÿæ— æ³•ç›´æ¥é€šè¿‡ yum/apt çš„æ–¹å¼å®‰è£…æŒ‡å®šçš„è½¯ä»¶åŒ…ï¼Œè™½ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ scp çš„æ–¹å¼å°†è¿™äº›åŒ…å¤åˆ¶åˆ°éƒ¨ç½²èŠ‚ç‚¹ï¼Œé€šè¿‡ rpm æˆ– dpkg çš„æ–¹å¼æ¥å®‰è£…ä¸Šï¼Œä½†è¿™æ ·å¹¶ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œè€Œä¸”é€šç”¨æ€§èƒ½ä¹Ÿä¸æ˜¯å¾ˆå¥½ï¼›</li><li>æœ€åéœ€è¦é€‚é…çš„ Linux å‘è¡Œç‰ˆå’ŒåŒ…ç®¡ç†å™¨ç§ç±»ä¹Ÿæœ‰å¤šç§ï¼Œè€Œä¸”æœ‰äº›åŒ…çš„åŒ…åæˆ–è€…ç‰ˆæœ¬å·åœ¨ä¸åŒçš„åŒ…ç®¡ç†ä¹‹é—´ä¹Ÿç›¸å·®ç”šå¤§ï¼Œæ— æ³•åšåˆ°ç»Ÿä¸€ç®¡ç†ã€‚</li><li>è¦åŒæ—¶é€‚é… arm64 å’Œ amd64 çš„æºåŠå…¶å›°éš¾</li></ul><p>ç»¼ä¸Šï¼Œå°†å¹³å°éƒ¨ç½²ä¾èµ–çš„åœ¨çº¿ yum/apt ä¹‹ç±»çš„è½¯ä»¶åŒ…èµ„æºåˆ¶ä½œæˆç¦»çº¿å®‰è£…åŒ…æ˜¯ä¸€ä»¶å¾ˆæ£˜æ‰‹çš„äº‹æƒ…ã€‚ä¸ªäººå°±è¿™ä¸ªé—®é¢˜æŠ˜è…¾äº†ä¸€æ®µæ—¶é—´ï¼Œç»ˆäºæ‰¾åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒåˆé€‚çš„è§£å†³æ–¹æ¡ˆï¼šå³é€šè¿‡ä¸€ä¸ª YAML é…ç½®æ–‡ä»¶æ¥ç®¡ç†åŒ…ï¼Œç„¶åä½¿ç”¨ Dockerfile æ¥æ„å»ºæˆç¦»çº¿çš„ tar åŒ…æˆ–è€…å®¹å™¨é•œåƒã€‚å¦‚æœæœ‰ç±»ä¼¼éœ€æ±‚çš„å°ä¼™ä¼´ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹æœ¬æ–¹æ¡ˆã€‚</p><h2 id="Docker-build"><a href="#Docker-build" class="headerlink" title="Docker build"></a>Docker build</h2><p>ä¼ ç»Ÿåˆ¶ä½œç¦»çº¿æºçš„æ–¹å¼æ˜¯æ‰¾ä¸€å°ç›¸åº”çš„ Linux æœºå™¨ï¼Œåœ¨ä¸Šé¢é€šè¿‡åŒ…ç®¡ç†å™¨ä¸‹è½½è¿™äº›è½¯ä»¶åŒ…ï¼Œç„¶åå†åˆ›å»ºè¿™äº›è½¯ä»¶åŒ…çš„ repo ç´¢å¼•æ–‡ä»¶ã€‚</p><p>å¯ä»¥çœ‹å‡ºè¿™ç§æ–¹å¼ååˆ†ä¸çµæ´»ï¼Œå‡å¦‚æˆ‘æƒ³è¦åˆ¶ä½œ Debian 9 çš„ apt ç¦»çº¿æºï¼Œæˆ‘å°±éœ€è¦ä¸€å° Debian 9 çš„æœºå™¨ã€‚å¦‚æœè¦é€‚é…å¤šä¸ª Linux å‘è¡Œç‰ˆå°±éœ€è¦å¤šä¸ªç›¸åº”çš„ OS æœºå™¨ã€‚è¦ç®¡ç†å’Œä½¿ç”¨è¿™ä¹ˆå¤šç§ç±»çš„ OS ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹å„¿ï¼Œè€Œå¦‚ä»Šå·²ç»ååˆ†æ™®éä½¿ç”¨çš„å®¹å™¨æŠ€æœ¯æ°æ°èƒ½å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ç±»é—®é¢˜ã€‚æ¯”å¦‚æˆ‘æƒ³è¿è¡Œä¸€ä¸ª Debian9 çš„æ“ä½œç³»ç»Ÿï¼Œæˆ‘åªéœ€è¦è¿è¡Œä¸€ä¸ª Debian 9 é•œåƒçš„å®¹å™¨å³å¯ï¼Œè€Œä¸”ä¸éœ€è¦é¢å¤–çš„ç®¡ç†æˆæœ¬ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿååˆ†åœ°è½»é‡ã€‚</p><p>æ—¥å¸¸å·¥ä½œä¸­æˆ‘ä»¬å¸¸ä½¿ç”¨å®¹å™¨æ¥æ„å»ºä¸€äº› Golang å†™çš„åç«¯ç»„ä»¶ï¼Œé‚£ä¹ˆæ„å»ºç¦»çº¿æºæ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥è¿™æ ·åšï¼Ÿå®è·µè¯æ˜ç¡®å®å¯ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸ºä¸åŒçš„ OS å’ŒåŒ…ç®¡ç†å™¨å†™ä¸€ä¸ªç›¸åº”çš„ Dockerfile å³å¯ã€‚ä½¿ç”¨ docker build å¤šé˜¶æ®µæ„å»ºçš„ç‰¹æ€§ï¼Œå¯ä»¥å°†å¤šä¸ª Dockerfile åˆå¹¶æˆä¸€ä¸ªï¼Œç„¶åæœ€åä½¿ç”¨ COPY â€“from çš„æ–¹å¼å°†è¿™ä¸ªæ„å»ºçš„äº§ç‰©å¤åˆ¶åˆ°åŒä¸€ä¸ªé•œåƒä¸­ï¼Œæ¯”å¦‚æä¾› HTTP çš„ nginx å®¹å™¨ï¼Œæˆ–è€…ä½¿ç”¨ BuildKit çš„ç‰¹æ€§å°†è¿™äº›æ„å»ºäº§ç‰©å¯¼å‡ºä¸º taråŒ… æˆ–è€…ä¸ºæœ¬åœ°ç›®å½•ã€‚</p><h2 id="é€‚é…-OS"><a href="#é€‚é…-OS" class="headerlink" title="é€‚é… OS"></a>é€‚é… OS</h2><p>æ ¹æ®è‡ªå·±çš„ PaaS toB ä»ä¸šç»éªŒå¯çŸ¥ï¼Œç›®å‰å›½å†…çš„ç§æœ‰äº‘å®¢æˆ·ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨çš„ OS ä¸­ï¼Œ CentOS åº”è¯¥æ˜¯æœ€å¤šçš„ï¼Œå…¶æ¬¡æ˜¯ Ubuntu å’Œ Debianã€‚è‡³äº RedHat åˆ™éœ€è¦ä»˜è´¹è®¢é˜…æ‰èƒ½ä½¿ç”¨ï¼ŒDockerHub ä¸Šæ›´æ˜¯æ²¡æœ‰å…è´¹å¯ä½¿ç”¨çš„é•œåƒï¼Œå› æ­¤æœ¬æ–¹æ¡ˆæ— æ³•ç¡®ä¿é€‚ç”¨äº RedHatã€‚äº§å“æ–¹é¢ CentOS éœ€è¦çš„ç‰ˆæœ¬åªæœ‰ 7.9ï¼›Ubuntu éœ€è¦æ”¯æŒ 18.04 å’Œ 20.04ï¼›Debian éœ€è¦æ”¯æŒ 9 å’Œ 10ã€‚å› ä¸ºæ—¶é—´å’Œç²¾åŠ›æœ‰é™ï¼Œæœ¬æ–¹æ¡ˆæ”¯æŒçš„ Linux å‘è¡Œç‰ˆå’Œç›¸åº”çš„ç‰ˆæœ¬åªæœ‰ CentOS 7, Debian 9/10, Ubuntu 18.04/20.04 è¿™äº”ä¸ªã€‚å¦‚æœè¦æ”¯æŒå…¶ä»– OS çš„ç¦»çº¿æºæ¯”å¦‚ OpenSUSEï¼Œä¹Ÿå¯ä»¥å‚è€ƒæœ¬æ–¹æ¡ˆç¼–å†™ä¸€ä¸ª Dockerfile æ–‡ä»¶æ¥å®ç°é€‚é…ã€‚</p><h2 id="æ„å»º"><a href="#æ„å»º" class="headerlink" title="æ„å»º"></a>æ„å»º</h2><p>æ„å»ºçš„è¿‡ç¨‹ååˆ†ç®€å•ï¼Œä½¿ç”¨ä¸€ä¸ª YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶æ¥ç®¡ç†ä¸åŒçš„åŒ…ç®¡ç†å™¨æˆ– Linux å‘è¡Œç‰ˆå®‰è£…ä¸åŒçš„åŒ…ï¼Œå¹¶åœ¨ä¸€ä¸ª Dockerfile é‡Œå®Œæˆæ‰€æœ‰çš„æ„å»ºæ“ä½œã€‚å®ç°æºç åœ¨ <a href="https://github.com/muzi502/scripts/tree/master/build-packages-repo" target="_blank" rel="noopener">github.com/muzi502/scripts/build-packages-repo</a>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">build</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ Dockerfile.centos</span><br><span class="line">â”œâ”€â”€ Dockerfile.debian</span><br><span class="line">â”œâ”€â”€ Dockerfile.ubuntu</span><br><span class="line">â””â”€â”€ packages.yaml</span><br></pre></td></tr></table></figure><h3 id="æ„å»ºè¿‡ç¨‹"><a href="#æ„å»ºè¿‡ç¨‹" class="headerlink" title="æ„å»ºè¿‡ç¨‹"></a>æ„å»ºè¿‡ç¨‹</h3><p>ä½¿ç”¨ docker build çš„æ–¹å¼æ„å»ºç¦»çº¿æºå¤§è‡´å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p><ul><li>åœ¨æ„å»ºå®¹å™¨å†…é…ç½® yum/apt æºï¼Œå®‰è£…æ„å»ºæ—¶éœ€è¦å·¥å…·ï¼›</li><li>ç”Ÿæˆç³»ç»Ÿå†…çš„ rpm/deb åŒ…çš„åˆ—è¡¨å’Œéœ€è¦ä¸‹è½½çš„åŒ…åˆ—è¡¨ï¼Œè§£å†³ä¸€äº›è½¯ä»¶åŒ…ä¾èµ–çš„é—®é¢˜ï¼›</li><li>æ ¹æ®ç”Ÿæˆçš„åŒ…åˆ—è¡¨ä½¿ç”¨ç›¸åº”çš„åŒ…ç®¡ç†å™¨å·¥å…·ä¸‹è½½éœ€è¦çš„è½¯ä»¶åŒ…ï¼›</li><li>ç”Ÿç”¨ç›¸åº”çš„åŒ…ç®¡ç†å™¨ç”Ÿæˆè¿™äº›åŒ…çš„ index æ–‡ä»¶ï¼Œå¦‚ repodata æˆ– Packages.gz æ–‡ä»¶ï¼›</li><li>å°†ä¸Šè¿°çš„æ„å»ºäº§ç‰© COPY åˆ°åŒä¸€ä¸ªå®¹å™¨é•œåƒé‡Œï¼Œæ¯”å¦‚ nginx ï¼›ä¹Ÿå¯ä»¥å¯¼å‡ºä¸º tar åŒ…æˆ–ç›®å½•ï¼›</li></ul><h3 id="packages-yaml"><a href="#packages-yaml" class="headerlink" title="packages.yaml"></a>packages.yaml</h3><p>è¿™ä¸ªæ–‡ä»¶ç”¨æ¥ç®¡ç†ä¸åŒçš„åŒ…ç®¡ç†å™¨æˆ–è€… Linux å‘è¡Œç‰ˆéœ€è¦å®‰è£…çš„è½¯ä»¶åŒ…ã€‚æ ¹æ®ä¸åŒçš„åŒ…ç®¡ç†å™¨å’Œå‘è¡Œç‰ˆæˆ‘ä»¬å¯ä»¥å°†è¿™äº›åŒ…å¤§è‡´åˆ’åˆ†ä¸º 4 ç±»ã€‚</p><ul><li><p>commonï¼šé€‚ç”¨äºä¸€äº›æ‰€æœ‰åŒ…ç®¡ç†å™¨ä¸­åŒ…åç›¸åŒæˆ–è€…å¯¹ç‰ˆæœ¬æ— è¦æ±‚çš„åŒ…ï¼Œæ¯”å¦‚ vim ã€curlã€wget è¿™ç±»å·¥å…·ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä½¿ç”¨è¿™äº›å·¥å…·æˆ‘ä»¬å¹¶ä¸å…³å¿ƒå®ƒçš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”è¿™ç±»åŒ…çš„åŒ…ååœ¨æ‰€æœ‰çš„åŒ…ç®¡ç†å™¨ä¸­éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥è¿™ç±»å¯ä»¥åˆ’åˆ†ä¸ºå…¬å…±åŒ…ã€‚</p></li><li><p>yum/apt/dnfï¼šé€‚ç”¨äºä¸åŒçš„å‘è¡Œç‰ˆä½¿ç”¨ç›¸åŒçš„åŒ…ç®¡ç†å™¨ã€‚æ¯”å¦‚ nfs çš„åŒ…ï¼Œåœ¨ yum ä¸­åŒ…åä¸º nfs-utils ä½†åœ¨ apt ä¸­ä¸º nfs-commonï¼Œè¿™ç±»è½¯ä»¶åŒ…å¯ä»¥åˆ’åˆ†ä¸ºä¸€ç±»ã€‚</p></li><li><p>OSï¼šé€‚ç”¨äºä¸€äº›è¯¥ OS ç‹¬æœ‰çš„åŒ…ï¼Œæ¯”å¦‚å®‰è£…ä¸€ä¸ª Ubuntu ä¸­æœ‰ä½† Debian ä¸­æ²¡æœ‰çš„åŒ…ï¼ˆæ¯”å¦‚ debian-builder æˆ– ubuntu-dev-toolsï¼‰ã€‚</p></li><li><p>OS-å‘è¡Œç‰ˆä»£å·ï¼šè¿™ç±»åŒ…çš„ç‰ˆæœ¬å’Œå‘è¡Œç‰ˆä»£å·ç»‘å®šåœ¨ä¸€èµ·ï¼Œæ¯”å¦‚ <code>docker-ce=5:19.03.15~3-0~debian-stretchã€‚</code></p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">common:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">vim</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">curl</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">wget</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tree</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lvm2</span></span><br><span class="line"></span><br><span class="line"><span class="attr">yum:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfs-utils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">yum-utils</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">createrepo</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">centos-release-gluster</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">epel-release</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apt:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfs-common</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apt-transport-https</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ca-certificates</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">lsb-release</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">software-properties-common</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">aptitude</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">dpkg-dev</span></span><br><span class="line"></span><br><span class="line"><span class="attr">centos:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">centos-release</span></span><br><span class="line"></span><br><span class="line"><span class="attr">debian:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">debian-builder</span></span><br><span class="line"></span><br><span class="line"><span class="attr">debian-buster:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">docker-ce=5:19.03.15~3-0~debian-buster</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ubuntu:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ubuntu-dev-tools</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œéœ€è¦é¢å¤–æ³¨æ„ä¸€ä¸‹ï¼Œåœ¨ä¸åŒçš„åŒ…ç®¡ç†å™¨ä¹‹é—´æŒ‡å®šåŒ…ç‰ˆæœ¬çš„æ–¹å¼ä¹Ÿå„ä¸ç›¸åŒï¼Œæ¯”å¦‚åœ¨ yum ä¸­å¦‚æœè¦å®‰è£… 19.03.15 ç‰ˆæœ¬çš„ docker-ce åŒ…åä¸º <code>docker-ce-19.03.15</code>ï¼Œè€Œåœ¨ debian ä¸­åŒ…ååˆ™ä¸º <code>docker-ce=5:19.03.15~3-0~debian-stretch</code>ã€‚å¯ä»¥ä½¿ç”¨åŒ…ç®¡ç†å™¨æŸ¥çœ‹ç›¸åŒçš„ä¸€ä¸ªåŒ…å¦‚ docker-ce åœ¨ä¸åŒçš„åŒ…ç®¡ç†å™¨ä¹‹å‰çš„å·®å¼‚ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@centos:]<span class="comment"># yum list docker-ce --showduplicates | grep 19.03.15</span></span><br><span class="line">docker-ce.x86_64            3:19.03.15-3.el7                    docker-ce-stable</span><br><span class="line"></span><br><span class="line">root@debian:/<span class="comment"># apt-cache policy docker-ce</span></span><br><span class="line">docker-ce:</span><br><span class="line">  Installed: (none)</span><br><span class="line">  Candidate: 5:19.03.15~3-0~debian-stretch</span><br><span class="line">  Version table:</span><br><span class="line">     5:19.03.15~3-0~debian-stretch 500</span><br><span class="line">        500 https://download.docker.com/linux/debian stretch/stable amd64 Packages</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç‰ˆæœ¬å·çš„é—®é¢˜åœ¨ kubespray çš„æºç ä¸­ä¹Ÿæ˜¯åŒæ ·åšäº†ç‰¹æ®Šå¤„ç†ï¼Œç›®å‰ç¡®å®æ²¡æœ‰å¤ªå¥½çš„æ–¹æ¡ˆæ¥è§£å†³ï¼Œåªèƒ½æ‰‹åŠ¨ç»´æŠ¤è¿™ä¸ªç‰ˆæœ¬å·ã€‚</p><ul><li>roles/container-engine/docker/vars/redhat.yml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># https://docs.docker.com/engine/installation/linux/centos/#install-from-a-package</span></span><br><span class="line"><span class="comment"># https://download.docker.com/linux/centos/&lt;centos_version&gt;&gt;/x86_64/stable/Packages/</span></span><br><span class="line"><span class="comment"># or do 'yum --showduplicates list docker-engine'</span></span><br><span class="line"><span class="attr">docker_versioned_pkg:</span></span><br><span class="line">  <span class="attr">'latest':</span> <span class="string">docker-ce</span></span><br><span class="line">  <span class="attr">'18.09':</span> <span class="string">docker-ce-18.09.9-3.el7</span></span><br><span class="line">  <span class="attr">'19.03':</span> <span class="string">docker-ce-19.03.15-3.el&#123;&#123;</span> <span class="string">ansible_distribution_major_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'20.10':</span> <span class="string">docker-ce-20.10.5-3.el&#123;&#123;</span> <span class="string">ansible_distribution_major_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'stable':</span> <span class="string">docker-ce-19.03.15-3.el&#123;&#123;</span> <span class="string">ansible_distribution_major_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'edge':</span> <span class="string">docker-ce-19.03.15-3.el&#123;&#123;</span> <span class="string">ansible_distribution_major_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">docker_cli_versioned_pkg:</span></span><br><span class="line">  <span class="attr">'latest':</span> <span class="string">docker-ce-cli</span></span><br><span class="line">  <span class="attr">'18.09':</span> <span class="string">docker-ce-cli-18.09.9-3.el7</span></span><br><span class="line">  <span class="attr">'19.03':</span> <span class="string">docker-ce-cli-19.03.15-3.el&#123;&#123;</span> <span class="string">ansible_distribution_major_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'20.10':</span> <span class="string">docker-ce-cli-20.10.5-3.el&#123;&#123;</span> <span class="string">ansible_distribution_major_version</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">docker_package_info:</span></span><br><span class="line">  <span class="attr">enablerepo:</span> <span class="string">"docker-ce"</span></span><br><span class="line">  <span class="attr">pkgs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; containerd_versioned_pkg[containerd_version | string] &#125;&#125;</span>"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_cli_versioned_pkg[docker_cli_version | string] &#125;&#125;</span>"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_versioned_pkg[docker_version | string] &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><ul><li>roles/container-engine/docker/vars/ubuntu.yml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://download.docker.com/linux/ubuntu/</span></span><br><span class="line"><span class="attr">docker_versioned_pkg:</span></span><br><span class="line">  <span class="attr">'latest':</span> <span class="string">docker-ce</span></span><br><span class="line">  <span class="attr">'18.09':</span> <span class="string">docker-ce=5:18.09.9~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'19.03':</span> <span class="string">docker-ce=5:19.03.15~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'20.10':</span> <span class="string">docker-ce=5:20.10.5~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'stable':</span> <span class="string">docker-ce=5:19.03.15~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'edge':</span> <span class="string">docker-ce=5:19.03.15~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">docker_cli_versioned_pkg:</span></span><br><span class="line">  <span class="attr">'latest':</span> <span class="string">docker-ce-cli</span></span><br><span class="line">  <span class="attr">'18.09':</span> <span class="string">docker-ce-cli=5:18.09.9~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'19.03':</span> <span class="string">docker-ce-cli=5:19.03.15~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">'20.10':</span> <span class="string">docker-ce-cli=5:20.10.5~3-0~ubuntu-&#123;&#123;</span> <span class="string">ansible_distribution_release|lower</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">docker_package_info:</span></span><br><span class="line">  <span class="attr">pkgs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; containerd_versioned_pkg[containerd_version | string] &#125;&#125;</span>"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_cli_versioned_pkg[docker_cli_version | string] &#125;&#125;</span>"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_versioned_pkg[docker_version | string] &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><h3 id="CentOS7"><a href="#CentOS7" class="headerlink" title="CentOS7"></a>CentOS7</h3><p>ä»‹ç»å®Œä¸Šè¿°çš„åŒ…é…ç½®æ–‡ä»¶ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ ¹æ®è¿™ä¸ª packages.yml é…ç½®æ–‡ä»¶ä½¿ç”¨ Dockerfile æ„å»ºè¿™äº›åŒ…çš„ç¦»çº¿æºã€‚ä»¥ä¸‹æ˜¯æ„å»º CentOS 7 ç¦»çº¿æºçš„ Dockerfileã€‚</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ centos 7.9 ä½œä¸º base æ„å»ºé•œåƒ</span></span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7.9</span>.<span class="number">2009</span> as builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰ centos çš„ç‰ˆæœ¬å’Œå¤„ç†å™¨ä½“ç³»æ¶æ„</span></span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=<span class="number">7</span></span><br><span class="line"><span class="keyword">ARG</span> ARCH=x86_64</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨è¿™é‡Œå®šä¹‰ä¸€äº›æ„å»ºæ—¶éœ€è¦çš„è½¯ä»¶åŒ…</span></span><br><span class="line"><span class="keyword">ARG</span> BUILD_TOOLS=<span class="string">"yum-utils createrepo centos-release-gluster epel-release curl"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…æ„å»ºå·¥å…·å’Œé…ç½®ä¸€äº›è½¯ä»¶æº repo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -q -y <span class="variable">$BUILD_TOOLS</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo \</span></span><br><span class="line"><span class="bash">    &amp;&amp; yum makecache &amp;&amp; yum update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éœ€è¦å®‰è£… yq ä¸ªå·¥å…·æ¥å¤„ç† packages.yaml é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£æ packages.yml é…ç½®æ–‡ä»¶ï¼Œç”Ÿæˆæ‰€éœ€è¦çš„ packages.list æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /centos/<span class="variable">$OS_VERSION</span>/os/<span class="variable">$ARCH</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ yq å…ˆå°† YAML æ–‡ä»¶è½¬æ¢æˆ json æ ¼å¼çš„å†…å®¹ï¼Œå†ä½¿ç”¨ jq è¿‡æ»¤å‡ºæ‰€éœ€è¦çš„åŒ…ï¼Œè¾“å‡ºä¸ºä¸€ä¸ªåˆ—è¡¨</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> <span class="string">'.common[],.yum[],.centos[]'</span> packages.yaml | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rpm -qa &gt;&gt; packages.list</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ packages.list ä¸­çš„è½¯ä»¶åŒ…ï¼Œå¹¶ç”Ÿæˆ repo ç´¢å¼•æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> cat packages.list | xargs yumdownloader --resolve \</span></span><br><span class="line"><span class="bash">    &amp;&amp; createrepo -d .</span></span><br><span class="line"><span class="comment"># å°†æ„å»ºäº§ç‰©å¤åˆ¶åˆ°ä¸€å±‚ç©ºçš„é•œåƒä¸­ï¼Œæ–¹ä¾¿å¯¼å‡ºä¸º tar åŒ…æˆ–ç›®å½•çš„æ ¼å¼</span></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=centos7 /centos /centos</span></span><br></pre></td></tr></table></figure><p>åœ¨æœ€åçš„ä¸€ä¸ª FROM é•œåƒä¸­ï¼Œè¿™é‡ŒæŒ‡å®šçš„æ˜¯ <code>scratch</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é•œåƒåï¼Œå®ƒä»£è¡¨çš„æ˜¯ä¸€ä¸ªç©ºçš„é•œåƒ layerã€‚</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æ„å»ºäº§ç‰©å¤åˆ¶åˆ°ä¸€å±‚ç©ºçš„é•œåƒä¸­ï¼Œæ–¹ä¾¿å¯¼å‡ºä¸º tar åŒ…æˆ–ç›®å½•çš„æ ¼å¼</span></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=centos7 /centos /centos</span></span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç›´æ¥å°†æ„å»ºå‡ºæ¥çš„äº§ç‰©æ”¾åˆ° nginx å®¹å™¨ä¸­ï¼Œè¿™æ ·ç›´æ¥è¿è¡Œ nginx å®¹å™¨å°±èƒ½æä¾› yum/apt æºçš„æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM nginx:1.19</span><br><span class="line">COPY --from=centos7 /centos /usr/share/nginx/html</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœè¦æ„å»ºä¸º tar åŒ…æˆ–è€…æœ¬åœ°ç›®å½•çš„æ–¹å¼ï¼Œéœ€è¦ä¸º Docker å¼€å¯ <code>DOCKER_BUILDKIT=1</code> è¿™ä¸ªç‰¹æ€§</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ„å»ºä¸ºæœ¬åœ°ç›®å½•</span></span><br><span class="line">root@debian: ~ <span class="comment"># DOCKER_BUILDKIT=1 docker build -o type=local,dest=$PWD -f Dockerfile.centos .</span></span><br><span class="line"><span class="comment"># æ„å»ºä¸º tar åŒ…</span></span><br><span class="line">root@debian: ~ <span class="comment"># DOCKER_BUILDKIT=1 docker build -o type=tar,dest=$PWD/centos7.tar -f Dockerfile.centos .</span></span><br></pre></td></tr></table></figure><ul><li>æ„å»ºæ—¥å¿—å¦‚ä¸‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[+] Building 30.9s (13/13) FINISHED</span><br><span class="line"> =&gt; [internal] load .dockerignore                                                                                                                                            0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 109B                                                                                                                                            0.0s</span><br><span class="line"> =&gt; [internal] load build definition from Dockerfile.centos                                                                                                                  0.0s</span><br><span class="line"> =&gt; =&gt; transferring dockerfile: 979B                                                                                                                                         0.0s</span><br><span class="line"> =&gt; [internal] load metadata <span class="keyword">for</span> docker.io/library/centos:7.9.2009                                                                                                           2.6s</span><br><span class="line"> =&gt; [centos7 1/7] FROM docker.io/library/centos:7.9.2009@sha256:0f4ec88e21daf75124b8a9e5ca03c37a5e937e0e108a255d890492430789b60e                                             0.0s</span><br><span class="line"> =&gt; [internal] load build context                                                                                                                                            0.0s</span><br><span class="line"> =&gt; =&gt; transferring context: 818B                                                                                                                                            0.0s</span><br><span class="line"> =&gt; CACHED [centos7 2/7] RUN yum install -q -y yum-utils createrepo centos-release-gluster epel-release curl     &amp;&amp; yum-config-manager --add-repo https://download.docker.c  0.0s</span><br><span class="line"> =&gt; [centos7 3/7] WORKDIR /centos/7/os/x86_64                                                                                                                                0.0s</span><br><span class="line"> =&gt; [centos7 4/7] RUN curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64     &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq     &amp;&amp; curl   3.2s</span><br><span class="line"> =&gt; [centos7 5/7] COPY packages.yaml packages.yaml                                                                                                                           0.1s</span><br><span class="line"> =&gt; [centos7 6/7] RUN yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.yum[],.centos[]'</span> | sort -u &gt; packages.list     &amp;&amp; rpm -qa &gt;&gt; packages.list                                1.0s</span><br><span class="line"> =&gt; [centos7 7/7] RUN cat packages.list | xargs yumdownloader --resolve     &amp;&amp; createrepo -d .                                                                              21.6s</span><br><span class="line"> =&gt; [stage-1 1/1] COPY --from=centos7 /centos /centos                                                                                                                        0.5s</span><br><span class="line"> =&gt; exporting to client                                                                                                                                                      0.7s</span><br><span class="line"> =&gt; =&gt; copying files 301.37MB</span><br></pre></td></tr></table></figure><ul><li>æ„å»ºäº§ç‰©å¦‚ä¸‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/build <span class="comment"># tree centos</span></span><br><span class="line">centos</span><br><span class="line">â””â”€â”€ 7</span><br><span class="line">    â””â”€â”€ os</span><br><span class="line">        â””â”€â”€ x86_64</span><br><span class="line">            â”œâ”€â”€ acl-2.2.51-15.el7.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ ansible-2.9.21-1.el7.noarch.rpm</span><br><span class="line">            â”œâ”€â”€ at-3.1.13-24.el7.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ attr-2.4.46-13.el7.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ audit-libs-2.8.5-4.el7.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ audit-libs-python-2.8.5-4.el7.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ avahi-libs-0.6.31-20.el7.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ basesystem-10.0-7.el7.centos.noarch.rpm</span><br><span class="line">            â”œâ”€â”€ bash-4.2.46-34.el7.x86_64.rpm</span><br><span class="line">            â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">            â”œâ”€â”€ redhat-lsb-submod-security-4.1-27.el7.centos.1.x86_64.rpm</span><br><span class="line">            â”œâ”€â”€ repodata</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ 28d2fe2d1dbd9b76d3e5385d42cf628ac9fc34d69e151edfe8d134fe6ac6a6d9-primary.xml.gz</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ 5264ca1af13ec7c870f25b2a28edb3c2843556ca201d07ac681eb4af7a28b47c-primary.sqlite.bz2</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ 591d9c2d5be714356e8db39f006d07073f0e1e024a4a811d5960d8e200a874fb-other.xml.gz</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ c035d2112d55d23a72b6d006b9e86a2f67db78c0de45345e415884aa0782f40c-other.sqlite.bz2</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ cd756169c3718d77201d08590c0613ebed80053f84a2db7acc719b5b9bca866f-filelists.xml.gz</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ ed0c5a36b12cf1d4100f90b4825b93dac832e6e21f83b23ae9d9753842801cee-filelists.sqlite.bz2</span><br><span class="line">            â”‚Â Â  â””â”€â”€ repomd.xml</span><br><span class="line">            â”œâ”€â”€ yum-utils-1.1.31-54.el7_8.noarch.rpm</span><br><span class="line">            â””â”€â”€ zlib-1.2.7-19.el7_9.x86_64.rpm</span><br><span class="line"></span><br><span class="line">4 directories, 368 files</span><br></pre></td></tr></table></figure><h3 id="Debian9"><a href="#Debian9" class="headerlink" title="Debian9"></a>Debian9</h3><p>ä¸‹é¢æ˜¯ Debian9 æ„å»º Dockerfileï¼Œæµç¨‹ä¸Šå’Œ CentOS ç›¸å·®ä¸å¤šï¼Œåªæ˜¯åŒ…ç®¡ç†å™¨çš„ä½¿ç”¨æ–¹å¼ä¸å¤ªç›¸åŒè€Œå·²ï¼Œè¿™é‡Œå°±ä¸å†åšè¯¦ç»†çš„æºç ä»‹ç»ã€‚</p><ul><li>Dockerfile.debian</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:stretch-slim as stretch</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=stretch</span><br><span class="line"><span class="keyword">ARG</span> ARCH=amd64</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEP_PACKAGES=<span class="string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update -y -q \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install -y --no-install-recommends <span class="variable">$DEP_PACKAGES</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian <span class="variable">$&#123;OS_VERSION&#125;</span> stable"</span> \</span></span><br><span class="line"><span class="bash">    | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /debian/<span class="variable">$&#123;OS_VERSION&#125;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> <span class="string">'.common[],.apt[],.debian[]'</span> packages.yaml | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 &gt;&gt; packages.list</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown -R _apt /debian/<span class="variable">$OS_VERSION</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests \</span></span><br><span class="line"><span class="bash">    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="string">'^\w'</span> | sort -u | xargs apt-get download</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ../ &amp;&amp; dpkg-scanpackages <span class="variable">$OS_VERSION</span> | gzip -9c &gt; <span class="variable">$OS_VERSION</span>/Packages.gz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /debian /debian</span></span><br></pre></td></tr></table></figure><h3 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h3><p>Ubuntu ç¦»çº¿æºçš„åˆ¶ä½œæ­¥éª¤å’Œ Debian å·®ä¸å¤ªå¤šï¼Œåªéœ€è¦ç®€å•ä¿®æ”¹ä¸€ä¸‹ Debian çš„ Dockerfile åº”è¯¥å°± OK ï¼Œæ¯”å¦‚ <code>&#39;s/debian/ubuntu/g&#39;</code> ï¼Œæ¯•ç«Ÿ Debian æ˜¯ Ubuntu çš„çˆ¸çˆ¸å˜›ï½ï½ï¼Œæ‰€ä»¥ apt ä½¿ç”¨çš„æ–¹å¼å’ŒåŒ…åå‡ ä¹ä¸€æ¨¡ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p><h3 id="All-in-Oone"><a href="#All-in-Oone" class="headerlink" title="All-in-Oone"></a>All-in-Oone</h3><p>å°†ä¸Šè¿°å‡ ä¸ª Linux å‘è¡Œç‰ˆçš„ Dockerfile æ•´åˆæˆä¸€ä¸ªï¼Œè¿™æ ·åªéœ€è¦ä¸€ä¸ª docker build å‘½ä»¤å°±èƒ½æ„å»ºå‡ºæ‰€éœ€è¦çš„æ‰€æœ‰ OS çš„ç¦»çº¿æºäº†ã€‚</p><ul><li>Dockerfile</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CentOS 7.9 2009</span></span><br><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7.9</span>.<span class="number">2009</span> as centos7</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=<span class="number">7</span></span><br><span class="line"><span class="keyword">ARG</span> ARCH=x86_64</span><br><span class="line"><span class="keyword">ARG</span> BUILD_TOOLS=<span class="string">"yum-utils createrepo centos-release-gluster epel-release curl"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -q -y <span class="variable">$BUILD_TOOLS</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo \</span></span><br><span class="line"><span class="bash">    &amp;&amp; yum makecache &amp;&amp; yum update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -sL -o /usr/<span class="built_in">local</span>/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/jq</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /centos/<span class="variable">$OS_VERSION</span>/os/<span class="variable">$ARCH</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.yum[],.centos[]'</span> | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rpm -qa &gt;&gt; packages.list</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> cat packages.list | xargs yumdownloader --resolve \</span></span><br><span class="line"><span class="bash">    &amp;&amp; createrepo -d .</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Debian 9 stretch</span></span><br><span class="line"><span class="keyword">FROM</span> debian:stretch-slim as stretch</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=stretch</span><br><span class="line"><span class="keyword">ARG</span> ARCH=amd64</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEP_PACKAGES=<span class="string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update -y -q \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install -y --no-install-recommends <span class="variable">$DEP_PACKAGES</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian <span class="variable">$&#123;OS_VERSION&#125;</span> stable"</span> \</span></span><br><span class="line"><span class="bash">    | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -sL -o /usr/<span class="built_in">local</span>/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/jq</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /debian/<span class="variable">$&#123;OS_VERSION&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.apt[],.debian[]'</span> | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 &gt;&gt; packages.list</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown -R _apt /debian/<span class="variable">$OS_VERSION</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests \</span></span><br><span class="line"><span class="bash">    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="string">'^\w'</span> | sort -u | xargs apt-get download</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ../ &amp;&amp; dpkg-scanpackages <span class="variable">$OS_VERSION</span> | gzip -9c &gt; <span class="variable">$OS_VERSION</span>/Packages.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Debian 10 buster</span></span><br><span class="line"><span class="keyword">FROM</span> debian:buster-slim as buster</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=buster</span><br><span class="line"><span class="keyword">ARG</span> ARCH=amd64</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEP_PACKAGES=<span class="string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update -y -q \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install -y --no-install-recommends <span class="variable">$DEP_PACKAGES</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian <span class="variable">$&#123;OS_VERSION&#125;</span> stable"</span> \</span></span><br><span class="line"><span class="bash">    | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -sL -o /usr/<span class="built_in">local</span>/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/jq</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /debian/<span class="variable">$&#123;OS_VERSION&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.apt[],.debian[]'</span> | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 &gt;&gt; packages.list</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown -R _apt /debian/<span class="variable">$OS_VERSION</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests \</span></span><br><span class="line"><span class="bash">    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="string">'^\w'</span> | sort -u | xargs apt-get download</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ../ &amp;&amp; dpkg-scanpackages <span class="variable">$OS_VERSION</span> | gzip -9c &gt; <span class="variable">$OS_VERSION</span>/Packages.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu 18.04 bionic</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:bionic as bionic</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=bionic</span><br><span class="line"><span class="keyword">ARG</span> ARCH=amd64</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEP_PACKAGES=<span class="string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update -y -q \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install -y --no-install-recommends <span class="variable">$DEP_PACKAGES</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu <span class="variable">$&#123;OS_VERSION&#125;</span> stable"</span> \</span></span><br><span class="line"><span class="bash">    | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -sL -o /usr/<span class="built_in">local</span>/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/jq</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /ubuntu/<span class="variable">$&#123;OS_VERSION&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.apt[],.ubuntu[]'</span> | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 &gt;&gt; packages.list</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown -R _apt /ubuntu/<span class="variable">$OS_VERSION</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests \</span></span><br><span class="line"><span class="bash">    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="string">'^\w'</span> | sort -u | xargs apt-get download</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ../ &amp;&amp; dpkg-scanpackages <span class="variable">$OS_VERSION</span> | gzip -9c &gt; <span class="variable">$OS_VERSION</span>/Packages.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu 20.04 focal</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:focal as focal</span><br><span class="line"><span class="keyword">ARG</span> OS_VERSION=focal</span><br><span class="line"><span class="keyword">ARG</span> ARCH=amd64</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> DEP_PACKAGES=<span class="string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update -y -q \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install -y --no-install-recommends <span class="variable">$DEP_PACKAGES</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu <span class="variable">$&#123;OS_VERSION&#125;</span> stable"</span> \</span></span><br><span class="line"><span class="bash">    | tee /etc/apt/sources.list.d/docker.list &gt; /dev/null \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update -y -q</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> curl -sL -o /usr/<span class="built_in">local</span>/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/yq \</span></span><br><span class="line"><span class="bash">    &amp;&amp; curl -sL -o /usr/<span class="built_in">local</span>/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/jq</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /ubuntu/<span class="variable">$&#123;OS_VERSION&#125;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> packages.yaml packages.yaml</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yq <span class="built_in">eval</span> packages.yaml -j | jq -r <span class="string">'.common[],.apt[],.ubuntu[]'</span> | sort -u &gt; packages.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 &gt;&gt; packages.list</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> chown -R _apt /ubuntu/<span class="variable">$OS_VERSION</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests \</span></span><br><span class="line"><span class="bash">    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="string">'^\w'</span> | sort -u | xargs apt-get download</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> ../ &amp;&amp; dpkg-scanpackages <span class="variable">$OS_VERSION</span> | gzip -9c &gt; <span class="variable">$OS_VERSION</span>/Packages.gz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=centos7 /centos /centos</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=stretch /debian /debian</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=buster /debian /debian</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=bionic /ubuntu /ubuntu</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=focal /ubuntu /ubuntu</span></span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h2><p>æ„å»ºå¥½äº†ç¦»çº¿æºä¹‹åï¼Œåœ¨éƒ¨ç½²çš„æœºå™¨ä¸Šè¿è¡Œä¸€ä¸ª Nginx æœåŠ¡ï¼Œç”¨äºæä¾› HTTP æ–¹å¼ä¸‹è½½è¿™äº›è½¯ä»¶åŒ…ï¼ŒåŒæ—¶éœ€è¦é…ç½®ä¸€ä¸‹æœºå™¨çš„åŒ…ç®¡ç†å™¨ repo é…ç½®æ–‡ä»¶ã€‚</p><ul><li>CentOS 7</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Inra-Mirror]</span><br><span class="line">name=Infra Mirror Repository</span><br><span class="line">baseurl=http://172.20.0.10/centos/7/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br></pre></td></tr></table></figure><ul><li>Debian 9 stretch</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb [trusted=yes] http://172.20.0.10:8080/debian stretch/</span><br></pre></td></tr></table></figure><ul><li>Debian 10 buster</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb [trusted&#x3D;yes] http:&#x2F;&#x2F;172.20.0.10:8080&#x2F;debian buster&#x2F;</span><br></pre></td></tr></table></figure><ul><li>Ubuntu 18.04 bionic</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb [trusted=yes] http://172.20.0.10:8080/ubuntu bionic/</span><br></pre></td></tr></table></figure><ul><li>Ubuntu 20.04 focal</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb [trusted&#x3D;yes] http:&#x2F;&#x2F;172.20.0.10:8080&#x2F;debian focal&#x2F;</span><br></pre></td></tr></table></figure><h2 id="GitHub-Action-è‡ªåŠ¨æ„å»º"><a href="#GitHub-Action-è‡ªåŠ¨æ„å»º" class="headerlink" title="GitHub Action è‡ªåŠ¨æ„å»º"></a>GitHub Action è‡ªåŠ¨æ„å»º</h2><p>å‡†å¤‡å¥½ä¸Šé¢è¿™äº› Dockerfile ä¹‹åï¼Œæ¥ä¸‹æ¥å°±è¦è€ƒè™‘æ„å»ºçš„é—®é¢˜äº†ã€‚å¯¹äºä¸€ä¸ª PaaS æˆ–è€… IaaS äº§å“éœ€è¦é€‚é…ä¸»æµçš„ Linux å‘è¡Œç‰ˆï¼Œæœ‰æ—¶è¿˜éœ€è¦é€‚é… arm64 æ¶æ„çš„æœºå™¨ã€‚å¦‚æœæœ¬åœ°æ‰‹åŠ¨ docker build æ¥æ„å»ºçš„è¯ï¼Œæ•ˆç‡å¾ˆä½ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨ GitHub actions è‡ªåŠ¨æ„å»ºè¿™äº› rpm/deb åŒ…çš„ç¦»çº¿æºï¼Œå…·ä½“å®ç°ä»£ç å¯å‚è€ƒ <a href="https://github.com/k8sli/os-packages" target="_blank" rel="noopener">k8sli/os-packages</a></p><h3 id="ä»£ç ç»“æ„"><a href="#ä»£ç ç»“æ„" class="headerlink" title="ä»£ç ç»“æ„"></a>ä»£ç ç»“æ„</h3><p>åœ¨ build ç›®å½•é‡Œå­˜æ”¾å„ç§å‘è¡Œç‰ˆçš„ Dockerfileã€‚ç”±äºä¸åŒçš„å‘è¡Œç‰ˆä»¥åŠæ¯ä¸ªå‘è¡Œç‰ˆçš„ç‰ˆæœ¬æ„å»ºæ–¹æ³•åƒå·®ä¸‡åˆ«ï¼Œå› æ­¤æ¯ä¸ªå‘è¡Œç‰ˆ OS åœ¨ä¸€ä¸ªå•ç‹¬çš„ Dockerfile é‡Œæ„å»ºã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">os-packages/</span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ Makefile</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ build</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Dockerfile.os.centos7</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Dockerfile.os.centos8</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Dockerfile.os.debian10</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Dockerfile.os.debian9</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Dockerfile.os.fedora33</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Dockerfile.os.fedora34</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ Dockerfile.os.ubuntu1804</span><br><span class="line">â”‚Â Â  â””â”€â”€ Dockerfile.os.ubuntu2004</span><br><span class="line">â”œâ”€â”€ packages.yaml</span><br><span class="line">â””â”€â”€ repos</span><br><span class="line">    â”œâ”€â”€ CentOS-All-in-One.repo</span><br><span class="line">    â”œâ”€â”€ Debian-buster-All-in-One.list</span><br><span class="line">    â”œâ”€â”€ Fedora-All-in-One.repo</span><br><span class="line">    â””â”€â”€ Ubuntu-focal-All-in-One.list</span><br></pre></td></tr></table></figure><h3 id="Workflow"><a href="#Workflow" class="headerlink" title="Workflow"></a>Workflow</h3><ul><li>è§¦å‘æ–¹å¼</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Build</span> <span class="string">os-packages</span> <span class="string">image</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">tag:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'v*'</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">[main,</span> <span class="string">release-*,</span> <span class="string">master]</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br></pre></td></tr></table></figure><ul><li>å…¨å±€å˜é‡</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="comment"># é•œåƒä»“åº“åŸŸå</span></span><br><span class="line">  <span class="attr">IMAGE_REGISTRY:</span> <span class="string">"ghcr.io"</span></span><br><span class="line">  <span class="comment"># é•œåƒä»“åº“ç”¨æˆ·å</span></span><br><span class="line">  <span class="attr">REGISTRY_USER:</span> <span class="string">"$<span class="template-variable">&#123;&#123; github.repository_owner &#125;&#125;</span>"</span></span><br><span class="line">  <span class="comment"># é•œåƒä»“åº“ç™»å½•å‡­æ®</span></span><br><span class="line">  <span class="attr">REGISTRY_TOKEN:</span> <span class="string">"$<span class="template-variable">&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;</span>"</span></span><br><span class="line">  <span class="comment"># é•œåƒä»“åº“æ¨é€ repo</span></span><br><span class="line">  <span class="attr">IMAGE_REPO:</span> <span class="string">"ghcr.io/$<span class="template-variable">&#123;&#123; github.repository_owner &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><ul><li>æ„å»ºçŸ©é˜µï¼Œè¿™äº› job ä¼šå„è‡ªè¿è¡Œä¸€ä¸ª runner æ¥è¿›è¡Œå¹¶è¡Œæ„å»º</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-20.04</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">fail-fast:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">include:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ubuntu-bionic</span></span><br><span class="line">            <span class="attr">image_name:</span> <span class="string">os-packages-ubuntu1804</span></span><br><span class="line">            <span class="attr">dockerfile:</span> <span class="string">build/Dockerfile.os.ubuntu1804</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ubuntu-focal</span></span><br><span class="line">            <span class="attr">image_name:</span> <span class="string">os-packages-ubuntu2004</span></span><br><span class="line">            <span class="attr">dockerfile:</span> <span class="string">build/Dockerfile.os.ubuntu2004</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">centos-7</span></span><br><span class="line">            <span class="attr">image_name:</span> <span class="string">os-packages-centos7</span></span><br><span class="line">            <span class="attr">dockerfile:</span> <span class="string">build/Dockerfile.os.centos7</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">centos-8</span></span><br><span class="line">            <span class="attr">image_name:</span> <span class="string">os-packages-centos8</span></span><br><span class="line">            <span class="attr">dockerfile:</span> <span class="string">build/Dockerfile.os.centos8</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debian-buster</span></span><br><span class="line">            <span class="attr">image_name:</span> <span class="string">os-packages-debian10</span></span><br><span class="line">            <span class="attr">dockerfile:</span> <span class="string">build/Dockerfile.os.debian10</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debian-stretch</span></span><br><span class="line">            <span class="attr">image_name:</span> <span class="string">os-packages-debian9</span></span><br><span class="line">            <span class="attr">dockerfile:</span> <span class="string">build/Dockerfile.os.debian9</span></span><br></pre></td></tr></table></figure><ul><li>checkout ä»£ç ï¼Œé…ç½® buildx æ„å»ºç¯å¢ƒ</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">    <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">    <span class="attr">with:</span></span><br><span class="line">      <span class="comment"># fetch all git repo tag for define image tag</span></span><br><span class="line">      <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">QEMU</span></span><br><span class="line">    <span class="attr">uses:</span> <span class="string">docker/setup-qemu-action@v1</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Docker</span> <span class="string">Buildx</span></span><br><span class="line">    <span class="attr">uses:</span> <span class="string">docker/setup-buildx-action@v1</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Log</span> <span class="string">in</span> <span class="string">to</span> <span class="string">GitHub</span> <span class="string">Docker</span> <span class="string">Registry</span></span><br><span class="line">    <span class="attr">uses:</span> <span class="string">docker/login-action@v1</span></span><br><span class="line">    <span class="attr">with:</span></span><br><span class="line">      <span class="attr">registry:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.IMAGE_REGISTRY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.REGISTRY_USER</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.REGISTRY_TOKEN</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ <code>git describe --tags</code> æ–¹å¼ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„é•œåƒ tag</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prepare</span> <span class="string">for</span> <span class="string">build</span> <span class="string">images</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">git</span> <span class="string">describe</span> <span class="string">--tags</span> <span class="string">--always</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/IMAGE_TAG=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br></pre></td></tr></table></figure><ul><li>æ„å»ºé•œåƒå¹¶ push åˆ°é•œåƒä»“åº“ï¼Œåé¢æ‰“åŒ…ä¸€ä¸ª All-in-one çš„åŒ…æ—¶å€™ä¼šç”¨åˆ°</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">and</span> <span class="string">push</span> <span class="string">os-package</span> <span class="string">images</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">docker/build-push-action@v2</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">push:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event_name</span> <span class="string">!=</span> <span class="string">'pull_request'</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.dockerfile</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">platforms:</span> <span class="string">linux/amd64,linux/arm64</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">$&#123;&#123;</span> <span class="string">env.IMAGE_REPO</span> <span class="string">&#125;&#125;/$&#123;&#123;</span> <span class="string">matrix.image_name</span> <span class="string">&#125;&#125;:$&#123;&#123;</span> <span class="string">env.IMAGE_TAG</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><ul><li>ç”Ÿæˆæ–°çš„ Dockerfileï¼Œå¯¼å‡ºé•œåƒåˆ°æœ¬åœ°ç›®å½•</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen</span> <span class="string">new</span> <span class="string">Dockerfile</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">echo</span> <span class="string">-e</span> <span class="string">"FROM scratch\nCOPY --from=$<span class="template-variable">&#123;&#123; env.IMAGE_REPO &#125;&#125;</span>/$<span class="template-variable">&#123;&#123; matrix.image_name &#125;&#125;</span>:$<span class="template-variable">&#123;&#123; env.IMAGE_TAG &#125;&#125;</span> / /"</span> <span class="string">&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">kubeplay</span> <span class="string">image</span> <span class="string">to</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">docker/build-push-action@v2</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">platforms:</span> <span class="string">linux/amd64,linux/arm64</span></span><br><span class="line">    <span class="attr">outputs:</span> <span class="string">type=local,dest=./</span></span><br></pre></td></tr></table></figure><ul><li>å°†æœ€ç»ˆæ„å»ºäº§ç‰©æ‰“åŒ…ä¸Šä¼ åˆ° GitHub release</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prepare</span> <span class="string">for</span> <span class="string">upload</span> <span class="string">package</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">linux_amd64/resources</span> <span class="string">resources</span></span><br><span class="line">    <span class="string">tar</span> <span class="string">-I</span> <span class="string">pigz</span> <span class="string">-cf</span> <span class="string">resources-$&#123;&#123;</span> <span class="string">matrix.image_name</span> <span class="string">&#125;&#125;-$&#123;IMAGE_TAG&#125;-amd64.tar.gz</span> <span class="string">resources</span> <span class="string">--remove-files</span></span><br><span class="line">    <span class="string">mv</span> <span class="string">linux_arm64/resources</span> <span class="string">resources</span></span><br><span class="line">    <span class="string">tar</span> <span class="string">-I</span> <span class="string">pigz</span> <span class="string">-cf</span> <span class="string">resources-$&#123;&#123;</span> <span class="string">matrix.image_name</span> <span class="string">&#125;&#125;-$&#123;IMAGE_TAG&#125;-arm64.tar.gz</span> <span class="string">resources</span> <span class="string">--remove-files</span></span><br><span class="line">    <span class="string">sha256sum</span> <span class="string">resources-$&#123;&#123;</span> <span class="string">matrix.image_name</span> <span class="string">&#125;&#125;-$&#123;IMAGE_TAG&#125;-&#123;amd64,arm64&#125;.tar.gz</span> <span class="string">&gt;</span> <span class="string">resources-$&#123;&#123;</span> <span class="string">matrix.image_name</span> <span class="string">&#125;&#125;-$&#123;IMAGE_TAG&#125;.sha256sum.txt</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span> <span class="string">and</span> <span class="string">upload</span> <span class="string">packages</span></span><br><span class="line">  <span class="attr">if:</span> <span class="string">startsWith(github.ref,</span> <span class="string">'refs/tags/'</span><span class="string">)</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">softprops/action-gh-release@v1</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">files:</span> <span class="string">|</span></span><br><span class="line">      <span class="string">resources-$&#123;&#123;</span> <span class="string">matrix.image_name</span> <span class="string">&#125;&#125;-$&#123;&#123;</span> <span class="string">env.IMAGE_TAG</span> <span class="string">&#125;&#125;.sha256sum.txt</span></span><br><span class="line">      <span class="string">resources-$&#123;&#123;</span> <span class="string">matrix.image_name</span> <span class="string">&#125;&#125;-$&#123;&#123;</span> <span class="string">env.IMAGE_TAG</span> <span class="string">&#125;&#125;-amd64.tar.gz</span></span><br><span class="line">      <span class="string">resources-$&#123;&#123;</span> <span class="string">matrix.image_name</span> <span class="string">&#125;&#125;-$&#123;&#123;</span> <span class="string">env.IMAGE_TAG</span> <span class="string">&#125;&#125;-arm64.tar.gz</span></span><br></pre></td></tr></table></figure><ul><li>All-in-one åˆå¹¶æ‰€æœ‰æ„å»ºçš„é•œåƒ</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upload:</span></span><br><span class="line">  <span class="attr">needs:</span> <span class="string">[build]</span></span><br><span class="line">  <span class="attr">runs-on:</span> <span class="string">ubuntu-20.04</span></span><br><span class="line">  <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="comment"># fetch all git repo tag for define image tag</span></span><br><span class="line">        <span class="attr">fetch-depth:</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">QEMU</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">docker/setup-qemu-action@v1</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Docker</span> <span class="string">Buildx</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">docker/setup-buildx-action@v1</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Log</span> <span class="string">in</span> <span class="string">to</span> <span class="string">GitHub</span> <span class="string">Docker</span> <span class="string">Registry</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">docker/login-action@v1</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">registry:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.IMAGE_REGISTRY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.REGISTRY_USER</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">$&#123;&#123;</span> <span class="string">env.REGISTRY_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prepare</span> <span class="string">for</span> <span class="string">build</span> <span class="string">images</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">git</span> <span class="string">describe</span> <span class="string">--tags</span> <span class="string">--always</span> <span class="string">|</span> <span class="string">sed</span> <span class="string">'s/^/IMAGE_TAG=/'</span> <span class="string">&gt;&gt;</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">        <span class="string">source</span> <span class="string">$GITHUB_ENV</span></span><br><span class="line">        <span class="string">echo</span> <span class="string">"FROM scratch"</span> <span class="string">&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line">        <span class="string">echo</span> <span class="string">"COPY --from=$<span class="template-variable">&#123;&#123; env.IMAGE_REPO &#125;&#125;</span>/os-packages-ubuntu1804:$&#123;IMAGE_TAG&#125; / /"</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line">        <span class="string">echo</span> <span class="string">"COPY --from=$<span class="template-variable">&#123;&#123; env.IMAGE_REPO &#125;&#125;</span>/os-packages-ubuntu2004:$&#123;IMAGE_TAG&#125; / /"</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line">        <span class="string">echo</span> <span class="string">"COPY --from=$<span class="template-variable">&#123;&#123; env.IMAGE_REPO &#125;&#125;</span>/os-packages-centos7:$&#123;IMAGE_TAG&#125; / /"</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line">        <span class="string">echo</span> <span class="string">"COPY --from=$<span class="template-variable">&#123;&#123; env.IMAGE_REPO &#125;&#125;</span>/os-packages-centos8:$&#123;IMAGE_TAG&#125; / /"</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line">        <span class="string">echo</span> <span class="string">"COPY --from=$<span class="template-variable">&#123;&#123; env.IMAGE_REPO &#125;&#125;</span>/os-packages-debian9:$&#123;IMAGE_TAG&#125; / /"</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line">        <span class="string">echo</span> <span class="string">"COPY --from=$<span class="template-variable">&#123;&#123; env.IMAGE_REPO &#125;&#125;</span>/os-packages-debian10:$&#123;IMAGE_TAG&#125; / /"</span> <span class="string">&gt;&gt;</span> <span class="string">Dockerfile</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">os-packages</span> <span class="string">images</span> <span class="string">to</span> <span class="string">local</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">docker/build-push-action@v2</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">        <span class="attr">file:</span> <span class="string">Dockerfile</span></span><br><span class="line">        <span class="attr">platforms:</span> <span class="string">linux/amd64,linux/arm64</span></span><br><span class="line">        <span class="attr">outputs:</span> <span class="string">type=local,dest=./</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prepare</span> <span class="string">for</span> <span class="string">upload</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">mv</span> <span class="string">linux_amd64/resources</span> <span class="string">resources</span></span><br><span class="line">        <span class="string">tar</span> <span class="string">-I</span> <span class="string">pigz</span> <span class="string">-cf</span> <span class="string">resources-os-packages-all-$&#123;IMAGE_TAG&#125;-amd64.tar.gz</span> <span class="string">resources</span> <span class="string">--remove-files</span></span><br><span class="line">        <span class="string">mv</span> <span class="string">linux_arm64/resources</span> <span class="string">resources</span></span><br><span class="line">        <span class="string">tar</span> <span class="string">-I</span> <span class="string">pigz</span> <span class="string">-cf</span> <span class="string">resources-os-packages-all-$&#123;IMAGE_TAG&#125;-arm64.tar.gz</span> <span class="string">resources</span> <span class="string">--remove-files</span></span><br><span class="line">        <span class="string">sha256sum</span> <span class="string">resources-os-packages-all-$&#123;IMAGE_TAG&#125;-&#123;amd64,arm64&#125;.tar.gz</span> <span class="string">&gt;</span> <span class="string">resources-os-packages-all-$&#123;IMAGE_TAG&#125;.sha256sum.txt</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span> <span class="string">and</span> <span class="string">upload</span> <span class="string">packages</span></span><br><span class="line">      <span class="attr">if:</span> <span class="string">startsWith(github.ref,</span> <span class="string">'refs/tags/'</span><span class="string">)</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">softprops/action-gh-release@v1</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">files:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">resources-os-packages-all-$&#123;&#123;</span> <span class="string">env.IMAGE_TAG</span> <span class="string">&#125;&#125;.sha256sum.txt</span></span><br><span class="line">          <span class="string">resources-os-packages-all-$&#123;&#123;</span> <span class="string">env.IMAGE_TAG</span> <span class="string">&#125;&#125;-amd64.tar.gz</span></span><br><span class="line">          <span class="string">resources-os-packages-all-$&#123;&#123;</span> <span class="string">env.IMAGE_TAG</span> <span class="string">&#125;&#125;-arm64.tar.gz</span></span><br></pre></td></tr></table></figure><h2 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h2><h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>å¯ä»¥è€ƒè™‘å°† Dockerfile ä¸­çš„æ„å»ºè¿‡ç¨‹åˆå¹¶æˆä¸€ä¸ª shell è„šæœ¬ï¼Œç„¶ååœ¨ Dockerfile ä¸­è°ƒç”¨è¿™ä¸ªè„šæœ¬å³å¯ï¼Œè¿™æ ·å¯ä¼˜åŒ– Dockerfile ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼ŒåŒæ—¶åç»­é€‚é…å¤šç§ OS çš„æ—¶å€™ä¹Ÿå¯ä»¥å¤ç”¨éƒ¨åˆ†ç›¸åŒçš„ä»£ç ï¼Œä½†è¿™æ ·å¯èƒ½ä¼šå¯¼è‡´ docker build ç¼“å­˜çš„å¤±æ•ˆé—®é¢˜ã€‚</p><p>å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨è„šæœ¬å°†å¤šä¸ª Dockerfile åˆå¹¶æˆä¸€ä¸ªï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Merge all Dockerfile.xx to an all-in-one file</span></span><br><span class="line">ls Dockerfile.* | xargs -L1 grep -Ev 'FROM scratch|COPY --from=' &gt; Dockerfile</span><br><span class="line">echo "FROM scratch" &gt;&gt; Dockerfile</span><br><span class="line">ls Dockerfile.* | xargs -L1 grep 'COPY --from=' &gt;&gt; Dockerfile</span><br></pre></td></tr></table></figure><p>å…¶å®å¦‚æœä½¿ç”¨ GitHub actions æ¥æ„å»ºçš„è¯ï¼Œå°±ä¸éœ€è¦è¿›è¡Œåˆå¹¶äº†ï¼Œä½¿ç”¨ actions çŸ©é˜µæ„å»ºçš„ç‰¹æ€§å¯å¹¶è¡Œæ„å»ºã€‚</p><h3 id="Package-version"><a href="#Package-version" class="headerlink" title="Package version"></a>Package version</h3><p>å¯¹äºä¸€äº›ç‰ˆæœ¬ä¸­åŒ…å« Linux å‘è¡Œç‰ˆæœ¬ä»£å·çš„åŒ…æ¥è®²ï¼Œæ‰‹åŠ¨ç»´æŠ¤è¿™ä¸ªä»£å·ä¸å¤ªæ–¹ä¾¿ï¼Œå¯ä»¥è€ƒè™‘å°†å®ƒé­”æ”¹æˆå ä½å˜é‡çš„æ–¹å¼ï¼Œåœ¨æ„å»ºå®¹å™¨å†…ç”Ÿæˆ package.list æ–‡ä»¶åç»Ÿä¸€ä½¿ç”¨ sed æŠŠè¿™äº›å ä½çš„å˜é‡ç»™æ›¿æ¢ä¸€ä¸‹ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt:</span><br><span class="line">  - docker-ce=5:19.03.15~3-0~__ID__-__VERSION_CODENAME__</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ sed å¤„ç†ä¸€ä¸‹ç”Ÿæˆçš„ packages.list ä¸­çš„è¿™äº›å ä½ç¬¦å˜é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">"s|__ID__|<span class="variable">$(sed -n 's|^ID=||p' /etc/os-release)</span>|;s|__VERSION_CODENAME__|<span class="variable">$(sed -n 's|^VERSION_CODENAME=||p' /etc/os-release)</span>|"</span> packages.list</span><br></pre></td></tr></table></figure><p>è™½ç„¶è¿™æ ·åšå¾ˆä¸ç¾è§‚ï¼Œä½†è¿™ç§æ–¹å¼ç¡®å®å¯è¡Œ ğŸ˜‚ï¼Œæœ€ç»ˆèƒ½å¤Ÿçš„åˆ°æ­£ç¡®çš„ç‰ˆæœ¬å·ã€‚æ€»ä¹‹æˆ‘ä»¬å°½é‡åœ°å°‘ç»´æŠ¤ä¸€äº›åŒ…çš„ç‰ˆæœ¬ï¼Œæ¯”å¦‚ä½¿ç”¨è¿™ç§æ–¹å¼å°±å¯ä»¥å°†æŸä¸ªç‰ˆæœ¬çš„ docker-ce åŒ…æ”¾åœ¨é…ç½®æ–‡ä»¶çš„ apt ä¸­ï¼Œè€Œä¸æ˜¯ debian/ubuntu ä¸­ï¼Œé€šè¿‡ä¸€äº›ç¯å¢ƒå˜é‡æˆ–è€… shell è„šæœ¬è‡ªåŠ¨æ·»åŠ ä¸Šè¿™äº›ç‰¹æ®Šé¡¹ï¼Œè¿™æ ·èƒ½å‡å°‘ä¸€äº›ç»´æŠ¤æˆæœ¬ã€‚</p><h2 id="è¸©å‘"><a href="#è¸©å‘" class="headerlink" title="è¸©å‘"></a>è¸©å‘</h2><ul><li>Fedora æŒ‡å®šåŒ…çš„ç‰ˆæœ¬æ—¶ï¼Œä¹Ÿéœ€è¦åŠ ä¸Š Fedora çš„ç‰ˆæœ¬</li><li>CentOS 7 å’Œ CentOS 8 æœ‰äº›åŒ…çš„åŒ…åä¸åŒï¼Œéœ€è¦å•ç‹¬å¤„ç†ä¸€ä¸‹</li><li>CentOS 7 å’Œ CentOS 8 æ„å»ºæ–¹å¼ä¸åŒï¼Œæœ€åç”Ÿæˆ repodata çš„æ—¶å€™ CentOS 8 éœ€è¦å•ç‹¬å¤„ç†ä¸€ä¸‹</li><li>Fedora 33 å’Œ Fedora34 ä½¿ç”¨ GitHub action æ„å»ºçš„æ—¶å€™ arm64 æ¶æ„çš„ä¼šä¸€ç›´å¡ä½ï¼Œæ˜¯ç”±äº buildx çš„ bug æ‰€è‡´ï¼Œå› æ­¤åªç»™å‡ºäº† Dockerfileï¼Œå¹¶æœªæ”¾åœ¨ GitHub actions æ„å»ºæµæ°´çº¿ä¸­ã€‚</li></ul><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li><a href="https://www.aptly.info/tutorial/mirror/" target="_blank" rel="noopener">aptly.info</a></li><li><a href="https://mozillazg.com/2018/01/jq-use-examples-cookbook.html" target="_blank" rel="noopener">jq å¸¸ç”¨æ“ä½œ</a></li><li><a href="https://lyyao09.github.io/2019/08/02/tools/The-usage-of-yq-read-write/" target="_blank" rel="noopener">yq ä¹‹è¯»å†™ç¯‡</a></li><li><a href="https://docs.docker.com/develop/develop-images/build_enhancements/" target="_blank" rel="noopener">Build images with BuildKit</a></li><li><a href="https://github.com/kubernetes-sigs/kubespray/pull/6766" target="_blank" rel="noopener">kubernetes-sigs/kubespray/pull/6766</a></li><li><a href="https://moelove.info/2021/03/14/ä¸‡å­—é•¿æ–‡å½»åº•ææ‡‚å®¹å™¨é•œåƒæ„å»º/" target="_blank" rel="noopener">ä¸‡å­—é•¿æ–‡ï¼šå½»åº•ææ‡‚å®¹å™¨é•œåƒæ„å»º</a></li><li><a href="https://www.xiaocoder.com/2017/09/12/offline-local-source/" target="_blank" rel="noopener">ä¸º CentOS ä¸ Ubuntu åˆ¶ä½œç¦»çº¿æœ¬åœ°æº</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;h2 id=&quot;ç¦»çº¿éƒ¨ç½²&quot;&gt;&lt;a href=&quot;#ç¦»çº¿éƒ¨ç½²&quot;
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="docker" scheme="https://blog.k8s.li/tags/docker/"/>
    
      <category term="centos" scheme="https://blog.k8s.li/tags/centos/"/>
    
      <category term="ubuntu" scheme="https://blog.k8s.li/tags/ubuntu/"/>
    
      <category term="rpm" scheme="https://blog.k8s.li/tags/rpm/"/>
    
      <category term="deb" scheme="https://blog.k8s.li/tags/deb/"/>
    
  </entry>
  
  <entry>
    <title>kubespray éƒ¨ç½²å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æ±‡æ€»</title>
    <link href="https://blog.k8s.li/kubespray-tips.html"/>
    <id>https://blog.k8s.li/kubespray-tips.html</id>
    <published>2021-05-12T16:00:00.000Z</published>
    <updated>2021-05-12T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>kubespray v2.16 ç‰ˆæœ¬å³å°†å‘å¸ƒï¼Œæ•´ç†ä¸€ä¸‹è‡ªå·±åœ¨ä½¿ç”¨ kubespray è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œä¸€äº›ä¼˜åŒ–å»ºè®®ã€‚</p><h2 id="äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="äºŒè¿›åˆ¶æ–‡ä»¶"></a>äºŒè¿›åˆ¶æ–‡ä»¶</h2><p>åœ¨ kubespray ä¸Šæ¸¸çš„ <a href="https://github.com/kubernetes-sigs/kubespray/pull/7561" target="_blank" rel="noopener">#7561</a>  PR ä¸­å®ç°äº†æ ¹æ® kubespray çš„æºç ç”Ÿæˆéœ€è¦çš„æ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ã€‚åªéœ€è¦åœ¨ repo çš„ <code>contrib/offline</code> ç›®å½•ä¸‹æ‰§è¡Œ <code>bash generate_list.sh</code> å°±å¯ä»¥ç”Ÿæˆä¸€ä¸ª files.list å’Œä¸€ä¸ª images.list  æ–‡ä»¶ã€‚ç„¶åå°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ–‡ä»¶æ¥ä¸‹è½½ä¾èµ–çš„æ–‡ä»¶å’Œé•œåƒã€‚å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> contrib/offline</span><br><span class="line">$ bash generate_list.sh</span><br><span class="line">$ tree temp</span><br><span class="line">temp</span><br><span class="line">â”œâ”€â”€ files.list</span><br><span class="line">â”œâ”€â”€ generate.sh</span><br><span class="line">â””â”€â”€ images.list</span><br></pre></td></tr></table></figure><ul><li>files.list å†…å®¹å¦‚ä¸‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cat temp/files.list</span><br><span class="line">https://get.helm.sh/helm-v3.5.4-linux-amd64.tar.gz</span><br><span class="line">https://github.com/containerd/nerdctl/releases/download/v0.8.0/nerdctl-0.8.0-linux-amd64.tar.gz</span><br><span class="line">https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">https://github.com/containers/crun/releases/download/0.19/crun-0.19-linux-amd64</span><br><span class="line">https://github.com/coreos/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">https://github.com/kata-containers/runtime/releases/download/1.12.1/kata-static-1.12.1-x86_64.tar.xz</span><br><span class="line">https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.20.0/crictl-v1.20.0-linux-amd64.tar.gz</span><br><span class="line">https://github.com/kubernetes-sigs/krew/releases/download/v0.4.1/krew.tar.gz</span><br><span class="line">https://github.com/projectcalico/calico/archive/v3.17.4.tar.gz</span><br><span class="line">https://github.com/projectcalico/calicoctl/releases/download/v3.17.4/calicoctl-linux-amd64</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubeadm</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubectl</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubelet</span><br></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡ wget è¿›è¡Œä¸‹è½½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -x -P temp/files -i temp/files.list</span><br></pre></td></tr></table></figure><ul><li>ä¸‹è½½åçš„æ–‡ä»¶å¦‚ä¸‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"> tree temp/files</span><br><span class="line">temp/files</span><br><span class="line">â”œâ”€â”€ get.helm.sh</span><br><span class="line">â”‚Â Â  â””â”€â”€ helm-v3.5.4-linux-amd64.tar.gz</span><br><span class="line">â”œâ”€â”€ github.com</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containerd</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ nerdctl</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.8.0</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ nerdctl-0.8.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containernetworking</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ plugins</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.9.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containers</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ crun</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ 0.19</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ crun-0.19-linux-amd64</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ coreos</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ etcd</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v3.4.13</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kata-containers</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ runtime</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ 1.12.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ kata-static-1.12.1-x86_64.tar.xz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kubernetes-sigs</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cri-tools</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â          â””â”€â”€ v1.20.0</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â              â””â”€â”€ crictl-v1.20.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ krew</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.4.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ krew.tar.gz</span><br><span class="line">â”‚Â Â  â””â”€â”€ projectcalico</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ calico</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ archive</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ v3.17.4.tar.gz</span><br><span class="line">â”‚Â Â      â””â”€â”€ calicoctl</span><br><span class="line">â”‚Â Â          â””â”€â”€ releases</span><br><span class="line">â”‚Â Â              â””â”€â”€ download</span><br><span class="line">â”‚Â Â                  â””â”€â”€ v3.17.4</span><br><span class="line">â”‚Â Â                      â””â”€â”€ calicoctl-linux-amd64</span><br><span class="line">â””â”€â”€ storage.googleapis.com</span><br><span class="line">    â””â”€â”€ kubernetes-release</span><br><span class="line">        â””â”€â”€ release</span><br><span class="line">            â””â”€â”€ v1.20.6</span><br><span class="line">                â””â”€â”€ bin</span><br><span class="line">                    â””â”€â”€ linux</span><br><span class="line">                        â””â”€â”€ amd64</span><br><span class="line">                            â”œâ”€â”€ kubeadm</span><br><span class="line">                            â”œâ”€â”€ kubectl</span><br><span class="line">                            â””â”€â”€ kubelet</span><br></pre></td></tr></table></figure><p>ä¿æŒè¿™ä¸ªç›®å½•ç»“æ„ä¸å˜ï¼ŒæŠŠå®ƒä»¬ä¸Šä¼ åˆ°è‡ªå·±çš„æ–‡ä»¶æœåŠ¡å™¨ä¸Šï¼Œç„¶åå†ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶çš„ä¸‹è½½å‚æ•°ï¼Œåªéœ€è¦åœ¨å‰é¢åŠ ä¸Šæ–‡ä»¶æœåŠ¡å™¨çš„ URL å³å¯ï¼Œæ¯”å¦‚æˆ‘çš„é…ç½®ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download URLs</span></span><br><span class="line"><span class="attr">download_url:</span> <span class="string">"https://dl.k8s.li"</span></span><br><span class="line"><span class="attr">kubelet_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubelet"</span></span><br><span class="line"><span class="attr">kubectl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubectl"</span></span><br><span class="line"><span class="attr">kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kubeadm_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubeadm"</span></span><br><span class="line"><span class="attr">etcd_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/coreos/etcd/releases/download/<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>/etcd-<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">cni_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containernetworking/plugins/releases/download/<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>/cni-plugins-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>-<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>.tgz"</span></span><br><span class="line"><span class="attr">calicoctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calicoctl/releases/download/<span class="template-variable">&#123;&#123; calico_ctl_version &#125;&#125;</span>/calicoctl-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_crds_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calico/archive/<span class="template-variable">&#123;&#123; calico_version &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crictl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kubernetes-sigs/cri-tools/releases/download/<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>/crictl-<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">helm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/get.helm.sh/helm-<span class="template-variable">&#123;&#123; helm_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crun_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containers/crun/releases/download/<span class="template-variable">&#123;&#123; crun_version &#125;&#125;</span>/crun-<span class="template-variable">&#123;&#123; crun_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kata_containers_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kata-containers/runtime/releases/download/<span class="template-variable">&#123;&#123; kata_containers_version &#125;&#125;</span>/kata-static-<span class="template-variable">&#123;&#123; kata_containers_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_architecture &#125;&#125;</span>.tar.xz"</span></span><br><span class="line"><span class="attr">nerdctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containerd/nerdctl/releases/download/v<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>/nerdctl-<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br></pre></td></tr></table></figure><ul><li>images.list æ˜¯ kubespray æ‰€æœ‰å¯èƒ½ä¼šç”¨åˆ°çš„é•œåƒï¼Œå¦‚ä¸‹ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat temp/images.list</span></span><br><span class="line">docker.io/amazon/aws-alb-ingress-controller:v1.1.9</span><br><span class="line">docker.io/amazon/aws-ebs-csi-driver:v0.5.0</span><br><span class="line">docker.io/cloudnativelabs/kube-router:v1.2.2</span><br><span class="line">docker.io/integratedcloudnative/ovn4nfv-k8s-plugin:v1.1.0</span><br><span class="line">docker.io/k8scloudprovider/cinder-csi-plugin:v1.20.0</span><br><span class="line">docker.io/kubeovn/kube-ovn:v1.6.2</span><br><span class="line">docker.io/kubernetesui/dashboard-amd64:v2.2.0</span><br><span class="line">docker.io/kubernetesui/metrics-scraper:v1.0.6</span><br><span class="line">docker.io/library/haproxy:2.3</span><br><span class="line">docker.io/library/nginx:1.19</span><br><span class="line">docker.io/library/registry:2.7.1</span><br><span class="line">docker.io/nfvpe/multus:v3.7</span><br><span class="line">docker.io/rancher/<span class="built_in">local</span>-path-provisioner:v0.0.19</span><br><span class="line">docker.io/weaveworks/weave-kube:2.8.1</span><br><span class="line">docker.io/weaveworks/weave-npc:2.8.1</span><br><span class="line">docker.io/xueshanf/install-socat:latest</span><br><span class="line">k8s.gcr.io/addon-resizer:1.8.11</span><br><span class="line">k8s.gcr.io/coredns:1.7.0</span><br><span class="line">k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64:1.8.3</span><br><span class="line">k8s.gcr.io/dns/k8s-dns-node-cache:1.17.1</span><br><span class="line">k8s.gcr.io/ingress-nginx/controller:v0.43.0</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-registry-proxy:0.4</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.20.6</span><br><span class="line">k8s.gcr.io/metrics-server/metrics-server:v0.4.2</span><br><span class="line">k8s.gcr.io/pause:3.3</span><br><span class="line">quay.io/calico/cni:v3.17.4</span><br><span class="line">quay.io/calico/kube-controllers:v3.17.4</span><br><span class="line">quay.io/calico/node:v3.17.4</span><br><span class="line">quay.io/calico/typha:v3.17.4</span><br><span class="line">quay.io/cilium/cilium-init:2019-04-05</span><br><span class="line">quay.io/cilium/cilium:v1.8.9</span><br><span class="line">quay.io/cilium/operator:v1.8.9</span><br><span class="line">quay.io/coreos/etcd:v3.4.13</span><br><span class="line">quay.io/coreos/flannel:v0.13.0-amd64</span><br><span class="line">quay.io/datawire/ambassador-operator:v1.2.9</span><br><span class="line">quay.io/external_storage/cephfs-provisioner:v2.1.0-k8s1.11</span><br><span class="line">quay.io/external_storage/<span class="built_in">local</span>-volume-provisioner:v2.3.4</span><br><span class="line">quay.io/external_storage/rbd-provisioner:v2.1.1-k8s1.11</span><br><span class="line">quay.io/jetstack/cert-manager-cainjector:v1.0.4</span><br><span class="line">quay.io/jetstack/cert-manager-controller:v1.0.4</span><br><span class="line">quay.io/jetstack/cert-manager-webhook:v1.0.4</span><br><span class="line">quay.io/k8scsi/csi-attacher:v2.2.0</span><br><span class="line">quay.io/k8scsi/csi-node-driver-registrar:v1.3.0</span><br><span class="line">quay.io/k8scsi/csi-provisioner:v1.6.0</span><br><span class="line">quay.io/k8scsi/csi-resizer:v0.5.0</span><br><span class="line">quay.io/k8scsi/csi-snapshotter:v2.1.1</span><br><span class="line">quay.io/k8scsi/snapshot-controller:v2.0.1</span><br><span class="line">quay.io/l23network/k8s-netchecker-agent:v1.0</span><br><span class="line">quay.io/l23network/k8s-netchecker-server:v1.0</span><br></pre></td></tr></table></figure><p>å¯ä½¿ç”¨ skopeo å°†é•œåƒåŒæ­¥åˆ°è‡ªå·±çš„ registry ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> $(cat temp/images.list); <span class="keyword">do</span> skopeo copy docker://<span class="variable">$&#123;image&#125;</span> docker://hub.k8s.li/<span class="variable">$&#123;image#*/&#125;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><blockquote><p>å½“æ—¶å†™è¿™ä¸ªè„šæœ¬çš„æ—¶å€™ä¸€å †è›‡çš® sed æ›¿æ¢æ“ä½œå†™å¾—æƒ³ ğŸ¤®ï¼Œæ¯”å¦‚æœ‰äº›å˜é‡ä¼šæœ‰ ansible çš„ if else åˆ¤æ–­ï¼Œè¿™å°±æ„å‘³ç€ä¹Ÿè¦ç”¨ shell å»å®ç°å®ƒçš„åˆ¤æ–­é€»è¾‘ã€‚æ¯”å¦‚ä½¿ç”¨ shell å¤„ç†çš„æ—¶å€™éœ€è¦å°†è¿™ä¸‹é¢å¨è½¬æ¢æˆ shell çš„ if elseï¼Œè€Œä¸”è¿˜ä¸èƒ½æ¢è¡Œï¼š</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">coredns_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span><span class="template-variable">&#123;&#123;'/coredns/coredns' if (coredns_image_is_namespaced | bool) else '/coredns' &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">coredns_image_tag:</span> <span class="string">"<span class="template-variable">&#123;&#123; coredns_version if (coredns_image_is_namespaced | bool) else (coredns_version | regex_replace('^v', '')) &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># special handling for https://github.com/kubernetes-sigs/kubespray/pull/7570</span></span><br><span class="line">sed -i <span class="string">'s#^coredns_image_repo=.*#coredns_image_repo=$&#123;kube_image_repo&#125;$(if printf "%s\\n%s\\n" v1.21 $&#123;kube_version%.*&#125; | sort --check=quiet --version-sort; then echo -n /coredns/coredns;else echo -n /coredns; fi)#'</span> <span class="variable">$&#123;TEMP_DIR&#125;</span>/generate.sh</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'s#^coredns_image_tag=.*#coredns_image_tag=$(if printf "%s\\n%s\\n" v1.21 $&#123;kube_version%.*&#125; | sort --check=quiet --version-sort; then echo -n $&#123;coredns_version&#125;;else echo -n $&#123;coredns_version/v/&#125;; fi)#'</span> <span class="variable">$&#123;TEMP_DIR&#125;</span>/generate.sh</span><br></pre></td></tr></table></figure><p>å½“æ—¶è¿˜å­¦ä¼šäº†ä¸€æ‰‹ï¼Œåœ¨ shell ä¸­ä½¿ç”¨ <code>printf &quot;%s\\n%s\\n&quot; $v1 $v2 | sort --check=quiet --version-sort</code> è¿™ç§æ–¹å¼å¯ä»¥åˆ¤æ–­ä¸¤ä¸ªç‰ˆæœ¬å·çš„å¤§å°ï¼Œè€Œä¸”æ˜¯æœ€ç®€å•ä¾¿æ·çš„ã€‚</p><h2 id="é•œåƒä»“åº“"><a href="#é•œåƒä»“åº“" class="headerlink" title="é•œåƒä»“åº“"></a>é•œåƒä»“åº“</h2><p>ä¹‹å‰æåˆ°çš„æ˜¯æ ¹æ®é•œåƒåˆ—è¡¨å°†éœ€è¦çš„é•œåƒåŒæ­¥åˆ°è‡ªå·±çš„ registry ä¸­ï¼Œä½†å¯¹äºæœ¬åœ°å¼€å‘æµ‹è¯•æ¥è®²ï¼Œè¿™ç§æ‰‹åŠ¨å¯¼å…¥æ¯”è¾ƒè´¹äº‹è´¹åŠ›ã€‚åœ¨çœ‹äº†å¤§ä½¬å†™çš„ <a href="https://fuckcloudnative.io/posts/docker-registry-proxy/" target="_blank" rel="noopener">Docker é•œåƒåŠ é€Ÿæ•™ç¨‹</a> å’Œ <a href="https://www.chenshaowen.com/blog/how-to-run-a-private-registry-mirror.html" target="_blank" rel="noopener">å¦‚ä½•æ­å»ºä¸€ä¸ªç§æœ‰çš„é•œåƒä»“åº“ mirror</a>  å°±æƒ³åˆ°äº†å¯ä»¥ä½¿ç”¨ docker registry çš„ proxy ç‰¹æ€§æ¥éƒ¨ç½²å‡ ä¸ª kubespray éœ€è¦çš„é•œåƒä»“åº“ã€‚å¦‚ä¸‹</p><table><thead><tr><th>origin</th><th>mirror</th></tr></thead><tbody><tr><td>docker.io</td><td>hub.k8s.li</td></tr><tr><td>k8s.gcr.io</td><td>gcr.k8s.li</td></tr><tr><td>quay.io</td><td>quay.k8s.li</td></tr></tbody></table><ul><li>config.yml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">0.1</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">registry</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">blobdescriptor:</span> <span class="string">inmemory</span></span><br><span class="line">  <span class="attr">oss:</span></span><br><span class="line">    <span class="attr">accesskeyid:</span> <span class="string">xxxx</span> <span class="comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeyid</span></span><br><span class="line">    <span class="attr">accesskeysecret:</span> <span class="string">xxxx</span> <span class="comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeysecret</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">oss-cn-beijing</span> <span class="comment"># é…ç½® OSS bucket çš„åŒºåŸŸï¼Œæ¯”å¦‚ oss-cn-beijing</span></span><br><span class="line">    <span class="attr">internal:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">bucket:</span> <span class="string">fileserver</span> <span class="comment"># é…ç½®å­˜å‚¨ bucket çš„åç§°</span></span><br><span class="line">    <span class="attr">rootdirectory:</span> <span class="string">/kubespray/registry</span> <span class="comment"># é…ç½®è·¯å¾„</span></span><br><span class="line">  <span class="attr">delete:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">headers:</span></span><br><span class="line">    <span class="attr">X-Content-Type-Options:</span> <span class="string">[nosniff]</span></span><br><span class="line"><span class="attr">health:</span></span><br><span class="line">  <span class="attr">storagedriver:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><ul><li>docker-compose.yml</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">gcr-registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gcr-registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.yml:/etc/docker/registry/config.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5001:5001</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_HTTP_ADDR=0.0.0.0:5001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_PROXY_REMOTEURL=https://k8s.gcr.io</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">hub-registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">hub-registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.yml:/etc/docker/registry/config.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5002:5002</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_HTTP_ADDR=0.0.0.0:5002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_PROXY_REMOTEURL=https://docker.io</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">quay-registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">quay-registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.yml:/etc/docker/registry/config.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5003:5003</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_HTTP_ADDR=0.0.0.0:5003</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_PROXY_REMOTEURL=https://quay.io</span></span><br></pre></td></tr></table></figure><ul><li>nginx.conf</li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  gcr.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> domain.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> domain.key;</span><br><span class="line">    <span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">100000m</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET|HEAD)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   http://localhost:5001;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  hub.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> domain.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> domain.key;</span><br><span class="line">    <span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">100000m</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET|HEAD)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   http://localhost:5002;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  quay.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> domain.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> domain.key;</span><br><span class="line">    <span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">100000m</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET|HEAD)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   http://localhost:5003;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›¸å…³é…ç½®æ–‡ä»¶åœ¨ <a href="https://github.com/muzi502/registry-mirrors" target="_blank" rel="noopener">registry-mirrors</a> è¿™ä¸ª repo ä¸­ã€‚</p><h2 id="ä¼˜åŒ–-kubespray-é•œåƒå¤§å°"><a href="#ä¼˜åŒ–-kubespray-é•œåƒå¤§å°" class="headerlink" title="ä¼˜åŒ– kubespray é•œåƒå¤§å°"></a>ä¼˜åŒ– kubespray é•œåƒå¤§å°</h2><p>kubespray v1.25.1 ç‰ˆæœ¬å®˜æ–¹æ„å»ºçš„é•œåƒå¤§å°ä¸º <code>1.41GB</code>ï¼Œå¯¹äºä¸€äº›åœºæ™¯ä¸‹å¸Œæœ›é•œåƒå°ä¸€äº›ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•æ„å»ºä¸€ä¸ªä½“ç§¯è¾ƒå°çš„é•œåƒã€‚</p><ul><li>é¦–å…ˆæ„å»ºä¸€ä¸ª base é•œåƒï¼Œå¯¹äºä¸ç»å¸¸å˜åŠ¨çš„æˆ‘ä»¬æŠŠå®ƒå°è£…åœ¨ä¸€ä¸ª base é•œåƒé‡Œï¼Œåªæœ‰å½“ç›¸å…³ä¾èµ–æ›´æ–°äº†æ‰éœ€è¦é‡æ–°æ„å»ºè¿™ä¸ª base é•œåƒï¼Œ<code>Dockerfile.base</code> å¦‚ä¸‹ï¼š</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.6</span>-slim</span><br><span class="line"><span class="keyword">ENV</span> KUBE_VERSION v1.<span class="number">20.6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update -y \</span></span><br><span class="line"><span class="bash"> &amp;&amp; apt install -y \</span></span><br><span class="line"><span class="bash"> libssl-dev sshpass apt-transport-https jq moreutils vim moreutils iputils-ping \</span></span><br><span class="line"><span class="bash"> ca-certificates curl gnupg2 software-properties-common rsync wget tcpdump \</span></span><br><span class="line"><span class="bash"> &amp;&amp; rm -rf /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="bash"> &amp;&amp; wget -q https://dl.k8s.io/<span class="variable">$KUBE_VERSION</span>/bin/linux/amd64/kubectl -O /usr/<span class="built_in">local</span>/bin/kubectl \</span></span><br><span class="line"><span class="bash"> &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/kubectl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /kubespray</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> python3 -m pip install -r requirements.txt</span></span><br></pre></td></tr></table></figure><p>æ„å»º kubespray é•œåƒï¼šFROM çš„ base é•œåƒå°±ä½¿ç”¨æˆ‘ä»¬åˆšåˆšæ„å»ºå¥½çš„é•œåƒï¼Œå¯¹äº kubespray æ¥è®²ï¼Œç›¸å…³ä¾èµ–å·²ç»åœ¨ base é•œåƒä¸­å®‰è£…å¥½äº†ï¼Œè¿™é‡Œæ„å»ºçš„æ—¶å€™åªéœ€è¦æŠŠ repo å¤åˆ¶åˆ° /kubespray ç›®å½•ä¸‹å³å¯ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> kubespray:v2.<span class="number">16.0</span>-base-kube-v1.<span class="number">20.6</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . /kubespray</span></span><br></pre></td></tr></table></figure><p>è¿™æ ·æ„å»ºå‡ºæ¥çš„é•œåƒå¤§å°ä¸åˆ° 600MBï¼Œæ¯”ä¹‹å‰å°äº†å¾ˆå¤šï¼Œè€Œä¸”æ¯æ¬¡æ„å»ºé•œåƒçš„æ—¶å€™ä¹Ÿæ¯”è¾ƒå¿«ã€‚åªä¸è¿‡å½“ <code>requirements.txt</code>  æ–‡ä»¶æ›´æ–°åéœ€è¦é‡æ–°æ„å»º base é•œåƒï¼Œå¹¶ä¿®æ”¹ kubespray çš„ FROM é•œåƒä¸ºæ–°çš„ base é•œåƒã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubespray     v2.15.1                  73294562105a    1.41GB</span><br><span class="line">kubespray     v2.16-kube-v1.20.6-1.0   80b735995e48    579MB</span><br></pre></td></tr></table></figure><ul><li>kubespray é»˜è®¤æ²¡æœ‰åŠ å¦‚ <code>.dockerignore</code>ï¼Œè¿™å°±æ„å‘³ç€æ„å»ºé•œåƒçš„æ—¶å€™ä¼šæŠŠå½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹å¤åˆ¶åˆ°é•œåƒé‡Œï¼Œä¼šå¯¼è‡´é•œåƒå·¥ä½œç›®å½•ä¸‹å¯èƒ½å¾ˆæ··ä¹±ï¼Œåœ¨å®¹å™¨é‡Œ debug çš„æ—¶å€™ä¸å¤ªç¾è§‚ï¼Œå¼ºè¿«ç—‡æ‚£è€…å¯ä»¥åœ¨ repo ä¸­åŠ å…¥å¦‚ä¸‹çš„ <code>.dockerignore</code> æ–‡ä»¶ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.ansible-lint</span><br><span class="line">.editorconfig</span><br><span class="line">.git</span><br><span class="line">.github</span><br><span class="line">.gitignore</span><br><span class="line">.gitlab-ci</span><br><span class="line">.gitlab-ci.yml</span><br><span class="line">.gitmodules</span><br><span class="line">.markdownlint.yaml</span><br><span class="line">.nojekyll</span><br><span class="line">CNAME</span><br><span class="line">CONTRIBUTING.md</span><br><span class="line">Dockerfile</span><br><span class="line">Makefile</span><br><span class="line">OWNERS</span><br><span class="line">README.md</span><br><span class="line">RELEASE.md</span><br><span class="line">SECURITY_CONTACTS</span><br><span class="line">build</span><br><span class="line">code-of-conduct.md</span><br><span class="line">docs</span><br><span class="line">index.html</span><br><span class="line">logo</span><br></pre></td></tr></table></figure><h2 id="docker-registry-ç¦æ­¢-push-é•œåƒ"><a href="#docker-registry-ç¦æ­¢-push-é•œåƒ" class="headerlink" title="docker registry ç¦æ­¢ push é•œåƒ"></a>docker registry ç¦æ­¢ push é•œåƒ</h2><p>é»˜è®¤ç›´æ¥ä½¿ç”¨ docker registry æ¥éƒ¨ç½²é•œåƒä»“åº“çš„è¯ï¼Œæ¯”å¦‚æˆ‘çš„ hub.k8s.li ï¼Œå› ä¸ºæ²¡æœ‰æƒé™é™åˆ¶ä¼šå¯¼è‡´ä»»ä½•å¯è®¿é—®è¯¥é•œåƒä»“åº“çš„å®¢æˆ·ç«¯å¯ä»¥ push é•œåƒï¼Œè¿™æœ‰ç‚¹ä¸å®‰å…¨ï¼Œéœ€è¦å®‰å…¨åŠ å›ºä¸€ä¸‹ã€‚å› ä¸º pull é•œåƒçš„æ—¶å€™å®¢æˆ·ç«¯èµ°çš„éƒ½æ˜¯ HTTP GET è¯·æ±‚ï¼Œå¯ä»¥é€šè¿‡ nginx ç¦æ­¢ POSTã€PUT è¿™ç§è¯·æ±‚æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥ç¦æ­¢ push é•œåƒã€‚åœ¨ nginx çš„server å­—æ®µä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·åœ¨ push é•œåƒçš„æ—¶å€™ä¼šè¿”å› 403 çš„é”™è¯¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root # docker pull hub.k8s.li/calico/node:v3.17.3</span><br><span class="line">v3.17.3: Pulling from calico/node</span><br><span class="line">282bf12aa8be: Pull complete</span><br><span class="line">4ac1bb9354ad: Pull complete</span><br><span class="line">Digest: sha256:3595a9a945a7ba346a12ee523fc7ae15ed35f1e6282b76bce7fec474d28d68bb</span><br><span class="line">Status: Downloaded newer image for hub.k8s.li/calico/node:v3.17.3</span><br><span class="line">root@debian:/root # docker push !$</span><br><span class="line">root@debian:/root # docker push hub.k8s.li/calico/node:v3.17.3</span><br><span class="line">The push refers to repository [hub.k8s.li/calico/node]</span><br><span class="line">bc19ae092bb4: Preparing</span><br><span class="line">94333d52d45d: Preparing</span><br><span class="line">error parsing HTTP 403 response body: invalid character '&lt;' looking for beginning of value: "&lt;html&gt;\r\n&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;\r\n&lt;body bgcolor=\"white\"&gt;\r\n&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;\r\n&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n"</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆéœ€è¦ push é•œåƒçš„æ—¶å€™æ€ä¹ˆåŠï¼Ÿ</p><p>docker registry å¯åŠ¨çš„æ—¶å€™ bind åœ¨ 127.0.0.1 ä¸Šï¼Œè€Œä¸æ˜¯ 0.0.0.0ï¼Œé€šè¿‡ localhost:5000 æ¥ push é•œåƒã€‚</p><h2 id="é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦"><a href="#é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦" class="headerlink" title="é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦"></a>é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦</h2><p>å¦‚æœé•œåƒä»“åº“ä½¿ç”¨çš„æ˜¯è‡ªç­¾è¯ä¹¦ï¼Œå¯ä»¥è·‘ä¸‹é¢è¿™ä¸ª playbook å°†è‡ªç­¾è¯ä¹¦æ·»åŠ åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ trusted CA dir ä¸­ï¼Œè¿™æ ·æ— éœ€é…ç½® <code>insecure-registries</code> ä¹Ÿèƒ½æ‹‰å–é•œåƒã€‚</p><p><code>add-registry-ca.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">target</span> <span class="string">ca-certificate</span> <span class="string">store</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">set_fact:</span></span><br><span class="line">        <span class="attr">ca_cert_path:</span> <span class="string">|-</span></span><br><span class="line">          <span class="string">&#123;%</span> <span class="string">if</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"Debian"</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/usr/local/share/ca-certificates/registry-ca.crt</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">elif</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"RedHat"</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/etc/pki/ca-trust/source/anchors/registry-ca.crt</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">elif</span> <span class="string">ansible_os_family</span> <span class="string">in</span> <span class="string">["Flatcar</span> <span class="string">Container</span> <span class="string">Linux</span> <span class="string">by</span> <span class="string">Kinvolk"]</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/etc/ssl/certs/registry-ca.pem</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">elif</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"Suse"</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/etc/pki/trust/anchors/registry-ca.pem</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">elif</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"ClearLinux"</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/usr/share/ca-certs/registry-ca.pem</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">endif</span> <span class="string">%&#125;</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">facts</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">add</span> <span class="string">CA</span> <span class="string">to</span> <span class="string">trusted</span> <span class="string">CA</span> <span class="string">dir</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_cert_path &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">&#123;&#123; ca_cert_path &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">registry_ca_cert</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">update</span> <span class="string">ca-certificates</span> <span class="string">(Debian/Ubuntu/SUSE/Flatcar)</span>  <span class="comment"># noqa 503</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">update-ca-certificates</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">registry_ca_cert.changed</span> <span class="string">and</span> <span class="string">ansible_os_family</span> <span class="string">in</span> <span class="string">["Debian",</span> <span class="string">"Flatcar Container Linux by Kinvolk"</span><span class="string">,</span> <span class="string">"Suse"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">update</span> <span class="string">ca-certificates</span> <span class="string">(RedHat)</span>  <span class="comment"># noqa 503</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">update-ca-trust</span> <span class="string">extract</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">registry_ca_cert.changed</span> <span class="string">and</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"RedHat"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">update</span> <span class="string">ca-certificates</span> <span class="string">(ClearLinux)</span>  <span class="comment"># noqa 503</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">clrtrust</span> <span class="string">add</span> <span class="string">"<span class="template-variable">&#123;&#123; ca_cert_path &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">registry_ca_cert.changed</span> <span class="string">and</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"ClearLinux"</span></span><br></pre></td></tr></table></figure><ul><li>å°†è‡ªç­¾çš„ registry è¯ä¹¦æ”¾åˆ°æœ¬åœ°ï¼Œæ‰§è¡Œ playbook å¹¶æŒ‡å®š <code>registry_cert_path</code> ä¸ºæ­£ç¡®çš„è·¯å¾„</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/kubespray# ansible-playbook -i deploy/inventory -e registry_cert_path=/kubespray/registry_ca.pem add-registry-ca.yml</span><br><span class="line"></span><br><span class="line">PLAY [all] **********************************************************************************</span><br><span class="line">Thursday 29 April 2021  08:18:25 +0000 (0:00:00.077)       0:00:00.077 ********</span><br><span class="line"></span><br><span class="line">TASK [Gen_certs | target ca-certificate store file] *****************************************</span><br><span class="line">ok: [kube-control-2]</span><br><span class="line">ok: [kube-control-3]</span><br><span class="line">ok: [kube-control-1]</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">Thursday 29 April 2021  08:18:25 +0000 (0:00:00.389)       0:00:00.467 ********</span><br><span class="line"></span><br><span class="line">TASK [Gen_certs | add CA to trusted CA dir] *************************************************</span><br><span class="line">changed: [kube-control-2]</span><br><span class="line">changed: [kube-control-3]</span><br><span class="line">changed: [kube-control-1]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">Thursday 29 April 2021  08:18:29 +0000 (0:00:04.433)       0:00:04.901 ********</span><br><span class="line">Thursday 29 April 2021  08:18:30 +0000 (0:00:00.358)       0:00:05.259 ********</span><br><span class="line"></span><br><span class="line">TASK [Gen_certs | update ca-certificates (RedHat)] ******************************************</span><br><span class="line">changed: [kube-control-1]</span><br><span class="line">changed: [kube-control-3]</span><br><span class="line">changed: [kube-control-2]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">Thursday 29 April 2021  08:18:33 +0000 (0:00:02.938)       0:00:08.197 ********</span><br><span class="line"></span><br><span class="line">PLAY RECAP **********************************************************************************</span><br><span class="line">kube-control-1             : ok=3    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0</span><br><span class="line">kube-control-2             : ok=3    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0</span><br><span class="line">kube-control-3             : ok=3    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0</span><br><span class="line">kube-node-1                : ok=3    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0</span><br><span class="line"></span><br><span class="line">Thursday 29 April 2021  08:18:33 +0000 (0:00:00.355)  0:00:08.553 ********</span><br><span class="line">================================================================</span><br><span class="line">Gen_certs | add CA to trusted CA dir ------------------------------------------------------------- 4.43s</span><br><span class="line">Gen_certs | update ca-certificates (RedHat) ------------------------------------------------------------- 2.94s</span><br><span class="line">Gen_certs | target ca-certificate store file ------------------------------------------------------------- 0.39s</span><br><span class="line">Gen_certs | update ca-certificates (Debian/Ubuntu/SUSE/Flatcar) ------------------------------------------------------------- 0.36s</span><br><span class="line">Gen_certs | update ca-certificates (ClearLinux) -------------------------------------------------------------- 0.36s</span><br></pre></td></tr></table></figure><h2 id="containerd-æ— æ³•åŠ è½½-CNI-é…ç½®å¯¼è‡´èŠ‚ç‚¹-NotReady"><a href="#containerd-æ— æ³•åŠ è½½-CNI-é…ç½®å¯¼è‡´èŠ‚ç‚¹-NotReady" class="headerlink" title="containerd æ— æ³•åŠ è½½ CNI é…ç½®å¯¼è‡´èŠ‚ç‚¹ NotReady"></a>containerd æ— æ³•åŠ è½½ CNI é…ç½®å¯¼è‡´èŠ‚ç‚¹ NotReady</h2><p>å¶ç°é—®é¢˜ï¼Œé‡å¯ä¸€ä¸‹ containerd å°±å¯ä»¥äº†ï¼Œå…·ä½“åŸå› è¿˜æ²¡æ’æŸ¥å‡ºæ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/kubespray<span class="comment"># ansible all -i deploy/inventory -m service -a "name=containerd state=restarted"</span></span><br></pre></td></tr></table></figure><h2 id="ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦"><a href="#ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦" class="headerlink" title="ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦"></a>ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦</h2><p>Kubespray éƒ¨ç½²çš„æ—¶å€™æœ‰ä¸ª task ä¸“é—¨ç”¨æ¥ä¸‹è½½éƒ¨ç½²éœ€è¦çš„é•œåƒï¼Œç”±äºæ˜¯æ“ä½œçš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¼šå°†ä¸€äº›ä¸éœ€è¦çš„é•œåƒæ‹‰å–åˆ°è¯¥èŠ‚ç‚¹ä¸Šã€‚æ¯”å¦‚ kube-apiserverã€kube-controller-managerã€kube-scheduler è¿™äº›åœ¨ node èŠ‚ç‚¹ä¸Šä¸ä¼šç”¨åˆ°çš„é•œåƒä¹Ÿä¼šåœ¨ node èŠ‚ç‚¹ä¸Šæ‹‰å–ï¼Œè¿™æ ·ä¼šå¯¼è‡´ download çš„ task æ¯”è¾ƒè€—æ—¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">TASK [download : set_container_facts | Display the name of the image being processed] ********************************************************************************************</span><br><span class="line">ok: [kube-control-3] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-controller-manager"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-control-2] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-controller-manager"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-control-1] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-controller-manager"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-node-1] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-controller-manager"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ok: [kube-control-3] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-scheduler"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-control-2] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-scheduler"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-control-1] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-scheduler"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-node-1] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-scheduler"</span></span><br></pre></td></tr></table></figure><p>å¯ç”¨é€šè¿‡ <code>download_container: false</code> è¿™ä¸ªå‚æ•°æ¥ç¦ç”¨ download container è¿™ä¸ª taskï¼Œè¿™æ ·åœ¨ pod å¯åŠ¨çš„æ—¶å€™åªæ‹‰å–éœ€è¦çš„é•œåƒï¼Œå¯ä»¥èŠ‚çœä¸€äº›éƒ¨ç½²è€—æ—¶ã€‚</p><h2 id="å¯ç”¨æ’ä»¶"><a href="#å¯ç”¨æ’ä»¶" class="headerlink" title="å¯ç”¨æ’ä»¶"></a>å¯ç”¨æ’ä»¶</h2><p>Kubespray å®˜æ–¹æ”¯æŒçš„æ’ä»¶åˆ—è¡¨å¦‚ä¸‹ï¼Œé»˜è®¤æ˜¯ false ç¦ç”¨äº†æ’ä»¶ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kubernetes dashboard</span></span><br><span class="line"><span class="comment"># RBAC required. see docs/getting-started.md for access details.</span></span><br><span class="line"><span class="attr">dashboard_enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Addons which can be enabled</span></span><br><span class="line"><span class="attr">helm_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">krew_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">registry_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">metrics_server_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">enable_network_policy:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">local_path_provisioner_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">local_volume_provisioner_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">local_volume_provisioner_directory_mode:</span> <span class="number">0700</span></span><br><span class="line"><span class="attr">cinder_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">aws_ebs_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">azure_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">gcp_pd_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">vsphere_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">persistent_volumes_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">cephfs_provisioner_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">rbd_provisioner_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">ingress_nginx_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">ingress_ambassador_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">ingress_alb_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">cert_manager_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">expand_persistent_volumes:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">metallb_enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># containerd official CLI tool</span></span><br><span class="line"><span class="attr">nerdctl_enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>åœ¨éƒ¨ç½²çš„æ—¶å€™å¦‚æœæƒ³å¯åŠ¨æŸäº›æ’ä»¶å¯ä»¥åœ¨è‡ªå·±æœ¬åœ°å¯¹åº”çš„ inventory ç›®å½•ä¸‹çš„ <code>group_vars/k8s_cluster/addons.yml</code> æ–‡ä»¶ä¸­é€‰æ‹©å¼€å¯ç›¸åº”çš„æ’ä»¶ï¼Œæ¯”å¦‚ <code>inventory/sample/group_vars/k8s_cluster/addons.yml</code>ã€‚</p><h2 id="åˆ†å±‚éƒ¨ç½²"><a href="#åˆ†å±‚éƒ¨ç½²" class="headerlink" title="åˆ†å±‚éƒ¨ç½²"></a>åˆ†å±‚éƒ¨ç½²</h2><p>è¿™ä¸ªæ˜¯æˆ‘ä»¬å¯¹ kubespray äºŒå¼€çš„ä¸€ä¸ªä¼˜åŒ–é¡¹ã€‚kubespray åœ¨éƒ¨ç½²é›†ç¾¤çš„æ—¶å€™è¿è¡Œçš„ playbook æ˜¯ <code>cluster.yml</code>ï¼Œåœ¨é›†ç¾¤éƒ¨ç½²çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå› ä¸ºä½ ä¸€äº›ä¸ç¨³å®šå› ç´ å¯¼è‡´é›†ç¾¤éƒ¨ç½²å¤±è´¥ï¼Œå¤±è´¥åå†æ¬¡å°è¯•éƒ¨ç½²çš„è¯ï¼Œkubespray ä¼šä»å¤´å¼€å§‹å†è·‘ä¸€éå·²ç»æˆåŠŸè¿è¡Œçš„ taskï¼Œè¿™æ ·çš„æ•ˆç‡ä¼šæ¯”è¾ƒä½ã€‚å› æ­¤éœ€è¦ä½¿ç”¨æŸç§æ–¹æ³•è®°å½•ä¸€ä¸‹å·²ç»æˆåŠŸæ‰§è¡Œçš„ task æˆ– rolesï¼Œå¤±è´¥åé‡æ–°éƒ¨ç½²çš„æ—¶å€™å°±è·³è¿‡è¿™äº›å·²ç»æˆåŠŸè¿è¡Œçš„ taskï¼Œç„¶åä»ä¸Šæ¬¡å¤±è´¥çš„åœ°æ–¹å¼€å§‹è¿è¡Œã€‚</p><p>å¤§ä½“çš„æ€è·¯æ˜¯æ ¹æ® <code>cluster.yml</code> ä¸­çš„ roles æ‹†åˆ†ä¸ºä¸åŒçš„å±‚å³ layerï¼Œå¦‚ bootstrap-osã€downloadã€kubernetesã€networkã€apps ï¼Œåœ¨éƒ¨ç½²çš„è¿‡ç¨‹ä¸­æ¯è¿è¡Œå®Œä¸€ä¸ª layer å°±å°†å®ƒè®°å½•åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œéƒ¨ç½²çš„æ—¶å€™ä¼šæ ¹æ®è¿™ä¸ªæ–‡ä»¶æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦éƒ¨ç½²ï¼Œå¦‚æœæ–‡ä»¶ä¸­è®°å½•å­˜åœ¨çš„è¯å°±è¯´æ˜å·²ç»æˆåŠŸéƒ¨ç½²å®Œæˆäº†ï¼Œå°±è·³è¿‡å®ƒï¼Œç»§ç»­æ‰§è¡Œæœªæ‰§è¡Œçš„ layerã€‚</p><p>è‡³äºæ‹†åˆ†çš„æ–¹å¼å¤§æ¦‚æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ ¹æ® tag ã€ä¸€ç§æ˜¯å°† <code>cluster.yml</code> æ–‡ä»¶æ‹†åˆ†æˆè‹¥å¹²ä¸ª playbook æ–‡ä»¶ã€‚é€šè¿‡ tag çš„æ–¹å¼å¯èƒ½ä¼šæ¯”è¾ƒå¤æ‚ä¸€äº›ï¼Œåœ¨è¿™é‡Œè¿˜æ˜¯é€‰æ‹©æ‹†åˆ†çš„æ–¹å¼ã€‚æ‹†åˆ†çš„ç²’åº¦æœ‰å¤§æœ‰å°ï¼Œä»¥ä¸‹æ˜¯æˆ‘è®¤ä¸ºæ¯”è¾ƒåˆç†çš„æ‹†å°æ–¹å¼ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">playbooks</span><br><span class="line">â”œâ”€â”€ 00-default-ssh-config.yml <span class="comment"># é»˜è®¤éœ€è¦è¿è¡Œçš„ playbookï¼Œç”¨äºé…ç½®å ¡å’æœºå’Œé…ç½® ssh è®¤è¯</span></span><br><span class="line">â”œâ”€â”€ 01-cluster-bootstrap-os.yml <span class="comment"># åˆå§‹åŒ–é›†ç¾¤èŠ‚ç‚¹ OSï¼Œå®‰è£…å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸‹è½½éƒ¨ç½²ä¾èµ–çš„æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ 02-cluster-etcd.yml <span class="comment"># éƒ¨ç½² etcd é›†ç¾¤</span></span><br><span class="line">â”œâ”€â”€ 03-cluster-kubernetes.yml <span class="comment"># éƒ¨ç½² kubernetes é›†ç¾¤</span></span><br><span class="line">â”œâ”€â”€ 04-cluster-network.yml <span class="comment"># éƒ¨ç½²ç½‘ç»œæ’ä»¶</span></span><br><span class="line">â”œâ”€â”€ 05-cluster-apps.yml <span class="comment"># éƒ¨ç½²ä¸€äº› addons ç»„ä»¶ï¼Œå¦‚ coredns ç­‰</span></span><br><span class="line">â”œâ”€â”€ 06-cluster-self-host.yml <span class="comment"># å¹³å° self-host è‡ªæ‰˜ç®¡çš„éƒ¨åˆ†</span></span><br><span class="line">â””â”€â”€ 11-reset-reset.yml <span class="comment"># ç§»é™¤é›†ç¾¤</span></span><br></pre></td></tr></table></figure><ul><li>00-default-ssh-config.yml</li></ul><p>è¯¥ playbook ç”¨äºé…ç½®å ¡å’æœºå’Œ ssh è®¤è¯ï¼Œkubespray éœ€è¦ä½¿ç”¨  public key çš„æ–¹å¼ ssh è¿æ¥åˆ°éƒ¨ç½²èŠ‚ç‚¹ï¼Œå¦‚æœéƒ¨ç½²èŠ‚ç‚¹æ²¡æœ‰é…ç½® ssh public key çš„æ–¹å¼ï¼Œå¯ä»¥æŒ‡å®š <code>ssh_cert_path</code> è¿™ä¸ªå˜é‡çš„è·¯å¾„ï¼Œå°†å…¬é’¥æ·»åŠ åˆ°ä¸»æœºçš„ authorized_key ä¸­ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">bastion[0]</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">bastion-ssh-config,</span> <span class="attr">tags:</span> <span class="string">["localhost",</span> <span class="string">"bastion"</span><span class="string">]</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster:etcd</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setting</span> <span class="string">up</span> <span class="string">ssh</span> <span class="string">public</span> <span class="string">key</span> <span class="string">authentication</span></span><br><span class="line">      <span class="attr">authorized_key:</span> <span class="string">"user=<span class="template-variable">&#123;&#123; ansible_user &#125;&#125;</span> key=<span class="template-variable">&#123;&#123; lookup('file', '&#123;&#123; ssh_cert_path &#125;&#125;</span>') &#125;&#125;"</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ssh_cert_path</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">ssh-config</span></span><br></pre></td></tr></table></figure><ul><li>01-cluster-bootstrap-os.yml</li></ul><p>è¿™ä¸ª playbook ç”¨äºåˆå§‹åŒ–éƒ¨ç½²èŠ‚ç‚¹ OSã€å®‰è£…ä¸€äº›ä¾èµ–çš„ rpm/deb åŒ…ã€å®‰è£…å®¹å™¨è¿è¡Œæ—¶ã€ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ç­‰</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster:etcd</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">linear</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">bootstrap-os,</span> <span class="attr">tags:</span> <span class="string">bootstrap-os&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster:etcd</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/preinstall,</span> <span class="attr">tags:</span> <span class="string">preinstall</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">"container-engine"</span><span class="string">,</span> <span class="attr">tags:</span> <span class="string">"container-engine"</span><span class="string">,</span> <span class="attr">when:</span> <span class="string">deploy_container_engine|default(true)</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">download,</span> <span class="attr">tags:</span> <span class="string">download,</span> <span class="attr">when:</span> <span class="string">"not skip_downloads"</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>02-cluster-etcd.yml</li></ul><p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½² etcd é›†ç¾¤å’Œåˆ†å‘ etcd é›†ç¾¤çš„è¯ä¹¦åˆ°é›†ç¾¤èŠ‚ç‚¹ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">etcd</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">etcd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">etcd</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">etcd_cluster_setup:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">etcd_events_cluster_setup:</span> <span class="string">"<span class="template-variable">&#123;&#123; etcd_events_cluster_enabled &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">not</span> <span class="string">etcd_kubeadm_enabled|</span> <span class="string">default(false)</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">etcd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">etcd</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">etcd_cluster_setup:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">etcd_events_cluster_setup:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">not</span> <span class="string">etcd_kubeadm_enabled|</span> <span class="string">default(false)</span></span><br></pre></td></tr></table></figure><ul><li>03-cluster-kubernetes.yml</li></ul><p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½² kubernetes é›†ç¾¤ï¼Œè™½ç„¶è¿™é‡Œçš„ roles å¾ˆå¤šï¼Œä½†å¹¶æ²¡æœ‰åšè¿‡å¤šçš„æ‹†åˆ†ï¼Œä¸ªäººè¿˜æ˜¯è§‰ç€è¿™éƒ¨åˆ†å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/node,</span> <span class="attr">tags:</span> <span class="string">node</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/control-plane,</span> <span class="attr">tags:</span> <span class="string">master</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/client,</span> <span class="attr">tags:</span> <span class="string">client</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/cluster_roles,</span> <span class="attr">tags:</span> <span class="string">cluster-roles</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/kubeadm,</span> <span class="attr">tags:</span> <span class="string">kubeadm&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/node-label,</span> <span class="attr">tags:</span> <span class="string">node-label</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>04-cluster-network.yml</li></ul><p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½²ç½‘ç»œæ’ä»¶</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">network_plugin,</span> <span class="attr">tags:</span> <span class="string">network</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/network_plugin,</span> <span class="attr">tags:</span> <span class="string">network</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/policy_controller,</span> <span class="attr">tags:</span> <span class="string">policy-controller</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>05-cluster-apps.yml</li></ul><p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½²ä¸€äº› addons æ’ä»¶ï¼Œå¿…é¡» coredns, ingress-controllerï¼Œä»¥åŠä¸€äº›å¤–ç½®çš„ provisioner ç­‰ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/external_cloud_controller,</span> <span class="attr">tags:</span> <span class="string">external-cloud-controller</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/ingress_controller,</span> <span class="attr">tags:</span> <span class="string">ingress-controller</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/external_provisioner,</span> <span class="attr">tags:</span> <span class="string">external-provisioner</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps,</span> <span class="attr">tags:</span> <span class="string">apps</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>æ‹†åˆ†çš„æ—¶å€™å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µå»é™¤ä¸€äº›ä¸å¿…è¦çš„ rolesï¼Œæ¯”å¦‚ <code>calico_rr</code> , <code>win_nodes</code> ï¼Œæˆ‘ä»¬çš„äº§å“æœ¬èº«å°±ä¸æ”¯æŒ calico è·¯ç”±åå°„å™¨ã€ä¹Ÿä¸æ”¯æŒ windows èŠ‚ç‚¹ï¼Œå› æ­¤ç›´æ¥å°†è¿™ä¸¤éƒ¨åˆ†ç»™å»é™¤äº†ï¼Œè¿™æ ·ä¹Ÿèƒ½é¿å…å»æ‰§è¡Œè¿™äº› task çš„åˆ¤æ–­ï¼Œèƒ½èŠ‚çœä¸€å®šçš„æ—¶é—´ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">calico_rr</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">network_plugin/calico/rr,</span> <span class="attr">tags:</span> <span class="string">['network',</span> <span class="string">'calico_rr'</span><span class="string">]</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane[0]</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">win_nodes/kubernetes_patch,</span> <span class="attr">tags:</span> <span class="string">["master",</span> <span class="string">"win_nodes"</span><span class="string">]</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;kubespray v2.16
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubernetes" scheme="https://blog.k8s.li/tags/kubernetes/"/>
    
      <category term="kubespray" scheme="https://blog.k8s.li/tags/kubespray/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨ Kubespray æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤</title>
    <link href="https://blog.k8s.li/deploy-k8s-by-kubespray.html"/>
    <id>https://blog.k8s.li/deploy-k8s-by-kubespray.html</id>
    <published>2021-04-28T16:00:00.000Z</published>
    <updated>2021-04-28T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>å…¬å¸ PaaS å¹³å°åº•å±‚çš„ kubernetes é›†ç¾¤éƒ¨ç½²é‡‡ç”¨çš„å¼€æºçš„ kubesprayï¼Œæ­£å¥½æˆ‘åœ¨å‚ä¸ kubespray äºŒå¼€å·¥ä½œã€‚åœ¨è¿™æ®µæ—¶ä¸»è¦å®Œæˆäº† kubespray è‡ªåŠ¨åŒ–æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ã€ç§æœ‰åŒ–éƒ¨ç½²ã€å¢åŠ è‡ªç ” CNI éƒ¨ç½²ã€ä»¥åŠä¸€äº› bugfix ç­‰ã€‚æœ€è¿‘æŠ½ç©ºæ•´ç†å¹¶æ€»ç»“ä¸€ä¸‹ä½¿ç”¨ kubespray åœ¨æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤è¸©çš„ä¸€äº›å‘ã€‚</p><h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><p>åŠé€€ä¸‰è¿ğŸ˜‚ï¼š</p><ul><li>éœ€è¦ä¸€ä¸ªéƒ¨ç½²é•œåƒä»“åº“å’Œ nginx</li><li>éœ€è¦ä¸€ä¸ªåŸŸåï¼Œæœ€å¥½å·²ç»è®¾ç½®å¥½ DNS è§£æå’Œ SSL è¯ä¹¦</li><li>é›†ç¾¤èŠ‚ç‚¹éœ€è¦è‡³å°‘ä¸¤å°æœºå™¨ï¼Œå¹¶ä¸”å¯ä»¥è®¿é—®å¤–ç½‘</li></ul><p>è™½ç„¶æ‰‹å¤´é‡Œæœ‰ä¸€å¤§æ‰¹å¼€å‘æœºå™¨ï¼Œä½†ç”±äºæˆ‘çš„åŸŸå <code>k8s.li</code> æ¯”è¾ƒç‰¹æ®Šï¼Œå›½å†…å¾ˆéš¾è¿›è¡Œå¤‡æ¡ˆï¼ˆä¹Ÿä¸æƒ³å¤‡æ¡ˆï¼‰ï¼Œæ‰€ä»¥æ— æ³•å°† DNS è§£æåˆ°è¿™äº›å›½å†…çš„æœåŠ¡å™¨ä¸Šã€‚å› æ­¤æˆ‘æ‰“ç®—å°†åŸŸåè§£æåˆ°ä¸€å°å›½å¤–çš„æœåŠ¡å™¨ä¸Šï¼Œç„¶åå†ä½¿ç”¨ nginx rewrite é‡å†™å°†è¯·æ±‚è½¬å‘åˆ°é˜¿é‡Œäº‘çš„ OSS ï¼›å¦å¤– docker registry çš„åç«¯å­˜å‚¨ä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨é˜¿é‡Œäº‘ OSSï¼Œè¿™æ ·å®¢æˆ·ç«¯åœ¨æ‹‰å–é•œåƒçš„æ—¶å€™ï¼Œåªä¼šé€šè¿‡æˆ‘çš„åŸŸåè·å–é•œåƒçš„ manifest æ–‡ä»¶ï¼Œé•œåƒçš„ blobs æ•°æ®å°†ä¼šè½¬å‘åˆ°é˜¿é‡Œäº‘ OSSã€‚åœ¨é›†ç¾¤éƒ¨ç½²çš„æ—¶å€™ï¼Œä¸‹è½½æ–‡ä»¶å’Œé•œåƒæœ€ä¸»è¦çš„æµé‡éƒ½ä¼šé€šè¿‡é˜¿é‡Œäº‘ OSSï¼Œè¿™æ ·å¯ä»¥èŠ‚çœé›†ç¾¤éƒ¨ç½²è€—æ—¶ï¼Œæé«˜éƒ¨ç½²æ•ˆç‡ï¼ŒåŒæ—¶åˆèƒ½å‰©ä¸‹ä¸€ç¬”æœåŠ¡å™¨çš„æµé‡è´¹ç”¨ã€‚</p><h3 id="åŸŸå-SSL-è¯ä¹¦åˆ¶ä½œ"><a href="#åŸŸå-SSL-è¯ä¹¦åˆ¶ä½œ" class="headerlink" title="åŸŸå SSL è¯ä¹¦åˆ¶ä½œ"></a>åŸŸå SSL è¯ä¹¦åˆ¶ä½œ</h3><p>åŸŸå SSL è¯ä¹¦ä¸»è¦æ˜¯ç»™é•œåƒä»“åº“ä½¿ç”¨çš„ï¼Œå‡å¦‚è¯ä¹¦æ˜¯è‡ªç­¾çš„æˆ–è€…é•œåƒä»“åº“ä½¿ç”¨çš„æ˜¯ HTTP åè®®ï¼Œè¿™æ ·ä¼šå¯¼è‡´ docker æˆ–è€… containerd æ— æ³•æ‹‰å–é•œåƒï¼Œéœ€è¦ä¸ºé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹é…ç½® <code>insecure-registries</code>  è¿™ä¸ªå‚æ•°ã€‚æèµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œå› æ­¤è¿˜æ˜¯æ¨èç»™é•œåƒä»“åº“åŠ ä¸€ä¸ªéè‡ªç­¾çš„ SSL è¯ä¹¦ï¼Œè¿™æ ·èƒ½å‡å°‘ä¸€äº›ä¸å¿…è¦çš„éº»çƒ¦ã€‚å¦‚æœæœ‰ç°æˆçš„é•œåƒä»“åº“å¹¶ä¸”é…ç½®å¥½äº† SSL è¯ä¹¦ï¼Œå¯ä»¥ç•¥è¿‡æ­¤æ­¥ã€‚</p><p>åˆ¶ä½œåŸŸåè¯ä¹¦çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä¸ªäººæ¯”è¾ƒæ¨èä½¿ç”¨ acme.sh ã€‚å®ƒå®ç°äº† acme åè®®æ”¯æŒçš„æ‰€æœ‰éªŒè¯åè®®ï¼Œå¹¶ä¸”æ”¯æŒæ”¯æŒæ•°åç§åŸŸåè§£æå•†ã€‚ç”±äºæˆ‘çš„åŸŸåæ˜¯æ‰˜ç®¡åœ¨ cloudflare ä¸Šçš„ï¼Œä½¿ç”¨ acme.sh æ¥ç­¾å‘è¯ä¹¦ç‰¹åˆ«æ–¹ä¾¿ï¼Œåªéœ€è¦é…ç½®ä¸¤ä¸ªå‚æ•°å³å¯ã€‚ä¸‹é¢å°±ç»™ k8s.li è¿™ä¸ªåŸŸåç­¾å‘ä¸€ä¸ªæ³›åŸŸåè¯ä¹¦ã€‚</p><ul><li>å®‰è£…  acme.sh</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://get.acme.sh | sh</span><br><span class="line">~/.acme.sh/acme.sh --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><ul><li>ç­¾å‘è¯ä¹¦</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CF_Email=<span class="string">"muzi502.li@gmail.com"</span> <span class="comment"># cloudflare è´¦æˆ·çš„é‚®ç®±</span></span><br><span class="line"><span class="built_in">export</span> CF_Key=<span class="string">"xxxxxx"</span> <span class="comment"># "cloudflareä¸­æŸ¥çœ‹ä½ çš„key"</span></span><br><span class="line"></span><br><span class="line">~/.acme.sh/acme.sh --issue --dns dns_cf -d k8s.li -d *.k8s.li</span><br><span class="line"></span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] Cert success.</span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] Your cert is <span class="keyword">in</span>  /root/.acme.sh/k8s.li/k8s.li.cer</span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] Your cert key is <span class="keyword">in</span>  /root/.acme.sh/k8s.li/k8s.li.key</span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] The intermediate CA cert is <span class="keyword">in</span>  /root/.acme.sh/k8s.li/ca.cer</span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] And the full chain certs is there:  /root/.acme.sh/k8s.li/fullchain.cer</span><br></pre></td></tr></table></figure><blockquote><p>å‰é¢è¯ä¹¦ç”Ÿæˆä»¥åï¼Œæ¥ä¸‹æ¥éœ€è¦æŠŠè¯ä¹¦ copy åˆ°çœŸæ­£éœ€è¦ç”¨å®ƒçš„åœ°æ–¹ã€‚</p><p>æ³¨æ„ï¼Œé»˜è®¤ç”Ÿæˆçš„è¯ä¹¦éƒ½æ”¾åœ¨å®‰è£…ç›®å½•ä¸‹<code>~/.acme.sh/</code>ï¼Œ è¯·ä¸è¦ç›´æ¥ä½¿ç”¨æ­¤ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œä¾‹å¦‚: ä¸è¦ç›´æ¥è®©<code>nginx/apache</code>çš„é…ç½®æ–‡ä»¶ä½¿ç”¨è¿™ä¸‹é¢çš„æ–‡ä»¶ã€‚è¿™é‡Œé¢çš„æ–‡ä»¶éƒ½æ˜¯å†…éƒ¨ä½¿ç”¨ï¼Œè€Œä¸”ç›®å½•ç»“æ„å¯èƒ½ä¼šå˜åŒ–ã€‚</p><p>æ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•æ˜¯ä½¿ç”¨<code>--installcert</code> å‘½ä»¤ï¼Œå¹¶æŒ‡å®šç›®æ ‡ä½ç½®ï¼Œç„¶åè¯ä¹¦æ–‡ä»¶ä¼šè¢« copy åˆ°ç›¸åº”çš„ä½ç½®</p></blockquote><ul><li>å®‰è£…è¯ä¹¦</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --install-cert -d k8s.li \</span><br><span class="line">--cert-file      /etc/nginx/ssl/k8s.li.cer  \</span><br><span class="line">--key-file       /etc/nginx/ssl/k8s.li.key  \</span><br><span class="line">--fullchain-file /etc/nginx/ssl/fullchain.cer</span><br></pre></td></tr></table></figure><h3 id="æ­å»ºé•œåƒä»“åº“"><a href="#æ­å»ºé•œåƒä»“åº“" class="headerlink" title="æ­å»ºé•œåƒä»“åº“"></a>æ­å»ºé•œåƒä»“åº“</h3><ul><li>config.yml</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">0.1</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">registry</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">blobdescriptor:</span> <span class="string">inmemory</span></span><br><span class="line">  <span class="attr">oss:</span></span><br><span class="line">    <span class="attr">accesskeyid:</span> <span class="string">xxxx</span> <span class="comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeyid</span></span><br><span class="line">    <span class="attr">accesskeysecret:</span> <span class="string">xxxx</span> <span class="comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeysecret</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">oss-cn-beijing</span> <span class="comment"># é…ç½® OSS bucket çš„åŒºåŸŸï¼Œæ¯”å¦‚ oss-cn-beijing</span></span><br><span class="line">    <span class="attr">internal:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">bucket:</span> <span class="string">fileserver</span> <span class="comment"># é…ç½®å­˜å‚¨ bucket çš„åç§°</span></span><br><span class="line">    <span class="attr">rootdirectory:</span> <span class="string">/kubespray/registry</span> <span class="comment"># é…ç½®è·¯å¾„</span></span><br><span class="line">  <span class="attr">delete:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">addr:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:5000</span></span><br><span class="line">  <span class="attr">headers:</span></span><br><span class="line">    <span class="attr">X-Content-Type-Options:</span> <span class="string">[nosniff]</span></span><br><span class="line"><span class="attr">health:</span></span><br><span class="line">  <span class="attr">storagedriver:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure><ul><li>docker-compose</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">hub-registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2.7.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">hub-registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.yml:/etc/docker/registry/config.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5000:5000</span></span><br></pre></td></tr></table></figure><ul><li>nginx.conf</li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  hub.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/fullchain.cer;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/k8s.li.key;</span><br><span class="line">    <span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">4096m</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   http://localhost:5000;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–‡ä»¶æœåŠ¡å™¨"><a href="#æ–‡ä»¶æœåŠ¡å™¨" class="headerlink" title="æ–‡ä»¶æœåŠ¡å™¨"></a>æ–‡ä»¶æœåŠ¡å™¨</h3><p>æ–‡ä»¶æœåŠ¡å™¨ç”¨äºå­˜æ”¾ä¸€äº› kubeadmã€kubectlã€kubelet ç­‰äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œkubespray é»˜è®¤çš„ä¸‹è½½åœ°å€åœ¨å›½å†…è®¿é—®ç‰¹åˆ«æ…¢ï¼Œå› æ­¤éœ€è¦æ­å»ºä¸€ä¸ª http/https æœåŠ¡å™¨ï¼Œç”¨äºç»™é›†ç¾¤éƒ¨ç½²ä¸‹è½½è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨ã€‚</p><ul><li>nginx.conf</li></ul><p>éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œçš„ nginx é…ç½®ä½¿ç”¨çš„æ˜¯ rewrite è€Œä¸æ˜¯ proxy_passï¼Œè¿™æ ·å®¢æˆ·ç«¯åœ¨æƒ³æˆ‘çš„æœåŠ¡å™¨è¯·æ±‚æ–‡ä»¶æ—¶ï¼Œä¼šé‡å†™å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè®©å®¢æˆ·ç«¯å»è¯·æ±‚é˜¿é‡Œäº‘ OSS çš„åœ°å€ã€‚</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span>;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>   dl.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/fullchain.cer;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/k8s.li.key;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> https://fileserver.oss-cn-beijing.aliyuncs.com/kubespray/files/<span class="variable">$1</span>;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> Content-Disposition;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-request-id;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-object-type;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-hash-crc64ecma;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-storage-class;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-force-download;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-server-time;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘å®‰è£…-skopeo"><a href="#ç¼–è¯‘å®‰è£…-skopeo" class="headerlink" title="ç¼–è¯‘å®‰è£… skopeo"></a>ç¼–è¯‘å®‰è£… skopeo</h3><p>å®‰è£… skopeo ç”¨æ¥åŒæ­¥ä¸€äº›ä½¿ç”¨çš„é•œåƒåˆ°ç§æœ‰é•œåƒä»“åº“ï¼Œæ€§èƒ½ä¸Šæ¯” docker å¿«å¾ˆå¤šï¼Œå¼ºçƒˆæ¨èã€‚skopeo çš„å®‰è£…æ–¹å¼å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ <a href="https://github.com/containers/skopeo/blob/master/install.md" target="_blank" rel="noopener">Installing from packages</a> ã€‚ä¸è¿‡ä¸ªäººè¿˜æ˜¯ä½¿ç”¨ go buid ç¼–è¯‘ä¸€ä¸ªé™æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™æ ·åœ¨ Linux å‘è¡Œç‰ˆéƒ½å¯ä»¥ä½¿ç”¨ã€‚ä¸ç„¶åœ¨ Debian ä¸Šç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶æ— æ³•æ‹¿åˆ° CentOS ä¸Šä½¿ç”¨ï¼Œå› ä¸ºäºŒè€…ä½¿ç”¨çš„åŠ¨æ€é“¾æ¥åº“ä¸ä¸€æ ·ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/skopeo git:(master*) <span class="comment"># git clone https://github.com/containers/skopeo &amp;&amp; cd skopeo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ¬åœ°å¼€å‘æœºå™¨å·²ç»å®‰è£…å¹¶é…ç½®å¥½äº† golang ç¼–è¯‘ç¯å¢ƒ</span></span><br><span class="line">root@debian:/root/skopeo git:(master*) <span class="comment"># CGO_ENABLE=0 GO111MODULE=on go build -mod=vendor "-buildmode=pie" -ldflags '-extldflags "-static"' -gcflags "" -tags "exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp" -o bin/skopeo ./cmd/skopeo</span></span><br><span class="line"></span><br><span class="line">root@debian:/root/skopeo git:(master*) <span class="comment"># ldd bin/skopeo</span></span><br><span class="line">not a dynamic executable</span><br></pre></td></tr></table></figure><h3 id="è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶"></a>è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶</h3><p>kubespray éƒ¨ç½²çš„æ—¶å€™éœ€è¦åˆ° github.com æˆ– storage.googleapis.com ä¸‹è½½ä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™äº›åœ°å€åœ¨å›½å†…éƒ½éƒ½è¢«é˜»æ–­äº†ï¼Œå› æ­¤éœ€è¦å°†éƒ¨ç½²æ—¶ä¾èµ–çš„æ–‡ä»¶ä¸Šä¼ åˆ°è‡ªå·±çš„æ–‡ä»¶æœåŠ¡å™¨ä¸Šã€‚è‡ªå·±å†™äº†ä¸ªè„šæœ¬ç”¨äºè·å– kubespray éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåœ¨ kubespray repo çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œ,ä¸‹è½½çš„æ–‡ä»¶é»˜è®¤ä¼šå­˜æ”¾åœ¨ <code>temp/files</code> ç›®å½•ä¸‹ã€‚ä¸‹è½½å®Œæˆä¹‹åå°†è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•ä¸Šä¼ åˆ°è‡ªå·±çš„æ–‡ä»¶æœåŠ¡å™¨ä¸Šã€‚åé¢é…ç½®ä¸€äº›å‚æ•°åœ¨è¿™ä¸ªåœ°å€çš„å‚æ•°å‰é¢åŠ ä¸Šè‡ªå·±æ–‡ä»¶æœåŠ¡å™¨çš„ URL å³å¯ã€‚</p><ul><li>é¦–å…ˆ clone repo åˆ°æœ¬åœ°</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root<span class="comment"># git clone https://github.com/kubernetes-sigs/kubespray &amp;&amp; cd kubespray</span></span><br></pre></td></tr></table></figure><ul><li>å°†è¯¥è„šæœ¬ <code>generate_list.sh</code> ä¿å­˜åˆ° repo æ ¹ç›®å½•ä¸‹ï¼Œå¹¶æ‰§è¡Œè¯¥è„šä¸‹è½½éœ€è¦çš„æ–‡ä»¶ã€‚</li></ul><blockquote><p>ps: ç”¨ shell è„šæœ¬å»å¤„ç† Jinja2 çš„ yamlï¼Œ å†™ sed å†™å¾—æˆ‘æƒ³åğŸ¤®</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line"></span><br><span class="line">CURRENT_DIR=$(<span class="built_in">cd</span> $(dirname <span class="variable">$0</span>); <span class="built_in">pwd</span>)</span><br><span class="line">TEMP_DIR=<span class="string">"<span class="variable">$&#123;CURRENT_DIR&#125;</span>/temp"</span></span><br><span class="line">REPO_ROOT_DIR=<span class="string">"<span class="variable">$&#123;CURRENT_DIR&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">: <span class="variable">$&#123;IMAGE_ARCH:="amd64"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;ANSIBLE_SYSTEM:="linux"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;ANSIBLE_ARCHITECTURE:="x86_64"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;DOWNLOAD_YML:="roles/download/defaults/main.yml"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;KUBE_VERSION_YAML:="roles/kubespray-defaults/defaults/main.yaml"&#125;</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$&#123;TEMP_DIR&#125;</span></span><br><span class="line"><span class="function"><span class="title">generate_versions</span></span>() &#123;</span><br><span class="line">    <span class="comment"># ARCH used in convert &#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125; to &#123;&#123;arch&#125;&#125;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;IMAGE_ARCH&#125;</span>"</span> != <span class="string">"amd64"</span> ]; <span class="keyword">then</span> ARCH=<span class="string">"<span class="variable">$&#123;IMAGE_ARCH&#125;</span>"</span>; <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    cat &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh &lt;&lt; EOF</span><br><span class="line">arch=<span class="variable">$&#123;ARCH&#125;</span></span><br><span class="line">image_arch=<span class="variable">$&#123;IMAGE_ARCH&#125;</span></span><br><span class="line">ansible_system=<span class="variable">$&#123;ANSIBLE_SYSTEM&#125;</span></span><br><span class="line">ansible_architecture=<span class="variable">$&#123;ANSIBLE_ARCHITECTURE&#125;</span></span><br><span class="line">EOF</span><br><span class="line">    grep <span class="string">'kube_version:'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;KUBE_VERSION_YAML&#125;</span> \</span><br><span class="line">    | sed <span class="string">'s/: /=/g'</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh</span><br><span class="line">    grep <span class="string">'_version:'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">    | sed <span class="string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> | tr -d <span class="string">' '</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh</span><br><span class="line">    sed -i <span class="string">'s/kube_major_version=.*/kube_major_version=$&#123;kube_version%.*&#125;/g'</span> <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh</span><br><span class="line">    sed -i <span class="string">'s/crictl_version=.*/crictl_version=$&#123;kube_version%.*&#125;.0/g'</span> <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">generate_files_list</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"source <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh"</span> &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.sh</span><br><span class="line">    grep <span class="string">'download_url:'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">    | sed <span class="string">'s/: /=/g;s/ //g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g;s/|lower//g;s/^.*_url=/echo /g'</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.sh</span><br><span class="line">    bash <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.sh | sort &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.list</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">generate_images_list</span></span>() &#123;</span><br><span class="line">    KUBE_IMAGES=<span class="string">"kube-apiserver kube-controller-manager kube-scheduler kube-proxy"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"source <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh"</span> &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh</span><br><span class="line">    grep -E <span class="string">'_repo:|_tag:'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">    | sed <span class="string">"s#&#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125;#&#123;&#123;arch&#125;&#125;#g"</span> \</span><br><span class="line">    | sed <span class="string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> | tr -d <span class="string">' '</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh</span><br><span class="line">    sed -n <span class="string">'/^downloads:/,/download_defaults:/p'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">    | sed -n <span class="string">"s/repo: //p;s/tag: //p"</span> | tr -d <span class="string">' '</span> | sed <span class="string">'s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> \</span><br><span class="line">    | sed <span class="string">'N;s#\n# #g'</span> | tr <span class="string">' '</span> <span class="string">':'</span> | sed <span class="string">'s/^/echo /g'</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;KUBE_IMAGES&#125;</span>"</span> | tr <span class="string">' '</span> <span class="string">'\n'</span> | xargs -L1 -I &#123;&#125; \</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'echo $&#123;kube_image_repo&#125;/&#123;&#125;:$&#123;kube_version&#125;'</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh</span><br><span class="line">    bash <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh | sort &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.list</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">generate_versions</span><br><span class="line">generate_files_list</span><br><span class="line">generate_images_list</span><br><span class="line">wget -x -P <span class="variable">$&#123;TEMP_DIR&#125;</span>/files -i <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.list</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆä¸‹è½½çš„ç»“æœå¦‚ä¸‹ï¼ŒåŸºæœ¬ä¸Šä¿æŒäº†åŸæœ‰çš„ URL è·¯å¾„ï¼Œä¹Ÿæ–¹ä¾¿åç»­çš„æ›´æ–°å’Œç‰ˆæœ¬è¿­ä»£ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">temp/files</span><br><span class="line">â”œâ”€â”€ get.helm.sh</span><br><span class="line">â”‚Â Â  â””â”€â”€ helm-v3.5.4-linux-amd64.tar.gz</span><br><span class="line">â”œâ”€â”€ github.com</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containerd</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ nerdctl</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.8.0</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ nerdctl-0.8.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containernetworking</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ plugins</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.9.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containers</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ crun</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ 0.19</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ crun-0.19-linux-amd64</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ coreos</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ etcd</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v3.4.13</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kata-containers</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ runtime</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ 1.12.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ kata-static-1.12.1-x86_64.tar.xz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kubernetes-sigs</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ cri-tools</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v1.20.0</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ crictl-v1.20.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â””â”€â”€ projectcalico</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ calico</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ archive</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ v3.17.3.tar.gz</span><br><span class="line">â”‚Â Â      â””â”€â”€ calicoctl</span><br><span class="line">â”‚Â Â          â””â”€â”€ releases</span><br><span class="line">â”‚Â Â              â””â”€â”€ download</span><br><span class="line">â”‚Â Â                  â””â”€â”€ v3.17.3</span><br><span class="line">â”‚Â Â                      â””â”€â”€ calicoctl-linux-amd64</span><br><span class="line">â””â”€â”€ storage.googleapis.com</span><br><span class="line">    â””â”€â”€ kubernetes-release</span><br><span class="line">        â””â”€â”€ release</span><br><span class="line">            â””â”€â”€ v1.20.6</span><br><span class="line">                â””â”€â”€ bin</span><br><span class="line">                    â””â”€â”€ linux</span><br><span class="line">                        â””â”€â”€ amd64</span><br><span class="line">                            â”œâ”€â”€ kubeadm</span><br><span class="line">                            â”œâ”€â”€ kubectl</span><br><span class="line">                            â””â”€â”€ kubelet</span><br></pre></td></tr></table></figure><h3 id="è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ"><a href="#è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ" class="headerlink" title="è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ"></a>è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ</h3><p>å¯¹äºç¦»çº¿éƒ¨ç½²ï¼Œkubespray æ”¯æŒçš„å¹¶ä¸æ˜¯å¾ˆå‹å¥½ã€‚æ¯”å¦‚è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒåˆ—è¡¨ï¼Œç›®å‰çš„æ–¹æ¡ˆæ˜¯éœ€è¦å…ˆéƒ¨ç½²ä¸€ä¸ªé›†ç¾¤ï¼Œç„¶åé€šè¿‡ kubectl get ä¸€äº›èµ„æºæ¥è·å– pod ä½¿ç”¨åˆ°çš„é•œåƒã€‚ä¸ªäººè§‰å¾—è¿™ä¸ªæ–¹å¼å¯ä»¥ä¿®æ”¹ä¸€ä¸‹ï¼Œæ¯”å¦‚é€šè¿‡ kubespray æºç æ¥ç”Ÿæˆä¸€ä¸ªé•œåƒåˆ—è¡¨ã€‚ä¸‹é¢åªæ˜¯ç®€å•ç”Ÿæˆä¸€ä¸ªé•œåƒåˆ—è¡¨ï¼Œå†…å®¹å¦‚ä¸‹</p><ul><li>images.list</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker.io/nginx:1.19.0</span><br><span class="line">docker.io/calico/cni:v3.17.3</span><br><span class="line">docker.io/calico/node:v3.17.3</span><br><span class="line">docker.io/calico/kube-controllers:v3.17.3</span><br><span class="line">quay.io/coreos/flannel:v0.13.0</span><br><span class="line">quay.io/coreos/flannel:v0.13.0-amd64</span><br><span class="line">k8s.gcr.io/pause:3.2</span><br><span class="line">k8s.gcr.io/coredns:1.7.0</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.20.6</span><br><span class="line">k8s.gcr.io/dns/k8s-dns-node-cache:1.17.1</span><br><span class="line">k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64:1.8.3</span><br></pre></td></tr></table></figure><p>ç”±äº master åˆ†æ”¯çš„ä»£ç ä¸€ç›´åœ¨æ›´æ–°ï¼Œå½“å‰çš„ master åˆ†æ”¯çš„ç‰ˆæœ¬å¯èƒ½å’Œè¿™é‡Œçš„ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦ä¿®æ”¹ä¸ºè‡ªå·±éœ€è¦çš„ç‰ˆæœ¬ã€‚</p><ul><li>æ ¹æ®ä¸Šé¢çš„é•œåƒåˆ—è¡¨ï¼Œä½¿ç”¨ skopeo å°†é•œåƒåŒæ­¥åˆ°è‡ªå·±çš„é•œåƒä»“åº“ä¸­ï¼Œå¦‚æˆ‘çš„ <code>hub.k8s.li</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> $(cat images.list); <span class="keyword">do</span> skopeo copy docker://<span class="variable">$&#123;image&#125;</span> docker://hub.k8s.li/<span class="variable">$&#123;image#*/&#125;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>åŒæ­¥åˆ°æˆ‘çš„é•œåƒä»“åº“ä¸­ï¼Œå†…å®¹å°±å¦‚ä¸‹ï¼Œåœ¨éƒ¨ç½²çš„æ—¶å€™é€šè¿‡ä¿®æ”¹ä¸€äº›é•œåƒä»“åº“çš„åœ°å€å³å¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hub.k8s.li/nginx:1.19.0</span><br><span class="line">hub.k8s.li/calico/cni:v3.17.3</span><br><span class="line">hub.k8s.li/calico/node:v3.17.3</span><br><span class="line">hub.k8s.li/calico/kube-controllers:v3.17.3</span><br><span class="line">hub.k8s.li/coreos/flannel:v0.13.0</span><br><span class="line">hub.k8s.li/coreos/flannel:v0.13.0-amd64</span><br><span class="line">hub.k8s.li/pause:3.2</span><br><span class="line">hub.k8s.li/coredns:1.7.0</span><br><span class="line">hub.k8s.li/kube-apiserver:v1.20.6</span><br><span class="line">hub.k8s.li/kube-controller-manager:v1.20.6</span><br><span class="line">hub.k8s.li/kube-proxy:v1.20.6</span><br><span class="line">hub.k8s.li/kube-scheduler:v1.20.6</span><br><span class="line">hub.k8s.li/dns/k8s-dns-node-cache:1.17.1</span><br><span class="line">hub.k8s.li/cpa/cluster-proportional-autoscaler-amd64:1.8.3</span><br></pre></td></tr></table></figure><p>è‡³æ­¤å‡†å¤‡å·¥ä½œå¤§è‡´éƒ½å·²ç»å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹é…ç½® kubespray çš„ä¸€äº›å‚æ•°å’Œ inventory æ–‡ä»¶</p><h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>æŒ‰ç…§ kubespray æ–‡æ¡£è¯´æ˜ï¼Œå°† <code>inventory/sample</code> ç›®å½•å¤åˆ¶ä¸€ä»½ï¼Œç„¶åé€šè¿‡ä¿®æ”¹é‡Œé¢çš„å‚æ•°æ¥æ§åˆ¶éƒ¨ç½²ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># cp -rf inventory/sample deploy</span></span><br></pre></td></tr></table></figure><h3 id="inventory"><a href="#inventory" class="headerlink" title="inventory"></a>inventory</h3><ul><li><code>deploy/inventory</code></li></ul><p>åˆ›å»ºä¸»æœº inventory æ–‡ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[all:vars]</span></span><br><span class="line"><span class="attr">ansible_port</span>=<span class="number">22</span></span><br><span class="line"><span class="attr">ansible_user</span>=root</span><br><span class="line"></span><br><span class="line"><span class="attr">ansible_ssh_private_key_file</span>=/kubespray/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line"><span class="section">[all]</span></span><br><span class="line">kube-control-1 ansible_host=192.168.4.11</span><br><span class="line">kube-control-2 ansible_host=192.168.4.12</span><br><span class="line">kube-control-3 ansible_host=192.168.4.13</span><br><span class="line">kube-node-1 ansible_host=192.168.4.4</span><br><span class="line"></span><br><span class="line"><span class="section">[kube_control_plane]</span></span><br><span class="line">kube-control-1</span><br><span class="line">kube-control-2</span><br><span class="line">kube-control-3</span><br><span class="line"></span><br><span class="line"><span class="section">[etcd]</span></span><br><span class="line">kube-control-1</span><br><span class="line">kube-control-2</span><br><span class="line">kube-control-3</span><br><span class="line"></span><br><span class="line"><span class="section">[kube-node]</span></span><br><span class="line">kube-control-1</span><br><span class="line">kube-control-2</span><br><span class="line">kube-control-3</span><br><span class="line">kube-node-1</span><br><span class="line"></span><br><span class="line"><span class="section">[calico-rr]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[k8s-cluster:children]</span></span><br><span class="line">kube_control_plane</span><br><span class="line">kube-node</span><br><span class="line">calico-rr</span><br></pre></td></tr></table></figure><ul><li>ssh äº’ä¿¡</li></ul><p>Kubespray ç”¨åˆ°äº† ansible çš„ <a href="https://docs.ansible.com/ansible/latest/collections/ansible/posix/synchronize_module.html" target="_blank" rel="noopener">synchronize</a> æ¨¡å—æ¥åˆ†å‘æ–‡ä»¶ï¼ŒåŸºäº rsync åè®®æ‰€ä»¥å¿…é¡»è¦ä½¿ç”¨ ssh å¯†é’¥å¯¹æ¥è¿æ¥é›†ç¾¤èŠ‚ç‚¹ã€‚inventory é…ç½®çš„æ˜¯ kubespray å®¹å™¨å†…çš„è·¯å¾„ï¼Œå› æ­¤éœ€è¦å°† ssh å…¬é’¥å’Œç§é’¥å¤åˆ¶åˆ° repo çš„ .ssh ç›®å½•ä¸‹ã€‚å¦‚æœèŠ‚ç‚¹å°±æ²¡æœ‰è¿›è¡Œ ssh å…å¯†ç™»å½•ï¼Œå¯ä»¥ç”¨ ansible çš„ authorized_key æ¨¡å—å°† ssh å…¬é’¥æ·»åŠ åˆ°ä¸»æœºçš„ authorized_key ä¸­ã€‚æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># mkdir -p .ssh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆ ssh å¯†é’¥å¯¹</span></span><br><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># ssh-keygen -t rsa -f .ssh/id_rsa -P ""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°† ssh å…¬é’¥æ·»åŠ åˆ°æ‰€æœ‰ä¸»æœº</span></span><br><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># ansible -i deploy/inventory all -m authorized_key -a "user=&#123;&#123; ansible_user &#125;&#125; key='&#123;&#123; lookup('file', '&#123;&#123; ssh_cert_path &#125;&#125;') &#125;&#125;'" -e ssh_cert_path=./.ssh/id_rsa.pub -e ansible_ssh_pass=passwd</span></span><br></pre></td></tr></table></figure><h3 id="vars"><a href="#vars" class="headerlink" title="vars"></a>vars</h3><p>åˆ›å»ºå¹¶ä¿®æ”¹ä»¥ä¸‹é…ç½®æ–‡ä»¶</p><ul><li><code>deploy/env.yml</code></li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€äº›ç»„ä»¶çš„ç‰ˆæœ¬</span></span><br><span class="line"><span class="attr">kube_version:</span> <span class="string">v1.20.6</span></span><br><span class="line"><span class="attr">calico_version:</span> <span class="string">"v3.17.3"</span></span><br><span class="line"><span class="attr">pod_infra_version:</span> <span class="string">"3.2"</span></span><br><span class="line"><span class="attr">nginx_image_version:</span> <span class="string">"1.19"</span></span><br><span class="line"><span class="attr">coredns_version:</span> <span class="string">"1.7.0"</span></span><br><span class="line"><span class="attr">image_arch:</span> <span class="string">"amd64"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker registry domain</span></span><br><span class="line"><span class="attr">registry_domain:</span> <span class="string">"hub.k8s.li"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># file download server url</span></span><br><span class="line"><span class="attr">download_url:</span> <span class="string">"https://dl.k8s.li"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-ce-repo mirrors</span></span><br><span class="line"><span class="attr">docker_mirrors_url:</span> <span class="string">"https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">container_manager:</span> <span class="string">"containerd"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”±äºä½¿ç”¨çš„æ˜¯ containerd ä½œä¸º CRIï¼Œç›®å‰ etcd ä¸æ”¯æŒ containerd å®¹å™¨åŒ–éƒ¨ç½²å› æ­¤éœ€è¦å°†è¯¥å‚æ•°ä¿®æ”¹ä¸º host ï¼Œä½¿ç”¨ systemd æ¥éƒ¨ç½²</span></span><br><span class="line"><span class="attr">etcd_deployment_type:</span> <span class="string">host</span></span><br><span class="line"><span class="attr">etcd_cluster_setup:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">etcd_events_cluster_setup:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">etcd_events_cluster_enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes CNI type é…ç½®é›†ç¾¤ CNI ä½¿ç”¨çš„ç±»å‹</span></span><br><span class="line"><span class="attr">kube_network_plugin:</span> <span class="string">canal</span></span><br></pre></td></tr></table></figure><ul><li><code>deploy/group_vars/all/download.yml</code></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Container registry define</span></span><br><span class="line"><span class="attr">gcr_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_domain &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kube_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_domain &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">docker_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_domain &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">quay_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_domain &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Download URLs</span></span><br><span class="line"><span class="attr">kubelet_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubelet"</span></span><br><span class="line"><span class="attr">kubectl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubectl"</span></span><br><span class="line"><span class="attr">kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kubeadm_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubeadm"</span></span><br><span class="line"><span class="attr">etcd_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/coreos/etcd/releases/download/<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>/etcd-<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">cni_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containernetworking/plugins/releases/download/<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>/cni-plugins-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>-<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>.tgz"</span></span><br><span class="line"><span class="attr">calicoctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calicoctl/releases/download/<span class="template-variable">&#123;&#123; calico_ctl_version &#125;&#125;</span>/calicoctl-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_crds_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calico/archive/<span class="template-variable">&#123;&#123; calico_version &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crictl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kubernetes-sigs/cri-tools/releases/download/<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>/crictl-<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">helm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/get.helm.sh/helm-<span class="template-variable">&#123;&#123; helm_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crun_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containers/crun/releases/download/<span class="template-variable">&#123;&#123; crun_version &#125;&#125;</span>/crun-<span class="template-variable">&#123;&#123; crun_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kata_containers_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kata-containers/runtime/releases/download/<span class="template-variable">&#123;&#123; kata_containers_version &#125;&#125;</span>/kata-static-<span class="template-variable">&#123;&#123; kata_containers_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_architecture &#125;&#125;</span>.tar.xz"</span></span><br><span class="line"><span class="attr">nerdctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containerd/nerdctl/releases/download/v<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>/nerdctl-<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br></pre></td></tr></table></figure><h3 id="docker-ce-mirrors"><a href="#docker-ce-mirrors" class="headerlink" title="docker-ce mirrors"></a>docker-ce mirrors</h3><p>kubespray å®‰è£… docker æˆ–è€… containerd å®¹å™¨è¿è¡Œæ—¶ï¼Œéœ€è¦ä½¿ç”¨ docker-ce çš„æºï¼Œå›½å†…å¯ä»¥ä½¿ç”¨æ¸…åçš„é•œåƒæºã€‚æ ¹æ®ä¸åŒçš„ Linux å‘è¡Œç‰ˆï¼Œåœ¨ <code>deploy/group_vars/all/offline.yml</code> æ–‡ä»¶ä¸­æ·»åŠ è¿™äº›å‚æ•°å³å¯ã€‚å…¶ä¸­ <code>docker_mirrors_url</code> è¿™ä¸ªå‚æ•°å°±æ˜¯åœ¨ <code>env.yml</code> é‡Œè®¾ç½®çš„å‚æ•°ã€‚</p><ul><li>CentOS/Redhat</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## CentOS/Redhat</span></span><br><span class="line"><span class="comment">### For EL7, base and extras repo must be available, for EL8, baseos and appstream</span></span><br><span class="line"><span class="comment">### By default we enable those repo automatically</span></span><br><span class="line"><span class="comment"># rhel_enable_repos: false</span></span><br><span class="line"><span class="comment">### Docker / Containerd</span></span><br><span class="line">docker_rh_repo_base_url: <span class="string">"&#123;&#123; docker_mirrors_url &#125;&#125;/centos/&#123;&#123; ansible_distribution_major_version &#125;&#125;/&#123;&#123; ansible_architecture &#125;&#125;/stable"</span></span><br><span class="line">docker_rh_repo_gpgkey: <span class="string">"&#123;&#123; docker_mirrors_url &#125;&#125;/centos/gpg"</span></span><br></pre></td></tr></table></figure><ul><li>Fedora</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Fedora</span></span><br><span class="line"><span class="comment">### Docker</span></span><br><span class="line"><span class="attr">docker_fedora_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/fedora/<span class="template-variable">&#123;&#123; ansible_distribution_major_version &#125;&#125;</span>/<span class="template-variable">&#123;&#123; ansible_architecture &#125;&#125;</span>/stable"</span></span><br><span class="line"><span class="attr">docker_fedora_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/fedora/gpg"</span></span><br><span class="line"><span class="comment">### Containerd</span></span><br><span class="line"><span class="attr">containerd_fedora_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/fedora/<span class="template-variable">&#123;&#123; ansible_distribution_major_version &#125;&#125;</span>/<span class="template-variable">&#123;&#123; ansible_architecture &#125;&#125;</span>/stable"</span></span><br><span class="line"><span class="attr">containerd_fedora_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/fedora/gpg"</span></span><br></pre></td></tr></table></figure><ul><li>debian</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Debian</span></span><br><span class="line"><span class="comment">### Docker</span></span><br><span class="line"><span class="attr">docker_debian_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/debian"</span></span><br><span class="line"><span class="attr">docker_debian_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/debian/gpg"</span></span><br><span class="line"><span class="comment">### Containerd</span></span><br><span class="line"><span class="attr">containerd_debian_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/debian"</span></span><br><span class="line"><span class="attr">containerd_debian_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/debian/gpg"</span></span><br><span class="line"><span class="comment"># containerd_debian_repo_repokey: 'YOURREPOKEY'</span></span><br></pre></td></tr></table></figure><ul><li>ubuntu</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Ubuntu</span></span><br><span class="line"><span class="comment">### Docker</span></span><br><span class="line"><span class="attr">docker_ubuntu_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/ubuntu"</span></span><br><span class="line"><span class="attr">docker_ubuntu_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/ubuntu/gpg"</span></span><br><span class="line"><span class="comment">### Containerd</span></span><br><span class="line"><span class="attr">containerd_ubuntu_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/ubuntu"</span></span><br><span class="line"><span class="attr">containerd_ubuntu_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/ubuntu/gpg"</span></span><br></pre></td></tr></table></figure><h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>ç»è¿‡ä»¥ä¸Šå‡†å¤‡å¥½é…ç½®å·¥ä½œä¹‹åï¼Œæ¥ä¸‹æ¥å¯ä»¥å¼€å§‹æ­£å¼éƒ¨ç½²äº†ã€‚åœ¨ä½¿ç”¨ ansible è¿›è¡Œéƒ¨ç½²çš„æ—¶å€™ï¼Œä¸ªäººå€¾å‘äºåœ¨ kubespray å®¹å™¨é‡Œè¿›è¡Œæ“ä½œï¼Œè€Œéåœ¨æœ¬åœ°å¼€å‘æœºå™¨ä¸Šå®‰è£… python3 ç­‰ç¯å¢ƒã€‚å¯¹äºç¦»çº¿éƒ¨ç½²è€Œè¨€ï¼Œæå‰æ„å»ºå¥½é•œåƒï¼Œä½¿ç”¨ docker å®¹å™¨æ›´ä¸ºæ–¹ä¾¿ä¸€äº›ã€‚</p><ul><li>æ„å»ºé•œåƒ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># docker build -t kubespray:v2.15.1-kube-v1.20.6 .</span></span><br></pre></td></tr></table></figure><ul><li>è¿è¡Œ kubespray å®¹å™¨</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># docker run --rm -it --net=host -v $PWD:/kubespray kubespray:v2.15.1-kube-v1.20.6 bash</span></span><br></pre></td></tr></table></figure><ul><li>æµ‹è¯•ä¸»æœºæ˜¯å¦è¿æ¥æ­£å¸¸</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/kubespray<span class="comment"># ansible -i cluster/inventory all -m ping</span></span><br><span class="line">kube-control-3 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">kube-control-1 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">kube-node-1 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">kube-control-2 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¼€å§‹éƒ¨ç½²é›†ç¾¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/kubespray<span class="comment"># ansible-playbook -i deploy/inventory -e "@deploy/env.yml" cluster.yml</span></span><br></pre></td></tr></table></figure><ul><li>éƒ¨ç½²å®Œæˆæ—¥å¿—å¦‚ä¸‹ï¼Œå½“ failed éƒ½ä¸º 0 æ—¶è¯´æ˜ tasks éƒ½å·²ç»æˆåŠŸè·‘å®Œäº†</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PLAY RECAP ******************************************************************</span><br><span class="line">kube-control-1             : ok=526  changed=67   unreachable=0    failed=0    skipped=978  rescued=0    ignored=0</span><br><span class="line">kube-control-2             : ok=524  changed=66   unreachable=0    failed=0    skipped=980  rescued=0    ignored=0</span><br><span class="line">kube-control-3             : ok=593  changed=76   unreachable=0    failed=0    skipped=1125 rescued=0    ignored=1</span><br><span class="line">kube-node-1                : ok=366  changed=34   unreachable=0    failed=0    skipped=628  rescued=0    ignored=0</span><br><span class="line">localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br><span class="line">Wednesday 28 April 2021  10:57:57 +0000 (0:00:00.115)       0:15:21.190 *******</span><br><span class="line">===============================================================================</span><br><span class="line">kubernetes/control-plane : kubeadm | Initialize first master -------------- 65.88s</span><br><span class="line">kubernetes/control-plane : Joining control plane node to the cluster. ----- 50.05s</span><br><span class="line">kubernetes/kubeadm : Join to cluster -------------------------------------- 31.54s</span><br><span class="line">download_container | Download image <span class="keyword">if</span> required --------------------------- 24.38s</span><br><span class="line">reload etcd --------------------------------------------------------------- 20.56s</span><br><span class="line">Gen_certs | Write etcd member and admin certs to other etcd nodes --------- 19.32s</span><br><span class="line">Gen_certs | Write node certs to other etcd nodes -------------------------- 19.14s</span><br><span class="line">Gen_certs | Write etcd member and admin certs to other etcd nodes --------- 17.45s</span><br><span class="line">network_plugin/canal : Canal | Create canal node manifests ---------------- 15.41s</span><br><span class="line">kubernetes-apps/ansible : Kubernetes Apps | Lay Down CoreDNS Template ----- 13.27s</span><br><span class="line">kubernetes/control-plane : Master | <span class="built_in">wait</span> <span class="keyword">for</span> kube-scheduler --------------- 11.97s</span><br><span class="line">download_container | Download image <span class="keyword">if</span> required --------------------------- 11.76s</span><br><span class="line">Gen_certs | Write node certs to other etcd nodes -------------------------- 10.50s</span><br><span class="line">kubernetes-apps/ansible : Kubernetes Apps | Start Resources ---------------- 8.28s</span><br><span class="line">policy_controller/calico : Create calico-kube-controllers manifests -------- 7.61s</span><br><span class="line">kubernetes/control-plane : <span class="built_in">set</span> kubeadm certificate key --------------------- 6.32s</span><br><span class="line">download : extract_file | Unpacking archive -------------------------------- 5.51s</span><br><span class="line">Configure | Check <span class="keyword">if</span> etcd cluster is healthy ------------------------------- 5.41s</span><br><span class="line">Configure | Check <span class="keyword">if</span> etcd-events cluster is healthy ------------------------ 5.41s</span><br><span class="line">kubernetes-apps/network_plugin/canal : Canal | Start Resources ------------- 4.85s</span><br></pre></td></tr></table></figure><ul><li>é›†ç¾¤çŠ¶æ€</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-control-1 ~]# kubectl get node -o wide</span><br><span class="line">NAME             STATUS   ROLES                  AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME</span><br><span class="line">kube-control-1   Ready    control-plane,master   5m24s   v1.20.6   192.168.4.11   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4</span><br><span class="line">kube-control-2   Ready    control-plane,master   5m40s   v1.20.6   192.168.4.12   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4</span><br><span class="line">kube-control-3   Ready    control-plane,master   6m28s   v1.20.6   192.168.4.13   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4</span><br><span class="line">kube-node-1      Ready    &lt;none&gt;                 3m53s   v1.20.6   192.168.4.14   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4</span><br></pre></td></tr></table></figure><ul><li>é›†ç¾¤ç»„ä»¶çŠ¶æ€</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-control-1 ~]<span class="comment"># kubectl get all -n kube-system</span></span><br><span class="line">NAME                                           READY   STATUS             RESTARTS   AGE</span><br><span class="line">pod/calico-kube-controllers-67d6cdb559-cwf62   0/1     CrashLoopBackOff   5          4m10s</span><br><span class="line">pod/canal-node-46x2b                           2/2     Running            0          4m25s</span><br><span class="line">pod/canal-node-5rkhq                           2/2     Running            0          4m25s</span><br><span class="line">pod/canal-node-fcsgn                           2/2     Running            0          4m25s</span><br><span class="line">pod/canal-node-nhkp8                           2/2     Running            0          4m25s</span><br><span class="line">pod/coredns-5d578c6f84-5nnp8                   1/1     Running            0          3m33s</span><br><span class="line">pod/coredns-5d578c6f84-w2kvf                   1/1     Running            0          3m39s</span><br><span class="line">pod/dns-autoscaler-6b675c8995-vp282            1/1     Running            0          3m34s</span><br><span class="line">pod/kube-apiserver-kube-control-1              1/1     Running            0          6m51s</span><br><span class="line">pod/kube-apiserver-kube-control-2              1/1     Running            0          7m7s</span><br><span class="line">pod/kube-apiserver-kube-control-3              1/1     Running            0          7m41s</span><br><span class="line">pod/kube-controller-manager-kube-control-1     1/1     Running            0          6m52s</span><br><span class="line">pod/kube-controller-manager-kube-control-2     1/1     Running            0          7m7s</span><br><span class="line">pod/kube-controller-manager-kube-control-3     1/1     Running            0          7m41s</span><br><span class="line">pod/kube-proxy-5dfx8                           1/1     Running            0          5m17s</span><br><span class="line">pod/kube-proxy-fvrqk                           1/1     Running            0          5m17s</span><br><span class="line">pod/kube-proxy-jd84p                           1/1     Running            0          5m17s</span><br><span class="line">pod/kube-proxy-l2mjk                           1/1     Running            0          5m17s</span><br><span class="line">pod/kube-scheduler-kube-control-1              1/1     Running            0          6m51s</span><br><span class="line">pod/kube-scheduler-kube-control-2              1/1     Running            0          7m7s</span><br><span class="line">pod/kube-scheduler-kube-control-3              1/1     Running            0          7m41s</span><br><span class="line">pod/nginx-proxy-kube-node-1                    1/1     Running            0          5m20s</span><br><span class="line">pod/nodelocaldns-77kq9                         1/1     Running            0          3m32s</span><br><span class="line">pod/nodelocaldns-fn5pd                         1/1     Running            0          3m32s</span><br><span class="line">pod/nodelocaldns-lfjzb                         1/1     Running            0          3m32s</span><br><span class="line">pod/nodelocaldns-xnc6n                         1/1     Running            0          3m32s</span><br><span class="line"></span><br><span class="line">NAME              TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">service/coredns   ClusterIP   10.233.0.3   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   3m38s</span><br><span class="line"></span><br><span class="line">NAME                          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span><br><span class="line">daemonset.apps/canal-node     4         4         4       4            4           &lt;none&gt;                   4m25s</span><br><span class="line">daemonset.apps/kube-proxy     4         4         4       4            4           kubernetes.io/os=linux   7m53s</span><br><span class="line">daemonset.apps/nodelocaldns   4         4         4       4            4           &lt;none&gt;                   3m32s</span><br><span class="line"></span><br><span class="line">NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/calico-kube-controllers   0/1     1            0           4m12s</span><br><span class="line">deployment.apps/coredns                   2/2     2            2           3m39s</span><br><span class="line">deployment.apps/dns-autoscaler            1/1     1            1           3m34s</span><br><span class="line"></span><br><span class="line">NAME                                                 DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/calico-kube-controllers-67d6cdb559   1         1         0       4m12s</span><br><span class="line">replicaset.apps/coredns-5d578c6f84                   2         2         2       3m39s</span><br><span class="line">replicaset.apps/dns-autoscaler-6b675c8995            1         1         1       3m34s</span><br></pre></td></tr></table></figure><h2 id="åæ§½"><a href="#åæ§½" class="headerlink" title="åæ§½"></a>åæ§½</h2><p>åœ¨å›½å†…è¿™ç§ååˆ†ç³Ÿç³•çš„ç½‘ç»œç¯å¢ƒä¸‹ï¼Œå¯¹äºæ™®é€šçš„å¼€å‘è€…æˆ–è€…å­¦ç”Ÿæ¥è®²ï¼Œéƒ¨ç½²ä¸€ä¸ª kubernetes é›†ç¾¤æ˜¯ååˆ†ç—›è‹¦çš„äº‹æƒ…ï¼Œè¿™ä¹Ÿè¿›ä¸€æ­¥é˜»ç¢äº†è¿™é—¨æŠ€æœ¯çš„æ™®åŠå’Œä½¿ç”¨ã€‚ä¹Ÿæƒ³èµ·äº†å‡ å¹´å‰åœ¨ä¸€æ¬¡ docker æŠ€æœ¯åˆ†äº«æ—¶çš„ QA é—®ç­”ï¼š</p><blockquote><p>Qï¼šå¦‚ä½•æ‘†è„±ç½‘ç»œçš„ä¾èµ–æ¥åˆ›å»ºä¸ª Docker çš„ image å‘¢ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªæ˜¯ Docker ç”¨æˆ·è‡ªå·±çš„åŸºæœ¬æƒåˆ©ï¼Ÿ</p></blockquote><p><strong>Aï¼šè¿™ä¸ªåŸºæœ¬æƒåˆ©æˆ‘è§‰å¾—è¿˜æ˜¯è¦é—® GFW ï¼Œå›½å¤–çš„å¼€å‘äººå‘˜æ˜¯éå¸¸éš¾ç†è§£æœ‰äº›ä»–ä»¬è®¤ä¸ºè·Ÿæ°´ç”µä¸€æ ·æ™®åŠçš„åŸºç¡€è®¾æ–½åœ¨æŸäº›åœ°æ–¹è¿˜æ˜¯å¾ˆå›°éš¾çš„ã€‚</strong></p>]]></content>
    
    <summary type="html">
    
      
      
        
        
          &lt;p&gt;å…¬å¸ PaaS å¹³å°åº•å±‚çš„ kubernetes
        
      
    
    </summary>
    
    
      <category term="æŠ€æœ¯" scheme="https://blog.k8s.li/categories/%E6%8A%80%E6%9C%AF/"/>
    
    
      <category term="kubernetes" scheme="https://blog.k8s.li/tags/kubernetes/"/>
    
      <category term="k8s" scheme="https://blog.k8s.li/tags/k8s/"/>
    
      <category term="kubespray" scheme="https://blog.k8s.li/tags/kubespray/"/>
    
  </entry>
  
</feed>
