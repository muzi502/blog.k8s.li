<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.3.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="不久前写过一篇博客《使用 Redfish 自动化安装 ESXi OS》分享了如何使用 Redfish 给物理服务器自动化安装 ESXi OS。虽然在我们内部做到了一键安装&#x2F;重装 ESXi OS，但想要将这套方案应用在客户的私有云机房环境中还是有很大的难度。 首先这套工具必须运行在 Linux 中才行，对于 Bare Metal 裸服务器来讲还没有安装任何 OS，这就引申出了鸡生蛋蛋生鸡的">
<meta property="og:type" content="blog">
<meta property="og:title" content="使用 Packer 构建虚拟机镜像踩的坑">
<meta property="og:url" content="https://blog.k8s.li/packer-vsphere-example.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="不久前写过一篇博客《使用 Redfish 自动化安装 ESXi OS》分享了如何使用 Redfish 给物理服务器自动化安装 ESXi OS。虽然在我们内部做到了一键安装&#x2F;重装 ESXi OS，但想要将这套方案应用在客户的私有云机房环境中还是有很大的难度。 首先这套工具必须运行在 Linux 中才行，对于 Bare Metal 裸服务器来讲还没有安装任何 OS，这就引申出了鸡生蛋蛋生鸡的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/2022-05-23-packer-vsphere-example-01.png">
<meta property="og:image" content="https://p.k8s.li/2022-05-23-packer-vsphere-example-02.png">
<meta property="article:published_time" content="2022-05-24T16:00:00.000Z">
<meta property="article:modified_time" content="2022-05-24T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="argo-workflow">
<meta property="article:tag" content="vSphere">
<meta property="article:tag" content="packer">
<meta property="article:tag" content="esxi">
<meta property="article:tag" content="k3s">
<meta property="article:tag" content="redfish">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/2022-05-23-packer-vsphere-example-01.png">


<link rel="canonical" href="https://blog.k8s.li/packer-vsphere-example.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/packer-vsphere-example.html","path":"packer-vsphere-example.html","title":"使用 Packer 构建虚拟机镜像踩的坑"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>使用 Packer 构建虚拟机镜像踩的坑 | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%9D%E9%80%80%E4%B8%89%E8%BF%9E-%F0%9F%98%82"><span class="nav-number">1.</span> <span class="nav-text">劝退三连 😂</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Packer"><span class="nav-number">2.</span> <span class="nav-text">Packer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">2.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">2.2.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">2.3.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#post-processors"><span class="nav-number">2.4.</span> <span class="nav-text">post-processors</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA"><span class="nav-number">2.5.</span> <span class="nav-text">构建</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">构建流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-vsphere-iso-%E6%9E%84%E5%BB%BA-Base-%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-number">3.1.</span> <span class="nav-text">通过 vsphere-iso 构建 Base 虚拟机</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-vsphere-clone-%E6%9E%84%E5%BB%BA%E4%B8%9A%E5%8A%A1%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%B9%B6%E5%AF%BC%E5%87%BA-OVF-x2F-OVA"><span class="nav-number">3.2.</span> <span class="nav-text">通过 vsphere-clone 构建业务虚拟机并导出 OVF&#x2F;OVA</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#argo-workflow-%E5%92%8C-k3s"><span class="nav-number">4.</span> <span class="nav-text">argo-workflow 和 k3s</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#argo-workflow"><span class="nav-number">4.1.</span> <span class="nav-text">argo-workflow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#k8s-and-k3s"><span class="nav-number">4.2.</span> <span class="nav-text">k8s and k3s</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">5.</span> <span class="nav-text">其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%84%9F%E5%8F%97"><span class="nav-number">5.1.</span> <span class="nav-text">使用感受</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OVA-%E6%A0%BC%E5%BC%8F"><span class="nav-number">5.2.</span> <span class="nav-text">OVA 格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-open-vm-tool-%E5%A4%B1%E8%B4%A5"><span class="nav-number">5.3.</span> <span class="nav-text">安装 open-vm-tool 失败</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%8F%E5%B0%91%E5%AF%BC%E5%87%BA%E5%90%8E-vmdk-%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F"><span class="nav-number">5.4.</span> <span class="nav-text">减少导出后 vmdk 文件大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Photon3"><span class="nav-number">5.5.</span> <span class="nav-text">Photon3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#goss"><span class="nav-number">5.6.</span> <span class="nav-text">goss</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5-OVA-%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%90%8E-Pod-%E7%8A%B6%E6%80%81%E5%BC%82%E5%B8%B8"><span class="nav-number">5.7.</span> <span class="nav-text">导入 OVA 虚拟机后 Pod 状态异常</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Packer-%E7%9B%B8%E5%85%B3"><span class="nav-number">6.1.</span> <span class="nav-text">Packer 相关</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">120</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">155</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail → mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/packer-vsphere-example.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="使用 Packer 构建虚拟机镜像踩的坑 | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          使用 Packer 构建虚拟机镜像踩的坑
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-25 2022-05-25T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2022-05-25T00:00:00+08:00">2022-05-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/packer-vsphere-example.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="packer-vsphere-example.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>39k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>35 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>不久前写过一篇博客《<a href="https://blog.k8s.li/redfish-esxi-os-installer.html">使用 Redfish 自动化安装 ESXi OS</a>》分享了如何使用 Redfish 给物理服务器自动化安装 ESXi OS。虽然在我们内部做到了一键安装&#x2F;重装 ESXi OS，但想要将这套方案应用在客户的私有云机房环境中还是有很大的难度。</p>
<p>首先这套工具必须运行在 Linux 中才行，对于 Bare Metal 裸服务器来讲还没有安装任何 OS，这就引申出了鸡生蛋蛋生鸡的尴尬难题。虽然可以给其中的一台物理服务器安装上一个 Linux 发行版比如 CentOS，然后再将这套自动化安装 ESXi OS 的工具搭建上去，但这会额外占用一台物理服务器，客户也肯定不愿意接受。</p>
<p>真实的实施场景中，可行的方案就是将这套工具运行在实施人员的笔记本电脑或者客户提供的台式机上。这又引申出了一个另外的难题：实施人员的笔记本电脑或者客户提供的台式机运行的大都是 Windows 系统，在 Windows 上安装 Ansible、Make、Python3 等一堆依赖，想想就不太现实，而且稳定性和兼容性很难得到保障，以及开发环境和运行环境不一致导致一些其他的奇奇怪怪的问题。虽然该工具支持容器化运行能够解决开发环境和运行环境不一致的问题，但在 Windows 上安装 docker 也比较繁琐和麻烦。</p>
<p>这时候就要搬出计算机科学中的至理名言: <strong>计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决</strong>。</p>
<blockquote>
<p><strong>Any problem in computer science can be solved by another layer of indirection.</strong></p>
</blockquote>
<p>既然我们这套工具目前只能在 Linux 上稳定运行，那么我们不如就将这套工具和它所运行的环境封装在一个“中间容器”里，比如虚拟机。使用者只需要安装像 <a target="_blank" rel="noopener" href="https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html">VMware Workstation</a> 或者 <a target="_blank" rel="noopener" href="https://www.virtualbox.org/">Oracle VirtualBox</a> 虚拟化管理软件运行这台虚拟机不就行了。一切皆可套娃（🤣</p>
<p>其实原理就像 docker 容器那样，我们将这套工具和它所依赖的运行环境在构建虚拟机的时候将它们全部打包在一起，使用者只需要想办法将这个虚拟机运行起来，就能一键使用我们这个工具，不必再手动安装 Ansible 和 Python3 等一堆依赖了，真正做到开箱即用。</p>
<p>于是本文分享一下如何使用 <a target="_blank" rel="noopener" href="https://www.packer.io/">Packer</a> 在 <a target="_blank" rel="noopener" href="https://www.vmware.com/products/vsphere.html">VMware vSphere</a> 环境上构建虚拟机镜像的方案，以及如何在这个虚拟机中运行一个 k3s 集群，然后通过 <a target="_blank" rel="noopener" href="https://github.com/argoproj/argo-workflows">argo-workflow</a> 工作流引擎运行 <a target="_blank" rel="noopener" href="https://github.com/muzi502/redfish-esxi-os-installer">redfish-esxi-os-installer</a> 来对裸金属服务器进行自动化安装 ESXi OS 的操作。</p>
<h2 id="劝退三连-😂"><a href="#劝退三连-😂" class="headerlink" title="劝退三连 😂"></a>劝退三连 😂</h2><ul>
<li>提前下载好 Base OS 的 ISO 镜像，比如 <a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso">CentOS-7-x86_64-Minimal-2009.iso</a></li>
<li>需要一个 <a target="_blank" rel="noopener" href="https://www.vmware.com/products/vcenter-server.html">vCenter Server</a> 以及一台 <a target="_blank" rel="noopener" href="https://www.vmware.com/products/esxi-and-esx.html">VMware ESXi</a> 主机</li>
<li>ESXi 的 VM Network 网络中需要有一台 DHCP 服务器用于给 VM 分配 IP</li>
</ul>
<h2 id="Packer"><a href="#Packer" class="headerlink" title="Packer"></a>Packer</h2><p>很早之前玩儿 VMware ESXi 的时候还没有接触到 Packer，那时候只能使用<a href="https://blog.k8s.li/esxi-vmbase.html">手搓虚拟机模版</a>的方式，费时费力还容易出错，下面就介绍一下这个自动化构建虚拟机镜像的工具。</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><a target="_blank" rel="noopener" href="https://github.com/hashicorp/packer">Packer</a> 是 <a target="_blank" rel="noopener" href="https://www.hashicorp.com/">hashicorp</a> 公司开源的一个虚拟机镜像构建工具，与它类似的工具还有 <a target="_blank" rel="noopener" href="https://github.com/openstack/diskimage-builder">OpenStack diskimage-builder</a>、<a target="_blank" rel="noopener" href="https://aws.amazon.com/image-builder/">AWS EC2 Image Builder</a> ，但是这两个只支持自家的平台。Packer 能够支持主流的公有云、私有云以及混合云，比它俩高到不知道哪里去了。可以这么来理解：Packer 在 IaaS 虚拟化领域的地位就像 Docker 在 PaaS 容器虚拟中那样重要，一个是虚拟机镜像的构建，另一个容器镜像的构建，有趣的是两者都是在 2013 年成立的项目。</p>
<p>Kubernetes 社区的 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/image-builder">image-builder</a> 项目就是使用 Packer 构建一些公有云及私有云的虚拟机模版提供给 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> 项目使用，十分推荐大家去看下这个项目的代码，刚开始我也是从这个项目熟悉 Packer 的，并从中抄袭借鉴了很多内容 😅。</p>
<p>下面就介绍一下 Packer 的基本使用方法</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>对于 Linux 发行版，建议直接下载二进制安装包来安装，通过包管理器安装感觉有点麻烦</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">wget</span> https://releases.hashicorp.com/packer/1.8.0/packer_1.8.0_linux_amd64.zip
$ <span class="token function">unzip</span> packer_1.8.0_linux_amd64.zip
$ <span class="token function">mv</span> packer /usr/local/bin/packer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>如果是 macOS 用户直接 <code>brew install packer</code> 命令一把梭就能安装好</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>不同于 Docker 有一个 Dockerfile 文件来定义如何构建容器镜像，Packer 构建虚拟机镜像则是由一系列的配置文件缝合而成，主要由 <a target="_blank" rel="noopener" href="https://www.packer.io/docs/terminology#builders">Builders</a> 、<a target="_blank" rel="noopener" href="https://www.packer.io/docs/terminology#provisioners">Provisioners</a> 、<a target="_blank" rel="noopener" href="https://www.packer.io/docs/terminology#post-processors">Post-processors</a> 这三部分组成。其中 Builder 主要是与 IaaS Provider 构建器相关的一些参数；Provisioner 用来配置构建过程中需要运行的一些任务；Post-processors 用于配置构建动作完成后的一些后处理操作；下面就依次介绍一下这几个配置的详细使用说明：</p>
<p>另外 Packer 推荐的配置语法是 <a target="_blank" rel="noopener" href="https://www.packer.io/guides/hcl">HCL2</a>，但个人觉着 HCL 的语法风格怪怪的，不如 json 那样整洁好看 😅，因此下面我统一使用 json 来进行配置，其实参数都一样，只是格式不相同而已。</p>
<h4 id="vars-x2F-var-file"><a href="#vars-x2F-var-file" class="headerlink" title="vars&#x2F;var-file"></a>vars&#x2F;var-file</h4><p>Packer 的变量配置文件有点类似于 Ansible 中的 vars。一个比较合理的方式就是按照每个参数的作用域进行分类整理，将它们统一放在一个单独的配置文件中，这样维护起来会更方便一些。参考了 image-builder 项目中的 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/image-builder/tree/master/images/capi/packer/ova">ova</a> 构建后我根据参数的不同作用划分成了如下几个配置文件：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/vcenter.json">vcenter.json</a>：主要用于配置一些与 vCenter 相关的参数，比如 datastore、datacenter、resource_pool、vcenter_server 等；另外像 vcenter 的用户名和密码建议使用环境变量的方式，避免明文编码在文件当中；</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"folder"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>
  <span class="token property">"resource_pool"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>
  <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>
  <span class="token property">"datacenter"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>
  <span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>
  <span class="token property">"convert_to_template"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
  <span class="token property">"create_snapshot"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
  <span class="token property">"linked_clone"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
  <span class="token property">"network"</span><span class="token operator">:</span> <span class="token string">"VM Network"</span><span class="token punctuation">,</span>
  <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"password"</span><span class="token punctuation">,</span>
  <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"administrator@vsphere.local"</span><span class="token punctuation">,</span>
  <span class="token property">"vcenter_server"</span><span class="token operator">:</span> <span class="token string">"vcenter.k8s.li"</span><span class="token punctuation">,</span>
  <span class="token property">"insecure_connection"</span><span class="token operator">:</span> <span class="token string">"true"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/centos7.json">centos7.json</a>：主要用于配置一些通过 ISO 安装 CentOS 的参数，比如 ISO 的下载地址、ISO 的 checksum、kickstart 文件路径、关机命令、isolinux 启动参数等；</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"boot_command_prefix"</span><span class="token operator">:</span> <span class="token string">"&lt;tab> text ks=hd:fd0:"</span><span class="token punctuation">,</span>
  <span class="token property">"boot_command_suffix"</span><span class="token operator">:</span> <span class="token string">"/7/ks.cfg&lt;enter>&lt;wait>"</span><span class="token punctuation">,</span>
  <span class="token property">"boot_media_path"</span><span class="token operator">:</span> <span class="token string">"/HTTP"</span><span class="token punctuation">,</span>
  <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"centos-7"</span><span class="token punctuation">,</span>
  <span class="token property">"distro_arch"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>
  <span class="token property">"distro_name"</span><span class="token operator">:</span> <span class="token string">"centos"</span><span class="token punctuation">,</span>
  <span class="token property">"distro_version"</span><span class="token operator">:</span> <span class="token string">"7"</span><span class="token punctuation">,</span>
  <span class="token property">"floppy_dirs"</span><span class="token operator">:</span> <span class="token string">"./kickstart/&#123;&#123;user `distro_name`&#125;&#125;/http/"</span><span class="token punctuation">,</span>
  <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"centos7-64"</span><span class="token punctuation">,</span>
  <span class="token property">"iso_checksum"</span><span class="token operator">:</span> <span class="token string">"07b94e6b1a0b0260b94c83d6bb76b26bf7a310dc78d7a9c7432809fb9bc6194a"</span><span class="token punctuation">,</span>
  <span class="token property">"iso_checksum_type"</span><span class="token operator">:</span> <span class="token string">"sha256"</span><span class="token punctuation">,</span>
  <span class="token property">"iso_url"</span><span class="token operator">:</span> <span class="token string">"https://mirrors.edge.kernel.org/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso"</span><span class="token punctuation">,</span>
  <span class="token property">"os_display_name"</span><span class="token operator">:</span> <span class="token string">"CentOS 7"</span><span class="token punctuation">,</span>
  <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"shutdown -h now"</span><span class="token punctuation">,</span>
  <span class="token property">"vsphere_guest_os_type"</span><span class="token operator">:</span> <span class="token string">"centos7_64Guest"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/photon3.json">photon3.json</a>：主要用于配置一些通过 ISO 安装 Photon3 OS 的参数，和上面的 centos7.json 作用基本一致；</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"boot_command_prefix"</span><span class="token operator">:</span> <span class="token string">"&lt;esc>&lt;wait> vmlinuz initrd=initrd.img root/dev/ram0 loglevel=3 photon.media=cdrom ks="</span><span class="token punctuation">,</span>
  <span class="token property">"boot_command_suffix"</span><span class="token operator">:</span> <span class="token string">"/3/ks.json&lt;enter>&lt;wait>"</span><span class="token punctuation">,</span>
  <span class="token property">"boot_media_path"</span><span class="token operator">:</span> <span class="token string">"http://&#123;&#123; .HTTPIP &#125;&#125;:&#123;&#123; .HTTPPort &#125;&#125;"</span><span class="token punctuation">,</span>
  <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"photon-3"</span><span class="token punctuation">,</span>
  <span class="token property">"distro_arch"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>
  <span class="token property">"distro_name"</span><span class="token operator">:</span> <span class="token string">"photon"</span><span class="token punctuation">,</span>
  <span class="token property">"distro_version"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>
  <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"vmware-photon-64"</span><span class="token punctuation">,</span>
  <span class="token property">"http_directory"</span><span class="token operator">:</span> <span class="token string">"./kickstart/&#123;&#123;user `distro_name`&#125;&#125;/http/"</span><span class="token punctuation">,</span>
  <span class="token property">"iso_checksum"</span><span class="token operator">:</span> <span class="token string">"c2883a42e402a2330d9c39b4d1e071cf9b3b5898"</span><span class="token punctuation">,</span>
  <span class="token property">"iso_checksum_type"</span><span class="token operator">:</span> <span class="token string">"sha1"</span><span class="token punctuation">,</span>
  <span class="token property">"iso_url"</span><span class="token operator">:</span> <span class="token string">"https://packages.vmware.com/photon/3.0/Rev3/iso/photon-minimal-3.0-a383732.iso"</span><span class="token punctuation">,</span>
  <span class="token property">"os_display_name"</span><span class="token operator">:</span> <span class="token string">"VMware Photon OS 64-bit"</span><span class="token punctuation">,</span>
  <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"shutdown now"</span><span class="token punctuation">,</span>
  <span class="token property">"vsphere_guest_os_type"</span><span class="token operator">:</span> <span class="token string">"vmwarePhoton64Guest"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/common.json">common.json</a>：一些公共参数，比如虚拟机的 ssh 用户名和密码（要和 kickstart 中设置的保持一致）、虚拟机的一些硬件配置如 CPU、内存、硬盘、虚拟机版本、网卡类型、存储控制器类型等；</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"ssh_username"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
  <span class="token property">"ssh_password"</span><span class="token operator">:</span> <span class="token string">"password"</span><span class="token punctuation">,</span>
  <span class="token property">"boot_wait"</span><span class="token operator">:</span> <span class="token string">"15s"</span><span class="token punctuation">,</span>
  <span class="token property">"disk_controller_type"</span><span class="token operator">:</span> <span class="token string">"lsilogic"</span><span class="token punctuation">,</span>
  <span class="token property">"disk_thin_provisioned"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
  <span class="token property">"disk_type_id"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
  <span class="token property">"firmware"</span><span class="token operator">:</span> <span class="token string">"bios"</span><span class="token punctuation">,</span>
  <span class="token property">"cpu"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
  <span class="token property">"cpu_cores"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
  <span class="token property">"memory"</span><span class="token operator">:</span> <span class="token string">"4096"</span><span class="token punctuation">,</span>
  <span class="token property">"disk_size"</span><span class="token operator">:</span> <span class="token string">"65536"</span><span class="token punctuation">,</span>
  <span class="token property">"network_card"</span><span class="token operator">:</span> <span class="token string">"e1000"</span><span class="token punctuation">,</span>
  <span class="token property">"ssh_timeout"</span><span class="token operator">:</span> <span class="token string">"3m"</span><span class="token punctuation">,</span>
  <span class="token property">"vmx_version"</span><span class="token operator">:</span> <span class="token string">"14"</span><span class="token punctuation">,</span>
  <span class="token property">"base_build_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `template`&#125;&#125;"</span><span class="token punctuation">,</span>
  <span class="token property">"build_timestamp"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;timestamp&#125;&#125;"</span><span class="token punctuation">,</span>
  <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"k3s"</span><span class="token punctuation">,</span>
  <span class="token property">"build_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ova_name`&#125;&#125;"</span><span class="token punctuation">,</span>
  <span class="token property">"export_manifest"</span><span class="token operator">:</span> <span class="token string">"none"</span><span class="token punctuation">,</span>
  <span class="token property">"output_dir"</span><span class="token operator">:</span> <span class="token string">"./output/&#123;&#123;user `build_version`&#125;&#125;"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Builder"><a href="#Builder" class="headerlink" title="Builder"></a>Builder</h4><p>Builder 就是告诉 Packer 要使用什么类型的构建器构建什么样的虚拟机镜像，主要是与底层 IaaS 资源提供商相关的配置。比如 <a target="_blank" rel="noopener" href="https://www.packer.io/plugins/builders/vsphere">vSphere Builder</a> 中有如下两种构建器：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/docs/builders/vsphere/vsphere-iso">vsphere-iso</a> 从 ISO 安装 OS 开始构建，通常情况下构建为一个虚拟机或虚拟机模版</li>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/docs/builders/vsphere/vsphere-clone">vsphere-clone</a> 通过 clone 虚拟机的方式进行构建，通常情况下构建产物为导出后的 OVF&#x2F;OVA 文件</li>
</ul>
<p>不同类型的 Builder 配置参数也会有所不同，每个参数的详细用途和说明可以参考 <a target="_blank" rel="noopener" href="https://www.packer.io/plugins">Packer 官方的文档</a>，在这里就不一一说明了。因为 Packer 的参数配置是在是太多太复杂了，很难三言两语讲清楚。最佳的方式就是阅读官方的文档和一些其他项目的实现方式，照葫芦画瓢学就行。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/builder.json">builders.json</a>：里面的配置参数大多都是引用的 var-file 中的参数，将这些参数单独抽出来的好处就是不同的 builder 之间可以复用一些公共参数。比如 vsphere-iso 和 vsphere-clone 这两种不同的 builder 与 vCenter 相关的 datacenter、datastore、vcenter_server 等参数都是其实相同的。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/docs/builders/vsphere/vsphere-iso">vsphere-iso</a> ：通过 ISO 安装 OS 构建一个虚拟机或虚拟机模版</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"builders"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"CPUs"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"RAM"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `memory`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"boot_command"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"&#123;&#123;user `boot_command_prefix`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token string">"&#123;&#123;user `boot_media_path`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token string">"&#123;&#123;user `boot_command_suffix`&#125;&#125;"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"boot_wait"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `boot_wait`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cluster`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"communicator"</span><span class="token operator">:</span> <span class="token string">"ssh"</span><span class="token punctuation">,</span>
      <span class="token property">"convert_to_template"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `convert_to_template`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"cpu_cores"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu_cores`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"create_snapshot"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `create_snapshot`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"datacenter"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datacenter`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datastore`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"disk_controller_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_controller_type`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"firmware"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `firmware`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"floppy_dirs"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `floppy_dirs`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"folder"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `folder`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vsphere_guest_os_type`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `host`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"http_directory"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `http_directory`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"insecure_connection"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `insecure_connection`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"iso_checksum"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `iso_checksum_type`&#125;&#125;:&#123;&#123;user `iso_checksum`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"iso_urls"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `iso_url`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"vsphere-iso-base"</span><span class="token punctuation">,</span>
      <span class="token property">"network_adapters"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
          <span class="token property">"network"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `network`&#125;&#125;"</span><span class="token punctuation">,</span>
          <span class="token property">"network_card"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `network_card`&#125;&#125;"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `password`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"echo '&#123;&#123;user `ssh_password`&#125;&#125;' | sudo -S -E sh -c '&#123;&#123;user `shutdown_command`&#125;&#125;'"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_clear_authorized_keys"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_password`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_timeout"</span><span class="token operator">:</span> <span class="token string">"4h"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_username`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"storage"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
          <span class="token property">"disk_size"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_size`&#125;&#125;"</span><span class="token punctuation">,</span>
          <span class="token property">"disk_thin_provisioned"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_thin_provisioned`&#125;&#125;"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"vsphere-iso"</span><span class="token punctuation">,</span>
      <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `username`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"vcenter_server"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vcenter_server`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"vm_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `base_build_version`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"vm_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vmx_version`&#125;&#125;"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/docs/builders/vsphere/vsphere-clone">vsphere-clone</a>：通过 clone 虚拟机构建一个虚拟机，并导出虚拟机 OVF 模版</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"builders"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"CPUs"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"RAM"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `memory`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cluster`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"communicator"</span><span class="token operator">:</span> <span class="token string">"ssh"</span><span class="token punctuation">,</span>
      <span class="token property">"convert_to_template"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `convert_to_template`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"cpu_cores"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu_cores`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"create_snapshot"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `create_snapshot`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"datacenter"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datacenter`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datastore`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"export"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"force"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">"manifest"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `export_manifest`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"output_directory"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `output_dir`&#125;&#125;"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"folder"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `folder`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `host`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"insecure_connection"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `insecure_connection`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"linked_clone"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `linked_clone`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"vsphere-clone"</span><span class="token punctuation">,</span>
      <span class="token property">"network"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `network`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `password`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"echo '&#123;&#123;user `ssh_password`&#125;&#125;' | sudo -S -E sh -c '&#123;&#123;user `shutdown_command`&#125;&#125;'"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_password`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_timeout"</span><span class="token operator">:</span> <span class="token string">"4h"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_username`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"template"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `template`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"vsphere-clone"</span><span class="token punctuation">,</span>
      <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `username`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"vcenter_server"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vcenter_server`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"vm_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `build_version`&#125;&#125;"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Provisioner"><a href="#Provisioner" class="headerlink" title="Provisioner"></a><a target="_blank" rel="noopener" href="https://www.packer.io/docs/provisioners">Provisioner</a></h4><p>Provisioner 就是告诉 Packer 要如何构建镜像，有点类似于 Dockerile 中的 RUN&#x2F;COPY&#x2F;ADD 等指令，用于执行一些命令&#x2F;脚本、往虚拟机里添加一些文件、调用第三方插件执行一些操作等。</p>
<p>在这个配置文件中我先使用 file 模块将一些脚本和依赖文件上传到虚拟机中，然后使用 shell 模块在虚拟机中执行 install.sh 安装脚本。如果构建的 builder 比较多，比如需要支持多个 Linux 发行版，这种场景建议使用 Ansible。由于我在 ISO 安装 OS 的构建流程中已经将一些与 OS 发行版相关的操作完成了，在这里使用 shell 执行的操作不需要区分哪个 Linux 发行版，所以就没有使用 ansible。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"provisioners"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>
      <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"scripts"</span><span class="token punctuation">,</span>
      <span class="token property">"destination"</span><span class="token operator">:</span> <span class="token string">"/root"</span><span class="token punctuation">,</span>
      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"vsphere-iso-base"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>
      <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"resources"</span><span class="token punctuation">,</span>
      <span class="token property">"destination"</span><span class="token operator">:</span> <span class="token string">"/root"</span><span class="token punctuation">,</span>
      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"vsphere-iso-base"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"shell"</span><span class="token punctuation">,</span>
      <span class="token property">"environment_vars"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"INSECURE_REGISTRY=&#123;&#123;user `insecure_registry`&#125;&#125;"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"inline"</span><span class="token operator">:</span> <span class="token string">"bash /root/scripts/install.sh"</span><span class="token punctuation">,</span>
      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"vsphere-iso-base"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="post-processors"><a href="#post-processors" class="headerlink" title="post-processors"></a>post-processors</h3><p>一些构建后的操作， 比如 <code>&quot;type&quot;: &quot;manifest&quot;</code> 可以导出一些构建过程中的配置参数，给后续的其他操作来使用。再比如 <code>&quot;type&quot;: &quot;shell-local&quot;</code> 就是执行一些 shell 脚本，在这里就是执行一个 Python 脚本将 OVF 转换成 OVA。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"post-processors"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"custom_data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"release_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `release_version`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"build_date"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;isotime&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `build_name`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"build_timestamp"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `build_timestamp`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"build_type"</span><span class="token operator">:</span> <span class="token string">"node"</span><span class="token punctuation">,</span>
        <span class="token property">"cpu"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"memory"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `memory`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"disk_size"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_size`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"distro_arch"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `distro_arch` &#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"distro_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `distro_name` &#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"distro_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `distro_version` &#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"firmware"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `firmware`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `guest_os_type`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"os_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `os_display_name`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"vsphere_guest_os_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vsphere_guest_os_type`&#125;&#125;"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"packer-manifest"</span><span class="token punctuation">,</span>
      <span class="token property">"output"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `output_dir`&#125;&#125;/packer-manifest.json"</span><span class="token punctuation">,</span>
      <span class="token property">"strip_path"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"manifest"</span><span class="token punctuation">,</span>
      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"vsphere-iso-base"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"inline"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"python3 ./scripts/ova.py --vmx &#123;&#123;user `vmx_version`&#125;&#125; --ovf_template &#123;&#123;user `ovf_template`&#125;&#125; --build_dir=&#123;&#123;user `output_dir`&#125;&#125;"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"vsphere-iso-base"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"vsphere"</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"shell-local"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h3><p><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example">packer-vsphere-example</a> 项目的目录结构如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>/packer-vsphere-example
├── kickstart        <span class="token comment"># kickstart 配置文件存放目录</span>
├── Makefile         <span class="token comment"># makefile，make 命令的操作的入口</span>
├── packer           <span class="token comment"># packer 配置文件</span>
│   ├── builder.json <span class="token comment"># packer builder 配置文件</span>
│   ├── centos7.json <span class="token comment"># centos iso 安装 os 的配置</span>
│   ├── common.json  <span class="token comment"># 一些公共配置参数</span>
│   ├── photon3.json <span class="token comment"># photon3 iso 安装 os 的配置</span>
│   └── vcenter.json <span class="token comment"># vcenter 相关的配置</span>
├── resources        <span class="token comment"># 一些 k8s manifests 文件</span>
└── scripts          <span class="token comment"># 构建过程中需要用到的脚本文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>与 docker 类似，packer 执行构建操作的子命令同样也是 build，即 <code>packer build</code>，不过 packer build 命令支持的选项并没有 docker 那么丰富。最核心选项就是 -except, -only, -var,  -var-file 这几个：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ packer build
Options:

	<span class="token comment"># 控制终端颜色输出</span>
  <span class="token parameter variable">-color</span><span class="token operator">=</span>false                  Disable color output. <span class="token punctuation">(</span>Default: color<span class="token punctuation">)</span>
  <span class="token comment"># debug 模式，类似于断点的方式运行</span>
  <span class="token parameter variable">-debug</span>                        Debug mode enabled <span class="token keyword">for</span> builds.
  <span class="token comment"># 排除一些 builder，有点类似于 ansible 的 --skip-tags</span>
  <span class="token parameter variable">-except</span><span class="token operator">=</span>foo,bar,baz           Run all builds and post-processors other than these.
  <span class="token comment"># 指定运行某些 builder，有点类似于 ansible 的 --tags</span>
  <span class="token parameter variable">-only</span><span class="token operator">=</span>foo,bar,baz             Build only the specified builds.
  <span class="token comment"># 强制构建，如果构建目标已经存在则强制删除重新构建</span>
  <span class="token parameter variable">-force</span>                        Force a build to <span class="token builtin class-name">continue</span> <span class="token keyword">if</span> artifacts exist, deletes existing artifacts.
  -machine-readable             Produce machine-readable output.
  <span class="token comment"># 出现错误之后的动作，cleanup 清理所有操作、abort 中断执行、ask 询问、</span>
  -on-error<span class="token operator">=</span><span class="token punctuation">[</span>cleanup<span class="token operator">|</span>abort<span class="token operator">|</span>ask<span class="token operator">|</span>run-cleanup-provisioner<span class="token punctuation">]</span> If the build fails do: clean up <span class="token punctuation">(</span>default<span class="token punctuation">)</span>, abort, ask, or run-cleanup-provisioner.
  <span class="token comment"># 并行运行的 builder 数量，默认没有限制，有点类似于 ansible 中的 --forks 参数</span>
  -parallel-builds<span class="token operator">=</span><span class="token number">1</span>            Number of builds to run <span class="token keyword">in</span> parallel. <span class="token number">1</span> disables parallelization. <span class="token number">0</span> means no limit <span class="token punctuation">(</span>Default: <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token comment"># UI 输出的时间戳</span>
  -timestamp-ui                 Enable prefixing of each ui output with an RFC3339 timestamp.
  <span class="token comment"># 变量参数，有点类似于 ansible 的 -e 选项</span>
  <span class="token parameter variable">-var</span> <span class="token string">'key=value'</span>              Variable <span class="token keyword">for</span> templates, can be used multiple times.
  <span class="token comment"># 变量文件，有点类似于 ansible 的 -e@ 选项</span>
  -var-file<span class="token operator">=</span>path                JSON or HCL2 <span class="token function">file</span> containing user variables.

<span class="token comment"># 指定一些 var 参数以及 var-file 文件，最后一个参数是 builder 的配置文件路径</span>
$ packer build  <span class="token parameter variable">--var</span> <span class="token assign-left variable">ova_name</span><span class="token operator">=</span>k3s-photon3-c4ca93f <span class="token parameter variable">--var</span> <span class="token assign-left variable">release_version</span><span class="token operator">=</span>c4ca93f <span class="token parameter variable">--var</span> <span class="token assign-left variable">ovf_template</span><span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/scripts/ovf_template.xml <span class="token parameter variable">--var</span> <span class="token assign-left variable">template</span><span class="token operator">=</span>base-os-photon3 <span class="token parameter variable">--var</span> <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token variable">$&#123;VCENTER_USERNAME&#125;</span> <span class="token parameter variable">--var</span> <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token variable">$&#123;VCENTER_PASSWORD&#125;</span> <span class="token parameter variable">--var</span> <span class="token assign-left variable">vcenter_server</span><span class="token operator">=</span><span class="token variable">$&#123;VCENTER_SERVER&#125;</span> <span class="token parameter variable">--var</span> <span class="token assign-left variable">build_name</span><span class="token operator">=</span>k3s-photon3 <span class="token parameter variable">--var</span> <span class="token assign-left variable">output_dir</span><span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/output/k3s-photon3-c4ca93f <span class="token parameter variable">-only</span> vsphere-clone -var-file<span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/vcenter.json -var-file<span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/photon3.json -var-file<span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/common.json /root/usr/src/github.com/muzi502/packer-vsphere-example/packer/builder.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>上面那个又长又臭的 packer build 命令我们在 <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/Makefile">Makefile</a> 里封装一下，那么多的参数选项手动输起来能把人气疯 😂</p>
<ul>
<li>首先定义一些默认的参数，比如构建版本、构建时间、base 模版名称、导出 ova 文件名称等等。</li>
</ul>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># Ensure Make is run with bash shell as some syntax below is bash-specific</span>
SHELL<span class="token operator">:=</span>/usr/bin/env bash
.DEFAULT_GOAL<span class="token operator">:=</span>help

<span class="token comment"># Full directory of where the Makefile resides</span>
ROOT_DIR <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> dirname <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">realpath</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">firstword</span> <span class="token variable">$</span><span class="token punctuation">(</span>MAKEFILE_LIST<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

RELEASE_VERSION       <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> git describe --tags --always --dirty<span class="token punctuation">)</span>
RELEASE_TIME          <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> date -u +<span class="token string">'%Y-%m-%dT%H:%M:%SZ'</span><span class="token punctuation">)</span>
PACKER_IMAGE          <span class="token operator">?=</span> hashicorp/packer<span class="token punctuation">:</span>1.8
PACKER_CONFIG_DIR     <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/packer
PACKER_FORCE          <span class="token operator">?=</span> false
PACKER_OVA_PREFIX     <span class="token operator">?=</span> k3s
PACKER_BASE_OS        <span class="token operator">?=</span> centos7
PACKER_OUTPUT_DIR     <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/output
PACKER_TEMPLATE_NAME  <span class="token operator">?=</span> base-os-<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span>
OVF_TEMPLATE          <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/scripts/ovf_template.xml
PACKER_OVA_NAME       <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_PREFIX<span class="token punctuation">)</span>-<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span>-<span class="token variable">$</span><span class="token punctuation">(</span>RELEASE_VERSION<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>然后定义 vars 和 var-file 参数</li>
</ul>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># 是否为强制构建，增加 force 参数</span>
<span class="token keyword">ifeq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_FORCE<span class="token punctuation">)</span>, true<span class="token punctuation">)</span>
  PACKER_FORCE_ARG <span class="token operator">=</span> --force<span class="token operator">=</span>true
<span class="token keyword">endif</span>

<span class="token comment"># 定义 vars 可变参数，比如 vcenter 用户名、密码 等参数</span>
PACKER_VARS <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_FORCE_ARG<span class="token punctuation">)</span> \            <span class="token comment"># 是否强制构建</span>
	--var ova_name<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_NAME<span class="token punctuation">)</span> \          <span class="token comment"># OVA 文件名</span>
	--var release_version<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>RELEASE_VERSION<span class="token punctuation">)</span> \   <span class="token comment"># 发布版本</span>
	--var ovf_template<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>OVF_TEMPLATE<span class="token punctuation">)</span> \         <span class="token comment"># OVF 模版文件</span>
	--var template<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_TEMPLATE_NAME<span class="token punctuation">)</span> \     <span class="token comment"># OVA 的 base 虚拟机模版名称</span>
	--var username<span class="token operator">=</span><span class="token variable">$$</span><span class="token punctuation">&#123;</span>VCENTER_USERNAME<span class="token punctuation">&#125;</span> \        <span class="token comment"># vCenter 用户名（环境变量）</span>
	--var password<span class="token operator">=</span><span class="token variable">$$</span><span class="token punctuation">&#123;</span>VCENTER_PASSWORD<span class="token punctuation">&#125;</span> \        <span class="token comment"># vCenter 密码（环境变量）</span>
	--var vcenter_server<span class="token operator">=</span><span class="token variable">$$</span><span class="token punctuation">&#123;</span>VCENTER_SERVER<span class="token punctuation">&#125;</span> \    <span class="token comment"># vCenter 访问地址（环境变量）</span>
	--var build_name<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_PREFIX<span class="token punctuation">)</span>-<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span> \  <span class="token comment"># 构建名称</span>
	--var output_dir<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OUTPUT_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_NAME<span class="token punctuation">)</span>   <span class="token comment"># OVA 导出的目录</span>

<span class="token comment"># 定义 var-file 参数</span>
PACKER_VAR_FILES <span class="token operator">=</span> -var-file<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/vcenter.json \ <span class="token comment"># vCenter 的参数配置</span>
	-var-file<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span>.json \        <span class="token comment"># OS 的参数配置</span>
	-var-file<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/common.json                     <span class="token comment"># 一些公共配置</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>最后定义 make targrt</li>
</ul>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> build-template
<span class="token comment"># 通过 ISO 安装 OS 构建一个 base 虚拟机</span>
<span class="token target symbol">build-template</span><span class="token punctuation">:</span> <span class="token comment">## build the base os template by iso</span>
	packer build <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VARS<span class="token punctuation">)</span> -only vsphere-iso-base <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VAR_FILES<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/builder.json

<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> build-ovf
<span class="token comment"># 通过 clone 方式构建并导出 OVF/OVA</span>
<span class="token target symbol">build-ovf</span><span class="token punctuation">:</span> <span class="token comment">## build the ovf template by clone the base os template</span>
	packer build <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VARS<span class="token punctuation">)</span> -only vsphere-clone <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VAR_FILES<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/builder.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>构建 BASE 模版</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 通过 PACKER_BASE_OS 参数设置 base os 是 photon3 还是 centos7</span>
$ <span class="token function">make</span> build-template <span class="token assign-left variable">PACKER_BASE_OS</span><span class="token operator">=</span>photon3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>构建 OVF 模版并导出为 OVA</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 通过 PACKER_BASE_OS 参数设置 base os 是 photon3 还是 centos7</span>
$ <span class="token function">make</span> build-ovf <span class="token assign-left variable">PACKER_BASE_OS</span><span class="token operator">=</span>photon3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="构建流程"><a href="#构建流程" class="headerlink" title="构建流程"></a>构建流程</h2><p>将 Packer 的配置文件以及 Makefile 封装好之后，我们就可以运行 <code>make build-template</code> 和 <code>make build-ovf</code> 命令来构建虚拟机模版了，整体的构建流程如下：</p>
<ul>
<li>先使用 ISO 构建一个与业务无关的 base 虚拟机</li>
<li>在 base 虚拟机之上通过 vsphere-clone 方式构建业务虚拟机</li>
<li>导出 OVF 虚拟机文件，打包成 OVA 格式的虚拟机模版</li>
</ul>
<h3 id="通过-vsphere-iso-构建-Base-虚拟机"><a href="#通过-vsphere-iso-构建-Base-虚拟机" class="headerlink" title="通过 vsphere-iso 构建 Base 虚拟机"></a>通过 vsphere-iso 构建 Base 虚拟机</h3><p>base 虚拟机有点类似于 Dockerfile 中的 FROM base 镜像。在 Packer 中我们可以把一些很少会改动的内容做成一个 base 虚拟机。然后从这个 base 虚拟机克隆出一台新的虚拟机来完成接下来的构建流程，这样能够节省整体的构建耗时，使得构建效率更高一些。</p>
<ul>
<li>centos7 构建输出日志</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vsphere-iso-base: output will be <span class="token keyword">in</span> this color.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: File /root/.cache/packer/e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso already uploaded<span class="token punctuation">;</span> continuing
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: File <span class="token punctuation">[</span>Packer<span class="token punctuation">]</span> packer_cache//e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso already exists<span class="token punctuation">;</span> skipping upload.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: the vm/template Packer/base-os-centos7 already exists, but deleting it due to <span class="token parameter variable">-force</span> flag
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating VM<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Customizing hardware<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Mounting ISO images<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding configuration parameters<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating floppy disk<span class="token punctuation">..</span>.
    vsphere-iso-base: Copying files flatly from floppy_files
    vsphere-iso-base: Done copying files from floppy_files
    vsphere-iso-base: Collecting paths from floppy_dirs
    vsphere-iso-base: Resulting paths from floppy_dirs <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>./kickstart/centos/http/<span class="token punctuation">]</span>
    vsphere-iso-base: Recursively copying <span class="token builtin class-name">:</span> ./kickstart/centos/http/
    vsphere-iso-base: Done copying paths from floppy_dirs
    vsphere-iso-base: Copying files from floppy_content
    vsphere-iso-base: Done copying files from floppy_content
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Uploading created floppy image
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding generated Floppy<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Set boot order temporary<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Power on VM<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting 15s <span class="token keyword">for</span> boot<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Typing boot command<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting <span class="token keyword">for</span> IP<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: IP address: <span class="token number">192.168</span>.29.46
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Using SSH communicator to connect: <span class="token number">192.168</span>.29.46
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting <span class="token keyword">for</span> SSH to become available<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Connected to SSH<span class="token operator">!</span>
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Executing <span class="token function">shutdown</span> command<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Deleting Floppy drives<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Deleting Floppy image<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Eject CD-ROM drives<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating snapshot<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Clear boot order<span class="token punctuation">..</span>.
Build <span class="token string">'vsphere-iso-base'</span> finished after <span class="token number">6</span> minutes <span class="token number">42</span> seconds.
<span class="token operator">==</span><span class="token operator">></span> Wait completed after <span class="token number">6</span> minutes <span class="token number">42</span> seconds
<span class="token operator">==</span><span class="token operator">></span> Builds finished. The artifacts of successful builds are:
--<span class="token operator">></span> vsphere-iso-base: base-os-centos7

<span class="token punctuation">[</span>root@localhost:/vmfs/volumes/622aec5b-de94a27c-948e-00505680fb1d<span class="token punctuation">]</span> <span class="token function">ls</span> packer_cache/
51511394170e64707b662ca8db012be4d23e121f.iso  d3e175624fc2d704975ce9a149f8f270e4768727.iso  e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso
<span class="token punctuation">[</span>root@localhost:/vmfs/volumes/622aec5b-de94a27c-948e-00505680fb1d<span class="token punctuation">]</span> <span class="token function">ls</span> <span class="token parameter variable">-alh</span> base-os-centos7/
total <span class="token number">4281536</span>
drwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">72</span>.0K Apr  <span class="token number">1</span> 09:17 <span class="token builtin class-name">.</span>
drwxr-xr-t    <span class="token number">1</span> root     root       <span class="token number">76</span>.0K Apr  <span class="token number">1</span> 09:17 <span class="token punctuation">..</span>
-rw-------    <span class="token number">1</span> root     root        <span class="token number">4</span>.0G Apr  <span class="token number">1</span> 09:17 base-os-centos7-3ea6b205.vswp
-rw-r--r--    <span class="token number">1</span> root     root         <span class="token number">253</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7-65ff34a3.hlog
-rw-------    <span class="token number">1</span> root     root       <span class="token number">64</span>.0G Apr  <span class="token number">1</span> 09:17 base-os-centos7-flat.vmdk
-rw-------    <span class="token number">1</span> root     root        <span class="token number">8</span>.5K Apr  <span class="token number">1</span> 09:17 base-os-centos7.nvram
-rw-------    <span class="token number">1</span> root     root         <span class="token number">482</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmdk
-rw-r--r--    <span class="token number">1</span> root     root           <span class="token number">0</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmsd
-rwxr-xr-x    <span class="token number">1</span> root     root        <span class="token number">2</span>.3K Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmx
-rw-------    <span class="token number">1</span> root     root           <span class="token number">0</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmx.lck
-rwxr-xr-x    <span class="token number">1</span> root     root        <span class="token number">2</span>.2K Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmx~
-rw-------    <span class="token number">1</span> root     root        <span class="token number">1</span>.4M Apr  <span class="token number">1</span> 09:17 packer-tmp-created-floppy.flp
-rw-r--r--    <span class="token number">1</span> root     root       <span class="token number">96</span>.1K Apr  <span class="token number">1</span> 09:17 vmware.log

root@devbox-fedora:/root <span class="token comment"># scp 192.168.24.43:/vmfs/volumes/Packer/base-os-centos7/packer-tmp-created-floppy.flp .</span>

root@devbox-fedora:/root <span class="token comment"># mount packer-tmp-created-floppy.flp /mnt</span>
root@devbox-fedora:/root <span class="token comment"># readlink /dev/disk/by-label/packer</span>
<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/loop2
root@devbox-fedora:/root <span class="token comment"># ls /mnt/HTTP/7/KS.CFG</span>
KS.CFG<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Photon3 构建输出日志</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">vsphere-iso-base: output will be in this color.

&#x3D;&#x3D;&gt; vsphere-iso-base: File &#x2F;root&#x2F;.cache&#x2F;packer&#x2F;d3e175624fc2d704975ce9a149f8f270e4768727.iso already uploaded; continuing
&#x3D;&#x3D;&gt; vsphere-iso-base: File [Packer] packer_cache&#x2F;&#x2F;d3e175624fc2d704975ce9a149f8f270e4768727.iso already exists; skipping upload.
&#x3D;&#x3D;&gt; vsphere-iso-base: the vm&#x2F;template Packer&#x2F;base-os-photon3 already exists, but deleting it due to -force flag
&#x3D;&#x3D;&gt; vsphere-iso-base: Creating VM...
&#x3D;&#x3D;&gt; vsphere-iso-base: Customizing hardware...
&#x3D;&#x3D;&gt; vsphere-iso-base: Mounting ISO images...
&#x3D;&#x3D;&gt; vsphere-iso-base: Adding configuration parameters...
&#x3D;&#x3D;&gt; vsphere-iso-base: Starting HTTP server on port 8674
&#x3D;&#x3D;&gt; vsphere-iso-base: Set boot order temporary...
&#x3D;&#x3D;&gt; vsphere-iso-base: Power on VM...
&#x3D;&#x3D;&gt; vsphere-iso-base: Waiting 15s for boot...
&#x3D;&#x3D;&gt; vsphere-iso-base: HTTP server is working at http:&#x2F;&#x2F;192.168.29.171:8674&#x2F;
&#x3D;&#x3D;&gt; vsphere-iso-base: Typing boot command...
&#x3D;&#x3D;&gt; vsphere-iso-base: Waiting for IP...
&#x3D;&#x3D;&gt; vsphere-iso-base: IP address: 192.168.29.208
&#x3D;&#x3D;&gt; vsphere-iso-base: Using SSH communicator to connect: 192.168.29.208
&#x3D;&#x3D;&gt; vsphere-iso-base: Waiting for SSH to become available...
&#x3D;&#x3D;&gt; vsphere-iso-base: Connected to SSH!
&#x3D;&#x3D;&gt; vsphere-iso-base: Executing shutdown command...
&#x3D;&#x3D;&gt; vsphere-iso-base: Deleting Floppy drives...
&#x3D;&#x3D;&gt; vsphere-iso-base: Eject CD-ROM drives...
&#x3D;&#x3D;&gt; vsphere-iso-base: Creating snapshot...
&#x3D;&#x3D;&gt; vsphere-iso-base: Clear boot order...
Build &#39;vsphere-iso-base&#39; finished after 5 minutes 24 seconds.

&#x3D;&#x3D;&gt; Wait completed after 5 minutes 24 seconds

&#x3D;&#x3D;&gt; Builds finished. The artifacts of successful builds are:
--&gt; vsphere-iso-base: base-os-photon3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过 <code>packer build</code> 命令的输出我们大致可以推断出通过 vsphere-iso 构建 Base 虚拟机的主要步骤和原理：</p>
<ul>
<li>下载 ISO 文件到本地的 ${HOME}&#x2F;.cache&#x2F;packer 目录，并以 checksum.iso 方式保存，这样的好处就是便于缓存 ISO 文件，避免重复下载；</li>
<li>上传本地 ISO 文件到 vCenter 的 datastore 中，默认保存在 datastore 的 packer_cache 目录下，如果 ISO 文件已经存在了，则会跳过上传的流程；</li>
<li>创建虚拟机，配置虚拟机硬件，挂载上传的 ISO 文件到虚拟机上的 CD&#x2F;ROM，设置 boot 启动项为 CD&#x2F;ROM</li>
<li>如果 <a target="_blank" rel="noopener" href="https://www.packer.io/plugins/builders/vsphere/vsphere-iso#boot-configuration">boot_media_path</a> 是 http 类型的则在本地随机监听一个 TCP 端口来运行一个 http 服务，用于提供 kickstart 文件的 HTTP 下载功能；如果是目录类型的则将 kickstart 文件创建成一个软盘文件，并将该文件上传到 datastore 中，将软盘文件插入到虚拟机中；</li>
<li>虚拟机开机启动到 ISO 引导页面，通过 vCenter API 发送键盘输入，插入 kickstart 文件的路径；</li>
<li>通过 vCenter API 发送回车键盘输入，ISO 中的 OS 安装程序读取 kickstart 进行 OS 安装；</li>
<li>在 kickstart 脚本里安装 <a target="_blank" rel="noopener" href="https://github.com/vmware/open-vm-tools">open-vm-tools</a> 工具；</li>
<li>等待 OS 安装完成，安装完成重启后进入安装好的 OS，OS 启动后通过 DHCP 获取 IP 地址；</li>
<li>通过 vm-tools 获取到虚拟机的 IP 地址，然后 ssh 连接到虚拟机执行关机命令；</li>
<li>虚拟机关机，卸载 ISO 和软驱等不需要的设备；</li>
<li>创建快照或者将虚拟机转换为模版；</li>
</ul>
<p>个人觉着这里比较好玩儿就是居然可以通过 vCenter 或 ESXi 的 <a target="_blank" rel="noopener" href="https://vdc-repo.vmware.com/vmwb-repository/dcr-public/1ef6c336-7bef-477d-b9bb-caa1767d7e30/82521f49-9d9a-42b7-b19b-9e6cd9b30db1/vim.VirtualMachine.html#putUsbScanCodes">PutUsbScanCodes</a> API 来给虚拟机发送一些键盘输入的指令，感觉这简直太神奇啦 😂。之前我们的项目是将 kickstart 文件构建成一个 ISO 文件，然后通过重新构建源 ISO 的方式来修改 isolinux 启动参数。后来感觉这种重新构建 ISO 的方式太蠢了，于是就参考 Packer 的思路使用 govc 里内置的 <a target="_blank" rel="noopener" href="https://github.com/vmware/govmomi/blob/master/govc/vm/keystrokes.go">vm.keystrokes</a> 命令来给虚拟机发送键盘指令，完成指定 kickstart 文件路径参数启动的操作。具体的 govc 操作命令可以参考如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 发送 tab 键，进入到 ISO 启动参数编辑页面</span>
$ govc vm.keystrokes <span class="token parameter variable">-vm</span><span class="token operator">=</span><span class="token string">'centos-vm-192'</span> <span class="token parameter variable">-c</span><span class="token operator">=</span><span class="token string">'KEY_TAB'</span>
<span class="token comment"># 发送 Right Control + U 键清空输入框</span>
$ govc vm.keystrokes <span class="token parameter variable">-vm</span><span class="token operator">=</span><span class="token string">'centos-vm-192'</span> <span class="token parameter variable">-rc</span><span class="token operator">=</span>true <span class="token parameter variable">-c</span><span class="token operator">=</span><span class="token string">'KEY_U'</span>
<span class="token comment"># 输入 isolinux 的启动参数配置，通过 ks=hd:LABEL=KS:/ks.cfg 指定 kickstart 路径，LABEL 为构建 ISO 时设置的 lable</span>
$ govc vm.keystrokes <span class="token parameter variable">-vm</span><span class="token operator">=</span><span class="token string">'centos-vm-192'</span> <span class="token parameter variable">-s</span><span class="token operator">=</span><span class="token string">'vmlinuz initrd=initrd.img ks=hd:LABEL=KS:/ks.cfg inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 quiet console=ttyS0'</span>
<span class="token comment"># 按下回车键，开始安装 OS</span>
$ govc vm.keystrokes <span class="token parameter variable">-vm</span><span class="token operator">=</span><span class="token string">'centos-vm-192'</span> <span class="token parameter variable">-c</span><span class="token operator">=</span><span class="token string">'KEY_ENTER'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="通过-vsphere-clone-构建业务虚拟机并导出-OVF-x2F-OVA"><a href="#通过-vsphere-clone-构建业务虚拟机并导出-OVF-x2F-OVA" class="headerlink" title="通过 vsphere-clone 构建业务虚拟机并导出 OVF&#x2F;OVA"></a>通过 vsphere-clone 构建业务虚拟机并导出 OVF&#x2F;OVA</h3><p>通过 vsphere-iso 构建 Base 虚拟机之后，我们就使用这个 base 虚拟机克隆出一台新的虚拟机，用来构建我们的业务虚拟机镜像，将 k3s, argo-workflow, redfish-esxi-os-installer 这一堆工具打包进去；</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vsphere-clone: output will be <span class="token keyword">in</span> this color.

<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Cloning VM<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Customizing hardware<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Power on VM<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Waiting <span class="token keyword">for</span> IP<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: IP address: <span class="token number">192.168</span>.30.112
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Using SSH communicator to connect: <span class="token number">192.168</span>.30.112
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Waiting <span class="token keyword">for</span> SSH to become available<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Connected to SSH<span class="token operator">!</span>
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Uploading scripts <span class="token operator">=</span><span class="token operator">></span> /root
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Uploading resources <span class="token operator">=</span><span class="token operator">></span> /root
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Provisioning with shell script: /tmp/packer-shell557168976
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Executing <span class="token function">shutdown</span> command<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Creating snapshot<span class="token punctuation">..</span>.
    vsphere-clone: Starting export<span class="token punctuation">..</span>.
    vsphere-clone: Downloading: k3s-photon3-c4ca93f-disk-0.vmdk
    vsphere-clone: Exporting file: k3s-photon3-c4ca93f-disk-0.vmdk
    vsphere-clone: Writing ovf<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Running post-processor: packer-manifest <span class="token punctuation">(</span>type manifest<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Running post-processor: vsphere <span class="token punctuation">(</span>type shell-local<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: Running <span class="token builtin class-name">local</span> shell script: /tmp/packer-shell2376077966
    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: <span class="token builtin class-name">cd</span> /root/usr/src/github.com/muzi502/packer-vsphere-example/output/k3s-photon3-c4ca93f
    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: create ovf k3s-photon3-c4ca93f.ovf
    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: create ova manifest k3s-photon3-c4ca93f.mf
    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: creating OVA using <span class="token function">tar</span>
    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: <span class="token punctuation">[</span><span class="token string">'tar'</span>, <span class="token string">'-c'</span>, <span class="token string">'-f'</span>, <span class="token string">'k3s-photon3-c4ca93f.ova'</span>, <span class="token string">'k3s-photon3-c4ca93f.ovf'</span>, <span class="token string">'k3s-photon3-c4ca93f.mf'</span>, <span class="token string">'k3s-photon3-c4ca93f-disk-0.vmdk'</span><span class="token punctuation">]</span>
    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: create ova checksum k3s-photon3-c4ca93f.ova.sha256
Build <span class="token string">'vsphere-clone'</span> finished after <span class="token number">14</span> minutes <span class="token number">16</span> seconds.

<span class="token operator">==</span><span class="token operator">></span> Wait completed after <span class="token number">14</span> minutes <span class="token number">16</span> seconds

<span class="token operator">==</span><span class="token operator">></span> Builds finished. The artifacts of successful builds are:
--<span class="token operator">></span> vsphere-clone: k3s-photon3-c4ca93f
--<span class="token operator">></span> vsphere-clone: k3s-photon3-c4ca93f
--<span class="token operator">></span> vsphere-clone: k3s-photon3-c4ca93f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过 packer build 命令的输出我们大致可以推断出构建流程：</p>
<ul>
<li>clone 虚拟机，修改虚拟机的硬件配置</li>
<li>虚拟机开机，通过 vm-tools 获取虚拟机的 IP 地址</li>
<li>获取到虚拟机的 IP 地址后等待 ssh 能够正常连接</li>
<li>ssh 能够正常连接后，通过 scp 的方式上传文件</li>
<li>ssh 远程执行虚拟机里的 <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/install.sh">install.sh</a> 脚本</li>
<li>执行虚拟机关机命令</li>
<li>创建虚拟机快照</li>
<li>导出虚拟机 OVF 文件</li>
<li>导出构建配置参数的 manifest.json 文件</li>
<li>执行 <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/ova.py">ova.py</a> 脚本，根据 manifest.json 配置参数将 OVF 格式转换成 OVA</li>
</ul>
<p>至此，整个的虚拟机模版的构建流程算是完成了，最终我们的到一个 OVA 格式的虚拟机模版。使用的时候只需要在本地机器上安装好 VMware Workstation 或者 Oracle VirtualBox 就能一键导入该虚拟机，开机后就可以使用啦，算是做到了开箱即用的效果。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">output
└── k3s-photon3-c4ca93f
    ├── k3s-photon3-c4ca93f-disk-0.vmdk
    ├── k3s-photon3-c4ca93f.mf
    ├── k3s-photon3-c4ca93f.ova
    ├── k3s-photon3-c4ca93f.ova.sha256
    ├── k3s-photon3-c4ca93f.ovf
    └── packer-manifest.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="argo-workflow-和-k3s"><a href="#argo-workflow-和-k3s" class="headerlink" title="argo-workflow 和 k3s"></a>argo-workflow 和 k3s</h2><p>在虚拟机内使用 redfish-esxi-os-installer 有点特殊，是将它放在 argo-workflow 的 Pod 内来执行的。在 workflow 模版文件 <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/resources/workflow/workflow.yaml">workflow.yaml</a> 中我们定义了若干个 steps 来运行 redfish-esxi-os-installer。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Workflow
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">generateName</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">-</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer
  <span class="token key atrule">templates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
            <span class="token key atrule">value</span><span class="token punctuation">:</span> pre<span class="token punctuation">-</span>check
        <span class="token key atrule">name</span><span class="token punctuation">:</span> Precheck
        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer
    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
            <span class="token key atrule">value</span><span class="token punctuation">:</span> build<span class="token punctuation">-</span>iso
        <span class="token key atrule">name</span><span class="token punctuation">:</span> BuildISO
        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer
    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
            <span class="token key atrule">value</span><span class="token punctuation">:</span> mount<span class="token punctuation">-</span>iso
        <span class="token key atrule">name</span><span class="token punctuation">:</span> MountISO
        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer
    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
            <span class="token key atrule">value</span><span class="token punctuation">:</span> reboot
        <span class="token key atrule">name</span><span class="token punctuation">:</span> Reboot
        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer
    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
            <span class="token key atrule">value</span><span class="token punctuation">:</span> post<span class="token punctuation">-</span>check
        <span class="token key atrule">name</span><span class="token punctuation">:</span> Postcheck
        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer
    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
            <span class="token key atrule">value</span><span class="token punctuation">:</span> umount<span class="token punctuation">-</span>iso
        <span class="token key atrule">name</span><span class="token punctuation">:</span> UmountISO
        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer
  <span class="token punctuation">-</span> <span class="token key atrule">container</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> installer
      <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/muzi502/redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">:</span>v0.1.0<span class="token punctuation">-</span>alpha.1
      <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> bash
      <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
      <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
        make inventory &amp;&amp; make &#123;&#123;inputs.parameters.command&#125;&#125;</span>
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME
        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
          <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> HOST_IP
        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
          <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.hostIP
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SRC_ISO_DIR
        <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/iso
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> HTTP_DIR
        <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/iso/redfish
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> HTTP_URL
        <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$(HOST_IP)/files/iso/redfish
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ESXI_ISO
        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
          <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">-</span>config
            <span class="token key atrule">key</span><span class="token punctuation">:</span> esxi_iso
      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
        <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /ansible/config.yaml
        <span class="token key atrule">name</span><span class="token punctuation">:</span> config
        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">subPath</span><span class="token punctuation">:</span> config.yaml
      <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data
        <span class="token key atrule">name</span><span class="token punctuation">:</span> data
    <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
      <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
    <span class="token key atrule">name</span><span class="token punctuation">:</span> installer
    <span class="token key atrule">retryStrategy</span><span class="token punctuation">:</span>
      <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
      <span class="token key atrule">retryPolicy</span><span class="token punctuation">:</span> OnFailure
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
      <span class="token key atrule">items</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> config
        <span class="token key atrule">path</span><span class="token punctuation">:</span> config.yaml
      <span class="token key atrule">name</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">-</span>config
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data
      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于目前没有 Web UI 和后端 Server 所以还是需要手动编辑 <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/resources/workflow/configmap.yaml">&#x2F;root&#x2F;resources&#x2F;workflow&#x2F;configmap.yaml</a> 配置文件，然后再执行 <code>kubectl create -f /root/resources/workflow</code> 命令创建 workflow 工作流。</p>
<p>workflow 创建了之后，就可以通过 argo 命令查看 workflow 执行的进度和状态</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@localhost <span class="token punctuation">[</span> ~/resources/workflow <span class="token punctuation">]</span><span class="token comment"># argo get redfish-esxi-os-installer-tjjqz</span>
Name:                redfish-esxi-os-installer-tjjqz
Namespace:           default
ServiceAccount:      <span class="token builtin class-name">unset</span> <span class="token punctuation">(</span>will run with the default ServiceAccount<span class="token punctuation">)</span>
Status:              Succeeded
Conditions:
 PodRunning          False
 Completed           True
Created:             Mon May <span class="token number">23</span> <span class="token number">11</span>:07:31 +0000 <span class="token punctuation">(</span><span class="token number">16</span> minutes ago<span class="token punctuation">)</span>
Started:             Mon May <span class="token number">23</span> <span class="token number">11</span>:07:31 +0000 <span class="token punctuation">(</span><span class="token number">16</span> minutes ago<span class="token punctuation">)</span>
Finished:            Mon May <span class="token number">23</span> <span class="token number">11</span>:23:38 +0000 <span class="token punctuation">(</span><span class="token number">19</span> seconds ago<span class="token punctuation">)</span>
Duration:            <span class="token number">16</span> minutes <span class="token number">7</span> seconds
Progress:            <span class="token number">6</span>/6
ResourcesDuration:   29m45s*<span class="token punctuation">(</span><span class="token number">1</span> cpu<span class="token punctuation">)</span>,29m45s*<span class="token punctuation">(</span>100Mi memory<span class="token punctuation">)</span>

STEP                                TEMPLATE                   PODNAME                                     DURATION  MESSAGE
 ✔ redfish-esxi-os-installer-tjjqz  redfish-esxi-os-installer
 ├───✔ Precheck<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-647555770   11s
 ├───✔ BuildISO<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-3078771217  14s
 ├───✔ MountISO<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-4099695623  19s
 ├───✔ Reboot<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                    installer                  redfish-esxi-os-installer-tjjqz-413209187   7s
 ├───✔ Postcheck<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                 installer                  redfish-esxi-os-installer-tjjqz-2674696793  14m
 └───✔ UmountISO<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                 installer                  redfish-esxi-os-installer-tjjqz-430254503   13s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="argo-workflow"><a href="#argo-workflow" class="headerlink" title="argo-workflow"></a>argo-workflow</h3><p>之所以使用 argo-workflow 而不是使用像 docker、nerdctl 这些命令行工具来运行 redfish-esxi-os-installer ，是因为通过 argo-workflow 来编排我们的安装部署任务能够比较方便地实现多个任务同时运行、获取任务执行的进度及日志、获取任务执行的耗时、停止重试等功能。使用 argo-workflow 来编排我们的安装部署任务，并通过 argo-workflow 的 RESTful API 获取部署任务的进度日志等信息，这样做更云原生一些（🤣</p>
<p><img data-src="https://p.k8s.li/2022-05-23-packer-vsphere-example-01.png" alt="argo-workfloe-apis"></p>
<p>在我们内部其实最终目的是准备将该方案做成一个产品化的工具，提供一个 Web UI 用来进行配置部署参数以及展示部署的进度日志等功能。当初设计方案的时候也是参考了一下  <a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/community-edition">VMware Tanzu 社区版</a> ：部署 Tanzu 管理集群的时候需要有一个已经存在的 k8s 集群，或者通过 Tanzu 新部署一个 kind 集群。部署一个 tanzu 管理集群可以通过 tanzu 命令行的方式，也可以通过 Tanzu Web UI 的方式，Tanzu Web UI 的方式其实就是一个偏向于产品化的工具。在 <a href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">VMware Tanzu kubernetes 发行版部署尝鲜</a> 我曾分享过 Tanzu 的部署方式，感兴趣的话可以去看一下。</p>
<p><img data-src="https://p.k8s.li/2022-05-23-packer-vsphere-example-02.png" alt="tanzu-cluster"></p>
<p>该方案主要是面向一些产品化的场景，由于引入了 K8s 这个庞然大物，整体的技术栈会复杂一些，但也有一些好处啦 😅。</p>
<h3 id="k8s-and-k3s"><a href="#k8s-and-k3s" class="headerlink" title="k8s and k3s"></a>k8s and k3s</h3><p>argo-workflow 需要依赖一个 k8s 集群才能运行，我们内部测试了 kubekey、sealos、kubespray、k3s 几种常见的部署工具。综合评定下来 k3s 集群占用的资源最少。参考 <a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/installation/installation-requirements/resource-profiling/_index/">K3s 资源分析</a> 给出的资源要求，最小只需要 768M 内存就能运行。对于硬件资源不太充足的笔记本电脑来讲，k3s 无疑是目前最佳的方案。</p>
<p>另外还有一个十分重要的原因就是 k3s server 更换单 control plan 节点的 IP 地址十分方便，对用户来说是无感知的。这样就可以将安装 k3s 的操作在构建 OVA 的时候完成，而不是在使用的时候手动执行安装脚本来安装。</p>
<p>只要开机运行虚拟机能够通过 DHCP 分配到一个内网 IPv4 地址或者手动配置一个静态 IP，k3s 就能够正常运行起来，能够真正做到开箱即用，而不是像 kubekey、sealos、kubespray 那样傻乎乎地填写一个复杂无比的配置文件，然后再执行一些命令来安装 k8s 集群。这种导入虚拟机开即用的方式，对用户来讲十分友好。</p>
<p>当然在使用 kubekey、sealos、kubespray 在构建虚拟机的时候安装好 k8s 集群也不是不可行，只不过我们构建时候虚拟机的 IP 地址（比如 10.172.20.223）和使用时的 IP 地址（比如 192.168.20.11）基本上是不会相同的。给 k8s control plain 节点更换 IP 的操作 <a target="_blank" rel="noopener" href="https://www.qikqiak.com/">阳明博主</a> 曾在 <a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/how-to-change-k8s-node-ip/">如何修改 Kubernetes 节点 IP 地址?</a> 文章中分享过他的经历，看完后直接把我整不会了，感觉操作起来实在是太麻烦了，还不如重新部署一套新的 k8s 方便呢 😂</p>
<p>其实构建虚拟机模版的时候安装 k8s 的思路最初我是借鉴的 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> 项目 😂。即将部署 k8s 依赖的一些文件和容器镜像构建在虚拟机模版当中，部署 k8s 的时候不需要再联网下载这些依赖资源了。不同的是，我们通过 k3s 直接提前将 k8s 集群部署好了，也就省去了让用户执行部署的操作。</p>
<p>综上，选用 k3s 作为该方案的 K8s 底座无疑是最佳的啦（</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="使用感受"><a href="#使用感受" class="headerlink" title="使用感受"></a>使用感受</h3><p>使用了一段时间后感觉 Packer 的复杂度和上手难度要比 Docker 构建容器镜像要高出一个数量级。可能是因为虚拟机并不像容器镜像那样有 <a target="_blank" rel="noopener" href="https://opencontainers.org/">OCI</a> 这种统一的构建、分发、运行工业标准。虚拟机的创建克隆等操作与底层的 IaaS 供应商耦合的十分紧密，这就导致不同 IaaS 供应商比如 vSphere、kvm&#x2F;qemu 他们之间能够复用的配置参数并不多。比如 vSphere 里有 datastore、datacenter、resource_pool、folder 等概念，但 kvm&#x2F;qemu 中缺没有，这就导致很难将它们统一成一个配置。</p>
<h3 id="OVA-格式"><a href="#OVA-格式" class="headerlink" title="OVA 格式"></a>OVA 格式</h3><p>使用 OVA 而不是 vagrant.box、vmdk、raw、qcow2 等其他格式是因为 OVA 支持支持一键导入的特性，在 Windows 上使用起来比较方便。毕竟 Windows 上安装 Vagrant 或者 qemu&#x2F;KVM 也够你折腾的了，<a target="_blank" rel="noopener" href="https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html">VMware Workstation</a> 或者 <a target="_blank" rel="noopener" href="https://www.virtualbox.org/">Oracle VirtualBox</a> 使用得更广泛一些。</p>
<p>另外 Packer 并不支持直接将虚拟机导出为 OVA 的方式，默认情况下只会通过 vCenter 的 API 导出为 ovf。如果需要 OVA 格式，需要将 OVF 打包成 OVA。在 ISSUE <a target="_blank" rel="noopener" href="https://github.com/hashicorp/packer/issues/9645">Add support for exporting to OVA in vsphere-iso builder #9645</a> 也有人反馈了支持 OVA 导出的需求，但 Packer 至今仍未支持。将 OVF 转换为 OVA 我是参考的 image-builder 项目的 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/image-builder/blob/master/images/capi/hack/image-build-ova.py"><strong>image-build-ova.py</strong> </a> 来完成的。</p>
<h3 id="安装-open-vm-tool-失败"><a href="#安装-open-vm-tool-失败" class="headerlink" title="安装 open-vm-tool 失败"></a>安装 open-vm-tool 失败</h3><p>由于 ISO 中并不包含 open-vm-tool 软件包，这就需要在 ISO 安装 OS 的过程中联网安装 open-vm-tools。如果安装的时候网络抖动了就可能会导致 open-vm-tools 安装失败。open-vm-tools 安装失败 packer 是无法感知到的，只能一直等到获取虚拟机 IP 超时后退出执行。目前没有很好的办法，只能在 kickstart 里安装 open-vm-tools 的时候进行重试直到 open-vm-tools 安装成功。</p>
<h3 id="减少导出后-vmdk-文件大小"><a href="#减少导出后-vmdk-文件大小" class="headerlink" title="减少导出后 vmdk 文件大小"></a>减少导出后 vmdk 文件大小</h3><p>曾经在 <a href="https://blog.k8s.li/esxi-vmbase.html">手搓虚拟机模板</a> 文章中分析过通过 dd 置零的方式可以大幅减少虚拟机导出后的 vmdk 文件大</p>
<blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">464M Aug <span class="token number">28</span> <span class="token number">16</span>:15 Ubuntu1804-2.ova <span class="token comment"># 置零后的大小</span>
<span class="token number">1</span>.3G Aug <span class="token number">28</span> <span class="token number">15</span>:48 Ubuntu1804.ova   <span class="token comment"># 置零前的大小</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</blockquote>
<p>需要注意的是，在 dd 置零之前要先停止 k3s 服务，不然置零的时候会占满 root 根分区导致 kubelet 启动 GC 将一些镜像给删除掉。之前导出虚拟机后发现少了一些镜像，排查了好久才发现是 kubelet GC 把我的镜像给删掉了，踩了个大坑，可气死我了 😡</p>
<p>另外也可以删除一些不必要的文件，比如 containerd 中 <code>io.containerd.content.v1.content/blobs/sha256</code> 一些镜像 layer 的原始 blob 文件是不需要的，可以将它们给删除掉，这样能够减少部分磁盘空间占用；</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token comment"># stop k3s server for for prevent it starting the garbage collection to delete images</span>
  systemctl stop k3s

  <span class="token comment"># Ensure on next boot that network devices get assigned unique IDs.</span>
  <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'/^\(HWADDR\|UUID\)=/d'</span> /etc/sysconfig/network-scripts/ifcfg-* <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">||</span> <span class="token boolean">true</span>

  <span class="token comment"># Clean up network interface persistence</span>
  <span class="token function">find</span> /var/log <span class="token parameter variable">-type</span> f <span class="token parameter variable">-exec</span> truncate <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">\</span><span class="token punctuation">;</span>
  <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /tmp/* /var/tmp/*

  <span class="token comment"># cleanup all blob files of registry download image</span>
  <span class="token function">find</span> /var/lib/rancher/k3s/agent/containerd/io.containerd.content.v1.content/blobs/sha256 <span class="token parameter variable">-size</span> +1M <span class="token parameter variable">-type</span> f <span class="token parameter variable">-delete</span>

  <span class="token comment"># zero out the rest of the free space using dd, then delete the written file.</span>
  <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/EMPTY <span class="token assign-left variable">bs</span><span class="token operator">=</span>4M <span class="token assign-left variable">status</span><span class="token operator">=</span>progress <span class="token operator">||</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> /EMPTY
  <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/data/EMPTY <span class="token assign-left variable">bs</span><span class="token operator">=</span>4M <span class="token assign-left variable">status</span><span class="token operator">=</span>progress <span class="token operator">||</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> /data/EMPTY
  <span class="token comment"># run sync so Packer doesn't quit too early, before the large file is deleted.</span>
  <span class="token function">sync</span>

  yum clean all
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Photon3"><a href="#Photon3" class="headerlink" title="Photon3"></a>Photon3</h3><p>之前在 <a href="https://blog.k8s.li/Photon-OS.html">轻量级容器优化型 Linux 发行版 Photon OS</a> 里分享过 VMware 的 Linux 发行版 <a target="_blank" rel="noopener" href="https://vmware.github.io/photon/assets/files/html/3.0/">Photon</a>。不同于传统的 Linux 发行版 Photon 的系统十分精简，使用它替代 CentOS 能够一定程度上减少系统资源的占用，导出后的 vmdk 文件也要比 CentOS 小一些。</p>
<h3 id="goss"><a href="#goss" class="headerlink" title="goss"></a><a target="_blank" rel="noopener" href="https://github.com/aelsabbahy/goss">goss</a></h3><p>在构建的过程中我们在 k3s 集群上安装了一些其他的组件，比如提供文件上传和下载服务的 filebrowser 以及 workflow 工作流引擎 argo-workflow，为了保证这些服务的正常运行，我们就需要通过不同的方式去检查这些服务是否正常。一般是通过 kubectl get 等命令查看 deployment、pod、daemonset 等服务是否正常运行，或者通过 curl 访问这些这些服务的健康检查 API。</p>
<p>由于检查项比较多且十分繁琐，使用传统的 shell 脚本来做这并不是很方便，需要解析每个命令的退出码以及返回值。因此我们使用 <a target="_blank" rel="noopener" href="https://github.com/aelsabbahy/goss">goss</a> 通过 YAML 格式的配置文件来定义一些检查项，让它批量来执行这些检查，而不用在 shell 对每个检查项写一堆的 awk&#x2F;grep 等命令来 check 了。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/goss/k3s.yaml">k3s.yaml</a>：用于检查 k3s 以及它默认自带的服务是否正常运行</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">
<span class="token comment"># DNS 类型的检查</span>
<span class="token key atrule">dns</span><span class="token punctuation">:</span>
  <span class="token comment"># 检查 coredns 是否能够正常解析到 kubernetes apiserver 的 service IP 地址</span>
  <span class="token key atrule">kubernetes.default.svc.cluster.local</span><span class="token punctuation">:</span>
    <span class="token key atrule">resolvable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">addrs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 10.43.0.1
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.43.0.10
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># TCP/UDP 端口类型的检查</span>
<span class="token key atrule">addr</span><span class="token punctuation">:</span>
  <span class="token comment"># 检查 coredns 的 UDP 53 端口是否正常</span>
  <span class="token key atrule">udp://10.43.0.10:53</span><span class="token punctuation">:</span>
    <span class="token key atrule">reachable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">500</span>

<span class="token comment"># 检查 cni0 网桥是否存在</span>
<span class="token key atrule">interface</span><span class="token punctuation">:</span>
  <span class="token key atrule">cni0</span><span class="token punctuation">:</span>
    <span class="token key atrule">exists</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">addrs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 10.42.0.1/24

<span class="token comment"># 本机端口类型的检查</span>
<span class="token key atrule">port</span><span class="token punctuation">:</span>
  <span class="token comment"># 检查 ssh 22 端口是否正常</span>
  <span class="token key atrule">tcp:22</span><span class="token punctuation">:</span>
    <span class="token key atrule">listening</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">ip</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 0.0.0.0
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 检查 kubernetes apiserver 6443 端口是否正常</span>
  <span class="token key atrule">tcp6:6443</span><span class="token punctuation">:</span>
    <span class="token key atrule">listening</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># 检查一些 systemd 服务的检查</span>
<span class="token key atrule">service</span><span class="token punctuation">:</span>
  <span class="token comment"># 默认禁用 firewalld 服务</span>
  <span class="token key atrule">firewalld</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">running</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 确保 sshd 服务正常运行</span>
  <span class="token key atrule">sshd</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">running</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 检查 k3s 服务是否正常运行</span>
  <span class="token key atrule">k3s</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">running</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># 定义一些 shell 命令执行的检查</span>
<span class="token key atrule">command</span><span class="token punctuation">:</span>
  <span class="token comment"># 检查 kubernetes cheduler 组件是否正常</span>
  <span class="token key atrule">check_k8s_scheduler_health</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> curl <span class="token punctuation">-</span>k https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10259/healthz
    <span class="token comment"># 退出码是否为 0</span>
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># 标准输出中是否包含正确的输出值</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ok"</span><span class="token punctuation">]</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 检查 kubernetes controller-manager 是否正常</span>
  <span class="token key atrule">check_k8s_controller-manager_health</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> curl <span class="token punctuation">-</span>k https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10257/healthz
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ok"</span><span class="token punctuation">]</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 检查 cluster-info  中输出的组件运行状态是否正常</span>
  <span class="token key atrule">check_cluster_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl cluster<span class="token punctuation">-</span>info <span class="token punctuation">|</span> grep 'is running'
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> CoreDNS
      <span class="token punctuation">-</span> Kubernetes control plane
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 检查节点是否处于 Ready 状态</span>
  <span class="token key atrule">check_node_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get node <span class="token punctuation">-</span>o jsonpath='<span class="token punctuation">&#123;</span>.items<span class="token punctuation">[</span><span class="token punctuation">]</span>.status<span class="token punctuation">&#125;</span>' <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.conditions<span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">]</span>.type'
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> Ready
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 检查节点 IP 是否正确</span>
  <span class="token key atrule">check_node_address</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get node <span class="token punctuation">-</span>o wide <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.status.addresses<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">|</span> select(.type == "InternalIP") <span class="token punctuation">|</span> .address'
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 检查 traefik loadBalancer 的 IP 地址是否正确</span>
  <span class="token key atrule">check_traefik_address</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system get svc traefik <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.status.loadBalancer.ingress<span class="token punctuation">[</span><span class="token punctuation">]</span>.ip'
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 检查 containerd 容器运行是否正常</span>
  <span class="token key atrule">check_container_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> crictl ps <span class="token punctuation">-</span><span class="token punctuation">-</span>output=json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.containers<span class="token punctuation">[</span><span class="token punctuation">]</span>.metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> coredns
      <span class="token punctuation">-</span> /lb<span class="token punctuation">-</span>.<span class="token important">*-443/</span>
      <span class="token punctuation">-</span> /lb<span class="token punctuation">-</span>.<span class="token important">*-80/</span>
      <span class="token punctuation">-</span> traefik
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 检查 kube-system namespace 下的 pod 是否正常</span>
  <span class="token key atrule">check_kube_system_namespace_pod_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get pod <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">|</span> select((.status.phase <span class="token tag">!=</span> "Running") and (.status.phase <span class="token tag">!=</span> "Succeeded") and (.status.phase <span class="token tag">!=</span> "Completed"))'
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"!string"</span><span class="token punctuation">]</span>
  <span class="token comment"># 检查 k8s deployment 服务是否都正常</span>
  <span class="token key atrule">check_k8s_deployment_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get deploy <span class="token punctuation">-</span><span class="token punctuation">-</span>all<span class="token punctuation">-</span>namespaces <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">|</span> select(.status.replicas == .status.availableReplicas) <span class="token punctuation">|</span> .metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> coredns
      <span class="token punctuation">-</span> traefik
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 检查 svclb-traefik daemonset 是否正常</span>
  <span class="token key atrule">check_k8s_daemonset_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get daemonset <span class="token punctuation">-</span><span class="token punctuation">-</span>all<span class="token punctuation">-</span>namespaces <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">|</span> select(.status.replicas == .status.availableReplicas) <span class="token punctuation">|</span> .metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> svclb<span class="token punctuation">-</span>traefik
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/goss/goss.yaml">goss.yaml</a>：用于检查我们部署的一些服务是否正常</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># 通过 include 其他 gossfile 方式将上面定义的 k3s.yaml 检查项也包含进来</span>
<span class="token key atrule">gossfile</span><span class="token punctuation">:</span>
  <span class="token key atrule">k3s.yaml</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token key atrule">dns</span><span class="token punctuation">:</span>
  <span class="token comment"># 检查部署的 filebrowser deployment 的 service IP 是否能正常解析到</span>
  <span class="token key atrule">filebrowser.default.svc.cluster.local</span><span class="token punctuation">:</span>
    <span class="token key atrule">resolvable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.43.0.10
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 检查部署的 argo-workflow deployment 的 service IP 是否能正常解析到</span>
  <span class="token key atrule">argo-workflow-argo-workflows-server.default.svc.cluster.local</span><span class="token punctuation">:</span>
    <span class="token key atrule">resolvable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.43.0.10
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># 一些 HTTP 请求方式的检查</span>
<span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token comment"># 检查 filebrowser 服务是否正常运行，类似于 pod 里的存活探针</span>
  http<span class="token punctuation">:</span>//<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/filebrowser/<span class="token punctuation">:</span>
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token number">200</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">method</span><span class="token punctuation">:</span> GET
  <span class="token comment"># 检查 argo-workflow 是否正常运行</span>
  http<span class="token punctuation">:</span>//<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/workflows/api/v1/version<span class="token punctuation">:</span>
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token number">200</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">method</span><span class="token punctuation">:</span> GET

<span class="token comment"># 同样也是一些 shell 命令的检查项目</span>
<span class="token key atrule">command</span><span class="token punctuation">:</span>
  <span class="token comment"># 检查容器镜像是否齐全，避免缺镜像的问题</span>
  <span class="token key atrule">check_container_images</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> crictl images <span class="token punctuation">-</span><span class="token punctuation">-</span>output=json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.images<span class="token punctuation">[</span><span class="token punctuation">]</span>.repoTags<span class="token punctuation">[</span><span class="token punctuation">]</span>' <span class="token punctuation">|</span> awk <span class="token punctuation">-</span>F '/' '<span class="token punctuation">&#123;</span>print $NF<span class="token punctuation">&#125;</span>' <span class="token punctuation">|</span> awk <span class="token punctuation">-</span>F '<span class="token punctuation">:</span>' '<span class="token punctuation">&#123;</span>print $1<span class="token punctuation">&#125;</span>' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> argocli
      <span class="token punctuation">-</span> argoexec
      <span class="token punctuation">-</span> workflow<span class="token punctuation">-</span>controller
      <span class="token punctuation">-</span> filebrowser
      <span class="token punctuation">-</span> nginx
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 检查容器运行的状态是否正常</span>
  <span class="token key atrule">check_container_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> crictl ps <span class="token punctuation">-</span><span class="token punctuation">-</span>output=json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.containers<span class="token punctuation">[</span><span class="token punctuation">]</span>.metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> argo<span class="token punctuation">-</span>server
      <span class="token punctuation">-</span> controller
      <span class="token punctuation">-</span> nginx
      <span class="token punctuation">-</span> filebrowser
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 检查一些 deployment 的状态是否正常</span>
  <span class="token key atrule">check_k8s_deployment_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get deploy <span class="token punctuation">-</span>n default <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">|</span> select(.status.replicas == .status.availableReplicas) <span class="token punctuation">|</span> .metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> argo<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>argo<span class="token punctuation">-</span>workflows<span class="token punctuation">-</span>server
      <span class="token punctuation">-</span> argo<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>argo<span class="token punctuation">-</span>workflows<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>controller
      <span class="token punctuation">-</span> filebrowser
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># 一些硬件参数的检查，比如 CPU 核心数、内存大小、可用内存大小</span>
<span class="token key atrule">matching</span><span class="token punctuation">:</span>
  <span class="token key atrule">check_vm_cpu_core</span><span class="token punctuation">:</span>
    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.cpu_core_number <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">matches</span><span class="token punctuation">:</span>
      <span class="token key atrule">gt</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">check_vm_memory_size</span><span class="token punctuation">:</span>
    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.memory_size <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">matches</span><span class="token punctuation">:</span>
      <span class="token key atrule">gt</span><span class="token punctuation">:</span> <span class="token number">1880000</span>
  <span class="token key atrule">check_available_memory_size</span><span class="token punctuation">:</span>
    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.available_memory_size <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">matches</span><span class="token punctuation">:</span>
      <span class="token key atrule">gt</span><span class="token punctuation">:</span> <span class="token number">600000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>另外 goss 也比较适合做一些巡检的工作。比如在一个 k8s 集群中进行巡检：检查集群内 pod 的状态、kubernetes 组件的状态、CNI 运行状态、节点的网络、磁盘存储空间、CPU 负载、内核参数、daemonset 服务状态等，都可以参照上述方式定义一系列的检查项，使用 goss 来帮我们自动完成巡检。</p>
<h3 id="导入-OVA-虚拟机后-Pod-状态异常"><a href="#导入-OVA-虚拟机后-Pod-状态异常" class="headerlink" title="导入 OVA 虚拟机后 Pod 状态异常"></a>导入 OVA 虚拟机后 Pod 状态异常</h3><p>将 OVA 虚拟机在 VMware Workstation 上导入之后，由于虚拟机 IP 的变化可能会导致一些 Pod 处于异常的状态，这时候就需要对这些 Pod 进行强制删除，强制重启一下才能恢复正常。因此需要需要在虚拟机里增加一个 <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/prepare.sh">prepare.sh</a> 脚本用来重启这些状态异常的 Pod。当导入 OVA 虚拟机后运行这个脚本让所有的 Pod 都正常运行起来，然后再调用 goss 来检查其他服务是否正常。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> errexit
<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> nounset
<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> pipefail

kubectl get pods --no-headers <span class="token parameter variable">-n</span> kube-system <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'0/2|0/1|Error|Unknown|CreateContainerError|CrashLoopBackOff'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">-I</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> kubectl delete pod <span class="token parameter variable">-n</span> kube-system --grace-period<span class="token operator">=</span><span class="token number">0</span> <span class="token parameter variable">--force</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> /dev/null  <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token boolean">true</span>
kubectl get pods --no-headers <span class="token parameter variable">-n</span> default <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'0/1|Error|Unknown|CreateContainerError|CrashLoopBackOff'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">-I</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> kubectl delete pod <span class="token parameter variable">-n</span> default --grace-period<span class="token operator">=</span><span class="token number">0</span> <span class="token parameter variable">--force</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> /dev/null  <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token boolean">true</span>
<span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">if</span> kubectl get pods --no-headers --all-namespaces <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-Ev</span> <span class="token string">'Running|Completed'</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Waiting for service readiness"</span>
    <span class="token function">sleep</span> <span class="token number">10</span>
  <span class="token keyword">else</span>
    <span class="token builtin class-name">break</span>
  <span class="token keyword">fi</span>
<span class="token keyword">done</span>

<span class="token builtin class-name">cd</span> <span class="token variable">$&#123;<span class="token environment constant">HOME</span>&#125;</span>/.goss
<span class="token function">cat</span> <span class="token operator">></span> vars.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
ip_address: <span class="token variable"><span class="token variable">$(</span><span class="token function">ip</span> r get <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">"s/ uid.*//g"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $NF&#125;'</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-n1</span><span class="token variable">)</span></span>
cpu_core_number: <span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token parameter variable">-c</span> ^processor /proc/cpuinfo<span class="token variable">)</span></span>
memory_size: <span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token string">'^MemTotal:'</span> /proc/meminfo <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span><span class="token variable">)</span></span>
available_memory_size: <span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token string">'^MemAvailable:'</span> /proc/meminfo <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span><span class="token variable">)</span></span>
EOF</span>
goss <span class="token parameter variable">--vars</span> vars.yaml <span class="token parameter variable">-g</span> goss.yaml validate --retry-timeout<span class="token operator">=</span>10s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.escapelife.site/posts/754ba85c.html">K3S 工具进阶完全指南</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/installation/installation-requirements/resource-profiling/_index/">K3s 资源分析</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aelsabbahy/goss/blob/master/docs/manual.md">goss</a>：goss 配置文档</li>
<li><a target="_blank" rel="noopener" href="https://github.com/alexellis/awesome-baremetal">awesome-baremetal</a>：一些与裸金属服务器相关的工具汇总</li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax">Kickstart Syntax Reference</a>：CentOS&#x2F;Red Hat kickstart 语法</li>
<li><a target="_blank" rel="noopener" href="https://vmware.github.io/photon/assets/files/html/3.0/photon_user/kickstart.html">Kickstart Support in Photon OS</a>：Photon OS 的 kickstart 语法</li>
</ul>
<h3 id="Packer-相关"><a href="#Packer-相关" class="headerlink" title="Packer 相关"></a>Packer 相关</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/chef/bento">bento</a>：是一个 Packer 最佳实践的模版仓库，不过它的 builder 是 Vagrant，但可以从中借鉴一些 Linux 发行版的自动化安装脚本，比如 CentOS 的 <a target="_blank" rel="noopener" href="https://github.com/chef/bento/tree/main/packer_templates/centos/http">kickstart</a> 文件。</li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/FnnMnu9i6gFNrAjIlzaNnQ">基于 Packer+Ansible 实现云平台黄金镜像统一构建和发布</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/image-builder/tree/master/images/capi">Image Builder for Cluster API</a></li>
<li><a target="_blank" rel="noopener" href="https://image-builder.sigs.k8s.io/capi/providers/vsphere.html#building-images-for-vsphere">Building Images for vSphere</a></li>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/plugins/builders/vsphere/vsphere-clone">VMware vSphere Clone Builder</a></li>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/plugins/builders/vsphere/vsphere-iso">Packer Builder for VMware vSphere</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hashicorp/packer-plugin-vsphere">packer-plugin-vsphere</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/vmware-samples/packer-examples-for-vsphere">packer-examples-for-vsphere</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.rockylinux.org/guides/automation/templates-automation-packer-vsphere/">Automatic template creation with Packer and deployment with Ansible in a VMware vSphere environment</a></li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/argo-workflow/" rel="tag"># argo-workflow</a>
              <a href="/tags/vSphere/" rel="tag"># vSphere</a>
              <a href="/tags/packer/" rel="tag"># packer</a>
              <a href="/tags/esxi/" rel="tag"># esxi</a>
              <a href="/tags/k3s/" rel="tag"># k3s</a>
              <a href="/tags/redfish/" rel="tag"># redfish</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/redfish-esxi-os-installer.html" rel="prev" title="使用 Redfish 自动化安装 ESXi OS">
                  <i class="fa fa-chevron-left"></i> 使用 Redfish 自动化安装 ESXi OS
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/One-Year-After-the-Lockdown-in-Shanghai.html" rel="next" title="写在上海封城一年之后">
                  写在上海封城一年之后 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.8m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">26:46</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
