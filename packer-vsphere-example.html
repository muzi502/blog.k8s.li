<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.3.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="ä¸ä¹…å‰å†™è¿‡ä¸€ç¯‡åšå®¢ã€Šä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OSã€‹åˆ†äº«äº†å¦‚ä½•ä½¿ç”¨ Redfish ç»™ç‰©ç†æœåŠ¡å™¨è‡ªåŠ¨åŒ–å®‰è£… ESXi OSã€‚è™½ç„¶åœ¨æˆ‘ä»¬å†…éƒ¨åšåˆ°äº†ä¸€é”®å®‰è£…&#x2F;é‡è£… ESXi OSï¼Œä½†æƒ³è¦å°†è¿™å¥—æ–¹æ¡ˆåº”ç”¨åœ¨å®¢æˆ·çš„ç§æœ‰äº‘æœºæˆ¿ç¯å¢ƒä¸­è¿˜æ˜¯æœ‰å¾ˆå¤§çš„éš¾åº¦ã€‚ é¦–å…ˆè¿™å¥—å·¥å…·å¿…é¡»è¿è¡Œåœ¨ Linux ä¸­æ‰è¡Œï¼Œå¯¹äº Bare Metal è£¸æœåŠ¡å™¨æ¥è®²è¿˜æ²¡æœ‰å®‰è£…ä»»ä½• OSï¼Œè¿™å°±å¼•ç”³å‡ºäº†é¸¡ç”Ÿè›‹è›‹ç”Ÿé¸¡çš„">
<meta property="og:type" content="blog">
<meta property="og:title" content="ä½¿ç”¨ Packer æ„å»ºè™šæ‹Ÿæœºé•œåƒè¸©çš„å‘">
<meta property="og:url" content="https://blog.k8s.li/packer-vsphere-example.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="ä¸ä¹…å‰å†™è¿‡ä¸€ç¯‡åšå®¢ã€Šä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OSã€‹åˆ†äº«äº†å¦‚ä½•ä½¿ç”¨ Redfish ç»™ç‰©ç†æœåŠ¡å™¨è‡ªåŠ¨åŒ–å®‰è£… ESXi OSã€‚è™½ç„¶åœ¨æˆ‘ä»¬å†…éƒ¨åšåˆ°äº†ä¸€é”®å®‰è£…&#x2F;é‡è£… ESXi OSï¼Œä½†æƒ³è¦å°†è¿™å¥—æ–¹æ¡ˆåº”ç”¨åœ¨å®¢æˆ·çš„ç§æœ‰äº‘æœºæˆ¿ç¯å¢ƒä¸­è¿˜æ˜¯æœ‰å¾ˆå¤§çš„éš¾åº¦ã€‚ é¦–å…ˆè¿™å¥—å·¥å…·å¿…é¡»è¿è¡Œåœ¨ Linux ä¸­æ‰è¡Œï¼Œå¯¹äº Bare Metal è£¸æœåŠ¡å™¨æ¥è®²è¿˜æ²¡æœ‰å®‰è£…ä»»ä½• OSï¼Œè¿™å°±å¼•ç”³å‡ºäº†é¸¡ç”Ÿè›‹è›‹ç”Ÿé¸¡çš„">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/2022-05-23-packer-vsphere-example-01.png">
<meta property="og:image" content="https://p.k8s.li/2022-05-23-packer-vsphere-example-02.png">
<meta property="article:published_time" content="2022-05-24T16:00:00.000Z">
<meta property="article:modified_time" content="2022-05-24T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="argo-workflow">
<meta property="article:tag" content="vSphere">
<meta property="article:tag" content="packer">
<meta property="article:tag" content="esxi">
<meta property="article:tag" content="k3s">
<meta property="article:tag" content="redfish">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/2022-05-23-packer-vsphere-example-01.png">


<link rel="canonical" href="https://blog.k8s.li/packer-vsphere-example.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/packer-vsphere-example.html","path":"packer-vsphere-example.html","title":"ä½¿ç”¨ Packer æ„å»ºè™šæ‹Ÿæœºé•œåƒè¸©çš„å‘"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ä½¿ç”¨ Packer æ„å»ºè™šæ‹Ÿæœºé•œåƒè¸©çš„å‘ | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%9D%E9%80%80%E4%B8%89%E8%BF%9E-%F0%9F%98%82"><span class="nav-number">1.</span> <span class="nav-text">åŠé€€ä¸‰è¿ ğŸ˜‚</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Packer"><span class="nav-number">2.</span> <span class="nav-text">Packer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">2.1.</span> <span class="nav-text">ç®€ä»‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85"><span class="nav-number">2.2.</span> <span class="nav-text">å®‰è£…</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">2.3.</span> <span class="nav-text">é…ç½®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#post-processors"><span class="nav-number">2.4.</span> <span class="nav-text">post-processors</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA"><span class="nav-number">2.5.</span> <span class="nav-text">æ„å»º</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">æ„å»ºæµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-vsphere-iso-%E6%9E%84%E5%BB%BA-Base-%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="nav-number">3.1.</span> <span class="nav-text">é€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœº</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E8%BF%87-vsphere-clone-%E6%9E%84%E5%BB%BA%E4%B8%9A%E5%8A%A1%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%B9%B6%E5%AF%BC%E5%87%BA-OVF-x2F-OVA"><span class="nav-number">3.2.</span> <span class="nav-text">é€šè¿‡ vsphere-clone æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º OVF&#x2F;OVA</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#argo-workflow-%E5%92%8C-k3s"><span class="nav-number">4.</span> <span class="nav-text">argo-workflow å’Œ k3s</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#argo-workflow"><span class="nav-number">4.1.</span> <span class="nav-text">argo-workflow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#k8s-and-k3s"><span class="nav-number">4.2.</span> <span class="nav-text">k8s and k3s</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">5.</span> <span class="nav-text">å…¶ä»–</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%84%9F%E5%8F%97"><span class="nav-number">5.1.</span> <span class="nav-text">ä½¿ç”¨æ„Ÿå—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OVA-%E6%A0%BC%E5%BC%8F"><span class="nav-number">5.2.</span> <span class="nav-text">OVA æ ¼å¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-open-vm-tool-%E5%A4%B1%E8%B4%A5"><span class="nav-number">5.3.</span> <span class="nav-text">å®‰è£… open-vm-tool å¤±è´¥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%8F%E5%B0%91%E5%AF%BC%E5%87%BA%E5%90%8E-vmdk-%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F"><span class="nav-number">5.4.</span> <span class="nav-text">å‡å°‘å¯¼å‡ºå vmdk æ–‡ä»¶å¤§å°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Photon3"><span class="nav-number">5.5.</span> <span class="nav-text">Photon3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#goss"><span class="nav-number">5.6.</span> <span class="nav-text">goss</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5-OVA-%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%90%8E-Pod-%E7%8A%B6%E6%80%81%E5%BC%82%E5%B8%B8"><span class="nav-number">5.7.</span> <span class="nav-text">å¯¼å…¥ OVA è™šæ‹Ÿæœºå Pod çŠ¶æ€å¼‚å¸¸</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">6.</span> <span class="nav-text">å‚è€ƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Packer-%E7%9B%B8%E5%85%B3"><span class="nav-number">6.1.</span> <span class="nav-text">Packer ç›¸å…³</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">120</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">155</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail â†’ mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/packer-vsphere-example.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="ä½¿ç”¨ Packer æ„å»ºè™šæ‹Ÿæœºé•œåƒè¸©çš„å‘ | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ä½¿ç”¨ Packer æ„å»ºè™šæ‹Ÿæœºé•œåƒè¸©çš„å‘
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-25 2022-05-25T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2022-05-25T00:00:00+08:00">2022-05-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/packer-vsphere-example.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="packer-vsphere-example.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>39k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>35 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>ä¸ä¹…å‰å†™è¿‡ä¸€ç¯‡åšå®¢ã€Š<a href="https://blog.k8s.li/redfish-esxi-os-installer.html">ä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OS</a>ã€‹åˆ†äº«äº†å¦‚ä½•ä½¿ç”¨ Redfish ç»™ç‰©ç†æœåŠ¡å™¨è‡ªåŠ¨åŒ–å®‰è£… ESXi OSã€‚è™½ç„¶åœ¨æˆ‘ä»¬å†…éƒ¨åšåˆ°äº†ä¸€é”®å®‰è£…&#x2F;é‡è£… ESXi OSï¼Œä½†æƒ³è¦å°†è¿™å¥—æ–¹æ¡ˆåº”ç”¨åœ¨å®¢æˆ·çš„ç§æœ‰äº‘æœºæˆ¿ç¯å¢ƒä¸­è¿˜æ˜¯æœ‰å¾ˆå¤§çš„éš¾åº¦ã€‚</p>
<p>é¦–å…ˆè¿™å¥—å·¥å…·å¿…é¡»è¿è¡Œåœ¨ Linux ä¸­æ‰è¡Œï¼Œå¯¹äº Bare Metal è£¸æœåŠ¡å™¨æ¥è®²è¿˜æ²¡æœ‰å®‰è£…ä»»ä½• OSï¼Œè¿™å°±å¼•ç”³å‡ºäº†é¸¡ç”Ÿè›‹è›‹ç”Ÿé¸¡çš„å°´å°¬éš¾é¢˜ã€‚è™½ç„¶å¯ä»¥ç»™å…¶ä¸­çš„ä¸€å°ç‰©ç†æœåŠ¡å™¨å®‰è£…ä¸Šä¸€ä¸ª Linux å‘è¡Œç‰ˆæ¯”å¦‚ CentOSï¼Œç„¶åå†å°†è¿™å¥—è‡ªåŠ¨åŒ–å®‰è£… ESXi OS çš„å·¥å…·æ­å»ºä¸Šå»ï¼Œä½†è¿™ä¼šé¢å¤–å ç”¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ï¼Œå®¢æˆ·ä¹Ÿè‚¯å®šä¸æ„¿æ„æ¥å—ã€‚</p>
<p>çœŸå®çš„å®æ–½åœºæ™¯ä¸­ï¼Œå¯è¡Œçš„æ–¹æ¡ˆå°±æ˜¯å°†è¿™å¥—å·¥å…·è¿è¡Œåœ¨å®æ–½äººå‘˜çš„ç¬”è®°æœ¬ç”µè„‘æˆ–è€…å®¢æˆ·æä¾›çš„å°å¼æœºä¸Šã€‚è¿™åˆå¼•ç”³å‡ºäº†ä¸€ä¸ªå¦å¤–çš„éš¾é¢˜ï¼šå®æ–½äººå‘˜çš„ç¬”è®°æœ¬ç”µè„‘æˆ–è€…å®¢æˆ·æä¾›çš„å°å¼æœºè¿è¡Œçš„å¤§éƒ½æ˜¯ Windows ç³»ç»Ÿï¼Œåœ¨ Windows ä¸Šå®‰è£… Ansibleã€Makeã€Python3 ç­‰ä¸€å †ä¾èµ–ï¼Œæƒ³æƒ³å°±ä¸å¤ªç°å®ï¼Œè€Œä¸”ç¨³å®šæ€§å’Œå…¼å®¹æ€§å¾ˆéš¾å¾—åˆ°ä¿éšœï¼Œä»¥åŠå¼€å‘ç¯å¢ƒå’Œè¿è¡Œç¯å¢ƒä¸ä¸€è‡´å¯¼è‡´ä¸€äº›å…¶ä»–çš„å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ã€‚è™½ç„¶è¯¥å·¥å…·æ”¯æŒå®¹å™¨åŒ–è¿è¡Œèƒ½å¤Ÿè§£å†³å¼€å‘ç¯å¢ƒå’Œè¿è¡Œç¯å¢ƒä¸ä¸€è‡´çš„é—®é¢˜ï¼Œä½†åœ¨ Windows ä¸Šå®‰è£… docker ä¹Ÿæ¯”è¾ƒç¹çå’Œéº»çƒ¦ã€‚</p>
<p>è¿™æ—¶å€™å°±è¦æ¬å‡ºè®¡ç®—æœºç§‘å­¦ä¸­çš„è‡³ç†åè¨€: <strong>è®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªé—´æ¥çš„ä¸­é—´å±‚æ¥è§£å†³</strong>ã€‚</p>
<blockquote>
<p><strong>Any problem in computer science can be solved by another layer of indirection.</strong></p>
</blockquote>
<p>æ—¢ç„¶æˆ‘ä»¬è¿™å¥—å·¥å…·ç›®å‰åªèƒ½åœ¨ Linux ä¸Šç¨³å®šè¿è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸å¦‚å°±å°†è¿™å¥—å·¥å…·å’Œå®ƒæ‰€è¿è¡Œçš„ç¯å¢ƒå°è£…åœ¨ä¸€ä¸ªâ€œä¸­é—´å®¹å™¨â€é‡Œï¼Œæ¯”å¦‚è™šæ‹Ÿæœºã€‚ä½¿ç”¨è€…åªéœ€è¦å®‰è£…åƒ <a target="_blank" rel="noopener" href="https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html">VMware Workstation</a> æˆ–è€… <a target="_blank" rel="noopener" href="https://www.virtualbox.org/">Oracle VirtualBox</a> è™šæ‹ŸåŒ–ç®¡ç†è½¯ä»¶è¿è¡Œè¿™å°è™šæ‹Ÿæœºä¸å°±è¡Œäº†ã€‚ä¸€åˆ‡çš†å¯å¥—å¨ƒï¼ˆğŸ¤£</p>
<p>å…¶å®åŸç†å°±åƒ docker å®¹å™¨é‚£æ ·ï¼Œæˆ‘ä»¬å°†è¿™å¥—å·¥å…·å’Œå®ƒæ‰€ä¾èµ–çš„è¿è¡Œç¯å¢ƒåœ¨æ„å»ºè™šæ‹Ÿæœºçš„æ—¶å€™å°†å®ƒä»¬å…¨éƒ¨æ‰“åŒ…åœ¨ä¸€èµ·ï¼Œä½¿ç”¨è€…åªéœ€è¦æƒ³åŠæ³•å°†è¿™ä¸ªè™šæ‹Ÿæœºè¿è¡Œèµ·æ¥ï¼Œå°±èƒ½ä¸€é”®ä½¿ç”¨æˆ‘ä»¬è¿™ä¸ªå·¥å…·ï¼Œä¸å¿…å†æ‰‹åŠ¨å®‰è£… Ansible å’Œ Python3 ç­‰ä¸€å †ä¾èµ–äº†ï¼ŒçœŸæ­£åšåˆ°å¼€ç®±å³ç”¨ã€‚</p>
<p>äºæ˜¯æœ¬æ–‡åˆ†äº«ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://www.packer.io/">Packer</a> åœ¨ <a target="_blank" rel="noopener" href="https://www.vmware.com/products/vsphere.html">VMware vSphere</a> ç¯å¢ƒä¸Šæ„å»ºè™šæ‹Ÿæœºé•œåƒçš„æ–¹æ¡ˆï¼Œä»¥åŠå¦‚ä½•åœ¨è¿™ä¸ªè™šæ‹Ÿæœºä¸­è¿è¡Œä¸€ä¸ª k3s é›†ç¾¤ï¼Œç„¶åé€šè¿‡ <a target="_blank" rel="noopener" href="https://github.com/argoproj/argo-workflows">argo-workflow</a> å·¥ä½œæµå¼•æ“è¿è¡Œ <a target="_blank" rel="noopener" href="https://github.com/muzi502/redfish-esxi-os-installer">redfish-esxi-os-installer</a> æ¥å¯¹è£¸é‡‘å±æœåŠ¡å™¨è¿›è¡Œè‡ªåŠ¨åŒ–å®‰è£… ESXi OS çš„æ“ä½œã€‚</p>
<h2 id="åŠé€€ä¸‰è¿-ğŸ˜‚"><a href="#åŠé€€ä¸‰è¿-ğŸ˜‚" class="headerlink" title="åŠé€€ä¸‰è¿ ğŸ˜‚"></a>åŠé€€ä¸‰è¿ ğŸ˜‚</h2><ul>
<li>æå‰ä¸‹è½½å¥½ Base OS çš„ ISO é•œåƒï¼Œæ¯”å¦‚ <a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso">CentOS-7-x86_64-Minimal-2009.iso</a></li>
<li>éœ€è¦ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://www.vmware.com/products/vcenter-server.html">vCenter Server</a> ä»¥åŠä¸€å° <a target="_blank" rel="noopener" href="https://www.vmware.com/products/esxi-and-esx.html">VMware ESXi</a> ä¸»æœº</li>
<li>ESXi çš„ VM Network ç½‘ç»œä¸­éœ€è¦æœ‰ä¸€å° DHCP æœåŠ¡å™¨ç”¨äºç»™ VM åˆ†é… IP</li>
</ul>
<h2 id="Packer"><a href="#Packer" class="headerlink" title="Packer"></a>Packer</h2><p>å¾ˆæ—©ä¹‹å‰ç©å„¿ VMware ESXi çš„æ—¶å€™è¿˜æ²¡æœ‰æ¥è§¦åˆ° Packerï¼Œé‚£æ—¶å€™åªèƒ½ä½¿ç”¨<a href="https://blog.k8s.li/esxi-vmbase.html">æ‰‹æ“è™šæ‹Ÿæœºæ¨¡ç‰ˆ</a>çš„æ–¹å¼ï¼Œè´¹æ—¶è´¹åŠ›è¿˜å®¹æ˜“å‡ºé”™ï¼Œä¸‹é¢å°±ä»‹ç»ä¸€ä¸‹è¿™ä¸ªè‡ªåŠ¨åŒ–æ„å»ºè™šæ‹Ÿæœºé•œåƒçš„å·¥å…·ã€‚</p>
<h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p><a target="_blank" rel="noopener" href="https://github.com/hashicorp/packer">Packer</a> æ˜¯ <a target="_blank" rel="noopener" href="https://www.hashicorp.com/">hashicorp</a> å…¬å¸å¼€æºçš„ä¸€ä¸ªè™šæ‹Ÿæœºé•œåƒæ„å»ºå·¥å…·ï¼Œä¸å®ƒç±»ä¼¼çš„å·¥å…·è¿˜æœ‰ <a target="_blank" rel="noopener" href="https://github.com/openstack/diskimage-builder">OpenStack diskimage-builder</a>ã€<a target="_blank" rel="noopener" href="https://aws.amazon.com/image-builder/">AWS EC2 Image Builder</a> ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªåªæ”¯æŒè‡ªå®¶çš„å¹³å°ã€‚Packer èƒ½å¤Ÿæ”¯æŒä¸»æµçš„å…¬æœ‰äº‘ã€ç§æœ‰äº‘ä»¥åŠæ··åˆäº‘ï¼Œæ¯”å®ƒä¿©é«˜åˆ°ä¸çŸ¥é“å“ªé‡Œå»äº†ã€‚å¯ä»¥è¿™ä¹ˆæ¥ç†è§£ï¼šPacker åœ¨ IaaS è™šæ‹ŸåŒ–é¢†åŸŸçš„åœ°ä½å°±åƒ Docker åœ¨ PaaS å®¹å™¨è™šæ‹Ÿä¸­é‚£æ ·é‡è¦ï¼Œä¸€ä¸ªæ˜¯è™šæ‹Ÿæœºé•œåƒçš„æ„å»ºï¼Œå¦ä¸€ä¸ªå®¹å™¨é•œåƒçš„æ„å»ºï¼Œæœ‰è¶£çš„æ˜¯ä¸¤è€…éƒ½æ˜¯åœ¨ 2013 å¹´æˆç«‹çš„é¡¹ç›®ã€‚</p>
<p>Kubernetes ç¤¾åŒºçš„ <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/image-builder">image-builder</a> é¡¹ç›®å°±æ˜¯ä½¿ç”¨ Packer æ„å»ºä¸€äº›å…¬æœ‰äº‘åŠç§æœ‰äº‘çš„è™šæ‹Ÿæœºæ¨¡ç‰ˆæä¾›ç»™ <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> é¡¹ç›®ä½¿ç”¨ï¼Œååˆ†æ¨èå¤§å®¶å»çœ‹ä¸‹è¿™ä¸ªé¡¹ç›®çš„ä»£ç ï¼Œåˆšå¼€å§‹æˆ‘ä¹Ÿæ˜¯ä»è¿™ä¸ªé¡¹ç›®ç†Ÿæ‚‰ Packer çš„ï¼Œå¹¶ä»ä¸­æŠ„è¢­å€Ÿé‰´äº†å¾ˆå¤šå†…å®¹ ğŸ˜…ã€‚</p>
<p>ä¸‹é¢å°±ä»‹ç»ä¸€ä¸‹ Packer çš„åŸºæœ¬ä½¿ç”¨æ–¹æ³•</p>
<h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>å¯¹äº Linux å‘è¡Œç‰ˆï¼Œå»ºè®®ç›´æ¥ä¸‹è½½äºŒè¿›åˆ¶å®‰è£…åŒ…æ¥å®‰è£…ï¼Œé€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£…æ„Ÿè§‰æœ‰ç‚¹éº»çƒ¦</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">wget</span> https://releases.hashicorp.com/packer/1.8.0/packer_1.8.0_linux_amd64.zip
$ <span class="token function">unzip</span> packer_1.8.0_linux_amd64.zip
$ <span class="token function">mv</span> packer /usr/local/bin/packer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å¦‚æœæ˜¯ macOS ç”¨æˆ·ç›´æ¥ <code>brew install packer</code> å‘½ä»¤ä¸€æŠŠæ¢­å°±èƒ½å®‰è£…å¥½</p>
<h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>ä¸åŒäº Docker æœ‰ä¸€ä¸ª Dockerfile æ–‡ä»¶æ¥å®šä¹‰å¦‚ä½•æ„å»ºå®¹å™¨é•œåƒï¼ŒPacker æ„å»ºè™šæ‹Ÿæœºé•œåƒåˆ™æ˜¯ç”±ä¸€ç³»åˆ—çš„é…ç½®æ–‡ä»¶ç¼åˆè€Œæˆï¼Œä¸»è¦ç”± <a target="_blank" rel="noopener" href="https://www.packer.io/docs/terminology#builders">Builders</a> ã€<a target="_blank" rel="noopener" href="https://www.packer.io/docs/terminology#provisioners">Provisioners</a> ã€<a target="_blank" rel="noopener" href="https://www.packer.io/docs/terminology#post-processors">Post-processors</a> è¿™ä¸‰éƒ¨åˆ†ç»„æˆã€‚å…¶ä¸­ Builder ä¸»è¦æ˜¯ä¸ IaaS Provider æ„å»ºå™¨ç›¸å…³çš„ä¸€äº›å‚æ•°ï¼›Provisioner ç”¨æ¥é…ç½®æ„å»ºè¿‡ç¨‹ä¸­éœ€è¦è¿è¡Œçš„ä¸€äº›ä»»åŠ¡ï¼›Post-processors ç”¨äºé…ç½®æ„å»ºåŠ¨ä½œå®Œæˆåçš„ä¸€äº›åå¤„ç†æ“ä½œï¼›ä¸‹é¢å°±ä¾æ¬¡ä»‹ç»ä¸€ä¸‹è¿™å‡ ä¸ªé…ç½®çš„è¯¦ç»†ä½¿ç”¨è¯´æ˜ï¼š</p>
<p>å¦å¤– Packer æ¨èçš„é…ç½®è¯­æ³•æ˜¯ <a target="_blank" rel="noopener" href="https://www.packer.io/guides/hcl">HCL2</a>ï¼Œä½†ä¸ªäººè§‰ç€ HCL çš„è¯­æ³•é£æ ¼æ€ªæ€ªçš„ï¼Œä¸å¦‚ json é‚£æ ·æ•´æ´å¥½çœ‹ ğŸ˜…ï¼Œå› æ­¤ä¸‹é¢æˆ‘ç»Ÿä¸€ä½¿ç”¨ json æ¥è¿›è¡Œé…ç½®ï¼Œå…¶å®å‚æ•°éƒ½ä¸€æ ·ï¼Œåªæ˜¯æ ¼å¼ä¸ç›¸åŒè€Œå·²ã€‚</p>
<h4 id="vars-x2F-var-file"><a href="#vars-x2F-var-file" class="headerlink" title="vars&#x2F;var-file"></a>vars&#x2F;var-file</h4><p>Packer çš„å˜é‡é…ç½®æ–‡ä»¶æœ‰ç‚¹ç±»ä¼¼äº Ansible ä¸­çš„ varsã€‚ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„æ–¹å¼å°±æ˜¯æŒ‰ç…§æ¯ä¸ªå‚æ•°çš„ä½œç”¨åŸŸè¿›è¡Œåˆ†ç±»æ•´ç†ï¼Œå°†å®ƒä»¬ç»Ÿä¸€æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™æ ·ç»´æŠ¤èµ·æ¥ä¼šæ›´æ–¹ä¾¿ä¸€äº›ã€‚å‚è€ƒäº† image-builder é¡¹ç›®ä¸­çš„ <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/image-builder/tree/master/images/capi/packer/ova">ova</a> æ„å»ºåæˆ‘æ ¹æ®å‚æ•°çš„ä¸åŒä½œç”¨åˆ’åˆ†æˆäº†å¦‚ä¸‹å‡ ä¸ªé…ç½®æ–‡ä»¶ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/vcenter.json">vcenter.json</a>ï¼šä¸»è¦ç”¨äºé…ç½®ä¸€äº›ä¸ vCenter ç›¸å…³çš„å‚æ•°ï¼Œæ¯”å¦‚ datastoreã€datacenterã€resource_poolã€vcenter_server ç­‰ï¼›å¦å¤–åƒ vcenter çš„ç”¨æˆ·åå’Œå¯†ç å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡çš„æ–¹å¼ï¼Œé¿å…æ˜æ–‡ç¼–ç åœ¨æ–‡ä»¶å½“ä¸­ï¼›</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"folder"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>
  <span class="token property">"resource_pool"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>
  <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>
  <span class="token property">"datacenter"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>
  <span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token string">"Packer"</span><span class="token punctuation">,</span>
  <span class="token property">"convert_to_template"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
  <span class="token property">"create_snapshot"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
  <span class="token property">"linked_clone"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
  <span class="token property">"network"</span><span class="token operator">:</span> <span class="token string">"VM Network"</span><span class="token punctuation">,</span>
  <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"password"</span><span class="token punctuation">,</span>
  <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"administrator@vsphere.local"</span><span class="token punctuation">,</span>
  <span class="token property">"vcenter_server"</span><span class="token operator">:</span> <span class="token string">"vcenter.k8s.li"</span><span class="token punctuation">,</span>
  <span class="token property">"insecure_connection"</span><span class="token operator">:</span> <span class="token string">"true"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/centos7.json">centos7.json</a>ï¼šä¸»è¦ç”¨äºé…ç½®ä¸€äº›é€šè¿‡ ISO å®‰è£… CentOS çš„å‚æ•°ï¼Œæ¯”å¦‚ ISO çš„ä¸‹è½½åœ°å€ã€ISO çš„ checksumã€kickstart æ–‡ä»¶è·¯å¾„ã€å…³æœºå‘½ä»¤ã€isolinux å¯åŠ¨å‚æ•°ç­‰ï¼›</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"boot_command_prefix"</span><span class="token operator">:</span> <span class="token string">"&lt;tab> text ks=hd:fd0:"</span><span class="token punctuation">,</span>
  <span class="token property">"boot_command_suffix"</span><span class="token operator">:</span> <span class="token string">"/7/ks.cfg&lt;enter>&lt;wait>"</span><span class="token punctuation">,</span>
  <span class="token property">"boot_media_path"</span><span class="token operator">:</span> <span class="token string">"/HTTP"</span><span class="token punctuation">,</span>
  <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"centos-7"</span><span class="token punctuation">,</span>
  <span class="token property">"distro_arch"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>
  <span class="token property">"distro_name"</span><span class="token operator">:</span> <span class="token string">"centos"</span><span class="token punctuation">,</span>
  <span class="token property">"distro_version"</span><span class="token operator">:</span> <span class="token string">"7"</span><span class="token punctuation">,</span>
  <span class="token property">"floppy_dirs"</span><span class="token operator">:</span> <span class="token string">"./kickstart/&#123;&#123;user `distro_name`&#125;&#125;/http/"</span><span class="token punctuation">,</span>
  <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"centos7-64"</span><span class="token punctuation">,</span>
  <span class="token property">"iso_checksum"</span><span class="token operator">:</span> <span class="token string">"07b94e6b1a0b0260b94c83d6bb76b26bf7a310dc78d7a9c7432809fb9bc6194a"</span><span class="token punctuation">,</span>
  <span class="token property">"iso_checksum_type"</span><span class="token operator">:</span> <span class="token string">"sha256"</span><span class="token punctuation">,</span>
  <span class="token property">"iso_url"</span><span class="token operator">:</span> <span class="token string">"https://mirrors.edge.kernel.org/centos/7.9.2009/isos/x86_64/CentOS-7-x86_64-Minimal-2009.iso"</span><span class="token punctuation">,</span>
  <span class="token property">"os_display_name"</span><span class="token operator">:</span> <span class="token string">"CentOS 7"</span><span class="token punctuation">,</span>
  <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"shutdown -h now"</span><span class="token punctuation">,</span>
  <span class="token property">"vsphere_guest_os_type"</span><span class="token operator">:</span> <span class="token string">"centos7_64Guest"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/photon3.json">photon3.json</a>ï¼šä¸»è¦ç”¨äºé…ç½®ä¸€äº›é€šè¿‡ ISO å®‰è£… Photon3 OS çš„å‚æ•°ï¼Œå’Œä¸Šé¢çš„ centos7.json ä½œç”¨åŸºæœ¬ä¸€è‡´ï¼›</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"boot_command_prefix"</span><span class="token operator">:</span> <span class="token string">"&lt;esc>&lt;wait> vmlinuz initrd=initrd.img root/dev/ram0 loglevel=3 photon.media=cdrom ks="</span><span class="token punctuation">,</span>
  <span class="token property">"boot_command_suffix"</span><span class="token operator">:</span> <span class="token string">"/3/ks.json&lt;enter>&lt;wait>"</span><span class="token punctuation">,</span>
  <span class="token property">"boot_media_path"</span><span class="token operator">:</span> <span class="token string">"http://&#123;&#123; .HTTPIP &#125;&#125;:&#123;&#123; .HTTPPort &#125;&#125;"</span><span class="token punctuation">,</span>
  <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"photon-3"</span><span class="token punctuation">,</span>
  <span class="token property">"distro_arch"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>
  <span class="token property">"distro_name"</span><span class="token operator">:</span> <span class="token string">"photon"</span><span class="token punctuation">,</span>
  <span class="token property">"distro_version"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>
  <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"vmware-photon-64"</span><span class="token punctuation">,</span>
  <span class="token property">"http_directory"</span><span class="token operator">:</span> <span class="token string">"./kickstart/&#123;&#123;user `distro_name`&#125;&#125;/http/"</span><span class="token punctuation">,</span>
  <span class="token property">"iso_checksum"</span><span class="token operator">:</span> <span class="token string">"c2883a42e402a2330d9c39b4d1e071cf9b3b5898"</span><span class="token punctuation">,</span>
  <span class="token property">"iso_checksum_type"</span><span class="token operator">:</span> <span class="token string">"sha1"</span><span class="token punctuation">,</span>
  <span class="token property">"iso_url"</span><span class="token operator">:</span> <span class="token string">"https://packages.vmware.com/photon/3.0/Rev3/iso/photon-minimal-3.0-a383732.iso"</span><span class="token punctuation">,</span>
  <span class="token property">"os_display_name"</span><span class="token operator">:</span> <span class="token string">"VMware Photon OS 64-bit"</span><span class="token punctuation">,</span>
  <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"shutdown now"</span><span class="token punctuation">,</span>
  <span class="token property">"vsphere_guest_os_type"</span><span class="token operator">:</span> <span class="token string">"vmwarePhoton64Guest"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/common.json">common.json</a>ï¼šä¸€äº›å…¬å…±å‚æ•°ï¼Œæ¯”å¦‚è™šæ‹Ÿæœºçš„ ssh ç”¨æˆ·åå’Œå¯†ç ï¼ˆè¦å’Œ kickstart ä¸­è®¾ç½®çš„ä¿æŒä¸€è‡´ï¼‰ã€è™šæ‹Ÿæœºçš„ä¸€äº›ç¡¬ä»¶é…ç½®å¦‚ CPUã€å†…å­˜ã€ç¡¬ç›˜ã€è™šæ‹Ÿæœºç‰ˆæœ¬ã€ç½‘å¡ç±»å‹ã€å­˜å‚¨æ§åˆ¶å™¨ç±»å‹ç­‰ï¼›</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"ssh_username"</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
  <span class="token property">"ssh_password"</span><span class="token operator">:</span> <span class="token string">"password"</span><span class="token punctuation">,</span>
  <span class="token property">"boot_wait"</span><span class="token operator">:</span> <span class="token string">"15s"</span><span class="token punctuation">,</span>
  <span class="token property">"disk_controller_type"</span><span class="token operator">:</span> <span class="token string">"lsilogic"</span><span class="token punctuation">,</span>
  <span class="token property">"disk_thin_provisioned"</span><span class="token operator">:</span> <span class="token string">"true"</span><span class="token punctuation">,</span>
  <span class="token property">"disk_type_id"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
  <span class="token property">"firmware"</span><span class="token operator">:</span> <span class="token string">"bios"</span><span class="token punctuation">,</span>
  <span class="token property">"cpu"</span><span class="token operator">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span>
  <span class="token property">"cpu_cores"</span><span class="token operator">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span>
  <span class="token property">"memory"</span><span class="token operator">:</span> <span class="token string">"4096"</span><span class="token punctuation">,</span>
  <span class="token property">"disk_size"</span><span class="token operator">:</span> <span class="token string">"65536"</span><span class="token punctuation">,</span>
  <span class="token property">"network_card"</span><span class="token operator">:</span> <span class="token string">"e1000"</span><span class="token punctuation">,</span>
  <span class="token property">"ssh_timeout"</span><span class="token operator">:</span> <span class="token string">"3m"</span><span class="token punctuation">,</span>
  <span class="token property">"vmx_version"</span><span class="token operator">:</span> <span class="token string">"14"</span><span class="token punctuation">,</span>
  <span class="token property">"base_build_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `template`&#125;&#125;"</span><span class="token punctuation">,</span>
  <span class="token property">"build_timestamp"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;timestamp&#125;&#125;"</span><span class="token punctuation">,</span>
  <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"k3s"</span><span class="token punctuation">,</span>
  <span class="token property">"build_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ova_name`&#125;&#125;"</span><span class="token punctuation">,</span>
  <span class="token property">"export_manifest"</span><span class="token operator">:</span> <span class="token string">"none"</span><span class="token punctuation">,</span>
  <span class="token property">"output_dir"</span><span class="token operator">:</span> <span class="token string">"./output/&#123;&#123;user `build_version`&#125;&#125;"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Builder"><a href="#Builder" class="headerlink" title="Builder"></a>Builder</h4><p>Builder å°±æ˜¯å‘Šè¯‰ Packer è¦ä½¿ç”¨ä»€ä¹ˆç±»å‹çš„æ„å»ºå™¨æ„å»ºä»€ä¹ˆæ ·çš„è™šæ‹Ÿæœºé•œåƒï¼Œä¸»è¦æ˜¯ä¸åº•å±‚ IaaS èµ„æºæä¾›å•†ç›¸å…³çš„é…ç½®ã€‚æ¯”å¦‚ <a target="_blank" rel="noopener" href="https://www.packer.io/plugins/builders/vsphere">vSphere Builder</a> ä¸­æœ‰å¦‚ä¸‹ä¸¤ç§æ„å»ºå™¨ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/docs/builders/vsphere/vsphere-iso">vsphere-iso</a> ä» ISO å®‰è£… OS å¼€å§‹æ„å»ºï¼Œé€šå¸¸æƒ…å†µä¸‹æ„å»ºä¸ºä¸€ä¸ªè™šæ‹Ÿæœºæˆ–è™šæ‹Ÿæœºæ¨¡ç‰ˆ</li>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/docs/builders/vsphere/vsphere-clone">vsphere-clone</a> é€šè¿‡ clone è™šæ‹Ÿæœºçš„æ–¹å¼è¿›è¡Œæ„å»ºï¼Œé€šå¸¸æƒ…å†µä¸‹æ„å»ºäº§ç‰©ä¸ºå¯¼å‡ºåçš„ OVF&#x2F;OVA æ–‡ä»¶</li>
</ul>
<p>ä¸åŒç±»å‹çš„ Builder é…ç½®å‚æ•°ä¹Ÿä¼šæœ‰æ‰€ä¸åŒï¼Œæ¯ä¸ªå‚æ•°çš„è¯¦ç»†ç”¨é€”å’Œè¯´æ˜å¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://www.packer.io/plugins">Packer å®˜æ–¹çš„æ–‡æ¡£</a>ï¼Œåœ¨è¿™é‡Œå°±ä¸ä¸€ä¸€è¯´æ˜äº†ã€‚å› ä¸º Packer çš„å‚æ•°é…ç½®æ˜¯åœ¨æ˜¯å¤ªå¤šå¤ªå¤æ‚äº†ï¼Œå¾ˆéš¾ä¸‰è¨€ä¸¤è¯­è®²æ¸…æ¥šã€‚æœ€ä½³çš„æ–¹å¼å°±æ˜¯é˜…è¯»å®˜æ–¹çš„æ–‡æ¡£å’Œä¸€äº›å…¶ä»–é¡¹ç›®çš„å®ç°æ–¹å¼ï¼Œç…§è‘«èŠ¦ç”»ç“¢å­¦å°±è¡Œã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/packer/builder.json">builders.json</a>ï¼šé‡Œé¢çš„é…ç½®å‚æ•°å¤§å¤šéƒ½æ˜¯å¼•ç”¨çš„ var-file ä¸­çš„å‚æ•°ï¼Œå°†è¿™äº›å‚æ•°å•ç‹¬æŠ½å‡ºæ¥çš„å¥½å¤„å°±æ˜¯ä¸åŒçš„ builder ä¹‹é—´å¯ä»¥å¤ç”¨ä¸€äº›å…¬å…±å‚æ•°ã€‚æ¯”å¦‚ vsphere-iso å’Œ vsphere-clone è¿™ä¸¤ç§ä¸åŒçš„ builder ä¸ vCenter ç›¸å…³çš„ datacenterã€datastoreã€vcenter_server ç­‰å‚æ•°éƒ½æ˜¯å…¶å®ç›¸åŒçš„ã€‚</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/docs/builders/vsphere/vsphere-iso">vsphere-iso</a> ï¼šé€šè¿‡ ISO å®‰è£… OS æ„å»ºä¸€ä¸ªè™šæ‹Ÿæœºæˆ–è™šæ‹Ÿæœºæ¨¡ç‰ˆ</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"builders"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"CPUs"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"RAM"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `memory`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"boot_command"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"&#123;&#123;user `boot_command_prefix`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token string">"&#123;&#123;user `boot_media_path`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token string">"&#123;&#123;user `boot_command_suffix`&#125;&#125;"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"boot_wait"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `boot_wait`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cluster`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"communicator"</span><span class="token operator">:</span> <span class="token string">"ssh"</span><span class="token punctuation">,</span>
      <span class="token property">"convert_to_template"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `convert_to_template`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"cpu_cores"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu_cores`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"create_snapshot"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `create_snapshot`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"datacenter"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datacenter`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datastore`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"disk_controller_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_controller_type`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"firmware"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `firmware`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"floppy_dirs"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `floppy_dirs`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"folder"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `folder`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vsphere_guest_os_type`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `host`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"http_directory"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `http_directory`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"insecure_connection"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `insecure_connection`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"iso_checksum"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `iso_checksum_type`&#125;&#125;:&#123;&#123;user `iso_checksum`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"iso_urls"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `iso_url`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"vsphere-iso-base"</span><span class="token punctuation">,</span>
      <span class="token property">"network_adapters"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
          <span class="token property">"network"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `network`&#125;&#125;"</span><span class="token punctuation">,</span>
          <span class="token property">"network_card"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `network_card`&#125;&#125;"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `password`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"echo '&#123;&#123;user `ssh_password`&#125;&#125;' | sudo -S -E sh -c '&#123;&#123;user `shutdown_command`&#125;&#125;'"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_clear_authorized_keys"</span><span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_password`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_timeout"</span><span class="token operator">:</span> <span class="token string">"4h"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_username`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"storage"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
          <span class="token property">"disk_size"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_size`&#125;&#125;"</span><span class="token punctuation">,</span>
          <span class="token property">"disk_thin_provisioned"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_thin_provisioned`&#125;&#125;"</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"vsphere-iso"</span><span class="token punctuation">,</span>
      <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `username`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"vcenter_server"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vcenter_server`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"vm_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `base_build_version`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"vm_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vmx_version`&#125;&#125;"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/docs/builders/vsphere/vsphere-clone">vsphere-clone</a>ï¼šé€šè¿‡ clone è™šæ‹Ÿæœºæ„å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼Œå¹¶å¯¼å‡ºè™šæ‹Ÿæœº OVF æ¨¡ç‰ˆ</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"builders"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"CPUs"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"RAM"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `memory`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"cluster"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cluster`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"communicator"</span><span class="token operator">:</span> <span class="token string">"ssh"</span><span class="token punctuation">,</span>
      <span class="token property">"convert_to_template"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `convert_to_template`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"cpu_cores"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu_cores`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"create_snapshot"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `create_snapshot`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"datacenter"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datacenter`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"datastore"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `datastore`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"export"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"force"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token property">"manifest"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `export_manifest`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"output_directory"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `output_dir`&#125;&#125;"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"folder"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `folder`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"host"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `host`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"insecure_connection"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `insecure_connection`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"linked_clone"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `linked_clone`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"vsphere-clone"</span><span class="token punctuation">,</span>
      <span class="token property">"network"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `network`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `password`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"shutdown_command"</span><span class="token operator">:</span> <span class="token string">"echo '&#123;&#123;user `ssh_password`&#125;&#125;' | sudo -S -E sh -c '&#123;&#123;user `shutdown_command`&#125;&#125;'"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_password"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_password`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_timeout"</span><span class="token operator">:</span> <span class="token string">"4h"</span><span class="token punctuation">,</span>
      <span class="token property">"ssh_username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `ssh_username`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"template"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `template`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"vsphere-clone"</span><span class="token punctuation">,</span>
      <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `username`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"vcenter_server"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vcenter_server`&#125;&#125;"</span><span class="token punctuation">,</span>
      <span class="token property">"vm_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `build_version`&#125;&#125;"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="Provisioner"><a href="#Provisioner" class="headerlink" title="Provisioner"></a><a target="_blank" rel="noopener" href="https://www.packer.io/docs/provisioners">Provisioner</a></h4><p>Provisioner å°±æ˜¯å‘Šè¯‰ Packer è¦å¦‚ä½•æ„å»ºé•œåƒï¼Œæœ‰ç‚¹ç±»ä¼¼äº Dockerile ä¸­çš„ RUN&#x2F;COPY&#x2F;ADD ç­‰æŒ‡ä»¤ï¼Œç”¨äºæ‰§è¡Œä¸€äº›å‘½ä»¤&#x2F;è„šæœ¬ã€å¾€è™šæ‹Ÿæœºé‡Œæ·»åŠ ä¸€äº›æ–‡ä»¶ã€è°ƒç”¨ç¬¬ä¸‰æ–¹æ’ä»¶æ‰§è¡Œä¸€äº›æ“ä½œç­‰ã€‚</p>
<p>åœ¨è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­æˆ‘å…ˆä½¿ç”¨ file æ¨¡å—å°†ä¸€äº›è„šæœ¬å’Œä¾èµ–æ–‡ä»¶ä¸Šä¼ åˆ°è™šæ‹Ÿæœºä¸­ï¼Œç„¶åä½¿ç”¨ shell æ¨¡å—åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œ install.sh å®‰è£…è„šæœ¬ã€‚å¦‚æœæ„å»ºçš„ builder æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚éœ€è¦æ”¯æŒå¤šä¸ª Linux å‘è¡Œç‰ˆï¼Œè¿™ç§åœºæ™¯å»ºè®®ä½¿ç”¨ Ansibleã€‚ç”±äºæˆ‘åœ¨ ISO å®‰è£… OS çš„æ„å»ºæµç¨‹ä¸­å·²ç»å°†ä¸€äº›ä¸ OS å‘è¡Œç‰ˆç›¸å…³çš„æ“ä½œå®Œæˆäº†ï¼Œåœ¨è¿™é‡Œä½¿ç”¨ shell æ‰§è¡Œçš„æ“ä½œä¸éœ€è¦åŒºåˆ†å“ªä¸ª Linux å‘è¡Œç‰ˆï¼Œæ‰€ä»¥å°±æ²¡æœ‰ä½¿ç”¨ ansibleã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"provisioners"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>
      <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"scripts"</span><span class="token punctuation">,</span>
      <span class="token property">"destination"</span><span class="token operator">:</span> <span class="token string">"/root"</span><span class="token punctuation">,</span>
      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"vsphere-iso-base"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"file"</span><span class="token punctuation">,</span>
      <span class="token property">"source"</span><span class="token operator">:</span> <span class="token string">"resources"</span><span class="token punctuation">,</span>
      <span class="token property">"destination"</span><span class="token operator">:</span> <span class="token string">"/root"</span><span class="token punctuation">,</span>
      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"vsphere-iso-base"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"shell"</span><span class="token punctuation">,</span>
      <span class="token property">"environment_vars"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"INSECURE_REGISTRY=&#123;&#123;user `insecure_registry`&#125;&#125;"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"inline"</span><span class="token operator">:</span> <span class="token string">"bash /root/scripts/install.sh"</span><span class="token punctuation">,</span>
      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"vsphere-iso-base"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="post-processors"><a href="#post-processors" class="headerlink" title="post-processors"></a>post-processors</h3><p>ä¸€äº›æ„å»ºåçš„æ“ä½œï¼Œ æ¯”å¦‚ <code>&quot;type&quot;: &quot;manifest&quot;</code> å¯ä»¥å¯¼å‡ºä¸€äº›æ„å»ºè¿‡ç¨‹ä¸­çš„é…ç½®å‚æ•°ï¼Œç»™åç»­çš„å…¶ä»–æ“ä½œæ¥ä½¿ç”¨ã€‚å†æ¯”å¦‚ <code>&quot;type&quot;: &quot;shell-local&quot;</code> å°±æ˜¯æ‰§è¡Œä¸€äº› shell è„šæœ¬ï¼Œåœ¨è¿™é‡Œå°±æ˜¯æ‰§è¡Œä¸€ä¸ª Python è„šæœ¬å°† OVF è½¬æ¢æˆ OVAã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"post-processors"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"custom_data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"release_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `release_version`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"build_date"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;isotime&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"build_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `build_name`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"build_timestamp"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `build_timestamp`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"build_type"</span><span class="token operator">:</span> <span class="token string">"node"</span><span class="token punctuation">,</span>
        <span class="token property">"cpu"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `cpu`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"memory"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `memory`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"disk_size"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `disk_size`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"distro_arch"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `distro_arch` &#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"distro_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `distro_name` &#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"distro_version"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123; user `distro_version` &#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"firmware"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `firmware`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"guest_os_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `guest_os_type`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"os_name"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `os_display_name`&#125;&#125;"</span><span class="token punctuation">,</span>
        <span class="token property">"vsphere_guest_os_type"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `vsphere_guest_os_type`&#125;&#125;"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"packer-manifest"</span><span class="token punctuation">,</span>
      <span class="token property">"output"</span><span class="token operator">:</span> <span class="token string">"&#123;&#123;user `output_dir`&#125;&#125;/packer-manifest.json"</span><span class="token punctuation">,</span>
      <span class="token property">"strip_path"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"manifest"</span><span class="token punctuation">,</span>
      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"vsphere-iso-base"</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"inline"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"python3 ./scripts/ova.py --vmx &#123;&#123;user `vmx_version`&#125;&#125; --ovf_template &#123;&#123;user `ovf_template`&#125;&#125; --build_dir=&#123;&#123;user `output_dir`&#125;&#125;"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"except"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"vsphere-iso-base"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"vsphere"</span><span class="token punctuation">,</span>
      <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"shell-local"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="æ„å»º"><a href="#æ„å»º" class="headerlink" title="æ„å»º"></a>æ„å»º</h3><p><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example">packer-vsphere-example</a> é¡¹ç›®çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">..</span>/packer-vsphere-example
â”œâ”€â”€ kickstart        <span class="token comment"># kickstart é…ç½®æ–‡ä»¶å­˜æ”¾ç›®å½•</span>
â”œâ”€â”€ Makefile         <span class="token comment"># makefileï¼Œmake å‘½ä»¤çš„æ“ä½œçš„å…¥å£</span>
â”œâ”€â”€ packer           <span class="token comment"># packer é…ç½®æ–‡ä»¶</span>
â”‚   â”œâ”€â”€ builder.json <span class="token comment"># packer builder é…ç½®æ–‡ä»¶</span>
â”‚   â”œâ”€â”€ centos7.json <span class="token comment"># centos iso å®‰è£… os çš„é…ç½®</span>
â”‚   â”œâ”€â”€ common.json  <span class="token comment"># ä¸€äº›å…¬å…±é…ç½®å‚æ•°</span>
â”‚   â”œâ”€â”€ photon3.json <span class="token comment"># photon3 iso å®‰è£… os çš„é…ç½®</span>
â”‚   â””â”€â”€ vcenter.json <span class="token comment"># vcenter ç›¸å…³çš„é…ç½®</span>
â”œâ”€â”€ resources        <span class="token comment"># ä¸€äº› k8s manifests æ–‡ä»¶</span>
â””â”€â”€ scripts          <span class="token comment"># æ„å»ºè¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„è„šæœ¬æ–‡ä»¶</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸ docker ç±»ä¼¼ï¼Œpacker æ‰§è¡Œæ„å»ºæ“ä½œçš„å­å‘½ä»¤åŒæ ·ä¹Ÿæ˜¯ buildï¼Œå³ <code>packer build</code>ï¼Œä¸è¿‡ packer build å‘½ä»¤æ”¯æŒçš„é€‰é¡¹å¹¶æ²¡æœ‰ docker é‚£ä¹ˆä¸°å¯Œã€‚æœ€æ ¸å¿ƒé€‰é¡¹å°±æ˜¯ -except, -only, -var,  -var-file è¿™å‡ ä¸ªï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ packer build
Options:

	<span class="token comment"># æ§åˆ¶ç»ˆç«¯é¢œè‰²è¾“å‡º</span>
  <span class="token parameter variable">-color</span><span class="token operator">=</span>false                  Disable color output. <span class="token punctuation">(</span>Default: color<span class="token punctuation">)</span>
  <span class="token comment"># debug æ¨¡å¼ï¼Œç±»ä¼¼äºæ–­ç‚¹çš„æ–¹å¼è¿è¡Œ</span>
  <span class="token parameter variable">-debug</span>                        Debug mode enabled <span class="token keyword">for</span> builds.
  <span class="token comment"># æ’é™¤ä¸€äº› builderï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible çš„ --skip-tags</span>
  <span class="token parameter variable">-except</span><span class="token operator">=</span>foo,bar,baz           Run all builds and post-processors other than these.
  <span class="token comment"># æŒ‡å®šè¿è¡ŒæŸäº› builderï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible çš„ --tags</span>
  <span class="token parameter variable">-only</span><span class="token operator">=</span>foo,bar,baz             Build only the specified builds.
  <span class="token comment"># å¼ºåˆ¶æ„å»ºï¼Œå¦‚æœæ„å»ºç›®æ ‡å·²ç»å­˜åœ¨åˆ™å¼ºåˆ¶åˆ é™¤é‡æ–°æ„å»º</span>
  <span class="token parameter variable">-force</span>                        Force a build to <span class="token builtin class-name">continue</span> <span class="token keyword">if</span> artifacts exist, deletes existing artifacts.
  -machine-readable             Produce machine-readable output.
  <span class="token comment"># å‡ºç°é”™è¯¯ä¹‹åçš„åŠ¨ä½œï¼Œcleanup æ¸…ç†æ‰€æœ‰æ“ä½œã€abort ä¸­æ–­æ‰§è¡Œã€ask è¯¢é—®ã€</span>
  -on-error<span class="token operator">=</span><span class="token punctuation">[</span>cleanup<span class="token operator">|</span>abort<span class="token operator">|</span>ask<span class="token operator">|</span>run-cleanup-provisioner<span class="token punctuation">]</span> If the build fails do: clean up <span class="token punctuation">(</span>default<span class="token punctuation">)</span>, abort, ask, or run-cleanup-provisioner.
  <span class="token comment"># å¹¶è¡Œè¿è¡Œçš„ builder æ•°é‡ï¼Œé»˜è®¤æ²¡æœ‰é™åˆ¶ï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible ä¸­çš„ --forks å‚æ•°</span>
  -parallel-builds<span class="token operator">=</span><span class="token number">1</span>            Number of builds to run <span class="token keyword">in</span> parallel. <span class="token number">1</span> disables parallelization. <span class="token number">0</span> means no limit <span class="token punctuation">(</span>Default: <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token comment"># UI è¾“å‡ºçš„æ—¶é—´æˆ³</span>
  -timestamp-ui                 Enable prefixing of each ui output with an RFC3339 timestamp.
  <span class="token comment"># å˜é‡å‚æ•°ï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible çš„ -e é€‰é¡¹</span>
  <span class="token parameter variable">-var</span> <span class="token string">'key=value'</span>              Variable <span class="token keyword">for</span> templates, can be used multiple times.
  <span class="token comment"># å˜é‡æ–‡ä»¶ï¼Œæœ‰ç‚¹ç±»ä¼¼äº ansible çš„ -e@ é€‰é¡¹</span>
  -var-file<span class="token operator">=</span>path                JSON or HCL2 <span class="token function">file</span> containing user variables.

<span class="token comment"># æŒ‡å®šä¸€äº› var å‚æ•°ä»¥åŠ var-file æ–‡ä»¶ï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯ builder çš„é…ç½®æ–‡ä»¶è·¯å¾„</span>
$ packer build  <span class="token parameter variable">--var</span> <span class="token assign-left variable">ova_name</span><span class="token operator">=</span>k3s-photon3-c4ca93f <span class="token parameter variable">--var</span> <span class="token assign-left variable">release_version</span><span class="token operator">=</span>c4ca93f <span class="token parameter variable">--var</span> <span class="token assign-left variable">ovf_template</span><span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/scripts/ovf_template.xml <span class="token parameter variable">--var</span> <span class="token assign-left variable">template</span><span class="token operator">=</span>base-os-photon3 <span class="token parameter variable">--var</span> <span class="token assign-left variable">username</span><span class="token operator">=</span><span class="token variable">$&#123;VCENTER_USERNAME&#125;</span> <span class="token parameter variable">--var</span> <span class="token assign-left variable">password</span><span class="token operator">=</span><span class="token variable">$&#123;VCENTER_PASSWORD&#125;</span> <span class="token parameter variable">--var</span> <span class="token assign-left variable">vcenter_server</span><span class="token operator">=</span><span class="token variable">$&#123;VCENTER_SERVER&#125;</span> <span class="token parameter variable">--var</span> <span class="token assign-left variable">build_name</span><span class="token operator">=</span>k3s-photon3 <span class="token parameter variable">--var</span> <span class="token assign-left variable">output_dir</span><span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/output/k3s-photon3-c4ca93f <span class="token parameter variable">-only</span> vsphere-clone -var-file<span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/vcenter.json -var-file<span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/photon3.json -var-file<span class="token operator">=</span>/root/usr/src/github.com/muzi502/packer-vsphere-example/packer/common.json /root/usr/src/github.com/muzi502/packer-vsphere-example/packer/builder.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸Šé¢é‚£ä¸ªåˆé•¿åˆè‡­çš„ packer build å‘½ä»¤æˆ‘ä»¬åœ¨ <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/Makefile">Makefile</a> é‡Œå°è£…ä¸€ä¸‹ï¼Œé‚£ä¹ˆå¤šçš„å‚æ•°é€‰é¡¹æ‰‹åŠ¨è¾“èµ·æ¥èƒ½æŠŠäººæ°”ç–¯ ğŸ˜‚</p>
<ul>
<li>é¦–å…ˆå®šä¹‰ä¸€äº›é»˜è®¤çš„å‚æ•°ï¼Œæ¯”å¦‚æ„å»ºç‰ˆæœ¬ã€æ„å»ºæ—¶é—´ã€base æ¨¡ç‰ˆåç§°ã€å¯¼å‡º ova æ–‡ä»¶åç§°ç­‰ç­‰ã€‚</li>
</ul>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># Ensure Make is run with bash shell as some syntax below is bash-specific</span>
SHELL<span class="token operator">:=</span>/usr/bin/env bash
.DEFAULT_GOAL<span class="token operator">:=</span>help

<span class="token comment"># Full directory of where the Makefile resides</span>
ROOT_DIR <span class="token operator">:=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> dirname <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">realpath</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">firstword</span> <span class="token variable">$</span><span class="token punctuation">(</span>MAKEFILE_LIST<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

RELEASE_VERSION       <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> git describe --tags --always --dirty<span class="token punctuation">)</span>
RELEASE_TIME          <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> date -u +<span class="token string">'%Y-%m-%dT%H:%M:%SZ'</span><span class="token punctuation">)</span>
PACKER_IMAGE          <span class="token operator">?=</span> hashicorp/packer<span class="token punctuation">:</span>1.8
PACKER_CONFIG_DIR     <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/packer
PACKER_FORCE          <span class="token operator">?=</span> false
PACKER_OVA_PREFIX     <span class="token operator">?=</span> k3s
PACKER_BASE_OS        <span class="token operator">?=</span> centos7
PACKER_OUTPUT_DIR     <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/output
PACKER_TEMPLATE_NAME  <span class="token operator">?=</span> base-os-<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span>
OVF_TEMPLATE          <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/scripts/ovf_template.xml
PACKER_OVA_NAME       <span class="token operator">?=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_PREFIX<span class="token punctuation">)</span>-<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span>-<span class="token variable">$</span><span class="token punctuation">(</span>RELEASE_VERSION<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>ç„¶åå®šä¹‰ vars å’Œ var-file å‚æ•°</li>
</ul>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token comment"># æ˜¯å¦ä¸ºå¼ºåˆ¶æ„å»ºï¼Œå¢åŠ  force å‚æ•°</span>
<span class="token keyword">ifeq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_FORCE<span class="token punctuation">)</span>, true<span class="token punctuation">)</span>
  PACKER_FORCE_ARG <span class="token operator">=</span> --force<span class="token operator">=</span>true
<span class="token keyword">endif</span>

<span class="token comment"># å®šä¹‰ vars å¯å˜å‚æ•°ï¼Œæ¯”å¦‚ vcenter ç”¨æˆ·åã€å¯†ç  ç­‰å‚æ•°</span>
PACKER_VARS <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_FORCE_ARG<span class="token punctuation">)</span> \            <span class="token comment"># æ˜¯å¦å¼ºåˆ¶æ„å»º</span>
	--var ova_name<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_NAME<span class="token punctuation">)</span> \          <span class="token comment"># OVA æ–‡ä»¶å</span>
	--var release_version<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>RELEASE_VERSION<span class="token punctuation">)</span> \   <span class="token comment"># å‘å¸ƒç‰ˆæœ¬</span>
	--var ovf_template<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>OVF_TEMPLATE<span class="token punctuation">)</span> \         <span class="token comment"># OVF æ¨¡ç‰ˆæ–‡ä»¶</span>
	--var template<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_TEMPLATE_NAME<span class="token punctuation">)</span> \     <span class="token comment"># OVA çš„ base è™šæ‹Ÿæœºæ¨¡ç‰ˆåç§°</span>
	--var username<span class="token operator">=</span><span class="token variable">$$</span><span class="token punctuation">&#123;</span>VCENTER_USERNAME<span class="token punctuation">&#125;</span> \        <span class="token comment"># vCenter ç”¨æˆ·åï¼ˆç¯å¢ƒå˜é‡ï¼‰</span>
	--var password<span class="token operator">=</span><span class="token variable">$$</span><span class="token punctuation">&#123;</span>VCENTER_PASSWORD<span class="token punctuation">&#125;</span> \        <span class="token comment"># vCenter å¯†ç ï¼ˆç¯å¢ƒå˜é‡ï¼‰</span>
	--var vcenter_server<span class="token operator">=</span><span class="token variable">$$</span><span class="token punctuation">&#123;</span>VCENTER_SERVER<span class="token punctuation">&#125;</span> \    <span class="token comment"># vCenter è®¿é—®åœ°å€ï¼ˆç¯å¢ƒå˜é‡ï¼‰</span>
	--var build_name<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_PREFIX<span class="token punctuation">)</span>-<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span> \  <span class="token comment"># æ„å»ºåç§°</span>
	--var output_dir<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OUTPUT_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_OVA_NAME<span class="token punctuation">)</span>   <span class="token comment"># OVA å¯¼å‡ºçš„ç›®å½•</span>

<span class="token comment"># å®šä¹‰ var-file å‚æ•°</span>
PACKER_VAR_FILES <span class="token operator">=</span> -var-file<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/vcenter.json \ <span class="token comment"># vCenter çš„å‚æ•°é…ç½®</span>
	-var-file<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>PACKER_BASE_OS<span class="token punctuation">)</span>.json \        <span class="token comment"># OS çš„å‚æ•°é…ç½®</span>
	-var-file<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/common.json                     <span class="token comment"># ä¸€äº›å…¬å…±é…ç½®</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>æœ€åå®šä¹‰ make targrt</li>
</ul>
<pre class="line-numbers language-makefile" data-language="makefile"><code class="language-makefile"><span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> build-template
<span class="token comment"># é€šè¿‡ ISO å®‰è£… OS æ„å»ºä¸€ä¸ª base è™šæ‹Ÿæœº</span>
<span class="token target symbol">build-template</span><span class="token punctuation">:</span> <span class="token comment">## build the base os template by iso</span>
	packer build <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VARS<span class="token punctuation">)</span> -only vsphere-iso-base <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VAR_FILES<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/builder.json

<span class="token builtin-target builtin">.PHONY</span><span class="token punctuation">:</span> build-ovf
<span class="token comment"># é€šè¿‡ clone æ–¹å¼æ„å»ºå¹¶å¯¼å‡º OVF/OVA</span>
<span class="token target symbol">build-ovf</span><span class="token punctuation">:</span> <span class="token comment">## build the ovf template by clone the base os template</span>
	packer build <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VARS<span class="token punctuation">)</span> -only vsphere-clone <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_VAR_FILES<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>PACKER_CONFIG_DIR<span class="token punctuation">)</span>/builder.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>æ„å»º BASE æ¨¡ç‰ˆ</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># é€šè¿‡ PACKER_BASE_OS å‚æ•°è®¾ç½® base os æ˜¯ photon3 è¿˜æ˜¯ centos7</span>
$ <span class="token function">make</span> build-template <span class="token assign-left variable">PACKER_BASE_OS</span><span class="token operator">=</span>photon3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>æ„å»º OVF æ¨¡ç‰ˆå¹¶å¯¼å‡ºä¸º OVA</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># é€šè¿‡ PACKER_BASE_OS å‚æ•°è®¾ç½® base os æ˜¯ photon3 è¿˜æ˜¯ centos7</span>
$ <span class="token function">make</span> build-ovf <span class="token assign-left variable">PACKER_BASE_OS</span><span class="token operator">=</span>photon3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="æ„å»ºæµç¨‹"><a href="#æ„å»ºæµç¨‹" class="headerlink" title="æ„å»ºæµç¨‹"></a>æ„å»ºæµç¨‹</h2><p>å°† Packer çš„é…ç½®æ–‡ä»¶ä»¥åŠ Makefile å°è£…å¥½ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿è¡Œ <code>make build-template</code> å’Œ <code>make build-ovf</code> å‘½ä»¤æ¥æ„å»ºè™šæ‹Ÿæœºæ¨¡ç‰ˆäº†ï¼Œæ•´ä½“çš„æ„å»ºæµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å…ˆä½¿ç”¨ ISO æ„å»ºä¸€ä¸ªä¸ä¸šåŠ¡æ— å…³çš„ base è™šæ‹Ÿæœº</li>
<li>åœ¨ base è™šæ‹Ÿæœºä¹‹ä¸Šé€šè¿‡ vsphere-clone æ–¹å¼æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœº</li>
<li>å¯¼å‡º OVF è™šæ‹Ÿæœºæ–‡ä»¶ï¼Œæ‰“åŒ…æˆ OVA æ ¼å¼çš„è™šæ‹Ÿæœºæ¨¡ç‰ˆ</li>
</ul>
<h3 id="é€šè¿‡-vsphere-iso-æ„å»º-Base-è™šæ‹Ÿæœº"><a href="#é€šè¿‡-vsphere-iso-æ„å»º-Base-è™šæ‹Ÿæœº" class="headerlink" title="é€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœº"></a>é€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœº</h3><p>base è™šæ‹Ÿæœºæœ‰ç‚¹ç±»ä¼¼äº Dockerfile ä¸­çš„ FROM base é•œåƒã€‚åœ¨ Packer ä¸­æˆ‘ä»¬å¯ä»¥æŠŠä¸€äº›å¾ˆå°‘ä¼šæ”¹åŠ¨çš„å†…å®¹åšæˆä¸€ä¸ª base è™šæ‹Ÿæœºã€‚ç„¶åä»è¿™ä¸ª base è™šæ‹Ÿæœºå…‹éš†å‡ºä¸€å°æ–°çš„è™šæ‹Ÿæœºæ¥å®Œæˆæ¥ä¸‹æ¥çš„æ„å»ºæµç¨‹ï¼Œè¿™æ ·èƒ½å¤ŸèŠ‚çœæ•´ä½“çš„æ„å»ºè€—æ—¶ï¼Œä½¿å¾—æ„å»ºæ•ˆç‡æ›´é«˜ä¸€äº›ã€‚</p>
<ul>
<li>centos7 æ„å»ºè¾“å‡ºæ—¥å¿—</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vsphere-iso-base: output will be <span class="token keyword">in</span> this color.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: File /root/.cache/packer/e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso already uploaded<span class="token punctuation">;</span> continuing
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: File <span class="token punctuation">[</span>Packer<span class="token punctuation">]</span> packer_cache//e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso already exists<span class="token punctuation">;</span> skipping upload.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: the vm/template Packer/base-os-centos7 already exists, but deleting it due to <span class="token parameter variable">-force</span> flag
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating VM<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Customizing hardware<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Mounting ISO images<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding configuration parameters<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating floppy disk<span class="token punctuation">..</span>.
    vsphere-iso-base: Copying files flatly from floppy_files
    vsphere-iso-base: Done copying files from floppy_files
    vsphere-iso-base: Collecting paths from floppy_dirs
    vsphere-iso-base: Resulting paths from floppy_dirs <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>./kickstart/centos/http/<span class="token punctuation">]</span>
    vsphere-iso-base: Recursively copying <span class="token builtin class-name">:</span> ./kickstart/centos/http/
    vsphere-iso-base: Done copying paths from floppy_dirs
    vsphere-iso-base: Copying files from floppy_content
    vsphere-iso-base: Done copying files from floppy_content
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Uploading created floppy image
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Adding generated Floppy<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Set boot order temporary<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Power on VM<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting 15s <span class="token keyword">for</span> boot<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Typing boot command<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting <span class="token keyword">for</span> IP<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: IP address: <span class="token number">192.168</span>.29.46
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Using SSH communicator to connect: <span class="token number">192.168</span>.29.46
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Waiting <span class="token keyword">for</span> SSH to become available<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Connected to SSH<span class="token operator">!</span>
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Executing <span class="token function">shutdown</span> command<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Deleting Floppy drives<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Deleting Floppy image<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Eject CD-ROM drives<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Creating snapshot<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-iso-base: Clear boot order<span class="token punctuation">..</span>.
Build <span class="token string">'vsphere-iso-base'</span> finished after <span class="token number">6</span> minutes <span class="token number">42</span> seconds.
<span class="token operator">==</span><span class="token operator">></span> Wait completed after <span class="token number">6</span> minutes <span class="token number">42</span> seconds
<span class="token operator">==</span><span class="token operator">></span> Builds finished. The artifacts of successful builds are:
--<span class="token operator">></span> vsphere-iso-base: base-os-centos7

<span class="token punctuation">[</span>root@localhost:/vmfs/volumes/622aec5b-de94a27c-948e-00505680fb1d<span class="token punctuation">]</span> <span class="token function">ls</span> packer_cache/
51511394170e64707b662ca8db012be4d23e121f.iso  d3e175624fc2d704975ce9a149f8f270e4768727.iso  e476ea1d3ef3c2e3966a7081ac4239cd5ae5e8a3.iso
<span class="token punctuation">[</span>root@localhost:/vmfs/volumes/622aec5b-de94a27c-948e-00505680fb1d<span class="token punctuation">]</span> <span class="token function">ls</span> <span class="token parameter variable">-alh</span> base-os-centos7/
total <span class="token number">4281536</span>
drwxr-xr-x    <span class="token number">1</span> root     root       <span class="token number">72</span>.0K Apr  <span class="token number">1</span> 09:17 <span class="token builtin class-name">.</span>
drwxr-xr-t    <span class="token number">1</span> root     root       <span class="token number">76</span>.0K Apr  <span class="token number">1</span> 09:17 <span class="token punctuation">..</span>
-rw-------    <span class="token number">1</span> root     root        <span class="token number">4</span>.0G Apr  <span class="token number">1</span> 09:17 base-os-centos7-3ea6b205.vswp
-rw-r--r--    <span class="token number">1</span> root     root         <span class="token number">253</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7-65ff34a3.hlog
-rw-------    <span class="token number">1</span> root     root       <span class="token number">64</span>.0G Apr  <span class="token number">1</span> 09:17 base-os-centos7-flat.vmdk
-rw-------    <span class="token number">1</span> root     root        <span class="token number">8</span>.5K Apr  <span class="token number">1</span> 09:17 base-os-centos7.nvram
-rw-------    <span class="token number">1</span> root     root         <span class="token number">482</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmdk
-rw-r--r--    <span class="token number">1</span> root     root           <span class="token number">0</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmsd
-rwxr-xr-x    <span class="token number">1</span> root     root        <span class="token number">2</span>.3K Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmx
-rw-------    <span class="token number">1</span> root     root           <span class="token number">0</span> Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmx.lck
-rwxr-xr-x    <span class="token number">1</span> root     root        <span class="token number">2</span>.2K Apr  <span class="token number">1</span> 09:17 base-os-centos7.vmx~
-rw-------    <span class="token number">1</span> root     root        <span class="token number">1</span>.4M Apr  <span class="token number">1</span> 09:17 packer-tmp-created-floppy.flp
-rw-r--r--    <span class="token number">1</span> root     root       <span class="token number">96</span>.1K Apr  <span class="token number">1</span> 09:17 vmware.log

root@devbox-fedora:/root <span class="token comment"># scp 192.168.24.43:/vmfs/volumes/Packer/base-os-centos7/packer-tmp-created-floppy.flp .</span>

root@devbox-fedora:/root <span class="token comment"># mount packer-tmp-created-floppy.flp /mnt</span>
root@devbox-fedora:/root <span class="token comment"># readlink /dev/disk/by-label/packer</span>
<span class="token punctuation">..</span>/<span class="token punctuation">..</span>/loop2
root@devbox-fedora:/root <span class="token comment"># ls /mnt/HTTP/7/KS.CFG</span>
KS.CFG<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Photon3 æ„å»ºè¾“å‡ºæ—¥å¿—</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">vsphere-iso-base: output will be in this color.

&#x3D;&#x3D;&gt; vsphere-iso-base: File &#x2F;root&#x2F;.cache&#x2F;packer&#x2F;d3e175624fc2d704975ce9a149f8f270e4768727.iso already uploaded; continuing
&#x3D;&#x3D;&gt; vsphere-iso-base: File [Packer] packer_cache&#x2F;&#x2F;d3e175624fc2d704975ce9a149f8f270e4768727.iso already exists; skipping upload.
&#x3D;&#x3D;&gt; vsphere-iso-base: the vm&#x2F;template Packer&#x2F;base-os-photon3 already exists, but deleting it due to -force flag
&#x3D;&#x3D;&gt; vsphere-iso-base: Creating VM...
&#x3D;&#x3D;&gt; vsphere-iso-base: Customizing hardware...
&#x3D;&#x3D;&gt; vsphere-iso-base: Mounting ISO images...
&#x3D;&#x3D;&gt; vsphere-iso-base: Adding configuration parameters...
&#x3D;&#x3D;&gt; vsphere-iso-base: Starting HTTP server on port 8674
&#x3D;&#x3D;&gt; vsphere-iso-base: Set boot order temporary...
&#x3D;&#x3D;&gt; vsphere-iso-base: Power on VM...
&#x3D;&#x3D;&gt; vsphere-iso-base: Waiting 15s for boot...
&#x3D;&#x3D;&gt; vsphere-iso-base: HTTP server is working at http:&#x2F;&#x2F;192.168.29.171:8674&#x2F;
&#x3D;&#x3D;&gt; vsphere-iso-base: Typing boot command...
&#x3D;&#x3D;&gt; vsphere-iso-base: Waiting for IP...
&#x3D;&#x3D;&gt; vsphere-iso-base: IP address: 192.168.29.208
&#x3D;&#x3D;&gt; vsphere-iso-base: Using SSH communicator to connect: 192.168.29.208
&#x3D;&#x3D;&gt; vsphere-iso-base: Waiting for SSH to become available...
&#x3D;&#x3D;&gt; vsphere-iso-base: Connected to SSH!
&#x3D;&#x3D;&gt; vsphere-iso-base: Executing shutdown command...
&#x3D;&#x3D;&gt; vsphere-iso-base: Deleting Floppy drives...
&#x3D;&#x3D;&gt; vsphere-iso-base: Eject CD-ROM drives...
&#x3D;&#x3D;&gt; vsphere-iso-base: Creating snapshot...
&#x3D;&#x3D;&gt; vsphere-iso-base: Clear boot order...
Build &#39;vsphere-iso-base&#39; finished after 5 minutes 24 seconds.

&#x3D;&#x3D;&gt; Wait completed after 5 minutes 24 seconds

&#x3D;&#x3D;&gt; Builds finished. The artifacts of successful builds are:
--&gt; vsphere-iso-base: base-os-photon3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é€šè¿‡ <code>packer build</code> å‘½ä»¤çš„è¾“å‡ºæˆ‘ä»¬å¤§è‡´å¯ä»¥æ¨æ–­å‡ºé€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœºçš„ä¸»è¦æ­¥éª¤å’ŒåŸç†ï¼š</p>
<ul>
<li>ä¸‹è½½ ISO æ–‡ä»¶åˆ°æœ¬åœ°çš„ ${HOME}&#x2F;.cache&#x2F;packer ç›®å½•ï¼Œå¹¶ä»¥ checksum.iso æ–¹å¼ä¿å­˜ï¼Œè¿™æ ·çš„å¥½å¤„å°±æ˜¯ä¾¿äºç¼“å­˜ ISO æ–‡ä»¶ï¼Œé¿å…é‡å¤ä¸‹è½½ï¼›</li>
<li>ä¸Šä¼ æœ¬åœ° ISO æ–‡ä»¶åˆ° vCenter çš„ datastore ä¸­ï¼Œé»˜è®¤ä¿å­˜åœ¨ datastore çš„ packer_cache ç›®å½•ä¸‹ï¼Œå¦‚æœ ISO æ–‡ä»¶å·²ç»å­˜åœ¨äº†ï¼Œåˆ™ä¼šè·³è¿‡ä¸Šä¼ çš„æµç¨‹ï¼›</li>
<li>åˆ›å»ºè™šæ‹Ÿæœºï¼Œé…ç½®è™šæ‹Ÿæœºç¡¬ä»¶ï¼ŒæŒ‚è½½ä¸Šä¼ çš„ ISO æ–‡ä»¶åˆ°è™šæ‹Ÿæœºä¸Šçš„ CD&#x2F;ROMï¼Œè®¾ç½® boot å¯åŠ¨é¡¹ä¸º CD&#x2F;ROM</li>
<li>å¦‚æœ <a target="_blank" rel="noopener" href="https://www.packer.io/plugins/builders/vsphere/vsphere-iso#boot-configuration">boot_media_path</a> æ˜¯ http ç±»å‹çš„åˆ™åœ¨æœ¬åœ°éšæœºç›‘å¬ä¸€ä¸ª TCP ç«¯å£æ¥è¿è¡Œä¸€ä¸ª http æœåŠ¡ï¼Œç”¨äºæä¾› kickstart æ–‡ä»¶çš„ HTTP ä¸‹è½½åŠŸèƒ½ï¼›å¦‚æœæ˜¯ç›®å½•ç±»å‹çš„åˆ™å°† kickstart æ–‡ä»¶åˆ›å»ºæˆä¸€ä¸ªè½¯ç›˜æ–‡ä»¶ï¼Œå¹¶å°†è¯¥æ–‡ä»¶ä¸Šä¼ åˆ° datastore ä¸­ï¼Œå°†è½¯ç›˜æ–‡ä»¶æ’å…¥åˆ°è™šæ‹Ÿæœºä¸­ï¼›</li>
<li>è™šæ‹Ÿæœºå¼€æœºå¯åŠ¨åˆ° ISO å¼•å¯¼é¡µé¢ï¼Œé€šè¿‡ vCenter API å‘é€é”®ç›˜è¾“å…¥ï¼Œæ’å…¥ kickstart æ–‡ä»¶çš„è·¯å¾„ï¼›</li>
<li>é€šè¿‡ vCenter API å‘é€å›è½¦é”®ç›˜è¾“å…¥ï¼ŒISO ä¸­çš„ OS å®‰è£…ç¨‹åºè¯»å– kickstart è¿›è¡Œ OS å®‰è£…ï¼›</li>
<li>åœ¨ kickstart è„šæœ¬é‡Œå®‰è£… <a target="_blank" rel="noopener" href="https://github.com/vmware/open-vm-tools">open-vm-tools</a> å·¥å…·ï¼›</li>
<li>ç­‰å¾… OS å®‰è£…å®Œæˆï¼Œå®‰è£…å®Œæˆé‡å¯åè¿›å…¥å®‰è£…å¥½çš„ OSï¼ŒOS å¯åŠ¨åé€šè¿‡ DHCP è·å– IP åœ°å€ï¼›</li>
<li>é€šè¿‡ vm-tools è·å–åˆ°è™šæ‹Ÿæœºçš„ IP åœ°å€ï¼Œç„¶å ssh è¿æ¥åˆ°è™šæ‹Ÿæœºæ‰§è¡Œå…³æœºå‘½ä»¤ï¼›</li>
<li>è™šæ‹Ÿæœºå…³æœºï¼Œå¸è½½ ISO å’Œè½¯é©±ç­‰ä¸éœ€è¦çš„è®¾å¤‡ï¼›</li>
<li>åˆ›å»ºå¿«ç…§æˆ–è€…å°†è™šæ‹Ÿæœºè½¬æ¢ä¸ºæ¨¡ç‰ˆï¼›</li>
</ul>
<p>ä¸ªäººè§‰ç€è¿™é‡Œæ¯”è¾ƒå¥½ç©å„¿å°±æ˜¯å±…ç„¶å¯ä»¥é€šè¿‡ vCenter æˆ– ESXi çš„ <a target="_blank" rel="noopener" href="https://vdc-repo.vmware.com/vmwb-repository/dcr-public/1ef6c336-7bef-477d-b9bb-caa1767d7e30/82521f49-9d9a-42b7-b19b-9e6cd9b30db1/vim.VirtualMachine.html#putUsbScanCodes">PutUsbScanCodes</a> API æ¥ç»™è™šæ‹Ÿæœºå‘é€ä¸€äº›é”®ç›˜è¾“å…¥çš„æŒ‡ä»¤ï¼Œæ„Ÿè§‰è¿™ç®€ç›´å¤ªç¥å¥‡å•¦ ğŸ˜‚ã€‚ä¹‹å‰æˆ‘ä»¬çš„é¡¹ç›®æ˜¯å°† kickstart æ–‡ä»¶æ„å»ºæˆä¸€ä¸ª ISO æ–‡ä»¶ï¼Œç„¶åé€šè¿‡é‡æ–°æ„å»ºæº ISO çš„æ–¹å¼æ¥ä¿®æ”¹ isolinux å¯åŠ¨å‚æ•°ã€‚åæ¥æ„Ÿè§‰è¿™ç§é‡æ–°æ„å»º ISO çš„æ–¹å¼å¤ªè ¢äº†ï¼Œäºæ˜¯å°±å‚è€ƒ Packer çš„æ€è·¯ä½¿ç”¨ govc é‡Œå†…ç½®çš„ <a target="_blank" rel="noopener" href="https://github.com/vmware/govmomi/blob/master/govc/vm/keystrokes.go">vm.keystrokes</a> å‘½ä»¤æ¥ç»™è™šæ‹Ÿæœºå‘é€é”®ç›˜æŒ‡ä»¤ï¼Œå®ŒæˆæŒ‡å®š kickstart æ–‡ä»¶è·¯å¾„å‚æ•°å¯åŠ¨çš„æ“ä½œã€‚å…·ä½“çš„ govc æ“ä½œå‘½ä»¤å¯ä»¥å‚è€ƒå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å‘é€ tab é”®ï¼Œè¿›å…¥åˆ° ISO å¯åŠ¨å‚æ•°ç¼–è¾‘é¡µé¢</span>
$ govc vm.keystrokes <span class="token parameter variable">-vm</span><span class="token operator">=</span><span class="token string">'centos-vm-192'</span> <span class="token parameter variable">-c</span><span class="token operator">=</span><span class="token string">'KEY_TAB'</span>
<span class="token comment"># å‘é€ Right Control + U é”®æ¸…ç©ºè¾“å…¥æ¡†</span>
$ govc vm.keystrokes <span class="token parameter variable">-vm</span><span class="token operator">=</span><span class="token string">'centos-vm-192'</span> <span class="token parameter variable">-rc</span><span class="token operator">=</span>true <span class="token parameter variable">-c</span><span class="token operator">=</span><span class="token string">'KEY_U'</span>
<span class="token comment"># è¾“å…¥ isolinux çš„å¯åŠ¨å‚æ•°é…ç½®ï¼Œé€šè¿‡ ks=hd:LABEL=KS:/ks.cfg æŒ‡å®š kickstart è·¯å¾„ï¼ŒLABEL ä¸ºæ„å»º ISO æ—¶è®¾ç½®çš„ lable</span>
$ govc vm.keystrokes <span class="token parameter variable">-vm</span><span class="token operator">=</span><span class="token string">'centos-vm-192'</span> <span class="token parameter variable">-s</span><span class="token operator">=</span><span class="token string">'vmlinuz initrd=initrd.img ks=hd:LABEL=KS:/ks.cfg inst.stage2=hd:LABEL=CentOS\\x207\\x20x86_64 quiet console=ttyS0'</span>
<span class="token comment"># æŒ‰ä¸‹å›è½¦é”®ï¼Œå¼€å§‹å®‰è£… OS</span>
$ govc vm.keystrokes <span class="token parameter variable">-vm</span><span class="token operator">=</span><span class="token string">'centos-vm-192'</span> <span class="token parameter variable">-c</span><span class="token operator">=</span><span class="token string">'KEY_ENTER'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="é€šè¿‡-vsphere-clone-æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º-OVF-x2F-OVA"><a href="#é€šè¿‡-vsphere-clone-æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º-OVF-x2F-OVA" class="headerlink" title="é€šè¿‡ vsphere-clone æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º OVF&#x2F;OVA"></a>é€šè¿‡ vsphere-clone æ„å»ºä¸šåŠ¡è™šæ‹Ÿæœºå¹¶å¯¼å‡º OVF&#x2F;OVA</h3><p>é€šè¿‡ vsphere-iso æ„å»º Base è™šæ‹Ÿæœºä¹‹åï¼Œæˆ‘ä»¬å°±ä½¿ç”¨è¿™ä¸ª base è™šæ‹Ÿæœºå…‹éš†å‡ºä¸€å°æ–°çš„è™šæ‹Ÿæœºï¼Œç”¨æ¥æ„å»ºæˆ‘ä»¬çš„ä¸šåŠ¡è™šæ‹Ÿæœºé•œåƒï¼Œå°† k3s, argo-workflow, redfish-esxi-os-installer è¿™ä¸€å †å·¥å…·æ‰“åŒ…è¿›å»ï¼›</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">vsphere-clone: output will be <span class="token keyword">in</span> this color.

<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Cloning VM<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Customizing hardware<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Power on VM<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Waiting <span class="token keyword">for</span> IP<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: IP address: <span class="token number">192.168</span>.30.112
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Using SSH communicator to connect: <span class="token number">192.168</span>.30.112
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Waiting <span class="token keyword">for</span> SSH to become available<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Connected to SSH<span class="token operator">!</span>
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Uploading scripts <span class="token operator">=</span><span class="token operator">></span> /root
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Uploading resources <span class="token operator">=</span><span class="token operator">></span> /root
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Provisioning with shell script: /tmp/packer-shell557168976
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Executing <span class="token function">shutdown</span> command<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Creating snapshot<span class="token punctuation">..</span>.
    vsphere-clone: Starting export<span class="token punctuation">..</span>.
    vsphere-clone: Downloading: k3s-photon3-c4ca93f-disk-0.vmdk
    vsphere-clone: Exporting file: k3s-photon3-c4ca93f-disk-0.vmdk
    vsphere-clone: Writing ovf<span class="token punctuation">..</span>.
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Running post-processor: packer-manifest <span class="token punctuation">(</span>type manifest<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone: Running post-processor: vsphere <span class="token punctuation">(</span>type shell-local<span class="token punctuation">)</span>
<span class="token operator">==</span><span class="token operator">></span> vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: Running <span class="token builtin class-name">local</span> shell script: /tmp/packer-shell2376077966
    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: <span class="token builtin class-name">cd</span> /root/usr/src/github.com/muzi502/packer-vsphere-example/output/k3s-photon3-c4ca93f
    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: create ovf k3s-photon3-c4ca93f.ovf
    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: create ova manifest k3s-photon3-c4ca93f.mf
    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: creating OVA using <span class="token function">tar</span>
    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: <span class="token punctuation">[</span><span class="token string">'tar'</span>, <span class="token string">'-c'</span>, <span class="token string">'-f'</span>, <span class="token string">'k3s-photon3-c4ca93f.ova'</span>, <span class="token string">'k3s-photon3-c4ca93f.ovf'</span>, <span class="token string">'k3s-photon3-c4ca93f.mf'</span>, <span class="token string">'k3s-photon3-c4ca93f-disk-0.vmdk'</span><span class="token punctuation">]</span>
    vsphere-clone <span class="token punctuation">(</span>shell-local<span class="token punctuation">)</span>: image-build-ova: create ova checksum k3s-photon3-c4ca93f.ova.sha256
Build <span class="token string">'vsphere-clone'</span> finished after <span class="token number">14</span> minutes <span class="token number">16</span> seconds.

<span class="token operator">==</span><span class="token operator">></span> Wait completed after <span class="token number">14</span> minutes <span class="token number">16</span> seconds

<span class="token operator">==</span><span class="token operator">></span> Builds finished. The artifacts of successful builds are:
--<span class="token operator">></span> vsphere-clone: k3s-photon3-c4ca93f
--<span class="token operator">></span> vsphere-clone: k3s-photon3-c4ca93f
--<span class="token operator">></span> vsphere-clone: k3s-photon3-c4ca93f<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é€šè¿‡ packer build å‘½ä»¤çš„è¾“å‡ºæˆ‘ä»¬å¤§è‡´å¯ä»¥æ¨æ–­å‡ºæ„å»ºæµç¨‹ï¼š</p>
<ul>
<li>clone è™šæ‹Ÿæœºï¼Œä¿®æ”¹è™šæ‹Ÿæœºçš„ç¡¬ä»¶é…ç½®</li>
<li>è™šæ‹Ÿæœºå¼€æœºï¼Œé€šè¿‡ vm-tools è·å–è™šæ‹Ÿæœºçš„ IP åœ°å€</li>
<li>è·å–åˆ°è™šæ‹Ÿæœºçš„ IP åœ°å€åç­‰å¾… ssh èƒ½å¤Ÿæ­£å¸¸è¿æ¥</li>
<li>ssh èƒ½å¤Ÿæ­£å¸¸è¿æ¥åï¼Œé€šè¿‡ scp çš„æ–¹å¼ä¸Šä¼ æ–‡ä»¶</li>
<li>ssh è¿œç¨‹æ‰§è¡Œè™šæ‹Ÿæœºé‡Œçš„ <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/install.sh">install.sh</a> è„šæœ¬</li>
<li>æ‰§è¡Œè™šæ‹Ÿæœºå…³æœºå‘½ä»¤</li>
<li>åˆ›å»ºè™šæ‹Ÿæœºå¿«ç…§</li>
<li>å¯¼å‡ºè™šæ‹Ÿæœº OVF æ–‡ä»¶</li>
<li>å¯¼å‡ºæ„å»ºé…ç½®å‚æ•°çš„ manifest.json æ–‡ä»¶</li>
<li>æ‰§è¡Œ <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/ova.py">ova.py</a> è„šæœ¬ï¼Œæ ¹æ® manifest.json é…ç½®å‚æ•°å°† OVF æ ¼å¼è½¬æ¢æˆ OVA</li>
</ul>
<p>è‡³æ­¤ï¼Œæ•´ä¸ªçš„è™šæ‹Ÿæœºæ¨¡ç‰ˆçš„æ„å»ºæµç¨‹ç®—æ˜¯å®Œæˆäº†ï¼Œæœ€ç»ˆæˆ‘ä»¬çš„åˆ°ä¸€ä¸ª OVA æ ¼å¼çš„è™šæ‹Ÿæœºæ¨¡ç‰ˆã€‚ä½¿ç”¨çš„æ—¶å€™åªéœ€è¦åœ¨æœ¬åœ°æœºå™¨ä¸Šå®‰è£…å¥½ VMware Workstation æˆ–è€… Oracle VirtualBox å°±èƒ½ä¸€é”®å¯¼å…¥è¯¥è™šæ‹Ÿæœºï¼Œå¼€æœºåå°±å¯ä»¥ä½¿ç”¨å•¦ï¼Œç®—æ˜¯åšåˆ°äº†å¼€ç®±å³ç”¨çš„æ•ˆæœã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">output
â””â”€â”€ k3s-photon3-c4ca93f
    â”œâ”€â”€ k3s-photon3-c4ca93f-disk-0.vmdk
    â”œâ”€â”€ k3s-photon3-c4ca93f.mf
    â”œâ”€â”€ k3s-photon3-c4ca93f.ova
    â”œâ”€â”€ k3s-photon3-c4ca93f.ova.sha256
    â”œâ”€â”€ k3s-photon3-c4ca93f.ovf
    â””â”€â”€ packer-manifest.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="argo-workflow-å’Œ-k3s"><a href="#argo-workflow-å’Œ-k3s" class="headerlink" title="argo-workflow å’Œ k3s"></a>argo-workflow å’Œ k3s</h2><p>åœ¨è™šæ‹Ÿæœºå†…ä½¿ç”¨ redfish-esxi-os-installer æœ‰ç‚¹ç‰¹æ®Šï¼Œæ˜¯å°†å®ƒæ”¾åœ¨ argo-workflow çš„ Pod å†…æ¥æ‰§è¡Œçš„ã€‚åœ¨ workflow æ¨¡ç‰ˆæ–‡ä»¶ <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/resources/workflow/workflow.yaml">workflow.yaml</a> ä¸­æˆ‘ä»¬å®šä¹‰äº†è‹¥å¹²ä¸ª steps æ¥è¿è¡Œ redfish-esxi-os-installerã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> argoproj.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Workflow
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">generateName</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">-</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer
  <span class="token key atrule">templates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
            <span class="token key atrule">value</span><span class="token punctuation">:</span> pre<span class="token punctuation">-</span>check
        <span class="token key atrule">name</span><span class="token punctuation">:</span> Precheck
        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer
    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
            <span class="token key atrule">value</span><span class="token punctuation">:</span> build<span class="token punctuation">-</span>iso
        <span class="token key atrule">name</span><span class="token punctuation">:</span> BuildISO
        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer
    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
            <span class="token key atrule">value</span><span class="token punctuation">:</span> mount<span class="token punctuation">-</span>iso
        <span class="token key atrule">name</span><span class="token punctuation">:</span> MountISO
        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer
    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
            <span class="token key atrule">value</span><span class="token punctuation">:</span> reboot
        <span class="token key atrule">name</span><span class="token punctuation">:</span> Reboot
        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer
    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
            <span class="token key atrule">value</span><span class="token punctuation">:</span> post<span class="token punctuation">-</span>check
        <span class="token key atrule">name</span><span class="token punctuation">:</span> Postcheck
        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer
    <span class="token punctuation">-</span> <span class="token punctuation">-</span> <span class="token key atrule">arguments</span><span class="token punctuation">:</span>
          <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
            <span class="token key atrule">value</span><span class="token punctuation">:</span> umount<span class="token punctuation">-</span>iso
        <span class="token key atrule">name</span><span class="token punctuation">:</span> UmountISO
        <span class="token key atrule">template</span><span class="token punctuation">:</span> installer
  <span class="token punctuation">-</span> <span class="token key atrule">container</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> installer
      <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/muzi502/redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">:</span>v0.1.0<span class="token punctuation">-</span>alpha.1
      <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> bash
      <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
      <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
        make inventory &amp;&amp; make &#123;&#123;inputs.parameters.command&#125;&#125;</span>
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> POD_NAME
        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
          <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> metadata.name
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> HOST_IP
        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
          <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> status.hostIP
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SRC_ISO_DIR
        <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/iso
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> HTTP_DIR
        <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/iso/redfish
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> HTTP_URL
        <span class="token key atrule">value</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$(HOST_IP)/files/iso/redfish
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ESXI_ISO
        <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
          <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">-</span>config
            <span class="token key atrule">key</span><span class="token punctuation">:</span> esxi_iso
      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
        <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /ansible/config.yaml
        <span class="token key atrule">name</span><span class="token punctuation">:</span> config
        <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">subPath</span><span class="token punctuation">:</span> config.yaml
      <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data
        <span class="token key atrule">name</span><span class="token punctuation">:</span> data
    <span class="token key atrule">inputs</span><span class="token punctuation">:</span>
      <span class="token key atrule">parameters</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> command
    <span class="token key atrule">name</span><span class="token punctuation">:</span> installer
    <span class="token key atrule">retryStrategy</span><span class="token punctuation">:</span>
      <span class="token key atrule">limit</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
      <span class="token key atrule">retryPolicy</span><span class="token punctuation">:</span> OnFailure
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
      <span class="token key atrule">items</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> config
        <span class="token key atrule">path</span><span class="token punctuation">:</span> config.yaml
      <span class="token key atrule">name</span><span class="token punctuation">:</span> redfish<span class="token punctuation">-</span>esxi<span class="token punctuation">-</span>os<span class="token punctuation">-</span>installer<span class="token punctuation">-</span>config
    <span class="token key atrule">name</span><span class="token punctuation">:</span> config
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /data
      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç”±äºç›®å‰æ²¡æœ‰ Web UI å’Œåç«¯ Server æ‰€ä»¥è¿˜æ˜¯éœ€è¦æ‰‹åŠ¨ç¼–è¾‘ <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/resources/workflow/configmap.yaml">&#x2F;root&#x2F;resources&#x2F;workflow&#x2F;configmap.yaml</a> é…ç½®æ–‡ä»¶ï¼Œç„¶åå†æ‰§è¡Œ <code>kubectl create -f /root/resources/workflow</code> å‘½ä»¤åˆ›å»º workflow å·¥ä½œæµã€‚</p>
<p>workflow åˆ›å»ºäº†ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡ argo å‘½ä»¤æŸ¥çœ‹ workflow æ‰§è¡Œçš„è¿›åº¦å’ŒçŠ¶æ€</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@localhost <span class="token punctuation">[</span> ~/resources/workflow <span class="token punctuation">]</span><span class="token comment"># argo get redfish-esxi-os-installer-tjjqz</span>
Name:                redfish-esxi-os-installer-tjjqz
Namespace:           default
ServiceAccount:      <span class="token builtin class-name">unset</span> <span class="token punctuation">(</span>will run with the default ServiceAccount<span class="token punctuation">)</span>
Status:              Succeeded
Conditions:
 PodRunning          False
 Completed           True
Created:             Mon May <span class="token number">23</span> <span class="token number">11</span>:07:31 +0000 <span class="token punctuation">(</span><span class="token number">16</span> minutes ago<span class="token punctuation">)</span>
Started:             Mon May <span class="token number">23</span> <span class="token number">11</span>:07:31 +0000 <span class="token punctuation">(</span><span class="token number">16</span> minutes ago<span class="token punctuation">)</span>
Finished:            Mon May <span class="token number">23</span> <span class="token number">11</span>:23:38 +0000 <span class="token punctuation">(</span><span class="token number">19</span> seconds ago<span class="token punctuation">)</span>
Duration:            <span class="token number">16</span> minutes <span class="token number">7</span> seconds
Progress:            <span class="token number">6</span>/6
ResourcesDuration:   29m45s*<span class="token punctuation">(</span><span class="token number">1</span> cpu<span class="token punctuation">)</span>,29m45s*<span class="token punctuation">(</span>100Mi memory<span class="token punctuation">)</span>

STEP                                TEMPLATE                   PODNAME                                     DURATION  MESSAGE
 âœ” redfish-esxi-os-installer-tjjqz  redfish-esxi-os-installer
 â”œâ”€â”€â”€âœ” Precheck<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-647555770   11s
 â”œâ”€â”€â”€âœ” BuildISO<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-3078771217  14s
 â”œâ”€â”€â”€âœ” MountISO<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                  installer                  redfish-esxi-os-installer-tjjqz-4099695623  19s
 â”œâ”€â”€â”€âœ” Reboot<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                    installer                  redfish-esxi-os-installer-tjjqz-413209187   7s
 â”œâ”€â”€â”€âœ” Postcheck<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                 installer                  redfish-esxi-os-installer-tjjqz-2674696793  14m
 â””â”€â”€â”€âœ” UmountISO<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                 installer                  redfish-esxi-os-installer-tjjqz-430254503   13s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="argo-workflow"><a href="#argo-workflow" class="headerlink" title="argo-workflow"></a>argo-workflow</h3><p>ä¹‹æ‰€ä»¥ä½¿ç”¨ argo-workflow è€Œä¸æ˜¯ä½¿ç”¨åƒ dockerã€nerdctl è¿™äº›å‘½ä»¤è¡Œå·¥å…·æ¥è¿è¡Œ redfish-esxi-os-installer ï¼Œæ˜¯å› ä¸ºé€šè¿‡ argo-workflow æ¥ç¼–æ’æˆ‘ä»¬çš„å®‰è£…éƒ¨ç½²ä»»åŠ¡èƒ½å¤Ÿæ¯”è¾ƒæ–¹ä¾¿åœ°å®ç°å¤šä¸ªä»»åŠ¡åŒæ—¶è¿è¡Œã€è·å–ä»»åŠ¡æ‰§è¡Œçš„è¿›åº¦åŠæ—¥å¿—ã€è·å–ä»»åŠ¡æ‰§è¡Œçš„è€—æ—¶ã€åœæ­¢é‡è¯•ç­‰åŠŸèƒ½ã€‚ä½¿ç”¨ argo-workflow æ¥ç¼–æ’æˆ‘ä»¬çš„å®‰è£…éƒ¨ç½²ä»»åŠ¡ï¼Œå¹¶é€šè¿‡ argo-workflow çš„ RESTful API è·å–éƒ¨ç½²ä»»åŠ¡çš„è¿›åº¦æ—¥å¿—ç­‰ä¿¡æ¯ï¼Œè¿™æ ·åšæ›´äº‘åŸç”Ÿä¸€äº›ï¼ˆğŸ¤£</p>
<p><img data-src="https://p.k8s.li/2022-05-23-packer-vsphere-example-01.png" alt="argo-workfloe-apis"></p>
<p>åœ¨æˆ‘ä»¬å†…éƒ¨å…¶å®æœ€ç»ˆç›®çš„æ˜¯å‡†å¤‡å°†è¯¥æ–¹æ¡ˆåšæˆä¸€ä¸ªäº§å“åŒ–çš„å·¥å…·ï¼Œæä¾›ä¸€ä¸ª Web UI ç”¨æ¥è¿›è¡Œé…ç½®éƒ¨ç½²å‚æ•°ä»¥åŠå±•ç¤ºéƒ¨ç½²çš„è¿›åº¦æ—¥å¿—ç­‰åŠŸèƒ½ã€‚å½“åˆè®¾è®¡æ–¹æ¡ˆçš„æ—¶å€™ä¹Ÿæ˜¯å‚è€ƒäº†ä¸€ä¸‹  <a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/community-edition">VMware Tanzu ç¤¾åŒºç‰ˆ</a> ï¼šéƒ¨ç½² Tanzu ç®¡ç†é›†ç¾¤çš„æ—¶å€™éœ€è¦æœ‰ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ k8s é›†ç¾¤ï¼Œæˆ–è€…é€šè¿‡ Tanzu æ–°éƒ¨ç½²ä¸€ä¸ª kind é›†ç¾¤ã€‚éƒ¨ç½²ä¸€ä¸ª tanzu ç®¡ç†é›†ç¾¤å¯ä»¥é€šè¿‡ tanzu å‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Tanzu Web UI çš„æ–¹å¼ï¼ŒTanzu Web UI çš„æ–¹å¼å…¶å®å°±æ˜¯ä¸€ä¸ªåå‘äºäº§å“åŒ–çš„å·¥å…·ã€‚åœ¨ <a href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ</a> æˆ‘æ›¾åˆ†äº«è¿‡ Tanzu çš„éƒ¨ç½²æ–¹å¼ï¼Œæ„Ÿå…´è¶£çš„è¯å¯ä»¥å»çœ‹ä¸€ä¸‹ã€‚</p>
<p><img data-src="https://p.k8s.li/2022-05-23-packer-vsphere-example-02.png" alt="tanzu-cluster"></p>
<p>è¯¥æ–¹æ¡ˆä¸»è¦æ˜¯é¢å‘ä¸€äº›äº§å“åŒ–çš„åœºæ™¯ï¼Œç”±äºå¼•å…¥äº† K8s è¿™ä¸ªåºç„¶å¤§ç‰©ï¼Œæ•´ä½“çš„æŠ€æœ¯æ ˆä¼šå¤æ‚ä¸€äº›ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›å¥½å¤„å•¦ ğŸ˜…ã€‚</p>
<h3 id="k8s-and-k3s"><a href="#k8s-and-k3s" class="headerlink" title="k8s and k3s"></a>k8s and k3s</h3><p>argo-workflow éœ€è¦ä¾èµ–ä¸€ä¸ª k8s é›†ç¾¤æ‰èƒ½è¿è¡Œï¼Œæˆ‘ä»¬å†…éƒ¨æµ‹è¯•äº† kubekeyã€sealosã€kubesprayã€k3s å‡ ç§å¸¸è§çš„éƒ¨ç½²å·¥å…·ã€‚ç»¼åˆè¯„å®šä¸‹æ¥ k3s é›†ç¾¤å ç”¨çš„èµ„æºæœ€å°‘ã€‚å‚è€ƒ <a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/installation/installation-requirements/resource-profiling/_index/">K3s èµ„æºåˆ†æ</a> ç»™å‡ºçš„èµ„æºè¦æ±‚ï¼Œæœ€å°åªéœ€è¦ 768M å†…å­˜å°±èƒ½è¿è¡Œã€‚å¯¹äºç¡¬ä»¶èµ„æºä¸å¤ªå……è¶³çš„ç¬”è®°æœ¬ç”µè„‘æ¥è®²ï¼Œk3s æ— ç–‘æ˜¯ç›®å‰æœ€ä½³çš„æ–¹æ¡ˆã€‚</p>
<p>å¦å¤–è¿˜æœ‰ä¸€ä¸ªååˆ†é‡è¦çš„åŸå› å°±æ˜¯ k3s server æ›´æ¢å• control plan èŠ‚ç‚¹çš„ IP åœ°å€ååˆ†æ–¹ä¾¿ï¼Œå¯¹ç”¨æˆ·æ¥è¯´æ˜¯æ— æ„ŸçŸ¥çš„ã€‚è¿™æ ·å°±å¯ä»¥å°†å®‰è£… k3s çš„æ“ä½œåœ¨æ„å»º OVA çš„æ—¶å€™å®Œæˆï¼Œè€Œä¸æ˜¯åœ¨ä½¿ç”¨çš„æ—¶å€™æ‰‹åŠ¨æ‰§è¡Œå®‰è£…è„šæœ¬æ¥å®‰è£…ã€‚</p>
<p>åªè¦å¼€æœºè¿è¡Œè™šæ‹Ÿæœºèƒ½å¤Ÿé€šè¿‡ DHCP åˆ†é…åˆ°ä¸€ä¸ªå†…ç½‘ IPv4 åœ°å€æˆ–è€…æ‰‹åŠ¨é…ç½®ä¸€ä¸ªé™æ€ IPï¼Œk3s å°±èƒ½å¤Ÿæ­£å¸¸è¿è¡Œèµ·æ¥ï¼Œèƒ½å¤ŸçœŸæ­£åšåˆ°å¼€ç®±å³ç”¨ï¼Œè€Œä¸æ˜¯åƒ kubekeyã€sealosã€kubespray é‚£æ ·å‚»ä¹ä¹åœ°å¡«å†™ä¸€ä¸ªå¤æ‚æ— æ¯”çš„é…ç½®æ–‡ä»¶ï¼Œç„¶åå†æ‰§è¡Œä¸€äº›å‘½ä»¤æ¥å®‰è£… k8s é›†ç¾¤ã€‚è¿™ç§å¯¼å…¥è™šæ‹Ÿæœºå¼€å³ç”¨çš„æ–¹å¼ï¼Œå¯¹ç”¨æˆ·æ¥è®²ååˆ†å‹å¥½ã€‚</p>
<p>å½“ç„¶åœ¨ä½¿ç”¨ kubekeyã€sealosã€kubespray åœ¨æ„å»ºè™šæ‹Ÿæœºçš„æ—¶å€™å®‰è£…å¥½ k8s é›†ç¾¤ä¹Ÿä¸æ˜¯ä¸å¯è¡Œï¼Œåªä¸è¿‡æˆ‘ä»¬æ„å»ºæ—¶å€™è™šæ‹Ÿæœºçš„ IP åœ°å€ï¼ˆæ¯”å¦‚ 10.172.20.223ï¼‰å’Œä½¿ç”¨æ—¶çš„ IP åœ°å€ï¼ˆæ¯”å¦‚ 192.168.20.11ï¼‰åŸºæœ¬ä¸Šæ˜¯ä¸ä¼šç›¸åŒçš„ã€‚ç»™ k8s control plain èŠ‚ç‚¹æ›´æ¢ IP çš„æ“ä½œ <a target="_blank" rel="noopener" href="https://www.qikqiak.com/">é˜³æ˜åšä¸»</a> æ›¾åœ¨ <a target="_blank" rel="noopener" href="https://www.qikqiak.com/post/how-to-change-k8s-node-ip/">å¦‚ä½•ä¿®æ”¹ Kubernetes èŠ‚ç‚¹ IP åœ°å€?</a> æ–‡ç« ä¸­åˆ†äº«è¿‡ä»–çš„ç»å†ï¼Œçœ‹å®Œåç›´æ¥æŠŠæˆ‘æ•´ä¸ä¼šäº†ï¼Œæ„Ÿè§‰æ“ä½œèµ·æ¥å®åœ¨æ˜¯å¤ªéº»çƒ¦äº†ï¼Œè¿˜ä¸å¦‚é‡æ–°éƒ¨ç½²ä¸€å¥—æ–°çš„ k8s æ–¹ä¾¿å‘¢ ğŸ˜‚</p>
<p>å…¶å®æ„å»ºè™šæ‹Ÿæœºæ¨¡ç‰ˆçš„æ—¶å€™å®‰è£… k8s çš„æ€è·¯æœ€åˆæˆ‘æ˜¯å€Ÿé‰´çš„ <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> é¡¹ç›® ğŸ˜‚ã€‚å³å°†éƒ¨ç½² k8s ä¾èµ–çš„ä¸€äº›æ–‡ä»¶å’Œå®¹å™¨é•œåƒæ„å»ºåœ¨è™šæ‹Ÿæœºæ¨¡ç‰ˆå½“ä¸­ï¼Œéƒ¨ç½² k8s çš„æ—¶å€™ä¸éœ€è¦å†è”ç½‘ä¸‹è½½è¿™äº›ä¾èµ–èµ„æºäº†ã€‚ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬é€šè¿‡ k3s ç›´æ¥æå‰å°† k8s é›†ç¾¤éƒ¨ç½²å¥½äº†ï¼Œä¹Ÿå°±çœå»äº†è®©ç”¨æˆ·æ‰§è¡Œéƒ¨ç½²çš„æ“ä½œã€‚</p>
<p>ç»¼ä¸Šï¼Œé€‰ç”¨ k3s ä½œä¸ºè¯¥æ–¹æ¡ˆçš„ K8s åº•åº§æ— ç–‘æ˜¯æœ€ä½³çš„å•¦ï¼ˆ</p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><h3 id="ä½¿ç”¨æ„Ÿå—"><a href="#ä½¿ç”¨æ„Ÿå—" class="headerlink" title="ä½¿ç”¨æ„Ÿå—"></a>ä½¿ç”¨æ„Ÿå—</h3><p>ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´åæ„Ÿè§‰ Packer çš„å¤æ‚åº¦å’Œä¸Šæ‰‹éš¾åº¦è¦æ¯” Docker æ„å»ºå®¹å™¨é•œåƒè¦é«˜å‡ºä¸€ä¸ªæ•°é‡çº§ã€‚å¯èƒ½æ˜¯å› ä¸ºè™šæ‹Ÿæœºå¹¶ä¸åƒå®¹å™¨é•œåƒé‚£æ ·æœ‰ <a target="_blank" rel="noopener" href="https://opencontainers.org/">OCI</a> è¿™ç§ç»Ÿä¸€çš„æ„å»ºã€åˆ†å‘ã€è¿è¡Œå·¥ä¸šæ ‡å‡†ã€‚è™šæ‹Ÿæœºçš„åˆ›å»ºå…‹éš†ç­‰æ“ä½œä¸åº•å±‚çš„ IaaS ä¾›åº”å•†è€¦åˆçš„ååˆ†ç´§å¯†ï¼Œè¿™å°±å¯¼è‡´ä¸åŒ IaaS ä¾›åº”å•†æ¯”å¦‚ vSphereã€kvm&#x2F;qemu ä»–ä»¬ä¹‹é—´èƒ½å¤Ÿå¤ç”¨çš„é…ç½®å‚æ•°å¹¶ä¸å¤šã€‚æ¯”å¦‚ vSphere é‡Œæœ‰ datastoreã€datacenterã€resource_poolã€folder ç­‰æ¦‚å¿µï¼Œä½† kvm&#x2F;qemu ä¸­ç¼ºæ²¡æœ‰ï¼Œè¿™å°±å¯¼è‡´å¾ˆéš¾å°†å®ƒä»¬ç»Ÿä¸€æˆä¸€ä¸ªé…ç½®ã€‚</p>
<h3 id="OVA-æ ¼å¼"><a href="#OVA-æ ¼å¼" class="headerlink" title="OVA æ ¼å¼"></a>OVA æ ¼å¼</h3><p>ä½¿ç”¨ OVA è€Œä¸æ˜¯ vagrant.boxã€vmdkã€rawã€qcow2 ç­‰å…¶ä»–æ ¼å¼æ˜¯å› ä¸º OVA æ”¯æŒæ”¯æŒä¸€é”®å¯¼å…¥çš„ç‰¹æ€§ï¼Œåœ¨ Windows ä¸Šä½¿ç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ã€‚æ¯•ç«Ÿ Windows ä¸Šå®‰è£… Vagrant æˆ–è€… qemu&#x2F;KVM ä¹Ÿå¤Ÿä½ æŠ˜è…¾çš„äº†ï¼Œ<a target="_blank" rel="noopener" href="https://www.vmware.com/products/workstation-pro/workstation-pro-evaluation.html">VMware Workstation</a> æˆ–è€… <a target="_blank" rel="noopener" href="https://www.virtualbox.org/">Oracle VirtualBox</a> ä½¿ç”¨å¾—æ›´å¹¿æ³›ä¸€äº›ã€‚</p>
<p>å¦å¤– Packer å¹¶ä¸æ”¯æŒç›´æ¥å°†è™šæ‹Ÿæœºå¯¼å‡ºä¸º OVA çš„æ–¹å¼ï¼Œé»˜è®¤æƒ…å†µä¸‹åªä¼šé€šè¿‡ vCenter çš„ API å¯¼å‡ºä¸º ovfã€‚å¦‚æœéœ€è¦ OVA æ ¼å¼ï¼Œéœ€è¦å°† OVF æ‰“åŒ…æˆ OVAã€‚åœ¨ ISSUE <a target="_blank" rel="noopener" href="https://github.com/hashicorp/packer/issues/9645">Add support for exporting to OVA in vsphere-iso builder #9645</a> ä¹Ÿæœ‰äººåé¦ˆäº†æ”¯æŒ OVA å¯¼å‡ºçš„éœ€æ±‚ï¼Œä½† Packer è‡³ä»Šä»æœªæ”¯æŒã€‚å°† OVF è½¬æ¢ä¸º OVA æˆ‘æ˜¯å‚è€ƒçš„ image-builder é¡¹ç›®çš„ <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/image-builder/blob/master/images/capi/hack/image-build-ova.py"><strong>image-build-ova.py</strong> </a> æ¥å®Œæˆçš„ã€‚</p>
<h3 id="å®‰è£…-open-vm-tool-å¤±è´¥"><a href="#å®‰è£…-open-vm-tool-å¤±è´¥" class="headerlink" title="å®‰è£… open-vm-tool å¤±è´¥"></a>å®‰è£… open-vm-tool å¤±è´¥</h3><p>ç”±äº ISO ä¸­å¹¶ä¸åŒ…å« open-vm-tool è½¯ä»¶åŒ…ï¼Œè¿™å°±éœ€è¦åœ¨ ISO å®‰è£… OS çš„è¿‡ç¨‹ä¸­è”ç½‘å®‰è£… open-vm-toolsã€‚å¦‚æœå®‰è£…çš„æ—¶å€™ç½‘ç»œæŠ–åŠ¨äº†å°±å¯èƒ½ä¼šå¯¼è‡´ open-vm-tools å®‰è£…å¤±è´¥ã€‚open-vm-tools å®‰è£…å¤±è´¥ packer æ˜¯æ— æ³•æ„ŸçŸ¥åˆ°çš„ï¼Œåªèƒ½ä¸€ç›´ç­‰åˆ°è·å–è™šæ‹Ÿæœº IP è¶…æ—¶åé€€å‡ºæ‰§è¡Œã€‚ç›®å‰æ²¡æœ‰å¾ˆå¥½çš„åŠæ³•ï¼Œåªèƒ½åœ¨ kickstart é‡Œå®‰è£… open-vm-tools çš„æ—¶å€™è¿›è¡Œé‡è¯•ç›´åˆ° open-vm-tools å®‰è£…æˆåŠŸã€‚</p>
<h3 id="å‡å°‘å¯¼å‡ºå-vmdk-æ–‡ä»¶å¤§å°"><a href="#å‡å°‘å¯¼å‡ºå-vmdk-æ–‡ä»¶å¤§å°" class="headerlink" title="å‡å°‘å¯¼å‡ºå vmdk æ–‡ä»¶å¤§å°"></a>å‡å°‘å¯¼å‡ºå vmdk æ–‡ä»¶å¤§å°</h3><p>æ›¾ç»åœ¨ <a href="https://blog.k8s.li/esxi-vmbase.html">æ‰‹æ“è™šæ‹Ÿæœºæ¨¡æ¿</a> æ–‡ç« ä¸­åˆ†æè¿‡é€šè¿‡ dd ç½®é›¶çš„æ–¹å¼å¯ä»¥å¤§å¹…å‡å°‘è™šæ‹Ÿæœºå¯¼å‡ºåçš„ vmdk æ–‡ä»¶å¤§</p>
<blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">464M Aug <span class="token number">28</span> <span class="token number">16</span>:15 Ubuntu1804-2.ova <span class="token comment"># ç½®é›¶åçš„å¤§å°</span>
<span class="token number">1</span>.3G Aug <span class="token number">28</span> <span class="token number">15</span>:48 Ubuntu1804.ova   <span class="token comment"># ç½®é›¶å‰çš„å¤§å°</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ dd ç½®é›¶ä¹‹å‰è¦å…ˆåœæ­¢ k3s æœåŠ¡ï¼Œä¸ç„¶ç½®é›¶çš„æ—¶å€™ä¼šå æ»¡ root æ ¹åˆ†åŒºå¯¼è‡´ kubelet å¯åŠ¨ GC å°†ä¸€äº›é•œåƒç»™åˆ é™¤æ‰ã€‚ä¹‹å‰å¯¼å‡ºè™šæ‹Ÿæœºåå‘ç°å°‘äº†ä¸€äº›é•œåƒï¼Œæ’æŸ¥äº†å¥½ä¹…æ‰å‘ç°æ˜¯ kubelet GC æŠŠæˆ‘çš„é•œåƒç»™åˆ æ‰äº†ï¼Œè¸©äº†ä¸ªå¤§å‘ï¼Œå¯æ°”æ­»æˆ‘äº† ğŸ˜¡</p>
<p>å¦å¤–ä¹Ÿå¯ä»¥åˆ é™¤ä¸€äº›ä¸å¿…è¦çš„æ–‡ä»¶ï¼Œæ¯”å¦‚ containerd ä¸­ <code>io.containerd.content.v1.content/blobs/sha256</code> ä¸€äº›é•œåƒ layer çš„åŸå§‹ blob æ–‡ä»¶æ˜¯ä¸éœ€è¦çš„ï¼Œå¯ä»¥å°†å®ƒä»¬ç»™åˆ é™¤æ‰ï¼Œè¿™æ ·èƒ½å¤Ÿå‡å°‘éƒ¨åˆ†ç£ç›˜ç©ºé—´å ç”¨ï¼›</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">function</span> <span class="token function-name function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token comment"># stop k3s server for for prevent it starting the garbage collection to delete images</span>
  systemctl stop k3s

  <span class="token comment"># Ensure on next boot that network devices get assigned unique IDs.</span>
  <span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'/^\(HWADDR\|UUID\)=/d'</span> /etc/sysconfig/network-scripts/ifcfg-* <span class="token operator"><span class="token file-descriptor important">2</span>></span>/dev/null <span class="token operator">||</span> <span class="token boolean">true</span>

  <span class="token comment"># Clean up network interface persistence</span>
  <span class="token function">find</span> /var/log <span class="token parameter variable">-type</span> f <span class="token parameter variable">-exec</span> truncate <span class="token parameter variable">--size</span><span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">\</span><span class="token punctuation">;</span>
  <span class="token function">rm</span> <span class="token parameter variable">-rf</span> /tmp/* /var/tmp/*

  <span class="token comment"># cleanup all blob files of registry download image</span>
  <span class="token function">find</span> /var/lib/rancher/k3s/agent/containerd/io.containerd.content.v1.content/blobs/sha256 <span class="token parameter variable">-size</span> +1M <span class="token parameter variable">-type</span> f <span class="token parameter variable">-delete</span>

  <span class="token comment"># zero out the rest of the free space using dd, then delete the written file.</span>
  <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/EMPTY <span class="token assign-left variable">bs</span><span class="token operator">=</span>4M <span class="token assign-left variable">status</span><span class="token operator">=</span>progress <span class="token operator">||</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> /EMPTY
  <span class="token function">dd</span> <span class="token assign-left variable">if</span><span class="token operator">=</span>/dev/zero <span class="token assign-left variable">of</span><span class="token operator">=</span>/data/EMPTY <span class="token assign-left variable">bs</span><span class="token operator">=</span>4M <span class="token assign-left variable">status</span><span class="token operator">=</span>progress <span class="token operator">||</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> /data/EMPTY
  <span class="token comment"># run sync so Packer doesn't quit too early, before the large file is deleted.</span>
  <span class="token function">sync</span>

  yum clean all
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Photon3"><a href="#Photon3" class="headerlink" title="Photon3"></a>Photon3</h3><p>ä¹‹å‰åœ¨ <a href="https://blog.k8s.li/Photon-OS.html">è½»é‡çº§å®¹å™¨ä¼˜åŒ–å‹ Linux å‘è¡Œç‰ˆ Photon OS</a> é‡Œåˆ†äº«è¿‡ VMware çš„ Linux å‘è¡Œç‰ˆ <a target="_blank" rel="noopener" href="https://vmware.github.io/photon/assets/files/html/3.0/">Photon</a>ã€‚ä¸åŒäºä¼ ç»Ÿçš„ Linux å‘è¡Œç‰ˆ Photon çš„ç³»ç»Ÿååˆ†ç²¾ç®€ï¼Œä½¿ç”¨å®ƒæ›¿ä»£ CentOS èƒ½å¤Ÿä¸€å®šç¨‹åº¦ä¸Šå‡å°‘ç³»ç»Ÿèµ„æºçš„å ç”¨ï¼Œå¯¼å‡ºåçš„ vmdk æ–‡ä»¶ä¹Ÿè¦æ¯” CentOS å°ä¸€äº›ã€‚</p>
<h3 id="goss"><a href="#goss" class="headerlink" title="goss"></a><a target="_blank" rel="noopener" href="https://github.com/aelsabbahy/goss">goss</a></h3><p>åœ¨æ„å»ºçš„è¿‡ç¨‹ä¸­æˆ‘ä»¬åœ¨ k3s é›†ç¾¤ä¸Šå®‰è£…äº†ä¸€äº›å…¶ä»–çš„ç»„ä»¶ï¼Œæ¯”å¦‚æä¾›æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½æœåŠ¡çš„ filebrowser ä»¥åŠ workflow å·¥ä½œæµå¼•æ“ argo-workflowï¼Œä¸ºäº†ä¿è¯è¿™äº›æœåŠ¡çš„æ­£å¸¸è¿è¡Œï¼Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡ä¸åŒçš„æ–¹å¼å»æ£€æŸ¥è¿™äº›æœåŠ¡æ˜¯å¦æ­£å¸¸ã€‚ä¸€èˆ¬æ˜¯é€šè¿‡ kubectl get ç­‰å‘½ä»¤æŸ¥çœ‹ deploymentã€podã€daemonset ç­‰æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œæˆ–è€…é€šè¿‡ curl è®¿é—®è¿™äº›è¿™äº›æœåŠ¡çš„å¥åº·æ£€æŸ¥ APIã€‚</p>
<p>ç”±äºæ£€æŸ¥é¡¹æ¯”è¾ƒå¤šä¸”ååˆ†ç¹çï¼Œä½¿ç”¨ä¼ ç»Ÿçš„ shell è„šæœ¬æ¥åšè¿™å¹¶ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œéœ€è¦è§£ææ¯ä¸ªå‘½ä»¤çš„é€€å‡ºç ä»¥åŠè¿”å›å€¼ã€‚å› æ­¤æˆ‘ä»¬ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://github.com/aelsabbahy/goss">goss</a> é€šè¿‡ YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶æ¥å®šä¹‰ä¸€äº›æ£€æŸ¥é¡¹ï¼Œè®©å®ƒæ‰¹é‡æ¥æ‰§è¡Œè¿™äº›æ£€æŸ¥ï¼Œè€Œä¸ç”¨åœ¨ shell å¯¹æ¯ä¸ªæ£€æŸ¥é¡¹å†™ä¸€å †çš„ awk&#x2F;grep ç­‰å‘½ä»¤æ¥ check äº†ã€‚</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/goss/k3s.yaml">k3s.yaml</a>ï¼šç”¨äºæ£€æŸ¥ k3s ä»¥åŠå®ƒé»˜è®¤è‡ªå¸¦çš„æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">
<span class="token comment"># DNS ç±»å‹çš„æ£€æŸ¥</span>
<span class="token key atrule">dns</span><span class="token punctuation">:</span>
  <span class="token comment"># æ£€æŸ¥ coredns æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è§£æåˆ° kubernetes apiserver çš„ service IP åœ°å€</span>
  <span class="token key atrule">kubernetes.default.svc.cluster.local</span><span class="token punctuation">:</span>
    <span class="token key atrule">resolvable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">addrs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 10.43.0.1
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.43.0.10
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># TCP/UDP ç«¯å£ç±»å‹çš„æ£€æŸ¥</span>
<span class="token key atrule">addr</span><span class="token punctuation">:</span>
  <span class="token comment"># æ£€æŸ¥ coredns çš„ UDP 53 ç«¯å£æ˜¯å¦æ­£å¸¸</span>
  <span class="token key atrule">udp://10.43.0.10:53</span><span class="token punctuation">:</span>
    <span class="token key atrule">reachable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">500</span>

<span class="token comment"># æ£€æŸ¥ cni0 ç½‘æ¡¥æ˜¯å¦å­˜åœ¨</span>
<span class="token key atrule">interface</span><span class="token punctuation">:</span>
  <span class="token key atrule">cni0</span><span class="token punctuation">:</span>
    <span class="token key atrule">exists</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">addrs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 10.42.0.1/24

<span class="token comment"># æœ¬æœºç«¯å£ç±»å‹çš„æ£€æŸ¥</span>
<span class="token key atrule">port</span><span class="token punctuation">:</span>
  <span class="token comment"># æ£€æŸ¥ ssh 22 ç«¯å£æ˜¯å¦æ­£å¸¸</span>
  <span class="token key atrule">tcp:22</span><span class="token punctuation">:</span>
    <span class="token key atrule">listening</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">ip</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 0.0.0.0
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># æ£€æŸ¥ kubernetes apiserver 6443 ç«¯å£æ˜¯å¦æ­£å¸¸</span>
  <span class="token key atrule">tcp6:6443</span><span class="token punctuation">:</span>
    <span class="token key atrule">listening</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># æ£€æŸ¥ä¸€äº› systemd æœåŠ¡çš„æ£€æŸ¥</span>
<span class="token key atrule">service</span><span class="token punctuation">:</span>
  <span class="token comment"># é»˜è®¤ç¦ç”¨ firewalld æœåŠ¡</span>
  <span class="token key atrule">firewalld</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">running</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># ç¡®ä¿ sshd æœåŠ¡æ­£å¸¸è¿è¡Œ</span>
  <span class="token key atrule">sshd</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">running</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># æ£€æŸ¥ k3s æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</span>
  <span class="token key atrule">k3s</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">running</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># å®šä¹‰ä¸€äº› shell å‘½ä»¤æ‰§è¡Œçš„æ£€æŸ¥</span>
<span class="token key atrule">command</span><span class="token punctuation">:</span>
  <span class="token comment"># æ£€æŸ¥ kubernetes cheduler ç»„ä»¶æ˜¯å¦æ­£å¸¸</span>
  <span class="token key atrule">check_k8s_scheduler_health</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> curl <span class="token punctuation">-</span>k https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10259/healthz
    <span class="token comment"># é€€å‡ºç æ˜¯å¦ä¸º 0</span>
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># æ ‡å‡†è¾“å‡ºä¸­æ˜¯å¦åŒ…å«æ­£ç¡®çš„è¾“å‡ºå€¼</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ok"</span><span class="token punctuation">]</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># æ£€æŸ¥ kubernetes controller-manager æ˜¯å¦æ­£å¸¸</span>
  <span class="token key atrule">check_k8s_controller-manager_health</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> curl <span class="token punctuation">-</span>k https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10257/healthz
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ok"</span><span class="token punctuation">]</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># æ£€æŸ¥ cluster-info  ä¸­è¾“å‡ºçš„ç»„ä»¶è¿è¡ŒçŠ¶æ€æ˜¯å¦æ­£å¸¸</span>
  <span class="token key atrule">check_cluster_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl cluster<span class="token punctuation">-</span>info <span class="token punctuation">|</span> grep 'is running'
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> CoreDNS
      <span class="token punctuation">-</span> Kubernetes control plane
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å¤„äº Ready çŠ¶æ€</span>
  <span class="token key atrule">check_node_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get node <span class="token punctuation">-</span>o jsonpath='<span class="token punctuation">&#123;</span>.items<span class="token punctuation">[</span><span class="token punctuation">]</span>.status<span class="token punctuation">&#125;</span>' <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.conditions<span class="token punctuation">[</span><span class="token number">-1</span><span class="token punctuation">]</span>.type'
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> Ready
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># æ£€æŸ¥èŠ‚ç‚¹ IP æ˜¯å¦æ­£ç¡®</span>
  <span class="token key atrule">check_node_address</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get node <span class="token punctuation">-</span>o wide <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.status.addresses<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">|</span> select(.type == "InternalIP") <span class="token punctuation">|</span> .address'
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># æ£€æŸ¥ traefik loadBalancer çš„ IP åœ°å€æ˜¯å¦æ­£ç¡®</span>
  <span class="token key atrule">check_traefik_address</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system get svc traefik <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.status.loadBalancer.ingress<span class="token punctuation">[</span><span class="token punctuation">]</span>.ip'
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># æ£€æŸ¥ containerd å®¹å™¨è¿è¡Œæ˜¯å¦æ­£å¸¸</span>
  <span class="token key atrule">check_container_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> crictl ps <span class="token punctuation">-</span><span class="token punctuation">-</span>output=json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.containers<span class="token punctuation">[</span><span class="token punctuation">]</span>.metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> coredns
      <span class="token punctuation">-</span> /lb<span class="token punctuation">-</span>.<span class="token important">*-443/</span>
      <span class="token punctuation">-</span> /lb<span class="token punctuation">-</span>.<span class="token important">*-80/</span>
      <span class="token punctuation">-</span> traefik
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># æ£€æŸ¥ kube-system namespace ä¸‹çš„ pod æ˜¯å¦æ­£å¸¸</span>
  <span class="token key atrule">check_kube_system_namespace_pod_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get pod <span class="token punctuation">-</span>n kube<span class="token punctuation">-</span>system <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">|</span> select((.status.phase <span class="token tag">!=</span> "Running") and (.status.phase <span class="token tag">!=</span> "Succeeded") and (.status.phase <span class="token tag">!=</span> "Completed"))'
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"!string"</span><span class="token punctuation">]</span>
  <span class="token comment"># æ£€æŸ¥ k8s deployment æœåŠ¡æ˜¯å¦éƒ½æ­£å¸¸</span>
  <span class="token key atrule">check_k8s_deployment_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get deploy <span class="token punctuation">-</span><span class="token punctuation">-</span>all<span class="token punctuation">-</span>namespaces <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">|</span> select(.status.replicas == .status.availableReplicas) <span class="token punctuation">|</span> .metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> coredns
      <span class="token punctuation">-</span> traefik
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># æ£€æŸ¥ svclb-traefik daemonset æ˜¯å¦æ­£å¸¸</span>
  <span class="token key atrule">check_k8s_daemonset_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get daemonset <span class="token punctuation">-</span><span class="token punctuation">-</span>all<span class="token punctuation">-</span>namespaces <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">|</span> select(.status.replicas == .status.availableReplicas) <span class="token punctuation">|</span> .metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> svclb<span class="token punctuation">-</span>traefik
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/goss/goss.yaml">goss.yaml</a>ï¼šç”¨äºæ£€æŸ¥æˆ‘ä»¬éƒ¨ç½²çš„ä¸€äº›æœåŠ¡æ˜¯å¦æ­£å¸¸</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># é€šè¿‡ include å…¶ä»– gossfile æ–¹å¼å°†ä¸Šé¢å®šä¹‰çš„ k3s.yaml æ£€æŸ¥é¡¹ä¹ŸåŒ…å«è¿›æ¥</span>
<span class="token key atrule">gossfile</span><span class="token punctuation">:</span>
  <span class="token key atrule">k3s.yaml</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token key atrule">dns</span><span class="token punctuation">:</span>
  <span class="token comment"># æ£€æŸ¥éƒ¨ç½²çš„ filebrowser deployment çš„ service IP æ˜¯å¦èƒ½æ­£å¸¸è§£æåˆ°</span>
  <span class="token key atrule">filebrowser.default.svc.cluster.local</span><span class="token punctuation">:</span>
    <span class="token key atrule">resolvable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.43.0.10
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># æ£€æŸ¥éƒ¨ç½²çš„ argo-workflow deployment çš„ service IP æ˜¯å¦èƒ½æ­£å¸¸è§£æåˆ°</span>
  <span class="token key atrule">argo-workflow-argo-workflows-server.default.svc.cluster.local</span><span class="token punctuation">:</span>
    <span class="token key atrule">resolvable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 10.43.0.10
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># ä¸€äº› HTTP è¯·æ±‚æ–¹å¼çš„æ£€æŸ¥</span>
<span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token comment"># æ£€æŸ¥ filebrowser æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œç±»ä¼¼äº pod é‡Œçš„å­˜æ´»æ¢é’ˆ</span>
  http<span class="token punctuation">:</span>//<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/filebrowser/<span class="token punctuation">:</span>
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token number">200</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">method</span><span class="token punctuation">:</span> GET
  <span class="token comment"># æ£€æŸ¥ argo-workflow æ˜¯å¦æ­£å¸¸è¿è¡Œ</span>
  http<span class="token punctuation">:</span>//<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.ip_address <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>/workflows/api/v1/version<span class="token punctuation">:</span>
    <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token number">200</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">600</span>
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">method</span><span class="token punctuation">:</span> GET

<span class="token comment"># åŒæ ·ä¹Ÿæ˜¯ä¸€äº› shell å‘½ä»¤çš„æ£€æŸ¥é¡¹ç›®</span>
<span class="token key atrule">command</span><span class="token punctuation">:</span>
  <span class="token comment"># æ£€æŸ¥å®¹å™¨é•œåƒæ˜¯å¦é½å…¨ï¼Œé¿å…ç¼ºé•œåƒçš„é—®é¢˜</span>
  <span class="token key atrule">check_container_images</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> crictl images <span class="token punctuation">-</span><span class="token punctuation">-</span>output=json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.images<span class="token punctuation">[</span><span class="token punctuation">]</span>.repoTags<span class="token punctuation">[</span><span class="token punctuation">]</span>' <span class="token punctuation">|</span> awk <span class="token punctuation">-</span>F '/' '<span class="token punctuation">&#123;</span>print $NF<span class="token punctuation">&#125;</span>' <span class="token punctuation">|</span> awk <span class="token punctuation">-</span>F '<span class="token punctuation">:</span>' '<span class="token punctuation">&#123;</span>print $1<span class="token punctuation">&#125;</span>' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> argocli
      <span class="token punctuation">-</span> argoexec
      <span class="token punctuation">-</span> workflow<span class="token punctuation">-</span>controller
      <span class="token punctuation">-</span> filebrowser
      <span class="token punctuation">-</span> nginx
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># æ£€æŸ¥å®¹å™¨è¿è¡Œçš„çŠ¶æ€æ˜¯å¦æ­£å¸¸</span>
  <span class="token key atrule">check_container_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> crictl ps <span class="token punctuation">-</span><span class="token punctuation">-</span>output=json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.containers<span class="token punctuation">[</span><span class="token punctuation">]</span>.metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> argo<span class="token punctuation">-</span>server
      <span class="token punctuation">-</span> controller
      <span class="token punctuation">-</span> nginx
      <span class="token punctuation">-</span> filebrowser
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># æ£€æŸ¥ä¸€äº› deployment çš„çŠ¶æ€æ˜¯å¦æ­£å¸¸</span>
  <span class="token key atrule">check_k8s_deployment_status</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span> kubectl get deploy <span class="token punctuation">-</span>n default <span class="token punctuation">-</span>o json <span class="token punctuation">|</span> jq <span class="token punctuation">-</span>r '.items<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">|</span> select(.status.replicas == .status.availableReplicas) <span class="token punctuation">|</span> .metadata.name' <span class="token punctuation">|</span> sort <span class="token punctuation">-</span>u
    <span class="token key atrule">exit-status</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stderr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">stdout</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> argo<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>argo<span class="token punctuation">-</span>workflows<span class="token punctuation">-</span>server
      <span class="token punctuation">-</span> argo<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>argo<span class="token punctuation">-</span>workflows<span class="token punctuation">-</span>workflow<span class="token punctuation">-</span>controller
      <span class="token punctuation">-</span> filebrowser
    <span class="token key atrule">skip</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># ä¸€äº›ç¡¬ä»¶å‚æ•°çš„æ£€æŸ¥ï¼Œæ¯”å¦‚ CPU æ ¸å¿ƒæ•°ã€å†…å­˜å¤§å°ã€å¯ç”¨å†…å­˜å¤§å°</span>
<span class="token key atrule">matching</span><span class="token punctuation">:</span>
  <span class="token key atrule">check_vm_cpu_core</span><span class="token punctuation">:</span>
    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.cpu_core_number <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">matches</span><span class="token punctuation">:</span>
      <span class="token key atrule">gt</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">check_vm_memory_size</span><span class="token punctuation">:</span>
    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.memory_size <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">matches</span><span class="token punctuation">:</span>
      <span class="token key atrule">gt</span><span class="token punctuation">:</span> <span class="token number">1880000</span>
  <span class="token key atrule">check_available_memory_size</span><span class="token punctuation">:</span>
    <span class="token key atrule">content</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> .Vars.available_memory_size <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">matches</span><span class="token punctuation">:</span>
      <span class="token key atrule">gt</span><span class="token punctuation">:</span> <span class="token number">600000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¦å¤– goss ä¹Ÿæ¯”è¾ƒé€‚åˆåšä¸€äº›å·¡æ£€çš„å·¥ä½œã€‚æ¯”å¦‚åœ¨ä¸€ä¸ª k8s é›†ç¾¤ä¸­è¿›è¡Œå·¡æ£€ï¼šæ£€æŸ¥é›†ç¾¤å†… pod çš„çŠ¶æ€ã€kubernetes ç»„ä»¶çš„çŠ¶æ€ã€CNI è¿è¡ŒçŠ¶æ€ã€èŠ‚ç‚¹çš„ç½‘ç»œã€ç£ç›˜å­˜å‚¨ç©ºé—´ã€CPU è´Ÿè½½ã€å†…æ ¸å‚æ•°ã€daemonset æœåŠ¡çŠ¶æ€ç­‰ï¼Œéƒ½å¯ä»¥å‚ç…§ä¸Šè¿°æ–¹å¼å®šä¹‰ä¸€ç³»åˆ—çš„æ£€æŸ¥é¡¹ï¼Œä½¿ç”¨ goss æ¥å¸®æˆ‘ä»¬è‡ªåŠ¨å®Œæˆå·¡æ£€ã€‚</p>
<h3 id="å¯¼å…¥-OVA-è™šæ‹Ÿæœºå-Pod-çŠ¶æ€å¼‚å¸¸"><a href="#å¯¼å…¥-OVA-è™šæ‹Ÿæœºå-Pod-çŠ¶æ€å¼‚å¸¸" class="headerlink" title="å¯¼å…¥ OVA è™šæ‹Ÿæœºå Pod çŠ¶æ€å¼‚å¸¸"></a>å¯¼å…¥ OVA è™šæ‹Ÿæœºå Pod çŠ¶æ€å¼‚å¸¸</h3><p>å°† OVA è™šæ‹Ÿæœºåœ¨ VMware Workstation ä¸Šå¯¼å…¥ä¹‹åï¼Œç”±äºè™šæ‹Ÿæœº IP çš„å˜åŒ–å¯èƒ½ä¼šå¯¼è‡´ä¸€äº› Pod å¤„äºå¼‚å¸¸çš„çŠ¶æ€ï¼Œè¿™æ—¶å€™å°±éœ€è¦å¯¹è¿™äº› Pod è¿›è¡Œå¼ºåˆ¶åˆ é™¤ï¼Œå¼ºåˆ¶é‡å¯ä¸€ä¸‹æ‰èƒ½æ¢å¤æ­£å¸¸ã€‚å› æ­¤éœ€è¦éœ€è¦åœ¨è™šæ‹Ÿæœºé‡Œå¢åŠ ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://github.com/muzi502/packer-vsphere-example/blob/master/scripts/prepare.sh">prepare.sh</a> è„šæœ¬ç”¨æ¥é‡å¯è¿™äº›çŠ¶æ€å¼‚å¸¸çš„ Podã€‚å½“å¯¼å…¥ OVA è™šæ‹Ÿæœºåè¿è¡Œè¿™ä¸ªè„šæœ¬è®©æ‰€æœ‰çš„ Pod éƒ½æ­£å¸¸è¿è¡Œèµ·æ¥ï¼Œç„¶åå†è°ƒç”¨ goss æ¥æ£€æŸ¥å…¶ä»–æœåŠ¡æ˜¯å¦æ­£å¸¸ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> errexit
<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> nounset
<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> pipefail

kubectl get pods --no-headers <span class="token parameter variable">-n</span> kube-system <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'0/2|0/1|Error|Unknown|CreateContainerError|CrashLoopBackOff'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">-I</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> kubectl delete pod <span class="token parameter variable">-n</span> kube-system --grace-period<span class="token operator">=</span><span class="token number">0</span> <span class="token parameter variable">--force</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> /dev/null  <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token boolean">true</span>
kubectl get pods --no-headers <span class="token parameter variable">-n</span> default <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'0/1|Error|Unknown|CreateContainerError|CrashLoopBackOff'</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">-I</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> kubectl delete pod <span class="token parameter variable">-n</span> default --grace-period<span class="token operator">=</span><span class="token number">0</span> <span class="token parameter variable">--force</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token operator">></span> /dev/null  <span class="token operator"><span class="token file-descriptor important">2</span>></span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">||</span> <span class="token boolean">true</span>
<span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token keyword">if</span> kubectl get pods --no-headers --all-namespaces <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-Ev</span> <span class="token string">'Running|Completed'</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"Waiting for service readiness"</span>
    <span class="token function">sleep</span> <span class="token number">10</span>
  <span class="token keyword">else</span>
    <span class="token builtin class-name">break</span>
  <span class="token keyword">fi</span>
<span class="token keyword">done</span>

<span class="token builtin class-name">cd</span> <span class="token variable">$&#123;<span class="token environment constant">HOME</span>&#125;</span>/.goss
<span class="token function">cat</span> <span class="token operator">></span> vars.yaml <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
ip_address: <span class="token variable"><span class="token variable">$(</span><span class="token function">ip</span> r get <span class="token number">1</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">"s/ uid.*//g"</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $NF&#125;'</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-n1</span><span class="token variable">)</span></span>
cpu_core_number: <span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token parameter variable">-c</span> ^processor /proc/cpuinfo<span class="token variable">)</span></span>
memory_size: <span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token string">'^MemTotal:'</span> /proc/meminfo <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span><span class="token variable">)</span></span>
available_memory_size: <span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> <span class="token string">'^MemAvailable:'</span> /proc/meminfo <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $2&#125;'</span><span class="token variable">)</span></span>
EOF</span>
goss <span class="token parameter variable">--vars</span> vars.yaml <span class="token parameter variable">-g</span> goss.yaml validate --retry-timeout<span class="token operator">=</span>10s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.escapelife.site/posts/754ba85c.html">K3S å·¥å…·è¿›é˜¶å®Œå…¨æŒ‡å—</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.rancher.cn/docs/k3s/installation/installation-requirements/resource-profiling/_index/">K3s èµ„æºåˆ†æ</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/aelsabbahy/goss/blob/master/docs/manual.md">goss</a>ï¼šgoss é…ç½®æ–‡æ¡£</li>
<li><a target="_blank" rel="noopener" href="https://github.com/alexellis/awesome-baremetal">awesome-baremetal</a>ï¼šä¸€äº›ä¸è£¸é‡‘å±æœåŠ¡å™¨ç›¸å…³çš„å·¥å…·æ±‡æ€»</li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax">Kickstart Syntax Reference</a>ï¼šCentOS&#x2F;Red Hat kickstart è¯­æ³•</li>
<li><a target="_blank" rel="noopener" href="https://vmware.github.io/photon/assets/files/html/3.0/photon_user/kickstart.html">Kickstart Support in Photon OS</a>ï¼šPhoton OS çš„ kickstart è¯­æ³•</li>
</ul>
<h3 id="Packer-ç›¸å…³"><a href="#Packer-ç›¸å…³" class="headerlink" title="Packer ç›¸å…³"></a>Packer ç›¸å…³</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/chef/bento">bento</a>ï¼šæ˜¯ä¸€ä¸ª Packer æœ€ä½³å®è·µçš„æ¨¡ç‰ˆä»“åº“ï¼Œä¸è¿‡å®ƒçš„ builder æ˜¯ Vagrantï¼Œä½†å¯ä»¥ä»ä¸­å€Ÿé‰´ä¸€äº› Linux å‘è¡Œç‰ˆçš„è‡ªåŠ¨åŒ–å®‰è£…è„šæœ¬ï¼Œæ¯”å¦‚ CentOS çš„ <a target="_blank" rel="noopener" href="https://github.com/chef/bento/tree/main/packer_templates/centos/http">kickstart</a> æ–‡ä»¶ã€‚</li>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/FnnMnu9i6gFNrAjIlzaNnQ">åŸºäº Packer+Ansible å®ç°äº‘å¹³å°é»„é‡‘é•œåƒç»Ÿä¸€æ„å»ºå’Œå‘å¸ƒ</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/image-builder/tree/master/images/capi">Image Builder for Cluster API</a></li>
<li><a target="_blank" rel="noopener" href="https://image-builder.sigs.k8s.io/capi/providers/vsphere.html#building-images-for-vsphere">Building Images for vSphere</a></li>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/plugins/builders/vsphere/vsphere-clone">VMware vSphere Clone Builder</a></li>
<li><a target="_blank" rel="noopener" href="https://www.packer.io/plugins/builders/vsphere/vsphere-iso">Packer Builder for VMware vSphere</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hashicorp/packer-plugin-vsphere">packer-plugin-vsphere</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/vmware-samples/packer-examples-for-vsphere">packer-examples-for-vsphere</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.rockylinux.org/guides/automation/templates-automation-packer-vsphere/">Automatic template creation with Packer and deployment with Ansible in a VMware vSphere environment</a></li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/argo-workflow/" rel="tag"># argo-workflow</a>
              <a href="/tags/vSphere/" rel="tag"># vSphere</a>
              <a href="/tags/packer/" rel="tag"># packer</a>
              <a href="/tags/esxi/" rel="tag"># esxi</a>
              <a href="/tags/k3s/" rel="tag"># k3s</a>
              <a href="/tags/redfish/" rel="tag"># redfish</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/redfish-esxi-os-installer.html" rel="prev" title="ä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OS">
                  <i class="fa fa-chevron-left"></i> ä½¿ç”¨ Redfish è‡ªåŠ¨åŒ–å®‰è£… ESXi OS
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/One-Year-After-the-Lockdown-in-Shanghai.html" rel="next" title="å†™åœ¨ä¸Šæµ·å°åŸä¸€å¹´ä¹‹å">
                  å†™åœ¨ä¸Šæµ·å°åŸä¸€å¹´ä¹‹å <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.8m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">26:46</span>
  </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
