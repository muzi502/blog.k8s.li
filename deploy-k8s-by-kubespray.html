<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.2.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="公司 PaaS 平台底层的 kubernetes 集群部署采用的开源的 kubespray，正好我在参与 kubespray 二开工作。在这段时主要完成了 kubespray 自动化打包发布流水线、私有化部署、增加自研 CNI 部署、以及一些 bugfix 等。最近抽空整理并总结一下使用 kubespray 在本地开发测试部署 kubernetes 集群踩的一些坑。 准备劝退三连 😂：  需要一">
<meta property="og:type" content="blog">
<meta property="og:title" content="使用 Kubespray 本地开发测试部署 kubernetes 集群">
<meta property="og:url" content="https://blog.k8s.li/deploy-k8s-by-kubespray.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="公司 PaaS 平台底层的 kubernetes 集群部署采用的开源的 kubespray，正好我在参与 kubespray 二开工作。在这段时主要完成了 kubespray 自动化打包发布流水线、私有化部署、增加自研 CNI 部署、以及一些 bugfix 等。最近抽空整理并总结一下使用 kubespray 在本地开发测试部署 kubernetes 集群踩的一些坑。 准备劝退三连 😂：  需要一">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-04-28T16:00:00.000Z">
<meta property="article:modified_time" content="2021-04-28T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="kubespray">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.k8s.li/deploy-k8s-by-kubespray.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/deploy-k8s-by-kubespray.html","path":"deploy-k8s-by-kubespray.html","title":"使用 Kubespray 本地开发测试部署 kubernetes 集群"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>使用 Kubespray 本地开发测试部署 kubernetes 集群 | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87"><span class="nav-number">1.</span> <span class="nav-text">准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%9F%E5%90%8D-SSL-%E8%AF%81%E4%B9%A6%E5%88%B6%E4%BD%9C"><span class="nav-number">1.1.</span> <span class="nav-text">域名 SSL 证书制作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93"><span class="nav-number">1.2.</span> <span class="nav-text">搭建镜像仓库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="nav-number">1.3.</span> <span class="nav-text">文件服务器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-skopeo"><span class="nav-number">1.4.</span> <span class="nav-text">编译安装 skopeo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E9%83%A8%E7%BD%B2%E9%9C%80%E8%A6%81%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6"><span class="nav-number">1.5.</span> <span class="nav-text">获取部署需要的二进制文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E9%83%A8%E7%BD%B2%E9%9C%80%E8%A6%81%E7%9A%84%E9%95%9C%E5%83%8F"><span class="nav-number">1.6.</span> <span class="nav-text">获取部署需要的镜像</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE"><span class="nav-number">2.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#inventory"><span class="nav-number">2.1.</span> <span class="nav-text">inventory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vars"><span class="nav-number">2.2.</span> <span class="nav-text">vars</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-ce-mirrors"><span class="nav-number">2.3.</span> <span class="nav-text">docker-ce mirrors</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2"><span class="nav-number">3.</span> <span class="nav-text">部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%90%E6%A7%BD"><span class="nav-number">4.</span> <span class="nav-text">吐槽</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">115</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">147</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail → mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/deploy-k8s-by-kubespray.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="使用 Kubespray 本地开发测试部署 kubernetes 集群 | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          使用 Kubespray 本地开发测试部署 kubernetes 集群
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-29 2021-04-29T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2021-04-29T00:00:00+08:00">2021-04-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/deploy-k8s-by-kubespray.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="deploy-k8s-by-kubespray.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>23k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>21 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>公司 PaaS 平台底层的 kubernetes 集群部署采用的开源的 kubespray，正好我在参与 kubespray 二开工作。在这段时主要完成了 kubespray 自动化打包发布流水线、私有化部署、增加自研 CNI 部署、以及一些 bugfix 等。最近抽空整理并总结一下使用 kubespray 在本地开发测试部署 kubernetes 集群踩的一些坑。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>劝退三连 😂：</p>
<ul>
<li>需要一个部署镜像仓库和 nginx</li>
<li>需要一个域名，最好已经设置好 DNS 解析和 SSL 证书</li>
<li>集群节点需要至少两台机器，并且可以访问外网</li>
</ul>
<p>虽然手头里有一大批开发机器，但由于我的域名 <code>k8s.li</code> 比较特殊，国内很难进行备案（也不想备案），所以无法将 DNS 解析到这些国内的服务器上。因此我打算将域名解析到一台国外的服务器上，然后再使用 nginx rewrite 重写将请求转发到阿里云的 OSS ；另外 docker registry 的后端存储也可以选择使用阿里云 OSS，这样客户端在拉取镜像的时候，只会通过我的域名获取镜像的 manifest 文件，镜像的 blobs 数据将会转发到阿里云 OSS。在集群部署的时候，下载文件和镜像最主要的流量都会通过阿里云 OSS，这样可以节省集群部署耗时，提高部署效率，同时又能剩下一笔服务器的流量费用。</p>
<h3 id="域名-SSL-证书制作"><a href="#域名-SSL-证书制作" class="headerlink" title="域名 SSL 证书制作"></a>域名 SSL 证书制作</h3><p>域名 SSL 证书主要是给镜像仓库使用的，假如证书是自签的或者镜像仓库使用的是 HTTP 协议，这样会导致 docker 或者 containerd 无法拉取镜像，需要为集群所有节点配置 <code>insecure-registries</code>  这个参数。搞起来比较麻烦，因此还是推荐给镜像仓库加一个非自签的 SSL 证书，这样能减少一些不必要的麻烦。如果有现成的镜像仓库并且配置好了 SSL 证书，可以略过此步。</p>
<p>制作域名证书的方式有很多种，个人比较推荐使用 acme.sh 。它实现了 acme 协议支持的所有验证协议，并且支持支持数十种域名解析商。由于我的域名是托管在 cloudflare 上的，使用 acme.sh 来签发证书特别方便，只需要配置两个参数即可。下面就给 k8s.li 这个域名签发一个泛域名证书。</p>
<ul>
<li>安装  acme.sh</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> https://get.acme.sh <span class="token operator">|</span> <span class="token function">sh</span>
~/.acme.sh/acme.sh --help<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>签发证书</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">CF_Email</span><span class="token operator">=</span><span class="token string">"muzi502.li@gmail.com"</span> <span class="token comment"># cloudflare 账户的邮箱</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CF_Key</span><span class="token operator">=</span><span class="token string">"xxxxxx"</span> <span class="token comment"># "cloudflare中查看你的key"</span>

~/.acme.sh/acme.sh --issue --dns dns_cf -d k8s.li -d *.k8s.li

<span class="token punctuation">[</span>Tue Apr <span class="token number">27</span> 07:32:52 UTC <span class="token number">2021</span><span class="token punctuation">]</span> Cert success.
<span class="token punctuation">[</span>Tue Apr <span class="token number">27</span> 07:32:52 UTC <span class="token number">2021</span><span class="token punctuation">]</span> Your cert is <span class="token keyword">in</span>  /root/.acme.sh/k8s.li/k8s.li.cer
<span class="token punctuation">[</span>Tue Apr <span class="token number">27</span> 07:32:52 UTC <span class="token number">2021</span><span class="token punctuation">]</span> Your cert key is <span class="token keyword">in</span>  /root/.acme.sh/k8s.li/k8s.li.key
<span class="token punctuation">[</span>Tue Apr <span class="token number">27</span> 07:32:52 UTC <span class="token number">2021</span><span class="token punctuation">]</span> The intermediate CA cert is <span class="token keyword">in</span>  /root/.acme.sh/k8s.li/ca.cer
<span class="token punctuation">[</span>Tue Apr <span class="token number">27</span> 07:32:52 UTC <span class="token number">2021</span><span class="token punctuation">]</span> And the full chain certs is there:  /root/.acme.sh/k8s.li/fullchain.cer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>前面证书生成以后，接下来需要把证书 copy 到真正需要用它的地方。</p>
<p>注意，默认生成的证书都放在安装目录下 <code>~/.acme.sh/</code>， 请不要直接使用此目录下的文件，例如: 不要直接让 <code>nginx/apache</code> 的配置文件使用这下面的文件。这里面的文件都是内部使用，而且目录结构可能会变化。</p>
<p>正确的使用方法是使用 <code>--installcert</code> 命令，并指定目标位置，然后证书文件会被 copy 到相应的位置</p>
</blockquote>
<ul>
<li>安装证书</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">acme.sh --install-cert -d k8s.li <span class="token punctuation">\</span>
--cert-file      /etc/nginx/ssl/k8s.li.cer  <span class="token punctuation">\</span>
--key-file       /etc/nginx/ssl/k8s.li.key  <span class="token punctuation">\</span>
--fullchain-file /etc/nginx/ssl/fullchain.cer<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="搭建镜像仓库"><a href="#搭建镜像仓库" class="headerlink" title="搭建镜像仓库"></a>搭建镜像仓库</h3><ul>
<li>config.yml</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">0.1</span>
<span class="token key atrule">log</span><span class="token punctuation">:</span>
  <span class="token key atrule">fields</span><span class="token punctuation">:</span>
    <span class="token key atrule">service</span><span class="token punctuation">:</span> registry
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">blobdescriptor</span><span class="token punctuation">:</span> inmemory
  <span class="token key atrule">oss</span><span class="token punctuation">:</span>
    <span class="token key atrule">accesskeyid</span><span class="token punctuation">:</span> xxxx <span class="token comment"># 这里配置阿里云 OSS 的 accesskeyid</span>
    <span class="token key atrule">accesskeysecret</span><span class="token punctuation">:</span> xxxx <span class="token comment"># 这里配置阿里云 OSS 的 accesskeysecret</span>
    <span class="token key atrule">region</span><span class="token punctuation">:</span> oss<span class="token punctuation">-</span>cn<span class="token punctuation">-</span>beijing <span class="token comment"># 配置 OSS bucket 的区域，比如 oss-cn-beijing</span>
    <span class="token key atrule">internal</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">bucket</span><span class="token punctuation">:</span> fileserver <span class="token comment"># 配置存储 bucket 的名称</span>
    <span class="token key atrule">rootdirectory</span><span class="token punctuation">:</span> /kubespray/registry <span class="token comment"># 配置路径</span>
  <span class="token key atrule">delete</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token key atrule">addr</span><span class="token punctuation">:</span> 0.0.0.0<span class="token punctuation">:</span><span class="token number">5000</span>
  <span class="token key atrule">headers</span><span class="token punctuation">:</span>
    <span class="token key atrule">X-Content-Type-Options</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nosniff<span class="token punctuation">]</span>
<span class="token key atrule">health</span><span class="token punctuation">:</span>
  <span class="token key atrule">storagedriver</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s
    <span class="token key atrule">threshold</span><span class="token punctuation">:</span> <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>docker-compose</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">hub-registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry<span class="token punctuation">:</span>2.7.1
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> hub<span class="token punctuation">-</span>registry
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./config.yml<span class="token punctuation">:</span>/etc/docker/registry/config.yml
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span>5000<span class="token punctuation">:</span><span class="token number">5000</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>nginx.conf</li>
</ul>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span>       [::]:443</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  hub.k8s.li</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate</span> /etc/nginx/ssl/fullchain.cer</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /etc/nginx/ssl/k8s.li.key</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_static</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">4096m</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_method</span> !~* GET)</span> <span class="token punctuation">&#123;</span>
         <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span>   http://localhost:5000</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="文件服务器"><a href="#文件服务器" class="headerlink" title="文件服务器"></a>文件服务器</h3><p>文件服务器用于存放一些 kubeadm、kubectl、kubelet 等二进制文件，kubespray 默认的下载地址在国内访问特别慢，因此需要搭建一个 http&#x2F;https 服务器，用于给集群部署下载这些二进制文件使用。</p>
<ul>
<li>nginx.conf</li>
</ul>
<p>需要注意，这里的 nginx 配置使用的是 rewrite 而不是 proxy_pass，这样客户端在想我的服务器请求文件时，会重写客户端的请求，让客户端去请求阿里云 OSS 的地址。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">443</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span> [::]:443</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>   dl.k8s.li</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate</span> /etc/nginx/ssl/fullchain.cer</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> /etc/nginx/ssl/k8s.li.key</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">rewrite</span> ^/(.*)$ https://fileserver.oss-cn-beijing.aliyuncs.com/kubespray/files/<span class="token variable">$1</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_hide_header</span> Content-Disposition</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_hide_header</span> x-oss-request-id</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_hide_header</span> x-oss-object-type</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_hide_header</span> x-oss-hash-crc64ecma</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_hide_header</span> x-oss-storage-class</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_hide_header</span> x-oss-force-download</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_hide_header</span> x-oss-server-time</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="编译安装-skopeo"><a href="#编译安装-skopeo" class="headerlink" title="编译安装 skopeo"></a>编译安装 skopeo</h3><p>安装 skopeo 用来同步一些使用的镜像到私有镜像仓库，性能上比 docker 快很多，强烈推荐。skopeo 的安装方式可参考官方文档 <a target="_blank" rel="noopener" href="https://github.com/containers/skopeo/blob/master/install.md">Installing from packages</a> 。不过个人还是使用 go buid 编译一个静态链接的可执行文件，这样在 Linux 发行版都可以使用。不然在 Debian 上编译的可执行文件无法拿到 CentOS 上使用，因为二者使用的动态链接库不一样！</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/root/skopeo git:<span class="token punctuation">(</span>master*<span class="token punctuation">)</span> <span class="token comment"># git clone https://github.com/containers/skopeo &amp;&amp; cd skopeo</span>

<span class="token comment"># 本地开发机器已经安装并配置好了 golang 编译环境</span>
root@debian:/root/skopeo git:<span class="token punctuation">(</span>master*<span class="token punctuation">)</span> <span class="token comment"># CGO_ENABLE=0 GO111MODULE=on go build -mod=vendor "-buildmode=pie" -ldflags '-extldflags "-static"' -gcflags "" -tags "exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp" -o bin/skopeo ./cmd/skopeo</span>

root@debian:/root/skopeo git:<span class="token punctuation">(</span>master*<span class="token punctuation">)</span> <span class="token comment"># ldd bin/skopeo</span>
not a dynamic executable<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="获取部署需要的二进制文件"><a href="#获取部署需要的二进制文件" class="headerlink" title="获取部署需要的二进制文件"></a>获取部署需要的二进制文件</h3><p>kubespray 部署的时候需要到 github.com 或 storage.googleapis.com 下载一些二进制文件，这些地址在国内都都被阻断了，因此需要将部署时依赖的文件上传到自己的文件服务器上。自己写了个脚本用于获取 kubespray 部署需要的二进制文件，在 kubespray repo 的根目录下执行,下载的文件默认会存放在 <code>temp/files</code> 目录下。下载完成之后将该目录下的所有子目录上传到自己的文件服务器上。后面配置一些参数在这个地址的参数前面加上自己文件服务器的 URL 即可。</p>
<ul>
<li>首先 clone repo 到本地</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/root<span class="token comment"># git clone https://github.com/kubernetes-sigs/kubespray &amp;&amp; cd kubespray</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>将该脚本 <code>generate_list.sh</code> 保存到 repo 根目录下，并执行该脚下载需要的文件。</li>
</ul>
<blockquote>
<p>ps: 用 shell 脚本去处理 Jinja2 的 yaml， 写 sed 写得我想吐 🤮</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">set</span> -eo pipefail

<span class="token assign-left variable">CURRENT_DIR</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">cd</span> <span class="token punctuation">$(</span>dirname $0<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>
<span class="token assign-left variable">TEMP_DIR</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;CURRENT_DIR&#125;</span>/temp"</span>
<span class="token assign-left variable">REPO_ROOT_DIR</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;CURRENT_DIR&#125;</span>"</span>

<span class="token builtin class-name">:</span> <span class="token variable">$&#123;IMAGE_ARCH<span class="token operator">:=</span>"amd64"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;ANSIBLE_SYSTEM<span class="token operator">:=</span>"linux"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;ANSIBLE_ARCHITECTURE<span class="token operator">:=</span>"x86_64"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;DOWNLOAD_YML<span class="token operator">:=</span>"roles<span class="token operator">/</span>download<span class="token operator">/</span>defaults<span class="token operator">/</span>main.yml"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;KUBE_VERSION_YAML<span class="token operator">:=</span>"roles<span class="token operator">/</span>kubespray-defaults<span class="token operator">/</span>defaults<span class="token operator">/</span>main.yaml"&#125;</span>

<span class="token function">mkdir</span> -p <span class="token variable">$&#123;TEMP_DIR&#125;</span>
<span class="token function-name function">generate_versions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment"># ARCH used in convert &#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125; to &#123;&#123;arch&#125;&#125;</span>
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$&#123;IMAGE_ARCH&#125;</span>"</span> <span class="token operator">!=</span> <span class="token string">"amd64"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token assign-left variable">ARCH</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;IMAGE_ARCH&#125;</span>"</span><span class="token punctuation">;</span> <span class="token keyword">fi</span>

    <span class="token function">cat</span> <span class="token operator">></span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/version.sh <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
arch=<span class="token variable">$&#123;ARCH&#125;</span>
image_arch=<span class="token variable">$&#123;IMAGE_ARCH&#125;</span>
ansible_system=<span class="token variable">$&#123;ANSIBLE_SYSTEM&#125;</span>
ansible_architecture=<span class="token variable">$&#123;ANSIBLE_ARCHITECTURE&#125;</span>
EOF</span>
    <span class="token function">grep</span> <span class="token string">'kube_version:'</span> <span class="token variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="token variable">$&#123;KUBE_VERSION_YAML&#125;</span> <span class="token punctuation">\</span>
    <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/: /=/g'</span> <span class="token operator">>></span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/version.sh
    <span class="token function">grep</span> <span class="token string">'_version:'</span> <span class="token variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="token variable">$&#123;DOWNLOAD_YML&#125;</span> <span class="token punctuation">\</span>
    <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">' '</span> <span class="token operator">>></span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/version.sh
    <span class="token function">sed</span> -i <span class="token string">'s/kube_major_version=.*/kube_major_version=$&#123;kube_version%.*&#125;/g'</span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/version.sh
    <span class="token function">sed</span> -i <span class="token string">'s/crictl_version=.*/crictl_version=$&#123;kube_version%.*&#125;.0/g'</span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/version.sh
<span class="token punctuation">&#125;</span>

<span class="token function-name function">generate_files_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"source <span class="token variable">$&#123;TEMP_DIR&#125;</span>/version.sh"</span> <span class="token operator">></span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/files.sh
    <span class="token function">grep</span> <span class="token string">'download_url:'</span> <span class="token variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="token variable">$&#123;DOWNLOAD_YML&#125;</span> <span class="token punctuation">\</span>
    <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/: /=/g;s/ //g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g;s/|lower//g;s/^.*_url=/echo /g'</span> <span class="token operator">>></span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/files.sh
    <span class="token function">bash</span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/files.sh <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">></span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/files.list
<span class="token punctuation">&#125;</span>

<span class="token function-name function">generate_images_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token assign-left variable">KUBE_IMAGES</span><span class="token operator">=</span><span class="token string">"kube-apiserver kube-controller-manager kube-scheduler kube-proxy"</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"source <span class="token variable">$&#123;TEMP_DIR&#125;</span>/version.sh"</span> <span class="token operator">></span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/images.sh
    <span class="token function">grep</span> -E <span class="token string">'_repo:|_tag:'</span> <span class="token variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="token variable">$&#123;DOWNLOAD_YML&#125;</span> <span class="token punctuation">\</span>
    <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">"s#&#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125;#&#123;&#123;arch&#125;&#125;#g"</span> <span class="token punctuation">\</span>
    <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">' '</span> <span class="token operator">>></span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/images.sh
    <span class="token function">sed</span> -n <span class="token string">'/^downloads:/,/download_defaults:/p'</span> <span class="token variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="token variable">$&#123;DOWNLOAD_YML&#125;</span> <span class="token punctuation">\</span>
    <span class="token operator">|</span> <span class="token function">sed</span> -n <span class="token string">"s/repo: //p;s/tag: //p"</span> <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">' '</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> <span class="token punctuation">\</span>
    <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'N;s#\n# #g'</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">' '</span> <span class="token string">':'</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/^/echo /g'</span> <span class="token operator">>></span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/images.sh
    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$&#123;KUBE_IMAGES&#125;</span>"</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token string">' '</span> <span class="token string">'\n'</span> <span class="token operator">|</span> <span class="token function">xargs</span> -L1 -I <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> <span class="token punctuation">\</span>
    <span class="token builtin class-name">echo</span> <span class="token string">'echo $&#123;kube_image_repo&#125;/&#123;&#125;:$&#123;kube_version&#125;'</span> <span class="token operator">>></span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/images.sh
    <span class="token function">bash</span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/images.sh <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">></span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/images.list
<span class="token punctuation">&#125;</span>

generate_versions
generate_files_list
generate_images_list
<span class="token function">wget</span> -x -P <span class="token variable">$&#123;TEMP_DIR&#125;</span>/files -i <span class="token variable">$&#123;TEMP_DIR&#125;</span>/files.list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最终下载的结果如下，基本上保持了原有的 URL 路径，也方便后续的更新和版本迭代。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">temp/files
├── get.helm.sh
│   └── helm-v3.5.4-linux-amd64.tar.gz
├── github.com
│   ├── containerd
│   │   └── nerdctl
│   │       └── releases
│   │           └── download
│   │               └── v0.8.0
│   │                   └── nerdctl-0.8.0-linux-amd64.tar.gz
│   ├── containernetworking
│   │   └── plugins
│   │       └── releases
│   │           └── download
│   │               └── v0.9.1
│   │                   └── cni-plugins-linux-amd64-v0.9.1.tgz
│   ├── containers
│   │   └── crun
│   │       └── releases
│   │           └── download
│   │               └── <span class="token number">0.19</span>
│   │                   └── crun-0.19-linux-amd64
│   ├── coreos
│   │   └── etcd
│   │       └── releases
│   │           └── download
│   │               └── v3.4.13
│   │                   └── etcd-v3.4.13-linux-amd64.tar.gz
│   ├── kata-containers
│   │   └── runtime
│   │       └── releases
│   │           └── download
│   │               └── <span class="token number">1.12</span>.1
│   │                   └── kata-static-1.12.1-x86_64.tar.xz
│   ├── kubernetes-sigs
│   │   └── cri-tools
│   │       └── releases
│   │           └── download
│   │               └── v1.20.0
│   │                   └── crictl-v1.20.0-linux-amd64.tar.gz
│   └── projectcalico
│       ├── calico
│       │   └── archive
│       │       └── v3.17.3.tar.gz
│       └── calicoctl
│           └── releases
│               └── download
│                   └── v3.17.3
│                       └── calicoctl-linux-amd64
└── storage.googleapis.com
    └── kubernetes-release
        └── release
            └── v1.20.6
                └── bin
                    └── linux
                        └── amd64
                            ├── kubeadm
                            ├── kubectl
                            └── kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="获取部署需要的镜像"><a href="#获取部署需要的镜像" class="headerlink" title="获取部署需要的镜像"></a>获取部署需要的镜像</h3><p>对于离线部署，kubespray 支持的并不是很友好。比如获取部署需要的镜像列表，目前的方案是需要先部署一个集群，然后通过 kubectl get 一些资源来获取 pod 使用到的镜像。个人觉得这个方式可以修改一下，比如通过 kubespray 源码来生成一个镜像列表。下面只是简单生成一个镜像列表，内容如下</p>
<ul>
<li>images.list</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker.io/nginx:1.19.0
docker.io/calico/cni:v3.17.3
docker.io/calico/node:v3.17.3
docker.io/calico/kube-controllers:v3.17.3
quay.io/coreos/flannel:v0.13.0
quay.io/coreos/flannel:v0.13.0-amd64
k8s.gcr.io/pause:3.2
k8s.gcr.io/coredns:1.7.0
k8s.gcr.io/kube-apiserver:v1.20.6
k8s.gcr.io/kube-controller-manager:v1.20.6
k8s.gcr.io/kube-proxy:v1.20.6
k8s.gcr.io/kube-scheduler:v1.20.6
k8s.gcr.io/dns/k8s-dns-node-cache:1.17.1
k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64:1.8.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>由于 master 分支的代码一直在更新，当前的 master 分支的版本可能和这里的不太一样，需要修改为自己需要的版本。</p>
<ul>
<li>根据上面的镜像列表，使用 skopeo 将镜像同步到自己的镜像仓库中，如我的 <code>hub.k8s.li</code></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">image</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> images.list<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> skopeo copy docker://<span class="token variable">$&#123;image&#125;</span> docker://hub.k8s.li/<span class="token variable">$&#123;image<span class="token operator">#</span>*<span class="token operator">/</span>&#125;</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>同步到我的镜像仓库中，内容就如下，在部署的时候通过修改一些镜像仓库的地址即可</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hub.k8s.li/nginx:1.19.0
hub.k8s.li/calico/cni:v3.17.3
hub.k8s.li/calico/node:v3.17.3
hub.k8s.li/calico/kube-controllers:v3.17.3
hub.k8s.li/coreos/flannel:v0.13.0
hub.k8s.li/coreos/flannel:v0.13.0-amd64
hub.k8s.li/pause:3.2
hub.k8s.li/coredns:1.7.0
hub.k8s.li/kube-apiserver:v1.20.6
hub.k8s.li/kube-controller-manager:v1.20.6
hub.k8s.li/kube-proxy:v1.20.6
hub.k8s.li/kube-scheduler:v1.20.6
hub.k8s.li/dns/k8s-dns-node-cache:1.17.1
hub.k8s.li/cpa/cluster-proportional-autoscaler-amd64:1.8.3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>至此准备工作大致都已经完成了，接下来开始配置 kubespray 的一些参数和 inventory 文件</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>按照 kubespray 文档说明，将 <code>inventory/sample</code> 目录复制一份，然后通过修改里面的参数来控制部署。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/root/kubespray git:<span class="token punctuation">(</span>master*<span class="token punctuation">)</span> <span class="token comment"># cp -rf inventory/sample deploy</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="inventory"><a href="#inventory" class="headerlink" title="inventory"></a>inventory</h3><ul>
<li><code>deploy/inventory</code></li>
</ul>
<p>创建主机 inventory 文件，格式如下：</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">all:vars</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">ansible_port</span><span class="token punctuation">=</span><span class="token value attr-value">22</span>
<span class="token key attr-name">ansible_user</span><span class="token punctuation">=</span><span class="token value attr-value">root</span>

<span class="token key attr-name">ansible_ssh_private_key_file</span><span class="token punctuation">=</span><span class="token value attr-value">/kubespray/.ssh/id_rsa</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">all</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">kube-control-1 ansible_host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.4.11</span>
<span class="token key attr-name">kube-control-2 ansible_host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.4.12</span>
<span class="token key attr-name">kube-control-3 ansible_host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.4.13</span>
<span class="token key attr-name">kube-node-1 ansible_host</span><span class="token punctuation">=</span><span class="token value attr-value">192.168.4.4</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">kube_control_plane</span><span class="token punctuation">]</span></span>
kube-control-1
kube-control-2
kube-control-3

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">etcd</span><span class="token punctuation">]</span></span>
kube-control-1
kube-control-2
kube-control-3

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">kube-node</span><span class="token punctuation">]</span></span>
kube-control-1
kube-control-2
kube-control-3
kube-node-1

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">calico-rr</span><span class="token punctuation">]</span></span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">k8s-cluster:children</span><span class="token punctuation">]</span></span>
kube_control_plane
kube-node
calico-rr<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>ssh 互信</li>
</ul>
<p>Kubespray 用到了 ansible 的 <a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/posix/synchronize_module.html">synchronize</a> 模块来分发文件，基于 rsync 协议所以必须要使用 ssh 密钥对来连接集群节点。inventory 配置的是 kubespray 容器内的路径，因此需要将 ssh 公钥和私钥复制到 repo 的 .ssh 目录下。如果节点就没有进行 ssh 免密登录，可以用 ansible 的 authorized_key 模块将 ssh 公钥添加到主机的 authorized_key 中。操作步骤如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/root/kubespray git:<span class="token punctuation">(</span>master*<span class="token punctuation">)</span> <span class="token comment"># mkdir -p .ssh</span>

<span class="token comment"># 生成 ssh 密钥对</span>
root@debian:/root/kubespray git:<span class="token punctuation">(</span>master*<span class="token punctuation">)</span> <span class="token comment"># ssh-keygen -t rsa -f .ssh/id_rsa -P ""</span>

<span class="token comment"># 将 ssh 公钥添加到所有主机</span>
root@debian:/root/kubespray git:<span class="token punctuation">(</span>master*<span class="token punctuation">)</span> <span class="token comment"># ansible -i deploy/inventory all -m authorized_key -a "user=&#123;&#123; ansible_user &#125;&#125; key='&#123;&#123; lookup('file', '&#123;&#123; ssh_cert_path &#125;&#125;') &#125;&#125;'" -e ssh_cert_path=./.ssh/id_rsa.pub -e ansible_ssh_pass=passwd</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="vars"><a href="#vars" class="headerlink" title="vars"></a>vars</h3><p>创建并修改以下配置文件</p>
<ul>
<li><code>deploy/env.yml</code></li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token comment"># 定义一些组件的版本</span>
<span class="token key atrule">kube_version</span><span class="token punctuation">:</span> v1.20.6
<span class="token key atrule">calico_version</span><span class="token punctuation">:</span> <span class="token string">"v3.17.3"</span>
<span class="token key atrule">pod_infra_version</span><span class="token punctuation">:</span> <span class="token string">"3.2"</span>
<span class="token key atrule">nginx_image_version</span><span class="token punctuation">:</span> <span class="token string">"1.19"</span>
<span class="token key atrule">coredns_version</span><span class="token punctuation">:</span> <span class="token string">"1.7.0"</span>
<span class="token key atrule">image_arch</span><span class="token punctuation">:</span> <span class="token string">"amd64"</span>

<span class="token comment"># docker registry domain</span>
<span class="token key atrule">registry_domain</span><span class="token punctuation">:</span> <span class="token string">"hub.k8s.li"</span>

<span class="token comment"># file download server url</span>
<span class="token key atrule">download_url</span><span class="token punctuation">:</span> <span class="token string">"https://dl.k8s.li"</span>

<span class="token comment"># docker-ce-repo mirrors</span>
<span class="token key atrule">docker_mirrors_url</span><span class="token punctuation">:</span> <span class="token string">"https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux"</span>

<span class="token key atrule">container_manager</span><span class="token punctuation">:</span> <span class="token string">"containerd"</span>

<span class="token comment"># 由于使用的是 containerd 作为 CRI，目前 etcd 不支持 containerd 容器化部署因此需要将该参数修改为 host ，使用 systemd 来部署</span>
<span class="token key atrule">etcd_deployment_type</span><span class="token punctuation">:</span> host
<span class="token key atrule">etcd_cluster_setup</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">etcd_events_cluster_setup</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">etcd_events_cluster_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

<span class="token comment"># kubernetes CNI type 配置集群 CNI 使用的类型</span>
<span class="token key atrule">kube_network_plugin</span><span class="token punctuation">:</span> canal<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>deploy/group_vars/all/download.yml</code></li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">## Container registry define</span>
<span class="token key atrule">gcr_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; registry_domain &#125;&#125;"</span>
<span class="token key atrule">kube_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; registry_domain &#125;&#125;"</span>
<span class="token key atrule">docker_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; registry_domain &#125;&#125;"</span>
<span class="token key atrule">quay_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; registry_domain &#125;&#125;"</span>

<span class="token comment"># Download URLs</span>
<span class="token key atrule">kubelet_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kube_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubelet"</span>
<span class="token key atrule">kubectl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kube_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubectl"</span>
<span class="token key atrule">kubeadm_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kubeadm_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubeadm"</span>
<span class="token key atrule">etcd_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/coreos/etcd/releases/download/&#123;&#123; etcd_version &#125;&#125;/etcd-&#123;&#123; etcd_version &#125;&#125;-linux-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token key atrule">cni_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/containernetworking/plugins/releases/download/&#123;&#123; cni_version &#125;&#125;/cni-plugins-linux-&#123;&#123; image_arch &#125;&#125;-&#123;&#123; cni_version &#125;&#125;.tgz"</span>
<span class="token key atrule">calicoctl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/projectcalico/calicoctl/releases/download/&#123;&#123; calico_ctl_version &#125;&#125;/calicoctl-linux-&#123;&#123; image_arch &#125;&#125;"</span>
<span class="token key atrule">calico_crds_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/projectcalico/calico/archive/&#123;&#123; calico_version &#125;&#125;.tar.gz"</span>
<span class="token key atrule">crictl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/kubernetes-sigs/cri-tools/releases/download/&#123;&#123; crictl_version &#125;&#125;/crictl-&#123;&#123; crictl_version &#125;&#125;-&#123;&#123; ansible_system | lower &#125;&#125;-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token key atrule">helm_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/get.helm.sh/helm-&#123;&#123; helm_version &#125;&#125;-linux-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token key atrule">crun_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/containers/crun/releases/download/&#123;&#123; crun_version &#125;&#125;/crun-&#123;&#123; crun_version &#125;&#125;-linux-&#123;&#123; image_arch &#125;&#125;"</span>
<span class="token key atrule">kata_containers_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/kata-containers/runtime/releases/download/&#123;&#123; kata_containers_version &#125;&#125;/kata-static-&#123;&#123; kata_containers_version &#125;&#125;-&#123;&#123; ansible_architecture &#125;&#125;.tar.xz"</span>
<span class="token key atrule">nerdctl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/containerd/nerdctl/releases/download/v&#123;&#123; nerdctl_version &#125;&#125;/nerdctl-&#123;&#123; nerdctl_version &#125;&#125;-&#123;&#123; ansible_system | lower &#125;&#125;-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="docker-ce-mirrors"><a href="#docker-ce-mirrors" class="headerlink" title="docker-ce mirrors"></a>docker-ce mirrors</h3><p>kubespray 安装 docker 或者 containerd 容器运行时，需要使用 docker-ce 的源，国内可以使用清华的镜像源。根据不同的 Linux 发行版，在 <code>deploy/group_vars/all/offline.yml</code> 文件中添加这些参数即可。其中 <code>docker_mirrors_url</code> 这个参数就是在 <code>env.yml</code> 里设置的参数。</p>
<ul>
<li>CentOS&#x2F;Redhat</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">## CentOS/Redhat</span>
<span class="token comment">### For EL7, base and extras repo must be available, for EL8, baseos and appstream</span>
<span class="token comment">### By default we enable those repo automatically</span>
<span class="token comment"># rhel_enable_repos: false</span>
<span class="token comment">### Docker / Containerd</span>
docker_rh_repo_base_url: <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/centos/&#123;&#123; ansible_distribution_major_version &#125;&#125;/&#123;&#123; ansible_architecture &#125;&#125;/stable"</span>
docker_rh_repo_gpgkey: <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/centos/gpg"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Fedora</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">## Fedora</span>
<span class="token comment">### Docker</span>
<span class="token key atrule">docker_fedora_repo_base_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/fedora/&#123;&#123; ansible_distribution_major_version &#125;&#125;/&#123;&#123; ansible_architecture &#125;&#125;/stable"</span>
<span class="token key atrule">docker_fedora_repo_gpgkey</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/fedora/gpg"</span>
<span class="token comment">### Containerd</span>
<span class="token key atrule">containerd_fedora_repo_base_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/fedora/&#123;&#123; ansible_distribution_major_version &#125;&#125;/&#123;&#123; ansible_architecture &#125;&#125;/stable"</span>
<span class="token key atrule">containerd_fedora_repo_gpgkey</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/fedora/gpg"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>debian</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">## Debian</span>
<span class="token comment">### Docker</span>
<span class="token key atrule">docker_debian_repo_base_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/debian"</span>
<span class="token key atrule">docker_debian_repo_gpgkey</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/debian/gpg"</span>
<span class="token comment">### Containerd</span>
<span class="token key atrule">containerd_debian_repo_base_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/debian"</span>
<span class="token key atrule">containerd_debian_repo_gpgkey</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/debian/gpg"</span>
<span class="token comment"># containerd_debian_repo_repokey: 'YOURREPOKEY'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>ubuntu</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment">## Ubuntu</span>
<span class="token comment">### Docker</span>
<span class="token key atrule">docker_ubuntu_repo_base_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/ubuntu"</span>
<span class="token key atrule">docker_ubuntu_repo_gpgkey</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/ubuntu/gpg"</span>
<span class="token comment">### Containerd</span>
<span class="token key atrule">containerd_ubuntu_repo_base_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/ubuntu"</span>
<span class="token key atrule">containerd_ubuntu_repo_gpgkey</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; docker_mirrors_url &#125;&#125;/ubuntu/gpg"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>经过以上准备好配置工作之后，接下来可以开始正式部署了。在使用 ansible 进行部署的时候，个人倾向于在 kubespray 容器里进行操作，而非在本地开发机器上安装 python3 等环境。对于离线部署而言，提前构建好镜像，使用 docker 容器更为方便一些。</p>
<ul>
<li>构建镜像</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/root/kubespray git:<span class="token punctuation">(</span>master*<span class="token punctuation">)</span> <span class="token comment"># docker build -t kubespray:v2.15.1-kube-v1.20.6 .</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>运行 kubespray 容器</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/root/kubespray git:<span class="token punctuation">(</span>master*<span class="token punctuation">)</span> <span class="token comment"># docker run --rm -it --net=host -v $PWD:/kubespray kubespray:v2.15.1-kube-v1.20.6 bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>测试主机是否连接正常</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/kubespray<span class="token comment"># ansible -i cluster/inventory all -m ping</span>
kube-control-3 <span class="token operator">|</span> SUCCESS <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"ansible_facts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"discovered_interpreter_python"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/bin/python"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"ping"</span><span class="token builtin class-name">:</span> <span class="token string">"pong"</span>
<span class="token punctuation">&#125;</span>
kube-control-1 <span class="token operator">|</span> SUCCESS <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"ansible_facts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"discovered_interpreter_python"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/bin/python"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"ping"</span><span class="token builtin class-name">:</span> <span class="token string">"pong"</span>
<span class="token punctuation">&#125;</span>
kube-node-1 <span class="token operator">|</span> SUCCESS <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"ansible_facts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"discovered_interpreter_python"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/bin/python"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"ping"</span><span class="token builtin class-name">:</span> <span class="token string">"pong"</span>
<span class="token punctuation">&#125;</span>
kube-control-2 <span class="token operator">|</span> SUCCESS <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"ansible_facts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
        <span class="token string">"discovered_interpreter_python"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/bin/python"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token string">"changed"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"ping"</span><span class="token builtin class-name">:</span> <span class="token string">"pong"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>开始部署集群</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/kubespray<span class="token comment"># ansible-playbook -i deploy/inventory -e "@deploy/env.yml" cluster.yml</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>部署完成日志如下，当 failed 都为 0 时说明 tasks 都已经成功跑完了</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">PLAY RECAP ******************************************************************
kube-control-1             <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">526</span>  <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">67</span>   <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">978</span>  <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span>
kube-control-2             <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">524</span>  <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">66</span>   <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">980</span>  <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span>
kube-control-3             <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">593</span>  <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">76</span>   <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">1125</span> <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">1</span>
kube-node-1                <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">366</span>  <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">34</span>   <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">628</span>  <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span>
localhost                  <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">3</span>    <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span>

Wednesday <span class="token number">28</span> April <span class="token number">2021</span>  <span class="token number">10</span>:57:57 +0000 <span class="token punctuation">(</span><span class="token number">0</span>:00:00.115<span class="token punctuation">)</span>       <span class="token number">0</span>:15:21.190 *******
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span>
kubernetes/control-plane <span class="token builtin class-name">:</span> kubeadm <span class="token operator">|</span> Initialize first master -------------- <span class="token number">65</span>.88s
kubernetes/control-plane <span class="token builtin class-name">:</span> Joining control plane <span class="token function">node</span> to the cluster. ----- <span class="token number">50</span>.05s
kubernetes/kubeadm <span class="token builtin class-name">:</span> Join to cluster -------------------------------------- <span class="token number">31</span>.54s
download_container <span class="token operator">|</span> Download image <span class="token keyword">if</span> required --------------------------- <span class="token number">24</span>.38s
reload etcd --------------------------------------------------------------- <span class="token number">20</span>.56s
Gen_certs <span class="token operator">|</span> Write etcd member and admin certs to other etcd nodes --------- <span class="token number">19</span>.32s
Gen_certs <span class="token operator">|</span> Write <span class="token function">node</span> certs to other etcd nodes -------------------------- <span class="token number">19</span>.14s
Gen_certs <span class="token operator">|</span> Write etcd member and admin certs to other etcd nodes --------- <span class="token number">17</span>.45s
network_plugin/canal <span class="token builtin class-name">:</span> Canal <span class="token operator">|</span> Create canal <span class="token function">node</span> manifests ---------------- <span class="token number">15</span>.41s
kubernetes-apps/ansible <span class="token builtin class-name">:</span> Kubernetes Apps <span class="token operator">|</span> Lay Down CoreDNS Template ----- <span class="token number">13</span>.27s
kubernetes/control-plane <span class="token builtin class-name">:</span> Master <span class="token operator">|</span> <span class="token function">wait</span> <span class="token keyword">for</span> kube-scheduler --------------- <span class="token number">11</span>.97s
download_container <span class="token operator">|</span> Download image <span class="token keyword">if</span> required --------------------------- <span class="token number">11</span>.76s
Gen_certs <span class="token operator">|</span> Write <span class="token function">node</span> certs to other etcd nodes -------------------------- <span class="token number">10</span>.50s
kubernetes-apps/ansible <span class="token builtin class-name">:</span> Kubernetes Apps <span class="token operator">|</span> Start Resources ---------------- <span class="token number">8</span>.28s
policy_controller/calico <span class="token builtin class-name">:</span> Create calico-kube-controllers manifests -------- <span class="token number">7</span>.61s
kubernetes/control-plane <span class="token builtin class-name">:</span> <span class="token builtin class-name">set</span> kubeadm certificate key --------------------- <span class="token number">6</span>.32s
download <span class="token builtin class-name">:</span> extract_file <span class="token operator">|</span> Unpacking archive -------------------------------- <span class="token number">5</span>.51s
Configure <span class="token operator">|</span> Check <span class="token keyword">if</span> etcd cluster is healthy ------------------------------- <span class="token number">5</span>.41s
Configure <span class="token operator">|</span> Check <span class="token keyword">if</span> etcd-events cluster is healthy ------------------------ <span class="token number">5</span>.41s
kubernetes-apps/network_plugin/canal <span class="token builtin class-name">:</span> Canal <span class="token operator">|</span> Start Resources ------------- <span class="token number">4</span>.85s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>集群状态</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kube-control-1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get node -o wide</span>
NAME             STATUS   ROLES                  AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME
kube-control-1   Ready    control-plane,master   5m24s   v1.20.6   <span class="token number">192.168</span>.4.11   <span class="token operator">&lt;</span>none<span class="token operator">></span>        CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>   <span class="token number">3.10</span>.0-1160.el7.x86_64   containerd://1.4.4
kube-control-2   Ready    control-plane,master   5m40s   v1.20.6   <span class="token number">192.168</span>.4.12   <span class="token operator">&lt;</span>none<span class="token operator">></span>        CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>   <span class="token number">3.10</span>.0-1160.el7.x86_64   containerd://1.4.4
kube-control-3   Ready    control-plane,master   6m28s   v1.20.6   <span class="token number">192.168</span>.4.13   <span class="token operator">&lt;</span>none<span class="token operator">></span>        CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>   <span class="token number">3.10</span>.0-1160.el7.x86_64   containerd://1.4.4
kube-node-1      Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span>                 3m53s   v1.20.6   <span class="token number">192.168</span>.4.14   <span class="token operator">&lt;</span>none<span class="token operator">></span>        CentOS Linux <span class="token number">7</span> <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>   <span class="token number">3.10</span>.0-1160.el7.x86_64   containerd://1.4.4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>集群组件状态</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kube-control-1 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get all -n kube-system</span>
NAME                                           READY   STATUS             RESTARTS   AGE
pod/calico-kube-controllers-67d6cdb559-cwf62   <span class="token number">0</span>/1     CrashLoopBackOff   <span class="token number">5</span>          4m10s
pod/canal-node-46x2b                           <span class="token number">2</span>/2     Running            <span class="token number">0</span>          4m25s
pod/canal-node-5rkhq                           <span class="token number">2</span>/2     Running            <span class="token number">0</span>          4m25s
pod/canal-node-fcsgn                           <span class="token number">2</span>/2     Running            <span class="token number">0</span>          4m25s
pod/canal-node-nhkp8                           <span class="token number">2</span>/2     Running            <span class="token number">0</span>          4m25s
pod/coredns-5d578c6f84-5nnp8                   <span class="token number">1</span>/1     Running            <span class="token number">0</span>          3m33s
pod/coredns-5d578c6f84-w2kvf                   <span class="token number">1</span>/1     Running            <span class="token number">0</span>          3m39s
pod/dns-autoscaler-6b675c8995-vp282            <span class="token number">1</span>/1     Running            <span class="token number">0</span>          3m34s
pod/kube-apiserver-kube-control-1              <span class="token number">1</span>/1     Running            <span class="token number">0</span>          6m51s
pod/kube-apiserver-kube-control-2              <span class="token number">1</span>/1     Running            <span class="token number">0</span>          7m7s
pod/kube-apiserver-kube-control-3              <span class="token number">1</span>/1     Running            <span class="token number">0</span>          7m41s
pod/kube-controller-manager-kube-control-1     <span class="token number">1</span>/1     Running            <span class="token number">0</span>          6m52s
pod/kube-controller-manager-kube-control-2     <span class="token number">1</span>/1     Running            <span class="token number">0</span>          7m7s
pod/kube-controller-manager-kube-control-3     <span class="token number">1</span>/1     Running            <span class="token number">0</span>          7m41s
pod/kube-proxy-5dfx8                           <span class="token number">1</span>/1     Running            <span class="token number">0</span>          5m17s
pod/kube-proxy-fvrqk                           <span class="token number">1</span>/1     Running            <span class="token number">0</span>          5m17s
pod/kube-proxy-jd84p                           <span class="token number">1</span>/1     Running            <span class="token number">0</span>          5m17s
pod/kube-proxy-l2mjk                           <span class="token number">1</span>/1     Running            <span class="token number">0</span>          5m17s
pod/kube-scheduler-kube-control-1              <span class="token number">1</span>/1     Running            <span class="token number">0</span>          6m51s
pod/kube-scheduler-kube-control-2              <span class="token number">1</span>/1     Running            <span class="token number">0</span>          7m7s
pod/kube-scheduler-kube-control-3              <span class="token number">1</span>/1     Running            <span class="token number">0</span>          7m41s
pod/nginx-proxy-kube-node-1                    <span class="token number">1</span>/1     Running            <span class="token number">0</span>          5m20s
pod/nodelocaldns-77kq9                         <span class="token number">1</span>/1     Running            <span class="token number">0</span>          3m32s
pod/nodelocaldns-fn5pd                         <span class="token number">1</span>/1     Running            <span class="token number">0</span>          3m32s
pod/nodelocaldns-lfjzb                         <span class="token number">1</span>/1     Running            <span class="token number">0</span>          3m32s
pod/nodelocaldns-xnc6n                         <span class="token number">1</span>/1     Running            <span class="token number">0</span>          3m32s

NAME              TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                  AGE
service/coredns   ClusterIP   <span class="token number">10.233</span>.0.3   <span class="token operator">&lt;</span>none<span class="token operator">></span>        <span class="token number">53</span>/UDP,53/TCP,9153/TCP   3m38s

NAME                          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
daemonset.apps/canal-node     <span class="token number">4</span>         <span class="token number">4</span>         <span class="token number">4</span>       <span class="token number">4</span>            <span class="token number">4</span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>                   4m25s
daemonset.apps/kube-proxy     <span class="token number">4</span>         <span class="token number">4</span>         <span class="token number">4</span>       <span class="token number">4</span>            <span class="token number">4</span>           kubernetes.io/os<span class="token operator">=</span>linux   7m53s
daemonset.apps/nodelocaldns   <span class="token number">4</span>         <span class="token number">4</span>         <span class="token number">4</span>       <span class="token number">4</span>            <span class="token number">4</span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>                   3m32s

NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/calico-kube-controllers   <span class="token number">0</span>/1     <span class="token number">1</span>            <span class="token number">0</span>           4m12s
deployment.apps/coredns                   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           3m39s
deployment.apps/dns-autoscaler            <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           3m34s

NAME                                                 DESIRED   CURRENT   READY   AGE
replicaset.apps/calico-kube-controllers-67d6cdb559   <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">0</span>       4m12s
replicaset.apps/coredns-5d578c6f84                   <span class="token number">2</span>         <span class="token number">2</span>         <span class="token number">2</span>       3m39s
replicaset.apps/dns-autoscaler-6b675c8995            <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">1</span>       3m34s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="吐槽"><a href="#吐槽" class="headerlink" title="吐槽"></a>吐槽</h2><p>在国内这种十分糟糕的网络环境下，对于普通的开发者或者学生来讲，部署一个 kubernetes 集群是十分痛苦的事情，这也进一步阻碍了这门技术的普及和使用。也想起了几年前在一次 docker 技术分享时的 QA 问答：</p>
<blockquote>
<p>Q：如何摆脱网络的依赖来创建个 Docker 的 image 呢，我觉得这个是 Docker 用户自己的基本权利？</p>
</blockquote>
<p><strong>A：这个基本权利我觉得还是要问 GFW ，国外的开发人员是非常难理解有些他们认为跟水电一样普及的基础设施在某些地方还是很困难的。</strong></p>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
              <a href="/tags/k8s/" rel="tag"># k8s</a>
              <a href="/tags/kubespray/" rel="tag"># kubespray</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/select-registry-images.html" rel="prev" title="什么？发布流水线中镜像“同步”速度又提升了 15 倍 ！">
                  <i class="fa fa-chevron-left"></i> 什么？发布流水线中镜像“同步”速度又提升了 15 倍 ！
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/kubespray-tips.html" rel="next" title="kubespray 部署常见问题和优化汇总">
                  kubespray 部署常见问题和优化汇总 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">25:30</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
