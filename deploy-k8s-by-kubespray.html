<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.k8s.li').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>
  <meta name="description" content="å…¬å¸ PaaS å¹³å°åº•å±‚çš„ kubernetes é›†ç¾¤éƒ¨ç½²é‡‡ç”¨çš„å¼€æºçš„ kubesprayï¼Œæ­£å¥½æˆ‘åœ¨å‚ä¸ kubespray äºŒå¼€å·¥ä½œã€‚åœ¨è¿™æ®µæ—¶ä¸»è¦å®Œæˆäº† kubespray è‡ªåŠ¨åŒ–æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ã€ç§æœ‰åŒ–éƒ¨ç½²ã€å¢åŠ è‡ªç ” CNI éƒ¨ç½²ã€ä»¥åŠä¸€äº› bugfix ç­‰ã€‚æœ€è¿‘æŠ½ç©ºæ•´ç†å¹¶æ€»ç»“ä¸€ä¸‹ä½¿ç”¨ kubespray åœ¨æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤è¸©çš„ä¸€äº›å‘ã€‚ å‡†å¤‡åŠé€€ä¸‰è¿ğŸ˜‚ï¼š  éœ€è¦ä¸€ä¸ª">
<meta property="og:type" content="article">
<meta property="og:title" content="ä½¿ç”¨ Kubespray æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤">
<meta property="og:url" content="https://blog.k8s.li/deploy-k8s-by-kubespray.html">
<meta property="og:site_name" content="æœ¨å­">
<meta property="og:description" content="å…¬å¸ PaaS å¹³å°åº•å±‚çš„ kubernetes é›†ç¾¤éƒ¨ç½²é‡‡ç”¨çš„å¼€æºçš„ kubesprayï¼Œæ­£å¥½æˆ‘åœ¨å‚ä¸ kubespray äºŒå¼€å·¥ä½œã€‚åœ¨è¿™æ®µæ—¶ä¸»è¦å®Œæˆäº† kubespray è‡ªåŠ¨åŒ–æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ã€ç§æœ‰åŒ–éƒ¨ç½²ã€å¢åŠ è‡ªç ” CNI éƒ¨ç½²ã€ä»¥åŠä¸€äº› bugfix ç­‰ã€‚æœ€è¿‘æŠ½ç©ºæ•´ç†å¹¶æ€»ç»“ä¸€ä¸‹ä½¿ç”¨ kubespray åœ¨æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤è¸©çš„ä¸€äº›å‘ã€‚ å‡†å¤‡åŠé€€ä¸‰è¿ğŸ˜‚ï¼š  éœ€è¦ä¸€ä¸ª">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-04-28T16:00:00.000Z">
<meta property="article:modified_time" content="2021-04-28T16:00:00.000Z">
<meta property="article:author" content="æœ¨å­">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="kubespray">
<meta name="twitter:card" content="summary">
<link rel="canonical" href="https://blog.k8s.li/deploy-k8s-by-kubespray.html">
<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>
  <title>ä½¿ç”¨ Kubespray æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤ | æœ¨å­</title>
  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }
  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>
<link rel="alternate" href="/atom.xml" title="æœ¨å­" type="application/atom+xml">
</head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">
    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æœ¨å­</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>
<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">
    <a href="/" rel="section"><i class="fa fa-fw fa-desktop"></i>Home</a>
  </li>
        <li class="menu-item menu-item-books">
    <a href="/booklist.html" rel="section"><i class="fa fa-fw fa-book"></i>Books</a>
  </li>
        <li class="menu-item menu-item-kindle">
    <a href="https://kindle.502.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
  </li>
        <li class="menu-item menu-item-friend">
    <a href="/link/" rel="section"><i class="fa fa-fw fa-link"></i>Friend</a>
  </li>
        <li class="menu-item menu-item-about">
    <a href="/about.html" rel="section"><i class="fa fa-fw fa-user-circle-o"></i>About</a>
  </li>
  </ul>
</nav>
</div>
    </header>
  <div class="reading-progress-bar"></div>
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
  <div class="posts-expand">
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/deploy-k8s-by-kubespray.html">
    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog.k8s.li/avatar.png">
      <meta itemprop="name" content="æœ¨å­">
      <meta itemprop="description" content="">
    </span>
    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æœ¨å­">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          ä½¿ç”¨ Kubespray æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤
        </h2>
        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-04-29 2021-04-29T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2021-04-29T00:00:00+08:00">2021-04-29</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>
            </span>
  <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    <a title="disqus" href="/deploy-k8s-by-kubespray.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="deploy-k8s-by-kubespray.html" itemprop="commentCount"></span>
    </a>
  </span>
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>24k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>39 åˆ†é’Ÿ</span>
            </span>
        </div>
      </header>
    <div class="post-body" itemprop="articleBody">
        <p>å…¬å¸ PaaS å¹³å°åº•å±‚çš„ kubernetes é›†ç¾¤éƒ¨ç½²é‡‡ç”¨çš„å¼€æºçš„ kubesprayï¼Œæ­£å¥½æˆ‘åœ¨å‚ä¸ kubespray äºŒå¼€å·¥ä½œã€‚åœ¨è¿™æ®µæ—¶ä¸»è¦å®Œæˆäº† kubespray è‡ªåŠ¨åŒ–æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ã€ç§æœ‰åŒ–éƒ¨ç½²ã€å¢åŠ è‡ªç ” CNI éƒ¨ç½²ã€ä»¥åŠä¸€äº› bugfix ç­‰ã€‚æœ€è¿‘æŠ½ç©ºæ•´ç†å¹¶æ€»ç»“ä¸€ä¸‹ä½¿ç”¨ kubespray åœ¨æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤è¸©çš„ä¸€äº›å‘ã€‚</p>
<h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><p>åŠé€€ä¸‰è¿ğŸ˜‚ï¼š</p>
<ul>
<li>éœ€è¦ä¸€ä¸ªéƒ¨ç½²é•œåƒä»“åº“å’Œ nginx</li>
<li>éœ€è¦ä¸€ä¸ªåŸŸåï¼Œæœ€å¥½å·²ç»è®¾ç½®å¥½ DNS è§£æå’Œ SSL è¯ä¹¦</li>
<li>é›†ç¾¤èŠ‚ç‚¹éœ€è¦è‡³å°‘ä¸¤å°æœºå™¨ï¼Œå¹¶ä¸”å¯ä»¥è®¿é—®å¤–ç½‘</li>
</ul>
<p>è™½ç„¶æ‰‹å¤´é‡Œæœ‰ä¸€å¤§æ‰¹å¼€å‘æœºå™¨ï¼Œä½†ç”±äºæˆ‘çš„åŸŸå <code>k8s.li</code> æ¯”è¾ƒç‰¹æ®Šï¼Œå›½å†…å¾ˆéš¾è¿›è¡Œå¤‡æ¡ˆï¼ˆä¹Ÿä¸æƒ³å¤‡æ¡ˆï¼‰ï¼Œæ‰€ä»¥æ— æ³•å°† DNS è§£æåˆ°è¿™äº›å›½å†…çš„æœåŠ¡å™¨ä¸Šã€‚å› æ­¤æˆ‘æ‰“ç®—å°†åŸŸåè§£æåˆ°ä¸€å°å›½å¤–çš„æœåŠ¡å™¨ä¸Šï¼Œç„¶åå†ä½¿ç”¨ nginx rewrite é‡å†™å°†è¯·æ±‚è½¬å‘åˆ°é˜¿é‡Œäº‘çš„ OSS ï¼›å¦å¤– docker registry çš„åç«¯å­˜å‚¨ä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨é˜¿é‡Œäº‘ OSSï¼Œè¿™æ ·å®¢æˆ·ç«¯åœ¨æ‹‰å–é•œåƒçš„æ—¶å€™ï¼Œåªä¼šé€šè¿‡æˆ‘çš„åŸŸåè·å–é•œåƒçš„ manifest æ–‡ä»¶ï¼Œé•œåƒçš„ blobs æ•°æ®å°†ä¼šè½¬å‘åˆ°é˜¿é‡Œäº‘ OSSã€‚åœ¨é›†ç¾¤éƒ¨ç½²çš„æ—¶å€™ï¼Œä¸‹è½½æ–‡ä»¶å’Œé•œåƒæœ€ä¸»è¦çš„æµé‡éƒ½ä¼šé€šè¿‡é˜¿é‡Œäº‘ OSSï¼Œè¿™æ ·å¯ä»¥èŠ‚çœé›†ç¾¤éƒ¨ç½²è€—æ—¶ï¼Œæé«˜éƒ¨ç½²æ•ˆç‡ï¼ŒåŒæ—¶åˆèƒ½å‰©ä¸‹ä¸€ç¬”æœåŠ¡å™¨çš„æµé‡è´¹ç”¨ã€‚</p>
<h3 id="åŸŸå-SSL-è¯ä¹¦åˆ¶ä½œ"><a href="#åŸŸå-SSL-è¯ä¹¦åˆ¶ä½œ" class="headerlink" title="åŸŸå SSL è¯ä¹¦åˆ¶ä½œ"></a>åŸŸå SSL è¯ä¹¦åˆ¶ä½œ</h3><p>åŸŸå SSL è¯ä¹¦ä¸»è¦æ˜¯ç»™é•œåƒä»“åº“ä½¿ç”¨çš„ï¼Œå‡å¦‚è¯ä¹¦æ˜¯è‡ªç­¾çš„æˆ–è€…é•œåƒä»“åº“ä½¿ç”¨çš„æ˜¯ HTTP åè®®ï¼Œè¿™æ ·ä¼šå¯¼è‡´ docker æˆ–è€… containerd æ— æ³•æ‹‰å–é•œåƒï¼Œéœ€è¦ä¸ºé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹é…ç½® <code>insecure-registries</code>  è¿™ä¸ªå‚æ•°ã€‚æèµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œå› æ­¤è¿˜æ˜¯æ¨èç»™é•œåƒä»“åº“åŠ ä¸€ä¸ªéè‡ªç­¾çš„ SSL è¯ä¹¦ï¼Œè¿™æ ·èƒ½å‡å°‘ä¸€äº›ä¸å¿…è¦çš„éº»çƒ¦ã€‚å¦‚æœæœ‰ç°æˆçš„é•œåƒä»“åº“å¹¶ä¸”é…ç½®å¥½äº† SSL è¯ä¹¦ï¼Œå¯ä»¥ç•¥è¿‡æ­¤æ­¥ã€‚</p>
<p>åˆ¶ä½œåŸŸåè¯ä¹¦çš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œä¸ªäººæ¯”è¾ƒæ¨èä½¿ç”¨ acme.sh ã€‚å®ƒå®ç°äº† acme åè®®æ”¯æŒçš„æ‰€æœ‰éªŒè¯åè®®ï¼Œå¹¶ä¸”æ”¯æŒæ”¯æŒæ•°åç§åŸŸåè§£æå•†ã€‚ç”±äºæˆ‘çš„åŸŸåæ˜¯æ‰˜ç®¡åœ¨ cloudflare ä¸Šçš„ï¼Œä½¿ç”¨ acme.sh æ¥ç­¾å‘è¯ä¹¦ç‰¹åˆ«æ–¹ä¾¿ï¼Œåªéœ€è¦é…ç½®ä¸¤ä¸ªå‚æ•°å³å¯ã€‚ä¸‹é¢å°±ç»™ k8s.li è¿™ä¸ªåŸŸåç­¾å‘ä¸€ä¸ªæ³›åŸŸåè¯ä¹¦ã€‚</p>
<ul>
<li>å®‰è£…  acme.sh</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://get.acme.sh | sh</span><br><span class="line">~/.acme.sh/acme.sh --<span class="built_in">help</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ç­¾å‘è¯ä¹¦</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CF_Email=<span class="string">"muzi502.li@gmail.com"</span> <span class="comment"># cloudflare è´¦æˆ·çš„é‚®ç®±</span></span><br><span class="line"><span class="built_in">export</span> CF_Key=<span class="string">"xxxxxx"</span> <span class="comment"># "cloudflareä¸­æŸ¥çœ‹ä½ çš„key"</span></span><br><span class="line"></span><br><span class="line">~/.acme.sh/acme.sh --issue --dns dns_cf -d k8s.li -d *.k8s.li</span><br><span class="line"></span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] Cert success.</span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] Your cert is <span class="keyword">in</span>  /root/.acme.sh/k8s.li/k8s.li.cer</span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] Your cert key is <span class="keyword">in</span>  /root/.acme.sh/k8s.li/k8s.li.key</span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] The intermediate CA cert is <span class="keyword">in</span>  /root/.acme.sh/k8s.li/ca.cer</span><br><span class="line">[Tue Apr 27 07:32:52 UTC 2021] And the full chain certs is there:  /root/.acme.sh/k8s.li/fullchain.cer</span><br></pre></td></tr></table></figure>
<blockquote>
<p>å‰é¢è¯ä¹¦ç”Ÿæˆä»¥åï¼Œæ¥ä¸‹æ¥éœ€è¦æŠŠè¯ä¹¦ copy åˆ°çœŸæ­£éœ€è¦ç”¨å®ƒçš„åœ°æ–¹ã€‚</p>
<p>æ³¨æ„ï¼Œé»˜è®¤ç”Ÿæˆçš„è¯ä¹¦éƒ½æ”¾åœ¨å®‰è£…ç›®å½•ä¸‹<code>~/.acme.sh/</code>ï¼Œ è¯·ä¸è¦ç›´æ¥ä½¿ç”¨æ­¤ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œä¾‹å¦‚: ä¸è¦ç›´æ¥è®©<code>nginx/apache</code>çš„é…ç½®æ–‡ä»¶ä½¿ç”¨è¿™ä¸‹é¢çš„æ–‡ä»¶ã€‚è¿™é‡Œé¢çš„æ–‡ä»¶éƒ½æ˜¯å†…éƒ¨ä½¿ç”¨ï¼Œè€Œä¸”ç›®å½•ç»“æ„å¯èƒ½ä¼šå˜åŒ–ã€‚</p>
<p>æ­£ç¡®çš„ä½¿ç”¨æ–¹æ³•æ˜¯ä½¿ç”¨<code>--installcert</code> å‘½ä»¤ï¼Œå¹¶æŒ‡å®šç›®æ ‡ä½ç½®ï¼Œç„¶åè¯ä¹¦æ–‡ä»¶ä¼šè¢« copy åˆ°ç›¸åº”çš„ä½ç½®</p>
</blockquote>
<ul>
<li>å®‰è£…è¯ä¹¦</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --install-cert -d k8s.li \</span><br><span class="line">--cert-file      /etc/nginx/ssl/k8s.li.cer  \</span><br><span class="line">--key-file       /etc/nginx/ssl/k8s.li.key  \</span><br><span class="line">--fullchain-file /etc/nginx/ssl/fullchain.cer</span><br></pre></td></tr></table></figure>
<h3 id="æ­å»ºé•œåƒä»“åº“"><a href="#æ­å»ºé•œåƒä»“åº“" class="headerlink" title="æ­å»ºé•œåƒä»“åº“"></a>æ­å»ºé•œåƒä»“åº“</h3><ul>
<li>config.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">0.1</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">registry</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">blobdescriptor:</span> <span class="string">inmemory</span></span><br><span class="line">  <span class="attr">oss:</span></span><br><span class="line">    <span class="attr">accesskeyid:</span> <span class="string">xxxx</span> <span class="comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeyid</span></span><br><span class="line">    <span class="attr">accesskeysecret:</span> <span class="string">xxxx</span> <span class="comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeysecret</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">oss-cn-beijing</span> <span class="comment"># é…ç½® OSS bucket çš„åŒºåŸŸï¼Œæ¯”å¦‚ oss-cn-beijing</span></span><br><span class="line">    <span class="attr">internal:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">bucket:</span> <span class="string">fileserver</span> <span class="comment"># é…ç½®å­˜å‚¨ bucket çš„åç§°</span></span><br><span class="line">    <span class="attr">rootdirectory:</span> <span class="string">/kubespray/registry</span> <span class="comment"># é…ç½®è·¯å¾„</span></span><br><span class="line">  <span class="attr">delete:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">addr:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:5000</span></span><br><span class="line">  <span class="attr">headers:</span></span><br><span class="line">    <span class="attr">X-Content-Type-Options:</span> <span class="string">[nosniff]</span></span><br><span class="line"><span class="attr">health:</span></span><br><span class="line">  <span class="attr">storagedriver:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
<ul>
<li>docker-compose</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">hub-registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2.7.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">hub-registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.yml:/etc/docker/registry/config.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5000:5000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>nginx.conf</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  hub.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/fullchain.cer;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/k8s.li.key;</span><br><span class="line">    <span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">4096m</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   http://localhost:5000;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ–‡ä»¶æœåŠ¡å™¨"><a href="#æ–‡ä»¶æœåŠ¡å™¨" class="headerlink" title="æ–‡ä»¶æœåŠ¡å™¨"></a>æ–‡ä»¶æœåŠ¡å™¨</h3><p>æ–‡ä»¶æœåŠ¡å™¨ç”¨äºå­˜æ”¾ä¸€äº› kubeadmã€kubectlã€kubelet ç­‰äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œkubespray é»˜è®¤çš„ä¸‹è½½åœ°å€åœ¨å›½å†…è®¿é—®ç‰¹åˆ«æ…¢ï¼Œå› æ­¤éœ€è¦æ­å»ºä¸€ä¸ª http/https æœåŠ¡å™¨ï¼Œç”¨äºç»™é›†ç¾¤éƒ¨ç½²ä¸‹è½½è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨ã€‚</p>
<ul>
<li>nginx.conf</li>
</ul>
<p>éœ€è¦æ³¨æ„ï¼Œè¿™é‡Œçš„ nginx é…ç½®ä½¿ç”¨çš„æ˜¯ rewrite è€Œä¸æ˜¯ proxy_passï¼Œè¿™æ ·å®¢æˆ·ç«¯åœ¨æƒ³æˆ‘çš„æœåŠ¡å™¨è¯·æ±‚æ–‡ä»¶æ—¶ï¼Œä¼šé‡å†™å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè®©å®¢æˆ·ç«¯å»è¯·æ±‚é˜¿é‡Œäº‘ OSS çš„åœ°å€ã€‚</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span>;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>   dl.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/fullchain.cer;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/k8s.li.key;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> https://fileserver.oss-cn-beijing.aliyuncs.com/kubespray/files/<span class="variable">$1</span>;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> Content-Disposition;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-request-id;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-object-type;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-hash-crc64ecma;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-storage-class;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-force-download;</span><br><span class="line">        <span class="attribute">proxy_hide_header</span> x-oss-server-time;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç¼–è¯‘å®‰è£…-skopeo"><a href="#ç¼–è¯‘å®‰è£…-skopeo" class="headerlink" title="ç¼–è¯‘å®‰è£… skopeo"></a>ç¼–è¯‘å®‰è£… skopeo</h3><p>å®‰è£… skopeo ç”¨æ¥åŒæ­¥ä¸€äº›ä½¿ç”¨çš„é•œåƒåˆ°ç§æœ‰é•œåƒä»“åº“ï¼Œæ€§èƒ½ä¸Šæ¯” docker å¿«å¾ˆå¤šï¼Œå¼ºçƒˆæ¨èã€‚skopeo çš„å®‰è£…æ–¹å¼å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£ <a href="https://github.com/containers/skopeo/blob/master/install.md" target="_blank" rel="noopener">Installing from packages</a> ã€‚ä¸è¿‡ä¸ªäººè¿˜æ˜¯ä½¿ç”¨ go buid ç¼–è¯‘ä¸€ä¸ªé™æ€é“¾æ¥çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¿™æ ·åœ¨ Linux å‘è¡Œç‰ˆéƒ½å¯ä»¥ä½¿ç”¨ã€‚ä¸ç„¶åœ¨ Debian ä¸Šç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶æ— æ³•æ‹¿åˆ° CentOS ä¸Šä½¿ç”¨ï¼Œå› ä¸ºäºŒè€…ä½¿ç”¨çš„åŠ¨æ€é“¾æ¥åº“ä¸ä¸€æ ·ï¼</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/skopeo git:(master*) <span class="comment"># git clone https://github.com/containers/skopeo &amp;&amp; cd skopeo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ¬åœ°å¼€å‘æœºå™¨å·²ç»å®‰è£…å¹¶é…ç½®å¥½äº† golang ç¼–è¯‘ç¯å¢ƒ</span></span><br><span class="line">root@debian:/root/skopeo git:(master*) <span class="comment"># CGO_ENABLE=0 GO111MODULE=on go build -mod=vendor "-buildmode=pie" -ldflags '-extldflags "-static"' -gcflags "" -tags "exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp" -o bin/skopeo ./cmd/skopeo</span></span><br><span class="line"></span><br><span class="line">root@debian:/root/skopeo git:(master*) <span class="comment"># ldd bin/skopeo</span></span><br><span class="line">not a dynamic executable</span><br></pre></td></tr></table></figure>
<h3 id="è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶"></a>è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶</h3><p>kubespray éƒ¨ç½²çš„æ—¶å€™éœ€è¦åˆ° github.com æˆ– storage.googleapis.com ä¸‹è½½ä¸€äº›äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¿™äº›åœ°å€åœ¨å›½å†…éƒ½éƒ½è¢«é˜»æ–­äº†ï¼Œå› æ­¤éœ€è¦å°†éƒ¨ç½²æ—¶ä¾èµ–çš„æ–‡ä»¶ä¸Šä¼ åˆ°è‡ªå·±çš„æ–‡ä»¶æœåŠ¡å™¨ä¸Šã€‚è‡ªå·±å†™äº†ä¸ªè„šæœ¬ç”¨äºè·å– kubespray éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåœ¨ kubespray repo çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œ,ä¸‹è½½çš„æ–‡ä»¶é»˜è®¤ä¼šå­˜æ”¾åœ¨ <code>temp/files</code> ç›®å½•ä¸‹ã€‚ä¸‹è½½å®Œæˆä¹‹åå°†è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•ä¸Šä¼ åˆ°è‡ªå·±çš„æ–‡ä»¶æœåŠ¡å™¨ä¸Šã€‚åé¢é…ç½®ä¸€äº›å‚æ•°åœ¨è¿™ä¸ªåœ°å€çš„å‚æ•°å‰é¢åŠ ä¸Šè‡ªå·±æ–‡ä»¶æœåŠ¡å™¨çš„ URL å³å¯ã€‚</p>
<ul>
<li>é¦–å…ˆ clone repo åˆ°æœ¬åœ°</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root<span class="comment"># git clone https://github.com/kubernetes-sigs/kubespray &amp;&amp; cd kubespray</span></span><br></pre></td></tr></table></figure>
<ul>
<li>å°†è¯¥è„šæœ¬ <code>generate_list.sh</code> ä¿å­˜åˆ° repo æ ¹ç›®å½•ä¸‹ï¼Œå¹¶æ‰§è¡Œè¯¥è„šä¸‹è½½éœ€è¦çš„æ–‡ä»¶ã€‚</li>
</ul>
<blockquote>
<p>ps: ç”¨ shell è„šæœ¬å»å¤„ç† Jinja2 çš„ yamlï¼Œ å†™ sed å†™å¾—æˆ‘æƒ³åğŸ¤®</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line"></span><br><span class="line">CURRENT_DIR=$(<span class="built_in">cd</span> $(dirname <span class="variable">$0</span>); <span class="built_in">pwd</span>)</span><br><span class="line">TEMP_DIR=<span class="string">"<span class="variable">$&#123;CURRENT_DIR&#125;</span>/temp"</span></span><br><span class="line">REPO_ROOT_DIR=<span class="string">"<span class="variable">$&#123;CURRENT_DIR&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">: <span class="variable">$&#123;IMAGE_ARCH:="amd64"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;ANSIBLE_SYSTEM:="linux"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;ANSIBLE_ARCHITECTURE:="x86_64"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;DOWNLOAD_YML:="roles/download/defaults/main.yml"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;KUBE_VERSION_YAML:="roles/kubespray-defaults/defaults/main.yaml"&#125;</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$&#123;TEMP_DIR&#125;</span></span><br><span class="line"><span class="function"><span class="title">generate_versions</span></span>() &#123;</span><br><span class="line">    <span class="comment"># ARCH used in convert &#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125; to &#123;&#123;arch&#125;&#125;</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;IMAGE_ARCH&#125;</span>"</span> != <span class="string">"amd64"</span> ]; <span class="keyword">then</span> ARCH=<span class="string">"<span class="variable">$&#123;IMAGE_ARCH&#125;</span>"</span>; <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    cat &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh &lt;&lt; EOF</span><br><span class="line">arch=<span class="variable">$&#123;ARCH&#125;</span></span><br><span class="line">image_arch=<span class="variable">$&#123;IMAGE_ARCH&#125;</span></span><br><span class="line">ansible_system=<span class="variable">$&#123;ANSIBLE_SYSTEM&#125;</span></span><br><span class="line">ansible_architecture=<span class="variable">$&#123;ANSIBLE_ARCHITECTURE&#125;</span></span><br><span class="line">EOF</span><br><span class="line">    grep <span class="string">'kube_version:'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;KUBE_VERSION_YAML&#125;</span> \</span><br><span class="line">    | sed <span class="string">'s/: /=/g'</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh</span><br><span class="line">    grep <span class="string">'_version:'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">    | sed <span class="string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> | tr -d <span class="string">' '</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh</span><br><span class="line">    sed -i <span class="string">'s/kube_major_version=.*/kube_major_version=$&#123;kube_version%.*&#125;/g'</span> <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh</span><br><span class="line">    sed -i <span class="string">'s/crictl_version=.*/crictl_version=$&#123;kube_version%.*&#125;.0/g'</span> <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">generate_files_list</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"source <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh"</span> &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.sh</span><br><span class="line">    grep <span class="string">'download_url:'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">    | sed <span class="string">'s/: /=/g;s/ //g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g;s/|lower//g;s/^.*_url=/echo /g'</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.sh</span><br><span class="line">    bash <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.sh | sort &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.list</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">generate_images_list</span></span>() &#123;</span><br><span class="line">    KUBE_IMAGES=<span class="string">"kube-apiserver kube-controller-manager kube-scheduler kube-proxy"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"source <span class="variable">$&#123;TEMP_DIR&#125;</span>/version.sh"</span> &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh</span><br><span class="line">    grep -E <span class="string">'_repo:|_tag:'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">    | sed <span class="string">"s#&#123;%- if image_arch != 'amd64' -%&#125;-&#123;&#123; image_arch &#125;&#125;&#123;%- endif -%&#125;#&#123;&#123;arch&#125;&#125;#g"</span> \</span><br><span class="line">    | sed <span class="string">'s/: /=/g;s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> | tr -d <span class="string">' '</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh</span><br><span class="line">    sed -n <span class="string">'/^downloads:/,/download_defaults:/p'</span> <span class="variable">$&#123;REPO_ROOT_DIR&#125;</span>/<span class="variable">$&#123;DOWNLOAD_YML&#125;</span> \</span><br><span class="line">    | sed -n <span class="string">"s/repo: //p;s/tag: //p"</span> | tr -d <span class="string">' '</span> | sed <span class="string">'s/&#123;&#123;/$&#123;/g;s/&#125;&#125;/&#125;/g'</span> \</span><br><span class="line">    | sed <span class="string">'N;s#\n# #g'</span> | tr <span class="string">' '</span> <span class="string">':'</span> | sed <span class="string">'s/^/echo /g'</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;KUBE_IMAGES&#125;</span>"</span> | tr <span class="string">' '</span> <span class="string">'\n'</span> | xargs -L1 -I &#123;&#125; \</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'echo $&#123;kube_image_repo&#125;/&#123;&#125;:$&#123;kube_version&#125;'</span> &gt;&gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh</span><br><span class="line">    bash <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.sh | sort &gt; <span class="variable">$&#123;TEMP_DIR&#125;</span>/images.list</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">generate_versions</span><br><span class="line">generate_files_list</span><br><span class="line">generate_images_list</span><br><span class="line">wget -x -P <span class="variable">$&#123;TEMP_DIR&#125;</span>/files -i <span class="variable">$&#123;TEMP_DIR&#125;</span>/files.list</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆä¸‹è½½çš„ç»“æœå¦‚ä¸‹ï¼ŒåŸºæœ¬ä¸Šä¿æŒäº†åŸæœ‰çš„ URL è·¯å¾„ï¼Œä¹Ÿæ–¹ä¾¿åç»­çš„æ›´æ–°å’Œç‰ˆæœ¬è¿­ä»£ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">temp/files</span><br><span class="line">â”œâ”€â”€ get.helm.sh</span><br><span class="line">â”‚Â Â  â””â”€â”€ helm-v3.5.4-linux-amd64.tar.gz</span><br><span class="line">â”œâ”€â”€ github.com</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containerd</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ nerdctl</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.8.0</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ nerdctl-0.8.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containernetworking</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ plugins</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.9.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containers</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ crun</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ 0.19</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ crun-0.19-linux-amd64</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ coreos</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ etcd</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v3.4.13</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kata-containers</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ runtime</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ 1.12.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ kata-static-1.12.1-x86_64.tar.xz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kubernetes-sigs</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ cri-tools</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v1.20.0</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ crictl-v1.20.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â””â”€â”€ projectcalico</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ calico</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ archive</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ v3.17.3.tar.gz</span><br><span class="line">â”‚Â Â      â””â”€â”€ calicoctl</span><br><span class="line">â”‚Â Â          â””â”€â”€ releases</span><br><span class="line">â”‚Â Â              â””â”€â”€ download</span><br><span class="line">â”‚Â Â                  â””â”€â”€ v3.17.3</span><br><span class="line">â”‚Â Â                      â””â”€â”€ calicoctl-linux-amd64</span><br><span class="line">â””â”€â”€ storage.googleapis.com</span><br><span class="line">    â””â”€â”€ kubernetes-release</span><br><span class="line">        â””â”€â”€ release</span><br><span class="line">            â””â”€â”€ v1.20.6</span><br><span class="line">                â””â”€â”€ bin</span><br><span class="line">                    â””â”€â”€ linux</span><br><span class="line">                        â””â”€â”€ amd64</span><br><span class="line">                            â”œâ”€â”€ kubeadm</span><br><span class="line">                            â”œâ”€â”€ kubectl</span><br><span class="line">                            â””â”€â”€ kubelet</span><br></pre></td></tr></table></figure>
<h3 id="è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ"><a href="#è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ" class="headerlink" title="è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ"></a>è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ</h3><p>å¯¹äºç¦»çº¿éƒ¨ç½²ï¼Œkubespray æ”¯æŒçš„å¹¶ä¸æ˜¯å¾ˆå‹å¥½ã€‚æ¯”å¦‚è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒåˆ—è¡¨ï¼Œç›®å‰çš„æ–¹æ¡ˆæ˜¯éœ€è¦å…ˆéƒ¨ç½²ä¸€ä¸ªé›†ç¾¤ï¼Œç„¶åé€šè¿‡ kubectl get ä¸€äº›èµ„æºæ¥è·å– pod ä½¿ç”¨åˆ°çš„é•œåƒã€‚ä¸ªäººè§‰å¾—è¿™ä¸ªæ–¹å¼å¯ä»¥ä¿®æ”¹ä¸€ä¸‹ï¼Œæ¯”å¦‚é€šè¿‡ kubespray æºç æ¥ç”Ÿæˆä¸€ä¸ªé•œåƒåˆ—è¡¨ã€‚ä¸‹é¢åªæ˜¯ç®€å•ç”Ÿæˆä¸€ä¸ªé•œåƒåˆ—è¡¨ï¼Œå†…å®¹å¦‚ä¸‹</p>
<ul>
<li>images.list</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker.io/nginx:1.19.0</span><br><span class="line">docker.io/calico/cni:v3.17.3</span><br><span class="line">docker.io/calico/node:v3.17.3</span><br><span class="line">docker.io/calico/kube-controllers:v3.17.3</span><br><span class="line">quay.io/coreos/flannel:v0.13.0</span><br><span class="line">quay.io/coreos/flannel:v0.13.0-amd64</span><br><span class="line">k8s.gcr.io/pause:3.2</span><br><span class="line">k8s.gcr.io/coredns:1.7.0</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.20.6</span><br><span class="line">k8s.gcr.io/dns/k8s-dns-node-cache:1.17.1</span><br><span class="line">k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64:1.8.3</span><br></pre></td></tr></table></figure>
<p>ç”±äº master åˆ†æ”¯çš„ä»£ç ä¸€ç›´åœ¨æ›´æ–°ï¼Œå½“å‰çš„ master åˆ†æ”¯çš„ç‰ˆæœ¬å¯èƒ½å’Œè¿™é‡Œçš„ä¸å¤ªä¸€æ ·ï¼Œéœ€è¦ä¿®æ”¹ä¸ºè‡ªå·±éœ€è¦çš„ç‰ˆæœ¬ã€‚</p>
<ul>
<li>æ ¹æ®ä¸Šé¢çš„é•œåƒåˆ—è¡¨ï¼Œä½¿ç”¨ skopeo å°†é•œåƒåŒæ­¥åˆ°è‡ªå·±çš„é•œåƒä»“åº“ä¸­ï¼Œå¦‚æˆ‘çš„ <code>hub.k8s.li</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> $(cat images.list); <span class="keyword">do</span> skopeo copy docker://<span class="variable">$&#123;image&#125;</span> docker://hub.k8s.li/<span class="variable">$&#123;image#*/&#125;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>åŒæ­¥åˆ°æˆ‘çš„é•œåƒä»“åº“ä¸­ï¼Œå†…å®¹å°±å¦‚ä¸‹ï¼Œåœ¨éƒ¨ç½²çš„æ—¶å€™é€šè¿‡ä¿®æ”¹ä¸€äº›é•œåƒä»“åº“çš„åœ°å€å³å¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">hub.k8s.li/nginx:1.19.0</span><br><span class="line">hub.k8s.li/calico/cni:v3.17.3</span><br><span class="line">hub.k8s.li/calico/node:v3.17.3</span><br><span class="line">hub.k8s.li/calico/kube-controllers:v3.17.3</span><br><span class="line">hub.k8s.li/coreos/flannel:v0.13.0</span><br><span class="line">hub.k8s.li/coreos/flannel:v0.13.0-amd64</span><br><span class="line">hub.k8s.li/pause:3.2</span><br><span class="line">hub.k8s.li/coredns:1.7.0</span><br><span class="line">hub.k8s.li/kube-apiserver:v1.20.6</span><br><span class="line">hub.k8s.li/kube-controller-manager:v1.20.6</span><br><span class="line">hub.k8s.li/kube-proxy:v1.20.6</span><br><span class="line">hub.k8s.li/kube-scheduler:v1.20.6</span><br><span class="line">hub.k8s.li/dns/k8s-dns-node-cache:1.17.1</span><br><span class="line">hub.k8s.li/cpa/cluster-proportional-autoscaler-amd64:1.8.3</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤å‡†å¤‡å·¥ä½œå¤§è‡´éƒ½å·²ç»å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹é…ç½® kubespray çš„ä¸€äº›å‚æ•°å’Œ inventory æ–‡ä»¶</p>
<h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><p>æŒ‰ç…§ kubespray æ–‡æ¡£è¯´æ˜ï¼Œå°† <code>inventory/sample</code> ç›®å½•å¤åˆ¶ä¸€ä»½ï¼Œç„¶åé€šè¿‡ä¿®æ”¹é‡Œé¢çš„å‚æ•°æ¥æ§åˆ¶éƒ¨ç½²ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># cp -rf inventory/sample deploy</span></span><br></pre></td></tr></table></figure>
<h3 id="inventory"><a href="#inventory" class="headerlink" title="inventory"></a>inventory</h3><ul>
<li><code>deploy/inventory</code></li>
</ul>
<p>åˆ›å»ºä¸»æœº inventory æ–‡ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[all:vars]</span></span><br><span class="line"><span class="attr">ansible_port</span>=<span class="number">22</span></span><br><span class="line"><span class="attr">ansible_user</span>=root</span><br><span class="line"></span><br><span class="line"><span class="attr">ansible_ssh_private_key_file</span>=/kubespray/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line"><span class="section">[all]</span></span><br><span class="line">kube-control-1 ansible_host=192.168.4.11</span><br><span class="line">kube-control-2 ansible_host=192.168.4.12</span><br><span class="line">kube-control-3 ansible_host=192.168.4.13</span><br><span class="line">kube-node-1 ansible_host=192.168.4.4</span><br><span class="line"></span><br><span class="line"><span class="section">[kube_control_plane]</span></span><br><span class="line">kube-control-1</span><br><span class="line">kube-control-2</span><br><span class="line">kube-control-3</span><br><span class="line"></span><br><span class="line"><span class="section">[etcd]</span></span><br><span class="line">kube-control-1</span><br><span class="line">kube-control-2</span><br><span class="line">kube-control-3</span><br><span class="line"></span><br><span class="line"><span class="section">[kube-node]</span></span><br><span class="line">kube-control-1</span><br><span class="line">kube-control-2</span><br><span class="line">kube-control-3</span><br><span class="line">kube-node-1</span><br><span class="line"></span><br><span class="line"><span class="section">[calico-rr]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[k8s-cluster:children]</span></span><br><span class="line">kube_control_plane</span><br><span class="line">kube-node</span><br><span class="line">calico-rr</span><br></pre></td></tr></table></figure>
<ul>
<li>ssh äº’ä¿¡</li>
</ul>
<p>Kubespray ç”¨åˆ°äº† ansible çš„ <a href="https://docs.ansible.com/ansible/latest/collections/ansible/posix/synchronize_module.html" target="_blank" rel="noopener">synchronize</a> æ¨¡å—æ¥åˆ†å‘æ–‡ä»¶ï¼ŒåŸºäº rsync åè®®æ‰€ä»¥å¿…é¡»è¦ä½¿ç”¨ ssh å¯†é’¥å¯¹æ¥è¿æ¥é›†ç¾¤èŠ‚ç‚¹ã€‚inventory é…ç½®çš„æ˜¯ kubespray å®¹å™¨å†…çš„è·¯å¾„ï¼Œå› æ­¤éœ€è¦å°† ssh å…¬é’¥å’Œç§é’¥å¤åˆ¶åˆ° repo çš„ .ssh ç›®å½•ä¸‹ã€‚å¦‚æœèŠ‚ç‚¹å°±æ²¡æœ‰è¿›è¡Œ ssh å…å¯†ç™»å½•ï¼Œå¯ä»¥ç”¨ ansible çš„ authorized_key æ¨¡å—å°† ssh å…¬é’¥æ·»åŠ åˆ°ä¸»æœºçš„ authorized_key ä¸­ã€‚æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># mkdir -p .ssh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆ ssh å¯†é’¥å¯¹</span></span><br><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># ssh-keygen -t rsa -f .ssh/id_rsa -P ""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°† ssh å…¬é’¥æ·»åŠ åˆ°æ‰€æœ‰ä¸»æœº</span></span><br><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># ansible -i deploy/inventory all -m authorized_key -a "user=&#123;&#123; ansible_user &#125;&#125; key='&#123;&#123; lookup('file', '&#123;&#123; ssh_cert_path &#125;&#125;') &#125;&#125;'" -e ssh_cert_path=./.ssh/id_rsa.pub -e ansible_ssh_pass=passwd</span></span><br></pre></td></tr></table></figure>
<h3 id="vars"><a href="#vars" class="headerlink" title="vars"></a>vars</h3><p>åˆ›å»ºå¹¶ä¿®æ”¹ä»¥ä¸‹é…ç½®æ–‡ä»¶</p>
<ul>
<li><code>deploy/env.yml</code></li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># å®šä¹‰ä¸€äº›ç»„ä»¶çš„ç‰ˆæœ¬</span></span><br><span class="line"><span class="attr">kube_version:</span> <span class="string">v1.20.6</span></span><br><span class="line"><span class="attr">calico_version:</span> <span class="string">"v3.17.3"</span></span><br><span class="line"><span class="attr">pod_infra_version:</span> <span class="string">"3.2"</span></span><br><span class="line"><span class="attr">nginx_image_version:</span> <span class="string">"1.19"</span></span><br><span class="line"><span class="attr">coredns_version:</span> <span class="string">"1.7.0"</span></span><br><span class="line"><span class="attr">image_arch:</span> <span class="string">"amd64"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker registry domain</span></span><br><span class="line"><span class="attr">registry_domain:</span> <span class="string">"hub.k8s.li"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># file download server url</span></span><br><span class="line"><span class="attr">download_url:</span> <span class="string">"https://dl.k8s.li"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># docker-ce-repo mirrors</span></span><br><span class="line"><span class="attr">docker_mirrors_url:</span> <span class="string">"https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">container_manager:</span> <span class="string">"containerd"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”±äºä½¿ç”¨çš„æ˜¯ containerd ä½œä¸º CRIï¼Œç›®å‰ etcd ä¸æ”¯æŒ containerd å®¹å™¨åŒ–éƒ¨ç½²å› æ­¤éœ€è¦å°†è¯¥å‚æ•°ä¿®æ”¹ä¸º host ï¼Œä½¿ç”¨ systemd æ¥éƒ¨ç½²</span></span><br><span class="line"><span class="attr">etcd_deployment_type:</span> <span class="string">host</span></span><br><span class="line"><span class="attr">etcd_cluster_setup:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">etcd_events_cluster_setup:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">etcd_events_cluster_enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes CNI type é…ç½®é›†ç¾¤ CNI ä½¿ç”¨çš„ç±»å‹</span></span><br><span class="line"><span class="attr">kube_network_plugin:</span> <span class="string">canal</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>deploy/group_vars/all/download.yml</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Container registry define</span></span><br><span class="line"><span class="attr">gcr_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_domain &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kube_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_domain &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">docker_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_domain &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">quay_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_domain &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Download URLs</span></span><br><span class="line"><span class="attr">kubelet_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubelet"</span></span><br><span class="line"><span class="attr">kubectl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubectl"</span></span><br><span class="line"><span class="attr">kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kubeadm_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubeadm"</span></span><br><span class="line"><span class="attr">etcd_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/coreos/etcd/releases/download/<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>/etcd-<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">cni_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containernetworking/plugins/releases/download/<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>/cni-plugins-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>-<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>.tgz"</span></span><br><span class="line"><span class="attr">calicoctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calicoctl/releases/download/<span class="template-variable">&#123;&#123; calico_ctl_version &#125;&#125;</span>/calicoctl-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_crds_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calico/archive/<span class="template-variable">&#123;&#123; calico_version &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crictl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kubernetes-sigs/cri-tools/releases/download/<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>/crictl-<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">helm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/get.helm.sh/helm-<span class="template-variable">&#123;&#123; helm_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crun_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containers/crun/releases/download/<span class="template-variable">&#123;&#123; crun_version &#125;&#125;</span>/crun-<span class="template-variable">&#123;&#123; crun_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kata_containers_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kata-containers/runtime/releases/download/<span class="template-variable">&#123;&#123; kata_containers_version &#125;&#125;</span>/kata-static-<span class="template-variable">&#123;&#123; kata_containers_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_architecture &#125;&#125;</span>.tar.xz"</span></span><br><span class="line"><span class="attr">nerdctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containerd/nerdctl/releases/download/v<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>/nerdctl-<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br></pre></td></tr></table></figure>
<h3 id="docker-ce-mirrors"><a href="#docker-ce-mirrors" class="headerlink" title="docker-ce mirrors"></a>docker-ce mirrors</h3><p>kubespray å®‰è£… docker æˆ–è€… containerd å®¹å™¨è¿è¡Œæ—¶ï¼Œéœ€è¦ä½¿ç”¨ docker-ce çš„æºï¼Œå›½å†…å¯ä»¥ä½¿ç”¨æ¸…åçš„é•œåƒæºã€‚æ ¹æ®ä¸åŒçš„ Linux å‘è¡Œç‰ˆï¼Œåœ¨ <code>deploy/group_vars/all/offline.yml</code> æ–‡ä»¶ä¸­æ·»åŠ è¿™äº›å‚æ•°å³å¯ã€‚å…¶ä¸­ <code>docker_mirrors_url</code> è¿™ä¸ªå‚æ•°å°±æ˜¯åœ¨ <code>env.yml</code> é‡Œè®¾ç½®çš„å‚æ•°ã€‚</p>
<ul>
<li>CentOS/Redhat</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## CentOS/Redhat</span></span><br><span class="line"><span class="comment">### For EL7, base and extras repo must be available, for EL8, baseos and appstream</span></span><br><span class="line"><span class="comment">### By default we enable those repo automatically</span></span><br><span class="line"><span class="comment"># rhel_enable_repos: false</span></span><br><span class="line"><span class="comment">### Docker / Containerd</span></span><br><span class="line">docker_rh_repo_base_url: <span class="string">"&#123;&#123; docker_mirrors_url &#125;&#125;/centos/&#123;&#123; ansible_distribution_major_version &#125;&#125;/&#123;&#123; ansible_architecture &#125;&#125;/stable"</span></span><br><span class="line">docker_rh_repo_gpgkey: <span class="string">"&#123;&#123; docker_mirrors_url &#125;&#125;/centos/gpg"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Fedora</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Fedora</span></span><br><span class="line"><span class="comment">### Docker</span></span><br><span class="line"><span class="attr">docker_fedora_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/fedora/<span class="template-variable">&#123;&#123; ansible_distribution_major_version &#125;&#125;</span>/<span class="template-variable">&#123;&#123; ansible_architecture &#125;&#125;</span>/stable"</span></span><br><span class="line"><span class="attr">docker_fedora_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/fedora/gpg"</span></span><br><span class="line"><span class="comment">### Containerd</span></span><br><span class="line"><span class="attr">containerd_fedora_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/fedora/<span class="template-variable">&#123;&#123; ansible_distribution_major_version &#125;&#125;</span>/<span class="template-variable">&#123;&#123; ansible_architecture &#125;&#125;</span>/stable"</span></span><br><span class="line"><span class="attr">containerd_fedora_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/fedora/gpg"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>debian</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Debian</span></span><br><span class="line"><span class="comment">### Docker</span></span><br><span class="line"><span class="attr">docker_debian_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/debian"</span></span><br><span class="line"><span class="attr">docker_debian_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/debian/gpg"</span></span><br><span class="line"><span class="comment">### Containerd</span></span><br><span class="line"><span class="attr">containerd_debian_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/debian"</span></span><br><span class="line"><span class="attr">containerd_debian_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/debian/gpg"</span></span><br><span class="line"><span class="comment"># containerd_debian_repo_repokey: 'YOURREPOKEY'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ubuntu</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Ubuntu</span></span><br><span class="line"><span class="comment">### Docker</span></span><br><span class="line"><span class="attr">docker_ubuntu_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/ubuntu"</span></span><br><span class="line"><span class="attr">docker_ubuntu_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/ubuntu/gpg"</span></span><br><span class="line"><span class="comment">### Containerd</span></span><br><span class="line"><span class="attr">containerd_ubuntu_repo_base_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/ubuntu"</span></span><br><span class="line"><span class="attr">containerd_ubuntu_repo_gpgkey:</span> <span class="string">"<span class="template-variable">&#123;&#123; docker_mirrors_url &#125;&#125;</span>/ubuntu/gpg"</span></span><br></pre></td></tr></table></figure>
<h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>ç»è¿‡ä»¥ä¸Šå‡†å¤‡å¥½é…ç½®å·¥ä½œä¹‹åï¼Œæ¥ä¸‹æ¥å¯ä»¥å¼€å§‹æ­£å¼éƒ¨ç½²äº†ã€‚åœ¨ä½¿ç”¨ ansible è¿›è¡Œéƒ¨ç½²çš„æ—¶å€™ï¼Œä¸ªäººå€¾å‘äºåœ¨ kubespray å®¹å™¨é‡Œè¿›è¡Œæ“ä½œï¼Œè€Œéåœ¨æœ¬åœ°å¼€å‘æœºå™¨ä¸Šå®‰è£… python3 ç­‰ç¯å¢ƒã€‚å¯¹äºç¦»çº¿éƒ¨ç½²è€Œè¨€ï¼Œæå‰æ„å»ºå¥½é•œåƒï¼Œä½¿ç”¨ docker å®¹å™¨æ›´ä¸ºæ–¹ä¾¿ä¸€äº›ã€‚</p>
<ul>
<li>æ„å»ºé•œåƒ</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># docker build -t kubespray:v2.15.1-kube-v1.20.6 .</span></span><br></pre></td></tr></table></figure>
<ul>
<li>è¿è¡Œ kubespray å®¹å™¨</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root/kubespray git:(master*) <span class="comment"># docker run --rm -it --net=host -v $PWD:/kubespray kubespray:v2.15.1-kube-v1.20.6 bash</span></span><br></pre></td></tr></table></figure>
<ul>
<li>æµ‹è¯•ä¸»æœºæ˜¯å¦è¿æ¥æ­£å¸¸</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/kubespray<span class="comment"># ansible -i cluster/inventory all -m ping</span></span><br><span class="line">kube-control-3 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">kube-control-1 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">kube-node-1 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">kube-control-2 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¼€å§‹éƒ¨ç½²é›†ç¾¤</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/kubespray<span class="comment"># ansible-playbook -i deploy/inventory -e "@deploy/env.yml" cluster.yml</span></span><br></pre></td></tr></table></figure>
<ul>
<li>éƒ¨ç½²å®Œæˆæ—¥å¿—å¦‚ä¸‹ï¼Œå½“ failed éƒ½ä¸º 0 æ—¶è¯´æ˜ tasks éƒ½å·²ç»æˆåŠŸè·‘å®Œäº†</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PLAY RECAP ******************************************************************</span><br><span class="line">kube-control-1             : ok=526  changed=67   unreachable=0    failed=0    skipped=978  rescued=0    ignored=0</span><br><span class="line">kube-control-2             : ok=524  changed=66   unreachable=0    failed=0    skipped=980  rescued=0    ignored=0</span><br><span class="line">kube-control-3             : ok=593  changed=76   unreachable=0    failed=0    skipped=1125 rescued=0    ignored=1</span><br><span class="line">kube-node-1                : ok=366  changed=34   unreachable=0    failed=0    skipped=628  rescued=0    ignored=0</span><br><span class="line">localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"></span><br><span class="line">Wednesday 28 April 2021  10:57:57 +0000 (0:00:00.115)       0:15:21.190 *******</span><br><span class="line">===============================================================================</span><br><span class="line">kubernetes/control-plane : kubeadm | Initialize first master -------------- 65.88s</span><br><span class="line">kubernetes/control-plane : Joining control plane node to the cluster. ----- 50.05s</span><br><span class="line">kubernetes/kubeadm : Join to cluster -------------------------------------- 31.54s</span><br><span class="line">download_container | Download image <span class="keyword">if</span> required --------------------------- 24.38s</span><br><span class="line">reload etcd --------------------------------------------------------------- 20.56s</span><br><span class="line">Gen_certs | Write etcd member and admin certs to other etcd nodes --------- 19.32s</span><br><span class="line">Gen_certs | Write node certs to other etcd nodes -------------------------- 19.14s</span><br><span class="line">Gen_certs | Write etcd member and admin certs to other etcd nodes --------- 17.45s</span><br><span class="line">network_plugin/canal : Canal | Create canal node manifests ---------------- 15.41s</span><br><span class="line">kubernetes-apps/ansible : Kubernetes Apps | Lay Down CoreDNS Template ----- 13.27s</span><br><span class="line">kubernetes/control-plane : Master | <span class="built_in">wait</span> <span class="keyword">for</span> kube-scheduler --------------- 11.97s</span><br><span class="line">download_container | Download image <span class="keyword">if</span> required --------------------------- 11.76s</span><br><span class="line">Gen_certs | Write node certs to other etcd nodes -------------------------- 10.50s</span><br><span class="line">kubernetes-apps/ansible : Kubernetes Apps | Start Resources ---------------- 8.28s</span><br><span class="line">policy_controller/calico : Create calico-kube-controllers manifests -------- 7.61s</span><br><span class="line">kubernetes/control-plane : <span class="built_in">set</span> kubeadm certificate key --------------------- 6.32s</span><br><span class="line">download : extract_file | Unpacking archive -------------------------------- 5.51s</span><br><span class="line">Configure | Check <span class="keyword">if</span> etcd cluster is healthy ------------------------------- 5.41s</span><br><span class="line">Configure | Check <span class="keyword">if</span> etcd-events cluster is healthy ------------------------ 5.41s</span><br><span class="line">kubernetes-apps/network_plugin/canal : Canal | Start Resources ------------- 4.85s</span><br></pre></td></tr></table></figure>
<ul>
<li>é›†ç¾¤çŠ¶æ€</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-control-1 ~]# kubectl get node -o wide</span><br><span class="line">NAME             STATUS   ROLES                  AGE     VERSION   INTERNAL-IP     EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION           CONTAINER-RUNTIME</span><br><span class="line">kube-control-1   Ready    control-plane,master   5m24s   v1.20.6   192.168.4.11   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4</span><br><span class="line">kube-control-2   Ready    control-plane,master   5m40s   v1.20.6   192.168.4.12   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4</span><br><span class="line">kube-control-3   Ready    control-plane,master   6m28s   v1.20.6   192.168.4.13   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4</span><br><span class="line">kube-node-1      Ready    &lt;none&gt;                 3m53s   v1.20.6   192.168.4.14   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.el7.x86_64   containerd://1.4.4</span><br></pre></td></tr></table></figure>
<ul>
<li>é›†ç¾¤ç»„ä»¶çŠ¶æ€</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@kube-control-1 ~]<span class="comment"># kubectl get all -n kube-system</span></span><br><span class="line">NAME                                           READY   STATUS             RESTARTS   AGE</span><br><span class="line">pod/calico-kube-controllers-67d6cdb559-cwf62   0/1     CrashLoopBackOff   5          4m10s</span><br><span class="line">pod/canal-node-46x2b                           2/2     Running            0          4m25s</span><br><span class="line">pod/canal-node-5rkhq                           2/2     Running            0          4m25s</span><br><span class="line">pod/canal-node-fcsgn                           2/2     Running            0          4m25s</span><br><span class="line">pod/canal-node-nhkp8                           2/2     Running            0          4m25s</span><br><span class="line">pod/coredns-5d578c6f84-5nnp8                   1/1     Running            0          3m33s</span><br><span class="line">pod/coredns-5d578c6f84-w2kvf                   1/1     Running            0          3m39s</span><br><span class="line">pod/dns-autoscaler-6b675c8995-vp282            1/1     Running            0          3m34s</span><br><span class="line">pod/kube-apiserver-kube-control-1              1/1     Running            0          6m51s</span><br><span class="line">pod/kube-apiserver-kube-control-2              1/1     Running            0          7m7s</span><br><span class="line">pod/kube-apiserver-kube-control-3              1/1     Running            0          7m41s</span><br><span class="line">pod/kube-controller-manager-kube-control-1     1/1     Running            0          6m52s</span><br><span class="line">pod/kube-controller-manager-kube-control-2     1/1     Running            0          7m7s</span><br><span class="line">pod/kube-controller-manager-kube-control-3     1/1     Running            0          7m41s</span><br><span class="line">pod/kube-proxy-5dfx8                           1/1     Running            0          5m17s</span><br><span class="line">pod/kube-proxy-fvrqk                           1/1     Running            0          5m17s</span><br><span class="line">pod/kube-proxy-jd84p                           1/1     Running            0          5m17s</span><br><span class="line">pod/kube-proxy-l2mjk                           1/1     Running            0          5m17s</span><br><span class="line">pod/kube-scheduler-kube-control-1              1/1     Running            0          6m51s</span><br><span class="line">pod/kube-scheduler-kube-control-2              1/1     Running            0          7m7s</span><br><span class="line">pod/kube-scheduler-kube-control-3              1/1     Running            0          7m41s</span><br><span class="line">pod/nginx-proxy-kube-node-1                    1/1     Running            0          5m20s</span><br><span class="line">pod/nodelocaldns-77kq9                         1/1     Running            0          3m32s</span><br><span class="line">pod/nodelocaldns-fn5pd                         1/1     Running            0          3m32s</span><br><span class="line">pod/nodelocaldns-lfjzb                         1/1     Running            0          3m32s</span><br><span class="line">pod/nodelocaldns-xnc6n                         1/1     Running            0          3m32s</span><br><span class="line"></span><br><span class="line">NAME              TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">service/coredns   ClusterIP   10.233.0.3   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   3m38s</span><br><span class="line"></span><br><span class="line">NAME                          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE</span><br><span class="line">daemonset.apps/canal-node     4         4         4       4            4           &lt;none&gt;                   4m25s</span><br><span class="line">daemonset.apps/kube-proxy     4         4         4       4            4           kubernetes.io/os=linux   7m53s</span><br><span class="line">daemonset.apps/nodelocaldns   4         4         4       4            4           &lt;none&gt;                   3m32s</span><br><span class="line"></span><br><span class="line">NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/calico-kube-controllers   0/1     1            0           4m12s</span><br><span class="line">deployment.apps/coredns                   2/2     2            2           3m39s</span><br><span class="line">deployment.apps/dns-autoscaler            1/1     1            1           3m34s</span><br><span class="line"></span><br><span class="line">NAME                                                 DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/calico-kube-controllers-67d6cdb559   1         1         0       4m12s</span><br><span class="line">replicaset.apps/coredns-5d578c6f84                   2         2         2       3m39s</span><br><span class="line">replicaset.apps/dns-autoscaler-6b675c8995            1         1         1       3m34s</span><br></pre></td></tr></table></figure>
<h2 id="åæ§½"><a href="#åæ§½" class="headerlink" title="åæ§½"></a>åæ§½</h2><p>åœ¨å›½å†…è¿™ç§ååˆ†ç³Ÿç³•çš„ç½‘ç»œç¯å¢ƒä¸‹ï¼Œå¯¹äºæ™®é€šçš„å¼€å‘è€…æˆ–è€…å­¦ç”Ÿæ¥è®²ï¼Œéƒ¨ç½²ä¸€ä¸ª kubernetes é›†ç¾¤æ˜¯ååˆ†ç—›è‹¦çš„äº‹æƒ…ï¼Œè¿™ä¹Ÿè¿›ä¸€æ­¥é˜»ç¢äº†è¿™é—¨æŠ€æœ¯çš„æ™®åŠå’Œä½¿ç”¨ã€‚ä¹Ÿæƒ³èµ·äº†å‡ å¹´å‰åœ¨ä¸€æ¬¡ docker æŠ€æœ¯åˆ†äº«æ—¶çš„ QA é—®ç­”ï¼š</p>
<blockquote>
<p>Qï¼šå¦‚ä½•æ‘†è„±ç½‘ç»œçš„ä¾èµ–æ¥åˆ›å»ºä¸ª Docker çš„ image å‘¢ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªæ˜¯ Docker ç”¨æˆ·è‡ªå·±çš„åŸºæœ¬æƒåˆ©ï¼Ÿ</p>
</blockquote>
<p><strong>Aï¼šè¿™ä¸ªåŸºæœ¬æƒåˆ©æˆ‘è§‰å¾—è¿˜æ˜¯è¦é—® GFW ï¼Œå›½å¤–çš„å¼€å‘äººå‘˜æ˜¯éå¸¸éš¾ç†è§£æœ‰äº›ä»–ä»¬è®¤ä¸ºè·Ÿæ°´ç”µä¸€æ ·æ™®åŠçš„åŸºç¡€è®¾æ–½åœ¨æŸäº›åœ°æ–¹è¿˜æ˜¯å¾ˆå›°éš¾çš„ã€‚</strong></p>
    </div>
      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kubernetes/" rel="tag"><i class="fa fa-tag"></i> kubernetes</a>
              <a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a>
              <a href="/tags/kubespray/" rel="tag"><i class="fa fa-tag"></i> kubespray</a>
          </div>
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/select-registry-images.html" rel="prev" title="ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼">
      <i class="fa fa-chevron-left"></i> ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼
    </a></div>
      <div class="post-nav-item">
    <a href="/kubespray-tips.html" rel="next" title="kubespray éƒ¨ç½²å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æ±‡æ€»">
      kubespray éƒ¨ç½²å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æ±‡æ€» <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
  </article>
  </div>
          </div>
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
        </div>
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>
  <aside class="sidebar">
    <div class="sidebar-inner">
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>
      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å‡†å¤‡"><span class="nav-number">1.</span> <span class="nav-text">å‡†å¤‡</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#åŸŸå-SSL-è¯ä¹¦åˆ¶ä½œ"><span class="nav-number">1.1.</span> <span class="nav-text">åŸŸå SSL è¯ä¹¦åˆ¶ä½œ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ­å»ºé•œåƒä»“åº“"><span class="nav-number">1.2.</span> <span class="nav-text">æ­å»ºé•œåƒä»“åº“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ–‡ä»¶æœåŠ¡å™¨"><span class="nav-number">1.3.</span> <span class="nav-text">æ–‡ä»¶æœåŠ¡å™¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç¼–è¯‘å®‰è£…-skopeo"><span class="nav-number">1.4.</span> <span class="nav-text">ç¼–è¯‘å®‰è£… skopeo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶"><span class="nav-number">1.5.</span> <span class="nav-text">è·å–éƒ¨ç½²éœ€è¦çš„äºŒè¿›åˆ¶æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ"><span class="nav-number">1.6.</span> <span class="nav-text">è·å–éƒ¨ç½²éœ€è¦çš„é•œåƒ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é…ç½®"><span class="nav-number">2.</span> <span class="nav-text">é…ç½®</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#inventory"><span class="nav-number">2.1.</span> <span class="nav-text">inventory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vars"><span class="nav-number">2.2.</span> <span class="nav-text">vars</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-ce-mirrors"><span class="nav-number">2.3.</span> <span class="nav-text">docker-ce mirrors</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#éƒ¨ç½²"><span class="nav-number">3.</span> <span class="nav-text">éƒ¨ç½²</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åæ§½"><span class="nav-number">4.</span> <span class="nav-text">åæ§½</span></a></li></ol></div>
      </div>
      <!--/noindex-->
      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="æœ¨å­"
      src="https://blog.k8s.li/avatar.png">
  <p class="site-author-name" itemprop="name">æœ¨å­</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">98</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:blog@502.li" title="E-Mail â†’ mailto:blog@502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://kindle.502.li/" title="Kindle â†’ https:&#x2F;&#x2F;kindle.502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tg.k8s.li/" title="Channel â†’ https:&#x2F;&#x2F;tg.k8s.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Channel</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>
      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>
      </div>
    </main>
    <footer class="footer">
      <div class="footer-inner">
<div class="copyright">
  &copy; 2018 â€“ 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">æœ¨å­</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">39:50</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>
      </div>
    </footer>
  </div>
  <script src="/lib/anime.min.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>
<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://muzi.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://blog.k8s.li/deploy-k8s-by-kubespray.html",
            identifier: "deploy-k8s-by-kubespray.html",
            title: "ä½¿ç”¨ Kubespray æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://muzi.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>
</body>
</html>
