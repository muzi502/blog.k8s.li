<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.3.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="小插曲最近 土豆哥 在捣鼓 Webp Server Go 的时候发咱一张 systemctl status webp 的信息：  咦？咱的 systemctl status webp 为啥子没得 CPU 和 Memory 信息呐？  然后和土豆哥请教了一下，咱也想要。于是土豆哥发咱一篇 systemd – systemctl 不显示内存 CPU 信息 博客，于是拜师学艺就 get 到啦 😋。只需">
<meta property="og:type" content="blog">
<meta property="og:title" content="Linux 的小伙伴 systemd 详解">
<meta property="og:url" content="https://blog.k8s.li/systemd.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="小插曲最近 土豆哥 在捣鼓 Webp Server Go 的时候发咱一张 systemctl status webp 的信息：  咦？咱的 systemctl status webp 为啥子没得 CPU 和 Memory 信息呐？  然后和土豆哥请教了一下，咱也想要。于是土豆哥发咱一篇 systemd – systemctl 不显示内存 CPU 信息 博客，于是拜师学艺就 get 到啦 😋。只需">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/20200318080736564.png">
<meta property="og:image" content="https://p.k8s.li/20200318080903595.png">
<meta property="og:image" content="https://p.k8s.li/20200318211715509.png">
<meta property="og:image" content="https://p.k8s.li/systemd_components-svg.png">
<meta property="og:image" content="https://p.k8s.li/linux_kernel_unified_hierarchy_cgroups_and_systemd-svg.png">
<meta property="article:published_time" content="2020-03-18T16:00:00.000Z">
<meta property="article:modified_time" content="2020-03-18T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="blog">
<meta property="article:tag" content="笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/20200318080736564.png">


<link rel="canonical" href="https://blog.k8s.li/systemd.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/systemd.html","path":"systemd.html","title":"Linux 的小伙伴 systemd 详解"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Linux 的小伙伴 systemd 详解 | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E6%8F%92%E6%9B%B2"><span class="nav-number">1.</span> <span class="nav-text">小插曲</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">2.</span> <span class="nav-text">Linux 启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#BIOS-x2F-EFI-%E9%98%B6%E6%AE%B5"><span class="nav-number">2.1.</span> <span class="nav-text">BIOS&#x2F;EFI 阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BootLoader-%E9%98%B6%E6%AE%B5"><span class="nav-number">2.2.</span> <span class="nav-text">BootLoader 阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kernel-%E9%98%B6%E6%AE%B5"><span class="nav-number">2.3.</span> <span class="nav-text">kernel 阶段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#init-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5"><span class="nav-number">2.4.</span> <span class="nav-text">init 初始化阶段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BB%E8%A7%92-systemd"><span class="nav-number">3.</span> <span class="nav-text">主角 systemd</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#systemd-%E7%AE%80%E4%BB%8B"><span class="nav-number">3.1.</span> <span class="nav-text">systemd 简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#systemd-%E8%AE%BE%E8%AE%A1%E7%9B%AE%E6%A0%87"><span class="nav-number">3.2.</span> <span class="nav-text">systemd 设计目标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#systemd-%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84"><span class="nav-number">3.3.</span> <span class="nav-text">systemd 体系架构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#systemd-unit"><span class="nav-number">3.4.</span> <span class="nav-text">systemd unit</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#systemd-unit-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">3.5.</span> <span class="nav-text">systemd unit 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%93%BE%E6%8E%A5%E6%96%87%E4%BB%B6"><span class="nav-number">3.6.</span> <span class="nav-text">链接文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#systemd-%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">3.7.</span> <span class="nav-text">systemd 启动流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E6%A0%91"><span class="nav-number">3.8.</span> <span class="nav-text">进程树</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%A1%E7%90%86-systemd"><span class="nav-number">4.</span> <span class="nav-text">管理 systemd</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#systemctl-%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="nav-number">4.1.</span> <span class="nav-text">systemctl 基本用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#journal"><span class="nav-number">4.2.</span> <span class="nav-text">journal</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#systemd-analyze"><span class="nav-number">4.3.</span> <span class="nav-text">systemd-analyze</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A8%E8%8D%90-x2F-%E5%8F%82%E8%80%83"><span class="nav-number">5.</span> <span class="nav-text">推荐&#x2F;参考</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81"><span class="nav-number">5.1.</span> <span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E6%A1%A3"><span class="nav-number">5.2.</span> <span class="nav-text">文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%9A%E5%AE%A2"><span class="nav-number">5.3.</span> <span class="nav-text">博客</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">120</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">155</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail → mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/systemd.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Linux 的小伙伴 systemd 详解 | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Linux 的小伙伴 systemd 详解
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-03-19 2020-03-19T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2020-03-19T00:00:00+08:00">2020-03-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/systemd.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="systemd.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>23k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>21 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="小插曲"><a href="#小插曲" class="headerlink" title="小插曲"></a>小插曲</h2><p>最近 <a target="_blank" rel="noopener" href="https://www.bennythink.com/">土豆哥</a> 在捣鼓 <a target="_blank" rel="noopener" href="https://github.com/webp-sh/webp_server_go">Webp Server Go</a> 的时候发咱一张 <code>systemctl status webp</code> 的信息：</p>
<p><img data-src="https://p.k8s.li/20200318080736564.png"></p>
<p>咦？咱的 <code>systemctl status webp</code> 为啥子没得 CPU 和 Memory 信息呐？</p>
<p><img data-src="https://p.k8s.li/20200318080903595.png"></p>
<p>然后和土豆哥请教了一下，咱也想要。于是土豆哥发咱一篇 <a target="_blank" rel="noopener" href="https://www.bennythink.com/systemd-accounting.html">systemd – systemctl 不显示内存 CPU 信息</a> 博客，于是拜师学艺就 get 到啦 😋。只需要在 systemd 的配置文件中 <code>/etc/systemd/system.conf</code> 追加</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token key attr-name">DefaultCPUAccounting</span><span class="token punctuation">=</span><span class="token value attr-value">yes</span>
<span class="token key attr-name">DefaultMemoryAccounting</span><span class="token punctuation">=</span><span class="token value attr-value">yes</span>
<span class="token key attr-name">DefaultTasksAccounting</span><span class="token punctuation">=</span><span class="token value attr-value">yes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>然后再 <code>systemctl daemon-reload</code> 一把梭就可以啦 😂</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@blog /home/ubuntu
╰─<span class="token comment"># systemctl status webps</span>
● webps.service - WebP Server
   Loaded: loaded <span class="token punctuation">(</span>/opt/webps/webps.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Sat <span class="token number">2020</span>-03-14 <span class="token number">10</span>:32:31 UTC<span class="token punctuation">;</span> <span class="token number">4</span> days ago
     Docs: https://github.com/n0vad3v/webp_server_go
 Main PID: <span class="token number">20691</span> <span class="token punctuation">(</span>webp-server<span class="token punctuation">)</span>
    Tasks: <span class="token number">36</span> <span class="token punctuation">(</span>limit: <span class="token number">684</span><span class="token punctuation">)</span>
   Memory: <span class="token number">9</span>.1M
      CPU: <span class="token number">20</span>.421s
   CGroup: /system.slice/webps.service
           └─20691 /opt/webps/webp-server <span class="token parameter variable">--config</span> /opt/webps/config.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img data-src="https://p.k8s.li/20200318211715509.png"></p>
<p>不过，咱还是要深入地学习一下 <code>systemd</code> ，于是就水了这篇博客 😂</p>
<h2 id="Linux-启动流程"><a href="#Linux-启动流程" class="headerlink" title="Linux 启动流程"></a>Linux 启动流程</h2><p>提到 systemd 不得不提一下 Linux 的启动流程，这样才能清楚  systemd 在 Linux 系统中的地位和作用 😋。所以就简明扼要第介绍一下 Linux 启动的流程。</p>
<p>Linux 从按下电源键到进入用户交互界面整个启动流程大致可以分为四个阶段：</p>
<ul>
<li>BIOS 阶段</li>
<li>BootLoader 阶段</li>
<li>kernel 加载阶段</li>
<li>init：systemd&#x2F;sysvinit 初始化阶段</li>
</ul>
<h3 id="BIOS-x2F-EFI-阶段"><a href="#BIOS-x2F-EFI-阶段" class="headerlink" title="BIOS&#x2F;EFI 阶段"></a>BIOS&#x2F;EFI 阶段</h3><p>BIOS 想必大家都熟悉，也就是做一些基本的硬件自检准备以及加载 bootloader 程序。在按下电源电源键（冷启动）后， CPU 的程序计数器被初始化为一个特定的內存地址，存储在只读存储器（ROM）中的 BIOS 就是从这个特定的內存地址开始执行。<strong>所以没有 CPU 是无法启动主板上的 BIOS 的</strong> ，应该（小声。注意：对于嵌入式系统中的 CPU ，将会加载引导区去启动 flash&#x2F;ROM 中已知地址的程序。</p>
<p>BIOS 启动后就开始执行硬件的基本初始化也称之为（POST: 上电自检），并根据引导设备的优先级将系统控制权交给硬件启动项（比如硬盘&#x2F;网络&#x2F;U 盘等）。也就是我们 BIOS 上的启动菜单，这一步是可以被打断的。当我们按下 F12 或者 ESC 键（根据主板芯片组而异）就会弹出选择启动项的界面，而且这些按键高度依赖硬件。</p>
<p>BIOS 选择好硬件启动项之后就开始执行硬件设备上的初级引导程序代码，对于 MBR 硬盘来讲是最开始的一个扇区（512 字节）將被加载到內存，並执行行其中的初始化代码来加载下一阶段的 Bootloader 。</p>
<p>PS：MBR <strong>主引导记录</strong>是一个 512 字节的扇区，位于硬盘的第一扇区（0 道 0 柱 1 扇区）。对于 GPT&#x2F;EFI 来讲~~，有点头大，暂且先不谈 😂。</p>
<p>可以使用 dd 命令读取 MBR 里的内容 <code>dd if=/dev/sda of=mbr.bin bs=512 count=1</code></p>
<p>使用 od 命令来查看 <code>od -xa mbr.bin</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># od -xa mbr.bin</span>
0000000    63eb    0090    0000    0000    0000    0000    0000    0000
          k   c dle nul nul nul nul nul nul nul nul nul nul nul nul nul
0000020    0000    0000    0000    0000    0000    0000    0000    0000
        nul nul nul nul nul nul nul nul nul nul nul nul nul nul nul nul
*
0000120    0000    0000    0000    0000    0000    <span class="token number">8000</span>    0800    0000
        nul nul nul nul nul nul nul nul nul nul nul nul nul  bs nul nul
0000140    0000    0000    faff    <span class="token number">9090</span>    c2f6    <span class="token number">7480</span>    f605    70c2
        nul nul nul nul del   z dle dle   <span class="token function">v</span>   B nul   t enq   <span class="token function">v</span>   B   p
0000160    0274    80b2    79ea    007c    <span class="token number">3100</span>    8ec0    8ed8    bcd0
          t stx   <span class="token number">2</span> nul   j   y   <span class="token operator">|</span> nul nul   <span class="token number">1</span>   @  so   X  so   P   <span class="token operator">&lt;</span>
0000200    <span class="token number">2000</span>    a0fb    7c64    ff3c    0274    c288    bb52    0417
        nul  sp   <span class="token punctuation">&#123;</span>  sp   d   <span class="token operator">|</span>   <span class="token operator">&lt;</span> del   t stx  bs   B   R   <span class="token punctuation">;</span> etb eot
0000220    07f6    <span class="token number">7403</span>    be06    7d88    17e8    be01    7c05    41b4
          <span class="token function">v</span> bel etx   t ack   <span class="token operator">></span>  bs   <span class="token punctuation">&#125;</span>   h etb soh   <span class="token operator">></span> enq   <span class="token operator">|</span>   <span class="token number">4</span>   A
0000240    aabb    cd55    5a13    <span class="token number">7252</span>    813d    55fb    75aa    <span class="token number">8337</span>
……………………<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="BootLoader-阶段"><a href="#BootLoader-阶段" class="headerlink" title="BootLoader 阶段"></a>BootLoader 阶段</h3><p>主引导记录加载完 Bootloader（主要为 GRUB）到 RAM 中之后，GRUB 会根据需求显示一个可用的内核列表（定义在&#x2F;etc&#x2F;grub.conf，以及&#x2F;etc&#x2F;grub&#x2F;menu.lst 和&#x2F;etc&#x2F;grub.conf 的软连接）。根据 GRUB 的配置加载默认内核镜像和 initrd 镜像到内存中，当所有镜像准备好后，即跳转到内核镜像。</p>
<h3 id="kernel-阶段"><a href="#kernel-阶段" class="headerlink" title="kernel 阶段"></a>kernel 阶段</h3><p>BootLoader 阶段完成之后内核镜像加载到内存中，系统的控制权就交给内核镜像，由此内核阶段开始了。内核镜像不是一个可以执行的内核，而是一个被压缩的内核镜像 （zImage 或 bzImage）。在内核镜像的头部有一个小型程序 routine ，其做少量的硬件设置，然后自解压压缩的内核镜像并放到高端内存。如果存在初始磁盘镜像（initrd），routine 将拷贝 initrd 以供稍后安装使用，然后 routine 将调用内核开始内核启动。</p>
<blockquote>
<p>在内核引导过程中，初始 RAM 磁盘（initrd）是由 BootLoader 加载到内存中的，它会被复制到 RAM 中并挂载到系统上。这个 initrd 作为 RAM 中的临时根文件系统使用，并允许内核在没有挂载任何物理磁盘的情况下完整地实现引导。由于与外围设备进行交互所需要的模块可是 initrd 的一部分，因此内核可以非常小，但是仍然支持大量可能的硬件配置。在内核启动后，就可以正式装备根文件系统了（通过 pivot_root），此时会将 initrd 根文件系统卸载掉，并挂载真正的根文件系统。<br>initrd 函数让我们可以创建一个小型的 Linux 内核，其中包括作为可加载模块编译的驱动程序。这些可加载的模块为内核提供了访问磁盘和磁盘上的文件系统的方法，并为其他硬件提供了驱动程序。由于根文件系统是磁盘上的一个文件系统，因此 initrd 函数会提供一种启动方法来获得对磁盘的访问，并挂载真正的根文件系统。在没有硬盘的嵌入式目标中，initrd 可以是最终的根文件系统，或者也可以通过网络文件系统（NFS）来挂载最终的根文件系统。</p>
</blockquote>
<p>可以使用 dmesg 来查看从加载内核后的流程，下一篇博客会写从 dmesg 日志分析 Linux 内核启动流程（挖坑</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@blog /home/ubuntu
╰─<span class="token comment"># dmesg</span>
<span class="token punctuation">[</span>    <span class="token number">0.000000</span><span class="token punctuation">]</span> Linux version <span class="token number">5.0</span>.0-1031-gcp <span class="token punctuation">(</span>buildd@lcy01-amd64-020<span class="token punctuation">)</span> <span class="token punctuation">(</span>gcc version <span class="token number">7.4</span>.0 <span class="token punctuation">(</span>Ubuntu <span class="token number">7.4</span>.0-1ubuntu1~18.04.1<span class="token punctuation">))</span> <span class="token comment">#32-Ubuntu SMP Tue Feb 11 03:55:48 UTC 2020 (Ubuntu 5.0.0-1031.32-gcp 5.0.21)</span>
<span class="token punctuation">[</span>    <span class="token number">0.000000</span><span class="token punctuation">]</span> Command line: <span class="token assign-left variable">BOOT_IMAGE</span><span class="token operator">=</span>/boot/vmlinuz-5.0.0-1031-gcp <span class="token assign-left variable">root</span><span class="token operator">=</span>PARTUUID<span class="token operator">=</span>9b22aacc-c8b9-497a-9583-a20c1be968c4 ro <span class="token assign-left variable">scsi_mod.use_blk_mq</span><span class="token operator">=</span>Y <span class="token assign-left variable">console</span><span class="token operator">=</span>ttyS0
<span class="token punctuation">[</span>    <span class="token number">0.000000</span><span class="token punctuation">]</span> KERNEL supported cpus:
<span class="token punctuation">[</span>    <span class="token number">0.000000</span><span class="token punctuation">]</span>   Intel GenuineIntel
<span class="token punctuation">[</span>    <span class="token number">0.000000</span><span class="token punctuation">]</span>   AMD AuthenticAMD
<span class="token punctuation">[</span>    <span class="token number">0.000000</span><span class="token punctuation">]</span>   Hygon HygonGenuine
<span class="token punctuation">[</span>    <span class="token number">0.000000</span><span class="token punctuation">]</span>   Centaur CentaurHauls
……………………………………………………………………………………………………
<span class="token punctuation">[</span>    <span class="token number">2.486896</span><span class="token punctuation">]</span> Write protecting the kernel read-only data: 22528k
<span class="token punctuation">[</span>    <span class="token number">2.489395</span><span class="token punctuation">]</span> Freeing unused kernel image memory: 2016K
<span class="token punctuation">[</span>    <span class="token number">2.490937</span><span class="token punctuation">]</span> Freeing unused kernel image memory: 1708K
<span class="token punctuation">[</span>    <span class="token number">2.500867</span><span class="token punctuation">]</span> x86/mm: Checked W+X mappings: passed, no W+X pages found.
<span class="token punctuation">[</span>    <span class="token number">2.503126</span><span class="token punctuation">]</span> x86/mm: Checking user space page tables
<span class="token punctuation">[</span>    <span class="token number">2.513767</span><span class="token punctuation">]</span> x86/mm: Checked W+X mappings: passed, no W+X pages found.
<span class="token punctuation">[</span>    <span class="token number">2.516258</span><span class="token punctuation">]</span> Run /sbin/init as init process
<span class="token punctuation">[</span>    <span class="token number">3.992535</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: systemd <span class="token number">237</span> running <span class="token keyword">in</span> system mode. <span class="token punctuation">(</span>+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP +BLKID +ELFUTILS +KMOD <span class="token parameter variable">-IDN2</span> +IDN <span class="token parameter variable">-PCRE2</span> default-hierarchy<span class="token operator">=</span>hybrid<span class="token punctuation">)</span>
<span class="token punctuation">[</span>    <span class="token number">4.002297</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Detected virtualization kvm.
<span class="token punctuation">[</span>    <span class="token number">4.004593</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Detected architecture x86-64.
<span class="token punctuation">[</span>    <span class="token number">4.031531</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Set <span class="token function">hostname</span> to <span class="token operator">&lt;</span>blog<span class="token operator">></span>.
<span class="token punctuation">[</span>    <span class="token number">5.343604</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Reached target Swap.
<span class="token punctuation">[</span>    <span class="token number">5.355156</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started Dispatch Password Requests to Console Directory Watch.
<span class="token punctuation">[</span>    <span class="token number">5.367360</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Created slice User and Session Slice.
<span class="token punctuation">[</span>    <span class="token number">5.379321</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Set up automount Arbitrary Executable File Formats File System Automount Point.
<span class="token punctuation">[</span>    <span class="token number">5.395189</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Started Forward Password Requests to Wall Directory Watch.
<span class="token punctuation">[</span>    <span class="token number">5.411078</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Reached target Local Encrypted Volumes.
<span class="token punctuation">[</span>    <span class="token number">5.644759</span><span class="token punctuation">]</span> EXT4-fs <span class="token punctuation">(</span>sda1<span class="token punctuation">)</span>: re-mounted. Opts: <span class="token punctuation">(</span>null<span class="token punctuation">)</span>
<span class="token punctuation">[</span>   <span class="token number">11.663490</span><span class="token punctuation">]</span> bpfilter: Loaded bpfilter_umh pid <span class="token number">456</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="init-初始化阶段"><a href="#init-初始化阶段" class="headerlink" title="init 初始化阶段"></a>init 初始化阶段</h3><p>一旦内核自解压完成，启动并初始化后，内核启动第一个<strong>用户空间应用程序</strong>，即 systemd 进程（其是老式 System V 系统的 init 程序的替代品)，并转移控制权到 systemd。这是调用的第一个使用标准 C 库编译的程序，在此进程之前，还没有执行任何标准的 C 应用程序。至此整个系统引导过程的结束，kernel 和 systemd 处于运行状态，接下来就由 systemd 来启动各项程序。</p>
<p>从 dmesg 的输出日志我们可以看到，直到 2.516258 秒才开始执行 <code>/sbin/init</code> 命令，而对于采用 systemd 的发行版来说，<code>/sbin/init</code> 是指向 <code>/sbin/init -&gt; /lib/systemd/systemd</code> ，的链接文件，实际上就是在启动 systemd 😂</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>    <span class="token number">2.516258</span><span class="token punctuation">]</span> Run /sbin/init as init process
<span class="token punctuation">[</span>    <span class="token number">3.992535</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: systemd <span class="token number">237</span> running <span class="token keyword">in</span> system mode. <span class="token punctuation">(</span>+PAM +AUDIT +SELINUX +IMA +APPARMOR +SMACK +SYSVINIT +UTMP +LIBCRYPTSETUP +GCRYPT +GNUTLS +ACL +XZ +LZ4 +SECCOMP +BLKID +ELFUTILS +KMOD <span class="token parameter variable">-IDN2</span> +IDN <span class="token parameter variable">-PCRE2</span> default-hierarchy<span class="token operator">=</span>hybrid<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="主角-systemd"><a href="#主角-systemd" class="headerlink" title="主角 systemd"></a>主角 systemd</h2><p>为什么文章题名为 <strong>Linux 的小伙伴 systemd</strong> 呐，其实广义上来讲 Linux 是众多 Linux 系统发行版的集合，但严格来讲 Linux 仅仅是一个 OS 的 kernel 而已，仅仅有一个内核是无法组成一个系统的，所以 Linux kernel 还需要他的几个兄弟比如 GNU 、 systemd 、X Window 、GNOME 、 KDE 、Xfce 等等其他用户层面的程序来构建出一套完整的操作系统出来。</p>
<p>还有如果你要是当着自由软件基金会主席 RMS <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%90%86%E6%9F%A5%E5%BE%B7%C2%B7%E6%96%AF%E6%89%98%E6%9B%BC">理查德·斯托曼</a> 说 Linux 的话，他会给你发火哦，你要说 GNU&#x2F;Linux 才行 😂。</p>
<p>将 Debian 哲学与方法论，GNU 工具集、Linux 内核，以及其他重要的自由软件结合在一起所构成的独特的软件发行版称为 Debian GNU&#x2F;Linux。当你将 Debian 的安装镜像刻录到 U 盘之后显示的名称就是 <code>Debian GNU/Linux</code> 。关于 GNU 和 Linux 的故事可以去看一哈 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-cn/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E9%9D%A9%E5%91%BD">操作系统革命</a> 纪录片，以及 RMS 的自传《若为自由故：自由软件之父理查德·斯托曼传》以及 Linus 的自传《只是为了好玩儿》。</p>
<h3 id="systemd-简介"><a href="#systemd-简介" class="headerlink" title="systemd 简介"></a>systemd 简介</h3><p>讲完了 Linux 系统启动的流程，接下来就到了本文的主角 <code>systemd</code> 上场啦。剽窃一段 archlinux.org 上的文档来介绍一下 systemd 。（archlinux 的文档是做的最好的哦！</p>
<blockquote>
<p><em>systemd</em> 是一个 Linux 系统基础组件的集合，提供了一个系统和服务管理器，运行为 PID 1 并负责启动其它程序。功能包括：</p>
<ul>
<li>支持并行化任务；</li>
<li>同时采用 socket 式与 <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/D-Bus_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">D-Bus</a> 总线式激活服务；</li>
<li>按需启动守护进程（daemon）；</li>
<li>利用 Linux 的 <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/Cgroups">cgroups</a> 监视进程； # 本文开篇讲到的 systemctl 显示 CPU 和  Mem 信息就是基于此哦。</li>
<li>支持快照和系统恢复；</li>
<li>维护挂载点和自动挂载点；</li>
<li>各服务间基于依赖关系进行精密控制。</li>
<li>systemd* 支持 SysV 和 LSB 初始脚本，可以替代 sysvinit。</li>
<li>除此之外，功能还包括日志进程、控制基础系统配置，维护登陆用户列表以及系统账户、运行时目录和设置，可以运行容器和虚拟机，可以简单的管理网络配置、网络时间同步、日志转发和名称解析等。</li>
</ul>
</blockquote>
<p>还有一段摘自 <a target="_blank" rel="noopener" href="https://systemd.io/">systemd.io</a></p>
<blockquote>
<p>systemd is a suite of basic building blocks for a Linux system. It provides a system and service manager that runs as PID 1 and starts the rest of the system.</p>
<p>systemd provides aggressive parallelization capabilities, uses socket and D-Bus activation for starting services, offers on-demand starting of daemons, keeps track of processes using Linux control groups, maintains mount and automount points, and implements an elaborate transactional dependency-based service control logic. systemd supports SysV and LSB init scripts and works as a replacement for sysvinit.</p>
<p>Other parts include a logging daemon, utilities to control basic system configuration like the hostname, date, locale, maintain a list of logged-in users and running containers and virtual machines, system accounts, runtime directories and settings, and daemons to manage simple network configuration, network time synchronization, log forwarding, and name resolution.</p>
</blockquote>
<h3 id="systemd-设计目标"><a href="#systemd-设计目标" class="headerlink" title="systemd 设计目标"></a>systemd 设计目标</h3><ul>
<li>改进效能。使用二进制代码替换松散的 SYSV 启动脚本，减少频繁的进程创建，库加载，内核&#x2F;用户切换。</li>
<li>利用 Dbus 进程间通讯与 socket 激活机制，解决任务启动时的依赖问题，实现启动并行化。</li>
<li>实现任务（daemons）的精确控制。使用内核的 cgroup 机制，不依赖 pid 来追踪进程，即使是两次 fork 之后生成的守护进程也不会脱离 systemd 的控制。</li>
<li>统一任务定义。用户不需要自行编写 shell 脚本，而仅依据 systemd 制定的 unit 规则。</li>
</ul>
<h3 id="systemd-体系架构"><a href="#systemd-体系架构" class="headerlink" title="systemd 体系架构"></a>systemd 体系架构</h3><p><img data-src="https://p.k8s.li/systemd_components-svg.png"></p>
<ul>
<li>最底层：systemd 内核层面依赖 cgroup、autofs、kdbus</li>
<li>第二层：systemd libraries 是 systemd 依赖库</li>
<li>第三层：systemd Core 是 systemd 自己的库</li>
<li>第四层：systemd daemons 以及 targets 是自带的一些基本 unit、target，类似于 sysvinit 中自带的脚本</li>
<li>最上层就是和  systemd 交互的一些工具</li>
</ul>
<p><img data-src="https://p.k8s.li/linux_kernel_unified_hierarchy_cgroups_and_systemd-svg.png"></p>
<h3 id="systemd-unit"><a href="#systemd-unit" class="headerlink" title="systemd unit"></a>systemd unit</h3><p>systemd 将各种系统启动和运行相关的对象， 表示为各种不同类型的单元 <code>unit</code>， 并提供了 处理不同单元之间依赖关系的能力。</p>
<table>
<thead>
<tr>
<th align="center">type</th>
<th align="center">name</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Service unit</td>
<td align="center">.service</td>
<td align="left">用于封装一个后台服务进程</td>
</tr>
<tr>
<td align="center">Target unit</td>
<td align="center">.target</td>
<td align="left">用于将多个单元在逻辑上组合在一起。</td>
</tr>
<tr>
<td align="center">Device unit</td>
<td align="center">.device</td>
<td align="left">用于定义内核识别的设备，在 sysfs(5) 里面作为 udev(7) 设备树展示</td>
</tr>
<tr>
<td align="center">Socket unit</td>
<td align="center">.socket</td>
<td align="left">用于标识进程间通信用到的 socket 文件</td>
</tr>
<tr>
<td align="center">Snapshot unit</td>
<td align="center">.snapshot</td>
<td align="left">管理系统快照</td>
</tr>
<tr>
<td align="center">Swap unit</td>
<td align="center">.swap</td>
<td align="left">用于标识 swap 文件或设备</td>
</tr>
<tr>
<td align="center">Mount unit</td>
<td align="center">.mount</td>
<td align="left">用于封装一个文件系统挂载点(也向后兼容传统的 &#x2F;etc&#x2F;fstab 文件)</td>
</tr>
<tr>
<td align="center">Automount unit</td>
<td align="center">.automount</td>
<td align="left">用于封装一个文件系统自动挂载点</td>
</tr>
<tr>
<td align="center">Path unit</td>
<td align="center">.path</td>
<td align="left">用于根据文件系统上特定对象的变化来启动其他服务。</td>
</tr>
<tr>
<td align="center">Time unit</td>
<td align="center">.timer</td>
<td align="left">用于封装一个基于时间触发的动作。取代传统的 crond 等任务计划服务</td>
</tr>
<tr>
<td align="center">Slice unit</td>
<td align="center">*.slice</td>
<td align="left">用于控制特定 CGroup 内所有进程的总体资源占用。</td>
</tr>
</tbody></table>
<p>需要注意的是 systemd 只在内存中加载最小化的一组单元。 只有至少满足下列条件之一的单元，才会被加载到内存中：</p>
<ul>
<li>处于 活动(active)、启动中(activating)、停止中(deactivating)、失败(failed) 状态之一(也就是停止(inactive)之外的状态)</li>
<li>至少有一个作业正在作业队列中</li>
<li>至少有一个其他已经加载到内存中的单元依赖于它</li>
<li>仍然占有某些资源 (例如一个已停止的服务单元的进程忽略了终止请求，仍在逗留)</li>
<li>被 D-Bus 调用以程序化的方式固定到了内存中</li>
</ul>
<blockquote>
<p>只要有需要，systemd 就会自动从磁盘加载所需的单元。 因此实际上用户并不能显而易见的看到某个单元是否已被加载到内存。 使用 <strong>systemctl list-units –all</strong> 命令可以显示当前已加载到内存中的所有单元。 不满足加载条件(见上文)的单元会被立即从内存中卸载，并且它的记帐数据(accounting data)也会被清空。 不过，因为每当一个单元关闭时，都会生成一条日志记录声明该单元所消耗的资源， 所以这些数据通常不会彻底消失。</p>
</blockquote>
<h3 id="systemd-unit-配置文件"><a href="#systemd-unit-配置文件" class="headerlink" title="systemd unit 配置文件"></a>systemd unit 配置文件</h3><ul>
<li>在 CentOS&#x2F;RedHat 发行版中 <code>man systemd.unit</code></li>
</ul>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">Table 1.  Load path when running in system mode (--system).
┌────────────────────────┬─────────────────────────────┐
│Path                    │ Description                 │
├────────────────────────┼─────────────────────────────┤
│/etc/systemd/system     │ Local configuration         │
├────────────────────────┼─────────────────────────────┤
│/run/systemd/system     │ Runtime units               │
├────────────────────────┼─────────────────────────────┤
│/usr/lib/systemd/system │ Units of installed packages │
└────────────────────────┴─────────────────────────────┘<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>在 Ubuntu&#x2F;Debian 发行版中 <code>man systemd.unit</code></li>
</ul>
<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">Table 1.  Load path when running in system mode (--system).
┌────────────────────┬─────────────────────────────┐
│Path                │ Description                 │
├────────────────────┼─────────────────────────────┤
│/etc/systemd/system │ Local configuration         │
├────────────────────┼─────────────────────────────┤
│/run/systemd/system │ Runtime units               │
├────────────────────┼─────────────────────────────┤
│/lib/systemd/system │ Units of installed packages │
└────────────────────┴─────────────────────────────┘<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不同的发行版 systemd unit 的 path 不一样哦，不过 systemd 的配置文件主要位于以下三个目录中</p>
<ul>
<li><p><code>/usr/lib/systemd/system</code> 或 <code>/lib/systemd</code> : 使用包管理器安装的软件的 systemd unit 件实际配置文件的存放位置</p>
</li>
<li><p><code>/run/systemd/system</code>：在运行时创建的 s ystemd unit 文件。该目录优先于已安装服务单元文件的目录。</p>
<p><code>/etc/systemd/system</code>:  优先级最高，由 systemctl 命令创建的 systemd unit 文件以及为扩展服务而添加的 unit 文件都将启用。</p>
</li>
</ul>
<p>在使用 yum&#x2F;apt 或其他包管理器，以及 rpm&#x2F;deb 等软件包安装软件的时候，如果该软件支持 systemd 管理的话，就会自动在 <code>/usr/lib/systemd/system</code> 目录添加一个配置文件。可以用过  systemctl cat name 来查看该软件的  systemd 单元文件，比如查看一下 nginx 的 <code>nginx.service</code> 文件</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@sg-02 ~
╰─<span class="token comment"># systemctl cat nginx                                                                                         1 ↵</span>
<span class="token comment"># /lib/systemd/system/nginx.service</span>
<span class="token comment"># Stop dance for nginx</span>
<span class="token comment"># =======================</span>
<span class="token comment">#</span>
<span class="token comment"># ExecStop sends SIGSTOP (graceful stop) to the nginx process.</span>
<span class="token comment"># If, after 5s (--retry QUIT/5) nginx is still running, systemd takes control</span>
<span class="token comment"># and sends SIGTERM (fast shutdown) to the main process.</span>
<span class="token comment"># After another 5s (TimeoutStopSec=5), and if nginx is alive, systemd sends</span>
<span class="token comment"># SIGKILL to all the remaining processes in the process group (KillMode=mixed).</span>
<span class="token comment">#</span>
<span class="token comment"># nginx signals reference doc:</span>
<span class="token comment"># http://nginx.org/en/docs/control.html</span>
<span class="token comment">#</span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>A high performance web server and a reverse proxy server
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>man:nginx<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking
<span class="token assign-left variable">PIDFile</span><span class="token operator">=</span>/run/nginx.pid
<span class="token assign-left variable">ExecStartPre</span><span class="token operator">=</span>/usr/sbin/nginx <span class="token parameter variable">-t</span> <span class="token parameter variable">-q</span> <span class="token parameter variable">-g</span> <span class="token string">'daemon on; master_process on;'</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/sbin/nginx <span class="token parameter variable">-g</span> <span class="token string">'daemon on; master_process on;'</span>
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/usr/sbin/nginx <span class="token parameter variable">-g</span> <span class="token string">'daemon on; master_process on;'</span> <span class="token parameter variable">-s</span> reload
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>-/sbin/start-stop-daemon <span class="token parameter variable">--quiet</span> <span class="token parameter variable">--stop</span> <span class="token parameter variable">--retry</span> QUIT/5 <span class="token parameter variable">--pidfile</span> /run/nginx.pid
<span class="token assign-left variable">TimeoutStopSec</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token assign-left variable">KillMode</span><span class="token operator">=</span>mixed

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果软件没有自带 systemd 配置文件的话，我们可以自己搓一个配置文件出来，并复制到相应的目录下即可。比我我们的 <a target="_blank" rel="noopener" href="https://github.com/webp-sh/webp_server_go">Webp Server Go</a> 的 <code>webps.service</code></p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Unit</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Description</span><span class="token punctuation">=</span><span class="token value attr-value">WebP Server Go</span>
<span class="token key attr-name">Documentation</span><span class="token punctuation">=</span><span class="token value attr-value">https://github.com/webp-sh/webp_server_go</span>
<span class="token key attr-name">After</span><span class="token punctuation">=</span><span class="token value attr-value">nginx.target</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Service</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Type</span><span class="token punctuation">=</span><span class="token value attr-value">simple</span>
<span class="token key attr-name">StandardError</span><span class="token punctuation">=</span><span class="token value attr-value">journal</span>
<span class="token key attr-name">WorkingDirectory</span><span class="token punctuation">=</span><span class="token value attr-value">/opt/webps</span>
<span class="token key attr-name">ExecStart</span><span class="token punctuation">=</span><span class="token value attr-value">/opt/webps/webp-server --config /opt/webps/config.json</span>
<span class="token key attr-name">Restart</span><span class="token punctuation">=</span><span class="token value attr-value">always</span>
<span class="token key attr-name">RestartSec</span><span class="token punctuation">=</span><span class="token value attr-value">3s</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Install</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">WantedBy</span><span class="token punctuation">=</span><span class="token value attr-value">multi-user.target</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关于 systemd 的单元配置文件如何书写，因为根据不同的单元类型包含的配置项实在是巨多。不是三言两语就能讲清的，所以大家还是参考一下 systemd 的官方文档&#x2F;社区翻译文档。比如 <a target="_blank" rel="noopener" href="http://www.jinbuguo.com/systemd/systemd.index.html">systemd (简体中文)</a>。</p>
<h3 id="链接文件"><a href="#链接文件" class="headerlink" title="链接文件"></a>链接文件</h3><p>当我们使用 reboot 、poweroff 、shutdown 等命令的时候，其实并不是执行该命令本身，背后是调用的 systemctl 命令。systemctl 命令会将 reboot 这些命令作为 $1 参数传递进去。所以执行 reboot 和 systemctl reboot 本质上是一样的。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@gitlab /sbin
╰─<span class="token comment"># ls -alh /usr/bin /sbin /bin /usr/local/bin  | grep systemctl</span>
-rwxr-xr-x  <span class="token number">1</span> root root 179K Feb  <span class="token number">5</span> 01:07 systemctl
lrwxrwxrwx  <span class="token number">1</span> root root      <span class="token number">14</span> Feb  <span class="token number">5</span> 01:07 <span class="token function">halt</span> -<span class="token operator">></span> /bin/systemctl
lrwxrwxrwx  <span class="token number">1</span> root root      <span class="token number">14</span> Feb  <span class="token number">5</span> 01:07 poweroff -<span class="token operator">></span> /bin/systemctl
lrwxrwxrwx  <span class="token number">1</span> root root      <span class="token number">14</span> Feb  <span class="token number">5</span> 01:07 <span class="token function">reboot</span> -<span class="token operator">></span> /bin/systemctl
lrwxrwxrwx  <span class="token number">1</span> root root      <span class="token number">14</span> Feb  <span class="token number">5</span> 01:07 runlevel -<span class="token operator">></span> /bin/systemctl
lrwxrwxrwx  <span class="token number">1</span> root root      <span class="token number">14</span> Feb  <span class="token number">5</span> 01:07 <span class="token function">shutdown</span> -<span class="token operator">></span> /bin/systemctl
lrwxrwxrwx  <span class="token number">1</span> root root      <span class="token number">14</span> Feb  <span class="token number">5</span> 01:07 telinit -<span class="token operator">></span> /bin/systemctl<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>还有前文提到的有一点就是绝大多数使用 systemd 的发行版都设置了一个软连接，由 <code>/sbin/init -&gt; /lib/systemd/systemd</code>。另外在 <code>/etc/systemd</code> 下也有很多链接文件，感兴趣的可以去分析一下。</p>
<h3 id="systemd-启动流程"><a href="#systemd-启动流程" class="headerlink" title="systemd 启动流程"></a>systemd 启动流程</h3><p>回到 Linux 启动流程，当内核加载到内存中后开始执行 systemd 。根据 dmesg 的日志我们可以了解到 systemd 启动后执行了哪一些操作。</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token punctuation">[</span>    <span class="token number">2.516258</span><span class="token punctuation">]</span> Run <span class="token operator">/</span>sbin<span class="token operator">/</span>init as init process
<span class="token punctuation">[</span>    <span class="token number">3.992535</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> systemd <span class="token number">237</span> running in system mode<span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token operator">+</span>PAM <span class="token operator">+</span>AUDIT <span class="token operator">+</span>SELINUX <span class="token operator">+</span>IMA <span class="token operator">+</span>APPARMOR <span class="token operator">+</span>SMACK <span class="token operator">+</span>SYSVINIT <span class="token operator">+</span>UTMP <span class="token operator">+</span>LIBCRYPTSETUP <span class="token operator">+</span>GCRYPT <span class="token operator">+</span>GNUTLS <span class="token operator">+</span>ACL <span class="token operator">+</span>XZ <span class="token operator">+</span>LZ4 <span class="token operator">+</span>SECCOMP <span class="token operator">+</span>BLKID <span class="token operator">+</span>ELFUTILS <span class="token operator">+</span>KMOD <span class="token operator">-</span>IDN2 <span class="token operator">+</span>IDN <span class="token operator">-</span>PCRE2 <span class="token keyword">default</span><span class="token operator">-</span>hierarchy<span class="token operator">=</span>hybrid<span class="token punctuation">)</span>
<span class="token punctuation">[</span>    <span class="token number">4.002297</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Detected virtualization kvm<span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">4.004593</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Detected architecture x86<span class="token operator">-</span><span class="token number">64</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">4.031531</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Set hostname to <span class="token operator">&lt;</span>blog<span class="token operator">></span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">5.343604</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Reached target Swap<span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">5.355156</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Started Dispatch Password Requests to Console Directory Watch<span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">5.367360</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Created slice User <span class="token keyword">and</span> Session Slice<span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">5.379321</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Set up automount Arbitrary Executable File Formats File System Automount Point<span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">5.395189</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Started Forward Password Requests to Wall Directory Watch<span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">5.411078</span><span class="token punctuation">]</span> systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Reached target Local Encrypted Volumes<span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">5.644759</span><span class="token punctuation">]</span> EXT4<span class="token operator">-</span>fs <span class="token punctuation">(</span>sda1<span class="token punctuation">)</span><span class="token punctuation">:</span> re<span class="token operator">-</span>mounted<span class="token punctuation">.</span> Opts<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>    <span class="token number">5.702603</span><span class="token punctuation">]</span> RPC<span class="token punctuation">:</span> Registered named UNIX socket transport <span class="token keyword">module</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">5.704115</span><span class="token punctuation">]</span> RPC<span class="token punctuation">:</span> Registered udp transport <span class="token keyword">module</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">5.705318</span><span class="token punctuation">]</span> RPC<span class="token punctuation">:</span> Registered tcp transport <span class="token keyword">module</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">5.706573</span><span class="token punctuation">]</span> RPC<span class="token punctuation">:</span> Registered tcp NFSv4<span class="token number">.1</span> backchannel transport <span class="token keyword">module</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">5.825727</span><span class="token punctuation">]</span> Loading iSCSI transport <span class="token keyword">class</span> v2<span class="token number">.0</span><span class="token operator">-</span><span class="token number">870</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>    <span class="token number">5.912079</span><span class="token punctuation">]</span> iscsi<span class="token punctuation">:</span> registered transport <span class="token punctuation">(</span>tcp<span class="token punctuation">)</span>
<span class="token punctuation">[</span>    <span class="token number">5.942499</span><span class="token punctuation">]</span> systemd<span class="token operator">-</span>journald<span class="token punctuation">[</span><span class="token number">196</span><span class="token punctuation">]</span><span class="token punctuation">:</span> Received request to flush runtime journal from PID <span class="token number">1</span>
<span class="token punctuation">[</span>    <span class="token number">5.973269</span><span class="token punctuation">]</span> systemd<span class="token operator">-</span>journald<span class="token punctuation">[</span><span class="token number">196</span><span class="token punctuation">]</span><span class="token punctuation">:</span> File <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log<span class="token operator">/</span>journal<span class="token operator">/</span><span class="token number">7</span>bc72ce3e0aa559e38159aa4fa0547f9<span class="token operator">/</span>system<span class="token punctuation">.</span>journal corrupted <span class="token keyword">or</span> uncleanly shut down<span class="token punctuation">,</span> renaming <span class="token keyword">and</span> replacing<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>下面的图表解释了 这些具有特定含义的 target 单元之间的依赖关系 以及各自在启动流程中的位置。图中的箭头表示了单元之间的依赖关系与先后顺序， 整个图表按照自上而下的时间顺序执行。</p>
</blockquote>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">local</span><span class="token operator">-</span>fs<span class="token operator">-</span>pre<span class="token punctuation">.</span>target
            <span class="token operator">|</span>
            v
   <span class="token punctuation">(</span>various mounts <span class="token keyword">and</span>   <span class="token punctuation">(</span>various swap   <span class="token punctuation">(</span>various cryptsetup
    fsck services<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>     devices<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>        devices<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>       <span class="token punctuation">(</span>various low<span class="token operator">-</span>level   <span class="token punctuation">(</span>various low<span class="token operator">-</span>level
            <span class="token operator">|</span>                  <span class="token operator">|</span>                  <span class="token operator">|</span>             services<span class="token punctuation">:</span> udevd<span class="token punctuation">,</span>     API VFS mounts<span class="token punctuation">:</span>
            v                  v                  v             tmpfiles<span class="token punctuation">,</span> random     mqueue<span class="token punctuation">,</span> configfs<span class="token punctuation">,</span>
     <span class="token keyword">local</span><span class="token operator">-</span>fs<span class="token punctuation">.</span>target      swap<span class="token punctuation">.</span>target     cryptsetup<span class="token punctuation">.</span>target    seed<span class="token punctuation">,</span> sysctl<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>      debugfs<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
            <span class="token operator">|</span>                  <span class="token operator">|</span>                  <span class="token operator">|</span>                    <span class="token operator">|</span>                    <span class="token operator">|</span>
            \__________________<span class="token operator">|</span>_________________ <span class="token operator">|</span> <span class="token constant">`_______________</span>` <span class="token operator">|</span>____________________<span class="token operator">/</span>
                                                 \<span class="token operator">|/</span>
                                                  v
                                           sysinit<span class="token punctuation">.</span>target
                                                  <span class="token operator">|</span>
             <span class="token constant">`________________________________</span>` <span class="token operator">/|</span>\________________________________________
            <span class="token operator">/</span>                  <span class="token operator">|</span>                  <span class="token operator">|</span>                    <span class="token operator">|</span>                    \
            <span class="token operator">|</span>                  <span class="token operator">|</span>                  <span class="token operator">|</span>                    <span class="token operator">|</span>                    <span class="token operator">|</span>
            v                  v                  <span class="token operator">|</span>                    v                    v
        <span class="token punctuation">(</span>various           <span class="token punctuation">(</span>various               <span class="token operator">|</span>                <span class="token punctuation">(</span>various          rescue<span class="token punctuation">.</span>service
       timers<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>          paths<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>              <span class="token operator">|</span>               sockets<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>               <span class="token operator">|</span>
            <span class="token operator">|</span>                  <span class="token operator">|</span>                  <span class="token operator">|</span>                    <span class="token operator">|</span>                    v
            v                  v                  <span class="token operator">|</span>                    v             <span class="token operator">*</span>rescue<span class="token punctuation">.</span>target
      timers<span class="token punctuation">.</span>target      paths<span class="token punctuation">.</span>target             <span class="token operator">|</span>             sockets<span class="token punctuation">.</span>target
            <span class="token operator">|</span>                  <span class="token operator">|</span>                  <span class="token operator">|</span>                    <span class="token operator">|</span>
            v                  \_________________ <span class="token operator">|</span> <span class="token constant">`_______________</span>` <span class="token operator">/</span>
                                                 \<span class="token operator">|/</span>
                                                  v
                                            basic<span class="token punctuation">.</span>target
                                                  <span class="token operator">|</span>
             <span class="token constant">`________________________________</span>` <span class="token operator">/|</span>                                 emergency<span class="token punctuation">.</span>service
            <span class="token operator">/</span>                  <span class="token operator">|</span>                  <span class="token operator">|</span>                                         <span class="token operator">|</span>
            <span class="token operator">|</span>                  <span class="token operator">|</span>                  <span class="token operator">|</span>                                         v
            v                  v                  v                                <span class="token operator">*</span>emergency<span class="token punctuation">.</span>target
        display<span class="token operator">-</span>        <span class="token punctuation">(</span>various system    <span class="token punctuation">(</span>various system
    manager<span class="token punctuation">.</span>service         services           services<span class="token punctuation">)</span>
            <span class="token operator">|</span>             required <span class="token keyword">for</span>            <span class="token operator">|</span>
            <span class="token operator">|</span>            graphical UIs<span class="token punctuation">)</span>           v
            <span class="token operator">|</span>                  <span class="token operator">|</span>          <span class="token operator">*</span>multi<span class="token operator">-</span>user<span class="token punctuation">.</span>target
            <span class="token operator">|</span>                  <span class="token operator">|</span>                  <span class="token operator">|</span>
            \_________________ <span class="token operator">|</span> <span class="token constant">`_____________</span>` <span class="token operator">/</span>
                              \<span class="token operator">|/</span>
                               v
                  <span class="token operator">*</span>graphical<span class="token punctuation">.</span>target
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>systemd 执行的第一个目标是 <strong>default.target</strong>。但实际上 default.target 是指向 <strong>graphical.target</strong> 的软链接。Graphical.target 的实际位置是 <code>/usr/lib/systemd/system/graphical.target</code>。</li>
</ul>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">╭─root@ ~
╰─# cat /usr/lib/systemd/system/graphical.target
<span class="token comment">#  This file is part of systemd.</span>
<span class="token comment">#</span>
<span class="token comment">#  systemd is free software; you can redistribute it and/or modify it</span>
<span class="token comment">#  under the terms of the GNU Lesser General Public License as published by</span>
<span class="token comment">#  the Free Software Foundation; either version 2.1 of the License, or</span>
<span class="token comment">#  (at your option) any later version.</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Unit</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Description</span><span class="token punctuation">=</span><span class="token value attr-value">Graphical Interface</span>
<span class="token key attr-name">Documentation</span><span class="token punctuation">=</span><span class="token value attr-value">man:systemd.special(7)</span>
<span class="token key attr-name">Requires</span><span class="token punctuation">=</span><span class="token value attr-value">multi-user.target</span>
<span class="token key attr-name">Wants</span><span class="token punctuation">=</span><span class="token value attr-value">display-manager.service</span>
<span class="token key attr-name">Conflicts</span><span class="token punctuation">=</span><span class="token value attr-value">rescue.service rescue.target</span>
<span class="token key attr-name">After</span><span class="token punctuation">=</span><span class="token value attr-value">multi-user.target rescue.service rescue.target display-manager.service</span>
<span class="token key attr-name">AllowIsolate</span><span class="token punctuation">=</span><span class="token value attr-value">yes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>在 <strong>default.target</strong> 这个阶段，会启动 <strong>multi-user.target</strong> 而这个 target 将自己的子单元放在目录 <code>/etc/systemd/system/multi-user.target.wants</code> 里。这个 target 为多用户支持设定系统环境。非 root 用户会在这个阶段的引导过程中启用。防火墙相关的服务也会在这个阶段启动。<strong>multi-user.target</strong> 会将控制权交给另一层 <strong>basic.target</strong>。</li>
</ul>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">╭─root@docker-230 ~
╰─# cat /usr/lib/systemd/system/multi-user.target
<span class="token comment">#  This file is part of systemd.</span>
<span class="token comment">#</span>
<span class="token comment">#  systemd is free software; you can redistribute it and/or modify it</span>
<span class="token comment">#  under the terms of the GNU Lesser General Public License as published by</span>
<span class="token comment">#  the Free Software Foundation; either version 2.1 of the License, or</span>
<span class="token comment">#  (at your option) any later version.</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Unit</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Description</span><span class="token punctuation">=</span><span class="token value attr-value">Multi-User System</span>
<span class="token key attr-name">Documentation</span><span class="token punctuation">=</span><span class="token value attr-value">man:systemd.special(7)</span>
<span class="token key attr-name">Requires</span><span class="token punctuation">=</span><span class="token value attr-value">basic.target</span>
<span class="token key attr-name">Conflicts</span><span class="token punctuation">=</span><span class="token value attr-value">rescue.service rescue.target</span>
<span class="token key attr-name">After</span><span class="token punctuation">=</span><span class="token value attr-value">basic.target rescue.service rescue.target</span>
<span class="token key attr-name">AllowIsolate</span><span class="token punctuation">=</span><span class="token value attr-value">yes</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>basic.target</strong> 单元用于启动普通服务特别是图形管理服务。它通过 <code>/etc/systemd/system/basic.target.wants</code> 目录来决定哪些服务会被启动，<strong>basic.target</strong> 之后将控制权交给 <strong>sysinit.target</strong>.</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@docker-230 ~
╰─<span class="token comment"># tree /etc/systemd/system/multi-user.target.wants</span>
/etc/systemd/system/multi-user.target.wants
├── auditd.service -<span class="token operator">></span> /usr/lib/systemd/system/auditd.service
├── chronyd.service -<span class="token operator">></span> /usr/lib/systemd/system/chronyd.service
├── crond.service -<span class="token operator">></span> /usr/lib/systemd/system/crond.service
├── docker.service -<span class="token operator">></span> /usr/lib/systemd/system/docker.service
├── firewalld.service -<span class="token operator">></span> /usr/lib/systemd/system/firewalld.service
├── gitlab-runsvdir.service -<span class="token operator">></span> /usr/lib/systemd/system/gitlab-runsvdir.service
├── irqbalance.service -<span class="token operator">></span> /usr/lib/systemd/system/irqbalance.service
├── kdump.service -<span class="token operator">></span> /usr/lib/systemd/system/kdump.service
├── NetworkManager.service -<span class="token operator">></span> /usr/lib/systemd/system/NetworkManager.service
├── remote-fs.target -<span class="token operator">></span> /usr/lib/systemd/system/remote-fs.target
├── rhel-configure.service -<span class="token operator">></span> /usr/lib/systemd/system/rhel-configure.service
├── rsyslog.service -<span class="token operator">></span> /usr/lib/systemd/system/rsyslog.service
├── sshd.service -<span class="token operator">></span> /usr/lib/systemd/system/sshd.service
└── tuned.service -<span class="token operator">></span> /usr/lib/systemd/system/tuned.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><strong>sysinit.target</strong> 会启动重要的系统服务例如系统挂载，内存交换空间和设备，内核补充选项等等。sysinit.target 在启动过程中会传递给 <strong>local-fs.target</strong>。</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@docker-230 ~
╰─<span class="token comment"># tree /etc/systemd/system/basic.target.wants</span>
/etc/systemd/system/basic.target.wants
├── microcode.service -<span class="token operator">></span> /usr/lib/systemd/system/microcode.service
└── rhel-dmesg.service -<span class="token operator">></span> /usr/lib/systemd/system/rhel-dmesg.service

<span class="token number">0</span> directories, <span class="token number">2</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>local-fs.target</code>，这个 target 单元不会启动用户相关的服务，它只处理底层核心服务。这个 target 会根据 &#x2F;etc&#x2F;fstab 和 &#x2F;etc&#x2F;inittab 来执行相关操作。</li>
</ul>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini">╭─root@docker-230 ~
╰─# cat /usr/lib/systemd/system/sysinit.target
<span class="token comment">#  This file is part of systemd.</span>
<span class="token comment">#</span>
<span class="token comment">#  systemd is free software; you can redistribute it and/or modify it</span>
<span class="token comment">#  under the terms of the GNU Lesser General Public License as published by</span>
<span class="token comment">#  the Free Software Foundation; either version 2.1 of the License, or</span>
<span class="token comment">#  (at your option) any later version.</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Unit</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Description</span><span class="token punctuation">=</span><span class="token value attr-value">System Initialization</span>
<span class="token key attr-name">Documentation</span><span class="token punctuation">=</span><span class="token value attr-value">man:systemd.special(7)</span>
<span class="token key attr-name">Conflicts</span><span class="token punctuation">=</span><span class="token value attr-value">emergency.service emergency.target</span>
<span class="token key attr-name">Wants</span><span class="token punctuation">=</span><span class="token value attr-value">local-fs.target swap.target</span>
<span class="token key attr-name">After</span><span class="token punctuation">=</span><span class="token value attr-value">local-fs.target swap.target emergency.service emergency.target</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="进程树"><a href="#进程树" class="headerlink" title="进程树"></a>进程树</h3><p>我们使用 pstree 命令来看一哈进程树的状态，用户空间的进程都挂在  PID 为 1 的 systemd 下。由 systemd 来管理进程优点多多 😂</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@sg-02 ~
╰─<span class="token comment"># pstree -p</span>
systemd<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>─┬─accounts-daemon<span class="token punctuation">(</span><span class="token number">661</span><span class="token punctuation">)</span>─┬─<span class="token punctuation">&#123;</span>accounts-daemon<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">689</span><span class="token punctuation">)</span>
           │                      └─<span class="token punctuation">&#123;</span>accounts-daemon<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">729</span><span class="token punctuation">)</span>
           ├─agetty<span class="token punctuation">(</span><span class="token number">971</span><span class="token punctuation">)</span>
           ├─agetty<span class="token punctuation">(</span><span class="token number">992</span><span class="token punctuation">)</span>
           ├─aria2c<span class="token punctuation">(</span><span class="token number">1010</span><span class="token punctuation">)</span>
           ├─atd<span class="token punctuation">(</span><span class="token number">653</span><span class="token punctuation">)</span>
           ├─containerd<span class="token punctuation">(</span><span class="token number">2915</span><span class="token punctuation">)</span>─┬─<span class="token punctuation">&#123;</span>containerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">2928</span><span class="token punctuation">)</span>
           │                  ├─<span class="token punctuation">&#123;</span>containerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">2929</span><span class="token punctuation">)</span>
           │                  ├─<span class="token punctuation">&#123;</span>containerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">2930</span><span class="token punctuation">)</span>
           │                  ├─<span class="token punctuation">&#123;</span>containerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">2934</span><span class="token punctuation">)</span>
           │                  ├─<span class="token punctuation">&#123;</span>containerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">2935</span><span class="token punctuation">)</span>
           │                  ├─<span class="token punctuation">&#123;</span>containerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">2950</span><span class="token punctuation">)</span>
           │                  ├─<span class="token punctuation">&#123;</span>containerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">2951</span><span class="token punctuation">)</span>
           │                  ├─<span class="token punctuation">&#123;</span>containerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">2978</span><span class="token punctuation">)</span>
           │                  ├─<span class="token punctuation">&#123;</span>containerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">5360</span><span class="token punctuation">)</span>
           │                  └─<span class="token punctuation">&#123;</span>containerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">8299</span><span class="token punctuation">)</span>
           ├─cron<span class="token punctuation">(</span><span class="token number">639</span><span class="token punctuation">)</span>───cron<span class="token punctuation">(</span><span class="token number">20506</span><span class="token punctuation">)</span>───sh<span class="token punctuation">(</span><span class="token number">20507</span><span class="token punctuation">)</span>───monitor.sh<span class="token punctuation">(</span><span class="token number">20509</span><span class="token punctuation">)</span>───ffmpeg<span class="token punctuation">(</span><span class="token number">20514</span><span class="token punctuation">)</span>
           ├─dbus-daemon<span class="token punctuation">(</span><span class="token number">664</span><span class="token punctuation">)</span>
           ├─dockerd<span class="token punctuation">(</span><span class="token number">17771</span><span class="token punctuation">)</span>─┬─<span class="token punctuation">&#123;</span>dockerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">17783</span><span class="token punctuation">)</span>
           │                ├─<span class="token punctuation">&#123;</span>dockerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">17784</span><span class="token punctuation">)</span>
           │                ├─<span class="token punctuation">&#123;</span>dockerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">17785</span><span class="token punctuation">)</span>
           │                ├─<span class="token punctuation">&#123;</span>dockerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">17791</span><span class="token punctuation">)</span>
           │                ├─<span class="token punctuation">&#123;</span>dockerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">17793</span><span class="token punctuation">)</span>
           │                ├─<span class="token punctuation">&#123;</span>dockerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">17800</span><span class="token punctuation">)</span>
           │                ├─<span class="token punctuation">&#123;</span>dockerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">17803</span><span class="token punctuation">)</span>
           │                ├─<span class="token punctuation">&#123;</span>dockerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">3030</span><span class="token punctuation">)</span>
           │                └─<span class="token punctuation">&#123;</span>dockerd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">3031</span><span class="token punctuation">)</span>
           ├─fail2ban-server<span class="token punctuation">(</span><span class="token number">755</span><span class="token punctuation">)</span>─┬─<span class="token punctuation">&#123;</span>fail2ban-server<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">1059</span><span class="token punctuation">)</span>
           │                      └─<span class="token punctuation">&#123;</span>fail2ban-server<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">1060</span><span class="token punctuation">)</span>
           ├─iscsid<span class="token punctuation">(</span><span class="token number">896</span><span class="token punctuation">)</span>
           ├─iscsid<span class="token punctuation">(</span><span class="token number">897</span><span class="token punctuation">)</span>
           ├─lvmetad<span class="token punctuation">(</span><span class="token number">392</span><span class="token punctuation">)</span>
           ├─networkd-dispat<span class="token punctuation">(</span><span class="token number">622</span><span class="token punctuation">)</span>───<span class="token punctuation">&#123;</span>networkd-dispat<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">982</span><span class="token punctuation">)</span>
           ├─nginx<span class="token punctuation">(</span><span class="token number">3305</span><span class="token punctuation">)</span>───nginx<span class="token punctuation">(</span><span class="token number">17700</span><span class="token punctuation">)</span>
           ├─php-fpm7.2<span class="token punctuation">(</span><span class="token number">7497</span><span class="token punctuation">)</span>─┬─php-fpm7.2<span class="token punctuation">(</span><span class="token number">1295</span><span class="token punctuation">)</span>
           │                  ├─php-fpm7.2<span class="token punctuation">(</span><span class="token number">1296</span><span class="token punctuation">)</span>
           │                  └─php-fpm7.2<span class="token punctuation">(</span><span class="token number">5611</span><span class="token punctuation">)</span>
           ├─polkitd<span class="token punctuation">(</span><span class="token number">808</span><span class="token punctuation">)</span>─┬─<span class="token punctuation">&#123;</span>polkitd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">820</span><span class="token punctuation">)</span>
           │              └─<span class="token punctuation">&#123;</span>polkitd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">822</span><span class="token punctuation">)</span>
           ├─rngd<span class="token punctuation">(</span><span class="token number">981</span><span class="token punctuation">)</span>
           ├─rpcbind<span class="token punctuation">(</span><span class="token number">7125</span><span class="token punctuation">)</span>
           ├─rsyslogd<span class="token punctuation">(</span><span class="token number">11567</span><span class="token punctuation">)</span>─┬─<span class="token punctuation">&#123;</span>rsyslogd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">11598</span><span class="token punctuation">)</span>
           │                 ├─<span class="token punctuation">&#123;</span>rsyslogd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">11599</span><span class="token punctuation">)</span>
           │                 └─<span class="token punctuation">&#123;</span>rsyslogd<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">11600</span><span class="token punctuation">)</span>
           ├─ss-server<span class="token punctuation">(</span><span class="token number">17126</span><span class="token punctuation">)</span>───obfs-server<span class="token punctuation">(</span><span class="token number">17138</span><span class="token punctuation">)</span>
             ├─sshd<span class="token punctuation">(</span><span class="token number">5357</span><span class="token punctuation">)</span>─┬─sshd<span class="token punctuation">(</span><span class="token number">15490</span><span class="token punctuation">)</span>───sshd<span class="token punctuation">(</span><span class="token number">15598</span><span class="token punctuation">)</span>───zsh<span class="token punctuation">(</span><span class="token number">15619</span><span class="token punctuation">)</span>───pstree<span class="token punctuation">(</span><span class="token number">20539</span><span class="token punctuation">)</span>
           │            ├─sshd<span class="token punctuation">(</span><span class="token number">20413</span><span class="token punctuation">)</span>───sshd<span class="token punctuation">(</span><span class="token number">20414</span><span class="token punctuation">)</span>
           │            └─sshd<span class="token punctuation">(</span><span class="token number">20517</span><span class="token punctuation">)</span>
           ├─systemd<span class="token punctuation">(</span><span class="token number">5715</span><span class="token punctuation">)</span>───<span class="token punctuation">(</span>sd-pam<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">5718</span><span class="token punctuation">)</span>
           ├─systemd-journal<span class="token punctuation">(</span><span class="token number">12866</span><span class="token punctuation">)</span>
           ├─systemd-logind<span class="token punctuation">(</span><span class="token number">652</span><span class="token punctuation">)</span>
           ├─systemd-network<span class="token punctuation">(</span><span class="token number">12827</span><span class="token punctuation">)</span>
           ├─systemd-resolve<span class="token punctuation">(</span><span class="token number">12839</span><span class="token punctuation">)</span>
           ├─systemd-timesyn<span class="token punctuation">(</span><span class="token number">12852</span><span class="token punctuation">)</span>───<span class="token punctuation">&#123;</span>systemd-timesyn<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token number">12861</span><span class="token punctuation">)</span>
           └─systemd-udevd<span class="token punctuation">(</span><span class="token number">8171</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="管理-systemd"><a href="#管理-systemd" class="headerlink" title="管理 systemd"></a>管理 systemd</h2><p>讲完了 systemd 的基础知识，接下来就开始动手实践，控制 systemd 的主要命令主要有以下几种：</p>
<ul>
<li>systemctl 命令控制 <code>systemd</code> 的管理系统和服务的命令行工具</li>
<li>systemsdm 命令控制 <code>systemd</code> 的管理和服务的图形化工具</li>
<li>journalctl 命令查詢 <code>systemd</code> 日志系统</li>
<li>loginctl 命令控制 <code>systemd</code> 登入管理器</li>
<li>systemd-analyze 分析系统启动效能（类似开机时间？</li>
</ul>
<h3 id="systemctl-基本用法"><a href="#systemctl-基本用法" class="headerlink" title="systemctl 基本用法"></a>systemctl 基本用法</h3><h4 id="启动-x2F-重启-x2F-停止服务"><a href="#启动-x2F-重启-x2F-停止服务" class="headerlink" title="启动&#x2F;重启&#x2F;停止服务"></a>启动&#x2F;重启&#x2F;停止服务</h4><ul>
<li><code>systemctl start NAME</code></li>
<li><code>systemctl restart NAME</code></li>
<li><code>systemctl stop NAME</code></li>
</ul>
<h4 id="查看服务状态"><a href="#查看服务状态" class="headerlink" title="查看服务状态"></a>查看服务状态</h4><p>就如文章开头所提到的，需要注意的是最下面那种带时间戳的是输出的日志</p>
<ul>
<li><code>systemctl status NAME</code></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@blog /home/ubuntu
╰─<span class="token comment"># systemctl status webps                                                                                    130 ↵</span>
● webps.service - WebP Server
   Loaded: loaded <span class="token punctuation">(</span>/opt/webps/webps.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Wed <span class="token number">2020</span>-03-18 <span class="token number">13</span>:58:00 UTC<span class="token punctuation">;</span> 22h ago
     Docs: https://github.com/n0vad3v/webp_server_go
 Main PID: <span class="token number">5732</span> <span class="token punctuation">(</span>webp-server<span class="token punctuation">)</span>
    Tasks: <span class="token number">52</span> <span class="token punctuation">(</span>limit: <span class="token number">684</span><span class="token punctuation">)</span>
   Memory: <span class="token number">185</span>.2M
      CPU: 1min <span class="token number">30</span>.092s
   CGroup: /system.slice/webps.service
           └─5732 /opt/webps/webp-server <span class="token parameter variable">--config</span> /opt/webps/config.json

Mar <span class="token number">19</span> 05:23:20 blog webp-server<span class="token punctuation">[</span><span class="token number">5732</span><span class="token punctuation">]</span>: Save to exhaushttps://p.k8s.li/20200109192923891.png.1584538399.webp ok<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="列出所有单元："><a href="#列出所有单元：" class="headerlink" title="列出所有单元："></a>列出所有单元：</h4><ul>
<li><code>systemctl list-unit-files</code></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@docker-230 ~
╰─<span class="token comment"># systemctl list-unit-files</span>
UNIT FILE                                     STATE
proc-sys-fs-binfmt_misc.automount             static
dev-hugepages.mount                           static
dev-mqueue.mount                              static<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="列出激活的单元"><a href="#列出激活的单元" class="headerlink" title="列出激活的单元"></a>列出激活的单元</h4><ul>
<li><code>systemctl list-units</code> 等同于 <code>systemctl</code></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@docker-230 ~
╰─<span class="token comment"># systemctl list-units                                                                                      127 ↵</span>
  UNIT                                         LOAD   ACTIVE SUB       DESCRIPTION
  proc-sys-fs-binfmt_misc.automount            loaded active waiting   Arbitrary Executable File Formats File System
  sys-devices-pci0000:00-0000:00:15.0-0000:03:00.0-host2-target2:0:0-2:0:0:0-block-sda-sda1.device loaded active plu
  sys-devices-pci0000:00-0000:00:15.0-0000:03:00.0-host2-target2:0:0-2:0:0:0-block-sda-sda2.device loaded active plu<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="重新载入-systemd，扫描新的或有变动的单元："><a href="#重新载入-systemd，扫描新的或有变动的单元：" class="headerlink" title="重新载入 systemd，扫描新的或有变动的单元："></a>重新载入 systemd，扫描新的或有变动的单元：</h4><p>当向 systemd 的目录中添加显得 unit 文件后需要 reload 一下才能生效</p>
<ul>
<li><code>systemctl daemon-reload</code></li>
</ul>
<h4 id="查询服务是否开机启动"><a href="#查询服务是否开机启动" class="headerlink" title="查询服务是否开机启动"></a>查询服务是否开机启动</h4><ul>
<li><code>systemctl is-enabled crond</code></li>
</ul>
<h4 id="设置-x2F-取消服务开机自启"><a href="#设置-x2F-取消服务开机自启" class="headerlink" title="设置&#x2F;取消服务开机自启"></a>设置&#x2F;取消服务开机自启</h4><ul>
<li><code>systemctl enable NAME</code></li>
<li><code>systemctl disable NAME</code></li>
</ul>
<h4 id="远程控制其他服务器的-systemd"><a href="#远程控制其他服务器的-systemd" class="headerlink" title="远程控制其他服务器的 systemd"></a>远程控制其他服务器的 systemd</h4><p><code>systemctl</code> 参数中添加 <code>-H &lt;用户名&gt;@&lt;主机名&gt;</code> 可以实现对其他机器的远程控制，该功能使用 <a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/SSH_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">SSH</a> 连接。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@blog /home/ubuntu
╰─<span class="token comment"># systemctl status nginx -H sg2</span>
● nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded <span class="token punctuation">(</span>/lib/systemd/system/nginx.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Mon <span class="token number">2020</span>-02-17 08:41:11 UTC<span class="token punctuation">;</span> <span class="token number">1</span> months <span class="token number">0</span> days ago
     Docs: man:nginx<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
 Main PID: <span class="token number">3305</span>
    Tasks: <span class="token number">2</span> <span class="token punctuation">(</span>limit: <span class="token number">1152</span><span class="token punctuation">)</span>
   CGroup: /system.slice/nginx.service
           ├─ <span class="token number">3305</span> nginx: master process /usr/sbin/nginx <span class="token parameter variable">-g</span> daemon on<span class="token punctuation">;</span> master_process on<span class="token punctuation">;</span>
           └─17700 nginx: worker process<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="使用-systemctl-命令杀死服务"><a href="#使用-systemctl-命令杀死服务" class="headerlink" title="使用 systemctl 命令杀死服务"></a>使用 systemctl 命令杀死服务</h4><ul>
<li><code>systemctl kill NAME</code></li>
</ul>
<h3 id="journal"><a href="#journal" class="headerlink" title="journal"></a>journal</h3><p>systemd 的第二个主要部分是 journal 日志系统，类似于 syslog 但也有些显著区别。如果你喜欢用 <code>sed 、grep 、awk</code> 三剑客来处理日志，那么当你面对 journal 日志系统的时候你就准备<strong>掀桌儿</strong>吧！因为这是个二进制日志，无法使用常规的命令行文本处理工具来解析它 😂</p>
<h3 id="systemd-analyze"><a href="#systemd-analyze" class="headerlink" title="systemd-analyze"></a>systemd-analyze</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@docker-230 ~
╰─<span class="token comment"># systemd-analyze</span>
Startup finished <span class="token keyword">in</span> 489ms <span class="token punctuation">(</span>kernel<span class="token punctuation">)</span> + <span class="token number">1</span>.547s <span class="token punctuation">(</span>initrd<span class="token punctuation">)</span> + <span class="token number">10</span>.333s <span class="token punctuation">(</span>userspace<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">12</span>.369s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="推荐-x2F-参考"><a href="#推荐-x2F-参考" class="headerlink" title="推荐&#x2F;参考"></a>推荐&#x2F;参考</h2><h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/systemd/systemd">github.com&#x2F;systemd&#x2F;systemd</a></li>
<li><a target="_blank" rel="noopener" href="https://systemd.io/">systemd.io</a></li>
</ul>
<h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><ul>
<li><a target="_blank" rel="noopener" href="http://www.jinbuguo.com/systemd/systemd.exec.html">systemd.exec 中文手册</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.archlinux.org/index.php/systemd_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87)">systemd (简体中文)</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.debian.org/systemd">wiki.debian.org&#x2F;systemd</a></li>
<li><a target="_blank" rel="noopener" href="https://www.debian.org/doc/manuals/debian-reference/ch03.zh-tw.html">第 3 章 系統初始化</a></li>
<li><a target="_blank" rel="noopener" href="https://openwrt.org/docs/techref/architecture">OpenWrt – operating system architecture</a></li>
<li><a target="_blank" rel="noopener" href="http://manpages.ubuntu.com/manpages/cosmic/zh_CN/man7/bootup.7.html">bootup - 系统启动流程</a></li>
<li><a target="_blank" rel="noopener" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/chap-managing_services_with_systemd">CHAPTER 10. MANAGING SERVICES WITH SYSTEMD</a></li>
</ul>
<h3 id="博客"><a href="#博客" class="headerlink" title="博客"></a>博客</h3><ul>
<li><a target="_blank" rel="noopener" href="https://coolshell.cn/articles/17998.html">LINUX PID 1 和 SYSTEMD</a> 耗子的博客，必须墙裂推荐阅读哈，其他的可以不读，但这一篇博客必须要读哦 ：）</li>
<li><a target="_blank" rel="noopener" href="https://lp007819.wordpress.com/2015/01/11/systemd%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/">systemd 的一些总结</a></li>
<li><a target="_blank" rel="noopener" href="https://linux.cn/article-5457-1.html">走进 Linux 之 systemd 启动过程</a></li>
<li><a target="_blank" rel="noopener" href="https://hotttao.github.io/2018/08/03/linux_mt/14-Linux%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%8F%8A%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%AE%A1%E7%90%86/CentOS7-Systemd%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">13.3 Centos7 Systemd 启动流程</a></li>
<li><a target="_blank" rel="noopener" href="https://www.itwire.com/business-it-news/open-source/65402-torvalds-says-he-has-no-strong-opinions-on-systemd">Torvalds says he has no strong opinions on systemd</a></li>
<li><a target="_blank" rel="noopener" href="http://0pointer.de/blog/projects/systemd.html">Rethinking PID 1</a></li>
<li><a target="_blank" rel="noopener" href="http://0pointer.de/blog/projects/the-biggest-myths.html">The Biggest Myths</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bennythink.com/linux-keep-running.html">Linux 怎么让程序持续运行：简单说说几种好玩的办法</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bennythink.com/systemd-accounting.html">systemd – systemctl 不显示内存 CPU 信息</a></li>
<li><a target="_blank" rel="noopener" href="https://lp007819.wordpress.com/2015/01/17/systemd-journal-%E4%BB%8B%E7%BB%8D/">systemd journal 介绍</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.lujun9972.win/blog/2018/08/08/%E4%BD%BF%E7%94%A8journalctl%E6%9F%A5%E7%9C%8Bsystemd%E6%97%A5%E5%BF%97/index.html">使用 journalctl 查看 systemd 日志</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.lujun9972.win/blog/2019/11/30/%E5%A6%82%E4%BD%95%E9%98%B2%E6%AD%A2%E6%84%8F%E5%A4%96%E9%87%8D%E5%90%AFlinux(%E5%9F%BA%E4%BA%8Esystemd)/index.html">如何防止意外重启 Linux(基于 systemd)</a></li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linux/" rel="tag"># Linux</a>
              <a href="/tags/blog/" rel="tag"># blog</a>
              <a href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag"># 笔记</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/N1-openwrt.html" rel="prev" title="N1 盒子刷入 OpenWrt 并部署 K3s">
                  <i class="fa fa-chevron-left"></i> N1 盒子刷入 OpenWrt 并部署 K3s
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/cloudflare-worker-build-mirror-website.html" rel="next" title="使用 CloudFlare Workers 搭建 telegram 频道镜像站">
                  使用 CloudFlare Workers 搭建 telegram 频道镜像站 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.8m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">26:45</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
