<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.2.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言如果你的 FastDFS 文件系统需要高可用，需要部署在多台机器上的话，并且你的这些服务器上只跑 FastDFS 这个服务，那么 FastDFS 可能并不适合用 Docker 来部署，按照官方文档直接部署在机器上就可以，没必要采用容器来部署。其实 FastDFS 并不适合容器化部署，因为 tracker 服务器向 storage 服务器报告自己的 IP， 而这个 IP 是容器内的 IP 。是">
<meta property="og:type" content="blog">
<meta property="og:title" content="Docker 部署 FastDFS">
<meta property="og:url" content="https://blog.k8s.li/docker-deploy-fastdfs.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="前言如果你的 FastDFS 文件系统需要高可用，需要部署在多台机器上的话，并且你的这些服务器上只跑 FastDFS 这个服务，那么 FastDFS 可能并不适合用 Docker 来部署，按照官方文档直接部署在机器上就可以，没必要采用容器来部署。其实 FastDFS 并不适合容器化部署，因为 tracker 服务器向 storage 服务器报告自己的 IP， 而这个 IP 是容器内的 IP 。是">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/1569728664464.png">
<meta property="og:image" content="https://p.k8s.li/1569728744655.png">
<meta property="og:image" content="https://p.k8s.li/1569729043301.png">
<meta property="og:image" content="https://p.k8s.li/1564128425387.png">
<meta property="og:image" content="https://p.k8s.li/1564128874832.png">
<meta property="og:image" content="https://p.k8s.li/1564128721547.png">
<meta property="og:image" content="https://p.k8s.li/1564364594777.png">
<meta property="og:image" content="https://p.k8s.li/1564127683217.png">
<meta property="og:image" content="https://p.k8s.li/1564364294952.png">
<meta property="og:image" content="https://p.k8s.li/1564365025177.png">
<meta property="og:image" content="https://p.k8s.li/1564363829960.png">
<meta property="og:image" content="https://p.k8s.li/1564125161155.png">
<meta property="og:image" content="https://p.k8s.li/1564130238346.png">
<meta property="og:image" content="https://p.k8s.li/1564130789416.png">
<meta property="og:image" content="https://p.k8s.li/1564023927851.png">
<meta property="og:image" content="https://p.k8s.li/1564384530137.png">
<meta property="og:image" content="https://p.k8s.li/1564384711746.png">
<meta property="og:image" content="https://p.k8s.li/1564384906456.png">
<meta property="article:published_time" content="2019-09-24T16:00:00.000Z">
<meta property="article:modified_time" content="2022-05-30T14:40:01.914Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="FastDFS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/1569728664464.png">


<link rel="canonical" href="https://blog.k8s.li/docker-deploy-fastdfs.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/docker-deploy-fastdfs.html","path":"docker-deploy-fastdfs.html","title":"Docker 部署 FastDFS"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Docker 部署 FastDFS | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA-docker-%E9%95%9C%E5%83%8F"><span class="nav-number">2.</span> <span class="nav-text">构建 docker 镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.1.</span> <span class="nav-text">准备配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">2.2.</span> <span class="nav-text">修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile"><span class="nav-number">2.3.</span> <span class="nav-text">Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E4%B8%8D%E5%90%8C%E5%9F%BA%E7%A1%80%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA%E5%87%BA%E7%9A%84%E5%A4%A7%E5%B0%8F%E5%AF%B9%E6%AF%94"><span class="nav-number">2.4.</span> <span class="nav-text">构不同基础镜像构建出的大小对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#musl-libc-%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">2.5.</span> <span class="nav-text">musl libc 带来的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E5%90%AF%E5%8A%A8%E6%96%B9%E6%B3%95"><span class="nav-number">2.6.</span> <span class="nav-text">容器启动方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">3.</span> <span class="nav-text">测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7"><span class="nav-number">3.1.</span> <span class="nav-text">测试工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%B5%8B%E8%AF%95"><span class="nav-number">3.2.</span> <span class="nav-text">文件上传测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%B5%8B%E8%AF%95"><span class="nav-number">3.3.</span> <span class="nav-text">文件下载测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="nav-number">3.4.</span> <span class="nav-text">测试结果分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E5%8F%82%E6%95%B0"><span class="nav-number">4.</span> <span class="nav-text">优化参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="nav-number">5.</span> <span class="nav-text">常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E7%9B%B8%E5%85%B3"><span class="nav-number">5.1.</span> <span class="nav-text">安全相关</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">116</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">151</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail → mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/docker-deploy-fastdfs.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Docker 部署 FastDFS | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Docker 部署 FastDFS
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-09-25 2019-09-25T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2019-09-25T00:00:00+08:00">2019-09-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-05-30 2022-05-30T22:40:01+08:00" itemprop="dateModified" datetime="2022-05-30T22:40:01+08:00">2022-05-30</time>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/docker-deploy-fastdfs.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="docker-deploy-fastdfs.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>如果你的 FastDFS 文件系统需要高可用，需要部署在多台机器上的话，并且你的这些服务器上只跑 FastDFS 这个服务，那么 FastDFS 可能并不适合用 Docker 来部署，按照官方文档直接部署在机器上就可以，没必要采用容器来部署。其实 FastDFS 并不适合容器化部署，因为 tracker 服务器向 storage 服务器报告自己的 IP， 而这个 IP 是容器内的 IP 。是 Docker 的一个私有 IP 段，这将导致客户端无法访问 storage 服务器。当然如果使用 host 网络或者能打通客户端到 storage 的网络解决方案，比如 flannel ，calico 等，这都可以，在 Kubernetes 基于服务发现，客户端也可以访问到 storage 服务器。</p>
<p>那么 FastDFS 采用 Docker 部署适用于什么场景呢？其实比较适合中小型的项目，对高可用，高性能要求不大的情况下。或者将 FastDFS 所有的服务封装在一个容器里运行，和其他服务一起使用 docker-compose 启动，这样用再适合不过了。我的项目就是这种场景，由于服务器资源有限，不可能去单独部署一个 FastDFS 服务器集群，巴拉巴拉整个高可用。所有的项目组件都采用 Docker 部署在一台机器上，FastDFS 里的  nginx 也是没有单独去部署，和 tracker、storage 服务器一起装在一个容器里。为了节省资源没得办法 😂</p>
<h2 id="构建-docker-镜像"><a href="#构建-docker-镜像" class="headerlink" title="构建 docker 镜像"></a>构建 docker 镜像</h2><p>官方给出了两种构建 docker 镜像的方式，但是我感觉都不好，一是使用的 的是 centos 基础镜像构建，构建出来的大小将近，根本就不用区分本地构建或者网络构建。你构建的整个过程都要都需要连接外网下载构建的包之类的，还用区分什么网络构建和本地构建？所以在这里我们仅仅需要准备配置文件即可。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"> ╭─root@docker-230 ~/root/container/fastdfs/fastdfs/docker/dockerfile_network ‹master›
╰─<span class="token comment"># docker images</span>
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
fastdfs             centos              c1488537c23c        <span class="token number">8</span> seconds ago       483MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="准备配置文件"><a href="#准备配置文件" class="headerlink" title="准备配置文件"></a>准备配置文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 将所有的配置文件一并放到 conf 目录下</span>
<span class="token builtin class-name">cd</span> ~
<span class="token function">mkdir</span>  -p fastdfs/conf
<span class="token function">git</span> clone https://github.com/happyfish100/fastdfs.git --depth <span class="token number">1</span>
<span class="token function">cp</span> -rf fastdfs/docker/dockerfile_local/conf/* conf
<span class="token function">cp</span> fastdfs/docker/dockerfile_local/fastdfs.sh conf
<span class="token function">touch</span> Dockerfile.debian
<span class="token function">touch</span> Dockerfile.alpine
<span class="token comment"># 复制出来配置文件，把源码移除掉就可以</span>
<span class="token function">rm</span> -rf fastdfs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>所有的配置文件都在 conf 里，我们根据自身的需要修改一下各个配置文件即可，关于 fastdfs 配置文件的各个参数可以去参考一下下面的博客。</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chiangchou/p/fastdfs.html">用 FastDFS 一步步搭建文件管理系统</a></li>
<li><a target="_blank" rel="noopener" href="https://mhl.xyz/Linux/fastdfs-tracker-storage.html">FastDFS 配置参数 tracker.conf、storage.conf 详解</a></li>
</ul>
<p>我修改了默认的配置，数据存放目录修改成了 <code>/var/fdfs</code> ,在写 <code>Dockerfile</code> 的时候需要建立这个目录，如果你的目录没有修改的话，就把 Dockerfile 里后面那里建立文件夹的路径修改成默认的即可。</p>
<p>把 <code>tracker_server</code> 修改成 <code>tracker_server=tracker_ip:22122</code> ，容器启动的时候使用环境变量注入的 <code>FASTDFS_IPADDR</code> 替换掉就可以。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@debian-deploy-132 ~/fastdfs/conf
╰─<span class="token comment"># tree</span>
<span class="token builtin class-name">.</span>
├── client.conf             <span class="token comment"># C 语言版本客户端配置文件，可以忽略</span>
├── fastdfs.sh              <span class="token comment"># docker 容器启动 fastdfs 服务的脚本</span>
├── http.conf               <span class="token comment"># http 配置文件，参考官方文档</span>
├── mime.types              <span class="token comment">#</span>
├── mod_fastdfs.conf        <span class="token comment"># fastdfs nginx 模块配置文件</span>
├── nginx.conf              <span class="token comment"># nginx 配置文件，根据自身项目修改</span>
├── storage.conf            <span class="token comment"># storage 服务配置文件</span>
└── tracker.conf            <span class="token comment"># tracker 服务配置文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="tracker-服务配置文件-tracker-conf"><a href="#tracker-服务配置文件-tracker-conf" class="headerlink" title="tracker 服务配置文件 tracker.conf"></a>tracker 服务配置文件 tracker.conf</h4><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token key attr-name">disabled</span><span class="token punctuation">=</span><span class="token value attr-value">false                #启用配置文件</span>
<span class="token key attr-name">port</span><span class="token punctuation">=</span><span class="token value attr-value">22122                    #设置tracker的端口号</span>
<span class="token key attr-name">base_path</span><span class="token punctuation">=</span><span class="token value attr-value">/var/dfs           #设置tracker的数据文件和日志目录（需预先创建）</span>
<span class="token key attr-name">http.server_port</span><span class="token punctuation">=</span><span class="token value attr-value">28080         #设置http端口号</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="storage-服务配置文件-storage-ids-conf"><a href="#storage-服务配置文件-storage-ids-conf" class="headerlink" title="storage 服务配置文件 storage_ids.conf"></a>storage 服务配置文件 storage_ids.conf</h4><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># storage服务端口</span>
<span class="token key attr-name">port</span><span class="token punctuation">=</span><span class="token value attr-value">23000                         # 监听端口号</span>
<span class="token key attr-name">base_path</span><span class="token punctuation">=</span><span class="token value attr-value">/var/dfs                # 数据和日志文件存储根目录</span>
<span class="token key attr-name">store_path0</span><span class="token punctuation">=</span><span class="token value attr-value">/var/dfs              # 第一个存储目录</span>
<span class="token key attr-name">tracker_server</span><span class="token punctuation">=</span><span class="token value attr-value">tracker_ip:22122    # tracker服务器IP和端口</span>
<span class="token key attr-name">http.server_port</span><span class="token punctuation">=</span><span class="token value attr-value">28888</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="nginx-配置文件-nginx-conf"><a href="#nginx-配置文件-nginx-conf" class="headerlink" title="nginx 配置文件 nginx.conf"></a>nginx 配置文件 nginx.conf</h4><pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># 在 nginx 配置文件中添加修改下面这段</span>
<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">28888</span></span><span class="token punctuation">;</span>    <span class="token comment">## 该端口为storage.conf中的http.server_port相同</span>
    <span class="token directive"><span class="token keyword">server_name</span>  localhost</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> ~/group[0-9]/</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">ngx_fastdfs_module</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token directive"><span class="token keyword">error_page</span>   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  /50x.html</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">location</span> = /50x.html</span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">root</span>   html</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="nginx-模块配置文件-mod-fastdfs-conf"><a href="#nginx-模块配置文件-mod-fastdfs-conf" class="headerlink" title="nginx 模块配置文件 mod_fastdfs.conf"></a>nginx 模块配置文件 mod_fastdfs.conf</h4><pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token key attr-name">tracker_server</span><span class="token punctuation">=</span><span class="token value attr-value">tracker_ip:22122   # tracker服务器IP和端口</span>
<span class="token key attr-name">url_have_group_name</span><span class="token punctuation">=</span><span class="token value attr-value">true             # url 中包含 group 的名称</span>
<span class="token key attr-name">store_path0</span><span class="token punctuation">=</span><span class="token value attr-value">/var/dfs                # 数据和日志文件存储根目录</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="fastdfs-服务的脚本-fastdfs-sh"><a href="#fastdfs-服务的脚本-fastdfs-sh" class="headerlink" title="fastdfs 服务的脚本 fastdfs.sh"></a>fastdfs 服务的脚本 fastdfs.sh</h4><p>官方的脚本写的很随意，我就修改了一哈，不修改按照官方的来也 ok</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token assign-left variable">new_val</span><span class="token operator">=</span><span class="token variable">$FASTDFS_IPADDR</span>
<span class="token assign-left variable">old</span><span class="token operator">=</span><span class="token string">"tracker_ip"</span>

<span class="token function">sed</span> -i <span class="token string">"s/<span class="token variable">$old</span>/<span class="token variable">$new_val</span>/g"</span> /etc/fdfs/storage.conf
<span class="token function">sed</span> -i <span class="token string">"s/<span class="token variable">$old</span>/<span class="token variable">$new_val</span>/g"</span> /etc/fdfs/mod_fastdfs.conf

<span class="token builtin class-name">echo</span> <span class="token string">"start trackerd"</span>
/etc/init.d/fdfs_trackerd start

<span class="token builtin class-name">echo</span> <span class="token string">"start storage"</span>
/etc/init.d/fdfs_storaged start

<span class="token builtin class-name">echo</span> <span class="token string">"start nginx"</span>
/usr/local/nginx/sbin/nginx

<span class="token function">tail</span> -f  /dev/null<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="把-bash-替换成-sh"><a href="#把-bash-替换成-sh" class="headerlink" title="把 bash 替换成 sh"></a>把 bash 替换成 sh</h4><p>其实这一步骤可以不做，使用 bash 启动的话，需要在 alpine 安装 bash ，会增加 6MB 左右的镜像大小，感觉也没必要这样做 😂</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> -i <span class="token string">'s/bash/sh/g'</span> <span class="token variable"><span class="token variable">`</span><span class="token function">grep</span> -nr <span class="token function">bash</span> <span class="token operator">|</span> <span class="token function">awk</span> -F <span class="token string">':'</span> <span class="token string">'&#123;print $1&#125;'</span><span class="token variable">`</span></span>

<span class="token comment"># 替换后</span>
<span class="token function">grep</span> -nr <span class="token punctuation">\</span>#<span class="token punctuation">\</span><span class="token operator">!</span><span class="token punctuation">\</span>/bin<span class="token punctuation">\</span>/sh
stop.sh:1:<span class="token comment">#!/bin/sh</span>
init.d/fdfs_storaged:1:<span class="token comment">#!/bin/sh</span>
init.d/fdfs_trackerd:1:<span class="token comment">#!/bin/sh</span>
conf/fastdfs.sh:1:<span class="token comment">#!/bin/sh</span>
restart.sh:1:<span class="token comment">#!/bin/sh</span>
docker/dockerfile_local/fastdfs.sh:1:<span class="token comment">#!/bin/sh</span>
docker/dockerfile_network/fastdfs.sh:1:<span class="token comment">#!/bin/sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><h4 id="alpine-3-10"><a href="#alpine-3-10" class="headerlink" title="alpine:3.10"></a>alpine:3.10</h4><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> alpine:3.10</span>

<span class="token instruction"><span class="token keyword">COPY</span> conf/ /home</span>
<span class="token instruction"><span class="token keyword">RUN</span> set -xe <span class="token operator">\</span>
    &amp;&amp; echo <span class="token string">"http://mirrors.aliyun.com/alpine/latest-stable/main/"</span> > /etc/apk/repositories <span class="token operator">\</span>
    &amp;&amp; echo <span class="token string">"http://mirrors.aliyun.com/alpine/latest-stable/community/"</span> >> /etc/apk/repositories <span class="token operator">\</span>
    &amp;&amp; apk update <span class="token operator">\</span>
    &amp;&amp; apk add --no-cache --virtual .build-deps alpine-sdk gcc libc-dev make perl-dev openssl-dev pcre-dev zlib-dev tzdata <span class="token operator">\</span>
    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span class="token operator">\</span>
    &amp;&amp; echo <span class="token string">"Asia/Shanghai"</span> > /etc/timezone <span class="token operator">\</span>
    &amp;&amp; mkdir -p /usr/local/src <span class="token operator">\</span>
    &amp;&amp; cd /usr/local/src <span class="token operator">\</span>
    &amp;&amp; git clone https://github.com/happyfish100/libfastcommon.git --depth 1 <span class="token operator">\</span>
    &amp;&amp; git clone https://github.com/happyfish100/fastdfs.git --depth 1    <span class="token operator">\</span>
    &amp;&amp; git clone https://github.com/happyfish100/fastdfs-nginx-module.git --depth 1  <span class="token operator">\</span>
    &amp;&amp; wget http://nginx.org/download/nginx-1.15.4.tar.gz <span class="token operator">\</span>
    &amp;&amp; tar -xf nginx-1.15.4.tar.gz <span class="token operator">\</span>
    &amp;&amp; cd /usr/local/src/libfastcommon <span class="token operator">\</span>
    &amp;&amp; sed -i <span class="token string">'s/sys\/poll\.h/poll\.h/g'</span> src/sockopt.c <span class="token operator">\</span>
    &amp;&amp; ./make.sh <span class="token operator">\</span>
    &amp;&amp; ./make.sh install <span class="token operator">\</span>
    &amp;&amp; cd /usr/local/src/fastdfs/ <span class="token operator">\</span>
    &amp;&amp; ./make.sh <span class="token operator">\</span>
    &amp;&amp; ./make.sh install <span class="token operator">\</span>
    &amp;&amp; cd /usr/local/src/nginx-1.15.4/ <span class="token operator">\</span>
    &amp;&amp; ./configure --add-module=/usr/local/src/fastdfs-nginx-module/src/ <span class="token operator">\</span>
    &amp;&amp; make &amp;&amp; make install <span class="token operator">\</span>
    &amp;&amp; apk del .build-deps tzdata <span class="token operator">\</span>
    &amp;&amp; apk add --no-cache pcre-dev bash <span class="token operator">\</span>
    &amp;&amp; mkdir -p /var/fdfs /home/fastdfs/ <span class="token operator">\</span>
    &amp;&amp; mv /home/fastdfs.sh /home/fastdfs/ <span class="token operator">\</span>
    &amp;&amp; mv /home/*.conf /home/mime.types /etc/fdfs <span class="token operator">\</span>
    &amp;&amp; mv /home/nginx.conf /usr/local/nginx/conf/ <span class="token operator">\</span>
    &amp;&amp; chmod +x /home/fastdfs/fastdfs.sh <span class="token operator">\</span>
    &amp;&amp; sed -i <span class="token string">'s/bash/sh/g'</span> /etc/init.d/fdfs_storaged <span class="token operator">\</span>
    &amp;&amp; sed -i <span class="token string">'s/bash/sh/g'</span> /etc/init.d/fdfs_trackerd <span class="token operator">\</span>
    &amp;&amp; sed -i <span class="token string">'s/bash/sh/g'</span> /home/fastdfs/fastdfs.sh <span class="token operator">\</span>
    &amp;&amp; rm -rf /usr/local/src/* /var/cache/apk/* /tmp/* /var/tmp/* <span class="token variable">$HOME</span>/.cache</span>
<span class="token instruction"><span class="token keyword">VOLUME</span> /var/fdfs</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span> 22122 23000 28888 28080</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"/home/fastdfs/fastdfs.sh"</span>]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="debian-stretch-slim"><a href="#debian-stretch-slim" class="headerlink" title="debian:stretch-slim"></a>debian:stretch-slim</h4><pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> debian:stretch-slim</span>

<span class="token instruction"><span class="token keyword">COPY</span> conf/ /home/</span>
<span class="token instruction"><span class="token keyword">RUN</span> set -x <span class="token operator">\</span>
    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span class="token operator">\</span>
    &amp;&amp; echo <span class="token string">"Asia/shanghai"</span> > /etc/timezone <span class="token operator">\</span>
    &amp;&amp; sed -i <span class="token string">'s/deb.debian.org/mirrors.aliyun.com/g'</span> /etc/apt/sources.list <span class="token operator">\</span>
    &amp;&amp; sed -i <span class="token string">'s|security.debian.org/debian-security|mirrors.aliyun.com/debian-security|g'</span> /etc/apt/sources.list <span class="token operator">\</span>
    &amp;&amp; apt update <span class="token operator">\</span>
    &amp;&amp; apt install  --no-install-recommends --no-install-suggests -y build-essential libpcre3 libpcre3-dev zlib1g <span class="token operator">\</span>
                   git wget ca-certificates  zlib1g-dev libtool libssl-dev <span class="token operator">\</span>
    &amp;&amp; rm -rf /var/lib/apt/lists/* <span class="token operator">\</span>
    &amp;&amp; mkdir -p /usr/local/src <span class="token operator">\</span>
    &amp;&amp; cd /usr/local/src <span class="token operator">\</span>
    &amp;&amp; git clone https://github.com/happyfish100/libfastcommon.git --depth 1 <span class="token operator">\</span>
    &amp;&amp; git clone https://github.com/happyfish100/fastdfs.git --depth 1    <span class="token operator">\</span>
    &amp;&amp; git clone https://github.com/happyfish100/fastdfs-nginx-module.git --depth 1  <span class="token operator">\</span>
    &amp;&amp; wget http://nginx.org/download/nginx-1.15.4.tar.gz <span class="token operator">\</span>
    &amp;&amp; tar -xf nginx-1.15.4.tar.gz <span class="token operator">\</span>
    &amp;&amp; cd /usr/local/src/libfastcommon <span class="token operator">\</span>
    &amp;&amp; ./make.sh <span class="token operator">\</span>
    &amp;&amp; ./make.sh install <span class="token operator">\</span>
    &amp;&amp; cd /usr/local/src/fastdfs/ <span class="token operator">\</span>
    &amp;&amp; ./make.sh <span class="token operator">\</span>
    &amp;&amp; ./make.sh install <span class="token operator">\</span>
    &amp;&amp; cd /usr/local/src/nginx-1.15.4/ <span class="token operator">\</span>
    &amp;&amp; ./configure --add-module=/usr/local/src/fastdfs-nginx-module/src/ <span class="token operator">\</span>
    &amp;&amp; make &amp;&amp; make install <span class="token operator">\</span>
    &amp;&amp; apt purge -y build-essential libtool git wget ca-certificates <span class="token operator">\</span>
    &amp;&amp; apt autoremove -y <span class="token operator">\</span>
    &amp;&amp; mkdir -p /var/dfs /home/fastdfs/ <span class="token operator">\</span>
    &amp;&amp; mv /home/fastdfs.sh /home/fastdfs/ <span class="token operator">\</span>
    &amp;&amp; mv /home/*.conf /home/mime.types /etc/fdfs <span class="token operator">\</span>
    &amp;&amp; mv /home/nginx.conf /usr/local/nginx/conf/ <span class="token operator">\</span>
    &amp;&amp; chmod +x /home/fastdfs/fastdfs.sh <span class="token operator">\</span>
    &amp;&amp; rm -rf /var/lib/apt/list  /usr/local/src/*</span>

<span class="token instruction"><span class="token keyword">VOLUME</span> /var/fdfs</span>
<span class="token instruction"><span class="token keyword">EXPOSE</span>  22122 23000 28888 28080</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="构不同基础镜像构建出的大小对比"><a href="#构不同基础镜像构建出的大小对比" class="headerlink" title="构不同基础镜像构建出的大小对比"></a>构不同基础镜像构建出的大小对比</h3><p>哭了，官方构建出来的镜像将近 500MB</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">fastdfs             alpine              e855bd197dbe        <span class="token number">10</span> seconds ago      <span class="token number">29</span>.3MB
fastdfs             debian              e05ca1616604        <span class="token number">20</span> minutes ago      103MB
fastdfs             centos              c1488537c23c        <span class="token number">30</span> minutes ago      483MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="使用-dive-分析各个镜像"><a href="#使用-dive-分析各个镜像" class="headerlink" title="使用 dive 分析各个镜像"></a>使用 dive 分析各个镜像</h4><p>官方的</p>
<p><img data-src="https://p.k8s.li/1569728664464.png"></p>
<h4 id="alpine"><a href="#alpine" class="headerlink" title="alpine"></a>alpine</h4><p>基于 alpine 的基础镜像构建完成后，只有三层镜像 😂</p>
<p><img data-src="https://p.k8s.li/1569728744655.png"></p>
<h4 id="debian"><a href="#debian" class="headerlink" title="debian"></a>debian</h4><p><img data-src="https://p.k8s.li/1569729043301.png"></p>
<h3 id="musl-libc-带来的问题"><a href="#musl-libc-带来的问题" class="headerlink" title="musl libc 带来的问题"></a><code>musl libc</code> 带来的问题</h3><p>不过需要注意的是，使用 CentOS 和 Alpine 基础镜像分别构建出来的镜像，使用 ldd 查看二者编译出来的 fastdfs ，两者的动态链接库存在很大的差异， Alpine 缺少了很多动态链接库，这是因为 alpine 的 c 库是 <code>musl libc</code> ，而不是正统的 <code>glibc</code> ，另外对于一些依赖 <code>glibc</code> 的大型项目，像 openjdk 、tomcat、rabbitmq 等都不建议使用 alpine 基础镜像，因为  <code>musl libc</code> 会导致 jvm 一些奇怪的问题。这也是为什么 tomcat 官方没有给出基础镜像是 alpine 的 Dockerfile</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">centos<span class="token comment"># find /usr/bin/ -name "fdfs*" | xargs ldd</span>
        linux-vdso.so.1 <span class="token operator">=</span><span class="token operator">></span>  <span class="token punctuation">(</span>0x00007fffe1d30000<span class="token punctuation">)</span>
        libpthread.so.0 <span class="token operator">=</span><span class="token operator">></span> /lib64/libpthread.so.0 <span class="token punctuation">(</span>0x00007f86036e6000<span class="token punctuation">)</span>
        libfastcommon.so <span class="token operator">=</span><span class="token operator">></span> /lib/libfastcommon.so <span class="token punctuation">(</span>0x00007f86034a5000<span class="token punctuation">)</span>
        libc.so.6 <span class="token operator">=</span><span class="token operator">></span> /lib64/libc.so.6 <span class="token punctuation">(</span>0x00007f86030d8000<span class="token punctuation">)</span>
        /lib64/ld-linux-x86-64.so.2 <span class="token punctuation">(</span>0x00007f8603902000<span class="token punctuation">)</span>
        libm.so.6 <span class="token operator">=</span><span class="token operator">></span> /lib64/libm.so.6 <span class="token punctuation">(</span>0x00007f8602dd6000<span class="token punctuation">)</span>
        libdl.so.2 <span class="token operator">=</span><span class="token operator">></span> /lib64/libdl.so.2 <span class="token punctuation">(</span>0x00007f8602bd2000<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">alpine <span class="token comment"># find /usr/bin/ -name "fdfs*" | xargs ldd</span>
        /lib/ld-musl-x86_64.so.1 <span class="token punctuation">(</span>0x7f4f91585000<span class="token punctuation">)</span>
        libfastcommon.so <span class="token operator">=</span><span class="token operator">></span> /usr/lib/libfastcommon.so <span class="token punctuation">(</span>0x7f4f91528000<span class="token punctuation">)</span>
        libc.musl-x86_64.so.1 <span class="token operator">=</span><span class="token operator">></span> /lib/ld-musl-x86_64.so.1 <span class="token punctuation">(</span>0x7f4f91585000<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">debian <span class="token comment"># find /usr/bin/ -name "fdfs*" | xargs ldd</span>
        linux-vdso.so.1 <span class="token punctuation">(</span>0x00007ffd17e50000<span class="token punctuation">)</span>
        libpthread.so.0 <span class="token operator">=</span><span class="token operator">></span> /lib/x86_64-linux-gnu/libpthread.so.0 <span class="token punctuation">(</span>0x00007feadf317000<span class="token punctuation">)</span>
        libfastcommon.so <span class="token operator">=</span><span class="token operator">></span> /usr/lib/libfastcommon.so <span class="token punctuation">(</span>0x00007feadf0d6000<span class="token punctuation">)</span>
        libc.so.6 <span class="token operator">=</span><span class="token operator">></span> /lib/x86_64-linux-gnu/libc.so.6 <span class="token punctuation">(</span>0x00007feaded37000<span class="token punctuation">)</span>
        /lib64/ld-linux-x86-64.so.2 <span class="token punctuation">(</span>0x00007feadf74a000<span class="token punctuation">)</span>
        libm.so.6 <span class="token operator">=</span><span class="token operator">></span> /lib/x86_64-linux-gnu/libm.so.6 <span class="token punctuation">(</span>0x00007feadea33000<span class="token punctuation">)</span>
        libdl.so.2 <span class="token operator">=</span><span class="token operator">></span> /lib/x86_64-linux-gnu/libdl.so.2 <span class="token punctuation">(</span>0x00007feade82f000<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="容器启动方法"><a href="#容器启动方法" class="headerlink" title="容器启动方法"></a>容器启动方法</h3><p>需要注意的是，FastDFS 的容器需要使用 host 网络，因为 fastdfs storage 服务器需要向 tracker 服务器汇报自己 IP，这个 IP 还需要通过环境变量的方式注入到相关的配置文件当中。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> run -d -e <span class="token assign-left variable">FASTDFS_IPADDR</span><span class="token operator">=</span><span class="token number">10.10</span>.107.230 <span class="token punctuation">\</span>
           -p <span class="token number">28888</span>:28888 -p <span class="token number">22122</span>:22122 -p <span class="token number">23000</span>:23000 -p <span class="token number">28088</span>:28080 <span class="token punctuation">\</span>
           -v <span class="token environment constant">$PWD</span>/data:/var/fdfs --net<span class="token operator">=</span>host --name fastdfs fastdfs:alpine<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="测试工具"><a href="#测试工具" class="headerlink" title="测试工具"></a>测试工具</h3><ol>
<li>上传客户端：<code>fdfs_upload_file</code></li>
<li>并发执行工具 ：<code>xargs</code></li>
<li>测试样本：10W  张表情包图片 ，大小在 <strong>8KB–128KB</strong> 之间</li>
<li>上传测试命令：<code>time ls  | xargs -n 1 -I &#123;&#125; -P 256 sh -c &quot;/usr/bin/fdfs_upload_file /etc/fdfs/client.conf &#123;&#125;&quot;` </code>-p 参数指定并发执行的任务数量</li>
<li>下载测试工具： <code>wget</code></li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">下载测试命令：<span class="token variable"><span class="token variable">`</span><span class="token function">time</span> <span class="token function">cat</span> url.log  <span class="token operator">|</span> <span class="token function">xargs</span> -n <span class="token number">1</span> -I <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span> -P <span class="token number">256</span> <span class="token function">sh</span> -c <span class="token string">"wget  &#123;&#125;"</span><span class="token variable">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="文件上传测试"><a href="#文件上传测试" class="headerlink" title="文件上传测试"></a>文件上传测试</h3><p>测试样本为 10W 张 8KB-100 KB 大小不等的图片</p>
<p><img data-src="https://p.k8s.li/1564128425387.png"></p>
<p><strong>测试文件数量和大小</strong></p>
<p><img data-src="https://p.k8s.li/1564128874832.png"></p>
<p><strong>使用 xargs 执行 256 个进程并发上传 10w 张照片所用所用时间 为 2 分钟左右（内网）</strong></p>
<p><img data-src="https://p.k8s.li/1564128721547.png"></p>
<p><strong>用时 2 分 11 秒</strong></p>
<p><img data-src="https://p.k8s.li/1564364594777.png"></p>
<p><strong>客户端负载情况</strong></p>
<p><img data-src="https://p.k8s.li/1564127683217.png"></p>
<p><strong>服务端负载情况</strong></p>
<p><img data-src="https://p.k8s.li/1564364294952.png"></p>
<p><strong>服务端带宽流量</strong></p>
<p><img data-src="https://p.k8s.li/1564365025177.png"></p>
<p><strong>服务端带宽流量</strong></p>
<p><img data-src="https://p.k8s.li/1564363829960.png"></p>
<p><strong>服务端上传结果</strong></p>
<p><img data-src="https://p.k8s.li/1564125161155.png"></p>
<p><strong>服务端上传日志记录 ，均无错误输出</strong></p>
<p><img data-src="https://p.k8s.li/1564130238346.png"></p>
<h3 id="文件下载测试"><a href="#文件下载测试" class="headerlink" title="文件下载测试"></a>文件下载测试</h3><p><strong>从日志中提取文件路径</strong></p>
<p>从服务端的 <code>storage_access.log</code> 日志里提取出文件的路径，使用 <code>sed</code> 添加 <code>nginx</code> 的访问端口地址得到 10W 个记录 上传文件的 <code>http</code> 访问 <code>url</code> 地址</p>
<p><img data-src="https://p.k8s.li/1564130789416.png"></p>
<p><strong>wget 下载</strong></p>
<p>使用 <code>wget -i</code> 参数指定 <code>url.log</code> 为标准输出来测试下载刚刚上传的 10W 张图片 用时 3 分 23 秒</p>
<p><img data-src="https://p.k8s.li/1564023927851.png"></p>
<h3 id="测试结果分析"><a href="#测试结果分析" class="headerlink" title="测试结果分析"></a>测试结果分析</h3><p>使用 FastDFS 自带的上传测试工具和 xargs 并发执行工具，通过 xargs -P 参数指定的并发请求数，测得结果为单机性能在网络环境稳定的情况下可以达到 5000 并发上传请求。10W 张图片上传时间耗时 2 分 11 秒左右。使用定时脚本持续测试，总测试上传 100W 张图片。分析 tracker 服务器和 storage 服务器的日志，无论上传还是下载均未发现错误和异常，性能和稳定性较好。</p>
<h2 id="优化参数"><a href="#优化参数" class="headerlink" title="优化参数"></a>优化参数</h2><p>根据业务需求和线上环境调整一下参数，可充分发挥 FastDFS 文件系统的性能</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># 接收请求的线程数数量</span>
<span class="token key attr-name">accept_threads</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>

<span class="token comment"># work thread count, should &lt;= max_connections</span>
<span class="token comment"># default value is 4</span>
<span class="token comment"># since V2.00</span>
<span class="token comment"># 工作线程数量，应当小于等于最大连接数</span>
<span class="token key attr-name">work_threads</span><span class="token punctuation">=</span><span class="token value attr-value">4</span>

<span class="token comment"># min buff size</span>
<span class="token comment"># default value 8KB</span>
<span class="token comment"># 最小缓冲大小，默认值为 8KB</span>
<span class="token key attr-name">min_buff_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">8KB</span>

<span class="token comment"># max buff size</span>
<span class="token comment"># default value 128KB</span>
<span class="token comment"># 最大缓冲大小，默认值为 128KB</span>
<span class="token key attr-name">max_buff_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">128KB</span>

<span class="token comment"># thread stack size, should >= 64KB</span>
<span class="token comment"># default value is 256KB</span>
<span class="token comment"># 线程栈的大小，应当大于 64KB，默认为 256KB</span>
<span class="token key attr-name">thread_stack_size</span> <span class="token punctuation">=</span> <span class="token value attr-value">256KB</span>

<span class="token comment"># if use connection pool</span>
<span class="token comment"># default value is false</span>
<span class="token comment"># since V4.05</span>
<span class="token comment"># 是否使用连接池</span>
<span class="token key attr-name">use_connection_pool</span> <span class="token punctuation">=</span> <span class="token value attr-value">false</span>

<span class="token comment"># connections whose the idle time exceeds this time will be closed</span>
<span class="token comment"># unit: second</span>
<span class="token comment"># default value is 3600</span>
<span class="token comment"># since V4.05</span>
<span class="token comment"># 连接池的最大空闲时间</span>
<span class="token key attr-name">connection_pool_max_idle_time</span> <span class="token punctuation">=</span> <span class="token value attr-value">3600</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h4 id="无法连接到-tracker-服务器"><a href="#无法连接到-tracker-服务器" class="headerlink" title="无法连接到 tracker 服务器"></a>无法连接到 tracker 服务器</h4><p>需要在 tracker.conf 配置文件中添加允许访问的 IP ,并添加防火墙规则</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span><span class="token number">2019</span>-07-25 <span class="token number">10</span>:40:54<span class="token punctuation">]</span> ERROR - file: <span class="token punctuation">..</span>/client/storage_client.c, line: <span class="token number">996</span>, fdfs_recv_response fail, result: <span class="token number">107</span>
upload <span class="token function">file</span> fail, error no: <span class="token number">107</span>, error info: Transport endpoint is not connected
<span class="token punctuation">[</span><span class="token number">2019</span>-07-25 <span class="token number">10</span>:40:54<span class="token punctuation">]</span> ERROR - file: tracker_proto.c, line: <span class="token number">37</span>, server: <span class="token number">10.20</span>.172.192:23000, recv data fail, errno: <span class="token number">107</span>, error info: Transport endpoint is not connected<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="服务器磁盘用尽"><a href="#服务器磁盘用尽" class="headerlink" title="服务器磁盘用尽"></a>服务器磁盘用尽</h4><p>当 storage 服务器设定的上传存储目录所在的分区磁盘用尽将会出现无剩余空间的错误日志</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span><span class="token number">2019</span>-07-26 <span class="token number">16</span>:16:45<span class="token punctuation">]</span> ERROR - file: tracker_proto.c, line: <span class="token number">48</span>, server: <span class="token number">10.10</span>.107.232:22122, response status <span class="token number">28</span> <span class="token operator">!=</span> <span class="token number">0</span>
<span class="token punctuation">[</span><span class="token number">2019</span>-07-26 <span class="token number">16</span>:16:45<span class="token punctuation">]</span> ERROR - file: <span class="token punctuation">..</span>/client/tracker_client.c, line: <span class="token number">907</span>, fdfs_recv_response fail, result: <span class="token number">28</span>
tracker_query_storage fail, error no: <span class="token number">28</span>, error info: No space left on device<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="重启服务时失败"><a href="#重启服务时失败" class="headerlink" title="重启服务时失败"></a>重启服务时失败</h4><p>使用 service fdfs_trackerd restart 重启 tracker 或者 storage 服务时会报错，会提示端口已经占用。解决的方案就是使用 kill -9 命令杀死 tracker 服务或者 storage 服务，然后再重新启动相应服务即可</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span><span class="token number">2019</span>-07-25 <span class="token number">10</span>:36:55<span class="token punctuation">]</span> INFO - FastDFS v5.12, <span class="token assign-left variable">base_path</span><span class="token operator">=</span>/home/dfs, <span class="token assign-left variable">run_by_group</span><span class="token operator">=</span>, <span class="token assign-left variable">run_by_user</span><span class="token operator">=</span>, <span class="token assign-left variable">connect_timeout</span><span class="token operator">=</span>10s, <span class="token assign-left variable">network_timeout</span><span class="token operator">=</span>60s, <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">22122</span>, <span class="token assign-left variable">bind_addr</span><span class="token operator">=</span>, <span class="token assign-left variable">max_connections</span><span class="token operator">=</span><span class="token number">1024</span>, <span class="token assign-left variable">accept_threads</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">work_threads</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">min_buff_size</span><span class="token operator">=</span><span class="token number">8,192</span>, <span class="token assign-left variable">max_buff_size</span><span class="token operator">=</span><span class="token number">131,072</span>, <span class="token assign-left variable">store_lookup</span><span class="token operator">=</span><span class="token number">2</span>, <span class="token assign-left variable">store_group</span><span class="token operator">=</span>, <span class="token assign-left variable">store_server</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">store_path</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">reserved_storage_space</span><span class="token operator">=</span><span class="token number">10.00</span>%, <span class="token assign-left variable">download_server</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">allow_ip_count</span><span class="token operator">=</span>-1, <span class="token assign-left variable">sync_log_buff_interval</span><span class="token operator">=</span>10s, <span class="token assign-left variable">check_active_interval</span><span class="token operator">=</span>120s, <span class="token assign-left variable">thread_stack_size</span><span class="token operator">=</span><span class="token number">256</span> KB, <span class="token assign-left variable">storage_ip_changed_auto_adjust</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">storage_sync_file_max_delay</span><span class="token operator">=</span>86400s, <span class="token assign-left variable">storage_sync_file_max_time</span><span class="token operator">=</span>300s, <span class="token assign-left variable">use_trunk_file</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">slot_min_size</span><span class="token operator">=</span><span class="token number">256</span>, <span class="token assign-left variable">slot_max_size</span><span class="token operator">=</span><span class="token number">16</span> MB, <span class="token assign-left variable">trunk_file_size</span><span class="token operator">=</span><span class="token number">64</span> MB, <span class="token assign-left variable">trunk_create_file_advance</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">trunk_create_file_time_base</span><span class="token operator">=</span>02:00, <span class="token assign-left variable">trunk_create_file_interval</span><span class="token operator">=</span><span class="token number">86400</span>, <span class="token assign-left variable">trunk_create_file_space_threshold</span><span class="token operator">=</span><span class="token number">20</span> GB, <span class="token assign-left variable">trunk_init_check_occupying</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">trunk_init_reload_from_binlog</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">trunk_compress_binlog_min_interval</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">use_storage_id</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">id_type_in_filename</span><span class="token operator">=</span>ip, <span class="token assign-left variable">storage_id_count</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">rotate_error_log</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">error_log_rotate_time</span><span class="token operator">=</span>00:00, <span class="token assign-left variable">rotate_error_log_size</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">log_file_keep_days</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">store_slave_file_use_link</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">use_connection_pool</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">g_connection_pool_max_idle_time</span><span class="token operator">=</span>3600s
<span class="token punctuation">[</span><span class="token number">2019</span>-07-25 <span class="token number">10</span>:36:55<span class="token punctuation">]</span> ERROR - file: sockopt.c, line: <span class="token number">868</span>, <span class="token builtin class-name">bind</span> port <span class="token number">22122</span> failed, errno: <span class="token number">98</span>, error info: Address already <span class="token keyword">in</span> use.
<span class="token punctuation">[</span><span class="token number">2019</span>-07-25 <span class="token number">10</span>:36:55<span class="token punctuation">]</span> CRIT - <span class="token builtin class-name">exit</span> abnormally<span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="安全相关"><a href="#安全相关" class="headerlink" title="安全相关"></a>安全相关</h3><ol>
<li>tracker.conf 、storage.conf 配置文件默认允许所有 IP 地址访问 ，建议去掉  <code>allow_hosts=*</code> 修改为 FastDFS 客户端所在的内网 IP 地址。</li>
</ol>
<p><img data-src="https://p.k8s.li/1564384530137.png"></p>
<p>2.tracker.conf 、storage.conf  默认配置文件监听的地址为 0.0.0.0 即本机所有的 IP 地址，建议修改为 FastDFS 服务器所在的内网 IP 地址。</p>
<p><img data-src="https://p.k8s.li/1564384711746.png"></p>
<p>3.默认运行用户为当前用户和用户组为当前用户，建议指定为权限最小的用户来运行此进程。</p>
<p><img data-src="https://p.k8s.li/1564384906456.png"></p>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Docker/" rel="tag"># Docker</a>
              <a href="/tags/FastDFS/" rel="tag"># FastDFS</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/esp8266-pc-switch.html" rel="prev" title="使用 ESP8266 NodeMCU 打造 WiFi 开关">
                  <i class="fa fa-chevron-left"></i> 使用 ESP8266 NodeMCU 打造 WiFi 开关
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/fastdfs-lua-redis.html" rel="next" title="Lua + Redis 对 nginx 做动态路由">
                  Lua + Redis 对 nginx 做动态路由 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">26:05</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
