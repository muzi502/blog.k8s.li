<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.k8s.li').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>
  <meta name="description" content="å‰è¨€å¦‚æœä½ çš„ FastDFS æ–‡ä»¶ç³»ç»Ÿéœ€è¦é«˜å¯ç”¨ï¼Œéœ€è¦éƒ¨ç½²åœ¨å¤šå°æœºå™¨ä¸Šçš„è¯ï¼Œå¹¶ä¸”ä½ çš„è¿™äº›æœåŠ¡å™¨ä¸Šåªè·‘ FastDFS è¿™ä¸ªæœåŠ¡ï¼Œé‚£ä¹ˆ FastDFS å¯èƒ½å¹¶ä¸é€‚åˆç”¨ Docker æ¥éƒ¨ç½²ï¼ŒæŒ‰ç…§å®˜æ–¹æ–‡æ¡£ç›´æ¥éƒ¨ç½²åœ¨æœºå™¨ä¸Šå°±å¯ä»¥ï¼Œæ²¡å¿…è¦é‡‡ç”¨å®¹å™¨æ¥éƒ¨ç½²ã€‚å…¶å® FastDFS å¹¶ä¸é€‚åˆå®¹å™¨åŒ–éƒ¨ç½²ï¼Œå› ä¸º tracker æœåŠ¡å™¨å‘ storage æœåŠ¡å™¨æŠ¥å‘Šè‡ªå·±çš„ IPï¼Œ è€Œè¿™ä¸ª IP æ˜¯å®¹å™¨å†…çš„ IP ã€‚æ˜¯">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker éƒ¨ç½² FastDFS">
<meta property="og:url" content="https://blog.k8s.li/docker-deploy-fastdfs.html">
<meta property="og:site_name" content="æœ¨å­">
<meta property="og:description" content="å‰è¨€å¦‚æœä½ çš„ FastDFS æ–‡ä»¶ç³»ç»Ÿéœ€è¦é«˜å¯ç”¨ï¼Œéœ€è¦éƒ¨ç½²åœ¨å¤šå°æœºå™¨ä¸Šçš„è¯ï¼Œå¹¶ä¸”ä½ çš„è¿™äº›æœåŠ¡å™¨ä¸Šåªè·‘ FastDFS è¿™ä¸ªæœåŠ¡ï¼Œé‚£ä¹ˆ FastDFS å¯èƒ½å¹¶ä¸é€‚åˆç”¨ Docker æ¥éƒ¨ç½²ï¼ŒæŒ‰ç…§å®˜æ–¹æ–‡æ¡£ç›´æ¥éƒ¨ç½²åœ¨æœºå™¨ä¸Šå°±å¯ä»¥ï¼Œæ²¡å¿…è¦é‡‡ç”¨å®¹å™¨æ¥éƒ¨ç½²ã€‚å…¶å® FastDFS å¹¶ä¸é€‚åˆå®¹å™¨åŒ–éƒ¨ç½²ï¼Œå› ä¸º tracker æœåŠ¡å™¨å‘ storage æœåŠ¡å™¨æŠ¥å‘Šè‡ªå·±çš„ IPï¼Œ è€Œè¿™ä¸ª IP æ˜¯å®¹å™¨å†…çš„ IP ã€‚æ˜¯">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/1569728664464.png">
<meta property="og:image" content="https://p.k8s.li/1569728744655.png">
<meta property="og:image" content="https://p.k8s.li/1569729043301.png">
<meta property="og:image" content="https://p.k8s.li/1564128425387.png">
<meta property="og:image" content="https://p.k8s.li/1564128874832.png">
<meta property="og:image" content="https://p.k8s.li/1564128721547.png">
<meta property="og:image" content="https://p.k8s.li/1564364594777.png">
<meta property="og:image" content="https://p.k8s.li/1564127683217.png">
<meta property="og:image" content="https://p.k8s.li/1564364294952.png">
<meta property="og:image" content="https://p.k8s.li/1564365025177.png">
<meta property="og:image" content="https://p.k8s.li/1564363829960.png">
<meta property="og:image" content="https://p.k8s.li/1564125161155.png">
<meta property="og:image" content="https://p.k8s.li/1564130238346.png">
<meta property="og:image" content="https://p.k8s.li/1564130789416.png">
<meta property="og:image" content="https://p.k8s.li/1564023927851.png">
<meta property="og:image" content="https://p.k8s.li/1564384530137.png">
<meta property="og:image" content="https://p.k8s.li/1564384711746.png">
<meta property="og:image" content="https://p.k8s.li/1564384906456.png">
<meta property="article:published_time" content="2019-09-24T16:00:00.000Z">
<meta property="article:modified_time" content="2021-05-30T14:38:18.392Z">
<meta property="article:author" content="æœ¨å­">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="FastDFS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/1569728664464.png">
<link rel="canonical" href="https://blog.k8s.li/docker-deploy-fastdfs.html">
<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>
  <title>Docker éƒ¨ç½² FastDFS | æœ¨å­</title>
  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }
  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>
<link rel="alternate" href="/atom.xml" title="æœ¨å­" type="application/atom+xml">
</head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">
    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æœ¨å­</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>
<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">
    <a href="/" rel="section"><i class="fa fa-fw fa-desktop"></i>Home</a>
  </li>
        <li class="menu-item menu-item-books">
    <a href="/booklist.html" rel="section"><i class="fa fa-fw fa-book"></i>Books</a>
  </li>
        <li class="menu-item menu-item-kindle">
    <a href="https://kindle.502.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
  </li>
        <li class="menu-item menu-item-friend">
    <a href="/link/" rel="section"><i class="fa fa-fw fa-link"></i>Friend</a>
  </li>
        <li class="menu-item menu-item-about">
    <a href="/about.html" rel="section"><i class="fa fa-fw fa-user-circle-o"></i>About</a>
  </li>
  </ul>
</nav>
</div>
    </header>
  <div class="reading-progress-bar"></div>
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
  <div class="posts-expand">
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/docker-deploy-fastdfs.html">
    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog.k8s.li/avatar.png">
      <meta itemprop="name" content="æœ¨å­">
      <meta itemprop="description" content="">
    </span>
    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æœ¨å­">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          Docker éƒ¨ç½² FastDFS
        </h2>
        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-09-25 2019-09-25T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2019-09-25T00:00:00+08:00">2019-09-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-30 2021-05-30T22:38:18+08:00" itemprop="dateModified" datetime="2021-05-30T22:38:18+08:00">2021-05-30</time>
              </span>
  <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    <a title="disqus" href="/docker-deploy-fastdfs.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="docker-deploy-fastdfs.html" itemprop="commentCount"></span>
    </a>
  </span>
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>21 åˆ†é’Ÿ</span>
            </span>
        </div>
      </header>
    <div class="post-body" itemprop="articleBody">
        <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å¦‚æœä½ çš„ FastDFS æ–‡ä»¶ç³»ç»Ÿéœ€è¦é«˜å¯ç”¨ï¼Œéœ€è¦éƒ¨ç½²åœ¨å¤šå°æœºå™¨ä¸Šçš„è¯ï¼Œå¹¶ä¸”ä½ çš„è¿™äº›æœåŠ¡å™¨ä¸Šåªè·‘ FastDFS è¿™ä¸ªæœåŠ¡ï¼Œé‚£ä¹ˆ FastDFS å¯èƒ½å¹¶ä¸é€‚åˆç”¨ Docker æ¥éƒ¨ç½²ï¼ŒæŒ‰ç…§å®˜æ–¹æ–‡æ¡£ç›´æ¥éƒ¨ç½²åœ¨æœºå™¨ä¸Šå°±å¯ä»¥ï¼Œæ²¡å¿…è¦é‡‡ç”¨å®¹å™¨æ¥éƒ¨ç½²ã€‚å…¶å® FastDFS å¹¶ä¸é€‚åˆå®¹å™¨åŒ–éƒ¨ç½²ï¼Œå› ä¸º tracker æœåŠ¡å™¨å‘ storage æœåŠ¡å™¨æŠ¥å‘Šè‡ªå·±çš„ IPï¼Œ è€Œè¿™ä¸ª IP æ˜¯å®¹å™¨å†…çš„ IP ã€‚æ˜¯ Docker çš„ä¸€ä¸ªç§æœ‰ IP æ®µï¼Œè¿™å°†å¯¼è‡´å®¢æˆ·ç«¯æ— æ³•è®¿é—® storage æœåŠ¡å™¨ã€‚å½“ç„¶å¦‚æœä½¿ç”¨ host ç½‘ç»œæˆ–è€…èƒ½æ‰“é€šå®¢æˆ·ç«¯åˆ° storage çš„ç½‘ç»œè§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚ flannel ï¼Œcalico ç­‰ï¼Œè¿™éƒ½å¯ä»¥ï¼Œåœ¨ Kubernetes åŸºäºæœåŠ¡å‘ç°ï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥è®¿é—®åˆ° storage æœåŠ¡å™¨ã€‚</p>
<p>é‚£ä¹ˆ FastDFS é‡‡ç”¨ Docker éƒ¨ç½²é€‚ç”¨äºä»€ä¹ˆåœºæ™¯å‘¢ï¼Ÿå…¶å®æ¯”è¾ƒé€‚åˆä¸­å°å‹çš„é¡¹ç›®ï¼Œå¯¹é«˜å¯ç”¨ï¼Œé«˜æ€§èƒ½è¦æ±‚ä¸å¤§çš„æƒ…å†µä¸‹ã€‚æˆ–è€…å°† FastDFS æ‰€æœ‰çš„æœåŠ¡å°è£…åœ¨ä¸€ä¸ªå®¹å™¨é‡Œè¿è¡Œï¼Œå’Œå…¶ä»–æœåŠ¡ä¸€èµ·ä½¿ç”¨ docker-compose å¯åŠ¨ï¼Œè¿™æ ·ç”¨å†é€‚åˆä¸è¿‡äº†ã€‚æˆ‘çš„é¡¹ç›®å°±æ˜¯è¿™ç§åœºæ™¯ï¼Œç”±äºæœåŠ¡å™¨èµ„æºæœ‰é™ï¼Œä¸å¯èƒ½å»å•ç‹¬éƒ¨ç½²ä¸€ä¸ª FastDFS æœåŠ¡å™¨é›†ç¾¤ï¼Œå·´æ‹‰å·´æ‹‰æ•´ä¸ªé«˜å¯ç”¨ã€‚æ‰€æœ‰çš„é¡¹ç›®ç»„ä»¶éƒ½é‡‡ç”¨ Docker éƒ¨ç½²åœ¨ä¸€å°æœºå™¨ä¸Šï¼ŒFastDFS é‡Œçš„  nginx ä¹Ÿæ˜¯æ²¡æœ‰å•ç‹¬å»éƒ¨ç½²ï¼Œå’Œ trackerã€storage æœåŠ¡å™¨ä¸€èµ·è£…åœ¨ä¸€ä¸ªå®¹å™¨é‡Œã€‚ä¸ºäº†èŠ‚çœèµ„æºæ²¡å¾—åŠæ³•ğŸ˜‚</p>
<h2 id="æ„å»º-docker-é•œåƒ"><a href="#æ„å»º-docker-é•œåƒ" class="headerlink" title="æ„å»º docker é•œåƒ"></a>æ„å»º docker é•œåƒ</h2><p>å®˜æ–¹ç»™å‡ºäº†ä¸¤ç§æ„å»º docker é•œåƒçš„æ–¹å¼ï¼Œä½†æ˜¯æˆ‘æ„Ÿè§‰éƒ½ä¸å¥½ï¼Œä¸€æ˜¯ä½¿ç”¨çš„ çš„æ˜¯ centos åŸºç¡€é•œåƒæ„å»ºï¼Œæ„å»ºå‡ºæ¥çš„å¤§å°å°†è¿‘ï¼Œæ ¹æœ¬å°±ä¸ç”¨åŒºåˆ†æœ¬åœ°æ„å»ºæˆ–è€…ç½‘ç»œæ„å»ºã€‚ä½ æ„å»ºçš„æ•´ä¸ªè¿‡ç¨‹éƒ½è¦éƒ½éœ€è¦è¿æ¥å¤–ç½‘ä¸‹è½½æ„å»ºçš„åŒ…ä¹‹ç±»çš„ï¼Œè¿˜ç”¨åŒºåˆ†ä»€ä¹ˆç½‘ç»œæ„å»ºå’Œæœ¬åœ°æ„å»ºï¼Ÿæ‰€ä»¥åœ¨è¿™é‡Œæˆ‘ä»¬ä»…ä»…éœ€è¦å‡†å¤‡é…ç½®æ–‡ä»¶å³å¯ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> â•­â”€root@docker-230 ~/root/container/fastdfs/fastdfs/docker/dockerfile_network â€¹masterâ€º</span><br><span class="line">â•°â”€<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">fastdfs             centos              c1488537c23c        8 seconds ago       483MB</span><br></pre></td></tr></table></figure>
<h3 id="å‡†å¤‡é…ç½®æ–‡ä»¶"><a href="#å‡†å¤‡é…ç½®æ–‡ä»¶" class="headerlink" title="å‡†å¤‡é…ç½®æ–‡ä»¶"></a>å‡†å¤‡é…ç½®æ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†æ‰€æœ‰çš„é…ç½®æ–‡ä»¶ä¸€å¹¶æ”¾åˆ° conf ç›®å½•ä¸‹</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">mkdir  -p fastdfs/conf</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs.git --depth 1</span><br><span class="line">cp -rf fastdfs/docker/dockerfile_local/conf/* conf</span><br><span class="line">cp fastdfs/docker/dockerfile_local/fastdfs.sh conf</span><br><span class="line">touch Dockerfile.debian</span><br><span class="line">touch Dockerfile.alpine</span><br><span class="line"><span class="comment"># å¤åˆ¶å‡ºæ¥é…ç½®æ–‡ä»¶ï¼ŒæŠŠæºç ç§»é™¤æ‰å°±å¯ä»¥</span></span><br><span class="line">rm -rf fastdfs</span><br></pre></td></tr></table></figure>
<h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><p>æ‰€æœ‰çš„é…ç½®æ–‡ä»¶éƒ½åœ¨ conf é‡Œï¼Œæˆ‘ä»¬æ ¹æ®è‡ªèº«çš„éœ€è¦ä¿®æ”¹ä¸€ä¸‹å„ä¸ªé…ç½®æ–‡ä»¶å³å¯ï¼Œå…³äº fastdfs é…ç½®æ–‡ä»¶çš„å„ä¸ªå‚æ•°å¯ä»¥å»å‚è€ƒä¸€ä¸‹ä¸‹é¢çš„åšå®¢ã€‚</p>
<ul>
<li><p><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html" target="_blank" rel="noopener">ç”¨FastDFSä¸€æ­¥æ­¥æ­å»ºæ–‡ä»¶ç®¡ç†ç³»ç»Ÿ</a></p>
</li>
<li><p><a href="https://mhl.xyz/Linux/fastdfs-tracker-storage.html" target="_blank" rel="noopener">FastDFSé…ç½®å‚æ•°tracker.confã€storage.confè¯¦è§£</a></p>
</li>
</ul>
<p>æˆ‘ä¿®æ”¹äº†é»˜è®¤çš„é…ç½®ï¼Œæ•°æ®å­˜æ”¾ç›®å½•ä¿®æ”¹æˆäº† <code>/var/fdfs</code> ,åœ¨å†™ <code>Dockerfile</code> çš„æ—¶å€™éœ€è¦å»ºç«‹è¿™ä¸ªç›®å½•ï¼Œå¦‚æœä½ çš„ç›®å½•æ²¡æœ‰ä¿®æ”¹çš„è¯ï¼Œå°±æŠŠ Dockerfile é‡Œåé¢é‚£é‡Œå»ºç«‹æ–‡ä»¶å¤¹çš„è·¯å¾„ä¿®æ”¹æˆé»˜è®¤çš„å³å¯ã€‚</p>
<p>æŠŠ <code>tracker_server</code> ä¿®æ”¹æˆ <code>tracker_server=tracker_ip:22122</code> ï¼Œå®¹å™¨å¯åŠ¨çš„æ—¶å€™ä½¿ç”¨ç¯å¢ƒå˜é‡æ³¨å…¥çš„ <code>FASTDFS_IPADDR</code> æ›¿æ¢æ‰å°±å¯ä»¥ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@debian-deploy-132 ~/fastdfs/conf</span><br><span class="line">â•°â”€<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ client.conf             <span class="comment"># C è¯­è¨€ç‰ˆæœ¬å®¢æˆ·ç«¯é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥å¿½ç•¥</span></span><br><span class="line">â”œâ”€â”€ fastdfs.sh              <span class="comment"># docker å®¹å™¨å¯åŠ¨ fastdfs æœåŠ¡çš„è„šæœ¬</span></span><br><span class="line">â”œâ”€â”€ http.conf               <span class="comment"># http é…ç½®æ–‡ä»¶ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£</span></span><br><span class="line">â”œâ”€â”€ mime.types              <span class="comment">#</span></span><br><span class="line">â”œâ”€â”€ mod_fastdfs.conf        <span class="comment"># fastdfs nginx æ¨¡å—é…ç½®æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ nginx.conf              <span class="comment"># nginx é…ç½®æ–‡ä»¶ï¼Œæ ¹æ®è‡ªèº«é¡¹ç›®ä¿®æ”¹</span></span><br><span class="line">â”œâ”€â”€ storage.conf            <span class="comment"># storage æœåŠ¡é…ç½®æ–‡ä»¶</span></span><br><span class="line">â””â”€â”€ tracker.conf            <span class="comment"># tracker æœåŠ¡é…ç½®æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>
<h4 id="tracker-æœåŠ¡é…ç½®æ–‡ä»¶-tracker-conf"><a href="#tracker-æœåŠ¡é…ç½®æ–‡ä»¶-tracker-conf" class="headerlink" title="tracker æœåŠ¡é…ç½®æ–‡ä»¶ tracker.conf"></a>tracker æœåŠ¡é…ç½®æ–‡ä»¶ tracker.conf</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">disabled</span>=<span class="literal">false</span>                <span class="comment">#å¯ç”¨é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">22122</span>                    <span class="comment">#è®¾ç½®trackerçš„ç«¯å£å·</span></span><br><span class="line"><span class="attr">base_path</span>=/var/dfs           <span class="comment">#è®¾ç½®trackerçš„æ•°æ®æ–‡ä»¶å’Œæ—¥å¿—ç›®å½•ï¼ˆéœ€é¢„å…ˆåˆ›å»ºï¼‰</span></span><br><span class="line"><span class="attr">http.server_port</span>=<span class="number">28080</span>         <span class="comment">#è®¾ç½®httpç«¯å£å·</span></span><br></pre></td></tr></table></figure>
<h4 id="storage-æœåŠ¡é…ç½®æ–‡ä»¶-storage-ids-conf"><a href="#storage-æœåŠ¡é…ç½®æ–‡ä»¶-storage-ids-conf" class="headerlink" title="storage æœåŠ¡é…ç½®æ–‡ä»¶ storage_ids.conf"></a>storage æœåŠ¡é…ç½®æ–‡ä»¶ storage_ids.conf</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># storageæœåŠ¡ç«¯å£</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">23000</span>                         <span class="comment"># ç›‘å¬ç«¯å£å·</span></span><br><span class="line"><span class="attr">base_path</span>=/var/dfs                <span class="comment"># æ•°æ®å’Œæ—¥å¿—æ–‡ä»¶å­˜å‚¨æ ¹ç›®å½•</span></span><br><span class="line"><span class="attr">store_path0</span>=/var/dfs              <span class="comment"># ç¬¬ä¸€ä¸ªå­˜å‚¨ç›®å½•</span></span><br><span class="line"><span class="attr">tracker_server</span>=tracker_ip:<span class="number">22122</span>    <span class="comment"># trackeræœåŠ¡å™¨IPå’Œç«¯å£</span></span><br><span class="line"><span class="attr">http.server_port</span>=<span class="number">28888</span></span><br></pre></td></tr></table></figure>
<h4 id="nginx-é…ç½®æ–‡ä»¶-nginx-conf"><a href="#nginx-é…ç½®æ–‡ä»¶-nginx-conf" class="headerlink" title="nginx é…ç½®æ–‡ä»¶ nginx.conf"></a>nginx é…ç½®æ–‡ä»¶ nginx.conf</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ nginx é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ä¿®æ”¹ä¸‹é¢è¿™æ®µ</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">28888</span>;    <span class="comment">## è¯¥ç«¯å£ä¸ºstorage.confä¸­çš„http.server_portç›¸åŒ</span></span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line">    <span class="attribute">location</span> ~/group[<span class="number">0</span>-<span class="number">9</span>]/ &#123;</span><br><span class="line">        ngx_fastdfs_module;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">    <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">    <span class="attribute">root</span>   html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="nginx-æ¨¡å—é…ç½®æ–‡ä»¶-mod-fastdfs-conf"><a href="#nginx-æ¨¡å—é…ç½®æ–‡ä»¶-mod-fastdfs-conf" class="headerlink" title="nginx æ¨¡å—é…ç½®æ–‡ä»¶ mod_fastdfs.conf"></a>nginx æ¨¡å—é…ç½®æ–‡ä»¶ mod_fastdfs.conf</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tracker_server</span>=tracker_ip:<span class="number">22122</span>   <span class="comment"># trackeræœåŠ¡å™¨IPå’Œç«¯å£</span></span><br><span class="line"><span class="attr">url_have_group_name</span>=<span class="literal">true</span>             <span class="comment"># url ä¸­åŒ…å« group çš„åç§°</span></span><br><span class="line"><span class="attr">store_path0</span>=/var/dfs                <span class="comment"># æ•°æ®å’Œæ—¥å¿—æ–‡ä»¶å­˜å‚¨æ ¹ç›®å½•</span></span><br></pre></td></tr></table></figure>
<h4 id="fastdfs-æœåŠ¡çš„è„šæœ¬-fastdfs-sh"><a href="#fastdfs-æœåŠ¡çš„è„šæœ¬-fastdfs-sh" class="headerlink" title="fastdfs æœåŠ¡çš„è„šæœ¬ fastdfs.sh"></a>fastdfs æœåŠ¡çš„è„šæœ¬ fastdfs.sh</h4><p>å®˜æ–¹çš„è„šæœ¬å†™çš„å¾ˆéšæ„ï¼Œæˆ‘å°±ä¿®æ”¹äº†ä¸€å“ˆï¼Œä¸ä¿®æ”¹æŒ‰ç…§å®˜æ–¹çš„æ¥ä¹Ÿ ok</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">new_val=<span class="variable">$FASTDFS_IPADDR</span></span><br><span class="line">old=<span class="string">"tracker_ip"</span></span><br><span class="line"></span><br><span class="line">sed -i <span class="string">"s/<span class="variable">$old</span>/<span class="variable">$new_val</span>/g"</span> /etc/fdfs/storage.conf</span><br><span class="line">sed -i <span class="string">"s/<span class="variable">$old</span>/<span class="variable">$new_val</span>/g"</span> /etc/fdfs/mod_fastdfs.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"start trackerd"</span></span><br><span class="line">/etc/init.d/fdfs_trackerd start</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"start storage"</span></span><br><span class="line">/etc/init.d/fdfs_storaged start</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"start nginx"</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br><span class="line"></span><br><span class="line">tail -f  /dev/null</span><br></pre></td></tr></table></figure>
<h4 id="æŠŠ-bash-æ›¿æ¢æˆ-sh"><a href="#æŠŠ-bash-æ›¿æ¢æˆ-sh" class="headerlink" title="æŠŠ bash æ›¿æ¢æˆ sh"></a>æŠŠ bash æ›¿æ¢æˆ sh</h4><p>å…¶å®è¿™ä¸€æ­¥éª¤å¯ä»¥ä¸åšï¼Œä½¿ç”¨ bash å¯åŠ¨çš„è¯ï¼Œéœ€è¦åœ¨ alpine å®‰è£… bash ï¼Œä¼šå¢åŠ  6MB å·¦å³çš„é•œåƒå¤§å°ï¼Œæ„Ÿè§‰ä¹Ÿæ²¡å¿…è¦è¿™æ ·åšğŸ˜‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">'s/bash/sh/g'</span> `grep -nr bash | awk -F <span class="string">':'</span> <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›¿æ¢å</span></span><br><span class="line">grep -nr \<span class="comment">#\!\/bin\/sh</span></span><br><span class="line">stop.sh:1:<span class="comment">#!/bin/sh</span></span><br><span class="line">init.d/fdfs_storaged:1:<span class="comment">#!/bin/sh</span></span><br><span class="line">init.d/fdfs_trackerd:1:<span class="comment">#!/bin/sh</span></span><br><span class="line">conf/fastdfs.sh:1:<span class="comment">#!/bin/sh</span></span><br><span class="line">restart.sh:1:<span class="comment">#!/bin/sh</span></span><br><span class="line">docker/dockerfile_local/fastdfs.sh:1:<span class="comment">#!/bin/sh</span></span><br><span class="line">docker/dockerfile_network/fastdfs.sh:1:<span class="comment">#!/bin/sh</span></span><br></pre></td></tr></table></figure>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><h4 id="alpine-3-10"><a href="#alpine-3-10" class="headerlink" title="alpine:3.10"></a>alpine:3.10</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> conf/ /home</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -xe \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"http://mirrors.aliyun.com/alpine/latest-stable/main/"</span> &gt; /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"http://mirrors.aliyun.com/alpine/latest-stable/community/"</span> &gt;&gt; /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk add --no-cache --virtual .build-deps alpine-sdk gcc libc-dev make perl-dev openssl-dev pcre-dev zlib-dev tzdata \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/Shanghai"</span> &gt; /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p /usr/<span class="built_in">local</span>/src \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src \</span></span><br><span class="line"><span class="bash">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/libfastcommon.git --depth 1 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs.git --depth 1    \</span></span><br><span class="line"><span class="bash">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs-nginx-module.git --depth 1  \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget http://nginx.org/download/nginx-1.15.4.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -xf nginx-1.15.4.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/libfastcommon \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">'s/sys\/poll\.h/poll\.h/g'</span> src/sockopt.c \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/fastdfs/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/nginx-1.15.4/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./configure --add-module=/usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make &amp;&amp; make install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk del .build-deps tzdata \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk add --no-cache pcre-dev bash \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p /var/fdfs /home/fastdfs/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /home/fastdfs.sh /home/fastdfs/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /home/*.conf /home/mime.types /etc/fdfs \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /home/nginx.conf /usr/<span class="built_in">local</span>/nginx/conf/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod +x /home/fastdfs/fastdfs.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">'s/bash/sh/g'</span> /etc/init.d/fdfs_storaged \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">'s/bash/sh/g'</span> /etc/init.d/fdfs_trackerd \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">'s/bash/sh/g'</span> /home/fastdfs/fastdfs.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /usr/<span class="built_in">local</span>/src/* /var/cache/apk/* /tmp/* /var/tmp/* <span class="variable">$HOME</span>/.cache</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /var/fdfs</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">22122</span> <span class="number">23000</span> <span class="number">28888</span> <span class="number">28080</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/home/fastdfs/fastdfs.sh"</span>]</span></span><br></pre></td></tr></table></figure>
<h4 id="debian-stretch-slim"><a href="#debian-stretch-slim" class="headerlink" title="debian:stretch-slim"></a>debian:stretch-slim</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:stretch-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> conf/ /home/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -x \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/shanghai"</span> &gt; /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">'s/deb.debian.org/mirrors.aliyun.com/g'</span> /etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">'s|security.debian.org/debian-security|mirrors.aliyun.com/debian-security|g'</span> /etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install  --no-install-recommends --no-install-suggests -y build-essential libpcre3 libpcre3-dev zlib1g \</span></span><br><span class="line"><span class="bash">                   git wget ca-certificates  zlib1g-dev libtool libssl-dev \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p /usr/<span class="built_in">local</span>/src \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src \</span></span><br><span class="line"><span class="bash">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/libfastcommon.git --depth 1 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs.git --depth 1    \</span></span><br><span class="line"><span class="bash">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs-nginx-module.git --depth 1  \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget http://nginx.org/download/nginx-1.15.4.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -xf nginx-1.15.4.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/libfastcommon \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/fastdfs/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/nginx-1.15.4/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./configure --add-module=/usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make &amp;&amp; make install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt purge -y build-essential libtool git wget ca-certificates \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt autoremove -y \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p /var/dfs /home/fastdfs/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /home/fastdfs.sh /home/fastdfs/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /home/*.conf /home/mime.types /etc/fdfs \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /home/nginx.conf /usr/<span class="built_in">local</span>/nginx/conf/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod +x /home/fastdfs/fastdfs.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/lib/apt/list  /usr/<span class="built_in">local</span>/src/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /var/fdfs</span></span><br><span class="line"><span class="keyword">EXPOSE</span>  <span class="number">22122</span> <span class="number">23000</span> <span class="number">28888</span> <span class="number">28080</span></span><br></pre></td></tr></table></figure>
<h3 id="æ„ä¸åŒåŸºç¡€é•œåƒæ„å»ºå‡ºçš„å¤§å°å¯¹æ¯”"><a href="#æ„ä¸åŒåŸºç¡€é•œåƒæ„å»ºå‡ºçš„å¤§å°å¯¹æ¯”" class="headerlink" title="æ„ä¸åŒåŸºç¡€é•œåƒæ„å»ºå‡ºçš„å¤§å°å¯¹æ¯”"></a>æ„ä¸åŒåŸºç¡€é•œåƒæ„å»ºå‡ºçš„å¤§å°å¯¹æ¯”</h3><p>å“­äº†ï¼Œå®˜æ–¹æ„å»ºå‡ºæ¥çš„é•œåƒå°†è¿‘ 500MB</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fastdfs             alpine              e855bd197dbe        10 seconds ago      29.3MB</span><br><span class="line">fastdfs             debian              e05ca1616604        20 minutes ago      103MB</span><br><span class="line">fastdfs             centos              c1488537c23c        30 minutes ago      483MB</span><br></pre></td></tr></table></figure>
<h4 id="ä½¿ç”¨-dive-åˆ†æå„ä¸ªé•œåƒ"><a href="#ä½¿ç”¨-dive-åˆ†æå„ä¸ªé•œåƒ" class="headerlink" title="ä½¿ç”¨ dive åˆ†æå„ä¸ªé•œåƒ"></a>ä½¿ç”¨ dive åˆ†æå„ä¸ªé•œåƒ</h4><p>å®˜æ–¹çš„</p>
<p><img src="https://p.k8s.li/1569728664464.png" alt=""></p>
<h4 id="alpine"><a href="#alpine" class="headerlink" title="alpine"></a>alpine</h4><p>åŸºäº alpine çš„åŸºç¡€é•œåƒæ„å»ºå®Œæˆåï¼Œåªæœ‰ä¸‰å±‚é•œåƒğŸ˜‚</p>
<p><img src="https://p.k8s.li/1569728744655.png" alt=""></p>
<h4 id="debian"><a href="#debian" class="headerlink" title="debian"></a>debian</h4><p><img src="https://p.k8s.li/1569729043301.png" alt=""></p>
<h3 id="musl-libc-å¸¦æ¥çš„é—®é¢˜"><a href="#musl-libc-å¸¦æ¥çš„é—®é¢˜" class="headerlink" title="musl libc å¸¦æ¥çš„é—®é¢˜"></a><code>musl libc</code> å¸¦æ¥çš„é—®é¢˜</h3><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨ CentOS å’Œ Alpine åŸºç¡€é•œåƒåˆ†åˆ«æ„å»ºå‡ºæ¥çš„é•œåƒï¼Œä½¿ç”¨ ldd æŸ¥çœ‹äºŒè€…ç¼–è¯‘å‡ºæ¥çš„ fastdfs ï¼Œä¸¤è€…çš„åŠ¨æ€é“¾æ¥åº“å­˜åœ¨å¾ˆå¤§çš„å·®å¼‚ï¼Œ Alpine ç¼ºå°‘äº†å¾ˆå¤šåŠ¨æ€é“¾æ¥åº“ï¼Œè¿™æ˜¯å› ä¸º alpine çš„ c åº“æ˜¯ <code>musl libc</code> ï¼Œè€Œä¸æ˜¯æ­£ç»Ÿçš„ <code>glibc</code> ï¼Œå¦å¤–å¯¹äºä¸€äº›ä¾èµ– <code>glibc</code> çš„å¤§å‹é¡¹ç›®ï¼Œåƒ openjdk ã€tomcatã€rabbitmq ç­‰éƒ½ä¸å»ºè®®ä½¿ç”¨ alpine åŸºç¡€é•œåƒï¼Œå› ä¸º  <code>musl libc</code> ä¼šå¯¼è‡´ jvm ä¸€äº›å¥‡æ€ªçš„é—®é¢˜ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ tomcat å®˜æ–¹æ²¡æœ‰ç»™å‡ºåŸºç¡€é•œåƒæ˜¯ alpine çš„ Dockerfile</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">centos<span class="comment"># find /usr/bin/ -name "fdfs*" | xargs ldd</span></span><br><span class="line">        linux-vdso.so.1 =&gt;  (0x00007fffe1d30000)</span><br><span class="line">        libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007f86036e6000)</span><br><span class="line">        libfastcommon.so =&gt; /lib/libfastcommon.so (0x00007f86034a5000)</span><br><span class="line">        libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f86030d8000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x00007f8603902000)</span><br><span class="line">        libm.so.6 =&gt; /lib64/libm.so.6 (0x00007f8602dd6000)</span><br><span class="line">        libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f8602bd2000)</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alpine <span class="comment"># find /usr/bin/ -name "fdfs*" | xargs ldd</span></span><br><span class="line">        /lib/ld-musl-x86_64.so.1 (0x7f4f91585000)</span><br><span class="line">        libfastcommon.so =&gt; /usr/lib/libfastcommon.so (0x7f4f91528000)</span><br><span class="line">        libc.musl-x86_64.so.1 =&gt; /lib/ld-musl-x86_64.so.1 (0x7f4f91585000)</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">debian <span class="comment"># find /usr/bin/ -name "fdfs*" | xargs ldd</span></span><br><span class="line">        linux-vdso.so.1 (0x00007ffd17e50000)</span><br><span class="line">        libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007feadf317000)</span><br><span class="line">        libfastcommon.so =&gt; /usr/lib/libfastcommon.so (0x00007feadf0d6000)</span><br><span class="line">        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007feaded37000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x00007feadf74a000)</span><br><span class="line">        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007feadea33000)</span><br><span class="line">        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007feade82f000)</span><br></pre></td></tr></table></figure>
<h3 id="å®¹å™¨å¯åŠ¨æ–¹æ³•"><a href="#å®¹å™¨å¯åŠ¨æ–¹æ³•" class="headerlink" title="å®¹å™¨å¯åŠ¨æ–¹æ³•"></a>å®¹å™¨å¯åŠ¨æ–¹æ³•</h3><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒFastDFS çš„å®¹å™¨éœ€è¦ä½¿ç”¨ host ç½‘ç»œï¼Œå› ä¸º fastdfs storage æœåŠ¡å™¨éœ€è¦å‘ tracker æœåŠ¡å™¨æ±‡æŠ¥è‡ªå·± IPï¼Œè¿™ä¸ª IP è¿˜éœ€è¦é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼æ³¨å…¥åˆ°ç›¸å…³çš„é…ç½®æ–‡ä»¶å½“ä¸­ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -e FASTDFS_IPADDR=10.10.107.230 \</span><br><span class="line">           -p 28888:28888 -p 22122:22122 -p 23000:23000 -p 28088:28080 \</span><br><span class="line">           -v <span class="variable">$PWD</span>/data:/var/fdfs --net=host --name fastdfs fastdfs:alpine</span><br></pre></td></tr></table></figure>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><h3 id="æµ‹è¯•å·¥å…·"><a href="#æµ‹è¯•å·¥å…·" class="headerlink" title="æµ‹è¯•å·¥å…·"></a>æµ‹è¯•å·¥å…·</h3><ol>
<li>ä¸Šä¼ å®¢æˆ·ç«¯ï¼š<code>fdfs_upload_file</code></li>
<li>å¹¶å‘æ‰§è¡Œå·¥å…· ï¼š<code>xargs</code></li>
<li>æµ‹è¯•æ ·æœ¬ï¼š10W  å¼ è¡¨æƒ…åŒ…å›¾ç‰‡ ï¼Œå¤§å°åœ¨ <strong>8KBâ€“128KB</strong> ä¹‹é—´</li>
<li>ä¸Šä¼ æµ‹è¯•å‘½ä»¤ï¼š<code>time ls  | xargs -n 1 -I {} -P 256 sh -c &quot;/usr/bin/fdfs_upload_file /etc/fdfs/client.conf {}&quot;`</code>-p å‚æ•°æŒ‡å®šå¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡</li>
<li>ä¸‹è½½æµ‹è¯•å·¥å…·ï¼š <code>wget</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ä¸‹è½½æµ‹è¯•å‘½ä»¤ï¼š`time cat url.log  | xargs -n 1 -I &#123;&#125; -P 256 sh -c <span class="string">"wget  &#123;&#125;"</span>`</span><br></pre></td></tr></table></figure>
<h3 id="æ–‡ä»¶ä¸Šä¼ æµ‹è¯•"><a href="#æ–‡ä»¶ä¸Šä¼ æµ‹è¯•" class="headerlink" title="æ–‡ä»¶ä¸Šä¼ æµ‹è¯•"></a>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h3><p>  æµ‹è¯•æ ·æœ¬ä¸º 10W å¼  8KB-100 KB å¤§å°ä¸ç­‰çš„å›¾ç‰‡</p>
<p><img src="https://p.k8s.li/1564128425387.png" alt=""></p>
<p><strong>æµ‹è¯•æ–‡ä»¶æ•°é‡å’Œå¤§å°</strong></p>
<p><img src="https://p.k8s.li/1564128874832.png" alt=""></p>
<p><strong>ä½¿ç”¨ xargs æ‰§è¡Œ 256 ä¸ªè¿›ç¨‹å¹¶å‘ä¸Šä¼  10w å¼ ç…§ç‰‡æ‰€ç”¨æ‰€ç”¨æ—¶é—´ ä¸º 2 åˆ†é’Ÿå·¦å³ï¼ˆå†…ç½‘ï¼‰</strong></p>
<p><img src="https://p.k8s.li/1564128721547.png" alt=""></p>
<p><strong>ç”¨æ—¶ 2 åˆ† 11 ç§’</strong></p>
<p><img src="https://p.k8s.li/1564364594777.png" alt=""></p>
<p><strong>å®¢æˆ·ç«¯è´Ÿè½½æƒ…å†µ</strong></p>
<p><img src="https://p.k8s.li/1564127683217.png" alt=""></p>
<p><strong>æœåŠ¡ç«¯è´Ÿè½½æƒ…å†µ</strong></p>
<p><img src="https://p.k8s.li/1564364294952.png" alt=""></p>
<p><strong>æœåŠ¡ç«¯å¸¦å®½æµé‡</strong></p>
<p><img src="https://p.k8s.li/1564365025177.png" alt=""></p>
<p><strong>æœåŠ¡ç«¯å¸¦å®½æµé‡</strong></p>
<p><img src="https://p.k8s.li/1564363829960.png" alt=""></p>
<p><strong>æœåŠ¡ç«¯ä¸Šä¼ ç»“æœ</strong></p>
<p><img src="https://p.k8s.li/1564125161155.png" alt=""></p>
<p><strong>æœåŠ¡ç«¯ä¸Šä¼ æ—¥å¿—è®°å½• ï¼Œå‡æ— é”™è¯¯è¾“å‡º</strong></p>
<p><img src="https://p.k8s.li/1564130238346.png" alt=""></p>
<h3 id="æ–‡ä»¶ä¸‹è½½æµ‹è¯•"><a href="#æ–‡ä»¶ä¸‹è½½æµ‹è¯•" class="headerlink" title="æ–‡ä»¶ä¸‹è½½æµ‹è¯•"></a>æ–‡ä»¶ä¸‹è½½æµ‹è¯•</h3><p><strong>ä»æ—¥å¿—ä¸­æå–æ–‡ä»¶è·¯å¾„</strong></p>
<p>ä»æœåŠ¡ç«¯çš„ <code>storage_access.log</code> æ—¥å¿—é‡Œæå–å‡ºæ–‡ä»¶çš„è·¯å¾„ï¼Œä½¿ç”¨ <code>sed</code> æ·»åŠ  <code>nginx</code> çš„è®¿é—®ç«¯å£åœ°å€å¾—åˆ° 10W ä¸ªè®°å½• ä¸Šä¼ æ–‡ä»¶çš„ <code>http</code> è®¿é—® <code>url</code> åœ°å€</p>
<p><img src="https://p.k8s.li/1564130789416.png" alt=""></p>
<p><strong>wget ä¸‹è½½</strong></p>
<p>ä½¿ç”¨ <code>wget -i</code> å‚æ•°æŒ‡å®š <code>url.log</code> ä¸ºæ ‡å‡†è¾“å‡ºæ¥æµ‹è¯•ä¸‹è½½åˆšåˆšä¸Šä¼ çš„ 10W å¼ å›¾ç‰‡ ç”¨æ—¶ 3 åˆ† 23 ç§’</p>
<p><img src="https://p.k8s.li/1564023927851.png" alt=""></p>
<h3 id="æµ‹è¯•ç»“æœåˆ†æ"><a href="#æµ‹è¯•ç»“æœåˆ†æ" class="headerlink" title="æµ‹è¯•ç»“æœåˆ†æ"></a>æµ‹è¯•ç»“æœåˆ†æ</h3><p>ä½¿ç”¨ FastDFS è‡ªå¸¦çš„ä¸Šä¼ æµ‹è¯•å·¥å…·å’Œ xargs å¹¶å‘æ‰§è¡Œå·¥å…·ï¼Œé€šè¿‡ xargs -P å‚æ•°æŒ‡å®šçš„å¹¶å‘è¯·æ±‚æ•°ï¼Œæµ‹å¾—ç»“æœä¸ºå•æœºæ€§èƒ½åœ¨ç½‘ç»œç¯å¢ƒç¨³å®šçš„æƒ…å†µä¸‹å¯ä»¥è¾¾åˆ° 5000 å¹¶å‘ä¸Šä¼ è¯·æ±‚ã€‚10W å¼ å›¾ç‰‡ä¸Šä¼ æ—¶é—´è€—æ—¶ 2 åˆ† 11 ç§’å·¦å³ã€‚ä½¿ç”¨å®šæ—¶è„šæœ¬æŒç»­æµ‹è¯•ï¼Œæ€»æµ‹è¯•ä¸Šä¼  100W å¼ å›¾ç‰‡ã€‚åˆ†æ tracker æœåŠ¡å™¨å’Œ storage æœåŠ¡å™¨çš„æ—¥å¿—ï¼Œæ— è®ºä¸Šä¼ è¿˜æ˜¯ä¸‹è½½å‡æœªå‘ç°é”™è¯¯å’Œå¼‚å¸¸ï¼Œæ€§èƒ½å’Œç¨³å®šæ€§è¾ƒå¥½ã€‚</p>
<h2 id="ä¼˜åŒ–å‚æ•°"><a href="#ä¼˜åŒ–å‚æ•°" class="headerlink" title="ä¼˜åŒ–å‚æ•°"></a>ä¼˜åŒ–å‚æ•°</h2><p>æ ¹æ®ä¸šåŠ¡éœ€æ±‚å’Œçº¿ä¸Šç¯å¢ƒè°ƒæ•´ä¸€ä¸‹å‚æ•°ï¼Œå¯å……åˆ†å‘æŒ¥ FastDFS æ–‡ä»¶ç³»ç»Ÿçš„æ€§èƒ½</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¥æ”¶è¯·æ±‚çš„çº¿ç¨‹æ•°æ•°é‡</span></span><br><span class="line"><span class="attr">accept_threads</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># work thread count, should &lt;= max_connections</span></span><br><span class="line"><span class="comment"># default value is 4</span></span><br><span class="line"><span class="comment"># since V2.00</span></span><br><span class="line"><span class="comment"># å·¥ä½œçº¿ç¨‹æ•°é‡ï¼Œåº”å½“å°äºç­‰äºæœ€å¤§è¿æ¥æ•°</span></span><br><span class="line"><span class="attr">work_threads</span>=<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># min buff size</span></span><br><span class="line"><span class="comment"># default value 8KB</span></span><br><span class="line"><span class="comment"># æœ€å°ç¼“å†²å¤§å°ï¼Œé»˜è®¤å€¼ä¸º 8KB</span></span><br><span class="line"><span class="attr">min_buff_size</span> = <span class="number">8</span>KB</span><br><span class="line"></span><br><span class="line"><span class="comment"># max buff size</span></span><br><span class="line"><span class="comment"># default value 128KB</span></span><br><span class="line"><span class="comment"># æœ€å¤§ç¼“å†²å¤§å°ï¼Œé»˜è®¤å€¼ä¸º 128KB</span></span><br><span class="line"><span class="attr">max_buff_size</span> = <span class="number">128</span>KB</span><br><span class="line"></span><br><span class="line"><span class="comment"># thread stack size, should &gt;= 64KB</span></span><br><span class="line"><span class="comment"># default value is 256KB</span></span><br><span class="line"><span class="comment"># çº¿ç¨‹æ ˆçš„å¤§å°ï¼Œåº”å½“å¤§äº 64KBï¼Œé»˜è®¤ä¸º 256KB</span></span><br><span class="line"><span class="attr">thread_stack_size</span> = <span class="number">256</span>KB</span><br><span class="line"></span><br><span class="line"><span class="comment"># if use connection pool</span></span><br><span class="line"><span class="comment"># default value is false</span></span><br><span class="line"><span class="comment"># since V4.05</span></span><br><span class="line"><span class="comment"># æ˜¯å¦ä½¿ç”¨è¿æ¥æ± </span></span><br><span class="line"><span class="attr">use_connection_pool</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># connections whose the idle time exceeds this time will be closed</span></span><br><span class="line"><span class="comment"># unit: second</span></span><br><span class="line"><span class="comment"># default value is 3600</span></span><br><span class="line"><span class="comment"># since V4.05</span></span><br><span class="line"><span class="comment"># è¿æ¥æ± çš„æœ€å¤§ç©ºé—²æ—¶é—´</span></span><br><span class="line"><span class="attr">connection_pool_max_idle_time</span> = <span class="number">3600</span></span><br></pre></td></tr></table></figure>
<h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><h4 id="æ— æ³•è¿æ¥åˆ°-tracker-æœåŠ¡å™¨"><a href="#æ— æ³•è¿æ¥åˆ°-tracker-æœåŠ¡å™¨" class="headerlink" title="æ— æ³•è¿æ¥åˆ° tracker æœåŠ¡å™¨"></a>æ— æ³•è¿æ¥åˆ° tracker æœåŠ¡å™¨</h4><p>éœ€è¦åœ¨ tracker.conf é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å…è®¸è®¿é—®çš„ IP ,å¹¶æ·»åŠ é˜²ç«å¢™è§„åˆ™</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[2019-07-25 10:40:54] ERROR - file: ../client/storage_client.c, line: 996, fdfs_recv_response fail, result: 107</span><br><span class="line">upload file fail, error no: 107, error info: Transport endpoint is not connected</span><br><span class="line">[2019-07-25 10:40:54] ERROR - file: tracker_proto.c, line: 37, server: 10.20.172.192:23000, recv data fail, errno: 107, error info: Transport endpoint is not connected</span><br></pre></td></tr></table></figure>
<h4 id="æœåŠ¡å™¨ç£ç›˜ç”¨å°½"><a href="#æœåŠ¡å™¨ç£ç›˜ç”¨å°½" class="headerlink" title="æœåŠ¡å™¨ç£ç›˜ç”¨å°½"></a>æœåŠ¡å™¨ç£ç›˜ç”¨å°½</h4><p>å½“ storage æœåŠ¡å™¨è®¾å®šçš„ä¸Šä¼ å­˜å‚¨ç›®å½•æ‰€åœ¨çš„åˆ†åŒºç£ç›˜ç”¨å°½å°†ä¼šå‡ºç°æ— å‰©ä½™ç©ºé—´çš„é”™è¯¯æ—¥å¿—</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[2019-07-26 16:16:45] ERROR - file: tracker_proto.c, line: 48, server: 10.10.107.232:22122, response status 28 != 0</span><br><span class="line">[2019-07-26 16:16:45] ERROR - file: ../client/tracker_client.c, line: 907, fdfs_recv_response fail, result: 28</span><br><span class="line">tracker_query_storage fail, error no: 28, error info: No space left on device</span><br></pre></td></tr></table></figure>
<h4 id="é‡å¯æœåŠ¡æ—¶å¤±è´¥"><a href="#é‡å¯æœåŠ¡æ—¶å¤±è´¥" class="headerlink" title="é‡å¯æœåŠ¡æ—¶å¤±è´¥"></a>é‡å¯æœåŠ¡æ—¶å¤±è´¥</h4><p>ä½¿ç”¨ service fdfs_trackerd restart é‡å¯ tracker æˆ–è€… storage æœåŠ¡æ—¶ä¼šæŠ¥é”™ï¼Œä¼šæç¤ºç«¯å£å·²ç»å ç”¨ã€‚è§£å†³çš„æ–¹æ¡ˆå°±æ˜¯ä½¿ç”¨ kill -9 å‘½ä»¤æ€æ­» tracker æœåŠ¡æˆ–è€… storage æœåŠ¡ï¼Œç„¶åå†é‡æ–°å¯åŠ¨ç›¸åº”æœåŠ¡å³å¯</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[2019-07-25 10:36:55] INFO - FastDFS v5.12, base_path=/home/dfs, run_by_group=, run_by_user=, connect_timeout=10s, network_timeout=60s, port=22122, bind_addr=, max_connections=1024, accept_threads=1, work_threads=4, min_buff_size=8,192, max_buff_size=131,072, store_lookup=2, store_group=, store_server=0, store_path=0, reserved_storage_space=10.00%, download_server=0, allow_ip_count=-1, sync_log_buff_interval=10s, check_active_interval=120s, thread_stack_size=256 KB, storage_ip_changed_auto_adjust=1, storage_sync_file_max_delay=86400s, storage_sync_file_max_time=300s, use_trunk_file=0, slot_min_size=256, slot_max_size=16 MB, trunk_file_size=64 MB, trunk_create_file_advance=0, trunk_create_file_time_base=02:00, trunk_create_file_interval=86400, trunk_create_file_space_threshold=20 GB, trunk_init_check_occupying=0, trunk_init_reload_from_binlog=0, trunk_compress_binlog_min_interval=0, use_storage_id=0, id_type_in_filename=ip, storage_id_count=0, rotate_error_log=0, error_log_rotate_time=00:00, rotate_error_log_size=0, log_file_keep_days=0, store_slave_file_use_link=0, use_connection_pool=0, g_connection_pool_max_idle_time=3600s</span><br><span class="line">[2019-07-25 10:36:55] ERROR - file: sockopt.c, line: 868, <span class="built_in">bind</span> port 22122 failed, errno: 98, error info: Address already <span class="keyword">in</span> use.</span><br><span class="line">[2019-07-25 10:36:55] CRIT - <span class="built_in">exit</span> abnormally!</span><br></pre></td></tr></table></figure>
<h3 id="å®‰å…¨ç›¸å…³"><a href="#å®‰å…¨ç›¸å…³" class="headerlink" title="å®‰å…¨ç›¸å…³"></a>å®‰å…¨ç›¸å…³</h3><ol>
<li>tracker.conf ã€storage.conf é…ç½®æ–‡ä»¶é»˜è®¤å…è®¸æ‰€æœ‰ IP åœ°å€è®¿é—® ï¼Œå»ºè®®å»æ‰  <code>allow_hosts=*</code> ä¿®æ”¹ä¸º FastDFS å®¢æˆ·ç«¯æ‰€åœ¨çš„å†…ç½‘ IP åœ°å€ã€‚</li>
</ol>
<p><img src="https://p.k8s.li/1564384530137.png" alt=""></p>
<p>2.tracker.conf ã€storage.conf  é»˜è®¤é…ç½®æ–‡ä»¶ç›‘å¬çš„åœ°å€ä¸º 0.0.0.0 å³æœ¬æœºæ‰€æœ‰çš„ IP åœ°å€ï¼Œå»ºè®®ä¿®æ”¹ä¸º FastDFS æœåŠ¡å™¨æ‰€åœ¨çš„å†…ç½‘ IP åœ°å€ã€‚</p>
<p><img src="https://p.k8s.li/1564384711746.png" alt=""></p>
<p>3.é»˜è®¤è¿è¡Œç”¨æˆ·ä¸ºå½“å‰ç”¨æˆ·å’Œç”¨æˆ·ç»„ä¸ºå½“å‰ç”¨æˆ·ï¼Œå»ºè®®æŒ‡å®šä¸ºæƒé™æœ€å°çš„ç”¨æˆ·æ¥è¿è¡Œæ­¤è¿›ç¨‹ã€‚</p>
<p><img src="https://p.k8s.li/1564384906456.png" alt=""></p>
    </div>
      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Docker/" rel="tag"><i class="fa fa-tag"></i> Docker</a>
              <a href="/tags/FastDFS/" rel="tag"><i class="fa fa-tag"></i> FastDFS</a>
          </div>
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/esp8266-pc-switch.html" rel="prev" title="ä½¿ç”¨ ESP8266 NodeMCU æ‰“é€  WiFi å¼€å…³">
      <i class="fa fa-chevron-left"></i> ä½¿ç”¨ ESP8266 NodeMCU æ‰“é€  WiFi å¼€å…³
    </a></div>
      <div class="post-nav-item">
    <a href="/fastdfs-lua-redis.html" rel="next" title="Lua + Redis å¯¹ nginx åšåŠ¨æ€è·¯ç”±">
      Lua + Redis å¯¹ nginx åšåŠ¨æ€è·¯ç”± <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
  </article>
  </div>
          </div>
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
        </div>
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>
  <aside class="sidebar">
    <div class="sidebar-inner">
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>
      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#å‰è¨€"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ„å»º-docker-é•œåƒ"><span class="nav-number">2.</span> <span class="nav-text">æ„å»º docker é•œåƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å‡†å¤‡é…ç½®æ–‡ä»¶"><span class="nav-number">2.1.</span> <span class="nav-text">å‡†å¤‡é…ç½®æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¿®æ”¹é…ç½®æ–‡ä»¶"><span class="nav-number">2.2.</span> <span class="nav-text">ä¿®æ”¹é…ç½®æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile"><span class="nav-number">2.3.</span> <span class="nav-text">Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ„ä¸åŒåŸºç¡€é•œåƒæ„å»ºå‡ºçš„å¤§å°å¯¹æ¯”"><span class="nav-number">2.4.</span> <span class="nav-text">æ„ä¸åŒåŸºç¡€é•œåƒæ„å»ºå‡ºçš„å¤§å°å¯¹æ¯”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#musl-libc-å¸¦æ¥çš„é—®é¢˜"><span class="nav-number">2.5.</span> <span class="nav-text">musl libc å¸¦æ¥çš„é—®é¢˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å®¹å™¨å¯åŠ¨æ–¹æ³•"><span class="nav-number">2.6.</span> <span class="nav-text">å®¹å™¨å¯åŠ¨æ–¹æ³•</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æµ‹è¯•"><span class="nav-number">3.</span> <span class="nav-text">æµ‹è¯•</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æµ‹è¯•å·¥å…·"><span class="nav-number">3.1.</span> <span class="nav-text">æµ‹è¯•å·¥å…·</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ–‡ä»¶ä¸Šä¼ æµ‹è¯•"><span class="nav-number">3.2.</span> <span class="nav-text">æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ–‡ä»¶ä¸‹è½½æµ‹è¯•"><span class="nav-number">3.3.</span> <span class="nav-text">æ–‡ä»¶ä¸‹è½½æµ‹è¯•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æµ‹è¯•ç»“æœåˆ†æ"><span class="nav-number">3.4.</span> <span class="nav-text">æµ‹è¯•ç»“æœåˆ†æ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¼˜åŒ–å‚æ•°"><span class="nav-number">4.</span> <span class="nav-text">ä¼˜åŒ–å‚æ•°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¸¸è§é—®é¢˜"><span class="nav-number">5.</span> <span class="nav-text">å¸¸è§é—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å®‰å…¨ç›¸å…³"><span class="nav-number">5.1.</span> <span class="nav-text">å®‰å…¨ç›¸å…³</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->
      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="æœ¨å­"
      src="https://blog.k8s.li/avatar.png">
  <p class="site-author-name" itemprop="name">æœ¨å­</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">98</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:blog@502.li" title="E-Mail â†’ mailto:blog@502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://kindle.502.li/" title="Kindle â†’ https:&#x2F;&#x2F;kindle.502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tg.k8s.li/" title="Channel â†’ https:&#x2F;&#x2F;tg.k8s.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Channel</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>
      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>
      </div>
    </main>
    <footer class="footer">
      <div class="footer-inner">
<div class="copyright">
  &copy; 2018 â€“ 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">æœ¨å­</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">39:50</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>
      </div>
    </footer>
  </div>
  <script src="/lib/anime.min.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>
<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://muzi.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://blog.k8s.li/docker-deploy-fastdfs.html",
            identifier: "docker-deploy-fastdfs.html",
            title: "Docker éƒ¨ç½² FastDFS"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://muzi.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>
</body>
</html>
