<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.k8s.li').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>
  <meta name="description" content="前言如果你的 FastDFS 文件系统需要高可用，需要部署在多台机器上的话，并且你的这些服务器上只跑 FastDFS 这个服务，那么 FastDFS 可能并不适合用 Docker 来部署，按照官方文档直接部署在机器上就可以，没必要采用容器来部署。其实 FastDFS 并不适合容器化部署，因为 tracker 服务器向 storage 服务器报告自己的 IP， 而这个 IP 是容器内的 IP 。是">
<meta property="og:type" content="article">
<meta property="og:title" content="Docker 部署 FastDFS">
<meta property="og:url" content="https://blog.k8s.li/docker-deploy-fastdfs.html">
<meta property="og:site_name" content="木子">
<meta property="og:description" content="前言如果你的 FastDFS 文件系统需要高可用，需要部署在多台机器上的话，并且你的这些服务器上只跑 FastDFS 这个服务，那么 FastDFS 可能并不适合用 Docker 来部署，按照官方文档直接部署在机器上就可以，没必要采用容器来部署。其实 FastDFS 并不适合容器化部署，因为 tracker 服务器向 storage 服务器报告自己的 IP， 而这个 IP 是容器内的 IP 。是">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/1569728664464.png">
<meta property="og:image" content="https://p.k8s.li/1569728744655.png">
<meta property="og:image" content="https://p.k8s.li/1569729043301.png">
<meta property="og:image" content="https://p.k8s.li/1564128425387.png">
<meta property="og:image" content="https://p.k8s.li/1564128874832.png">
<meta property="og:image" content="https://p.k8s.li/1564128721547.png">
<meta property="og:image" content="https://p.k8s.li/1564364594777.png">
<meta property="og:image" content="https://p.k8s.li/1564127683217.png">
<meta property="og:image" content="https://p.k8s.li/1564364294952.png">
<meta property="og:image" content="https://p.k8s.li/1564365025177.png">
<meta property="og:image" content="https://p.k8s.li/1564363829960.png">
<meta property="og:image" content="https://p.k8s.li/1564125161155.png">
<meta property="og:image" content="https://p.k8s.li/1564130238346.png">
<meta property="og:image" content="https://p.k8s.li/1564130789416.png">
<meta property="og:image" content="https://p.k8s.li/1564023927851.png">
<meta property="og:image" content="https://p.k8s.li/1564384530137.png">
<meta property="og:image" content="https://p.k8s.li/1564384711746.png">
<meta property="og:image" content="https://p.k8s.li/1564384906456.png">
<meta property="article:published_time" content="2019-09-24T16:00:00.000Z">
<meta property="article:modified_time" content="2021-05-30T14:38:18.392Z">
<meta property="article:author" content="木子">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="FastDFS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/1569728664464.png">
<link rel="canonical" href="https://blog.k8s.li/docker-deploy-fastdfs.html">
<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>
  <title>Docker 部署 FastDFS | 木子</title>
  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }
  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>
<link rel="alternate" href="/atom.xml" title="木子" type="application/atom+xml">
</head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">
    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">木子</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>
<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">
    <a href="/" rel="section"><i class="fa fa-fw fa-desktop"></i>Home</a>
  </li>
        <li class="menu-item menu-item-books">
    <a href="/booklist.html" rel="section"><i class="fa fa-fw fa-book"></i>Books</a>
  </li>
        <li class="menu-item menu-item-kindle">
    <a href="https://kindle.502.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
  </li>
        <li class="menu-item menu-item-friend">
    <a href="/link/" rel="section"><i class="fa fa-fw fa-link"></i>Friend</a>
  </li>
        <li class="menu-item menu-item-about">
    <a href="/about.html" rel="section"><i class="fa fa-fw fa-user-circle-o"></i>About</a>
  </li>
  </ul>
</nav>
</div>
    </header>
  <div class="reading-progress-bar"></div>
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
  <div class="posts-expand">
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/docker-deploy-fastdfs.html">
    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog.k8s.li/avatar.png">
      <meta itemprop="name" content="木子">
      <meta itemprop="description" content="">
    </span>
    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="木子">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          Docker 部署 FastDFS
        </h2>
        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="创建时间：2019-09-25 2019-09-25T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2019-09-25T00:00:00+08:00">2019-09-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-30 2021-05-30T22:38:18+08:00" itemprop="dateModified" datetime="2021-05-30T22:38:18+08:00">2021-05-30</time>
              </span>
  <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    <a title="disqus" href="/docker-deploy-fastdfs.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="docker-deploy-fastdfs.html" itemprop="commentCount"></span>
    </a>
  </span>
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>21 分钟</span>
            </span>
        </div>
      </header>
    <div class="post-body" itemprop="articleBody">
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>如果你的 FastDFS 文件系统需要高可用，需要部署在多台机器上的话，并且你的这些服务器上只跑 FastDFS 这个服务，那么 FastDFS 可能并不适合用 Docker 来部署，按照官方文档直接部署在机器上就可以，没必要采用容器来部署。其实 FastDFS 并不适合容器化部署，因为 tracker 服务器向 storage 服务器报告自己的 IP， 而这个 IP 是容器内的 IP 。是 Docker 的一个私有 IP 段，这将导致客户端无法访问 storage 服务器。当然如果使用 host 网络或者能打通客户端到 storage 的网络解决方案，比如 flannel ，calico 等，这都可以，在 Kubernetes 基于服务发现，客户端也可以访问到 storage 服务器。</p>
<p>那么 FastDFS 采用 Docker 部署适用于什么场景呢？其实比较适合中小型的项目，对高可用，高性能要求不大的情况下。或者将 FastDFS 所有的服务封装在一个容器里运行，和其他服务一起使用 docker-compose 启动，这样用再适合不过了。我的项目就是这种场景，由于服务器资源有限，不可能去单独部署一个 FastDFS 服务器集群，巴拉巴拉整个高可用。所有的项目组件都采用 Docker 部署在一台机器上，FastDFS 里的  nginx 也是没有单独去部署，和 tracker、storage 服务器一起装在一个容器里。为了节省资源没得办法😂</p>
<h2 id="构建-docker-镜像"><a href="#构建-docker-镜像" class="headerlink" title="构建 docker 镜像"></a>构建 docker 镜像</h2><p>官方给出了两种构建 docker 镜像的方式，但是我感觉都不好，一是使用的 的是 centos 基础镜像构建，构建出来的大小将近，根本就不用区分本地构建或者网络构建。你构建的整个过程都要都需要连接外网下载构建的包之类的，还用区分什么网络构建和本地构建？所以在这里我们仅仅需要准备配置文件即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> ╭─root@docker-230 ~/root/container/fastdfs/fastdfs/docker/dockerfile_network ‹master›</span><br><span class="line">╰─<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">fastdfs             centos              c1488537c23c        8 seconds ago       483MB</span><br></pre></td></tr></table></figure>
<h3 id="准备配置文件"><a href="#准备配置文件" class="headerlink" title="准备配置文件"></a>准备配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将所有的配置文件一并放到 conf 目录下</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">mkdir  -p fastdfs/conf</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs.git --depth 1</span><br><span class="line">cp -rf fastdfs/docker/dockerfile_local/conf/* conf</span><br><span class="line">cp fastdfs/docker/dockerfile_local/fastdfs.sh conf</span><br><span class="line">touch Dockerfile.debian</span><br><span class="line">touch Dockerfile.alpine</span><br><span class="line"><span class="comment"># 复制出来配置文件，把源码移除掉就可以</span></span><br><span class="line">rm -rf fastdfs</span><br></pre></td></tr></table></figure>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>所有的配置文件都在 conf 里，我们根据自身的需要修改一下各个配置文件即可，关于 fastdfs 配置文件的各个参数可以去参考一下下面的博客。</p>
<ul>
<li><p><a href="https://www.cnblogs.com/chiangchou/p/fastdfs.html" target="_blank" rel="noopener">用FastDFS一步步搭建文件管理系统</a></p>
</li>
<li><p><a href="https://mhl.xyz/Linux/fastdfs-tracker-storage.html" target="_blank" rel="noopener">FastDFS配置参数tracker.conf、storage.conf详解</a></p>
</li>
</ul>
<p>我修改了默认的配置，数据存放目录修改成了 <code>/var/fdfs</code> ,在写 <code>Dockerfile</code> 的时候需要建立这个目录，如果你的目录没有修改的话，就把 Dockerfile 里后面那里建立文件夹的路径修改成默认的即可。</p>
<p>把 <code>tracker_server</code> 修改成 <code>tracker_server=tracker_ip:22122</code> ，容器启动的时候使用环境变量注入的 <code>FASTDFS_IPADDR</code> 替换掉就可以。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">╭─root@debian-deploy-132 ~/fastdfs/conf</span><br><span class="line">╰─<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">├── client.conf             <span class="comment"># C 语言版本客户端配置文件，可以忽略</span></span><br><span class="line">├── fastdfs.sh              <span class="comment"># docker 容器启动 fastdfs 服务的脚本</span></span><br><span class="line">├── http.conf               <span class="comment"># http 配置文件，参考官方文档</span></span><br><span class="line">├── mime.types              <span class="comment">#</span></span><br><span class="line">├── mod_fastdfs.conf        <span class="comment"># fastdfs nginx 模块配置文件</span></span><br><span class="line">├── nginx.conf              <span class="comment"># nginx 配置文件，根据自身项目修改</span></span><br><span class="line">├── storage.conf            <span class="comment"># storage 服务配置文件</span></span><br><span class="line">└── tracker.conf            <span class="comment"># tracker 服务配置文件</span></span><br></pre></td></tr></table></figure>
<h4 id="tracker-服务配置文件-tracker-conf"><a href="#tracker-服务配置文件-tracker-conf" class="headerlink" title="tracker 服务配置文件 tracker.conf"></a>tracker 服务配置文件 tracker.conf</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">disabled</span>=<span class="literal">false</span>                <span class="comment">#启用配置文件</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">22122</span>                    <span class="comment">#设置tracker的端口号</span></span><br><span class="line"><span class="attr">base_path</span>=/var/dfs           <span class="comment">#设置tracker的数据文件和日志目录（需预先创建）</span></span><br><span class="line"><span class="attr">http.server_port</span>=<span class="number">28080</span>         <span class="comment">#设置http端口号</span></span><br></pre></td></tr></table></figure>
<h4 id="storage-服务配置文件-storage-ids-conf"><a href="#storage-服务配置文件-storage-ids-conf" class="headerlink" title="storage 服务配置文件 storage_ids.conf"></a>storage 服务配置文件 storage_ids.conf</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># storage服务端口</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">23000</span>                         <span class="comment"># 监听端口号</span></span><br><span class="line"><span class="attr">base_path</span>=/var/dfs                <span class="comment"># 数据和日志文件存储根目录</span></span><br><span class="line"><span class="attr">store_path0</span>=/var/dfs              <span class="comment"># 第一个存储目录</span></span><br><span class="line"><span class="attr">tracker_server</span>=tracker_ip:<span class="number">22122</span>    <span class="comment"># tracker服务器IP和端口</span></span><br><span class="line"><span class="attr">http.server_port</span>=<span class="number">28888</span></span><br></pre></td></tr></table></figure>
<h4 id="nginx-配置文件-nginx-conf"><a href="#nginx-配置文件-nginx-conf" class="headerlink" title="nginx 配置文件 nginx.conf"></a>nginx 配置文件 nginx.conf</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 nginx 配置文件中添加修改下面这段</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">28888</span>;    <span class="comment">## 该端口为storage.conf中的http.server_port相同</span></span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line">    <span class="attribute">location</span> ~/group[<span class="number">0</span>-<span class="number">9</span>]/ &#123;</span><br><span class="line">        ngx_fastdfs_module;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">    <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">    <span class="attribute">root</span>   html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="nginx-模块配置文件-mod-fastdfs-conf"><a href="#nginx-模块配置文件-mod-fastdfs-conf" class="headerlink" title="nginx 模块配置文件 mod_fastdfs.conf"></a>nginx 模块配置文件 mod_fastdfs.conf</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tracker_server</span>=tracker_ip:<span class="number">22122</span>   <span class="comment"># tracker服务器IP和端口</span></span><br><span class="line"><span class="attr">url_have_group_name</span>=<span class="literal">true</span>             <span class="comment"># url 中包含 group 的名称</span></span><br><span class="line"><span class="attr">store_path0</span>=/var/dfs                <span class="comment"># 数据和日志文件存储根目录</span></span><br></pre></td></tr></table></figure>
<h4 id="fastdfs-服务的脚本-fastdfs-sh"><a href="#fastdfs-服务的脚本-fastdfs-sh" class="headerlink" title="fastdfs 服务的脚本 fastdfs.sh"></a>fastdfs 服务的脚本 fastdfs.sh</h4><p>官方的脚本写的很随意，我就修改了一哈，不修改按照官方的来也 ok</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">new_val=<span class="variable">$FASTDFS_IPADDR</span></span><br><span class="line">old=<span class="string">"tracker_ip"</span></span><br><span class="line"></span><br><span class="line">sed -i <span class="string">"s/<span class="variable">$old</span>/<span class="variable">$new_val</span>/g"</span> /etc/fdfs/storage.conf</span><br><span class="line">sed -i <span class="string">"s/<span class="variable">$old</span>/<span class="variable">$new_val</span>/g"</span> /etc/fdfs/mod_fastdfs.conf</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"start trackerd"</span></span><br><span class="line">/etc/init.d/fdfs_trackerd start</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"start storage"</span></span><br><span class="line">/etc/init.d/fdfs_storaged start</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"start nginx"</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br><span class="line"></span><br><span class="line">tail -f  /dev/null</span><br></pre></td></tr></table></figure>
<h4 id="把-bash-替换成-sh"><a href="#把-bash-替换成-sh" class="headerlink" title="把 bash 替换成 sh"></a>把 bash 替换成 sh</h4><p>其实这一步骤可以不做，使用 bash 启动的话，需要在 alpine 安装 bash ，会增加 6MB 左右的镜像大小，感觉也没必要这样做😂</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">'s/bash/sh/g'</span> `grep -nr bash | awk -F <span class="string">':'</span> <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换后</span></span><br><span class="line">grep -nr \<span class="comment">#\!\/bin\/sh</span></span><br><span class="line">stop.sh:1:<span class="comment">#!/bin/sh</span></span><br><span class="line">init.d/fdfs_storaged:1:<span class="comment">#!/bin/sh</span></span><br><span class="line">init.d/fdfs_trackerd:1:<span class="comment">#!/bin/sh</span></span><br><span class="line">conf/fastdfs.sh:1:<span class="comment">#!/bin/sh</span></span><br><span class="line">restart.sh:1:<span class="comment">#!/bin/sh</span></span><br><span class="line">docker/dockerfile_local/fastdfs.sh:1:<span class="comment">#!/bin/sh</span></span><br><span class="line">docker/dockerfile_network/fastdfs.sh:1:<span class="comment">#!/bin/sh</span></span><br></pre></td></tr></table></figure>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><h4 id="alpine-3-10"><a href="#alpine-3-10" class="headerlink" title="alpine:3.10"></a>alpine:3.10</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> conf/ /home</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -xe \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"http://mirrors.aliyun.com/alpine/latest-stable/main/"</span> &gt; /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"http://mirrors.aliyun.com/alpine/latest-stable/community/"</span> &gt;&gt; /etc/apk/repositories \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk add --no-cache --virtual .build-deps alpine-sdk gcc libc-dev make perl-dev openssl-dev pcre-dev zlib-dev tzdata \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/Shanghai"</span> &gt; /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p /usr/<span class="built_in">local</span>/src \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src \</span></span><br><span class="line"><span class="bash">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/libfastcommon.git --depth 1 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs.git --depth 1    \</span></span><br><span class="line"><span class="bash">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs-nginx-module.git --depth 1  \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget http://nginx.org/download/nginx-1.15.4.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -xf nginx-1.15.4.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/libfastcommon \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">'s/sys\/poll\.h/poll\.h/g'</span> src/sockopt.c \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/fastdfs/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/nginx-1.15.4/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./configure --add-module=/usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make &amp;&amp; make install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk del .build-deps tzdata \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apk add --no-cache pcre-dev bash \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p /var/fdfs /home/fastdfs/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /home/fastdfs.sh /home/fastdfs/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /home/*.conf /home/mime.types /etc/fdfs \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /home/nginx.conf /usr/<span class="built_in">local</span>/nginx/conf/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod +x /home/fastdfs/fastdfs.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">'s/bash/sh/g'</span> /etc/init.d/fdfs_storaged \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">'s/bash/sh/g'</span> /etc/init.d/fdfs_trackerd \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">'s/bash/sh/g'</span> /home/fastdfs/fastdfs.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /usr/<span class="built_in">local</span>/src/* /var/cache/apk/* /tmp/* /var/tmp/* <span class="variable">$HOME</span>/.cache</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /var/fdfs</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">22122</span> <span class="number">23000</span> <span class="number">28888</span> <span class="number">28080</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/home/fastdfs/fastdfs.sh"</span>]</span></span><br></pre></td></tr></table></figure>
<h4 id="debian-stretch-slim"><a href="#debian-stretch-slim" class="headerlink" title="debian:stretch-slim"></a>debian:stretch-slim</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> debian:stretch-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> conf/ /home/</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">set</span> -x \</span></span><br><span class="line"><span class="bash">    &amp;&amp; cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">"Asia/shanghai"</span> &gt; /etc/timezone \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">'s/deb.debian.org/mirrors.aliyun.com/g'</span> /etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; sed -i <span class="string">'s|security.debian.org/debian-security|mirrors.aliyun.com/debian-security|g'</span> /etc/apt/sources.list \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt install  --no-install-recommends --no-install-suggests -y build-essential libpcre3 libpcre3-dev zlib1g \</span></span><br><span class="line"><span class="bash">                   git wget ca-certificates  zlib1g-dev libtool libssl-dev \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p /usr/<span class="built_in">local</span>/src \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src \</span></span><br><span class="line"><span class="bash">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/libfastcommon.git --depth 1 \</span></span><br><span class="line"><span class="bash">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs.git --depth 1    \</span></span><br><span class="line"><span class="bash">    &amp;&amp; git <span class="built_in">clone</span> https://github.com/happyfish100/fastdfs-nginx-module.git --depth 1  \</span></span><br><span class="line"><span class="bash">    &amp;&amp; wget http://nginx.org/download/nginx-1.15.4.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; tar -xf nginx-1.15.4.tar.gz \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/libfastcommon \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/fastdfs/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./make.sh install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/nginx-1.15.4/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; ./configure --add-module=/usr/<span class="built_in">local</span>/src/fastdfs-nginx-module/src/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; make &amp;&amp; make install \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt purge -y build-essential libtool git wget ca-certificates \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt autoremove -y \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p /var/dfs /home/fastdfs/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /home/fastdfs.sh /home/fastdfs/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /home/*.conf /home/mime.types /etc/fdfs \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mv /home/nginx.conf /usr/<span class="built_in">local</span>/nginx/conf/ \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod +x /home/fastdfs/fastdfs.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; rm -rf /var/lib/apt/list  /usr/<span class="built_in">local</span>/src/*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /var/fdfs</span></span><br><span class="line"><span class="keyword">EXPOSE</span>  <span class="number">22122</span> <span class="number">23000</span> <span class="number">28888</span> <span class="number">28080</span></span><br></pre></td></tr></table></figure>
<h3 id="构不同基础镜像构建出的大小对比"><a href="#构不同基础镜像构建出的大小对比" class="headerlink" title="构不同基础镜像构建出的大小对比"></a>构不同基础镜像构建出的大小对比</h3><p>哭了，官方构建出来的镜像将近 500MB</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fastdfs             alpine              e855bd197dbe        10 seconds ago      29.3MB</span><br><span class="line">fastdfs             debian              e05ca1616604        20 minutes ago      103MB</span><br><span class="line">fastdfs             centos              c1488537c23c        30 minutes ago      483MB</span><br></pre></td></tr></table></figure>
<h4 id="使用-dive-分析各个镜像"><a href="#使用-dive-分析各个镜像" class="headerlink" title="使用 dive 分析各个镜像"></a>使用 dive 分析各个镜像</h4><p>官方的</p>
<p><img src="https://p.k8s.li/1569728664464.png" alt=""></p>
<h4 id="alpine"><a href="#alpine" class="headerlink" title="alpine"></a>alpine</h4><p>基于 alpine 的基础镜像构建完成后，只有三层镜像😂</p>
<p><img src="https://p.k8s.li/1569728744655.png" alt=""></p>
<h4 id="debian"><a href="#debian" class="headerlink" title="debian"></a>debian</h4><p><img src="https://p.k8s.li/1569729043301.png" alt=""></p>
<h3 id="musl-libc-带来的问题"><a href="#musl-libc-带来的问题" class="headerlink" title="musl libc 带来的问题"></a><code>musl libc</code> 带来的问题</h3><p>不过需要注意的是，使用 CentOS 和 Alpine 基础镜像分别构建出来的镜像，使用 ldd 查看二者编译出来的 fastdfs ，两者的动态链接库存在很大的差异， Alpine 缺少了很多动态链接库，这是因为 alpine 的 c 库是 <code>musl libc</code> ，而不是正统的 <code>glibc</code> ，另外对于一些依赖 <code>glibc</code> 的大型项目，像 openjdk 、tomcat、rabbitmq 等都不建议使用 alpine 基础镜像，因为  <code>musl libc</code> 会导致 jvm 一些奇怪的问题。这也是为什么 tomcat 官方没有给出基础镜像是 alpine 的 Dockerfile</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">centos<span class="comment"># find /usr/bin/ -name "fdfs*" | xargs ldd</span></span><br><span class="line">        linux-vdso.so.1 =&gt;  (0x00007fffe1d30000)</span><br><span class="line">        libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007f86036e6000)</span><br><span class="line">        libfastcommon.so =&gt; /lib/libfastcommon.so (0x00007f86034a5000)</span><br><span class="line">        libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f86030d8000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x00007f8603902000)</span><br><span class="line">        libm.so.6 =&gt; /lib64/libm.so.6 (0x00007f8602dd6000)</span><br><span class="line">        libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f8602bd2000)</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alpine <span class="comment"># find /usr/bin/ -name "fdfs*" | xargs ldd</span></span><br><span class="line">        /lib/ld-musl-x86_64.so.1 (0x7f4f91585000)</span><br><span class="line">        libfastcommon.so =&gt; /usr/lib/libfastcommon.so (0x7f4f91528000)</span><br><span class="line">        libc.musl-x86_64.so.1 =&gt; /lib/ld-musl-x86_64.so.1 (0x7f4f91585000)</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">debian <span class="comment"># find /usr/bin/ -name "fdfs*" | xargs ldd</span></span><br><span class="line">        linux-vdso.so.1 (0x00007ffd17e50000)</span><br><span class="line">        libpthread.so.0 =&gt; /lib/x86_64-linux-gnu/libpthread.so.0 (0x00007feadf317000)</span><br><span class="line">        libfastcommon.so =&gt; /usr/lib/libfastcommon.so (0x00007feadf0d6000)</span><br><span class="line">        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007feaded37000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x00007feadf74a000)</span><br><span class="line">        libm.so.6 =&gt; /lib/x86_64-linux-gnu/libm.so.6 (0x00007feadea33000)</span><br><span class="line">        libdl.so.2 =&gt; /lib/x86_64-linux-gnu/libdl.so.2 (0x00007feade82f000)</span><br></pre></td></tr></table></figure>
<h3 id="容器启动方法"><a href="#容器启动方法" class="headerlink" title="容器启动方法"></a>容器启动方法</h3><p>需要注意的是，FastDFS 的容器需要使用 host 网络，因为 fastdfs storage 服务器需要向 tracker 服务器汇报自己 IP，这个 IP 还需要通过环境变量的方式注入到相关的配置文件当中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -e FASTDFS_IPADDR=10.10.107.230 \</span><br><span class="line">           -p 28888:28888 -p 22122:22122 -p 23000:23000 -p 28088:28080 \</span><br><span class="line">           -v <span class="variable">$PWD</span>/data:/var/fdfs --net=host --name fastdfs fastdfs:alpine</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><h3 id="测试工具"><a href="#测试工具" class="headerlink" title="测试工具"></a>测试工具</h3><ol>
<li>上传客户端：<code>fdfs_upload_file</code></li>
<li>并发执行工具 ：<code>xargs</code></li>
<li>测试样本：10W  张表情包图片 ，大小在 <strong>8KB–128KB</strong> 之间</li>
<li>上传测试命令：<code>time ls  | xargs -n 1 -I {} -P 256 sh -c &quot;/usr/bin/fdfs_upload_file /etc/fdfs/client.conf {}&quot;`</code>-p 参数指定并发执行的任务数量</li>
<li>下载测试工具： <code>wget</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">下载测试命令：`time cat url.log  | xargs -n 1 -I &#123;&#125; -P 256 sh -c <span class="string">"wget  &#123;&#125;"</span>`</span><br></pre></td></tr></table></figure>
<h3 id="文件上传测试"><a href="#文件上传测试" class="headerlink" title="文件上传测试"></a>文件上传测试</h3><p>  测试样本为 10W 张 8KB-100 KB 大小不等的图片</p>
<p><img src="https://p.k8s.li/1564128425387.png" alt=""></p>
<p><strong>测试文件数量和大小</strong></p>
<p><img src="https://p.k8s.li/1564128874832.png" alt=""></p>
<p><strong>使用 xargs 执行 256 个进程并发上传 10w 张照片所用所用时间 为 2 分钟左右（内网）</strong></p>
<p><img src="https://p.k8s.li/1564128721547.png" alt=""></p>
<p><strong>用时 2 分 11 秒</strong></p>
<p><img src="https://p.k8s.li/1564364594777.png" alt=""></p>
<p><strong>客户端负载情况</strong></p>
<p><img src="https://p.k8s.li/1564127683217.png" alt=""></p>
<p><strong>服务端负载情况</strong></p>
<p><img src="https://p.k8s.li/1564364294952.png" alt=""></p>
<p><strong>服务端带宽流量</strong></p>
<p><img src="https://p.k8s.li/1564365025177.png" alt=""></p>
<p><strong>服务端带宽流量</strong></p>
<p><img src="https://p.k8s.li/1564363829960.png" alt=""></p>
<p><strong>服务端上传结果</strong></p>
<p><img src="https://p.k8s.li/1564125161155.png" alt=""></p>
<p><strong>服务端上传日志记录 ，均无错误输出</strong></p>
<p><img src="https://p.k8s.li/1564130238346.png" alt=""></p>
<h3 id="文件下载测试"><a href="#文件下载测试" class="headerlink" title="文件下载测试"></a>文件下载测试</h3><p><strong>从日志中提取文件路径</strong></p>
<p>从服务端的 <code>storage_access.log</code> 日志里提取出文件的路径，使用 <code>sed</code> 添加 <code>nginx</code> 的访问端口地址得到 10W 个记录 上传文件的 <code>http</code> 访问 <code>url</code> 地址</p>
<p><img src="https://p.k8s.li/1564130789416.png" alt=""></p>
<p><strong>wget 下载</strong></p>
<p>使用 <code>wget -i</code> 参数指定 <code>url.log</code> 为标准输出来测试下载刚刚上传的 10W 张图片 用时 3 分 23 秒</p>
<p><img src="https://p.k8s.li/1564023927851.png" alt=""></p>
<h3 id="测试结果分析"><a href="#测试结果分析" class="headerlink" title="测试结果分析"></a>测试结果分析</h3><p>使用 FastDFS 自带的上传测试工具和 xargs 并发执行工具，通过 xargs -P 参数指定的并发请求数，测得结果为单机性能在网络环境稳定的情况下可以达到 5000 并发上传请求。10W 张图片上传时间耗时 2 分 11 秒左右。使用定时脚本持续测试，总测试上传 100W 张图片。分析 tracker 服务器和 storage 服务器的日志，无论上传还是下载均未发现错误和异常，性能和稳定性较好。</p>
<h2 id="优化参数"><a href="#优化参数" class="headerlink" title="优化参数"></a>优化参数</h2><p>根据业务需求和线上环境调整一下参数，可充分发挥 FastDFS 文件系统的性能</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 接收请求的线程数数量</span></span><br><span class="line"><span class="attr">accept_threads</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># work thread count, should &lt;= max_connections</span></span><br><span class="line"><span class="comment"># default value is 4</span></span><br><span class="line"><span class="comment"># since V2.00</span></span><br><span class="line"><span class="comment"># 工作线程数量，应当小于等于最大连接数</span></span><br><span class="line"><span class="attr">work_threads</span>=<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># min buff size</span></span><br><span class="line"><span class="comment"># default value 8KB</span></span><br><span class="line"><span class="comment"># 最小缓冲大小，默认值为 8KB</span></span><br><span class="line"><span class="attr">min_buff_size</span> = <span class="number">8</span>KB</span><br><span class="line"></span><br><span class="line"><span class="comment"># max buff size</span></span><br><span class="line"><span class="comment"># default value 128KB</span></span><br><span class="line"><span class="comment"># 最大缓冲大小，默认值为 128KB</span></span><br><span class="line"><span class="attr">max_buff_size</span> = <span class="number">128</span>KB</span><br><span class="line"></span><br><span class="line"><span class="comment"># thread stack size, should &gt;= 64KB</span></span><br><span class="line"><span class="comment"># default value is 256KB</span></span><br><span class="line"><span class="comment"># 线程栈的大小，应当大于 64KB，默认为 256KB</span></span><br><span class="line"><span class="attr">thread_stack_size</span> = <span class="number">256</span>KB</span><br><span class="line"></span><br><span class="line"><span class="comment"># if use connection pool</span></span><br><span class="line"><span class="comment"># default value is false</span></span><br><span class="line"><span class="comment"># since V4.05</span></span><br><span class="line"><span class="comment"># 是否使用连接池</span></span><br><span class="line"><span class="attr">use_connection_pool</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># connections whose the idle time exceeds this time will be closed</span></span><br><span class="line"><span class="comment"># unit: second</span></span><br><span class="line"><span class="comment"># default value is 3600</span></span><br><span class="line"><span class="comment"># since V4.05</span></span><br><span class="line"><span class="comment"># 连接池的最大空闲时间</span></span><br><span class="line"><span class="attr">connection_pool_max_idle_time</span> = <span class="number">3600</span></span><br></pre></td></tr></table></figure>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h4 id="无法连接到-tracker-服务器"><a href="#无法连接到-tracker-服务器" class="headerlink" title="无法连接到 tracker 服务器"></a>无法连接到 tracker 服务器</h4><p>需要在 tracker.conf 配置文件中添加允许访问的 IP ,并添加防火墙规则</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[2019-07-25 10:40:54] ERROR - file: ../client/storage_client.c, line: 996, fdfs_recv_response fail, result: 107</span><br><span class="line">upload file fail, error no: 107, error info: Transport endpoint is not connected</span><br><span class="line">[2019-07-25 10:40:54] ERROR - file: tracker_proto.c, line: 37, server: 10.20.172.192:23000, recv data fail, errno: 107, error info: Transport endpoint is not connected</span><br></pre></td></tr></table></figure>
<h4 id="服务器磁盘用尽"><a href="#服务器磁盘用尽" class="headerlink" title="服务器磁盘用尽"></a>服务器磁盘用尽</h4><p>当 storage 服务器设定的上传存储目录所在的分区磁盘用尽将会出现无剩余空间的错误日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[2019-07-26 16:16:45] ERROR - file: tracker_proto.c, line: 48, server: 10.10.107.232:22122, response status 28 != 0</span><br><span class="line">[2019-07-26 16:16:45] ERROR - file: ../client/tracker_client.c, line: 907, fdfs_recv_response fail, result: 28</span><br><span class="line">tracker_query_storage fail, error no: 28, error info: No space left on device</span><br></pre></td></tr></table></figure>
<h4 id="重启服务时失败"><a href="#重启服务时失败" class="headerlink" title="重启服务时失败"></a>重启服务时失败</h4><p>使用 service fdfs_trackerd restart 重启 tracker 或者 storage 服务时会报错，会提示端口已经占用。解决的方案就是使用 kill -9 命令杀死 tracker 服务或者 storage 服务，然后再重新启动相应服务即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[2019-07-25 10:36:55] INFO - FastDFS v5.12, base_path=/home/dfs, run_by_group=, run_by_user=, connect_timeout=10s, network_timeout=60s, port=22122, bind_addr=, max_connections=1024, accept_threads=1, work_threads=4, min_buff_size=8,192, max_buff_size=131,072, store_lookup=2, store_group=, store_server=0, store_path=0, reserved_storage_space=10.00%, download_server=0, allow_ip_count=-1, sync_log_buff_interval=10s, check_active_interval=120s, thread_stack_size=256 KB, storage_ip_changed_auto_adjust=1, storage_sync_file_max_delay=86400s, storage_sync_file_max_time=300s, use_trunk_file=0, slot_min_size=256, slot_max_size=16 MB, trunk_file_size=64 MB, trunk_create_file_advance=0, trunk_create_file_time_base=02:00, trunk_create_file_interval=86400, trunk_create_file_space_threshold=20 GB, trunk_init_check_occupying=0, trunk_init_reload_from_binlog=0, trunk_compress_binlog_min_interval=0, use_storage_id=0, id_type_in_filename=ip, storage_id_count=0, rotate_error_log=0, error_log_rotate_time=00:00, rotate_error_log_size=0, log_file_keep_days=0, store_slave_file_use_link=0, use_connection_pool=0, g_connection_pool_max_idle_time=3600s</span><br><span class="line">[2019-07-25 10:36:55] ERROR - file: sockopt.c, line: 868, <span class="built_in">bind</span> port 22122 failed, errno: 98, error info: Address already <span class="keyword">in</span> use.</span><br><span class="line">[2019-07-25 10:36:55] CRIT - <span class="built_in">exit</span> abnormally!</span><br></pre></td></tr></table></figure>
<h3 id="安全相关"><a href="#安全相关" class="headerlink" title="安全相关"></a>安全相关</h3><ol>
<li>tracker.conf 、storage.conf 配置文件默认允许所有 IP 地址访问 ，建议去掉  <code>allow_hosts=*</code> 修改为 FastDFS 客户端所在的内网 IP 地址。</li>
</ol>
<p><img src="https://p.k8s.li/1564384530137.png" alt=""></p>
<p>2.tracker.conf 、storage.conf  默认配置文件监听的地址为 0.0.0.0 即本机所有的 IP 地址，建议修改为 FastDFS 服务器所在的内网 IP 地址。</p>
<p><img src="https://p.k8s.li/1564384711746.png" alt=""></p>
<p>3.默认运行用户为当前用户和用户组为当前用户，建议指定为权限最小的用户来运行此进程。</p>
<p><img src="https://p.k8s.li/1564384906456.png" alt=""></p>
    </div>
      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Docker/" rel="tag"><i class="fa fa-tag"></i> Docker</a>
              <a href="/tags/FastDFS/" rel="tag"><i class="fa fa-tag"></i> FastDFS</a>
          </div>
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/esp8266-pc-switch.html" rel="prev" title="使用 ESP8266 NodeMCU 打造 WiFi 开关">
      <i class="fa fa-chevron-left"></i> 使用 ESP8266 NodeMCU 打造 WiFi 开关
    </a></div>
      <div class="post-nav-item">
    <a href="/fastdfs-lua-redis.html" rel="next" title="Lua + Redis 对 nginx 做动态路由">
      Lua + Redis 对 nginx 做动态路由 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
  </article>
  </div>
          </div>
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
        </div>
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>
  <aside class="sidebar">
    <div class="sidebar-inner">
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>
      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#构建-docker-镜像"><span class="nav-number">2.</span> <span class="nav-text">构建 docker 镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备配置文件"><span class="nav-number">2.1.</span> <span class="nav-text">准备配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改配置文件"><span class="nav-number">2.2.</span> <span class="nav-text">修改配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile"><span class="nav-number">2.3.</span> <span class="nav-text">Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#构不同基础镜像构建出的大小对比"><span class="nav-number">2.4.</span> <span class="nav-text">构不同基础镜像构建出的大小对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#musl-libc-带来的问题"><span class="nav-number">2.5.</span> <span class="nav-text">musl libc 带来的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#容器启动方法"><span class="nav-number">2.6.</span> <span class="nav-text">容器启动方法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试"><span class="nav-number">3.</span> <span class="nav-text">测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#测试工具"><span class="nav-number">3.1.</span> <span class="nav-text">测试工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件上传测试"><span class="nav-number">3.2.</span> <span class="nav-text">文件上传测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件下载测试"><span class="nav-number">3.3.</span> <span class="nav-text">文件下载测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试结果分析"><span class="nav-number">3.4.</span> <span class="nav-text">测试结果分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优化参数"><span class="nav-number">4.</span> <span class="nav-text">优化参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常见问题"><span class="nav-number">5.</span> <span class="nav-text">常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安全相关"><span class="nav-number">5.1.</span> <span class="nav-text">安全相关</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->
      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="木子"
      src="https://blog.k8s.li/avatar.png">
  <p class="site-author-name" itemprop="name">木子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">98</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:blog@502.li" title="E-Mail → mailto:blog@502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://kindle.502.li/" title="Kindle → https:&#x2F;&#x2F;kindle.502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tg.k8s.li/" title="Channel → https:&#x2F;&#x2F;tg.k8s.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Channel</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>
      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>
      </div>
    </main>
    <footer class="footer">
      <div class="footer-inner">
<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">木子</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">1.4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">39:50</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>
      </div>
    </footer>
  </div>
  <script src="/lib/anime.min.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>
<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://muzi.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://blog.k8s.li/docker-deploy-fastdfs.html",
            identifier: "docker-deploy-fastdfs.html",
            title: "Docker 部署 FastDFS"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://muzi.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>
</body>
</html>
