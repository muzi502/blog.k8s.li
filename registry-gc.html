<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.k8s.li').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>
  <meta name="description" content="å¥½ä¹…æ²¡æ›´æ–°åšå®¢äº†ï¼Œåœ¨å®¶æ‘¸é±¼èµ¶ç´§æ¥æ°´ä¸€ç¯‡ğŸ˜‚  registry GC åŸç†ğŸ¤”åœ¨å’±ä¸Šä¸ªæœˆå†™çš„ã€Šæ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿã€‹ä¸­ç®€å•æåˆ°äº†å®¹å™¨é•œåƒçš„ä¸€äº›çŸ¥è¯†ï¼Œä¹Ÿç®€å•ä»‹ç»äº†é•œåƒåœ¨ registry ä¸­å­˜å‚¨çš„ç›®å½•ç»“æ„ã€‚ä»Šå¤©è¿˜æ˜¯ä»æ–‡ä»¶ç³»ç»Ÿå±‚é¢åˆ†æä¸€ä¸‹ registry GC çš„åŸç†ï¼Œæ¯”ä»æºç æ¥åˆ†ææ›´ç›´è§‚ä¸€äº›ã€‚ éƒ¨ç½² registry å®¹å™¨é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨æœ¬åœ°éƒ¨ç½²ä¸€ä¸ª registry å®¹å™¨ï¼ŒåŒæ—¶ä¸ºäº†æ“ä½œçš„æ–¹ä¾¿è¿˜">
<meta property="og:type" content="article">
<meta property="og:title" content="docker registry GC åŸç†åˆ†æ">
<meta property="og:url" content="https://blog.k8s.li/registry-gc.html">
<meta property="og:site_name" content="æœ¨å­">
<meta property="og:description" content="å¥½ä¹…æ²¡æ›´æ–°åšå®¢äº†ï¼Œåœ¨å®¶æ‘¸é±¼èµ¶ç´§æ¥æ°´ä¸€ç¯‡ğŸ˜‚  registry GC åŸç†ğŸ¤”åœ¨å’±ä¸Šä¸ªæœˆå†™çš„ã€Šæ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿã€‹ä¸­ç®€å•æåˆ°äº†å®¹å™¨é•œåƒçš„ä¸€äº›çŸ¥è¯†ï¼Œä¹Ÿç®€å•ä»‹ç»äº†é•œåƒåœ¨ registry ä¸­å­˜å‚¨çš„ç›®å½•ç»“æ„ã€‚ä»Šå¤©è¿˜æ˜¯ä»æ–‡ä»¶ç³»ç»Ÿå±‚é¢åˆ†æä¸€ä¸‹ registry GC çš„åŸç†ï¼Œæ¯”ä»æºç æ¥åˆ†ææ›´ç›´è§‚ä¸€äº›ã€‚ éƒ¨ç½² registry å®¹å™¨é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨æœ¬åœ°éƒ¨ç½²ä¸€ä¸ª registry å®¹å™¨ï¼ŒåŒæ—¶ä¸ºäº†æ“ä½œçš„æ–¹ä¾¿è¿˜">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/registry-storage.jpeg">
<meta property="og:image" content="https://p.k8s.li/registry-gc.png">
<meta property="og:image" content="https://p.k8s.li/registry-gc-1.jpeg">
<meta property="og:image" content="https://p.k8s.li/registry-gc-2.jpeg">
<meta property="og:image" content="https://p.k8s.li/registry-gc-3.jpeg">
<meta property="article:published_time" content="2020-07-10T16:00:00.000Z">
<meta property="article:modified_time" content="2021-05-30T14:38:18.416Z">
<meta property="article:author" content="æœ¨å­">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="registry">
<meta property="article:tag" content="é•œåƒ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/registry-storage.jpeg">
<link rel="canonical" href="https://blog.k8s.li/registry-gc.html">
<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>
  <title>docker registry GC åŸç†åˆ†æ | æœ¨å­</title>
  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }
  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>
<link rel="alternate" href="/atom.xml" title="æœ¨å­" type="application/atom+xml">
</head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">
    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æœ¨å­</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>
<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">
    <a href="/" rel="section"><i class="fa fa-fw fa-desktop"></i>Home</a>
  </li>
        <li class="menu-item menu-item-books">
    <a href="/booklist.html" rel="section"><i class="fa fa-fw fa-book"></i>Books</a>
  </li>
        <li class="menu-item menu-item-kindle">
    <a href="https://kindle.502.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
  </li>
        <li class="menu-item menu-item-friend">
    <a href="/link/" rel="section"><i class="fa fa-fw fa-link"></i>Friend</a>
  </li>
        <li class="menu-item menu-item-about">
    <a href="/about.html" rel="section"><i class="fa fa-fw fa-user-circle-o"></i>About</a>
  </li>
  </ul>
</nav>
</div>
    </header>
  <div class="reading-progress-bar"></div>
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
  <div class="posts-expand">
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/registry-gc.html">
    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog.k8s.li/avatar.png">
      <meta itemprop="name" content="æœ¨å­">
      <meta itemprop="description" content="">
    </span>
    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æœ¨å­">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          docker registry GC åŸç†åˆ†æ
        </h2>
        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-07-11 2020-07-11T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2020-07-11T00:00:00+08:00">2020-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-30 2021-05-30T22:38:18+08:00" itemprop="dateModified" datetime="2021-05-30T22:38:18+08:00">2021-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>
            </span>
  <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    <a title="disqus" href="/registry-gc.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="registry-gc.html" itemprop="commentCount"></span>
    </a>
  </span>
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>36 åˆ†é’Ÿ</span>
            </span>
        </div>
      </header>
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>å¥½ä¹…æ²¡æ›´æ–°åšå®¢äº†ï¼Œåœ¨å®¶æ‘¸é±¼èµ¶ç´§æ¥æ°´ä¸€ç¯‡ğŸ˜‚</p>
</blockquote>
<h2 id="registry-GC-åŸç†ğŸ¤”"><a href="#registry-GC-åŸç†ğŸ¤”" class="headerlink" title="registry GC åŸç†ğŸ¤”"></a>registry GC åŸç†ğŸ¤”</h2><p>åœ¨å’±ä¸Šä¸ªæœˆå†™çš„<a href="https://blog.k8s.li/Exploring-container-image.html">ã€Šæ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿã€‹</a>ä¸­ç®€å•æåˆ°äº†å®¹å™¨é•œåƒçš„ä¸€äº›çŸ¥è¯†ï¼Œä¹Ÿç®€å•ä»‹ç»äº†é•œåƒåœ¨ registry ä¸­å­˜å‚¨çš„ç›®å½•ç»“æ„ã€‚ä»Šå¤©è¿˜æ˜¯ä»æ–‡ä»¶ç³»ç»Ÿå±‚é¢åˆ†æä¸€ä¸‹ registry GC çš„åŸç†ï¼Œæ¯”ä»æºç æ¥åˆ†ææ›´ç›´è§‚ä¸€äº›ã€‚</p>
<h3 id="éƒ¨ç½²-registry-å®¹å™¨"><a href="#éƒ¨ç½²-registry-å®¹å™¨" class="headerlink" title="éƒ¨ç½² registry å®¹å™¨"></a>éƒ¨ç½² registry å®¹å™¨</h3><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åœ¨æœ¬åœ°éƒ¨ç½²ä¸€ä¸ª registry å®¹å™¨ï¼ŒåŒæ—¶ä¸ºäº†æ“ä½œçš„æ–¹ä¾¿è¿˜éœ€è¦ä½¿ç”¨åˆ° skopeo è¿™ä¸ªå·¥å…·æ¥æ›¿ä»£ docker å‘½ä»¤è¡Œå®¢æˆ·ç«¯è¿›è¡Œ copy é•œåƒå’Œ delete é•œåƒã€‚å…³äº skopeo è¿™ä¸ªå·¥å…·çš„å®‰è£…å’Œä½¿ç”¨å¯ä»¥å‚è€ƒå’±ä¹‹å‰å†™è¿‡çš„<a href="https://blog.k8s.li/skopeo.html">ã€Šé•œåƒæ¬è¿å·¥ skopeo ã€‹</a>ã€‚</p>
<h4 id="è‡ªç­¾-SSL-è¯ä¹¦"><a href="#è‡ªç­¾-SSL-è¯ä¹¦" class="headerlink" title="è‡ªç­¾ SSL è¯ä¹¦"></a>è‡ªç­¾ SSL è¯ä¹¦</h4><p>è¿™ä¸€æ­¥ä¸ºäº†æ–¹ä¾¿åœ¨ä½¿ç”¨ skopeo çš„æ—¶å€™ä¸ç”¨åŠ ä¸€å †é¢å¤–çš„å‚æ•°ğŸ˜‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">set -e</span><br><span class="line">set -o nounset</span><br><span class="line">cat &gt;ca.conf &lt;&lt;EOF</span><br><span class="line">[ req ]</span><br><span class="line">default_bits  = 2048</span><br><span class="line">distinguished_name = req_distinguished_name</span><br><span class="line">prompt   = no</span><br><span class="line">encrypt_key  = no</span><br><span class="line">x509_extensions  = v3_ca</span><br><span class="line">[ req_distinguished_name ]</span><br><span class="line">CN         = localhost</span><br><span class="line">[ CA_default ]</span><br><span class="line">copy_extensions = copy</span><br><span class="line">[ alternate_names ]</span><br><span class="line">DNS.2=localhost</span><br><span class="line">[ v3_ca ]</span><br><span class="line">subjectAltName=@alternate_names</span><br><span class="line">subjectKeyIdentifier=hash</span><br><span class="line">authorityKeyIdentifier=keyid:always,issuer:always</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">keyUsage=keyCertSign,cRLSign,digitalSignature,keyEncipherment,nonRepudiation</span><br><span class="line">EOF</span><br><span class="line">mkdir -p certs</span><br><span class="line">openssl req -days 365 -x509 -config ca.conf \</span><br><span class="line">    -new -keyout certs/domain.key -out certs/domain.crt</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¿¡ä»»è¯ä¹¦ï¼Œæ ¹æ®ä¸åŒçš„å‘è¡Œç‰ˆé€‰æ‹©ç›¸åº”çš„è·¯å¾„å’Œå‘½ä»¤è¡Œå³å¯ã€‚</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> CentOS</span></span><br><span class="line">update-ca-trust force-enable</span><br><span class="line">cp certs/domain.crt /etc/pki/ca-trust/source/anchors/localhost.crt</span><br><span class="line">update-ca-trust</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Ubuntu</span></span><br><span class="line">cp certs/domain.crt /usr/local/share/ca-certificates/localhost.crt</span><br><span class="line"><span class="meta">$</span><span class="bash"> update-ca-certificates</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Debian</span></span><br><span class="line">cp certs/domain.crt /usr/share/ca-certificates/localhost.crt</span><br><span class="line">echo localhost.crt &gt;&gt; /etc/ca-certificates.conf</span><br><span class="line">update-ca-certificates</span><br></pre></td></tr></table></figure>
<h4 id="åˆ›å»ºå¯†ç -auth-è®¤è¯-auth-htpasswd-æ–‡ä»¶"><a href="#åˆ›å»ºå¯†ç -auth-è®¤è¯-auth-htpasswd-æ–‡ä»¶" class="headerlink" title="åˆ›å»ºå¯†ç  auth è®¤è¯  auth.htpasswd æ–‡ä»¶"></a>åˆ›å»ºå¯†ç  auth è®¤è¯  auth.htpasswd æ–‡ä»¶</h4><p>ç”±äº PUSH é•œåƒå’Œ DELETE é•œåƒæ˜¯é€šè¿‡ HTTP è¯·æ±‚ registry çš„ API å®Œæˆçš„ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦ä¸€ä¸ª token æ‰èƒ½å®Œæˆæ“ä½œï¼Œè¿™ä¸ª token éœ€è¦ä½¿ç”¨è¿™ä¸ª AUTH æ–‡ä»¶æ¥è¿›è¡Œé‰´æƒï¼Œä½¿ç”¨ <code>htpasswd</code> æ¥ç”Ÿæˆä¸€ä¸ªæ˜æ–‡çš„ç”¨æˆ·/å¯†ç å³å¯ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">htpasswd -cB -b auth.htpasswd root 123456</span><br></pre></td></tr></table></figure>
<h4 id="å¯åŠ¨-registry-å®¹å™¨ï¼Œdocker-run-èµ°èµ·ï¼"><a href="#å¯åŠ¨-registry-å®¹å™¨ï¼Œdocker-run-èµ°èµ·ï¼" class="headerlink" title="å¯åŠ¨ registry å®¹å™¨ï¼Œdocker run èµ°èµ·ï¼"></a>å¯åŠ¨ registry å®¹å™¨ï¼Œdocker run èµ°èµ·ï¼</h4><ul>
<li><code>-v /var/lib/registry:/var/lib/registry</code> ï¼Œå°†æœ¬åœ°çš„å­˜å‚¨ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…çš„ registry å­˜å‚¨ç›®å½•ä¸‹ã€‚</li>
<li><code>-v pwd/certs:/certs</code>ï¼Œå°†ç”Ÿæˆçš„ SSL è¯ä¹¦æŒ‚è½½åˆ°å®¹å™¨å†…ã€‚</li>
<li><code>-e REGISTRY_STORAGE_DELETE_ENABLED=true</code>ï¼Œæ·»åŠ è¯¥å‚æ•°æ‰èƒ½è¿›è¡Œ DELETE é•œåƒæ“ä½œï¼Œä¸ç„¶çš„è¯ä¼šæç¤º <a href="https://github.com/docker/distribution/issues/1573" target="_blank" rel="noopener">Error in deleting repository in a private registry V2 #1573</a> è¿™ç§é”™è¯¯ï¼ˆï¼ï¹ï¼œï¼‰ã€‚</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 127.0.0.1:443:5000 --name registry \</span><br><span class="line">    -v /var/lib/registry:/var/lib/registry \</span><br><span class="line">    -v `pwd`/certs:/certs \</span><br><span class="line">    -v $(pwd)/auth.htpasswd:/etc/docker/registry/auth.htpasswd \</span><br><span class="line">    -e REGISTRY_AUTH="&#123;htpasswd: &#123;realm: localhost, path: /etc/docker/registry/auth.htpasswd&#125;&#125;" \</span><br><span class="line">    -e REGISTRY_HTTP_ADDR=0.0.0.0:5000 \</span><br><span class="line">    -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \</span><br><span class="line">    -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \</span><br><span class="line">    -e REGISTRY_STORAGE_DELETE_ENABLED=true \</span><br><span class="line">    registry</span><br></pre></td></tr></table></figure>
<h4 id="docker-login"><a href="#docker-login" class="headerlink" title="docker login"></a>docker login</h4><p>è¿™ä¸€æ­¥æ˜¯ä¸ºäº†åœ¨ <code>~/.docker/.config.json</code> ï¼Œä¸­æ·»åŠ ä¸Š auth è®¤è¯ï¼Œåé¢ä½¿ç”¨ skopeo çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 ~/registry</span><br><span class="line">â•°â”€# docker login localhost -u root -p 123456</span><br><span class="line">]WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line">â•­â”€root@sg-02 ~/registry</span><br><span class="line">â•°â”€# cat ~/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">        "auths": &#123;</span><br><span class="line">                "https://registry.k8s.li/v2": &#123;</span><br><span class="line">                        "auth": "VlJFpmQE43Sw=="</span><br><span class="line">                &#125;,</span><br><span class="line">                "localhost": &#123;</span><br><span class="line">                        "auth": "cm9vdDoxMjM0NTY="</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        "HttpHeaders": &#123;</span><br><span class="line">                "User-Agent": "Docker-Client/19.03.5 (linux)"</span><br><span class="line">        &#125;,</span><br><span class="line">        "experimental": "enabled"</span><br><span class="line">&#125;#</span><br></pre></td></tr></table></figure>
<h3 id="COPY-é•œåƒåˆ°-registry"><a href="#COPY-é•œåƒåˆ°-registry" class="headerlink" title="COPY é•œåƒåˆ° registry"></a>COPY é•œåƒåˆ° registry</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 ~/registry</span><br><span class="line">â•°â”€# skopeo copy docker://alpine:3.10 docker://localhost/library/alpine:3.10</span><br><span class="line">Getting image source signatures</span><br><span class="line">Copying blob 21c83c524219 done</span><br><span class="line">Copying config be4e4bea2c done</span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br></pre></td></tr></table></figure>
<h3 id="registry-å­˜å‚¨ç›®å½•é•¿ä»€ä¹ˆæ ·ğŸ¤”"><a href="#registry-å­˜å‚¨ç›®å½•é•¿ä»€ä¹ˆæ ·ğŸ¤”" class="headerlink" title="registry å­˜å‚¨ç›®å½•é•¿ä»€ä¹ˆæ ·ğŸ¤”"></a>registry å­˜å‚¨ç›®å½•é•¿ä»€ä¹ˆæ ·ğŸ¤”</h3><p><img src="https://p.k8s.li/registry-storage.jpeg" alt=""></p>
<p>registry å®¹å™¨å†…çš„<code>/var/lib/registry/docker/registry/v2</code> å­˜å‚¨ç›®å½•ï¼Œç»“åˆä¸Šé¢è¿™å¼ å›¾ï¼Œé€šè¿‡ tree ç›®å½•æˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°ï¼šregistry å­˜å‚¨ç›®å½•ä¸‹åªæœ‰ä¸¤ç§æ–‡ä»¶åçš„æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ <code>data</code> æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ <code>link</code> æ–‡ä»¶ã€‚å…¶ä¸­ link æ–‡ä»¶æ˜¯æ™®é€šçš„æ–‡æœ¬æ–‡ä»¶ï¼Œå­˜æ”¾åœ¨ <code>repositories</code> ç›®å½•ä¸‹ï¼Œå…¶å†…å®¹æ˜¯æŒ‡å‘ data æ–‡ä»¶çš„ sha256 digest å€¼ã€‚link æ–‡ä»¶æ˜¯ä¸æ˜¯æœ‰ç‚¹åƒ C è¯­è¨€ä¸­çš„æŒ‡é’ˆğŸ˜‚ï¼ˆå¤§é›¾ã€‚</p>
<p>data æ–‡ä»¶å­˜æ”¾åœ¨ <code>blobs</code> ç›®å½•ä¸‹æ–‡ä»¶åˆåˆ†ä¸ºäº†ä¸‰ç§æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯é•œåƒæ¯ä¸€å±‚çš„ <code>layer</code> æ–‡ä»¶å’Œé•œåƒçš„ <code>config</code> æ–‡ä»¶ï¼Œä»¥åŠé•œåƒçš„ <code>manifest</code> æ–‡ä»¶ã€‚</p>
<p>åœ¨ <code>repositories</code> ç›®å½•ä¸‹æ¯ä¸ªé•œåƒçš„ <code>_layers/sha256</code> ç›®å½•ä¸‹çš„æ–‡ä»¶å¤¹åæ˜¯é•œåƒçš„ layer å’Œ config æ–‡ä»¶çš„ digest ï¼Œè¯¥ç›®å½•ä¸‹çš„ link æ–‡ä»¶å°±æ˜¯æŒ‡å‘å¯¹åº” blobs ç›®å½•ä¸‹çš„ data æ–‡ä»¶ã€‚å½“æˆ‘ä»¬ pull ä¸€ä¸ªé•œåƒçš„ layer æ—¶ï¼Œæ˜¯é€šè¿‡ link æ–‡ä»¶æ‰¾åˆ° layer åœ¨ registry ä¸­å®é™…çš„å­˜å‚¨ä½ç½®çš„ã€‚</p>
<p>åœ¨ <code>_manifests</code> æ–‡ä»¶å¤¹ä¸‹çš„ tags å’Œ revisions ç›®å½•ä¸‹çš„ link æ–‡ä»¶åˆ™æŒ‡å‘è¯¥é•œåƒçš„ manifest æ–‡ä»¶ï¼Œä¿å­˜åœ¨æ‰€æœ‰å†å²é•œåƒ tag çš„ manifest æ–‡ä»¶ çš„ linkã€‚å½“åˆ é™¤ä¸€ä¸ªé•œåƒæ—¶ï¼Œåªä¼šåˆ é™¤è¯¥é•œåƒæœ€æ–°çš„ tag çš„ link æ–‡ä»¶ã€‚</p>
<p>tags ç›®å½•ä¸‹çš„æ–‡ä»¶å¤¹åä¾‹å¦‚ 3.10 ï¼Œå°±æ˜¯è¯¥é•œåƒçš„ tag ï¼Œåœ¨å®ƒçš„å­ç›®å½•ä¸‹çš„ current/link æ–‡ä»¶åˆ™è®°å½•äº†å½“å‰ tag æŒ‡å‘çš„ manifest æ–‡ä»¶çš„ä½ç½®ã€‚æ¯”å¦‚æˆ‘ä»¬çš„ alpine:latest é•œåƒï¼Œæ¯æ¬¡ push æ–°çš„ latest é•œåƒæ—¶ï¼Œcurrent/link éƒ½ä¼šæ›´æ–°æˆæŒ‡å‘æœ€æ–°é•œåƒçš„ manifest æ–‡ä»¶ã€‚</p>
<p>æˆ‘ä»¬åé¢è§‚å¯Ÿä¸€ä¸‹å½“åˆ é™¤ä¸€ä¸ªé•œåƒæ—¶ï¼Œè¿™äº›æ–‡ä»¶æ˜¯æ€ä¹ˆå˜åŒ–çš„ï¼Œå°±å¯ä»¥å¾—çŸ¥é€šè¿‡ registry API è¿›è¡Œ DELETE æ“ä½œå¯ä»¥è½¬æ¢æˆæ–‡ä»¶ç³»ç»Ÿå±‚é¢ä¸Šå¯¹ link æ–‡ä»¶çš„åˆ é™¤æ“ä½œã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 ~/registry</span><br><span class="line">â•°â”€# cd /var/lib/registry/docker/registry/v2</span><br><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">â•°â”€# tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ blobs</span><br><span class="line">â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ 21</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ a1</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â””â”€â”€ be</span><br><span class="line">â”‚Â Â          â””â”€â”€ be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">â”‚Â Â              â””â”€â”€ data</span><br><span class="line">â””â”€â”€ repositories</span><br><span class="line">    â””â”€â”€ library</span><br><span class="line">        â””â”€â”€ alpine</span><br><span class="line">            â”œâ”€â”€ _layers</span><br><span class="line">            â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">            â”‚Â Â      â”œâ”€â”€ 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">            â”‚Â Â      â”‚Â Â  â””â”€â”€ link</span><br><span class="line">            â”‚Â Â      â””â”€â”€ be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">            â”‚Â Â          â””â”€â”€ link</span><br><span class="line">            â”œâ”€â”€ _manifests</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ revisions</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">            â”‚Â Â  â”‚Â Â      â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">            â”‚Â Â  â”‚Â Â          â””â”€â”€ link</span><br><span class="line">            â”‚Â Â  â””â”€â”€ tags</span><br><span class="line">            â”‚Â Â      â””â”€â”€ 3.10</span><br><span class="line">            â”‚Â Â          â”œâ”€â”€ current</span><br><span class="line">            â”‚Â Â          â”‚Â Â  â””â”€â”€ link</span><br><span class="line">            â”‚Â Â          â””â”€â”€ index</span><br><span class="line">            â”‚Â Â              â””â”€â”€ sha256</span><br><span class="line">            â”‚Â Â                  â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">            â”‚Â Â                      â””â”€â”€ link</span><br><span class="line">            â””â”€â”€ _uploads</span><br><span class="line"></span><br><span class="line">26 directories, 8 files</span><br></pre></td></tr></table></figure>
<ul>
<li><code>blobs</code> å­˜å‚¨ç›®å½•ï¼Œå­˜æ”¾äº†é•œåƒçš„ä¸‰ä¸ªå¿…é¡»æ–‡ä»¶ï¼Œ<code>layer</code>ï¼Œ<code>manifest</code>ï¼Œ<code>config</code>ã€‚é€šè¿‡æ–‡ä»¶å¤§å°æˆ‘ä»¬å¯ä»¥å¤§è‡´åœ°æ¨ç®—å‡ºæœ€å¤§çš„ 2.7M æ˜¯é•œåƒçš„ layer ã€‚</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">â•°â”€# find . -name "data" -exec ls -sh &#123;&#125; \;</span><br><span class="line">2.7M ./blobs/sha256/21/21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d/data</span><br><span class="line">4.0K ./blobs/sha256/a1/a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590/data</span><br><span class="line">4.0K ./blobs/sha256/be/be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c/data</span><br></pre></td></tr></table></figure>
<ul>
<li><code>image layer</code> æ–‡ä»¶ï¼Œæ˜¯ gzip æ ¼å¼çš„ tar åŒ…ï¼Œæ˜¯é•œåƒå±‚çœŸå®å†…å®¹çš„ <code>tar.gzip</code> æ ¼å¼å­˜å‚¨å½¢å¼ã€‚</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./blobs/sha256/21/21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d/data: gzip compressed data</span><br></pre></td></tr></table></figure>
<ul>
<li><code>image manifest</code> æ–‡ä»¶ï¼Œjson æ–‡ä»¶æ ¼å¼çš„ï¼Œå­˜æ”¾è¯¥é•œåƒ <code>layer</code> å’Œ  <code>image config</code> æ–‡ä»¶çš„ç´¢å¼•ã€‚</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">â•°â”€# cat ./blobs/sha256/a1/a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590/data</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">"schemaVersion"</span>: <span class="number">2</span>,</span><br><span class="line">   <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">   <span class="attr">"config"</span>: &#123;</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.container.image.v1+json"</span>,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">1509</span>,</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"layers"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span>,</span><br><span class="line">         <span class="attr">"size"</span>: <span class="number">2795580</span>,</span><br><span class="line">         <span class="attr">"digest"</span>: <span class="string">"sha256:21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d"</span></span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;#</span><br></pre></td></tr></table></figure>
<ul>
<li><code>image config</code> æ–‡ä»¶ï¼Œjson æ ¼å¼çš„ã€‚æ˜¯æ„å»ºæ—¶ç”Ÿæˆçš„ï¼Œæ ¹æ® <code>Dockerfile</code> å’Œå®¿ä¸»æœºçš„ä¸€äº›ä¿¡æ¯ï¼Œä»¥åŠä¸€äº›æ„å»ºè¿‡ç¨‹ä¸­çš„å®¹å™¨å¯ä»¥ç”Ÿæˆ digest å”¯ä¸€çš„ <code>image config</code> æ–‡ä»¶ã€‚ä»”ç»†çœ‹è¿™ä¸ª image config æ–‡ä»¶æ˜¯ä¸æ˜¯æœ‰ç‚¹ç–‘æƒ‘ï¼Œæ— è®ºæ˜¯ manifest è¿˜æ˜¯ config æ–‡ä»¶é‡Œé¢çš„å†…å®¹å‹æ ¹å°±æ²¡æœ‰é•œåƒçš„åç§°å’Œ tag ã€‚å…¶å®ï¼Œé•œåƒå°±å¥½æ¯”ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶çš„å†…å®¹å’Œæ–‡ä»¶åæ¯«æ— å…³ç³»ã€‚åœ¨ registry ä¸­ï¼Œæ˜¯é€šè¿‡è·¯å¾„åçš„æ–¹å¼æ¥å¯¹ä¸€ä¸ªé•œåƒè¿›è¡Œå‘½åçš„ã€‚å½“æˆ‘ä»¬å¾€ registry ä¸­ PUSH ä¸€ä¸ªé•œåƒæ—¶ï¼Œä»¥<code>localhost/library/alpine:3.10</code>ä¸ºä¾‹ï¼Œ<code>localhost</code>ï¼Œå°±æ˜¯è¯¥ registry çš„åŸŸåæˆ–è€… URL ï¼Œ<code>library</code>å°±æ˜¯ project ï¼Œ<code>alpine:3.10</code>å°±æ˜¯é•œåƒåå’Œé•œåƒçš„ tagã€‚registry ä¼šæ ¹æ® <code>localhost/library/alpine:3.10</code> åœ¨<code>repositories</code> ç›®å½•ä¸‹ä¾æ¬¡åˆ›å»ºç›¸åº”çš„ç›®å½•ã€‚</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">â•°â”€# cat ./blobs/sha256/be/be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c/data | jq "."</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">  <span class="attr">"config"</span>: &#123;</span><br><span class="line">    <span class="attr">"Hostname"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"Domainname"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"User"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"AttachStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStdout"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStderr"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Tty"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"OpenStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"StdinOnce"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Env"</span>: [</span><br><span class="line">      <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Cmd"</span>: [</span><br><span class="line">      <span class="string">"/bin/sh"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"ArgsEscaped"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"Image"</span>: <span class="string">"sha256:d928e20e1fbe5142bb5cdf594862271673133c5354950d6a8f74afed24df4c23"</span>,</span><br><span class="line">    <span class="attr">"Volumes"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"WorkingDir"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"Entrypoint"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"OnBuild"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"Labels"</span>: <span class="literal">null</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"container"</span>: <span class="string">"37e3972c75360676982c8f6591b66a9097719e5ad4cecd5fa63ad4f06472825f"</span>,</span><br><span class="line">  <span class="attr">"container_config"</span>: &#123;</span><br><span class="line">    <span class="attr">"Hostname"</span>: <span class="string">"37e3972c7536"</span>,</span><br><span class="line">    <span class="attr">"Domainname"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"User"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"AttachStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStdout"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStderr"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Tty"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"OpenStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"StdinOnce"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Env"</span>: [</span><br><span class="line">      <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Cmd"</span>: [</span><br><span class="line">      <span class="string">"/bin/sh"</span>,</span><br><span class="line">      <span class="string">"-c"</span>,</span><br><span class="line">      <span class="string">"#(nop) "</span>,</span><br><span class="line">      <span class="string">"CMD [\"/bin/sh\"]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"ArgsEscaped"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"Image"</span>: <span class="string">"sha256:d928e20e1fbe5142bb5cdf594862271673133c5354950d6a8f74afed24df4c23"</span>,</span><br><span class="line">    <span class="attr">"Volumes"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"WorkingDir"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"Entrypoint"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"OnBuild"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"Labels"</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"created"</span>: <span class="string">"2020-04-24T01:05:21.571691552Z"</span>,</span><br><span class="line">  <span class="attr">"docker_version"</span>: <span class="string">"18.09.7"</span>,</span><br><span class="line">  <span class="attr">"history"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"created"</span>: <span class="string">"2020-04-24T01:05:21.178437685Z"</span>,</span><br><span class="line">      <span class="attr">"created_by"</span>: <span class="string">"/bin/sh -c #(nop) ADD file:66a440394c2442570f1f060e25c86613cb2d88a8af0c71c5a4154b3570e9a805 in / "</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"created"</span>: <span class="string">"2020-04-24T01:05:21.571691552Z"</span>,</span><br><span class="line">      <span class="attr">"created_by"</span>: <span class="string">"/bin/sh -c #(nop)  CMD [\"/bin/sh\"]"</span>,</span><br><span class="line">      <span class="attr">"empty_layer"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">  <span class="attr">"rootfs"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"layers"</span>,</span><br><span class="line">    <span class="attr">"diff_ids"</span>: [</span><br><span class="line">      <span class="string">"sha256:1b3ee35aacca9866b01dd96e870136266bde18006ac2f0d6eb706c798d1fa3c3"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æˆ‘ä»¬å†å¾€ registry ä¸­ COPY ä¸€ä¸ªé•œåƒï¼Œæ–¹ä¾¿åé¢çš„åˆ†æè¿‡ç¨‹ã€‚</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skopeo copy docker://debian:buster-slim docker://localhost/library/debian:buster-slim</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿™æ˜¯ registry ä¸­å°±åªæœ‰ <code>alpine:3.10</code> å’Œ <code>debian:buster-slim</code>è¿™ä¸¤ä¸ªåŸºç¡€é•œåƒï¼Œæ­¤æ—¶çš„ registry å­˜å‚¨ç›®å½•çš„ç»“æ„å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">â•°â”€# tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ blobs</span><br><span class="line">â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ 21</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ 43</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ 43e3995ee54ac008271bfcf2d8ac7278c33f4c5e83d2f02bfcddd350034e3357</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ 7c</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ 85</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ 8559a31e96f442f2c7b6da49d6c84705f98a39d8be10b3f5f14821d0ee8417df</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ a1</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â””â”€â”€ be</span><br><span class="line">â”‚Â Â          â””â”€â”€ be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">â”‚Â Â              â””â”€â”€ data</span><br><span class="line">â””â”€â”€ repositories</span><br><span class="line">    â””â”€â”€ library</span><br><span class="line">        â”œâ”€â”€ alpine</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ _layers</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”œâ”€â”€ 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ link</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â””â”€â”€ be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">        â”‚Â Â  â”‚Â Â          â””â”€â”€ link</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ _manifests</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”œâ”€â”€ revisions</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”‚Â Â          â””â”€â”€ link</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â””â”€â”€ tags</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â””â”€â”€ 3.10</span><br><span class="line">        â”‚Â Â  â”‚Â Â          â”œâ”€â”€ current</span><br><span class="line">        â”‚Â Â  â”‚Â Â          â”‚Â Â  â””â”€â”€ link</span><br><span class="line">        â”‚Â Â  â”‚Â Â          â””â”€â”€ index</span><br><span class="line">        â”‚Â Â  â”‚Â Â              â””â”€â”€ sha256</span><br><span class="line">        â”‚Â Â  â”‚Â Â                  â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">        â”‚Â Â  â”‚Â Â                      â””â”€â”€ link</span><br><span class="line">        â”‚Â Â  â””â”€â”€ _uploads</span><br><span class="line">        â””â”€â”€ debian</span><br><span class="line">            â”œâ”€â”€ _layers</span><br><span class="line">            â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">            â”‚Â Â      â”œâ”€â”€ 43e3995ee54ac008271bfcf2d8ac7278c33f4c5e83d2f02bfcddd350034e3357</span><br><span class="line">            â”‚Â Â      â”‚Â Â  â””â”€â”€ link</span><br><span class="line">            â”‚Â Â      â””â”€â”€ 8559a31e96f442f2c7b6da49d6c84705f98a39d8be10b3f5f14821d0ee8417df</span><br><span class="line">            â”‚Â Â          â””â”€â”€ link</span><br><span class="line">            â”œâ”€â”€ _manifests</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ revisions</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">            â”‚Â Â  â”‚Â Â      â””â”€â”€ 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">            â”‚Â Â  â”‚Â Â          â””â”€â”€ link</span><br><span class="line">            â”‚Â Â  â””â”€â”€ tags</span><br><span class="line">            â”‚Â Â      â””â”€â”€ buster-slim</span><br><span class="line">            â”‚Â Â          â”œâ”€â”€ current</span><br><span class="line">            â”‚Â Â          â”‚Â Â  â””â”€â”€ link</span><br><span class="line">            â”‚Â Â          â””â”€â”€ index</span><br><span class="line">            â”‚Â Â              â””â”€â”€ sha256</span><br><span class="line">            â”‚Â Â                  â””â”€â”€ 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">            â”‚Â Â                      â””â”€â”€ link</span><br><span class="line">            â””â”€â”€ _uploads</span><br><span class="line"></span><br><span class="line">48 directories, 16 files</span><br></pre></td></tr></table></figure>
<h3 id="DELETE-é•œåƒ"><a href="#DELETE-é•œåƒ" class="headerlink" title="DELETE é•œåƒ"></a>DELETE é•œåƒ</h3><ul>
<li>é€šè¿‡ <code>skopeo delete</code> åˆ é™¤é•œåƒï¼Œæ³¨æ„ï¼Œé€šè¿‡ registry çš„ API åˆ é™¤é•œåƒæ¯æ¬¡åªèƒ½åˆ é™¤ä¸€ä¸ª tag çš„é•œåƒã€‚</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">â•°â”€# skopeo delete docker://localhost/library/alpine:3.10 --debug</span><br><span class="line">DEBU[0000] Returning credentials from /run/containers/0/auth.json</span><br><span class="line">DEBU[0000] Using registries.d directory /etc/containers/registries.d for sigstore configuration</span><br><span class="line">DEBU[0000]  No signature storage configuration found for localhost/library/alpine:3.10</span><br><span class="line">DEBU[0000] Looking for TLS certificates and private keys in /etc/docker/certs.d/localhost</span><br><span class="line">DEBU[0000] Loading registries configuration "/etc/containers/registries.conf"</span><br><span class="line">DEBU[0000] GET https://localhost/v2/</span><br><span class="line">DEBU[0000] Ping https://localhost/v2/ status 401</span><br><span class="line">DEBU[0000] GET https://localhost/v2/library/alpine/manifests/3.10</span><br><span class="line">DEBU[0000] DELETE https://localhost/v2/library/alpine/manifests/sha256:a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br></pre></td></tr></table></figure>
<ul>
<li>å†çœ‹ä¸€ä¸‹åˆ é™¤åçš„ registry å­˜å‚¨ç›®å½•ä¸‹çš„ alpine ç›®å½•é‡Œéƒ½å°‘äº†å“ªäº›ä¸œä¸œï¼Ÿ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">â•°â”€# tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ blobs</span><br><span class="line">â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ 21</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ 43</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ 43e3995ee54ac008271bfcf2d8ac7278c33f4c5e83d2f02bfcddd350034e3357</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ 7c</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ 85</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ 8559a31e96f442f2c7b6da49d6c84705f98a39d8be10b3f5f14821d0ee8417df</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ a1</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â””â”€â”€ be</span><br><span class="line">â”‚Â Â          â””â”€â”€ be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">â”‚Â Â              â””â”€â”€ data</span><br><span class="line">â””â”€â”€ repositories</span><br><span class="line">    â””â”€â”€ library</span><br><span class="line">        â”œâ”€â”€ alpine</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ _layers</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”œâ”€â”€ 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ link</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â””â”€â”€ be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">        â”‚Â Â  â”‚Â Â          â””â”€â”€ link</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ _manifests</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”œâ”€â”€ revisions</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â””â”€â”€ tags</span><br><span class="line">        â”‚Â Â  â””â”€â”€ _uploads</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ skopeo delete ä¸€ä¸ªé•œåƒçš„æ—¶å€™ï¼Œåªå¯¹ <code>_manifests</code> ä¸‹çš„ link æ–‡ä»¶è¿›è¡Œäº†æ“ä½œï¼Œåˆ é™¤çš„éƒ½æ˜¯å¯¹è¯¥ tag é•œåƒ manifest æ–‡ä»¶å¤¹ä¸‹çš„ link æ–‡ä»¶ï¼Œå®é™…ä¸Š manifest æ–‡ä»¶å¹¶æ²¡æœ‰ä» blobs ç›®å½•ä¸‹åˆ é™¤ï¼Œåªæ˜¯åˆ é™¤äº†è¯¥é•œåƒçš„ manifest æ–‡ä»¶çš„å¼•ç”¨ã€‚åˆ é™¤ä¸€ä¸ªé•œåƒåï¼Œtags ç›®å½•ä¸‹çš„ tag åç›®å½•å°±è¢«åˆ é™¤äº†ï¼Œ_manifests/revisions ç›®å½•ä¸‹çš„ link æ–‡ä»¶ä¹Ÿè¢«åˆ é™¤äº†ã€‚å®é™…ä¸Šä¸¤è€…åˆ é™¤çš„æ˜¯åŒä¸€ä¸ªå†…å®¹ï¼Œå³å¯¹è¯¥é•œåƒ manifest æ–‡ä»¶çš„ link æ–‡ä»¶ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEBU[0000] DELETE https://localhost/v2/library/alpine/manifests/sha256:a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢æ–‡ä»¶çš„å˜åŒ–å¯ä»¥å¾—å‡ºï¼Œé€šè¿‡ registry API æ¥ DELETE ä¸€ä¸ªé•œåƒå®è´¨ä¸Šæ˜¯åˆ é™¤ repositories å…ƒæ•°æ®æ–‡ä»¶å¤¹ä¸‹çš„ tag åæ–‡ä»¶å¤¹å’Œè¯¥ tag çš„ revisions ä¸‹çš„ link æ–‡ä»¶ã€‚</p>
<h2 id="registry-GC-åŸç†"><a href="#registry-GC-åŸç†" class="headerlink" title="registry GC åŸç†"></a>registry GC åŸç†</h2><p>ä¸Šé¢å·´æ‹‰å·´æ‹‰æ‰¯äº†ä¸€é€šä¹Ÿè®¸ä½ ç°åœ¨ä¸€å¤´é›¾æ°´ï¼Œè¿™å’Œä»Šå¤©çš„ä¸»é¢˜ registry GC åŸç†æ¯›å…³ç³»ï¼ŸğŸ˜‚ï¼Œå…¶å®æƒ³è¦ä»æ–‡ä»¶ç³»ç»Ÿå±‚é¢æ¥ç†è§£ registry GC ï¼Œä¸Šé¢çš„çŸ¥è¯†æ˜¯å¿…å¤‡çš„ï¼ˆ<em>^____^</em>ï¼‰ã€‚</p>
<h3 id="GC-æ˜¯å¼„å•¥å’§ï¼ŸğŸ¤”"><a href="#GC-æ˜¯å¼„å•¥å’§ï¼ŸğŸ¤”" class="headerlink" title="GC æ˜¯å¼„å•¥å’§ï¼ŸğŸ¤”"></a>GC æ˜¯å¼„å•¥å’§ï¼ŸğŸ¤”</h3><p>GC å˜›ï¼Œå°±æ˜¯åƒåœ¾å›æ”¶çš„æ„æ€ï¼Œä» docker å®˜æ–¹æ–‡æ¡£ <a href="https://docs.docker.com/registry/garbage-collection/" target="_blank" rel="noopener">Garbage collection</a> å·æ¥çš„ example ğŸ˜‚æ¥è§£é‡Šä¸€ä¸‹å§ã€‚</p>
<ul>
<li>å‡å¦‚é•œåƒ A å’Œé•œåƒ B ï¼Œä»–ä¿©åˆ†åˆ«å¼•ç”¨äº†layer aï¼Œbå’Œ aï¼Œcã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A -----&gt; a &lt;----- B</span><br><span class="line">    \--&gt; b     |</span><br><span class="line">         c &lt;--&#x2F;</span><br></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡ registry API åˆ é™¤é•œåƒ B ä¹‹åï¼Œlayer c å¹¶æ²¡æœ‰åˆ æ‰ï¼Œåªæ˜¯åˆ æ‰äº†å¯¹å®ƒçš„å¼•ç”¨ï¼Œæ‰€ä»¥ c æ˜¯å¤šä½™çš„ã€‚</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A -----&gt; a     B</span><br><span class="line">    \--&gt; b</span><br><span class="line">         c</span><br></pre></td></tr></table></figure>
<ul>
<li>GC ä¹‹åï¼Œlayer c å°±è¢«åˆ æ‰äº†ï¼Œç°åœ¨å°±æ²¡æœ‰æ— ç”¨çš„ layer äº†ã€‚</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A -----&gt; a</span><br><span class="line">    \--&gt; b</span><br></pre></td></tr></table></figure>
<h3 id="GC-çš„è¿‡ç¨‹"><a href="#GC-çš„è¿‡ç¨‹" class="headerlink" title="GC çš„è¿‡ç¨‹"></a>GC çš„è¿‡ç¨‹</h3><p>ç¿»ä¸€ä¸‹ registry  GC çš„æºç  <a href="https://github.com/docker/distribution/blob/master/registry/storage/garbagecollect.go" target="_blank" rel="noopener">garbagecollect.go</a>ï¼Œå¯ä»¥çœ‹åˆ° GC çš„ä¸»è¦åˆ†ä¸¤ä¸ªé˜¶æ®µï¼Œmarking å’Œ sweepã€‚</p>
<h4 id="marking"><a href="#marking" class="headerlink" title="marking"></a>marking</h4><p>marking é˜¶æ®µæ˜¯æ‰«ææ‰€æœ‰çš„ manifest æ–‡ä»¶ï¼Œæ ¹æ®ä¸Šæ–‡æˆ‘ä»¬æåˆ°çš„ link æ–‡ä»¶ï¼Œé€šè¿‡æ‰«ææ‰€æœ‰é•œåƒ tags ç›®å½•ä¸‹çš„ link æ–‡ä»¶å°±å¯ä»¥å¾—åˆ°è¿™äº›é•œåƒçš„ manifestï¼Œåœ¨ manifest ä¸­ä¿å­˜åœ¨è¯¥é•œåƒæ‰€æœ‰çš„ layer å’Œ config æ–‡ä»¶çš„ digest å€¼ï¼ŒæŠŠè¿™äº›å€¼æ ‡è®°ä¸º<strong>ä¸èƒ½æ¸…é™¤</strong>ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mark</span></span><br><span class="line">markSet := <span class="built_in">make</span>(<span class="keyword">map</span>[digest.Digest]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">manifestArr := <span class="built_in">make</span>([]ManifestDel, <span class="number">0</span>)</span><br><span class="line">err := repositoryEnumerator.Enumerate(ctx, <span class="function"><span class="keyword">func</span><span class="params">(repoName <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	emit(repoName)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	named, err := reference.WithName(repoName)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to parse repo name %s: %v"</span>, repoName, err)</span><br><span class="line">	&#125;</span><br><span class="line">	repository, err := registry.Repository(ctx, named)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to construct repository: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	manifestService, err := repository.Manifests(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to construct manifest service: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	manifestEnumerator, ok := manifestService.(distribution.ManifestEnumerator)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"unable to convert ManifestService into ManifestEnumerator"</span>)</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸€é˜¶æ®µç”¨ shell è„šæœ¬æ¥å®ç°çš„è¯å¤§è‡´å¯ä»¥è¿™æ ·æ¥æï¼Œä½¿ç”¨ shell å»éå†è¿™äº› manifest ï¼Œç„¶åå† grep å‡ºæ‰€æœ‰çš„ sha256 å€¼å°±èƒ½å¾—åˆ°è¿™ä¸ªé•œåƒæ‰€æœ‰çš„ blobs ç›®å½•ä¸‹çš„ data æ–‡ä»¶ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">set -x</span><br><span class="line">v2=$&#123;v2:="/var/lib/registry/docker/registry/v2"&#125;</span><br><span class="line">cd $&#123;v2&#125;</span><br><span class="line">all_blobs=/tmp/all_blobs.list</span><br><span class="line">echo "" &gt; $&#123;all_blobs&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> marking all the blob by all images manifest</span></span><br><span class="line">for tag in $(find repositories -name "link" | grep current)</span><br><span class="line">do</span><br><span class="line">    link=$(cat $&#123;tag&#125; | cut -c8-71)</span><br><span class="line">    mfs=blobs/sha256/$&#123;link:0:2&#125;/$&#123;link&#125;/data</span><br><span class="line">    echo $&#123;link&#125; &gt;&gt; $&#123;all_blobs&#125;</span><br><span class="line">    grep sha256 $&#123;mfs&#125; |cut -d "\"" -f4 | cut -c8-71 &gt;&gt; $&#123;all_blobs&#125;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h4 id="sweep"><a href="#sweep" class="headerlink" title="sweep"></a>sweep</h4><p>ç¬¬äºŒé˜¶æ®µå°±æ˜¯åˆ é™¤æ“ä½œå•¦ï¼Œmarking å®Œä¹‹åï¼Œæ²¡æœ‰æ ‡è®° blobï¼ˆ layer å’Œ config æ–‡ä»¶ï¼‰å°±ä¼šè¢«æ¸…é™¤æ‰ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sweep</span></span><br><span class="line">vacuum := NewVacuum(ctx, storageDriver)</span><br><span class="line"><span class="keyword">if</span> !opts.DryRun &#123;</span><br><span class="line">	<span class="keyword">for</span> _, obj := <span class="keyword">range</span> manifestArr &#123;</span><br><span class="line">		err = vacuum.RemoveManifest(obj.Name, obj.Digest, obj.Tags)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to delete manifest %s: %v"</span>, obj.Digest, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">blobService := registry.Blobs()</span><br><span class="line">deleteSet := <span class="built_in">make</span>(<span class="keyword">map</span>[digest.Digest]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">err = blobService.Enumerate(ctx, <span class="function"><span class="keyword">func</span><span class="params">(dgst digest.Digest)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// check if digest is in markSet. If not, delete it!</span></span><br><span class="line">	<span class="keyword">if</span> _, ok := markSet[dgst]; !ok &#123;</span><br><span class="line">		deleteSet[dgst] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="https://p.k8s.li/registry-gc.png" alt=""></p>
<h3 id="GC-éƒ½å¹²äº†å•¥ï¼Ÿ"><a href="#GC-éƒ½å¹²äº†å•¥ï¼Ÿ" class="headerlink" title="GC éƒ½å¹²äº†å•¥ï¼Ÿ"></a>GC éƒ½å¹²äº†å•¥ï¼Ÿ</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±è¿›è¡Œå®é™…çš„ GC æ“ä½œï¼Œè¿›å…¥åˆ° registry å®¹å™¨ä¸­ï¼Œä½¿ç”¨ registry garbage-collect è¿™ä¸ªå­å‘½ä»¤è¿›è¡Œæ“ä½œã€‚</p>
<h4 id="marking-1"><a href="#marking-1" class="headerlink" title="marking"></a>marking</h4><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-<span class="number">02</span> /<span class="keyword">var</span>/lib/registry/docker/registry/v2</span><br><span class="line">â•°â”€# docker exec -it registry sh</span><br><span class="line">/ # registry garbage-collect -m --delete-untagged=true /etc/docker/registry/<span class="keyword">config</span><span class="variable">.yml</span></span><br><span class="line"><span class="keyword">library</span>/alpine</span><br><span class="line"><span class="keyword">library</span>/debian</span><br><span class="line"><span class="keyword">library</span>/debian: marking manifest sha256:<span class="number">7</span>c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line"><span class="keyword">library</span>/debian: marking blob sha256:<span class="number">43</span>e3995ee54ac008271bfcf2d8ac7278c33f4c5e83d2f02bfcddd350034e3357</span><br><span class="line"><span class="keyword">library</span>/debian: marking blob sha256:<span class="number">8559</span>a31e96f442f2c7b6da49d6c84705f98a39d8be10b3f5f14821d0ee8417df</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> blobs marked, <span class="number">3</span> blobs <span class="keyword">and</span> <span class="number">0</span> manifests eligible <span class="keyword">for</span> deletion</span><br></pre></td></tr></table></figure>
<h4 id="sweep-1"><a href="#sweep-1" class="headerlink" title="sweep"></a>sweep</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">blob eligible for deletion: sha256:a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">INFO[0000] Deleting blob: &#x2F;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&#x2F;a1&#x2F;a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590  go.version&#x3D;go1.11.2 instance.id&#x3D;3ad15352-7cb7-46ca-a5ae-e5e16c6485a5 service&#x3D;registry</span><br><span class="line">blob eligible for deletion: sha256:be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">INFO[0000] Deleting blob: &#x2F;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&#x2F;be&#x2F;be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c  go.version&#x3D;go1.11.2 instance.id&#x3D;3ad15352-7cb7-46ca-a5ae-e5e16c6485a5 service&#x3D;registry</span><br><span class="line">blob eligible for deletion: sha256:21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">INFO[0000] Deleting blob: &#x2F;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&#x2F;21&#x2F;21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d  go.version&#x3D;go1.11.2 instance.id&#x3D;3ad15352-7cb7-46ca-a5ae-e5e16c6485a5 service&#x3D;registry</span><br></pre></td></tr></table></figure>
<h4 id="GC-ä¹‹åçš„-registry-å­˜å‚¨ç›®å½•é•¿ä»€ä¹ˆæ ·ï¼Ÿ"><a href="#GC-ä¹‹åçš„-registry-å­˜å‚¨ç›®å½•é•¿ä»€ä¹ˆæ ·ï¼Ÿ" class="headerlink" title="GC ä¹‹åçš„ registry å­˜å‚¨ç›®å½•é•¿ä»€ä¹ˆæ ·ï¼Ÿ"></a>GC ä¹‹åçš„ registry å­˜å‚¨ç›®å½•é•¿ä»€ä¹ˆæ ·ï¼Ÿ</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">â•°â”€# tree                                                                                     </span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ blobs</span><br><span class="line">â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ 21</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ 43</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ 43e3995ee54ac008271bfcf2d8ac7278c33f4c5e83d2f02bfcddd350034e3357</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ 7c</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ 85</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ 8559a31e96f442f2c7b6da49d6c84705f98a39d8be10b3f5f14821d0ee8417df</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ a1</span><br><span class="line">â”‚Â Â      â””â”€â”€ be</span><br><span class="line">â””â”€â”€ repositories</span><br><span class="line">    â””â”€â”€ library</span><br><span class="line">        â”œâ”€â”€ alpine</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ _layers</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”œâ”€â”€ 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ link</span><br><span class="line">        â”‚Â Â  â”‚Â Â      â””â”€â”€ be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">        â”‚Â Â  â”‚Â Â          â””â”€â”€ link</span><br><span class="line">        â”‚Â Â  â”œâ”€â”€ _manifests</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”œâ”€â”€ revisions</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">        â”‚Â Â  â”‚Â Â  â””â”€â”€ tags</span><br><span class="line">        â”‚Â Â  â””â”€â”€ _uploads</span><br><span class="line">        â””â”€â”€ debian</span><br><span class="line">            â”œâ”€â”€ _layers</span><br><span class="line">            â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">            â”‚Â Â      â”œâ”€â”€ 43e3995ee54ac008271bfcf2d8ac7278c33f4c5e83d2f02bfcddd350034e3357</span><br><span class="line">            â”‚Â Â      â”‚Â Â  â””â”€â”€ link</span><br><span class="line">            â”‚Â Â      â””â”€â”€ 8559a31e96f442f2c7b6da49d6c84705f98a39d8be10b3f5f14821d0ee8417df</span><br><span class="line">            â”‚Â Â          â””â”€â”€ link</span><br><span class="line">            â”œâ”€â”€ _manifests</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ revisions</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">            â”‚Â Â  â”‚Â Â      â””â”€â”€ 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">            â”‚Â Â  â”‚Â Â          â””â”€â”€ link</span><br><span class="line">            â”‚Â Â  â””â”€â”€ tags</span><br><span class="line">            â”‚Â Â      â””â”€â”€ buster-slim</span><br><span class="line">            â”‚Â Â          â”œâ”€â”€ current</span><br><span class="line">            â”‚Â Â          â”‚Â Â  â””â”€â”€ link</span><br><span class="line">            â”‚Â Â          â””â”€â”€ index</span><br><span class="line">            â”‚Â Â              â””â”€â”€ sha256</span><br><span class="line">            â”‚Â Â                  â””â”€â”€ 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">            â”‚Â Â                      â””â”€â”€ link</span><br><span class="line">            â””â”€â”€ _uploads</span><br><span class="line"></span><br><span class="line">40 directories, 10 files</span><br></pre></td></tr></table></figure>
<p>æ ¹æ® GC åçš„ registry å­˜å‚¨ç›®å½•æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒåŸæœ¬ blobs ç›®å½•ä¸‹æœ‰ 6 ä¸ª data æ–‡ä»¶ï¼Œç°åœ¨å·²ç»å˜æˆäº† 3 ä¸ªï¼Œalpine:3.10 è¿™ä¸ªé•œåƒç›¸å…³çš„ layerã€configã€manifest è¿™ä¸‰ä¸ªæ–‡ä»¶éƒ½å·²ç»è¢« GC æ‰äº†ã€‚ä½†æ˜¯åœ¨ repositories ç›®å½•ä¸‹ï¼Œè¯¥é•œåƒçš„ _layers ä¸‹çš„ link æ–‡ä»¶ä¾æ—§å­˜åœ¨ğŸ¤”ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>æ€»ç»“ä»¥ä¸Šï¼Œç”¨ä¸‹é¢è¿™ä¸‰å¼ å›¾ç‰‡å°±èƒ½ç›´è§‚åœ°ç†è§£è¿™äº›è¿‡ç¨‹å•¦ã€‚</p>
<h4 id="delete-é•œåƒä¹‹å‰çš„-registry-å­˜å‚¨ç›®å½•ç»“æ„"><a href="#delete-é•œåƒä¹‹å‰çš„-registry-å­˜å‚¨ç›®å½•ç»“æ„" class="headerlink" title="delete é•œåƒä¹‹å‰çš„ registry å­˜å‚¨ç›®å½•ç»“æ„"></a>delete é•œåƒä¹‹å‰çš„ registry å­˜å‚¨ç›®å½•ç»“æ„</h4><p><img src="https://p.k8s.li/registry-gc-1.jpeg" alt=""></p>
<h4 id="delete-é•œåƒä¹‹åçš„-registry-å­˜å‚¨ç›®å½•ç»“æ„"><a href="#delete-é•œåƒä¹‹åçš„-registry-å­˜å‚¨ç›®å½•ç»“æ„" class="headerlink" title="delete é•œåƒä¹‹åçš„ registry å­˜å‚¨ç›®å½•ç»“æ„"></a>delete é•œåƒä¹‹åçš„ registry å­˜å‚¨ç›®å½•ç»“æ„</h4><p><img src="https://p.k8s.li/registry-gc-2.jpeg" alt=""></p>
<h4 id="GC-ä¹‹åçš„-registry-å­˜å‚¨ç›®å½•ç»“æ„"><a href="#GC-ä¹‹åçš„-registry-å­˜å‚¨ç›®å½•ç»“æ„" class="headerlink" title="GC ä¹‹åçš„ registry å­˜å‚¨ç›®å½•ç»“æ„"></a>GC ä¹‹åçš„ registry å­˜å‚¨ç›®å½•ç»“æ„</h4><p><img src="https://p.k8s.li/registry-gc-3.jpeg" alt=""></p>
<h3 id="shell-å¤§æ³•å¥½ï¼"><a href="#shell-å¤§æ³•å¥½ï¼" class="headerlink" title="shell å¤§æ³•å¥½ï¼"></a>shell å¤§æ³•å¥½ï¼</h3><p>æ ¹æ®ä¸Šé¢çš„ GC åŸç†å’Œè¿‡ç¨‹ï¼Œå®é™…ä¸Šæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸åˆ° 25 è¡Œçš„ shell è„šæœ¬æ¥å®ç°ä¸€ä¸ªç²—æš´çš„  GC ğŸ˜‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">set -x</span><br><span class="line">v2=$1</span><br><span class="line">v2=$&#123;v2:="/var/lib/registry/docker/registry/v2"&#125;</span><br><span class="line">cd $&#123;v2&#125;</span><br><span class="line">all_blobs=/tmp/all_blobs.list</span><br><span class="line">: &gt; $&#123;all_blobs&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> marking all the blob by all images manifest</span></span><br><span class="line">for tag in $(find repositories -name "link" | grep current)</span><br><span class="line">do</span><br><span class="line">    link=$(cat $&#123;tag&#125; | cut -c8-71)</span><br><span class="line">    mfs=blobs/sha256/$&#123;link:0:2&#125;/$&#123;link&#125;/data</span><br><span class="line">    echo $&#123;link&#125; &gt;&gt; $&#123;all_blobs&#125;</span><br><span class="line">    grep sha256 $&#123;mfs&#125; |cut -d "\"" -f4 | cut -c8-71 &gt;&gt; $&#123;all_blobs&#125;</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> delete blob <span class="keyword">if</span> the blob doesn<span class="string">'t exist in all_blobs.list</span></span></span><br><span class="line">for blob in $(find blobs -name "data" | cut -d "/" -f4)</span><br><span class="line">do</span><br><span class="line">    grep $&#123;blob&#125; $&#123;all_blobs&#125;</span><br><span class="line">    if [[ $? != 0 ]]; then</span><br><span class="line">    rm -rf blobs/sha256/$&#123;blob:0:2&#125;/$&#123;blob&#125;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<ol>
<li><p>éå†æ‰€æœ‰é•œåƒçš„ tag ä¸‹æœ€æ–°çš„ link æ–‡ä»¶æŒ‡å‘çš„ manifest</p>
</li>
<li><p>æ ¹æ® manifest æ–‡ä»¶ grep å‡º sha256 å€¼çš„ image config å’Œ layer æ–‡ä»¶ï¼Œä¿å­˜åˆ° <code>all_blobs.list</code> æ–‡ä»¶ä¸­ã€‚</p>
</li>
<li><p>ä½¿ç”¨ <code>find</code> å’Œ <code>for</code> å¾ªç¯éå†æ‰€æœ‰ blobs ä¸‹çš„çš„ data æ–‡ä»¶ï¼Œåˆ¤æ–­å®ƒæ˜¯å¦åœ¨ <code>all_blobs.list</code> ä¸­ï¼Œä¸å†çš„è¯ç›´æ¥ <code>rm -rf</code> å¹²æ‰å®ƒï¼</p>
</li>
<li><p>æœ€åé‡å¯ä¸€ä¸‹ registry å®¹å™¨ã€‚</p>
</li>
</ol>
<p>å°±æ˜¯è¿™ä¹ˆç®€å•ç²—æš´ï¼å“ˆå“ˆï¼Œ<code>rm -rf</code> ç”¨èµ·æ¥çœŸçˆ½ï¼ˆæ‰‹åŠ¨æ»‘ç¨½ ã€‚å¦‚æœè¿˜æƒ³æŠŠè¿™ä¸ªè„šæœ¬å†ä¼˜åŒ–ä¸€ä¸‹çš„è¯ï¼Œå¯ä»¥å°† æ‰€æœ‰çš„ blob çš„ sha256 å€¼æˆªå–å‰ 12 ä½ä¿å­˜åœ¨ä¸€ä¸ªå˜é‡ä¸­ã€‚é€šè¿‡ <code>=~</code> æ¥åˆ¤æ–­åŒ…å«å…³ç³»æ¥æ›¿ä»£ grepã€‚</p>
<h2 id="è¸©å‘ï¼"><a href="#è¸©å‘ï¼" class="headerlink" title="è¸©å‘ï¼"></a>è¸©å‘ï¼</h2><h3 id="The-operation-is-unsupported-405-Method-Not-Allowed"><a href="#The-operation-is-unsupported-405-Method-Not-Allowed" class="headerlink" title="The operation is unsupported.(405 Method Not Allowed)"></a>The operation is unsupported.(405 Method Not Allowed)</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 ~/registry</span><br><span class="line">â•°â”€# skopeo delete docker://localhost/library/alpine:3.10 --debug</span><br><span class="line">DEBU[0000] Returning credentials from /run/containers/0/auth.json</span><br><span class="line">DEBU[0000] Using registries.d directory /etc/containers/registries.d for sigstore configuration</span><br><span class="line">DEBU[0000]  No signature storage configuration found for localhost/library/alpine:3.10</span><br><span class="line">DEBU[0000] Looking for TLS certificates and private keys in /etc/docker/certs.d/localhost</span><br><span class="line">DEBU[0000] Loading registries configuration "/etc/containers/registries.conf"</span><br><span class="line">DEBU[0000] GET https://localhost/v2/</span><br><span class="line">DEBU[0000] Ping https://localhost/v2/ status 401</span><br><span class="line">DEBU[0000] GET https://localhost/v2/library/alpine/manifests/3.10</span><br><span class="line">DEBU[0000] DELETE https://localhost/v2/library/alpine/manifests/sha256:a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">FATA[0000] Failed to delete /v2/library/alpine/manifests/sha256:a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590: &#123;"errors":[&#123;"code":"UNSUPPORTED","message":"The operation is unsupported."&#125;]&#125;</span><br><span class="line"> (405 Method Not Allowed)</span><br></pre></td></tr></table></figure>
<p>åœ¨ registry å®¹å™¨å¯åŠ¨çš„æ—¶å€™æ·»åŠ å˜é‡å¼€å¯ <code>REGISTRY_STORAGE_DELETE_ENABLED=true</code> å³å¯ï¼Œæˆ–è€…ä¿®æ”¹å®¹å™¨å†…çš„é…ç½®æ–‡ä»¶ <code>/etc/docker/registry/config.yml</code>ï¼Œåœ¨ <code>storage:</code> ä¸‹æ·»åŠ ä¸Š ä¸‹é¢çš„å‚æ•°ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">delete:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="GC-ä¸å½»åº•ï¼Œæ®‹ç•™-link-æ–‡ä»¶"><a href="#GC-ä¸å½»åº•ï¼Œæ®‹ç•™-link-æ–‡ä»¶" class="headerlink" title="GC ä¸å½»åº•ï¼Œæ®‹ç•™ link æ–‡ä»¶"></a>GC ä¸å½»åº•ï¼Œæ®‹ç•™ link æ–‡ä»¶</h3><p>ä»ä¸Šé¢æˆ‘ä»¬å¯ä»¥å¾—çŸ¥ï¼Œregistry æ— è®ºæ˜¯åˆ é™¤ä¸€ä¸ªé•œåƒè¿˜æ˜¯è¿›è¡Œ GC æ“ä½œï¼Œéƒ½ä¸ä¼šåˆ é™¤ repositories ç›®å½•ä¸‹çš„ <code>_layers/sha256/digest/link</code> æ–‡ä»¶ï¼Œåœ¨è¿›è¡Œ GC ä¹‹åï¼Œä¸€äº›é•œåƒ layer å’Œ config æ–‡ä»¶å·²ç»åœ¨ blobs å­˜å‚¨ç›®å½•ä¸‹åˆ é™¤äº†ï¼Œä½†æŒ‡å‘å®ƒçš„ layers/link æ–‡ä»¶ä¾æ—§ä¿å­˜åœ¨ repositories ç›®å½•ä¸‹ğŸ™„ã€‚GitHub ä¸Šæœ‰ä¸ª PR <a href="https://github.com/docker/distribution/issues/2288" target="_blank" rel="noopener">Remove the layerâ€™s link by garbage-collect #2288</a> å°±æ˜¯ä¸“é—¨æ¥æ¸…ç†è¿™äº›æ— ç”¨çš„ layer link æ–‡ä»¶çš„ï¼Œæœ€æ—©çš„ä¸€ä¸ªæ˜¯ä¸‰å¹´å‰çš„ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰åˆå¹¶ğŸ˜‚ã€‚</p>
<p>ç•™ç€å·²ç»è¢« GC æ‰ blob çš„ layer link ä¹Ÿæ²¡å•¥ç”¨ï¼Œä½¿ç”¨ä¸‹é¢è¿™ä¸ªè„šæœ¬å°±èƒ½åˆ æ‰æ— ç”¨çš„ layer link æ–‡ä»¶ã€‚æ ¹æ® layer link çš„å€¼å» blobs ç›®å½•ä¸‹çœ‹çœ‹è¯¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„è¯å°± rm -rf æ‰ï¼Œå­˜åœ¨çš„è¯å°±ç•™ç€ã€‚è¿™æ ·å°±èƒ½æ¸…ç†å¹²å‡€å•¦ğŸ˜ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">cd /var/lib/registry/docker/registry/v2</span><br><span class="line">for link in $(find repositories -name "link" | grep -E "_layers")</span><br><span class="line">do</span><br><span class="line">    link_sha256=$(echo $&#123;link&#125; | awk -F "/" '&#123;print $6&#125;')</span><br><span class="line">    link_short=$(echo $&#123;link&#125; | awk -F "/" '&#123;print $6&#125;' | cut -c1-2)</span><br><span class="line">    data_file=blobs/sha256/$&#123;link_short&#125;/$&#123;link_sha256&#125;</span><br><span class="line">    dir_link=$(echo $&#123;link&#125; | sed s'/link//g')</span><br><span class="line">    if [[ ! -d "$&#123;data_file&#125;" ]]; then</span><br><span class="line">    rm -rf $&#123;dir_link&#125;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="GC-åè¦é‡å¯ï¼"><a href="#GC-åè¦é‡å¯ï¼" class="headerlink" title="GC åè¦é‡å¯ï¼"></a>GC åè¦é‡å¯ï¼</h3><p>GC ä¹‹åä¸€å®šè¦é‡å¯ï¼Œå› ä¸º registry å®¹å™¨ç¼“å­˜äº†é•œåƒ layer çš„ä¿¡æ¯ï¼Œå½“åˆ é™¤æ‰ä¸€ä¸ªé•œåƒ A ï¼Œåè¾¹ GC æ‰è¯¥é•œåƒçš„ layer ä¹‹åï¼Œå¦‚æœä¸é‡å¯ registry å®¹å™¨ï¼Œå½“é‡æ–° PUSH é•œåƒ A çš„æ—¶å€™å°±ä¼šæç¤ºé•œåƒ layer å·²ç»å­˜åœ¨ï¼Œä¸ä¼šé‡æ–°ä¸Šä¼  layer ï¼Œä½†å®é™…ä¸Šå·²ç»è¢« GC æ‰äº†ï¼Œæœ€ç»ˆä¼šå¯¼è‡´é•œåƒ A ä¸å®Œæ•´ï¼Œæ— æ³• pull åˆ°è¯¥é•œåƒã€‚</p>
<h3 id="GC-ä¸æ˜¯äº‹åŠ¡æ€§æ“ä½œ"><a href="#GC-ä¸æ˜¯äº‹åŠ¡æ€§æ“ä½œ" class="headerlink" title="GC ä¸æ˜¯äº‹åŠ¡æ€§æ“ä½œ"></a>GC ä¸æ˜¯äº‹åŠ¡æ€§æ“ä½œ</h3><p>GC çš„æ—¶å€™æœ€å¥½æš‚åœ PUSH é•œåƒï¼Œä»¥å…æŠŠæ­£åœ¨ä¸Šä¼ çš„é•œåƒ layer ç»™ GC æ‰ã€‚</p>
    </div>
      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/docker/" rel="tag"><i class="fa fa-tag"></i> docker</a>
              <a href="/tags/registry/" rel="tag"><i class="fa fa-tag"></i> registry</a>
              <a href="/tags/%E9%95%9C%E5%83%8F/" rel="tag"><i class="fa fa-tag"></i> é•œåƒ</a>
          </div>
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/Q2-reading.html" rel="prev" title="2020 é˜…è¯»è®°å½•ï¼ˆäºŒï¼‰">
      <i class="fa fa-chevron-left"></i> 2020 é˜…è¯»è®°å½•ï¼ˆäºŒï¼‰
    </a></div>
      <div class="post-nav-item">
    <a href="/homelab.html" rel="next" title="åƒåœ¾ä½¬çš„ Homelab æŠ˜è…¾è®°å½•">
      åƒåœ¾ä½¬çš„ Homelab æŠ˜è…¾è®°å½• <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
  </article>
  </div>
          </div>
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
        </div>
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>
  <aside class="sidebar">
    <div class="sidebar-inner">
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>
      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#registry-GC-åŸç†ğŸ¤”"><span class="nav-number">1.</span> <span class="nav-text">registry GC åŸç†ğŸ¤”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#éƒ¨ç½²-registry-å®¹å™¨"><span class="nav-number">1.1.</span> <span class="nav-text">éƒ¨ç½² registry å®¹å™¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#COPY-é•œåƒåˆ°-registry"><span class="nav-number">1.2.</span> <span class="nav-text">COPY é•œåƒåˆ° registry</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#registry-å­˜å‚¨ç›®å½•é•¿ä»€ä¹ˆæ ·ğŸ¤”"><span class="nav-number">1.3.</span> <span class="nav-text">registry å­˜å‚¨ç›®å½•é•¿ä»€ä¹ˆæ ·ğŸ¤”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DELETE-é•œåƒ"><span class="nav-number">1.4.</span> <span class="nav-text">DELETE é•œåƒ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#registry-GC-åŸç†"><span class="nav-number">2.</span> <span class="nav-text">registry GC åŸç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-æ˜¯å¼„å•¥å’§ï¼ŸğŸ¤”"><span class="nav-number">2.1.</span> <span class="nav-text">GC æ˜¯å¼„å•¥å’§ï¼ŸğŸ¤”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-çš„è¿‡ç¨‹"><span class="nav-number">2.2.</span> <span class="nav-text">GC çš„è¿‡ç¨‹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-éƒ½å¹²äº†å•¥ï¼Ÿ"><span class="nav-number">2.3.</span> <span class="nav-text">GC éƒ½å¹²äº†å•¥ï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number">2.4.</span> <span class="nav-text">æ€»ç»“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#shell-å¤§æ³•å¥½ï¼"><span class="nav-number">2.5.</span> <span class="nav-text">shell å¤§æ³•å¥½ï¼</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è¸©å‘ï¼"><span class="nav-number">3.</span> <span class="nav-text">è¸©å‘ï¼</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-operation-is-unsupported-405-Method-Not-Allowed"><span class="nav-number">3.1.</span> <span class="nav-text">The operation is unsupported.(405 Method Not Allowed)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-ä¸å½»åº•ï¼Œæ®‹ç•™-link-æ–‡ä»¶"><span class="nav-number">3.2.</span> <span class="nav-text">GC ä¸å½»åº•ï¼Œæ®‹ç•™ link æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-åè¦é‡å¯ï¼"><span class="nav-number">3.3.</span> <span class="nav-text">GC åè¦é‡å¯ï¼</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-ä¸æ˜¯äº‹åŠ¡æ€§æ“ä½œ"><span class="nav-number">3.4.</span> <span class="nav-text">GC ä¸æ˜¯äº‹åŠ¡æ€§æ“ä½œ</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->
      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="æœ¨å­"
      src="https://blog.k8s.li/avatar.png">
  <p class="site-author-name" itemprop="name">æœ¨å­</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">98</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:blog@502.li" title="E-Mail â†’ mailto:blog@502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://kindle.502.li/" title="Kindle â†’ https:&#x2F;&#x2F;kindle.502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tg.k8s.li/" title="Channel â†’ https:&#x2F;&#x2F;tg.k8s.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Channel</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>
      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>
      </div>
    </main>
    <footer class="footer">
      <div class="footer-inner">
<div class="copyright">
  &copy; 2018 â€“ 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">æœ¨å­</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">39:50</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>
      </div>
    </footer>
  </div>
  <script src="/lib/anime.min.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>
<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://muzi.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://blog.k8s.li/registry-gc.html",
            identifier: "registry-gc.html",
            title: "docker registry GC åŸç†åˆ†æ"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://muzi.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>
</body>
</html>
