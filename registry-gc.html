<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.k8s.li').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>
  <meta name="description" content="好久没更新博客了，在家摸鱼赶紧来水一篇😂  registry GC 原理🤔在咱上个月写的《深入浅出容器镜像的一生》中简单提到了容器镜像的一些知识，也简单介绍了镜像在 registry 中存储的目录结构。今天还是从文件系统层面分析一下 registry GC 的原理，比从源码来分析更直观一些。 部署 registry 容器首先我们需要在本地部署一个 registry 容器，同时为了操作的方便还">
<meta property="og:type" content="article">
<meta property="og:title" content="docker registry GC 原理分析">
<meta property="og:url" content="https://blog.k8s.li/registry-gc.html">
<meta property="og:site_name" content="木子">
<meta property="og:description" content="好久没更新博客了，在家摸鱼赶紧来水一篇😂  registry GC 原理🤔在咱上个月写的《深入浅出容器镜像的一生》中简单提到了容器镜像的一些知识，也简单介绍了镜像在 registry 中存储的目录结构。今天还是从文件系统层面分析一下 registry GC 的原理，比从源码来分析更直观一些。 部署 registry 容器首先我们需要在本地部署一个 registry 容器，同时为了操作的方便还">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/registry-storage.jpeg">
<meta property="og:image" content="https://p.k8s.li/registry-gc.png">
<meta property="og:image" content="https://p.k8s.li/registry-gc-1.jpeg">
<meta property="og:image" content="https://p.k8s.li/registry-gc-2.jpeg">
<meta property="og:image" content="https://p.k8s.li/registry-gc-3.jpeg">
<meta property="article:published_time" content="2020-07-10T16:00:00.000Z">
<meta property="article:modified_time" content="2021-05-30T14:38:18.416Z">
<meta property="article:author" content="木子">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="registry">
<meta property="article:tag" content="镜像">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/registry-storage.jpeg">
<link rel="canonical" href="https://blog.k8s.li/registry-gc.html">
<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>
  <title>docker registry GC 原理分析 | 木子</title>
  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }
  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>
<link rel="alternate" href="/atom.xml" title="木子" type="application/atom+xml">
</head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">
    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">木子</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>
<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">
    <a href="/" rel="section"><i class="fa fa-fw fa-desktop"></i>Home</a>
  </li>
        <li class="menu-item menu-item-books">
    <a href="/booklist.html" rel="section"><i class="fa fa-fw fa-book"></i>Books</a>
  </li>
        <li class="menu-item menu-item-kindle">
    <a href="https://kindle.502.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
  </li>
        <li class="menu-item menu-item-friend">
    <a href="/link/" rel="section"><i class="fa fa-fw fa-link"></i>Friend</a>
  </li>
        <li class="menu-item menu-item-about">
    <a href="/about.html" rel="section"><i class="fa fa-fw fa-user-circle-o"></i>About</a>
  </li>
  </ul>
</nav>
</div>
    </header>
  <div class="reading-progress-bar"></div>
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
  <div class="posts-expand">
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/registry-gc.html">
    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog.k8s.li/avatar.png">
      <meta itemprop="name" content="木子">
      <meta itemprop="description" content="">
    </span>
    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="木子">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          docker registry GC 原理分析
        </h2>
        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="创建时间：2020-07-11 2020-07-11T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2020-07-11T00:00:00+08:00">2020-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-30 2021-05-30T22:38:18+08:00" itemprop="dateModified" datetime="2021-05-30T22:38:18+08:00">2021-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>
            </span>
  <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    <a title="disqus" href="/registry-gc.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="registry-gc.html" itemprop="commentCount"></span>
    </a>
  </span>
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>36 分钟</span>
            </span>
        </div>
      </header>
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>好久没更新博客了，在家摸鱼赶紧来水一篇😂</p>
</blockquote>
<h2 id="registry-GC-原理🤔"><a href="#registry-GC-原理🤔" class="headerlink" title="registry GC 原理🤔"></a>registry GC 原理🤔</h2><p>在咱上个月写的<a href="https://blog.k8s.li/Exploring-container-image.html">《深入浅出容器镜像的一生》</a>中简单提到了容器镜像的一些知识，也简单介绍了镜像在 registry 中存储的目录结构。今天还是从文件系统层面分析一下 registry GC 的原理，比从源码来分析更直观一些。</p>
<h3 id="部署-registry-容器"><a href="#部署-registry-容器" class="headerlink" title="部署 registry 容器"></a>部署 registry 容器</h3><p>首先我们需要在本地部署一个 registry 容器，同时为了操作的方便还需要使用到 skopeo 这个工具来替代 docker 命令行客户端进行 copy 镜像和 delete 镜像。关于 skopeo 这个工具的安装和使用可以参考咱之前写过的<a href="https://blog.k8s.li/skopeo.html">《镜像搬运工 skopeo 》</a>。</p>
<h4 id="自签-SSL-证书"><a href="#自签-SSL-证书" class="headerlink" title="自签 SSL 证书"></a>自签 SSL 证书</h4><p>这一步为了方便在使用 skopeo 的时候不用加一堆额外的参数😂</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">set -e</span><br><span class="line">set -o nounset</span><br><span class="line">cat &gt;ca.conf &lt;&lt;EOF</span><br><span class="line">[ req ]</span><br><span class="line">default_bits  = 2048</span><br><span class="line">distinguished_name = req_distinguished_name</span><br><span class="line">prompt   = no</span><br><span class="line">encrypt_key  = no</span><br><span class="line">x509_extensions  = v3_ca</span><br><span class="line">[ req_distinguished_name ]</span><br><span class="line">CN         = localhost</span><br><span class="line">[ CA_default ]</span><br><span class="line">copy_extensions = copy</span><br><span class="line">[ alternate_names ]</span><br><span class="line">DNS.2=localhost</span><br><span class="line">[ v3_ca ]</span><br><span class="line">subjectAltName=@alternate_names</span><br><span class="line">subjectKeyIdentifier=hash</span><br><span class="line">authorityKeyIdentifier=keyid:always,issuer:always</span><br><span class="line">basicConstraints = critical,CA:true</span><br><span class="line">keyUsage=keyCertSign,cRLSign,digitalSignature,keyEncipherment,nonRepudiation</span><br><span class="line">EOF</span><br><span class="line">mkdir -p certs</span><br><span class="line">openssl req -days 365 -x509 -config ca.conf \</span><br><span class="line">    -new -keyout certs/domain.key -out certs/domain.crt</span><br></pre></td></tr></table></figure>
<ul>
<li>信任证书，根据不同的发行版选择相应的路径和命令行即可。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> CentOS</span></span><br><span class="line">update-ca-trust force-enable</span><br><span class="line">cp certs/domain.crt /etc/pki/ca-trust/source/anchors/localhost.crt</span><br><span class="line">update-ca-trust</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Ubuntu</span></span><br><span class="line">cp certs/domain.crt /usr/local/share/ca-certificates/localhost.crt</span><br><span class="line"><span class="meta">$</span><span class="bash"> update-ca-certificates</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Debian</span></span><br><span class="line">cp certs/domain.crt /usr/share/ca-certificates/localhost.crt</span><br><span class="line">echo localhost.crt &gt;&gt; /etc/ca-certificates.conf</span><br><span class="line">update-ca-certificates</span><br></pre></td></tr></table></figure>
<h4 id="创建密码-auth-认证-auth-htpasswd-文件"><a href="#创建密码-auth-认证-auth-htpasswd-文件" class="headerlink" title="创建密码 auth 认证  auth.htpasswd 文件"></a>创建密码 auth 认证  auth.htpasswd 文件</h4><p>由于 PUSH 镜像和 DELETE 镜像是通过 HTTP 请求 registry 的 API 完成的，每个请求都需要一个 token 才能完成操作，这个 token 需要使用这个 AUTH 文件来进行鉴权，使用 <code>htpasswd</code> 来生成一个明文的用户/密码即可。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">htpasswd -cB -b auth.htpasswd root 123456</span><br></pre></td></tr></table></figure>
<h4 id="启动-registry-容器，docker-run-走起！"><a href="#启动-registry-容器，docker-run-走起！" class="headerlink" title="启动 registry 容器，docker run 走起！"></a>启动 registry 容器，docker run 走起！</h4><ul>
<li><code>-v /var/lib/registry:/var/lib/registry</code> ，将本地的存储目录挂载到容器内的 registry 存储目录下。</li>
<li><code>-v pwd/certs:/certs</code>，将生成的 SSL 证书挂载到容器内。</li>
<li><code>-e REGISTRY_STORAGE_DELETE_ENABLED=true</code>，添加该参数才能进行 DELETE 镜像操作，不然的话会提示 <a href="https://github.com/docker/distribution/issues/1573" target="_blank" rel="noopener">Error in deleting repository in a private registry V2 #1573</a> 这种错误（＞﹏＜）。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -p 127.0.0.1:443:5000 --name registry \</span><br><span class="line">    -v /var/lib/registry:/var/lib/registry \</span><br><span class="line">    -v `pwd`/certs:/certs \</span><br><span class="line">    -v $(pwd)/auth.htpasswd:/etc/docker/registry/auth.htpasswd \</span><br><span class="line">    -e REGISTRY_AUTH="&#123;htpasswd: &#123;realm: localhost, path: /etc/docker/registry/auth.htpasswd&#125;&#125;" \</span><br><span class="line">    -e REGISTRY_HTTP_ADDR=0.0.0.0:5000 \</span><br><span class="line">    -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \</span><br><span class="line">    -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \</span><br><span class="line">    -e REGISTRY_STORAGE_DELETE_ENABLED=true \</span><br><span class="line">    registry</span><br></pre></td></tr></table></figure>
<h4 id="docker-login"><a href="#docker-login" class="headerlink" title="docker login"></a>docker login</h4><p>这一步是为了在 <code>~/.docker/.config.json</code> ，中添加上 auth 认证，后面使用 skopeo 的时候会用到。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">╭─root@sg-02 ~/registry</span><br><span class="line">╰─# docker login localhost -u root -p 123456</span><br><span class="line">]WARNING! Using --password via the CLI is insecure. Use --password-stdin.</span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br><span class="line">Login Succeeded</span><br><span class="line">╭─root@sg-02 ~/registry</span><br><span class="line">╰─# cat ~/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">        "auths": &#123;</span><br><span class="line">                "https://registry.k8s.li/v2": &#123;</span><br><span class="line">                        "auth": "VlJFpmQE43Sw=="</span><br><span class="line">                &#125;,</span><br><span class="line">                "localhost": &#123;</span><br><span class="line">                        "auth": "cm9vdDoxMjM0NTY="</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        "HttpHeaders": &#123;</span><br><span class="line">                "User-Agent": "Docker-Client/19.03.5 (linux)"</span><br><span class="line">        &#125;,</span><br><span class="line">        "experimental": "enabled"</span><br><span class="line">&#125;#</span><br></pre></td></tr></table></figure>
<h3 id="COPY-镜像到-registry"><a href="#COPY-镜像到-registry" class="headerlink" title="COPY 镜像到 registry"></a>COPY 镜像到 registry</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">╭─root@sg-02 ~/registry</span><br><span class="line">╰─# skopeo copy docker://alpine:3.10 docker://localhost/library/alpine:3.10</span><br><span class="line">Getting image source signatures</span><br><span class="line">Copying blob 21c83c524219 done</span><br><span class="line">Copying config be4e4bea2c done</span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br></pre></td></tr></table></figure>
<h3 id="registry-存储目录长什么样🤔"><a href="#registry-存储目录长什么样🤔" class="headerlink" title="registry 存储目录长什么样🤔"></a>registry 存储目录长什么样🤔</h3><p><img src="https://p.k8s.li/registry-storage.jpeg" alt=""></p>
<p>registry 容器内的<code>/var/lib/registry/docker/registry/v2</code> 存储目录，结合上面这张图，通过 tree 目录我们可以清晰地看到：registry 存储目录下只有两种文件名的文件，一个是 <code>data</code> 文件，一个是 <code>link</code> 文件。其中 link 文件是普通的文本文件，存放在 <code>repositories</code> 目录下，其内容是指向 data 文件的 sha256 digest 值。link 文件是不是有点像 C 语言中的指针😂（大雾。</p>
<p>data 文件存放在 <code>blobs</code> 目录下文件又分为了三种文件，一个是镜像每一层的 <code>layer</code> 文件和镜像的 <code>config</code> 文件，以及镜像的 <code>manifest</code> 文件。</p>
<p>在 <code>repositories</code> 目录下每个镜像的 <code>_layers/sha256</code> 目录下的文件夹名是镜像的 layer 和 config 文件的 digest ，该目录下的 link 文件就是指向对应 blobs 目录下的 data 文件。当我们 pull 一个镜像的 layer 时，是通过 link 文件找到 layer 在 registry 中实际的存储位置的。</p>
<p>在 <code>_manifests</code> 文件夹下的 tags 和 revisions 目录下的 link 文件则指向该镜像的 manifest 文件，保存在所有历史镜像 tag 的 manifest 文件 的 link。当删除一个镜像时，只会删除该镜像最新的 tag 的 link 文件。</p>
<p>tags 目录下的文件夹名例如 3.10 ，就是该镜像的 tag ，在它的子目录下的 current/link 文件则记录了当前 tag 指向的 manifest 文件的位置。比如我们的 alpine:latest 镜像，每次 push 新的 latest 镜像时，current/link 都会更新成指向最新镜像的 manifest 文件。</p>
<p>我们后面观察一下当删除一个镜像时，这些文件是怎么变化的，就可以得知通过 registry API 进行 DELETE 操作可以转换成文件系统层面上对 link 文件的删除操作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">╭─root@sg-02 ~/registry</span><br><span class="line">╰─# cd /var/lib/registry/docker/registry/v2</span><br><span class="line">╭─root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">╰─# tree</span><br><span class="line">.</span><br><span class="line">├── blobs</span><br><span class="line">│   └── sha256</span><br><span class="line">│       ├── 21</span><br><span class="line">│       │   └── 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── a1</span><br><span class="line">│       │   └── a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">│       │       └── data</span><br><span class="line">│       └── be</span><br><span class="line">│           └── be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">│               └── data</span><br><span class="line">└── repositories</span><br><span class="line">    └── library</span><br><span class="line">        └── alpine</span><br><span class="line">            ├── _layers</span><br><span class="line">            │   └── sha256</span><br><span class="line">            │       ├── 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">            │       │   └── link</span><br><span class="line">            │       └── be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">            │           └── link</span><br><span class="line">            ├── _manifests</span><br><span class="line">            │   ├── revisions</span><br><span class="line">            │   │   └── sha256</span><br><span class="line">            │   │       └── a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">            │   │           └── link</span><br><span class="line">            │   └── tags</span><br><span class="line">            │       └── 3.10</span><br><span class="line">            │           ├── current</span><br><span class="line">            │           │   └── link</span><br><span class="line">            │           └── index</span><br><span class="line">            │               └── sha256</span><br><span class="line">            │                   └── a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">            │                       └── link</span><br><span class="line">            └── _uploads</span><br><span class="line"></span><br><span class="line">26 directories, 8 files</span><br></pre></td></tr></table></figure>
<ul>
<li><code>blobs</code> 存储目录，存放了镜像的三个必须文件，<code>layer</code>，<code>manifest</code>，<code>config</code>。通过文件大小我们可以大致地推算出最大的 2.7M 是镜像的 layer 。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">╭─root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">╰─# find . -name "data" -exec ls -sh &#123;&#125; \;</span><br><span class="line">2.7M ./blobs/sha256/21/21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d/data</span><br><span class="line">4.0K ./blobs/sha256/a1/a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590/data</span><br><span class="line">4.0K ./blobs/sha256/be/be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c/data</span><br></pre></td></tr></table></figure>
<ul>
<li><code>image layer</code> 文件，是 gzip 格式的 tar 包，是镜像层真实内容的 <code>tar.gzip</code> 格式存储形式。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./blobs/sha256/21/21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d/data: gzip compressed data</span><br></pre></td></tr></table></figure>
<ul>
<li><code>image manifest</code> 文件，json 文件格式的，存放该镜像 <code>layer</code> 和  <code>image config</code> 文件的索引。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">╭─root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">╰─# cat ./blobs/sha256/a1/a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590/data</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">"schemaVersion"</span>: <span class="number">2</span>,</span><br><span class="line">   <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">   <span class="attr">"config"</span>: &#123;</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.container.image.v1+json"</span>,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">1509</span>,</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"layers"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span>,</span><br><span class="line">         <span class="attr">"size"</span>: <span class="number">2795580</span>,</span><br><span class="line">         <span class="attr">"digest"</span>: <span class="string">"sha256:21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d"</span></span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;#</span><br></pre></td></tr></table></figure>
<ul>
<li><code>image config</code> 文件，json 格式的。是构建时生成的，根据 <code>Dockerfile</code> 和宿主机的一些信息，以及一些构建过程中的容器可以生成 digest 唯一的 <code>image config</code> 文件。仔细看这个 image config 文件是不是有点疑惑，无论是 manifest 还是 config 文件里面的内容压根就没有镜像的名称和 tag 。其实，镜像就好比一个文件，文件的内容和文件名毫无关系。在 registry 中，是通过路径名的方式来对一个镜像进行命名的。当我们往 registry 中 PUSH 一个镜像时，以<code>localhost/library/alpine:3.10</code>为例，<code>localhost</code>，就是该 registry 的域名或者 URL ，<code>library</code>就是 project ，<code>alpine:3.10</code>就是镜像名和镜像的 tag。registry 会根据 <code>localhost/library/alpine:3.10</code> 在<code>repositories</code> 目录下依次创建相应的目录。</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">╭─root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">╰─# cat ./blobs/sha256/be/be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c/data | jq "."</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">  <span class="attr">"config"</span>: &#123;</span><br><span class="line">    <span class="attr">"Hostname"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"Domainname"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"User"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"AttachStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStdout"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStderr"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Tty"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"OpenStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"StdinOnce"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Env"</span>: [</span><br><span class="line">      <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Cmd"</span>: [</span><br><span class="line">      <span class="string">"/bin/sh"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"ArgsEscaped"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"Image"</span>: <span class="string">"sha256:d928e20e1fbe5142bb5cdf594862271673133c5354950d6a8f74afed24df4c23"</span>,</span><br><span class="line">    <span class="attr">"Volumes"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"WorkingDir"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"Entrypoint"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"OnBuild"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"Labels"</span>: <span class="literal">null</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"container"</span>: <span class="string">"37e3972c75360676982c8f6591b66a9097719e5ad4cecd5fa63ad4f06472825f"</span>,</span><br><span class="line">  <span class="attr">"container_config"</span>: &#123;</span><br><span class="line">    <span class="attr">"Hostname"</span>: <span class="string">"37e3972c7536"</span>,</span><br><span class="line">    <span class="attr">"Domainname"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"User"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"AttachStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStdout"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStderr"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Tty"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"OpenStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"StdinOnce"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Env"</span>: [</span><br><span class="line">      <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Cmd"</span>: [</span><br><span class="line">      <span class="string">"/bin/sh"</span>,</span><br><span class="line">      <span class="string">"-c"</span>,</span><br><span class="line">      <span class="string">"#(nop) "</span>,</span><br><span class="line">      <span class="string">"CMD [\"/bin/sh\"]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"ArgsEscaped"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"Image"</span>: <span class="string">"sha256:d928e20e1fbe5142bb5cdf594862271673133c5354950d6a8f74afed24df4c23"</span>,</span><br><span class="line">    <span class="attr">"Volumes"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"WorkingDir"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"Entrypoint"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"OnBuild"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"Labels"</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"created"</span>: <span class="string">"2020-04-24T01:05:21.571691552Z"</span>,</span><br><span class="line">  <span class="attr">"docker_version"</span>: <span class="string">"18.09.7"</span>,</span><br><span class="line">  <span class="attr">"history"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"created"</span>: <span class="string">"2020-04-24T01:05:21.178437685Z"</span>,</span><br><span class="line">      <span class="attr">"created_by"</span>: <span class="string">"/bin/sh -c #(nop) ADD file:66a440394c2442570f1f060e25c86613cb2d88a8af0c71c5a4154b3570e9a805 in / "</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"created"</span>: <span class="string">"2020-04-24T01:05:21.571691552Z"</span>,</span><br><span class="line">      <span class="attr">"created_by"</span>: <span class="string">"/bin/sh -c #(nop)  CMD [\"/bin/sh\"]"</span>,</span><br><span class="line">      <span class="attr">"empty_layer"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">  <span class="attr">"rootfs"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"layers"</span>,</span><br><span class="line">    <span class="attr">"diff_ids"</span>: [</span><br><span class="line">      <span class="string">"sha256:1b3ee35aacca9866b01dd96e870136266bde18006ac2f0d6eb706c798d1fa3c3"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>我们再往 registry 中 COPY 一个镜像，方便后面的分析过程。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">skopeo copy docker://debian:buster-slim docker://localhost/library/debian:buster-slim</span><br></pre></td></tr></table></figure>
<ul>
<li>这是 registry 中就只有 <code>alpine:3.10</code> 和 <code>debian:buster-slim</code>这两个基础镜像，此时的 registry 存储目录的结构如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">╭─root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">╰─# tree</span><br><span class="line">.</span><br><span class="line">├── blobs</span><br><span class="line">│   └── sha256</span><br><span class="line">│       ├── 21</span><br><span class="line">│       │   └── 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── 43</span><br><span class="line">│       │   └── 43e3995ee54ac008271bfcf2d8ac7278c33f4c5e83d2f02bfcddd350034e3357</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── 7c</span><br><span class="line">│       │   └── 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── 85</span><br><span class="line">│       │   └── 8559a31e96f442f2c7b6da49d6c84705f98a39d8be10b3f5f14821d0ee8417df</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── a1</span><br><span class="line">│       │   └── a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">│       │       └── data</span><br><span class="line">│       └── be</span><br><span class="line">│           └── be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">│               └── data</span><br><span class="line">└── repositories</span><br><span class="line">    └── library</span><br><span class="line">        ├── alpine</span><br><span class="line">        │   ├── _layers</span><br><span class="line">        │   │   └── sha256</span><br><span class="line">        │   │       ├── 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">        │   │       │   └── link</span><br><span class="line">        │   │       └── be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">        │   │           └── link</span><br><span class="line">        │   ├── _manifests</span><br><span class="line">        │   │   ├── revisions</span><br><span class="line">        │   │   │   └── sha256</span><br><span class="line">        │   │   │       └── a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">        │   │   │           └── link</span><br><span class="line">        │   │   └── tags</span><br><span class="line">        │   │       └── 3.10</span><br><span class="line">        │   │           ├── current</span><br><span class="line">        │   │           │   └── link</span><br><span class="line">        │   │           └── index</span><br><span class="line">        │   │               └── sha256</span><br><span class="line">        │   │                   └── a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">        │   │                       └── link</span><br><span class="line">        │   └── _uploads</span><br><span class="line">        └── debian</span><br><span class="line">            ├── _layers</span><br><span class="line">            │   └── sha256</span><br><span class="line">            │       ├── 43e3995ee54ac008271bfcf2d8ac7278c33f4c5e83d2f02bfcddd350034e3357</span><br><span class="line">            │       │   └── link</span><br><span class="line">            │       └── 8559a31e96f442f2c7b6da49d6c84705f98a39d8be10b3f5f14821d0ee8417df</span><br><span class="line">            │           └── link</span><br><span class="line">            ├── _manifests</span><br><span class="line">            │   ├── revisions</span><br><span class="line">            │   │   └── sha256</span><br><span class="line">            │   │       └── 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">            │   │           └── link</span><br><span class="line">            │   └── tags</span><br><span class="line">            │       └── buster-slim</span><br><span class="line">            │           ├── current</span><br><span class="line">            │           │   └── link</span><br><span class="line">            │           └── index</span><br><span class="line">            │               └── sha256</span><br><span class="line">            │                   └── 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">            │                       └── link</span><br><span class="line">            └── _uploads</span><br><span class="line"></span><br><span class="line">48 directories, 16 files</span><br></pre></td></tr></table></figure>
<h3 id="DELETE-镜像"><a href="#DELETE-镜像" class="headerlink" title="DELETE 镜像"></a>DELETE 镜像</h3><ul>
<li>通过 <code>skopeo delete</code> 删除镜像，注意，通过 registry 的 API 删除镜像每次只能删除一个 tag 的镜像。</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">╭─root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">╰─# skopeo delete docker://localhost/library/alpine:3.10 --debug</span><br><span class="line">DEBU[0000] Returning credentials from /run/containers/0/auth.json</span><br><span class="line">DEBU[0000] Using registries.d directory /etc/containers/registries.d for sigstore configuration</span><br><span class="line">DEBU[0000]  No signature storage configuration found for localhost/library/alpine:3.10</span><br><span class="line">DEBU[0000] Looking for TLS certificates and private keys in /etc/docker/certs.d/localhost</span><br><span class="line">DEBU[0000] Loading registries configuration "/etc/containers/registries.conf"</span><br><span class="line">DEBU[0000] GET https://localhost/v2/</span><br><span class="line">DEBU[0000] Ping https://localhost/v2/ status 401</span><br><span class="line">DEBU[0000] GET https://localhost/v2/library/alpine/manifests/3.10</span><br><span class="line">DEBU[0000] DELETE https://localhost/v2/library/alpine/manifests/sha256:a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br></pre></td></tr></table></figure>
<ul>
<li>再看一下删除后的 registry 存储目录下的 alpine 目录里都少了哪些东东？</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">╭─root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">╰─# tree</span><br><span class="line">.</span><br><span class="line">├── blobs</span><br><span class="line">│   └── sha256</span><br><span class="line">│       ├── 21</span><br><span class="line">│       │   └── 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── 43</span><br><span class="line">│       │   └── 43e3995ee54ac008271bfcf2d8ac7278c33f4c5e83d2f02bfcddd350034e3357</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── 7c</span><br><span class="line">│       │   └── 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── 85</span><br><span class="line">│       │   └── 8559a31e96f442f2c7b6da49d6c84705f98a39d8be10b3f5f14821d0ee8417df</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── a1</span><br><span class="line">│       │   └── a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">│       │       └── data</span><br><span class="line">│       └── be</span><br><span class="line">│           └── be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">│               └── data</span><br><span class="line">└── repositories</span><br><span class="line">    └── library</span><br><span class="line">        ├── alpine</span><br><span class="line">        │   ├── _layers</span><br><span class="line">        │   │   └── sha256</span><br><span class="line">        │   │       ├── 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">        │   │       │   └── link</span><br><span class="line">        │   │       └── be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">        │   │           └── link</span><br><span class="line">        │   ├── _manifests</span><br><span class="line">        │   │   ├── revisions</span><br><span class="line">        │   │   │   └── sha256</span><br><span class="line">        │   │   │       └── a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">        │   │   └── tags</span><br><span class="line">        │   └── _uploads</span><br></pre></td></tr></table></figure>
<p>我们可以看到，通过 skopeo delete 一个镜像的时候，只对 <code>_manifests</code> 下的 link 文件进行了操作，删除的都是对该 tag 镜像 manifest 文件夹下的 link 文件，实际上 manifest 文件并没有从 blobs 目录下删除，只是删除了该镜像的 manifest 文件的引用。删除一个镜像后，tags 目录下的 tag 名目录就被删除了，_manifests/revisions 目录下的 link 文件也被删除了。实际上两者删除的是同一个内容，即对该镜像 manifest 文件的 link 文件。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEBU[0000] DELETE https://localhost/v2/library/alpine/manifests/sha256:a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br></pre></td></tr></table></figure>
<p>从上面文件的变化可以得出，通过 registry API 来 DELETE 一个镜像实质上是删除 repositories 元数据文件夹下的 tag 名文件夹和该 tag 的 revisions 下的 link 文件。</p>
<h2 id="registry-GC-原理"><a href="#registry-GC-原理" class="headerlink" title="registry GC 原理"></a>registry GC 原理</h2><p>上面巴拉巴拉扯了一通也许你现在一头雾水，这和今天的主题 registry GC 原理毛关系？😂，其实想要从文件系统层面来理解 registry GC ，上面的知识是必备的（<em>^____^</em>）。</p>
<h3 id="GC-是弄啥咧？🤔"><a href="#GC-是弄啥咧？🤔" class="headerlink" title="GC 是弄啥咧？🤔"></a>GC 是弄啥咧？🤔</h3><p>GC 嘛，就是垃圾回收的意思，从 docker 官方文档 <a href="https://docs.docker.com/registry/garbage-collection/" target="_blank" rel="noopener">Garbage collection</a> 偷来的 example 😂来解释一下吧。</p>
<ul>
<li>假如镜像 A 和镜像 B ，他俩分别引用了layer a，b和 a，c。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A -----&gt; a &lt;----- B</span><br><span class="line">    \--&gt; b     |</span><br><span class="line">         c &lt;--&#x2F;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过 registry API 删除镜像 B 之后，layer c 并没有删掉，只是删掉了对它的引用，所以 c 是多余的。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A -----&gt; a     B</span><br><span class="line">    \--&gt; b</span><br><span class="line">         c</span><br></pre></td></tr></table></figure>
<ul>
<li>GC 之后，layer c 就被删掉了，现在就没有无用的 layer 了。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A -----&gt; a</span><br><span class="line">    \--&gt; b</span><br></pre></td></tr></table></figure>
<h3 id="GC-的过程"><a href="#GC-的过程" class="headerlink" title="GC 的过程"></a>GC 的过程</h3><p>翻一下 registry  GC 的源码 <a href="https://github.com/docker/distribution/blob/master/registry/storage/garbagecollect.go" target="_blank" rel="noopener">garbagecollect.go</a>，可以看到 GC 的主要分两个阶段，marking 和 sweep。</p>
<h4 id="marking"><a href="#marking" class="headerlink" title="marking"></a>marking</h4><p>marking 阶段是扫描所有的 manifest 文件，根据上文我们提到的 link 文件，通过扫描所有镜像 tags 目录下的 link 文件就可以得到这些镜像的 manifest，在 manifest 中保存在该镜像所有的 layer 和 config 文件的 digest 值，把这些值标记为<strong>不能清除</strong>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mark</span></span><br><span class="line">markSet := <span class="built_in">make</span>(<span class="keyword">map</span>[digest.Digest]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">manifestArr := <span class="built_in">make</span>([]ManifestDel, <span class="number">0</span>)</span><br><span class="line">err := repositoryEnumerator.Enumerate(ctx, <span class="function"><span class="keyword">func</span><span class="params">(repoName <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	emit(repoName)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	named, err := reference.WithName(repoName)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to parse repo name %s: %v"</span>, repoName, err)</span><br><span class="line">	&#125;</span><br><span class="line">	repository, err := registry.Repository(ctx, named)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to construct repository: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	manifestService, err := repository.Manifests(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to construct manifest service: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	manifestEnumerator, ok := manifestService.(distribution.ManifestEnumerator)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"unable to convert ManifestService into ManifestEnumerator"</span>)</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>这一阶段用 shell 脚本来实现的话大致可以这样来搞，使用 shell 去遍历这些 manifest ，然后再 grep 出所有的 sha256 值就能得到这个镜像所有的 blobs 目录下的 data 文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">set -x</span><br><span class="line">v2=$&#123;v2:="/var/lib/registry/docker/registry/v2"&#125;</span><br><span class="line">cd $&#123;v2&#125;</span><br><span class="line">all_blobs=/tmp/all_blobs.list</span><br><span class="line">echo "" &gt; $&#123;all_blobs&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> marking all the blob by all images manifest</span></span><br><span class="line">for tag in $(find repositories -name "link" | grep current)</span><br><span class="line">do</span><br><span class="line">    link=$(cat $&#123;tag&#125; | cut -c8-71)</span><br><span class="line">    mfs=blobs/sha256/$&#123;link:0:2&#125;/$&#123;link&#125;/data</span><br><span class="line">    echo $&#123;link&#125; &gt;&gt; $&#123;all_blobs&#125;</span><br><span class="line">    grep sha256 $&#123;mfs&#125; |cut -d "\"" -f4 | cut -c8-71 &gt;&gt; $&#123;all_blobs&#125;</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h4 id="sweep"><a href="#sweep" class="headerlink" title="sweep"></a>sweep</h4><p>第二阶段就是删除操作啦，marking 完之后，没有标记 blob（ layer 和 config 文件）就会被清除掉。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sweep</span></span><br><span class="line">vacuum := NewVacuum(ctx, storageDriver)</span><br><span class="line"><span class="keyword">if</span> !opts.DryRun &#123;</span><br><span class="line">	<span class="keyword">for</span> _, obj := <span class="keyword">range</span> manifestArr &#123;</span><br><span class="line">		err = vacuum.RemoveManifest(obj.Name, obj.Digest, obj.Tags)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">"failed to delete manifest %s: %v"</span>, obj.Digest, err)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">blobService := registry.Blobs()</span><br><span class="line">deleteSet := <span class="built_in">make</span>(<span class="keyword">map</span>[digest.Digest]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">err = blobService.Enumerate(ctx, <span class="function"><span class="keyword">func</span><span class="params">(dgst digest.Digest)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// check if digest is in markSet. If not, delete it!</span></span><br><span class="line">	<span class="keyword">if</span> _, ok := markSet[dgst]; !ok &#123;</span><br><span class="line">		deleteSet[dgst] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="https://p.k8s.li/registry-gc.png" alt=""></p>
<h3 id="GC-都干了啥？"><a href="#GC-都干了啥？" class="headerlink" title="GC 都干了啥？"></a>GC 都干了啥？</h3><p>接下来我们就进行实际的 GC 操作，进入到 registry 容器中，使用 registry garbage-collect 这个子命令进行操作。</p>
<h4 id="marking-1"><a href="#marking-1" class="headerlink" title="marking"></a>marking</h4><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">╭─root@sg-<span class="number">02</span> /<span class="keyword">var</span>/lib/registry/docker/registry/v2</span><br><span class="line">╰─# docker exec -it registry sh</span><br><span class="line">/ # registry garbage-collect -m --delete-untagged=true /etc/docker/registry/<span class="keyword">config</span><span class="variable">.yml</span></span><br><span class="line"><span class="keyword">library</span>/alpine</span><br><span class="line"><span class="keyword">library</span>/debian</span><br><span class="line"><span class="keyword">library</span>/debian: marking manifest sha256:<span class="number">7</span>c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line"><span class="keyword">library</span>/debian: marking blob sha256:<span class="number">43</span>e3995ee54ac008271bfcf2d8ac7278c33f4c5e83d2f02bfcddd350034e3357</span><br><span class="line"><span class="keyword">library</span>/debian: marking blob sha256:<span class="number">8559</span>a31e96f442f2c7b6da49d6c84705f98a39d8be10b3f5f14821d0ee8417df</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> blobs marked, <span class="number">3</span> blobs <span class="keyword">and</span> <span class="number">0</span> manifests eligible <span class="keyword">for</span> deletion</span><br></pre></td></tr></table></figure>
<h4 id="sweep-1"><a href="#sweep-1" class="headerlink" title="sweep"></a>sweep</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">blob eligible for deletion: sha256:a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">INFO[0000] Deleting blob: &#x2F;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&#x2F;a1&#x2F;a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590  go.version&#x3D;go1.11.2 instance.id&#x3D;3ad15352-7cb7-46ca-a5ae-e5e16c6485a5 service&#x3D;registry</span><br><span class="line">blob eligible for deletion: sha256:be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">INFO[0000] Deleting blob: &#x2F;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&#x2F;be&#x2F;be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c  go.version&#x3D;go1.11.2 instance.id&#x3D;3ad15352-7cb7-46ca-a5ae-e5e16c6485a5 service&#x3D;registry</span><br><span class="line">blob eligible for deletion: sha256:21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">INFO[0000] Deleting blob: &#x2F;docker&#x2F;registry&#x2F;v2&#x2F;blobs&#x2F;sha256&#x2F;21&#x2F;21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d  go.version&#x3D;go1.11.2 instance.id&#x3D;3ad15352-7cb7-46ca-a5ae-e5e16c6485a5 service&#x3D;registry</span><br></pre></td></tr></table></figure>
<h4 id="GC-之后的-registry-存储目录长什么样？"><a href="#GC-之后的-registry-存储目录长什么样？" class="headerlink" title="GC 之后的 registry 存储目录长什么样？"></a>GC 之后的 registry 存储目录长什么样？</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">╭─root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">╰─# tree                                                                                     </span><br><span class="line">.</span><br><span class="line">├── blobs</span><br><span class="line">│   └── sha256</span><br><span class="line">│       ├── 21</span><br><span class="line">│       ├── 43</span><br><span class="line">│       │   └── 43e3995ee54ac008271bfcf2d8ac7278c33f4c5e83d2f02bfcddd350034e3357</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── 7c</span><br><span class="line">│       │   └── 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── 85</span><br><span class="line">│       │   └── 8559a31e96f442f2c7b6da49d6c84705f98a39d8be10b3f5f14821d0ee8417df</span><br><span class="line">│       │       └── data</span><br><span class="line">│       ├── a1</span><br><span class="line">│       └── be</span><br><span class="line">└── repositories</span><br><span class="line">    └── library</span><br><span class="line">        ├── alpine</span><br><span class="line">        │   ├── _layers</span><br><span class="line">        │   │   └── sha256</span><br><span class="line">        │   │       ├── 21c83c5242199776c232920ddb58cfa2a46b17e42ed831ca9001c8dbc532d22d</span><br><span class="line">        │   │       │   └── link</span><br><span class="line">        │   │       └── be4e4bea2c2e15b403bb321562e78ea84b501fb41497472e91ecb41504e8a27c</span><br><span class="line">        │   │           └── link</span><br><span class="line">        │   ├── _manifests</span><br><span class="line">        │   │   ├── revisions</span><br><span class="line">        │   │   │   └── sha256</span><br><span class="line">        │   │   │       └── a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">        │   │   └── tags</span><br><span class="line">        │   └── _uploads</span><br><span class="line">        └── debian</span><br><span class="line">            ├── _layers</span><br><span class="line">            │   └── sha256</span><br><span class="line">            │       ├── 43e3995ee54ac008271bfcf2d8ac7278c33f4c5e83d2f02bfcddd350034e3357</span><br><span class="line">            │       │   └── link</span><br><span class="line">            │       └── 8559a31e96f442f2c7b6da49d6c84705f98a39d8be10b3f5f14821d0ee8417df</span><br><span class="line">            │           └── link</span><br><span class="line">            ├── _manifests</span><br><span class="line">            │   ├── revisions</span><br><span class="line">            │   │   └── sha256</span><br><span class="line">            │   │       └── 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">            │   │           └── link</span><br><span class="line">            │   └── tags</span><br><span class="line">            │       └── buster-slim</span><br><span class="line">            │           ├── current</span><br><span class="line">            │           │   └── link</span><br><span class="line">            │           └── index</span><br><span class="line">            │               └── sha256</span><br><span class="line">            │                   └── 7c459309b9a5ec1683ef3b137f39ce5888f5ad0384e488ad73c94e0243bc77d4</span><br><span class="line">            │                       └── link</span><br><span class="line">            └── _uploads</span><br><span class="line"></span><br><span class="line">40 directories, 10 files</span><br></pre></td></tr></table></figure>
<p>根据 GC 后的 registry 存储目录我们可以看到，原本 blobs 目录下有 6 个 data 文件，现在已经变成了 3 个，alpine:3.10 这个镜像相关的 layer、config、manifest 这三个文件都已经被 GC 掉了。但是在 repositories 目录下，该镜像的 _layers 下的 link 文件依旧存在🤔。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>总结以上，用下面这三张图片就能直观地理解这些过程啦。</p>
<h4 id="delete-镜像之前的-registry-存储目录结构"><a href="#delete-镜像之前的-registry-存储目录结构" class="headerlink" title="delete 镜像之前的 registry 存储目录结构"></a>delete 镜像之前的 registry 存储目录结构</h4><p><img src="https://p.k8s.li/registry-gc-1.jpeg" alt=""></p>
<h4 id="delete-镜像之后的-registry-存储目录结构"><a href="#delete-镜像之后的-registry-存储目录结构" class="headerlink" title="delete 镜像之后的 registry 存储目录结构"></a>delete 镜像之后的 registry 存储目录结构</h4><p><img src="https://p.k8s.li/registry-gc-2.jpeg" alt=""></p>
<h4 id="GC-之后的-registry-存储目录结构"><a href="#GC-之后的-registry-存储目录结构" class="headerlink" title="GC 之后的 registry 存储目录结构"></a>GC 之后的 registry 存储目录结构</h4><p><img src="https://p.k8s.li/registry-gc-3.jpeg" alt=""></p>
<h3 id="shell-大法好！"><a href="#shell-大法好！" class="headerlink" title="shell 大法好！"></a>shell 大法好！</h3><p>根据上面的 GC 原理和过程，实际上我们可以使用不到 25 行的 shell 脚本来实现一个粗暴的  GC 😂</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">set -x</span><br><span class="line">v2=$1</span><br><span class="line">v2=$&#123;v2:="/var/lib/registry/docker/registry/v2"&#125;</span><br><span class="line">cd $&#123;v2&#125;</span><br><span class="line">all_blobs=/tmp/all_blobs.list</span><br><span class="line">: &gt; $&#123;all_blobs&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"> marking all the blob by all images manifest</span></span><br><span class="line">for tag in $(find repositories -name "link" | grep current)</span><br><span class="line">do</span><br><span class="line">    link=$(cat $&#123;tag&#125; | cut -c8-71)</span><br><span class="line">    mfs=blobs/sha256/$&#123;link:0:2&#125;/$&#123;link&#125;/data</span><br><span class="line">    echo $&#123;link&#125; &gt;&gt; $&#123;all_blobs&#125;</span><br><span class="line">    grep sha256 $&#123;mfs&#125; |cut -d "\"" -f4 | cut -c8-71 &gt;&gt; $&#123;all_blobs&#125;</span><br><span class="line">done</span><br><span class="line"><span class="meta">#</span><span class="bash"> delete blob <span class="keyword">if</span> the blob doesn<span class="string">'t exist in all_blobs.list</span></span></span><br><span class="line">for blob in $(find blobs -name "data" | cut -d "/" -f4)</span><br><span class="line">do</span><br><span class="line">    grep $&#123;blob&#125; $&#123;all_blobs&#125;</span><br><span class="line">    if [[ $? != 0 ]]; then</span><br><span class="line">    rm -rf blobs/sha256/$&#123;blob:0:2&#125;/$&#123;blob&#125;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<ol>
<li><p>遍历所有镜像的 tag 下最新的 link 文件指向的 manifest</p>
</li>
<li><p>根据 manifest 文件 grep 出 sha256 值的 image config 和 layer 文件，保存到 <code>all_blobs.list</code> 文件中。</p>
</li>
<li><p>使用 <code>find</code> 和 <code>for</code> 循环遍历所有 blobs 下的的 data 文件，判断它是否在 <code>all_blobs.list</code> 中，不再的话直接 <code>rm -rf</code> 干掉它！</p>
</li>
<li><p>最后重启一下 registry 容器。</p>
</li>
</ol>
<p>就是这么简单粗暴！哈哈，<code>rm -rf</code> 用起来真爽（手动滑稽 。如果还想把这个脚本再优化一下的话，可以将 所有的 blob 的 sha256 值截取前 12 位保存在一个变量中。通过 <code>=~</code> 来判断包含关系来替代 grep。</p>
<h2 id="踩坑！"><a href="#踩坑！" class="headerlink" title="踩坑！"></a>踩坑！</h2><h3 id="The-operation-is-unsupported-405-Method-Not-Allowed"><a href="#The-operation-is-unsupported-405-Method-Not-Allowed" class="headerlink" title="The operation is unsupported.(405 Method Not Allowed)"></a>The operation is unsupported.(405 Method Not Allowed)</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">╭─root@sg-02 ~/registry</span><br><span class="line">╰─# skopeo delete docker://localhost/library/alpine:3.10 --debug</span><br><span class="line">DEBU[0000] Returning credentials from /run/containers/0/auth.json</span><br><span class="line">DEBU[0000] Using registries.d directory /etc/containers/registries.d for sigstore configuration</span><br><span class="line">DEBU[0000]  No signature storage configuration found for localhost/library/alpine:3.10</span><br><span class="line">DEBU[0000] Looking for TLS certificates and private keys in /etc/docker/certs.d/localhost</span><br><span class="line">DEBU[0000] Loading registries configuration "/etc/containers/registries.conf"</span><br><span class="line">DEBU[0000] GET https://localhost/v2/</span><br><span class="line">DEBU[0000] Ping https://localhost/v2/ status 401</span><br><span class="line">DEBU[0000] GET https://localhost/v2/library/alpine/manifests/3.10</span><br><span class="line">DEBU[0000] DELETE https://localhost/v2/library/alpine/manifests/sha256:a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590</span><br><span class="line">FATA[0000] Failed to delete /v2/library/alpine/manifests/sha256:a143f3ba578f79e2c7b3022c488e6e12a35836cd4a6eb9e363d7f3a07d848590: &#123;"errors":[&#123;"code":"UNSUPPORTED","message":"The operation is unsupported."&#125;]&#125;</span><br><span class="line"> (405 Method Not Allowed)</span><br></pre></td></tr></table></figure>
<p>在 registry 容器启动的时候添加变量开启 <code>REGISTRY_STORAGE_DELETE_ENABLED=true</code> 即可，或者修改容器内的配置文件 <code>/etc/docker/registry/config.yml</code>，在 <code>storage:</code> 下添加上 下面的参数。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">delete:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="GC-不彻底，残留-link-文件"><a href="#GC-不彻底，残留-link-文件" class="headerlink" title="GC 不彻底，残留 link 文件"></a>GC 不彻底，残留 link 文件</h3><p>从上面我们可以得知，registry 无论是删除一个镜像还是进行 GC 操作，都不会删除 repositories 目录下的 <code>_layers/sha256/digest/link</code> 文件，在进行 GC 之后，一些镜像 layer 和 config 文件已经在 blobs 存储目录下删除了，但指向它的 layers/link 文件依旧保存在 repositories 目录下🙄。GitHub 上有个 PR <a href="https://github.com/docker/distribution/issues/2288" target="_blank" rel="noopener">Remove the layer’s link by garbage-collect #2288</a> 就是专门来清理这些无用的 layer link 文件的，最早的一个是三年前的，但是还没有合并😂。</p>
<p>留着已经被 GC 掉 blob 的 layer link 也没啥用，使用下面这个脚本就能删掉无用的 layer link 文件。根据 layer link 的值去 blobs 目录下看看该文件是否存在，不存在的话就 rm -rf 掉，存在的话就留着。这样就能清理干净啦😁。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">cd /var/lib/registry/docker/registry/v2</span><br><span class="line">for link in $(find repositories -name "link" | grep -E "_layers")</span><br><span class="line">do</span><br><span class="line">    link_sha256=$(echo $&#123;link&#125; | awk -F "/" '&#123;print $6&#125;')</span><br><span class="line">    link_short=$(echo $&#123;link&#125; | awk -F "/" '&#123;print $6&#125;' | cut -c1-2)</span><br><span class="line">    data_file=blobs/sha256/$&#123;link_short&#125;/$&#123;link_sha256&#125;</span><br><span class="line">    dir_link=$(echo $&#123;link&#125; | sed s'/link//g')</span><br><span class="line">    if [[ ! -d "$&#123;data_file&#125;" ]]; then</span><br><span class="line">    rm -rf $&#123;dir_link&#125;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<h3 id="GC-后要重启！"><a href="#GC-后要重启！" class="headerlink" title="GC 后要重启！"></a>GC 后要重启！</h3><p>GC 之后一定要重启，因为 registry 容器缓存了镜像 layer 的信息，当删除掉一个镜像 A ，后边 GC 掉该镜像的 layer 之后，如果不重启 registry 容器，当重新 PUSH 镜像 A 的时候就会提示镜像 layer 已经存在，不会重新上传 layer ，但实际上已经被 GC 掉了，最终会导致镜像 A 不完整，无法 pull 到该镜像。</p>
<h3 id="GC-不是事务性操作"><a href="#GC-不是事务性操作" class="headerlink" title="GC 不是事务性操作"></a>GC 不是事务性操作</h3><p>GC 的时候最好暂停 PUSH 镜像，以免把正在上传的镜像 layer 给 GC 掉。</p>
    </div>
      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/docker/" rel="tag"><i class="fa fa-tag"></i> docker</a>
              <a href="/tags/registry/" rel="tag"><i class="fa fa-tag"></i> registry</a>
              <a href="/tags/%E9%95%9C%E5%83%8F/" rel="tag"><i class="fa fa-tag"></i> 镜像</a>
          </div>
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/Q2-reading.html" rel="prev" title="2020 阅读记录（二）">
      <i class="fa fa-chevron-left"></i> 2020 阅读记录（二）
    </a></div>
      <div class="post-nav-item">
    <a href="/homelab.html" rel="next" title="垃圾佬的 Homelab 折腾记录">
      垃圾佬的 Homelab 折腾记录 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
  </article>
  </div>
          </div>
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
        </div>
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>
  <aside class="sidebar">
    <div class="sidebar-inner">
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>
      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#registry-GC-原理🤔"><span class="nav-number">1.</span> <span class="nav-text">registry GC 原理🤔</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#部署-registry-容器"><span class="nav-number">1.1.</span> <span class="nav-text">部署 registry 容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#COPY-镜像到-registry"><span class="nav-number">1.2.</span> <span class="nav-text">COPY 镜像到 registry</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#registry-存储目录长什么样🤔"><span class="nav-number">1.3.</span> <span class="nav-text">registry 存储目录长什么样🤔</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DELETE-镜像"><span class="nav-number">1.4.</span> <span class="nav-text">DELETE 镜像</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#registry-GC-原理"><span class="nav-number">2.</span> <span class="nav-text">registry GC 原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-是弄啥咧？🤔"><span class="nav-number">2.1.</span> <span class="nav-text">GC 是弄啥咧？🤔</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-的过程"><span class="nav-number">2.2.</span> <span class="nav-text">GC 的过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-都干了啥？"><span class="nav-number">2.3.</span> <span class="nav-text">GC 都干了啥？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">2.4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#shell-大法好！"><span class="nav-number">2.5.</span> <span class="nav-text">shell 大法好！</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#踩坑！"><span class="nav-number">3.</span> <span class="nav-text">踩坑！</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#The-operation-is-unsupported-405-Method-Not-Allowed"><span class="nav-number">3.1.</span> <span class="nav-text">The operation is unsupported.(405 Method Not Allowed)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-不彻底，残留-link-文件"><span class="nav-number">3.2.</span> <span class="nav-text">GC 不彻底，残留 link 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-后要重启！"><span class="nav-number">3.3.</span> <span class="nav-text">GC 后要重启！</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC-不是事务性操作"><span class="nav-number">3.4.</span> <span class="nav-text">GC 不是事务性操作</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->
      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="木子"
      src="https://blog.k8s.li/avatar.png">
  <p class="site-author-name" itemprop="name">木子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">98</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:blog@502.li" title="E-Mail → mailto:blog@502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://kindle.502.li/" title="Kindle → https:&#x2F;&#x2F;kindle.502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tg.k8s.li/" title="Channel → https:&#x2F;&#x2F;tg.k8s.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Channel</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>
      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>
      </div>
    </main>
    <footer class="footer">
      <div class="footer-inner">
<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">木子</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">1.4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">39:50</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>
      </div>
    </footer>
  </div>
  <script src="/lib/anime.min.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>
<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://muzi.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://blog.k8s.li/registry-gc.html",
            identifier: "registry-gc.html",
            title: "docker registry GC 原理分析"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://muzi.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>
</body>
</html>
