<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.3.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="ä¹‹å‰æ¥è§¦çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·å¤§å¤šæ•°éƒ½æ˜¯ä¾èµ–äº ssh è¿æ¥åˆ°å¾…éƒ¨ç½²çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œéƒ¨ç½²æ“ä½œï¼Œè¿™æ ·å°±è¦æ±‚éƒ¨ç½²å‰éœ€è¦æå‰å‡†å¤‡å¥½é›†ç¾¤èŠ‚ç‚¹ï¼Œä¸”è¦ä¿è¯è¿™äº›èŠ‚ç‚¹çš„ç½‘ç»œäº’é€šä»¥åŠæ—¶é’ŸåŒæ­¥ç­‰é—®é¢˜ã€‚ç±»ä¼¼äº kubespray æˆ–è€… kubekey è¿™äº›éƒ¨ç½²å·¥å…·æ˜¯ä¸ä¼šå»ç®¡è¿™äº›åº•å±‚çš„ IaaS èµ„æºçš„åˆ›å»ºï¼Œæ˜¯è¦è‡ªå·±æå‰å‡†å¤‡å¥½ã€‚ä½†æ˜¯åœ¨ä¸€äº›ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒä¸­ï¼Œä½¿ç”¨äº†å¦‚ VMware vShpere æˆ– OpenS">
<meta property="og:type" content="blog">
<meta property="og:title" content="VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ">
<meta property="og:url" content="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="ä¹‹å‰æ¥è§¦çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·å¤§å¤šæ•°éƒ½æ˜¯ä¾èµ–äº ssh è¿æ¥åˆ°å¾…éƒ¨ç½²çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œéƒ¨ç½²æ“ä½œï¼Œè¿™æ ·å°±è¦æ±‚éƒ¨ç½²å‰éœ€è¦æå‰å‡†å¤‡å¥½é›†ç¾¤èŠ‚ç‚¹ï¼Œä¸”è¦ä¿è¯è¿™äº›èŠ‚ç‚¹çš„ç½‘ç»œäº’é€šä»¥åŠæ—¶é’ŸåŒæ­¥ç­‰é—®é¢˜ã€‚ç±»ä¼¼äº kubespray æˆ–è€… kubekey è¿™äº›éƒ¨ç½²å·¥å…·æ˜¯ä¸ä¼šå»ç®¡è¿™äº›åº•å±‚çš„ IaaS èµ„æºçš„åˆ›å»ºï¼Œæ˜¯è¦è‡ªå·±æå‰å‡†å¤‡å¥½ã€‚ä½†æ˜¯åœ¨ä¸€äº›ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒä¸­ï¼Œä½¿ç”¨äº†å¦‚ VMware vShpere æˆ– OpenS">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/2022-01-22-deploy-tanzu-k8s-cluster-01.jpg">
<meta property="article:published_time" content="2022-02-05T16:00:00.000Z">
<meta property="article:modified_time" content="2022-02-05T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="ESXi">
<meta property="article:tag" content="Tanzu">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Cluster-api">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/2022-01-22-deploy-tanzu-k8s-cluster-01.jpg">


<link rel="canonical" href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/deploy-tanzu-k8s-cluster.html","path":"deploy-tanzu-k8s-cluster.html","title":"VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B"><span class="nav-number">1.</span> <span class="nav-text">éƒ¨ç½²æµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%9D%E9%80%80%E4%B8%89%E8%BF%9E-%F0%9F%98%82"><span class="nav-number">1.1.</span> <span class="nav-text">åŠé€€ä¸‰è¿ ğŸ˜‚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E4%BE%9D%E8%B5%96%E6%96%87%E4%BB%B6"><span class="nav-number">1.2.</span> <span class="nav-text">ä¸‹è½½ä¾èµ–æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-govc-%E5%8F%8A%E4%BE%9D%E8%B5%96"><span class="nav-number">1.3.</span> <span class="nav-text">å®‰è£… govc åŠä¾èµ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-ESXi-OS"><span class="nav-number">1.4.</span> <span class="nav-text">å®‰è£… ESXi OS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E8%A3%85-vCenter"><span class="nav-number">1.5.</span> <span class="nav-text">å®‰è£… vCenter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE-vCenter"><span class="nav-number">1.6.</span> <span class="nav-text">é…ç½® vCenter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-bootstrap-%E8%8A%82%E7%82%B9"><span class="nav-number">1.7.</span> <span class="nav-text">åˆå§‹åŒ– bootstrap èŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E7%AE%A1%E7%90%86%E9%9B%86%E7%BE%A4"><span class="nav-number">1.8.</span> <span class="nav-text">éƒ¨ç½²ç®¡ç†é›†ç¾¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E6%97%A5%E5%BF%97"><span class="nav-number">1.9.</span> <span class="nav-text">éƒ¨ç½²æ—¥å¿—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2%E6%B5%81%E7%A8%8B-1"><span class="nav-number">1.10.</span> <span class="nav-text">éƒ¨ç½²æµç¨‹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2-workload-%E9%9B%86%E7%BE%A4"><span class="nav-number">2.</span> <span class="nav-text">éƒ¨ç½² workload é›†ç¾¤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%A9%E5%AE%B9%E9%9B%86%E7%BE%A4"><span class="nav-number">3.</span> <span class="nav-text">æ‰©å®¹é›†ç¾¤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%AE%B9-control-plan-%E8%8A%82%E7%82%B9"><span class="nav-number">3.1.</span> <span class="nav-text">æ‰©å®¹ control-plan èŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%AE%B9-work-%E8%8A%82%E7%82%B9"><span class="nav-number">3.2.</span> <span class="nav-text">æ‰©å®¹ work èŠ‚ç‚¹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8E%E7%BB%AD"><span class="nav-number">4.</span> <span class="nav-text">åç»­</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">5.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">118</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">153</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail â†’ mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-06 2022-02-06T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2022-02-06T00:00:00+08:00">2022-02-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/deploy-tanzu-k8s-cluster.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="deploy-tanzu-k8s-cluster.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>34k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>31 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>ä¹‹å‰æ¥è§¦çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·å¤§å¤šæ•°éƒ½æ˜¯ä¾èµ–äº ssh è¿æ¥åˆ°å¾…éƒ¨ç½²çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œéƒ¨ç½²æ“ä½œï¼Œè¿™æ ·å°±è¦æ±‚éƒ¨ç½²å‰éœ€è¦æå‰å‡†å¤‡å¥½é›†ç¾¤èŠ‚ç‚¹ï¼Œä¸”è¦ä¿è¯è¿™äº›èŠ‚ç‚¹çš„ç½‘ç»œäº’é€šä»¥åŠæ—¶é’ŸåŒæ­¥ç­‰é—®é¢˜ã€‚ç±»ä¼¼äº kubespray æˆ–è€… kubekey è¿™äº›éƒ¨ç½²å·¥å…·æ˜¯ä¸ä¼šå»ç®¡è¿™äº›åº•å±‚çš„ IaaS èµ„æºçš„åˆ›å»ºï¼Œæ˜¯è¦è‡ªå·±æå‰å‡†å¤‡å¥½ã€‚ä½†æ˜¯åœ¨ä¸€äº›ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒä¸­ï¼Œä½¿ç”¨äº†å¦‚ <a target="_blank" rel="noopener" href="https://docs.vmware.com/cn/VMware-vSphere/index.html">VMware vShpere</a> æˆ– <a target="_blank" rel="noopener" href="https://www.openstack.org/">OpenStack</a> è¿™äº›è™šæ‹ŸåŒ–å¹³å°ï¼Œæ˜¯å¯ä»¥å°† K8s é›†ç¾¤éƒ¨ç½²ä¸ IaaS èµ„æºåˆ›å»ºè¿™ä¸¤æ­¥ç»Ÿä¸€èµ·æ¥çš„ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æ‰‹åŠ¨åˆ›å»ºå’Œé…ç½®è™šæ‹Ÿæœºè¿™äº›ç¹ççš„æ­¥éª¤ã€‚</p>
<p>ç›®å‰å°† IaaS èµ„æºåˆ›å»ºä¸ K8s é›†ç¾¤éƒ¨ç½²ç»“åˆèµ·æ¥ä¹Ÿæœ‰æ¯”è¾ƒæˆç†Ÿçš„æ–¹æ¡ˆï¼Œæ¯”å¦‚åŸºäº <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cluster-api">cluster-api</a> é¡¹ç›®çš„ <a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu">tanzu</a> ã€‚æœ¬æ–‡å°±ä»¥ <a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/community-edition">VMware Tanzu ç¤¾åŒºç‰ˆ</a> ä¸ºä¾‹åœ¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šï¼Œä»å®‰è£… ESXi OS åˆ°éƒ¨ç½²å®Œæˆ Tanzu Workload é›†ç¾¤ï¼Œæ¥ä½“éªŒä¸€ä¸‹è¿™ç§éƒ¨ç½²æ–¹æ¡ˆçš„ä¸ä¼—ä¸åŒä¹‹å¤„ã€‚</p>
<h2 id="éƒ¨ç½²æµç¨‹"><a href="#éƒ¨ç½²æµç¨‹" class="headerlink" title="éƒ¨ç½²æµç¨‹"></a>éƒ¨ç½²æµç¨‹</h2><ul>
<li>ä¸‹è½½ä¾èµ–æ–‡ä»¶</li>
<li>å®‰è£… govc ä¾èµ–</li>
<li>å®‰è£… ESXi OS</li>
<li>å®‰è£… vCenter</li>
<li>é…ç½® vCenter</li>
<li>åˆ›å»º bootstrap è™šæ‹Ÿæœº</li>
<li>åˆå§‹åŒ– bootstrap èŠ‚ç‚¹</li>
<li>éƒ¨ç½² Tanzu Manager é›†ç¾¤</li>
<li>éƒ¨ç½² Tanzu Workload é›†ç¾¤</li>
</ul>
<h3 id="åŠé€€ä¸‰è¿-ğŸ˜‚"><a href="#åŠé€€ä¸‰è¿-ğŸ˜‚" class="headerlink" title="åŠé€€ä¸‰è¿ ğŸ˜‚"></a>åŠé€€ä¸‰è¿ ğŸ˜‚</h3><ul>
<li>éœ€è¦æœ‰ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://customerconnect.vmware.com/login">VMware çš„è´¦æˆ·</a> ç”¨äºä¸‹è½½ä¸€äº› ISO é•œåƒå’Œè™šæ‹Ÿæœºæ¨¡ç‰ˆ;</li>
<li>éœ€è¦æœ‰ä¸€å°ç‰©ç†æœåŠ¡å™¨ï¼Œæ¨èæœ€ä½é…ç½® 8C 32Gï¼Œè‡³å°‘ 256GB å­˜å‚¨ï¼›</li>
<li>éœ€è¦ä¸€å° DHCP æœåŠ¡å™¨ï¼Œç”±äºé»˜è®¤æ˜¯ä½¿ç”¨ DHCP è·å– IP æ¥åˆ†é…ç»™è™šæ‹Ÿæœºçš„ï¼Œå› æ­¤ ESXi æ‰€åœ¨çš„ VM Network  ç½‘ç»œä¸­å¿…é¡»æœ‰ä¸€å° DHCP æœåŠ¡å™¨ç”¨äºç»™è™šæ‹Ÿæœºåˆ†é… IPï¼›</li>
</ul>
<h3 id="ä¸‹è½½ä¾èµ–æ–‡ä»¶"><a href="#ä¸‹è½½ä¾èµ–æ–‡ä»¶" class="headerlink" title="ä¸‹è½½ä¾èµ–æ–‡ä»¶"></a>ä¸‹è½½ä¾èµ–æ–‡ä»¶</h3><p>æ•´ä¸ªéƒ¨ç½²æµç¨‹æ‰€éœ€è¦çš„ä¾æ–‡ä»¶èµ–å¦‚ä¸‹ï¼Œå¯ä»¥å…ˆå°†è¿™äº›ä¾èµ–ä¸‹è½½åˆ°æœ¬åœ°çš„æœºå™¨ä¸Šï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@devbox:/root/tanzu <span class="token comment"># tree -sh</span>
<span class="token builtin class-name">.</span>
â”œâ”€â”€ <span class="token punctuation">[</span>  12M<span class="token punctuation">]</span>  govc_Linux_x86_64.tar.gz
â”œâ”€â”€ <span class="token punctuation">[</span> 895M<span class="token punctuation">]</span>  photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova
â”œâ”€â”€ <span class="token punctuation">[</span> 225M<span class="token punctuation">]</span>  photon-ova-4.0-c001795b80.ova
â”œâ”€â”€ <span class="token punctuation">[</span> 170M<span class="token punctuation">]</span>  tce-linux-amd64-v0.9.1.tar.gz
â”œâ”€â”€ <span class="token punctuation">[</span> <span class="token number">9</span>.0G<span class="token punctuation">]</span>  VMware-VCSA-all-7.0.3-18778458.iso
â””â”€â”€ <span class="token punctuation">[</span> 390M<span class="token punctuation">]</span>  VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>ç”¨é€”</th>
<th>ä¸‹è½½æ–¹å¼</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://customerconnect.vmware.com/downloads/details?downloadGroup=ESXI70U2A&productId=974&rPId=46384">VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso</a></td>
<td>å®‰è£… ESXi OS</td>
<td>VMware éœ€è´¦æˆ·</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://customerconnect.vmware.com/downloads/details?downloadGroup=VC70U3C&productId=974&rPId=83853">VMware-VCSA-all-7.0.3-19234570.iso</a></td>
<td>å®‰è£… vCenter</td>
<td>VMware éœ€è´¦æˆ·</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova">photon-ova-4.0-c001795b80.ova</a></td>
<td>bootstrap èŠ‚ç‚¹</td>
<td>VMware</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://customerconnect.vmware.com/downloads/get-download?downloadGroup=TCE-090">photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</a></td>
<td>tanzu é›†ç¾¤èŠ‚ç‚¹</td>
<td>VMware éœ€è´¦æˆ·</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz">tce-linux-amd64-v0.9.1.tar.gz</a></td>
<td>tanzu ç¤¾åŒºç‰ˆ</td>
<td>GitHub release</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://github.com/vmware/govmomi/releases/download/v0.27.3/govc_Linux_x86_64.tar.gz">govc_Linux_x86_64.tar.gz</a></td>
<td>å®‰è£…&#x2F;é…ç½® vCenter</td>
<td>GitHub release</td>
</tr>
</tbody></table>
<p>æ³¨æ„ ESXi å’Œ vCenter çš„ç‰ˆæœ¬æœ€å¥½æ˜¯ 7.0 åŠä»¥ä¸Šï¼Œæˆ‘åªåœ¨ ESXi 7.0.2 å’Œ vCenter 7.0.3 ä¸Šæµ‹è¯•è¿‡ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰äº›å·®å¼‚ï¼›å¦å¤– ESXi çš„ç‰ˆæœ¬ä¸å»ºè®®ä½¿ç”¨æœ€æ–°çš„ 7.0.3ï¼Œå› ä¸ºæœ‰æ¯”è¾ƒä¸¥é‡çš„ bugï¼Œå®˜æ–¹ä¹Ÿå»ºè®®ç”¨æˆ·ç”Ÿäº§ç¯å¢ƒä¸è¦ä½¿ç”¨è¯¥ç‰ˆæœ¬äº† <a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/86287">vSphere 7.0 Update 3 Critical Known Issues - Workarounds &amp; Fix (86287)</a> ã€‚</p>
<h3 id="å®‰è£…-govc-åŠä¾èµ–"><a href="#å®‰è£…-govc-åŠä¾èµ–" class="headerlink" title="å®‰è£… govc åŠä¾èµ–"></a>å®‰è£… govc åŠä¾èµ–</h3><p>åœ¨æœ¬åœ°æœºå™¨ä¸Šå®‰è£…å¥½ govc å’Œ jqï¼Œè¿™ä¸¤ä¸ªå·¥å…·åé¢åœ¨é…ç½® vCenter çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</p>
<ul>
<li>macOS</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ brew <span class="token function">install</span> govc jq<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>Debian&#x2F;Ubuntu</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">tar</span> <span class="token parameter variable">-xf</span> govc_Linux_x86_64.tar.gz <span class="token parameter variable">-C</span> /usr/local/bin
$ <span class="token function">apt</span> <span class="token function">install</span> jq <span class="token parameter variable">-y</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>å…¶ä»– Linux å¯ä»¥åœ¨ govc å’Œ jq çš„ GitHub ä¸Šä¸‹è½½å¯¹åº”çš„å®‰è£…æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚</li>
</ul>
<h3 id="å®‰è£…-ESXi-OS"><a href="#å®‰è£…-ESXi-OS" class="headerlink" title="å®‰è£… ESXi OS"></a>å®‰è£… ESXi OS</h3><p>ESXi OS çš„å®‰è£…ç½‘ä¸Šæœ‰å¾ˆå¤šæ•™ç¨‹ï¼Œæ²¡æœ‰å¤ªå¤šå€¼å¾—è®²è§£çš„åœ°æ–¹ï¼Œå› æ­¤å°±å‚ç…§ä¸€ä¸‹å…¶ä»–å¤§ä½¬å†™çš„åšå®¢æˆ–è€…å®˜æ–¹çš„å®‰è£…æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://docs.vmware.com/cn/VMware-vSphere/7.0/vsphere-esxi-701-installation-setup-guide.pdf">VMware ESXi å®‰è£…å’Œè®¾ç½®</a> æ¥å°±è¡Œï¼›éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼ŒESXi OS å®‰è£…æ—¶ VMFSL åˆ†åŒºå°†ä¼šå ç”¨å¤§é‡çš„å­˜å‚¨ç©ºé—´ï¼Œè¿™å°†ä¼šä½¿å¾— ESXi OS å®‰è£…æ‰€åœ¨çš„ç£ç›˜æœ€ç»ˆåˆ›å»ºå‡ºæ¥çš„ datastore æ¯”é¢„æœŸå°å¾ˆå¤šï¼Œè€Œä¸”è¿™ä¸ª VMFSL åˆ†åŒºåœ¨å®‰è£…å¥½ä¹‹åå°±å¾ˆéš¾å†åšè°ƒæ•´äº†ã€‚å› æ­¤å¦‚æœç£ç›˜å­˜å‚¨ç©ºé—´æ¯”è¾ƒç´§å¼ ï¼Œåœ¨å®‰è£… ESXi OS ä¹‹å‰å¯ä»¥è€ƒè™‘ä¸‹å¦‚ä½•å»æ‰è¿™ä¸ªåˆ†åŒºï¼›æˆ–è€…å’Œæˆ‘ä¸€æ ·å°† ESXI OS å®‰è£…åœ¨äº†ä¸€ä¸ª 16G çš„ USB Dom ç›˜ä¸Šï¼Œä¸è¿‡ç”Ÿäº§ç¯å¢ƒä¸å»ºè®®é‡‡ç”¨è¿™ç§æ–¹æ¡ˆ ğŸ˜‚ï¼ˆå…¶å®ä¸ªäººè§‰ç€å®‰è£…åœ¨ U ç›˜ä¸Šé—®é¢˜ä¸å¤§ï¼ŒESXi OS å¯åŠ¨ä¹‹åæ˜¯åŠ è½½åˆ°å†…å­˜ä¸­è¿è¡Œçš„ï¼Œä¸ä¼šå¯¹ U ç›˜æœ‰å¤§é‡çš„è¯»å†™æ“ä½œï¼Œåªä¸è¿‡åœ¨æœºæˆ¿ä¸­ U ç›˜è¢«äººä¸å°å¿ƒæ‹”èµ°å°±å‡‰äº†ã€‚</p>
<ul>
<li>è®¾ç½® govc ç¯å¢ƒå˜é‡</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ESXi èŠ‚ç‚¹çš„ IP</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ESXI_IP</span><span class="token operator">=</span><span class="token string">"192.168.18.47"</span>
<span class="token comment"># ESXi ç™»å½•çš„ç”¨æˆ·åï¼Œåˆæ¬¡å®‰è£…åé»˜è®¤ä¸º root</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_USERNAME</span><span class="token operator">=</span><span class="token string">"root"</span>
<span class="token comment"># åœ¨ ESXi å®‰è£…æ—¶è®¾ç½®çš„ root å¯†ç </span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_PASSWORD</span><span class="token operator">=</span><span class="token string">"admin@2022"</span>
<span class="token comment"># å…è®¸ä¸å®‰å…¨çš„ SSL è¿æ¥</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_INSECURE</span><span class="token operator">=</span>true
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_URL</span><span class="token operator">=</span><span class="token string">"https://<span class="token variable">$&#123;ESXI_IP&#125;</span>"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_DATASTORE</span><span class="token operator">=</span>datastore1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>æµ‹è¯• govc æ˜¯å¦èƒ½æ­£å¸¸è¿æ¥ ESXi ä¸»æœº</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Name:              localhost.local
  Path:            /ha-datacenter/host/localhost/localhost
  Manufacturer:    Dell
  Logical CPUs:    <span class="token number">20</span> CPUs @ 2394MHz
  Processor type:  Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Xeon<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Silver 4210R CPU @ <span class="token number">2</span>.40GHz
  CPU usage:       <span class="token number">579</span> MHz <span class="token punctuation">(</span><span class="token number">1.2</span>%<span class="token punctuation">)</span>
  Memory:          261765MB
  Memory usage:    <span class="token number">16457</span> MB <span class="token punctuation">(</span><span class="token number">6.3</span>%<span class="token punctuation">)</span>
  Boot time:       <span class="token number">2022</span>-02-02 <span class="token number">11</span>:53:59.630124 +0000 UTC
  State:           connected<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="å®‰è£…-vCenter"><a href="#å®‰è£…-vCenter" class="headerlink" title="å®‰è£… vCenter"></a>å®‰è£… vCenter</h3><p>æŒ‰ç…§ VMware å®˜æ–¹çš„ vCenter å®‰è£…æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vcenter.install.doc/GUID-8DC3866D-5087-40A2-8067-1361A2AF95BD.html">å…³äº vCenter Server å®‰è£…å’Œè®¾ç½®</a> æ¥å®‰è£…å®åœ¨æ˜¯è¿‡äºç¹çï¼Œå…¶å®å®˜æ–¹çš„ ISO å®‰è£…æ–¹å¼æ— éæ˜¯è¿è¡Œä¸€ä¸ª installer web æœåŠ¡ï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸Šé…ç½®å¥½ vCenter è™šæ‹Ÿæœºçš„å‚æ•°ï¼Œå†å°†å¡«å†™çš„é…ç½®ä¿¡æ¯åœ¨éƒ¨ç½² vcsa è™šæ‹Ÿæœºçš„æ—¶å€™æ³¨å…¥åˆ° ova çš„é…ç½®å‚æ•°ä¸­ã€‚</p>
<p>çŸ¥é“è¿™ä¸ªå®‰è£…è¿‡ç¨‹çš„åŸç†ä¹‹åæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±é…ç½® vCenter çš„å‚æ•°ä¿¡æ¯ï¼Œç„¶åé€šè¿‡ govc æ¥éƒ¨ç½² ovaï¼›è¿™æ¯”ä½¿ç”¨ UI çš„æ–¹å¼ç®€å•æ–¹ä¾¿å¾ˆå¤šï¼Œæœ€ç»ˆåªéœ€è¦å¡«å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¸€æ¡å‘½ä»¤å°±å¯ä»¥éƒ¨ç½²å®Œæˆå•¦ã€‚</p>
<ul>
<li>é¦–å…ˆæ˜¯æŒ‚è½½ vCenter çš„ ISOï¼Œæ‰¾åˆ° vcsa ova æ–‡ä»¶ï¼Œå®ƒæ˜¯ vCenter è™šæ‹Ÿæœºçš„æ¨¡ç‰ˆ</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">mount</span> <span class="token parameter variable">-o</span> loop VMware-VCSA-all-7.0.3-18778458.iso /mnt
$ <span class="token function">ls</span> /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova
/mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>æ ¹æ®è‡ªå·±çš„ç¯å¢ƒä¿¡æ¯ä¿®æ”¹ä¸‹é¢å®‰è£…è„šæœ¬ä¸­çš„ç›¸å…³é…ç½®ï¼š</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/env bash</span>
<span class="token assign-left variable">VCSA_OVA_FILE</span><span class="token operator">=</span><span class="token variable">$1</span>

<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> errexit
<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> nounset
<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> pipefail

<span class="token comment"># ESXi çš„ IP åœ°å€</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ESXI_IP</span><span class="token operator">=</span><span class="token string">"192.168.18.47"</span>

<span class="token comment"># ESXi çš„ç”¨æˆ·å</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_USERNAME</span><span class="token operator">=</span><span class="token string">"root"</span>

<span class="token comment"># ESXI çš„å¯†ç </span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_PASSWORD</span><span class="token operator">=</span><span class="token string">"admin@2020"</span>

<span class="token comment"># å®‰è£… vCenter è™šæ‹Ÿæœºä½¿ç”¨çš„ datastore åç§°</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_DATASTORE</span><span class="token operator">=</span>datastore1
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_INSECURE</span><span class="token operator">=</span>true
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_URL</span><span class="token operator">=</span><span class="token string">"https://<span class="token variable">$&#123;ESXI_IP&#125;</span>"</span>

<span class="token comment"># vCenter çš„ç™»å½•å¯†ç </span>
<span class="token assign-left variable">VM_PASSWORD</span><span class="token operator">=</span><span class="token string">"admin@2020"</span>
<span class="token comment"># vCenter çš„ IP åœ°å€</span>
<span class="token assign-left variable">VM_IP</span><span class="token operator">=</span><span class="token number">192.168</span>.20.92
<span class="token comment"># vCenter è™šæ‹Ÿæœºçš„åç§°</span>
<span class="token assign-left variable">VM_NAME</span><span class="token operator">=</span>vCenter-Server-Appliance
<span class="token comment"># vCenter è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œ</span>
<span class="token assign-left variable">VM_NETWORK</span><span class="token operator">=</span><span class="token string">"VM Network"</span>
<span class="token comment"># DNS æœåŠ¡å™¨</span>
<span class="token assign-left variable">VM_DNS</span><span class="token operator">=</span><span class="token string">"223.6.6.6"</span>
<span class="token comment"># NTP æœåŠ¡å™¨</span>
<span class="token assign-left variable">VM_NTP</span><span class="token operator">=</span><span class="token string">"0.pool.ntp.org"</span>

<span class="token function-name function">deploy_vcsa_vm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token assign-left variable">config</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>govc host.info <span class="token parameter variable">-k</span> <span class="token parameter variable">-json</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">'.HostSystems[].Config'</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">gateway</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>jq <span class="token parameter variable">-r</span> <span class="token string">'.Network.IpRouteConfig.DefaultGateway'</span> <span class="token operator">&lt;&lt;&lt;</span><span class="token string">"<span class="token variable">$config</span>"</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">route</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>jq <span class="token parameter variable">-r</span> <span class="token string">'.Network.RouteTableInfo.IpRoute[] | select(.DeviceName == "vmk0") | select(.Gateway == "0.0.0.0")'</span> <span class="token operator">&lt;&lt;&lt;</span><span class="token string">"<span class="token variable">$config</span>"</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">prefix</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>jq <span class="token parameter variable">-r</span> <span class="token string">'.PrefixLength'</span> <span class="token operator">&lt;&lt;&lt;</span><span class="token string">"<span class="token variable">$route</span>"</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">opts</span><span class="token operator">=</span><span class="token punctuation">(</span>
        <span class="token assign-left variable">cis.vmdir.password</span><span class="token operator">=</span><span class="token variable">$&#123;VM_PASSWORD&#125;</span>
        <span class="token assign-left variable">cis.appliance.root.passwd</span><span class="token operator">=</span><span class="token variable">$&#123;VM_PASSWORD&#125;</span>
        <span class="token assign-left variable">cis.appliance.root.shell</span><span class="token operator">=</span>/bin/bash
        <span class="token assign-left variable">cis.deployment.node.type</span><span class="token operator">=</span>embedded
        cis.vmdir.domain-name<span class="token operator">=</span>vsphere.local
        cis.vmdir.site-name<span class="token operator">=</span>VCSA
        <span class="token assign-left variable">cis.appliance.net.addr.family</span><span class="token operator">=</span>ipv4
        <span class="token assign-left variable">cis.appliance.ssh.enabled</span><span class="token operator">=</span>True
        <span class="token assign-left variable">cis.ceip_enabled</span><span class="token operator">=</span>False
        <span class="token assign-left variable">cis.deployment.autoconfig</span><span class="token operator">=</span>True
        <span class="token assign-left variable">cis.appliance.net.addr</span><span class="token operator">=</span><span class="token variable">$&#123;VM_IP&#125;</span>
        <span class="token assign-left variable">cis.appliance.net.prefix</span><span class="token operator">=</span><span class="token variable">$&#123;prefix&#125;</span>
        <span class="token assign-left variable">cis.appliance.net.dns.servers</span><span class="token operator">=</span><span class="token variable">$&#123;VM_DNS&#125;</span>
        <span class="token assign-left variable">cis.appliance.net.gateway</span><span class="token operator">=</span><span class="token variable">$gateway</span>
        <span class="token assign-left variable">cis.appliance.ntp.servers</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;VM_NTP&#125;</span>"</span>
        <span class="token assign-left variable">cis.appliance.net.mode</span><span class="token operator">=</span>static
    <span class="token punctuation">)</span>

    <span class="token assign-left variable">props</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">printf</span> -- <span class="token string">"guestinfo.%s<span class="token entity" title="\n">\n</span>"</span> <span class="token string">"<span class="token variable">$&#123;opts<span class="token punctuation">[</span>@<span class="token punctuation">]</span>&#125;</span>"</span> <span class="token operator">|</span> jq <span class="token parameter variable">--slurp</span> <span class="token parameter variable">-R</span> 'split<span class="token punctuation">(</span><span class="token string">"<span class="token entity" title="\n">\n</span>"</span><span class="token punctuation">)</span> <span class="token operator">|</span> map<span class="token punctuation">(</span>select<span class="token punctuation">(</span>. <span class="token operator">!=</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token variable">)</span></span> <span class="token operator">|</span> map<span class="token punctuation">(</span>split<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">))</span> <span class="token operator">|</span> map<span class="token punctuation">(</span><span class="token punctuation">&#123;</span><span class="token string">"Key"</span><span class="token builtin class-name">:</span> .<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>, <span class="token string">"Value"</span><span class="token builtin class-name">:</span> .<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>'<span class="token punctuation">)</span>

    <span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">|</span> govc import.<span class="token variable">$&#123;VCSA_OVA_FILE<span class="token operator">##</span>*.&#125;</span> <span class="token parameter variable">-options</span> - <span class="token string">"<span class="token variable">$&#123;VCSA_OVA_FILE&#125;</span>"</span></span>
    &#123;
    "Name": "<span class="token variable">$&#123;VM_NAME&#125;</span>",
    "Deployment": "tiny",
    "DiskProvisioning": "thin",
    "IPProtocol": "IPv4",
    "Annotation": "VMware vCenter Server Appliance",
    "PowerOn": false,
    "WaitForIP": false,
    "InjectOvfEnv": true,
    "NetworkMapping": [
        &#123;
        "Name": "Network 1",
        "Network": "<span class="token variable">$&#123;VM_NETWORK&#125;</span>"
        &#125;
    ],
    "PropertyMapping": <span class="token variable">$&#123;props&#125;</span>
    &#125;
EOF</span>

<span class="token punctuation">&#125;</span>

deploy_vcsa_vm
govc vm.change <span class="token parameter variable">-vm</span> <span class="token string">"<span class="token variable">$&#123;VM_NAME&#125;</span>"</span> <span class="token parameter variable">-g</span> vmwarePhoton64Guest
govc vm.power <span class="token parameter variable">-on</span> <span class="token string">"<span class="token variable">$&#123;VM_NAME&#125;</span>"</span>
govc vm.ip <span class="token parameter variable">-a</span> <span class="token string">"<span class="token variable">$&#123;VM_NAME&#125;</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>é€šè¿‡è„šæœ¬å®‰è£… vCenterï¼ŒæŒ‡å®šç¬¬ä¸€å‚æ•°ä¸º OVA çš„ç»å¯¹è·¯å¾„ã€‚è¿è¡Œå®Œåå°†ä¼šè‡ªåŠ¨å°† ova å¯¼å…¥åˆ° vCenterï¼Œå¹¶å¯åŠ¨è™šæ‹Ÿæœºï¼›</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># æ‰§è¡Œè¯¥è„šæœ¬ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ vCenter ISO ä¸­ vcsa ova æ–‡ä»¶çš„ç»å¯¹è·¯å¾„</span>
$ <span class="token function">bash</span> install-vcsa.sh /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova

<span class="token punctuation">[</span>03-02-22 <span class="token number">18</span>:40:19<span class="token punctuation">]</span> Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk1.vmdk<span class="token punctuation">..</span>. OK
<span class="token punctuation">[</span>03-02-22 <span class="token number">18</span>:41:09<span class="token punctuation">]</span> Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk<span class="token punctuation">..</span>. <span class="token punctuation">(</span><span class="token number">29</span>%, <span class="token number">52</span>.5MiB/s<span class="token punctuation">)</span>
<span class="token punctuation">[</span>03-02-22 <span class="token number">18</span>:43:08<span class="token punctuation">]</span> Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk<span class="token punctuation">..</span>. OK
<span class="token punctuation">[</span>03-02-22 <span class="token number">18</span>:43:08<span class="token punctuation">]</span> Injecting OVF environment<span class="token punctuation">..</span>.
Powering on VirtualMachine:3<span class="token punctuation">..</span>. OK
fe80::20c:29ff:fe03:2f80<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>è®¾ç½® vCenter ç™»å½•çš„ç¯å¢ƒå˜é‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ govc æ¥é…ç½® vCenterï¼Œé€šè¿‡æµè§ˆå™¨ Web UI çš„æ–¹å¼é…ç½®èµ·æ¥æ•ˆç‡æœ‰ç‚¹ä½ï¼Œä¸å¦‚ govc å‘½ä»¤ä¸€æŠŠæ¢­æ–¹ä¾¿ ğŸ˜‚</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_URL</span><span class="token operator">=</span><span class="token string">"https://192.168.20.92"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_USERNAME</span><span class="token operator">=</span><span class="token string">"administrator@vsphere.local"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_PASSWORD</span><span class="token operator">=</span><span class="token string">"admin@2022"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_INSECURE</span><span class="token operator">=</span>true
<span class="token builtin class-name">export</span> <span class="token assign-left variable">GOVC_DATASTORE</span><span class="token operator">=</span>datastore1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>è™šæ‹Ÿæœºå¯åŠ¨åå°†è‡ªåŠ¨è¿›è¡Œ vCenter çš„å®‰è£…é…ç½®ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ vCenter å®‰è£…å¥½ä¹‹åï¼Œä½¿ç”¨ govc about æŸ¥çœ‹ vCenter çš„ä¿¡æ¯ï¼Œå¦‚æœèƒ½æ­£ç¡®æˆ–æ¸ é“è¯´æ˜ vCenter å°±å®‰è£…å¥½äº†ï¼›</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ govc about
FullName:     VMware vCenter Server <span class="token number">7.0</span>.3 build-18778458
Name:         VMware vCenter Server
Vendor:       VMware, Inc.
Version:      <span class="token number">7.0</span>.3
Build:        <span class="token number">18778458</span>
OS type:      linux-x64
API type:     VirtualCenter
API version:  <span class="token number">7.0</span>.3.0
Product ID:   vpx
UUID:         0b49e119-e38f-4fbc-84a8-d7a0e548027d<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="é…ç½®-vCenter"><a href="#é…ç½®-vCenter" class="headerlink" title="é…ç½® vCenter"></a>é…ç½® vCenter</h3><p>è¿™ä¸€æ­¥éª¤ä¸»è¦æ˜¯é…ç½® vCenterï¼šåˆ›å»º Datacenterã€clusterã€folder ç­‰èµ„æºï¼Œå¹¶å°† ESXi ä¸»æœºæ·»åŠ åˆ° cluster ä¸­ï¼›</p>
<ul>
<li>é…ç½® vCenter</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># åˆ›å»º Datacenter æ•°æ®ä¸­å¿ƒ</span>
$ govc datacenter.create SH-IDC
<span class="token comment"># åˆ›å»º Cluster é›†ç¾¤</span>
$ govc cluster.create <span class="token parameter variable">-dc</span><span class="token operator">=</span>SH-IDC Tanzu-Cluster
<span class="token comment"># å°† ESXi ä¸»æœºæ·»åŠ åˆ° Cluster å½“ä¸­</span>
$ govc cluster.add <span class="token parameter variable">-dc</span><span class="token operator">=</span>SH-IDC <span class="token parameter variable">-cluster</span><span class="token operator">=</span>Tanzu-Cluster <span class="token parameter variable">-hostname</span><span class="token operator">=</span><span class="token number">192.168</span>.18.47 <span class="token parameter variable">--username</span><span class="token operator">=</span>root <span class="token parameter variable">-password</span><span class="token operator">=</span><span class="token string">'admin@2020'</span> <span class="token parameter variable">-noverify</span>
<span class="token comment"># åˆ›å»º folderï¼Œç”¨äºå°† Tanzu çš„èŠ‚ç‚¹è™šæ‹Ÿæœºå­˜æ”¾åˆ°è¯¥æ–‡ä»¶å¤¹ä¸‹</span>
$ govc folder.create /SH-IDC/vm/Tanzu-node
<span class="token comment"># å¯¼å…¥ tanzu æ±²å–èŠ‚ç‚¹çš„è™šæ‹Ÿæœº ova æ¨¡ç‰ˆ</span>
$ govc import.ova <span class="token parameter variable">-dc</span><span class="token operator">=</span><span class="token string">'SH-IDC'</span> <span class="token parameter variable">-ds</span><span class="token operator">=</span><span class="token string">'datastore1'</span> photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova
<span class="token comment"># å°†è™šæ‹Ÿæœºè½¬æ¢ä¸ºæ¨¡ç‰ˆï¼Œåç»­ tanzu é›†ç¾¤å°†ä»¥è¯¥æ¨¡ç‰ˆåˆ›å»ºè™šæ‹Ÿæœº</span>
$ govc vm.markastemplate photon-3-kube-v1.21.2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="åˆå§‹åŒ–-bootstrap-èŠ‚ç‚¹"><a href="#åˆå§‹åŒ–-bootstrap-èŠ‚ç‚¹" class="headerlink" title="åˆå§‹åŒ– bootstrap èŠ‚ç‚¹"></a>åˆå§‹åŒ– bootstrap èŠ‚ç‚¹</h3><p>bootstrap èŠ‚ç‚¹èŠ‚ç‚¹æ˜¯ç”¨äºè¿è¡Œ tanzu éƒ¨ç½²å·¥å…·çš„èŠ‚ç‚¹ï¼Œå®˜æ–¹æ˜¯æ”¯æŒ Linux&#x2F;macOS&#x2F;Windows ä¸‰ç§æ“ä½œç³»ç»Ÿçš„ï¼Œä½†æœ‰ä¸€äº›æ¯”è¾ƒä¸¥æ ¼çš„è¦æ±‚ï¼š</p>
<table>
<thead>
<tr>
<th>Arch: x86; ARM is currently unsupported</th>
</tr>
</thead>
<tbody><tr>
<td>RAM: 6 GB</td>
</tr>
<tr>
<td>CPU: 2</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/">Docker</a> Add your non-root user account to the docker user group. Create the group if it does not already exist. This lets the Tanzu CLI access the Docker socket, which is owned by the root user. For more information, see steps 1 to 4 in the <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user">Manage Docker as a non-root user</a> procedure in the Docker documentation.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/">Kubectl</a></td>
</tr>
<tr>
<td>Latest version of Chrome, Firefox, Safari, Internet Explorer, or Edge</td>
</tr>
<tr>
<td>System time is synchronized with a Network Time Protocol (NTP) server.</td>
</tr>
<tr>
<td>Ensure your bootstrap machine is using <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man7/cgroups.7.html">cgroup v1</a>. For more information, see <a target="_blank" rel="noopener" href="https://tanzucommunityedition.io/docs/latest/support-matrix/#check-and-set-the-cgroup">Check and set the cgroup</a>.</td>
</tr>
</tbody></table>
<p>åœ¨è¿™é‡Œä¸ºäº†é¿å…è¿™äº›éº»çƒ¦çš„é…ç½®ï¼Œæˆ‘å°±ç›´æ¥ä½¿ç”¨çš„ VMware å®˜æ–¹çš„ <a target="_blank" rel="noopener" href="https://github.com/vmware/photon/wiki/Downloading-Photon-OS#photon-os-40-rev2-binaries">Photon OS 4.0 Rev2</a> ï¼Œä¸‹è½½ OVA æ ¼å¼çš„é•œåƒç›´æ¥å¯¼å…¥åˆ° ESXi ä¸»æœºå¯åŠ¨ä¸€å°è™šæ‹Ÿæœºå³å¯ï¼Œèƒ½èŠ‚çœä¸å°‘éº»çƒ¦çš„é…ç½®ï¼›è¿˜æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯åœ¨ä¸€å°å•ç‹¬çš„è™šæ‹Ÿæœºä¸Šè¿è¡Œ tanzu éƒ¨ç½²å·¥å…·ä¸ä¼šæ±¡æŸ“æœ¬åœ°çš„å¼€å‘ç¯å¢ƒã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">wget</span> https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova
<span class="token comment"># å¯¼å…¥ OVA è™šæ‹Ÿæœºæ¨¡ç‰ˆ</span>
$ govc import.ova <span class="token parameter variable">-ds</span><span class="token operator">=</span><span class="token string">'datastore1'</span> <span class="token parameter variable">-name</span> bootstrap-node photon-ova-4.0-c001795b80.ova
<span class="token comment"># ä¿®æ”¹ä¸€ä¸‹è™šæ‹Ÿæœºçš„é…ç½®ï¼Œè°ƒæ•´ä¸º 4C8G</span>
$ govc vm.change <span class="token parameter variable">-c</span> <span class="token number">4</span> <span class="token parameter variable">-m</span> <span class="token number">8192</span> <span class="token parameter variable">-vm</span> bootstrap-node
<span class="token comment"># å¼€å¯è™šæ‹Ÿæœº</span>
$ govc vm.power <span class="token parameter variable">-on</span> bootstrap-node
<span class="token comment"># æŸ¥çœ‹è™šæ‹Ÿæœºè·å–åˆ°çš„ IPv4 åœ°å€</span>
$ govc vm.ip <span class="token parameter variable">-a</span> <span class="token parameter variable">-wait</span> 1m bootstrap-node
$ <span class="token function">ssh</span> root@192.168.74.10
<span class="token comment"># å¯†ç é»˜è®¤ä¸º changemeï¼Œè¾“å…¥å®Œå¯†ç ä¹‹åæç¤ºåœ¨è¾“å…¥ä¸€é changemeï¼Œç„¶åå†ä¿®æ”¹æ–°çš„å¯†ç </span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># cat /etc/os-release</span>
<span class="token assign-left variable">NAME</span><span class="token operator">=</span><span class="token string">"VMware Photon OS"</span>
<span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token string">"4.0"</span>
<span class="token assign-left variable">ID</span><span class="token operator">=</span>photon
<span class="token assign-left variable">VERSION_ID</span><span class="token operator">=</span><span class="token number">4.0</span>
<span class="token assign-left variable">PRETTY_NAME</span><span class="token operator">=</span><span class="token string">"VMware Photon OS/Linux"</span>
<span class="token assign-left variable">ANSI_COLOR</span><span class="token operator">=</span><span class="token string">"1;34"</span>
<span class="token assign-left variable">HOME_URL</span><span class="token operator">=</span><span class="token string">"https://vmware.github.io/photon/"</span>
<span class="token assign-left variable">BUG_REPORT_URL</span><span class="token operator">=</span><span class="token string">"https://github.com/vmware/photon/issues"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>å®‰è£…éƒ¨ç½²æ—¶éœ€è¦çš„ä¸€äº›å·¥å…·ï¼ˆåˆ‡ï¼ŒPhoton OS é‡Œç«Ÿç„¶è¿ä¸ª tar å‘½ä»¤éƒ½æ²¡æœ‰ ğŸ˜ </li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># tdnf install sudo tar -y</span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># curl -LO https://dl.k8s.io/release/v1.21.2/bin/linux/amd64/kubectl</span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>å¯åŠ¨ dockerï¼Œbootstrap èŠ‚ç‚¹ä¼šä»¥ kind çš„æ–¹å¼è¿è¡Œä¸€ä¸ª K8s é›†ç¾¤ï¼Œéœ€è¦ç”¨åˆ° dockerã€‚è™½ç„¶å¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ k8s é›†ç¾¤ï¼Œä½†ä¸æ˜¯å¾ˆæ¨èï¼Œå› ä¸º cluster-api ä¾èµ– k8s çš„ç‰ˆæœ¬ï¼Œä¸èƒ½å¤ªé«˜ä¹Ÿä¸èƒ½å¤ªä½ï¼›</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># systemctl enable docker --now</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>ä» <a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/community-edition/releases/tag/v0.9.1">vmware-tanzu&#x2F;community-edition</a> ä¸‹è½½ tanzu ç¤¾åŒºç‰ˆçš„å®‰è£…åŒ…ï¼Œç„¶åè§£å‹åå®‰è£…ï¼›</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># curl -LO  https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz</span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># tar -xf tce-linux-amd64-v0.9.1.tar.gz</span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># cd tce-linux-amd64-v0.9.1/</span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># bash install.sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶è€Œä¸å¹¸åœ°ç¿»è½¦äº†ï¼Œ install.sh è„šæœ¬ä¸­ç¦æ­¢ root ç”¨æˆ·è¿è¡Œ</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">+ <span class="token assign-left variable">ALLOW_INSTALL_AS_ROOT</span><span class="token operator">=</span>
+ <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token number">0</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>
+ <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token string">''</span> <span class="token operator">!=</span> <span class="token punctuation">\</span>t<span class="token punctuation">\</span>r<span class="token punctuation">\</span>u<span class="token punctuation">\</span>e <span class="token punctuation">]</span><span class="token punctuation">]</span>
+ <span class="token builtin class-name">echo</span> <span class="token string">'Do not run this script as root'</span>
Do not run this script as root
+ <span class="token builtin class-name">exit</span> <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘å°±ååè¦ä»¥ root ç”¨æˆ·æ¥è¿è¡Œæ€ä¹ˆæƒ¹ ğŸ˜¡</p>
<p><img data-src="https://p.k8s.li/2022-01-22-deploy-tanzu-k8s-cluster-01.jpg"></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># sed å»æ‰ç¬¬ä¸€ä¸ª exit 1 å°±å¯ä»¥äº†</span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># sed -i.bak "s/exit 1//" install.sh</span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># bash install.sh</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å®‰è£…å¥½ä¹‹åä¼šè¾“å‡º <code>Installation complete!</code>ï¼ˆè®²çœŸå®˜æ–¹çš„ install.sh è„šæœ¬è¾“å‡ºå¾ˆä¸å‹å¥½ï¼Œæ±¡æŸ“æˆ‘çš„ terminal</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">+ tanzu init
<span class="token operator">|</span> initializing âœ”  successfully initialized CLI
++ tanzu plugin repo list
++ <span class="token function">grep</span> tce
+ <span class="token assign-left variable">TCE_REPO</span><span class="token operator">=</span>
+ <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">''</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>
+ tanzu plugin repo <span class="token function">add</span> <span class="token parameter variable">--name</span> tce --gcp-bucket-name tce-tanzu-cli-plugins --gcp-root-path artifacts
++ tanzu plugin repo list
++ <span class="token function">grep</span> core-admin
+ <span class="token assign-left variable">TCE_REPO</span><span class="token operator">=</span>
+ <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">''</span> <span class="token punctuation">]</span><span class="token punctuation">]</span>
+ tanzu plugin repo <span class="token function">add</span> <span class="token parameter variable">--name</span> core-admin --gcp-bucket-name tce-tanzu-cli-framework-admin --gcp-root-path artifacts-admin
+ <span class="token builtin class-name">echo</span> <span class="token string">'Installation complete!'</span>
Installation complete<span class="token operator">!</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="éƒ¨ç½²ç®¡ç†é›†ç¾¤"><a href="#éƒ¨ç½²ç®¡ç†é›†ç¾¤" class="headerlink" title="éƒ¨ç½²ç®¡ç†é›†ç¾¤"></a>éƒ¨ç½²ç®¡ç†é›†ç¾¤</h3><p>å…ˆæ˜¯éƒ¨ç½²ä¸€ä¸ª tanzu çš„ç®¡ç†é›†ç¾¤ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡ <a target="_blank" rel="noopener" href="https://tanzucommunityedition.io/docs/latest/getting-started/">å®˜æ–¹æ–‡æ¡£</a> æåˆ°çš„é€šè¿‡ Web UI çš„æ–¹å¼ã€‚ç›®å‰è¿™ä¸ª UI ç•Œé¢æ¯”è¾ƒæ‹‰å®ï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥è®©ç”¨æˆ·å¡«å†™ä¸€äº›é…ç½®å‚æ•°ï¼Œç„¶åè°ƒç”¨åå°çš„ tanzu å‘½ä»¤æ¥éƒ¨ç½²é›†ç¾¤ã€‚å¹¶æŠŠé›†ç¾¤éƒ¨ç½²çš„æ—¥å¿—å’Œè¿›åº¦å±•ç¤ºå‡ºæ¥ï¼›éƒ¨ç½²å®Œæˆä¹‹åï¼Œè¿™ä¸ª UI åˆä¸èƒ½ç®¡ç†è¿™äº›é›†ç¾¤ï¼Œåˆä¸æ”¯æŒéƒ¨ç½² workload é›†ç¾¤ï¼ˆ</p>
<p>å¦ä¸€ç§å°±æ˜¯é€šè¿‡ tanzu å‘½ä»¤æŒ‡å®šé…ç½®æ–‡ä»¶æ¥éƒ¨ç½²ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦é€šè¿‡æµè§ˆå™¨åœ¨ web é¡µé¢ä¸Šå‚»ä¹ä¹åœ°ç‚¹æ¥ç‚¹å»å¡«ä¸€äº›å‚æ•°ï¼Œåªéœ€è¦æå‰å¡«å†™å¥½ä¸€ä¸ª yaml æ ¼å¼çš„é…ç½®æ–‡ä»¶å³å¯ã€‚ä¸‹é¢æˆ‘ä»¬å°±é‡‡ç”¨ tanzu å‘½ä»¤æ¥éƒ¨ç½²é›†ç¾¤ï¼Œç®¡ç†é›†ç¾¤çš„é…ç½®æ–‡ä»¶æ¨¡ç‰ˆå¦‚ä¸‹ï¼š</p>
<ul>
<li>tanzu-mgt-cluster.yaml</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Cluster Pod IP çš„ CIDR</span>
<span class="token key atrule">CLUSTER_CIDR</span><span class="token punctuation">:</span> 100.96.0.0/11
<span class="token comment"># Service çš„ CIDR</span>
<span class="token key atrule">SERVICE_CIDR</span><span class="token punctuation">:</span> 100.64.0.0/13
<span class="token comment"># é›†ç¾¤çš„åç§°</span>
<span class="token key atrule">CLUSTER_NAME</span><span class="token punctuation">:</span> tanzu<span class="token punctuation">-</span>control<span class="token punctuation">-</span>plan
<span class="token comment"># é›†ç¾¤çš„ç±»å‹</span>
<span class="token key atrule">CLUSTER_PLAN</span><span class="token punctuation">:</span> dev
<span class="token comment"># é›†ç¾¤èŠ‚ç‚¹çš„ arch</span>
<span class="token key atrule">OS_ARCH</span><span class="token punctuation">:</span> amd64
<span class="token comment"># é›†ç¾¤èŠ‚ç‚¹çš„ OS åç§°</span>
<span class="token key atrule">OS_NAME</span><span class="token punctuation">:</span> photon
<span class="token comment"># é›†ç¾¤èŠ‚ç‚¹ OS ç‰ˆæœ¬</span>
<span class="token key atrule">OS_VERSION</span><span class="token punctuation">:</span> <span class="token string">"3"</span>
<span class="token comment"># åŸºç¡€è®¾æ–½èµ„æºçš„æä¾›æ–¹</span>
<span class="token key atrule">INFRASTRUCTURE_PROVIDER</span><span class="token punctuation">:</span> vsphere

<span class="token comment"># é›†ç¾¤çš„ VIP</span>
<span class="token key atrule">VSPHERE_CONTROL_PLANE_ENDPOINT</span><span class="token punctuation">:</span> 192.168.75.194
<span class="token comment"># control-plan èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span>
<span class="token key atrule">VSPHERE_CONTROL_PLANE_DISK_GIB</span><span class="token punctuation">:</span> <span class="token string">"20"</span>
<span class="token comment"># control-plan èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span>
<span class="token key atrule">VSPHERE_CONTROL_PLANE_MEM_MIB</span><span class="token punctuation">:</span> <span class="token string">"8192"</span>
<span class="token comment"># control-plan èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span>
<span class="token key atrule">VSPHERE_CONTROL_PLANE_NUM_CPUS</span><span class="token punctuation">:</span> <span class="token string">"4"</span>
<span class="token comment"># work èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span>
<span class="token key atrule">VSPHERE_WORKER_DISK_GIB</span><span class="token punctuation">:</span> <span class="token string">"20"</span>
<span class="token comment"># work èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span>
<span class="token key atrule">VSPHERE_WORKER_MEM_MIB</span><span class="token punctuation">:</span> <span class="token string">"4096"</span>
<span class="token comment"># work èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span>
<span class="token key atrule">VSPHERE_WORKER_NUM_CPUS</span><span class="token punctuation">:</span> <span class="token string">"2"</span>

<span class="token comment"># vCenter çš„ Datacenter è·¯å¾„</span>
<span class="token key atrule">VSPHERE_DATACENTER</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC
<span class="token comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„ Datastore è·¯å¾„</span>
<span class="token key atrule">VSPHERE_DATASTORE</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/datastore/datastore1
<span class="token comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„æ–‡ä»¶å¤¹</span>
<span class="token key atrule">VSPHERE_FOLDER</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/vm/Tanzu<span class="token punctuation">-</span>node
<span class="token comment"># è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œ</span>
<span class="token key atrule">VSPHERE_NETWORK</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/network/VM Network
<span class="token comment"># è™šæ‹Ÿæœºå…³è”çš„èµ„æºæ± </span>
<span class="token key atrule">VSPHERE_RESOURCE_POOL</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/host/Tanzu<span class="token punctuation">-</span>Cluster/Resources

<span class="token comment"># vCenter çš„ IP</span>
<span class="token key atrule">VSPHERE_SERVER</span><span class="token punctuation">:</span> 192.168.75.110
<span class="token comment"># vCenter çš„ç”¨æˆ·å</span>
<span class="token key atrule">VSPHERE_USERNAME</span><span class="token punctuation">:</span> administrator@vsphere.local
<span class="token comment"># vCenter çš„å¯†ç ï¼Œä»¥ base64 ç¼–ç </span>
<span class="token key atrule">VSPHERE_PASSWORD</span><span class="token punctuation">:</span> &lt;encoded<span class="token punctuation">:</span>base64password<span class="token punctuation">></span>
<span class="token comment"># vCenter çš„è¯ä¹¦æŒ‡çº¹ï¼Œå¯ä»¥é€šè¿‡ govc about.cert -json | jq -r '.ThumbprintSHA1' è·å–</span>
<span class="token key atrule">VSPHERE_TLS_THUMBPRINT</span><span class="token punctuation">:</span> EB<span class="token punctuation">:</span>F3<span class="token punctuation">:</span>D8<span class="token punctuation">:</span>7A<span class="token punctuation">:</span>E8<span class="token punctuation">:</span>3D<span class="token punctuation">:</span>1A<span class="token punctuation">:</span>59<span class="token punctuation">:</span>B0<span class="token punctuation">:</span>DE<span class="token punctuation">:</span>73<span class="token punctuation">:</span>96<span class="token punctuation">:</span>DC<span class="token punctuation">:</span>B9<span class="token punctuation">:</span>5F<span class="token punctuation">:</span>13<span class="token punctuation">:</span>86<span class="token punctuation">:</span>EF<span class="token punctuation">:</span>B6<span class="token punctuation">:</span><span class="token number">27</span>
<span class="token comment"># è™šæ‹Ÿæœºæ³¨å…¥çš„ ssh å…¬é’¥ï¼Œéœ€è¦ç”¨å®ƒæ¥ ssh ç™»å½•é›†ç¾¤èŠ‚ç‚¹</span>
<span class="token key atrule">VSPHERE_SSH_AUTHORIZED_KEY</span><span class="token punctuation">:</span> ssh<span class="token punctuation">-</span>rsa

<span class="token comment"># ä¸€äº›é»˜è®¤å‚æ•°</span>
<span class="token key atrule">AVI_ENABLE</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
<span class="token key atrule">IDENTITY_MANAGEMENT_TYPE</span><span class="token punctuation">:</span> none
<span class="token key atrule">ENABLE_AUDIT_LOGGING</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
<span class="token key atrule">ENABLE_CEIP_PARTICIPATION</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
<span class="token key atrule">TKG_HTTP_PROXY_ENABLED</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
<span class="token key atrule">DEPLOY_TKG_ON_VSPHERE7</span><span class="token punctuation">:</span> <span class="token string">"true"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>é€šè¿‡ tanzu CLI éƒ¨ç½²ç®¡ç†é›†ç¾¤</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ tanzu management-cluster create <span class="token parameter variable">--file</span> tanzu-mgt-cluster.yaml <span class="token parameter variable">-v6</span>

<span class="token comment"># å¦‚æœæ²¡æœ‰é…ç½® VSPHERE_TLS_THUMBPRINT ä¼šæœ‰ä¸€ä¸ªç¡®è®¤ vSphere thumbprint çš„äº¤äº’ï¼Œè¾“å…¥ Y å°±å¯ä»¥</span>
Validating the pre-requisites<span class="token punctuation">..</span>.
Do you want to <span class="token builtin class-name">continue</span> with the vSphere thumbprint EB:F3:D8:7A:E8:3D:1A:59:B0:DE:73:96:DC:B9:5F:13:86:EF:B6:27 <span class="token punctuation">[</span>y/N<span class="token punctuation">]</span>: y<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="éƒ¨ç½²æ—¥å¿—"><a href="#éƒ¨ç½²æ—¥å¿—" class="headerlink" title="éƒ¨ç½²æ—¥å¿—"></a>éƒ¨ç½²æ—¥å¿—</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># tanzu management-cluster create --file tanzu-mgt-cluster.yaml -v 6</span>
compatibility <span class="token function">file</span> <span class="token punctuation">(</span>/root/.config/tanzu/tkg/compatibility/tkg-compatibility.yaml<span class="token punctuation">)</span> already exists, skipping download
BOM files inside /root/.config/tanzu/tkg/bom already exists, skipping download
CEIP Opt-in status: <span class="token boolean">false</span>

Validating the pre-requisites<span class="token punctuation">..</span>.

vSphere <span class="token number">7.0</span> Environment Detected.

You have connected to a vSphere <span class="token number">7.0</span> environment <span class="token function">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includes
an integrated Tanzu Kubernetes Grid Service <span class="token function">which</span> turns a vSphere cluster into a platform <span class="token keyword">for</span> running Kubernetes workloads <span class="token keyword">in</span> dedicated
resource pools. Configuring Tanzu Kubernetes Grid Service is <span class="token keyword">done</span> through vSphere HTML5 client.

Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="token keyword">in</span> vSphere <span class="token number">7.0</span> environments. Alternatively you may
deploy a non-integrated Tanzu Kubernetes Grid instance on vSphere <span class="token number">7.0</span>.
Deploying TKG management cluster on vSphere <span class="token number">7.0</span> <span class="token punctuation">..</span>.
Identity Provider not configured. Some authentication features won<span class="token string">'t work.
Checking if VSPHERE_CONTROL_PLANE_ENDPOINT 192.168.20.94 is already in use

Setting up management cluster...
Validating configuration...
Using infrastructure provider vsphere:v0.7.10
Generating cluster configuration...
Setting up bootstrapper...
Fetching configuration for kind node image...
kindConfig:
 &amp;&#123;&#123;Cluster kind.x-k8s.io/v1alpha4&#125;  [&#123;  map[] [&#123;/var/run/docker.sock /var/run/docker.sock false false &#125;] [] [] []&#125;] &#123; 0  100.96.0.0/11 100.64.0.0/13 false &#125; map[] map[] [apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
imageRepository: projects.registry.vmware.com/tkg
etcd:
  local:
    imageRepository: projects.registry.vmware.com/tkg
    imageTag: v3.4.13_vmware.15
dns:
  type: CoreDNS
  imageRepository: projects.registry.vmware.com/tkg
  imageTag: v1.8.0_vmware.5] [] [] []&#125;
Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210
Creating cluster "tkg-kind-c7vj6kds0a6sf43e6210" ...
Ensuring node image (projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1) ...
Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 ...
Preparing nodes ...
Writing configuration ...
Starting control-plane ...
Installing CNI ...
Installing StorageClass ...
Waiting 2m0s for control-plane = Ready ...
Ready after 19s
Bootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOL
Installing providers on bootstrapper...
Fetching providers
Installing cert-manager Version="v1.1.0"
Waiting for cert-manager to be available...
Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"
Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"
Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"
Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"
installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"
installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"
installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"
installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"
Waiting for provider infrastructure-vsphere
Waiting for provider control-plane-kubeadm
Waiting for provider cluster-api
Waiting for provider bootstrap-kubeadm
Waiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and running
pods are not yet running for deployment '</span>capi-kubeadm-control-plane-controller-manager<span class="token string">' in namespace '</span>capi-kubeadm-control-plane-system<span class="token string">', retrying
Passed waiting on provider bootstrap-kubeadm after 25.205820854s
pods are not yet running for deployment '</span>capi-controller-manager<span class="token string">' in namespace '</span>capi-webhook-system<span class="token string">', retrying
Passed waiting on provider infrastructure-vsphere after 30.185406332s
Passed waiting on provider cluster-api after 30.213216243s
Success waiting on all providers.

Start creating management cluster...
patch cluster object with operation status:
	&#123;
		"metadata": &#123;
			"annotations": &#123;
				"TKGOperationInfo" : "&#123;\"Operation\":\"Create\",\"OperationStartTimestamp\":\"2022-02-06 02:35:34.30219421 +0000 UTC\",\"OperationTimeout\":1800&#125;",
				"TKGOperationLastObservedTimestamp" : "2022-02-06 02:35:34.30219421 +0000 UTC"
			&#125;
		&#125;
	&#125;
cluster control plane is still being initialized, retrying
Getting secret for cluster
Waiting for resource tanzu-control-plan-kubeconfig of type *v1.Secret to be up and running
Saving management cluster kubeconfig into /root/.kube/config
Installing providers on management cluster...
Fetching providers
Installing cert-manager Version="v1.1.0"
Waiting for cert-manager to be available...
Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"
Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"
Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"
Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"
installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"
installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"
installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"
installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"
Waiting for provider control-plane-kubeadm
Waiting for provider bootstrap-kubeadm
Waiting for provider infrastructure-vsphere
Waiting for provider cluster-api
Waiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and running
Passed waiting on provider control-plane-kubeadm after 10.046865402s
Waiting for resource antrea-controller of type *v1.Deployment to be up and running
Moving all Cluster API objects from bootstrap cluster to management cluster...
Performing move...
Discovering Cluster API objects
Moving Cluster API objects Clusters=1
Creating objects in the target cluster
Deleting objects from the source cluster
Waiting for additional components to be up and running...
Waiting for packages to be up and running...
Waiting for package: antrea
Waiting for package: metrics-server
Waiting for package: tanzu-addons-manager
Waiting for package: vsphere-cpi
Waiting for package: vsphere-csi
Waiting for resource antrea of type *v1alpha1.PackageInstall to be up and running
Waiting for resource vsphere-cpi of type *v1alpha1.PackageInstall to be up and running
Waiting for resource vsphere-csi of type *v1alpha1.PackageInstall to be up and running
Waiting for resource metrics-server of type *v1alpha1.PackageInstall to be up and running
Waiting for resource tanzu-addons-manager of type *v1alpha1.PackageInstall to be up and running
Successfully reconciled package: antrea
Successfully reconciled package: vsphere-csi
Successfully reconciled package: metrics-server
Context set for management cluster tanzu-control-plan as '</span>tanzu-control-plan-admin@tanzu-control-plan'.
Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210

Management cluster created<span class="token operator">!</span>


You can now create your first workload cluster by running the following:

  tanzu cluster create <span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token parameter variable">-f</span> <span class="token punctuation">[</span>file<span class="token punctuation">]</span>


Some addons might be getting installed<span class="token operator">!</span> Check their status by running the following:

  kubectl get apps <span class="token parameter variable">-A</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>éƒ¨ç½²å®Œæˆä¹‹åï¼Œå°†ç®¡ç†é›†ç¾¤çš„ kubeconfig æ–‡ä»¶å¤åˆ¶åˆ° kubectl é»˜è®¤çš„ç›®å½•ä¸‹</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># cp $&#123;HOME&#125;/.kube-tkg/config $&#123;HOME&#125;/.kube/config</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ç®¡ç†é›†ç¾¤çš„ cluster èµ„æºä¿¡æ¯ï¼Œç®¡ç†é›†ç¾¤çš„ CR é»˜è®¤ä¿å­˜åœ¨äº† tkg-system namespace ä¸‹</span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get cluster -A</span>
NAMESPACE    NAME                 PHASE
tkg-system   tanzu-control-plan   Provisioned
<span class="token comment"># ç®¡ç†é›†ç¾¤çš„ machine èµ„æºä¿¡æ¯</span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get machine -A</span>
NAMESPACE    NAME                                       PROVIDERID                                       PHASE         VERSION
tkg-system   tanzu-control-plan-control-plane-gs4bl     vsphere://4239c450-f621-d78e-3c44-4ac8890c0cd3   Running       v1.21.2+vmware.1
tkg-system   tanzu-control-plan-md-0-7cdc97c7c6-kxcnx   vsphere://4239d776-c04c-aacc-db12-3380542a6d03   Provisioned   v1.21.2+vmware.1
<span class="token comment"># è¿è¡Œçš„ç»„ä»¶çŠ¶æ€</span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get pod -A</span>
NAMESPACE                           NAME                                                             READY   STATUS    RESTARTS   AGE
capi-kubeadm-bootstrap-system       capi-kubeadm-bootstrap-controller-manager-6494884869-wlzhx       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m37s
capi-kubeadm-control-plane-system   capi-kubeadm-control-plane-controller-manager-857d687b9d-tpznv   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m35s
capi-system                         capi-controller-manager-778bd4dfb9-tkvwg                         <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m41s
capi-webhook-system                 capi-controller-manager-9995bdc94-svjm2                          <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m41s
capi-webhook-system                 capi-kubeadm-bootstrap-controller-manager-68845b65f8-sllgv       <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m38s
capi-webhook-system                 capi-kubeadm-control-plane-controller-manager-9847c6747-vvz6g    <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m35s
capi-webhook-system                 capv-controller-manager-55bf67fbd5-4t46v                         <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m31s
capv-system                         capv-controller-manager-587fbf697f-bbzs9                         <span class="token number">2</span>/2     Running   <span class="token number">0</span>          8m31s
cert-manager                        cert-manager-77f6fb8fd5-8tq6n                                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m
cert-manager                        cert-manager-cainjector-6bd4cff7bb-6vlzx                         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m
cert-manager                        cert-manager-webhook-fbfcb9d6c-qpkbc                             <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m
kube-system                         antrea-agent-5m9d4                                               <span class="token number">2</span>/2     Running   <span class="token number">0</span>          6m
kube-system                         antrea-agent-8mpr7                                               <span class="token number">2</span>/2     Running   <span class="token number">0</span>          5m40s
kube-system                         antrea-controller-5bbcb98667-hklss                               <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m50s
kube-system                         coredns-8dcb5c56b-ckvb7                                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m
kube-system                         coredns-8dcb5c56b-d98hf                                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m
kube-system                         etcd-tanzu-control-plan-control-plane-gs4bl                      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m
kube-system                         kube-apiserver-tanzu-control-plan-control-plane-gs4bl            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m
kube-system                         kube-controller-manager-tanzu-control-plan-control-plane-gs4bl   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m
kube-system                         kube-proxy-d4wq4                                                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m
kube-system                         kube-proxy-nhkgg                                                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m
kube-system                         kube-scheduler-tanzu-control-plan-control-plane-gs4bl            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m
kube-system                         kube-vip-tanzu-control-plan-control-plane-gs4bl                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          12m
kube-system                         metrics-server-59fcb9fcf-xjznj                                   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m29s
kube-system                         vsphere-cloud-controller-manager-kzffm                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m50s
kube-system                         vsphere-csi-controller-74675c9488-q9h5c                          <span class="token number">6</span>/6     Running   <span class="token number">0</span>          6m31s
kube-system                         vsphere-csi-node-dmvvr                                           <span class="token number">3</span>/3     Running   <span class="token number">0</span>          6m31s
kube-system                         vsphere-csi-node-k6x98                                           <span class="token number">3</span>/3     Running   <span class="token number">0</span>          6m31s
tkg-system                          kapp-controller-6499b8866-xnql7                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m
tkg-system                          tanzu-addons-controller-manager-657c587556-rpbjm                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>          7m58s
tkg-system                          tanzu-capabilities-controller-manager-6ff97656b8-cq7m7           <span class="token number">1</span>/1     Running   <span class="token number">0</span>          11m
tkr-system                          tkr-controller-manager-6bc455b5d4-wm98s                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="éƒ¨ç½²æµç¨‹-1"><a href="#éƒ¨ç½²æµç¨‹-1" class="headerlink" title="éƒ¨ç½²æµç¨‹"></a>éƒ¨ç½²æµç¨‹</h3><p>ç»“åˆ <a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go">tanzu çš„æºç </a> å’Œéƒ¨ç½²è¾“å‡ºçš„æ—¥å¿—æˆ‘ä»¬å¤§ä½“å¯ä»¥å¾—çŸ¥ï¼Œtanzu ç®¡ç†é›†ç¾¤éƒ¨ç½²å¤§è‡´åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go</span>

<span class="token comment">// management cluster init step constants</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	StepConfigPrerequisite                 <span class="token operator">=</span> <span class="token string">"Configure prerequisite"</span>
	StepValidateConfiguration              <span class="token operator">=</span> <span class="token string">"Validate configuration"</span>
	StepGenerateClusterConfiguration       <span class="token operator">=</span> <span class="token string">"Generate cluster configuration"</span>
	StepSetupBootstrapCluster              <span class="token operator">=</span> <span class="token string">"Setup bootstrap cluster"</span>
	StepInstallProvidersOnBootstrapCluster <span class="token operator">=</span> <span class="token string">"Install providers on bootstrap cluster"</span>
	StepCreateManagementCluster            <span class="token operator">=</span> <span class="token string">"Create management cluster"</span>
	StepInstallProvidersOnRegionalCluster  <span class="token operator">=</span> <span class="token string">"Install providers on management cluster"</span>
	StepMoveClusterAPIObjects              <span class="token operator">=</span> <span class="token string">"Move cluster-api objects from bootstrap cluster to management cluster"</span>
<span class="token punctuation">)</span>

<span class="token comment">// InitRegionSteps management cluster init step sequence</span>
<span class="token keyword">var</span> InitRegionSteps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span>
	StepConfigPrerequisite<span class="token punctuation">,</span>
	StepValidateConfiguration<span class="token punctuation">,</span>
	StepGenerateClusterConfiguration<span class="token punctuation">,</span>
	StepSetupBootstrapCluster<span class="token punctuation">,</span>
	StepInstallProvidersOnBootstrapCluster<span class="token punctuation">,</span>
	StepCreateManagementCluster<span class="token punctuation">,</span>
	StepInstallProvidersOnRegionalCluster<span class="token punctuation">,</span>
	StepMoveClusterAPIObjects<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>ConfigPrerequisite å‡†å¤‡é˜¶æ®µï¼Œä¼šä¸‹è½½ <code>tkg-compatibility</code> å’Œ <code>tkg-bom</code> é•œåƒï¼Œç”¨äºæ£€æŸ¥ç¯å¢ƒçš„å…¼å®¹æ€§ï¼›</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Downloading TKG compatibility <span class="token function">file</span> from <span class="token string">'projects.registry.vmware.com/tkg/framework-zshippable/tkg-compatibility'</span>
Downloading the TKG Bill of Materials <span class="token punctuation">(</span>BOM<span class="token punctuation">)</span> <span class="token function">file</span> from <span class="token string">'projects.registry.vmware.com/tkg/tkg-bom:v1.4.0'</span>
Downloading the TKr Bill of Materials <span class="token punctuation">(</span>BOM<span class="token punctuation">)</span> <span class="token function">file</span> from <span class="token string">'projects.registry.vmware.com/tkg/tkr-bom:v1.21.2_vmware.1-tkg.1'</span>
ERROR <span class="token number">2022</span>/02/06 02:24:46 svType <span class="token operator">!=</span> tvType<span class="token punctuation">;</span> <span class="token assign-left variable">key</span><span class="token operator">=</span>release, <span class="token assign-left variable">st</span><span class="token operator">=</span>map<span class="token punctuation">[</span>string<span class="token punctuation">]</span>interface <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>, <span class="token assign-left variable">tt</span><span class="token operator">=</span><span class="token operator">&lt;</span>nil<span class="token operator">></span>, <span class="token assign-left variable">sv</span><span class="token operator">=</span>map<span class="token punctuation">[</span>version:<span class="token punctuation">]</span>, <span class="token assign-left variable">tv</span><span class="token operator">=</span><span class="token operator">&lt;</span>nil<span class="token operator">></span>
CEIP Opt-in status: <span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>ValidateConfiguration é…ç½®æ–‡ä»¶æ ¡éªŒï¼Œæ ¹æ®å¡«å†™çš„å‚æ•°æ ¡éªŒé…ç½®æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠæ£€æŸ¥ vCenter å½“ä¸­æœ‰æ— åŒ¹é…çš„è™šæ‹Ÿæœºæ¨¡ç‰ˆï¼›</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Validating the pre-requisites<span class="token punctuation">..</span>.

vSphere <span class="token number">7.0</span> Environment Detected.

You have connected to a vSphere <span class="token number">7.0</span> environment <span class="token function">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includes
an integrated Tanzu Kubernetes Grid Service <span class="token function">which</span> turns a vSphere cluster into a platform <span class="token keyword">for</span> running Kubernetes workloads <span class="token keyword">in</span> dedicated
resource pools. Configuring Tanzu Kubernetes Grid Service is <span class="token keyword">done</span> through vSphere HTML5 client.

Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="token keyword">in</span> vSphere <span class="token number">7.0</span> environments. Alternatively you may
deploy a non-integrated Tanzu Kubernetes Grid instance on vSphere <span class="token number">7.0</span>.
Deploying TKG management cluster on vSphere <span class="token number">7.0</span> <span class="token punctuation">..</span>.
Identity Provider not configured. Some authentication features won't work.
Checking <span class="token keyword">if</span> VSPHERE_CONTROL_PLANE_ENDPOINT <span class="token number">192.168</span>.20.94 is already <span class="token keyword">in</span> use

Setting up management cluster<span class="token punctuation">..</span>.
Validating configuration<span class="token punctuation">..</span>.
Using infrastructure provider vsphere:v0.7.10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>GenerateClusterConfiguration ç”Ÿæˆé›†ç¾¤é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼›</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Generating cluster configuration<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>SetupBootstrapCluster è®¾ç½® bootstrap é›†ç¾¤ï¼Œç›®å‰é»˜è®¤ä¸º kindã€‚ä¼šè¿è¡Œä¸€ä¸ª docker å®¹å™¨ï¼Œé‡Œé¢å¥—å¨ƒè¿è¡Œç€ä¸€ä¸ª k8s é›†ç¾¤ï¼›è¿™ä¸ª bootstrap k8s é›†ç¾¤åªæ˜¯ä¸´æ—¶è¿è¡Œ cluster-api æ¥éƒ¨ç½²ç®¡ç†é›†ç¾¤ç”¨çš„ï¼Œéƒ¨ç½²å®Œæˆä¹‹å bootstrap é›†ç¾¤ä¹Ÿå°±æ²¡ç”¨äº†ï¼Œä¼šè‡ªåŠ¨åˆ æ‰ï¼›</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Setting up bootstrapper<span class="token punctuation">..</span>.
Fetching configuration <span class="token keyword">for</span> kind <span class="token function">node</span> image<span class="token punctuation">..</span>.
kindConfig:
 <span class="token operator">&amp;</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span>Cluster kind.x-k8s.io/v1alpha4<span class="token punctuation">&#125;</span>  <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>  map<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>/var/run/docker.sock /var/run/docker.sock <span class="token boolean">false</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span>  <span class="token number">100.96</span>.0.0/11 <span class="token number">100.64</span>.0.0/13 <span class="token boolean">false</span> <span class="token punctuation">&#125;</span> map<span class="token punctuation">[</span><span class="token punctuation">]</span> map<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>apiVersion: kubeadm.k8s.io/v1beta2
kind: ClusterConfiguration
imageRepository: projects.registry.vmware.com/tkg
etcd:
  local:
    imageRepository: projects.registry.vmware.com/tkg
    imageTag: v3.4.13_vmware.15
dns:
  type: CoreDNS
  imageRepository: projects.registry.vmware.com/tkg
  imageTag: v1.8.0_vmware.5<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>
Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210
Creating cluster <span class="token string">"tkg-kind-c7vj6kds0a6sf43e6210"</span> <span class="token punctuation">..</span>.
Ensuring <span class="token function">node</span> image <span class="token punctuation">(</span>projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 <span class="token punctuation">..</span>.
Preparing nodes <span class="token punctuation">..</span>.
Writing configuration <span class="token punctuation">..</span>.
Starting control-plane <span class="token punctuation">..</span>.
Installing CNI <span class="token punctuation">..</span>.
Installing StorageClass <span class="token punctuation">..</span>.
Waiting 2m0s <span class="token keyword">for</span> control-plane <span class="token operator">=</span> Ready <span class="token punctuation">..</span>.
Ready after 19s
Bootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>InstallProvidersOnBootstrapCluster åœ¨ bootstrap é›†ç¾¤ä¸Šå®‰è£… cluste-api ç›¸å…³ç»„ä»¶ï¼›</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Installing providers on bootstrapper<span class="token punctuation">..</span>.
Fetching providers
<span class="token comment"># å®‰è£… cert-manager ä¸»è¦æ˜¯ä¸ºäº†ç”Ÿæˆ k8s é›†ç¾¤éƒ¨ç½²æ‰€ä¾èµ–çš„é‚£ä¸€å †è¯ä¹¦</span>
Installing cert-manager <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v1.1.0"</span>
Waiting <span class="token keyword">for</span> cert-manager to be available<span class="token punctuation">..</span>.
Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"cluster-api"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-system"</span>
Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"bootstrap-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-bootstrap-system"</span>
Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"control-plane-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-control-plane-system"</span>
Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"infrastructure-vsphere"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.7.10"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capv-system"</span>
installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"cluster-api"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"CoreProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>
installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"kubeadm"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"BootstrapProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>
installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"kubeadm"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"ControlPlaneProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>
installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"vsphere"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"InfrastructureProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.7.10"</span>
Waiting <span class="token keyword">for</span> provider infrastructure-vsphere
Waiting <span class="token keyword">for</span> provider control-plane-kubeadm
Waiting <span class="token keyword">for</span> provider cluster-api
Waiting <span class="token keyword">for</span> provider bootstrap-kubeadm
Passed waiting on provider infrastructure-vsphere after <span class="token number">30</span>.185406332s
Passed waiting on provider cluster-api after <span class="token number">30</span>.213216243s
Success waiting on all providers.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>CreateManagementCluster åˆ›å»ºç®¡ç†é›†ç¾¤ï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯åˆ›å»ºè™šæ‹Ÿæœºã€åˆå§‹åŒ–èŠ‚ç‚¹ã€è¿è¡Œ kubeadm éƒ¨ç½² k8s é›†ç¾¤ï¼›</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Start creating management cluster<span class="token punctuation">..</span>.
patch cluster object with operation status:
	<span class="token punctuation">&#123;</span>
		<span class="token string">"metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
			<span class="token string">"annotations"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
				<span class="token string">"TKGOperationInfo"</span> <span class="token builtin class-name">:</span> <span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>Operation<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>Create<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>OperationStartTimestamp<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>2022-02-06 02:35:34.30219421 +0000 UTC<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>OperationTimeout<span class="token entity" title="\&quot;">\"</span>:1800&#125;"</span>,
				<span class="token string">"TKGOperationLastObservedTimestamp"</span> <span class="token builtin class-name">:</span> <span class="token string">"2022-02-06 02:35:34.30219421 +0000 UTC"</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
cluster control plane is still being initialized, retrying
Getting secret <span class="token keyword">for</span> cluster
Waiting <span class="token keyword">for</span> resource tanzu-control-plan-kubeconfig of <span class="token builtin class-name">type</span> *v1.Secret to be up and running
Saving management cluster kubeconfig into /root/.kube/config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>InstallProvidersOnRegionalCluster åœ¨ç®¡ç†é›†ç¾¤ä¸Šå®‰è£… cluster-api ç›¸å…³ç»„ä»¶ï¼›</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Installing providers on management cluster<span class="token punctuation">..</span>.
Fetching providers
Installing cert-manager <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v1.1.0"</span>
Waiting <span class="token keyword">for</span> cert-manager to be available<span class="token punctuation">..</span>.
Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"cluster-api"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-system"</span>
Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"bootstrap-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-bootstrap-system"</span>
Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"control-plane-kubeadm"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.3.23"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capi-kubeadm-control-plane-system"</span>
Installing <span class="token assign-left variable">Provider</span><span class="token operator">=</span><span class="token string">"infrastructure-vsphere"</span> <span class="token assign-left variable">Version</span><span class="token operator">=</span><span class="token string">"v0.7.10"</span> <span class="token assign-left variable">TargetNamespace</span><span class="token operator">=</span><span class="token string">"capv-system"</span>
installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"cluster-api"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"CoreProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>
installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"kubeadm"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"BootstrapProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>
installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"kubeadm"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"ControlPlaneProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.3.23"</span>
installed  <span class="token assign-left variable">Component</span><span class="token operator">==</span><span class="token string">"vsphere"</span>  <span class="token assign-left variable">Type</span><span class="token operator">==</span><span class="token string">"InfrastructureProvider"</span>  <span class="token assign-left variable">Version</span><span class="token operator">==</span><span class="token string">"v0.7.10"</span>
Waiting <span class="token keyword">for</span> provider control-plane-kubeadm
Waiting <span class="token keyword">for</span> provider bootstrap-kubeadm
Waiting <span class="token keyword">for</span> provider infrastructure-vsphere
Waiting <span class="token keyword">for</span> provider cluster-api
Waiting <span class="token keyword">for</span> resource capv-controller-manager of <span class="token builtin class-name">type</span> *v1.Deployment to be up and running
Passed waiting on provider infrastructure-vsphere after <span class="token number">20</span>.091935635s
Passed waiting on provider cluster-api after <span class="token number">20</span>.109419304s
Success waiting on all providers.
Waiting <span class="token keyword">for</span> the management cluster to get ready <span class="token keyword">for</span> move<span class="token punctuation">..</span>.
Waiting <span class="token keyword">for</span> resource tanzu-control-plan of <span class="token builtin class-name">type</span> *v1alpha3.Cluster to be up and running
Waiting <span class="token keyword">for</span> resources <span class="token builtin class-name">type</span> *v1alpha3.MachineDeploymentList to be up and running
Waiting <span class="token keyword">for</span> resources <span class="token builtin class-name">type</span> *v1alpha3.MachineList to be up and running
Waiting <span class="token keyword">for</span> addons installation<span class="token punctuation">..</span>.
Waiting <span class="token keyword">for</span> resources <span class="token builtin class-name">type</span> *v1alpha3.ClusterResourceSetList to be up and running
Waiting <span class="token keyword">for</span> resource antrea-controller of <span class="token builtin class-name">type</span> *v1.Deployment to be up and running<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>MoveClusterAPIObjects å°† bootstrap é›†ç¾¤ä¸Š cluster-api ç›¸å…³çš„èµ„æºè½¬ç§»åˆ°ç®¡ç†é›†ç¾¤ä¸Šã€‚è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯ä¸ºäº†è¾¾åˆ° self-hosted è‡ªæ‰˜ç®¡çš„åŠŸèƒ½ï¼šå³ç®¡ç†é›†ç¾¤è‡ªèº«çš„æ‰©ç¼©å®¹ä¹Ÿæ˜¯é€šè¿‡ cluster-api æ¥å®Œæˆï¼Œè¿™æ ·å°±ä¸ç”¨å†ä¾èµ–å…ˆå‰çš„é‚£ä¸ª bootstrap é›†ç¾¤äº†ï¼›</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Moving all Cluster API objects from bootstrap cluster to management cluster<span class="token punctuation">..</span>.
Performing move<span class="token punctuation">..</span>.
Discovering Cluster API objects
Moving Cluster API objects <span class="token assign-left variable">Clusters</span><span class="token operator">=</span><span class="token number">1</span>
Creating objects <span class="token keyword">in</span> the target cluster
Deleting objects from the <span class="token builtin class-name">source</span> cluster
Context <span class="token builtin class-name">set</span> <span class="token keyword">for</span> management cluster tanzu-control-plan as <span class="token string">'tanzu-control-plan-admin@tanzu-control-plan'</span><span class="token builtin class-name">.</span>
Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210

Management cluster created<span class="token operator">!</span>

You can now create your first workload cluster by running the following:

  tanzu cluster create <span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token parameter variable">-f</span> <span class="token punctuation">[</span>file<span class="token punctuation">]</span>


Some addons might be getting installed<span class="token operator">!</span> Check their status by running the following:

  kubectl get apps <span class="token parameter variable">-A</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>éƒ¨ç½²å®Œæˆåä¼šåˆ é™¤ bootstrap é›†ç¾¤ï¼Œå› ä¸º bootstrap é›†ç¾¤ä¸­çš„èµ„æºå·²ç»è½¬ç§»åˆ°äº†ç®¡ç†é›†ç¾¤ä¸­ï¼Œå®ƒç»§ç»­å­˜åœ¨çš„æ„ä¹‰ä¸å¤§ã€‚</p>
<h2 id="éƒ¨ç½²-workload-é›†ç¾¤"><a href="#éƒ¨ç½²-workload-é›†ç¾¤" class="headerlink" title="éƒ¨ç½² workload é›†ç¾¤"></a>éƒ¨ç½² workload é›†ç¾¤</h2><p>ä¸Šé¢æˆ‘ä»¬åªæ˜¯éƒ¨ç½²å¥½äº†ä¸€ä¸ª tanzu ç®¡ç†é›†ç¾¤ï¼Œæˆ‘ä»¬çœŸæ­£çš„å·¥ä½œè´Ÿè½½å¹¶ä¸é€‚åˆè¿è¡Œåœ¨è¿™ä¸ªé›†ç¾¤ä¸Šï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å†éƒ¨ç½²ä¸€ä¸ª workload é›†ç¾¤ï¼Œç±»ä¼¼äº k8s é›†ç¾¤ä¸­çš„ worker èŠ‚ç‚¹ã€‚éƒ¨ç½² workload é›†ç¾¤çš„æ—¶å€™ä¸å†ä¾èµ– bootstrap é›†ç¾¤ï¼Œè€Œæ˜¯ä½¿ç”¨ç®¡ç†é›†ç¾¤ã€‚</p>
<p>æ ¹æ®å®˜æ–¹æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://tanzucommunityedition.io/docs/latest/vsphere-wl-template/">vSphere Workload Cluster Template</a> ä¸­ç»™å‡ºçš„æ¨¡ç‰ˆåˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç„¶åå†é€šè¿‡ tanzu å‘½ä»¤æ¥éƒ¨ç½²å³å¯ã€‚é…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Cluster Pod IP çš„ CIDR</span>
<span class="token key atrule">CLUSTER_CIDR</span><span class="token punctuation">:</span> 100.96.0.0/11
<span class="token comment"># Service çš„ CIDR</span>
<span class="token key atrule">SERVICE_CIDR</span><span class="token punctuation">:</span> 100.64.0.0/13
<span class="token comment"># é›†ç¾¤çš„åç§°</span>
<span class="token key atrule">CLUSTER_NAME</span><span class="token punctuation">:</span> tanzu<span class="token punctuation">-</span>workload<span class="token punctuation">-</span>cluster
<span class="token comment"># é›†ç¾¤çš„ç±»å‹</span>
<span class="token key atrule">CLUSTER_PLAN</span><span class="token punctuation">:</span> dev
<span class="token comment"># é›†ç¾¤èŠ‚ç‚¹çš„ arch</span>
<span class="token key atrule">OS_ARCH</span><span class="token punctuation">:</span> amd64
<span class="token comment"># é›†ç¾¤èŠ‚ç‚¹çš„ OS åç§°</span>
<span class="token key atrule">OS_NAME</span><span class="token punctuation">:</span> photon
<span class="token comment"># é›†ç¾¤èŠ‚ç‚¹ OS ç‰ˆæœ¬</span>
<span class="token key atrule">OS_VERSION</span><span class="token punctuation">:</span> <span class="token string">"3"</span>
<span class="token comment"># åŸºç¡€è®¾æ–½èµ„æºçš„æä¾›æ–¹</span>
<span class="token key atrule">INFRASTRUCTURE_PROVIDER</span><span class="token punctuation">:</span> vsphere
<span class="token comment"># cluster, machine ç­‰è‡ªå®šä¹‰èµ„æºåˆ›å»ºçš„ namespace</span>
<span class="token key atrule">NAMESPACE</span><span class="token punctuation">:</span> default
<span class="token comment"># CNI é€‰ç”¨ç±»å‹ï¼Œç›®å‰åº”è¯¥åªæ”¯æŒ VMware è‡ªå®¶çš„ antrea</span>
<span class="token key atrule">CNI</span><span class="token punctuation">:</span> antrea

<span class="token comment"># é›†ç¾¤çš„ VIP</span>
<span class="token key atrule">VSPHERE_CONTROL_PLANE_ENDPOINT</span><span class="token punctuation">:</span> 192.168.20.95
<span class="token comment"># control-plan èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span>
<span class="token key atrule">VSPHERE_CONTROL_PLANE_DISK_GIB</span><span class="token punctuation">:</span> <span class="token string">"20"</span>
<span class="token comment"># control-plan èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span>
<span class="token key atrule">VSPHERE_CONTROL_PLANE_MEM_MIB</span><span class="token punctuation">:</span> <span class="token string">"8192"</span>
<span class="token comment"># control-plan èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span>
<span class="token key atrule">VSPHERE_CONTROL_PLANE_NUM_CPUS</span><span class="token punctuation">:</span> <span class="token string">"4"</span>
<span class="token comment"># work èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span>
<span class="token key atrule">VSPHERE_WORKER_DISK_GIB</span><span class="token punctuation">:</span> <span class="token string">"20"</span>
<span class="token comment"># work èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span>
<span class="token key atrule">VSPHERE_WORKER_MEM_MIB</span><span class="token punctuation">:</span> <span class="token string">"4096"</span>
<span class="token comment"># work èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span>
<span class="token key atrule">VSPHERE_WORKER_NUM_CPUS</span><span class="token punctuation">:</span> <span class="token string">"2"</span>

<span class="token comment"># vCenter çš„ Datacenter è·¯å¾„</span>
<span class="token key atrule">VSPHERE_DATACENTER</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC
<span class="token comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„ Datastore è·¯å¾„</span>
<span class="token key atrule">VSPHERE_DATASTORE</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/datastore/datastore1
<span class="token comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„æ–‡ä»¶å¤¹</span>
<span class="token key atrule">VSPHERE_FOLDER</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/vm/Tanzu<span class="token punctuation">-</span>node
<span class="token comment"># è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œ</span>
<span class="token key atrule">VSPHERE_NETWORK</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/network/VM Network
<span class="token comment"># è™šæ‹Ÿæœºå…³è”çš„èµ„æºæ± </span>
<span class="token key atrule">VSPHERE_RESOURCE_POOL</span><span class="token punctuation">:</span> /SH<span class="token punctuation">-</span>IDC/host/Tanzu<span class="token punctuation">-</span>Cluster/Resources

<span class="token comment"># vCenter çš„ IP</span>
<span class="token key atrule">VSPHERE_SERVER</span><span class="token punctuation">:</span> 192.168.20.92
<span class="token comment"># vCenter çš„ç”¨æˆ·å</span>
<span class="token key atrule">VSPHERE_USERNAME</span><span class="token punctuation">:</span> administrator@vsphere.local
<span class="token comment"># vCenter çš„å¯†ç ï¼Œä»¥ base64 ç¼–ç </span>
<span class="token key atrule">VSPHERE_PASSWORD</span><span class="token punctuation">:</span> &lt;encoded<span class="token punctuation">:</span>YWRtaW5AMjAyMA==<span class="token punctuation">></span>
<span class="token comment"># vCenter çš„è¯ä¹¦æŒ‡çº¹ï¼Œå¯ä»¥é€šè¿‡ govc about.cert -json | jq -r '.ThumbprintSHA1' è·å–</span>
<span class="token key atrule">VSPHERE_TLS_THUMBPRINT</span><span class="token punctuation">:</span> CB<span class="token punctuation">:</span>23<span class="token punctuation">:</span>48<span class="token punctuation">:</span>E8<span class="token punctuation">:</span>93<span class="token punctuation">:</span>34<span class="token punctuation">:</span>AD<span class="token punctuation">:</span>27<span class="token punctuation">:</span>D8<span class="token punctuation">:</span>FD<span class="token punctuation">:</span>88<span class="token punctuation">:</span>1C<span class="token punctuation">:</span>D7<span class="token punctuation">:</span>08<span class="token punctuation">:</span>4B<span class="token punctuation">:</span>47<span class="token punctuation">:</span>9B<span class="token punctuation">:</span>12<span class="token punctuation">:</span>F4<span class="token punctuation">:</span>E0
<span class="token comment"># è™šæ‹Ÿæœºæ³¨å…¥çš„ ssh å…¬é’¥ï¼Œéœ€è¦ç”¨å®ƒæ¥ ssh ç™»å½•é›†ç¾¤èŠ‚ç‚¹</span>
<span class="token key atrule">VSPHERE_SSH_AUTHORIZED_KEY</span><span class="token punctuation">:</span> ssh<span class="token punctuation">-</span>rsa

<span class="token comment"># ä¸€äº›é»˜è®¤å‚æ•°</span>
<span class="token key atrule">AVI_ENABLE</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
<span class="token key atrule">IDENTITY_MANAGEMENT_TYPE</span><span class="token punctuation">:</span> none
<span class="token key atrule">ENABLE_AUDIT_LOGGING</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
<span class="token key atrule">ENABLE_CEIP_PARTICIPATION</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
<span class="token key atrule">TKG_HTTP_PROXY_ENABLED</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
<span class="token key atrule">DEPLOY_TKG_ON_VSPHERE7</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
<span class="token comment"># æ˜¯å¦å¼€å¯è™šæ‹Ÿæœºå¥åº·æ£€æŸ¥</span>
<span class="token key atrule">ENABLE_MHC</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">MHC_UNKNOWN_STATUS_TIMEOUT</span><span class="token punctuation">:</span> 5m
<span class="token key atrule">MHC_FALSE_STATUS_TIMEOUT</span><span class="token punctuation">:</span> 12m
<span class="token comment"># æ˜¯å¦éƒ¨ç½² vsphere cis ç»„ä»¶</span>
<span class="token key atrule">ENABLE_DEFAULT_STORAGE_CLASS</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token comment"># æ˜¯å¦å¼€å¯é›†ç¾¤è‡ªåŠ¨æ‰©ç¼©å®¹</span>
<span class="token key atrule">ENABLE_AUTOSCALER</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>é€šè¿‡ tanzu å‘½ä»¤æ¥éƒ¨ç½² workload é›†ç¾¤</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># tanzu cluster create tanzu-workload-cluster --file tanzu-workload-cluster.yaml</span>
Validating configuration<span class="token punctuation">..</span>.
Warning: Pinniped configuration not found. Skipping pinniped configuration <span class="token keyword">in</span> workload cluster. Please refer to the documentation to check <span class="token keyword">if</span> you can configure pinniped on workload cluster manually
Creating workload cluster <span class="token string">'tanzu-workload-cluster'</span><span class="token punctuation">..</span>.
Waiting <span class="token keyword">for</span> cluster to be initialized<span class="token punctuation">..</span>.
Waiting <span class="token keyword">for</span> cluster nodes to be available<span class="token punctuation">..</span>.
Waiting <span class="token keyword">for</span> cluster autoscaler to be available<span class="token punctuation">..</span>.
Unable to <span class="token function">wait</span> <span class="token keyword">for</span> autoscaler deployment to be ready. reason: deployments.apps <span class="token string">"tanzu-workload-cluster-cluster-autoscaler"</span> not found
Waiting <span class="token keyword">for</span> addons installation<span class="token punctuation">..</span>.
Waiting <span class="token keyword">for</span> packages to be up and running<span class="token punctuation">..</span>.
Workload cluster <span class="token string">'tanzu-workload-cluster'</span> created<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>éƒ¨ç½²å®Œæˆä¹‹åæŸ¥çœ‹ä¸€ä¸‹é›†ç¾¤çš„ CR ä¿¡æ¯</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get cluster</span>
NAME                     PHASE
tanzu-workload-cluster   Provisioned
<span class="token comment"># machine çŠ¶æ€å¤„äº Running è¯´æ˜èŠ‚ç‚¹å·²ç»æ­£å¸¸è¿è¡Œäº†</span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get machine</span>
NAME                                          PROVIDERID                                       PHASE     VERSION
tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1
tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="æ‰©å®¹é›†ç¾¤"><a href="#æ‰©å®¹é›†ç¾¤" class="headerlink" title="æ‰©å®¹é›†ç¾¤"></a>æ‰©å®¹é›†ç¾¤</h2><p>é›†ç¾¤éƒ¨ç½²å¥½ä¹‹åï¼Œå¦‚æœæƒ³å¯¹é›†ç¾¤èŠ‚ç‚¹è¿›è¡Œæ‰©ç¼©å®¹ï¼Œæˆ‘ä»¬å¯ä»¥åƒ deployment çš„ä¸€æ ·ï¼Œåªéœ€è¦ä¿®æ”¹ä¸€äº› CR çš„ä¿¡æ¯å³å¯ã€‚cluster-api ç›¸å…³ç»„ä»¶ä¼š watch åˆ°è¿™äº› CR çš„å˜åŒ–ï¼Œå¹¶æ ¹æ®å®ƒçš„ spec ä¿¡æ¯è¿›è¡Œä¸€ç³»åˆ—è°ƒè°æ“ä½œã€‚å¦‚æœå½“å‰é›†ç¾¤èŠ‚ç‚¹æ•°é‡ä½äºæ‰€å®šä¹‰çš„èŠ‚ç‚¹å‰¯æœ¬æ•°é‡ï¼Œåˆ™ä¼šè‡ªåŠ¨è°ƒç”¨å¯¹åº”çš„ Provider åˆ›å»ºè™šæ‹Ÿæœºï¼Œå¹¶å¯¹è™šæ‹Ÿæœºè¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œå°†å®ƒè½¬æ¢ä¸º k8s é‡Œçš„ä¸€ä¸ª node èµ„æºï¼›</p>
<h3 id="æ‰©å®¹-control-plan-èŠ‚ç‚¹"><a href="#æ‰©å®¹-control-plan-èŠ‚ç‚¹" class="headerlink" title="æ‰©å®¹ control-plan èŠ‚ç‚¹"></a>æ‰©å®¹ control-plan èŠ‚ç‚¹</h3><p>å³æ‰©å®¹ master èŠ‚ç‚¹ï¼Œé€šè¿‡ä¿®æ”¹ <code>KubeadmControlPlane</code> è¿™ä¸ª CR ä¸­çš„ <code>replicas</code> å‰¯æœ¬æ•°å³å¯ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl scale kcp tanzu-workload-cluster-control-plane --replicas=3</span>
<span class="token comment"># å¯ä»¥çœ‹åˆ° machine å·²ç»å¤„äº Provisioning çŠ¶æ€ï¼Œè¯´æ˜é›†ç¾¤èŠ‚ç‚¹å¯¹åº”çš„è™šæ‹Ÿæœºæ­£åœ¨åˆ›å»ºä¸­</span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get machine</span>
NAME                                          PROVIDERID                                       PHASE          VERSION
tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running        v1.21.2+vmware.1
tanzu-workload-cluster-control-plane-mkmd2                                                     Provisioning   v1.21.2+vmware.1
tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running        v1.21.2+vmware.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="æ‰©å®¹-work-èŠ‚ç‚¹"><a href="#æ‰©å®¹-work-èŠ‚ç‚¹" class="headerlink" title="æ‰©å®¹ work èŠ‚ç‚¹"></a>æ‰©å®¹ work èŠ‚ç‚¹</h3><p>æ‰©å®¹ worker èŠ‚ç‚¹ï¼Œé€šè¿‡ä¿®æ”¹ <code>MachineDeployment</code> è¿™ä¸ª CR ä¸­çš„ <code>replicas</code> å‰¯æœ¬æ•°å³å¯ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl scale md tanzu-workload-cluster-md-0 --replicas=3</span>
root@photon-machine <span class="token punctuation">[</span> ~ <span class="token punctuation">]</span><span class="token comment"># kubectl get machine</span>
NAME                                          PROVIDERID                                       PHASE     VERSION
tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1
tanzu-workload-cluster-control-plane-mkmd2    vsphere://4239278c-0503-f03a-08b8-df92286bcdd7   Running   v1.21.2+vmware.1
tanzu-workload-cluster-control-plane-rt5mb    vsphere://4239c882-2fe5-a394-60c0-616941a6363e   Running   v1.21.2+vmware.1
tanzu-workload-cluster-md-0-8555bbbfc-4hlqk   vsphere://42395deb-e706-8b4b-a44f-c755c222575c   Running   v1.21.2+vmware.1
tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1
tanzu-workload-cluster-md-0-8555bbbfc-ftmlp   vsphere://42399640-8e94-85e5-c4bd-8436d84966e0   Running   v1.21.2+vmware.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h2><p>æœ¬æ–‡åªæ˜¯ä»‹ç»äº† tanzu é›†ç¾¤éƒ¨ç½²çš„å¤§ä½“æµç¨‹ï¼Œé‡Œé¢åŒ…å«äº† cluster-api ç›¸å…³çš„æ¦‚å¿µåœ¨æœ¬æ–‡å¹¶æ²¡æœ‰åšæ·±å…¥çš„åˆ†æï¼Œå› ä¸ºå®åœ¨æ˜¯å¤ªå¤æ‚äº† ğŸ˜‚ï¼Œåˆ°ç°åœ¨æˆ‘è¿˜æ˜¯æ²¡å¤ªç†è§£å…¶ä¸­çš„ä¸€äº›åŸç†ï¼Œå› æ­¤åç»­æˆ‘å†å•ç‹¬å†™ä¸€ç¯‡åšå®¢æ¥è®²è§£ä¸€äº› cluster-api ç›¸å…³çš„å†…å®¹ï¼Œåˆ°é‚£æ—¶å€™åœ¨ç»“åˆæœ¬æ–‡æ¥çœ‹å°±å®¹æ˜“ç†è§£å¾ˆå¤šã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/community-edition">community-edition</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/vmware/photon">vmware&#x2F;photon</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go">tanzu-framework</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/cluster-api-provider-vsphere">cluster-api-provider-vsphere</a></li>
<li><a target="_blank" rel="noopener" href="https://tanzucommunityedition.io/docs/latest/workload-clusters/">Deploying a workload cluster</a></li>
<li><a target="_blank" rel="noopener" href="https://tanzucommunityedition.io/docs/latest/verify-deployment/">Examine the Management Cluster Deployment</a></li>
<li><a target="_blank" rel="noopener" href="https://tanzucommunityedition.io/docs/latest/vsphere/">Prepare to Deploy a Management or Standalone Clusters to vSphere</a></li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ESXi/" rel="tag"># ESXi</a>
              <a href="/tags/Tanzu/" rel="tag"># Tanzu</a>
              <a href="/tags/Kubernetes/" rel="tag"># Kubernetes</a>
              <a href="/tags/Cluster-api/" rel="tag"># Cluster-api</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/rebuild-iso-image.html" rel="prev" title="ä½¿ç”¨ overlay2 æˆ– bind é‡æ–°æ„å»º ISO é•œåƒ">
                  <i class="fa fa-chevron-left"></i> ä½¿ç”¨ overlay2 æˆ– bind é‡æ–°æ„å»º ISO é•œåƒ
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/archive-argo-workflow-log-by-kubectl.html" rel="next" title="ä½¿ç”¨ kubectl è‡ªåŠ¨å½’æ¡£ argo workflow æ—¥å¿—">
                  ä½¿ç”¨ kubectl è‡ªåŠ¨å½’æ¡£ argo workflow æ—¥å¿— <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">26:28</span>
  </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
