<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.k8s.li').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="之前接触的 Kubernetes 集群部署工具大多数都是依赖于 ssh 连接到待部署的节点上进行部署操作，这样就要求部署前需要提前准备好集群节点，且要保证这些节点的网络互通以及时钟同步等问题。类似于 kubespray 或者 kubekey 这些部署工具是不会去管这些底层的 IaaS 资源的创建，是要自己提前准备好。但是在一些企业私有云环境中，使用了如 VMware vShpere 或 OpenS">
<meta property="og:type" content="article">
<meta property="og:title" content="VMware Tanzu kubernetes 发行版部署尝鲜">
<meta property="og:url" content="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="之前接触的 Kubernetes 集群部署工具大多数都是依赖于 ssh 连接到待部署的节点上进行部署操作，这样就要求部署前需要提前准备好集群节点，且要保证这些节点的网络互通以及时钟同步等问题。类似于 kubespray 或者 kubekey 这些部署工具是不会去管这些底层的 IaaS 资源的创建，是要自己提前准备好。但是在一些企业私有云环境中，使用了如 VMware vShpere 或 OpenS">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/2022-01-22-deploy-tanzu-k8s-cluster-01.jpg">
<meta property="article:published_time" content="2022-02-05T16:00:00.000Z">
<meta property="article:modified_time" content="2022-02-05T16:00:00.000Z">
<meta property="article:author" content="木子">
<meta property="article:tag" content="ESXi">
<meta property="article:tag" content="Tanzu">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Cluster-api">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/2022-01-22-deploy-tanzu-k8s-cluster-01.jpg">

<link rel="canonical" href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>VMware Tanzu kubernetes 发行版部署尝鲜 | Reimu's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Reimu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-desktop"></i>Home</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Books</a>

  </li>
        <li class="menu-item menu-item-kindle">

    <a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>

  </li>
        <li class="menu-item menu-item-friends">

    <a href="/friends.html" rel="section"><i class="fa fa-fw fa-link"></i>Friends</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about.html" rel="section"><i class="fa fa-fw fa-user-circle-o"></i>About</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog.k8s.li/avatar.png">
      <meta itemprop="name" content="木子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          VMware Tanzu kubernetes 发行版部署尝鲜
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-06 2022-02-06T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2022-02-06T00:00:00+08:00">2022-02-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/deploy-tanzu-k8s-cluster.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="deploy-tanzu-k8s-cluster.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>36k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>59 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>之前接触的 Kubernetes 集群部署工具大多数都是依赖于 ssh 连接到待部署的节点上进行部署操作，这样就要求部署前需要提前准备好集群节点，且要保证这些节点的网络互通以及时钟同步等问题。类似于 kubespray 或者 kubekey 这些部署工具是不会去管这些底层的 IaaS 资源的创建，是要自己提前准备好。但是在一些企业私有云环境中，使用了如 <a href="https://docs.vmware.com/cn/VMware-vSphere/index.html" target="_blank" rel="noopener">VMware vShpere</a> 或 <a href="https://www.openstack.org/" target="_blank" rel="noopener">OpenStack</a> 这些虚拟化平台，是可以将 K8s 集群部署与 IaaS 资源创建这两步统一起来的，这样就可以避免手动创建和配置虚拟机这些繁琐的步骤。</p>
<p>目前将 IaaS 资源创建与 K8s 集群部署结合起来也有比较成熟的方案，比如基于 <a href="https://github.com/kubernetes-sigs/cluster-api" target="_blank" rel="noopener">cluster-api</a> 项目的 <a href="https://github.com/vmware-tanzu" target="_blank" rel="noopener">tanzu</a> 。本文就以 <a href="https://github.com/vmware-tanzu/community-edition" target="_blank" rel="noopener">VMware Tanzu 社区版</a> 为例在一台物理服务器上，从安装 ESXi OS 到部署完成 Tanzu Workload 集群，来体验一下这种部署方案的与众不同之处。</p>
<h2 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h2><ul>
<li>下载依赖文件</li>
<li>安装 govc 依赖</li>
<li>安装 ESXi OS</li>
<li>安装 vCenter</li>
<li>配置 vCenter</li>
<li>创建 bootstrap 虚拟机</li>
<li>初始化 bootstrap 节点</li>
<li>部署 Tanzu Manager 集群</li>
<li>部署 Tanzu Workload 集群</li>
</ul>
<h3 id="劝退三连-😂"><a href="#劝退三连-😂" class="headerlink" title="劝退三连 😂"></a>劝退三连 😂</h3><ul>
<li><p>需要有一个 <a href="https://customerconnect.vmware.com/login" target="_blank" rel="noopener">VMware 的账户</a> 用于下载一些 ISO 镜像和虚拟机模版;</p>
</li>
<li><p>需要有一台物理服务器，推荐最低配置 8C 32G，至少 256GB 存储；</p>
</li>
<li><p>需要一台 DHCP 服务器，由于默认是使用 DHCP 获取 IP 来分配给虚拟机的，因此 ESXi 所在的 VM Network  网络中必须有一台 DHCP 服务器用于给虚拟机分配 IP；</p>
</li>
</ul>
<h3 id="下载依赖文件"><a href="#下载依赖文件" class="headerlink" title="下载依赖文件"></a>下载依赖文件</h3><p>整个部署流程所需要的依文件赖如下，可以先将这些依赖下载到本地的机器上，方便后续使用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@devbox:/root/tanzu <span class="comment"># tree -sh</span></span><br><span class="line">.</span><br><span class="line">├── [  12M]  govc_Linux_x86_64.tar.gz</span><br><span class="line">├── [ 895M]  photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</span><br><span class="line">├── [ 225M]  photon-ova-4.0-c001795b80.ova</span><br><span class="line">├── [ 170M]  tce-linux-amd64-v0.9.1.tar.gz</span><br><span class="line">├── [ 9.0G]  VMware-VCSA-all-7.0.3-18778458.iso</span><br><span class="line">└── [ 390M]  VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>文件</th>
<th>用途</th>
<th>下载方式</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=ESXI70U2A&productId=974&rPId=46384" target="_blank" rel="noopener">VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso</a></td>
<td>安装 ESXi OS</td>
<td>VMware 需账户</td>
</tr>
<tr>
<td><a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=VC70U3C&productId=974&rPId=83853" target="_blank" rel="noopener">VMware-VCSA-all-7.0.3-19234570.iso</a></td>
<td>安装 vCenter</td>
<td>VMware 需账户</td>
</tr>
<tr>
<td><a href="https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova" target="_blank" rel="noopener">photon-ova-4.0-c001795b80.ova</a></td>
<td>bootstrap 节点</td>
<td>VMware</td>
</tr>
<tr>
<td><a href="https://customerconnect.vmware.com/downloads/get-download?downloadGroup=TCE-090" target="_blank" rel="noopener">photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</a></td>
<td>tanzu 集群节点</td>
<td>VMware 需账户</td>
</tr>
<tr>
<td><a href="https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz" target="_blank" rel="noopener">tce-linux-amd64-v0.9.1.tar.gz</a></td>
<td>tanzu 社区版</td>
<td>GitHub release</td>
</tr>
<tr>
<td><a href="https://github.com/vmware/govmomi/releases/download/v0.27.3/govc_Linux_x86_64.tar.gz" target="_blank" rel="noopener">govc_Linux_x86_64.tar.gz</a></td>
<td>安装/配置 vCenter</td>
<td>GitHub release</td>
</tr>
</tbody></table>
<p>注意 ESXi 和 vCenter 的版本最好是 7.0 及以上，我只在 ESXi 7.0.2 和 vCenter 7.0.3 上测试过，其他版本可能会有些差异；另外 ESXi 的版本不建议使用最新的 7.0.3，因为有比较严重的 bug，官方也建议用户生产环境不要使用该版本了 <a href="https://kb.vmware.com/s/article/86287" target="_blank" rel="noopener">vSphere 7.0 Update 3 Critical Known Issues - Workarounds &amp; Fix (86287)</a> 。</p>
<h3 id="安装-govc-及依赖"><a href="#安装-govc-及依赖" class="headerlink" title="安装 govc 及依赖"></a>安装 govc 及依赖</h3><p>在本地机器上安装好 govc 和 jq，这两个工具后面在配置 vCenter 的时候会用到。</p>
<ul>
<li>macOS</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install govc jq</span><br></pre></td></tr></table></figure>

<ul>
<li>Debian/Ubuntu</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tar -xf govc_Linux_x86_64.tar.gz -C /usr/<span class="built_in">local</span>/bin</span><br><span class="line">$ apt install jq -y</span><br></pre></td></tr></table></figure>

<ul>
<li>其他 Linux 可以在 govc 和 jq 的 GitHub 上下载对应的安装文件进行安装。</li>
</ul>
<h3 id="安装-ESXi-OS"><a href="#安装-ESXi-OS" class="headerlink" title="安装 ESXi OS"></a>安装 ESXi OS</h3><p>ESXi OS 的安装网上有很多教程，没有太多值得讲解的地方，因此就参照一下其他大佬写的博客或者官方的安装文档 <a href="https://docs.vmware.com/cn/VMware-vSphere/7.0/vsphere-esxi-701-installation-setup-guide.pdf" target="_blank" rel="noopener">VMware ESXi 安装和设置</a> 来就行；需要注意一点，ESXi OS 安装时 VMFSL 分区将会占用大量的存储空间，这将会使得 ESXi OS 安装所在的磁盘最终创建出来的 datastore 比预期小很多，而且这个 VMFSL 分区在安装好之后就很难再做调整了。因此如果磁盘存储空间比较紧张，在安装 ESXi OS 之前可以考虑下如何去掉这个分区；或者和我一样将 ESXI OS 安装在了一个 16G 的 USB Dom 盘上，不过生产环境不建议采用这种方案 😂（其实个人觉着安装在 U 盘上问题不大，ESXi OS 启动之后是加载到内存中运行的，不会对 U 盘有大量的读写操作，只不过在机房中 U 盘被人不小心拔走就凉了。</p>
<ul>
<li>设置 govc 环境变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ESXi 节点的 IP</span></span><br><span class="line"><span class="built_in">export</span> ESXI_IP=<span class="string">"192.168.18.47"</span></span><br><span class="line"><span class="comment"># ESXi 登录的用户名，初次安装后默认为 root</span></span><br><span class="line"><span class="built_in">export</span> GOVC_USERNAME=<span class="string">"root"</span></span><br><span class="line"><span class="comment"># 在 ESXi 安装时设置的 root 密码</span></span><br><span class="line"><span class="built_in">export</span> GOVC_PASSWORD=<span class="string">"admin@2022"</span></span><br><span class="line"><span class="comment"># 允许不安全的 SSL 连接</span></span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://<span class="variable">$&#123;ESXI_IP&#125;</span>"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=datastore1</span><br></pre></td></tr></table></figure>

<ul>
<li>测试 govc 是否能正常连接 ESXi 主机</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Name:              localhost.local</span><br><span class="line">  Path:            /ha-datacenter/host/localhost/localhost</span><br><span class="line">  Manufacturer:    Dell</span><br><span class="line">  Logical CPUs:    20 CPUs @ 2394MHz</span><br><span class="line">  Processor <span class="built_in">type</span>:  Intel(R) Xeon(R) Silver 4210R CPU @ 2.40GHz</span><br><span class="line">  CPU usage:       579 MHz (1.2%)</span><br><span class="line">  Memory:          261765MB</span><br><span class="line">  Memory usage:    16457 MB (6.3%)</span><br><span class="line">  Boot time:       2022-02-02 11:53:59.630124 +0000 UTC</span><br><span class="line">  State:           connected</span><br></pre></td></tr></table></figure>

<h3 id="安装-vCenter"><a href="#安装-vCenter" class="headerlink" title="安装 vCenter"></a>安装 vCenter</h3><p>按照 VMware 官方的 vCenter 安装文档 <a href="https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vcenter.install.doc/GUID-8DC3866D-5087-40A2-8067-1361A2AF95BD.html" target="_blank" rel="noopener">关于 vCenter Server 安装和设置</a> 来安装实在是过于繁琐，其实官方的 ISO 安装方式无非是运行一个 installer web 服务，然后在浏览器上配置好 vCenter 虚拟机的参数，再将填写的配置信息在部署 vcsa 虚拟机的时候注入到 ova 的配置参数中。</p>
<p>知道这个安装过程的原理之后我们也可以自己配置 vCenter 的参数信息，然后通过 govc 来部署 ova；这比使用 UI 的方式简单方便很多，最终只需要填写一个配置文件，一条命令就可以部署完成啦。</p>
<ul>
<li>首先是挂载 vCenter 的 ISO，找到 vcsa ova 文件，它是 vCenter 虚拟机的模版</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mount -o loop VMware-VCSA-all-7.0.3-18778458.iso /mnt</span><br><span class="line">$ ls /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova</span><br><span class="line">/mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova</span><br></pre></td></tr></table></figure>

<ul>
<li>根据自己的环境信息修改下面安装脚本中的相关配置：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">VCSA_OVA_FILE=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -o errexit</span><br><span class="line"><span class="built_in">set</span> -o nounset</span><br><span class="line"><span class="built_in">set</span> -o pipefail</span><br><span class="line"></span><br><span class="line"><span class="comment"># ESXi 的 IP 地址</span></span><br><span class="line"><span class="built_in">export</span> ESXI_IP=<span class="string">"192.168.18.47"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ESXi 的用户名</span></span><br><span class="line"><span class="built_in">export</span> GOVC_USERNAME=<span class="string">"root"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ESXI 的密码</span></span><br><span class="line"><span class="built_in">export</span> GOVC_PASSWORD=<span class="string">"admin@2020"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 vCenter 虚拟机使用的 datastore 名称</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=datastore1</span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://<span class="variable">$&#123;ESXI_IP&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter 的登录密码</span></span><br><span class="line">VM_PASSWORD=<span class="string">"admin@2020"</span></span><br><span class="line"><span class="comment"># vCenter 的 IP 地址</span></span><br><span class="line">VM_IP=192.168.20.92</span><br><span class="line"><span class="comment"># vCenter 虚拟机的名称</span></span><br><span class="line">VM_NAME=vCenter-Server-Appliance</span><br><span class="line"><span class="comment"># vCenter 虚拟机使用的网络</span></span><br><span class="line">VM_NETWORK=<span class="string">"VM Network"</span></span><br><span class="line"><span class="comment"># DNS 服务器</span></span><br><span class="line">VM_DNS=<span class="string">"223.6.6.6"</span></span><br><span class="line"><span class="comment"># NTP 服务器</span></span><br><span class="line">VM_NTP=<span class="string">"0.pool.ntp.org"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">deploy_vcsa_vm</span></span>()&#123;</span><br><span class="line">    config=$(govc host.info -k -json | jq -r <span class="string">'.HostSystems[].Config'</span>)</span><br><span class="line">    gateway=$(jq -r <span class="string">'.Network.IpRouteConfig.DefaultGateway'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$config</span>"</span>)</span><br><span class="line">    route=$(jq -r <span class="string">'.Network.RouteTableInfo.IpRoute[] | select(.DeviceName == "vmk0") | select(.Gateway == "0.0.0.0")'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$config</span>"</span>)</span><br><span class="line">    prefix=$(jq -r <span class="string">'.PrefixLength'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$route</span>"</span>)</span><br><span class="line">    opts=(</span><br><span class="line">        cis.vmdir.password=<span class="variable">$&#123;VM_PASSWORD&#125;</span></span><br><span class="line">        cis.appliance.root.passwd=<span class="variable">$&#123;VM_PASSWORD&#125;</span></span><br><span class="line">        cis.appliance.root.shell=/bin/bash</span><br><span class="line">        cis.deployment.node.type=embedded</span><br><span class="line">        cis.vmdir.domain-name=vsphere.local</span><br><span class="line">        cis.vmdir.site-name=VCSA</span><br><span class="line">        cis.appliance.net.addr.family=ipv4</span><br><span class="line">        cis.appliance.ssh.enabled=True</span><br><span class="line">        cis.ceip_enabled=False</span><br><span class="line">        cis.deployment.autoconfig=True</span><br><span class="line">        cis.appliance.net.addr=<span class="variable">$&#123;VM_IP&#125;</span></span><br><span class="line">        cis.appliance.net.prefix=<span class="variable">$&#123;prefix&#125;</span></span><br><span class="line">        cis.appliance.net.dns.servers=<span class="variable">$&#123;VM_DNS&#125;</span></span><br><span class="line">        cis.appliance.net.gateway=<span class="variable">$gateway</span></span><br><span class="line">        cis.appliance.ntp.servers=<span class="string">"<span class="variable">$&#123;VM_NTP&#125;</span>"</span></span><br><span class="line">        cis.appliance.net.mode=static</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    props=$(<span class="built_in">printf</span> -- <span class="string">"guestinfo.%s\n"</span> <span class="string">"<span class="variable">$&#123;opts[@]&#125;</span>"</span> | jq --slurp -R <span class="string">'split("\n") | map(select(. != "")) | map(split("=")) | map(&#123;"Key": .[0], "Value": .[1]&#125;)'</span>)</span><br><span class="line"></span><br><span class="line">    cat &lt;&lt;EOF | govc import.<span class="variable">$&#123;VCSA_OVA_FILE##*.&#125;</span> -options - <span class="string">"<span class="variable">$&#123;VCSA_OVA_FILE&#125;</span>"</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span>,</span><br><span class="line">    <span class="string">"Deployment"</span>: <span class="string">"tiny"</span>,</span><br><span class="line">    <span class="string">"DiskProvisioning"</span>: <span class="string">"thin"</span>,</span><br><span class="line">    <span class="string">"IPProtocol"</span>: <span class="string">"IPv4"</span>,</span><br><span class="line">    <span class="string">"Annotation"</span>: <span class="string">"VMware vCenter Server Appliance"</span>,</span><br><span class="line">    <span class="string">"PowerOn"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"WaitForIP"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"InjectOvfEnv"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"NetworkMapping"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"Network 1"</span>,</span><br><span class="line">        <span class="string">"Network"</span>: <span class="string">"<span class="variable">$&#123;VM_NETWORK&#125;</span>"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"PropertyMapping"</span>: <span class="variable">$&#123;props&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">deploy_vcsa_vm</span><br><span class="line">govc vm.change -vm <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span> -g vmwarePhoton64Guest</span><br><span class="line">govc vm.power -on <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span></span><br><span class="line">govc vm.ip -a <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>通过脚本安装 vCenter，指定第一参数为 OVA 的绝对路径。运行完后将会自动将 ova 导入到 vCenter，并启动虚拟机；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行该脚本，第一个参数传入 vCenter ISO 中 vcsa ova 文件的绝对路径</span></span><br><span class="line">$ bash install-vcsa.sh /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova</span><br><span class="line"></span><br><span class="line">[03-02-22 18:40:19] Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk1.vmdk... OK</span><br><span class="line">[03-02-22 18:41:09] Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk... (29%, 52.5MiB/s)</span><br><span class="line">[03-02-22 18:43:08] Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk... OK</span><br><span class="line">[03-02-22 18:43:08] Injecting OVF environment...</span><br><span class="line">Powering on VirtualMachine:3... OK</span><br><span class="line">fe80::20c:29ff:fe03:2f80</span><br></pre></td></tr></table></figure>

<ul>
<li>设置 vCenter 登录的环境变量，我们使用 govc 来配置 vCenter，通过浏览器 Web UI 的方式配置起来效率有点低，不如 govc 命令一把梭方便 😂</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://192.168.20.92"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_USERNAME=<span class="string">"administrator@vsphere.local"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_PASSWORD=<span class="string">"admin@2022"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=datastore1</span><br></pre></td></tr></table></figure>

<ul>
<li>虚拟机启动后将自动进行 vCenter 的安装配置，等待一段时间 vCenter 安装好之后，使用 govc about 查看 vCenter 的信息，如果能正确或渠道说明 vCenter 就安装好了；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ govc about</span><br><span class="line">FullName:     VMware vCenter Server 7.0.3 build-18778458</span><br><span class="line">Name:         VMware vCenter Server</span><br><span class="line">Vendor:       VMware, Inc.</span><br><span class="line">Version:      7.0.3</span><br><span class="line">Build:        18778458</span><br><span class="line">OS <span class="built_in">type</span>:      linux-x64</span><br><span class="line">API <span class="built_in">type</span>:     VirtualCenter</span><br><span class="line">API version:  7.0.3.0</span><br><span class="line">Product ID:   vpx</span><br><span class="line">UUID:         0b49e119-e38f-4fbc-84a8-d7a0e548027d</span><br></pre></td></tr></table></figure>

<h3 id="配置-vCenter"><a href="#配置-vCenter" class="headerlink" title="配置 vCenter"></a>配置 vCenter</h3><p>这一步骤主要是配置 vCenter：创建 Datacenter、cluster、folder 等资源，并将 ESXi 主机添加到 cluster 中；</p>
<ul>
<li>配置 vCenter</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 Datacenter 数据中心</span></span><br><span class="line">$ govc datacenter.create SH-IDC</span><br><span class="line"><span class="comment"># 创建 Cluster 集群</span></span><br><span class="line">$ govc cluster.create -dc=SH-IDC Tanzu-Cluster</span><br><span class="line"><span class="comment"># 将 ESXi 主机添加到 Cluster 当中</span></span><br><span class="line">$ govc cluster.add -dc=SH-IDC -cluster=Tanzu-Cluster -hostname=192.168.18.47 --username=root -password=<span class="string">'admin@2020'</span> -noverify</span><br><span class="line"><span class="comment"># 创建 folder，用于将 Tanzu 的节点虚拟机存放到该文件夹下</span></span><br><span class="line">$ govc folder.create /SH-IDC/vm/Tanzu-node</span><br><span class="line"><span class="comment"># 导入 tanzu 汲取节点的虚拟机 ova 模版</span></span><br><span class="line">$ govc import.ova -dc=<span class="string">'SH-IDC'</span> -ds=<span class="string">'datastore1'</span> photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</span><br><span class="line"><span class="comment"># 将虚拟机转换为模版，后续 tanzu 集群将以该模版创建虚拟机</span></span><br><span class="line">$ govc vm.markastemplate photon-3-kube-v1.21.2</span><br></pre></td></tr></table></figure>

<h3 id="初始化-bootstrap-节点"><a href="#初始化-bootstrap-节点" class="headerlink" title="初始化 bootstrap 节点"></a>初始化 bootstrap 节点</h3><p>bootstrap 节点节点是用于运行 tanzu 部署工具的节点，官方是支持 Linux/macOS/Windows 三种操作系统的，但有一些比较严格的要求：</p>
<table>
<thead>
<tr>
<th>Arch: x86; ARM is currently unsupported</th>
</tr>
</thead>
<tbody><tr>
<td>RAM: 6 GB</td>
</tr>
<tr>
<td>CPU: 2</td>
</tr>
<tr>
<td><a href="https://docs.docker.com/engine/install/" target="_blank" rel="noopener">Docker</a> Add your non-root user account to the docker user group. Create the group if it does not already exist. This lets the Tanzu CLI access the Docker socket, which is owned by the root user. For more information, see steps 1 to 4 in the <a href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user" target="_blank" rel="noopener">Manage Docker as a non-root user</a> procedure in the Docker documentation.</td>
</tr>
<tr>
<td><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/" target="_blank" rel="noopener">Kubectl</a></td>
</tr>
<tr>
<td>Latest version of Chrome, Firefox, Safari, Internet Explorer, or Edge</td>
</tr>
<tr>
<td>System time is synchronized with a Network Time Protocol (NTP) server.</td>
</tr>
<tr>
<td>Ensure your bootstrap machine is using <a href="https://man7.org/linux/man-pages/man7/cgroups.7.html" target="_blank" rel="noopener">cgroup v1</a>. For more information, see <a href="https://tanzucommunityedition.io/docs/latest/support-matrix/#check-and-set-the-cgroup" target="_blank" rel="noopener">Check and set the cgroup</a>.</td>
</tr>
</tbody></table>
<p>在这里为了避免这些麻烦的配置，我就直接使用的 VMware 官方的 <a href="https://github.com/vmware/photon/wiki/Downloading-Photon-OS#photon-os-40-rev2-binaries" target="_blank" rel="noopener">Photon OS 4.0 Rev2</a> ，下载 OVA 格式的镜像直接导入到 ESXi 主机启动一台虚拟机即可，能节省不少麻烦的配置；还有一个好处就是在一台单独的虚拟机上运行 tanzu 部署工具不会污染本地的开发环境。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova</span><br><span class="line"><span class="comment"># 导入 OVA 虚拟机模版</span></span><br><span class="line">$ govc import.ova -ds=<span class="string">'datastore1'</span> -name bootstrap-node photon-ova-4.0-c001795b80.ova</span><br><span class="line"><span class="comment"># 修改一下虚拟机的配置，调整为 4C8G</span></span><br><span class="line">$ govc vm.change -c 4 -m 8192 -vm bootstrap-node</span><br><span class="line"><span class="comment"># 开启虚拟机</span></span><br><span class="line">$ govc vm.power -on bootstrap-node</span><br><span class="line"><span class="comment"># 查看虚拟机获取到的 IPv4 地址</span></span><br><span class="line">$ govc vm.ip -a -<span class="built_in">wait</span> 1m bootstrap-node</span><br><span class="line">$ ssh root@192.168.74.10</span><br><span class="line"><span class="comment"># 密码默认为 changeme，输入完密码之后提示在输入一遍 changeme，然后再修改新的密码</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># cat /etc/os-release</span></span><br><span class="line">NAME=<span class="string">"VMware Photon OS"</span></span><br><span class="line">VERSION=<span class="string">"4.0"</span></span><br><span class="line">ID=photon</span><br><span class="line">VERSION_ID=4.0</span><br><span class="line">PRETTY_NAME=<span class="string">"VMware Photon OS/Linux"</span></span><br><span class="line">ANSI_COLOR=<span class="string">"1;34"</span></span><br><span class="line">HOME_URL=<span class="string">"https://vmware.github.io/photon/"</span></span><br><span class="line">BUG_REPORT_URL=<span class="string">"https://github.com/vmware/photon/issues"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>安装部署时需要的一些工具（切，Photon OS 里竟然连个 tar 命令都没有 😠</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># tdnf install sudo tar -y</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># curl -LO https://dl.k8s.io/release/v1.21.2/bin/linux/amd64/kubectl</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl</span></span><br></pre></td></tr></table></figure>

<ul>
<li>启动 docker，bootstrap 节点会以 kind 的方式运行一个 K8s 集群，需要用到 docker。虽然可以使用外部的 k8s 集群，但不是很推荐，因为 cluster-api 依赖 k8s 的版本，不能太高也不能太低；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># systemctl enable docker --now</span></span><br></pre></td></tr></table></figure>

<ul>
<li>从 <a href="https://github.com/vmware-tanzu/community-edition/releases/tag/v0.9.1" target="_blank" rel="noopener">vmware-tanzu/community-edition</a> 下载 tanzu 社区版的安装包，然后解压后安装；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># curl -LO  https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># tar -xf tce-linux-amd64-v0.9.1.tar.gz</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># cd tce-linux-amd64-v0.9.1/</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># bash install.sh</span></span><br></pre></td></tr></table></figure>

<p>然而不幸地翻车了， install.sh 脚本中禁止 root 用户运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ ALLOW_INSTALL_AS_ROOT=</span><br><span class="line">+ [[ 0 -eq 0 ]]</span><br><span class="line">+ [[ <span class="string">''</span> != \t\r\u\e ]]</span><br><span class="line">+ <span class="built_in">echo</span> <span class="string">'Do not run this script as root'</span></span><br><span class="line">Do not run this script as root</span><br><span class="line">+ <span class="built_in">exit</span> 1</span><br></pre></td></tr></table></figure>

<p>我就偏偏要以 root 用户来运行怎么惹 😡</p>
<p><img src="https://p.k8s.li/2022-01-22-deploy-tanzu-k8s-cluster-01.jpg" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sed 去掉第一个 exit 1 就可以了</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># sed -i.bak "s/exit 1//" install.sh</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># bash install.sh</span></span><br></pre></td></tr></table></figure>

<p>安装好之后会输出 <code>Installation complete!</code>（讲真官方的 install.sh 脚本输出很不友好，污染我的 terminal</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+ tanzu init</span><br><span class="line">| initializing ✔  successfully initialized CLI</span><br><span class="line">++ tanzu plugin repo list</span><br><span class="line">++ grep tce</span><br><span class="line">+ TCE_REPO=</span><br><span class="line">+ [[ -z <span class="string">''</span> ]]</span><br><span class="line">+ tanzu plugin repo add --name tce --gcp-bucket-name tce-tanzu-cli-plugins --gcp-root-path artifacts</span><br><span class="line">++ tanzu plugin repo list</span><br><span class="line">++ grep core-admin</span><br><span class="line">+ TCE_REPO=</span><br><span class="line">+ [[ -z <span class="string">''</span> ]]</span><br><span class="line">+ tanzu plugin repo add --name core-admin --gcp-bucket-name tce-tanzu-cli-framework-admin --gcp-root-path artifacts-admin</span><br><span class="line">+ <span class="built_in">echo</span> <span class="string">'Installation complete!'</span></span><br><span class="line">Installation complete!</span><br></pre></td></tr></table></figure>

<h3 id="部署管理集群"><a href="#部署管理集群" class="headerlink" title="部署管理集群"></a>部署管理集群</h3><p>先是部署一个 tanzu 的管理集群，有两种方式，一种是通过 <a href="https://tanzucommunityedition.io/docs/latest/getting-started/" target="_blank" rel="noopener">官方文档</a> 提到的通过 Web UI 的方式。目前这个 UI 界面比较拉垮，它主要是用来让用户填写一些配置参数，然后调用后台的 tanzu 命令来部署集群。并把集群部署的日志和进度展示出来；部署完成之后，这个 UI 又不能管理这些集群，又不支持部署 workload 集群（</p>
<p>另一种就是通过 tanzu 命令指定配置文件来部署，这种方式不需要通过浏览器在 web 页面上傻乎乎地点来点去填一些参数，只需要提前填写好一个 yaml 格式的配置文件即可。下面我们就采用 tanzu 命令来部署集群，管理集群的配置文件模版如下：</p>
<ul>
<li>tanzu-mgt-cluster.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cluster Pod IP 的 CIDR</span></span><br><span class="line"><span class="attr">CLUSTER_CIDR:</span> <span class="number">100.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/11</span></span><br><span class="line"><span class="comment"># Service 的 CIDR</span></span><br><span class="line"><span class="attr">SERVICE_CIDR:</span> <span class="number">100.64</span><span class="number">.0</span><span class="number">.0</span><span class="string">/13</span></span><br><span class="line"><span class="comment"># 集群的名称</span></span><br><span class="line"><span class="attr">CLUSTER_NAME:</span> <span class="string">tanzu-control-plan</span></span><br><span class="line"><span class="comment"># 集群的类型</span></span><br><span class="line"><span class="attr">CLUSTER_PLAN:</span> <span class="string">dev</span></span><br><span class="line"><span class="comment"># 集群节点的 arch</span></span><br><span class="line"><span class="attr">OS_ARCH:</span> <span class="string">amd64</span></span><br><span class="line"><span class="comment"># 集群节点的 OS 名称</span></span><br><span class="line"><span class="attr">OS_NAME:</span> <span class="string">photon</span></span><br><span class="line"><span class="comment"># 集群节点 OS 版本</span></span><br><span class="line"><span class="attr">OS_VERSION:</span> <span class="string">"3"</span></span><br><span class="line"><span class="comment"># 基础设施资源的提供方</span></span><br><span class="line"><span class="attr">INFRASTRUCTURE_PROVIDER:</span> <span class="string">vsphere</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群的 VIP</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_ENDPOINT:</span> <span class="number">192.168</span><span class="number">.75</span><span class="number">.194</span></span><br><span class="line"><span class="comment"># control-plan 节点的磁盘大小</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># control-plan 节点的内存大小</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_MEM_MIB:</span> <span class="string">"8192"</span></span><br><span class="line"><span class="comment"># control-plan 节点的 CPU 核心数量</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_NUM_CPUS:</span> <span class="string">"4"</span></span><br><span class="line"><span class="comment"># work 节点的磁盘大小</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># work 节点的内存大小</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_MEM_MIB:</span> <span class="string">"4096"</span></span><br><span class="line"><span class="comment"># work 节点的 CPU 核心数量</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_NUM_CPUS:</span> <span class="string">"2"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter 的 Datacenter 路径</span></span><br><span class="line"><span class="attr">VSPHERE_DATACENTER:</span> <span class="string">/SH-IDC</span></span><br><span class="line"><span class="comment"># 虚拟机创建的 Datastore 路径</span></span><br><span class="line"><span class="attr">VSPHERE_DATASTORE:</span> <span class="string">/SH-IDC/datastore/datastore1</span></span><br><span class="line"><span class="comment"># 虚拟机创建的文件夹</span></span><br><span class="line"><span class="attr">VSPHERE_FOLDER:</span> <span class="string">/SH-IDC/vm/Tanzu-node</span></span><br><span class="line"><span class="comment"># 虚拟机使用的网络</span></span><br><span class="line"><span class="attr">VSPHERE_NETWORK:</span> <span class="string">/SH-IDC/network/VM</span> <span class="string">Network</span></span><br><span class="line"><span class="comment"># 虚拟机关联的资源池</span></span><br><span class="line"><span class="attr">VSPHERE_RESOURCE_POOL:</span> <span class="string">/SH-IDC/host/Tanzu-Cluster/Resources</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter 的 IP</span></span><br><span class="line"><span class="attr">VSPHERE_SERVER:</span> <span class="number">192.168</span><span class="number">.75</span><span class="number">.110</span></span><br><span class="line"><span class="comment"># vCenter 的用户名</span></span><br><span class="line"><span class="attr">VSPHERE_USERNAME:</span> <span class="string">administrator@vsphere.local</span></span><br><span class="line"><span class="comment"># vCenter 的密码，以 base64 编码</span></span><br><span class="line"><span class="attr">VSPHERE_PASSWORD:</span> <span class="string">&lt;encoded:base64password&gt;</span></span><br><span class="line"><span class="comment"># vCenter 的证书指纹，可以通过 govc about.cert -json | jq -r '.ThumbprintSHA1' 获取</span></span><br><span class="line"><span class="attr">VSPHERE_TLS_THUMBPRINT:</span> <span class="string">EB:F3:D8:7A:E8:3D:1A:59:B0:DE:73:96:DC:B9:5F:13:86:EF:B6:27</span></span><br><span class="line"><span class="comment"># 虚拟机注入的 ssh 公钥，需要用它来 ssh 登录集群节点</span></span><br><span class="line"><span class="attr">VSPHERE_SSH_AUTHORIZED_KEY:</span> <span class="string">ssh-rsa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一些默认参数</span></span><br><span class="line"><span class="attr">AVI_ENABLE:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">IDENTITY_MANAGEMENT_TYPE:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">ENABLE_AUDIT_LOGGING:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">ENABLE_CEIP_PARTICIPATION:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">TKG_HTTP_PROXY_ENABLED:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">DEPLOY_TKG_ON_VSPHERE7:</span> <span class="string">"true"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>通过 tanzu CLI 部署管理集群</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tanzu management-cluster create --file tanzu-mgt-cluster.yaml -v6</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果没有配置 VSPHERE_TLS_THUMBPRINT 会有一个确认 vSphere thumbprint 的交互，输入 Y 就可以</span></span><br><span class="line">Validating the pre-requisites...</span><br><span class="line">Do you want to <span class="built_in">continue</span> with the vSphere thumbprint EB:F3:D8:7A:E8:3D:1A:59:B0:DE:73:96:DC:B9:5F:13:86:EF:B6:27 [y/N]: y</span><br></pre></td></tr></table></figure>

<h3 id="部署日志"><a href="#部署日志" class="headerlink" title="部署日志"></a>部署日志</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># tanzu management-cluster create --file tanzu-mgt-cluster.yaml -v 6</span></span><br><span class="line">compatibility file (/root/.config/tanzu/tkg/compatibility/tkg-compatibility.yaml) already exists, skipping download</span><br><span class="line">BOM files inside /root/.config/tanzu/tkg/bom already exists, skipping download</span><br><span class="line">CEIP Opt-in status: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Validating the pre-requisites...</span><br><span class="line"></span><br><span class="line">vSphere 7.0 Environment Detected.</span><br><span class="line"></span><br><span class="line">You have connected to a vSphere 7.0 environment <span class="built_in">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includes</span><br><span class="line">an integrated Tanzu Kubernetes Grid Service <span class="built_in">which</span> turns a vSphere cluster into a platform <span class="keyword">for</span> running Kubernetes workloads <span class="keyword">in</span> dedicated</span><br><span class="line">resource pools. Configuring Tanzu Kubernetes Grid Service is <span class="keyword">done</span> through vSphere HTML5 client.</span><br><span class="line"></span><br><span class="line">Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="keyword">in</span> vSphere 7.0 environments. Alternatively you may</span><br><span class="line">deploy a non-integrated Tanzu Kubernetes Grid instance on vSphere 7.0.</span><br><span class="line">Deploying TKG management cluster on vSphere 7.0 ...</span><br><span class="line">Identity Provider not configured. Some authentication features won<span class="string">'t work.</span></span><br><span class="line"><span class="string">Checking if VSPHERE_CONTROL_PLANE_ENDPOINT 192.168.20.94 is already in use</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Setting up management cluster...</span></span><br><span class="line"><span class="string">Validating configuration...</span></span><br><span class="line"><span class="string">Using infrastructure provider vsphere:v0.7.10</span></span><br><span class="line"><span class="string">Generating cluster configuration...</span></span><br><span class="line"><span class="string">Setting up bootstrapper...</span></span><br><span class="line"><span class="string">Fetching configuration for kind node image...</span></span><br><span class="line"><span class="string">kindConfig:</span></span><br><span class="line"><span class="string"> &amp;&#123;&#123;Cluster kind.x-k8s.io/v1alpha4&#125;  [&#123;  map[] [&#123;/var/run/docker.sock /var/run/docker.sock false false &#125;] [] [] []&#125;] &#123; 0  100.96.0.0/11 100.64.0.0/13 false &#125; map[] map[] [apiVersion: kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="string">kind: ClusterConfiguration</span></span><br><span class="line"><span class="string">imageRepository: projects.registry.vmware.com/tkg</span></span><br><span class="line"><span class="string">etcd:</span></span><br><span class="line"><span class="string">  local:</span></span><br><span class="line"><span class="string">    imageRepository: projects.registry.vmware.com/tkg</span></span><br><span class="line"><span class="string">    imageTag: v3.4.13_vmware.15</span></span><br><span class="line"><span class="string">dns:</span></span><br><span class="line"><span class="string">  type: CoreDNS</span></span><br><span class="line"><span class="string">  imageRepository: projects.registry.vmware.com/tkg</span></span><br><span class="line"><span class="string">  imageTag: v1.8.0_vmware.5] [] [] []&#125;</span></span><br><span class="line"><span class="string">Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span></span><br><span class="line"><span class="string">Creating cluster "tkg-kind-c7vj6kds0a6sf43e6210" ...</span></span><br><span class="line"><span class="string">Ensuring node image (projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1) ...</span></span><br><span class="line"><span class="string">Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 ...</span></span><br><span class="line"><span class="string">Preparing nodes ...</span></span><br><span class="line"><span class="string">Writing configuration ...</span></span><br><span class="line"><span class="string">Starting control-plane ...</span></span><br><span class="line"><span class="string">Installing CNI ...</span></span><br><span class="line"><span class="string">Installing StorageClass ...</span></span><br><span class="line"><span class="string">Waiting 2m0s for control-plane = Ready ...</span></span><br><span class="line"><span class="string">Ready after 19s</span></span><br><span class="line"><span class="string">Bootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOL</span></span><br><span class="line"><span class="string">Installing providers on bootstrapper...</span></span><br><span class="line"><span class="string">Fetching providers</span></span><br><span class="line"><span class="string">Installing cert-manager Version="v1.1.0"</span></span><br><span class="line"><span class="string">Waiting for cert-manager to be available...</span></span><br><span class="line"><span class="string">Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"</span></span><br><span class="line"><span class="string">Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"</span></span><br><span class="line"><span class="string">Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"</span></span><br><span class="line"><span class="string">Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"</span></span><br><span class="line"><span class="string">installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"</span></span><br><span class="line"><span class="string">Waiting for provider infrastructure-vsphere</span></span><br><span class="line"><span class="string">Waiting for provider control-plane-kubeadm</span></span><br><span class="line"><span class="string">Waiting for provider cluster-api</span></span><br><span class="line"><span class="string">Waiting for provider bootstrap-kubeadm</span></span><br><span class="line"><span class="string">Waiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and running</span></span><br><span class="line"><span class="string">pods are not yet running for deployment '</span>capi-kubeadm-control-plane-controller-manager<span class="string">' in namespace '</span>capi-kubeadm-control-plane-system<span class="string">', retrying</span></span><br><span class="line"><span class="string">Passed waiting on provider bootstrap-kubeadm after 25.205820854s</span></span><br><span class="line"><span class="string">pods are not yet running for deployment '</span>capi-controller-manager<span class="string">' in namespace '</span>capi-webhook-system<span class="string">', retrying</span></span><br><span class="line"><span class="string">Passed waiting on provider infrastructure-vsphere after 30.185406332s</span></span><br><span class="line"><span class="string">Passed waiting on provider cluster-api after 30.213216243s</span></span><br><span class="line"><span class="string">Success waiting on all providers.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Start creating management cluster...</span></span><br><span class="line"><span class="string">patch cluster object with operation status:</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		"metadata": &#123;</span></span><br><span class="line"><span class="string">			"annotations": &#123;</span></span><br><span class="line"><span class="string">				"TKGOperationInfo" : "&#123;\"Operation\":\"Create\",\"OperationStartTimestamp\":\"2022-02-06 02:35:34.30219421 +0000 UTC\",\"OperationTimeout\":1800&#125;",</span></span><br><span class="line"><span class="string">				"TKGOperationLastObservedTimestamp" : "2022-02-06 02:35:34.30219421 +0000 UTC"</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">cluster control plane is still being initialized, retrying</span></span><br><span class="line"><span class="string">Getting secret for cluster</span></span><br><span class="line"><span class="string">Waiting for resource tanzu-control-plan-kubeconfig of type *v1.Secret to be up and running</span></span><br><span class="line"><span class="string">Saving management cluster kubeconfig into /root/.kube/config</span></span><br><span class="line"><span class="string">Installing providers on management cluster...</span></span><br><span class="line"><span class="string">Fetching providers</span></span><br><span class="line"><span class="string">Installing cert-manager Version="v1.1.0"</span></span><br><span class="line"><span class="string">Waiting for cert-manager to be available...</span></span><br><span class="line"><span class="string">Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"</span></span><br><span class="line"><span class="string">Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"</span></span><br><span class="line"><span class="string">Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"</span></span><br><span class="line"><span class="string">Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"</span></span><br><span class="line"><span class="string">installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"</span></span><br><span class="line"><span class="string">Waiting for provider control-plane-kubeadm</span></span><br><span class="line"><span class="string">Waiting for provider bootstrap-kubeadm</span></span><br><span class="line"><span class="string">Waiting for provider infrastructure-vsphere</span></span><br><span class="line"><span class="string">Waiting for provider cluster-api</span></span><br><span class="line"><span class="string">Waiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and running</span></span><br><span class="line"><span class="string">Passed waiting on provider control-plane-kubeadm after 10.046865402s</span></span><br><span class="line"><span class="string">Waiting for resource antrea-controller of type *v1.Deployment to be up and running</span></span><br><span class="line"><span class="string">Moving all Cluster API objects from bootstrap cluster to management cluster...</span></span><br><span class="line"><span class="string">Performing move...</span></span><br><span class="line"><span class="string">Discovering Cluster API objects</span></span><br><span class="line"><span class="string">Moving Cluster API objects Clusters=1</span></span><br><span class="line"><span class="string">Creating objects in the target cluster</span></span><br><span class="line"><span class="string">Deleting objects from the source cluster</span></span><br><span class="line"><span class="string">Waiting for additional components to be up and running...</span></span><br><span class="line"><span class="string">Waiting for packages to be up and running...</span></span><br><span class="line"><span class="string">Waiting for package: antrea</span></span><br><span class="line"><span class="string">Waiting for package: metrics-server</span></span><br><span class="line"><span class="string">Waiting for package: tanzu-addons-manager</span></span><br><span class="line"><span class="string">Waiting for package: vsphere-cpi</span></span><br><span class="line"><span class="string">Waiting for package: vsphere-csi</span></span><br><span class="line"><span class="string">Waiting for resource antrea of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource vsphere-cpi of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource vsphere-csi of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource metrics-server of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource tanzu-addons-manager of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Successfully reconciled package: antrea</span></span><br><span class="line"><span class="string">Successfully reconciled package: vsphere-csi</span></span><br><span class="line"><span class="string">Successfully reconciled package: metrics-server</span></span><br><span class="line"><span class="string">Context set for management cluster tanzu-control-plan as '</span>tanzu-control-plan-admin@tanzu-control-plan<span class="string">'.</span></span><br><span class="line"><span class="string">Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Management cluster created!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can now create your first workload cluster by running the following:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  tanzu cluster create [name] -f [file]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Some addons might be getting installed! Check their status by running the following:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  kubectl get apps -A</span></span><br></pre></td></tr></table></figure>

<ul>
<li>部署完成之后，将管理集群的 kubeconfig 文件复制到 kubectl 默认的目录下</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># cp $&#123;HOME&#125;/.kube-tkg/config $&#123;HOME&#125;/.kube/config</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查看集群状态信息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 管理集群的 cluster 资源信息，管理集群的 CR 默认保存在了 tkg-system namespace 下</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get cluster -A</span></span><br><span class="line">NAMESPACE    NAME                 PHASE</span><br><span class="line">tkg-system   tanzu-control-plan   Provisioned</span><br><span class="line"><span class="comment"># 管理集群的 machine 资源信息</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine -A</span></span><br><span class="line">NAMESPACE    NAME                                       PROVIDERID                                       PHASE         VERSION</span><br><span class="line">tkg-system   tanzu-control-plan-control-plane-gs4bl     vsphere://4239c450-f621-d78e-3c44-4ac8890c0cd3   Running       v1.21.2+vmware.1</span><br><span class="line">tkg-system   tanzu-control-plan-md-0-7cdc97c7c6-kxcnx   vsphere://4239d776-c04c-aacc-db12-3380542a6d03   Provisioned   v1.21.2+vmware.1</span><br><span class="line"><span class="comment"># 运行的组件状态</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE                           NAME                                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">capi-kubeadm-bootstrap-system       capi-kubeadm-bootstrap-controller-manager-6494884869-wlzhx       2/2     Running   0          8m37s</span><br><span class="line">capi-kubeadm-control-plane-system   capi-kubeadm-control-plane-controller-manager-857d687b9d-tpznv   2/2     Running   0          8m35s</span><br><span class="line">capi-system                         capi-controller-manager-778bd4dfb9-tkvwg                         2/2     Running   0          8m41s</span><br><span class="line">capi-webhook-system                 capi-controller-manager-9995bdc94-svjm2                          2/2     Running   0          8m41s</span><br><span class="line">capi-webhook-system                 capi-kubeadm-bootstrap-controller-manager-68845b65f8-sllgv       2/2     Running   0          8m38s</span><br><span class="line">capi-webhook-system                 capi-kubeadm-control-plane-controller-manager-9847c6747-vvz6g    2/2     Running   0          8m35s</span><br><span class="line">capi-webhook-system                 capv-controller-manager-55bf67fbd5-4t46v                         2/2     Running   0          8m31s</span><br><span class="line">capv-system                         capv-controller-manager-587fbf697f-bbzs9                         2/2     Running   0          8m31s</span><br><span class="line">cert-manager                        cert-manager-77f6fb8fd5-8tq6n                                    1/1     Running   0          11m</span><br><span class="line">cert-manager                        cert-manager-cainjector-6bd4cff7bb-6vlzx                         1/1     Running   0          11m</span><br><span class="line">cert-manager                        cert-manager-webhook-fbfcb9d6c-qpkbc                             1/1     Running   0          11m</span><br><span class="line">kube-system                         antrea-agent-5m9d4                                               2/2     Running   0          6m</span><br><span class="line">kube-system                         antrea-agent-8mpr7                                               2/2     Running   0          5m40s</span><br><span class="line">kube-system                         antrea-controller-5bbcb98667-hklss                               1/1     Running   0          5m50s</span><br><span class="line">kube-system                         coredns-8dcb5c56b-ckvb7                                          1/1     Running   0          12m</span><br><span class="line">kube-system                         coredns-8dcb5c56b-d98hf                                          1/1     Running   0          12m</span><br><span class="line">kube-system                         etcd-tanzu-control-plan-control-plane-gs4bl                      1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-apiserver-tanzu-control-plan-control-plane-gs4bl            1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-controller-manager-tanzu-control-plan-control-plane-gs4bl   1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-proxy-d4wq4                                                 1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-proxy-nhkgg                                                 1/1     Running   0          11m</span><br><span class="line">kube-system                         kube-scheduler-tanzu-control-plan-control-plane-gs4bl            1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-vip-tanzu-control-plan-control-plane-gs4bl                  1/1     Running   0          12m</span><br><span class="line">kube-system                         metrics-server-59fcb9fcf-xjznj                                   1/1     Running   0          6m29s</span><br><span class="line">kube-system                         vsphere-cloud-controller-manager-kzffm                           1/1     Running   0          5m50s</span><br><span class="line">kube-system                         vsphere-csi-controller-74675c9488-q9h5c                          6/6     Running   0          6m31s</span><br><span class="line">kube-system                         vsphere-csi-node-dmvvr                                           3/3     Running   0          6m31s</span><br><span class="line">kube-system                         vsphere-csi-node-k6x98                                           3/3     Running   0          6m31s</span><br><span class="line">tkg-system                          kapp-controller-6499b8866-xnql7                                  1/1     Running   0          10m</span><br><span class="line">tkg-system                          tanzu-addons-controller-manager-657c587556-rpbjm                 1/1     Running   0          7m58s</span><br><span class="line">tkg-system                          tanzu-capabilities-controller-manager-6ff97656b8-cq7m7           1/1     Running   0          11m</span><br><span class="line">tkr-system                          tkr-controller-manager-6bc455b5d4-wm98s                          1/1     Running   0          10m</span><br></pre></td></tr></table></figure>

<h3 id="部署流程-1"><a href="#部署流程-1" class="headerlink" title="部署流程"></a>部署流程</h3><p>结合 <a href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go" target="_blank" rel="noopener">tanzu 的源码</a> 和部署输出的日志我们大体可以得知，tanzu 管理集群部署大致分为如下几步：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// management cluster init step constants</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	StepConfigPrerequisite                 = <span class="string">"Configure prerequisite"</span></span><br><span class="line">	StepValidateConfiguration              = <span class="string">"Validate configuration"</span></span><br><span class="line">	StepGenerateClusterConfiguration       = <span class="string">"Generate cluster configuration"</span></span><br><span class="line">	StepSetupBootstrapCluster              = <span class="string">"Setup bootstrap cluster"</span></span><br><span class="line">	StepInstallProvidersOnBootstrapCluster = <span class="string">"Install providers on bootstrap cluster"</span></span><br><span class="line">	StepCreateManagementCluster            = <span class="string">"Create management cluster"</span></span><br><span class="line">	StepInstallProvidersOnRegionalCluster  = <span class="string">"Install providers on management cluster"</span></span><br><span class="line">	StepMoveClusterAPIObjects              = <span class="string">"Move cluster-api objects from bootstrap cluster to management cluster"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// InitRegionSteps management cluster init step sequence</span></span><br><span class="line"><span class="keyword">var</span> InitRegionSteps = []<span class="keyword">string</span>&#123;</span><br><span class="line">	StepConfigPrerequisite,</span><br><span class="line">	StepValidateConfiguration,</span><br><span class="line">	StepGenerateClusterConfiguration,</span><br><span class="line">	StepSetupBootstrapCluster,</span><br><span class="line">	StepInstallProvidersOnBootstrapCluster,</span><br><span class="line">	StepCreateManagementCluster,</span><br><span class="line">	StepInstallProvidersOnRegionalCluster,</span><br><span class="line">	StepMoveClusterAPIObjects,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ConfigPrerequisite 准备阶段，会下载 <code>tkg-compatibility</code> 和 <code>tkg-bom</code>镜像，用于检查环境的兼容性；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Downloading TKG compatibility file from <span class="string">'projects.registry.vmware.com/tkg/framework-zshippable/tkg-compatibility'</span></span><br><span class="line">Downloading the TKG Bill of Materials (BOM) file from <span class="string">'projects.registry.vmware.com/tkg/tkg-bom:v1.4.0'</span></span><br><span class="line">Downloading the TKr Bill of Materials (BOM) file from <span class="string">'projects.registry.vmware.com/tkg/tkr-bom:v1.21.2_vmware.1-tkg.1'</span></span><br><span class="line">ERROR 2022/02/06 02:24:46 svType != tvType; key=release, st=map[string]interface &#123;&#125;, tt=&lt;nil&gt;, sv=map[version:], tv=&lt;nil&gt;</span><br><span class="line">CEIP Opt-in status: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ValidateConfiguration 配置文件校验，根据填写的参数校验配置是否正确，以及检查 vCenter 当中有无匹配的虚拟机模版；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Validating the pre-requisites...</span><br><span class="line"></span><br><span class="line">vSphere 7.0 Environment Detected.</span><br><span class="line"></span><br><span class="line">You have connected to a vSphere 7.0 environment <span class="built_in">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includes</span><br><span class="line">an integrated Tanzu Kubernetes Grid Service <span class="built_in">which</span> turns a vSphere cluster into a platform <span class="keyword">for</span> running Kubernetes workloads <span class="keyword">in</span> dedicated</span><br><span class="line">resource pools. Configuring Tanzu Kubernetes Grid Service is <span class="keyword">done</span> through vSphere HTML5 client.</span><br><span class="line"></span><br><span class="line">Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="keyword">in</span> vSphere 7.0 environments. Alternatively you may</span><br><span class="line">deploy a non-integrated Tanzu Kubernetes Grid instance on vSphere 7.0.</span><br><span class="line">Deploying TKG management cluster on vSphere 7.0 ...</span><br><span class="line">Identity Provider not configured. Some authentication features won<span class="string">'t work.</span></span><br><span class="line"><span class="string">Checking if VSPHERE_CONTROL_PLANE_ENDPOINT 192.168.20.94 is already in use</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Setting up management cluster...</span></span><br><span class="line"><span class="string">Validating configuration...</span></span><br><span class="line"><span class="string">Using infrastructure provider vsphere:v0.7.10</span></span><br></pre></td></tr></table></figure>

<ul>
<li>GenerateClusterConfiguration 生成集群配置文件信息；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Generating cluster configuration...</span><br></pre></td></tr></table></figure>

<ul>
<li>SetupBootstrapCluster 设置 bootstrap 集群，目前默认为 kind。会运行一个 docker 容器，里面套娃运行着一个 k8s 集群；这个 bootstrap k8s 集群只是临时运行 cluster-api 来部署管理集群用的，部署完成之后 bootstrap 集群也就没用了，会自动删掉；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Setting up bootstrapper...</span><br><span class="line">Fetching configuration <span class="keyword">for</span> kind node image...</span><br><span class="line">kindConfig:</span><br><span class="line"> &amp;&#123;&#123;Cluster kind.x-k8s.io/v1alpha4&#125;  [&#123;  map[] [&#123;/var/run/docker.sock /var/run/docker.sock <span class="literal">false</span> <span class="literal">false</span> &#125;] [] [] []&#125;] &#123; 0  100.96.0.0/11 100.64.0.0/13 <span class="literal">false</span> &#125; map[] map[] [apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">imageRepository: projects.registry.vmware.com/tkg</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    imageRepository: projects.registry.vmware.com/tkg</span><br><span class="line">    imageTag: v3.4.13_vmware.15</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">  imageRepository: projects.registry.vmware.com/tkg</span><br><span class="line">  imageTag: v1.8.0_vmware.5] [] [] []&#125;</span><br><span class="line">Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span><br><span class="line">Creating cluster <span class="string">"tkg-kind-c7vj6kds0a6sf43e6210"</span> ...</span><br><span class="line">Ensuring node image (projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1) ...</span><br><span class="line">Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 ...</span><br><span class="line">Preparing nodes ...</span><br><span class="line">Writing configuration ...</span><br><span class="line">Starting control-plane ...</span><br><span class="line">Installing CNI ...</span><br><span class="line">Installing StorageClass ...</span><br><span class="line">Waiting 2m0s <span class="keyword">for</span> control-plane = Ready ...</span><br><span class="line">Ready after 19s</span><br><span class="line">Bootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOL</span><br></pre></td></tr></table></figure>

<ul>
<li>InstallProvidersOnBootstrapCluster 在 bootstrap 集群上安装 cluste-api 相关组件；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Installing providers on bootstrapper...</span><br><span class="line">Fetching providers</span><br><span class="line"><span class="comment"># 安装 cert-manager 主要是为了生成 k8s 集群部署所依赖的那一堆证书</span></span><br><span class="line">Installing cert-manager Version=<span class="string">"v1.1.0"</span></span><br><span class="line">Waiting <span class="keyword">for</span> cert-manager to be available...</span><br><span class="line">Installing Provider=<span class="string">"cluster-api"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-system"</span></span><br><span class="line">Installing Provider=<span class="string">"bootstrap-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-bootstrap-system"</span></span><br><span class="line">Installing Provider=<span class="string">"control-plane-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-control-plane-system"</span></span><br><span class="line">Installing Provider=<span class="string">"infrastructure-vsphere"</span> Version=<span class="string">"v0.7.10"</span> TargetNamespace=<span class="string">"capv-system"</span></span><br><span class="line">installed  Component==<span class="string">"cluster-api"</span>  Type==<span class="string">"CoreProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"BootstrapProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"ControlPlaneProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"vsphere"</span>  Type==<span class="string">"InfrastructureProvider"</span>  Version==<span class="string">"v0.7.10"</span></span><br><span class="line">Waiting <span class="keyword">for</span> provider infrastructure-vsphere</span><br><span class="line">Waiting <span class="keyword">for</span> provider control-plane-kubeadm</span><br><span class="line">Waiting <span class="keyword">for</span> provider cluster-api</span><br><span class="line">Waiting <span class="keyword">for</span> provider bootstrap-kubeadm</span><br><span class="line">Passed waiting on provider infrastructure-vsphere after 30.185406332s</span><br><span class="line">Passed waiting on provider cluster-api after 30.213216243s</span><br><span class="line">Success waiting on all providers.</span><br></pre></td></tr></table></figure>

<ul>
<li>CreateManagementCluster 创建管理集群，这一步主要是创建虚拟机、初始化节点、运行 kubeadm 部署 k8s 集群；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Start creating management cluster...</span><br><span class="line">patch cluster object with operation status:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="string">"metadata"</span>: &#123;</span><br><span class="line">			<span class="string">"annotations"</span>: &#123;</span><br><span class="line">				<span class="string">"TKGOperationInfo"</span> : <span class="string">"&#123;\"Operation\":\"Create\",\"OperationStartTimestamp\":\"2022-02-06 02:35:34.30219421 +0000 UTC\",\"OperationTimeout\":1800&#125;"</span>,</span><br><span class="line">				<span class="string">"TKGOperationLastObservedTimestamp"</span> : <span class="string">"2022-02-06 02:35:34.30219421 +0000 UTC"</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">cluster control plane is still being initialized, retrying</span><br><span class="line">Getting secret <span class="keyword">for</span> cluster</span><br><span class="line">Waiting <span class="keyword">for</span> resource tanzu-control-plan-kubeconfig of <span class="built_in">type</span> *v1.Secret to be up and running</span><br><span class="line">Saving management cluster kubeconfig into /root/.kube/config</span><br></pre></td></tr></table></figure>

<ul>
<li>InstallProvidersOnRegionalCluster 在管理集群上安装 cluster-api 相关组件；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Installing providers on management cluster...</span><br><span class="line">Fetching providers</span><br><span class="line">Installing cert-manager Version=<span class="string">"v1.1.0"</span></span><br><span class="line">Waiting <span class="keyword">for</span> cert-manager to be available...</span><br><span class="line">Installing Provider=<span class="string">"cluster-api"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-system"</span></span><br><span class="line">Installing Provider=<span class="string">"bootstrap-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-bootstrap-system"</span></span><br><span class="line">Installing Provider=<span class="string">"control-plane-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-control-plane-system"</span></span><br><span class="line">Installing Provider=<span class="string">"infrastructure-vsphere"</span> Version=<span class="string">"v0.7.10"</span> TargetNamespace=<span class="string">"capv-system"</span></span><br><span class="line">installed  Component==<span class="string">"cluster-api"</span>  Type==<span class="string">"CoreProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"BootstrapProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"ControlPlaneProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"vsphere"</span>  Type==<span class="string">"InfrastructureProvider"</span>  Version==<span class="string">"v0.7.10"</span></span><br><span class="line">Waiting <span class="keyword">for</span> provider control-plane-kubeadm</span><br><span class="line">Waiting <span class="keyword">for</span> provider bootstrap-kubeadm</span><br><span class="line">Waiting <span class="keyword">for</span> provider infrastructure-vsphere</span><br><span class="line">Waiting <span class="keyword">for</span> provider cluster-api</span><br><span class="line">Waiting <span class="keyword">for</span> resource capv-controller-manager of <span class="built_in">type</span> *v1.Deployment to be up and running</span><br><span class="line">Passed waiting on provider infrastructure-vsphere after 20.091935635s</span><br><span class="line">Passed waiting on provider cluster-api after 20.109419304s</span><br><span class="line">Success waiting on all providers.</span><br><span class="line">Waiting <span class="keyword">for</span> the management cluster to get ready <span class="keyword">for</span> move...</span><br><span class="line">Waiting <span class="keyword">for</span> resource tanzu-control-plan of <span class="built_in">type</span> *v1alpha3.Cluster to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> resources <span class="built_in">type</span> *v1alpha3.MachineDeploymentList to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> resources <span class="built_in">type</span> *v1alpha3.MachineList to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> addons installation...</span><br><span class="line">Waiting <span class="keyword">for</span> resources <span class="built_in">type</span> *v1alpha3.ClusterResourceSetList to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> resource antrea-controller of <span class="built_in">type</span> *v1.Deployment to be up and running</span><br></pre></td></tr></table></figure>

<ul>
<li>MoveClusterAPIObjects 将 bootstrap 集群上 cluster-api 相关的资源转移到管理集群上。这一步的目的是为了达到 self-hosted 自托管的功能：即管理集群自身的扩缩容也是通过 cluster-api 来完成，这样就不用再依赖先前的那个 bootstrap 集群了；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Moving all Cluster API objects from bootstrap cluster to management cluster...</span><br><span class="line">Performing move...</span><br><span class="line">Discovering Cluster API objects</span><br><span class="line">Moving Cluster API objects Clusters=1</span><br><span class="line">Creating objects <span class="keyword">in</span> the target cluster</span><br><span class="line">Deleting objects from the <span class="built_in">source</span> cluster</span><br><span class="line">Context <span class="built_in">set</span> <span class="keyword">for</span> management cluster tanzu-control-plan as <span class="string">'tanzu-control-plan-admin@tanzu-control-plan'</span>.</span><br><span class="line">Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span><br><span class="line"></span><br><span class="line">Management cluster created!</span><br><span class="line"></span><br><span class="line">You can now create your first workload cluster by running the following:</span><br><span class="line"></span><br><span class="line">  tanzu cluster create [name] -f [file]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Some addons might be getting installed! Check their status by running the following:</span><br><span class="line"></span><br><span class="line">  kubectl get apps -A</span><br></pre></td></tr></table></figure>

<p>部署完成后会删除 bootstrap 集群，因为 bootstrap 集群中的资源已经转移到了管理集群中，它继续存在的意义不大。</p>
<h2 id="部署-workload-集群"><a href="#部署-workload-集群" class="headerlink" title="部署 workload 集群"></a>部署 workload 集群</h2><p>上面我们只是部署好了一个 tanzu 管理集群，我们真正的工作负载并不适合运行在这个集群上，因此我们还需要再部署一个 workload 集群，类似于 k8s 集群中的 worker 节点。部署 workload 集群的时候不再依赖 bootstrap 集群，而是使用管理集群。</p>
<p>根据官方文档 <a href="https://tanzucommunityedition.io/docs/latest/vsphere-wl-template/" target="_blank" rel="noopener">vSphere Workload Cluster Template</a> 中给出的模版创建一个配置文件，然后再通过 tanzu 命令来部署即可。配置文件内容如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cluster Pod IP 的 CIDR</span></span><br><span class="line"><span class="attr">CLUSTER_CIDR:</span> <span class="number">100.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/11</span></span><br><span class="line"><span class="comment"># Service 的 CIDR</span></span><br><span class="line"><span class="attr">SERVICE_CIDR:</span> <span class="number">100.64</span><span class="number">.0</span><span class="number">.0</span><span class="string">/13</span></span><br><span class="line"><span class="comment"># 集群的名称</span></span><br><span class="line"><span class="attr">CLUSTER_NAME:</span> <span class="string">tanzu-workload-cluster</span></span><br><span class="line"><span class="comment"># 集群的类型</span></span><br><span class="line"><span class="attr">CLUSTER_PLAN:</span> <span class="string">dev</span></span><br><span class="line"><span class="comment"># 集群节点的 arch</span></span><br><span class="line"><span class="attr">OS_ARCH:</span> <span class="string">amd64</span></span><br><span class="line"><span class="comment"># 集群节点的 OS 名称</span></span><br><span class="line"><span class="attr">OS_NAME:</span> <span class="string">photon</span></span><br><span class="line"><span class="comment"># 集群节点 OS 版本</span></span><br><span class="line"><span class="attr">OS_VERSION:</span> <span class="string">"3"</span></span><br><span class="line"><span class="comment"># 基础设施资源的提供方</span></span><br><span class="line"><span class="attr">INFRASTRUCTURE_PROVIDER:</span> <span class="string">vsphere</span></span><br><span class="line"><span class="comment"># cluster, machine 等自定义资源创建的 namespace</span></span><br><span class="line"><span class="attr">NAMESPACE:</span> <span class="string">default</span></span><br><span class="line"><span class="comment"># CNI 选用类型，目前应该只支持 VMware 自家的 antrea</span></span><br><span class="line"><span class="attr">CNI:</span> <span class="string">antrea</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群的 VIP</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_ENDPOINT:</span> <span class="number">192.168</span><span class="number">.20</span><span class="number">.95</span></span><br><span class="line"><span class="comment"># control-plan 节点的磁盘大小</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># control-plan 节点的内存大小</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_MEM_MIB:</span> <span class="string">"8192"</span></span><br><span class="line"><span class="comment"># control-plan 节点的 CPU 核心数量</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_NUM_CPUS:</span> <span class="string">"4"</span></span><br><span class="line"><span class="comment"># work 节点的磁盘大小</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># work 节点的内存大小</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_MEM_MIB:</span> <span class="string">"4096"</span></span><br><span class="line"><span class="comment"># work 节点的 CPU 核心数量</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_NUM_CPUS:</span> <span class="string">"2"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter 的 Datacenter 路径</span></span><br><span class="line"><span class="attr">VSPHERE_DATACENTER:</span> <span class="string">/SH-IDC</span></span><br><span class="line"><span class="comment"># 虚拟机创建的 Datastore 路径</span></span><br><span class="line"><span class="attr">VSPHERE_DATASTORE:</span> <span class="string">/SH-IDC/datastore/datastore1</span></span><br><span class="line"><span class="comment"># 虚拟机创建的文件夹</span></span><br><span class="line"><span class="attr">VSPHERE_FOLDER:</span> <span class="string">/SH-IDC/vm/Tanzu-node</span></span><br><span class="line"><span class="comment"># 虚拟机使用的网络</span></span><br><span class="line"><span class="attr">VSPHERE_NETWORK:</span> <span class="string">/SH-IDC/network/VM</span> <span class="string">Network</span></span><br><span class="line"><span class="comment"># 虚拟机关联的资源池</span></span><br><span class="line"><span class="attr">VSPHERE_RESOURCE_POOL:</span> <span class="string">/SH-IDC/host/Tanzu-Cluster/Resources</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter 的 IP</span></span><br><span class="line"><span class="attr">VSPHERE_SERVER:</span> <span class="number">192.168</span><span class="number">.20</span><span class="number">.92</span></span><br><span class="line"><span class="comment"># vCenter 的用户名</span></span><br><span class="line"><span class="attr">VSPHERE_USERNAME:</span> <span class="string">administrator@vsphere.local</span></span><br><span class="line"><span class="comment"># vCenter 的密码，以 base64 编码</span></span><br><span class="line"><span class="attr">VSPHERE_PASSWORD:</span> <span class="string">&lt;encoded:YWRtaW5AMjAyMA==&gt;</span></span><br><span class="line"><span class="comment"># vCenter 的证书指纹，可以通过 govc about.cert -json | jq -r '.ThumbprintSHA1' 获取</span></span><br><span class="line"><span class="attr">VSPHERE_TLS_THUMBPRINT:</span> <span class="string">CB:23:48:E8:93:34:AD:27:D8:FD:88:1C:D7:08:4B:47:9B:12:F4:E0</span></span><br><span class="line"><span class="comment"># 虚拟机注入的 ssh 公钥，需要用它来 ssh 登录集群节点</span></span><br><span class="line"><span class="attr">VSPHERE_SSH_AUTHORIZED_KEY:</span> <span class="string">ssh-rsa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一些默认参数</span></span><br><span class="line"><span class="attr">AVI_ENABLE:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">IDENTITY_MANAGEMENT_TYPE:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">ENABLE_AUDIT_LOGGING:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">ENABLE_CEIP_PARTICIPATION:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">TKG_HTTP_PROXY_ENABLED:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">DEPLOY_TKG_ON_VSPHERE7:</span> <span class="string">"true"</span></span><br><span class="line"><span class="comment"># 是否开启虚拟机健康检查</span></span><br><span class="line"><span class="attr">ENABLE_MHC:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">MHC_UNKNOWN_STATUS_TIMEOUT:</span> <span class="string">5m</span></span><br><span class="line"><span class="attr">MHC_FALSE_STATUS_TIMEOUT:</span> <span class="string">12m</span></span><br><span class="line"><span class="comment"># 是否部署 vsphere cis 组件</span></span><br><span class="line"><span class="attr">ENABLE_DEFAULT_STORAGE_CLASS:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># 是否开启集群自动扩缩容</span></span><br><span class="line"><span class="attr">ENABLE_AUTOSCALER:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>通过 tanzu 命令来部署 workload 集群</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># tanzu cluster create tanzu-workload-cluster --file tanzu-workload-cluster.yaml</span></span><br><span class="line">Validating configuration...</span><br><span class="line">Warning: Pinniped configuration not found. Skipping pinniped configuration <span class="keyword">in</span> workload cluster. Please refer to the documentation to check <span class="keyword">if</span> you can configure pinniped on workload cluster manually</span><br><span class="line">Creating workload cluster <span class="string">'tanzu-workload-cluster'</span>...</span><br><span class="line">Waiting <span class="keyword">for</span> cluster to be initialized...</span><br><span class="line">Waiting <span class="keyword">for</span> cluster nodes to be available...</span><br><span class="line">Waiting <span class="keyword">for</span> cluster autoscaler to be available...</span><br><span class="line">Unable to <span class="built_in">wait</span> <span class="keyword">for</span> autoscaler deployment to be ready. reason: deployments.apps <span class="string">"tanzu-workload-cluster-cluster-autoscaler"</span> not found</span><br><span class="line">Waiting <span class="keyword">for</span> addons installation...</span><br><span class="line">Waiting <span class="keyword">for</span> packages to be up and running...</span><br><span class="line">Workload cluster <span class="string">'tanzu-workload-cluster'</span> created</span><br></pre></td></tr></table></figure>

<ul>
<li>部署完成之后查看一下集群的 CR 信息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get cluster</span></span><br><span class="line">NAME                     PHASE</span><br><span class="line">tanzu-workload-cluster   Provisioned</span><br><span class="line"><span class="comment"># machine 状态处于 Running 说明节点已经正常运行了</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine</span></span><br><span class="line">NAME                                          PROVIDERID                                       PHASE     VERSION</span><br><span class="line">tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1</span><br></pre></td></tr></table></figure>

<h2 id="扩容集群"><a href="#扩容集群" class="headerlink" title="扩容集群"></a>扩容集群</h2><p>集群部署好之后，如果想对集群节点进行扩缩容，我们可以像 deployment 的一样，只需要修改一些 CR 的信息即可。cluster-api 相关组件会 watch 到这些 CR 的变化，并根据它的 spec 信息进行一系列调谐操作。如果当前集群节点数量低于所定义的节点副本数量，则会自动调用对应的 Provider 创建虚拟机，并对虚拟机进行初始化操作，将它转换为 k8s 里的一个 node 资源；</p>
<h3 id="扩容-control-plan-节点"><a href="#扩容-control-plan-节点" class="headerlink" title="扩容 control-plan 节点"></a>扩容 control-plan 节点</h3><p>即扩容 master 节点，通过修改 <code>KubeadmControlPlane</code> 这个 CR 中的 <code>replicas</code> 副本数即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl scale kcp tanzu-workload-cluster-control-plane --replicas=3</span></span><br><span class="line"><span class="comment"># 可以看到 machine 已经处于 Provisioning 状态，说明集群节点对应的虚拟机正在创建中</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine</span></span><br><span class="line">NAME                                          PROVIDERID                                       PHASE          VERSION</span><br><span class="line">tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running        v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-control-plane-mkmd2                                                     Provisioning   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running        v1.21.2+vmware.1</span><br></pre></td></tr></table></figure>

<h3 id="扩容-work-节点"><a href="#扩容-work-节点" class="headerlink" title="扩容 work 节点"></a>扩容 work 节点</h3><p>扩容 worker 节点，通过修改 <code>MachineDeployment</code> 这个 CR 中的 <code>replicas</code> 副本数即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl scale md tanzu-workload-cluster-md-0 --replicas=3</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine</span></span><br><span class="line">NAME                                          PROVIDERID                                       PHASE     VERSION</span><br><span class="line">tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-control-plane-mkmd2    vsphere://4239278c-0503-f03a-08b8-df92286bcdd7   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-control-plane-rt5mb    vsphere://4239c882-2fe5-a394-60c0-616941a6363e   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-4hlqk   vsphere://42395deb-e706-8b4b-a44f-c755c222575c   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-ftmlp   vsphere://42399640-8e94-85e5-c4bd-8436d84966e0   Running   v1.21.2+vmware.1</span><br></pre></td></tr></table></figure>

<h2 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h2><p>本文只是介绍了 tanzu 集群部署的大体流程，里面包含了 cluster-api 相关的概念在本文并没有做深入的分析，因为实在是太复杂了 😂，到现在我还是没太理解其中的一些原理，因此后续我再单独写一篇博客来讲解一些 cluster-api 相关的内容，到那时候在结合本文来看就容易理解很多。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://github.com/vmware-tanzu/community-edition" target="_blank" rel="noopener">community-edition</a></li>
<li><a href="https://github.com/vmware/photon" target="_blank" rel="noopener">vmware/photon</a></li>
<li><a href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go" target="_blank" rel="noopener">tanzu-framework</a></li>
<li><a href="https://github.com/kubernetes-sigs/cluster-api-provider-vsphere" target="_blank" rel="noopener">cluster-api-provider-vsphere</a></li>
<li><a href="https://tanzucommunityedition.io/docs/latest/workload-clusters/" target="_blank" rel="noopener">Deploying a workload cluster</a></li>
<li><a href="https://tanzucommunityedition.io/docs/latest/verify-deployment/" target="_blank" rel="noopener">Examine the Management Cluster Deployment</a></li>
<li><a href="https://tanzucommunityedition.io/docs/latest/vsphere/" target="_blank" rel="noopener">Prepare to Deploy a Management or Standalone Clusters to vSphere</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/ESXi/" rel="tag"><i class="fa fa-tag"></i> ESXi</a>
              <a href="/tags/Tanzu/" rel="tag"><i class="fa fa-tag"></i> Tanzu</a>
              <a href="/tags/Kubernetes/" rel="tag"><i class="fa fa-tag"></i> Kubernetes</a>
              <a href="/tags/Cluster-api/" rel="tag"><i class="fa fa-tag"></i> Cluster-api</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/rebuild-iso-image.html" rel="prev" title="使用 overlay2 或 bind 重新构建 ISO 镜像">
      <i class="fa fa-chevron-left"></i> 使用 overlay2 或 bind 重新构建 ISO 镜像
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署流程"><span class="nav-number">1.</span> <span class="nav-text">部署流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#劝退三连-😂"><span class="nav-number">1.1.</span> <span class="nav-text">劝退三连 😂</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载依赖文件"><span class="nav-number">1.2.</span> <span class="nav-text">下载依赖文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-govc-及依赖"><span class="nav-number">1.3.</span> <span class="nav-text">安装 govc 及依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-ESXi-OS"><span class="nav-number">1.4.</span> <span class="nav-text">安装 ESXi OS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-vCenter"><span class="nav-number">1.5.</span> <span class="nav-text">安装 vCenter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置-vCenter"><span class="nav-number">1.6.</span> <span class="nav-text">配置 vCenter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化-bootstrap-节点"><span class="nav-number">1.7.</span> <span class="nav-text">初始化 bootstrap 节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署管理集群"><span class="nav-number">1.8.</span> <span class="nav-text">部署管理集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署日志"><span class="nav-number">1.9.</span> <span class="nav-text">部署日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署流程-1"><span class="nav-number">1.10.</span> <span class="nav-text">部署流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署-workload-集群"><span class="nav-number">2.</span> <span class="nav-text">部署 workload 集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩容集群"><span class="nav-number">3.</span> <span class="nav-text">扩容集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#扩容-control-plan-节点"><span class="nav-number">3.1.</span> <span class="nav-text">扩容 control-plan 节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#扩容-work-节点"><span class="nav-number">3.2.</span> <span class="nav-text">扩容 work 节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后续"><span class="nav-number">4.</span> <span class="nav-text">后续</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="木子"
      src="https://blog.k8s.li/avatar.png">
  <p class="site-author-name" itemprop="name">木子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">111</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">134</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail → mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tg.k8s.li/" title="Channel → https:&#x2F;&#x2F;tg.k8s.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Channel</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">木子</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">1.6m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">45:45</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://muzi.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://blog.k8s.li/deploy-tanzu-k8s-cluster.html",
            identifier: "deploy-tanzu-k8s-cluster.html",
            title: "VMware Tanzu kubernetes 发行版部署尝鲜"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://muzi.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
