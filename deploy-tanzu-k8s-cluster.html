<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.k8s.li').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="ä¹‹å‰æ¥è§¦çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·å¤§å¤šæ•°éƒ½æ˜¯ä¾èµ–äº ssh è¿æ¥åˆ°å¾…éƒ¨ç½²çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œéƒ¨ç½²æ“ä½œï¼Œè¿™æ ·å°±è¦æ±‚éƒ¨ç½²å‰éœ€è¦æå‰å‡†å¤‡å¥½é›†ç¾¤èŠ‚ç‚¹ï¼Œä¸”è¦ä¿è¯è¿™äº›èŠ‚ç‚¹çš„ç½‘ç»œäº’é€šä»¥åŠæ—¶é’ŸåŒæ­¥ç­‰é—®é¢˜ã€‚ç±»ä¼¼äº kubespray æˆ–è€… kubekey è¿™äº›éƒ¨ç½²å·¥å…·æ˜¯ä¸ä¼šå»ç®¡è¿™äº›åº•å±‚çš„ IaaS èµ„æºçš„åˆ›å»ºï¼Œæ˜¯è¦è‡ªå·±æå‰å‡†å¤‡å¥½ã€‚ä½†æ˜¯åœ¨ä¸€äº›ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒä¸­ï¼Œä½¿ç”¨äº†å¦‚ VMware vShpere æˆ– OpenS">
<meta property="og:type" content="article">
<meta property="og:title" content="VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ">
<meta property="og:url" content="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="ä¹‹å‰æ¥è§¦çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·å¤§å¤šæ•°éƒ½æ˜¯ä¾èµ–äº ssh è¿æ¥åˆ°å¾…éƒ¨ç½²çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œéƒ¨ç½²æ“ä½œï¼Œè¿™æ ·å°±è¦æ±‚éƒ¨ç½²å‰éœ€è¦æå‰å‡†å¤‡å¥½é›†ç¾¤èŠ‚ç‚¹ï¼Œä¸”è¦ä¿è¯è¿™äº›èŠ‚ç‚¹çš„ç½‘ç»œäº’é€šä»¥åŠæ—¶é’ŸåŒæ­¥ç­‰é—®é¢˜ã€‚ç±»ä¼¼äº kubespray æˆ–è€… kubekey è¿™äº›éƒ¨ç½²å·¥å…·æ˜¯ä¸ä¼šå»ç®¡è¿™äº›åº•å±‚çš„ IaaS èµ„æºçš„åˆ›å»ºï¼Œæ˜¯è¦è‡ªå·±æå‰å‡†å¤‡å¥½ã€‚ä½†æ˜¯åœ¨ä¸€äº›ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒä¸­ï¼Œä½¿ç”¨äº†å¦‚ VMware vShpere æˆ– OpenS">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/2022-01-22-deploy-tanzu-k8s-cluster-01.jpg">
<meta property="article:published_time" content="2022-02-05T16:00:00.000Z">
<meta property="article:modified_time" content="2022-02-05T16:00:00.000Z">
<meta property="article:author" content="æœ¨å­">
<meta property="article:tag" content="ESXi">
<meta property="article:tag" content="Tanzu">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="Cluster-api">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/2022-01-22-deploy-tanzu-k8s-cluster-01.jpg">

<link rel="canonical" href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ | Reimu's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Reimu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-desktop"></i>Home</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Books</a>

  </li>
        <li class="menu-item menu-item-kindle">

    <a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>

  </li>
        <li class="menu-item menu-item-friends">

    <a href="/friends.html" rel="section"><i class="fa fa-fw fa-link"></i>Friends</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about.html" rel="section"><i class="fa fa-fw fa-user-circle-o"></i>About</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/deploy-tanzu-k8s-cluster.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog.k8s.li/avatar.png">
      <meta itemprop="name" content="æœ¨å­">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2022-02-06 2022-02-06T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2022-02-06T00:00:00+08:00">2022-02-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/deploy-tanzu-k8s-cluster.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="deploy-tanzu-k8s-cluster.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>36k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>59 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>ä¹‹å‰æ¥è§¦çš„ Kubernetes é›†ç¾¤éƒ¨ç½²å·¥å…·å¤§å¤šæ•°éƒ½æ˜¯ä¾èµ–äº ssh è¿æ¥åˆ°å¾…éƒ¨ç½²çš„èŠ‚ç‚¹ä¸Šè¿›è¡Œéƒ¨ç½²æ“ä½œï¼Œè¿™æ ·å°±è¦æ±‚éƒ¨ç½²å‰éœ€è¦æå‰å‡†å¤‡å¥½é›†ç¾¤èŠ‚ç‚¹ï¼Œä¸”è¦ä¿è¯è¿™äº›èŠ‚ç‚¹çš„ç½‘ç»œäº’é€šä»¥åŠæ—¶é’ŸåŒæ­¥ç­‰é—®é¢˜ã€‚ç±»ä¼¼äº kubespray æˆ–è€… kubekey è¿™äº›éƒ¨ç½²å·¥å…·æ˜¯ä¸ä¼šå»ç®¡è¿™äº›åº•å±‚çš„ IaaS èµ„æºçš„åˆ›å»ºï¼Œæ˜¯è¦è‡ªå·±æå‰å‡†å¤‡å¥½ã€‚ä½†æ˜¯åœ¨ä¸€äº›ä¼ä¸šç§æœ‰äº‘ç¯å¢ƒä¸­ï¼Œä½¿ç”¨äº†å¦‚ <a href="https://docs.vmware.com/cn/VMware-vSphere/index.html" target="_blank" rel="noopener">VMware vShpere</a> æˆ– <a href="https://www.openstack.org/" target="_blank" rel="noopener">OpenStack</a> è¿™äº›è™šæ‹ŸåŒ–å¹³å°ï¼Œæ˜¯å¯ä»¥å°† K8s é›†ç¾¤éƒ¨ç½²ä¸ IaaS èµ„æºåˆ›å»ºè¿™ä¸¤æ­¥ç»Ÿä¸€èµ·æ¥çš„ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…æ‰‹åŠ¨åˆ›å»ºå’Œé…ç½®è™šæ‹Ÿæœºè¿™äº›ç¹ççš„æ­¥éª¤ã€‚</p>
<p>ç›®å‰å°† IaaS èµ„æºåˆ›å»ºä¸ K8s é›†ç¾¤éƒ¨ç½²ç»“åˆèµ·æ¥ä¹Ÿæœ‰æ¯”è¾ƒæˆç†Ÿçš„æ–¹æ¡ˆï¼Œæ¯”å¦‚åŸºäº <a href="https://github.com/kubernetes-sigs/cluster-api" target="_blank" rel="noopener">cluster-api</a> é¡¹ç›®çš„ <a href="https://github.com/vmware-tanzu" target="_blank" rel="noopener">tanzu</a> ã€‚æœ¬æ–‡å°±ä»¥ <a href="https://github.com/vmware-tanzu/community-edition" target="_blank" rel="noopener">VMware Tanzu ç¤¾åŒºç‰ˆ</a> ä¸ºä¾‹åœ¨ä¸€å°ç‰©ç†æœåŠ¡å™¨ä¸Šï¼Œä»å®‰è£… ESXi OS åˆ°éƒ¨ç½²å®Œæˆ Tanzu Workload é›†ç¾¤ï¼Œæ¥ä½“éªŒä¸€ä¸‹è¿™ç§éƒ¨ç½²æ–¹æ¡ˆçš„ä¸ä¼—ä¸åŒä¹‹å¤„ã€‚</p>
<h2 id="éƒ¨ç½²æµç¨‹"><a href="#éƒ¨ç½²æµç¨‹" class="headerlink" title="éƒ¨ç½²æµç¨‹"></a>éƒ¨ç½²æµç¨‹</h2><ul>
<li>ä¸‹è½½ä¾èµ–æ–‡ä»¶</li>
<li>å®‰è£… govc ä¾èµ–</li>
<li>å®‰è£… ESXi OS</li>
<li>å®‰è£… vCenter</li>
<li>é…ç½® vCenter</li>
<li>åˆ›å»º bootstrap è™šæ‹Ÿæœº</li>
<li>åˆå§‹åŒ– bootstrap èŠ‚ç‚¹</li>
<li>éƒ¨ç½² Tanzu Manager é›†ç¾¤</li>
<li>éƒ¨ç½² Tanzu Workload é›†ç¾¤</li>
</ul>
<h3 id="åŠé€€ä¸‰è¿-ğŸ˜‚"><a href="#åŠé€€ä¸‰è¿-ğŸ˜‚" class="headerlink" title="åŠé€€ä¸‰è¿ ğŸ˜‚"></a>åŠé€€ä¸‰è¿ ğŸ˜‚</h3><ul>
<li><p>éœ€è¦æœ‰ä¸€ä¸ª <a href="https://customerconnect.vmware.com/login" target="_blank" rel="noopener">VMware çš„è´¦æˆ·</a> ç”¨äºä¸‹è½½ä¸€äº› ISO é•œåƒå’Œè™šæ‹Ÿæœºæ¨¡ç‰ˆ;</p>
</li>
<li><p>éœ€è¦æœ‰ä¸€å°ç‰©ç†æœåŠ¡å™¨ï¼Œæ¨èæœ€ä½é…ç½® 8C 32Gï¼Œè‡³å°‘ 256GB å­˜å‚¨ï¼›</p>
</li>
<li><p>éœ€è¦ä¸€å° DHCP æœåŠ¡å™¨ï¼Œç”±äºé»˜è®¤æ˜¯ä½¿ç”¨ DHCP è·å– IP æ¥åˆ†é…ç»™è™šæ‹Ÿæœºçš„ï¼Œå› æ­¤ ESXi æ‰€åœ¨çš„ VM Network  ç½‘ç»œä¸­å¿…é¡»æœ‰ä¸€å° DHCP æœåŠ¡å™¨ç”¨äºç»™è™šæ‹Ÿæœºåˆ†é… IPï¼›</p>
</li>
</ul>
<h3 id="ä¸‹è½½ä¾èµ–æ–‡ä»¶"><a href="#ä¸‹è½½ä¾èµ–æ–‡ä»¶" class="headerlink" title="ä¸‹è½½ä¾èµ–æ–‡ä»¶"></a>ä¸‹è½½ä¾èµ–æ–‡ä»¶</h3><p>æ•´ä¸ªéƒ¨ç½²æµç¨‹æ‰€éœ€è¦çš„ä¾æ–‡ä»¶èµ–å¦‚ä¸‹ï¼Œå¯ä»¥å…ˆå°†è¿™äº›ä¾èµ–ä¸‹è½½åˆ°æœ¬åœ°çš„æœºå™¨ä¸Šï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@devbox:/root/tanzu <span class="comment"># tree -sh</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ [  12M]  govc_Linux_x86_64.tar.gz</span><br><span class="line">â”œâ”€â”€ [ 895M]  photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</span><br><span class="line">â”œâ”€â”€ [ 225M]  photon-ova-4.0-c001795b80.ova</span><br><span class="line">â”œâ”€â”€ [ 170M]  tce-linux-amd64-v0.9.1.tar.gz</span><br><span class="line">â”œâ”€â”€ [ 9.0G]  VMware-VCSA-all-7.0.3-18778458.iso</span><br><span class="line">â””â”€â”€ [ 390M]  VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>ç”¨é€”</th>
<th>ä¸‹è½½æ–¹å¼</th>
</tr>
</thead>
<tbody><tr>
<td><a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=ESXI70U2A&productId=974&rPId=46384" target="_blank" rel="noopener">VMware-VMvisor-Installer-7.0U2a-17867351.x86_64.iso</a></td>
<td>å®‰è£… ESXi OS</td>
<td>VMware éœ€è´¦æˆ·</td>
</tr>
<tr>
<td><a href="https://customerconnect.vmware.com/downloads/details?downloadGroup=VC70U3C&productId=974&rPId=83853" target="_blank" rel="noopener">VMware-VCSA-all-7.0.3-19234570.iso</a></td>
<td>å®‰è£… vCenter</td>
<td>VMware éœ€è´¦æˆ·</td>
</tr>
<tr>
<td><a href="https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova" target="_blank" rel="noopener">photon-ova-4.0-c001795b80.ova</a></td>
<td>bootstrap èŠ‚ç‚¹</td>
<td>VMware</td>
</tr>
<tr>
<td><a href="https://customerconnect.vmware.com/downloads/get-download?downloadGroup=TCE-090" target="_blank" rel="noopener">photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</a></td>
<td>tanzu é›†ç¾¤èŠ‚ç‚¹</td>
<td>VMware éœ€è´¦æˆ·</td>
</tr>
<tr>
<td><a href="https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz" target="_blank" rel="noopener">tce-linux-amd64-v0.9.1.tar.gz</a></td>
<td>tanzu ç¤¾åŒºç‰ˆ</td>
<td>GitHub release</td>
</tr>
<tr>
<td><a href="https://github.com/vmware/govmomi/releases/download/v0.27.3/govc_Linux_x86_64.tar.gz" target="_blank" rel="noopener">govc_Linux_x86_64.tar.gz</a></td>
<td>å®‰è£…/é…ç½® vCenter</td>
<td>GitHub release</td>
</tr>
</tbody></table>
<p>æ³¨æ„ ESXi å’Œ vCenter çš„ç‰ˆæœ¬æœ€å¥½æ˜¯ 7.0 åŠä»¥ä¸Šï¼Œæˆ‘åªåœ¨ ESXi 7.0.2 å’Œ vCenter 7.0.3 ä¸Šæµ‹è¯•è¿‡ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰äº›å·®å¼‚ï¼›å¦å¤– ESXi çš„ç‰ˆæœ¬ä¸å»ºè®®ä½¿ç”¨æœ€æ–°çš„ 7.0.3ï¼Œå› ä¸ºæœ‰æ¯”è¾ƒä¸¥é‡çš„ bugï¼Œå®˜æ–¹ä¹Ÿå»ºè®®ç”¨æˆ·ç”Ÿäº§ç¯å¢ƒä¸è¦ä½¿ç”¨è¯¥ç‰ˆæœ¬äº† <a href="https://kb.vmware.com/s/article/86287" target="_blank" rel="noopener">vSphere 7.0 Update 3 Critical Known Issues - Workarounds &amp; Fix (86287)</a> ã€‚</p>
<h3 id="å®‰è£…-govc-åŠä¾èµ–"><a href="#å®‰è£…-govc-åŠä¾èµ–" class="headerlink" title="å®‰è£… govc åŠä¾èµ–"></a>å®‰è£… govc åŠä¾èµ–</h3><p>åœ¨æœ¬åœ°æœºå™¨ä¸Šå®‰è£…å¥½ govc å’Œ jqï¼Œè¿™ä¸¤ä¸ªå·¥å…·åé¢åœ¨é…ç½® vCenter çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚</p>
<ul>
<li>macOS</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install govc jq</span><br></pre></td></tr></table></figure>

<ul>
<li>Debian/Ubuntu</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ tar -xf govc_Linux_x86_64.tar.gz -C /usr/<span class="built_in">local</span>/bin</span><br><span class="line">$ apt install jq -y</span><br></pre></td></tr></table></figure>

<ul>
<li>å…¶ä»– Linux å¯ä»¥åœ¨ govc å’Œ jq çš„ GitHub ä¸Šä¸‹è½½å¯¹åº”çš„å®‰è£…æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚</li>
</ul>
<h3 id="å®‰è£…-ESXi-OS"><a href="#å®‰è£…-ESXi-OS" class="headerlink" title="å®‰è£… ESXi OS"></a>å®‰è£… ESXi OS</h3><p>ESXi OS çš„å®‰è£…ç½‘ä¸Šæœ‰å¾ˆå¤šæ•™ç¨‹ï¼Œæ²¡æœ‰å¤ªå¤šå€¼å¾—è®²è§£çš„åœ°æ–¹ï¼Œå› æ­¤å°±å‚ç…§ä¸€ä¸‹å…¶ä»–å¤§ä½¬å†™çš„åšå®¢æˆ–è€…å®˜æ–¹çš„å®‰è£…æ–‡æ¡£ <a href="https://docs.vmware.com/cn/VMware-vSphere/7.0/vsphere-esxi-701-installation-setup-guide.pdf" target="_blank" rel="noopener">VMware ESXi å®‰è£…å’Œè®¾ç½®</a> æ¥å°±è¡Œï¼›éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼ŒESXi OS å®‰è£…æ—¶ VMFSL åˆ†åŒºå°†ä¼šå ç”¨å¤§é‡çš„å­˜å‚¨ç©ºé—´ï¼Œè¿™å°†ä¼šä½¿å¾— ESXi OS å®‰è£…æ‰€åœ¨çš„ç£ç›˜æœ€ç»ˆåˆ›å»ºå‡ºæ¥çš„ datastore æ¯”é¢„æœŸå°å¾ˆå¤šï¼Œè€Œä¸”è¿™ä¸ª VMFSL åˆ†åŒºåœ¨å®‰è£…å¥½ä¹‹åå°±å¾ˆéš¾å†åšè°ƒæ•´äº†ã€‚å› æ­¤å¦‚æœç£ç›˜å­˜å‚¨ç©ºé—´æ¯”è¾ƒç´§å¼ ï¼Œåœ¨å®‰è£… ESXi OS ä¹‹å‰å¯ä»¥è€ƒè™‘ä¸‹å¦‚ä½•å»æ‰è¿™ä¸ªåˆ†åŒºï¼›æˆ–è€…å’Œæˆ‘ä¸€æ ·å°† ESXI OS å®‰è£…åœ¨äº†ä¸€ä¸ª 16G çš„ USB Dom ç›˜ä¸Šï¼Œä¸è¿‡ç”Ÿäº§ç¯å¢ƒä¸å»ºè®®é‡‡ç”¨è¿™ç§æ–¹æ¡ˆ ğŸ˜‚ï¼ˆå…¶å®ä¸ªäººè§‰ç€å®‰è£…åœ¨ U ç›˜ä¸Šé—®é¢˜ä¸å¤§ï¼ŒESXi OS å¯åŠ¨ä¹‹åæ˜¯åŠ è½½åˆ°å†…å­˜ä¸­è¿è¡Œçš„ï¼Œä¸ä¼šå¯¹ U ç›˜æœ‰å¤§é‡çš„è¯»å†™æ“ä½œï¼Œåªä¸è¿‡åœ¨æœºæˆ¿ä¸­ U ç›˜è¢«äººä¸å°å¿ƒæ‹”èµ°å°±å‡‰äº†ã€‚</p>
<ul>
<li>è®¾ç½® govc ç¯å¢ƒå˜é‡</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ESXi èŠ‚ç‚¹çš„ IP</span></span><br><span class="line"><span class="built_in">export</span> ESXI_IP=<span class="string">"192.168.18.47"</span></span><br><span class="line"><span class="comment"># ESXi ç™»å½•çš„ç”¨æˆ·åï¼Œåˆæ¬¡å®‰è£…åé»˜è®¤ä¸º root</span></span><br><span class="line"><span class="built_in">export</span> GOVC_USERNAME=<span class="string">"root"</span></span><br><span class="line"><span class="comment"># åœ¨ ESXi å®‰è£…æ—¶è®¾ç½®çš„ root å¯†ç </span></span><br><span class="line"><span class="built_in">export</span> GOVC_PASSWORD=<span class="string">"admin@2022"</span></span><br><span class="line"><span class="comment"># å…è®¸ä¸å®‰å…¨çš„ SSL è¿æ¥</span></span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://<span class="variable">$&#123;ESXI_IP&#125;</span>"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=datastore1</span><br></pre></td></tr></table></figure>

<ul>
<li>æµ‹è¯• govc æ˜¯å¦èƒ½æ­£å¸¸è¿æ¥ ESXi ä¸»æœº</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Name:              localhost.local</span><br><span class="line">  Path:            /ha-datacenter/host/localhost/localhost</span><br><span class="line">  Manufacturer:    Dell</span><br><span class="line">  Logical CPUs:    20 CPUs @ 2394MHz</span><br><span class="line">  Processor <span class="built_in">type</span>:  Intel(R) Xeon(R) Silver 4210R CPU @ 2.40GHz</span><br><span class="line">  CPU usage:       579 MHz (1.2%)</span><br><span class="line">  Memory:          261765MB</span><br><span class="line">  Memory usage:    16457 MB (6.3%)</span><br><span class="line">  Boot time:       2022-02-02 11:53:59.630124 +0000 UTC</span><br><span class="line">  State:           connected</span><br></pre></td></tr></table></figure>

<h3 id="å®‰è£…-vCenter"><a href="#å®‰è£…-vCenter" class="headerlink" title="å®‰è£… vCenter"></a>å®‰è£… vCenter</h3><p>æŒ‰ç…§ VMware å®˜æ–¹çš„ vCenter å®‰è£…æ–‡æ¡£ <a href="https://docs.vmware.com/cn/VMware-vSphere/7.0/com.vmware.vcenter.install.doc/GUID-8DC3866D-5087-40A2-8067-1361A2AF95BD.html" target="_blank" rel="noopener">å…³äº vCenter Server å®‰è£…å’Œè®¾ç½®</a> æ¥å®‰è£…å®åœ¨æ˜¯è¿‡äºç¹çï¼Œå…¶å®å®˜æ–¹çš„ ISO å®‰è£…æ–¹å¼æ— éæ˜¯è¿è¡Œä¸€ä¸ª installer web æœåŠ¡ï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸Šé…ç½®å¥½ vCenter è™šæ‹Ÿæœºçš„å‚æ•°ï¼Œå†å°†å¡«å†™çš„é…ç½®ä¿¡æ¯åœ¨éƒ¨ç½² vcsa è™šæ‹Ÿæœºçš„æ—¶å€™æ³¨å…¥åˆ° ova çš„é…ç½®å‚æ•°ä¸­ã€‚</p>
<p>çŸ¥é“è¿™ä¸ªå®‰è£…è¿‡ç¨‹çš„åŸç†ä¹‹åæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±é…ç½® vCenter çš„å‚æ•°ä¿¡æ¯ï¼Œç„¶åé€šè¿‡ govc æ¥éƒ¨ç½² ovaï¼›è¿™æ¯”ä½¿ç”¨ UI çš„æ–¹å¼ç®€å•æ–¹ä¾¿å¾ˆå¤šï¼Œæœ€ç»ˆåªéœ€è¦å¡«å†™ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¸€æ¡å‘½ä»¤å°±å¯ä»¥éƒ¨ç½²å®Œæˆå•¦ã€‚</p>
<ul>
<li>é¦–å…ˆæ˜¯æŒ‚è½½ vCenter çš„ ISOï¼Œæ‰¾åˆ° vcsa ova æ–‡ä»¶ï¼Œå®ƒæ˜¯ vCenter è™šæ‹Ÿæœºçš„æ¨¡ç‰ˆ</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mount -o loop VMware-VCSA-all-7.0.3-18778458.iso /mnt</span><br><span class="line">$ ls /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova</span><br><span class="line">/mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova</span><br></pre></td></tr></table></figure>

<ul>
<li>æ ¹æ®è‡ªå·±çš„ç¯å¢ƒä¿¡æ¯ä¿®æ”¹ä¸‹é¢å®‰è£…è„šæœ¬ä¸­çš„ç›¸å…³é…ç½®ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line">VCSA_OVA_FILE=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -o errexit</span><br><span class="line"><span class="built_in">set</span> -o nounset</span><br><span class="line"><span class="built_in">set</span> -o pipefail</span><br><span class="line"></span><br><span class="line"><span class="comment"># ESXi çš„ IP åœ°å€</span></span><br><span class="line"><span class="built_in">export</span> ESXI_IP=<span class="string">"192.168.18.47"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ESXi çš„ç”¨æˆ·å</span></span><br><span class="line"><span class="built_in">export</span> GOVC_USERNAME=<span class="string">"root"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ESXI çš„å¯†ç </span></span><br><span class="line"><span class="built_in">export</span> GOVC_PASSWORD=<span class="string">"admin@2020"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… vCenter è™šæ‹Ÿæœºä½¿ç”¨çš„ datastore åç§°</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=datastore1</span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://<span class="variable">$&#123;ESXI_IP&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter çš„ç™»å½•å¯†ç </span></span><br><span class="line">VM_PASSWORD=<span class="string">"admin@2020"</span></span><br><span class="line"><span class="comment"># vCenter çš„ IP åœ°å€</span></span><br><span class="line">VM_IP=192.168.20.92</span><br><span class="line"><span class="comment"># vCenter è™šæ‹Ÿæœºçš„åç§°</span></span><br><span class="line">VM_NAME=vCenter-Server-Appliance</span><br><span class="line"><span class="comment"># vCenter è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œ</span></span><br><span class="line">VM_NETWORK=<span class="string">"VM Network"</span></span><br><span class="line"><span class="comment"># DNS æœåŠ¡å™¨</span></span><br><span class="line">VM_DNS=<span class="string">"223.6.6.6"</span></span><br><span class="line"><span class="comment"># NTP æœåŠ¡å™¨</span></span><br><span class="line">VM_NTP=<span class="string">"0.pool.ntp.org"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">deploy_vcsa_vm</span></span>()&#123;</span><br><span class="line">    config=$(govc host.info -k -json | jq -r <span class="string">'.HostSystems[].Config'</span>)</span><br><span class="line">    gateway=$(jq -r <span class="string">'.Network.IpRouteConfig.DefaultGateway'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$config</span>"</span>)</span><br><span class="line">    route=$(jq -r <span class="string">'.Network.RouteTableInfo.IpRoute[] | select(.DeviceName == "vmk0") | select(.Gateway == "0.0.0.0")'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$config</span>"</span>)</span><br><span class="line">    prefix=$(jq -r <span class="string">'.PrefixLength'</span> &lt;&lt;&lt;<span class="string">"<span class="variable">$route</span>"</span>)</span><br><span class="line">    opts=(</span><br><span class="line">        cis.vmdir.password=<span class="variable">$&#123;VM_PASSWORD&#125;</span></span><br><span class="line">        cis.appliance.root.passwd=<span class="variable">$&#123;VM_PASSWORD&#125;</span></span><br><span class="line">        cis.appliance.root.shell=/bin/bash</span><br><span class="line">        cis.deployment.node.type=embedded</span><br><span class="line">        cis.vmdir.domain-name=vsphere.local</span><br><span class="line">        cis.vmdir.site-name=VCSA</span><br><span class="line">        cis.appliance.net.addr.family=ipv4</span><br><span class="line">        cis.appliance.ssh.enabled=True</span><br><span class="line">        cis.ceip_enabled=False</span><br><span class="line">        cis.deployment.autoconfig=True</span><br><span class="line">        cis.appliance.net.addr=<span class="variable">$&#123;VM_IP&#125;</span></span><br><span class="line">        cis.appliance.net.prefix=<span class="variable">$&#123;prefix&#125;</span></span><br><span class="line">        cis.appliance.net.dns.servers=<span class="variable">$&#123;VM_DNS&#125;</span></span><br><span class="line">        cis.appliance.net.gateway=<span class="variable">$gateway</span></span><br><span class="line">        cis.appliance.ntp.servers=<span class="string">"<span class="variable">$&#123;VM_NTP&#125;</span>"</span></span><br><span class="line">        cis.appliance.net.mode=static</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    props=$(<span class="built_in">printf</span> -- <span class="string">"guestinfo.%s\n"</span> <span class="string">"<span class="variable">$&#123;opts[@]&#125;</span>"</span> | jq --slurp -R <span class="string">'split("\n") | map(select(. != "")) | map(split("=")) | map(&#123;"Key": .[0], "Value": .[1]&#125;)'</span>)</span><br><span class="line"></span><br><span class="line">    cat &lt;&lt;EOF | govc import.<span class="variable">$&#123;VCSA_OVA_FILE##*.&#125;</span> -options - <span class="string">"<span class="variable">$&#123;VCSA_OVA_FILE&#125;</span>"</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="string">"Name"</span>: <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span>,</span><br><span class="line">    <span class="string">"Deployment"</span>: <span class="string">"tiny"</span>,</span><br><span class="line">    <span class="string">"DiskProvisioning"</span>: <span class="string">"thin"</span>,</span><br><span class="line">    <span class="string">"IPProtocol"</span>: <span class="string">"IPv4"</span>,</span><br><span class="line">    <span class="string">"Annotation"</span>: <span class="string">"VMware vCenter Server Appliance"</span>,</span><br><span class="line">    <span class="string">"PowerOn"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"WaitForIP"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"InjectOvfEnv"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"NetworkMapping"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"Network 1"</span>,</span><br><span class="line">        <span class="string">"Network"</span>: <span class="string">"<span class="variable">$&#123;VM_NETWORK&#125;</span>"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"PropertyMapping"</span>: <span class="variable">$&#123;props&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">deploy_vcsa_vm</span><br><span class="line">govc vm.change -vm <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span> -g vmwarePhoton64Guest</span><br><span class="line">govc vm.power -on <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span></span><br><span class="line">govc vm.ip -a <span class="string">"<span class="variable">$&#123;VM_NAME&#125;</span>"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡è„šæœ¬å®‰è£… vCenterï¼ŒæŒ‡å®šç¬¬ä¸€å‚æ•°ä¸º OVA çš„ç»å¯¹è·¯å¾„ã€‚è¿è¡Œå®Œåå°†ä¼šè‡ªåŠ¨å°† ova å¯¼å…¥åˆ° vCenterï¼Œå¹¶å¯åŠ¨è™šæ‹Ÿæœºï¼›</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‰§è¡Œè¯¥è„šæœ¬ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ vCenter ISO ä¸­ vcsa ova æ–‡ä»¶çš„ç»å¯¹è·¯å¾„</span></span><br><span class="line">$ bash install-vcsa.sh /mnt/vcsa/VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10.ova</span><br><span class="line"></span><br><span class="line">[03-02-22 18:40:19] Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk1.vmdk... OK</span><br><span class="line">[03-02-22 18:41:09] Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk... (29%, 52.5MiB/s)</span><br><span class="line">[03-02-22 18:43:08] Uploading VMware-vCenter-Server-Appliance-7.0.3.00100-18778458_OVF10-disk2.vmdk... OK</span><br><span class="line">[03-02-22 18:43:08] Injecting OVF environment...</span><br><span class="line">Powering on VirtualMachine:3... OK</span><br><span class="line">fe80::20c:29ff:fe03:2f80</span><br></pre></td></tr></table></figure>

<ul>
<li>è®¾ç½® vCenter ç™»å½•çš„ç¯å¢ƒå˜é‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ govc æ¥é…ç½® vCenterï¼Œé€šè¿‡æµè§ˆå™¨ Web UI çš„æ–¹å¼é…ç½®èµ·æ¥æ•ˆç‡æœ‰ç‚¹ä½ï¼Œä¸å¦‚ govc å‘½ä»¤ä¸€æŠŠæ¢­æ–¹ä¾¿ ğŸ˜‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GOVC_URL=<span class="string">"https://192.168.20.92"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_USERNAME=<span class="string">"administrator@vsphere.local"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_PASSWORD=<span class="string">"admin@2022"</span></span><br><span class="line"><span class="built_in">export</span> GOVC_INSECURE=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> GOVC_DATASTORE=datastore1</span><br></pre></td></tr></table></figure>

<ul>
<li>è™šæ‹Ÿæœºå¯åŠ¨åå°†è‡ªåŠ¨è¿›è¡Œ vCenter çš„å®‰è£…é…ç½®ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ vCenter å®‰è£…å¥½ä¹‹åï¼Œä½¿ç”¨ govc about æŸ¥çœ‹ vCenter çš„ä¿¡æ¯ï¼Œå¦‚æœèƒ½æ­£ç¡®æˆ–æ¸ é“è¯´æ˜ vCenter å°±å®‰è£…å¥½äº†ï¼›</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ govc about</span><br><span class="line">FullName:     VMware vCenter Server 7.0.3 build-18778458</span><br><span class="line">Name:         VMware vCenter Server</span><br><span class="line">Vendor:       VMware, Inc.</span><br><span class="line">Version:      7.0.3</span><br><span class="line">Build:        18778458</span><br><span class="line">OS <span class="built_in">type</span>:      linux-x64</span><br><span class="line">API <span class="built_in">type</span>:     VirtualCenter</span><br><span class="line">API version:  7.0.3.0</span><br><span class="line">Product ID:   vpx</span><br><span class="line">UUID:         0b49e119-e38f-4fbc-84a8-d7a0e548027d</span><br></pre></td></tr></table></figure>

<h3 id="é…ç½®-vCenter"><a href="#é…ç½®-vCenter" class="headerlink" title="é…ç½® vCenter"></a>é…ç½® vCenter</h3><p>è¿™ä¸€æ­¥éª¤ä¸»è¦æ˜¯é…ç½® vCenterï¼šåˆ›å»º Datacenterã€clusterã€folder ç­‰èµ„æºï¼Œå¹¶å°† ESXi ä¸»æœºæ·»åŠ åˆ° cluster ä¸­ï¼›</p>
<ul>
<li>é…ç½® vCenter</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»º Datacenter æ•°æ®ä¸­å¿ƒ</span></span><br><span class="line">$ govc datacenter.create SH-IDC</span><br><span class="line"><span class="comment"># åˆ›å»º Cluster é›†ç¾¤</span></span><br><span class="line">$ govc cluster.create -dc=SH-IDC Tanzu-Cluster</span><br><span class="line"><span class="comment"># å°† ESXi ä¸»æœºæ·»åŠ åˆ° Cluster å½“ä¸­</span></span><br><span class="line">$ govc cluster.add -dc=SH-IDC -cluster=Tanzu-Cluster -hostname=192.168.18.47 --username=root -password=<span class="string">'admin@2020'</span> -noverify</span><br><span class="line"><span class="comment"># åˆ›å»º folderï¼Œç”¨äºå°† Tanzu çš„èŠ‚ç‚¹è™šæ‹Ÿæœºå­˜æ”¾åˆ°è¯¥æ–‡ä»¶å¤¹ä¸‹</span></span><br><span class="line">$ govc folder.create /SH-IDC/vm/Tanzu-node</span><br><span class="line"><span class="comment"># å¯¼å…¥ tanzu æ±²å–èŠ‚ç‚¹çš„è™šæ‹Ÿæœº ova æ¨¡ç‰ˆ</span></span><br><span class="line">$ govc import.ova -dc=<span class="string">'SH-IDC'</span> -ds=<span class="string">'datastore1'</span> photon-3-kube-v1.21.2+vmware.1-tkg.2-12816990095845873721.ova</span><br><span class="line"><span class="comment"># å°†è™šæ‹Ÿæœºè½¬æ¢ä¸ºæ¨¡ç‰ˆï¼Œåç»­ tanzu é›†ç¾¤å°†ä»¥è¯¥æ¨¡ç‰ˆåˆ›å»ºè™šæ‹Ÿæœº</span></span><br><span class="line">$ govc vm.markastemplate photon-3-kube-v1.21.2</span><br></pre></td></tr></table></figure>

<h3 id="åˆå§‹åŒ–-bootstrap-èŠ‚ç‚¹"><a href="#åˆå§‹åŒ–-bootstrap-èŠ‚ç‚¹" class="headerlink" title="åˆå§‹åŒ– bootstrap èŠ‚ç‚¹"></a>åˆå§‹åŒ– bootstrap èŠ‚ç‚¹</h3><p>bootstrap èŠ‚ç‚¹èŠ‚ç‚¹æ˜¯ç”¨äºè¿è¡Œ tanzu éƒ¨ç½²å·¥å…·çš„èŠ‚ç‚¹ï¼Œå®˜æ–¹æ˜¯æ”¯æŒ Linux/macOS/Windows ä¸‰ç§æ“ä½œç³»ç»Ÿçš„ï¼Œä½†æœ‰ä¸€äº›æ¯”è¾ƒä¸¥æ ¼çš„è¦æ±‚ï¼š</p>
<table>
<thead>
<tr>
<th>Arch: x86; ARM is currently unsupported</th>
</tr>
</thead>
<tbody><tr>
<td>RAM: 6 GB</td>
</tr>
<tr>
<td>CPU: 2</td>
</tr>
<tr>
<td><a href="https://docs.docker.com/engine/install/" target="_blank" rel="noopener">Docker</a> Add your non-root user account to the docker user group. Create the group if it does not already exist. This lets the Tanzu CLI access the Docker socket, which is owned by the root user. For more information, see steps 1 to 4 in the <a href="https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user" target="_blank" rel="noopener">Manage Docker as a non-root user</a> procedure in the Docker documentation.</td>
</tr>
<tr>
<td><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/" target="_blank" rel="noopener">Kubectl</a></td>
</tr>
<tr>
<td>Latest version of Chrome, Firefox, Safari, Internet Explorer, or Edge</td>
</tr>
<tr>
<td>System time is synchronized with a Network Time Protocol (NTP) server.</td>
</tr>
<tr>
<td>Ensure your bootstrap machine is using <a href="https://man7.org/linux/man-pages/man7/cgroups.7.html" target="_blank" rel="noopener">cgroup v1</a>. For more information, see <a href="https://tanzucommunityedition.io/docs/latest/support-matrix/#check-and-set-the-cgroup" target="_blank" rel="noopener">Check and set the cgroup</a>.</td>
</tr>
</tbody></table>
<p>åœ¨è¿™é‡Œä¸ºäº†é¿å…è¿™äº›éº»çƒ¦çš„é…ç½®ï¼Œæˆ‘å°±ç›´æ¥ä½¿ç”¨çš„ VMware å®˜æ–¹çš„ <a href="https://github.com/vmware/photon/wiki/Downloading-Photon-OS#photon-os-40-rev2-binaries" target="_blank" rel="noopener">Photon OS 4.0 Rev2</a> ï¼Œä¸‹è½½ OVA æ ¼å¼çš„é•œåƒç›´æ¥å¯¼å…¥åˆ° ESXi ä¸»æœºå¯åŠ¨ä¸€å°è™šæ‹Ÿæœºå³å¯ï¼Œèƒ½èŠ‚çœä¸å°‘éº»çƒ¦çš„é…ç½®ï¼›è¿˜æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯åœ¨ä¸€å°å•ç‹¬çš„è™šæ‹Ÿæœºä¸Šè¿è¡Œ tanzu éƒ¨ç½²å·¥å…·ä¸ä¼šæ±¡æŸ“æœ¬åœ°çš„å¼€å‘ç¯å¢ƒã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://packages.vmware.com/photon/4.0/Rev2/ova/photon-ova-4.0-c001795b80.ova</span><br><span class="line"><span class="comment"># å¯¼å…¥ OVA è™šæ‹Ÿæœºæ¨¡ç‰ˆ</span></span><br><span class="line">$ govc import.ova -ds=<span class="string">'datastore1'</span> -name bootstrap-node photon-ova-4.0-c001795b80.ova</span><br><span class="line"><span class="comment"># ä¿®æ”¹ä¸€ä¸‹è™šæ‹Ÿæœºçš„é…ç½®ï¼Œè°ƒæ•´ä¸º 4C8G</span></span><br><span class="line">$ govc vm.change -c 4 -m 8192 -vm bootstrap-node</span><br><span class="line"><span class="comment"># å¼€å¯è™šæ‹Ÿæœº</span></span><br><span class="line">$ govc vm.power -on bootstrap-node</span><br><span class="line"><span class="comment"># æŸ¥çœ‹è™šæ‹Ÿæœºè·å–åˆ°çš„ IPv4 åœ°å€</span></span><br><span class="line">$ govc vm.ip -a -<span class="built_in">wait</span> 1m bootstrap-node</span><br><span class="line">$ ssh root@192.168.74.10</span><br><span class="line"><span class="comment"># å¯†ç é»˜è®¤ä¸º changemeï¼Œè¾“å…¥å®Œå¯†ç ä¹‹åæç¤ºåœ¨è¾“å…¥ä¸€é changemeï¼Œç„¶åå†ä¿®æ”¹æ–°çš„å¯†ç </span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># cat /etc/os-release</span></span><br><span class="line">NAME=<span class="string">"VMware Photon OS"</span></span><br><span class="line">VERSION=<span class="string">"4.0"</span></span><br><span class="line">ID=photon</span><br><span class="line">VERSION_ID=4.0</span><br><span class="line">PRETTY_NAME=<span class="string">"VMware Photon OS/Linux"</span></span><br><span class="line">ANSI_COLOR=<span class="string">"1;34"</span></span><br><span class="line">HOME_URL=<span class="string">"https://vmware.github.io/photon/"</span></span><br><span class="line">BUG_REPORT_URL=<span class="string">"https://github.com/vmware/photon/issues"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å®‰è£…éƒ¨ç½²æ—¶éœ€è¦çš„ä¸€äº›å·¥å…·ï¼ˆåˆ‡ï¼ŒPhoton OS é‡Œç«Ÿç„¶è¿ä¸ª tar å‘½ä»¤éƒ½æ²¡æœ‰ ğŸ˜ </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># tdnf install sudo tar -y</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># curl -LO https://dl.k8s.io/release/v1.21.2/bin/linux/amd64/kubectl</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl</span></span><br></pre></td></tr></table></figure>

<ul>
<li>å¯åŠ¨ dockerï¼Œbootstrap èŠ‚ç‚¹ä¼šä»¥ kind çš„æ–¹å¼è¿è¡Œä¸€ä¸ª K8s é›†ç¾¤ï¼Œéœ€è¦ç”¨åˆ° dockerã€‚è™½ç„¶å¯ä»¥ä½¿ç”¨å¤–éƒ¨çš„ k8s é›†ç¾¤ï¼Œä½†ä¸æ˜¯å¾ˆæ¨èï¼Œå› ä¸º cluster-api ä¾èµ– k8s çš„ç‰ˆæœ¬ï¼Œä¸èƒ½å¤ªé«˜ä¹Ÿä¸èƒ½å¤ªä½ï¼›</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># systemctl enable docker --now</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ä» <a href="https://github.com/vmware-tanzu/community-edition/releases/tag/v0.9.1" target="_blank" rel="noopener">vmware-tanzu/community-edition</a> ä¸‹è½½ tanzu ç¤¾åŒºç‰ˆçš„å®‰è£…åŒ…ï¼Œç„¶åè§£å‹åå®‰è£…ï¼›</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># curl -LO  https://github.com/vmware-tanzu/community-edition/releases/download/v0.9.1/tce-linux-amd64-v0.9.1.tar.gz</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># tar -xf tce-linux-amd64-v0.9.1.tar.gz</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># cd tce-linux-amd64-v0.9.1/</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># bash install.sh</span></span><br></pre></td></tr></table></figure>

<p>ç„¶è€Œä¸å¹¸åœ°ç¿»è½¦äº†ï¼Œ install.sh è„šæœ¬ä¸­ç¦æ­¢ root ç”¨æˆ·è¿è¡Œ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ ALLOW_INSTALL_AS_ROOT=</span><br><span class="line">+ [[ 0 -eq 0 ]]</span><br><span class="line">+ [[ <span class="string">''</span> != \t\r\u\e ]]</span><br><span class="line">+ <span class="built_in">echo</span> <span class="string">'Do not run this script as root'</span></span><br><span class="line">Do not run this script as root</span><br><span class="line">+ <span class="built_in">exit</span> 1</span><br></pre></td></tr></table></figure>

<p>æˆ‘å°±ååè¦ä»¥ root ç”¨æˆ·æ¥è¿è¡Œæ€ä¹ˆæƒ¹ ğŸ˜¡</p>
<p><img src="https://p.k8s.li/2022-01-22-deploy-tanzu-k8s-cluster-01.jpg" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sed å»æ‰ç¬¬ä¸€ä¸ª exit 1 å°±å¯ä»¥äº†</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># sed -i.bak "s/exit 1//" install.sh</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># bash install.sh</span></span><br></pre></td></tr></table></figure>

<p>å®‰è£…å¥½ä¹‹åä¼šè¾“å‡º <code>Installation complete!</code>ï¼ˆè®²çœŸå®˜æ–¹çš„ install.sh è„šæœ¬è¾“å‡ºå¾ˆä¸å‹å¥½ï¼Œæ±¡æŸ“æˆ‘çš„ terminal</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+ tanzu init</span><br><span class="line">| initializing âœ”  successfully initialized CLI</span><br><span class="line">++ tanzu plugin repo list</span><br><span class="line">++ grep tce</span><br><span class="line">+ TCE_REPO=</span><br><span class="line">+ [[ -z <span class="string">''</span> ]]</span><br><span class="line">+ tanzu plugin repo add --name tce --gcp-bucket-name tce-tanzu-cli-plugins --gcp-root-path artifacts</span><br><span class="line">++ tanzu plugin repo list</span><br><span class="line">++ grep core-admin</span><br><span class="line">+ TCE_REPO=</span><br><span class="line">+ [[ -z <span class="string">''</span> ]]</span><br><span class="line">+ tanzu plugin repo add --name core-admin --gcp-bucket-name tce-tanzu-cli-framework-admin --gcp-root-path artifacts-admin</span><br><span class="line">+ <span class="built_in">echo</span> <span class="string">'Installation complete!'</span></span><br><span class="line">Installation complete!</span><br></pre></td></tr></table></figure>

<h3 id="éƒ¨ç½²ç®¡ç†é›†ç¾¤"><a href="#éƒ¨ç½²ç®¡ç†é›†ç¾¤" class="headerlink" title="éƒ¨ç½²ç®¡ç†é›†ç¾¤"></a>éƒ¨ç½²ç®¡ç†é›†ç¾¤</h3><p>å…ˆæ˜¯éƒ¨ç½²ä¸€ä¸ª tanzu çš„ç®¡ç†é›†ç¾¤ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡ <a href="https://tanzucommunityedition.io/docs/latest/getting-started/" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a> æåˆ°çš„é€šè¿‡ Web UI çš„æ–¹å¼ã€‚ç›®å‰è¿™ä¸ª UI ç•Œé¢æ¯”è¾ƒæ‹‰å®ï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥è®©ç”¨æˆ·å¡«å†™ä¸€äº›é…ç½®å‚æ•°ï¼Œç„¶åè°ƒç”¨åå°çš„ tanzu å‘½ä»¤æ¥éƒ¨ç½²é›†ç¾¤ã€‚å¹¶æŠŠé›†ç¾¤éƒ¨ç½²çš„æ—¥å¿—å’Œè¿›åº¦å±•ç¤ºå‡ºæ¥ï¼›éƒ¨ç½²å®Œæˆä¹‹åï¼Œè¿™ä¸ª UI åˆä¸èƒ½ç®¡ç†è¿™äº›é›†ç¾¤ï¼Œåˆä¸æ”¯æŒéƒ¨ç½² workload é›†ç¾¤ï¼ˆ</p>
<p>å¦ä¸€ç§å°±æ˜¯é€šè¿‡ tanzu å‘½ä»¤æŒ‡å®šé…ç½®æ–‡ä»¶æ¥éƒ¨ç½²ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦é€šè¿‡æµè§ˆå™¨åœ¨ web é¡µé¢ä¸Šå‚»ä¹ä¹åœ°ç‚¹æ¥ç‚¹å»å¡«ä¸€äº›å‚æ•°ï¼Œåªéœ€è¦æå‰å¡«å†™å¥½ä¸€ä¸ª yaml æ ¼å¼çš„é…ç½®æ–‡ä»¶å³å¯ã€‚ä¸‹é¢æˆ‘ä»¬å°±é‡‡ç”¨ tanzu å‘½ä»¤æ¥éƒ¨ç½²é›†ç¾¤ï¼Œç®¡ç†é›†ç¾¤çš„é…ç½®æ–‡ä»¶æ¨¡ç‰ˆå¦‚ä¸‹ï¼š</p>
<ul>
<li>tanzu-mgt-cluster.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cluster Pod IP çš„ CIDR</span></span><br><span class="line"><span class="attr">CLUSTER_CIDR:</span> <span class="number">100.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/11</span></span><br><span class="line"><span class="comment"># Service çš„ CIDR</span></span><br><span class="line"><span class="attr">SERVICE_CIDR:</span> <span class="number">100.64</span><span class="number">.0</span><span class="number">.0</span><span class="string">/13</span></span><br><span class="line"><span class="comment"># é›†ç¾¤çš„åç§°</span></span><br><span class="line"><span class="attr">CLUSTER_NAME:</span> <span class="string">tanzu-control-plan</span></span><br><span class="line"><span class="comment"># é›†ç¾¤çš„ç±»å‹</span></span><br><span class="line"><span class="attr">CLUSTER_PLAN:</span> <span class="string">dev</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹çš„ arch</span></span><br><span class="line"><span class="attr">OS_ARCH:</span> <span class="string">amd64</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹çš„ OS åç§°</span></span><br><span class="line"><span class="attr">OS_NAME:</span> <span class="string">photon</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹ OS ç‰ˆæœ¬</span></span><br><span class="line"><span class="attr">OS_VERSION:</span> <span class="string">"3"</span></span><br><span class="line"><span class="comment"># åŸºç¡€è®¾æ–½èµ„æºçš„æä¾›æ–¹</span></span><br><span class="line"><span class="attr">INFRASTRUCTURE_PROVIDER:</span> <span class="string">vsphere</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤çš„ VIP</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_ENDPOINT:</span> <span class="number">192.168</span><span class="number">.75</span><span class="number">.194</span></span><br><span class="line"><span class="comment"># control-plan èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># control-plan èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_MEM_MIB:</span> <span class="string">"8192"</span></span><br><span class="line"><span class="comment"># control-plan èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_NUM_CPUS:</span> <span class="string">"4"</span></span><br><span class="line"><span class="comment"># work èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># work èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_MEM_MIB:</span> <span class="string">"4096"</span></span><br><span class="line"><span class="comment"># work èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_NUM_CPUS:</span> <span class="string">"2"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter çš„ Datacenter è·¯å¾„</span></span><br><span class="line"><span class="attr">VSPHERE_DATACENTER:</span> <span class="string">/SH-IDC</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„ Datastore è·¯å¾„</span></span><br><span class="line"><span class="attr">VSPHERE_DATASTORE:</span> <span class="string">/SH-IDC/datastore/datastore1</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="attr">VSPHERE_FOLDER:</span> <span class="string">/SH-IDC/vm/Tanzu-node</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œ</span></span><br><span class="line"><span class="attr">VSPHERE_NETWORK:</span> <span class="string">/SH-IDC/network/VM</span> <span class="string">Network</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºå…³è”çš„èµ„æºæ± </span></span><br><span class="line"><span class="attr">VSPHERE_RESOURCE_POOL:</span> <span class="string">/SH-IDC/host/Tanzu-Cluster/Resources</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter çš„ IP</span></span><br><span class="line"><span class="attr">VSPHERE_SERVER:</span> <span class="number">192.168</span><span class="number">.75</span><span class="number">.110</span></span><br><span class="line"><span class="comment"># vCenter çš„ç”¨æˆ·å</span></span><br><span class="line"><span class="attr">VSPHERE_USERNAME:</span> <span class="string">administrator@vsphere.local</span></span><br><span class="line"><span class="comment"># vCenter çš„å¯†ç ï¼Œä»¥ base64 ç¼–ç </span></span><br><span class="line"><span class="attr">VSPHERE_PASSWORD:</span> <span class="string">&lt;encoded:base64password&gt;</span></span><br><span class="line"><span class="comment"># vCenter çš„è¯ä¹¦æŒ‡çº¹ï¼Œå¯ä»¥é€šè¿‡ govc about.cert -json | jq -r '.ThumbprintSHA1' è·å–</span></span><br><span class="line"><span class="attr">VSPHERE_TLS_THUMBPRINT:</span> <span class="string">EB:F3:D8:7A:E8:3D:1A:59:B0:DE:73:96:DC:B9:5F:13:86:EF:B6:27</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºæ³¨å…¥çš„ ssh å…¬é’¥ï¼Œéœ€è¦ç”¨å®ƒæ¥ ssh ç™»å½•é›†ç¾¤èŠ‚ç‚¹</span></span><br><span class="line"><span class="attr">VSPHERE_SSH_AUTHORIZED_KEY:</span> <span class="string">ssh-rsa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€äº›é»˜è®¤å‚æ•°</span></span><br><span class="line"><span class="attr">AVI_ENABLE:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">IDENTITY_MANAGEMENT_TYPE:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">ENABLE_AUDIT_LOGGING:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">ENABLE_CEIP_PARTICIPATION:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">TKG_HTTP_PROXY_ENABLED:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">DEPLOY_TKG_ON_VSPHERE7:</span> <span class="string">"true"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡ tanzu CLI éƒ¨ç½²ç®¡ç†é›†ç¾¤</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tanzu management-cluster create --file tanzu-mgt-cluster.yaml -v6</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœæ²¡æœ‰é…ç½® VSPHERE_TLS_THUMBPRINT ä¼šæœ‰ä¸€ä¸ªç¡®è®¤ vSphere thumbprint çš„äº¤äº’ï¼Œè¾“å…¥ Y å°±å¯ä»¥</span></span><br><span class="line">Validating the pre-requisites...</span><br><span class="line">Do you want to <span class="built_in">continue</span> with the vSphere thumbprint EB:F3:D8:7A:E8:3D:1A:59:B0:DE:73:96:DC:B9:5F:13:86:EF:B6:27 [y/N]: y</span><br></pre></td></tr></table></figure>

<h3 id="éƒ¨ç½²æ—¥å¿—"><a href="#éƒ¨ç½²æ—¥å¿—" class="headerlink" title="éƒ¨ç½²æ—¥å¿—"></a>éƒ¨ç½²æ—¥å¿—</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># tanzu management-cluster create --file tanzu-mgt-cluster.yaml -v 6</span></span><br><span class="line">compatibility file (/root/.config/tanzu/tkg/compatibility/tkg-compatibility.yaml) already exists, skipping download</span><br><span class="line">BOM files inside /root/.config/tanzu/tkg/bom already exists, skipping download</span><br><span class="line">CEIP Opt-in status: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Validating the pre-requisites...</span><br><span class="line"></span><br><span class="line">vSphere 7.0 Environment Detected.</span><br><span class="line"></span><br><span class="line">You have connected to a vSphere 7.0 environment <span class="built_in">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includes</span><br><span class="line">an integrated Tanzu Kubernetes Grid Service <span class="built_in">which</span> turns a vSphere cluster into a platform <span class="keyword">for</span> running Kubernetes workloads <span class="keyword">in</span> dedicated</span><br><span class="line">resource pools. Configuring Tanzu Kubernetes Grid Service is <span class="keyword">done</span> through vSphere HTML5 client.</span><br><span class="line"></span><br><span class="line">Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="keyword">in</span> vSphere 7.0 environments. Alternatively you may</span><br><span class="line">deploy a non-integrated Tanzu Kubernetes Grid instance on vSphere 7.0.</span><br><span class="line">Deploying TKG management cluster on vSphere 7.0 ...</span><br><span class="line">Identity Provider not configured. Some authentication features won<span class="string">'t work.</span></span><br><span class="line"><span class="string">Checking if VSPHERE_CONTROL_PLANE_ENDPOINT 192.168.20.94 is already in use</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Setting up management cluster...</span></span><br><span class="line"><span class="string">Validating configuration...</span></span><br><span class="line"><span class="string">Using infrastructure provider vsphere:v0.7.10</span></span><br><span class="line"><span class="string">Generating cluster configuration...</span></span><br><span class="line"><span class="string">Setting up bootstrapper...</span></span><br><span class="line"><span class="string">Fetching configuration for kind node image...</span></span><br><span class="line"><span class="string">kindConfig:</span></span><br><span class="line"><span class="string"> &amp;&#123;&#123;Cluster kind.x-k8s.io/v1alpha4&#125;  [&#123;  map[] [&#123;/var/run/docker.sock /var/run/docker.sock false false &#125;] [] [] []&#125;] &#123; 0  100.96.0.0/11 100.64.0.0/13 false &#125; map[] map[] [apiVersion: kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="string">kind: ClusterConfiguration</span></span><br><span class="line"><span class="string">imageRepository: projects.registry.vmware.com/tkg</span></span><br><span class="line"><span class="string">etcd:</span></span><br><span class="line"><span class="string">  local:</span></span><br><span class="line"><span class="string">    imageRepository: projects.registry.vmware.com/tkg</span></span><br><span class="line"><span class="string">    imageTag: v3.4.13_vmware.15</span></span><br><span class="line"><span class="string">dns:</span></span><br><span class="line"><span class="string">  type: CoreDNS</span></span><br><span class="line"><span class="string">  imageRepository: projects.registry.vmware.com/tkg</span></span><br><span class="line"><span class="string">  imageTag: v1.8.0_vmware.5] [] [] []&#125;</span></span><br><span class="line"><span class="string">Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span></span><br><span class="line"><span class="string">Creating cluster "tkg-kind-c7vj6kds0a6sf43e6210" ...</span></span><br><span class="line"><span class="string">Ensuring node image (projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1) ...</span></span><br><span class="line"><span class="string">Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 ...</span></span><br><span class="line"><span class="string">Preparing nodes ...</span></span><br><span class="line"><span class="string">Writing configuration ...</span></span><br><span class="line"><span class="string">Starting control-plane ...</span></span><br><span class="line"><span class="string">Installing CNI ...</span></span><br><span class="line"><span class="string">Installing StorageClass ...</span></span><br><span class="line"><span class="string">Waiting 2m0s for control-plane = Ready ...</span></span><br><span class="line"><span class="string">Ready after 19s</span></span><br><span class="line"><span class="string">Bootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOL</span></span><br><span class="line"><span class="string">Installing providers on bootstrapper...</span></span><br><span class="line"><span class="string">Fetching providers</span></span><br><span class="line"><span class="string">Installing cert-manager Version="v1.1.0"</span></span><br><span class="line"><span class="string">Waiting for cert-manager to be available...</span></span><br><span class="line"><span class="string">Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"</span></span><br><span class="line"><span class="string">Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"</span></span><br><span class="line"><span class="string">Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"</span></span><br><span class="line"><span class="string">Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"</span></span><br><span class="line"><span class="string">installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"</span></span><br><span class="line"><span class="string">Waiting for provider infrastructure-vsphere</span></span><br><span class="line"><span class="string">Waiting for provider control-plane-kubeadm</span></span><br><span class="line"><span class="string">Waiting for provider cluster-api</span></span><br><span class="line"><span class="string">Waiting for provider bootstrap-kubeadm</span></span><br><span class="line"><span class="string">Waiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and running</span></span><br><span class="line"><span class="string">pods are not yet running for deployment '</span>capi-kubeadm-control-plane-controller-manager<span class="string">' in namespace '</span>capi-kubeadm-control-plane-system<span class="string">', retrying</span></span><br><span class="line"><span class="string">Passed waiting on provider bootstrap-kubeadm after 25.205820854s</span></span><br><span class="line"><span class="string">pods are not yet running for deployment '</span>capi-controller-manager<span class="string">' in namespace '</span>capi-webhook-system<span class="string">', retrying</span></span><br><span class="line"><span class="string">Passed waiting on provider infrastructure-vsphere after 30.185406332s</span></span><br><span class="line"><span class="string">Passed waiting on provider cluster-api after 30.213216243s</span></span><br><span class="line"><span class="string">Success waiting on all providers.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Start creating management cluster...</span></span><br><span class="line"><span class="string">patch cluster object with operation status:</span></span><br><span class="line"><span class="string">	&#123;</span></span><br><span class="line"><span class="string">		"metadata": &#123;</span></span><br><span class="line"><span class="string">			"annotations": &#123;</span></span><br><span class="line"><span class="string">				"TKGOperationInfo" : "&#123;\"Operation\":\"Create\",\"OperationStartTimestamp\":\"2022-02-06 02:35:34.30219421 +0000 UTC\",\"OperationTimeout\":1800&#125;",</span></span><br><span class="line"><span class="string">				"TKGOperationLastObservedTimestamp" : "2022-02-06 02:35:34.30219421 +0000 UTC"</span></span><br><span class="line"><span class="string">			&#125;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">cluster control plane is still being initialized, retrying</span></span><br><span class="line"><span class="string">Getting secret for cluster</span></span><br><span class="line"><span class="string">Waiting for resource tanzu-control-plan-kubeconfig of type *v1.Secret to be up and running</span></span><br><span class="line"><span class="string">Saving management cluster kubeconfig into /root/.kube/config</span></span><br><span class="line"><span class="string">Installing providers on management cluster...</span></span><br><span class="line"><span class="string">Fetching providers</span></span><br><span class="line"><span class="string">Installing cert-manager Version="v1.1.0"</span></span><br><span class="line"><span class="string">Waiting for cert-manager to be available...</span></span><br><span class="line"><span class="string">Installing Provider="cluster-api" Version="v0.3.23" TargetNamespace="capi-system"</span></span><br><span class="line"><span class="string">Installing Provider="bootstrap-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-bootstrap-system"</span></span><br><span class="line"><span class="string">Installing Provider="control-plane-kubeadm" Version="v0.3.23" TargetNamespace="capi-kubeadm-control-plane-system"</span></span><br><span class="line"><span class="string">Installing Provider="infrastructure-vsphere" Version="v0.7.10" TargetNamespace="capv-system"</span></span><br><span class="line"><span class="string">installed  Component=="cluster-api"  Type=="CoreProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="BootstrapProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="kubeadm"  Type=="ControlPlaneProvider"  Version=="v0.3.23"</span></span><br><span class="line"><span class="string">installed  Component=="vsphere"  Type=="InfrastructureProvider"  Version=="v0.7.10"</span></span><br><span class="line"><span class="string">Waiting for provider control-plane-kubeadm</span></span><br><span class="line"><span class="string">Waiting for provider bootstrap-kubeadm</span></span><br><span class="line"><span class="string">Waiting for provider infrastructure-vsphere</span></span><br><span class="line"><span class="string">Waiting for provider cluster-api</span></span><br><span class="line"><span class="string">Waiting for resource capi-kubeadm-control-plane-controller-manager of type *v1.Deployment to be up and running</span></span><br><span class="line"><span class="string">Passed waiting on provider control-plane-kubeadm after 10.046865402s</span></span><br><span class="line"><span class="string">Waiting for resource antrea-controller of type *v1.Deployment to be up and running</span></span><br><span class="line"><span class="string">Moving all Cluster API objects from bootstrap cluster to management cluster...</span></span><br><span class="line"><span class="string">Performing move...</span></span><br><span class="line"><span class="string">Discovering Cluster API objects</span></span><br><span class="line"><span class="string">Moving Cluster API objects Clusters=1</span></span><br><span class="line"><span class="string">Creating objects in the target cluster</span></span><br><span class="line"><span class="string">Deleting objects from the source cluster</span></span><br><span class="line"><span class="string">Waiting for additional components to be up and running...</span></span><br><span class="line"><span class="string">Waiting for packages to be up and running...</span></span><br><span class="line"><span class="string">Waiting for package: antrea</span></span><br><span class="line"><span class="string">Waiting for package: metrics-server</span></span><br><span class="line"><span class="string">Waiting for package: tanzu-addons-manager</span></span><br><span class="line"><span class="string">Waiting for package: vsphere-cpi</span></span><br><span class="line"><span class="string">Waiting for package: vsphere-csi</span></span><br><span class="line"><span class="string">Waiting for resource antrea of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource vsphere-cpi of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource vsphere-csi of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource metrics-server of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Waiting for resource tanzu-addons-manager of type *v1alpha1.PackageInstall to be up and running</span></span><br><span class="line"><span class="string">Successfully reconciled package: antrea</span></span><br><span class="line"><span class="string">Successfully reconciled package: vsphere-csi</span></span><br><span class="line"><span class="string">Successfully reconciled package: metrics-server</span></span><br><span class="line"><span class="string">Context set for management cluster tanzu-control-plan as '</span>tanzu-control-plan-admin@tanzu-control-plan<span class="string">'.</span></span><br><span class="line"><span class="string">Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Management cluster created!</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">You can now create your first workload cluster by running the following:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  tanzu cluster create [name] -f [file]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Some addons might be getting installed! Check their status by running the following:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  kubectl get apps -A</span></span><br></pre></td></tr></table></figure>

<ul>
<li>éƒ¨ç½²å®Œæˆä¹‹åï¼Œå°†ç®¡ç†é›†ç¾¤çš„ kubeconfig æ–‡ä»¶å¤åˆ¶åˆ° kubectl é»˜è®¤çš„ç›®å½•ä¸‹</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># cp $&#123;HOME&#125;/.kube-tkg/config $&#123;HOME&#125;/.kube/config</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ä¿¡æ¯</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç®¡ç†é›†ç¾¤çš„ cluster èµ„æºä¿¡æ¯ï¼Œç®¡ç†é›†ç¾¤çš„ CR é»˜è®¤ä¿å­˜åœ¨äº† tkg-system namespace ä¸‹</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get cluster -A</span></span><br><span class="line">NAMESPACE    NAME                 PHASE</span><br><span class="line">tkg-system   tanzu-control-plan   Provisioned</span><br><span class="line"><span class="comment"># ç®¡ç†é›†ç¾¤çš„ machine èµ„æºä¿¡æ¯</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine -A</span></span><br><span class="line">NAMESPACE    NAME                                       PROVIDERID                                       PHASE         VERSION</span><br><span class="line">tkg-system   tanzu-control-plan-control-plane-gs4bl     vsphere://4239c450-f621-d78e-3c44-4ac8890c0cd3   Running       v1.21.2+vmware.1</span><br><span class="line">tkg-system   tanzu-control-plan-md-0-7cdc97c7c6-kxcnx   vsphere://4239d776-c04c-aacc-db12-3380542a6d03   Provisioned   v1.21.2+vmware.1</span><br><span class="line"><span class="comment"># è¿è¡Œçš„ç»„ä»¶çŠ¶æ€</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get pod -A</span></span><br><span class="line">NAMESPACE                           NAME                                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">capi-kubeadm-bootstrap-system       capi-kubeadm-bootstrap-controller-manager-6494884869-wlzhx       2/2     Running   0          8m37s</span><br><span class="line">capi-kubeadm-control-plane-system   capi-kubeadm-control-plane-controller-manager-857d687b9d-tpznv   2/2     Running   0          8m35s</span><br><span class="line">capi-system                         capi-controller-manager-778bd4dfb9-tkvwg                         2/2     Running   0          8m41s</span><br><span class="line">capi-webhook-system                 capi-controller-manager-9995bdc94-svjm2                          2/2     Running   0          8m41s</span><br><span class="line">capi-webhook-system                 capi-kubeadm-bootstrap-controller-manager-68845b65f8-sllgv       2/2     Running   0          8m38s</span><br><span class="line">capi-webhook-system                 capi-kubeadm-control-plane-controller-manager-9847c6747-vvz6g    2/2     Running   0          8m35s</span><br><span class="line">capi-webhook-system                 capv-controller-manager-55bf67fbd5-4t46v                         2/2     Running   0          8m31s</span><br><span class="line">capv-system                         capv-controller-manager-587fbf697f-bbzs9                         2/2     Running   0          8m31s</span><br><span class="line">cert-manager                        cert-manager-77f6fb8fd5-8tq6n                                    1/1     Running   0          11m</span><br><span class="line">cert-manager                        cert-manager-cainjector-6bd4cff7bb-6vlzx                         1/1     Running   0          11m</span><br><span class="line">cert-manager                        cert-manager-webhook-fbfcb9d6c-qpkbc                             1/1     Running   0          11m</span><br><span class="line">kube-system                         antrea-agent-5m9d4                                               2/2     Running   0          6m</span><br><span class="line">kube-system                         antrea-agent-8mpr7                                               2/2     Running   0          5m40s</span><br><span class="line">kube-system                         antrea-controller-5bbcb98667-hklss                               1/1     Running   0          5m50s</span><br><span class="line">kube-system                         coredns-8dcb5c56b-ckvb7                                          1/1     Running   0          12m</span><br><span class="line">kube-system                         coredns-8dcb5c56b-d98hf                                          1/1     Running   0          12m</span><br><span class="line">kube-system                         etcd-tanzu-control-plan-control-plane-gs4bl                      1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-apiserver-tanzu-control-plan-control-plane-gs4bl            1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-controller-manager-tanzu-control-plan-control-plane-gs4bl   1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-proxy-d4wq4                                                 1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-proxy-nhkgg                                                 1/1     Running   0          11m</span><br><span class="line">kube-system                         kube-scheduler-tanzu-control-plan-control-plane-gs4bl            1/1     Running   0          12m</span><br><span class="line">kube-system                         kube-vip-tanzu-control-plan-control-plane-gs4bl                  1/1     Running   0          12m</span><br><span class="line">kube-system                         metrics-server-59fcb9fcf-xjznj                                   1/1     Running   0          6m29s</span><br><span class="line">kube-system                         vsphere-cloud-controller-manager-kzffm                           1/1     Running   0          5m50s</span><br><span class="line">kube-system                         vsphere-csi-controller-74675c9488-q9h5c                          6/6     Running   0          6m31s</span><br><span class="line">kube-system                         vsphere-csi-node-dmvvr                                           3/3     Running   0          6m31s</span><br><span class="line">kube-system                         vsphere-csi-node-k6x98                                           3/3     Running   0          6m31s</span><br><span class="line">tkg-system                          kapp-controller-6499b8866-xnql7                                  1/1     Running   0          10m</span><br><span class="line">tkg-system                          tanzu-addons-controller-manager-657c587556-rpbjm                 1/1     Running   0          7m58s</span><br><span class="line">tkg-system                          tanzu-capabilities-controller-manager-6ff97656b8-cq7m7           1/1     Running   0          11m</span><br><span class="line">tkr-system                          tkr-controller-manager-6bc455b5d4-wm98s                          1/1     Running   0          10m</span><br></pre></td></tr></table></figure>

<h3 id="éƒ¨ç½²æµç¨‹-1"><a href="#éƒ¨ç½²æµç¨‹-1" class="headerlink" title="éƒ¨ç½²æµç¨‹"></a>éƒ¨ç½²æµç¨‹</h3><p>ç»“åˆ <a href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go" target="_blank" rel="noopener">tanzu çš„æºç </a> å’Œéƒ¨ç½²è¾“å‡ºçš„æ—¥å¿—æˆ‘ä»¬å¤§ä½“å¯ä»¥å¾—çŸ¥ï¼Œtanzu ç®¡ç†é›†ç¾¤éƒ¨ç½²å¤§è‡´åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// management cluster init step constants</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	StepConfigPrerequisite                 = <span class="string">"Configure prerequisite"</span></span><br><span class="line">	StepValidateConfiguration              = <span class="string">"Validate configuration"</span></span><br><span class="line">	StepGenerateClusterConfiguration       = <span class="string">"Generate cluster configuration"</span></span><br><span class="line">	StepSetupBootstrapCluster              = <span class="string">"Setup bootstrap cluster"</span></span><br><span class="line">	StepInstallProvidersOnBootstrapCluster = <span class="string">"Install providers on bootstrap cluster"</span></span><br><span class="line">	StepCreateManagementCluster            = <span class="string">"Create management cluster"</span></span><br><span class="line">	StepInstallProvidersOnRegionalCluster  = <span class="string">"Install providers on management cluster"</span></span><br><span class="line">	StepMoveClusterAPIObjects              = <span class="string">"Move cluster-api objects from bootstrap cluster to management cluster"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// InitRegionSteps management cluster init step sequence</span></span><br><span class="line"><span class="keyword">var</span> InitRegionSteps = []<span class="keyword">string</span>&#123;</span><br><span class="line">	StepConfigPrerequisite,</span><br><span class="line">	StepValidateConfiguration,</span><br><span class="line">	StepGenerateClusterConfiguration,</span><br><span class="line">	StepSetupBootstrapCluster,</span><br><span class="line">	StepInstallProvidersOnBootstrapCluster,</span><br><span class="line">	StepCreateManagementCluster,</span><br><span class="line">	StepInstallProvidersOnRegionalCluster,</span><br><span class="line">	StepMoveClusterAPIObjects,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ConfigPrerequisite å‡†å¤‡é˜¶æ®µï¼Œä¼šä¸‹è½½ <code>tkg-compatibility</code> å’Œ <code>tkg-bom</code>é•œåƒï¼Œç”¨äºæ£€æŸ¥ç¯å¢ƒçš„å…¼å®¹æ€§ï¼›</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Downloading TKG compatibility file from <span class="string">'projects.registry.vmware.com/tkg/framework-zshippable/tkg-compatibility'</span></span><br><span class="line">Downloading the TKG Bill of Materials (BOM) file from <span class="string">'projects.registry.vmware.com/tkg/tkg-bom:v1.4.0'</span></span><br><span class="line">Downloading the TKr Bill of Materials (BOM) file from <span class="string">'projects.registry.vmware.com/tkg/tkr-bom:v1.21.2_vmware.1-tkg.1'</span></span><br><span class="line">ERROR 2022/02/06 02:24:46 svType != tvType; key=release, st=map[string]interface &#123;&#125;, tt=&lt;nil&gt;, sv=map[version:], tv=&lt;nil&gt;</span><br><span class="line">CEIP Opt-in status: <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>ValidateConfiguration é…ç½®æ–‡ä»¶æ ¡éªŒï¼Œæ ¹æ®å¡«å†™çš„å‚æ•°æ ¡éªŒé…ç½®æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠæ£€æŸ¥ vCenter å½“ä¸­æœ‰æ— åŒ¹é…çš„è™šæ‹Ÿæœºæ¨¡ç‰ˆï¼›</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Validating the pre-requisites...</span><br><span class="line"></span><br><span class="line">vSphere 7.0 Environment Detected.</span><br><span class="line"></span><br><span class="line">You have connected to a vSphere 7.0 environment <span class="built_in">which</span> does not have vSphere with Tanzu enabled. vSphere with Tanzu includes</span><br><span class="line">an integrated Tanzu Kubernetes Grid Service <span class="built_in">which</span> turns a vSphere cluster into a platform <span class="keyword">for</span> running Kubernetes workloads <span class="keyword">in</span> dedicated</span><br><span class="line">resource pools. Configuring Tanzu Kubernetes Grid Service is <span class="keyword">done</span> through vSphere HTML5 client.</span><br><span class="line"></span><br><span class="line">Tanzu Kubernetes Grid Service is the preferred way to consume Tanzu Kubernetes Grid <span class="keyword">in</span> vSphere 7.0 environments. Alternatively you may</span><br><span class="line">deploy a non-integrated Tanzu Kubernetes Grid instance on vSphere 7.0.</span><br><span class="line">Deploying TKG management cluster on vSphere 7.0 ...</span><br><span class="line">Identity Provider not configured. Some authentication features won<span class="string">'t work.</span></span><br><span class="line"><span class="string">Checking if VSPHERE_CONTROL_PLANE_ENDPOINT 192.168.20.94 is already in use</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Setting up management cluster...</span></span><br><span class="line"><span class="string">Validating configuration...</span></span><br><span class="line"><span class="string">Using infrastructure provider vsphere:v0.7.10</span></span><br></pre></td></tr></table></figure>

<ul>
<li>GenerateClusterConfiguration ç”Ÿæˆé›†ç¾¤é…ç½®æ–‡ä»¶ä¿¡æ¯ï¼›</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Generating cluster configuration...</span><br></pre></td></tr></table></figure>

<ul>
<li>SetupBootstrapCluster è®¾ç½® bootstrap é›†ç¾¤ï¼Œç›®å‰é»˜è®¤ä¸º kindã€‚ä¼šè¿è¡Œä¸€ä¸ª docker å®¹å™¨ï¼Œé‡Œé¢å¥—å¨ƒè¿è¡Œç€ä¸€ä¸ª k8s é›†ç¾¤ï¼›è¿™ä¸ª bootstrap k8s é›†ç¾¤åªæ˜¯ä¸´æ—¶è¿è¡Œ cluster-api æ¥éƒ¨ç½²ç®¡ç†é›†ç¾¤ç”¨çš„ï¼Œéƒ¨ç½²å®Œæˆä¹‹å bootstrap é›†ç¾¤ä¹Ÿå°±æ²¡ç”¨äº†ï¼Œä¼šè‡ªåŠ¨åˆ æ‰ï¼›</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Setting up bootstrapper...</span><br><span class="line">Fetching configuration <span class="keyword">for</span> kind node image...</span><br><span class="line">kindConfig:</span><br><span class="line"> &amp;&#123;&#123;Cluster kind.x-k8s.io/v1alpha4&#125;  [&#123;  map[] [&#123;/var/run/docker.sock /var/run/docker.sock <span class="literal">false</span> <span class="literal">false</span> &#125;] [] [] []&#125;] &#123; 0  100.96.0.0/11 100.64.0.0/13 <span class="literal">false</span> &#125; map[] map[] [apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">imageRepository: projects.registry.vmware.com/tkg</span><br><span class="line">etcd:</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    imageRepository: projects.registry.vmware.com/tkg</span><br><span class="line">    imageTag: v3.4.13_vmware.15</span><br><span class="line">dns:</span><br><span class="line">  <span class="built_in">type</span>: CoreDNS</span><br><span class="line">  imageRepository: projects.registry.vmware.com/tkg</span><br><span class="line">  imageTag: v1.8.0_vmware.5] [] [] []&#125;</span><br><span class="line">Creating kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span><br><span class="line">Creating cluster <span class="string">"tkg-kind-c7vj6kds0a6sf43e6210"</span> ...</span><br><span class="line">Ensuring node image (projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1) ...</span><br><span class="line">Pulling image: projects.registry.vmware.com/tkg/kind/node:v1.21.2_vmware.1 ...</span><br><span class="line">Preparing nodes ...</span><br><span class="line">Writing configuration ...</span><br><span class="line">Starting control-plane ...</span><br><span class="line">Installing CNI ...</span><br><span class="line">Installing StorageClass ...</span><br><span class="line">Waiting 2m0s <span class="keyword">for</span> control-plane = Ready ...</span><br><span class="line">Ready after 19s</span><br><span class="line">Bootstrapper created. Kubeconfig: /root/.kube-tkg/tmp/config_3fkzTCOL</span><br></pre></td></tr></table></figure>

<ul>
<li>InstallProvidersOnBootstrapCluster åœ¨ bootstrap é›†ç¾¤ä¸Šå®‰è£… cluste-api ç›¸å…³ç»„ä»¶ï¼›</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Installing providers on bootstrapper...</span><br><span class="line">Fetching providers</span><br><span class="line"><span class="comment"># å®‰è£… cert-manager ä¸»è¦æ˜¯ä¸ºäº†ç”Ÿæˆ k8s é›†ç¾¤éƒ¨ç½²æ‰€ä¾èµ–çš„é‚£ä¸€å †è¯ä¹¦</span></span><br><span class="line">Installing cert-manager Version=<span class="string">"v1.1.0"</span></span><br><span class="line">Waiting <span class="keyword">for</span> cert-manager to be available...</span><br><span class="line">Installing Provider=<span class="string">"cluster-api"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-system"</span></span><br><span class="line">Installing Provider=<span class="string">"bootstrap-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-bootstrap-system"</span></span><br><span class="line">Installing Provider=<span class="string">"control-plane-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-control-plane-system"</span></span><br><span class="line">Installing Provider=<span class="string">"infrastructure-vsphere"</span> Version=<span class="string">"v0.7.10"</span> TargetNamespace=<span class="string">"capv-system"</span></span><br><span class="line">installed  Component==<span class="string">"cluster-api"</span>  Type==<span class="string">"CoreProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"BootstrapProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"ControlPlaneProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"vsphere"</span>  Type==<span class="string">"InfrastructureProvider"</span>  Version==<span class="string">"v0.7.10"</span></span><br><span class="line">Waiting <span class="keyword">for</span> provider infrastructure-vsphere</span><br><span class="line">Waiting <span class="keyword">for</span> provider control-plane-kubeadm</span><br><span class="line">Waiting <span class="keyword">for</span> provider cluster-api</span><br><span class="line">Waiting <span class="keyword">for</span> provider bootstrap-kubeadm</span><br><span class="line">Passed waiting on provider infrastructure-vsphere after 30.185406332s</span><br><span class="line">Passed waiting on provider cluster-api after 30.213216243s</span><br><span class="line">Success waiting on all providers.</span><br></pre></td></tr></table></figure>

<ul>
<li>CreateManagementCluster åˆ›å»ºç®¡ç†é›†ç¾¤ï¼Œè¿™ä¸€æ­¥ä¸»è¦æ˜¯åˆ›å»ºè™šæ‹Ÿæœºã€åˆå§‹åŒ–èŠ‚ç‚¹ã€è¿è¡Œ kubeadm éƒ¨ç½² k8s é›†ç¾¤ï¼›</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Start creating management cluster...</span><br><span class="line">patch cluster object with operation status:</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="string">"metadata"</span>: &#123;</span><br><span class="line">			<span class="string">"annotations"</span>: &#123;</span><br><span class="line">				<span class="string">"TKGOperationInfo"</span> : <span class="string">"&#123;\"Operation\":\"Create\",\"OperationStartTimestamp\":\"2022-02-06 02:35:34.30219421 +0000 UTC\",\"OperationTimeout\":1800&#125;"</span>,</span><br><span class="line">				<span class="string">"TKGOperationLastObservedTimestamp"</span> : <span class="string">"2022-02-06 02:35:34.30219421 +0000 UTC"</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">cluster control plane is still being initialized, retrying</span><br><span class="line">Getting secret <span class="keyword">for</span> cluster</span><br><span class="line">Waiting <span class="keyword">for</span> resource tanzu-control-plan-kubeconfig of <span class="built_in">type</span> *v1.Secret to be up and running</span><br><span class="line">Saving management cluster kubeconfig into /root/.kube/config</span><br></pre></td></tr></table></figure>

<ul>
<li>InstallProvidersOnRegionalCluster åœ¨ç®¡ç†é›†ç¾¤ä¸Šå®‰è£… cluster-api ç›¸å…³ç»„ä»¶ï¼›</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Installing providers on management cluster...</span><br><span class="line">Fetching providers</span><br><span class="line">Installing cert-manager Version=<span class="string">"v1.1.0"</span></span><br><span class="line">Waiting <span class="keyword">for</span> cert-manager to be available...</span><br><span class="line">Installing Provider=<span class="string">"cluster-api"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-system"</span></span><br><span class="line">Installing Provider=<span class="string">"bootstrap-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-bootstrap-system"</span></span><br><span class="line">Installing Provider=<span class="string">"control-plane-kubeadm"</span> Version=<span class="string">"v0.3.23"</span> TargetNamespace=<span class="string">"capi-kubeadm-control-plane-system"</span></span><br><span class="line">Installing Provider=<span class="string">"infrastructure-vsphere"</span> Version=<span class="string">"v0.7.10"</span> TargetNamespace=<span class="string">"capv-system"</span></span><br><span class="line">installed  Component==<span class="string">"cluster-api"</span>  Type==<span class="string">"CoreProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"BootstrapProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"kubeadm"</span>  Type==<span class="string">"ControlPlaneProvider"</span>  Version==<span class="string">"v0.3.23"</span></span><br><span class="line">installed  Component==<span class="string">"vsphere"</span>  Type==<span class="string">"InfrastructureProvider"</span>  Version==<span class="string">"v0.7.10"</span></span><br><span class="line">Waiting <span class="keyword">for</span> provider control-plane-kubeadm</span><br><span class="line">Waiting <span class="keyword">for</span> provider bootstrap-kubeadm</span><br><span class="line">Waiting <span class="keyword">for</span> provider infrastructure-vsphere</span><br><span class="line">Waiting <span class="keyword">for</span> provider cluster-api</span><br><span class="line">Waiting <span class="keyword">for</span> resource capv-controller-manager of <span class="built_in">type</span> *v1.Deployment to be up and running</span><br><span class="line">Passed waiting on provider infrastructure-vsphere after 20.091935635s</span><br><span class="line">Passed waiting on provider cluster-api after 20.109419304s</span><br><span class="line">Success waiting on all providers.</span><br><span class="line">Waiting <span class="keyword">for</span> the management cluster to get ready <span class="keyword">for</span> move...</span><br><span class="line">Waiting <span class="keyword">for</span> resource tanzu-control-plan of <span class="built_in">type</span> *v1alpha3.Cluster to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> resources <span class="built_in">type</span> *v1alpha3.MachineDeploymentList to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> resources <span class="built_in">type</span> *v1alpha3.MachineList to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> addons installation...</span><br><span class="line">Waiting <span class="keyword">for</span> resources <span class="built_in">type</span> *v1alpha3.ClusterResourceSetList to be up and running</span><br><span class="line">Waiting <span class="keyword">for</span> resource antrea-controller of <span class="built_in">type</span> *v1.Deployment to be up and running</span><br></pre></td></tr></table></figure>

<ul>
<li>MoveClusterAPIObjects å°† bootstrap é›†ç¾¤ä¸Š cluster-api ç›¸å…³çš„èµ„æºè½¬ç§»åˆ°ç®¡ç†é›†ç¾¤ä¸Šã€‚è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯ä¸ºäº†è¾¾åˆ° self-hosted è‡ªæ‰˜ç®¡çš„åŠŸèƒ½ï¼šå³ç®¡ç†é›†ç¾¤è‡ªèº«çš„æ‰©ç¼©å®¹ä¹Ÿæ˜¯é€šè¿‡ cluster-api æ¥å®Œæˆï¼Œè¿™æ ·å°±ä¸ç”¨å†ä¾èµ–å…ˆå‰çš„é‚£ä¸ª bootstrap é›†ç¾¤äº†ï¼›</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Moving all Cluster API objects from bootstrap cluster to management cluster...</span><br><span class="line">Performing move...</span><br><span class="line">Discovering Cluster API objects</span><br><span class="line">Moving Cluster API objects Clusters=1</span><br><span class="line">Creating objects <span class="keyword">in</span> the target cluster</span><br><span class="line">Deleting objects from the <span class="built_in">source</span> cluster</span><br><span class="line">Context <span class="built_in">set</span> <span class="keyword">for</span> management cluster tanzu-control-plan as <span class="string">'tanzu-control-plan-admin@tanzu-control-plan'</span>.</span><br><span class="line">Deleting kind cluster: tkg-kind-c7vj6kds0a6sf43e6210</span><br><span class="line"></span><br><span class="line">Management cluster created!</span><br><span class="line"></span><br><span class="line">You can now create your first workload cluster by running the following:</span><br><span class="line"></span><br><span class="line">  tanzu cluster create [name] -f [file]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Some addons might be getting installed! Check their status by running the following:</span><br><span class="line"></span><br><span class="line">  kubectl get apps -A</span><br></pre></td></tr></table></figure>

<p>éƒ¨ç½²å®Œæˆåä¼šåˆ é™¤ bootstrap é›†ç¾¤ï¼Œå› ä¸º bootstrap é›†ç¾¤ä¸­çš„èµ„æºå·²ç»è½¬ç§»åˆ°äº†ç®¡ç†é›†ç¾¤ä¸­ï¼Œå®ƒç»§ç»­å­˜åœ¨çš„æ„ä¹‰ä¸å¤§ã€‚</p>
<h2 id="éƒ¨ç½²-workload-é›†ç¾¤"><a href="#éƒ¨ç½²-workload-é›†ç¾¤" class="headerlink" title="éƒ¨ç½² workload é›†ç¾¤"></a>éƒ¨ç½² workload é›†ç¾¤</h2><p>ä¸Šé¢æˆ‘ä»¬åªæ˜¯éƒ¨ç½²å¥½äº†ä¸€ä¸ª tanzu ç®¡ç†é›†ç¾¤ï¼Œæˆ‘ä»¬çœŸæ­£çš„å·¥ä½œè´Ÿè½½å¹¶ä¸é€‚åˆè¿è¡Œåœ¨è¿™ä¸ªé›†ç¾¤ä¸Šï¼Œå› æ­¤æˆ‘ä»¬è¿˜éœ€è¦å†éƒ¨ç½²ä¸€ä¸ª workload é›†ç¾¤ï¼Œç±»ä¼¼äº k8s é›†ç¾¤ä¸­çš„ worker èŠ‚ç‚¹ã€‚éƒ¨ç½² workload é›†ç¾¤çš„æ—¶å€™ä¸å†ä¾èµ– bootstrap é›†ç¾¤ï¼Œè€Œæ˜¯ä½¿ç”¨ç®¡ç†é›†ç¾¤ã€‚</p>
<p>æ ¹æ®å®˜æ–¹æ–‡æ¡£ <a href="https://tanzucommunityedition.io/docs/latest/vsphere-wl-template/" target="_blank" rel="noopener">vSphere Workload Cluster Template</a> ä¸­ç»™å‡ºçš„æ¨¡ç‰ˆåˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œç„¶åå†é€šè¿‡ tanzu å‘½ä»¤æ¥éƒ¨ç½²å³å¯ã€‚é…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cluster Pod IP çš„ CIDR</span></span><br><span class="line"><span class="attr">CLUSTER_CIDR:</span> <span class="number">100.96</span><span class="number">.0</span><span class="number">.0</span><span class="string">/11</span></span><br><span class="line"><span class="comment"># Service çš„ CIDR</span></span><br><span class="line"><span class="attr">SERVICE_CIDR:</span> <span class="number">100.64</span><span class="number">.0</span><span class="number">.0</span><span class="string">/13</span></span><br><span class="line"><span class="comment"># é›†ç¾¤çš„åç§°</span></span><br><span class="line"><span class="attr">CLUSTER_NAME:</span> <span class="string">tanzu-workload-cluster</span></span><br><span class="line"><span class="comment"># é›†ç¾¤çš„ç±»å‹</span></span><br><span class="line"><span class="attr">CLUSTER_PLAN:</span> <span class="string">dev</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹çš„ arch</span></span><br><span class="line"><span class="attr">OS_ARCH:</span> <span class="string">amd64</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹çš„ OS åç§°</span></span><br><span class="line"><span class="attr">OS_NAME:</span> <span class="string">photon</span></span><br><span class="line"><span class="comment"># é›†ç¾¤èŠ‚ç‚¹ OS ç‰ˆæœ¬</span></span><br><span class="line"><span class="attr">OS_VERSION:</span> <span class="string">"3"</span></span><br><span class="line"><span class="comment"># åŸºç¡€è®¾æ–½èµ„æºçš„æä¾›æ–¹</span></span><br><span class="line"><span class="attr">INFRASTRUCTURE_PROVIDER:</span> <span class="string">vsphere</span></span><br><span class="line"><span class="comment"># cluster, machine ç­‰è‡ªå®šä¹‰èµ„æºåˆ›å»ºçš„ namespace</span></span><br><span class="line"><span class="attr">NAMESPACE:</span> <span class="string">default</span></span><br><span class="line"><span class="comment"># CNI é€‰ç”¨ç±»å‹ï¼Œç›®å‰åº”è¯¥åªæ”¯æŒ VMware è‡ªå®¶çš„ antrea</span></span><br><span class="line"><span class="attr">CNI:</span> <span class="string">antrea</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é›†ç¾¤çš„ VIP</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_ENDPOINT:</span> <span class="number">192.168</span><span class="number">.20</span><span class="number">.95</span></span><br><span class="line"><span class="comment"># control-plan èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># control-plan èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_MEM_MIB:</span> <span class="string">"8192"</span></span><br><span class="line"><span class="comment"># control-plan èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span></span><br><span class="line"><span class="attr">VSPHERE_CONTROL_PLANE_NUM_CPUS:</span> <span class="string">"4"</span></span><br><span class="line"><span class="comment"># work èŠ‚ç‚¹çš„ç£ç›˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_DISK_GIB:</span> <span class="string">"20"</span></span><br><span class="line"><span class="comment"># work èŠ‚ç‚¹çš„å†…å­˜å¤§å°</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_MEM_MIB:</span> <span class="string">"4096"</span></span><br><span class="line"><span class="comment"># work èŠ‚ç‚¹çš„ CPU æ ¸å¿ƒæ•°é‡</span></span><br><span class="line"><span class="attr">VSPHERE_WORKER_NUM_CPUS:</span> <span class="string">"2"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter çš„ Datacenter è·¯å¾„</span></span><br><span class="line"><span class="attr">VSPHERE_DATACENTER:</span> <span class="string">/SH-IDC</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„ Datastore è·¯å¾„</span></span><br><span class="line"><span class="attr">VSPHERE_DATASTORE:</span> <span class="string">/SH-IDC/datastore/datastore1</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºåˆ›å»ºçš„æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="attr">VSPHERE_FOLDER:</span> <span class="string">/SH-IDC/vm/Tanzu-node</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºä½¿ç”¨çš„ç½‘ç»œ</span></span><br><span class="line"><span class="attr">VSPHERE_NETWORK:</span> <span class="string">/SH-IDC/network/VM</span> <span class="string">Network</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºå…³è”çš„èµ„æºæ± </span></span><br><span class="line"><span class="attr">VSPHERE_RESOURCE_POOL:</span> <span class="string">/SH-IDC/host/Tanzu-Cluster/Resources</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vCenter çš„ IP</span></span><br><span class="line"><span class="attr">VSPHERE_SERVER:</span> <span class="number">192.168</span><span class="number">.20</span><span class="number">.92</span></span><br><span class="line"><span class="comment"># vCenter çš„ç”¨æˆ·å</span></span><br><span class="line"><span class="attr">VSPHERE_USERNAME:</span> <span class="string">administrator@vsphere.local</span></span><br><span class="line"><span class="comment"># vCenter çš„å¯†ç ï¼Œä»¥ base64 ç¼–ç </span></span><br><span class="line"><span class="attr">VSPHERE_PASSWORD:</span> <span class="string">&lt;encoded:YWRtaW5AMjAyMA==&gt;</span></span><br><span class="line"><span class="comment"># vCenter çš„è¯ä¹¦æŒ‡çº¹ï¼Œå¯ä»¥é€šè¿‡ govc about.cert -json | jq -r '.ThumbprintSHA1' è·å–</span></span><br><span class="line"><span class="attr">VSPHERE_TLS_THUMBPRINT:</span> <span class="string">CB:23:48:E8:93:34:AD:27:D8:FD:88:1C:D7:08:4B:47:9B:12:F4:E0</span></span><br><span class="line"><span class="comment"># è™šæ‹Ÿæœºæ³¨å…¥çš„ ssh å…¬é’¥ï¼Œéœ€è¦ç”¨å®ƒæ¥ ssh ç™»å½•é›†ç¾¤èŠ‚ç‚¹</span></span><br><span class="line"><span class="attr">VSPHERE_SSH_AUTHORIZED_KEY:</span> <span class="string">ssh-rsa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸€äº›é»˜è®¤å‚æ•°</span></span><br><span class="line"><span class="attr">AVI_ENABLE:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">IDENTITY_MANAGEMENT_TYPE:</span> <span class="string">none</span></span><br><span class="line"><span class="attr">ENABLE_AUDIT_LOGGING:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">ENABLE_CEIP_PARTICIPATION:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">TKG_HTTP_PROXY_ENABLED:</span> <span class="string">"false"</span></span><br><span class="line"><span class="attr">DEPLOY_TKG_ON_VSPHERE7:</span> <span class="string">"true"</span></span><br><span class="line"><span class="comment"># æ˜¯å¦å¼€å¯è™šæ‹Ÿæœºå¥åº·æ£€æŸ¥</span></span><br><span class="line"><span class="attr">ENABLE_MHC:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">MHC_UNKNOWN_STATUS_TIMEOUT:</span> <span class="string">5m</span></span><br><span class="line"><span class="attr">MHC_FALSE_STATUS_TIMEOUT:</span> <span class="string">12m</span></span><br><span class="line"><span class="comment"># æ˜¯å¦éƒ¨ç½² vsphere cis ç»„ä»¶</span></span><br><span class="line"><span class="attr">ENABLE_DEFAULT_STORAGE_CLASS:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment"># æ˜¯å¦å¼€å¯é›†ç¾¤è‡ªåŠ¨æ‰©ç¼©å®¹</span></span><br><span class="line"><span class="attr">ENABLE_AUTOSCALER:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡ tanzu å‘½ä»¤æ¥éƒ¨ç½² workload é›†ç¾¤</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># tanzu cluster create tanzu-workload-cluster --file tanzu-workload-cluster.yaml</span></span><br><span class="line">Validating configuration...</span><br><span class="line">Warning: Pinniped configuration not found. Skipping pinniped configuration <span class="keyword">in</span> workload cluster. Please refer to the documentation to check <span class="keyword">if</span> you can configure pinniped on workload cluster manually</span><br><span class="line">Creating workload cluster <span class="string">'tanzu-workload-cluster'</span>...</span><br><span class="line">Waiting <span class="keyword">for</span> cluster to be initialized...</span><br><span class="line">Waiting <span class="keyword">for</span> cluster nodes to be available...</span><br><span class="line">Waiting <span class="keyword">for</span> cluster autoscaler to be available...</span><br><span class="line">Unable to <span class="built_in">wait</span> <span class="keyword">for</span> autoscaler deployment to be ready. reason: deployments.apps <span class="string">"tanzu-workload-cluster-cluster-autoscaler"</span> not found</span><br><span class="line">Waiting <span class="keyword">for</span> addons installation...</span><br><span class="line">Waiting <span class="keyword">for</span> packages to be up and running...</span><br><span class="line">Workload cluster <span class="string">'tanzu-workload-cluster'</span> created</span><br></pre></td></tr></table></figure>

<ul>
<li>éƒ¨ç½²å®Œæˆä¹‹åæŸ¥çœ‹ä¸€ä¸‹é›†ç¾¤çš„ CR ä¿¡æ¯</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get cluster</span></span><br><span class="line">NAME                     PHASE</span><br><span class="line">tanzu-workload-cluster   Provisioned</span><br><span class="line"><span class="comment"># machine çŠ¶æ€å¤„äº Running è¯´æ˜èŠ‚ç‚¹å·²ç»æ­£å¸¸è¿è¡Œäº†</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine</span></span><br><span class="line">NAME                                          PROVIDERID                                       PHASE     VERSION</span><br><span class="line">tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1</span><br></pre></td></tr></table></figure>

<h2 id="æ‰©å®¹é›†ç¾¤"><a href="#æ‰©å®¹é›†ç¾¤" class="headerlink" title="æ‰©å®¹é›†ç¾¤"></a>æ‰©å®¹é›†ç¾¤</h2><p>é›†ç¾¤éƒ¨ç½²å¥½ä¹‹åï¼Œå¦‚æœæƒ³å¯¹é›†ç¾¤èŠ‚ç‚¹è¿›è¡Œæ‰©ç¼©å®¹ï¼Œæˆ‘ä»¬å¯ä»¥åƒ deployment çš„ä¸€æ ·ï¼Œåªéœ€è¦ä¿®æ”¹ä¸€äº› CR çš„ä¿¡æ¯å³å¯ã€‚cluster-api ç›¸å…³ç»„ä»¶ä¼š watch åˆ°è¿™äº› CR çš„å˜åŒ–ï¼Œå¹¶æ ¹æ®å®ƒçš„ spec ä¿¡æ¯è¿›è¡Œä¸€ç³»åˆ—è°ƒè°æ“ä½œã€‚å¦‚æœå½“å‰é›†ç¾¤èŠ‚ç‚¹æ•°é‡ä½äºæ‰€å®šä¹‰çš„èŠ‚ç‚¹å‰¯æœ¬æ•°é‡ï¼Œåˆ™ä¼šè‡ªåŠ¨è°ƒç”¨å¯¹åº”çš„ Provider åˆ›å»ºè™šæ‹Ÿæœºï¼Œå¹¶å¯¹è™šæ‹Ÿæœºè¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œå°†å®ƒè½¬æ¢ä¸º k8s é‡Œçš„ä¸€ä¸ª node èµ„æºï¼›</p>
<h3 id="æ‰©å®¹-control-plan-èŠ‚ç‚¹"><a href="#æ‰©å®¹-control-plan-èŠ‚ç‚¹" class="headerlink" title="æ‰©å®¹ control-plan èŠ‚ç‚¹"></a>æ‰©å®¹ control-plan èŠ‚ç‚¹</h3><p>å³æ‰©å®¹ master èŠ‚ç‚¹ï¼Œé€šè¿‡ä¿®æ”¹ <code>KubeadmControlPlane</code> è¿™ä¸ª CR ä¸­çš„ <code>replicas</code> å‰¯æœ¬æ•°å³å¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl scale kcp tanzu-workload-cluster-control-plane --replicas=3</span></span><br><span class="line"><span class="comment"># å¯ä»¥çœ‹åˆ° machine å·²ç»å¤„äº Provisioning çŠ¶æ€ï¼Œè¯´æ˜é›†ç¾¤èŠ‚ç‚¹å¯¹åº”çš„è™šæ‹Ÿæœºæ­£åœ¨åˆ›å»ºä¸­</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine</span></span><br><span class="line">NAME                                          PROVIDERID                                       PHASE          VERSION</span><br><span class="line">tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running        v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-control-plane-mkmd2                                                     Provisioning   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running        v1.21.2+vmware.1</span><br></pre></td></tr></table></figure>

<h3 id="æ‰©å®¹-work-èŠ‚ç‚¹"><a href="#æ‰©å®¹-work-èŠ‚ç‚¹" class="headerlink" title="æ‰©å®¹ work èŠ‚ç‚¹"></a>æ‰©å®¹ work èŠ‚ç‚¹</h3><p>æ‰©å®¹ worker èŠ‚ç‚¹ï¼Œé€šè¿‡ä¿®æ”¹ <code>MachineDeployment</code> è¿™ä¸ª CR ä¸­çš„ <code>replicas</code> å‰¯æœ¬æ•°å³å¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl scale md tanzu-workload-cluster-md-0 --replicas=3</span></span><br><span class="line">root@photon-machine [ ~ ]<span class="comment"># kubectl get machine</span></span><br><span class="line">NAME                                          PROVIDERID                                       PHASE     VERSION</span><br><span class="line">tanzu-workload-cluster-control-plane-4tdwq    vsphere://423950ac-1c6d-e5ef-3132-77b6a53cf626   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-control-plane-mkmd2    vsphere://4239278c-0503-f03a-08b8-df92286bcdd7   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-control-plane-rt5mb    vsphere://4239c882-2fe5-a394-60c0-616941a6363e   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-4hlqk   vsphere://42395deb-e706-8b4b-a44f-c755c222575c   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-74vdg   vsphere://4239b83b-6003-d990-4555-a72ac4dec484   Running   v1.21.2+vmware.1</span><br><span class="line">tanzu-workload-cluster-md-0-8555bbbfc-ftmlp   vsphere://42399640-8e94-85e5-c4bd-8436d84966e0   Running   v1.21.2+vmware.1</span><br></pre></td></tr></table></figure>

<h2 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h2><p>æœ¬æ–‡åªæ˜¯ä»‹ç»äº† tanzu é›†ç¾¤éƒ¨ç½²çš„å¤§ä½“æµç¨‹ï¼Œé‡Œé¢åŒ…å«äº† cluster-api ç›¸å…³çš„æ¦‚å¿µåœ¨æœ¬æ–‡å¹¶æ²¡æœ‰åšæ·±å…¥çš„åˆ†æï¼Œå› ä¸ºå®åœ¨æ˜¯å¤ªå¤æ‚äº† ğŸ˜‚ï¼Œåˆ°ç°åœ¨æˆ‘è¿˜æ˜¯æ²¡å¤ªç†è§£å…¶ä¸­çš„ä¸€äº›åŸç†ï¼Œå› æ­¤åç»­æˆ‘å†å•ç‹¬å†™ä¸€ç¯‡åšå®¢æ¥è®²è§£ä¸€äº› cluster-api ç›¸å…³çš„å†…å®¹ï¼Œåˆ°é‚£æ—¶å€™åœ¨ç»“åˆæœ¬æ–‡æ¥çœ‹å°±å®¹æ˜“ç†è§£å¾ˆå¤šã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul>
<li><a href="https://github.com/vmware-tanzu/community-edition" target="_blank" rel="noopener">community-edition</a></li>
<li><a href="https://github.com/vmware/photon" target="_blank" rel="noopener">vmware/photon</a></li>
<li><a href="https://github.com/vmware-tanzu/tanzu-framework/blob/main/pkg/v1/tkg/client/init.go" target="_blank" rel="noopener">tanzu-framework</a></li>
<li><a href="https://github.com/kubernetes-sigs/cluster-api-provider-vsphere" target="_blank" rel="noopener">cluster-api-provider-vsphere</a></li>
<li><a href="https://tanzucommunityedition.io/docs/latest/workload-clusters/" target="_blank" rel="noopener">Deploying a workload cluster</a></li>
<li><a href="https://tanzucommunityedition.io/docs/latest/verify-deployment/" target="_blank" rel="noopener">Examine the Management Cluster Deployment</a></li>
<li><a href="https://tanzucommunityedition.io/docs/latest/vsphere/" target="_blank" rel="noopener">Prepare to Deploy a Management or Standalone Clusters to vSphere</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/ESXi/" rel="tag"><i class="fa fa-tag"></i> ESXi</a>
              <a href="/tags/Tanzu/" rel="tag"><i class="fa fa-tag"></i> Tanzu</a>
              <a href="/tags/Kubernetes/" rel="tag"><i class="fa fa-tag"></i> Kubernetes</a>
              <a href="/tags/Cluster-api/" rel="tag"><i class="fa fa-tag"></i> Cluster-api</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/rebuild-iso-image.html" rel="prev" title="ä½¿ç”¨ overlay2 æˆ– bind é‡æ–°æ„å»º ISO é•œåƒ">
      <i class="fa fa-chevron-left"></i> ä½¿ç”¨ overlay2 æˆ– bind é‡æ–°æ„å»º ISO é•œåƒ
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#éƒ¨ç½²æµç¨‹"><span class="nav-number">1.</span> <span class="nav-text">éƒ¨ç½²æµç¨‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#åŠé€€ä¸‰è¿-ğŸ˜‚"><span class="nav-number">1.1.</span> <span class="nav-text">åŠé€€ä¸‰è¿ ğŸ˜‚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ä¸‹è½½ä¾èµ–æ–‡ä»¶"><span class="nav-number">1.2.</span> <span class="nav-text">ä¸‹è½½ä¾èµ–æ–‡ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å®‰è£…-govc-åŠä¾èµ–"><span class="nav-number">1.3.</span> <span class="nav-text">å®‰è£… govc åŠä¾èµ–</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å®‰è£…-ESXi-OS"><span class="nav-number">1.4.</span> <span class="nav-text">å®‰è£… ESXi OS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å®‰è£…-vCenter"><span class="nav-number">1.5.</span> <span class="nav-text">å®‰è£… vCenter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#é…ç½®-vCenter"><span class="nav-number">1.6.</span> <span class="nav-text">é…ç½® vCenter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åˆå§‹åŒ–-bootstrap-èŠ‚ç‚¹"><span class="nav-number">1.7.</span> <span class="nav-text">åˆå§‹åŒ– bootstrap èŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#éƒ¨ç½²ç®¡ç†é›†ç¾¤"><span class="nav-number">1.8.</span> <span class="nav-text">éƒ¨ç½²ç®¡ç†é›†ç¾¤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#éƒ¨ç½²æ—¥å¿—"><span class="nav-number">1.9.</span> <span class="nav-text">éƒ¨ç½²æ—¥å¿—</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#éƒ¨ç½²æµç¨‹-1"><span class="nav-number">1.10.</span> <span class="nav-text">éƒ¨ç½²æµç¨‹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#éƒ¨ç½²-workload-é›†ç¾¤"><span class="nav-number">2.</span> <span class="nav-text">éƒ¨ç½² workload é›†ç¾¤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#æ‰©å®¹é›†ç¾¤"><span class="nav-number">3.</span> <span class="nav-text">æ‰©å®¹é›†ç¾¤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‰©å®¹-control-plan-èŠ‚ç‚¹"><span class="nav-number">3.1.</span> <span class="nav-text">æ‰©å®¹ control-plan èŠ‚ç‚¹</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æ‰©å®¹-work-èŠ‚ç‚¹"><span class="nav-number">3.2.</span> <span class="nav-text">æ‰©å®¹ work èŠ‚ç‚¹</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åç»­"><span class="nav-number">4.</span> <span class="nav-text">åç»­</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">5.</span> <span class="nav-text">å‚è€ƒ</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="æœ¨å­"
      src="https://blog.k8s.li/avatar.png">
  <p class="site-author-name" itemprop="name">æœ¨å­</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">111</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">134</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail â†’ mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tg.k8s.li/" title="Channel â†’ https:&#x2F;&#x2F;tg.k8s.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Channel</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2018 â€“ 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">æœ¨å­</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.6m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">45:45</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://muzi.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://blog.k8s.li/deploy-tanzu-k8s-cluster.html",
            identifier: "deploy-tanzu-k8s-cluster.html",
            title: "VMware Tanzu kubernetes å‘è¡Œç‰ˆéƒ¨ç½²å°é²œ"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://muzi.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
