<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.3.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="咱来推销 webp server go 啦 （x 小声  劝退三连 😂 需要配置 nginx 反向代理（＞﹏＜） 图片必须放在自己的服务器上，图床不得行 (ﾉ*･ω･)ﾉ 需要独立的服务器，GitHub page 之类的不得行（╯︿╰）  不过，对于已经会自由访问互联网的人来说这都不难 (●ˇ∀ˇ●) ，食用过程中有什么疑问的话也可以联系咱，咱会尽自己所能提供一些帮助 😘，一起来完善这个开源">
<meta property="og:type" content="blog">
<meta property="og:title" content="让图片飞起来 oh-my-webp.sh ！">
<meta property="og:url" content="https://blog.k8s.li/oh-my-webpsh.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="咱来推销 webp server go 啦 （x 小声  劝退三连 😂 需要配置 nginx 反向代理（＞﹏＜） 图片必须放在自己的服务器上，图床不得行 (ﾉ*･ω･)ﾉ 需要独立的服务器，GitHub page 之类的不得行（╯︿╰）  不过，对于已经会自由访问互联网的人来说这都不难 (●ˇ∀ˇ●) ，食用过程中有什么疑问的话也可以联系咱，咱会尽自己所能提供一些帮助 😘，一起来完善这个开源">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/20200306094307271.png">
<meta property="og:image" content="https://p.k8s.li/20200307102856702.png">
<meta property="og:image" content="https://p.k8s.li/20200304191400500.png">
<meta property="og:image" content="https://p.k8s.li/no-webp.png">
<meta property="og:image" content="https://p.k8s.li/with-webp.png">
<meta property="article:published_time" content="2020-03-04T16:00:00.000Z">
<meta property="article:modified_time" content="2020-03-05T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/20200306094307271.png">


<link rel="canonical" href="https://blog.k8s.li/oh-my-webpsh.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/oh-my-webpsh.html","path":"oh-my-webpsh.html","title":"让图片飞起来 oh-my-webp.sh ！"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>让图片飞起来 oh-my-webp.sh ！ | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%9D%E9%80%80%E4%B8%89%E8%BF%9E-%F0%9F%98%82"><span class="nav-number">1.</span> <span class="nav-text">劝退三连 😂</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WebP"><span class="nav-number">2.</span> <span class="nav-text">WebP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%AF%E6%8C%81%E6%83%85%E5%86%B5"><span class="nav-number">2.1.</span> <span class="nav-text">支持情况</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#webp-sh"><span class="nav-number">3.</span> <span class="nav-text">webp-sh</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97"><span class="nav-number">4.</span> <span class="nav-text">食用指南</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E4%B8%8B%E8%BD%BD"><span class="nav-number">4.1.</span> <span class="nav-text">1. 下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E9%85%8D%E7%BD%AE"><span class="nav-number">4.2.</span> <span class="nav-text">2. 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E5%90%AF%E5%8A%A8"><span class="nav-number">4.3.</span> <span class="nav-text">3.启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-%E9%A2%84%E5%8A%A0%E8%BD%BD"><span class="nav-number">4.4.</span> <span class="nav-text">4.预加载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#benchmark"><span class="nav-number">5.</span> <span class="nav-text">benchmark</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="nav-number">5.1.</span> <span class="nav-text">测试结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AC%E6%8D%A2%E5%89%8D%E5%90%8E%E5%A4%A7%E5%B0%8F%E5%AF%B9%E6%AF%94"><span class="nav-number">5.2.</span> <span class="nav-text">转换前后大小对比</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%99%85%E6%95%88%E6%9E%9C"><span class="nav-number">6.</span> <span class="nav-text">实际效果</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#no-webps"><span class="nav-number">6.1.</span> <span class="nav-text">no webps</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#webps-yes"><span class="nav-number">6.2.</span> <span class="nav-text">webps yes!</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB"><span class="nav-number">7.</span> <span class="nav-text">推荐阅读</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">119</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">153</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail → mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/oh-my-webpsh.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="让图片飞起来 oh-my-webp.sh ！ | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          让图片飞起来 oh-my-webp.sh ！
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-03-05 2020-03-05T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2020-03-05T00:00:00+08:00">2020-03-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2020-03-06 2020-03-06T00:00:00+08:00" itemprop="dateModified" datetime="2020-03-06T00:00:00+08:00">2020-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/oh-my-webpsh.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="oh-my-webpsh.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>10k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>咱来推销 webp server go 啦 （x 小声</p>
</blockquote>
<h2 id="劝退三连-😂"><a href="#劝退三连-😂" class="headerlink" title="劝退三连 😂"></a>劝退三连 😂</h2><ul>
<li>需要配置 nginx 反向代理（＞﹏＜）</li>
<li>图片必须放在自己的服务器上，图床不得行 (ﾉ*･ω･)ﾉ</li>
<li>需要独立的服务器，GitHub page 之类的不得行（╯︿╰）</li>
</ul>
<p>不过，对于已经会自由访问互联网的人来说这都不难 (●ˇ∀ˇ●) ，食用过程中有什么疑问的话也可以联系咱，咱会尽自己所能提供一些帮助 😘，一起来完善这个开源项目。</p>
<h2 id="WebP"><a href="#WebP" class="headerlink" title="WebP"></a>WebP</h2><blockquote>
<p>WebP 的有损压缩算法是基于 VP8 视频格式的帧内编码[17]，并以 RIFF 作为容器格式。[2] 因此，它是一个具有八位色彩深度和以 1:2 的比例进行色度子采样的亮度-色度模型（YCbCr 4:2:0）的基于块的转换方案。[18] 不含内容的情况下，RIFF 容器要求只需 20 字节的开销，依然能保存额外的 元数据(metadata)。[2] WebP 图像的边长限制为 16383 像素。</p>
</blockquote>
<p>WebP 是一种衍生自 Google VP8 的图像格式，同时支持有损和无损编码。当使用有损模式，它在相同体积提供比 JPG 图像更好的质量；当使用无损模式，它提供比最佳压缩的 PNG 图像更小的体积。简单来说，WebP 图片格式的存在，让我们在 WebP 上展示的图片体积可以有较大幅度的缩小。网站上的图片资源如果使用 WebP，那么自然也会减少这些图片文件的加载时间，也就带来了网站加载性能的提升。关于 webp 图像格式的具体实现细节可以去维基百科或者文末我提到的推荐阅读看一下，总之 webp 很香就是啦 (●’◡’●)</p>
<h3 id="支持情况"><a href="#支持情况" class="headerlink" title="支持情况"></a>支持情况</h3><p>根据 <a target="_blank" rel="noopener" href="https://caniuse.com/#search=webp">caniuse</a> 的统计情况，主流浏览器（接近 80%）都支持 webp 了，如果遇到 Safari 这样的奇葩，咱直接返回原图。IE 浏览器？？</p>
<p><img data-src="https://p.k8s.li/20200306094307271.png"></p>
<h2 id="webp-sh"><a href="#webp-sh" class="headerlink" title="webp-sh"></a>webp-sh</h2><ul>
<li>官网 <a target="_blank" rel="noopener" href="https://webp.sh/">webp.sh</a></li>
<li>GitHub <a target="_blank" rel="noopener" href="https://github.com/webp-sh">webp-sh</a></li>
</ul>
<p>webp server 顾名思义就是 webp 服务器啦，用于将网站里的图片（jpg、png、jpeg 等）转换成 webp 图像编码格式，而且无须修改博客站点内图片的 url ，因此对于访问图片资源的客户端来讲是透明的。主流的 CDN 也支持这样类似的功能，比如 Cloudflare 的 <a href="">Polish</a> ，可以参考 <a target="_blank" rel="noopener" href="https://support.cloudflare.com/hc/en-us/articles/360000607372-Using-Cloudflare-Polish-to-compress-images">Using Cloudflare Polish to compress images</a> 。但是天下没有免费的午餐，图片转码与编码这都是要算力的，都是要计算资源的，都是要 CPU 的，都是要花钱的 😂。说到底还是穷啊（咱 webp server 是开源免费的。</p>
<blockquote>
<p>最重要的一点是——我们访问的 URL 可以完全不用改变，访客访问的依然是 <code>https://image.nova.moe/tsuki/tsuki.jpg</code> ，但是得到的图片格式为：<code>image/webp</code>，而且体积减少了不少。</p>
</blockquote>
<p>其实 webp server 有多种语言都实现了，并且这些仓库还都放在了 <a target="_blank" rel="noopener" href="https://github.com/webp-sh">webp-sh</a> 该 Organizations 下。不过咱比较喜欢 golang 所以就推荐 webp server go 啦 😂，隔壁的 webp server rust 别打我啊（逃</p>
<blockquote>
<p>这个工具就是由 <a target="_blank" rel="noopener" href="https://nova.moe/">Nova 童鞋</a>、 <a target="_blank" rel="noopener" href="https://www.bennythink.com/">Benny</a> 、<a target="_blank" rel="noopener" href="https://blog.0xbbc.com/">cocoa</a> 以及 <a href="https://blog.k8s.li/">muzi</a> 小盆友一起鼓捣的 webp_server_go 啦！</p>
</blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/webp-sh/webp_server_go">webp_server_go</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/webp-sh/webp_server_rs">webp_server_rs</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/webp-sh/webp_server_node">webp_server_node</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/webp-sh/webp_server_java">webp_server_java</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/webp-sh/webp_server_python">webp_server_python</a></li>
</ul>
<h2 id="食用指南"><a href="#食用指南" class="headerlink" title="食用指南"></a>食用指南</h2><h3 id="1-下载"><a href="#1-下载" class="headerlink" title="1. 下载"></a>1. 下载</h3><p>首先到 <a target="_blank" rel="noopener" href="https://github.com/webp-sh/webp_server_go/releases">release</a> 页面下载已经编译好的二进制文件或者根据自己的发行版选择下载 rpm 或 deb 包，在此要注意选择下载符合自己的 arch 和 OS。</p>
<p>至于安装路径，我个人更倾向于放在 <code>/opt/</code> 目录下，因为这个目录下的东西都是自己安装的，而且也不依赖于特定的发行版，方便博客迁移（搬家），搬家的时候直接打包 <code>/opt</code> 目录，然后 scp 一下就卷铺盖走人，多方便呀 😂。</p>
<h3 id="2-配置"><a href="#2-配置" class="headerlink" title="2. 配置"></a>2. 配置</h3><p>食用 webp-server-go 之前选准备好一个 <code>config.json</code> 配置文件，如下：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"HOST"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
  <span class="token property">"PORT"</span><span class="token operator">:</span> <span class="token string">"3333"</span><span class="token punctuation">,</span>
  <span class="token property">"QUALITY"</span><span class="token operator">:</span> <span class="token string">"80"</span><span class="token punctuation">,</span>
  <span class="token property">"IMG_PATH"</span><span class="token operator">:</span> <span class="token string">"/var/www/hexo"</span><span class="token punctuation">,</span>
  <span class="token property">"EXHAUST_PATH"</span><span class="token operator">:</span> <span class="token string">"./dist"</span><span class="token punctuation">,</span>
  <span class="token property">"ALLOWED_TYPES"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"jpg"</span><span class="token punctuation">,</span><span class="token string">"png"</span><span class="token punctuation">,</span><span class="token string">"jpeg"</span><span class="token punctuation">,</span><span class="token string">"bmp"</span><span class="token punctuation">,</span><span class="token string">"gif"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>HOST：对于 webp server 服务来讲只需要监听 127.0.0.1 这个本机地址就可以了，稍后使用 nginx 反向代理一下。</li>
<li>PORT：就是 webp server 服务监听的的端口号，根据自己需求修改</li>
<li>QUALITY：编码的质量，一般推荐 75 ，不过使用 80 也是不错的。</li>
<li>IMG_PATH：网站的根目录，根目录，根目录，一定要配置你图片 url 的根目录。</li>
<li>EXHAUST_PATH：转换后的 webp 图片文件存放位置，提前创建好。</li>
<li>ALLOWED_TYPES：允许转码的图片格式，目前支持这几种。</li>
</ul>
<p>接下来再配置以下 nginx ，下面以我的 hexo 博客为例，hugo 也同样如此。再添加一块 localtion 字段即可，如果你修改了默认端口号的话不要忘记修改为你改之后的端口号。</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">location</span> ~* \.(png|jpg|jpeg)$</span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:3333</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><code>/etc/nginx/conf.d/blog.conf</code></p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">listen</span> [::]:80</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">server_name</span>  blog.k8s.li</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">set</span> <span class="token variable">$base</span> /var/www/hexo/public</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">root</span> <span class="token variable">$base</span>/</span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
            <span class="token directive"><span class="token keyword">index</span>  index.html</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token directive"><span class="token keyword">location</span> ~* \.(png|jpg|jpeg)$</span> <span class="token punctuation">&#123;</span>
            <span class="token directive"><span class="token keyword">proxy_pass</span> http://127.0.0.1:3333</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_hide_header</span> X-Powered-By</span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">proxy_set_header</span> HOST <span class="token variable">$http_host</span></span><span class="token punctuation">;</span>
            <span class="token directive"><span class="token keyword">add_header</span> Cache-Control <span class="token string">'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0'</span></span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不过在此需要注意，nginx 的 location 字段的路径一定要和 webp server <code>config.json</code> 里的 <code>IMG_PATH</code> 相对应，不然会导致请求资源的 uri 与 webp server 转换后的文件路径不一致而导致资源 404 。还有一点就是 location 那里不能仅仅添加 <code>proxy_pass http://127.0.0.1:3333;</code> ，这样浏览器的 UA 会被 nginx 给吃掉 😄，nginx 将请求 proxy 给 webp server 后无法从 headers 那里获取到 UA ，而导致 <code>Safari</code> 浏览器无法正常输出原图。所以以下几行添加在 <code>proxy_pass</code> 下面是必须的：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">proxy_set_header</span> HOST <span class="token variable">$http_host</span></span><span class="token punctuation">;</span>
<span class="token directive"><span class="token keyword">add_header</span> Cache-Control <span class="token string">'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0'</span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>此外感谢好心读者的提醒才发现这个 bug 😘</p>
<p><img data-src="https://p.k8s.li/20200307102856702.png"></p>
<h3 id="3-启动"><a href="#3-启动" class="headerlink" title="3.启动"></a>3.启动</h3><p>手动运行起来很简单，<code>./webp-server -config /path/to/config.json</code> ，如果该服务挂掉了资源就 gg 了，所以还是选用一种稳定持久化的运行方式。咱推荐使用 systemd 来启动，这样 webp server 服务挂掉了也会自动拉起重启一下。首先要创建或修改一下 <code>webps.service</code> 配置文件。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>WebP Server
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://github.com/webp-sh/webp_server_go
<span class="token assign-left variable">After</span><span class="token operator">=</span>nginx.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>simple
<span class="token assign-left variable">StandardError</span><span class="token operator">=</span>journal
<span class="token assign-left variable">AmbientCapabilities</span><span class="token operator">=</span>CAP_NET_BIND_SERVICE
<span class="token assign-left variable">WorkingDirectory</span><span class="token operator">=</span>/opt/webps
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/opt/webps/webp-server <span class="token parameter variable">--config</span> /opt/webps/config.json
<span class="token assign-left variable">ExecReload</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-HUP</span> <span class="token variable">$MAINPID</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always
<span class="token assign-left variable">RestartSec</span><span class="token operator">=</span>3s

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>修改一下 <code>ExecStart=/opt/webps/webp-server --config /opt/webps/config.json</code> 和 <code>WorkingDirectory=/opt/webps</code> 对应的路径。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cp</span> webps.service /lib/systemd/system/
systemctl daemon-reload
systemctl <span class="token builtin class-name">enable</span> webps.service
systemctl start webps.service<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-预加载"><a href="#4-预加载" class="headerlink" title="4.预加载"></a>4.预加载</h3><p>webp-server-go 有个预加载的功能，就是提前将全部的图片资源进行一次转换，这样再次访问图片资源的时候就不必再进行转换，而直接使用已经转换后的 webp 文件即可。这相当于一次 “缓存” 。</p>
<p>使用 <code>./webp-server -jobs 1 -config config.json -prefetch</code> 来进行一次预加载，其中 jobs 后面的数字为你 CPU 的核心数，也可以不用加默认使用全部核心。</p>
<h2 id="benchmark"><a href="#benchmark" class="headerlink" title="benchmark"></a>benchmark</h2><p>说到性能，咱必须得进行一次压测才能放心大胆地推荐各位食用 webp server go 啦，下面得就是咱的测试数据样例。图片的测试样本是咱使用 <a target="_blank" rel="noopener" href="https://github.com/Tsuk1ko/pxder">pxder</a> 爬下来的，总共 10600 张图片，总大小 11.1 GB。如果你也需要这些测试样本的话可以私聊咱发给你。下面就是真实的测试数据。测试环境是 8 core ×3.4G Hz，测试版本为 <a target="_blank" rel="noopener" href="https://github.com/webp-sh/webp_server_go/releases/tag/0.1.0">v0.1.0</a> ，使用的是默认参数配置。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"HOST"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span>
  <span class="token property">"PORT"</span><span class="token operator">:</span> <span class="token string">"3333"</span><span class="token punctuation">,</span>
  <span class="token property">"QUALITY"</span><span class="token operator">:</span> <span class="token string">"80"</span><span class="token punctuation">,</span>
  <span class="token property">"IMG_PATH"</span><span class="token operator">:</span> <span class="token string">"./src"</span><span class="token punctuation">,</span>
  <span class="token property">"EXHAUST_PATH"</span><span class="token operator">:</span> <span class="token string">"./dist"</span><span class="token punctuation">,</span>
  <span class="token property">"ALLOWED_TYPES"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"jpg"</span><span class="token punctuation">,</span><span class="token string">"png"</span><span class="token punctuation">,</span><span class="token string">"jpeg"</span><span class="token punctuation">,</span><span class="token string">"bmp"</span><span class="token punctuation">,</span><span class="token string">"gif"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img data-src="https://p.k8s.li/20200304191400500.png"></p>
<h3 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h3><table>
<thead>
<tr>
<th align="center">file_size_range</th>
<th align="center">file_num</th>
<th align="center">src_size</th>
<th align="center">dist_size</th>
<th align="center">total</th>
<th align="center">user</th>
<th align="center">system</th>
<th align="center">cpu</th>
<th align="center">core</th>
</tr>
</thead>
<tbody><tr>
<td align="center">(10KB,500KB)</td>
<td align="center">4600</td>
<td align="center">1.3G</td>
<td align="center">310M</td>
<td align="center">1:44.49</td>
<td align="center">905.41s</td>
<td align="center">9.55s</td>
<td align="center">875%</td>
<td align="center">8</td>
</tr>
<tr>
<td align="center">(500KB,1MB)</td>
<td align="center">3500</td>
<td align="center">2.4G</td>
<td align="center">361M</td>
<td align="center">2:04.81</td>
<td align="center">1092.50s</td>
<td align="center">7.98s</td>
<td align="center">881%</td>
<td align="center">8</td>
</tr>
<tr>
<td align="center">(1MB,4MB)</td>
<td align="center">2000</td>
<td align="center">3.8G</td>
<td align="center">342M</td>
<td align="center">2:32.64</td>
<td align="center">1345.73s</td>
<td align="center">10.84s</td>
<td align="center">888%</td>
<td align="center">8</td>
</tr>
<tr>
<td align="center">(4MB,32MB)</td>
<td align="center">500</td>
<td align="center">3.6G</td>
<td align="center">246M</td>
<td align="center">1:44.53</td>
<td align="center">916.91s</td>
<td align="center">12.03s</td>
<td align="center">888%</td>
<td align="center">8</td>
</tr>
</tbody></table>
<h4 id="不同核心-total-对比"><a href="#不同核心-total-对比" class="headerlink" title="不同核心 total 对比"></a>不同核心 total 对比</h4><table>
<thead>
<tr>
<th align="center">file_size_range</th>
<th align="center">file_num</th>
<th align="center">src_size</th>
<th align="center">dist_size</th>
<th align="center">8</th>
<th align="center">4</th>
<th align="center">2</th>
<th align="center">1</th>
</tr>
</thead>
<tbody><tr>
<td align="center">(10KB,500KB)</td>
<td align="center">4600</td>
<td align="center">1.3G</td>
<td align="center">310M</td>
<td align="center">1:44.49</td>
<td align="center">2:18.49</td>
<td align="center">3:36.05</td>
<td align="center">5:20.88</td>
</tr>
<tr>
<td align="center">(500KB,1MB)</td>
<td align="center">3500</td>
<td align="center">2.4G</td>
<td align="center">361M</td>
<td align="center">2:04.81</td>
<td align="center">2:49.46</td>
<td align="center">4:16.41</td>
<td align="center">6:28.97</td>
</tr>
<tr>
<td align="center">(1MB,4MB)</td>
<td align="center">2000</td>
<td align="center">3.8G</td>
<td align="center">342M</td>
<td align="center">2:32.64</td>
<td align="center">3:26.18</td>
<td align="center">5:22.15</td>
<td align="center">7:53.45</td>
</tr>
<tr>
<td align="center">(4MB,32MB)</td>
<td align="center">500</td>
<td align="center">3.6G</td>
<td align="center">246M</td>
<td align="center">1:44.53</td>
<td align="center">2:21.22</td>
<td align="center">3:39.16</td>
<td align="center">5:28.65</td>
</tr>
</tbody></table>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">### 10KB-500KB</span>
./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">1</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">632</span>.77s user <span class="token number">11</span>.23s system <span class="token number">200</span>% cpu <span class="token number">5</span>:20.88 total
./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">2</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">639</span>.31s user <span class="token number">8</span>.77s system <span class="token number">299</span>% cpu <span class="token number">3</span>:36.05 total
./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">4</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">676</span>.17s user <span class="token number">8</span>.12s system <span class="token number">494</span>% cpu <span class="token number">2</span>:18.49 total
./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">8</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">905</span>.41s user <span class="token number">9</span>.55s system <span class="token number">875</span>% cpu <span class="token number">1</span>:44.49 total

<span class="token comment">### 500KB-1MB</span>

./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">1</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">767</span>.45s user <span class="token number">10</span>.14s system <span class="token number">199</span>% cpu <span class="token number">6</span>:28.97 total
./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">2</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">778</span>.00s user <span class="token number">8</span>.62s system <span class="token number">295</span>% cpu <span class="token number">4</span>:16.41 total
./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">4</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">831</span>.38s user <span class="token number">7</span>.62s system <span class="token number">495</span>% cpu <span class="token number">2</span>:49.46 total
./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">8</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">1092</span>.50s user <span class="token number">7</span>.98s system <span class="token number">881</span>% cpu <span class="token number">2</span>:04.81 total

<span class="token comment">### 1MB-4MB</span>

./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">1</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">934</span>.22s user <span class="token number">12</span>.45s system <span class="token number">199</span>% cpu <span class="token number">7</span>:53.45 total
./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">2</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">958</span>.41s user <span class="token number">9</span>.41s system <span class="token number">300</span>% cpu <span class="token number">5</span>:22.15 total
./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">4</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">1010</span>.56s user <span class="token number">8</span>.05s system <span class="token number">494</span>% cpu <span class="token number">3</span>:26.18 total
./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">8</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">1345</span>.73s user <span class="token number">10</span>.84s system <span class="token number">888</span>% cpu <span class="token number">2</span>:32.64 total

<span class="token comment">### 4MB-32MB</span>

./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">1</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">641</span>.78s user <span class="token number">10</span>.77s system <span class="token number">187</span>% cpu <span class="token number">5</span>:28.65 total
./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">2</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">643</span>.19s user <span class="token number">9</span>.73s system <span class="token number">297</span>% cpu <span class="token number">3</span>:39.16 total
./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">4</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">688</span>.05s user <span class="token number">9</span>.91s system <span class="token number">494</span>% cpu <span class="token number">2</span>:21.22 total
./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">8</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>  <span class="token number">916</span>.91s user <span class="token number">12</span>.03s system <span class="token number">888</span>% cpu <span class="token number">1</span>:44.53 total<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="转换前后大小对比"><a href="#转换前后大小对比" class="headerlink" title="转换前后大小对比"></a>转换前后大小对比</h3><p>以下咱就截取一小部分的测试结果，完整的日志放在了我的 gist 上 <strong><a target="_blank" rel="noopener" href="https://gist.github.com/muzi502/4f7c4128895ac3f438e7a183df219661">webp-server-go_test.log</a></strong> 。图片都是真是的数据，根据文件名的 ID 可以在 pixiv.net 上找到源文件，相信老司机们都懂得 😂。</p>
<h4 id="10KB-500KB"><a href="#10KB-500KB" class="headerlink" title="(10KB,500KB)"></a>(10KB,500KB)</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">8</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>
<span class="token number">905</span>.41s user <span class="token number">9</span>.55s system <span class="token number">875</span>% cpu <span class="token number">1</span>:44.49 total

src		    	dist		num
<span class="token number">1</span>.3G			310M		<span class="token number">4600</span>
<span class="token number">63304866</span>.png	495K		40K
<span class="token number">40881097</span>.jpg	495K		118K
<span class="token number">21045662</span>.jpg	495K		94K
<span class="token number">67888534</span>.png	495K		73K
<span class="token number">50136421</span>.jpg	495K		62K
<span class="token number">72636668</span>.png	495K		113K
<span class="token number">55156014</span>.jpg	495K		78K
<span class="token number">76671894</span>.png	495K		59K
<span class="token number">64709121</span>.png	495K		67K
<span class="token number">78336881</span>.jpg	495K		77K
<span class="token number">57090512</span>.png	494K		35K
<span class="token number">72153105</span>.jpg	494K		64K
<span class="token number">62457185</span>.png	494K		39K
<span class="token number">44892218</span>.png	494K		96K
<span class="token number">39599640</span>.jpg	494K		39K
<span class="token number">21428544</span>.jpg	493K		76K
<span class="token number">65293876</span>.jpg	493K		68K
<span class="token number">76098632</span>.png	493K		80K
<span class="token number">65418239</span>.jpg	493K		119K
<span class="token number">17900553</span>.jpg	493K		51K
<span class="token number">61511853</span>.jpg	493K		123K
<span class="token number">77984504</span>.png	493K		56K
<span class="token number">54667116</span>.jpg	493K		56K
<span class="token number">75357235</span>.jpg	493K		67K
<span class="token number">21085426</span>.jpg	492K		55K<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="500KB-1MB"><a href="#500KB-1MB" class="headerlink" title="(500KB,1MB)"></a>(500KB,1MB)</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">8</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>
<span class="token number">1092</span>.50s user <span class="token number">7</span>.98s system <span class="token number">881</span>% cpu <span class="token number">2</span>:04.81 total

src				dist		num
<span class="token number">2</span>.4G			361M		<span class="token number">3500</span>

<span class="token number">44937735</span>.png	974K		74K
<span class="token number">56343106</span>.png	974K		49K
<span class="token number">51320479</span>.png	974K		73K
<span class="token number">68346957</span>.jpg	974K		112K
<span class="token number">74882964</span>.png	974K		150K
<span class="token number">76640395</span>.jpg	974K		75K
<span class="token number">62034004</span>.jpg	974K		110K
<span class="token number">59897148</span>.jpg	974K		147K
<span class="token number">46287856</span>.jpg	973K		68K
<span class="token number">54674488</span>.jpg	973K		111K
<span class="token number">42265521</span>.png	973K		51K
<span class="token number">40261146</span>.jpg	973K		135K
<span class="token number">76815098</span>.png	973K		77K
<span class="token number">57095484</span>.png	973K		99K
<span class="token number">65354070</span>.jpg	973K		206K
<span class="token number">24130390</span>.jpg	973K		121K
<span class="token number">73753170</span>.jpg	972K		106K
<span class="token number">64066680</span>.jpg	972K		92K
<span class="token number">72175991</span>.png	972K		49K
<span class="token number">53402985</span>.png	972K		114K
<span class="token number">70710923</span>.png	971K		63K
<span class="token number">76242996</span>.png	971K		63K
<span class="token number">65736419</span>.jpg	971K		728K
<span class="token number">70095856</span>.png	971K		91K
<span class="token number">64284761</span>.png	971K		53K
<span class="token number">73907152</span>.jpg	971K		101K
<span class="token number">62120962</span>.png	970K		85K
<span class="token number">22003560</span>.png	970K		76K
<span class="token number">77293789</span>.jpg	970K		116K
<span class="token number">68647243</span>.png	970K		46K
<span class="token number">54618347</span>.png	970K		59K
<span class="token number">79602155</span>.jpg	969K		120K
<span class="token number">55491641</span>.jpg	968K		119K
<span class="token number">53473372</span>.png	968K		45K
<span class="token number">77569729</span>.jpg	968K		69K
<span class="token number">57420240</span>.png	968K		61K
<span class="token number">69798500</span>.png	968K		74K
<span class="token number">63487148</span>.png	968K		47K
<span class="token number">79687107</span>.jpg	967K		164K
<span class="token number">70081772</span>.jpg	966K		129K
<span class="token number">79623240</span>.jpg	966K		133K
<span class="token number">72535236</span>.jpg	966K		160K
<span class="token number">47680545</span>.png	966K		162K<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="1MB-4MB"><a href="#1MB-4MB" class="headerlink" title="(1MB,4MB)"></a>(1MB,4MB)</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">8</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>
<span class="token number">1345</span>.73s user <span class="token number">10</span>.84s system <span class="token number">888</span>% cpu <span class="token number">2</span>:32.64 total

src		  		dist		num
<span class="token number">3</span>.8G			342M		<span class="token number">2000</span>

<span class="token number">73839511</span>.png	<span class="token number">4</span>.1M		293K
<span class="token number">73839511</span>.png	<span class="token number">4</span>.1M		293K
<span class="token number">66504933</span>.png	<span class="token number">4</span>.1M		107K
<span class="token number">78316050</span>.png	<span class="token number">4</span>.1M		319K
<span class="token number">74264931</span>.png	<span class="token number">4</span>.1M		330K
<span class="token number">74412671</span>.png	<span class="token number">4</span>.1M		186K
<span class="token number">77414892</span>.png	<span class="token number">4</span>.1M		227K
<span class="token number">76442741</span>.png	<span class="token number">4</span>.0M		191K
<span class="token number">71330750</span>.png	<span class="token number">4</span>.0M		199K
<span class="token number">78361206</span>.png	<span class="token number">4</span>.0M		153K
<span class="token number">68763693</span>.png	<span class="token number">4</span>.0M		233K
<span class="token number">67222487</span>.png	<span class="token number">4</span>.0M		368K
<span class="token number">68560466</span>.png	<span class="token number">4</span>.0M		186K
<span class="token number">72437850</span>.png	<span class="token number">4</span>.0M		282K
<span class="token number">67767752</span>.png	<span class="token number">4</span>.0M		203K
<span class="token number">73597995</span>.png	<span class="token number">4</span>.0M		432K
<span class="token number">71506633</span>.png	<span class="token number">4</span>.0M		88K
<span class="token number">77601042</span>.png	<span class="token number">4</span>.0M		726K
<span class="token number">77033762</span>.png	<span class="token number">4</span>.0M		261K
<span class="token number">73436647</span>.jpg	<span class="token number">4</span>.0M		514K
<span class="token number">78099751</span>.png	<span class="token number">4</span>.0M		283K
<span class="token number">73165937</span>.png	<span class="token number">4</span>.0M		202K
<span class="token number">74379006</span>.png	<span class="token number">4</span>.0M		300K
<span class="token number">79274246</span>.png	<span class="token number">4</span>.0M		191K
<span class="token number">69701132</span>.png	<span class="token number">4</span>.0M		129K
<span class="token number">67455430</span>.jpg	<span class="token number">3</span>.9M		397K
<span class="token number">73651880</span>.png	<span class="token number">3</span>.9M		183K
<span class="token number">79152655</span>.png	<span class="token number">3</span>.9M		298K
<span class="token number">73117385</span>.png	<span class="token number">3</span>.9M		258K
<span class="token number">70281950</span>.png	<span class="token number">3</span>.9M		314K
<span class="token number">68501346</span>.png	<span class="token number">3</span>.9M		203K
<span class="token number">78895125</span>.png	<span class="token number">3</span>.9M		310K
<span class="token number">70159814</span>.png	<span class="token number">3</span>.9M		156K
<span class="token number">70764048</span>.jpg	<span class="token number">3</span>.9M		437K<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="4MB-32MB"><a href="#4MB-32MB" class="headerlink" title="(4MB,32MB)"></a>(4MB,32MB)</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./webp-server <span class="token parameter variable">-jobs</span> <span class="token number">8</span> <span class="token parameter variable">-config</span> config.json <span class="token parameter variable">-prefetch</span>
<span class="token number">916</span>.91s user <span class="token number">12</span>.03s system <span class="token number">888</span>% cpu <span class="token number">1</span>:44.53 total

src				dist		num
<span class="token number">3</span>.8G			<span class="token number">3</span>.8G		<span class="token number">500</span>

<span class="token number">78467499</span>.png	32M		<span class="token number">2</span>.8M
<span class="token number">79620324</span>.png	32M
<span class="token number">74975502</span>.png	32M		<span class="token number">3</span>.0M
<span class="token number">74902740</span>.png	31M		<span class="token number">2</span>.6M
<span class="token number">77032574</span>.png	31M		<span class="token number">2</span>.5M
<span class="token number">77673519</span>.png	30M		<span class="token number">2</span>.3M
<span class="token number">77298781</span>.png	29M		<span class="token number">1</span>.4M
<span class="token number">77959551</span>.png	27M		<span class="token number">1</span>.5M
<span class="token number">69987155</span>.png	26M		649K
<span class="token number">74432253</span>.png	25M		<span class="token number">1</span>.6M
<span class="token number">78994948</span>.png	25M		923K
<span class="token number">77218195</span>.png	24M		<span class="token number">1</span>.6M
<span class="token number">72379562</span>.png	22M		251K
<span class="token number">77559996</span>.png	22M		<span class="token number">1</span>.9M
<span class="token number">71522636</span>.png	22M		<span class="token number">1</span>.3M
<span class="token number">78236671</span>.png	21M		<span class="token number">1</span>.7M
<span class="token number">78033540</span>.jpg	20M		<span class="token number">2</span>.7M
<span class="token number">70906047</span>.png	19M		677K
<span class="token number">72498744</span>.png	19M		882K
<span class="token number">73977640</span>.png	19M		523K
<span class="token number">78757823</span>.png	18M		<span class="token number">1</span>.5M
<span class="token number">71588979</span>.png	18M		<span class="token number">1</span>.2M
<span class="token number">75747535</span>.png	17M		<span class="token number">1</span>.2M
<span class="token number">71504158</span>.png	17M		<span class="token number">1</span>.2M
<span class="token number">76969768</span>.png	17M		<span class="token number">1</span>.4M
<span class="token number">77995994</span>.png	17M		568K
<span class="token number">75340699</span>.png	17M		<span class="token number">1</span>.4M
<span class="token number">69821163</span>.png	16M		<span class="token number">1</span>.1M
<span class="token number">70050613</span>.png	16M		<span class="token number">1</span>.1M
<span class="token number">76559411</span>.png	15M		<span class="token number">1</span>.7M
<span class="token number">76576885</span>.png	15M		853K
<span class="token number">75640746</span>.png	15M		<span class="token number">1</span>.4M
<span class="token number">78188732</span>.png	15M		<span class="token number">1</span>.4M
<span class="token number">73355141</span>.png	15M		589K
<span class="token number">75977096</span>.png	15M		<span class="token number">1</span>.4M
<span class="token number">72840608</span>.jpg	15M		<span class="token number">1</span>.8M
<span class="token number">75665779</span>.png	14M		<span class="token number">1</span>.5M
<span class="token number">77898275</span>.png	14M		<span class="token number">1</span>.2M
<span class="token number">79663534</span>.png	13M		<span class="token number">1</span>.2M
<span class="token number">76539246</span>.png	13M		<span class="token number">1</span>.2M
<span class="token number">70598104</span>.png	13M		840K
<span class="token number">78348611</span>.jpg	13M		<span class="token number">2</span>.7M<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="实际效果"><a href="#实际效果" class="headerlink" title="实际效果"></a>实际效果</h2><p>为了做个对比，咱使用  <code>hexo.k8s.li</code> 这个域名为对照组，即输出源文件，使用 <code>blog.k8s.li</code> 这个域名为实验组加上 webp server 来测试，各位读者也可以分别访问这两个域名来实际体验之间的差别，肉眼可见 😂。</p>
<h3 id="no-webps"><a href="#no-webps" class="headerlink" title="no webps"></a>no webps</h3><p>优化建议能节省 138s ，之前也有读者普遍反映图片打开极慢</p>
<p><img data-src="https://p.k8s.li/no-webp.png"></p>
<h3 id="webps-yes"><a href="#webps-yes" class="headerlink" title="webps yes!"></a>webps yes!</h3><p>优化建议能节省 19s ，比不适用 webp 整整减少了将近 2 min😂，看来效果及其明显呀。</p>
<p><img data-src="https://p.k8s.li/with-webp.png"></p>
<p>选择两篇图片比较多的博客，测试链接为 ：</p>
<ul>
<li><code>https://blog.k8s.li/2020-Lunar-New-Year.html</code></li>
<li><code>https://blog.k8s.li/wd-hc310-dc-hdd.html</code></li>
<li><code>https://hexo.k8s.li/2020-Lunar-New-Year.html</code></li>
<li><code>https://hexo.k8s.li/wd-hc310-dc-hdd.html</code></li>
</ul>
<h2 id="推荐阅读"><a href="#推荐阅读" class="headerlink" title="推荐阅读"></a>推荐阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://nova.moe/re-introduce-webp-server/">让站点图片加载速度更快——引入 WebP Server 无缝转换图片为 WebP</a></li>
<li><a target="_blank" rel="noopener" href="https://await.moe/2020/02/note-about-encountered-memory-changes-for-no-reason-in-golang/">记 Golang 下遇到的一回「毫无由头」的内存更改</a></li>
<li><a target="_blank" rel="noopener" href="https://await.moe/2020/02/webp-server-in-rust/">WebP Server in Rust</a></li>
<li><a target="_blank" rel="noopener" href="https://www.bennythink.com/flying-webp.html">个人网站无缝切换图片到 webp</a></li>
<li><a target="_blank" rel="noopener" href="https://halo.run/archives/halo-and-webp">优雅的让 Halo 支持 webp 图片输出</a></li>
<li><a target="_blank" rel="noopener" href="https://vince.xin/2018/09/12/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E2%80%94%E2%80%94%E4%BD%BF%E7%94%A8webp%E6%9D%A5%E4%BC%98%E5%8C%96%E4%BD%A0%E7%9A%84%E5%9B%BE%E7%89%87/">前端性能优化——使用 webp 来优化你的图片 xx</a></li>
<li><a target="_blank" rel="noopener" href="https://aotu.io/notes/2016/06/23/explore-something-of-webp/index.html">探究 WebP 一些事儿</a></li>
<li><a target="_blank" rel="noopener" href="https://developers.google.com/speed/webp">A new image format for the Web</a></li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%8D%9A%E5%AE%A2/" rel="tag"># 博客</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/linux-net-and-iptables.html" rel="prev" title="Linux 网络和 iptables 运行原理">
                  <i class="fa fa-chevron-left"></i> Linux 网络和 iptables 运行原理
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/N1-openwrt.html" rel="next" title="N1 盒子刷入 OpenWrt 并部署 K3s">
                  N1 盒子刷入 OpenWrt 并部署 K3s <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.8m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">26:36</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
