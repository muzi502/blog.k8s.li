<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.k8s.li').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>
  <meta name="description" content="æœ€è¿‘åœ¨ kubernetes ä¸­ä½¿ç”¨ NFS å­˜å‚¨çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªå°é—®é¢˜ï¼Œä¹Ÿæ‰¾åˆ°äº†è§£å†³åŠæ³•ï¼Œä¸è¿‡è¿˜æ˜¯æƒ³æ·±å…¥åœ°äº†è§£ä¸€ä¸‹ kubelet æŒ‚è½½å­˜å‚¨çš„åŸç†å’Œè¿‡ç¨‹ï¼Œäºæ˜¯å°±æ°´äº†è¿™ç¯‡åšå®¢ ğŸ˜‚ã€‚è™½ç„¶å¹³æ—¶ä¹ŸçŸ¥é“ PV ã€PVC ã€å­˜å‚¨ç±»ç­‰æ€ä¹ˆä½¿ç”¨ï¼Œä½†èƒŒåçš„è¿‡ç¨‹å’ŒåŸç†å´æ²¡æœ‰æ·±ç©¶è¿‡ï¼Œæœ‰ç‚¹ä¸€çŸ¥åŠè§£çš„æ„Ÿè§‰ã€‚å”‰ï¼Œå¤ªèœäº† ğŸ˜‘ ï¼ˆæµä¸‹äº†æ²¡æœ‰æŠ€æœ¯çš„çœ¼æ³ª.jpg ç–‘æƒ‘ å½“ä½¿ç”¨ NFS å­˜å‚¨çš„ Pod è°ƒåº¦åˆ°æ²¡æœ‰å®‰è£… NFS c">
<meta property="og:type" content="article">
<meta property="og:title" content="kubelet æŒ‚è½½ volume åŸç†åˆ†æ">
<meta property="og:url" content="https://blog.k8s.li/kubelet-mount-volumes-analysis.html">
<meta property="og:site_name" content="æœ¨å­">
<meta property="og:description" content="æœ€è¿‘åœ¨ kubernetes ä¸­ä½¿ç”¨ NFS å­˜å‚¨çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªå°é—®é¢˜ï¼Œä¹Ÿæ‰¾åˆ°äº†è§£å†³åŠæ³•ï¼Œä¸è¿‡è¿˜æ˜¯æƒ³æ·±å…¥åœ°äº†è§£ä¸€ä¸‹ kubelet æŒ‚è½½å­˜å‚¨çš„åŸç†å’Œè¿‡ç¨‹ï¼Œäºæ˜¯å°±æ°´äº†è¿™ç¯‡åšå®¢ ğŸ˜‚ã€‚è™½ç„¶å¹³æ—¶ä¹ŸçŸ¥é“ PV ã€PVC ã€å­˜å‚¨ç±»ç­‰æ€ä¹ˆä½¿ç”¨ï¼Œä½†èƒŒåçš„è¿‡ç¨‹å’ŒåŸç†å´æ²¡æœ‰æ·±ç©¶è¿‡ï¼Œæœ‰ç‚¹ä¸€çŸ¥åŠè§£çš„æ„Ÿè§‰ã€‚å”‰ï¼Œå¤ªèœäº† ğŸ˜‘ ï¼ˆæµä¸‹äº†æ²¡æœ‰æŠ€æœ¯çš„çœ¼æ³ª.jpg ç–‘æƒ‘ å½“ä½¿ç”¨ NFS å­˜å‚¨çš„ Pod è°ƒåº¦åˆ°æ²¡æœ‰å®‰è£… NFS c">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/types-of-mounts.png">
<meta property="article:published_time" content="2020-04-30T16:00:00.000Z">
<meta property="article:modified_time" content="2020-04-30T16:00:00.000Z">
<meta property="article:author" content="æœ¨å­">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="å®¹å™¨">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="å­˜å‚¨">
<meta property="article:tag" content="volumes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/types-of-mounts.png">
<link rel="canonical" href="https://blog.k8s.li/kubelet-mount-volumes-analysis.html">
<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>
  <title>kubelet æŒ‚è½½ volume åŸç†åˆ†æ | æœ¨å­</title>
  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }
  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>
<link rel="alternate" href="/atom.xml" title="æœ¨å­" type="application/atom+xml">
</head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">
    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æœ¨å­</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>
<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">
    <a href="/" rel="section"><i class="fa fa-fw fa-desktop"></i>Home</a>
  </li>
        <li class="menu-item menu-item-books">
    <a href="/booklist.html" rel="section"><i class="fa fa-fw fa-book"></i>Books</a>
  </li>
        <li class="menu-item menu-item-kindle">
    <a href="https://kindle.502.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
  </li>
        <li class="menu-item menu-item-friend">
    <a href="/link/" rel="section"><i class="fa fa-fw fa-link"></i>Friend</a>
  </li>
        <li class="menu-item menu-item-about">
    <a href="/about.html" rel="section"><i class="fa fa-fw fa-user-circle-o"></i>About</a>
  </li>
  </ul>
</nav>
</div>
    </header>
  <div class="reading-progress-bar"></div>
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
  <div class="posts-expand">
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/kubelet-mount-volumes-analysis.html">
    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog.k8s.li/avatar.png">
      <meta itemprop="name" content="æœ¨å­">
      <meta itemprop="description" content="">
    </span>
    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æœ¨å­">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          kubelet æŒ‚è½½ volume åŸç†åˆ†æ
        </h2>
        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-05-01 2020-05-01T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2020-05-01T00:00:00+08:00">2020-05-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>
            </span>
  <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    <a title="disqus" href="/kubelet-mount-volumes-analysis.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="kubelet-mount-volumes-analysis.html" itemprop="commentCount"></span>
    </a>
  </span>
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>25k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>42 åˆ†é’Ÿ</span>
            </span>
        </div>
      </header>
    <div class="post-body" itemprop="articleBody">
        <p>æœ€è¿‘åœ¨ kubernetes ä¸­ä½¿ç”¨ NFS å­˜å‚¨çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªå°é—®é¢˜ï¼Œä¹Ÿæ‰¾åˆ°äº†è§£å†³åŠæ³•ï¼Œä¸è¿‡è¿˜æ˜¯æƒ³æ·±å…¥åœ°äº†è§£ä¸€ä¸‹ kubelet æŒ‚è½½å­˜å‚¨çš„åŸç†å’Œè¿‡ç¨‹ï¼Œäºæ˜¯å°±æ°´äº†è¿™ç¯‡åšå®¢ ğŸ˜‚ã€‚è™½ç„¶å¹³æ—¶ä¹ŸçŸ¥é“ PV ã€PVC ã€å­˜å‚¨ç±»ç­‰æ€ä¹ˆä½¿ç”¨ï¼Œä½†èƒŒåçš„è¿‡ç¨‹å’ŒåŸç†å´æ²¡æœ‰æ·±ç©¶è¿‡ï¼Œæœ‰ç‚¹ä¸€çŸ¥åŠè§£çš„æ„Ÿè§‰ã€‚å”‰ï¼Œå¤ªèœäº† ğŸ˜‘ ï¼ˆ<code>æµä¸‹äº†æ²¡æœ‰æŠ€æœ¯çš„çœ¼æ³ª.jpg</code></p>
<h2 id="ç–‘æƒ‘"><a href="#ç–‘æƒ‘" class="headerlink" title="ç–‘æƒ‘"></a>ç–‘æƒ‘</h2><blockquote>
<p>å½“ä½¿ç”¨ NFS å­˜å‚¨çš„ Pod è°ƒåº¦åˆ°æ²¡æœ‰å®‰è£… NFS client (nfs-utils ã€nfs-common) Node èŠ‚ç‚¹ä¸Šçš„æ—¶å€™ï¼Œä¼šæç¤º NFS volume æŒ‚è½½å¤±è´¥ï¼ŒNode å®¿ä¸»æœºå®‰è£…ä¸Š NFS client åå°±å¯ä»¥æ­£å¸¸æŒ‚è½½äº†ï¼Œæˆ‘æƒ³æ˜¯ä¸æ˜¯ kubelet åœ¨å¯åŠ¨å®¹å™¨ä¹‹å‰æ˜¯ä¸æ˜¯è°ƒç”¨ system-run å»æŒ‚è½½ NFS ï¼Œå¦‚æœ Node å®¿ä¸»æœºæ²¡æœ‰å®‰è£… NFS client å°±æ— æ³•æŒ‚è½½ã€‚</p>
<p>ç¿»äº†ä¸€ä¸‹æºç  <a href="https://github.com/kubernetes/kubernetes/blob/master/vendor/k8s.io/utils/mount/mount_linux.go#L115" target="_blank" rel="noopener">mount_linux.go</a> å’Œ <a href="https://github.com/kubernetes/kubernetes/pull/49640" target="_blank" rel="noopener">49640</a> è¿™ä¸ª PRã€‚é‡Œé¢æåˆ°çš„æ˜¯ kubelet æŒ‚è½½å­˜å‚¨å·çš„æ—¶å€™ä½¿ç”¨ system-run æŒ‚è½½ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå³ä¾¿ kubelet æŒ‚æ‰æˆ–è€…é‡å¯çš„æ—¶å€™ä¹Ÿä¸ä¼šå½±å“åˆ°å®¹å™¨ä½¿ç”¨ kubelet æŒ‚è½½çš„å­˜å‚¨å·ã€‚</p>
</blockquote>
<p>è¯·æ•™äº†ä¸€ä¸‹ä¸¤ä¸ªå¤§ä½¬ <a href="https://zdyxry.github.io/" target="_blank" rel="noopener">Yiran</a> å’Œ <a href="http://gaocegege.com/Blog/about/" target="_blank" rel="noopener">é«˜ç­–</a>ï¼Œä»–ä»¬ä¹Ÿä¸å¤ªç†Ÿæ‚‰ğŸ˜‚ï¼Œä¸è¿‡ä¹Ÿæ‰¾åˆ°äº†è§£å†³æ€è·¯ã€‚åœ¨ä½¿ç”¨ GlusterFS çš„æ—¶å€™ï¼ŒNode èŠ‚ç‚¹ä¹Ÿéœ€è¦å®‰è£… GlusterFS çš„å®¢æˆ·ç«¯ï¼Œä¸ç„¶ kubelet ä¹Ÿæ˜¯æ— æ³•æŒ‚è½½ Pod çš„ volumeã€‚ç”±æ­¤å¯ä»¥ç¡®è®¤çš„æ˜¯ï¼š kubelet åœ¨ä¸º Pod æŒ‚è½½ volume çš„æ—¶å€™ï¼Œæ ¹æ® volume çš„ç±»å‹ï¼ˆNFSã€GlusterFSã€Ceph ç­‰ï¼‰ï¼ŒPod æ‰€åœ¨çš„ Node èŠ‚ç‚¹å®¿ä¸»æœºä¹Ÿéœ€è¦å®‰è£…å¥½å¯¹åº”çš„å®¢æˆ·ç«¯ç¨‹åºã€‚</p>
<h2 id="é—®é¢˜å¤ç°"><a href="#é—®é¢˜å¤ç°" class="headerlink" title="é—®é¢˜å¤ç°"></a>é—®é¢˜å¤ç°</h2><p>é›†ç¾¤ä¿¡æ¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master-01 opt]# kubectl get node</span><br><span class="line">NAME            STATUS   ROLES    AGE    VERSION</span><br><span class="line">k8s-master-01   Ready    master   8d     v1.17.4</span><br><span class="line">k8s-master-02   Ready    master   8d     v1.17.4</span><br><span class="line">k8s-master-03   Ready    master   8d     v1.17.4</span><br><span class="line">k8s-node-02     Ready    &lt;none&gt; 8d     v1.17.4</span><br><span class="line">k8s-node-3      Ready    &lt;none&gt; 3d3h   v1.17.4</span><br><span class="line">node1           Ready    &lt;none&gt; 108s   v1.17.4</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†æ–¹ä¾¿å¤ç°é—®é¢˜è¿˜æ˜¯åœ¨ Rancher ä¸Šåˆ›å»ºäº† PV å’Œ PVCï¼Œä»¥åŠåŒ…å«ä¸¤ä¸ª Pod çš„ä¸€ä¸ª <code>Deploment</code>ï¼Œåœ¨åˆ›å»º Deploment çš„æ—¶å€™ï¼ŒæŒ‡å®šå°† Pod è°ƒåº¦åˆ°æ–°åŠ å…¥çš„èŠ‚ç‚¹ä¸Šï¼Œå³è¿™ä¸ªèŠ‚ç‚¹ä¸Šå¹¶æ²¡æœ‰å®‰è£… NFS å®¢æˆ·ç«¯ã€‚</p>
<p><strong>PV ä¿¡æ¯å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master-01 opt]# kubectl describe pv nfs211</span><br><span class="line">Name:            nfs211</span><br><span class="line">Labels:          cattle.io/creator=norman</span><br><span class="line">Annotations:     field.cattle.io/creatorId: user-gwgpp</span><br><span class="line">                 pv.kubernetes.io/bound-by-controller: yes</span><br><span class="line">Finalizers:      [kubernetes.io/pv-protection]</span><br><span class="line">StorageClass:    nfs216</span><br><span class="line">Status:          Bound</span><br><span class="line">Claim:           ops-test/nfs-211</span><br><span class="line">Reclaim Policy:  Retain</span><br><span class="line">Access Modes:    RWX</span><br><span class="line">VolumeMode:      Filesystem</span><br><span class="line">Capacity:        10Gi</span><br><span class="line">Node Affinity:   &lt;none&gt;</span><br><span class="line">Message:</span><br><span class="line">Source:</span><br><span class="line">    Type:      NFS (an NFS mount that lasts the lifetime of a pod)</span><br><span class="line">    Server:    10.20.172.211</span><br><span class="line">    Path:      /nfs</span><br><span class="line">    ReadOnly:  false</span><br><span class="line">Events:        &lt;none&gt;</span><br></pre></td></tr></table></figure>
<p><strong>PVC ä¿¡æ¯å¦‚ä¸‹</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"accessModes"</span>: [</span><br><span class="line">        <span class="string">"ReadWriteMany"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"annotations"</span>: &#123;</span><br><span class="line">        <span class="attr">"pv.kubernetes.io/bind-completed"</span>: <span class="string">"yes"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"baseType"</span>: <span class="string">"persistentVolumeClaim"</span>,</span><br><span class="line">    <span class="attr">"created"</span>: <span class="string">"2020-04-30T08:59:15Z"</span>,</span><br><span class="line">    <span class="attr">"createdTS"</span>: <span class="number">1588237155000</span>,</span><br><span class="line">    <span class="attr">"creatorId"</span>: <span class="string">"user-gwgpp"</span>,</span><br><span class="line">    <span class="attr">"id"</span>: <span class="string">"ops-test:nfs-211"</span>,</span><br><span class="line">    <span class="attr">"labels"</span>: &#123;</span><br><span class="line">        <span class="attr">"cattle.io/creator"</span>: <span class="string">"norman"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"links"</span>: &#123;</span><br><span class="line">        <span class="attr">"remove"</span>: <span class="string">"â€¦/v3/project/c-rl5jz:p-knsxt/persistentVolumeClaims/ops-test:nfs-211"</span>,</span><br><span class="line">        <span class="attr">"self"</span>: <span class="string">"â€¦/v3/project/c-rl5jz:p-knsxt/persistentVolumeClaims/ops-test:nfs-211"</span>,</span><br><span class="line">        <span class="attr">"update"</span>: <span class="string">"â€¦/v3/project/c-rl5jz:p-knsxt/persistentVolumeClaims/ops-test:nfs-211"</span>,</span><br><span class="line">        <span class="attr">"yaml"</span>: <span class="string">"â€¦/v3/project/c-rl5jz:p-knsxt/persistentVolumeClaims/ops-test:nfs-211/yaml"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"nfs-211"</span>,</span><br><span class="line">    <span class="attr">"namespaceId"</span>: <span class="string">"ops-test"</span>,</span><br><span class="line">    <span class="attr">"projectId"</span>: <span class="string">"c-rl5jz:p-knsxt"</span>,</span><br><span class="line">    <span class="attr">"resources"</span>: &#123;</span><br><span class="line">        <span class="attr">"requests"</span>: &#123;</span><br><span class="line">            <span class="attr">"storage"</span>: <span class="string">"10Gi"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"/v3/project/schemas/resourceRequirements"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"state"</span>: <span class="string">"bound"</span>,</span><br><span class="line">    <span class="attr">"status"</span>: &#123;</span><br><span class="line">        <span class="attr">"accessModes"</span>: [</span><br><span class="line">            <span class="string">"ReadWriteMany"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"capacity"</span>: &#123;</span><br><span class="line">            <span class="attr">"storage"</span>: <span class="string">"10Gi"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"phase"</span>: <span class="string">"Bound"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"/v3/project/schemas/persistentVolumeClaimStatus"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"storageClassId"</span>: <span class="string">"nfs216"</span>,</span><br><span class="line">    <span class="attr">"transitioning"</span>: <span class="string">"no"</span>,</span><br><span class="line">    <span class="attr">"transitioningMessage"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"persistentVolumeClaim"</span>,</span><br><span class="line">    <span class="attr">"uuid"</span>: <span class="string">"660dc8d1-7911-4d30-b575-b54990de8667"</span>,</span><br><span class="line">    <span class="attr">"volumeId"</span>: <span class="string">"nfs211"</span>,</span><br><span class="line">    <span class="attr">"volumeMode"</span>: <span class="string">"Filesystem"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Deploment ä¿¡æ¯å¦‚ä¸‹ï¼š</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">deployment.kubernetes.io/revision:</span> <span class="string">"1"</span></span><br><span class="line">    <span class="attr">field.cattle.io/creatorId:</span> <span class="string">user-gwgpp</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="string">"2020-04-30T09:00:19Z"</span></span><br><span class="line">  <span class="attr">generation:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">cattle.io/creator:</span> <span class="string">norman</span></span><br><span class="line">    <span class="attr">workload.user.cattle.io/workloadselector:</span> <span class="string">deployment-ops-test-node1-nfs-test</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node1-nfs-test</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">ops-test</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">"1940561"</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/apis/apps/v1/namespaces/ops-test/deployments/node1-nfs-test</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">5d14a158-1eef-4a94-8433-15ad002ee55c</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">progressDeadlineSeconds:</span> <span class="number">600</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">revisionHistoryLimit:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">workload.user.cattle.io/workloadselector:</span> <span class="string">deployment-ops-test-node1-nfs-test</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxSurge:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">cattle.io/timestamp:</span> <span class="string">"2020-04-30T09:01:05Z"</span></span><br><span class="line">        <span class="attr">workload.cattle.io/state:</span> <span class="string">'&#123;"bm9kZTE=":"c-rl5jz:machine-wbs6r"&#125;'</span></span><br><span class="line">      <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">workload.user.cattle.io/workloadselector:</span> <span class="string">deployment-ops-test-node1-nfs-test</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">node1-nfs-test</span></span><br><span class="line">        <span class="attr">resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">allowPrivilegeEscalation:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">capabilities:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">        <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">        <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">vol1</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">      <span class="attr">nodeName:</span> <span class="string">node1</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">      <span class="attr">securityContext:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">vol1</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">nfs-211</span></span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºå®Œ Deploment ä¹‹åï¼Œä½¿ç”¨ kubectl get pod å‘½ä»¤æŸ¥çœ‹ Pod åˆ›å»ºçš„è¿›åº¦ï¼Œå‘ç°ä¸€ç›´å¡åœ¨ <code>ContainerCreating</code> çŠ¶æ€</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master-01 opt]# kubectl get pod -n ops-test</span><br><span class="line">NAME                              READY   STATUS              RESTARTS   AGE</span><br><span class="line">node1-nfs-test-547c4d7678-j6kwv   0/1     ContainerCreating   0          2m12s</span><br><span class="line">node1-nfs-test-547c4d7678-vwdqg   0/1     ContainerCreating   0          2m12s</span><br></pre></td></tr></table></figure>
<p>kubectl describe pod çš„æ—¥å¿—å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master-01 opt]# kubectl describe pod node1-nfs-test-547c4d7678-j6kwv -n ops-test</span><br><span class="line">Name:           node1-nfs-test-547c4d7678-j6kwv</span><br><span class="line">Namespace:      ops-test</span><br><span class="line">Priority:       0</span><br><span class="line">Node:           node1/10.10.107.214</span><br><span class="line">Start Time:     Thu, 30 Apr 2020 17:00:33 +0800</span><br><span class="line">Labels:         pod-template-hash=547c4d7678</span><br><span class="line">                workload.user.cattle.io/workloadselector=deployment-ops-test-node1-nfs-test</span><br><span class="line">Annotations:    cattle.io/timestamp: 2020-04-30T09:01:05Z</span><br><span class="line">                workload.cattle.io/state: &#123;"bm9kZTE=":"c-rl5jz:machine-wbs6r"&#125;</span><br><span class="line">Status:         Pending</span><br><span class="line">IP:</span><br><span class="line">IPs:            &lt;none&gt;</span><br><span class="line">Controlled By:  ReplicaSet/node1-nfs-test-547c4d7678</span><br><span class="line">Containers:</span><br><span class="line">  node1-nfs-test:</span><br><span class="line">    Container ID:</span><br><span class="line">    Image:          alpine</span><br><span class="line">    Image ID:</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Waiting</span><br><span class="line">      Reason:       ContainerCreating</span><br><span class="line">    Ready:          False</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /tmp from vol1 (rw)</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-f6wjj (ro)</span><br><span class="line">Conditions:</span><br><span class="line">  Type              Status</span><br><span class="line">  Initialized       True</span><br><span class="line">  Ready             False</span><br><span class="line">  ContainersReady   False</span><br><span class="line">  PodScheduled      True</span><br><span class="line">Volumes:</span><br><span class="line">  vol1:</span><br><span class="line">    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)</span><br><span class="line">    ClaimName:  nfs-211</span><br><span class="line">    ReadOnly:   false</span><br><span class="line">  default-token-f6wjj:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-f6wjj</span><br><span class="line">    Optional:    false</span><br><span class="line">QoS Class:       BestEffort</span><br><span class="line">Node-Selectors:  &lt;none&gt;</span><br><span class="line">Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s</span><br><span class="line">                 node.kubernetes.io/unreachable:NoExecute for 300s</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason       Age    From            Message</span><br><span class="line">  ----  ------  ---- ----     -------</span><br><span class="line">  Warning  FailedMount  8m49s  kubelet, node1  MountVolume.SetUp failed for volume "nfs211" : mount failed: exit status 32</span><br><span class="line">Mounting command: systemd-run</span><br><span class="line">Mounting arguments: --description=Kubernetes transient mount for /var/lib/kubelet/pods/cddc94e7-8033-4150-bed5-d141e3b71e49/volumes/kubernetes.io~nfs/nfs211 --scope -- mount -t nfs 10.20.172.211:/nfs /var/lib/kubelet/pods/cddc94e7-8033-4150-bed5-d141e3b71e49/volumes/kubernetes.io~nfs/nfs211</span><br><span class="line">Output: Running scope as unit run-38284.scope.</span><br><span class="line">mount: wrong fs type, bad option, bad superblock on 10.20.172.211:/nfs,</span><br><span class="line">       missing codepage or helper program, or other error</span><br><span class="line">       (for several filesystems (e.g. nfs, cifs) you might</span><br><span class="line">       need a /sbin/mount.&lt;type&gt; helper program)</span><br><span class="line"></span><br><span class="line">       In some cases useful info is found in syslog - try</span><br><span class="line">       dmesg | tail or so.</span><br><span class="line">  Warning  FailedMount  8m48s  kubelet, node1  MountVolume.SetUp failed for volume "nfs211" : mount failed: exit status 32</span><br></pre></td></tr></table></figure>
<p>åœ¨ ä¸€å°æ²¡æœ‰å®‰è£… NFS å®¢æˆ·ç«¯çš„èŠ‚ç‚¹å°è¯•æŒ‚è½½ä¸€ä¸‹ NFS å­˜å‚¨ï¼Œå‘ç°æŠ¥é”™çš„æ—¥å¿—å’Œ kubelet çš„æ—¥å¿—ç›¸åŒğŸ¤”</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master-03 ~]# mount -t nfs 10.20.172.211:/nfs /tmp</span><br><span class="line">mount: wrong fs type, bad option, bad superblock on 10.20.172.211:/nfs,</span><br><span class="line">       missing codepage or helper program, or other error</span><br><span class="line">       (for several filesystems (e.g. nfs, cifs) you might</span><br><span class="line">       need a /sbin/mount.&lt;type&gt; helper program)</span><br><span class="line"></span><br><span class="line">       In some cases useful info is found in syslog - try</span><br><span class="line">       dmesg | tail or so.</span><br></pre></td></tr></table></figure>
<h2 id="è§£å†³é—®é¢˜"><a href="#è§£å†³é—®é¢˜" class="headerlink" title="è§£å†³é—®é¢˜"></a>è§£å†³é—®é¢˜</h2><p>çœ‹åˆ° kubelet æŠ¥é”™çš„æ—¥å¿—å’Œæˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸Šä½¿ç”¨ mount åæŒ‚è½½ NFS å­˜å‚¨æ—¶çš„é”™è¯¯ä¸€æ ·å°±å¯ä»¥æ–­å®šä¸ºæ˜¯å®¿ä¸»æœºçš„é—®é¢˜ã€‚æœäº†ä¸€ä¸‹æŠ¥é”™æ—¥å¿—ï¼Œåœ¨ <a href="https://askubuntu.com/questions/525243/why-do-i-get-wrong-fs-type-bad-option-bad-superblock-error" target="_blank" rel="noopener">Why do I get â€œwrong fs type, bad option, bad superblockâ€ error?</a> å¾—åˆ°æç¤ºè¯´éœ€è¦å®‰è£…ä¸€ä¸‹ NFS å®¢æˆ·ç«¯ (nfs-commonã€nfs-utils) ğŸ˜‚ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@node1 ~</span><br><span class="line">â•°â”€# yum install nfs-utils</span><br><span class="line">â€¦â€¦â€¦â€¦â€¦â€¦</span><br><span class="line">Install  1 Package (+15 Dependent packages)</span><br><span class="line"></span><br><span class="line">Total download size: 1.5 M</span><br><span class="line">Installed size: 4.3 M</span><br><span class="line">Is this ok [y/d/N]:</span><br></pre></td></tr></table></figure>
<p>yum ä¸€æŠŠæ¢­åå‘ç° <code>nfs-utils</code> è¿˜çœŸæ²¡æœ‰å®‰è£…ğŸ˜‚ã€‚</p>
<p>å®‰è£…å®Œæ—¶å€™ä½¿ç”¨ kubectl åˆ é™¤æ‰ä¹‹å‰çš„ Podï¼ŒDeploment æ§åˆ¶å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å°† Pod æ•°é‡è°ƒå’Œåˆ°æŒ‡å®šçš„æ•°é‡ã€‚å¯ä»¥å‘ç° Pod æ‰€åœ¨å®¿ä¸»æœºå®‰è£… NFS å®¢æˆ·ç«¯ä¹‹å kubelet å°±èƒ½æ­£å¸¸ä¸º Pod æŒ‚è½½ volume äº† è€Œä¸” Pod ä¹Ÿæ­£å¸¸è¿è¡Œäº†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master-01 ~]# kubectl delete pod node1-nfs-test-547c4d7678-j6kwv node1-nfs-test-547c4d7678-vwdqg -n ops-test</span><br><span class="line">pod "node1-nfs-test-547c4d7678-j6kwv" deleted</span><br><span class="line">pod "node1-nfs-test-547c4d7678-vwdqg" deleted</span><br><span class="line">[root@k8s-master-01 ~]# kubectl get pod -n ops-test</span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">node1-nfs-test-7589fb4787-cknz4   1/1     Running   0          18s</span><br><span class="line">node1-nfs-test-7589fb4787-l9bt2   1/1     Running   0          22s</span><br></pre></td></tr></table></figure>
<p>è¿›å…¥å®¹å™¨å†…æŸ¥çœ‹ä¸€ä¸‹å®¹å™¨å†…æŒ‚è½½ç‚¹çš„ä¿¡æ¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master-01 ~]# kubectl exec -it node1-nfs-test-7589fb4787-cknz4 -n ops-test sh</span><br><span class="line">/ # df -h</span><br><span class="line">Filesystem                Size      Used Available Use% Mounted on</span><br><span class="line">overlay                  28.9G      4.1G     23.3G  15% /</span><br><span class="line">10.20.172.211:/nfs       28.9G     14.5G     12.9G  53% /tmp</span><br><span class="line">tmpfs                     1.8G         0      1.8G   0% /sys/firmware</span><br><span class="line">/ # mount</span><br><span class="line">rootfs on / type rootfs (rw)</span><br><span class="line">10.20.172.211:/nfs on /tmp type nfs (rw,relatime,vers=3,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=10.20.172.211,mountvers=3,mountport=20048,mountproto=udp,local_lock=none,addr=10.20.172.211)</span><br><span class="line"></span><br><span class="line">10.20.172.211:/nfs on /mnt/nfs type nfs (rw,relatime,vers=3,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=10.20.172.211,mountvers=3,mountport=20048,mountproto=udp,local_lock=none,addr=10.20.172.211)</span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤é—®é¢˜å·²ç»è§£å†³äº†ï¼Œæ¥ä¸‹æ¥å°±åˆ°äº†æ­£æ–‡ï¼šå¼€å§‹åˆ†æä¸€ä¸‹  kubelet ä¸º Pod æŒ‚è½½ volume çš„æµç¨‹å’ŒåŸç†ğŸ˜‚</p>
<h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><h3 id="å®¹å™¨å­˜å‚¨"><a href="#å®¹å™¨å­˜å‚¨" class="headerlink" title="å®¹å™¨å­˜å‚¨"></a>å®¹å™¨å­˜å‚¨</h3><p>åœ¨åˆ†æ Pod çš„ volume ä¹‹å‰éœ€è¦å…ˆäº†è§£ä¸€ä¸‹ docker å®¹å™¨çš„å­˜å‚¨ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ <code>docker inspect</code> &lt;å®¹å™¨ ID&gt; å‘½ä»¤æ¥æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯æ—¶ï¼Œåœ¨å®¹å™¨å…ƒæ•°æ®ä¿¡æ¯çš„ <code>GraphDriver</code> å­—æ®µä¸‹åŒ…å«ç€ä¸€ä¸ª <code>Mounts</code> ï¼Œè€Œ <code>Mounts</code> å­—æ®µé‡Œçš„æ­£æ˜¯å®¹å™¨æŒ‚è½½çš„å­˜å‚¨ï¼Œå…¶ä¸­é‡Œé¢çš„ <code>Type</code> å­—æ®µé‡Œæœ‰ <code>bind</code> å’Œ <code>volume</code> ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ª <code>tmpfs</code>ã€‚</p>
<p>å¦å¤–å…¶ä¸­çš„ <code>Data</code> å­—æ®µé‡Œçš„ <code>LowerDir</code> æ­£æ˜¯å®¹å™¨çš„é•œåƒå±‚ï¼Œå…³äºå®¹å™¨é•œåƒå±‚çš„è®²è§£å»ºè®®é˜…è¯»ä¸€ä¸‹ <a href="https://arkingc.github.io/2018/01/15/2018-01-15-docker-storage-overlay2/" target="_blank" rel="noopener">Dockeræºç åˆ†æâ€”å­˜å‚¨é©±åŠ¨</a> ï¼Œè¿™ç¯‡æºç åˆ†æğŸ‘ï¼Œåœ¨è¿™é‡Œç‚¹åˆ°ä¸ºæ­¢å°±ä¸å†ç»†ç©¶äº†ğŸ˜‚</p>
<blockquote>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†è§£äº†å±‚çš„åˆ›å»ºå’Œåˆ é™¤è¿‡ç¨‹ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸€ç›´æ²¡æœ‰æåˆ°ä¸€ä¸ªé—®é¢˜ï¼š<strong>æˆ‘ä»¬åœ¨å®¹å™¨å†…çœ‹åˆ°çš„æ–‡ä»¶å­˜åœ¨å“ªï¼Ÿ</strong></p>
<p>æˆ‘ä»¬å·²ç»çŸ¥é“å±‚ç›®å½•ä¸‹æœ‰diffï¼Œmergedå’Œwork 3ä¸ªç›®å½•ã€‚diffå­˜å‚¨çš„æ˜¯è¯¥å±‚çš„æ–‡ä»¶ï¼Œworkæ˜¯æ‰§è¡Œä¸€äº›ç‰¹å®šæ“ä½œæ—¶æ‰€è¦ç”¨åˆ°çš„ç›®å½•ï¼Œæ‰€ä»¥å®é™…ä¸Šï¼Œ<strong>åœ¨å®¹å™¨å†…çœ‹åˆ°çš„æ–‡ä»¶ï¼Œå°±å­˜åœ¨äºmergedç›®å½•ä¸‹</strong></p>
<p><strong>mergedç›®å½•åœ¨å®¹å™¨æœªè¿è¡Œæ—¶ï¼Œæ˜¯ä¸€ä¸ªç©ºç›®å½•ï¼Œå½“å®¹å™¨å¯åŠ¨æ—¶ä¼šå°†è¯¥å®¹å™¨æ‰€æœ‰å±‚çš„diffç›®å½•è¿›è¡Œè”åˆæŒ‚è½½ï¼ŒæŒ‚è½½åˆ°mergedç›®å½•ä¸‹ï¼ŒæŒ‚è½½æ—¶ä½¿ç”¨çš„æ–‡ä»¶ç³»ç»Ÿå°±æ˜¯å†…æ ¸OverlayFSæ–‡ä»¶ç³»ç»Ÿ</strong></p>
<blockquote>
<p>å¦‚æœæœ‰çœ‹è¿‡æˆ‘å…³äºå†…æ ¸OverlayFSç›¸å…³çš„åšæ–‡ï¼Œè¿™é‡Œåº”è¯¥å·²ç»å¯¹Dockerçš„overlay2å­˜å‚¨é©±åŠ¨ä¸å†…æ ¸OverlayFSçš„å…³ç³»æœ‰äº†ä¸€ä¸ªæ¯”è¾ƒæ¸…æ™°çš„è®¤è¯†</p>
</blockquote>
<p><strong>å½“æŒ‚è½½å®Œæˆåï¼Œå®¹å™¨å¤„äºä¸€ä¸ªå­æ–‡ä»¶ç³»ç»Ÿå‘½åç©ºé—´ï¼Œåªèƒ½çœ‹åˆ°mergedç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œç›¸å½“äºchrootå‘½ä»¤çš„æ•ˆæœ</strong></p>
<p>æ‰€ä»¥ï¼Œåœ¨åœæ­¢ä¸€ä¸ªå®¹å™¨æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹mergedç›®å½•æ‰§è¡Œä¸€ä¸ªå¸è½½å‘½ä»¤</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">"GraphDriver": &#123;</span><br><span class="line">            "Data": &#123;</span><br><span class="line">                "LowerDir": "/var/lib/docker/overlay2/2a846f62b759d87bf8b2731960c4031585fb4ee14bbf313f58e0374c4fee9ce0-init/diff:/var/lib/docker/overlay2/29f9a1e9523d4ec323402a3c2da8a5e288cfe0e6f3168a57dd2388b63775c20a/diff:/var/lib/docker/overlay2/015afa447ae2fcfa592d257644312b286173b9a00d0f2017a4c6ede448a87d47/diff:/var/lib/docker/overlay2/2f71b56cd5550bf299ed33a04e385ef5578511e3a17d35162148f4b84bda4b26/diff",</span><br><span class="line">                "MergedDir": "/var/lib/docker/overlay2/2a846f62b759d87bf8b2731960c4031585fb4ee14bbf313f58e0374c4fee9ce0/merged",</span><br><span class="line">                "UpperDir": "/var/lib/docker/overlay2/2a846f62b759d87bf8b2731960c4031585fb4ee14bbf313f58e0374c4fee9ce0/diff",</span><br><span class="line">                "WorkDir": "/var/lib/docker/overlay2/2a846f62b759d87bf8b2731960c4031585fb4ee14bbf313f58e0374c4fee9ce0/work"</span><br><span class="line">            &#125;,</span><br><span class="line">            "Name": "overlay2"</span><br><span class="line">        &#125;,</span><br><span class="line">        "Mounts": [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"Type"</span>: <span class="string">"bind"</span>,</span><br><span class="line">                <span class="attr">"Source"</span>: <span class="string">"/opt/wordpress-nginx-docker/webp-server/config.json"</span>,</span><br><span class="line">                <span class="attr">"Destination"</span>: <span class="string">"/etc/config.json"</span>,</span><br><span class="line">                <span class="attr">"Mode"</span>: <span class="string">"rw"</span>,</span><br><span class="line">                <span class="attr">"RW"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">"Propagation"</span>: <span class="string">"rprivate"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"Type"</span>: <span class="string">"bind"</span>,</span><br><span class="line">                <span class="attr">"Source"</span>: <span class="string">"/opt/wordpress-nginx-docker/wordpress"</span>,</span><br><span class="line">                <span class="attr">"Destination"</span>: <span class="string">"/var/www/html"</span>,</span><br><span class="line">                <span class="attr">"Mode"</span>: <span class="string">"rw"</span>,</span><br><span class="line">                <span class="attr">"RW"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">"Propagation"</span>: <span class="string">"rprivate"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"Type"</span>: <span class="string">"volume"</span>,</span><br><span class="line">                <span class="attr">"Name"</span>: <span class="string">"36d087638f2e9ba8472c441bcf906320cfd80419874291f56e039e4f7d1278e7"</span>,</span><br><span class="line">                <span class="attr">"Source"</span>: <span class="string">"/var/lib/docker/volumes/36d087638f2e9ba8472c441bcf906320cfd80419874291f56e039e4f7d1278e7/_data"</span>,</span><br><span class="line">                <span class="attr">"Destination"</span>: <span class="string">"/opt/exhaust"</span>,</span><br><span class="line">                <span class="attr">"Driver"</span>: <span class="string">"local"</span>,</span><br><span class="line">                <span class="attr">"Mode"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="attr">"RW"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">"Propagation"</span>: <span class="string">""</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br></pre></td></tr></table></figure>
<p>æ ¹æ® docker çš„å®˜æ–¹æ–‡æ¡£ <a href="https://docs.docker.com/storage/" target="_blank" rel="noopener">Manage data in Docker</a> ï¼Œdocker æä¾›äº† 3 ç§æ–¹æ³•å°†æ•°æ®ä» Docker å®¿ä¸»æœºæŒ‚è½½ï¼ˆmountï¼‰åˆ°å®¹å™¨å†…ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://p.k8s.li/types-of-mounts.png" alt=""></p>
<p><code>å›¾ç‰‡ä» Docker å®˜æ–¹æ–‡æ¡£å·æ¥çš„ğŸ˜‚</code></p>
<blockquote>
<ul>
<li><strong>Volumes</strong> are stored in a part of the host filesystem which is <em>managed by Docker</em> (<code>/var/lib/docker/volumes/</code> on Linux). Non-Docker processes should not modify this part of the filesystem. Volumes are the best way to persist data in Docker.</li>
<li><strong>Bind mounts</strong> may be stored <em>anywhere</em> on the host system. They may even be important system files or directories. Non-Docker processes on the Docker host or a Docker container can modify them at any time.</li>
<li><strong><code>tmpfs</code> mounts</strong> are stored in the host systemâ€™s memory only, and are never written to the host systemâ€™s filesystem.</li>
</ul>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°å®¹å™¨å¯ä»¥ä½¿ç”¨çš„å­˜å‚¨æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>Volumesï¼šä½¿ç”¨ Docker æ¥ç®¡ç†çš„å­˜å‚¨ï¼Œé»˜è®¤å­˜æ”¾åœ¨ <code>/var/lib/docker/volumes/</code> ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>docker volume</code> å­å‘½ä»¤æ¥ç®¡ç†è¿™äº› volume ï¼Œå¯ä»¥åˆ›å»ºã€æŸ¥çœ‹ã€åˆ—å‡ºã€æ¸…ç©ºã€åˆ é™¤ç­‰æ“ä½œã€‚é docker è¿›ç¨‹ä¸åº”è¯¥å»ä¿®æ”¹è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œ<strong>å·æ˜¯ Docker å®¹å™¨æŒä¹…åŒ–æ•°æ®çš„æœ€å¥½æ–¹å¼</strong>ã€‚</li>
</ul>
<blockquote>
<p><code>-v</code>æˆ–<code>--volume</code>ï¼šç”±3ä¸ªåŸŸç»„æˆï¼Œ<code>&#39;:&#39;</code>åˆ†éš”</p>
<ul>
<li>ç¬¬ä¸€ä¸ªåŸŸï¼šå¯¹äºå‘½åå·ï¼Œä¸ºå·åï¼›åŒ¿åå·ï¼Œåˆ™å¿½ç•¥ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºåŒ¿åå·</li>
<li>ç¬¬äºŒä¸ªåŸŸï¼šå®¹å™¨ä¸­çš„æŒ‚è½½ç‚¹</li>
<li>ç¬¬ä¸‰ä¸ªåŸŸï¼šå¯é€‰å‚æ•°ï¼Œç”±<code>&#39;,&#39;</code>éš”å¼€ï¼Œå¦‚<code>ro</code></li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /home/ubuntu</span><br><span class="line">â•°â”€# docker volume</span><br><span class="line">Usage:  docker volume COMMAND</span><br><span class="line">Manage volumes</span><br><span class="line">Commands:</span><br><span class="line">  create      Create a volume</span><br><span class="line">  inspect     Display detailed information on one or more volumes</span><br><span class="line">  ls          List volumes</span><br><span class="line">  prune       Remove all unused local volumes</span><br><span class="line">  rm          Remove one or more volumes</span><br><span class="line">Run 'docker volume COMMAND --help' for more information on a command.</span><br></pre></td></tr></table></figure>
<p>å‡å¦‚åœ¨å†™ <code>Dockerfile</code> çš„æ—¶å€™ï¼Œä½¿ç”¨ <code>VOLUME</code> æŒ‡ä»¤æŒ‡å®šå®¹å™¨å†…çš„è·¯å¾„ã€‚åœ¨æˆ‘ä»¬å¯åŠ¨å®¹å™¨çš„æ—¶å€™ docker ä¼šå¸®æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæŒä¹…åŒ–å­˜å‚¨çš„ volumeã€‚ä¹Ÿå¯åœ¨ <code>docker run</code> æˆ–è€… <code>docker-compose.yaml</code> æŒ‡å®š <code>volume</code> ã€‚</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /home/ubuntu</span><br><span class="line">â•°â”€# docker volume ls</span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line">local               docker-elk_elasticsearch</span><br><span class="line">local               opt</span><br><span class="line">â•­â”€root@sg-02 /home/ubuntu</span><br><span class="line">â•°â”€# docker volume inspect opt</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"CreatedAt"</span>: <span class="string">"2020-03-12T06:58:15Z"</span>,</span><br><span class="line">        <span class="attr">"Driver"</span>: <span class="string">"local"</span>,</span><br><span class="line">        <span class="attr">"Labels"</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">"Mountpoint"</span>: <span class="string">"/var/lib/docker/volumes/opt/_data"</span>,</span><br><span class="line">        <span class="attr">"Name"</span>: <span class="string">"opt"</span>,</span><br><span class="line">        <span class="attr">"Options"</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">"Scope"</span>: <span class="string">"local"</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">â•­â”€root@sg-02 /home/ubuntu</span><br><span class="line">â•°â”€# docker inspect docker-elk_elasticsearch</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">"CreatedAt"</span>: <span class="string">"2020-04-24T01:37:07Z"</span>,</span><br><span class="line">        <span class="attr">"Driver"</span>: <span class="string">"local"</span>,</span><br><span class="line">        <span class="attr">"Labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"com.docker.compose.project"</span>: <span class="string">"docker-elk"</span>,</span><br><span class="line">            <span class="attr">"com.docker.compose.version"</span>: <span class="string">"1.25.4"</span>,</span><br><span class="line">            <span class="attr">"com.docker.compose.volume"</span>: <span class="string">"elasticsearch"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"Mountpoint"</span>: <span class="string">"/var/lib/docker/volumes/docker-elk_elasticsearch/_data"</span>,</span><br><span class="line">        <span class="attr">"Name"</span>: <span class="string">"docker-elk_elasticsearch"</span>,</span><br><span class="line">        <span class="attr">"Options"</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">"Scope"</span>: <span class="string">"local"</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>Bind mountsï¼š</li>
</ul>
<p>ä½¿ç”¨ <code>Bind mounts</code> å°†å®¿ä¸»æœºçš„ç›®å½•æˆ–è€…æ–‡ä»¶æŒ‚è½½è¿›å®¹å™¨å†…ï¼Œè¿™ä¸ªæ–‡ä»¶å’Œç›®å½•å¯ä»¥æ˜¯å®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿä¸Šçš„ä»»æ„ä½ç½®ï¼Œå¯ä»¥ä¸å— docker æ‰€ç®¡ç†ï¼Œæ¯”å¦‚ kubelet çš„ volumes ç›®å½•ï¼š<code>/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/</code> ã€‚ kubelet åœ¨ä¸º Pod æŒ‚è½½å­˜å‚¨çš„æ—¶å€™ä¹Ÿæ­£æ˜¯é€šè¿‡ <code>Bind mounts</code> çš„æ–¹å¼å°† Pod çš„ volumes æŒ‚è½½åˆ°å®¹å™¨å†…ã€‚æ‰€ä»¥å½“æˆ‘ä»¬ä½¿ç”¨ docker inspect å‘½ä»¤å»æŸ¥çœ‹ Pod å†…å®¹å™¨çš„ <code>Mounts</code> ä¿¡æ¯æ˜¯ï¼Œ<code>Type</code> ç±»å‹å¤šä¸º <code>bind</code> æˆ–è€… <code>tmpfs</code> ï¼Œå¾ˆå°‘ä¼šç”¨åˆ° <code>volumes</code> ã€‚å¯ä»¥ç†è§£ä¸º kubelet çš„ volumes ç›®å½•å°±åƒ docker çš„ volumes é‚£æ ·ï¼Œæ˜¯ç”± kubelet è‡ªå·±æ¥ç®¡ç†çš„ï¼Œå…¶ä»–ç”¨æˆ·æˆ–è¿›ç¨‹ä¸åº”è¯¥å»ä¿®æ”¹å®ƒã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@k8s-node-3 ~</span><br><span class="line">â•°â”€# docker inspect f1111ee6ac84</span><br><span class="line">"Mounts": [</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="attr">"Type"</span>: <span class="string">"bind"</span>,</span><br><span class="line">      <span class="attr">"Source"</span>: <span class="string">"/var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/volumes/kubernetes.io~nfs/nfs211"</span>,</span><br><span class="line">      <span class="attr">"Destination"</span>: <span class="string">"/var/www/html"</span>,</span><br><span class="line">      <span class="attr">"Mode"</span>: <span class="string">""</span>,</span><br><span class="line">      <span class="attr">"RW"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"Propagation"</span>: <span class="string">"rprivate"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="attr">"Type"</span>: <span class="string">"bind"</span>,</span><br><span class="line">      <span class="attr">"Source"</span>: <span class="string">"/var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/volumes/kubernetes.io~secret/default-token-wgfd9"</span>,</span><br><span class="line">      <span class="attr">"Destination"</span>: <span class="string">"/var/run/secrets/kubernetes.io/serviceaccount"</span>,</span><br><span class="line">      <span class="attr">"Mode"</span>: <span class="string">"ro,Z"</span>,</span><br><span class="line">      <span class="attr">"RW"</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">"Propagation"</span>: <span class="string">"rprivate"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="attr">"Type"</span>: <span class="string">"bind"</span>,</span><br><span class="line">      <span class="attr">"Source"</span>: <span class="string">"/var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/etc-hosts"</span>,</span><br><span class="line">      <span class="attr">"Destination"</span>: <span class="string">"/etc/hosts"</span>,</span><br><span class="line">      <span class="attr">"Mode"</span>: <span class="string">"Z"</span>,</span><br><span class="line">      <span class="attr">"RW"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"Propagation"</span>: <span class="string">"rprivate"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">      <span class="attr">"Type"</span>: <span class="string">"bind"</span>,</span><br><span class="line">      <span class="attr">"Source"</span>: <span class="string">"/var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/containers/nginx/f760f2be"</span>,</span><br><span class="line">      <span class="attr">"Destination"</span>: <span class="string">"/dev/termination-log"</span>,</span><br><span class="line">      <span class="attr">"Mode"</span>: <span class="string">"Z"</span>,</span><br><span class="line">      <span class="attr">"RW"</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">"Propagation"</span>: <span class="string">"rprivate"</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>Bind mounts</code>å¯èƒ½ä¼šæœ‰å®‰å…¨é—®é¢˜ï¼šå®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹å¯ä»¥ä¿®æ”¹å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…æ‹¬åˆ›å»ºï¼Œä¿®æ”¹ï¼Œåˆ é™¤é‡è¦çš„ç³»ç»Ÿæ–‡ä»¶æˆ–ç›®å½•ã€‚ä¸è¿‡å¯ä»¥åŠ å‚æ•°æŒ‚è½½ä¸ºåªè¯»ã€‚</p>
<blockquote>
<p><code>--mount</code>ï¼šç”±å¤šä¸ª<code>&#39;,&#39;</code>éš”å¼€çš„é”®å€¼å¯¹<key>=<value>ç»„æˆï¼š</p>
<ul>
<li>æŒ‚è½½ç±»å‹ï¼škeyä¸º<code>type</code>ï¼Œvalueä¸º<code>bind</code>ã€<code>volume</code>æˆ–<code>tmpfs</code></li>
<li>æŒ‚è½½æºï¼škeyä¸º<code>source</code>æˆ–<code>src</code>ï¼Œå¯¹äºå‘½åå·ï¼Œvalueä¸ºå·åï¼Œå¯¹äºåŒ¿åå·ï¼Œåˆ™å¿½ç•¥</li>
<li>å®¹å™¨ä¸­çš„æŒ‚è½½ç‚¹ï¼škeyä¸º<code>destination</code>ã€<code>dst</code>æˆ–<code>target</code>ï¼Œvalueä¸ºå®¹å™¨ä¸­çš„è·¯å¾„</li>
<li>è¯»å†™ç±»å‹ï¼švalueä¸º<code>readonly</code>ï¼Œæ²¡æœ‰key</li>
<li>è¯»å†™ç±»å‹ï¼švalueä¸º<code>readonly</code>ï¼Œæ²¡æœ‰key</li>
<li>volume-opté€‰é¡¹ï¼Œå¯ä»¥å‡ºç°å¤šæ¬¡ã€‚æ¯”å¦‚<code>volume-driver=local,volume-opt=type=nfs,...</code></li>
</ul>
</blockquote>
<ul>
<li><p>tmpsï¼š</p>
<p>  ç”¨æ¥å­˜å‚¨ä¸€äº›ä¸éœ€è¦æŒä¹…åŒ–çš„çŠ¶æ€æˆ–æ•æ„Ÿæ•°æ®ï¼Œæ¯”å¦‚ <code>kubernetes</code> ä¸­çš„å„ç§ <code>secret</code> ã€‚æ¯”å¦‚å½“æˆ‘ä»¬ä½¿ç”¨ <code>kubectl exec -it POD</code> ï¼Œè¿›å…¥åˆ° Pod å®¹å™¨å†…ï¼Œç„¶åä½¿ç”¨ mount å‘½ä»¤æŸ¥çœ‹å®¹å™¨å†…çš„æŒ‚è½½ç‚¹ä¿¡æ¯å°±ä¼šæœ‰å¾ˆå¤š tmpfs ç±»å‹çš„æŒ‚è½½ç‚¹ã€‚å…¶ä¸­çš„ <code>/run/secrets/kubernetes.io/serviceaccount/</code> ç›®å½•ä¸‹å°±æœ‰ç€æ¯”è¾ƒæ•æ„Ÿçš„ä¿¡æ¯ã€‚</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tmpfs on /run/secrets/kubernetes.io/serviceaccount type tmpfs (ro,relatime)</span><br><span class="line">/ # tree /run/secrets/kubernetes.io/serviceaccount/</span><br><span class="line">/run/secrets/kubernetes.io/serviceaccount/</span><br><span class="line">â”œâ”€â”€ ca.crt -&gt; ..data/ca.crt</span><br><span class="line">â”œâ”€â”€ namespace -&gt; ..data/namespace</span><br><span class="line">â””â”€â”€ token -&gt; ..data/token</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<ul>
<li><p><code>--tmpfs</code>ï¼šç›´æ¥æŒ‡å®šå®¹å™¨ä¸­çš„æŒ‚è½½ç‚¹ã€‚ä¸å…è®¸æŒ‡å®šä»»ä½•é…ç½®é€‰é¡¹</p>
</li>
<li><p>â€“mountï¼šç”±å¤šä¸ªâ€™,â€™éš”å¼€çš„é”®å€¼å¯¹<key>=<value>ç»„æˆï¼š</p>
<p>  æŒ‚è½½ç±»å‹ï¼škeyä¸º<code>type</code>ï¼Œvalueä¸º<code>bind</code>ã€<code>volume</code>æˆ–<code>tmpfs</code></p>
<p>  å®¹å™¨ä¸­çš„æŒ‚è½½ç‚¹ï¼škeyä¸º<code>destination</code>ã€<code>dst</code>æˆ–<code>target</code>ï¼Œvalueä¸ºå®¹å™¨ä¸­çš„è·¯å¾„</p>
<p>  <code>tmpfs-size</code>å’Œ<code>tmpfs-mode</code>é€‰é¡¹</p>
</li>
</ul>
</blockquote>
<h3 id="kubelet-æŒ‚è½½å­˜å‚¨"><a href="#kubelet-æŒ‚è½½å­˜å‚¨" class="headerlink" title="kubelet æŒ‚è½½å­˜å‚¨"></a>kubelet æŒ‚è½½å­˜å‚¨</h3><p>å½“å¯¹å®¹å™¨å­˜å‚¨çš„ç±»å‹æœ‰äº†å¤§è‡´äº†è§£ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ Pod æ˜¯å¦‚ä½•è¿›è¡Œ volume æŒ‚è½½çš„ã€‚</p>
<p>å½“ Pod è¢«è°ƒåº¦åˆ°ä¸€ä¸ª Node èŠ‚ç‚¹ä¸Šåï¼ŒNode èŠ‚ç‚¹ä¸Šçš„ kubelet ç»„ä»¶å°±ä¼šä¸ºè¿™ä¸ª Pod åˆ›å»ºå®ƒçš„ Volume ç›®å½•ï¼Œé»˜è®¤æƒ…å†µä¸‹ kubelet ä¸º Volume åˆ›å»ºçš„ç›®å½•åœ¨ kubelet çš„å·¥ä½œç›®å½•ï¼ˆé»˜è®¤åœ¨ <code>/var/lib/kubelet</code> ï¼‰ï¼Œåœ¨ kubelet å¯åŠ¨çš„æ—¶å€™å¯ä»¥æ ¹æ® <code>â€“root-dir</code> å‚æ•°æ¥æŒ‡å®šå·¥ä½œç›®å½•ï¼Œä¸è¿‡ä¸€èˆ¬æ²¡å•¥ç‰¹æ®Šè¦æ±‚è¿˜æ˜¯ä½¿ç”¨é»˜è®¤çš„å°±å¥½ğŸ˜‚ã€‚Pod çš„ volume ç›®å½•å°±åœ¨è¯¥ç›®å½•ä¸‹ï¼Œè·¯å¾„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¯”å¦‚:</span></span><br><span class="line">/var/lib/kubelet/pods/c4b1998b-f5c1-440a-b9bc-7fbf87f3c267/volumes/kubernetes.io~nfs/nfs211</span><br></pre></td></tr></table></figure>
<p>åœ¨ Node èŠ‚ç‚¹ä¸Šå¯ä»¥ä½¿ç”¨ mount å‘½ä»¤æ¥æŸ¥çœ‹ kubelet ä¸º Pod æŒ‚è½½çš„æŒ‚è½½ç‚¹ä¿¡æ¯ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.107.216:/nfs on /var/lib/kubelet/pods/6750b756-d8e4-448a-93f9-8906f9c44788/volumes/kubernetes.io~nfs/nfs-test type nfs (rw,relatime,vers=3,rsize=1048576,wsize=1048576,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=10.10.107.216,mountvers=3,mountport=56389,mountproto=udp,local_lock=none,addr=10.10.107.216)</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@k8s-node-3 ~</span><br><span class="line">â•°â”€# mount | grep kubelet</span><br><span class="line">tmpfs on /var/lib/kubelet/pods/45c55c5e-ce96-47fd-94b3-60a334e5a44d/volumes/kubernetes.io~secret/kube-proxy-token-h4dfb type tmpfs (rw,relatime,seclabel)</span><br><span class="line">tmpfs on /var/lib/kubelet/pods/3fb63baa-27ec-4d76-8028-39a0a8f91749/volumes/kubernetes.io~secret/calico-node-token-4hks6 type tmpfs (rw,relatime,seclabel)</span><br><span class="line">tmpfs on /var/lib/kubelet/pods/05c75313-f932-4913-b09f-d7bccdfb6e62/volumes/kubernetes.io~secret/nginx-ingress-token-5569x type tmpfs (rw,relatime,seclabel)</span><br><span class="line">10.20.172.211:/nfs on /var/lib/kubelet/pods/c4b1998b-f5c1-440a-b9bc-7fbf87f3c267/volumes/kubernetes.io~nfs/nfs211 type nfs (rw,relatime,vers=3,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=10.20.172.211,mountvers=3,mountport=20048,mountproto=udp,local_lock=none,addr=10.20.172.211)</span><br><span class="line">tmpfs on /var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/volumes/kubernetes.io~secret/default-token-wgfd9 type tmpfs (rw,relatime,seclabel)</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ kubernetes ç›®å‰æ”¯æŒçš„ Volume çš„ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>kubectl explain pod.spec.volumes</code>  æ¥æŸ¥çœ‹ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@k8s-master-01 ~</span><br><span class="line">â•°â”€# kubectl explain pod.spec.volumes | grep Object | cut -d "&lt;" -f1</span><br><span class="line">RESOURCE: volumes</span><br><span class="line">awsElasticBlockStore</span><br><span class="line">azureDisk</span><br><span class="line">azureFile</span><br><span class="line">cephfs</span><br><span class="line">cinder</span><br><span class="line">configMap</span><br><span class="line">csi</span><br><span class="line">downwardAPI</span><br><span class="line">emptyDir</span><br><span class="line">fc</span><br><span class="line">flexVolume</span><br><span class="line">flocker</span><br><span class="line">gcePersistentDisk</span><br><span class="line">gitRepo</span><br><span class="line">glusterfs</span><br><span class="line">hostPath</span><br><span class="line">iscsi</span><br><span class="line">nfs</span><br><span class="line">persistentVolumeClaim</span><br><span class="line">photonPersistentDisk</span><br><span class="line">portworxVolume</span><br><span class="line">projected</span><br><span class="line">quobyte</span><br><span class="line">rbd</span><br><span class="line">scaleIO</span><br><span class="line">secret</span><br><span class="line">storageos</span><br><span class="line">vsphereVolume</span><br></pre></td></tr></table></figure>
<h3 id="ç®¡-systemd-ä»€ä¹ˆäº‹å„¿ï¼Ÿ"><a href="#ç®¡-systemd-ä»€ä¹ˆäº‹å„¿ï¼Ÿ" class="headerlink" title="ç®¡ systemd ä»€ä¹ˆäº‹å„¿ï¼Ÿ"></a>ç®¡ systemd ä»€ä¹ˆäº‹å„¿ï¼Ÿ</h3><p>æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹å½“åˆçš„é”™è¯¯æ—¥å¿—ï¼š</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Events:</span><br><span class="line">  Type     Reason       Age    From            Message</span><br><span class="line">  ----  ------  ---- ----     -------</span><br><span class="line">  Warning  FailedMount  <span class="number">8</span>m49s  kubelet, node1  MountVolume<span class="variable">.SetUp</span> failed <span class="keyword">for</span> volume <span class="string">"nfs211"</span> : mount failed: exit status <span class="number">32</span></span><br><span class="line">Mounting command: systemd-run</span><br><span class="line">Mounting arguments: --description=Kubernetes transient mount <span class="keyword">for</span> /<span class="keyword">var</span>/lib/kubelet/pods/cddc94e7-<span class="number">8033</span>-<span class="number">4150</span>-bed5-d141e3b71e49/volumes/kubernetes<span class="variable">.io</span>~nfs/nfs211 --scope -- mount -t nfs <span class="number">10</span><span class="variable">.20</span><span class="variable">.172</span><span class="variable">.211</span>:/nfs /<span class="keyword">var</span>/lib/kubelet/pods/cddc94e7-<span class="number">8033</span>-<span class="number">4150</span>-bed5-d141e3b71e49/volumes/kubernetes<span class="variable">.io</span>~nfs/nfs211</span><br><span class="line">Output: Running scope as unit run-<span class="number">38284</span><span class="variable">.scope</span>.</span><br><span class="line">mount: wrong fs <span class="keyword">type</span>, bad option, bad superblock on <span class="number">10</span><span class="variable">.20</span><span class="variable">.172</span><span class="variable">.211</span>:/nfs,</span><br><span class="line">       missing codepage <span class="keyword">or</span> helper <span class="keyword">program</span>, <span class="keyword">or</span> other error</span><br><span class="line">       (<span class="keyword">for</span> several filesystems (e<span class="variable">.g</span>. nfs, cifs) you might</span><br><span class="line">       need a /sbin/mount.&lt;<span class="keyword">type</span>&gt; helper <span class="keyword">program</span>)</span><br><span class="line"></span><br><span class="line">       In some cases useful info is found in syslog - try</span><br><span class="line">       dmesg | tail <span class="keyword">or</span> so.</span><br><span class="line">  Warning  FailedMount  <span class="number">8</span>m48s  kubelet, node1  MountVolume<span class="variable">.SetUp</span> failed <span class="keyword">for</span> volume <span class="string">"nfs211"</span> : mount failed: exit status <span class="number">32</span></span><br></pre></td></tr></table></figure>
<p>å’¦ï¼Ÿå½“æ—¶æˆ‘è¿˜å¯»æ€ç€ kubelet æŒ‚è½½ volumes å’Œ systemd ä»€ä¹ˆå…³ç³»ï¼Ÿ<code>systemd</code> è¿™ä¸ªå¤§å¦ˆæ€ä¹ˆåˆæ¥ç®¡è¿™äº‹å„¿äº†ğŸ˜‚ï¼ˆä¹‹å‰æˆ‘å†™è¿‡ä¸€ç¯‡<a href="https://blog.k8s.li/systemd.html">ã€ŠLinux çš„å°ä¼™ä¼´ systemd è¯¦è§£ã€‹</a> ï¼Œæˆç§° systemd æ˜¯ Linux çš„å°ä¼™ä¼´ï¼Œçœ‹æ¥è¿™ä¸ªè¯´æ³•æ˜¯ä¸å¦¥çš„ã€‚systemd ç®€ç›´å°±æ˜¯ Linux é‡Œçš„ç‰©ä¸šå¤§å¦ˆå¥½å˜›ğŸ¤£ï¼Œä¸Šç®¡ service ä¸‹ç®¡ dev ã€ mount è®¾å¤‡ç­‰ã€‚å±‘ï¼Œç®€ç›´å°±æ˜¯ä¸ªç‰©ä¸šå¤§å¦ˆç®¡è¿™ç®¡é‚£çš„ã€‚å›åˆ°æ­£é¢˜ï¼Œäºæ˜¯é¡ºç€è¿™æ¡æŠ¥é”™æ—¥å¿—é¡ºè—¤æ‘¸ç“œæ‰¾åˆ°äº† <a href="https://github.com/kubernetes/kubernetes/pull/49640" target="_blank" rel="noopener">Run mount in its own systemd scope.</a> è¿™ä¸ª PRã€‚</p>
<blockquote>
<p>Kubelet needs to run /bin/mount in its own cgroup.</p>
<ul>
<li>When kubelet runs as a systemd service, â€œsystemctl restart kubeletâ€ may kill all processes in the same cgroup and thus terminate fuse daemons that are needed for gluster and cephfs mounts.</li>
<li>When kubelet runs in a docker container, restart of the container kills all fuse daemons started in the container.</li>
</ul>
<p>Killing fuse daemons is bad, it basically unmounts volumes from running pods.</p>
<p>This patch runs mount via â€œsystemd-run â€“scope /bin/mount â€¦â€, which makes sure that any fuse daemons are forked in its own systemd scope (= cgroup) and they will survive restart of kubeletâ€™s systemd service or docker container.</p>
<p>This helps with <a href="https://github.com/kubernetes/kubernetes/issues/34965" target="_blank" rel="noopener">#34965</a></p>
<p>As a downside, each new fuse daemon will run in its own transient systemd service and systemctl output may be cluttered.</p>
</blockquote>
<p>æ­£å¦‚æè¿™ä¸ª PR çš„å¤§ä½¬è®²çš„ï¼Œï¼ˆä¹‹å‰ï¼‰kubelet éœ€è¦åœ¨å®ƒè‡ªå·±çš„ <code>cgroup</code> é‡Œè¿è¡Œå®¿ä¸»æœºä¸Šçš„ <code>/bin/mount</code> æ¥ä¸º Pod æŒ‚è½½ volumes ï¼Œè€Œå½“ kubelet è¿›ç¨‹é‡å¯æˆ–è€…æŒ‚æ‰çš„æ—¶å€™ï¼Œè¿™äº›åœ¨ kubelet çš„  <code>cgroup</code> é‡Œè¿è¡Œçš„è¿›ç¨‹ä¹Ÿå°†ä¼šæŒ‚æ‰ï¼Œæ¯”å¦‚ï¼ˆglusterï¼Œcephï¼‰ã€‚ç„¶åå¤§ä½¬çš„è¿™ä¸ª patch é€šè¿‡ <code>systemd-run --scope /bin/mount</code> æ¥å»å¯åŠ¨ä¸€ä¸ªä¸´æ—¶çš„ systemd å•å…ƒæ¥ä¸º Pod æŒ‚è½½ volumesï¼Œè¿™æ ·ä¸€æ¥è¿™äº› <code>fuse daemons</code>  è¿›ç¨‹ï¼ˆglusterï¼Œcephï¼‰å°±ä¼š forked åˆ°å®ƒè‡ªå·±çš„ systemd scope é‡Œï¼Œè¿™æ ·å³ä¾¿ kubelet é‡å¯æˆ–è€…æŒ‚æ‰ä¹Ÿä¸ä¼šå½±å“æ­£åœ¨è¿è¡Œçš„å®¹å™¨ä½¿ç”¨ volumesã€‚</p>
<p>è¿™ä¸€ç‚¹åƒ <a href="https://github.com/containerd/containerd" target="_blank" rel="noopener">containerd</a> ä¹‹äº dockerd ï¼Œå³ä¾¿ dockerd é‡å¯ä¹Ÿä¸ä¼šå½±å“åˆ°å®¹å™¨çš„è¿è¡Œï¼Œå› ä¸ºï¼Œåœ¨è¿è¡Œæ—¶è¿™ä¸€å—ï¼ŒçœŸæ­£è¿è¡Œå®¹å™¨çš„æ˜¯ containerd ä¸‹çš„å„ä¸ª containerd-shim å­è¿›ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ pstree å‘½ä»¤æ¥çœ‹ä¸€ä¸‹è¿™ç§å±‚çº§å…³ç³»ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€containerdâ”€â”¬â”€5*[containerd-shimâ”€â”¬â”€pause]</span><br><span class="line">â”‚            â”‚                    â””â”€9*[&#123;containerd-shim&#125;]]</span><br><span class="line">â”‚            â”œâ”€containerd-shimâ”€â”¬â”€pause</span><br><span class="line">â”‚            â”‚                 â””â”€10*[&#123;containerd-shim&#125;]</span><br><span class="line">â”‚            â”œâ”€containerd-shimâ”€â”¬â”€etcdâ”€â”€â”€15*[&#123;etcd&#125;]</span><br><span class="line">â”‚            â”‚                 â””â”€9*[&#123;containerd-shim&#125;]</span><br><span class="line">â”‚            â”œâ”€containerd-shimâ”€â”¬â”€kube-controllerâ”€â”€â”€12*[&#123;kube-controller&#125;]</span><br><span class="line">â”‚            â”‚                 â””â”€9*[&#123;containerd-shim&#125;]</span><br><span class="line">â”‚            â”œâ”€containerd-shimâ”€â”¬â”€kube-apiserverâ”€â”€â”€14*[&#123;kube-apiserver&#125;]</span><br><span class="line">â”‚            â”‚                 â””â”€9*[&#123;containerd-shim&#125;]</span><br><span class="line">â”‚            â”œâ”€containerd-shimâ”€â”¬â”€kube-schedulerâ”€â”€â”€13*[&#123;kube-scheduler&#125;]</span><br><span class="line">â”‚            â”‚                 â””â”€9*[&#123;containerd-shim&#125;]</span><br><span class="line">â”‚            â”œâ”€containerd-shimâ”€â”¬â”€kube-proxyâ”€â”€â”€11*[&#123;kube-proxy&#125;]</span><br><span class="line">â”‚            â”‚                 â””â”€9*[&#123;containerd-shim&#125;]</span><br><span class="line">â”‚            â”œâ”€containerd-shimâ”€â”¬â”€flanneldâ”€â”€â”€15*[&#123;flanneld&#125;]</span><br><span class="line">â”‚            â”‚                 â””â”€9*[&#123;containerd-shim&#125;]</span><br><span class="line">â”‚            â””â”€26*[&#123;containerd&#125;]</span><br></pre></td></tr></table></figure>
<p>æ¥ç€é¡ºè—¤æ‘¸ç“œç¿»åˆ°è¿™ä¸ª PR å¯¹åº”çš„æºç æ–‡ä»¶  <a href="https://github.com/kubernetes/kubernetes/blob/master/vendor/k8s.io/utils/mount/mount_linux.go#L115" target="_blank" rel="noopener">mount_linux.go</a>ï¼Œå…³é”®å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// doMount runs the mount command. mounterPath is the path to mounter binary if containerized mounter is used.</span></span><br><span class="line"><span class="comment">// sensitiveOptions is an extention of options except they will not be logged (because they may contain sensitive material)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mounter *Mounter)</span> <span class="title">doMount</span><span class="params">(mounterPath <span class="keyword">string</span>, mountCmd <span class="keyword">string</span>, source <span class="keyword">string</span>, target <span class="keyword">string</span>, fstype <span class="keyword">string</span>, options []<span class="keyword">string</span>, sensitiveOptions []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	mountArgs, mountArgsLogStr := MakeMountArgsSensitive(source, target, fstype, options, sensitiveOptions)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(mounterPath) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		mountArgs = <span class="built_in">append</span>([]<span class="keyword">string</span>&#123;mountCmd&#125;, mountArgs...)</span><br><span class="line">		mountArgsLogStr = mountCmd + <span class="string">" "</span> + mountArgsLogStr</span><br><span class="line">		mountCmd = mounterPath</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> mounter.withSystemd &#123;</span><br><span class="line">		<span class="comment">// Try to run mount via systemd-run --scope. This will escape the</span></span><br><span class="line">		<span class="comment">// service where kubelet runs and any fuse daemons will be started in a</span></span><br><span class="line">		<span class="comment">// specific scope. kubelet service than can be restarted without killing</span></span><br><span class="line">		<span class="comment">// these fuse daemons.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// Complete command line (when mounterPath is not used):</span></span><br><span class="line">		<span class="comment">// systemd-run --description=... --scope -- mount -t &lt;type&gt; &lt;what&gt; &lt;where&gt;</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// Expected flow:</span></span><br><span class="line">		<span class="comment">// * systemd-run creates a transient scope (=~ cgroup) and executes its</span></span><br><span class="line">		<span class="comment">//   argument (/bin/mount) there.</span></span><br><span class="line">		<span class="comment">// * mount does its job, forks a fuse daemon if necessary and finishes.</span></span><br><span class="line">		<span class="comment">//   (systemd-run --scope finishes at this point, returning mount's exit</span></span><br><span class="line">		<span class="comment">//   code and stdout/stderr - thats one of --scope benefits).</span></span><br><span class="line">		<span class="comment">// * systemd keeps the fuse daemon running in the scope (i.e. in its own</span></span><br><span class="line">		<span class="comment">//   cgroup) until the fuse daemon dies (another --scope benefit).</span></span><br><span class="line">		<span class="comment">//   Kubelet service can be restarted and the fuse daemon survives.</span></span><br><span class="line">		<span class="comment">// * When the fuse daemon dies (e.g. during unmount) systemd removes the</span></span><br><span class="line">		<span class="comment">//   scope automatically.</span></span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		<span class="comment">// systemd-mount is not used because it's too new for older distros</span></span><br><span class="line">		<span class="comment">// (CentOS 7, Debian Jessie).</span></span><br><span class="line">		mountCmd, mountArgs, mountArgsLogStr = AddSystemdScopeSensitive(<span class="string">"systemd-run"</span>, target, mountCmd, mountArgs, mountArgsLogStr)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// No systemd-run on the host (or we failed to check it), assume kubelet</span></span><br><span class="line">		<span class="comment">// does not run as a systemd service.</span></span><br><span class="line">		<span class="comment">// No code here, mountCmd and mountArgs are already populated.</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Logging with sensitive mount options removed.</span></span><br><span class="line">	klog.V(<span class="number">4</span>).Infof(<span class="string">"Mounting cmd (%s) with arguments (%s)"</span>, mountCmd, mountArgsLogStr)</span><br><span class="line">	command := exec.Command(mountCmd, mountArgs...)</span><br><span class="line">	output, err := command.CombinedOutput()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		klog.Errorf(<span class="string">"Mount failed: %v\nMounting command: %s\nMounting arguments: %s\nOutput: %s\n"</span>, err, mountCmd, mountArgsLogStr, <span class="keyword">string</span>(output))</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">"mount failed: %v\nMounting command: %s\nMounting arguments: %s\nOutput: %s"</span>,</span><br><span class="line">			err, mountCmd, mountArgsLogStr, <span class="keyword">string</span>(output))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥çœ‹ä¸€ä¸‹ <code>doMount</code> è¿™ä¸ªå‡½æ•°çš„å‡ ä¸ªå½¢å‚ï¼š</p>
<ul>
<li>mounterPath ï¼š</li>
</ul>
<p>å°±æ˜¯æˆ‘ä»¬å®¿ä¸»æœºä¸Šçš„æŒ‚è½½å‘½ä»¤æ¯”å¦‚ <code>/sbin/mount.nfs</code> ã€<code>/sbin/mount.glusterfs</code> ç­‰ã€‚</p>
<ul>
<li><p>mountCmdï¼šæŒ‚è½½å‘½ä»¤å°±æ˜¯ <code>systemd-run</code></p>
</li>
<li><p>sourceï¼šæŒ‚è½½å­˜å‚¨çš„æºè·¯å¾„ï¼Œæ¯”å¦‚ NFS é‡Œçš„ <code>10.10.107.211:/nfs</code></p>
</li>
<li><p>target</p>
</li>
</ul>
<p>å°±æ˜¯æˆ‘ä»¬çš„ Pod çš„ volume ï¼Œåœ¨ <code>/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;</code> ï¼Œç€ç›®å½•åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™ä¼š bind mount åˆ°å®¹å™¨å†…çš„æŒ‚è½½ç‚¹</p>
<ul>
<li><p>fstypeï¼šæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼ŒNFSã€cephã€GlusterFS</p>
</li>
<li><p>options []stringï¼šæŒ‚è½½çš„å‚æ•°ï¼Œæ¯”å¦‚ NFS çš„</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(rw,relatime,vers=3,rsize=524288,wsize=524288,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=10.20.172.211,mountvers=3,mountport=20048,mountproto=udp,local_lock=none,addr=10.20.172.211)</span><br></pre></td></tr></table></figure>
<ul>
<li>sensitiveOptions []stringï¼Œè¿™ä¸ªå‚æ•°æ²¡å»ä»”ç»†çœ‹ï¼Œå°±ç•¥è¿‡å§ï¼ˆ</li>
</ul>
<p>è‡³æ­¤ kubelet ä¸º Pod æŒ‚è½½çš„åŸç†å’Œæµç¨‹ä¹Ÿä¸€ç›®äº†ç„¶ï¼Œå…¶å®å¾ˆç®€å•çš„é€»è¾‘ï¼Œå¤§è‡´å¯ä»¥æ°›å›´</p>
<ul>
<li>Attach é˜¶æ®µï¼škubelet ä½¿ç”¨ systemd-run å•ç‹¬èµ·ä¸€ä¸ªä¸´æ—¶çš„ systemd scope æ¥è¿è¡Œåç«¯å­˜å‚¨çš„å®¢æˆ·ç«¯æ¯”å¦‚ï¼ˆ nfs ã€glusterã€cephï¼‰ï¼Œå°†è¿™äº›å­˜å‚¨æŒ‚è½½åˆ° <code>/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;</code></li>
<li>Mount é˜¶æ®µï¼šå®¹å™¨å¯åŠ¨çš„æ—¶å€™é€šè¿‡ bind mount çš„æ–¹å¼å°†  <code>/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;</code> è¿™ä¸ªç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ã€‚è¿™ä¸€æ­¥ç›¸å½“äºä½¿ç”¨<code>docker run -v /var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;:/&lt;å®¹å™¨å†…çš„ç›®æ ‡ç›®å½•&gt; æˆ‘çš„é•œåƒ</code> å¯åŠ¨ä¸€ä¸ªå®¹å™¨ã€‚</li>
</ul>
<p>å…³äºæ›´è¯¦ç»†çš„ CSI å­˜å‚¨å¯ä»¥å‚è€ƒä¸‹é¢æåˆ°çš„æ–‡ç« </p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>è™½ç„¶æ˜¯ä¸€ç¯‡å¾ˆç®€å•çš„åˆ†æï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å‚è€ƒäº†å¾ˆå¤šçš„åšå®¢ï¼Œæ²¡æœ‰è¿™äº›å¤§ä½¬çš„åˆ†äº«å°±æ²¡æœ‰è¿™ç¯‡æ–‡ç« ï¼šï¼‰ï¼Œè¿™äº›å¤§ä½¬ä»¬çš„åšå®¢æ–‡ç« æ¯”æˆ‘å†™çš„<code>ä¸çŸ¥é“é«˜åˆ°å“ªé‡Œå»äº†</code>ï¼Œæ‰€ä»¥å¦‚æœä½ çœ‹äº†è¿™ç¯‡æ–‡ç« è¿˜æ˜¯æ²¡æ‡‚çš„è¯ï¼Œä¸å¦¨ä¹Ÿçœ‹ä¸€ä¸‹ä¸‹é¢çš„è¿™äº›æ–‡ç« å°±èƒ½è±ç„¶å¼€æœ—äº†ğŸ˜‚ã€‚</p>
<h3 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h3><ul>
<li><p><a href="https://github.com/kubernetes/kubernetes/blob/master/vendor/k8s.io/utils/mount/mount_linux.go#L115" target="_blank" rel="noopener">kubernetes/mount_linux.go at master Â· kubernetes/kubernetes</a></p>
</li>
<li><p><a href="https://github.com/kubernetes/kubernetes/pull/49640" target="_blank" rel="noopener">Run mount in its own systemd scope. by jsafrane Â· Pull Request #49640 Â· kubernetes/kubernetes</a></p>
</li>
</ul>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><ul>
<li><p><a href="https://www.huweihuang.com/article/source-analysis/kubelet/create-pod-by-kubelet/#66-mount-volumes" target="_blank" rel="noopener">kubeletæºç åˆ†æï¼ˆå››ï¼‰ä¹‹ Podçš„åˆ›å»º - èƒ¡ä¼Ÿç…Œ | Blog</a></p>
</li>
<li><p><a href="http://ljchen.net/2018/10/28/kubelet%E6%BA%90%E7%A0%81%E6%9E%B6%E6%9E%84%E7%AE%80%E4%BB%8B/" target="_blank" rel="noopener">Kubeletæºç æ¶æ„ç®€ä»‹ | ljchenâ€™s Notes</a></p>
</li>
<li><p><a href="http://newgoo.org/2019/09/03/k8s/kubelet-%E6%BA%90%E7%A0%81/" target="_blank" rel="noopener">kubelet æºç åˆ†æ - Beantech | Newgoo | kubernates</a></p>
</li>
<li><p><a href="http://blog.xbblfz.site/2018/10/12/Kubelet%E5%90%AF%E5%8A%A8%E5%8F%8A%E5%AF%B9Docker%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">â€œKubeletå¯åŠ¨æºç åˆ†æâ€ - å¾æ³¢çš„åšå®¢ | Xu Blog</a></p>
</li>
<li><p><a href="https://cizixs.com/2017/06/06/kubelet-source-code-analysis-part-1/" target="_blank" rel="noopener">kubelet æºç åˆ†æï¼šå¯åŠ¨æµç¨‹ | Cizixs Write Here</a></p>
</li>
<li><p><a href="https://fankangbest.github.io/2017/12/17/kubelet%E5%88%86%E6%9E%90(%E4%B8%89)-volumeManager-v1-5-2/" target="_blank" rel="noopener">kubeletåˆ†æ(ä¸‰)-volumeManager-v1.5.2 | fankangbest</a></p>
</li>
<li><p><a href="https://wenfeng-gao.github.io/post/k8s-volume-manager-source-code-analysis/" target="_blank" rel="noopener">Kubernetesæºç åˆ†æä¹‹VolumeManager - Je pense donc je suis</a></p>
</li>
<li><p><a href="https://www.huweihuang.com/kubernetes-notes/code-analysis/kubelet/startKubelet.html" target="_blank" rel="noopener">startKubelet Â· Kubernetes å­¦ä¹ ç¬”è®°</a></p>
</li>
</ul>
<h3 id="å®˜æ–¹æ–‡æ¡£"><a href="#å®˜æ–¹æ–‡æ¡£" class="headerlink" title="å®˜æ–¹æ–‡æ¡£"></a>å®˜æ–¹æ–‡æ¡£</h3><ul>
<li><p><a href="https://docs.docker.com/storage/" target="_blank" rel="noopener">Manage data in Docker | Docker Documentation</a></p>
</li>
<li><p><a href="https://docs.docker.com/storage/bind-mounts/" target="_blank" rel="noopener">Use bind mounts | Docker Documentation</a></p>
</li>
<li><p><a href="https://docs.docker.com/storage/bind-mounts/" target="_blank" rel="noopener">Use bind mounts | Docker Documentation</a></p>
</li>
<li><p><a href="http://www.jinbuguo.com/man/mount.html" target="_blank" rel="noopener">mount ä¸­æ–‡æ‰‹å†Œ</a></p>
</li>
<li><p><a href="https://docs.docker.com/storage/storagedriver/overlayfs-driver/" target="_blank" rel="noopener">Use the OverlayFS storage driver</a></p>
</li>
</ul>
<h3 id="ç›¸å…³åšå®¢"><a href="#ç›¸å…³åšå®¢" class="headerlink" title="ç›¸å…³åšå®¢"></a>ç›¸å…³åšå®¢</h3><ul>
<li><p><a href="https://cizixs.com/2016/10/25/kubernetes-intro-kubelet/" target="_blank" rel="noopener">kubernetes ç®€ä»‹ï¼š kubelet å’Œ pod | Cizixs Write Here</a></p>
</li>
<li><p><a href="https://michaelyou.github.io/2017/09/17/Docker%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86-Volume%EF%BC%8C-bind-mount%E5%92%8Ctmpfs-mount/" target="_blank" rel="noopener">Dockeræ•°æ®ç®¡ç†-Volumeï¼Œ bind mountå’Œtmpfs mount | Youmai ã® Blog</a></p>
</li>
<li><p><a href="https://www.qikqiak.com/k8strain/storage/csi/" target="_blank" rel="noopener">å­˜å‚¨åŸç† - K8Sè®­ç»ƒè¥</a></p>
</li>
<li><p><a href="https://blog.fatedier.com/2020/04/17/pod-loopcrash-of-k8s-subpath/" target="_blank" rel="noopener">Kubernetes æŒ‚è½½ subpath çš„å®¹å™¨åœ¨ configmap å˜æ›´åé‡å¯æ—¶æŒ‚è½½å¤±è´¥</a></p>
</li>
<li><p><a href="https://www.infvie.com/ops-notes/kubernetes-storage.html" target="_blank" rel="noopener">ç†è§£kubernetesä¸­çš„Storage | Infvieâ€™s Blog</a></p>
</li>
<li><p><a href="https://arkingc.github.io/2018/12/11/2018-12-11-docker-storage-persist/" target="_blank" rel="noopener">Dockerå®¹å™¨æ•°æ®æŒä¹…åŒ–</a></p>
</li>
<li><p><a href="https://arkingc.github.io/2018/01/19/2018-01-19-docker-imagestore/" target="_blank" rel="noopener">Dockeræºç åˆ†æâ€”é•œåƒå­˜å‚¨</a></p>
</li>
<li><p><a href="https://arkingc.github.io/2018/01/15/2018-01-15-docker-storage-overlay2/" target="_blank" rel="noopener">Dockeræºç åˆ†æâ€”å­˜å‚¨é©±åŠ¨</a></p>
</li>
<li><p><a href="https://arkingc.github.io/2017/05/05/2017-05-05-docker-filesystem-overlay/" target="_blank" rel="noopener">Dockerå­˜å‚¨é©±åŠ¨â€”Overlay/Overlay2ã€Œè¯‘ã€</a></p>
</li>
<li><p><a href="https://blog.k8s.li/systemd.html">Linux çš„å°ä¼™ä¼´ systemd è¯¦è§£</a></p>
</li>
</ul>
<h2 id="ç»“æŸ"><a href="#ç»“æŸ" class="headerlink" title="ç»“æŸ"></a>ç»“æŸ</h2><p>æœ€åç¥å„ä½è¿˜åœ¨<code>æ¬ç –</code>çš„å·¥äººä»¬èŠ‚æ—¥å¿«ä¹ï¼</p>
    </div>
      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kubernetes/" rel="tag"><i class="fa fa-tag"></i> kubernetes</a>
              <a href="/tags/%E5%AE%B9%E5%99%A8/" rel="tag"><i class="fa fa-tag"></i> å®¹å™¨</a>
              <a href="/tags/docker/" rel="tag"><i class="fa fa-tag"></i> docker</a>
              <a href="/tags/%E5%AD%98%E5%82%A8/" rel="tag"><i class="fa fa-tag"></i> å­˜å‚¨</a>
              <a href="/tags/volumes/" rel="tag"><i class="fa fa-tag"></i> volumes</a>
          </div>
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/interview-wordpress-install.html" rel="prev" title="ä¸€æ¬¡æœ‰è¶£çš„é¢è¯•ï¼šWordPress éƒ¨ç½²">
      <i class="fa fa-chevron-left"></i> ä¸€æ¬¡æœ‰è¶£çš„é¢è¯•ï¼šWordPress éƒ¨ç½²
    </a></div>
      <div class="post-nav-item">
    <a href="/Brick-removal-note.html" rel="next" title="æ— ç –å¯æ¬çš„æ—¥å­|æ¢å‚è®°">
      æ— ç –å¯æ¬çš„æ—¥å­|æ¢å‚è®° <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
  </article>
  </div>
          </div>
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
        </div>
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>
  <aside class="sidebar">
    <div class="sidebar-inner">
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>
      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ç–‘æƒ‘"><span class="nav-number">1.</span> <span class="nav-text">ç–‘æƒ‘</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é—®é¢˜å¤ç°"><span class="nav-number">2.</span> <span class="nav-text">é—®é¢˜å¤ç°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#è§£å†³é—®é¢˜"><span class="nav-number">3.</span> <span class="nav-text">è§£å†³é—®é¢˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åˆ†æ"><span class="nav-number">4.</span> <span class="nav-text">åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å®¹å™¨å­˜å‚¨"><span class="nav-number">4.1.</span> <span class="nav-text">å®¹å™¨å­˜å‚¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubelet-æŒ‚è½½å­˜å‚¨"><span class="nav-number">4.2.</span> <span class="nav-text">kubelet æŒ‚è½½å­˜å‚¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç®¡-systemd-ä»€ä¹ˆäº‹å„¿ï¼Ÿ"><span class="nav-number">4.3.</span> <span class="nav-text">ç®¡ systemd ä»€ä¹ˆäº‹å„¿ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">5.</span> <span class="nav-text">å‚è€ƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#æºç "><span class="nav-number">5.1.</span> <span class="nav-text">æºç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æºç åˆ†æ"><span class="nav-number">5.2.</span> <span class="nav-text">æºç åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å®˜æ–¹æ–‡æ¡£"><span class="nav-number">5.3.</span> <span class="nav-text">å®˜æ–¹æ–‡æ¡£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ç›¸å…³åšå®¢"><span class="nav-number">5.4.</span> <span class="nav-text">ç›¸å…³åšå®¢</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ç»“æŸ"><span class="nav-number">6.</span> <span class="nav-text">ç»“æŸ</span></a></li></ol></div>
      </div>
      <!--/noindex-->
      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="æœ¨å­"
      src="https://blog.k8s.li/avatar.png">
  <p class="site-author-name" itemprop="name">æœ¨å­</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">98</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:blog@502.li" title="E-Mail â†’ mailto:blog@502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://kindle.502.li/" title="Kindle â†’ https:&#x2F;&#x2F;kindle.502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tg.k8s.li/" title="Channel â†’ https:&#x2F;&#x2F;tg.k8s.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Channel</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>
      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>
      </div>
    </main>
    <footer class="footer">
      <div class="footer-inner">
<div class="copyright">
  &copy; 2018 â€“ 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">æœ¨å­</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">39:50</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>
      </div>
    </footer>
  </div>
  <script src="/lib/anime.min.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>
<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://muzi.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://blog.k8s.li/kubelet-mount-volumes-analysis.html",
            identifier: "kubelet-mount-volumes-analysis.html",
            title: "kubelet æŒ‚è½½ volume åŸç†åˆ†æ"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://muzi.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>
</body>
</html>
