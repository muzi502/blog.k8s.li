<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.3.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="最近在 kubernetes 中使用 NFS 存储的时候遇到了一个小问题，也找到了解决办法，不过还是想深入地了解一下 kubelet 挂载存储的原理和过程，于是就水了这篇博客 😂。虽然平时也知道 PV 、PVC 、存储类等怎么使用，但背后的过程和原理却没有深究过，有点一知半解的感觉。唉，太菜了 😑 （流下了没有技术的眼泪.jpg 疑惑 当使用 NFS 存储的 Pod 调度到没有安装 NFS c">
<meta property="og:type" content="blog">
<meta property="og:title" content="kubelet 挂载 volume 原理分析">
<meta property="og:url" content="https://blog.k8s.li/kubelet-mount-volumes-analysis.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="最近在 kubernetes 中使用 NFS 存储的时候遇到了一个小问题，也找到了解决办法，不过还是想深入地了解一下 kubelet 挂载存储的原理和过程，于是就水了这篇博客 😂。虽然平时也知道 PV 、PVC 、存储类等怎么使用，但背后的过程和原理却没有深究过，有点一知半解的感觉。唉，太菜了 😑 （流下了没有技术的眼泪.jpg 疑惑 当使用 NFS 存储的 Pod 调度到没有安装 NFS c">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/types-of-mounts.png">
<meta property="article:published_time" content="2020-04-30T16:00:00.000Z">
<meta property="article:modified_time" content="2020-04-30T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="容器">
<meta property="article:tag" content="存储">
<meta property="article:tag" content="volumes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/types-of-mounts.png">


<link rel="canonical" href="https://blog.k8s.li/kubelet-mount-volumes-analysis.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/kubelet-mount-volumes-analysis.html","path":"kubelet-mount-volumes-analysis.html","title":"kubelet 挂载 volume 原理分析"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>kubelet 挂载 volume 原理分析 | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%96%91%E6%83%91"><span class="nav-number">1.</span> <span class="nav-text">疑惑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%A4%8D%E7%8E%B0"><span class="nav-number">2.</span> <span class="nav-text">问题复现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98"><span class="nav-number">3.</span> <span class="nav-text">解决问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E5%AD%98%E5%82%A8"><span class="nav-number">4.1.</span> <span class="nav-text">容器存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubelet-%E6%8C%82%E8%BD%BD%E5%AD%98%E5%82%A8"><span class="nav-number">4.2.</span> <span class="nav-text">kubelet 挂载存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%A1-systemd-%E4%BB%80%E4%B9%88%E4%BA%8B%E5%84%BF%EF%BC%9F"><span class="nav-number">4.3.</span> <span class="nav-text">管 systemd 什么事儿？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81"><span class="nav-number">5.1.</span> <span class="nav-text">源码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">5.2.</span> <span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="nav-number">5.3.</span> <span class="nav-text">官方文档</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E5%8D%9A%E5%AE%A2"><span class="nav-number">5.4.</span> <span class="nav-text">相关博客</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E6%9D%9F"><span class="nav-number">6.</span> <span class="nav-text">结束</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">119</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">153</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail → mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/kubelet-mount-volumes-analysis.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="kubelet 挂载 volume 原理分析 | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          kubelet 挂载 volume 原理分析
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-01 2020-05-01T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2020-05-01T00:00:00+08:00">2020-05-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/kubelet-mount-volumes-analysis.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="kubelet-mount-volumes-analysis.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>24k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>22 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>最近在 kubernetes 中使用 NFS 存储的时候遇到了一个小问题，也找到了解决办法，不过还是想深入地了解一下 kubelet 挂载存储的原理和过程，于是就水了这篇博客 😂。虽然平时也知道 PV 、PVC 、存储类等怎么使用，但背后的过程和原理却没有深究过，有点一知半解的感觉。唉，太菜了 😑 （<code>流下了没有技术的眼泪.jpg</code></p>
<h2 id="疑惑"><a href="#疑惑" class="headerlink" title="疑惑"></a>疑惑</h2><blockquote>
<p>当使用 NFS 存储的 Pod 调度到没有安装 NFS client (nfs-utils 、nfs-common) Node 节点上的时候，会提示 NFS volume 挂载失败，Node 宿主机安装上 NFS client 后就可以正常挂载了，我想是不是 kubelet 在启动容器之前是不是调用 system-run 去挂载 NFS ，如果 Node 宿主机没有安装 NFS client 就无法挂载。</p>
<p>翻了一下源码 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/vendor/k8s.io/utils/mount/mount_linux.go#L115">mount_linux.go</a> 和 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/49640">49640</a> 这个 PR。里面提到的是 kubelet 挂载存储卷的时候使用 system-run 挂载，这样一来，即便 kubelet 挂掉或者重启的时候也不会影响到容器使用 kubelet 挂载的存储卷。</p>
</blockquote>
<p>请教了一下两个大佬 <a target="_blank" rel="noopener" href="https://zdyxry.github.io/">Yiran</a> 和 <a target="_blank" rel="noopener" href="http://gaocegege.com/Blog/about/">高策</a>，他们也不太熟悉 😂，不过也找到了解决思路。在使用 GlusterFS 的时候，Node 节点也需要安装 GlusterFS 的客户端，不然 kubelet 也是无法挂载 Pod 的 volume。由此可以确认的是： kubelet 在为 Pod 挂载 volume 的时候，根据 volume 的类型（NFS、GlusterFS、Ceph 等），Pod 所在的 Node 节点宿主机也需要安装好对应的客户端程序。</p>
<h2 id="问题复现"><a href="#问题复现" class="headerlink" title="问题复现"></a>问题复现</h2><p>集群信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-01 opt<span class="token punctuation">]</span><span class="token comment"># kubectl get node</span>
NAME            STATUS   ROLES    AGE    VERSION
k8s-master-01   Ready    master   8d     v1.17.4
k8s-master-02   Ready    master   8d     v1.17.4
k8s-master-03   Ready    master   8d     v1.17.4
k8s-node-02     Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span> 8d     v1.17.4
k8s-node-3      Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span> 3d3h   v1.17.4
node1           Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span> 108s   v1.17.4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>为了方便复现问题还是在 Rancher 上创建了 PV 和 PVC，以及包含两个 Pod 的一个 <code>Deploment</code>，在创建 Deploment 的时候，指定将 Pod 调度到新加入的节点上，即这个节点上并没有安装 NFS 客户端。</p>
<p><strong>PV 信息如下：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-01 opt<span class="token punctuation">]</span><span class="token comment"># kubectl describe pv nfs211</span>
Name:            nfs211
Labels:          cattle.io/creator<span class="token operator">=</span>norman
Annotations:     field.cattle.io/creatorId: user-gwgpp
                 pv.kubernetes.io/bound-by-controller: <span class="token function">yes</span>
Finalizers:      <span class="token punctuation">[</span>kubernetes.io/pv-protection<span class="token punctuation">]</span>
StorageClass:    nfs216
Status:          Bound
Claim:           ops-test/nfs-211
Reclaim Policy:  Retain
Access Modes:    RWX
VolumeMode:      Filesystem
Capacity:        10Gi
Node Affinity:   <span class="token operator">&lt;</span>none<span class="token operator">></span>
Message:
Source:
    Type:      NFS <span class="token punctuation">(</span>an NFS <span class="token function">mount</span> that lasts the lifetime of a pod<span class="token punctuation">)</span>
    Server:    <span class="token number">10.20</span>.172.211
    Path:      /nfs
    ReadOnly:  <span class="token boolean">false</span>
Events:        <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>PVC 信息如下</strong></p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"accessModes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"ReadWriteMany"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"annotations"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"pv.kubernetes.io/bind-completed"</span><span class="token operator">:</span> <span class="token string">"yes"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"baseType"</span><span class="token operator">:</span> <span class="token string">"persistentVolumeClaim"</span><span class="token punctuation">,</span>
    <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"2020-04-30T08:59:15Z"</span><span class="token punctuation">,</span>
    <span class="token property">"createdTS"</span><span class="token operator">:</span> <span class="token number">1588237155000</span><span class="token punctuation">,</span>
    <span class="token property">"creatorId"</span><span class="token operator">:</span> <span class="token string">"user-gwgpp"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"ops-test:nfs-211"</span><span class="token punctuation">,</span>
    <span class="token property">"labels"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"cattle.io/creator"</span><span class="token operator">:</span> <span class="token string">"norman"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"links"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"remove"</span><span class="token operator">:</span> <span class="token string">"…/v3/project/c-rl5jz:p-knsxt/persistentVolumeClaims/ops-test:nfs-211"</span><span class="token punctuation">,</span>
        <span class="token property">"self"</span><span class="token operator">:</span> <span class="token string">"…/v3/project/c-rl5jz:p-knsxt/persistentVolumeClaims/ops-test:nfs-211"</span><span class="token punctuation">,</span>
        <span class="token property">"update"</span><span class="token operator">:</span> <span class="token string">"…/v3/project/c-rl5jz:p-knsxt/persistentVolumeClaims/ops-test:nfs-211"</span><span class="token punctuation">,</span>
        <span class="token property">"yaml"</span><span class="token operator">:</span> <span class="token string">"…/v3/project/c-rl5jz:p-knsxt/persistentVolumeClaims/ops-test:nfs-211/yaml"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"nfs-211"</span><span class="token punctuation">,</span>
    <span class="token property">"namespaceId"</span><span class="token operator">:</span> <span class="token string">"ops-test"</span><span class="token punctuation">,</span>
    <span class="token property">"projectId"</span><span class="token operator">:</span> <span class="token string">"c-rl5jz:p-knsxt"</span><span class="token punctuation">,</span>
    <span class="token property">"resources"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"requests"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"storage"</span><span class="token operator">:</span> <span class="token string">"10Gi"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"/v3/project/schemas/resourceRequirements"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"bound"</span><span class="token punctuation">,</span>
    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"accessModes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"ReadWriteMany"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"capacity"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"storage"</span><span class="token operator">:</span> <span class="token string">"10Gi"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"phase"</span><span class="token operator">:</span> <span class="token string">"Bound"</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"/v3/project/schemas/persistentVolumeClaimStatus"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"storageClassId"</span><span class="token operator">:</span> <span class="token string">"nfs216"</span><span class="token punctuation">,</span>
    <span class="token property">"transitioning"</span><span class="token operator">:</span> <span class="token string">"no"</span><span class="token punctuation">,</span>
    <span class="token property">"transitioningMessage"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"persistentVolumeClaim"</span><span class="token punctuation">,</span>
    <span class="token property">"uuid"</span><span class="token operator">:</span> <span class="token string">"660dc8d1-7911-4d30-b575-b54990de8667"</span><span class="token punctuation">,</span>
    <span class="token property">"volumeId"</span><span class="token operator">:</span> <span class="token string">"nfs211"</span><span class="token punctuation">,</span>
    <span class="token property">"volumeMode"</span><span class="token operator">:</span> <span class="token string">"Filesystem"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Deploment 信息如下：</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">deployment.kubernetes.io/revision</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
    <span class="token key atrule">field.cattle.io/creatorId</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>gwgpp
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2020-04-30T09:00:19Z"</span>
  <span class="token key atrule">generation</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">cattle.io/creator</span><span class="token punctuation">:</span> norman
    <span class="token key atrule">workload.user.cattle.io/workloadselector</span><span class="token punctuation">:</span> deployment<span class="token punctuation">-</span>ops<span class="token punctuation">-</span>test<span class="token punctuation">-</span>node1<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>test
  <span class="token key atrule">name</span><span class="token punctuation">:</span> node1<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>test
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ops<span class="token punctuation">-</span>test
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"1940561"</span>
  <span class="token key atrule">selfLink</span><span class="token punctuation">:</span> /apis/apps/v1/namespaces/ops<span class="token punctuation">-</span>test/deployments/node1<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>test
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 5d14a158<span class="token punctuation">-</span>1eef<span class="token punctuation">-</span>4a94<span class="token punctuation">-</span>8433<span class="token punctuation">-</span>15ad002ee55c
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">workload.user.cattle.io/workloadselector</span><span class="token punctuation">:</span> deployment<span class="token punctuation">-</span>ops<span class="token punctuation">-</span>test<span class="token punctuation">-</span>node1<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>test
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">cattle.io/timestamp</span><span class="token punctuation">:</span> <span class="token string">"2020-04-30T09:01:05Z"</span>
        <span class="token key atrule">workload.cattle.io/state</span><span class="token punctuation">:</span> <span class="token string">'&#123;"bm9kZTE=":"c-rl5jz:machine-wbs6r"&#125;'</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">workload.user.cattle.io/workloadselector</span><span class="token punctuation">:</span> deployment<span class="token punctuation">-</span>ops<span class="token punctuation">-</span>test<span class="token punctuation">-</span>node1<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>test
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> alpine
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
        <span class="token key atrule">name</span><span class="token punctuation">:</span> node1<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>test
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">capabilities</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">stdin</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log
        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File
        <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp
          <span class="token key atrule">name</span><span class="token punctuation">:</span> vol1
      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> node1
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler
      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> vol1
        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span><span class="token number">211</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>创建完 Deploment 之后，使用 kubectl get pod 命令查看 Pod 创建的进度，发现一直卡在 <code>ContainerCreating</code> 状态</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-01 opt<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n ops-test</span>
NAME                              READY   STATUS              RESTARTS   AGE
node1-nfs-test-547c4d7678-j6kwv   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          2m12s
node1-nfs-test-547c4d7678-vwdqg   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          2m12s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>kubectl describe pod 的日志如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-01 opt<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod node1-nfs-test-547c4d7678-j6kwv -n ops-test</span>
Name:           node1-nfs-test-547c4d7678-j6kwv
Namespace:      ops-test
Priority:       <span class="token number">0</span>
Node:           node1/10.10.107.214
Start Time:     Thu, <span class="token number">30</span> Apr <span class="token number">2020</span> <span class="token number">17</span>:00:33 +0800
Labels:         pod-template-hash<span class="token operator">=</span>547c4d7678
                workload.user.cattle.io/workloadselector<span class="token operator">=</span>deployment-ops-test-node1-nfs-test
Annotations:    cattle.io/timestamp: <span class="token number">2020</span>-04-30T09:01:05Z
                workload.cattle.io/state: <span class="token punctuation">&#123;</span><span class="token string">"bm9kZTE="</span><span class="token builtin class-name">:</span><span class="token string">"c-rl5jz:machine-wbs6r"</span><span class="token punctuation">&#125;</span>
Status:         Pending
IP:
IPs:            <span class="token operator">&lt;</span>none<span class="token operator">></span>
Controlled By:  ReplicaSet/node1-nfs-test-547c4d7678
Containers:
  node1-nfs-test:
    Container ID:
    Image:          alpine
    Image ID:
    Port:           <span class="token operator">&lt;</span>none<span class="token operator">></span>
    Host Port:      <span class="token operator">&lt;</span>none<span class="token operator">></span>
    State:          Waiting
      Reason:       ContainerCreating
    Ready:          False
    Restart Count:  <span class="token number">0</span>
    Environment:    <span class="token operator">&lt;</span>none<span class="token operator">></span>
    Mounts:
      /tmp from vol1 <span class="token punctuation">(</span>rw<span class="token punctuation">)</span>
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-f6wjj <span class="token punctuation">(</span>ro<span class="token punctuation">)</span>
Conditions:
  Type              Status
  Initialized       True
  Ready             False
  ContainersReady   False
  PodScheduled      True
Volumes:
  vol1:
    Type:       PersistentVolumeClaim <span class="token punctuation">(</span>a reference to a PersistentVolumeClaim <span class="token keyword">in</span> the same namespace<span class="token punctuation">)</span>
    ClaimName:  nfs-211
    ReadOnly:   <span class="token boolean">false</span>
  default-token-f6wjj:
    Type:        Secret <span class="token punctuation">(</span>a volume populated by a Secret<span class="token punctuation">)</span>
    SecretName:  default-token-f6wjj
    Optional:    <span class="token boolean">false</span>
QoS Class:       BestEffort
Node-Selectors:  <span class="token operator">&lt;</span>none<span class="token operator">></span>
Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="token keyword">for</span> 300s
                 node.kubernetes.io/unreachable:NoExecute <span class="token keyword">for</span> 300s
Events:
  Type     Reason       Age    From            Message
  ----  ------  ---- ----     -------
  Warning  FailedMount  8m49s  kubelet, node1  MountVolume.SetUp failed <span class="token keyword">for</span> volume <span class="token string">"nfs211"</span> <span class="token builtin class-name">:</span> <span class="token function">mount</span> failed: <span class="token builtin class-name">exit</span> status <span class="token number">32</span>
Mounting command: systemd-run
Mounting arguments: <span class="token parameter variable">--description</span><span class="token operator">=</span>Kubernetes transient <span class="token function">mount</span> <span class="token keyword">for</span> /var/lib/kubelet/pods/cddc94e7-8033-4150-bed5-d141e3b71e49/volumes/kubernetes.io~nfs/nfs211 <span class="token parameter variable">--scope</span> -- <span class="token function">mount</span> <span class="token parameter variable">-t</span> nfs <span class="token number">10.20</span>.172.211:/nfs /var/lib/kubelet/pods/cddc94e7-8033-4150-bed5-d141e3b71e49/volumes/kubernetes.io~nfs/nfs211
Output: Running scope as unit run-38284.scope.
mount: wrong fs type, bad option, bad superblock on <span class="token number">10.20</span>.172.211:/nfs,
       missing codepage or helper program, or other error
       <span class="token punctuation">(</span>for several filesystems <span class="token punctuation">(</span>e.g. nfs, cifs<span class="token punctuation">)</span> you might
       need a /sbin/mount.<span class="token operator">&lt;</span>type<span class="token operator">></span> helper program<span class="token punctuation">)</span>

       In some cases useful info is found <span class="token keyword">in</span> syslog - try
       <span class="token function">dmesg</span> <span class="token operator">|</span> <span class="token function">tail</span> or so.
  Warning  FailedMount  8m48s  kubelet, node1  MountVolume.SetUp failed <span class="token keyword">for</span> volume <span class="token string">"nfs211"</span> <span class="token builtin class-name">:</span> <span class="token function">mount</span> failed: <span class="token builtin class-name">exit</span> status <span class="token number">32</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 一台没有安装 NFS 客户端的节点尝试挂载一下 NFS 存储，发现报错的日志和 kubelet 的日志相同 🤔</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-03 ~<span class="token punctuation">]</span><span class="token comment"># mount -t nfs 10.20.172.211:/nfs /tmp</span>
mount: wrong fs type, bad option, bad superblock on <span class="token number">10.20</span>.172.211:/nfs,
       missing codepage or helper program, or other error
       <span class="token punctuation">(</span>for several filesystems <span class="token punctuation">(</span>e.g. nfs, cifs<span class="token punctuation">)</span> you might
       need a /sbin/mount.<span class="token operator">&lt;</span>type<span class="token operator">></span> helper program<span class="token punctuation">)</span>

       In some cases useful info is found <span class="token keyword">in</span> syslog - try
       <span class="token function">dmesg</span> <span class="token operator">|</span> <span class="token function">tail</span> or so.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h2><p>看到 kubelet 报错的日志和我们在宿主机上使用 mount 名挂载 NFS 存储时的错误一样就可以断定为是宿主机的问题。搜了一下报错日志，在 <a target="_blank" rel="noopener" href="https://askubuntu.com/questions/525243/why-do-i-get-wrong-fs-type-bad-option-bad-superblock-error">Why do I get “wrong fs type, bad option, bad superblock” error?</a> 得到提示说需要安装一下 NFS 客户端 (nfs-common、nfs-utils) 😂。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@node1 ~
╰─<span class="token comment"># yum install nfs-utils</span>
………………
Install  <span class="token number">1</span> Package <span class="token punctuation">(</span>+15 Dependent packages<span class="token punctuation">)</span>

Total download size: <span class="token number">1.5</span> M
Installed size: <span class="token number">4.3</span> M
Is this ok <span class="token punctuation">[</span>y/d/N<span class="token punctuation">]</span>:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>yum 一把梭后发现 <code>nfs-utils</code> 还真没有安装 😂。</p>
<p>安装完时候使用 kubectl 删除掉之前的 Pod，Deploment 控制器会自动帮我们将 Pod 数量调和到指定的数量。可以发现 Pod 所在宿主机安装 NFS 客户端之后 kubelet 就能正常为 Pod 挂载 volume 了 而且 Pod 也正常运行了。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod node1-nfs-test-547c4d7678-j6kwv node1-nfs-test-547c4d7678-vwdqg -n ops-test</span>
pod <span class="token string">"node1-nfs-test-547c4d7678-j6kwv"</span> deleted
pod <span class="token string">"node1-nfs-test-547c4d7678-vwdqg"</span> deleted
<span class="token punctuation">[</span>root@k8s-master-01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n ops-test</span>
NAME                              READY   STATUS    RESTARTS   AGE
node1-nfs-test-7589fb4787-cknz4   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          18s
node1-nfs-test-7589fb4787-l9bt2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>进入容器内查看一下容器内挂载点的信息：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it node1-nfs-test-7589fb4787-cknz4 -n ops-test sh</span>
/ <span class="token comment"># df -h</span>
Filesystem                Size      Used Available Use% Mounted on
overlay                  <span class="token number">28</span>.9G      <span class="token number">4</span>.1G     <span class="token number">23</span>.3G  <span class="token number">15</span>% /
<span class="token number">10.20</span>.172.211:/nfs       <span class="token number">28</span>.9G     <span class="token number">14</span>.5G     <span class="token number">12</span>.9G  <span class="token number">53</span>% /tmp
tmpfs                     <span class="token number">1</span>.8G         <span class="token number">0</span>      <span class="token number">1</span>.8G   <span class="token number">0</span>% /sys/firmware
/ <span class="token comment"># mount</span>
rootfs on / <span class="token builtin class-name">type</span> rootfs <span class="token punctuation">(</span>rw<span class="token punctuation">)</span>
<span class="token number">10.20</span>.172.211:/nfs on /tmp <span class="token builtin class-name">type</span> nfs <span class="token punctuation">(</span>rw,relatime,vers<span class="token operator">=</span><span class="token number">3</span>,rsize<span class="token operator">=</span><span class="token number">524288</span>,wsize<span class="token operator">=</span><span class="token number">524288</span>,namlen<span class="token operator">=</span><span class="token number">255</span>,hard,proto<span class="token operator">=</span>tcp,timeo<span class="token operator">=</span><span class="token number">600</span>,retrans<span class="token operator">=</span><span class="token number">2</span>,sec<span class="token operator">=</span>sys,mountaddr<span class="token operator">=</span><span class="token number">10.20</span>.172.211,mountvers<span class="token operator">=</span><span class="token number">3</span>,mountport<span class="token operator">=</span><span class="token number">20048</span>,mountproto<span class="token operator">=</span>udp,local_lock<span class="token operator">=</span>none,addr<span class="token operator">=</span><span class="token number">10.20</span>.172.211<span class="token punctuation">)</span>

<span class="token number">10.20</span>.172.211:/nfs on /mnt/nfs <span class="token builtin class-name">type</span> nfs <span class="token punctuation">(</span>rw,relatime,vers<span class="token operator">=</span><span class="token number">3</span>,rsize<span class="token operator">=</span><span class="token number">524288</span>,wsize<span class="token operator">=</span><span class="token number">524288</span>,namlen<span class="token operator">=</span><span class="token number">255</span>,hard,proto<span class="token operator">=</span>tcp,timeo<span class="token operator">=</span><span class="token number">600</span>,retrans<span class="token operator">=</span><span class="token number">2</span>,sec<span class="token operator">=</span>sys,mountaddr<span class="token operator">=</span><span class="token number">10.20</span>.172.211,mountvers<span class="token operator">=</span><span class="token number">3</span>,mountport<span class="token operator">=</span><span class="token number">20048</span>,mountproto<span class="token operator">=</span>udp,local_lock<span class="token operator">=</span>none,addr<span class="token operator">=</span><span class="token number">10.20</span>.172.211<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>至此问题已经解决了，接下来就到了正文：开始分析一下  kubelet 为 Pod 挂载 volume 的流程和原理 😂</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><h3 id="容器存储"><a href="#容器存储" class="headerlink" title="容器存储"></a>容器存储</h3><p>在分析 Pod 的 volume 之前需要先了解一下 docker 容器的存储。当我们使用 <code>docker inspect</code> &lt; 容器 ID&gt; 命令来查看容器详细信息时，在容器元数据信息的 <code>GraphDriver</code> 字段下包含着一个 <code>Mounts</code> ，而 <code>Mounts</code> 字段里的正是容器挂载的存储，其中里面的 <code>Type</code> 字段里有 <code>bind</code> 和 <code>volume</code> ，其实还有一个 <code>tmpfs</code>。</p>
<p>另外其中的 <code>Data</code> 字段里的 <code>LowerDir</code> 正是容器的镜像层，关于容器镜像层的讲解建议阅读一下 <a target="_blank" rel="noopener" href="https://arkingc.github.io/2018/01/15/2018-01-15-docker-storage-overlay2/">Docker 源码分析—存储驱动</a> ，这篇源码分析 👍，在这里点到为止就不再细究了 😂</p>
<blockquote>
<p>现在，我们已经知道了解了层的创建和删除过程。但是我们一直没有提到一个问题：<strong>我们在容器内看到的文件存在哪？</strong></p>
<p>我们已经知道层目录下有 diff，merged 和 work 3 个目录。diff 存储的是该层的文件，work 是执行一些特定操作时所要用到的目录，所以实际上，<strong>在容器内看到的文件，就存在于 merged 目录下</strong></p>
<p><strong>merged 目录在容器未运行时，是一个空目录，当容器启动时会将该容器所有层的 diff 目录进行联合挂载，挂载到 merged 目录下，挂载时使用的文件系统就是内核 OverlayFS 文件系统</strong></p>
<blockquote>
<p>如果有看过我关于内核 OverlayFS 相关的博文，这里应该已经对 Docker 的 overlay2 存储驱动与内核 OverlayFS 的关系有了一个比较清晰的认识</p>
</blockquote>
<p><strong>当挂载完成后，容器处于一个子文件系统命名空间，只能看到 merged 目录下的文件，相当于 chroot 命令的效果</strong></p>
<p>所以，在停止一个容器时，实际上就是对 merged 目录执行一个卸载命令</p>
</blockquote>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"GraphDriver"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"Data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token property">"LowerDir"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/overlay2/2a846f62b759d87bf8b2731960c4031585fb4ee14bbf313f58e0374c4fee9ce0-init/diff:/var/lib/docker/overlay2/29f9a1e9523d4ec323402a3c2da8a5e288cfe0e6f3168a57dd2388b63775c20a/diff:/var/lib/docker/overlay2/015afa447ae2fcfa592d257644312b286173b9a00d0f2017a4c6ede448a87d47/diff:/var/lib/docker/overlay2/2f71b56cd5550bf299ed33a04e385ef5578511e3a17d35162148f4b84bda4b26/diff"</span><span class="token punctuation">,</span>
                <span class="token property">"MergedDir"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/overlay2/2a846f62b759d87bf8b2731960c4031585fb4ee14bbf313f58e0374c4fee9ce0/merged"</span><span class="token punctuation">,</span>
                <span class="token property">"UpperDir"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/overlay2/2a846f62b759d87bf8b2731960c4031585fb4ee14bbf313f58e0374c4fee9ce0/diff"</span><span class="token punctuation">,</span>
                <span class="token property">"WorkDir"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/overlay2/2a846f62b759d87bf8b2731960c4031585fb4ee14bbf313f58e0374c4fee9ce0/work"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"overlay2"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"Mounts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
                <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>
                <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/opt/wordpress-nginx-docker/webp-server/config.json"</span><span class="token punctuation">,</span>
                <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/etc/config.json"</span><span class="token punctuation">,</span>
                <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">"rw"</span><span class="token punctuation">,</span>
                <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span>
                <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>
                <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/opt/wordpress-nginx-docker/wordpress"</span><span class="token punctuation">,</span>
                <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/var/www/html"</span><span class="token punctuation">,</span>
                <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">"rw"</span><span class="token punctuation">,</span>
                <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span>
                <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"volume"</span><span class="token punctuation">,</span>
                <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"36d087638f2e9ba8472c441bcf906320cfd80419874291f56e039e4f7d1278e7"</span><span class="token punctuation">,</span>
                <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/volumes/36d087638f2e9ba8472c441bcf906320cfd80419874291f56e039e4f7d1278e7/_data"</span><span class="token punctuation">,</span>
                <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/opt/exhaust"</span><span class="token punctuation">,</span>
                <span class="token property">"Driver"</span><span class="token operator">:</span> <span class="token string">"local"</span><span class="token punctuation">,</span>
                <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
                <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">""</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>根据 docker 的官方文档 <a target="_blank" rel="noopener" href="https://docs.docker.com/storage/">Manage data in Docker</a> ，docker 提供了 3 种方法将数据从 Docker 宿主机挂载（mount）到容器内，如下：</p>
<p><img data-src="https://p.k8s.li/types-of-mounts.png"></p>
<p><code>图片从 Docker 官方文档偷来的😂</code></p>
<blockquote>
<ul>
<li><strong>Volumes</strong> are stored in a part of the host filesystem which is <em>managed by Docker</em> (<code>/var/lib/docker/volumes/</code> on Linux). Non-Docker processes should not modify this part of the filesystem. Volumes are the best way to persist data in Docker.</li>
<li><strong>Bind mounts</strong> may be stored <em>anywhere</em> on the host system. They may even be important system files or directories. Non-Docker processes on the Docker host or a Docker container can modify them at any time.</li>
<li><strong><code>tmpfs</code> mounts</strong> are stored in the host system’s memory only, and are never written to the host system’s filesystem.</li>
</ul>
</blockquote>
<p>可以看到容器可以使用的存储有三种：</p>
<ul>
<li>Volumes：使用 Docker 来管理的存储，默认存放在 <code>/var/lib/docker/volumes/</code> 下，我们可以使用 <code>docker volume</code> 子命令来管理这些 volume ，可以创建、查看、列出、清空、删除等操作。非 docker 进程不应该去修改该目录下的文件，<strong>卷是 Docker 容器持久化数据的最好方式</strong>。</li>
</ul>
<blockquote>
<p><code>-v</code> 或 <code>--volume</code>：由 3 个域组成，<code>&#39;:&#39;</code> 分隔</p>
<ul>
<li>第一个域：对于命名卷，为卷名；匿名卷，则忽略，此时会创建匿名卷</li>
<li>第二个域：容器中的挂载点</li>
<li>第三个域：可选参数，由 <code>&#39;,&#39;</code> 隔开，如 <code>ro</code></li>
</ul>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@sg-02 /home/ubuntu
╰─<span class="token comment"># docker volume</span>
Usage:  <span class="token function">docker</span> volume COMMAND
Manage volumes
Commands:
  create      Create a volume
  inspect     Display detailed information on one or <span class="token function">more</span> volumes
  <span class="token function">ls</span>          List volumes
  prune       Remove all unused <span class="token builtin class-name">local</span> volumes
  <span class="token function">rm</span>          Remove one or <span class="token function">more</span> volumes
Run <span class="token string">'docker volume COMMAND --help'</span> <span class="token keyword">for</span> <span class="token function">more</span> information on a command.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>假如在写 <code>Dockerfile</code> 的时候，使用 <code>VOLUME</code> 指令指定容器内的路径。在我们启动容器的时候 docker 会帮我们创建一个持久化存储的 volume。也可在 <code>docker run</code> 或者 <code>docker-compose.yaml</code> 指定 <code>volume</code> 。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">╭─root@sg<span class="token number">-02</span> /home/ubuntu
╰─# docker volume ls
DRIVER              VOLUME NAME
local               docker-elk_elasticsearch
local               opt
╭─root@sg<span class="token number">-02</span> /home/ubuntu
╰─# docker volume inspect opt
<span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token property">"CreatedAt"</span><span class="token operator">:</span> <span class="token string">"2020-03-12T06:58:15Z"</span><span class="token punctuation">,</span>
        <span class="token property">"Driver"</span><span class="token operator">:</span> <span class="token string">"local"</span><span class="token punctuation">,</span>
        <span class="token property">"Labels"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">"Mountpoint"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/volumes/opt/_data"</span><span class="token punctuation">,</span>
        <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"opt"</span><span class="token punctuation">,</span>
        <span class="token property">"Options"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">"Scope"</span><span class="token operator">:</span> <span class="token string">"local"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span>
╭─root@sg<span class="token number">-02</span> /home/ubuntu
╰─# docker inspect docker-elk_elasticsearch
<span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token property">"CreatedAt"</span><span class="token operator">:</span> <span class="token string">"2020-04-24T01:37:07Z"</span><span class="token punctuation">,</span>
        <span class="token property">"Driver"</span><span class="token operator">:</span> <span class="token string">"local"</span><span class="token punctuation">,</span>
        <span class="token property">"Labels"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"com.docker.compose.project"</span><span class="token operator">:</span> <span class="token string">"docker-elk"</span><span class="token punctuation">,</span>
            <span class="token property">"com.docker.compose.version"</span><span class="token operator">:</span> <span class="token string">"1.25.4"</span><span class="token punctuation">,</span>
            <span class="token property">"com.docker.compose.volume"</span><span class="token operator">:</span> <span class="token string">"elasticsearch"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"Mountpoint"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/volumes/docker-elk_elasticsearch/_data"</span><span class="token punctuation">,</span>
        <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"docker-elk_elasticsearch"</span><span class="token punctuation">,</span>
        <span class="token property">"Options"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">"Scope"</span><span class="token operator">:</span> <span class="token string">"local"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Bind mounts：</li>
</ul>
<p>使用 <code>Bind mounts</code> 将宿主机的目录或者文件挂载进容器内，这个文件和目录可以是宿主机文件系统上的任意位置，可以不受 docker 所管理，比如 kubelet 的 volumes 目录：<code>/var/lib/kubelet/pods/&lt;Pod的ID&gt;/volumes/</code> 。 kubelet 在为 Pod 挂载存储的时候也正是通过 <code>Bind mounts</code> 的方式将 Pod 的 volumes 挂载到容器内。所以当我们使用 docker inspect 命令去查看 Pod 内容器的 <code>Mounts</code> 信息是，<code>Type</code> 类型多为 <code>bind</code> 或者 <code>tmpfs</code> ，很少会用到 <code>volumes</code> 。可以理解为 kubelet 的 volumes 目录就像 docker 的 volumes 那样，是由 kubelet 自己来管理的，其他用户或进程不应该去修改它。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">╭─root@k8s-node<span class="token number">-3</span> ~
╰─# docker inspect f1111ee6ac84
<span class="token property">"Mounts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span>
      <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>
      <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/volumes/kubernetes.io~nfs/nfs211"</span><span class="token punctuation">,</span>
      <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/var/www/html"</span><span class="token punctuation">,</span>
      <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
      <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
      <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>
      <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/volumes/kubernetes.io~secret/default-token-wgfd9"</span><span class="token punctuation">,</span>
      <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/var/run/secrets/kubernetes.io/serviceaccount"</span><span class="token punctuation">,</span>
      <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">"ro,Z"</span><span class="token punctuation">,</span>
      <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
      <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>
      <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/etc-hosts"</span><span class="token punctuation">,</span>
      <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/etc/hosts"</span><span class="token punctuation">,</span>
      <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">"Z"</span><span class="token punctuation">,</span>
      <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
      <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>
      <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/containers/nginx/f760f2be"</span><span class="token punctuation">,</span>
      <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/dev/termination-log"</span><span class="token punctuation">,</span>
      <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">"Z"</span><span class="token punctuation">,</span>
      <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用 <code>Bind mounts</code> 可能会有安全问题：容器中运行的进程可以修改宿主机的文件系统，包括创建，修改，删除重要的系统文件或目录。不过可以加参数挂载为只读。</p>
<blockquote>
<p><code>--mount</code>：由多个 <code>&#39;,&#39;</code> 隔开的键值对<key>&#x3D;<value>组成：</p>
<ul>
<li>挂载类型：key 为 <code>type</code>，value 为 <code>bind</code>、<code>volume</code> 或 <code>tmpfs</code></li>
<li>挂载源：key 为 <code>source</code> 或 <code>src</code>，对于命名卷，value 为卷名，对于匿名卷，则忽略</li>
<li>容器中的挂载点：key 为 <code>destination</code>、<code>dst</code> 或 <code>target</code>，value 为容器中的路径</li>
<li>读写类型：value 为 <code>readonly</code>，没有 key</li>
<li>读写类型：value 为 <code>readonly</code>，没有 key</li>
<li>volume-opt 选项，可以出现多次。比如 <code>volume-driver=local,volume-opt=type=nfs,...</code></li>
</ul>
</blockquote>
<ul>
<li><p>tmps：</p>
<p>用来存储一些不需要持久化的状态或敏感数据，比如 <code>kubernetes</code> 中的各种 <code>secret</code> 。比如当我们使用 <code>kubectl exec -it POD</code> ，进入到 Pod 容器内，然后使用 mount 命令查看容器内的挂载点信息就会有很多 tmpfs 类型的挂载点。其中的 <code>/run/secrets/kubernetes.io/serviceaccount/</code> 目录下就有着比较敏感的信息。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tmpfs on /run/secrets/kubernetes.io/serviceaccount <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">(</span>ro,relatime<span class="token punctuation">)</span>
/ <span class="token comment"># tree /run/secrets/kubernetes.io/serviceaccount/</span>
/run/secrets/kubernetes.io/serviceaccount/
├── ca.crt -<span class="token operator">></span> <span class="token punctuation">..</span>data/ca.crt
├── namespace -<span class="token operator">></span> <span class="token punctuation">..</span>data/namespace
└── token -<span class="token operator">></span> <span class="token punctuation">..</span>data/token<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<blockquote>
<ul>
<li><p><code>--tmpfs</code>：直接指定容器中的挂载点。不允许指定任何配置选项</p>
</li>
<li><p>–mount：由多个’,’隔开的键值对<key>&#x3D;<value>组成：</p>
<p>挂载类型：key 为 <code>type</code>，value 为 <code>bind</code>、<code>volume</code> 或 <code>tmpfs</code></p>
<p>容器中的挂载点：key 为 <code>destination</code>、<code>dst</code> 或 <code>target</code>，value 为容器中的路径</p>
<p><code>tmpfs-size</code> 和 <code>tmpfs-mode</code> 选项</p>
</li>
</ul>
</blockquote>
<h3 id="kubelet-挂载存储"><a href="#kubelet-挂载存储" class="headerlink" title="kubelet 挂载存储"></a>kubelet 挂载存储</h3><p>当对容器存储的类型有了大致了解之后，我们再来看一下 Pod 是如何进行 volume 挂载的。</p>
<p>当 Pod 被调度到一个 Node 节点上后，Node 节点上的 kubelet 组件就会为这个 Pod 创建它的 Volume 目录，默认情况下 kubelet 为 Volume 创建的目录在 kubelet 的工作目录（默认在 <code>/var/lib/kubelet</code> ），在 kubelet 启动的时候可以根据 <code>–root-dir</code> 参数来指定工作目录，不过一般没啥特殊要求还是使用默认的就好 😂。Pod 的 volume 目录就在该目录下，路径格式如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/var/lib/kubelet/pods/<span class="token operator">&lt;</span>Pod的ID<span class="token operator">></span>/volumes/kubernetes.io~<span class="token operator">&lt;</span>Volume类型<span class="token operator">></span>/<span class="token operator">&lt;</span>Volume名字<span class="token operator">></span>

<span class="token comment"># 比如:</span>
/var/lib/kubelet/pods/c4b1998b-f5c1-440a-b9bc-7fbf87f3c267/volumes/kubernetes.io~nfs/nfs211<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在 Node 节点上可以使用 mount 命令来查看 kubelet 为 Pod 挂载的挂载点信息。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">10.10</span>.107.216:/nfs on /var/lib/kubelet/pods/6750b756-d8e4-448a-93f9-8906f9c44788/volumes/kubernetes.io~nfs/nfs-test <span class="token builtin class-name">type</span> nfs <span class="token punctuation">(</span>rw,relatime,vers<span class="token operator">=</span><span class="token number">3</span>,rsize<span class="token operator">=</span><span class="token number">1048576</span>,wsize<span class="token operator">=</span><span class="token number">1048576</span>,namlen<span class="token operator">=</span><span class="token number">255</span>,hard,proto<span class="token operator">=</span>tcp,timeo<span class="token operator">=</span><span class="token number">600</span>,retrans<span class="token operator">=</span><span class="token number">2</span>,sec<span class="token operator">=</span>sys,mountaddr<span class="token operator">=</span><span class="token number">10.10</span>.107.216,mountvers<span class="token operator">=</span><span class="token number">3</span>,mountport<span class="token operator">=</span><span class="token number">56389</span>,mountproto<span class="token operator">=</span>udp,local_lock<span class="token operator">=</span>none,addr<span class="token operator">=</span><span class="token number">10.10</span>.107.216<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@k8s-node-3 ~
╰─<span class="token comment"># mount | grep kubelet</span>
tmpfs on /var/lib/kubelet/pods/45c55c5e-ce96-47fd-94b3-60a334e5a44d/volumes/kubernetes.io~secret/kube-proxy-token-h4dfb <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">(</span>rw,relatime,seclabel<span class="token punctuation">)</span>
tmpfs on /var/lib/kubelet/pods/3fb63baa-27ec-4d76-8028-39a0a8f91749/volumes/kubernetes.io~secret/calico-node-token-4hks6 <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">(</span>rw,relatime,seclabel<span class="token punctuation">)</span>
tmpfs on /var/lib/kubelet/pods/05c75313-f932-4913-b09f-d7bccdfb6e62/volumes/kubernetes.io~secret/nginx-ingress-token-5569x <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">(</span>rw,relatime,seclabel<span class="token punctuation">)</span>
<span class="token number">10.20</span>.172.211:/nfs on /var/lib/kubelet/pods/c4b1998b-f5c1-440a-b9bc-7fbf87f3c267/volumes/kubernetes.io~nfs/nfs211 <span class="token builtin class-name">type</span> nfs <span class="token punctuation">(</span>rw,relatime,vers<span class="token operator">=</span><span class="token number">3</span>,rsize<span class="token operator">=</span><span class="token number">524288</span>,wsize<span class="token operator">=</span><span class="token number">524288</span>,namlen<span class="token operator">=</span><span class="token number">255</span>,hard,proto<span class="token operator">=</span>tcp,timeo<span class="token operator">=</span><span class="token number">600</span>,retrans<span class="token operator">=</span><span class="token number">2</span>,sec<span class="token operator">=</span>sys,mountaddr<span class="token operator">=</span><span class="token number">10.20</span>.172.211,mountvers<span class="token operator">=</span><span class="token number">3</span>,mountport<span class="token operator">=</span><span class="token number">20048</span>,mountproto<span class="token operator">=</span>udp,local_lock<span class="token operator">=</span>none,addr<span class="token operator">=</span><span class="token number">10.20</span>.172.211<span class="token punctuation">)</span>
tmpfs on /var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/volumes/kubernetes.io~secret/default-token-wgfd9 <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">(</span>rw,relatime,seclabel<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中 kubernetes 目前支持的 Volume 的类型，可以使用 <code>kubectl explain pod.spec.volumes</code>  来查看。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">╭─root@k8s-master-01 ~
╰─<span class="token comment"># kubectl explain pod.spec.volumes | grep Object | cut -d "&lt;" -f1</span>
RESOURCE: volumes
awsElasticBlockStore
azureDisk
azureFile
cephfs
cinder
configMap
csi
downwardAPI
emptyDir
fc
flexVolume
flocker
gcePersistentDisk
gitRepo
glusterfs
hostPath
iscsi
nfs
persistentVolumeClaim
photonPersistentDisk
portworxVolume
projected
quobyte
rbd
scaleIO
secret
storageos
vsphereVolume<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="管-systemd-什么事儿？"><a href="#管-systemd-什么事儿？" class="headerlink" title="管 systemd 什么事儿？"></a>管 systemd 什么事儿？</h3><p>我们来回顾一下当初的错误日志：</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog">Events<span class="token punctuation">:</span>
  Type     Reason       Age    From            Message
  <span class="token operator">----</span>  <span class="token operator">------</span>  <span class="token operator">----</span> <span class="token operator">----</span>     <span class="token operator">-------</span>
  Warning  FailedMount  <span class="token number">8</span>m49s  kubelet<span class="token punctuation">,</span> node1  MountVolume<span class="token punctuation">.</span>SetUp failed <span class="token keyword">for</span> volume <span class="token string">"nfs211"</span> <span class="token punctuation">:</span> mount failed<span class="token punctuation">:</span> exit status <span class="token number">32</span>
Mounting command<span class="token punctuation">:</span> systemd<span class="token operator">-</span>run
Mounting arguments<span class="token punctuation">:</span> <span class="token operator">--</span>description<span class="token operator">=</span>Kubernetes transient mount <span class="token keyword">for</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>kubelet<span class="token operator">/</span>pods<span class="token operator">/</span>cddc94e7<span class="token operator">-</span><span class="token number">8033</span><span class="token operator">-</span><span class="token number">4150</span><span class="token operator">-</span>bed5<span class="token operator">-</span>d141e3b71e49<span class="token operator">/</span>volumes<span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io<span class="token operator">~</span>nfs<span class="token operator">/</span>nfs211 <span class="token operator">--</span>scope <span class="token operator">--</span> mount <span class="token operator">-</span>t nfs <span class="token number">10.20</span><span class="token punctuation">.</span><span class="token number">172.211</span><span class="token punctuation">:</span><span class="token operator">/</span>nfs <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>kubelet<span class="token operator">/</span>pods<span class="token operator">/</span>cddc94e7<span class="token operator">-</span><span class="token number">8033</span><span class="token operator">-</span><span class="token number">4150</span><span class="token operator">-</span>bed5<span class="token operator">-</span>d141e3b71e49<span class="token operator">/</span>volumes<span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io<span class="token operator">~</span>nfs<span class="token operator">/</span>nfs211
Output<span class="token punctuation">:</span> Running scope as unit run<span class="token operator">-</span><span class="token number">38284</span><span class="token punctuation">.</span>scope<span class="token punctuation">.</span>
mount<span class="token punctuation">:</span> wrong fs <span class="token keyword">type</span><span class="token punctuation">,</span> bad option<span class="token punctuation">,</span> bad superblock on <span class="token number">10.20</span><span class="token punctuation">.</span><span class="token number">172.211</span><span class="token punctuation">:</span><span class="token operator">/</span>nfs<span class="token punctuation">,</span>
       missing codepage <span class="token keyword">or</span> helper <span class="token keyword">program</span><span class="token punctuation">,</span> <span class="token keyword">or</span> other error
       <span class="token punctuation">(</span><span class="token keyword">for</span> several filesystems <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> nfs<span class="token punctuation">,</span> cifs<span class="token punctuation">)</span> you might
       need a <span class="token operator">/</span>sbin<span class="token operator">/</span>mount<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token keyword">type</span><span class="token operator">></span> helper <span class="token keyword">program</span><span class="token punctuation">)</span>

       In some cases useful info is found in syslog <span class="token operator">-</span> try
       dmesg <span class="token operator">|</span> tail <span class="token keyword">or</span> so<span class="token punctuation">.</span>
  Warning  FailedMount  <span class="token number">8</span>m48s  kubelet<span class="token punctuation">,</span> node1  MountVolume<span class="token punctuation">.</span>SetUp failed <span class="token keyword">for</span> volume <span class="token string">"nfs211"</span> <span class="token punctuation">:</span> mount failed<span class="token punctuation">:</span> exit status <span class="token number">32</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>咦？当时我还寻思着 kubelet 挂载 volumes 和 systemd 什么关系？<code>systemd</code> 这个大妈怎么又来管这事儿了 😂（之前我写过一篇<a href="https://blog.k8s.li/systemd.html">《Linux 的小伙伴 systemd 详解》</a> ，戏称 systemd 是 Linux 的小伙伴，看来这个说法是不妥的。systemd 简直就是 Linux 里的物业大妈好嘛 🤣，上管 service 下管 dev 、 mount 设备等。屑，简直就是个物业大妈管这管那的。回到正题，于是顺着这条报错日志顺藤摸瓜找到了 <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/49640">Run mount in its own systemd scope.</a> 这个 PR。</p>
<blockquote>
<p>Kubelet needs to run &#x2F;bin&#x2F;mount in its own cgroup.</p>
<ul>
<li>When kubelet runs as a systemd service, “systemctl restart kubelet” may kill all processes in the same cgroup and thus terminate fuse daemons that are needed for gluster and cephfs mounts.</li>
<li>When kubelet runs in a docker container, restart of the container kills all fuse daemons started in the container.</li>
</ul>
<p>Killing fuse daemons is bad, it basically unmounts volumes from running pods.</p>
<p>This patch runs mount via “systemd-run –scope &#x2F;bin&#x2F;mount …”, which makes sure that any fuse daemons are forked in its own systemd scope (&#x3D; cgroup) and they will survive restart of kubelet’s systemd service or docker container.</p>
<p>This helps with <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/34965">#34965</a></p>
<p>As a downside, each new fuse daemon will run in its own transient systemd service and systemctl output may be cluttered.</p>
</blockquote>
<p>正如提这个 PR 的大佬讲的，（之前）kubelet 需要在它自己的 <code>cgroup</code> 里运行宿主机上的 <code>/bin/mount</code> 来为 Pod 挂载 volumes ，而当 kubelet 进程重启或者挂掉的时候，这些在 kubelet 的  <code>cgroup</code> 里运行的进程也将会挂掉，比如（gluster，ceph）。然后大佬的这个 patch 通过 <code>systemd-run --scope /bin/mount</code> 来去启动一个临时的 systemd 单元来为 Pod 挂载 volumes，这样一来这些 <code>fuse daemons</code>  进程（gluster，ceph）就会 forked 到它自己的 systemd scope 里，这样即便 kubelet 重启或者挂掉也不会影响正在运行的容器使用 volumes。</p>
<p>这一点像 <a target="_blank" rel="noopener" href="https://github.com/containerd/containerd">containerd</a> 之于 dockerd ，即便 dockerd 重启也不会影响到容器的运行，因为，在运行时这一块，真正运行容器的是 containerd 下的各个 containerd-shim 子进程，可以使用 pstree 命令来看一下这种层级关系。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">├─containerd─┬─5*<span class="token punctuation">[</span>containerd-shim─┬─pause<span class="token punctuation">]</span>
│            │                    └─9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
│            ├─containerd-shim─┬─pause
│            │                 └─10*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
│            ├─containerd-shim─┬─etcd───15*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>etcd<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
│            │                 └─9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
│            ├─containerd-shim─┬─kube-controller───12*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>kube-controller<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
│            │                 └─9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
│            ├─containerd-shim─┬─kube-apiserver───14*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>kube-apiserver<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
│            │                 └─9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
│            ├─containerd-shim─┬─kube-scheduler───13*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>kube-scheduler<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
│            │                 └─9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
│            ├─containerd-shim─┬─kube-proxy───11*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>kube-proxy<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
│            │                 └─9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
│            ├─containerd-shim─┬─flanneld───15*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>flanneld<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
│            │                 └─9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
│            └─26*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>接着顺藤摸瓜翻到这个 PR 对应的源码文件  <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/vendor/k8s.io/utils/mount/mount_linux.go#L115">mount_linux.go</a>，关键内容如下：</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// doMount runs the mount command. mounterPath is the path to mounter binary if containerized mounter is used.</span>
<span class="token comment">// sensitiveOptions is an extention of options except they will not be logged (because they may contain sensitive material)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>mounter <span class="token operator">*</span>Mounter<span class="token punctuation">)</span> <span class="token function">doMount</span><span class="token punctuation">(</span>mounterPath <span class="token builtin">string</span><span class="token punctuation">,</span> mountCmd <span class="token builtin">string</span><span class="token punctuation">,</span> source <span class="token builtin">string</span><span class="token punctuation">,</span> target <span class="token builtin">string</span><span class="token punctuation">,</span> fstype <span class="token builtin">string</span><span class="token punctuation">,</span> options <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> sensitiveOptions <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	mountArgs<span class="token punctuation">,</span> mountArgsLogStr <span class="token operator">:=</span> <span class="token function">MakeMountArgsSensitive</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">,</span> fstype<span class="token punctuation">,</span> options<span class="token punctuation">,</span> sensitiveOptions<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>mounterPath<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		mountArgs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span>mountCmd<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> mountArgs<span class="token operator">...</span><span class="token punctuation">)</span>
		mountArgsLogStr <span class="token operator">=</span> mountCmd <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> mountArgsLogStr
		mountCmd <span class="token operator">=</span> mounterPath
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> mounter<span class="token punctuation">.</span>withSystemd <span class="token punctuation">&#123;</span>
		<span class="token comment">// Try to run mount via systemd-run --scope. This will escape the</span>
		<span class="token comment">// service where kubelet runs and any fuse daemons will be started in a</span>
		<span class="token comment">// specific scope. kubelet service than can be restarted without killing</span>
		<span class="token comment">// these fuse daemons.</span>
		<span class="token comment">//</span>
		<span class="token comment">// Complete command line (when mounterPath is not used):</span>
		<span class="token comment">// systemd-run --description=... --scope -- mount -t &lt;type> &lt;what> &lt;where></span>
		<span class="token comment">//</span>
		<span class="token comment">// Expected flow:</span>
		<span class="token comment">// * systemd-run creates a transient scope (=~ cgroup) and executes its</span>
		<span class="token comment">//   argument (/bin/mount) there.</span>
		<span class="token comment">// * mount does its job, forks a fuse daemon if necessary and finishes.</span>
		<span class="token comment">//   (systemd-run --scope finishes at this point, returning mount's exit</span>
		<span class="token comment">//   code and stdout/stderr - thats one of --scope benefits).</span>
		<span class="token comment">// * systemd keeps the fuse daemon running in the scope (i.e. in its own</span>
		<span class="token comment">//   cgroup) until the fuse daemon dies (another --scope benefit).</span>
		<span class="token comment">//   Kubelet service can be restarted and the fuse daemon survives.</span>
		<span class="token comment">// * When the fuse daemon dies (e.g. during unmount) systemd removes the</span>
		<span class="token comment">//   scope automatically.</span>
		<span class="token comment">//</span>
		<span class="token comment">// systemd-mount is not used because it's too new for older distros</span>
		<span class="token comment">// (CentOS 7, Debian Jessie).</span>
		mountCmd<span class="token punctuation">,</span> mountArgs<span class="token punctuation">,</span> mountArgsLogStr <span class="token operator">=</span> <span class="token function">AddSystemdScopeSensitive</span><span class="token punctuation">(</span><span class="token string">"systemd-run"</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> mountCmd<span class="token punctuation">,</span> mountArgs<span class="token punctuation">,</span> mountArgsLogStr<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// No systemd-run on the host (or we failed to check it), assume kubelet</span>
		<span class="token comment">// does not run as a systemd service.</span>
		<span class="token comment">// No code here, mountCmd and mountArgs are already populated.</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// Logging with sensitive mount options removed.</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Mounting cmd (%s) with arguments (%s)"</span><span class="token punctuation">,</span> mountCmd<span class="token punctuation">,</span> mountArgsLogStr<span class="token punctuation">)</span>
	command <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>mountCmd<span class="token punctuation">,</span> mountArgs<span class="token operator">...</span><span class="token punctuation">)</span>
	output<span class="token punctuation">,</span> err <span class="token operator">:=</span> command<span class="token punctuation">.</span><span class="token function">CombinedOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Mount failed: %v\nMounting command: %s\nMounting arguments: %s\nOutput: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> mountCmd<span class="token punctuation">,</span> mountArgsLogStr<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"mount failed: %v\nMounting command: %s\nMounting arguments: %s\nOutput: %s"</span><span class="token punctuation">,</span>
			err<span class="token punctuation">,</span> mountCmd<span class="token punctuation">,</span> mountArgsLogStr<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>来看一下 <code>doMount</code> 这个函数的几个形参：</p>
<ul>
<li>mounterPath ：</li>
</ul>
<p>就是我们宿主机上的挂载命令比如 <code>/sbin/mount.nfs</code> 、<code>/sbin/mount.glusterfs</code> 等。</p>
<ul>
<li>mountCmd：挂载命令就是 <code>systemd-run</code></li>
<li>source：挂载存储的源路径，比如 NFS 里的 <code>10.10.107.211:/nfs</code></li>
<li>target</li>
</ul>
<p>就是我们的 Pod 的 volume ，在 <code>/var/lib/kubelet/pods/&lt;Pod的ID&gt;/volumes/kubernetes.io~&lt;Volume类型&gt;/&lt;Volume名字&gt;</code> ，着目录在容器启动的时候会 bind mount 到容器内的挂载点</p>
<ul>
<li>fstype：文件系统类型，NFS、ceph、GlusterFS</li>
<li>options []string：挂载的参数，比如 NFS 的</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>rw,relatime,vers<span class="token operator">=</span><span class="token number">3</span>,rsize<span class="token operator">=</span><span class="token number">524288</span>,wsize<span class="token operator">=</span><span class="token number">524288</span>,namlen<span class="token operator">=</span><span class="token number">255</span>,hard,proto<span class="token operator">=</span>tcp,timeo<span class="token operator">=</span><span class="token number">600</span>,retrans<span class="token operator">=</span><span class="token number">2</span>,sec<span class="token operator">=</span>sys,mountaddr<span class="token operator">=</span><span class="token number">10.20</span>.172.211,mountvers<span class="token operator">=</span><span class="token number">3</span>,mountport<span class="token operator">=</span><span class="token number">20048</span>,mountproto<span class="token operator">=</span>udp,local_lock<span class="token operator">=</span>none,addr<span class="token operator">=</span><span class="token number">10.20</span>.172.211<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>sensitiveOptions []string，这个参数没去仔细看，就略过吧（</li>
</ul>
<p>至此 kubelet 为 Pod 挂载的原理和流程也一目了然，其实很简单的逻辑，大致可以氛围</p>
<ul>
<li>Attach 阶段：kubelet 使用 systemd-run 单独起一个临时的 systemd scope 来运行后端存储的客户端比如（ nfs 、gluster、ceph），将这些存储挂载到 <code>/var/lib/kubelet/pods/&lt;Pod的ID&gt;/volumes/kubernetes.io~&lt;Volume类型&gt;/&lt;Volume名字&gt;</code></li>
<li>Mount 阶段：容器启动的时候通过 bind mount 的方式将  <code>/var/lib/kubelet/pods/&lt;Pod的ID&gt;/volumes/kubernetes.io~&lt;Volume类型&gt;/&lt;Volume名字&gt;</code> 这个目录挂载到容器内。这一步相当于使用 <code>docker run -v /var/lib/kubelet/pods/&lt;Pod的ID&gt;/volumes/kubernetes.io~&lt;Volume类型&gt;/&lt;Volume名字&gt;:/&lt;容器内的目标目录&gt; 我的镜像</code> 启动一个容器。</li>
</ul>
<p>关于更详细的 CSI 存储可以参考下面提到的文章</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>虽然是一篇很简单的分析，在这个过程中参考了很多的博客，没有这些大佬的分享就没有这篇文章：），这些大佬们的博客文章比我写的 <code>不知道高到哪里去了</code>，所以如果你看了这篇文章还是没懂的话，不妨也看一下下面的这些文章就能豁然开朗了 😂。</p>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/vendor/k8s.io/utils/mount/mount_linux.go#L115">kubernetes&#x2F;mount_linux.go at master · kubernetes&#x2F;kubernetes</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/49640">Run mount in its own systemd scope. by jsafrane · Pull Request #49640 · kubernetes&#x2F;kubernetes</a></li>
</ul>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.huweihuang.com/article/source-analysis/kubelet/create-pod-by-kubelet/#66-mount-volumes">kubelet 源码分析（四）之 Pod 的创建 - 胡伟煌 | Blog</a></li>
<li><a target="_blank" rel="noopener" href="http://ljchen.net/2018/10/28/kubelet%E6%BA%90%E7%A0%81%E6%9E%B6%E6%9E%84%E7%AE%80%E4%BB%8B/">Kubelet 源码架构简介 | ljchen’s Notes</a></li>
<li><a target="_blank" rel="noopener" href="http://newgoo.org/2019/09/03/k8s/kubelet-%E6%BA%90%E7%A0%81/">kubelet 源码分析 - Beantech | Newgoo | kubernates</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.xbblfz.site/2018/10/12/Kubelet%E5%90%AF%E5%8A%A8%E5%8F%8A%E5%AF%B9Docker%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">“Kubelet 启动源码分析” - 徐波的博客 | Xu Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://cizixs.com/2017/06/06/kubelet-source-code-analysis-part-1/">kubelet 源码分析：启动流程 | Cizixs Write Here</a></li>
<li><a target="_blank" rel="noopener" href="https://fankangbest.github.io/2017/12/17/kubelet%E5%88%86%E6%9E%90(%E4%B8%89)-volumeManager-v1-5-2/">kubelet 分析(三)-volumeManager-v1.5.2 | fankangbest</a></li>
<li><a target="_blank" rel="noopener" href="https://wenfeng-gao.github.io/post/k8s-volume-manager-source-code-analysis/">Kubernetes 源码分析之 VolumeManager - Je pense donc je suis</a></li>
<li><a target="_blank" rel="noopener" href="https://www.huweihuang.com/kubernetes-notes/code-analysis/kubelet/startKubelet.html">startKubelet · Kubernetes 学习笔记</a></li>
</ul>
<h3 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h3><ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/">Manage data in Docker | Docker Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/bind-mounts/">Use bind mounts | Docker Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/bind-mounts/">Use bind mounts | Docker Documentation</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jinbuguo.com/man/mount.html">mount 中文手册</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/overlayfs-driver/">Use the OverlayFS storage driver</a></li>
</ul>
<h3 id="相关博客"><a href="#相关博客" class="headerlink" title="相关博客"></a>相关博客</h3><ul>
<li><a target="_blank" rel="noopener" href="https://cizixs.com/2016/10/25/kubernetes-intro-kubelet/">kubernetes 简介： kubelet 和 pod | Cizixs Write Here</a></li>
<li><a target="_blank" rel="noopener" href="https://michaelyou.github.io/2017/09/17/Docker%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86-Volume%EF%BC%8C-bind-mount%E5%92%8Ctmpfs-mount/">Docker 数据管理-Volume， bind mount 和 tmpfs mount | Youmai の Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://www.qikqiak.com/k8strain/storage/csi/">存储原理 - K8S 训练营</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.fatedier.com/2020/04/17/pod-loopcrash-of-k8s-subpath/">Kubernetes 挂载 subpath 的容器在 configmap 变更后重启时挂载失败</a></li>
<li><a target="_blank" rel="noopener" href="https://www.infvie.com/ops-notes/kubernetes-storage.html">理解 kubernetes 中的 Storage | Infvie’s Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://arkingc.github.io/2018/12/11/2018-12-11-docker-storage-persist/">Docker 容器数据持久化</a></li>
<li><a target="_blank" rel="noopener" href="https://arkingc.github.io/2018/01/19/2018-01-19-docker-imagestore/">Docker 源码分析—镜像存储</a></li>
<li><a target="_blank" rel="noopener" href="https://arkingc.github.io/2018/01/15/2018-01-15-docker-storage-overlay2/">Docker 源码分析—存储驱动</a></li>
<li><a target="_blank" rel="noopener" href="https://arkingc.github.io/2017/05/05/2017-05-05-docker-filesystem-overlay/">Docker 存储驱动—Overlay&#x2F;Overlay2「译」</a></li>
<li><a href="https://blog.k8s.li/systemd.html">Linux 的小伙伴 systemd 详解</a></li>
</ul>
<h2 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h2><p>最后祝各位还在 <code>搬砖</code> 的工人们节日快乐！</p>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
              <a href="/tags/docker/" rel="tag"># docker</a>
              <a href="/tags/%E5%AE%B9%E5%99%A8/" rel="tag"># 容器</a>
              <a href="/tags/%E5%AD%98%E5%82%A8/" rel="tag"># 存储</a>
              <a href="/tags/volumes/" rel="tag"># volumes</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/interview-wordpress-install.html" rel="prev" title="一次有趣的面试：WordPress 部署">
                  <i class="fa fa-chevron-left"></i> 一次有趣的面试：WordPress 部署
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/from-chongqing-to-hangzhou.html" rel="next" title="无砖可搬的日子：换厂记">
                  无砖可搬的日子：换厂记 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.8m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">26:36</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
