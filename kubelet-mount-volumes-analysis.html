<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.3.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="æœ€è¿‘åœ¨ kubernetes ä¸­ä½¿ç”¨ NFS å­˜å‚¨çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªå°é—®é¢˜ï¼Œä¹Ÿæ‰¾åˆ°äº†è§£å†³åŠæ³•ï¼Œä¸è¿‡è¿˜æ˜¯æƒ³æ·±å…¥åœ°äº†è§£ä¸€ä¸‹ kubelet æŒ‚è½½å­˜å‚¨çš„åŸç†å’Œè¿‡ç¨‹ï¼Œäºæ˜¯å°±æ°´äº†è¿™ç¯‡åšå®¢ ğŸ˜‚ã€‚è™½ç„¶å¹³æ—¶ä¹ŸçŸ¥é“ PV ã€PVC ã€å­˜å‚¨ç±»ç­‰æ€ä¹ˆä½¿ç”¨ï¼Œä½†èƒŒåçš„è¿‡ç¨‹å’ŒåŸç†å´æ²¡æœ‰æ·±ç©¶è¿‡ï¼Œæœ‰ç‚¹ä¸€çŸ¥åŠè§£çš„æ„Ÿè§‰ã€‚å”‰ï¼Œå¤ªèœäº† ğŸ˜‘ ï¼ˆæµä¸‹äº†æ²¡æœ‰æŠ€æœ¯çš„çœ¼æ³ª.jpg ç–‘æƒ‘ å½“ä½¿ç”¨ NFS å­˜å‚¨çš„ Pod è°ƒåº¦åˆ°æ²¡æœ‰å®‰è£… NFS c">
<meta property="og:type" content="blog">
<meta property="og:title" content="kubelet æŒ‚è½½ volume åŸç†åˆ†æ">
<meta property="og:url" content="https://blog.k8s.li/kubelet-mount-volumes-analysis.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="æœ€è¿‘åœ¨ kubernetes ä¸­ä½¿ç”¨ NFS å­˜å‚¨çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªå°é—®é¢˜ï¼Œä¹Ÿæ‰¾åˆ°äº†è§£å†³åŠæ³•ï¼Œä¸è¿‡è¿˜æ˜¯æƒ³æ·±å…¥åœ°äº†è§£ä¸€ä¸‹ kubelet æŒ‚è½½å­˜å‚¨çš„åŸç†å’Œè¿‡ç¨‹ï¼Œäºæ˜¯å°±æ°´äº†è¿™ç¯‡åšå®¢ ğŸ˜‚ã€‚è™½ç„¶å¹³æ—¶ä¹ŸçŸ¥é“ PV ã€PVC ã€å­˜å‚¨ç±»ç­‰æ€ä¹ˆä½¿ç”¨ï¼Œä½†èƒŒåçš„è¿‡ç¨‹å’ŒåŸç†å´æ²¡æœ‰æ·±ç©¶è¿‡ï¼Œæœ‰ç‚¹ä¸€çŸ¥åŠè§£çš„æ„Ÿè§‰ã€‚å”‰ï¼Œå¤ªèœäº† ğŸ˜‘ ï¼ˆæµä¸‹äº†æ²¡æœ‰æŠ€æœ¯çš„çœ¼æ³ª.jpg ç–‘æƒ‘ å½“ä½¿ç”¨ NFS å­˜å‚¨çš„ Pod è°ƒåº¦åˆ°æ²¡æœ‰å®‰è£… NFS c">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/types-of-mounts.png">
<meta property="article:published_time" content="2020-04-30T16:00:00.000Z">
<meta property="article:modified_time" content="2020-04-30T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="å®¹å™¨">
<meta property="article:tag" content="å­˜å‚¨">
<meta property="article:tag" content="volumes">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/types-of-mounts.png">


<link rel="canonical" href="https://blog.k8s.li/kubelet-mount-volumes-analysis.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/kubelet-mount-volumes-analysis.html","path":"kubelet-mount-volumes-analysis.html","title":"kubelet æŒ‚è½½ volume åŸç†åˆ†æ"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>kubelet æŒ‚è½½ volume åŸç†åˆ†æ | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%96%91%E6%83%91"><span class="nav-number">1.</span> <span class="nav-text">ç–‘æƒ‘</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%A4%8D%E7%8E%B0"><span class="nav-number">2.</span> <span class="nav-text">é—®é¢˜å¤ç°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98"><span class="nav-number">3.</span> <span class="nav-text">è§£å†³é—®é¢˜</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-number">4.</span> <span class="nav-text">åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E5%AD%98%E5%82%A8"><span class="nav-number">4.1.</span> <span class="nav-text">å®¹å™¨å­˜å‚¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubelet-%E6%8C%82%E8%BD%BD%E5%AD%98%E5%82%A8"><span class="nav-number">4.2.</span> <span class="nav-text">kubelet æŒ‚è½½å­˜å‚¨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%A1-systemd-%E4%BB%80%E4%B9%88%E4%BA%8B%E5%84%BF%EF%BC%9F"><span class="nav-number">4.3.</span> <span class="nav-text">ç®¡ systemd ä»€ä¹ˆäº‹å„¿ï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">5.</span> <span class="nav-text">å‚è€ƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81"><span class="nav-number">5.1.</span> <span class="nav-text">æºç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">5.2.</span> <span class="nav-text">æºç åˆ†æ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="nav-number">5.3.</span> <span class="nav-text">å®˜æ–¹æ–‡æ¡£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E5%8D%9A%E5%AE%A2"><span class="nav-number">5.4.</span> <span class="nav-text">ç›¸å…³åšå®¢</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E6%9D%9F"><span class="nav-number">6.</span> <span class="nav-text">ç»“æŸ</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">119</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">153</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail â†’ mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/kubelet-mount-volumes-analysis.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="kubelet æŒ‚è½½ volume åŸç†åˆ†æ | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          kubelet æŒ‚è½½ volume åŸç†åˆ†æ
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-05-01 2020-05-01T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2020-05-01T00:00:00+08:00">2020-05-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/kubelet-mount-volumes-analysis.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="kubelet-mount-volumes-analysis.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>24k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>22 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>æœ€è¿‘åœ¨ kubernetes ä¸­ä½¿ç”¨ NFS å­˜å‚¨çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªå°é—®é¢˜ï¼Œä¹Ÿæ‰¾åˆ°äº†è§£å†³åŠæ³•ï¼Œä¸è¿‡è¿˜æ˜¯æƒ³æ·±å…¥åœ°äº†è§£ä¸€ä¸‹ kubelet æŒ‚è½½å­˜å‚¨çš„åŸç†å’Œè¿‡ç¨‹ï¼Œäºæ˜¯å°±æ°´äº†è¿™ç¯‡åšå®¢ ğŸ˜‚ã€‚è™½ç„¶å¹³æ—¶ä¹ŸçŸ¥é“ PV ã€PVC ã€å­˜å‚¨ç±»ç­‰æ€ä¹ˆä½¿ç”¨ï¼Œä½†èƒŒåçš„è¿‡ç¨‹å’ŒåŸç†å´æ²¡æœ‰æ·±ç©¶è¿‡ï¼Œæœ‰ç‚¹ä¸€çŸ¥åŠè§£çš„æ„Ÿè§‰ã€‚å”‰ï¼Œå¤ªèœäº† ğŸ˜‘ ï¼ˆ<code>æµä¸‹äº†æ²¡æœ‰æŠ€æœ¯çš„çœ¼æ³ª.jpg</code></p>
<h2 id="ç–‘æƒ‘"><a href="#ç–‘æƒ‘" class="headerlink" title="ç–‘æƒ‘"></a>ç–‘æƒ‘</h2><blockquote>
<p>å½“ä½¿ç”¨ NFS å­˜å‚¨çš„ Pod è°ƒåº¦åˆ°æ²¡æœ‰å®‰è£… NFS client (nfs-utils ã€nfs-common) Node èŠ‚ç‚¹ä¸Šçš„æ—¶å€™ï¼Œä¼šæç¤º NFS volume æŒ‚è½½å¤±è´¥ï¼ŒNode å®¿ä¸»æœºå®‰è£…ä¸Š NFS client åå°±å¯ä»¥æ­£å¸¸æŒ‚è½½äº†ï¼Œæˆ‘æƒ³æ˜¯ä¸æ˜¯ kubelet åœ¨å¯åŠ¨å®¹å™¨ä¹‹å‰æ˜¯ä¸æ˜¯è°ƒç”¨ system-run å»æŒ‚è½½ NFS ï¼Œå¦‚æœ Node å®¿ä¸»æœºæ²¡æœ‰å®‰è£… NFS client å°±æ— æ³•æŒ‚è½½ã€‚</p>
<p>ç¿»äº†ä¸€ä¸‹æºç  <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/vendor/k8s.io/utils/mount/mount_linux.go#L115">mount_linux.go</a> å’Œ <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/49640">49640</a> è¿™ä¸ª PRã€‚é‡Œé¢æåˆ°çš„æ˜¯ kubelet æŒ‚è½½å­˜å‚¨å·çš„æ—¶å€™ä½¿ç”¨ system-run æŒ‚è½½ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå³ä¾¿ kubelet æŒ‚æ‰æˆ–è€…é‡å¯çš„æ—¶å€™ä¹Ÿä¸ä¼šå½±å“åˆ°å®¹å™¨ä½¿ç”¨ kubelet æŒ‚è½½çš„å­˜å‚¨å·ã€‚</p>
</blockquote>
<p>è¯·æ•™äº†ä¸€ä¸‹ä¸¤ä¸ªå¤§ä½¬ <a target="_blank" rel="noopener" href="https://zdyxry.github.io/">Yiran</a> å’Œ <a target="_blank" rel="noopener" href="http://gaocegege.com/Blog/about/">é«˜ç­–</a>ï¼Œä»–ä»¬ä¹Ÿä¸å¤ªç†Ÿæ‚‰ ğŸ˜‚ï¼Œä¸è¿‡ä¹Ÿæ‰¾åˆ°äº†è§£å†³æ€è·¯ã€‚åœ¨ä½¿ç”¨ GlusterFS çš„æ—¶å€™ï¼ŒNode èŠ‚ç‚¹ä¹Ÿéœ€è¦å®‰è£… GlusterFS çš„å®¢æˆ·ç«¯ï¼Œä¸ç„¶ kubelet ä¹Ÿæ˜¯æ— æ³•æŒ‚è½½ Pod çš„ volumeã€‚ç”±æ­¤å¯ä»¥ç¡®è®¤çš„æ˜¯ï¼š kubelet åœ¨ä¸º Pod æŒ‚è½½ volume çš„æ—¶å€™ï¼Œæ ¹æ® volume çš„ç±»å‹ï¼ˆNFSã€GlusterFSã€Ceph ç­‰ï¼‰ï¼ŒPod æ‰€åœ¨çš„ Node èŠ‚ç‚¹å®¿ä¸»æœºä¹Ÿéœ€è¦å®‰è£…å¥½å¯¹åº”çš„å®¢æˆ·ç«¯ç¨‹åºã€‚</p>
<h2 id="é—®é¢˜å¤ç°"><a href="#é—®é¢˜å¤ç°" class="headerlink" title="é—®é¢˜å¤ç°"></a>é—®é¢˜å¤ç°</h2><p>é›†ç¾¤ä¿¡æ¯ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-01 opt<span class="token punctuation">]</span><span class="token comment"># kubectl get node</span>
NAME            STATUS   ROLES    AGE    VERSION
k8s-master-01   Ready    master   8d     v1.17.4
k8s-master-02   Ready    master   8d     v1.17.4
k8s-master-03   Ready    master   8d     v1.17.4
k8s-node-02     Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span> 8d     v1.17.4
k8s-node-3      Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span> 3d3h   v1.17.4
node1           Ready    <span class="token operator">&lt;</span>none<span class="token operator">></span> 108s   v1.17.4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸ºäº†æ–¹ä¾¿å¤ç°é—®é¢˜è¿˜æ˜¯åœ¨ Rancher ä¸Šåˆ›å»ºäº† PV å’Œ PVCï¼Œä»¥åŠåŒ…å«ä¸¤ä¸ª Pod çš„ä¸€ä¸ª <code>Deploment</code>ï¼Œåœ¨åˆ›å»º Deploment çš„æ—¶å€™ï¼ŒæŒ‡å®šå°† Pod è°ƒåº¦åˆ°æ–°åŠ å…¥çš„èŠ‚ç‚¹ä¸Šï¼Œå³è¿™ä¸ªèŠ‚ç‚¹ä¸Šå¹¶æ²¡æœ‰å®‰è£… NFS å®¢æˆ·ç«¯ã€‚</p>
<p><strong>PV ä¿¡æ¯å¦‚ä¸‹ï¼š</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-01 opt<span class="token punctuation">]</span><span class="token comment"># kubectl describe pv nfs211</span>
Name:            nfs211
Labels:          cattle.io/creator<span class="token operator">=</span>norman
Annotations:     field.cattle.io/creatorId: user-gwgpp
                 pv.kubernetes.io/bound-by-controller: <span class="token function">yes</span>
Finalizers:      <span class="token punctuation">[</span>kubernetes.io/pv-protection<span class="token punctuation">]</span>
StorageClass:    nfs216
Status:          Bound
Claim:           ops-test/nfs-211
Reclaim Policy:  Retain
Access Modes:    RWX
VolumeMode:      Filesystem
Capacity:        10Gi
Node Affinity:   <span class="token operator">&lt;</span>none<span class="token operator">></span>
Message:
Source:
    Type:      NFS <span class="token punctuation">(</span>an NFS <span class="token function">mount</span> that lasts the lifetime of a pod<span class="token punctuation">)</span>
    Server:    <span class="token number">10.20</span>.172.211
    Path:      /nfs
    ReadOnly:  <span class="token boolean">false</span>
Events:        <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>PVC ä¿¡æ¯å¦‚ä¸‹</strong></p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"accessModes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"ReadWriteMany"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"annotations"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"pv.kubernetes.io/bind-completed"</span><span class="token operator">:</span> <span class="token string">"yes"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"baseType"</span><span class="token operator">:</span> <span class="token string">"persistentVolumeClaim"</span><span class="token punctuation">,</span>
    <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"2020-04-30T08:59:15Z"</span><span class="token punctuation">,</span>
    <span class="token property">"createdTS"</span><span class="token operator">:</span> <span class="token number">1588237155000</span><span class="token punctuation">,</span>
    <span class="token property">"creatorId"</span><span class="token operator">:</span> <span class="token string">"user-gwgpp"</span><span class="token punctuation">,</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"ops-test:nfs-211"</span><span class="token punctuation">,</span>
    <span class="token property">"labels"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"cattle.io/creator"</span><span class="token operator">:</span> <span class="token string">"norman"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"links"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"remove"</span><span class="token operator">:</span> <span class="token string">"â€¦/v3/project/c-rl5jz:p-knsxt/persistentVolumeClaims/ops-test:nfs-211"</span><span class="token punctuation">,</span>
        <span class="token property">"self"</span><span class="token operator">:</span> <span class="token string">"â€¦/v3/project/c-rl5jz:p-knsxt/persistentVolumeClaims/ops-test:nfs-211"</span><span class="token punctuation">,</span>
        <span class="token property">"update"</span><span class="token operator">:</span> <span class="token string">"â€¦/v3/project/c-rl5jz:p-knsxt/persistentVolumeClaims/ops-test:nfs-211"</span><span class="token punctuation">,</span>
        <span class="token property">"yaml"</span><span class="token operator">:</span> <span class="token string">"â€¦/v3/project/c-rl5jz:p-knsxt/persistentVolumeClaims/ops-test:nfs-211/yaml"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"nfs-211"</span><span class="token punctuation">,</span>
    <span class="token property">"namespaceId"</span><span class="token operator">:</span> <span class="token string">"ops-test"</span><span class="token punctuation">,</span>
    <span class="token property">"projectId"</span><span class="token operator">:</span> <span class="token string">"c-rl5jz:p-knsxt"</span><span class="token punctuation">,</span>
    <span class="token property">"resources"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"requests"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"storage"</span><span class="token operator">:</span> <span class="token string">"10Gi"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"/v3/project/schemas/resourceRequirements"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"bound"</span><span class="token punctuation">,</span>
    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"accessModes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"ReadWriteMany"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"capacity"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"storage"</span><span class="token operator">:</span> <span class="token string">"10Gi"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"phase"</span><span class="token operator">:</span> <span class="token string">"Bound"</span><span class="token punctuation">,</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"/v3/project/schemas/persistentVolumeClaimStatus"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"storageClassId"</span><span class="token operator">:</span> <span class="token string">"nfs216"</span><span class="token punctuation">,</span>
    <span class="token property">"transitioning"</span><span class="token operator">:</span> <span class="token string">"no"</span><span class="token punctuation">,</span>
    <span class="token property">"transitioningMessage"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"persistentVolumeClaim"</span><span class="token punctuation">,</span>
    <span class="token property">"uuid"</span><span class="token operator">:</span> <span class="token string">"660dc8d1-7911-4d30-b575-b54990de8667"</span><span class="token punctuation">,</span>
    <span class="token property">"volumeId"</span><span class="token operator">:</span> <span class="token string">"nfs211"</span><span class="token punctuation">,</span>
    <span class="token property">"volumeMode"</span><span class="token operator">:</span> <span class="token string">"Filesystem"</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Deploment ä¿¡æ¯å¦‚ä¸‹ï¼š</strong></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">deployment.kubernetes.io/revision</span><span class="token punctuation">:</span> <span class="token string">"1"</span>
    <span class="token key atrule">field.cattle.io/creatorId</span><span class="token punctuation">:</span> user<span class="token punctuation">-</span>gwgpp
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2020-04-30T09:00:19Z"</span>
  <span class="token key atrule">generation</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">cattle.io/creator</span><span class="token punctuation">:</span> norman
    <span class="token key atrule">workload.user.cattle.io/workloadselector</span><span class="token punctuation">:</span> deployment<span class="token punctuation">-</span>ops<span class="token punctuation">-</span>test<span class="token punctuation">-</span>node1<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>test
  <span class="token key atrule">name</span><span class="token punctuation">:</span> node1<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>test
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ops<span class="token punctuation">-</span>test
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"1940561"</span>
  <span class="token key atrule">selfLink</span><span class="token punctuation">:</span> /apis/apps/v1/namespaces/ops<span class="token punctuation">-</span>test/deployments/node1<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>test
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 5d14a158<span class="token punctuation">-</span>1eef<span class="token punctuation">-</span>4a94<span class="token punctuation">-</span>8433<span class="token punctuation">-</span>15ad002ee55c
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">workload.user.cattle.io/workloadselector</span><span class="token punctuation">:</span> deployment<span class="token punctuation">-</span>ops<span class="token punctuation">-</span>test<span class="token punctuation">-</span>node1<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>test
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">cattle.io/timestamp</span><span class="token punctuation">:</span> <span class="token string">"2020-04-30T09:01:05Z"</span>
        <span class="token key atrule">workload.cattle.io/state</span><span class="token punctuation">:</span> <span class="token string">'&#123;"bm9kZTE=":"c-rl5jz:machine-wbs6r"&#125;'</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">workload.user.cattle.io/workloadselector</span><span class="token punctuation">:</span> deployment<span class="token punctuation">-</span>ops<span class="token punctuation">-</span>test<span class="token punctuation">-</span>node1<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>test
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> alpine
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
        <span class="token key atrule">name</span><span class="token punctuation">:</span> node1<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>test
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
          <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">capabilities</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
          <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
          <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">stdin</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log
        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File
        <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp
          <span class="token key atrule">name</span><span class="token punctuation">:</span> vol1
      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
      <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> node1
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler
      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> vol1
        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span><span class="token number">211</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åˆ›å»ºå®Œ Deploment ä¹‹åï¼Œä½¿ç”¨ kubectl get pod å‘½ä»¤æŸ¥çœ‹ Pod åˆ›å»ºçš„è¿›åº¦ï¼Œå‘ç°ä¸€ç›´å¡åœ¨ <code>ContainerCreating</code> çŠ¶æ€</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-01 opt<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n ops-test</span>
NAME                              READY   STATUS              RESTARTS   AGE
node1-nfs-test-547c4d7678-j6kwv   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          2m12s
node1-nfs-test-547c4d7678-vwdqg   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          2m12s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>kubectl describe pod çš„æ—¥å¿—å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-01 opt<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod node1-nfs-test-547c4d7678-j6kwv -n ops-test</span>
Name:           node1-nfs-test-547c4d7678-j6kwv
Namespace:      ops-test
Priority:       <span class="token number">0</span>
Node:           node1/10.10.107.214
Start Time:     Thu, <span class="token number">30</span> Apr <span class="token number">2020</span> <span class="token number">17</span>:00:33 +0800
Labels:         pod-template-hash<span class="token operator">=</span>547c4d7678
                workload.user.cattle.io/workloadselector<span class="token operator">=</span>deployment-ops-test-node1-nfs-test
Annotations:    cattle.io/timestamp: <span class="token number">2020</span>-04-30T09:01:05Z
                workload.cattle.io/state: <span class="token punctuation">&#123;</span><span class="token string">"bm9kZTE="</span><span class="token builtin class-name">:</span><span class="token string">"c-rl5jz:machine-wbs6r"</span><span class="token punctuation">&#125;</span>
Status:         Pending
IP:
IPs:            <span class="token operator">&lt;</span>none<span class="token operator">></span>
Controlled By:  ReplicaSet/node1-nfs-test-547c4d7678
Containers:
  node1-nfs-test:
    Container ID:
    Image:          alpine
    Image ID:
    Port:           <span class="token operator">&lt;</span>none<span class="token operator">></span>
    Host Port:      <span class="token operator">&lt;</span>none<span class="token operator">></span>
    State:          Waiting
      Reason:       ContainerCreating
    Ready:          False
    Restart Count:  <span class="token number">0</span>
    Environment:    <span class="token operator">&lt;</span>none<span class="token operator">></span>
    Mounts:
      /tmp from vol1 <span class="token punctuation">(</span>rw<span class="token punctuation">)</span>
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-f6wjj <span class="token punctuation">(</span>ro<span class="token punctuation">)</span>
Conditions:
  Type              Status
  Initialized       True
  Ready             False
  ContainersReady   False
  PodScheduled      True
Volumes:
  vol1:
    Type:       PersistentVolumeClaim <span class="token punctuation">(</span>a reference to a PersistentVolumeClaim <span class="token keyword">in</span> the same namespace<span class="token punctuation">)</span>
    ClaimName:  nfs-211
    ReadOnly:   <span class="token boolean">false</span>
  default-token-f6wjj:
    Type:        Secret <span class="token punctuation">(</span>a volume populated by a Secret<span class="token punctuation">)</span>
    SecretName:  default-token-f6wjj
    Optional:    <span class="token boolean">false</span>
QoS Class:       BestEffort
Node-Selectors:  <span class="token operator">&lt;</span>none<span class="token operator">></span>
Tolerations:     node.kubernetes.io/not-ready:NoExecute <span class="token keyword">for</span> 300s
                 node.kubernetes.io/unreachable:NoExecute <span class="token keyword">for</span> 300s
Events:
  Type     Reason       Age    From            Message
  ----  ------  ---- ----     -------
  Warning  FailedMount  8m49s  kubelet, node1  MountVolume.SetUp failed <span class="token keyword">for</span> volume <span class="token string">"nfs211"</span> <span class="token builtin class-name">:</span> <span class="token function">mount</span> failed: <span class="token builtin class-name">exit</span> status <span class="token number">32</span>
Mounting command: systemd-run
Mounting arguments: <span class="token parameter variable">--description</span><span class="token operator">=</span>Kubernetes transient <span class="token function">mount</span> <span class="token keyword">for</span> /var/lib/kubelet/pods/cddc94e7-8033-4150-bed5-d141e3b71e49/volumes/kubernetes.io~nfs/nfs211 <span class="token parameter variable">--scope</span> -- <span class="token function">mount</span> <span class="token parameter variable">-t</span> nfs <span class="token number">10.20</span>.172.211:/nfs /var/lib/kubelet/pods/cddc94e7-8033-4150-bed5-d141e3b71e49/volumes/kubernetes.io~nfs/nfs211
Output: Running scope as unit run-38284.scope.
mount: wrong fs type, bad option, bad superblock on <span class="token number">10.20</span>.172.211:/nfs,
       missing codepage or helper program, or other error
       <span class="token punctuation">(</span>for several filesystems <span class="token punctuation">(</span>e.g. nfs, cifs<span class="token punctuation">)</span> you might
       need a /sbin/mount.<span class="token operator">&lt;</span>type<span class="token operator">></span> helper program<span class="token punctuation">)</span>

       In some cases useful info is found <span class="token keyword">in</span> syslog - try
       <span class="token function">dmesg</span> <span class="token operator">|</span> <span class="token function">tail</span> or so.
  Warning  FailedMount  8m48s  kubelet, node1  MountVolume.SetUp failed <span class="token keyword">for</span> volume <span class="token string">"nfs211"</span> <span class="token builtin class-name">:</span> <span class="token function">mount</span> failed: <span class="token builtin class-name">exit</span> status <span class="token number">32</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ ä¸€å°æ²¡æœ‰å®‰è£… NFS å®¢æˆ·ç«¯çš„èŠ‚ç‚¹å°è¯•æŒ‚è½½ä¸€ä¸‹ NFS å­˜å‚¨ï¼Œå‘ç°æŠ¥é”™çš„æ—¥å¿—å’Œ kubelet çš„æ—¥å¿—ç›¸åŒ ğŸ¤”</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-03 ~<span class="token punctuation">]</span><span class="token comment"># mount -t nfs 10.20.172.211:/nfs /tmp</span>
mount: wrong fs type, bad option, bad superblock on <span class="token number">10.20</span>.172.211:/nfs,
       missing codepage or helper program, or other error
       <span class="token punctuation">(</span>for several filesystems <span class="token punctuation">(</span>e.g. nfs, cifs<span class="token punctuation">)</span> you might
       need a /sbin/mount.<span class="token operator">&lt;</span>type<span class="token operator">></span> helper program<span class="token punctuation">)</span>

       In some cases useful info is found <span class="token keyword">in</span> syslog - try
       <span class="token function">dmesg</span> <span class="token operator">|</span> <span class="token function">tail</span> or so.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="è§£å†³é—®é¢˜"><a href="#è§£å†³é—®é¢˜" class="headerlink" title="è§£å†³é—®é¢˜"></a>è§£å†³é—®é¢˜</h2><p>çœ‹åˆ° kubelet æŠ¥é”™çš„æ—¥å¿—å’Œæˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸Šä½¿ç”¨ mount åæŒ‚è½½ NFS å­˜å‚¨æ—¶çš„é”™è¯¯ä¸€æ ·å°±å¯ä»¥æ–­å®šä¸ºæ˜¯å®¿ä¸»æœºçš„é—®é¢˜ã€‚æœäº†ä¸€ä¸‹æŠ¥é”™æ—¥å¿—ï¼Œåœ¨ <a target="_blank" rel="noopener" href="https://askubuntu.com/questions/525243/why-do-i-get-wrong-fs-type-bad-option-bad-superblock-error">Why do I get â€œwrong fs type, bad option, bad superblockâ€ error?</a> å¾—åˆ°æç¤ºè¯´éœ€è¦å®‰è£…ä¸€ä¸‹ NFS å®¢æˆ·ç«¯ (nfs-commonã€nfs-utils) ğŸ˜‚ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@node1 ~
â•°â”€<span class="token comment"># yum install nfs-utils</span>
â€¦â€¦â€¦â€¦â€¦â€¦
Install  <span class="token number">1</span> Package <span class="token punctuation">(</span>+15 Dependent packages<span class="token punctuation">)</span>

Total download size: <span class="token number">1.5</span> M
Installed size: <span class="token number">4.3</span> M
Is this ok <span class="token punctuation">[</span>y/d/N<span class="token punctuation">]</span>:<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>yum ä¸€æŠŠæ¢­åå‘ç° <code>nfs-utils</code> è¿˜çœŸæ²¡æœ‰å®‰è£… ğŸ˜‚ã€‚</p>
<p>å®‰è£…å®Œæ—¶å€™ä½¿ç”¨ kubectl åˆ é™¤æ‰ä¹‹å‰çš„ Podï¼ŒDeploment æ§åˆ¶å™¨ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å°† Pod æ•°é‡è°ƒå’Œåˆ°æŒ‡å®šçš„æ•°é‡ã€‚å¯ä»¥å‘ç° Pod æ‰€åœ¨å®¿ä¸»æœºå®‰è£… NFS å®¢æˆ·ç«¯ä¹‹å kubelet å°±èƒ½æ­£å¸¸ä¸º Pod æŒ‚è½½ volume äº† è€Œä¸” Pod ä¹Ÿæ­£å¸¸è¿è¡Œäº†ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod node1-nfs-test-547c4d7678-j6kwv node1-nfs-test-547c4d7678-vwdqg -n ops-test</span>
pod <span class="token string">"node1-nfs-test-547c4d7678-j6kwv"</span> deleted
pod <span class="token string">"node1-nfs-test-547c4d7678-vwdqg"</span> deleted
<span class="token punctuation">[</span>root@k8s-master-01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pod -n ops-test</span>
NAME                              READY   STATUS    RESTARTS   AGE
node1-nfs-test-7589fb4787-cknz4   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          18s
node1-nfs-test-7589fb4787-l9bt2   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          22s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿›å…¥å®¹å™¨å†…æŸ¥çœ‹ä¸€ä¸‹å®¹å™¨å†…æŒ‚è½½ç‚¹çš„ä¿¡æ¯ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@k8s-master-01 ~<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it node1-nfs-test-7589fb4787-cknz4 -n ops-test sh</span>
/ <span class="token comment"># df -h</span>
Filesystem                Size      Used Available Use% Mounted on
overlay                  <span class="token number">28</span>.9G      <span class="token number">4</span>.1G     <span class="token number">23</span>.3G  <span class="token number">15</span>% /
<span class="token number">10.20</span>.172.211:/nfs       <span class="token number">28</span>.9G     <span class="token number">14</span>.5G     <span class="token number">12</span>.9G  <span class="token number">53</span>% /tmp
tmpfs                     <span class="token number">1</span>.8G         <span class="token number">0</span>      <span class="token number">1</span>.8G   <span class="token number">0</span>% /sys/firmware
/ <span class="token comment"># mount</span>
rootfs on / <span class="token builtin class-name">type</span> rootfs <span class="token punctuation">(</span>rw<span class="token punctuation">)</span>
<span class="token number">10.20</span>.172.211:/nfs on /tmp <span class="token builtin class-name">type</span> nfs <span class="token punctuation">(</span>rw,relatime,vers<span class="token operator">=</span><span class="token number">3</span>,rsize<span class="token operator">=</span><span class="token number">524288</span>,wsize<span class="token operator">=</span><span class="token number">524288</span>,namlen<span class="token operator">=</span><span class="token number">255</span>,hard,proto<span class="token operator">=</span>tcp,timeo<span class="token operator">=</span><span class="token number">600</span>,retrans<span class="token operator">=</span><span class="token number">2</span>,sec<span class="token operator">=</span>sys,mountaddr<span class="token operator">=</span><span class="token number">10.20</span>.172.211,mountvers<span class="token operator">=</span><span class="token number">3</span>,mountport<span class="token operator">=</span><span class="token number">20048</span>,mountproto<span class="token operator">=</span>udp,local_lock<span class="token operator">=</span>none,addr<span class="token operator">=</span><span class="token number">10.20</span>.172.211<span class="token punctuation">)</span>

<span class="token number">10.20</span>.172.211:/nfs on /mnt/nfs <span class="token builtin class-name">type</span> nfs <span class="token punctuation">(</span>rw,relatime,vers<span class="token operator">=</span><span class="token number">3</span>,rsize<span class="token operator">=</span><span class="token number">524288</span>,wsize<span class="token operator">=</span><span class="token number">524288</span>,namlen<span class="token operator">=</span><span class="token number">255</span>,hard,proto<span class="token operator">=</span>tcp,timeo<span class="token operator">=</span><span class="token number">600</span>,retrans<span class="token operator">=</span><span class="token number">2</span>,sec<span class="token operator">=</span>sys,mountaddr<span class="token operator">=</span><span class="token number">10.20</span>.172.211,mountvers<span class="token operator">=</span><span class="token number">3</span>,mountport<span class="token operator">=</span><span class="token number">20048</span>,mountproto<span class="token operator">=</span>udp,local_lock<span class="token operator">=</span>none,addr<span class="token operator">=</span><span class="token number">10.20</span>.172.211<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è‡³æ­¤é—®é¢˜å·²ç»è§£å†³äº†ï¼Œæ¥ä¸‹æ¥å°±åˆ°äº†æ­£æ–‡ï¼šå¼€å§‹åˆ†æä¸€ä¸‹  kubelet ä¸º Pod æŒ‚è½½ volume çš„æµç¨‹å’ŒåŸç† ğŸ˜‚</p>
<h2 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h2><h3 id="å®¹å™¨å­˜å‚¨"><a href="#å®¹å™¨å­˜å‚¨" class="headerlink" title="å®¹å™¨å­˜å‚¨"></a>å®¹å™¨å­˜å‚¨</h3><p>åœ¨åˆ†æ Pod çš„ volume ä¹‹å‰éœ€è¦å…ˆäº†è§£ä¸€ä¸‹ docker å®¹å™¨çš„å­˜å‚¨ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ <code>docker inspect</code> &lt; å®¹å™¨ ID&gt; å‘½ä»¤æ¥æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯æ—¶ï¼Œåœ¨å®¹å™¨å…ƒæ•°æ®ä¿¡æ¯çš„ <code>GraphDriver</code> å­—æ®µä¸‹åŒ…å«ç€ä¸€ä¸ª <code>Mounts</code> ï¼Œè€Œ <code>Mounts</code> å­—æ®µé‡Œçš„æ­£æ˜¯å®¹å™¨æŒ‚è½½çš„å­˜å‚¨ï¼Œå…¶ä¸­é‡Œé¢çš„ <code>Type</code> å­—æ®µé‡Œæœ‰ <code>bind</code> å’Œ <code>volume</code> ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ª <code>tmpfs</code>ã€‚</p>
<p>å¦å¤–å…¶ä¸­çš„ <code>Data</code> å­—æ®µé‡Œçš„ <code>LowerDir</code> æ­£æ˜¯å®¹å™¨çš„é•œåƒå±‚ï¼Œå…³äºå®¹å™¨é•œåƒå±‚çš„è®²è§£å»ºè®®é˜…è¯»ä¸€ä¸‹ <a target="_blank" rel="noopener" href="https://arkingc.github.io/2018/01/15/2018-01-15-docker-storage-overlay2/">Docker æºç åˆ†æâ€”å­˜å‚¨é©±åŠ¨</a> ï¼Œè¿™ç¯‡æºç åˆ†æ ğŸ‘ï¼Œåœ¨è¿™é‡Œç‚¹åˆ°ä¸ºæ­¢å°±ä¸å†ç»†ç©¶äº† ğŸ˜‚</p>
<blockquote>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†è§£äº†å±‚çš„åˆ›å»ºå’Œåˆ é™¤è¿‡ç¨‹ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸€ç›´æ²¡æœ‰æåˆ°ä¸€ä¸ªé—®é¢˜ï¼š<strong>æˆ‘ä»¬åœ¨å®¹å™¨å†…çœ‹åˆ°çš„æ–‡ä»¶å­˜åœ¨å“ªï¼Ÿ</strong></p>
<p>æˆ‘ä»¬å·²ç»çŸ¥é“å±‚ç›®å½•ä¸‹æœ‰ diffï¼Œmerged å’Œ work 3 ä¸ªç›®å½•ã€‚diff å­˜å‚¨çš„æ˜¯è¯¥å±‚çš„æ–‡ä»¶ï¼Œwork æ˜¯æ‰§è¡Œä¸€äº›ç‰¹å®šæ“ä½œæ—¶æ‰€è¦ç”¨åˆ°çš„ç›®å½•ï¼Œæ‰€ä»¥å®é™…ä¸Šï¼Œ<strong>åœ¨å®¹å™¨å†…çœ‹åˆ°çš„æ–‡ä»¶ï¼Œå°±å­˜åœ¨äº merged ç›®å½•ä¸‹</strong></p>
<p><strong>merged ç›®å½•åœ¨å®¹å™¨æœªè¿è¡Œæ—¶ï¼Œæ˜¯ä¸€ä¸ªç©ºç›®å½•ï¼Œå½“å®¹å™¨å¯åŠ¨æ—¶ä¼šå°†è¯¥å®¹å™¨æ‰€æœ‰å±‚çš„ diff ç›®å½•è¿›è¡Œè”åˆæŒ‚è½½ï¼ŒæŒ‚è½½åˆ° merged ç›®å½•ä¸‹ï¼ŒæŒ‚è½½æ—¶ä½¿ç”¨çš„æ–‡ä»¶ç³»ç»Ÿå°±æ˜¯å†…æ ¸ OverlayFS æ–‡ä»¶ç³»ç»Ÿ</strong></p>
<blockquote>
<p>å¦‚æœæœ‰çœ‹è¿‡æˆ‘å…³äºå†…æ ¸ OverlayFS ç›¸å…³çš„åšæ–‡ï¼Œè¿™é‡Œåº”è¯¥å·²ç»å¯¹ Docker çš„ overlay2 å­˜å‚¨é©±åŠ¨ä¸å†…æ ¸ OverlayFS çš„å…³ç³»æœ‰äº†ä¸€ä¸ªæ¯”è¾ƒæ¸…æ™°çš„è®¤è¯†</p>
</blockquote>
<p><strong>å½“æŒ‚è½½å®Œæˆåï¼Œå®¹å™¨å¤„äºä¸€ä¸ªå­æ–‡ä»¶ç³»ç»Ÿå‘½åç©ºé—´ï¼Œåªèƒ½çœ‹åˆ° merged ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œç›¸å½“äº chroot å‘½ä»¤çš„æ•ˆæœ</strong></p>
<p>æ‰€ä»¥ï¼Œåœ¨åœæ­¢ä¸€ä¸ªå®¹å™¨æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹ merged ç›®å½•æ‰§è¡Œä¸€ä¸ªå¸è½½å‘½ä»¤</p>
</blockquote>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"GraphDriver"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"Data"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token property">"LowerDir"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/overlay2/2a846f62b759d87bf8b2731960c4031585fb4ee14bbf313f58e0374c4fee9ce0-init/diff:/var/lib/docker/overlay2/29f9a1e9523d4ec323402a3c2da8a5e288cfe0e6f3168a57dd2388b63775c20a/diff:/var/lib/docker/overlay2/015afa447ae2fcfa592d257644312b286173b9a00d0f2017a4c6ede448a87d47/diff:/var/lib/docker/overlay2/2f71b56cd5550bf299ed33a04e385ef5578511e3a17d35162148f4b84bda4b26/diff"</span><span class="token punctuation">,</span>
                <span class="token property">"MergedDir"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/overlay2/2a846f62b759d87bf8b2731960c4031585fb4ee14bbf313f58e0374c4fee9ce0/merged"</span><span class="token punctuation">,</span>
                <span class="token property">"UpperDir"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/overlay2/2a846f62b759d87bf8b2731960c4031585fb4ee14bbf313f58e0374c4fee9ce0/diff"</span><span class="token punctuation">,</span>
                <span class="token property">"WorkDir"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/overlay2/2a846f62b759d87bf8b2731960c4031585fb4ee14bbf313f58e0374c4fee9ce0/work"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"overlay2"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"Mounts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">&#123;</span>
                <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>
                <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/opt/wordpress-nginx-docker/webp-server/config.json"</span><span class="token punctuation">,</span>
                <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/etc/config.json"</span><span class="token punctuation">,</span>
                <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">"rw"</span><span class="token punctuation">,</span>
                <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span>
                <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>
                <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/opt/wordpress-nginx-docker/wordpress"</span><span class="token punctuation">,</span>
                <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/var/www/html"</span><span class="token punctuation">,</span>
                <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">"rw"</span><span class="token punctuation">,</span>
                <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            <span class="token punctuation">&#123;</span>
                <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"volume"</span><span class="token punctuation">,</span>
                <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"36d087638f2e9ba8472c441bcf906320cfd80419874291f56e039e4f7d1278e7"</span><span class="token punctuation">,</span>
                <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/volumes/36d087638f2e9ba8472c441bcf906320cfd80419874291f56e039e4f7d1278e7/_data"</span><span class="token punctuation">,</span>
                <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/opt/exhaust"</span><span class="token punctuation">,</span>
                <span class="token property">"Driver"</span><span class="token operator">:</span> <span class="token string">"local"</span><span class="token punctuation">,</span>
                <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
                <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">""</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ ¹æ® docker çš„å®˜æ–¹æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://docs.docker.com/storage/">Manage data in Docker</a> ï¼Œdocker æä¾›äº† 3 ç§æ–¹æ³•å°†æ•°æ®ä» Docker å®¿ä¸»æœºæŒ‚è½½ï¼ˆmountï¼‰åˆ°å®¹å™¨å†…ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img data-src="https://p.k8s.li/types-of-mounts.png"></p>
<p><code>å›¾ç‰‡ä» Docker å®˜æ–¹æ–‡æ¡£å·æ¥çš„ğŸ˜‚</code></p>
<blockquote>
<ul>
<li><strong>Volumes</strong> are stored in a part of the host filesystem which is <em>managed by Docker</em> (<code>/var/lib/docker/volumes/</code> on Linux). Non-Docker processes should not modify this part of the filesystem. Volumes are the best way to persist data in Docker.</li>
<li><strong>Bind mounts</strong> may be stored <em>anywhere</em> on the host system. They may even be important system files or directories. Non-Docker processes on the Docker host or a Docker container can modify them at any time.</li>
<li><strong><code>tmpfs</code> mounts</strong> are stored in the host systemâ€™s memory only, and are never written to the host systemâ€™s filesystem.</li>
</ul>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°å®¹å™¨å¯ä»¥ä½¿ç”¨çš„å­˜å‚¨æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>Volumesï¼šä½¿ç”¨ Docker æ¥ç®¡ç†çš„å­˜å‚¨ï¼Œé»˜è®¤å­˜æ”¾åœ¨ <code>/var/lib/docker/volumes/</code> ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>docker volume</code> å­å‘½ä»¤æ¥ç®¡ç†è¿™äº› volume ï¼Œå¯ä»¥åˆ›å»ºã€æŸ¥çœ‹ã€åˆ—å‡ºã€æ¸…ç©ºã€åˆ é™¤ç­‰æ“ä½œã€‚é docker è¿›ç¨‹ä¸åº”è¯¥å»ä¿®æ”¹è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œ<strong>å·æ˜¯ Docker å®¹å™¨æŒä¹…åŒ–æ•°æ®çš„æœ€å¥½æ–¹å¼</strong>ã€‚</li>
</ul>
<blockquote>
<p><code>-v</code> æˆ– <code>--volume</code>ï¼šç”± 3 ä¸ªåŸŸç»„æˆï¼Œ<code>&#39;:&#39;</code> åˆ†éš”</p>
<ul>
<li>ç¬¬ä¸€ä¸ªåŸŸï¼šå¯¹äºå‘½åå·ï¼Œä¸ºå·åï¼›åŒ¿åå·ï¼Œåˆ™å¿½ç•¥ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºåŒ¿åå·</li>
<li>ç¬¬äºŒä¸ªåŸŸï¼šå®¹å™¨ä¸­çš„æŒ‚è½½ç‚¹</li>
<li>ç¬¬ä¸‰ä¸ªåŸŸï¼šå¯é€‰å‚æ•°ï¼Œç”± <code>&#39;,&#39;</code> éš”å¼€ï¼Œå¦‚ <code>ro</code></li>
</ul>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 /home/ubuntu
â•°â”€<span class="token comment"># docker volume</span>
Usage:  <span class="token function">docker</span> volume COMMAND
Manage volumes
Commands:
  create      Create a volume
  inspect     Display detailed information on one or <span class="token function">more</span> volumes
  <span class="token function">ls</span>          List volumes
  prune       Remove all unused <span class="token builtin class-name">local</span> volumes
  <span class="token function">rm</span>          Remove one or <span class="token function">more</span> volumes
Run <span class="token string">'docker volume COMMAND --help'</span> <span class="token keyword">for</span> <span class="token function">more</span> information on a command.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å‡å¦‚åœ¨å†™ <code>Dockerfile</code> çš„æ—¶å€™ï¼Œä½¿ç”¨ <code>VOLUME</code> æŒ‡ä»¤æŒ‡å®šå®¹å™¨å†…çš„è·¯å¾„ã€‚åœ¨æˆ‘ä»¬å¯åŠ¨å®¹å™¨çš„æ—¶å€™ docker ä¼šå¸®æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæŒä¹…åŒ–å­˜å‚¨çš„ volumeã€‚ä¹Ÿå¯åœ¨ <code>docker run</code> æˆ–è€… <code>docker-compose.yaml</code> æŒ‡å®š <code>volume</code> ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">â•­â”€root@sg<span class="token number">-02</span> /home/ubuntu
â•°â”€# docker volume ls
DRIVER              VOLUME NAME
local               docker-elk_elasticsearch
local               opt
â•­â”€root@sg<span class="token number">-02</span> /home/ubuntu
â•°â”€# docker volume inspect opt
<span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token property">"CreatedAt"</span><span class="token operator">:</span> <span class="token string">"2020-03-12T06:58:15Z"</span><span class="token punctuation">,</span>
        <span class="token property">"Driver"</span><span class="token operator">:</span> <span class="token string">"local"</span><span class="token punctuation">,</span>
        <span class="token property">"Labels"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">"Mountpoint"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/volumes/opt/_data"</span><span class="token punctuation">,</span>
        <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"opt"</span><span class="token punctuation">,</span>
        <span class="token property">"Options"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">"Scope"</span><span class="token operator">:</span> <span class="token string">"local"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span>
â•­â”€root@sg<span class="token number">-02</span> /home/ubuntu
â•°â”€# docker inspect docker-elk_elasticsearch
<span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token property">"CreatedAt"</span><span class="token operator">:</span> <span class="token string">"2020-04-24T01:37:07Z"</span><span class="token punctuation">,</span>
        <span class="token property">"Driver"</span><span class="token operator">:</span> <span class="token string">"local"</span><span class="token punctuation">,</span>
        <span class="token property">"Labels"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token property">"com.docker.compose.project"</span><span class="token operator">:</span> <span class="token string">"docker-elk"</span><span class="token punctuation">,</span>
            <span class="token property">"com.docker.compose.version"</span><span class="token operator">:</span> <span class="token string">"1.25.4"</span><span class="token punctuation">,</span>
            <span class="token property">"com.docker.compose.volume"</span><span class="token operator">:</span> <span class="token string">"elasticsearch"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"Mountpoint"</span><span class="token operator">:</span> <span class="token string">"/var/lib/docker/volumes/docker-elk_elasticsearch/_data"</span><span class="token punctuation">,</span>
        <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"docker-elk_elasticsearch"</span><span class="token punctuation">,</span>
        <span class="token property">"Options"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">"Scope"</span><span class="token operator">:</span> <span class="token string">"local"</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Bind mountsï¼š</li>
</ul>
<p>ä½¿ç”¨ <code>Bind mounts</code> å°†å®¿ä¸»æœºçš„ç›®å½•æˆ–è€…æ–‡ä»¶æŒ‚è½½è¿›å®¹å™¨å†…ï¼Œè¿™ä¸ªæ–‡ä»¶å’Œç›®å½•å¯ä»¥æ˜¯å®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿä¸Šçš„ä»»æ„ä½ç½®ï¼Œå¯ä»¥ä¸å— docker æ‰€ç®¡ç†ï¼Œæ¯”å¦‚ kubelet çš„ volumes ç›®å½•ï¼š<code>/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/</code> ã€‚ kubelet åœ¨ä¸º Pod æŒ‚è½½å­˜å‚¨çš„æ—¶å€™ä¹Ÿæ­£æ˜¯é€šè¿‡ <code>Bind mounts</code> çš„æ–¹å¼å°† Pod çš„ volumes æŒ‚è½½åˆ°å®¹å™¨å†…ã€‚æ‰€ä»¥å½“æˆ‘ä»¬ä½¿ç”¨ docker inspect å‘½ä»¤å»æŸ¥çœ‹ Pod å†…å®¹å™¨çš„ <code>Mounts</code> ä¿¡æ¯æ˜¯ï¼Œ<code>Type</code> ç±»å‹å¤šä¸º <code>bind</code> æˆ–è€… <code>tmpfs</code> ï¼Œå¾ˆå°‘ä¼šç”¨åˆ° <code>volumes</code> ã€‚å¯ä»¥ç†è§£ä¸º kubelet çš„ volumes ç›®å½•å°±åƒ docker çš„ volumes é‚£æ ·ï¼Œæ˜¯ç”± kubelet è‡ªå·±æ¥ç®¡ç†çš„ï¼Œå…¶ä»–ç”¨æˆ·æˆ–è¿›ç¨‹ä¸åº”è¯¥å»ä¿®æ”¹å®ƒã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">â•­â”€root@k8s-node<span class="token number">-3</span> ~
â•°â”€# docker inspect f1111ee6ac84
<span class="token property">"Mounts"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span>
      <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>
      <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/volumes/kubernetes.io~nfs/nfs211"</span><span class="token punctuation">,</span>
      <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/var/www/html"</span><span class="token punctuation">,</span>
      <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
      <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
      <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>
      <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/volumes/kubernetes.io~secret/default-token-wgfd9"</span><span class="token punctuation">,</span>
      <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/var/run/secrets/kubernetes.io/serviceaccount"</span><span class="token punctuation">,</span>
      <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">"ro,Z"</span><span class="token punctuation">,</span>
      <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
      <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>
      <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/etc-hosts"</span><span class="token punctuation">,</span>
      <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/etc/hosts"</span><span class="token punctuation">,</span>
      <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">"Z"</span><span class="token punctuation">,</span>
      <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
      <span class="token property">"Type"</span><span class="token operator">:</span> <span class="token string">"bind"</span><span class="token punctuation">,</span>
      <span class="token property">"Source"</span><span class="token operator">:</span> <span class="token string">"/var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/containers/nginx/f760f2be"</span><span class="token punctuation">,</span>
      <span class="token property">"Destination"</span><span class="token operator">:</span> <span class="token string">"/dev/termination-log"</span><span class="token punctuation">,</span>
      <span class="token property">"Mode"</span><span class="token operator">:</span> <span class="token string">"Z"</span><span class="token punctuation">,</span>
      <span class="token property">"RW"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token property">"Propagation"</span><span class="token operator">:</span> <span class="token string">"rprivate"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä½¿ç”¨ <code>Bind mounts</code> å¯èƒ½ä¼šæœ‰å®‰å…¨é—®é¢˜ï¼šå®¹å™¨ä¸­è¿è¡Œçš„è¿›ç¨‹å¯ä»¥ä¿®æ”¹å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…æ‹¬åˆ›å»ºï¼Œä¿®æ”¹ï¼Œåˆ é™¤é‡è¦çš„ç³»ç»Ÿæ–‡ä»¶æˆ–ç›®å½•ã€‚ä¸è¿‡å¯ä»¥åŠ å‚æ•°æŒ‚è½½ä¸ºåªè¯»ã€‚</p>
<blockquote>
<p><code>--mount</code>ï¼šç”±å¤šä¸ª <code>&#39;,&#39;</code> éš”å¼€çš„é”®å€¼å¯¹<key>&#x3D;<value>ç»„æˆï¼š</p>
<ul>
<li>æŒ‚è½½ç±»å‹ï¼škey ä¸º <code>type</code>ï¼Œvalue ä¸º <code>bind</code>ã€<code>volume</code> æˆ– <code>tmpfs</code></li>
<li>æŒ‚è½½æºï¼škey ä¸º <code>source</code> æˆ– <code>src</code>ï¼Œå¯¹äºå‘½åå·ï¼Œvalue ä¸ºå·åï¼Œå¯¹äºåŒ¿åå·ï¼Œåˆ™å¿½ç•¥</li>
<li>å®¹å™¨ä¸­çš„æŒ‚è½½ç‚¹ï¼škey ä¸º <code>destination</code>ã€<code>dst</code> æˆ– <code>target</code>ï¼Œvalue ä¸ºå®¹å™¨ä¸­çš„è·¯å¾„</li>
<li>è¯»å†™ç±»å‹ï¼švalue ä¸º <code>readonly</code>ï¼Œæ²¡æœ‰ key</li>
<li>è¯»å†™ç±»å‹ï¼švalue ä¸º <code>readonly</code>ï¼Œæ²¡æœ‰ key</li>
<li>volume-opt é€‰é¡¹ï¼Œå¯ä»¥å‡ºç°å¤šæ¬¡ã€‚æ¯”å¦‚ <code>volume-driver=local,volume-opt=type=nfs,...</code></li>
</ul>
</blockquote>
<ul>
<li><p>tmpsï¼š</p>
<p>ç”¨æ¥å­˜å‚¨ä¸€äº›ä¸éœ€è¦æŒä¹…åŒ–çš„çŠ¶æ€æˆ–æ•æ„Ÿæ•°æ®ï¼Œæ¯”å¦‚ <code>kubernetes</code> ä¸­çš„å„ç§ <code>secret</code> ã€‚æ¯”å¦‚å½“æˆ‘ä»¬ä½¿ç”¨ <code>kubectl exec -it POD</code> ï¼Œè¿›å…¥åˆ° Pod å®¹å™¨å†…ï¼Œç„¶åä½¿ç”¨ mount å‘½ä»¤æŸ¥çœ‹å®¹å™¨å†…çš„æŒ‚è½½ç‚¹ä¿¡æ¯å°±ä¼šæœ‰å¾ˆå¤š tmpfs ç±»å‹çš„æŒ‚è½½ç‚¹ã€‚å…¶ä¸­çš„ <code>/run/secrets/kubernetes.io/serviceaccount/</code> ç›®å½•ä¸‹å°±æœ‰ç€æ¯”è¾ƒæ•æ„Ÿçš„ä¿¡æ¯ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">tmpfs on /run/secrets/kubernetes.io/serviceaccount <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">(</span>ro,relatime<span class="token punctuation">)</span>
/ <span class="token comment"># tree /run/secrets/kubernetes.io/serviceaccount/</span>
/run/secrets/kubernetes.io/serviceaccount/
â”œâ”€â”€ ca.crt -<span class="token operator">></span> <span class="token punctuation">..</span>data/ca.crt
â”œâ”€â”€ namespace -<span class="token operator">></span> <span class="token punctuation">..</span>data/namespace
â””â”€â”€ token -<span class="token operator">></span> <span class="token punctuation">..</span>data/token<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<blockquote>
<ul>
<li><p><code>--tmpfs</code>ï¼šç›´æ¥æŒ‡å®šå®¹å™¨ä¸­çš„æŒ‚è½½ç‚¹ã€‚ä¸å…è®¸æŒ‡å®šä»»ä½•é…ç½®é€‰é¡¹</p>
</li>
<li><p>â€“mountï¼šç”±å¤šä¸ªâ€™,â€™éš”å¼€çš„é”®å€¼å¯¹<key>&#x3D;<value>ç»„æˆï¼š</p>
<p>æŒ‚è½½ç±»å‹ï¼škey ä¸º <code>type</code>ï¼Œvalue ä¸º <code>bind</code>ã€<code>volume</code> æˆ– <code>tmpfs</code></p>
<p>å®¹å™¨ä¸­çš„æŒ‚è½½ç‚¹ï¼škey ä¸º <code>destination</code>ã€<code>dst</code> æˆ– <code>target</code>ï¼Œvalue ä¸ºå®¹å™¨ä¸­çš„è·¯å¾„</p>
<p><code>tmpfs-size</code> å’Œ <code>tmpfs-mode</code> é€‰é¡¹</p>
</li>
</ul>
</blockquote>
<h3 id="kubelet-æŒ‚è½½å­˜å‚¨"><a href="#kubelet-æŒ‚è½½å­˜å‚¨" class="headerlink" title="kubelet æŒ‚è½½å­˜å‚¨"></a>kubelet æŒ‚è½½å­˜å‚¨</h3><p>å½“å¯¹å®¹å™¨å­˜å‚¨çš„ç±»å‹æœ‰äº†å¤§è‡´äº†è§£ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ Pod æ˜¯å¦‚ä½•è¿›è¡Œ volume æŒ‚è½½çš„ã€‚</p>
<p>å½“ Pod è¢«è°ƒåº¦åˆ°ä¸€ä¸ª Node èŠ‚ç‚¹ä¸Šåï¼ŒNode èŠ‚ç‚¹ä¸Šçš„ kubelet ç»„ä»¶å°±ä¼šä¸ºè¿™ä¸ª Pod åˆ›å»ºå®ƒçš„ Volume ç›®å½•ï¼Œé»˜è®¤æƒ…å†µä¸‹ kubelet ä¸º Volume åˆ›å»ºçš„ç›®å½•åœ¨ kubelet çš„å·¥ä½œç›®å½•ï¼ˆé»˜è®¤åœ¨ <code>/var/lib/kubelet</code> ï¼‰ï¼Œåœ¨ kubelet å¯åŠ¨çš„æ—¶å€™å¯ä»¥æ ¹æ® <code>â€“root-dir</code> å‚æ•°æ¥æŒ‡å®šå·¥ä½œç›®å½•ï¼Œä¸è¿‡ä¸€èˆ¬æ²¡å•¥ç‰¹æ®Šè¦æ±‚è¿˜æ˜¯ä½¿ç”¨é»˜è®¤çš„å°±å¥½ ğŸ˜‚ã€‚Pod çš„ volume ç›®å½•å°±åœ¨è¯¥ç›®å½•ä¸‹ï¼Œè·¯å¾„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">/var/lib/kubelet/pods/<span class="token operator">&lt;</span>Podçš„ID<span class="token operator">></span>/volumes/kubernetes.io~<span class="token operator">&lt;</span>Volumeç±»å‹<span class="token operator">></span>/<span class="token operator">&lt;</span>Volumeåå­—<span class="token operator">></span>

<span class="token comment"># æ¯”å¦‚:</span>
/var/lib/kubelet/pods/c4b1998b-f5c1-440a-b9bc-7fbf87f3c267/volumes/kubernetes.io~nfs/nfs211<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ Node èŠ‚ç‚¹ä¸Šå¯ä»¥ä½¿ç”¨ mount å‘½ä»¤æ¥æŸ¥çœ‹ kubelet ä¸º Pod æŒ‚è½½çš„æŒ‚è½½ç‚¹ä¿¡æ¯ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">10.10</span>.107.216:/nfs on /var/lib/kubelet/pods/6750b756-d8e4-448a-93f9-8906f9c44788/volumes/kubernetes.io~nfs/nfs-test <span class="token builtin class-name">type</span> nfs <span class="token punctuation">(</span>rw,relatime,vers<span class="token operator">=</span><span class="token number">3</span>,rsize<span class="token operator">=</span><span class="token number">1048576</span>,wsize<span class="token operator">=</span><span class="token number">1048576</span>,namlen<span class="token operator">=</span><span class="token number">255</span>,hard,proto<span class="token operator">=</span>tcp,timeo<span class="token operator">=</span><span class="token number">600</span>,retrans<span class="token operator">=</span><span class="token number">2</span>,sec<span class="token operator">=</span>sys,mountaddr<span class="token operator">=</span><span class="token number">10.10</span>.107.216,mountvers<span class="token operator">=</span><span class="token number">3</span>,mountport<span class="token operator">=</span><span class="token number">56389</span>,mountproto<span class="token operator">=</span>udp,local_lock<span class="token operator">=</span>none,addr<span class="token operator">=</span><span class="token number">10.10</span>.107.216<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@k8s-node-3 ~
â•°â”€<span class="token comment"># mount | grep kubelet</span>
tmpfs on /var/lib/kubelet/pods/45c55c5e-ce96-47fd-94b3-60a334e5a44d/volumes/kubernetes.io~secret/kube-proxy-token-h4dfb <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">(</span>rw,relatime,seclabel<span class="token punctuation">)</span>
tmpfs on /var/lib/kubelet/pods/3fb63baa-27ec-4d76-8028-39a0a8f91749/volumes/kubernetes.io~secret/calico-node-token-4hks6 <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">(</span>rw,relatime,seclabel<span class="token punctuation">)</span>
tmpfs on /var/lib/kubelet/pods/05c75313-f932-4913-b09f-d7bccdfb6e62/volumes/kubernetes.io~secret/nginx-ingress-token-5569x <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">(</span>rw,relatime,seclabel<span class="token punctuation">)</span>
<span class="token number">10.20</span>.172.211:/nfs on /var/lib/kubelet/pods/c4b1998b-f5c1-440a-b9bc-7fbf87f3c267/volumes/kubernetes.io~nfs/nfs211 <span class="token builtin class-name">type</span> nfs <span class="token punctuation">(</span>rw,relatime,vers<span class="token operator">=</span><span class="token number">3</span>,rsize<span class="token operator">=</span><span class="token number">524288</span>,wsize<span class="token operator">=</span><span class="token number">524288</span>,namlen<span class="token operator">=</span><span class="token number">255</span>,hard,proto<span class="token operator">=</span>tcp,timeo<span class="token operator">=</span><span class="token number">600</span>,retrans<span class="token operator">=</span><span class="token number">2</span>,sec<span class="token operator">=</span>sys,mountaddr<span class="token operator">=</span><span class="token number">10.20</span>.172.211,mountvers<span class="token operator">=</span><span class="token number">3</span>,mountport<span class="token operator">=</span><span class="token number">20048</span>,mountproto<span class="token operator">=</span>udp,local_lock<span class="token operator">=</span>none,addr<span class="token operator">=</span><span class="token number">10.20</span>.172.211<span class="token punctuation">)</span>
tmpfs on /var/lib/kubelet/pods/73fed6f3-4cbe-46a7-af7b-6fd912e6ebd4/volumes/kubernetes.io~secret/default-token-wgfd9 <span class="token builtin class-name">type</span> tmpfs <span class="token punctuation">(</span>rw,relatime,seclabel<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å…¶ä¸­ kubernetes ç›®å‰æ”¯æŒçš„ Volume çš„ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>kubectl explain pod.spec.volumes</code>  æ¥æŸ¥çœ‹ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@k8s-master-01 ~
â•°â”€<span class="token comment"># kubectl explain pod.spec.volumes | grep Object | cut -d "&lt;" -f1</span>
RESOURCE: volumes
awsElasticBlockStore
azureDisk
azureFile
cephfs
cinder
configMap
csi
downwardAPI
emptyDir
fc
flexVolume
flocker
gcePersistentDisk
gitRepo
glusterfs
hostPath
iscsi
nfs
persistentVolumeClaim
photonPersistentDisk
portworxVolume
projected
quobyte
rbd
scaleIO
secret
storageos
vsphereVolume<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ç®¡-systemd-ä»€ä¹ˆäº‹å„¿ï¼Ÿ"><a href="#ç®¡-systemd-ä»€ä¹ˆäº‹å„¿ï¼Ÿ" class="headerlink" title="ç®¡ systemd ä»€ä¹ˆäº‹å„¿ï¼Ÿ"></a>ç®¡ systemd ä»€ä¹ˆäº‹å„¿ï¼Ÿ</h3><p>æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹å½“åˆçš„é”™è¯¯æ—¥å¿—ï¼š</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog">Events<span class="token punctuation">:</span>
  Type     Reason       Age    From            Message
  <span class="token operator">----</span>  <span class="token operator">------</span>  <span class="token operator">----</span> <span class="token operator">----</span>     <span class="token operator">-------</span>
  Warning  FailedMount  <span class="token number">8</span>m49s  kubelet<span class="token punctuation">,</span> node1  MountVolume<span class="token punctuation">.</span>SetUp failed <span class="token keyword">for</span> volume <span class="token string">"nfs211"</span> <span class="token punctuation">:</span> mount failed<span class="token punctuation">:</span> exit status <span class="token number">32</span>
Mounting command<span class="token punctuation">:</span> systemd<span class="token operator">-</span>run
Mounting arguments<span class="token punctuation">:</span> <span class="token operator">--</span>description<span class="token operator">=</span>Kubernetes transient mount <span class="token keyword">for</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>kubelet<span class="token operator">/</span>pods<span class="token operator">/</span>cddc94e7<span class="token operator">-</span><span class="token number">8033</span><span class="token operator">-</span><span class="token number">4150</span><span class="token operator">-</span>bed5<span class="token operator">-</span>d141e3b71e49<span class="token operator">/</span>volumes<span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io<span class="token operator">~</span>nfs<span class="token operator">/</span>nfs211 <span class="token operator">--</span>scope <span class="token operator">--</span> mount <span class="token operator">-</span>t nfs <span class="token number">10.20</span><span class="token punctuation">.</span><span class="token number">172.211</span><span class="token punctuation">:</span><span class="token operator">/</span>nfs <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>kubelet<span class="token operator">/</span>pods<span class="token operator">/</span>cddc94e7<span class="token operator">-</span><span class="token number">8033</span><span class="token operator">-</span><span class="token number">4150</span><span class="token operator">-</span>bed5<span class="token operator">-</span>d141e3b71e49<span class="token operator">/</span>volumes<span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io<span class="token operator">~</span>nfs<span class="token operator">/</span>nfs211
Output<span class="token punctuation">:</span> Running scope as unit run<span class="token operator">-</span><span class="token number">38284</span><span class="token punctuation">.</span>scope<span class="token punctuation">.</span>
mount<span class="token punctuation">:</span> wrong fs <span class="token keyword">type</span><span class="token punctuation">,</span> bad option<span class="token punctuation">,</span> bad superblock on <span class="token number">10.20</span><span class="token punctuation">.</span><span class="token number">172.211</span><span class="token punctuation">:</span><span class="token operator">/</span>nfs<span class="token punctuation">,</span>
       missing codepage <span class="token keyword">or</span> helper <span class="token keyword">program</span><span class="token punctuation">,</span> <span class="token keyword">or</span> other error
       <span class="token punctuation">(</span><span class="token keyword">for</span> several filesystems <span class="token punctuation">(</span>e<span class="token punctuation">.</span>g<span class="token punctuation">.</span> nfs<span class="token punctuation">,</span> cifs<span class="token punctuation">)</span> you might
       need a <span class="token operator">/</span>sbin<span class="token operator">/</span>mount<span class="token punctuation">.</span><span class="token operator">&lt;</span><span class="token keyword">type</span><span class="token operator">></span> helper <span class="token keyword">program</span><span class="token punctuation">)</span>

       In some cases useful info is found in syslog <span class="token operator">-</span> try
       dmesg <span class="token operator">|</span> tail <span class="token keyword">or</span> so<span class="token punctuation">.</span>
  Warning  FailedMount  <span class="token number">8</span>m48s  kubelet<span class="token punctuation">,</span> node1  MountVolume<span class="token punctuation">.</span>SetUp failed <span class="token keyword">for</span> volume <span class="token string">"nfs211"</span> <span class="token punctuation">:</span> mount failed<span class="token punctuation">:</span> exit status <span class="token number">32</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å’¦ï¼Ÿå½“æ—¶æˆ‘è¿˜å¯»æ€ç€ kubelet æŒ‚è½½ volumes å’Œ systemd ä»€ä¹ˆå…³ç³»ï¼Ÿ<code>systemd</code> è¿™ä¸ªå¤§å¦ˆæ€ä¹ˆåˆæ¥ç®¡è¿™äº‹å„¿äº† ğŸ˜‚ï¼ˆä¹‹å‰æˆ‘å†™è¿‡ä¸€ç¯‡<a href="https://blog.k8s.li/systemd.html">ã€ŠLinux çš„å°ä¼™ä¼´ systemd è¯¦è§£ã€‹</a> ï¼Œæˆç§° systemd æ˜¯ Linux çš„å°ä¼™ä¼´ï¼Œçœ‹æ¥è¿™ä¸ªè¯´æ³•æ˜¯ä¸å¦¥çš„ã€‚systemd ç®€ç›´å°±æ˜¯ Linux é‡Œçš„ç‰©ä¸šå¤§å¦ˆå¥½å˜› ğŸ¤£ï¼Œä¸Šç®¡ service ä¸‹ç®¡ dev ã€ mount è®¾å¤‡ç­‰ã€‚å±‘ï¼Œç®€ç›´å°±æ˜¯ä¸ªç‰©ä¸šå¤§å¦ˆç®¡è¿™ç®¡é‚£çš„ã€‚å›åˆ°æ­£é¢˜ï¼Œäºæ˜¯é¡ºç€è¿™æ¡æŠ¥é”™æ—¥å¿—é¡ºè—¤æ‘¸ç“œæ‰¾åˆ°äº† <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/49640">Run mount in its own systemd scope.</a> è¿™ä¸ª PRã€‚</p>
<blockquote>
<p>Kubelet needs to run &#x2F;bin&#x2F;mount in its own cgroup.</p>
<ul>
<li>When kubelet runs as a systemd service, â€œsystemctl restart kubeletâ€ may kill all processes in the same cgroup and thus terminate fuse daemons that are needed for gluster and cephfs mounts.</li>
<li>When kubelet runs in a docker container, restart of the container kills all fuse daemons started in the container.</li>
</ul>
<p>Killing fuse daemons is bad, it basically unmounts volumes from running pods.</p>
<p>This patch runs mount via â€œsystemd-run â€“scope &#x2F;bin&#x2F;mount â€¦â€, which makes sure that any fuse daemons are forked in its own systemd scope (&#x3D; cgroup) and they will survive restart of kubeletâ€™s systemd service or docker container.</p>
<p>This helps with <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/34965">#34965</a></p>
<p>As a downside, each new fuse daemon will run in its own transient systemd service and systemctl output may be cluttered.</p>
</blockquote>
<p>æ­£å¦‚æè¿™ä¸ª PR çš„å¤§ä½¬è®²çš„ï¼Œï¼ˆä¹‹å‰ï¼‰kubelet éœ€è¦åœ¨å®ƒè‡ªå·±çš„ <code>cgroup</code> é‡Œè¿è¡Œå®¿ä¸»æœºä¸Šçš„ <code>/bin/mount</code> æ¥ä¸º Pod æŒ‚è½½ volumes ï¼Œè€Œå½“ kubelet è¿›ç¨‹é‡å¯æˆ–è€…æŒ‚æ‰çš„æ—¶å€™ï¼Œè¿™äº›åœ¨ kubelet çš„  <code>cgroup</code> é‡Œè¿è¡Œçš„è¿›ç¨‹ä¹Ÿå°†ä¼šæŒ‚æ‰ï¼Œæ¯”å¦‚ï¼ˆglusterï¼Œcephï¼‰ã€‚ç„¶åå¤§ä½¬çš„è¿™ä¸ª patch é€šè¿‡ <code>systemd-run --scope /bin/mount</code> æ¥å»å¯åŠ¨ä¸€ä¸ªä¸´æ—¶çš„ systemd å•å…ƒæ¥ä¸º Pod æŒ‚è½½ volumesï¼Œè¿™æ ·ä¸€æ¥è¿™äº› <code>fuse daemons</code>  è¿›ç¨‹ï¼ˆglusterï¼Œcephï¼‰å°±ä¼š forked åˆ°å®ƒè‡ªå·±çš„ systemd scope é‡Œï¼Œè¿™æ ·å³ä¾¿ kubelet é‡å¯æˆ–è€…æŒ‚æ‰ä¹Ÿä¸ä¼šå½±å“æ­£åœ¨è¿è¡Œçš„å®¹å™¨ä½¿ç”¨ volumesã€‚</p>
<p>è¿™ä¸€ç‚¹åƒ <a target="_blank" rel="noopener" href="https://github.com/containerd/containerd">containerd</a> ä¹‹äº dockerd ï¼Œå³ä¾¿ dockerd é‡å¯ä¹Ÿä¸ä¼šå½±å“åˆ°å®¹å™¨çš„è¿è¡Œï¼Œå› ä¸ºï¼Œåœ¨è¿è¡Œæ—¶è¿™ä¸€å—ï¼ŒçœŸæ­£è¿è¡Œå®¹å™¨çš„æ˜¯ containerd ä¸‹çš„å„ä¸ª containerd-shim å­è¿›ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ pstree å‘½ä»¤æ¥çœ‹ä¸€ä¸‹è¿™ç§å±‚çº§å…³ç³»ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â”œâ”€containerdâ”€â”¬â”€5*<span class="token punctuation">[</span>containerd-shimâ”€â”¬â”€pause<span class="token punctuation">]</span>
â”‚            â”‚                    â””â”€9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
â”‚            â”œâ”€containerd-shimâ”€â”¬â”€pause
â”‚            â”‚                 â””â”€10*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
â”‚            â”œâ”€containerd-shimâ”€â”¬â”€etcdâ”€â”€â”€15*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>etcd<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
â”‚            â”‚                 â””â”€9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
â”‚            â”œâ”€containerd-shimâ”€â”¬â”€kube-controllerâ”€â”€â”€12*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>kube-controller<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
â”‚            â”‚                 â””â”€9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
â”‚            â”œâ”€containerd-shimâ”€â”¬â”€kube-apiserverâ”€â”€â”€14*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>kube-apiserver<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
â”‚            â”‚                 â””â”€9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
â”‚            â”œâ”€containerd-shimâ”€â”¬â”€kube-schedulerâ”€â”€â”€13*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>kube-scheduler<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
â”‚            â”‚                 â””â”€9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
â”‚            â”œâ”€containerd-shimâ”€â”¬â”€kube-proxyâ”€â”€â”€11*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>kube-proxy<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
â”‚            â”‚                 â””â”€9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
â”‚            â”œâ”€containerd-shimâ”€â”¬â”€flanneldâ”€â”€â”€15*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>flanneld<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
â”‚            â”‚                 â””â”€9*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd-shim<span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
â”‚            â””â”€26*<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>containerd<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ¥ç€é¡ºè—¤æ‘¸ç“œç¿»åˆ°è¿™ä¸ª PR å¯¹åº”çš„æºç æ–‡ä»¶  <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/vendor/k8s.io/utils/mount/mount_linux.go#L115">mount_linux.go</a>ï¼Œå…³é”®å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// doMount runs the mount command. mounterPath is the path to mounter binary if containerized mounter is used.</span>
<span class="token comment">// sensitiveOptions is an extention of options except they will not be logged (because they may contain sensitive material)</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>mounter <span class="token operator">*</span>Mounter<span class="token punctuation">)</span> <span class="token function">doMount</span><span class="token punctuation">(</span>mounterPath <span class="token builtin">string</span><span class="token punctuation">,</span> mountCmd <span class="token builtin">string</span><span class="token punctuation">,</span> source <span class="token builtin">string</span><span class="token punctuation">,</span> target <span class="token builtin">string</span><span class="token punctuation">,</span> fstype <span class="token builtin">string</span><span class="token punctuation">,</span> options <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> sensitiveOptions <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">&#123;</span>
	mountArgs<span class="token punctuation">,</span> mountArgsLogStr <span class="token operator">:=</span> <span class="token function">MakeMountArgsSensitive</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> target<span class="token punctuation">,</span> fstype<span class="token punctuation">,</span> options<span class="token punctuation">,</span> sensitiveOptions<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>mounterPath<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">&#123;</span>
		mountArgs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">&#123;</span>mountCmd<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> mountArgs<span class="token operator">...</span><span class="token punctuation">)</span>
		mountArgsLogStr <span class="token operator">=</span> mountCmd <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> mountArgsLogStr
		mountCmd <span class="token operator">=</span> mounterPath
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">if</span> mounter<span class="token punctuation">.</span>withSystemd <span class="token punctuation">&#123;</span>
		<span class="token comment">// Try to run mount via systemd-run --scope. This will escape the</span>
		<span class="token comment">// service where kubelet runs and any fuse daemons will be started in a</span>
		<span class="token comment">// specific scope. kubelet service than can be restarted without killing</span>
		<span class="token comment">// these fuse daemons.</span>
		<span class="token comment">//</span>
		<span class="token comment">// Complete command line (when mounterPath is not used):</span>
		<span class="token comment">// systemd-run --description=... --scope -- mount -t &lt;type> &lt;what> &lt;where></span>
		<span class="token comment">//</span>
		<span class="token comment">// Expected flow:</span>
		<span class="token comment">// * systemd-run creates a transient scope (=~ cgroup) and executes its</span>
		<span class="token comment">//   argument (/bin/mount) there.</span>
		<span class="token comment">// * mount does its job, forks a fuse daemon if necessary and finishes.</span>
		<span class="token comment">//   (systemd-run --scope finishes at this point, returning mount's exit</span>
		<span class="token comment">//   code and stdout/stderr - thats one of --scope benefits).</span>
		<span class="token comment">// * systemd keeps the fuse daemon running in the scope (i.e. in its own</span>
		<span class="token comment">//   cgroup) until the fuse daemon dies (another --scope benefit).</span>
		<span class="token comment">//   Kubelet service can be restarted and the fuse daemon survives.</span>
		<span class="token comment">// * When the fuse daemon dies (e.g. during unmount) systemd removes the</span>
		<span class="token comment">//   scope automatically.</span>
		<span class="token comment">//</span>
		<span class="token comment">// systemd-mount is not used because it's too new for older distros</span>
		<span class="token comment">// (CentOS 7, Debian Jessie).</span>
		mountCmd<span class="token punctuation">,</span> mountArgs<span class="token punctuation">,</span> mountArgsLogStr <span class="token operator">=</span> <span class="token function">AddSystemdScopeSensitive</span><span class="token punctuation">(</span><span class="token string">"systemd-run"</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> mountCmd<span class="token punctuation">,</span> mountArgs<span class="token punctuation">,</span> mountArgsLogStr<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// No systemd-run on the host (or we failed to check it), assume kubelet</span>
		<span class="token comment">// does not run as a systemd service.</span>
		<span class="token comment">// No code here, mountCmd and mountArgs are already populated.</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">// Logging with sensitive mount options removed.</span>
	klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Mounting cmd (%s) with arguments (%s)"</span><span class="token punctuation">,</span> mountCmd<span class="token punctuation">,</span> mountArgsLogStr<span class="token punctuation">)</span>
	command <span class="token operator">:=</span> exec<span class="token punctuation">.</span><span class="token function">Command</span><span class="token punctuation">(</span>mountCmd<span class="token punctuation">,</span> mountArgs<span class="token operator">...</span><span class="token punctuation">)</span>
	output<span class="token punctuation">,</span> err <span class="token operator">:=</span> command<span class="token punctuation">.</span><span class="token function">CombinedOutput</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">&#123;</span>
		klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Mount failed: %v\nMounting command: %s\nMounting arguments: %s\nOutput: %s\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> mountCmd<span class="token punctuation">,</span> mountArgsLogStr<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"mount failed: %v\nMounting command: %s\nMounting arguments: %s\nOutput: %s"</span><span class="token punctuation">,</span>
			err<span class="token punctuation">,</span> mountCmd<span class="token punctuation">,</span> mountArgsLogStr<span class="token punctuation">,</span> <span class="token function">string</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> err
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ¥çœ‹ä¸€ä¸‹ <code>doMount</code> è¿™ä¸ªå‡½æ•°çš„å‡ ä¸ªå½¢å‚ï¼š</p>
<ul>
<li>mounterPath ï¼š</li>
</ul>
<p>å°±æ˜¯æˆ‘ä»¬å®¿ä¸»æœºä¸Šçš„æŒ‚è½½å‘½ä»¤æ¯”å¦‚ <code>/sbin/mount.nfs</code> ã€<code>/sbin/mount.glusterfs</code> ç­‰ã€‚</p>
<ul>
<li>mountCmdï¼šæŒ‚è½½å‘½ä»¤å°±æ˜¯ <code>systemd-run</code></li>
<li>sourceï¼šæŒ‚è½½å­˜å‚¨çš„æºè·¯å¾„ï¼Œæ¯”å¦‚ NFS é‡Œçš„ <code>10.10.107.211:/nfs</code></li>
<li>target</li>
</ul>
<p>å°±æ˜¯æˆ‘ä»¬çš„ Pod çš„ volume ï¼Œåœ¨ <code>/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;</code> ï¼Œç€ç›®å½•åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™ä¼š bind mount åˆ°å®¹å™¨å†…çš„æŒ‚è½½ç‚¹</p>
<ul>
<li>fstypeï¼šæ–‡ä»¶ç³»ç»Ÿç±»å‹ï¼ŒNFSã€cephã€GlusterFS</li>
<li>options []stringï¼šæŒ‚è½½çš„å‚æ•°ï¼Œæ¯”å¦‚ NFS çš„</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>rw,relatime,vers<span class="token operator">=</span><span class="token number">3</span>,rsize<span class="token operator">=</span><span class="token number">524288</span>,wsize<span class="token operator">=</span><span class="token number">524288</span>,namlen<span class="token operator">=</span><span class="token number">255</span>,hard,proto<span class="token operator">=</span>tcp,timeo<span class="token operator">=</span><span class="token number">600</span>,retrans<span class="token operator">=</span><span class="token number">2</span>,sec<span class="token operator">=</span>sys,mountaddr<span class="token operator">=</span><span class="token number">10.20</span>.172.211,mountvers<span class="token operator">=</span><span class="token number">3</span>,mountport<span class="token operator">=</span><span class="token number">20048</span>,mountproto<span class="token operator">=</span>udp,local_lock<span class="token operator">=</span>none,addr<span class="token operator">=</span><span class="token number">10.20</span>.172.211<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>sensitiveOptions []stringï¼Œè¿™ä¸ªå‚æ•°æ²¡å»ä»”ç»†çœ‹ï¼Œå°±ç•¥è¿‡å§ï¼ˆ</li>
</ul>
<p>è‡³æ­¤ kubelet ä¸º Pod æŒ‚è½½çš„åŸç†å’Œæµç¨‹ä¹Ÿä¸€ç›®äº†ç„¶ï¼Œå…¶å®å¾ˆç®€å•çš„é€»è¾‘ï¼Œå¤§è‡´å¯ä»¥æ°›å›´</p>
<ul>
<li>Attach é˜¶æ®µï¼škubelet ä½¿ç”¨ systemd-run å•ç‹¬èµ·ä¸€ä¸ªä¸´æ—¶çš„ systemd scope æ¥è¿è¡Œåç«¯å­˜å‚¨çš„å®¢æˆ·ç«¯æ¯”å¦‚ï¼ˆ nfs ã€glusterã€cephï¼‰ï¼Œå°†è¿™äº›å­˜å‚¨æŒ‚è½½åˆ° <code>/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;</code></li>
<li>Mount é˜¶æ®µï¼šå®¹å™¨å¯åŠ¨çš„æ—¶å€™é€šè¿‡ bind mount çš„æ–¹å¼å°†  <code>/var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;</code> è¿™ä¸ªç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…ã€‚è¿™ä¸€æ­¥ç›¸å½“äºä½¿ç”¨ <code>docker run -v /var/lib/kubelet/pods/&lt;Podçš„ID&gt;/volumes/kubernetes.io~&lt;Volumeç±»å‹&gt;/&lt;Volumeåå­—&gt;:/&lt;å®¹å™¨å†…çš„ç›®æ ‡ç›®å½•&gt; æˆ‘çš„é•œåƒ</code> å¯åŠ¨ä¸€ä¸ªå®¹å™¨ã€‚</li>
</ul>
<p>å…³äºæ›´è¯¦ç»†çš„ CSI å­˜å‚¨å¯ä»¥å‚è€ƒä¸‹é¢æåˆ°çš„æ–‡ç« </p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p>è™½ç„¶æ˜¯ä¸€ç¯‡å¾ˆç®€å•çš„åˆ†æï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å‚è€ƒäº†å¾ˆå¤šçš„åšå®¢ï¼Œæ²¡æœ‰è¿™äº›å¤§ä½¬çš„åˆ†äº«å°±æ²¡æœ‰è¿™ç¯‡æ–‡ç« ï¼šï¼‰ï¼Œè¿™äº›å¤§ä½¬ä»¬çš„åšå®¢æ–‡ç« æ¯”æˆ‘å†™çš„ <code>ä¸çŸ¥é“é«˜åˆ°å“ªé‡Œå»äº†</code>ï¼Œæ‰€ä»¥å¦‚æœä½ çœ‹äº†è¿™ç¯‡æ–‡ç« è¿˜æ˜¯æ²¡æ‡‚çš„è¯ï¼Œä¸å¦¨ä¹Ÿçœ‹ä¸€ä¸‹ä¸‹é¢çš„è¿™äº›æ–‡ç« å°±èƒ½è±ç„¶å¼€æœ—äº† ğŸ˜‚ã€‚</p>
<h3 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/vendor/k8s.io/utils/mount/mount_linux.go#L115">kubernetes&#x2F;mount_linux.go at master Â· kubernetes&#x2F;kubernetes</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/49640">Run mount in its own systemd scope. by jsafrane Â· Pull Request #49640 Â· kubernetes&#x2F;kubernetes</a></li>
</ul>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.huweihuang.com/article/source-analysis/kubelet/create-pod-by-kubelet/#66-mount-volumes">kubelet æºç åˆ†æï¼ˆå››ï¼‰ä¹‹ Pod çš„åˆ›å»º - èƒ¡ä¼Ÿç…Œ | Blog</a></li>
<li><a target="_blank" rel="noopener" href="http://ljchen.net/2018/10/28/kubelet%E6%BA%90%E7%A0%81%E6%9E%B6%E6%9E%84%E7%AE%80%E4%BB%8B/">Kubelet æºç æ¶æ„ç®€ä»‹ | ljchenâ€™s Notes</a></li>
<li><a target="_blank" rel="noopener" href="http://newgoo.org/2019/09/03/k8s/kubelet-%E6%BA%90%E7%A0%81/">kubelet æºç åˆ†æ - Beantech | Newgoo | kubernates</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.xbblfz.site/2018/10/12/Kubelet%E5%90%AF%E5%8A%A8%E5%8F%8A%E5%AF%B9Docker%E5%AE%B9%E5%99%A8%E7%AE%A1%E7%90%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">â€œKubelet å¯åŠ¨æºç åˆ†æâ€ - å¾æ³¢çš„åšå®¢ | Xu Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://cizixs.com/2017/06/06/kubelet-source-code-analysis-part-1/">kubelet æºç åˆ†æï¼šå¯åŠ¨æµç¨‹ | Cizixs Write Here</a></li>
<li><a target="_blank" rel="noopener" href="https://fankangbest.github.io/2017/12/17/kubelet%E5%88%86%E6%9E%90(%E4%B8%89)-volumeManager-v1-5-2/">kubelet åˆ†æ(ä¸‰)-volumeManager-v1.5.2 | fankangbest</a></li>
<li><a target="_blank" rel="noopener" href="https://wenfeng-gao.github.io/post/k8s-volume-manager-source-code-analysis/">Kubernetes æºç åˆ†æä¹‹ VolumeManager - Je pense donc je suis</a></li>
<li><a target="_blank" rel="noopener" href="https://www.huweihuang.com/kubernetes-notes/code-analysis/kubelet/startKubelet.html">startKubelet Â· Kubernetes å­¦ä¹ ç¬”è®°</a></li>
</ul>
<h3 id="å®˜æ–¹æ–‡æ¡£"><a href="#å®˜æ–¹æ–‡æ¡£" class="headerlink" title="å®˜æ–¹æ–‡æ¡£"></a>å®˜æ–¹æ–‡æ¡£</h3><ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/">Manage data in Docker | Docker Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/bind-mounts/">Use bind mounts | Docker Documentation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/bind-mounts/">Use bind mounts | Docker Documentation</a></li>
<li><a target="_blank" rel="noopener" href="http://www.jinbuguo.com/man/mount.html">mount ä¸­æ–‡æ‰‹å†Œ</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/overlayfs-driver/">Use the OverlayFS storage driver</a></li>
</ul>
<h3 id="ç›¸å…³åšå®¢"><a href="#ç›¸å…³åšå®¢" class="headerlink" title="ç›¸å…³åšå®¢"></a>ç›¸å…³åšå®¢</h3><ul>
<li><a target="_blank" rel="noopener" href="https://cizixs.com/2016/10/25/kubernetes-intro-kubelet/">kubernetes ç®€ä»‹ï¼š kubelet å’Œ pod | Cizixs Write Here</a></li>
<li><a target="_blank" rel="noopener" href="https://michaelyou.github.io/2017/09/17/Docker%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86-Volume%EF%BC%8C-bind-mount%E5%92%8Ctmpfs-mount/">Docker æ•°æ®ç®¡ç†-Volumeï¼Œ bind mount å’Œ tmpfs mount | Youmai ã® Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://www.qikqiak.com/k8strain/storage/csi/">å­˜å‚¨åŸç† - K8S è®­ç»ƒè¥</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.fatedier.com/2020/04/17/pod-loopcrash-of-k8s-subpath/">Kubernetes æŒ‚è½½ subpath çš„å®¹å™¨åœ¨ configmap å˜æ›´åé‡å¯æ—¶æŒ‚è½½å¤±è´¥</a></li>
<li><a target="_blank" rel="noopener" href="https://www.infvie.com/ops-notes/kubernetes-storage.html">ç†è§£ kubernetes ä¸­çš„ Storage | Infvieâ€™s Blog</a></li>
<li><a target="_blank" rel="noopener" href="https://arkingc.github.io/2018/12/11/2018-12-11-docker-storage-persist/">Docker å®¹å™¨æ•°æ®æŒä¹…åŒ–</a></li>
<li><a target="_blank" rel="noopener" href="https://arkingc.github.io/2018/01/19/2018-01-19-docker-imagestore/">Docker æºç åˆ†æâ€”é•œåƒå­˜å‚¨</a></li>
<li><a target="_blank" rel="noopener" href="https://arkingc.github.io/2018/01/15/2018-01-15-docker-storage-overlay2/">Docker æºç åˆ†æâ€”å­˜å‚¨é©±åŠ¨</a></li>
<li><a target="_blank" rel="noopener" href="https://arkingc.github.io/2017/05/05/2017-05-05-docker-filesystem-overlay/">Docker å­˜å‚¨é©±åŠ¨â€”Overlay&#x2F;Overlay2ã€Œè¯‘ã€</a></li>
<li><a href="https://blog.k8s.li/systemd.html">Linux çš„å°ä¼™ä¼´ systemd è¯¦è§£</a></li>
</ul>
<h2 id="ç»“æŸ"><a href="#ç»“æŸ" class="headerlink" title="ç»“æŸ"></a>ç»“æŸ</h2><p>æœ€åç¥å„ä½è¿˜åœ¨ <code>æ¬ç –</code> çš„å·¥äººä»¬èŠ‚æ—¥å¿«ä¹ï¼</p>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
              <a href="/tags/docker/" rel="tag"># docker</a>
              <a href="/tags/%E5%AE%B9%E5%99%A8/" rel="tag"># å®¹å™¨</a>
              <a href="/tags/%E5%AD%98%E5%82%A8/" rel="tag"># å­˜å‚¨</a>
              <a href="/tags/volumes/" rel="tag"># volumes</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/interview-wordpress-install.html" rel="prev" title="ä¸€æ¬¡æœ‰è¶£çš„é¢è¯•ï¼šWordPress éƒ¨ç½²">
                  <i class="fa fa-chevron-left"></i> ä¸€æ¬¡æœ‰è¶£çš„é¢è¯•ï¼šWordPress éƒ¨ç½²
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/from-chongqing-to-hangzhou.html" rel="next" title="æ— ç –å¯æ¬çš„æ—¥å­ï¼šæ¢å‚è®°">
                  æ— ç –å¯æ¬çš„æ—¥å­ï¼šæ¢å‚è®° <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.8m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">26:36</span>
  </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
