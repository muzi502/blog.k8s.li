<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.3.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="ä¸Šå‘¨åœ¨å†™ã€Šé•œåƒæ¬è¿å·¥ skopeo ã€‹ çš„æ—¶å€™çœ‹äº†å¾ˆå¤šå…³äºå®¹å™¨é•œåƒç›¸å…³çš„åšå®¢ï¼Œä»å¤§ä½¬ä»¬é‚£é‡Œå·å·å­¦äº†ä¸å°‘çŸ¥è¯†ï¼Œå¯¹å®¹å™¨é•œåƒæœ‰äº†ä¸€ç‚¹ç‚¹æ·±å…¥çš„äº†è§£ã€‚è¿™å‘¨æœ«ä¸€ä¸ªäººé—²ç€å®…åœ¨å®¶é‡Œæ²¡äº‹å°±æŠŠæœ€è¿‘æ‰€å­¦çš„çŸ¥è¯†æ•´ç†ä¸€ä¸‹åˆ†äº«å‡ºæ¥ï¼Œä¾›å¤§å®¶ä¸€èµ·æ¥é£Ÿç”¨ã€‚å†…å®¹æ¯”è¾ƒå¤šï¼Œè€å¿ƒçœ‹å®Œçš„è¯ï¼Œè¿˜æ˜¯èƒ½æ”¶è·ä¸€äº›æ²¡ç”¨çš„çŸ¥è¯†æ»´ ğŸ˜‚ã€‚ æ›´æ–°è®°å½• 2020-06-13ï¼šè¿˜æœ‰ä¸€äº›æ²¡æœ‰å†™å®Œï¼Œåç»­è¡¥å…… 2020-06-06ï¼šåˆç¨¿ 2020-09-02ï¼šè¡¥å……">
<meta property="og:type" content="blog">
<meta property="og:title" content="æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”ŸğŸ¤”">
<meta property="og:url" content="https://blog.k8s.li/Exploring-container-image.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="ä¸Šå‘¨åœ¨å†™ã€Šé•œåƒæ¬è¿å·¥ skopeo ã€‹ çš„æ—¶å€™çœ‹äº†å¾ˆå¤šå…³äºå®¹å™¨é•œåƒç›¸å…³çš„åšå®¢ï¼Œä»å¤§ä½¬ä»¬é‚£é‡Œå·å·å­¦äº†ä¸å°‘çŸ¥è¯†ï¼Œå¯¹å®¹å™¨é•œåƒæœ‰äº†ä¸€ç‚¹ç‚¹æ·±å…¥çš„äº†è§£ã€‚è¿™å‘¨æœ«ä¸€ä¸ªäººé—²ç€å®…åœ¨å®¶é‡Œæ²¡äº‹å°±æŠŠæœ€è¿‘æ‰€å­¦çš„çŸ¥è¯†æ•´ç†ä¸€ä¸‹åˆ†äº«å‡ºæ¥ï¼Œä¾›å¤§å®¶ä¸€èµ·æ¥é£Ÿç”¨ã€‚å†…å®¹æ¯”è¾ƒå¤šï¼Œè€å¿ƒçœ‹å®Œçš„è¯ï¼Œè¿˜æ˜¯èƒ½æ”¶è·ä¸€äº›æ²¡ç”¨çš„çŸ¥è¯†æ»´ ğŸ˜‚ã€‚ æ›´æ–°è®°å½• 2020-06-13ï¼šè¿˜æœ‰ä¸€äº›æ²¡æœ‰å†™å®Œï¼Œåç»­è¡¥å…… 2020-06-06ï¼šåˆç¨¿ 2020-09-02ï¼šè¡¥å……">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/docker-architecture.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/12036324/70367494-646d2380-18db-11ea-992a-d2bca4cbfeb0.png">
<meta property="og:image" content="https://p.k8s.li/registry-storage.jpeg">
<meta property="og:image" content="https://p.k8s.li/20200609_oci-04.jpg">
<meta property="og:image" content="https://p.k8s.li/overlay_constructs.jpg">
<meta property="article:published_time" content="2020-06-13T16:00:00.000Z">
<meta property="article:modified_time" content="2020-06-13T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="image">
<meta property="article:tag" content="registry">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/docker-architecture.png">


<link rel="canonical" href="https://blog.k8s.li/Exploring-container-image.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/Exploring-container-image.html","path":"Exploring-container-image.html","title":"æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”ŸğŸ¤”"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”ŸğŸ¤” | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95"><span class="nav-number">1.</span> <span class="nav-text">æ›´æ–°è®°å½•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E6%98%AF%E6%80%8E%E6%A0%B7%E7%82%BC%E6%88%90%E7%9A%84-%F0%9F%A4%94"><span class="nav-number">2.</span> <span class="nav-text">é•œåƒæ˜¯æ€æ ·ç‚¼æˆçš„ ğŸ¤”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OCI-image-spec"><span class="nav-number">2.1.</span> <span class="nav-text">OCI image-spec</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%84%E7%A7%8D-id-%E5%88%86%E4%B8%8D%E6%B8%85%EF%BC%9F"><span class="nav-number">2.2.</span> <span class="nav-text">å„ç§ id åˆ†ä¸æ¸…ï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile"><span class="nav-number">2.3.</span> <span class="nav-text">Dockerfile</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E6%98%AF%E6%80%8E%E6%A0%B7%E5%AD%98%E6%94%BE%E7%9A%84-%EF%BC%88%E4%B8%80%EF%BC%89%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8-%F0%9F%99%84"><span class="nav-number">3.</span> <span class="nav-text">é•œåƒæ˜¯æ€æ ·å­˜æ”¾çš„ ï¼ˆä¸€ï¼‰æœ¬åœ°å­˜å‚¨ ğŸ™„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-x2F-var-x2F-lib-x2F-docker"><span class="nav-number">3.1.</span> <span class="nav-text">docker (&#x2F;var&#x2F;lib&#x2F;docker)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#x2F-var-x2F-lib-x2F-docker-x2F-image"><span class="nav-number">3.2.</span> <span class="nav-text">&#x2F;var&#x2F;lib&#x2F;docker&#x2F;image</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#x2F-var-x2F-lib-x2F-docker-x2F-overlay2"><span class="nav-number">3.3.</span> <span class="nav-text">&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E6%98%AF%E6%80%8E%E4%B9%88%E6%90%AC%E8%BF%90%E7%9A%84-%F0%9F%A4%A3"><span class="nav-number">4.</span> <span class="nav-text">é•œåƒæ˜¯æ€ä¹ˆæ¬è¿çš„ ğŸ¤£</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-pull"><span class="nav-number">4.1.</span> <span class="nav-text">docker pull</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-push"><span class="nav-number">4.2.</span> <span class="nav-text">docker push</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python-docker-drag"><span class="nav-number">4.3.</span> <span class="nav-text">Python docker-drag</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo"><span class="nav-number">4.4.</span> <span class="nav-text">skopeo</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E6%98%AF%E6%80%8E%E4%B9%88%E5%AD%98%E6%94%BE%E7%9A%84-%E4%BA%8C-registry-%E5%AD%98%E5%82%A8-%F0%9F%99%84"><span class="nav-number">5.</span> <span class="nav-text">é•œåƒæ˜¯æ€ä¹ˆå­˜æ”¾çš„ (äºŒ) registry å­˜å‚¨ ğŸ™„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#registry-x2F-registry-x2F-docker-x2F-v2"><span class="nav-number">5.1.</span> <span class="nav-text">registry (&#x2F;registry&#x2F;docker&#x2F;v2)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#blobs-%E7%9B%AE%E5%BD%95"><span class="nav-number">5.2.</span> <span class="nav-text">blobs ç›®å½•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-archive"><span class="nav-number">5.3.</span> <span class="nav-text">docker-archive</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E6%98%AF%E6%80%8E%E4%B9%88%E9%A3%9F%E7%94%A8%E7%9A%84-%F0%9F%98%8B"><span class="nav-number">6.</span> <span class="nav-text">é•œåƒæ˜¯æ€ä¹ˆé£Ÿç”¨çš„ ğŸ˜‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-run"><span class="nav-number">6.1.</span> <span class="nav-text">docker run</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">7.</span> <span class="nav-text">å‚è€ƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3"><span class="nav-number">7.1.</span> <span class="nav-text">å®˜æ–¹æ–‡æ¡£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81"><span class="nav-number">7.2.</span> <span class="nav-text">æºç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%9A%E5%AE%A2"><span class="nav-number">7.3.</span> <span class="nav-text">åšå®¢</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">117</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">152</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail â†’ mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/Exploring-container-image.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”ŸğŸ¤” | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”ŸğŸ¤”
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-06-14 2020-06-14T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2020-06-14T00:00:00+08:00">2020-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/Exploring-container-image.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Exploring-container-image.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>45k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>41 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>ä¸Šå‘¨åœ¨å†™<a href="https://blog.k8s.li/skopeo.html">ã€Šé•œåƒæ¬è¿å·¥ skopeo ã€‹</a> çš„æ—¶å€™çœ‹äº†å¾ˆå¤šå…³äºå®¹å™¨é•œåƒç›¸å…³çš„åšå®¢ï¼Œä»å¤§ä½¬ä»¬é‚£é‡Œå·å·å­¦äº†ä¸å°‘çŸ¥è¯†ï¼Œå¯¹å®¹å™¨é•œåƒæœ‰äº†ä¸€ç‚¹ç‚¹æ·±å…¥çš„äº†è§£ã€‚è¿™å‘¨æœ«ä¸€ä¸ªäººé—²ç€å®…åœ¨å®¶é‡Œæ²¡äº‹å°±æŠŠæœ€è¿‘æ‰€å­¦çš„çŸ¥è¯†æ•´ç†ä¸€ä¸‹åˆ†äº«å‡ºæ¥ï¼Œä¾›å¤§å®¶ä¸€èµ·æ¥é£Ÿç”¨ã€‚å†…å®¹æ¯”è¾ƒå¤šï¼Œè€å¿ƒçœ‹å®Œçš„è¯ï¼Œè¿˜æ˜¯èƒ½æ”¶è·ä¸€äº›<del>æ²¡ç”¨çš„</del>çŸ¥è¯†æ»´ ğŸ˜‚ã€‚</p>
<h2 id="æ›´æ–°è®°å½•"><a href="#æ›´æ–°è®°å½•" class="headerlink" title="æ›´æ–°è®°å½•"></a>æ›´æ–°è®°å½•</h2><ul>
<li>2020-06-13ï¼šè¿˜æœ‰ä¸€äº›æ²¡æœ‰å†™å®Œï¼Œåç»­è¡¥å……</li>
<li>2020-06-06ï¼šåˆç¨¿</li>
<li>2020-09-02ï¼šè¡¥å……</li>
</ul>
<h2 id="é•œåƒæ˜¯æ€æ ·ç‚¼æˆçš„-ğŸ¤”"><a href="#é•œåƒæ˜¯æ€æ ·ç‚¼æˆçš„-ğŸ¤”" class="headerlink" title="é•œåƒæ˜¯æ€æ ·ç‚¼æˆçš„ ğŸ¤”"></a>é•œåƒæ˜¯æ€æ ·ç‚¼æˆçš„ ğŸ¤”</h2><p>æ‰€è°“ç‚¼æˆåƒå°±æ˜¯æ„å»ºé•œåƒå•¦ï¼Œä¸‹é¢ç”¨åˆ°çš„<strong>æ“</strong>å’Œ<strong>ç‚¼åˆ¶</strong>éƒ½æ˜¯æŒ‡çš„æ„å»ºé•œåƒå•¦ï¼Œåªæ˜¯ä¸ªäººä¹ æƒ¯ç”¨è¯­è€Œå·² ğŸ˜‚ã€‚</p>
<p>æåˆ°å®¹å™¨é•œåƒå°±ä¸å¾—ä¸æä¸€ä¸‹ OCI ï¼Œå³ Open Container Initiative æ—¨åœ¨å›´ç»•å®¹å™¨æ ¼å¼å’Œè¿è¡Œæ—¶åˆ¶å®šä¸€ä¸ªå¼€æ”¾çš„å·¥ä¸šåŒ–æ ‡å‡†ã€‚ç›®å‰ OCI ä¸»è¦æœ‰ä¸‰ä¸ªè§„èŒƒï¼šè¿è¡Œæ—¶è§„èŒƒ <a target="_blank" rel="noopener" href="https://github.com/opencontainers/runtime-spec">runtime-spec</a> ï¼Œé•œåƒè§„èŒƒ <a target="_blank" rel="noopener" href="http://www.github.com/opencontainers/image-spec">image-spec</a> ä»¥åŠä¸å¸¸è§çš„é•œåƒä»“åº“è§„èŒƒ <a target="_blank" rel="noopener" href="https://github.com/opencontainers/distribution-spec">distribution-spec</a> ã€‚å…³äº OCI è¿™äº›è§„èŒƒçš„ä½œç”¨çš„ä½œç”¨ï¼Œå°±å¼•ç”¨ä¸€ä¸‹ <a target="_blank" rel="noopener" href="https://wilhelmguo.cn/blog/post/william/%E5%AE%B9%E5%99%A8%E5%BC%80%E6%94%BE%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83%EF%BC%88CRI-OCI%EF%BC%89-2">å®¹å™¨å¼€æ”¾æ¥å£è§„èŒƒï¼ˆCRI OCIï¼‰</a> ä¸­çš„å†…å®¹ï¼Œæˆ‘ä¹Ÿå°±æ‡’å¾—è‡ªå·±ç»„ç»‡è¯­è¨€çŒæ°´äº† ğŸ˜‚ï¼ˆå‡‘å­—æ•°</p>
<blockquote>
<p>åˆ¶å®šå®¹å™¨æ ¼å¼æ ‡å‡†çš„å®—æ—¨æ¦‚æ‹¬æ¥è¯´å°±æ˜¯ä¸å—ä¸Šå±‚ç»“æ„çš„ç»‘å®šï¼Œå¦‚ç‰¹å®šçš„å®¢æˆ·ç«¯ã€ç¼–æ’æ ˆç­‰ï¼ŒåŒæ—¶ä¹Ÿä¸å—ç‰¹å®šçš„ä¾›åº”å•†æˆ–é¡¹ç›®çš„ç»‘å®šï¼Œå³ä¸é™äºæŸç§ç‰¹å®šæ“ä½œç³»ç»Ÿã€ç¡¬ä»¶ã€CPU æ¶æ„ã€å…¬æœ‰äº‘ç­‰ã€‚</p>
<p>è¿™ä¸¤ä¸ªåè®®é€šè¿‡ OCI runtime filesytem bundle çš„æ ‡å‡†æ ¼å¼è¿æ¥åœ¨ä¸€èµ·ï¼ŒOCI é•œåƒå¯ä»¥é€šè¿‡å·¥å…·è½¬æ¢æˆ bundleï¼Œç„¶å OCI å®¹å™¨å¼•æ“èƒ½å¤Ÿè¯†åˆ«è¿™ä¸ª bundle æ¥è¿è¡Œå®¹å™¨</p>
<ul>
<li>æ“ä½œæ ‡å‡†åŒ–ï¼šå®¹å™¨çš„æ ‡å‡†åŒ–æ“ä½œåŒ…æ‹¬ä½¿ç”¨æ ‡å‡†å®¹å™¨åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢å®¹å™¨ï¼Œä½¿ç”¨æ ‡å‡†æ–‡ä»¶ç³»ç»Ÿå·¥å…·å¤åˆ¶å’Œåˆ›å»ºå®¹å™¨å¿«ç…§ï¼Œä½¿ç”¨æ ‡å‡†åŒ–ç½‘ç»œå·¥å…·è¿›è¡Œä¸‹è½½å’Œä¸Šä¼ ã€‚</li>
<li>å†…å®¹æ— å…³ï¼šå†…å®¹æ— å…³æŒ‡ä¸ç®¡é’ˆå¯¹çš„å…·ä½“å®¹å™¨å†…å®¹æ˜¯ä»€ä¹ˆï¼Œå®¹å™¨æ ‡å‡†æ“ä½œæ‰§è¡Œåéƒ½èƒ½äº§ç”ŸåŒæ ·çš„æ•ˆæœã€‚å¦‚å®¹å™¨å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼ä¸Šä¼ ã€å¯åŠ¨ï¼Œä¸ç®¡æ˜¯ PHP åº”ç”¨è¿˜æ˜¯ MySQL æ•°æ®åº“æœåŠ¡ã€‚</li>
<li>åŸºç¡€è®¾æ–½æ— å…³ï¼šæ— è®ºæ˜¯ä¸ªäººçš„ç¬”è®°æœ¬ç”µè„‘è¿˜æ˜¯ AWS S3ï¼Œäº¦æˆ–æ˜¯ OpenStackï¼Œæˆ–è€…å…¶å®ƒåŸºç¡€è®¾æ–½ï¼Œéƒ½åº”è¯¥å¯¹æ”¯æŒå®¹å™¨çš„å„é¡¹æ“ä½œã€‚</li>
<li>ä¸ºè‡ªåŠ¨åŒ–é‡èº«å®šåˆ¶ï¼šåˆ¶å®šå®¹å™¨ç»Ÿä¸€æ ‡å‡†ï¼Œæ˜¯çš„æ“ä½œå†…å®¹æ— å…³åŒ–ã€å¹³å°æ— å…³åŒ–çš„æ ¹æœ¬ç›®çš„ä¹‹ä¸€ï¼Œå°±æ˜¯ä¸ºäº†å¯ä»¥ä½¿å®¹å™¨æ“ä½œå…¨å¹³å°è‡ªåŠ¨åŒ–ã€‚</li>
<li>å·¥ä¸šçº§äº¤ä»˜ï¼šåˆ¶å®šå®¹å™¨æ ‡å‡†ä¸€å¤§ç›®æ ‡ï¼Œå°±æ˜¯ä½¿è½¯ä»¶åˆ†å‘å¯ä»¥è¾¾åˆ°å·¥ä¸šçº§äº¤ä»˜æˆä¸ºç°å®</li>
</ul>
</blockquote>
<p>å…¶å® OCI è§„èŒƒå°±æ˜¯ä¸€å † markdown æ–‡ä»¶å•¦ï¼Œå†…å®¹ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼Œä¸åƒ RFC å’Œ ISO é‚£ä¹ˆé«˜æ·±è«æµ‹ï¼Œæ‰€ä»¥æ±æƒ³å¯¹å®¹å™¨é•œåƒæœ‰ä¸ªæ·±å…¥çš„äº†è§£è¿˜æ˜¯æ¨èå¤§å®¶å»è¯»ä¸€ä¸‹è¿™äº› markdown æ–‡ä»¶ ğŸ˜‚ã€‚OCI è§„èŒƒæ˜¯å…è´¹çš„å“¦ï¼Œä¸åƒå¤§å¤šæ•° ISO è§„èŒƒè¿˜è¦äº¤é’±æ‰èƒ½çœ‹ï¼ˆï¸¶^ï¸¶ï¼‰å“¼ã€‚</p>
<h3 id="OCI-image-spec"><a href="#OCI-image-spec" class="headerlink" title="OCI image-spec"></a>OCI image-spec</h3><p>OCI è§„èŒƒä¸­çš„é•œåƒè§„èŒƒ <a target="_blank" rel="noopener" href="http://www.github.com/opencontainers/image-spec">image-spec</a> å†³å®šäº†æˆ‘ä»¬çš„é•œåƒæŒ‰ç…§ä»€ä¹ˆæ ‡å‡†æ¥æ„å»ºï¼Œä»¥åŠæ„å»ºå®Œé•œåƒä¹‹åå¦‚ä½•å­˜æ”¾ï¼Œæ¥ç€ä¸‹æ–‡æåˆ°çš„ Dockerfile åˆ™å†³å®šäº†é•œåƒçš„ layer å†…å®¹ä»¥åŠé•œåƒçš„ä¸€äº›å…ƒæ•°æ®ä¿¡æ¯ã€‚ä¸€ä¸ªé•œåƒè§„èŒƒ image-spec å’Œä¸€ä¸ª Dockerfile å°±æŒ‡å¯¼ç€æˆ‘ä»¬æ„å»ºä¸€ä¸ªé•œåƒï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±ç®€å•äº†è§£ä¸€ä¸‹è¿™ä¸ªé•œåƒè§„èŒƒï¼Œçœ‹çœ‹é•œåƒæ˜¯é•¿ä»€ä¹ˆæ ·å­çš„ï¼Œå¯¹é•œåƒæœ‰ä¸ªå¤§ä½“çš„ä¸»è§‚è®¤è¯†ã€‚</p>
<p>æ ¹æ®å®˜æ–¹æ–‡æ¡£çš„æè¿°ï¼ŒOCI é•œåƒè§„èŒƒçš„ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ª markdown æ–‡ä»¶ç»„æˆï¼š</p>
<blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/manifest.md">Image Manifest</a> - a document describing the components that make up a container image</li>
<li><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/image-index.md">Image Index</a> - an annotated index of image manifests</li>
<li><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/image-layout.md">Image Layout</a> - a filesystem layout representing the contents of an image</li>
<li><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/layer.md">Filesystem Layer</a> - a changeset that describes a containerâ€™s filesystem</li>
<li><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/config.md">Image Configuration</a> - a document determining layer ordering and configuration of the image suitable for translation into a <a target="_blank" rel="noopener" href="https://github.com/opencontainers/runtime-spec">runtime bundle</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/conversion.md">Conversion</a> - a document describing how this translation should occur</li>
<li><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/descriptor.md">Descriptor</a> - a reference that describes the type, metadata and content address of referenced content</li>
</ul>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â”œâ”€â”€ annotations.md         <span class="token comment"># æ³¨è§£è§„èŒƒ</span>
â”œâ”€â”€ config.md              <span class="token comment"># image config æ–‡ä»¶è§„èŒƒ</span>
â”œâ”€â”€ considerations.md      <span class="token comment"># æ³¨æ„äº‹é¡¹</span>
â”œâ”€â”€ conversion.md          <span class="token comment"># è½¬æ¢ä¸º OCI è¿è¡Œæ—¶</span>
â”œâ”€â”€ descriptor.md          <span class="token comment"># OCI Content Descriptors å†…å®¹æè¿°</span>
â”œâ”€â”€ image-index.md         <span class="token comment"># manifest list æ–‡ä»¶</span>
â”œâ”€â”€ image-layout.md        <span class="token comment"># é•œåƒçš„å¸ƒå±€</span>
â”œâ”€â”€ implementations.md     <span class="token comment"># ä½¿ç”¨ OCI è§„èŒƒçš„é¡¹ç›®</span>
â”œâ”€â”€ layer.md               <span class="token comment"># é•œåƒå±‚ layer è§„èŒƒ</span>
â”œâ”€â”€ manifest.md            <span class="token comment"># manifest è§„èŒƒ</span>
â”œâ”€â”€ media-types.md         <span class="token comment"># æ–‡ä»¶ç±»å‹</span>
â”œâ”€â”€ README.md              <span class="token comment"># README æ–‡æ¡£</span>
â”œâ”€â”€ spec.md                <span class="token comment"># OCI é•œåƒè§„èŒƒçš„æ¦‚è§ˆ</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ€»ç»“ä»¥ä¸Šå‡ ä¸ª markdown æ–‡ä»¶ï¼Œ OCI å®¹å™¨é•œåƒè§„èŒƒä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ å—å†…å®¹ï¼š</p>
<h4 id="layer"><a href="#layer" class="headerlink" title="layer"></a>layer</h4><p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/layer.md">æ–‡ä»¶ç³»ç»Ÿ</a>ï¼šä»¥ layer ï¼ˆé•œåƒå±‚ï¼‰ä¿å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯ä¸ª layer ä¿å­˜äº†å’Œä¸Šå±‚ä¹‹é—´å˜åŒ–çš„éƒ¨åˆ†ï¼Œlayer åº”è¯¥ä¿å­˜å“ªäº›æ–‡ä»¶ï¼Œæ€ä¹ˆè¡¨ç¤ºå¢åŠ ã€ä¿®æ”¹å’Œåˆ é™¤çš„æ–‡ä»¶ç­‰ã€‚</p>
<h4 id="image-config"><a href="#image-config" class="headerlink" title="image config"></a>image config</h4><p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/config.md">image config æ–‡ä»¶</a>ï¼šä¿å­˜äº†æ–‡ä»¶ç³»ç»Ÿçš„å±‚çº§ä¿¡æ¯ï¼ˆæ¯ä¸ªå±‚çº§çš„ hash å€¼ï¼Œä»¥åŠå†å²ä¿¡æ¯ï¼‰ï¼Œä»¥åŠå®¹å™¨è¿è¡Œæ—¶éœ€è¦çš„ä¸€äº›ä¿¡æ¯ï¼ˆæ¯”å¦‚ç¯å¢ƒå˜é‡ã€å·¥ä½œç›®å½•ã€å‘½ä»¤å‚æ•°ã€mount åˆ—è¡¨ï¼‰ï¼ŒæŒ‡å®šäº†é•œåƒåœ¨æŸä¸ªç‰¹å®šå¹³å°å’Œç³»ç»Ÿçš„é…ç½®ï¼Œæ¯”è¾ƒæ¥è¿‘æˆ‘ä»¬ä½¿ç”¨ <code>docker inspect &lt;image_id&gt;</code> çœ‹åˆ°çš„å†…å®¹ã€‚</p>
<ul>
<li>example</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>
  <span class="token property">"config"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"Hostname"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"Domainname"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"User"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"AttachStdin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"AttachStdout"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"AttachStderr"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"Tty"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"OpenStdin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"StdinOnce"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"Env"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"Cmd"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"bash"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"Image"</span><span class="token operator">:</span> <span class="token string">"sha256:ba8f577813c7bdf6b737f638dffbc688aa1df2ff28a826a6c46bae722977b549"</span><span class="token punctuation">,</span>
    <span class="token property">"Volumes"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"WorkingDir"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"Entrypoint"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"OnBuild"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"Labels"</span><span class="token operator">:</span> <span class="token null keyword">null</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"container"</span><span class="token operator">:</span> <span class="token string">"38501d5aa48c080884f4dc6fd4b1b6590ff1607d9e7a12e1cef1d86a3fdc32df"</span><span class="token punctuation">,</span>
  <span class="token property">"container_config"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"Hostname"</span><span class="token operator">:</span> <span class="token string">"38501d5aa48c"</span><span class="token punctuation">,</span>
    <span class="token property">"Domainname"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"User"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"AttachStdin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"AttachStdout"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"AttachStderr"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"Tty"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"OpenStdin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"StdinOnce"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"Env"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"Cmd"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"/bin/sh"</span><span class="token punctuation">,</span>
      <span class="token string">"-c"</span><span class="token punctuation">,</span>
      <span class="token string">"#(nop) "</span><span class="token punctuation">,</span>
      <span class="token string">"CMD [\"bash\"]"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"Image"</span><span class="token operator">:</span> <span class="token string">"sha256:ba8f577813c7bdf6b737f638dffbc688aa1df2ff28a826a6c46bae722977b549"</span><span class="token punctuation">,</span>
    <span class="token property">"Volumes"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"WorkingDir"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"Entrypoint"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"OnBuild"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"Labels"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"2020-06-07T01:59:47.348924716Z"</span><span class="token punctuation">,</span>
  <span class="token property">"docker_version"</span><span class="token operator">:</span> <span class="token string">"19.03.5"</span><span class="token punctuation">,</span>
  <span class="token property">"history"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"2020-06-07T01:59:46.877600299Z"</span><span class="token punctuation">,</span>
      <span class="token property">"created_by"</span><span class="token operator">:</span> <span class="token string">"/bin/sh -c #(nop) ADD file:a82014afc29e7b364ac95223b22ebafad46cc9318951a85027a49f9ce1a99461 in / "</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"2020-06-07T01:59:47.348924716Z"</span><span class="token punctuation">,</span>
      <span class="token property">"created_by"</span><span class="token operator">:</span> <span class="token string">"/bin/sh -c #(nop)  CMD [\"bash\"]"</span><span class="token punctuation">,</span>
      <span class="token property">"empty_layer"</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>
  <span class="token property">"rootfs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"layers"</span><span class="token punctuation">,</span>
    <span class="token property">"diff_ids"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"sha256:d1b85e6186f67d9925c622a7a6e66faa447e767f90f65ae47cdc817c629fa956"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="manifest"><a href="#manifest" class="headerlink" title="manifest"></a>manifest</h4><p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/manifest.md">manifest æ–‡ä»¶</a> ï¼šé•œåƒçš„ config æ–‡ä»¶ç´¢å¼•ï¼Œæœ‰å“ªäº› layerï¼Œé¢å¤–çš„ annotation ä¿¡æ¯ï¼Œmanifest æ–‡ä»¶ä¸­ä¿å­˜äº†å¾ˆå¤šå’Œå½“å‰å¹³å°æœ‰å…³çš„ä¿¡æ¯ã€‚å¦å¤– manifest ä¸­çš„ layer å’Œ config ä¸­çš„ layer è¡¨è¾¾çš„è™½ç„¶éƒ½æ˜¯é•œåƒçš„ layer ï¼Œä½†äºŒè€…ä»£è¡¨çš„æ„ä¹‰ä¸å¤ªä¸€æ ·ï¼Œç¨åä¼šè®²åˆ°ã€‚manifest æ–‡ä»¶æ˜¯å­˜æ”¾åœ¨ registry ä¸­ï¼Œå½“æˆ‘ä»¬æ‹‰å–é•œåƒçš„æ—¶å€™ï¼Œä¼šæ ¹æ®è¯¥æ–‡ä»¶æ‹‰å–ç›¸åº”çš„ layer ã€‚æ ¹æ® OCI image-spec è§„èŒƒä¸­ <a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/manifest.md">OCI Image Manifest Specification</a> çš„å®šä¹‰å¯ä»¥å¾—çŸ¥ï¼Œé•œåƒçš„ manifest æ–‡ä»¶ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªç›®æ ‡ï¼šï¼ˆè‹±è¯­ä¸å¥½å°±ä¸ç¿»è¯‘äº† ğŸ˜¥</p>
<blockquote>
<p>There are three main goals of the Image Manifest Specification.</p>
<ul>
<li>The first goal is content-addressable images, by supporting an image model where the imageâ€™s configuration can be hashed to generate a unique ID for the image and its components.</li>
<li>The second goal is to allow multi-architecture images, through a â€œfat manifestâ€ which references image manifests for platform-specific versions of an image. In OCI, this is codified in an <a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/image-index.md">image index</a>.</li>
<li>The third goal is to be <a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/conversion.md">translatable</a> to the <a target="_blank" rel="noopener" href="https://github.com/opencontainers/runtime-spec">OCI Runtime Specification</a>.</li>
</ul>
</blockquote>
<p>å¦å¤– manifest ä¹Ÿåˆ†å¥½å‡ ä¸ªç‰ˆæœ¬ï¼Œç›®å‰ä¸»æµçš„ç‰ˆæœ¬æ˜¯  <code>Manifest Version 2, Schema 2</code> ï¼Œå¯ä»¥å‚è€ƒ docker çš„å®˜æ–¹æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://github.com/docker/distribution/blob/master/docs/spec/manifest-v2-2.md">Image Manifest Version 2, Schema 2</a> ã€‚registry ä¸­ä¼šæœ‰ä¸ª <code>Manifest List </code> æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æ˜¯ä¸ºä¸åŒå¤„ç†å™¨ä½“ç³»æ¶æ„è€Œè®¾è®¡çš„ï¼Œé€šè¿‡è¯¥æ–‡ä»¶æŒ‡å‘ä¸è¯¥å¤„ç†å™¨ä½“ç³»æ¶æ„ç›¸å¯¹åº”çš„ Image Manifest ï¼Œè¿™ä¸€ç‚¹ä¸è¦ææ··ã€‚</p>
<ul>
<li>Example Manifest List</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"schemaVersion"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.list.v2+json"</span><span class="token punctuation">,</span>
  <span class="token property">"manifests"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">7143</span><span class="token punctuation">,</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"ppc64le"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">7682</span><span class="token punctuation">,</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:5b0bcabd1ed22e9fb1310cf6c2dec7cdef19f0ad69efa1f392e94a4333501270"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>
        <span class="token property">"features"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">"sse4"</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Image Manifest</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">&#123;</span>
  <span class="token string">"schemaVersion"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
  <span class="token string">"mediaType"</span><span class="token builtin class-name">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span>,
  <span class="token string">"config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"mediaType"</span><span class="token builtin class-name">:</span> <span class="token string">"application/vnd.docker.container.image.v1+json"</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">1509</span>,
    <span class="token string">"digest"</span><span class="token builtin class-name">:</span> <span class="token string">"sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"layers"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token string">"mediaType"</span><span class="token builtin class-name">:</span> <span class="token string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span>,
      <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">5844992</span>,
      <span class="token string">"digest"</span><span class="token builtin class-name">:</span> <span class="token string">"sha256:50644c29ef5a27c9a40c393a73ece2479de78325cae7d762ef3cdc19bf42dd0a"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æœ€åå†è¡¥å……ä¸€æ®µé«˜ç­–å¤§ä½¬çš„ <a target="_blank" rel="noopener" href="http://gaocegege.com/Blog/ormb">è§£é‡Š</a> ï¼š</p>
<blockquote>
<p>Manifest æ˜¯ä¸€ä¸ª JSON æ–‡ä»¶ï¼Œå…¶å®šä¹‰åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ <a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/config.md">Config</a> å’Œ <a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/layer.md">Layers</a>ã€‚Config æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼ŒLayers æ˜¯ä¸€ä¸ªç”± JSON å¯¹è±¡ç»„æˆçš„æ•°ç»„ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒConfig ä¸ Layers ä¸­çš„æ¯ä¸€ä¸ªå¯¹è±¡çš„ç»“æ„ç›¸åŒï¼Œéƒ½åŒ…æ‹¬ä¸‰ä¸ªå­—æ®µï¼Œåˆ†åˆ«æ˜¯ digestã€mediaType å’Œ sizeã€‚å…¶ä¸­ digest å¯ä»¥ç†è§£ä¸ºæ˜¯è¿™ä¸€å¯¹è±¡çš„ IDã€‚mediaType è¡¨æ˜äº†è¿™ä¸€å†…å®¹çš„ç±»å‹ã€‚size æ˜¯è¿™ä¸€å†…å®¹çš„å¤§å°ã€‚</p>
<p>å®¹å™¨é•œåƒçš„ Config æœ‰ç€å›ºå®šçš„ mediaType <code>application/vnd.oci.image.config.v1+json</code>ã€‚ä¸€ä¸ª Config çš„ç¤ºä¾‹é…ç½®å¦‚ä¸‹ï¼Œå®ƒè®°å½•äº†å…³äºå®¹å™¨é•œåƒçš„é…ç½®ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯é•œåƒçš„å…ƒæ•°æ®ã€‚é€šå¸¸å®ƒä¼šè¢«é•œåƒä»“åº“ç”¨æ¥åœ¨ UI ä¸­å±•ç¤ºä¿¡æ¯ï¼Œä»¥åŠåŒºåˆ†ä¸åŒæ“ä½œç³»ç»Ÿçš„æ„å»ºç­‰ã€‚</p>
<p>è€Œå®¹å™¨é•œåƒçš„ Layers æ˜¯ç”±å¤šå±‚ mediaType ä¸º <code>application/vnd.oci.image.layer.v1.*</code>ï¼ˆå…¶ä¸­æœ€å¸¸è§çš„æ˜¯ <code>application/vnd.oci.image.layer.v1.tar+gzip</code>) çš„å†…å®¹ç»„æˆçš„ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œå®¹å™¨é•œåƒæ˜¯åˆ†å±‚æ„å»ºçš„ï¼Œæ¯ä¸€å±‚å°±å¯¹åº”ç€ Layers ä¸­çš„ä¸€ä¸ªå¯¹è±¡ã€‚</p>
<p>å®¹å™¨é•œåƒçš„ Configï¼Œå’Œ Layers ä¸­çš„æ¯ä¸€å±‚ï¼Œéƒ½æ˜¯ä»¥ Blob çš„æ–¹å¼å­˜å‚¨åœ¨é•œåƒä»“åº“ä¸­çš„ï¼Œå®ƒä»¬çš„ digest ä½œä¸º Key å­˜åœ¨ã€‚å› æ­¤ï¼Œåœ¨è¯·æ±‚åˆ°é•œåƒçš„ Manifest åï¼ŒDocker ä¼šåˆ©ç”¨ digest å¹¶è¡Œä¸‹è½½æ‰€æœ‰çš„ Blobsï¼Œå…¶ä¸­å°±åŒ…æ‹¬ Config å’Œæ‰€æœ‰çš„ Layersã€‚</p>
</blockquote>
<h4 id="image-manifest-index"><a href="#image-manifest-index" class="headerlink" title="image manifest index"></a>image manifest index</h4><p><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/image-index.md">index æ–‡ä»¶</a> ï¼šå…¶å®å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„ Manifest List å•¦ã€‚åœ¨ docker çš„ <a target="_blank" rel="noopener" href="https://github.com/docker/distribution">distribution</a> ä¸­ç§°ä¹‹ä¸º <code>Manifest List</code> åœ¨ OCI ä¸­å°±å« <a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/image-index.md">OCI Image Index Specification</a> ã€‚å…¶å®ä¸¤è€…æ˜¯æŒ‡çš„åŒä¸€ä¸ªæ–‡ä»¶ï¼Œç”šè‡³ä¸¤è€… GitHub ä¸Šæ–‡æ¡£ç»™çš„ example éƒ½ä¸€ä¸€æ¨¡æ · ğŸ¤£ï¼Œåº”è¯¥æ˜¯ OCI å¤åˆ¶ç²˜è´´ Docker çš„æ–‡æ¡£ ğŸ˜‚ã€‚index æ–‡ä»¶æ˜¯ä¸ªå¯é€‰çš„æ–‡ä»¶ï¼ŒåŒ…å«ç€ä¸€ä¸ªåˆ—è¡¨ä¸ºåŒä¸€ä¸ªé•œåƒä¸åŒçš„å¤„ç†å™¨ arch æŒ‡å‘ä¸åŒå¹³å°çš„ manifest æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶èƒ½ä¿è¯ä¸€ä¸ªé•œåƒå¯ä»¥è·¨å¹³å°ä½¿ç”¨ï¼Œæ¯ä¸ªå¤„ç†å™¨ arch å¹³å°æ‹¥æœ‰ä¸åŒçš„ manifest æ–‡ä»¶ï¼Œä½¿ç”¨ index ä½œä¸ºç´¢å¼•ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ arm æ¶æ„çš„å¤„ç†å™¨æ—¶è¦é¢å¤–æ³¨æ„ï¼Œåœ¨æ‹‰å–é•œåƒçš„æ—¶å€™è¦æ‹‰å– arm æ¶æ„çš„é•œåƒï¼Œä¸€èˆ¬å¤„ç†å™¨çš„æ¶æ„éƒ½æ¥åœ¨é•œåƒçš„ tag åé¢ï¼Œé»˜è®¤ latest tag çš„é•œåƒæ˜¯ x86 çš„ï¼Œåœ¨ arm å¤„ç†å™¨çš„æœºå™¨è¿™äº›é•œåƒä¸Šæ˜¯è·‘ä¸èµ·æ¥çš„ã€‚</p>
<h3 id="å„ç§-id-åˆ†ä¸æ¸…ï¼Ÿ"><a href="#å„ç§-id-åˆ†ä¸æ¸…ï¼Ÿ" class="headerlink" title="å„ç§ id åˆ†ä¸æ¸…ï¼Ÿ"></a>å„ç§ id åˆ†ä¸æ¸…ï¼Ÿ</h3><p>çœ‹å®Œ  <a target="_blank" rel="noopener" href="http://www.github.com/opencontainers/image-spec">image-spec</a> é‡Œé¢æåˆ°çš„å„ç§ id ç›¸ä¿¡ä½ åˆå¾ˆå¤šç–‘æƒ‘ï¼Œåœ¨æ­¤æ€»ç»“ä¸€ä¸‹è¿™äº› id çš„ä½œç”¨ï¼š</p>
<table>
<thead>
<tr>
<th align="center">image-id</th>
<th>image config çš„ sha256 å“ˆå¸Œå€¼ï¼Œåœ¨æœ¬åœ°é•œåƒå­˜å‚¨ä¸­ç”±å®ƒå”¯ä¸€æ ‡è¯†ä¸€ä¸ªé•œåƒ</th>
</tr>
</thead>
<tbody><tr>
<td align="center">image digest</td>
<td>åœ¨ registry ä¸­çš„ image manifest çš„ sha256 å“ˆå¸Œå€¼ï¼Œåœ¨ registry ä¸­ç”±å®ƒå”¯ä¸€æ ‡è¯†ä¸€ä¸ªé•œåƒ</td>
</tr>
<tr>
<td align="center">diff_ids</td>
<td>é•œåƒæ¯ä¸€å±‚çš„ id ï¼Œæ˜¯å¯¹ layer çš„æœªå‹ç¼©çš„ tar åŒ…çš„ sha256 å“ˆå¸Œå€¼</td>
</tr>
<tr>
<td align="center">layer digest</td>
<td>é•œåƒåœ¨ registry å­˜å‚¨ä¸­çš„ id ï¼Œæ˜¯å¯¹ layer å‹ç¼©åçš„ tar åŒ…çš„ sha256 å“ˆå¸Œå€¼</td>
</tr>
</tbody></table>
<p>é•œåƒçš„ image config ä¸­çš„ <code>rootfs</code> å­—æ®µè®°å½•äº†æ¯ä¸€å±‚ layer çš„ idï¼Œè€Œé•œåƒçš„ layer id åˆ™æ˜¯ layer tar åŒ…çš„ sha256 å€¼ï¼Œå¦‚æœé•œåƒçš„ layer æ”¹å˜ï¼Œåˆ™è¿™ä¸ª layer id ä¼šæ”¹å˜ï¼Œè€Œè®°å½•å®ƒçš„ image config å†…å®¹ä¹Ÿä¼šæ”¹å˜ï¼Œimage config å†…å®¹å˜äº†ï¼Œimage config æ–‡ä»¶çš„ sha256 å€¼ä¹Ÿå°±ä¼šæ”¹å˜ï¼Œè¿™æ ·å°±å¯ä»¥ç”± image id å’Œ image digest å”¯ä¸€æ ‡è¯†ä¸€ä¸ªé•œåƒï¼Œè¾¾åˆ°é˜²æ²»ç¯¡æ”¹çš„å®‰å…¨ç›®çš„ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token property">"rootfs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"layers"</span><span class="token punctuation">,</span>
    <span class="token property">"diff_ids"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"sha256:d1b85e6186f67d9925c622a7a6e66faa447e767f90f65ae47cdc817c629fa956"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>ä¼—æ‰€å‘¨çŸ¥ docker é•œåƒéœ€è¦ä¸€ä¸ª Dockerfile æ¥æ„å»ºè€Œæˆï¼Œå½“æˆ‘ä»¬å¯¹ OCI é•œåƒè§„èŒƒæœ‰äº†ä¸ªå¤§è‡´çš„äº†è§£ä¹‹åï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±æ‹¿ç€ Dockerfile è¿™ä¸ª â€å›¾çº¸â€œ å»ä¸€æ­¥æ­¥æ„å»ºé•œåƒã€‚æœ¬æ–‡ä¸å†ç»†è®² Dockerfile çš„è¯¦ç»†ä¹¦å†™å’ŒæŠ€å·§ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šä¼—æ‰€å‘¨çŸ¥çš„å…³äºå†™å¥½ Dockerfile çš„æŠ€å·§ï¼Œæ¯”å¦‚æˆ‘ä¹‹å‰æ°´è¿‡çš„ä¸€ç¯‡ <a href="https://blog.k8s.li/dockerfile-tips.html">Dockerfile æ“é•œåƒçš„å°æŠ€å·§</a> ã€‚</p>
<p>ä¸‹é¢å°±æ˜¯ <a target="_blank" rel="noopener" href="https://webp.sh/">webp server go</a> Dockerfile çš„ä¾‹å­ï¼š</p>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> golang:alpine <span class="token keyword">as</span> builder</span>
<span class="token instruction"><span class="token keyword">ARG</span> IMG_PATH=/opt/pics</span>
<span class="token instruction"><span class="token keyword">ARG</span> EXHAUST_PATH=/opt/exhaust</span>
<span class="token instruction"><span class="token keyword">RUN</span> apk update ;<span class="token operator">\</span>
    apk add alpine-sdk ;<span class="token operator">\</span>
    git clone https://github.com/webp-sh/webp_server_go /build ;<span class="token operator">\</span>
    cd /build ;<span class="token operator">\</span>
    sed -i <span class="token string">"s|.\/pics|$&#123;IMG_PATH&#125;|g"</span> config.json ;<span class="token operator">\</span>
    sed -i <span class="token string">"s|\"\"|\"$&#123;EXHAUST_PATH&#125;\"|g"</span> config.json ;<span class="token operator">\</span>
    sed -i <span class="token string">'s/127.0.0.1/0.0.0.0/g'</span> config.json</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /build</span>
<span class="token instruction"><span class="token keyword">RUN</span> go build -o webp-server .</span>

<span class="token instruction"><span class="token keyword">FROM</span> alpine</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /build/webp-server  /usr/bin/webp-server</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /build/config.json /etc/config.json</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /opt</span>
<span class="token instruction"><span class="token keyword">VOLUME</span> /opt/exhaust</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"/usr/bin/webp-server"</span>, <span class="token string">"--config"</span>, <span class="token string">"/etc/config.json"</span>]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ RUN æŒ‡ä»¤çš„æ¯è¡Œç»“å°¾æˆ‘ä½¿ç”¨çš„æ˜¯ <code>;\</code> æ¥æ¥ä¸‹ä¸€è¡Œ shell ï¼Œå¦ä¸€ç§å†™æ³•æ˜¯ <code>&amp;&amp;</code> ã€‚äºŒè€…æœ‰æœ¬è´¨çš„åŒºåˆ«ï¼Œæ¯”å¦‚ COMMAND 1;COMMAND 2 ï¼Œå½“ COMMAND 1 è¿è¡Œå¤±è´¥æ—¶ä¼šç»§ç»­è¿è¡Œ COMMAND2 ï¼Œå¹¶ä¸ä¼šé€€å‡ºã€‚è€Œ COMMAND 1&amp;&amp; COMMAND 2ï¼Œæ—¶ COMMAND 1 è¿è¡ŒæˆåŠŸæ—¶æ‰æ¥ç€è¿è¡Œ COMMAND 2 ï¼ŒCOMMAND 1 è¿è¡Œå¤±è´¥ä¼šé€€å‡ºã€‚å¦‚æœæ²¡æœ‰åè¶³çš„æŠŠæ¡ä¿è¯æ¯ä¸€è¡Œ shell éƒ½èƒ½æ¯æ¬¡è¿è¡ŒæˆåŠŸå»ºè®®ç”¨ <code>&amp;&amp;</code> ï¼Œè¿™æ ·å¤±è´¥äº†å°±é€€å‡ºæ„å»ºé•œåƒï¼Œä¸ç„¶æ„å»ºå‡ºæ¥çš„é•œåƒä¼šæœ‰é—®é¢˜ã€‚å¦‚æœæ˜¯è€å¸æœº ğŸš— çš„è¯å»ºè®®ç”¨ <code>;</code> ï¼Œé€›äº†ä¸€åœˆ docker hub å®˜æ–¹é•œåƒä¸­ç”¨ <code>;</code> è¾ƒå¤šä¸€äº›ï¼Œå› ä¸º <code>;</code> æ¯” <code>&amp;&amp;</code> è¦ç¾è§‚ä¸€äº›ï¼ˆå¤§é›¾ ğŸ˜‚ã€‚</p>
<ul>
<li>é£æ ¼ä¸€ï¼šæ¯”å¦‚ <a target="_blank" rel="noopener" href="https://github.com/nginxinc/docker-nginx/blob/master/stable/buster/Dockerfile">nginx</a> å®˜æ–¹é•œåƒæ˜¯ç”¨çš„ <code>&amp;&amp;</code>ï¼Œè²Œä¼¼ä¹Ÿæ··å…¥äº† <code>;</code>ğŸ¤£</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">RUN <span class="token builtin class-name">set</span> <span class="token parameter variable">-x</span> <span class="token punctuation">\</span>
<span class="token comment"># create nginx user/group first, to be consistent throughout docker variants</span>
    <span class="token operator">&amp;&amp;</span> addgroup <span class="token parameter variable">--system</span> <span class="token parameter variable">--gid</span> <span class="token number">101</span> nginx <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> adduser <span class="token parameter variable">--system</span> --disabled-login <span class="token parameter variable">--ingroup</span> nginx --no-create-home <span class="token parameter variable">--home</span> /nonexistent <span class="token parameter variable">--gecos</span> <span class="token string">"nginx user"</span> <span class="token parameter variable">--shell</span> /bin/false <span class="token parameter variable">--uid</span> <span class="token number">101</span> nginx <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> update <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> --no-install-recommends --no-install-suggests <span class="token parameter variable">-y</span> gnupg1 ca-certificates <span class="token punctuation">\</span>
    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">NGINX_GPGKEY</span><span class="token operator">=</span>573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62<span class="token punctuation">;</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">found</span><span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">server</span> <span class="token keyword">in</span> <span class="token punctuation">\</span>
        ha.pool.sks-keyservers.net <span class="token punctuation">\</span>
        hkp://keyserver.ubuntu.com:80 <span class="token punctuation">\</span>
        hkp://p80.pool.sks-keyservers.net:80 <span class="token punctuation">\</span>
        pgp.mit.edu <span class="token punctuation">\</span>
    <span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token punctuation">\</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>é£æ ¼äºŒï¼šæ¯”å¦‚ <a target="_blank" rel="noopener" href="https://github.com/docker-library/redis/blob/23af5b6adb271bcebbcebc93308884438512a4af/6.0/Dockerfile">redis</a> å®˜æ–¹é•œåƒå°±æ¸…ä¸€è‰²ä½¿ç”¨çš„ <code>;</code></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">RUN <span class="token builtin class-name">set</span> -eux<span class="token punctuation">;</span> <span class="token punctuation">\</span>
	<span class="token assign-left variable">savedAptMark</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>apt-mark showmanual<span class="token variable">)</span></span>"</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
	<span class="token function">apt-get</span> update<span class="token punctuation">;</span> <span class="token punctuation">\</span>
	<span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> --no-install-recommends ca-certificates dirmngr gnupg <span class="token function">wget</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
	<span class="token function">rm</span> <span class="token parameter variable">-rf</span> /var/lib/apt/lists/*<span class="token punctuation">;</span> <span class="token punctuation">\</span>
	<span class="token assign-left variable">dpkgArch</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture <span class="token operator">|</span> <span class="token function">awk</span> -F- <span class="token string">'&#123; print $NF &#125;'</span><span class="token variable">)</span></span>"</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
	<span class="token function">wget</span> <span class="token parameter variable">-O</span> /usr/local/bin/gosu <span class="token string">"https://github.com/tianon/gosu/releases/download/<span class="token variable">$GOSU_VERSION</span>/gosu-<span class="token variable">$dpkgArch</span>"</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
	<span class="token function">wget</span> <span class="token parameter variable">-O</span> /usr/local/bin/gosu.asc <span class="token string">"https://github.com/tianon/gosu/releases/download/<span class="token variable">$GOSU_VERSION</span>/gosu-<span class="token variable">$dpkgArch</span>.asc"</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
	<span class="token builtin class-name">export</span> <span class="token assign-left variable">GNUPGHOME</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span>mktemp <span class="token parameter variable">-d</span><span class="token variable">)</span></span>"</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
	gpg <span class="token parameter variable">--batch</span> <span class="token parameter variable">--keyserver</span> hkps://keys.openpgp.org --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4<span class="token punctuation">;</span> <span class="token punctuation">\</span>
	gpg <span class="token parameter variable">--batch</span> <span class="token parameter variable">--verify</span> /usr/local/bin/gosu.asc /usr/local/bin/gosu<span class="token punctuation">;</span> <span class="token punctuation">\</span>
	gpgconf <span class="token parameter variable">--kill</span> all<span class="token punctuation">;</span> <span class="token punctuation">\</span>
	<span class="token function">rm</span> <span class="token parameter variable">-rf</span> <span class="token string">"<span class="token variable">$GNUPGHOME</span>"</span> /usr/local/bin/gosu.asc<span class="token punctuation">;</span> <span class="token punctuation">\</span>
	apt-mark auto <span class="token string">'.*'</span> <span class="token operator">></span> /dev/null<span class="token punctuation">;</span> <span class="token punctuation">\</span>
	<span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">"<span class="token variable">$savedAptMark</span>"</span> <span class="token punctuation">]</span> <span class="token operator">||</span> apt-mark manual <span class="token variable">$savedAptMark</span> <span class="token operator">></span> /dev/null<span class="token punctuation">;</span> <span class="token punctuation">\</span>
	<span class="token function">apt-get</span> purge <span class="token parameter variable">-y</span> --auto-remove <span class="token parameter variable">-o</span> APT::AutoRemove::RecommendsImportant<span class="token operator">=</span>false<span class="token punctuation">;</span> <span class="token punctuation">\</span>
	<span class="token function">chmod</span> +x /usr/local/bin/gosu<span class="token punctuation">;</span> <span class="token punctuation">\</span>
	gosu --version<span class="token punctuation">;</span> <span class="token punctuation">\</span>
	gosu nobody <span class="token boolean">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ±å–œæ¬¢å“ªç§é£æ ¼å‘¢ï¼Ÿå¿«åœ¨è¯„è®ºåŒºç•™è¨€å§ ğŸ˜‹</p>
<h4 id="é•œåƒå·¥å‚-ğŸ› "><a href="#é•œåƒå·¥å‚-ğŸ› " class="headerlink" title="é•œåƒå·¥å‚ ğŸ› "></a>é•œåƒå·¥å‚ ğŸ› </h4><blockquote>
<p>Docker æ˜¯ä¸€ä¸ªå…¸å‹çš„ C&#x2F;S æ¶æ„çš„åº”ç”¨ï¼Œåˆ†ä¸º Docker å®¢æˆ·ç«¯ï¼ˆå³å¹³æ—¶æ•²çš„ docker å‘½ä»¤ï¼‰ Docker æœåŠ¡ç«¯ï¼ˆdockerd å®ˆæŠ¤è¿›ç¨‹ï¼‰ã€‚</p>
<p>Docker å®¢æˆ·ç«¯é€šè¿‡ REST API å’ŒæœåŠ¡ç«¯è¿›è¡Œäº¤äº’ï¼Œdocker å®¢æˆ·ç«¯æ¯å‘é€ä¸€æ¡æŒ‡ä»¤ï¼Œåº•å±‚éƒ½ä¼šè½¬åŒ–æˆ REST API è°ƒç”¨çš„å½¢å¼å‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚å¹¶ç»™å‡ºå“åº”ã€‚</p>
<p>Docker é•œåƒçš„æ„å»ºã€å®¹å™¨åˆ›å»ºã€å®¹å™¨è¿è¡Œç­‰å·¥ä½œéƒ½æ˜¯ Docker æœåŠ¡ç«¯æ¥å®Œæˆçš„ï¼ŒDocker å®¢æˆ·ç«¯åªæ˜¯æ‰¿æ‹…å‘é€æŒ‡ä»¤çš„è§’è‰²ã€‚</p>
<p>Docker å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯ä»¥åœ¨åŒä¸€ä¸ªå®¿ä¸»æœºï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒçš„å®¿ä¸»æœºï¼Œå¦‚æœåœ¨åŒä¸€ä¸ªå®¿ä¸»æœºçš„è¯ï¼ŒDocker å®¢æˆ·ç«¯é»˜è®¤é€šè¿‡ UNIX å¥—æ¥å­—(<code>/var/run/docker.sock</code>)å’ŒæœåŠ¡ç«¯é€šä¿¡ã€‚</p>
</blockquote>
<p>ç±»æ¯”äºé’¢é“æ˜¯æ€æ ·ç‚¼æˆçš„ï¼Œå¦‚æœè¯´ç‚¼åˆ¶é•œåƒä¹Ÿéœ€è¦ä¸ªå·¥å‚çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ dockerd è¿™ä¸ªå®ˆæŠ¤è¿›ç¨‹å°±æ˜¯ä¸ªç”Ÿäº§é•œåƒçš„å·¥å‚ã€‚èƒ½ç”Ÿäº§é•œåƒçš„ä¸æ­¢ docker ä¸€å®¶ï¼Œçº¢å¸½å­å®¶çš„ <a target="_blank" rel="noopener" href="https://buildah.io/">buildah</a> ä¹Ÿèƒ½ç”Ÿäº§é•œåƒï¼Œä¸è¿‡ç”¨çš„äººå¹¶ä¸å¤šã€‚äºŒè€…çš„æœ€å¤§åŒºåˆ«åœ¨äº buildah å¯ä»¥ä¸ç”¨ root æƒé™æ¥æ„å»ºé•œåƒï¼Œè€Œä½¿ç”¨ docker æ„å»ºé•œåƒæ—¶éœ€è¦ç”¨åˆ° root æƒé™ï¼Œæ²¡æœ‰ root æƒé™çš„ç”¨æˆ·æ„å»ºé•œåƒä¼šå½“åœºç¿»è½¦ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Got permission denied <span class="token keyword">while</span> trying to connect to the Docker daemon socket at unix:///var/run/docker.sock:<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä¸è¿‡ buildah æ„å»ºå‡ºæ¥çš„é•œåƒæœ‰ä¸€å †å †çš„å…¼å®¹æ€§é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ docker æ¥æ„å»ºé•œåƒå§ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ docker build å‘½ä»¤æ„å»ºä¸€ä¸ªé•œåƒçš„æ—¶å€™ç¬¬ä¸€è¡Œæ—¥å¿—å°±æ˜¯ <code>Sending build context to Docker daemon xx MB</code>ã€‚è¿™ä¸€æ­¥æ˜¯ docker cli è¿™ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯å°†æˆ‘ä»¬å½“å‰ç›®å½•ï¼ˆå³æ„å»ºä¸Šä¸‹æ–‡ï¼‰ <code>build context</code> æ‰“åŒ…å‘é€ <code>Docker daemon</code> å®ˆæŠ¤è¿›ç¨‹ ï¼ˆå³ dockerdï¼‰çš„è¿‡ç¨‹ã€‚</p>
<p><img data-src="https://p.k8s.li/docker-architecture.png"></p>
<p>docker build æ„å»ºé•œåƒçš„æµç¨‹å¤§æ¦‚å°±æ˜¯ï¼š</p>
<ul>
<li>æ‰§è¡Œ <code>docker build -t &lt;imageName:Tag&gt; .</code>ï¼Œå¯ä»¥ä½¿ç”¨ <code>-f</code> å‚æ•°æ¥æŒ‡å®š Dockerfile æ–‡ä»¶ï¼›</li>
<li>docker å®¢æˆ·ç«¯ä¼šå°†æ„å»ºå‘½ä»¤åé¢æŒ‡å®šçš„è·¯å¾„(<code>.</code>)ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª tar åŒ…ï¼Œå‘é€ç»™ Docker æœåŠ¡ç«¯;</li>
<li>docker æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„ tar åŒ…ï¼Œç„¶åè§£å‹ï¼Œæ¥ä¸‹æ¥æ ¹æ® Dockerfile é‡Œé¢çš„æŒ‡ä»¤è¿›è¡Œé•œåƒçš„åˆ†å±‚æ„å»ºï¼›</li>
<li>docker ä¸‹è½½ FROM è¯­å¥ä¸­æŒ‡å®šçš„åŸºç¡€é•œåƒï¼Œç„¶åå°†åŸºç¡€é•œåƒçš„ layer è”åˆæŒ‚è½½ä¸ºä¸€å±‚ï¼Œå¹¶åœ¨ä¸Šé¢åˆ›å»ºä¸€ä¸ªç©ºç›®å½•ï¼›</li>
<li>æ¥ç€å¯åŠ¨ä¸€ä¸ªä¸´æ—¶çš„å®¹å™¨å¹¶åœ¨ chroot ä¸­å¯åŠ¨ä¸€ä¸ª bashï¼Œè¿è¡Œ <code>RUN</code> è¯­å¥ä¸­çš„å‘½ä»¤ï¼š<code>RUN: chroot . /bin/bash -c &quot;apt get updateâ€¦â€¦&quot;</code>ï¼›</li>
<li>ä¸€æ¡ <code>RUN</code> å‘½ä»¤ç»“æŸåï¼Œä¼šæŠŠä¸Šå±‚ç›®å½•å‹ç¼©ï¼Œå½¢æˆæ–°é•œåƒä¸­çš„æ–°çš„ä¸€å±‚ï¼›</li>
<li>å¦‚æœ Dockerfile ä¸­åŒ…å«å…¶å®ƒå‘½ä»¤ï¼Œå°±ä»¥ä¹‹å‰æ„å»ºçš„å±‚æ¬¡ä¸ºåŸºç¡€ï¼Œä»ç¬¬äºŒæ­¥å¼€å§‹é‡å¤åˆ›å»ºæ–°å±‚ï¼Œç›´åˆ°å®Œæˆæ‰€æœ‰è¯­å¥åé€€å‡ºï¼›</li>
<li>æ„å»ºå®Œæˆä¹‹åä¸ºè¯¥é•œåƒæ‰“ä¸Š tagï¼›</li>
</ul>
<p>ä»¥ä¸Šå°±æ˜¯æ„å»ºé•œåƒçš„å¤§è‡´æµç¨‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ <code>docker history &lt;imageName:Tag&gt;</code> å‘½ä»¤æ¥é€†å‘æ¨ç®—å‡º docker build çš„è¿‡ç¨‹ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 ~/buster/slim
â•°â”€<span class="token comment"># docker history webpsh/webps</span>
IMAGE               CREATED             CREATED BY          SIZE                COMMENT
30d9679b0b1c        <span class="token number">2</span> weeks ago         /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  CMD ["/usr/bin/webp-serveâ€¦   0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">2</span> weeks ago         /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  VOLUME [/opt/exhaust]        0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">2</span> weeks ago         /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop) WORKDIR /opt                  0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">2</span> weeks ago         /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop) COPY file:1497d882aeef5f77â€¦   168B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">2</span> weeks ago         /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop) COPY file:327020918e4dc998â€¦   14.9MB</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">6</span> weeks ago         /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  CMD ["/bin/sh"]              0B</span>
<span class="token operator">&lt;</span>missing<span class="token operator">></span>           <span class="token number">6</span> weeks ago         /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop) ADD file:b91adb67b670d3a6fâ€¦   5.61MB</span>

â•­â”€root@sg-02 ~/buster/slim
â•°â”€<span class="token comment"># docker history debian:v2</span>
IMAGE               CREATED             CREATED BY           SIZE                COMMENT
e6e782a57a51        <span class="token number">38</span> hours ago        /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop)  CMD ["bash"]                 0B</span>
ba8f577813c7        <span class="token number">38</span> hours ago        /bin/sh <span class="token parameter variable">-c</span> <span class="token comment">#(nop) ADD file:a82014afc29e7b364â€¦   69.2MB</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="base-image"><a href="#base-image" class="headerlink" title="base image"></a>base image</h4><p>å½“æˆ‘ä»¬åœ¨å†™ Dockerfile çš„æ—¶å€™éƒ½éœ€è¦ç”¨ <code>FROM</code> è¯­å¥æ¥æŒ‡å®šä¸€ä¸ªåŸºç¡€é•œåƒï¼Œè¿™äº›åŸºç¡€é•œåƒå¹¶ä¸æ˜¯æ— ä¸­ç”Ÿæœ‰ï¼Œä¹Ÿéœ€è¦ä¸€ä¸ª Dockerfile æ¥æ„å»ºæˆé•œåƒã€‚ä¸‹é¢æˆ‘ä»¬æ‹¿æ¥ <a target="_blank" rel="noopener" href="https://hub.docker.com/_/debian">debian:buster</a> è¿™ä¸ªåŸºç¡€é•œåƒçš„ <a target="_blank" rel="noopener" href="https://github.com/debuerreotype/docker-debian-artifacts/blob/18cb4d0418be1c80fb19141b69ac2e0600b2d601/buster/Dockerfile">Dockerfile</a> æ¥çœ‹ä¸€ä¸‹åŸºç¡€é•œåƒæ˜¯å¦‚ä½•ç‚¼æˆçš„ã€‚</p>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> scratch</span>
<span class="token instruction"><span class="token keyword">ADD</span> rootfs.tar.xz /</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"bash"</span>]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>ä¸€ä¸ªåŸºç¡€é•œåƒçš„ Dockerfile ä¸€èˆ¬ä»…æœ‰ä¸‰è¡Œã€‚ç¬¬ä¸€è¡Œ <code>FROM scratch</code> ä¸­çš„ <code>scratch</code> è¿™ä¸ªé•œåƒå¹¶ä¸çœŸå®çš„å­˜åœ¨ã€‚å½“ä½ ä½¿ç”¨ <code>docker pull scratch</code> å‘½ä»¤æ¥æ‹‰å–è¿™ä¸ªé•œåƒçš„æ—¶å€™ä¼šç¿»è½¦å“¦ï¼Œæç¤º <code>Error response from daemon: &#39;scratch&#39; is a reserved name</code>ã€‚è¿™æ˜¯å› ä¸ºè‡ªä» docker 1.5 ç‰ˆæœ¬å¼€å§‹ï¼Œåœ¨ Dockerfile ä¸­ <code>FROM scratch</code> æŒ‡ä»¤å¹¶ä¸è¿›è¡Œä»»ä½•æ“ä½œï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šåˆ›å»ºä¸€ä¸ªé•œåƒå±‚ï¼›æ¥ç€ç¬¬äºŒè¡Œçš„ <code>ADD rootfs.tar.xz /</code> ä¼šè‡ªåŠ¨æŠŠ <code>rootfs.tar.xz</code>  è§£å‹åˆ° <code>/</code> ç›®å½•ä¸‹ï¼Œç”±æ­¤äº§ç”Ÿçš„ä¸€å±‚é•œåƒå°±æ˜¯æœ€ç»ˆæ„å»ºçš„é•œåƒçœŸå®çš„ layer å†…å®¹ï¼›ç¬¬ä¸‰è¡Œ <code>CMD [&quot;bash&quot;]</code> æŒ‡å®šè¿™é•œåƒåœ¨å¯åŠ¨å®¹å™¨çš„æ—¶å€™æ‰§è¡Œçš„åº”ç”¨ç¨‹åºï¼Œä¸€èˆ¬åŸºç¡€é•œåƒçš„ CMD é»˜è®¤ä¸º bash æˆ–è€… sh ã€‚</p>
<blockquote>
<p>As of Docker 1.5.0 (specifically, <a target="_blank" rel="noopener" href="https://github.com/docker/docker/pull/8827"><code>docker/docker#8827</code></a>), <code>FROM scratch</code> is a no-op in the Dockerfile , and will not create an extra layer in your image (so a previously 2-layer image will be a 1-layer image instead).</p>
</blockquote>
<p><code>ADD rootfs.tar.xz /</code> ä¸­ï¼Œè¿™ä¸ª <code>rootfs.tar.xz</code> å°±æ˜¯æˆ‘ä»¬ç»è¿‡ä¸€ç³»åˆ—éªšæ“ä½œï¼ˆä¸€èˆ¬æ˜¯å‘è¡Œç‰ˆæºç ç¼–è¯‘ï¼‰æ“å‡ºæ¥çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¸ªæ“ä½œæ¯”è¾ƒå¤æ‚ï¼Œæœ¨å­å¤ªèœäº† ğŸ¥¬ å°±ä¸åœ¨è¿™é‡Œçæ°æ°äº† ğŸ™ƒï¼Œå¦‚æœæ±å¯¹æºç æ„å»º <code>rootfs.tar.xz</code> è¿™ä¸ªè¿‡ç¨‹æ„Ÿå…´è¶£å¯ä»¥å»çœ‹ä¸€ä¸‹æ„å»º debian åŸºç¡€é•œåƒçš„ Jenkins æµæ°´çº¿ä»»åŠ¡ <a target="_blank" rel="noopener" href="https://doi-janky.infosiftr.net/job/tianon/job/debuerreotype/">debuerreotype</a>ï¼Œä¸Šé¢æœ‰æ„å»ºè¿™ä¸ª <code>rootfs.tar.xz</code> å®Œæ•´è¿‡ç¨‹ï¼Œæˆ–è€…å‚è€ƒ Debian å®˜æ–¹çš„ <a target="_blank" rel="noopener" href="https://github.com/debuerreotype/docker-debian-artifacts">docker-debian-artifacts</a> è¿™ä¸ª repo é‡Œçš„ shell è„šæœ¬ã€‚</p>
<p>éœ€è¦é¢å¤–æ³¨æ„ä¸€ç‚¹ï¼Œåœ¨è¿™é‡Œå¾€é•œåƒé‡Œæ·»åŠ  <code>rootfs.tar.xz</code> æ—¶ä½¿ç”¨çš„æ˜¯ <code>ADD</code> è€Œä¸æ˜¯ <code>COPY</code> ï¼Œå› ä¸ºåœ¨ Dockerfile ä¸­çš„ ADD æŒ‡ä»¤ src æ–‡ä»¶å¦‚æœæ˜¯ä¸ª tar åŒ…ï¼Œåœ¨æ„å»ºçš„æ—¶å€™ docker ä¼šå¸®æˆ‘ä»¬æŠŠ tar åŒ…è§£å¼€åˆ°æŒ‡å®šç›®å½•ï¼Œä½¿ç”¨ copy æŒ‡ä»¤åˆ™ä¸ä¼šè§£å¼€ tar åŒ…ã€‚å¦å¤–ä¸€ç‚¹åŒºåˆ«å°±æ˜¯ ADD æŒ‡ä»¤æ˜¯æ·»åŠ ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¯ä»¥æ˜¯æ„å»ºä¸Šä¸‹æ–‡ç¯å¢ƒä¸­çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸ª URLï¼Œè€Œ COPY åˆ™åªèƒ½æ·»åŠ æ„å»ºä¸Šä¸‹æ–‡ä¸­çš„æ–‡ä»¶ï¼Œæ‰€è°“çš„æ„å»ºä¸Šä¸‹æ–‡å°±æ˜¯æˆ‘ä»¬æ„å»ºé•œåƒçš„æ—¶å€™æœ€åä¸€ä¸ªå‚æ•°å•¦ã€‚</p>
<blockquote>
<p>PSï¼šé¢è¯•çš„æ—¶å€™ç»å¸¸è¢«é—® ADD ä¸ COPY çš„åŒºåˆ«ï¼›CMD ä¸ ENTRYPOINT çš„åŒºåˆ« ğŸ˜‚ã€‚</p>
</blockquote>
<p>æ“è¿™ä¸ª <code>rootfs.tar.xz</code> ä¸åŒçš„å‘è¡Œç‰ˆæ–¹æ³•å¯èƒ½ä¸å¤ªä¸€æ ·ï¼ŒDebian å‘è¡Œç‰ˆçš„ <code>rootfs.tar.xz</code> å¯ä»¥åœ¨ <a target="_blank" rel="noopener" href="https://github.com/debuerreotype/docker-debian-artifacts">docker-debian-artifacts</a> è¿™ä¸ª repo ä¸Šæ‰¾åˆ°ï¼Œæ ¹æ®ä¸åŒå¤„ç†å™¨ arch é€‰æ‹©ç›¸åº”çš„ branch ï¼Œç„¶åè¿™ä¸ª branch ä¸‹çš„ç›®å½•å°±å¯¹åº”ç€è¯¥å‘è¡Œç‰ˆçš„ä¸åŒçš„ç‰ˆæœ¬çš„ä»£å·ã€‚æ„å¤–å‘ç° Debian å®˜æ–¹æ˜¯å°†æ‰€æœ‰ arch å’Œæ‰€æœ‰ç‰ˆæœ¬çš„ <code>rootfs.tar.xz</code> éƒ½æ”¾åœ¨è¿™ä¸ª repo é‡Œçš„ï¼Œä»¥è‡³äºè¿™ä¸ª repo çš„å¤§å°æ¥è¿‘ 2.88 GiB ğŸ˜¨ï¼Œå½“ç½‘ç›˜æ¥ç”¨çš„å˜› ğŸ¤£ï¼ˆï¼šæ‰‹åŠ¨æ»‘ç¨½</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 ~
â•°â”€<span class="token comment"># git clone https://github.com/debuerreotype/docker-debian-artifacts</span>
Cloning into <span class="token string">'docker-debian-artifacts'</span><span class="token punctuation">..</span>.
remote: Enumerating objects: <span class="token number">278</span>, done.
remote: Counting objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">278</span>/278<span class="token punctuation">)</span>, done.
Receiving objects:  <span class="token number">67</span>% <span class="token punctuation">(</span><span class="token number">443</span>/660<span class="token punctuation">)</span>, <span class="token number">1.60</span> GiB <span class="token operator">|</span> <span class="token number">16.96</span> MiB/s
remote: Total <span class="token number">660</span> <span class="token punctuation">(</span>delta <span class="token number">130</span><span class="token punctuation">)</span>, reused <span class="token number">244</span> <span class="token punctuation">(</span>delta <span class="token number">97</span><span class="token punctuation">)</span>, pack-reused <span class="token number">382</span>
Receiving objects: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">660</span>/660<span class="token punctuation">)</span>, <span class="token number">2.88</span> GiB <span class="token operator">|</span> <span class="token number">16.63</span> MiB/s, done.
Resolving deltas: <span class="token number">100</span>% <span class="token punctuation">(</span><span class="token number">267</span>/267<span class="token punctuation">)</span>, done.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æˆ‘ä»¬æŠŠè¿™ä¸ª <code>rootfs.tar.xz</code> è§£å¼€å°±å¯ä»¥çœ‹åˆ°ï¼Œè¿™å°±æ˜¯ä¸€ä¸ª Linux çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œä¸åŒäºæˆ‘ä»¬ä½¿ç”¨ ISO å®‰è£…ç³»ç»Ÿçš„é‚£ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯ç»è¿‡ä¸€ç³»åˆ—çš„è£å‰ªï¼Œå»æ‰äº†ä¸€äº›åœ¨å®¹å™¨è¿è¡Œä¸­ä¸å¿…è¦çš„æ–‡ä»¶ï¼Œä½¿ä¹‹æ›´åŠ è½»é‡é€‚ç”¨äºå®¹å™¨è¿è¡Œçš„åœºæ™¯ï¼Œæ•´ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿçš„å¤§å°ä¸º 125Mï¼Œå¦‚æœä½¿ç”¨ slim çš„ <code>rootfs.tar.xz</code> ä¼šæ›´å°ä¸€äº›ï¼Œä»…ä»… 76Mã€‚å½“ç„¶ç›¸æ¯”äºä»…ä»…å‡  M çš„ <code>alpine</code> ï¼Œè¿™ç®—æ˜¯å¤Ÿå¤§çš„äº†ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º
â•°â”€<span class="token comment"># git checkout dist-amd64</span>
â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º
â•°â”€<span class="token comment"># cd buster</span>
â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º
â•°â”€<span class="token comment"># mkdir rootfs</span>
â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º
â•°â”€<span class="token comment"># tar -xvf rootfs.tar.xz -C !$</span>
â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º
â•°â”€<span class="token comment"># ls rootfs/</span>
bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º
â•°â”€<span class="token comment"># du -sh rootfs</span>
125M    rootfs
â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º
â•°â”€<span class="token comment"># du -sh slim/rootfs</span>
76M     slim/rootfs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æƒ³è¦è‡ªå·±æ„å»ºä¸€ä¸ª <code>debian:buster</code> åŸºç¡€é•œåƒå…¶å®å¾ˆç®€å•ï¼Œå°±åƒä¸‹é¢è¿™æ ·ä¸€æŠŠæ¢­æ“ä½œä¸‹æ¥å°±è¡Œ ğŸ˜‚ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/debuerreotype/docker-debian-artifacts debian
<span class="token builtin class-name">cd</span> <span class="token operator">!</span>$
<span class="token function">git</span> checkout dist-amd64
<span class="token builtin class-name">cd</span> buster
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> debian:buster <span class="token builtin class-name">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸‹é¢å°±æ˜¯æ„å»º Debian åŸºç¡€é•œåƒçš„è¿‡ç¨‹ï¼Œæ­£å¦‚ Dockerfile ä¸­çš„é‚£æ ·ï¼Œæœ€ç»ˆåªäº§ç”Ÿäº†ä¸€å±‚é•œåƒã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> debian:buster <span class="token builtin class-name">.</span>
Sending build context to Docker daemon  <span class="token number">30</span>.12MB
Step <span class="token number">1</span>/3 <span class="token builtin class-name">:</span> FROM scratch
 ---<span class="token operator">></span>
Step <span class="token number">2</span>/3 <span class="token builtin class-name">:</span> ADD rootfs.tar.xz /
 ---<span class="token operator">></span> 1756d6a585ae
Step <span class="token number">3</span>/3 <span class="token builtin class-name">:</span> CMD <span class="token punctuation">[</span><span class="token string">"bash"</span><span class="token punctuation">]</span>
 ---<span class="token operator">></span> Running <span class="token keyword">in</span> c86a8b6deb3d
Removing intermediate container c86a8b6deb3d
 ---<span class="token operator">></span> 04948daa3c2e
Successfully built 04948daa3c2e
Successfully tagged debian:buster<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="é•œåƒæ˜¯æ€æ ·å­˜æ”¾çš„-ï¼ˆä¸€ï¼‰æœ¬åœ°å­˜å‚¨-ğŸ™„"><a href="#é•œåƒæ˜¯æ€æ ·å­˜æ”¾çš„-ï¼ˆä¸€ï¼‰æœ¬åœ°å­˜å‚¨-ğŸ™„" class="headerlink" title="é•œåƒæ˜¯æ€æ ·å­˜æ”¾çš„ ï¼ˆä¸€ï¼‰æœ¬åœ°å­˜å‚¨ ğŸ™„"></a>é•œåƒæ˜¯æ€æ ·å­˜æ”¾çš„ ï¼ˆä¸€ï¼‰æœ¬åœ°å­˜å‚¨ ğŸ™„</h2><p>å½“æˆ‘ä»¬æ„å»ºå®Œä¸€ä¸ªé•œåƒä¹‹åï¼Œé•œåƒå°±å­˜å‚¨åœ¨äº†æˆ‘ä»¬ docker æœ¬åœ°å­˜å‚¨ç›®å½•ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸º <code>/var/lib/docker</code> ï¼Œä¸‹é¢å°±æ¢å¯»ä¸€ä¸‹é•œåƒæ˜¯ä»¥ä»€ä¹ˆæ ·çš„ç›®å½•ç»“æ„å­˜æ”¾çš„ã€‚åœ¨å¼€å§‹ hack ä¹‹å‰æˆ‘ä»¬å…ˆç»Ÿä¸€ä¸€ä¸‹ç¯å¢ƒä¿¡æ¯ï¼Œæˆ‘ä½¿ç”¨çš„æœºå™¨æ˜¯ Ubuntu 1804ï¼Œ<code>docker info</code> ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml">â•­â”€root@sg<span class="token punctuation">-</span>02 /var/lib/docker
â•°â”€<span class="token comment"># docker info</span>
<span class="token key atrule">Client</span><span class="token punctuation">:</span>
 <span class="token key atrule">Debug Mode</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
 <span class="token key atrule">Plugins</span><span class="token punctuation">:</span>
  <span class="token key atrule">buildx</span><span class="token punctuation">:</span> Build with BuildKit (Docker Inc.<span class="token punctuation">,</span> v0.3.1<span class="token punctuation">-</span>tp<span class="token punctuation">-</span>docker)
  <span class="token key atrule">app</span><span class="token punctuation">:</span> Docker Application (Docker Inc.<span class="token punctuation">,</span> v0.8.0)
<span class="token key atrule">Server</span><span class="token punctuation">:</span>
 <span class="token key atrule">Containers</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">Running</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">Paused</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">Stopped</span><span class="token punctuation">:</span> <span class="token number">0</span>
 <span class="token key atrule">Images</span><span class="token punctuation">:</span> <span class="token number">2</span>
 <span class="token key atrule">Server Version</span><span class="token punctuation">:</span> 19.03.5
 <span class="token key atrule">Storage Driver</span><span class="token punctuation">:</span> overlay2
  <span class="token key atrule">Backing Filesystem</span><span class="token punctuation">:</span> extfs
  <span class="token key atrule">Supports d_type</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">Native Overlay Diff</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
 <span class="token key atrule">Logging Driver</span><span class="token punctuation">:</span> json<span class="token punctuation">-</span>file
 <span class="token key atrule">Cgroup Driver</span><span class="token punctuation">:</span> cgroupfs
 <span class="token key atrule">Plugins</span><span class="token punctuation">:</span>
  <span class="token key atrule">Volume</span><span class="token punctuation">:</span> local
  <span class="token key atrule">Network</span><span class="token punctuation">:</span> bridge host ipvlan macvlan null overlay
  <span class="token key atrule">Log</span><span class="token punctuation">:</span> awslogs fluentd gcplogs gelf journald json<span class="token punctuation">-</span>file local logentries splunk syslog
 <span class="token key atrule">Swarm</span><span class="token punctuation">:</span> inactive
 <span class="token key atrule">Runtimes</span><span class="token punctuation">:</span> runc
 <span class="token key atrule">Default Runtime</span><span class="token punctuation">:</span> runc
 <span class="token key atrule">Init Binary</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>init
 <span class="token key atrule">containerd version</span><span class="token punctuation">:</span> b34a5c8af56e510852c35414db4c1f4fa6172339
 <span class="token key atrule">runc version</span><span class="token punctuation">:</span> 3e425f80a8c931f88e6d94a8c831b9d5aa481657
 <span class="token key atrule">init version</span><span class="token punctuation">:</span> fec3683
 <span class="token key atrule">Security Options</span><span class="token punctuation">:</span>
  apparmor
  seccomp
   <span class="token key atrule">Profile</span><span class="token punctuation">:</span> default
 <span class="token key atrule">Kernel Version</span><span class="token punctuation">:</span> 4.15.0<span class="token punctuation">-</span>1052<span class="token punctuation">-</span>aws
 <span class="token key atrule">Operating System</span><span class="token punctuation">:</span> Ubuntu 18.04.1 LTS
 <span class="token key atrule">OSType</span><span class="token punctuation">:</span> linux
 <span class="token key atrule">Architecture</span><span class="token punctuation">:</span> x86_64
 <span class="token key atrule">CPUs</span><span class="token punctuation">:</span> <span class="token number">1</span>
 <span class="token key atrule">Total Memory</span><span class="token punctuation">:</span> 983.9MiB
 <span class="token key atrule">Name</span><span class="token punctuation">:</span> sg<span class="token punctuation">-</span><span class="token number">02</span>
 <span class="token key atrule">ID</span><span class="token punctuation">:</span> B7J5<span class="token punctuation">:</span>Y7ZM<span class="token punctuation">:</span>Y477<span class="token punctuation">:</span>7AS6<span class="token punctuation">:</span>WMYI<span class="token punctuation">:</span>6NLV<span class="token punctuation">:</span>YOMA<span class="token punctuation">:</span>W32Y<span class="token punctuation">:</span>H4NZ<span class="token punctuation">:</span>UQVD<span class="token punctuation">:</span>XHDX<span class="token punctuation">:</span>Y5EF
 <span class="token key atrule">Docker Root Dir</span><span class="token punctuation">:</span> /opt/docker
 <span class="token key atrule">Debug Mode</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
 <span class="token key atrule">Username</span><span class="token punctuation">:</span> webpsh
 <span class="token key atrule">Registry</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//index.docker.io/v1/
 <span class="token key atrule">Labels</span><span class="token punctuation">:</span>
 <span class="token key atrule">Experimental</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
 <span class="token key atrule">Insecure Registries</span><span class="token punctuation">:</span>
  127.0.0.0/8
 <span class="token key atrule">Registry Mirrors</span><span class="token punctuation">:</span>
  https<span class="token punctuation">:</span>//registry.k8s.li/
 <span class="token key atrule">Live Restore Enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸ºäº†æ–¹ä¾¿åˆ†æï¼Œæˆ‘å°†å…¶ä»–çš„ docker image å…¨éƒ¨æ¸…ç©ºæ‰ï¼Œåªä¿ç•™ <code>debian:v1</code> å’Œ <code>debian:v2</code> è¿™ä¸¤ä¸ªé•œåƒï¼Œè¿™ä¸¤ä¸ªé•œåƒè¶³å¤Ÿå¸®åŠ©æˆ‘ä»¬ç†è§£å®¹å™¨é•œåƒæ˜¯å¦‚ä½•å­˜æ”¾çš„ï¼Œé•œåƒå¤šäº†å¤šè¯åˆ†æä¸‹é¢å­˜å‚¨ç›®å½•çš„æ—¶å€™å¯èƒ½ä¸å¤ªæ–¹ä¾¿ï¼ˆï¼ï¹ï¼œï¼‰ï¼Œè¿™ä¸¤ä¸ªé•œåƒæ˜¯æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨ Debian çš„ <code>rootfs.tar.xz</code> æ„å»ºå‡ºæ¥çš„åŸºç¡€é•œåƒã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 /var/lib/docker
â•°â”€<span class="token comment"># docker images</span>
REPOSITORY       TAG         IMAGE ID            CREATED             SIZE
debian           v2          e6e782a57a51        <span class="token number">22</span> hours ago        <span class="token number">69</span>.2MB
debian           v1          cfba37fd24f8        <span class="token number">22</span> hours ago        <span class="token number">69</span>.2MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="docker-x2F-var-x2F-lib-x2F-docker"><a href="#docker-x2F-var-x2F-lib-x2F-docker" class="headerlink" title="docker (&#x2F;var&#x2F;lib&#x2F;docker)"></a>docker (&#x2F;var&#x2F;lib&#x2F;docker)</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 /var/lib/docker
â•°â”€<span class="token comment"># tree -d -L 1</span>
<span class="token builtin class-name">.</span>
â”œâ”€â”€ builder
â”œâ”€â”€ buildkit
â”œâ”€â”€ containers
â”œâ”€â”€ image
â”œâ”€â”€ network
â”œâ”€â”€ overlay2
â”œâ”€â”€ plugins
â”œâ”€â”€ runtimes
â”œâ”€â”€ swarm
â”œâ”€â”€ tmp
â”œâ”€â”€ trust
â””â”€â”€ volumes

<span class="token number">12</span> directories<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ ¹æ®ç›®å½•çš„åå­—æˆ‘ä»¬å¯ä»¥å¤§è‡´æ¨æ–­å‡ºå…³äºå®¹å™¨é•œåƒçš„å­˜å‚¨ï¼Œæˆ‘ä»¬åªå…³å¿ƒ image å’Œ overlay2 è¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹å³å¯ï¼Œå®¹å™¨çš„å…ƒæ•°æ®å­˜æ”¾åœ¨ image ç›®å½•ä¸‹ï¼Œå®¹å™¨çš„ layer æ•°æ®åˆ™å­˜æ”¾åœ¨ overlay2 ç›®å½•ä¸‹ã€‚</p>
<h3 id="x2F-var-x2F-lib-x2F-docker-x2F-image"><a href="#x2F-var-x2F-lib-x2F-docker-x2F-image" class="headerlink" title="&#x2F;var&#x2F;lib&#x2F;docker&#x2F;image"></a>&#x2F;var&#x2F;lib&#x2F;docker&#x2F;image</h3><p>overlay2 ä»£è¡¨ç€æœ¬åœ° docker å­˜å‚¨ä½¿ç”¨çš„æ˜¯ overlay2 è¯¥å­˜å‚¨é©±åŠ¨ï¼Œç›®å‰æœ€æ–°ç‰ˆæœ¬çš„ docker é»˜è®¤ä¼˜å…ˆé‡‡ç”¨ <strong>overlay2</strong> ä½œä¸ºå­˜å‚¨é©±åŠ¨ï¼Œå¯¹äºå·²æ”¯æŒè¯¥é©±åŠ¨çš„ Linux å‘è¡Œç‰ˆï¼Œä¸éœ€è¦ä»»ä½•è¿›è¡Œä»»ä½•é¢å¤–çš„é…ç½®ï¼Œå¯ä½¿ç”¨ lsmod å‘½ä»¤æŸ¥çœ‹å½“å‰ç³»ç»Ÿå†…æ ¸æ˜¯å¦æ”¯æŒ overlay2 ã€‚</p>
<p>å¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ <code>devicemapper</code> å­˜å‚¨é©±åŠ¨å·²ç»åœ¨ docker 18.09 ç‰ˆæœ¬ä¸­è¢«åºŸå¼ƒï¼Œdocker å®˜æ–¹æ¨èä½¿ç”¨ <code>overlay2</code> æ›¿ä»£ <code>devicemapper</code>ã€‚ï¼ˆä¹‹å‰æˆ‘è€ä¸œå®¶ç”¨çš„ docker 1.13 ç‰ˆæœ¬ï¼Œ<code>devicemapper</code> çš„å­˜å‚¨é©±åŠ¨åœ¨ç”Ÿäº§ç¯å¢ƒç¿»è¿‡è½¦ ğŸ˜‚ã€‚æ‰€ä»¥å‘¢ï¼Œéƒ½ 2020 å¹´äº†ï¼Œå½“ä½ ä½¿ç”¨ baidu è¿™ç§åƒåœ¾æœç´ å¼•æ“å»æœç´¢ â€œCentOS å®‰è£… dockerâ€ æ—¶å®ƒä¼šç»™ä½ ä¸€å †åƒåœ¾çš„æ•™ç¨‹ï¼Œå«ä½ å»å®‰è£… <code>device-mapper-persistent-data lvm2</code>ï¼Œå¯¹äºè¿™ç§æŠ„æ¥æŠ„å»çš„åšå®¢å¹³å°ï¼Œç¦»å¾—è¶Šè¿œè¶Šå¥½ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">image
â””â”€â”€ overlay2
    â”œâ”€â”€ distribution
    â”‚   â”œâ”€â”€ diffid-by-digest
    â”‚   â”‚   â””â”€â”€ sha256
    â”‚   â”‚       â”œâ”€â”€ 039b991354af4dcbc534338f687e27643c717bb57e11b87c2e81d50bdd0b2376
    â”‚   â”‚       â”œâ”€â”€ 09a4142c5c9dde2fbf35e7a6e6475eba75a8c28540c375c80be7eade4b7cb438
    â”‚   â””â”€â”€ v2metadata-by-diffid
    â”‚       â””â”€â”€ sha256
    â”‚           â”œâ”€â”€ 0683de2821778aa9546bf3d3e6944df779daba1582631b7ea3517bb36f9e4007
    â”‚           â”œâ”€â”€ 0f7493e3a35bab1679e587b41b353b041dca1e7043be230670969703f28a1d83
    â”œâ”€â”€ imagedb
    â”‚   â”œâ”€â”€ content
    â”‚   â”‚   â””â”€â”€ sha256
    â”‚   â”‚       â”œâ”€â”€ 708bc6af7e5e539bdb59707bbf1053cc2166622f5e1b17666f0ba5829ca6aaea
    â”‚   â”‚       â””â”€â”€ f70734b6a266dcb5f44c383274821207885b549b75c8e119404917a61335981a
    â”‚   â””â”€â”€ metadata
    â”‚       â””â”€â”€ sha256
    â”œâ”€â”€ layerdb
    â”‚   â”œâ”€â”€ mounts
    â”‚   â”œâ”€â”€ sha256
    â”‚   â”‚   â”œâ”€â”€ b9835d6a62886d4e85b65abb120c0ea44ff1b3d116d7a707620785d4664d8c1a
    â”‚   â”‚   â”‚   â”œâ”€â”€ cache-id
    â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token function">diff</span>
    â”‚   â”‚   â”‚   â”œâ”€â”€ parent
    â”‚   â”‚   â”‚   â”œâ”€â”€ size
    â”‚   â”‚   â”‚   â””â”€â”€ tar-split.json.gz
    â”‚   â”‚   â””â”€â”€ d9b567b77bcdb9d8944d3654ea9bb5f6f4f7c4d07a264b2e40b1bb09af171dd3
    â”‚   â”‚       â”œâ”€â”€ cache-id
    â”‚   â”‚       â”œâ”€â”€ <span class="token function">diff</span>
    â”‚   â”‚       â”œâ”€â”€ parent
    â”‚   â”‚       â”œâ”€â”€ size
    â”‚   â”‚       â””â”€â”€ tar-split.json.gz
    â”‚   â””â”€â”€ tmp
    â””â”€â”€ repositories.json
<span class="token number">21</span> directories, <span class="token number">119</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>repositories.json</code></li>
</ul>
<p>repositories.json å°±æ˜¯å­˜å‚¨é•œåƒå…ƒæ•°æ®ä¿¡æ¯ï¼Œä¸»è¦æ˜¯ image name å’Œ image id çš„å¯¹åº”ï¼Œdigest å’Œ image id çš„å¯¹åº”ã€‚å½“ pull å®Œä¸€ä¸ªé•œåƒçš„æ—¶å€™ docker ä¼šæ›´æ–°è¿™ä¸ªæ–‡ä»¶ã€‚å½“æˆ‘ä»¬ docker run ä¸€ä¸ªå®¹å™¨çš„æ—¶å€™ä¹Ÿç”¨åˆ°è¿™ä¸ªæ–‡ä»¶å»ç´¢å¼•æœ¬åœ°æ˜¯å¦å­˜åœ¨è¯¥é•œåƒï¼Œæ²¡æœ‰é•œåƒçš„è¯å°±è‡ªåŠ¨å» pull è¿™ä¸ªé•œåƒã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">â•­â”€root@sg<span class="token number">-02</span> /var/lib/docker/image/overlay2
â•°â”€# jq <span class="token string">"."</span> repositories.json
<span class="token punctuation">&#123;</span>
  <span class="token property">"Repositories"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"debian"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"debian:v1"</span><span class="token operator">:</span> <span class="token string">"sha256:cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d"</span><span class="token punctuation">,</span>
      <span class="token property">"debian:v2"</span><span class="token operator">:</span> <span class="token string">"sha256:e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"localhost:5000/library/debian"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"localhost:5000/library/debian:v1"</span><span class="token operator">:</span> <span class="token string">"sha256:cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d"</span><span class="token punctuation">,</span>
      <span class="token property">"localhost:5000/library/debian:v2"</span><span class="token operator">:</span> <span class="token string">"sha256:e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df"</span><span class="token punctuation">,</span>
      <span class="token property">"localhost:5000/library/debian@sha256:b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239"</span><span class="token operator">:</span> <span class="token string">"sha256:cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d"</span><span class="token punctuation">,</span>
      <span class="token property">"localhost:5000/library/debian@sha256:c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11"</span><span class="token operator">:</span> <span class="token string">"sha256:e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token property">"registry"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"registry:latest"</span><span class="token operator">:</span> <span class="token string">"sha256:708bc6af7e5e539bdb59707bbf1053cc2166622f5e1b17666f0ba5829ca6aaea"</span><span class="token punctuation">,</span>
      <span class="token property">"registry@sha256:7d081088e4bfd632a88e3f3bcd9e007ef44a796fddfe3261407a3f9f04abe1e7"</span><span class="token operator">:</span> <span class="token string">"sha256:708bc6af7e5e539bdb59707bbf1053cc2166622f5e1b17666f0ba5829ca6aaea"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>distribution ç›®å½•ä¸‹</li>
</ul>
<p>å­˜æ”¾ç€ layer çš„ diff_id å’Œ digest çš„å¯¹åº”å…³ç³»</p>
<p>diffid-by-digest :å­˜æ”¾ <code>digest</code> åˆ° <code>diffid</code> çš„å¯¹åº”å…³ç³»</p>
<p>v2metadata-by-diffid : å­˜æ”¾ <code>diffid</code> åˆ° <code>digest</code> çš„å¯¹åº”å…³ç³»</p>
<pre class="line-numbers language-none"><code class="language-none">â”œâ”€â”€ distribution
â”‚Â Â  â”œâ”€â”€ diffid-by-digest
â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ 039b991354af4dcbc534338f687e27643c717bb57e11b87c2e81d50bdd0b2376
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ 09a4142c5c9dde2fbf35e7a6e6475eba75a8c28540c375c80be7eade4b7cb438
â”‚Â Â  â””â”€â”€ v2metadata-by-diffid
â”‚Â Â      â””â”€â”€ sha256
â”‚Â Â          â”œâ”€â”€ 0683de2821778aa9546bf3d3e6944df779daba1582631b7ea3517bb36f9e4007
â”‚Â Â          â”œâ”€â”€ 0f7493e3a35bab1679e587b41b353b041dca1e7043be230670969703f28a1d83<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>imagedb</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â”œâ”€â”€ imagedb
â”‚   â”œâ”€â”€ content
â”‚   â”‚   â””â”€â”€ sha256
â”‚   â”‚       â”œâ”€â”€ 708bc6af7e5e539bdb59707bbf1053cc2166622f5e1b17666f0ba5829ca6aaea
â”‚   â”‚       â””â”€â”€ f70734b6a266dcb5f44c383274821207885b549b75c8e119404917a61335981a
â”‚   â””â”€â”€ metadata
â”‚       â””â”€â”€ sha256<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>layerdb</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â”œâ”€â”€ layerdb
â”‚   â”œâ”€â”€ mounts
â”‚   â”œâ”€â”€ sha256
â”‚   â”‚   â”œâ”€â”€ b9835d6a62886d4e85b65abb120c0ea44ff1b3d116d7a707620785d4664d8c1a
â”‚   â”‚   â”‚   â”œâ”€â”€ cache-id  <span class="token comment"># docker ä¸‹è½½é•œåƒæ—¶éšæœºç”Ÿæˆçš„ id</span>
â”‚   â”‚   â”‚   â”œâ”€â”€ <span class="token function">diff</span> <span class="token comment"># å­˜æ”¾ layer çš„ diffid</span>
â”‚   â”‚   â”‚   â”œâ”€â”€ parent <span class="token comment"># æ”¾å½“å‰ layer çš„çˆ¶ layer çš„ diffidï¼Œæœ€åº•å±‚çš„ layer æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶</span>
â”‚   â”‚   â”‚   â”œâ”€â”€ size <span class="token comment"># è¯¥ layer çš„å¤§å°</span>
â”‚   â”‚   â”‚   â””â”€â”€ tar-split.json.gz<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼štar-split.json.gz æ–‡ä»¶æ˜¯ layer tar åŒ…çš„ split æ–‡ä»¶ï¼Œè®°å½•äº† layer è§£å‹åçš„æ–‡ä»¶åœ¨ tar åŒ…ä¸­çš„ä½ç½®ï¼ˆåç§»é‡ï¼‰ï¼Œé€šè¿‡è¿™ä¸ªæ–‡ä»¶å¯ä»¥è¿˜åŸ layer çš„ tar åŒ…ï¼Œåœ¨ docker save å¯¼å‡º image çš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œç”±æ ¹æ®å®ƒå¯ä»¥å¼€å€’è½¦æŠŠè§£å‹çš„ layer è¿˜åŸå› tar åŒ…ã€‚è¯¦æƒ…å¯å‚è€ƒ <a target="_blank" rel="noopener" href="https://github.com/vbatts/tar-split">tar-split</a></p>
<h3 id="x2F-var-x2F-lib-x2F-docker-x2F-overlay2"><a href="#x2F-var-x2F-lib-x2F-docker-x2F-overlay2" class="headerlink" title="&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2"></a>&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">overlay2
â”œâ”€â”€ 259cf6934509a674b1158f0a6c90c60c133fd11189f98945c7c3a524784509ff
â”‚   â””â”€â”€ <span class="token function">diff</span>
â”‚       â”œâ”€â”€ bin
â”‚       â”œâ”€â”€ dev
â”‚       â”œâ”€â”€ etc
â”‚       â”œâ”€â”€ home
â”‚       â”œâ”€â”€ lib
â”‚       â”œâ”€â”€ media
â”‚       â”œâ”€â”€ mnt
â”‚       â”œâ”€â”€ opt
â”‚       â”œâ”€â”€ proc
â”‚       â”œâ”€â”€ root
â”‚       â”œâ”€â”€ run
â”‚       â”œâ”€â”€ sbin
â”‚       â”œâ”€â”€ srv
â”‚       â”œâ”€â”€ sys
â”‚       â”œâ”€â”€ tmp
â”‚       â”œâ”€â”€ usr
â”‚       â””â”€â”€ var
â”œâ”€â”€ 27f9e9b74a88a269121b4e77330a665d6cca4719cb9a58bfc96a2b88a07af805
â”‚   â”œâ”€â”€ <span class="token function">diff</span>
â”‚   â””â”€â”€ work
â”œâ”€â”€ a0df3cc902cfbdee180e8bfa399d946f9022529d12dba3bc0b13fb7534120015
â”‚   â”œâ”€â”€ <span class="token function">diff</span>
â”‚   â”‚   â””â”€â”€ bin
â”‚   â””â”€â”€ work
â”œâ”€â”€ b2fbebb39522cb6f1f5ecbc22b7bec5e9bc6ecc25ac942d9e26f8f94a028baec
â”‚   â”œâ”€â”€ <span class="token function">diff</span>
â”‚   â”‚   â”œâ”€â”€ etc
â”‚   â”‚   â”œâ”€â”€ lib
â”‚   â”‚   â”œâ”€â”€ usr
â”‚   â”‚   â””â”€â”€ var
â”‚   â””â”€â”€ work
â”œâ”€â”€ be8c12f63bebacb3d7d78a09990dce2a5837d86643f674a8fd80e187d8877db9
â”‚   â”œâ”€â”€ <span class="token function">diff</span>
â”‚   â”‚   â””â”€â”€ etc
â”‚   â””â”€â”€ work
â”œâ”€â”€ e8f6e78aa1afeb96039c56f652bb6cd4bbd3daad172324c2172bad9b6c0a968d
â”‚   â””â”€â”€ <span class="token function">diff</span>
â”‚       â”œâ”€â”€ bin
â”‚       â”œâ”€â”€ dev
â”‚       â”œâ”€â”€ etc
â”‚       â”œâ”€â”€ home
â”‚       â”œâ”€â”€ lib
â”‚       â”œâ”€â”€ media
â”‚       â”œâ”€â”€ mnt
â”‚       â”œâ”€â”€ proc
â”‚       â”œâ”€â”€ root
â”‚       â”œâ”€â”€ run
â”‚       â”œâ”€â”€ sbin
â”‚       â”œâ”€â”€ srv
â”‚       â”œâ”€â”€ sys
â”‚       â”œâ”€â”€ tmp
â”‚       â”œâ”€â”€ usr
â”‚       â””â”€â”€ var
â””â”€â”€ l
    â”œâ”€â”€ 526XCHXRJMZXRIHN4YWJH2QLPY -<span class="token operator">></span> <span class="token punctuation">..</span>/b2fbebb39522cb6f1f5ecbc22b7bec5e9bc6ecc25ac942d9e26f8f94a028baec/diff
    â”œâ”€â”€ 5RZOXYR35NSGAWTI36CVUIRW7U -<span class="token operator">></span> <span class="token punctuation">..</span>/be8c12f63bebacb3d7d78a09990dce2a5837d86643f674a8fd80e187d8877db9/diff
    â”œâ”€â”€ LBWRL4ZXGBWOTN5JDCDZVNOY7H -<span class="token operator">></span> <span class="token punctuation">..</span>/a0df3cc902cfbdee180e8bfa399d946f9022529d12dba3bc0b13fb7534120015/diff
    â”œâ”€â”€ MYRYBGZRI4I76MJWQHN7VLZXLW -<span class="token operator">></span> <span class="token punctuation">..</span>/27f9e9b74a88a269121b4e77330a665d6cca4719cb9a58bfc96a2b88a07af805/diff
    â”œâ”€â”€ PCIS4FYUJP4X2D4RWB7ETFL6K2 -<span class="token operator">></span> <span class="token punctuation">..</span>/259cf6934509a674b1158f0a6c90c60c133fd11189f98945c7c3a524784509ff/diff
    â””â”€â”€ XK5IA4BWQ2CIS667J3SXPXGQK5 -<span class="token operator">></span> <span class="token punctuation">..</span>/e8f6e78aa1afeb96039c56f652bb6cd4bbd3daad172324c2172bad9b6c0a968d/diff<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ <code>/var/lib/docker/overlay2</code> ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé•œåƒ layer çš„å†…å®¹éƒ½å­˜æ”¾åœ¨ä¸€ä¸ª <code>diff</code> çš„æ–‡ä»¶å¤¹ä¸‹ï¼Œdiff çš„ä¸Šçº§ç›®å½•å°±æ˜¯ä»¥é•œåƒ layer çš„ digest ä¸ºåçš„ç›®å½•ã€‚å…¶ä¸­è¿˜æœ‰ä¸ª <code>l</code> æ–‡ä»¶å¤¹ï¼Œä¸‹é¢æœ‰ä¸€å¨å¨çš„ç¡¬é“¾æ¥æ–‡ä»¶æŒ‡å‘ä¸Šçº§ç›®å½•çš„ layer ç›®å½•ã€‚è¿™ä¸ª l å…¶å®å°±æ˜¯ link çš„ç¼©å†™ï¼Œl ä¸‹çš„æ–‡ä»¶éƒ½æ˜¯ä¸€äº›æ¯” digest æ–‡ä»¶å¤¹åçŸ­ä¸€äº›çš„ï¼Œæ–¹é¢ä¸è‡³äº mount çš„å‚æ•°è¿‡é•¿ã€‚</p>
<h2 id="é•œåƒæ˜¯æ€ä¹ˆæ¬è¿çš„-ğŸ¤£"><a href="#é•œåƒæ˜¯æ€ä¹ˆæ¬è¿çš„-ğŸ¤£" class="headerlink" title="é•œåƒæ˜¯æ€ä¹ˆæ¬è¿çš„ ğŸ¤£"></a>é•œåƒæ˜¯æ€ä¹ˆæ¬è¿çš„ ğŸ¤£</h2><p>å½“æˆ‘ä»¬åœ¨æœ¬åœ°æ„å»ºå®Œæˆä¸€ä¸ªé•œåƒä¹‹åï¼Œå¦‚ä½•ä¼ é€’ç»™ä»–äººå‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ°é•œåƒæ˜¯æ€ä¹ˆæ¬è¿çš„ä¸€äº›çŸ¥è¯†ï¼Œæ¬è¿é•œåƒå°±åƒæˆ‘ä»¬åœ¨ GitHub ä¸Šæ¬è¿ä»£ç ä¸€æ ·ï¼Œdocker ä¹Ÿæœ‰ç±»ä¼¼äº git clone å’Œ git push çš„æ¬è¿æ–¹å¼ã€‚docker push å°±å’Œæˆ‘ä»¬ä½¿ç”¨ git push ä¸€æ ·ï¼Œå°†æœ¬åœ°çš„é•œåƒæ¨é€åˆ°ä¸€ä¸ªç§°ä¹‹ä¸º registry çš„é•œåƒä»“åº“ï¼Œè¿™ä¸ª registry é•œåƒä»“åº“å°±åƒ GitHub ç”¨æ¥å­˜æ”¾å…¬å…±&#x2F;ç§æœ‰çš„é•œåƒï¼Œä¸€ä¸ªä¸­å¿ƒåŒ–çš„é•œåƒä»“åº“æ–¹ä¾¿å¤§å®¶æ¥è¿›è¡Œäº¤æµå’Œæ¬è¿é•œåƒã€‚docker pull å°±åƒæˆ‘ä»¬ä½¿ç”¨ git pull ä¸€æ ·ï¼Œå°†è¿œç¨‹çš„é•œåƒæ‹‰æ‹‰å–æœ¬åœ°ã€‚</p>
<h3 id="docker-pull"><a href="#docker-pull" class="headerlink" title="docker pull"></a>docker pull</h3><p>ç†è§£ docker pull ä¸€ä¸ªé•œåƒçš„æµç¨‹æœ€å¥½çš„åŠæ³•æ˜¯æŸ¥çœ‹ OCI registry è§„èŒƒä¸­çš„è¿™æ®µæ–‡æ¡£ <a target="_blank" rel="noopener" href="https://github.com/opencontainers/distribution-spec/blob/master/spec.md#pulling-an-image">pulling-an-image</a> ï¼Œåœ¨è¿™é‡Œæˆ‘ç»“åˆå¤§ä½¬çš„åšå®¢ç®€å•æ¢³ç†ä¸€ä¸‹ pull ä¸€ä¸ªé•œåƒçš„å¤§è‡´æµç¨‹ã€‚ä¸‹é¢è¿™å¼ å›¾æ˜¯ä» <a target="_blank" rel="noopener" href="https://github.com/helios741/myblog/blob/new/learn_go/src/2019/20191206_docker_disk_storage/README.md">æµ…è°ˆ docker ä¸­é•œåƒå’Œå®¹å™¨åœ¨æœ¬åœ°çš„å­˜å‚¨)</a> å€Ÿæ¥çš„ ğŸ˜‚</p>
<p><img data-src="https://user-images.githubusercontent.com/12036324/70367494-646d2380-18db-11ea-992a-d2bca4cbfeb0.png"></p>
<p>docker pull å°±å’Œæˆ‘ä»¬ä½¿ç”¨ git clone ä¸€æ ·æ•ˆæœï¼Œå°†è¿œç¨‹çš„é•œåƒä»“åº“æ‹‰å–åˆ°æœ¬åœ°æ¥ç»™å®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨ï¼Œç»“åˆä¸Šå›¾å¤§è‡´çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ­¥åº”è¯¥æ˜¯ä½¿ç”¨ <code>~/.docker/config.json</code> ä¸­çš„ auth è®¤è¯ä¿¡æ¯åœ¨ registry é‚£é‡Œè¿›è¡Œé‰´æƒæˆæƒï¼Œæ‹¿åˆ°ä¸€ä¸ª tokenï¼Œåé¢çš„æ‰€æœ‰çš„ HTTP è¯·æ±‚ä¸­éƒ½è¦åŒ…å«ç€è¯¥ token æ‰èƒ½æœ‰æƒé™è¿›è¡Œæ“ä½œã€‚</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">â•­â”€root@sg<span class="token number">-02</span> /home/ubuntu
â•°â”€# cat ~/.docker/config.json
<span class="token punctuation">&#123;</span>
        <span class="token property">"auths"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token property">"https://registry.k8s.li/v2/"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                        <span class="token property">"auth"</span><span class="token operator">:</span> <span class="token string">"d2VicH855828WM7bSVsslJFpmQE43Sw=="</span>
                <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"HttpHeaders"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token property">"User-Agent"</span><span class="token operator">:</span> <span class="token string">"Docker-Client/19.03.5 (linux)"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token property">"experimental"</span><span class="token operator">:</span> <span class="token string">"enabled"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>dockerd å®ˆæŠ¤è¿›ç¨‹è§£æ docker å®¢æˆ·ç«¯å‚æ•°ï¼Œç”±é•œåƒå + tag å‘ registry è¯·æ±‚ Manifest æ–‡ä»¶ï¼ŒHTTP è¯·æ±‚ä¸º <code>GET /v2/&lt;name&gt;/manifests/&lt;reference&gt;</code>ã€‚registry ä¸­ä¸€ä¸ªé•œåƒæœ‰å¤šä¸ª tag æˆ–è€…å¤šä¸ªå¤„ç†å™¨ä½“ç³»æ¶æ„çš„é•œåƒï¼Œåˆ™æ ¹æ®è¿™ä¸ª tag æ¥è¿”å›ç»™å®¢æˆ·ç«¯ä¸ä¹‹å¯¹åº”çš„  manifest æ–‡ä»¶ï¼›</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">GET /v2/&lt;name>/manifests/&lt;reference>
<span class="token punctuation">&#123;</span>
   <span class="token property">"annotations"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"com.example.key1"</span><span class="token operator">:</span> <span class="token string">"value1"</span><span class="token punctuation">,</span>
      <span class="token property">"com.example.key2"</span><span class="token operator">:</span> <span class="token string">"value2"</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
   <span class="token property">"config"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.oci.image.config.v1+json"</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">452</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
   <span class="token property">"layers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
         <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401"</span><span class="token punctuation">,</span>
         <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.oci.image.layer.v1.tar+gzip"</span><span class="token punctuation">,</span>
         <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">78343</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token property">"schemaVersion"</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>dockerd å¾—åˆ° <code>manifest</code> åï¼Œè¯»å–é‡Œé¢ image config æ–‡ä»¶çš„ <code>digest</code>ï¼Œè¿™ä¸ª sha256 å€¼å°±æ˜¯ image çš„ <code>ID</code></li>
<li>æ ¹æ® <code>ID</code> åœ¨æœ¬åœ°çš„ <code>repositories.json</code> ä¸­æŸ¥æ‰¾æ‰¾æœ‰æ²¡æœ‰å­˜åœ¨åŒæ · <code>ID</code> çš„ imageï¼Œæœ‰çš„è¯å°±ä¸ç”¨ä¸‹è½½äº†</li>
<li>å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆä¼šç»™ registry æœåŠ¡å™¨å‘è¯·æ±‚æ‹¿åˆ°  image config æ–‡ä»¶</li>
<li>æ ¹æ® image config æ–‡ä»¶ä¸­çš„ <code>diff_ids</code> åœ¨æœ¬åœ°æ‰¾å¯¹åº”çš„ layer æ˜¯å¦å­˜åœ¨</li>
<li>å¦‚æœ layer ä¸å­˜åœ¨ï¼Œåˆ™æ ¹æ® <code>manifest</code> é‡Œé¢ layer çš„ <code>sha256</code> å’Œ <code>media type</code> å»æœåŠ¡å™¨æ‹¿ç›¸åº”çš„ layerï¼ˆç›¸å½“å»æ‹¿å‹ç¼©æ ¼å¼çš„åŒ…ï¼‰</li>
<li>dockerd å®ˆæŠ¤è¿›ç¨‹å¹¶è¡Œä¸‹è½½å„ layer ï¼ŒHTTP è¯·æ±‚ä¸º <code>GET /v2/&lt;name&gt;/blobs/&lt;digest&gt;</code>ã€‚</li>
<li>æ‹¿åˆ°åè¿›è¡Œè§£å‹ï¼Œå¹¶æ£€æŸ¥è§£å‹(gzip -d)å tar åŒ…çš„ sha256 æ˜¯å¦å’Œ image config ä¸­çš„ <code>diff_id</code> ç›¸åŒï¼Œä¸ç›¸åŒå°±ç¿»è½¦äº†</li>
<li>ç­‰æ‰€æœ‰çš„ layer éƒ½ä¸‹è½½å®Œæˆåï¼Œæ•´ä¸ª image çš„ layer å°±ä¸‹è½½å®Œæˆï¼Œæ¥ç€å¼€å§‹è¿›è¡Œè§£å‹(tar -xf) layer çš„ tar åŒ…ã€‚</li>
<li>dockerd èµ·ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ <code>docker-untar</code> æ¥ gzip è§£å‹ç¼©å·²ç»ä¸‹è½½å®Œæˆçš„ layer æ–‡ä»¶ï¼›å¯¹äºæœ‰äº›æ¯”è¾ƒå¤§çš„é•œåƒï¼ˆæ¯”å¦‚å‡ å GB çš„é•œåƒï¼‰ï¼Œå¾€å¾€é•œåƒçš„ layer å·²ç»ä¸‹è½½å®Œæˆäº†ï¼Œä½†è¿˜æ²¡æœ‰è§£å‹å®Œ ğŸ˜‚ã€‚</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">docker-untar /var/lib/docker/overlay2/a076db6567c7306f3cdab6040cd7d083ef6a39d125171353eedbb8bde7f203b4/diff<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>éªŒè¯ image config ä¸­çš„ RootFS.DiffIDs æ˜¯å¦ä¸ä¸‹è½½ï¼ˆè§£å‹åï¼‰hash ç›¸åŒï¼›</li>
</ul>
<h3 id="docker-push"><a href="#docker-push" class="headerlink" title="docker push"></a>docker push</h3><p>push æ¨é€ä¸€ä¸ªé•œåƒåˆ°è¿œç¨‹çš„ registry æµç¨‹æ°å¥½å’Œ pull æ‹‰å–é•œåƒåˆ°æœ¬åœ°çš„æµç¨‹ç›¸åã€‚æˆ‘ä»¬ pull ä¸€ä¸ªé•œåƒçš„æ—¶å€™å¾€å¾€éœ€è¦å…ˆè·å–åŒ…å«ç€é•œåƒ layer ä¿¡æ¯çš„ Manifest æ–‡ä»¶ï¼Œç„¶åæ ¹æ®è¿™ä¸ªæ–‡ä»¶ä¸­çš„ layer ä¿¡æ¯å– pull ç›¸åº”çš„ layerã€‚push ä¸€ä¸ªé•œåƒï¼Œéœ€è¦å…ˆå°†é•œåƒçš„å„ä¸ª layer æ¨é€åˆ° registry ï¼Œå½“æ‰€æœ‰çš„é•œåƒ layer ä¸Šä¼ å®Œæ¯•ä¹‹åæœ€åå† push Image Manifest åˆ° registryã€‚å¤§ä½“çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>All layer uploads use two steps to manage the upload process. The first step starts the upload in the registry service, returning a url to carry out the second step. The second step uses the upload url to transfer the actual data. Uploads are started with a POST request which returns a url that can be used to push data and check upload status.</p>
</blockquote>
<ul>
<li><p>ç¬¬ä¸€æ­¥å’Œ pull ä¸€ä¸ªé•œåƒä¸€æ ·ä¹Ÿæ˜¯è¿›è¡Œé‰´æƒæˆæƒï¼Œæ‹¿åˆ°ä¸€ä¸ª tokenï¼›</p>
</li>
<li><p>å‘ registry å‘é€ <code>POST /v2/&lt;name&gt;/blobs/uploads/</code> è¯·æ±‚ï¼Œregistry è¿”å›ä¸€ä¸ªä¸Šä¼ é•œåƒ layer æ—¶è¦åº”åˆ°çš„ URLï¼›</p>
</li>
<li><p>å®¢æˆ·ç«¯é€šè¿‡ <code>HEAD /v2/&lt;name&gt;/blobs/&lt;digest&gt;</code> è¯·æ±‚æ£€æŸ¥ registry ä¸­æ˜¯å¦å·²ç»å­˜åœ¨é•œåƒçš„ layerã€‚</p>
</li>
<li><p>å®¢æˆ·ç«¯é€šè¿‡ URL ä½¿ç”¨ POST æ–¹æ³•æ¥å®æ—¶ä¸Šä¼  layer æ•°æ®ï¼Œä¸Šä¼ é•œåƒ layer åˆ†ä¸º <code>Monolithic Upload</code> ï¼ˆæ•´ä½“ä¸Šä¼ ï¼‰å’Œ <code>Chunked Upload</code>ï¼ˆåˆ†å—ä¸Šä¼ ï¼‰ä¸¤ç§æ–¹å¼ã€‚</p>
<ul>
<li>Monolithic Upload</li>
</ul>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">PUT /v2/&lt;name>/blobs/uploads/&lt;session_id>?digest=&lt;digest>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">&lt;size of layer></span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/octet-stream</span></span>

&lt;Layer Binary Data><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Chunked Upload</li>
</ul>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">PATCH /v2/&lt;name>/blobs/uploads/&lt;session_id>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">&lt;size of chunk></span></span>
<span class="token header"><span class="token header-name keyword">Content-Range</span><span class="token punctuation">:</span> <span class="token header-value">&lt;start of range>-&lt;end of range></span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/octet-stream</span></span>

&lt;Layer Chunk Binary Data><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>é•œåƒçš„ layer ä¸Šä¼ å®Œæˆä¹‹åï¼Œå®¢æˆ·ç«¯éœ€è¦å‘ registry å‘é€ä¸€ä¸ª PUT HTTP è¯·æ±‚å‘ŠçŸ¥è¯¥ layer å·²ç»ä¸Šä¼ å®Œæ¯•ã€‚</p>
</li>
</ul>
<pre class="line-numbers language-http" data-language="http"><code class="language-http">PUT /v2/&lt;name>/blobs/uploads/&lt;session_id>?digest=&lt;digest>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">&lt;size of chunk></span></span>
<span class="token header"><span class="token header-name keyword">Content-Range</span><span class="token punctuation">:</span> <span class="token header-value">&lt;start of range>-&lt;end of range></span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">application/octet-stream</span></span>

&lt;Last Layer Chunk Binary Data><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>æœ€åå½“æ‰€æœ‰çš„ layer ä¸Šä¼ å®Œä¹‹åï¼Œå®¢æˆ·ç«¯å†å°† manifest æ¨é€ä¸Šå»å°±å®Œäº‹å„¿äº†ã€‚</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">PUT /v2/&lt;name>/manifests/&lt;reference>
Content-Type<span class="token operator">:</span> &lt;manifest media type>

<span class="token punctuation">&#123;</span>
   <span class="token property">"annotations"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"com.example.key1"</span><span class="token operator">:</span> <span class="token string">"value1"</span><span class="token punctuation">,</span>
      <span class="token property">"com.example.key2"</span><span class="token operator">:</span> <span class="token string">"value2"</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
   <span class="token property">"config"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.oci.image.config.v1+json"</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">452</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
   <span class="token property">"layers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
         <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401"</span><span class="token punctuation">,</span>
         <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.oci.image.layer.v1.tar+gzip"</span><span class="token punctuation">,</span>
         <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">78343</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token property">"schemaVersion"</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Python-docker-drag"><a href="#Python-docker-drag" class="headerlink" title="Python docker-drag"></a>Python <a target="_blank" rel="noopener" href="https://github.com/NotGlop/docker-drag">docker-drag</a></h3><p>è¿™æ˜¯ä¸€ä¸ªå¾ˆç®€å•ç²—æš´çš„ Python è„šæœ¬ï¼Œä½¿ç”¨ request åº“è¯·æ±‚ registry API æ¥ä»é•œåƒä»“åº“ä¸­æ‹‰å–é•œåƒï¼Œå¹¶ä¿å­˜ä¸ºä¸€ä¸ª tar åŒ…ï¼Œæ‹‰å®Œä¹‹åä½¿ç”¨ docker load åŠ è½½ä¸€ä¸‹å°±èƒ½é£Ÿç”¨å•¦ã€‚è¯¥ python è„šæœ¬ç®€å•åˆ°å»æ‰ç©ºè¡Œå’Œæ³¨é‡Šä¸åˆ° 200 è¡Œï¼Œå¦‚æœæŠŠè¿™ä¸ªè„šæœ¬æºç è¯»ä¸€éçš„è¯å°±èƒ½å¤§æ¦‚çŸ¥é“ docker pull å’Œ skopeo copy çš„ä¸€äº›åŸç†ï¼Œä»–ä»¬éƒ½æ˜¯å»è°ƒç”¨ registry çš„ API ï¼Œæ‰€ä»¥è¿˜æ˜¯æ¨èå»è¯»ä¸€ä¸‹è¿™ä¸ªå®ƒçš„æºç ã€‚</p>
<p>é£Ÿç”¨èµ·æ¥ä¹Ÿå¾ˆç®€å•ç›´æ¥ <code>python3 docker_pull.py [image name]</code>ï¼Œè²Œä¼¼åªèƒ½æ‹‰å– docker.io ä¸Šçš„é•œåƒã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 /home/ubuntu
â•°â”€<span class="token comment"># wget https://raw.githubusercontent.com/NotGlop/docker-drag/master/docker_pull.py</span>
â•­â”€root@sg-02 /home/ubuntu
â•°â”€<span class="token comment"># python3 docker_pull.py nginx</span>
Creating image structure in: tmp_nginx_latest
afb6ec6fdc1c: Pull complete <span class="token punctuation">[</span><span class="token number">27098756</span><span class="token punctuation">]</span>
dd3ac8106a0b: Pull complete <span class="token punctuation">[</span><span class="token number">26210578</span><span class="token punctuation">]</span>                                       <span class="token punctuation">]</span>
8de28bdda69b: Pull complete <span class="token punctuation">[</span><span class="token number">538</span><span class="token punctuation">]</span>
a2c431ac2669: Pull complete <span class="token punctuation">[</span><span class="token number">900</span><span class="token punctuation">]</span>
e070d03fd1b5: Pull complete <span class="token punctuation">[</span><span class="token number">669</span><span class="token punctuation">]</span>
Docker image pulled: library_nginx.tar
â•­â”€root@sg-02 /home/ubuntu
â•°â”€<span class="token comment"># docker load -i library_nginx.tar</span>
ffc9b21953f4: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span><span class="token punctuation">]</span>  <span class="token number">72</span>.49MB/72.49MB
d9c0b16c8d5b: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span><span class="token punctuation">]</span>  <span class="token number">63</span>.81MB/63.81MB
8c7fd6263c1f: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span><span class="token punctuation">]</span>  <span class="token number">3</span>.072kB/3.072kB
077ae58ac205: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span><span class="token punctuation">]</span>  <span class="token number">4</span>.096kB/4.096kB
787328500ad5: Loading layer <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span><span class="token punctuation">]</span>  <span class="token number">3</span>.584kB/3.584kB
Loaded image: nginx:latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="skopeo"><a href="#skopeo" class="headerlink" title="skopeo"></a>skopeo</h3><p>è¿™ä¸ªå·¥å…·æ˜¯çº¢å¸½å­å®¶çš„ï¼Œæ˜¯ Podmanã€Skopeo å’Œ Buildah ï¼ˆç®€ç§° PSB ï¼‰ä¸‹ä¸€ä»£å®¹å™¨æ–°æ¶æ„ä¸­çš„ä¸€å‘˜ï¼Œä¸è¿‡æœ¨å­è§‰ç€ Podman æƒ³è¦å–ä»£ docker å’Œ containerd å®¹å™¨è¿è¡Œæ—¶è¿˜æœ‰å¾ˆé•¿çš„è·¯è¦èµ°ï¼Œè™½ç„¶å®ƒç¬¦åˆ OCI è§„èŒƒï¼Œä½†å¯¹äºä¼ä¸šæ¥è®²ï¼Œæ›¿æ¢çš„æˆæœ¬å¹¶ä¸å€¼å¾—ä»–ä»¬å»æ¢åˆ° PSB ä¸Šå»ã€‚</p>
<p>å…¶ä¸­çš„ skopeo è¿™ä¸ªé•œåƒæ¬è¿å·¥å…·ç®€ç›´æ˜¯ä¸ªç¥å™¨ï¼Œå°¤å…¶æ˜¯åœ¨ CI&#x2F;CD æµæ°´çº¿ä¸­æ¬è¿ä¸¤ä¸ªé•œåƒä»“åº“é‡Œçš„é•œåƒç®€ç›´çˆ½çš„ä¸å¾—äº†ã€‚æˆ‘å…¥èŒæ–°å…¬å¸ååšçš„ä¸€ä¸ªå·¥ä½œå°±æ˜¯ä¼˜åŒ–æˆ‘ä»¬çš„ Jenkins æµæ°´çº¿ä¸­åŒæ­¥ä¸¤ä¸ªé•œåƒä»“åº“çš„è¿‡ç¨‹ï¼Œä½¿ç”¨ äº† skopeo æ›¿ä»£ docker æ¥åŒæ­¥ä¸¤ä¸ªé•œåƒä»“åº“ä¸­çš„é•œåƒï¼Œå°†åŸæ¥éœ€è¦ 2h å°æ—¶ç¼©çŸ­åˆ°äº† 25min ğŸ˜€ã€‚</p>
<p>å…³äºè¿™ä¸ªå·¥å…·çš„è¯¦ç»†ä½¿ç”¨æ¨èå¤§å®¶å»è¯»ä¸€ä¸‹æˆ‘ä¹‹å‰å†™çš„ä¸€ç¯‡åšå®¢ <a href="https://blog.k8s.li/skopeo.html">é•œåƒæ¬è¿å·¥ skopeo åˆä½“éªŒ</a> ã€‚åœ¨è¿™é‡Œåªè®²ä¸¤ä¸ªæœ¨å­æœ€å¸¸ç”¨çš„åŠŸèƒ½ã€‚</p>
<h4 id="skopeo-copy"><a href="#skopeo-copy" class="headerlink" title="skopeo copy"></a>skopeo copy</h4><p>ä½¿ç”¨ skopeo copy ä¸¤ä¸ª registry ä¸­çš„é•œåƒæ—¶ï¼Œskopeo è¯·æ±‚ä¸¤ä¸ª registry API ç›´æ¥ copy <code>original blob</code> åˆ°å¦ä¸€ä¸ª registry ï¼Œè¿™æ ·å…å»äº†åƒ docker pull â€“&gt; docker tag â€“&gt; docker push é‚£æ · pull é•œåƒå¯¹é•œåƒè¿›è¡Œè§£å‹ç¼©ï¼Œpush é•œåƒè¿›è¡Œå‹ç¼©ã€‚å°¤å…¶æ˜¯åœ¨æ¬è¿ä¸€äº›è¾ƒå¤§çš„é•œåƒï¼ˆå‡  GB æˆ–è€…å‡ å GB çš„é•œåƒï¼Œæ¯”å¦‚ <code>nvidia/cuda</code> ï¼‰ï¼Œä½¿ç”¨ skopeo copy çš„åŠ é€Ÿæ•ˆæœååˆ†æ˜æ˜¾ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">DEBU<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Detected compression <span class="token function">format</span> <span class="token function">gzip</span>
DEBU<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Using original blob without modification

Getting image <span class="token builtin class-name">source</span> signatures
Copying blob 09a9f6a07669 <span class="token keyword">done</span>
Copying blob f8cdeb3c6c18 <span class="token keyword">done</span>
Copying blob 22c4d5853f25 <span class="token keyword">done</span>
Copying blob 76abc3f50d9b <span class="token keyword">done</span>
Copying blob 3386b7c9ccd4 <span class="token keyword">done</span>
Copying blob b9207193f1af <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>-------<span class="token punctuation">]</span> <span class="token number">224</span>.2MiB / <span class="token number">271</span>.2MiB
Copying blob 2f32d819e6ce <span class="token keyword">done</span>
Copying blob 5dbc3047e646 <span class="token keyword">done</span>
Copying blob f8dfcc3265c3 <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>-------------------<span class="token punctuation">]</span> <span class="token number">437</span>.1MiB / <span class="token number">864</span>.3MiB
Copying blob 13d3556105d1 <span class="token keyword">done</span>
Copying blob f9b7fa6a027e <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span>------------<span class="token punctuation">]</span> <span class="token number">84</span>.0MiB / <span class="token number">124</span>.3MiB
Copying blob a1a0f6abe73b <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">></span>-----------------<span class="token punctuation">]</span> <span class="token number">417</span>.9MiB / <span class="token number">749</span>.1MiB
Copying blob bcc9947fc8a4 <span class="token keyword">done</span>
Copying blob 9563b2824fef <span class="token keyword">done</span>
Copying blob a1b8faa0044b <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span>----------------------------------<span class="token punctuation">]</span> <span class="token number">88</span>.0MiB / <span class="token number">830</span>.1MiB
Copying blob 9917e218edfd <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">></span>----------------------<span class="token punctuation">]</span> <span class="token number">348</span>.6MiB / <span class="token number">803</span>.6MiB
Copying blob 776b9ff2f788 <span class="token keyword">done</span>
Copying config d0c3cfd730 <span class="token keyword">done</span>
Writing manifest to image destination
Storing signatures<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="skopeo-inspect"><a href="#skopeo-inspect" class="headerlink" title="skopeo inspect"></a>skopeo inspect</h4><p>ç”¨ skopeo inspect å‘½ä»¤å¯ä»¥å¾ˆæ–¹æ–¹ä¾¿åœ°é€šè¿‡ registry çš„ API æ¥æŸ¥çœ‹é•œåƒçš„ manifest æ–‡ä»¶ï¼Œä»¥å‰æˆ‘éƒ½æ˜¯ç”¨ curl å‘½ä»¤çš„ï¼Œè¦ token è¿˜è¦åŠ ä¸€å †å‚æ•°ï¼Œæ‰€ä»¥æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥åæ¥å°±ç”¨ä¸Šäº†  skopeo inspectğŸ˜€ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">root@deploy<span class="token operator">:</span>/root # skopeo inspect docker<span class="token operator">:</span><span class="token comment">//index.docker.io/webpsh/webps:latest --raw</span>
<span class="token punctuation">&#123;</span>
   <span class="token property">"schemaVersion"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
   <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
   <span class="token property">"config"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.container.image.v1+json"</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">2534</span><span class="token punctuation">,</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:30d9679b0b1ca7e56096eca0cdb7a6eedc29b63968f25156ef60dec27bc7d206"</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
   <span class="token property">"layers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
         <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="token punctuation">,</span>
         <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">2813316</span><span class="token punctuation">,</span>
         <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:cbdbe7a5bc2a134ca8ec91be58565ec07d037386d1f1d8385412d224deafca08"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
         <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="token punctuation">,</span>
         <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">8088920</span><span class="token punctuation">,</span>
         <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:54335262c2ed2d4155e62b45b187a1394fbb6f39e0a4a171ab8ce0c93789e6b0"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
         <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="token punctuation">,</span>
         <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">262</span><span class="token punctuation">,</span>
         <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:31555b34852eddc7c01f26fa9c0e5e577e36b4e7ccf1b10bec977eb4593a376b"</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="é•œåƒæ˜¯æ€ä¹ˆå­˜æ”¾çš„-äºŒ-registry-å­˜å‚¨-ğŸ™„"><a href="#é•œåƒæ˜¯æ€ä¹ˆå­˜æ”¾çš„-äºŒ-registry-å­˜å‚¨-ğŸ™„" class="headerlink" title="é•œåƒæ˜¯æ€ä¹ˆå­˜æ”¾çš„ (äºŒ) registry å­˜å‚¨ ğŸ™„"></a>é•œåƒæ˜¯æ€ä¹ˆå­˜æ”¾çš„ (äºŒ) registry å­˜å‚¨ ğŸ™„</h2><p>æ–‡ç« çš„å¼€å¤´æˆ‘ä»¬æåˆ°è¿‡ OCI è§„èŒƒä¸­çš„é•œåƒä»“åº“è§„èŒƒ <a target="_blank" rel="noopener" href="https://github.com/opencontainers/distribution-spec">distribution-spec</a>ï¼Œè¯¥è§„èŒƒå°±å®šä¹‰ç€å®¹å™¨é•œåƒå¦‚ä½•å­˜å‚¨åœ¨è¿œç«¯ï¼ˆå³ registryï¼‰ä¸Šã€‚æˆ‘ä»¬å¯ä»¥æŠŠ registry çœ‹ä½œé•œåƒçš„ä»“åº“ï¼Œä½¿ç”¨è¯¥è§„èŒƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬æŠŠè¿™äº›é•œåƒæŒ‰ç…§çº¦å®šä¿—æˆçš„æ ¼å¼æ¥å­˜æ”¾ï¼Œç›®å‰å®ç°è¯¥è§„èŒƒçš„ registry å°± docker å®¶çš„ registry ä½¿ç”¨çš„å¤šä¸€äº›ã€‚å…¶ä»–çš„ registry æ¯”å¦‚ harbor ï¼Œquay.io ä½¿ç”¨çš„ä¹Ÿæ¯”è¾ƒå¤šã€‚</p>
<h3 id="registry-x2F-registry-x2F-docker-x2F-v2"><a href="#registry-x2F-registry-x2F-docker-x2F-v2" class="headerlink" title="registry (&#x2F;registry&#x2F;docker&#x2F;v2)"></a>registry (&#x2F;registry&#x2F;docker&#x2F;v2)</h3><p>æƒ³è¦åˆ†æä¸€ä¸‹é•œåƒæ˜¯å¦‚ä½•å­˜æ”¾åœ¨ registry ä¸Šçš„ï¼Œæˆ‘ä»¬åœ¨æœ¬åœ°ä½¿ç”¨ docker run æ¥èµ· registry çš„å®¹å™¨å³å¯ï¼Œæˆ‘ä»¬ä»…ä»…æ˜¯æ¥åˆ†æ registry ä¸­é•œåƒæ—¶å¦‚ä½•å­˜å‚¨çš„ï¼Œè¿™ç§åœºæ™¯ä¸‹ä¸å¤ªé€‚åˆç”¨ harbor è¿™ç§é‡é‡çº§çš„ registry ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 /home/ubuntu
â•°â”€<span class="token comment"># docker run -d --name registry -p 5000:5000 -v /var/lib/registry:/var/lib/registry registry</span>
335ea763a2fa4508ebf3ec6f8b11f3b620a11bdcaa0ab43176b781427e0beee6<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å¯åŠ¨å®Œ registry å®¹å™¨ä¹‹åæˆ‘ä»¬ç»™ä¹‹å‰å·²ç»æ„å»ºå¥½çš„é•œåƒé‡æ–°æ‰“ä¸Šæ”¹ registry çš„ tag æ–¹ä¾¿åç»­ push åˆ° registry ä¸Šã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 ~/buster/slim
â•°â”€<span class="token comment"># docker tag debian:v1  localhost:5000/library/debian:v1</span>
â•­â”€root@sg-02 ~/buster/slim
â•°â”€<span class="token comment"># ^v1^v2</span>
â•­â”€root@sg-02 ~/buster/slim
â•°â”€<span class="token comment"># docker tag debian:v2  localhost:5000/library/debian:v2</span>
â•­â”€root@sg-02 ~/buster/slim
â•°â”€<span class="token comment"># docker images</span>
REPOSITORY                      TAG                 IMAGE ID            CREATED             SIZE
debian                          v2                  e6e782a57a51        <span class="token number">5</span> minutes ago       <span class="token number">69</span>.2MB
localhost:5000/library/debian   v2                  e6e782a57a51        <span class="token number">5</span> minutes ago       <span class="token number">69</span>.2MB
debian                          v1                  cfba37fd24f8        <span class="token number">9</span> minutes ago       <span class="token number">69</span>.2MB
localhost:5000/library/debian   v1                  cfba37fd24f8        <span class="token number">9</span> minutes ago       <span class="token number">69</span>.2MB
â•­â”€root@sg-02 ~/buster/slim
â•°â”€<span class="token comment"># docker push localhost:5000/library/debian:v1</span>
The push refers to repository <span class="token punctuation">[</span>localhost:5000/library/debian<span class="token punctuation">]</span>
d1b85e6186f6: Pushed
v1: digest: sha256:b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239 size: <span class="token number">529</span>
â•­â”€root@sg-02 ~/buster/slim
â•°â”€<span class="token comment"># docker push localhost:5000/library/debian:v2</span>
The push refers to repository <span class="token punctuation">[</span>localhost:5000/library/debian<span class="token punctuation">]</span>
d1b85e6186f6: Layer already exists
v2: digest: sha256:c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11 size: <span class="token number">529</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å½“æˆ‘ä»¬åœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ª registry å®¹å™¨ä¹‹åï¼Œå®¹å™¨å†…é»˜è®¤çš„å­˜å‚¨ä½ç½®ä¸º <code>/var/lib/registry</code> ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å¯åŠ¨çš„æ—¶å€™åŠ äº†å‚æ•° <code>-v /var/lib/registry:/var/lib/registry</code> å°†æœ¬æœºçš„è·¯å¾„æŒ‚è½½åˆ°å®¹å™¨å†…ã€‚è¿›å…¥è¿™é‡Œè·¯å¾„æˆ‘ä»¬ä½¿ç”¨ tree å‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç›®å½•çš„å­˜å‚¨ç»“æ„ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2
â•°â”€<span class="token comment"># tree -h</span>
<span class="token builtin class-name">.</span>
â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  blobs
â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  sha256
â”‚       â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  aa
â”‚       â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb
â”‚       â”‚       â””â”€â”€ <span class="token punctuation">[</span> 26M<span class="token punctuation">]</span>  data
â”‚       â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  b9
â”‚       â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239
â”‚       â”‚       â””â”€â”€ <span class="token punctuation">[</span> <span class="token number">529</span><span class="token punctuation">]</span>  data
â”‚       â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  c8
â”‚       â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11
â”‚       â”‚       â””â”€â”€ <span class="token punctuation">[</span> <span class="token number">529</span><span class="token punctuation">]</span>  data
â”‚       â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  cf
â”‚       â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d
â”‚       â”‚       â””â”€â”€ <span class="token punctuation">[</span><span class="token number">1</span>.4K<span class="token punctuation">]</span>  data
â”‚       â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  e6
â”‚           â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df
â”‚               â””â”€â”€ <span class="token punctuation">[</span><span class="token number">1</span>.4K<span class="token punctuation">]</span>  data
â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  repositories
    â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  library
        â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  debian
            â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  _layers
            â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  sha256
            â”‚       â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb
            â”‚       â”‚   â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
            â”‚       â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d
            â”‚       â”‚   â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
            â”‚       â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df
            â”‚           â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
            â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  _manifests
            â”‚   â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  revisions
            â”‚   â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  sha256
            â”‚   â”‚       â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239
            â”‚   â”‚       â”‚   â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
            â”‚   â”‚       â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11
            â”‚   â”‚           â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
            â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  tags
            â”‚       â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  v1
            â”‚       â”‚   â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  current
            â”‚       â”‚   â”‚   â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
            â”‚       â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  index
            â”‚       â”‚       â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  sha256
            â”‚       â”‚           â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239
            â”‚       â”‚               â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
            â”‚       â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  v2
            â”‚           â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  current
            â”‚           â”‚   â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
            â”‚           â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  index
            â”‚               â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  sha256
            â”‚                   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11
            â”‚                       â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
            â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  _uploads

<span class="token number">37</span> directories, <span class="token number">14</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ ‘å½¢çš„ç»“æ„çœ‹ç€ä¸å¤ªç›´è§‚ï¼Œæœ¨å­å°±ç”»äº†ä¸€å¼ å±‚çº§ç»“æ„çš„å›¾ï¼š</p>
<p><img data-src="https://p.k8s.li/registry-storage.jpeg"></p>
<h3 id="blobs-ç›®å½•"><a href="#blobs-ç›®å½•" class="headerlink" title="blobs ç›®å½•"></a>blobs ç›®å½•</h3><p>ä¹‹å‰æˆ‘ä»¬å‘ registry ç§æ¨é€äº†ä¸¤ä¸ªé•œåƒï¼Œè¿™ä¸¤ä¸ªé•œåƒçš„ layer ç›¸åŒä½†ä¸æ˜¯ç”¨ä¸€ä¸ªé•œåƒï¼Œåœ¨æˆ‘ä»¬ä¹‹å‰ push image çš„æ—¶å€™ä¹Ÿçœ‹åˆ°äº† <code>d1b85e6186f6: Layer already exists</code>ã€‚ä¹Ÿå°±å¯ä»¥è¯æ˜äº†ï¼Œè™½ç„¶ä¸¤ä¸ªé•œåƒä¸åŒï¼Œä½†å®ƒä»¬çš„ layer åœ¨ registry ä¸­å­˜å‚¨çš„æ—¶å€™å¯èƒ½æ˜¯ç›¸åŒçš„ã€‚</p>
<p>åœ¨ <code>blobs/sha256</code> ç›®å½•ä¸‹ä¸€å…±æœ‰ 5 ä¸ªåä¸º data çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ¨æµ‹ä¸€ä¸‹æœ€å¤§çš„é‚£ä¸ª <code>[ 26M]</code> åº”è¯¥æ˜¯é•œåƒçš„ layer ï¼Œæœ€å°çš„ <code>[ 529]</code> é‚£ä¸ªåº”è¯¥æ˜¯ manifestï¼Œå‰©ä¸‹çš„é‚£ä¸ª <code>[1.4K]</code> åº”è¯¥å°±æ˜¯ image config æ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/blobs/sha256
â•°â”€<span class="token comment"># tree -h</span>
<span class="token builtin class-name">.</span>
â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  aa
â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb
â”‚       â””â”€â”€ <span class="token punctuation">[</span> 26M<span class="token punctuation">]</span>  data
â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  b9
â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239
â”‚       â””â”€â”€ <span class="token punctuation">[</span> <span class="token number">529</span><span class="token punctuation">]</span>  data
â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  c8
â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11
â”‚       â””â”€â”€ <span class="token punctuation">[</span> <span class="token number">529</span><span class="token punctuation">]</span>  data
â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  cf
â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d
â”‚       â””â”€â”€ <span class="token punctuation">[</span><span class="token number">1</span>.4K<span class="token punctuation">]</span>  data
â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  e6
    â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df
        â””â”€â”€ <span class="token punctuation">[</span><span class="token number">1</span>.4K<span class="token punctuation">]</span>  data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨ <code>registry</code> çš„å­˜å‚¨ç›®å½•ä¸‹ï¼Œ<code>blobs</code> ç›®å½•ç”¨æ¥å­˜æ”¾é•œåƒçš„ä¸‰ç§æ–‡ä»¶ï¼š layer çš„çœŸå®æ•°æ®ï¼Œé•œåƒçš„ manifest æ–‡ä»¶ï¼Œé•œåƒçš„ image config æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶éƒ½æ˜¯ä»¥ <code>data</code> ä¸ºåçš„æ–‡ä»¶å­˜æ”¾åœ¨äºè¯¥æ–‡ä»¶ <code>sha256</code> ç›¸å¯¹åº”çš„ç›®å½•ä¸‹ã€‚ ä½¿ç”¨ä»¥å†…å®¹å¯»å€çš„ <code>sha256</code> æ•£åˆ—å­˜å‚¨æ–¹ä¾¿ç´¢å¼•æ–‡ä»¶ï¼Œåœ¨ <code>blob digest</code> ç›®å½•ä¸‹æœ‰ä¸€ä¸ªåä¸º <code>data</code> çš„æ–‡ä»¶ï¼Œå¯¹äº layer æ¥è®²ï¼Œè¿™æ˜¯ä¸ª <code>data</code> æ–‡ä»¶çš„æ ¼å¼æ˜¯ <code>vnd.docker.image.rootfs.diff.tar.gzip</code> ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>tar -xvf</code> å‘½ä»¤å°†è¿™ä¸ª layer è§£å¼€ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ docker pull å‘½ä»¤æ‹‰å–é•œåƒçš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å»ä¸‹è½½è¿™ä¸ª <code>data</code> æ–‡ä»¶ï¼Œä¸‹è½½å®Œæˆä¹‹åä¼šæœ‰ä¸€ä¸ª <code>docker-untar</code> çš„è¿›ç¨‹å°†è¿™ä¸ª <code>data</code> æ–‡ä»¶è§£å¼€å­˜æ”¾åœ¨ <code>/var/lib/docker/overlay2/$&#123;digest&#125;/diff</code> ç›®å½•ä¸‹ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  blobs
â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  sha256
â”‚       â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  aa
â”‚       â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb
â”‚       â”‚       â””â”€â”€ <span class="token punctuation">[</span> 26M<span class="token punctuation">]</span>  data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="manifest-æ–‡ä»¶"><a href="#manifest-æ–‡ä»¶" class="headerlink" title="manifest æ–‡ä»¶"></a>manifest æ–‡ä»¶</h4><p>å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ json æ–‡ä»¶å•¦ï¼Œè®°å½•äº†ä¸€ä¸ªé•œåƒæ‰€åŒ…å«çš„ layer ä¿¡æ¯ï¼Œå½“æˆ‘ä»¬ pull é•œåƒçš„æ—¶å€™ä¼šä½¿ç”¨åˆ°è¿™ä¸ªæ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">â•­â”€root@sg<span class="token number">-02</span> /var/lib/registry/docker/registry/v2/blobs/sha256/b9/b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239
â•°â”€# cat data
<span class="token punctuation">&#123;</span>
   <span class="token property">"schemaVersion"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
   <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
   <span class="token property">"config"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.container.image.v1+json"</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1462</span><span class="token punctuation">,</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d"</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
   <span class="token property">"layers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
         <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="token punctuation">,</span>
         <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">27097859</span><span class="token punctuation">,</span>
         <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb"</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>#<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="image-config-æ–‡ä»¶"><a href="#image-config-æ–‡ä»¶" class="headerlink" title="image config æ–‡ä»¶"></a>image config æ–‡ä»¶</h4><p>image config æ–‡ä»¶é‡Œå¹¶æ²¡æœ‰åŒ…å«é•œåƒçš„ tag ä¿¡æ¯ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">â•­â”€root@sg<span class="token number">-02</span> /var/lib/registry/docker/registry/v2/blobs/sha256/e6/e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df
â•°â”€# cat data | jq <span class="token string">"."</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>
  <span class="token property">"config"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"Hostname"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"Domainname"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"User"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"AttachStdin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"AttachStdout"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"AttachStderr"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"Tty"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"OpenStdin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"StdinOnce"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"Env"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"Cmd"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"bash"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"Image"</span><span class="token operator">:</span> <span class="token string">"sha256:ba8f577813c7bdf6b737f638dffbc688aa1df2ff28a826a6c46bae722977b549"</span><span class="token punctuation">,</span>
    <span class="token property">"Volumes"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"WorkingDir"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"Entrypoint"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"OnBuild"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"Labels"</span><span class="token operator">:</span> <span class="token null keyword">null</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"container"</span><span class="token operator">:</span> <span class="token string">"38501d5aa48c080884f4dc6fd4b1b6590ff1607d9e7a12e1cef1d86a3fdc32df"</span><span class="token punctuation">,</span>
  <span class="token property">"container_config"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"Hostname"</span><span class="token operator">:</span> <span class="token string">"38501d5aa48c"</span><span class="token punctuation">,</span>
    <span class="token property">"Domainname"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"User"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"AttachStdin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"AttachStdout"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"AttachStderr"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"Tty"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"OpenStdin"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"StdinOnce"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token property">"Env"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"Cmd"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"/bin/sh"</span><span class="token punctuation">,</span>
      <span class="token string">"-c"</span><span class="token punctuation">,</span>
      <span class="token string">"#(nop) "</span><span class="token punctuation">,</span>
      <span class="token string">"CMD [\"bash\"]"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"Image"</span><span class="token operator">:</span> <span class="token string">"sha256:ba8f577813c7bdf6b737f638dffbc688aa1df2ff28a826a6c46bae722977b549"</span><span class="token punctuation">,</span>
    <span class="token property">"Volumes"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"WorkingDir"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token property">"Entrypoint"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"OnBuild"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"Labels"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"2020-06-07T01:59:47.348924716Z"</span><span class="token punctuation">,</span>
  <span class="token property">"docker_version"</span><span class="token operator">:</span> <span class="token string">"19.03.5"</span><span class="token punctuation">,</span>
  <span class="token property">"history"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"2020-06-07T01:59:46.877600299Z"</span><span class="token punctuation">,</span>
      <span class="token property">"created_by"</span><span class="token operator">:</span> <span class="token string">"/bin/sh -c #(nop) ADD file:a82014afc29e7b364ac95223b22ebafad46cc9318951a85027a49f9ce1a99461 in / "</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"created"</span><span class="token operator">:</span> <span class="token string">"2020-06-07T01:59:47.348924716Z"</span><span class="token punctuation">,</span>
      <span class="token property">"created_by"</span><span class="token operator">:</span> <span class="token string">"/bin/sh -c #(nop)  CMD [\"bash\"]"</span><span class="token punctuation">,</span>
      <span class="token property">"empty_layer"</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>
  <span class="token property">"rootfs"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"layers"</span><span class="token punctuation">,</span>
    <span class="token property">"diff_ids"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"sha256:d1b85e6186f67d9925c622a7a6e66faa447e767f90f65ae47cdc817c629fa956"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="uploads-æ–‡ä»¶å¤¹"><a href="#uploads-æ–‡ä»¶å¤¹" class="headerlink" title="_uploads æ–‡ä»¶å¤¹"></a>_uploads æ–‡ä»¶å¤¹</h4><p>_uploads æ–‡ä»¶å¤¹æ˜¯ä¸ªä¸´æ—¶çš„æ–‡ä»¶å¤¹ï¼Œä¸»è¦ç”¨æ¥å­˜æ”¾ push é•œåƒè¿‡ç¨‹ä¸­çš„æ–‡ä»¶æ•°æ®ï¼Œå½“é•œåƒ <code>layer</code> ä¸Šä¼ å®Œæˆä¹‹åä¼šæ¸…ç©ºè¯¥æ–‡ä»¶å¤¹ã€‚å…¶ä¸­çš„ <code>data</code> æ–‡ä»¶ä¸Šä¼ å®Œæ¯•åä¼šç§»åŠ¨åˆ° <code>blobs</code> ç›®å½•ä¸‹ï¼Œæ ¹æ®è¯¥æ–‡ä»¶çš„ <code>sha256</code> å€¼æ¥è¿›è¡Œæ•£åˆ—å­˜å‚¨åˆ°ç›¸åº”çš„ç›®å½•ä¸‹ã€‚</p>
<p>ä¸Šä¼ è¿‡ç¨‹ä¸­çš„ç›®å½•ç»“æ„ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">_uploads
â”œâ”€â”€ <span class="token punctuation">[</span>  <span class="token number">53</span><span class="token punctuation">]</span>  0d6c996e-638f-4436-b2b6-54fa7ad430d2
â”‚   â”œâ”€â”€ <span class="token punctuation">[</span>198M<span class="token punctuation">]</span>  data
â”‚   â”œâ”€â”€ <span class="token punctuation">[</span>  <span class="token number">20</span><span class="token punctuation">]</span>  hashstates
â”‚   â”‚   â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">15</span><span class="token punctuation">]</span>  sha256
â”‚   â”‚       â””â”€â”€ <span class="token punctuation">[</span> <span class="token number">108</span><span class="token punctuation">]</span>  <span class="token number">0</span>
â”‚   â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">20</span><span class="token punctuation">]</span>  startedat
â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">53</span><span class="token punctuation">]</span>  ba31818e-4217-47ef-ae46-2784c9222614
    â”œâ”€â”€ <span class="token punctuation">[</span>571M<span class="token punctuation">]</span>  data
    â”œâ”€â”€ <span class="token punctuation">[</span>  <span class="token number">20</span><span class="token punctuation">]</span>  hashstates
    â”‚   â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">15</span><span class="token punctuation">]</span>  sha256
    â”‚       â””â”€â”€ <span class="token punctuation">[</span> <span class="token number">108</span><span class="token punctuation">]</span>  <span class="token number">0</span>
    â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">20</span><span class="token punctuation">]</span>  startedat

<span class="token number">6</span> directories, <span class="token number">6</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>ä¸Šä¼ å®Œé•œåƒä¹‹åï¼Œ<code>_uploads</code> æ–‡ä»¶å¤¹å°±ä¼šè¢«æ¸…ç©ºï¼Œæ­£å¸¸æƒ…å†µä¸‹è¿™ä¸ªæ–‡ä»¶å¤¹æ˜¯ç©ºçš„ã€‚ä½†ä¹Ÿæœ‰å¼‚å¸¸çš„æ—¶å€™ ğŸ˜‚ï¼Œæ¯”å¦‚ç½‘ç»œæŠ–åŠ¨å¯¼è‡´ä¸Šä¼ æ„å¤–ä¸­æ–­ï¼Œè¯¥æ–‡ä»¶å¤¹å°±å¯èƒ½ä¸ä¸ºç©ºã€‚</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">_uploads

<span class="token number">0</span> directories, <span class="token number">0</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="manifests-æ–‡ä»¶å¤¹"><a href="#manifests-æ–‡ä»¶å¤¹" class="headerlink" title="_manifests æ–‡ä»¶å¤¹"></a>_manifests æ–‡ä»¶å¤¹</h4><p><code>_manifests</code> æ–‡ä»¶å¤¹æ˜¯é•œåƒä¸Šä¼ å®Œæˆä¹‹åç”± registry æ¥ç”Ÿæˆçš„ï¼Œå¹¶ä¸”è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªåä¸º <code>link</code> çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå®ƒçš„å€¼æŒ‡å‘ blobs ç›®å½•ä¸‹ä¸ä¹‹å¯¹åº”çš„ç›®å½•ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/repositories/library
â•°â”€<span class="token comment"># find . -type f</span>
./debian/_layers/sha256/aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb/link
./debian/_layers/sha256/e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df/link
./debian/_layers/sha256/cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d/link
./debian/_manifests/tags/v2/current/link
./debian/_manifests/tags/v2/index/sha256/c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11/link
./debian/_manifests/tags/v1/current/link
./debian/_manifests/tags/v1/index/sha256/b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239/link
./debian/_manifests/revisions/sha256/b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239/link
./debian/_manifests/revisions/sha256/c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11/link<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>_manifests</code> æ–‡ä»¶å¤¹ä¸‹åŒ…å«ç€é•œåƒçš„ <code>tags</code> å’Œ <code>revisions</code> ä¿¡æ¯ï¼Œæ¯ä¸€ä¸ªé•œåƒçš„æ¯ä¸€ä¸ª tag å¯¹åº”ç€äº tag åç›¸åŒçš„ç›®å½•ã€‚é•œåƒçš„ tag å¹¶ä¸å­˜å‚¨åœ¨ image config ä¸­ï¼Œè€Œæ˜¯ä»¥ç›®å½•çš„å½¢å¼æ¥å½¢æˆé•œåƒçš„ tagï¼Œè¿™ä¸€ç‚¹æ¯”è¾ƒå¥‡å¦™ï¼Œè¿™å’Œæˆ‘ä»¬ Dockerfile ä¸­å¹¶ä¸åŒ…å«é•œåƒåå’Œ tag ä¸€ä¸ªé“ç†ï¼Ÿ</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">.</span>
â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  _layers
â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  sha256
â”‚       â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb
â”‚       â”‚   â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
â”‚       â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d
â”‚       â”‚   â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
â”‚       â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df
â”‚           â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  _manifests
â”‚   â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  revisions
â”‚   â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  sha256
â”‚   â”‚       â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239
â”‚   â”‚       â”‚   â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
â”‚   â”‚       â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11
â”‚   â”‚           â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  tags
â”‚       â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  v1
â”‚       â”‚   â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  current
â”‚       â”‚   â”‚   â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
â”‚       â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  index
â”‚       â”‚       â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  sha256
â”‚       â”‚           â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239
â”‚       â”‚               â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
â”‚       â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  v2
â”‚           â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  current
â”‚           â”‚   â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
â”‚           â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  index
â”‚               â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  sha256
â”‚                   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11
â”‚                       â””â”€â”€ <span class="token punctuation">[</span>  <span class="token number">71</span><span class="token punctuation">]</span>  <span class="token function">link</span>
â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  _uploads

<span class="token number">22</span> directories, <span class="token number">9</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="é•œåƒçš„-tag"><a href="#é•œåƒçš„-tag" class="headerlink" title="é•œåƒçš„ tag"></a>é•œåƒçš„ tag</h4><p>æ¯ä¸ª <code>tag</code> åç›®å½•ä¸‹é¢æœ‰ <code>current</code> ç›®å½•å’Œ <code>index</code> ç›®å½•ï¼Œ <code>current</code> ç›®å½•ä¸‹çš„ link æ–‡ä»¶ä¿å­˜äº†è¯¥ tag ç›®å‰çš„ manifest æ–‡ä»¶çš„ sha256 ç¼–ç ï¼Œå¯¹åº”åœ¨ <code>blobs</code> ä¸­çš„ <code>sha256</code> ç›®å½•ä¸‹çš„ <code>data</code> æ–‡ä»¶ï¼Œè€Œ <code>index</code> ç›®å½•åˆ™åˆ—å‡ºäº†è¯¥ <code>tag</code> å†å²ä¸Šä¼ çš„æ‰€æœ‰ç‰ˆæœ¬çš„ <code>sha256</code> ç¼–ç ä¿¡æ¯ã€‚<code>_revisions</code> ç›®å½•é‡Œå­˜æ”¾äº†è¯¥ <code>repository</code> å†å²ä¸Šä¸Šä¼ ç‰ˆæœ¬çš„æ‰€æœ‰ sha256 ç¼–ç ä¿¡æ¯ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/repositories/library/debian/_manifests/tags/v1
â•°â”€<span class="token comment"># cat current/link</span>
sha256:b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239
â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/blobs/sha256
â•°â”€<span class="token comment"># tree -h</span>
<span class="token builtin class-name">.</span>
â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  aa
â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb
â”‚       â””â”€â”€ <span class="token punctuation">[</span> 26M<span class="token punctuation">]</span>  data
â”œâ”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  b9
â”‚   â””â”€â”€ <span class="token punctuation">[</span><span class="token number">4</span>.0K<span class="token punctuation">]</span>  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239
â”‚       â””â”€â”€ <span class="token punctuation">[</span> <span class="token number">529</span><span class="token punctuation">]</span>  data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å½“æˆ‘ä»¬ <code>pull</code> é•œåƒçš„æ—¶å€™å¦‚æœä¸æŒ‡å®šé•œåƒçš„ <code>tag</code> åï¼Œé»˜è®¤å°±æ˜¯ latestï¼Œregistry ä¼šä» HTTP è¯·æ±‚ä¸­è§£æåˆ°è¿™ä¸ª tag åï¼Œç„¶åæ ¹æ® tag åç›®å½•ä¸‹çš„ link æ–‡ä»¶æ‰¾åˆ°è¯¥é•œåƒçš„ manifest çš„ä½ç½®è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ¥ç€å»è¯·æ±‚è¿™ä¸ª manifest æ–‡ä»¶ï¼Œå®¢æˆ·ç«¯æ ¹æ®è¿™ä¸ª manifest æ–‡ä»¶æ¥ pull ç›¸åº”çš„é•œåƒ layer ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">â•­â”€root@sg<span class="token number">-02</span> /var/lib/registry/docker/registry/v2/repositories/library/debian/_manifests/tags/v1
â•°â”€# cat  /var/lib/registry/docker/registry/v2/blobs/sha256/b9/b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239/data
<span class="token punctuation">&#123;</span>
   <span class="token property">"schemaVersion"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
   <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
   <span class="token property">"config"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.container.image.v1+json"</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">1462</span><span class="token punctuation">,</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d"</span>
   <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
   <span class="token property">"layers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
         <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span><span class="token punctuation">,</span>
         <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">27097859</span><span class="token punctuation">,</span>
         <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb"</span>
      <span class="token punctuation">&#125;</span>
   <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æœ€åå†è¡¥å……ä¸€ç‚¹å°±æ˜¯ï¼ŒåŒä¸€ä¸ªé•œåƒåœ¨ registry ä¸­å­˜å‚¨çš„ä½ç½®æ˜¯ç›¸åŒçš„ï¼Œå…·ä½“çš„åˆ†æå¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://supereagle.github.io/2018/04/24/docker-registry/">é•œåƒä»“åº“ä¸­é•œåƒå­˜å‚¨çš„åŸç†è§£æ</a> è¿™ç¯‡åšå®¢ã€‚</p>
<blockquote>
<ul>
<li>é€šè¿‡ Registry API è·å¾—çš„ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ manifest ä¿¡æ¯å®Œå…¨ç›¸åŒã€‚</li>
<li>ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ manifest ä¿¡æ¯çš„å­˜å‚¨è·¯å¾„å’Œå†…å®¹å®Œå…¨ç›¸åŒã€‚</li>
<li>ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ blob ä¿¡æ¯çš„å­˜å‚¨è·¯å¾„å’Œå†…å®¹å®Œå…¨ç›¸åŒã€‚</li>
</ul>
</blockquote>
<p>ä»ä¸Šé¢è¿™ä¸‰ä¸ªç»“è®ºä¸­æˆ‘ä»¬å¯ä»¥æ¨æ–­å‡º registry å­˜å‚¨ç›®å½•é‡Œå¹¶ä¸ä¼šå­˜å‚¨ä¸è¯¥ registry ç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”æˆ‘ä»¬ push é•œåƒçš„æ—¶å€™éœ€è¦ç»™é•œåƒåŠ ä¸Š <code>localhost:5000</code> è¿™ä¸ªå‰ç¼€ï¼Œè¿™ä¸ªå‰ç¼€å¹¶ä¸ä¼šå­˜å‚¨åœ¨ registry å­˜å‚¨ä¸­ã€‚åŠ å…¥æˆ‘è¦è¿ç§»ä¸€ä¸ªå¾ˆå¤§çš„ registry é•œåƒä»“åº“ï¼Œé•œåƒçš„æ•°é‡åœ¨ 5k ä»¥ä¸Šã€‚æœ€ä¾¿æ·çš„åŠæ³•å°±æ˜¯æ‰“åŒ…è¿™ä¸ª registry å­˜å‚¨ç›®å½•ï¼Œå°†è¿™ä¸ª tar åŒ… rsync åˆ°å¦ä¸€å°æœºå™¨å³å¯ã€‚éœ€è¦å¼ºè°ƒä¸€ç‚¹ï¼Œæ‰“åŒ… registry å­˜å‚¨ç›®å½•çš„æ—¶å€™ä¸éœ€è¦è¿›è¡Œå‹ç¼©ï¼Œç›´æ¥ <code>tar -cvf</code> å³å¯ã€‚å› ä¸º registry å­˜å‚¨çš„é•œåƒ layer å·²ç»æ˜¯ä¸ª <code>tar.gzip</code> æ ¼å¼çš„æ–‡ä»¶ï¼Œå†è¿›è¡Œå‹ç¼©çš„è¯æ•ˆæœç”šå¾®è€Œä¸”è¿˜æµªè´¹ CPU æ—¶é—´å¾—ä¸å¿å¤±ã€‚</p>
<h3 id="docker-archive"><a href="#docker-archive" class="headerlink" title="docker-archive"></a>docker-archive</h3><p>æœ¬æ¥æˆ‘æƒ³ç€ docker save å‡ºæ¥çš„å¹¶ä¸æ˜¯ä¸€ä¸ªé•œåƒï¼Œè€Œæ˜¯ä¸€ä¸ª <code>.tar</code> æ–‡ä»¶ï¼Œä½†æˆ‘æƒ³äº†åˆæƒ³ï¼Œè¿˜æ˜¯è§‰ç€å®ƒæ˜¯ä¸€ä¸ªé•œåƒï¼Œåªä¸è¿‡å­˜åœ¨çš„æ–¹å¼ä¸åŒè€Œå·²ã€‚äºåœ¨ docker å’Œ registry ä¸­å­˜æ”¾çš„æ–¹å¼ä¸åŒï¼Œä½¿ç”¨ docker save å‡ºæ¥çš„é•œåƒæ˜¯ä¸€ä¸ªå­¤ç«‹çš„å­˜åœ¨ã€‚å°±åƒæ˜¯ä»è›‹ç³•åº—é‡Œæ‹¿å‡ºæ¥çš„è›‹ç³•ï¼Œå¤–é¢è‚¯å®šè¦æœ‰ä¸ªç²¾ç¾çš„åŒ…è£…æ˜¯å§ï¼Œä½ æ€»æ²¡è§è¿‡ã€‚æ”¾åœ¨å“ªé‡Œéƒ½å¯ä»¥ï¼Œä½¿ç”¨çš„æ—¶å€™æˆ‘ä»¬ä½¿ç”¨ docker load æ‹†å¼€å¤–åŒ…è£…(<code>.tar</code>)å°±å¯ã€‚æ¯”å¦‚æˆ‘ä»¬ç¦»çº¿éƒ¨ç½² harbor çš„æ—¶å€™å°±æ˜¯ä½¿ç”¨å®˜æ–¹çš„é•œåƒ tar åŒ…æ¥è¿›è¡ŒåŠ è½½é•œåƒå¯åŠ¨å®¹å™¨çš„ã€‚</p>
<h2 id="é•œåƒæ˜¯æ€ä¹ˆé£Ÿç”¨çš„-ğŸ˜‹"><a href="#é•œåƒæ˜¯æ€ä¹ˆé£Ÿç”¨çš„-ğŸ˜‹" class="headerlink" title="é•œåƒæ˜¯æ€ä¹ˆé£Ÿç”¨çš„ ğŸ˜‹"></a>é•œåƒæ˜¯æ€ä¹ˆé£Ÿç”¨çš„ ğŸ˜‹</h2><p>å½“æˆ‘ä»¬æ‹¿åˆ°ä¸€ä¸ªé•œåƒä¹‹åï¼Œå¦‚æœç”¨å®ƒæ¥å¯åŠ¨ä¸€ä¸ªå®¹å™¨å‘¢ï¼Ÿè¿™é‡Œå°±æ¶‰åŠåˆ°äº† OCI è§„èŒƒä¸­çš„å¦ä¸€ä¸ªè§„èŒƒå³è¿è¡Œæ—¶è§„èŒƒ <a target="_blank" rel="noopener" href="https://github.com/opencontainers/runtime-spec">runtime-spec</a> ã€‚å®¹å™¨è¿è¡Œæ—¶é€šè¿‡ä¸€ä¸ªå« <a target="_blank" rel="noopener" href="https://github.com/opencontainers/runtime-spec/blob/master/bundle.md"> OCI runtime filesytem bundle</a> çš„æ ‡å‡†æ ¼å¼å°† OCI é•œåƒé€šè¿‡å·¥å…·è½¬æ¢ä¸º bundle ï¼Œç„¶å OCI å®¹å™¨å¼•æ“èƒ½å¤Ÿè¯†åˆ«è¿™ä¸ª bundle æ¥è¿è¡Œå®¹å™¨ã€‚</p>
<blockquote>
<p>filesystem bundle æ˜¯ä¸ªç›®å½•ï¼Œç”¨äºç»™ runtime æä¾›å¯åŠ¨å®¹å™¨å¿…å¤‡çš„é…ç½®æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿã€‚æ ‡å‡†çš„å®¹å™¨ bundle åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>config.json: è¯¥æ–‡ä»¶åŒ…å«äº†å®¹å™¨è¿è¡Œçš„é…ç½®ä¿¡æ¯ï¼Œè¯¥æ–‡ä»¶å¿…é¡»å­˜åœ¨ bundle çš„æ ¹ç›®å½•ï¼Œä¸”åå­—å¿…é¡»ä¸º config.json</li>
<li>å®¹å™¨çš„æ ¹ç›®å½•ï¼Œå¯ä»¥ç”± config.json ä¸­çš„ root.path æŒ‡å®š</li>
</ul>
</blockquote>
<p><img data-src="https://p.k8s.li/20200609_oci-04.jpg"></p>
<h3 id="docker-run"><a href="#docker-run" class="headerlink" title="docker run"></a>docker run</h3><p>å½“æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªå®¹å™¨ä¹‹åæˆ‘ä»¬ä½¿ç”¨ tree å‘½ä»¤æ¥åˆ†æä¸€ä¸‹ overlay2 å°±ä¼šå‘ç°ï¼Œè¾ƒä¹‹å‰çš„ç›®å½•ï¼Œå®¹å™¨å¯åŠ¨ä¹‹å overlay2 ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ª <code>merged</code> çš„æ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹å°±æ˜¯å®¹å™¨å†…çœ‹åˆ°çš„ã€‚docker é€šè¿‡ overlayfs è”åˆæŒ‚è½½çš„æŠ€æœ¯å°†é•œåƒçš„å¤šå±‚ layer æŒ‚è½½ä¸ºä¸€å±‚ï¼Œè¿™å±‚çš„å†…å®¹å°±æ˜¯å®¹å™¨é‡Œæ‰€çœ‹åˆ°çš„ï¼Œä¹Ÿå°±æ˜¯ merged æ–‡ä»¶å¤¹ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">â•­â”€root@sg-02 /var/lib/docker
â•°â”€<span class="token comment"># tree overlay2 -d -L 3</span>
overlay2
â”œâ”€â”€ 259cf6934509a674b1158f0a6c90c60c133fd11189f98945c7c3a524784509ff
â”‚   â””â”€â”€ <span class="token function">diff</span>
â”‚       â”œâ”€â”€ bin
<span class="token operator">|</span>
â”‚       â””â”€â”€ var
â”œâ”€â”€ 27f9e9b74a88a269121b4e77330a665d6cca4719cb9a58bfc96a2b88a07af805
â”‚   â”œâ”€â”€ <span class="token function">diff</span>
â”‚   â””â”€â”€ work
â”œâ”€â”€ 5f85c914c55220ec2635bce0080d2ad677f739dcfac4fd266b773625e3051844
â”‚   â”œâ”€â”€ <span class="token function">diff</span>
â”‚   â”‚   â””â”€â”€ var
â”‚   â”œâ”€â”€ merged
â”‚   â”‚   â”œâ”€â”€ bin
â”‚   â”‚   â”œâ”€â”€ dev
â”‚   â”‚   â”œâ”€â”€ etc
â”‚   â”‚   â”œâ”€â”€ home
â”‚   â”‚   â”œâ”€â”€ lib
â”‚   â”‚   â”œâ”€â”€ media
â”‚   â”‚   â”œâ”€â”€ mnt
â”‚   â”‚   â”œâ”€â”€ proc
â”‚   â”‚   â”œâ”€â”€ root
â”‚   â”‚   â”œâ”€â”€ run
â”‚   â”‚   â”œâ”€â”€ sbin
â”‚   â”‚   â”œâ”€â”€ srv
â”‚   â”‚   â”œâ”€â”€ sys
â”‚   â”‚   â”œâ”€â”€ tmp
â”‚   â”‚   â”œâ”€â”€ usr
â”‚   â”‚   â””â”€â”€ var
â”‚   â””â”€â”€ work
â”‚       â””â”€â”€ work
â”œâ”€â”€ 5f85c914c55220ec2635bce0080d2ad677f739dcfac4fd266b773625e3051844-init
â”‚   â”œâ”€â”€ <span class="token function">diff</span>
â”‚   â”‚   â”œâ”€â”€ dev
â”‚   â”‚   â””â”€â”€ etc
â”‚   â””â”€â”€ work
â”‚       â””â”€â”€ work<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">overlay on / <span class="token builtin class-name">type</span> overlay <span class="token punctuation">(</span>rw,relatime,lowerdir<span class="token operator">=</span>/opt/docker/overlay2/l/4EPD2X5VF62FH5PZOZHZDKAKGL:/opt/docker/overlay2/l/MYRYBGZRI4I76MJWQHN7VLZXLW:/opt/docker/overlay2/l/5RZOXYR35NSGAWTI36CVUIRW7U:/opt/docker/overlay2/l/LBWRL4ZXGBWOTN5JDCDZVNOY7H:/opt/docker/overlay2/l/526XCHXRJMZXRIHN4YWJH2QLPY:/opt/docker/overlay2/l/XK5IA4BWQ2CIS667J3SXPXGQK5,upperdir<span class="token operator">=</span>/opt/docker/overlay2/f913d81219134e23eb0827a1c27668494dfaea2f1b5d1d0c70382366eabed629/diff,workdir<span class="token operator">=</span>/opt/docker/overlay2/f913d81219134e23eb0827a1c27668494dfaea2f1b5d1d0c70382366eabed629/work<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>ä» docker å®˜æ–¹æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/overlayfs-driver/">Use the OverlayFS storage driver</a> é‡Œå·æ¥çš„ä¸€å¼ å›¾ç‰‡</p>
<p><img data-src="https://p.k8s.li/overlay_constructs.jpg"></p>
<p>å…³äºä¸Šå›¾ä¸­è¿™äº› Dir çš„ä½œç”¨ï¼Œä¸‹é¢æ˜¯ä¸€æ®µä» <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/56550890/docker-image-merged-diff-work-lowerdir-components-of-graphdriver">StackOverflow</a> ä¸Šæ¬è¿è¿‡æ¥çš„è§£é‡Šã€‚</p>
<blockquote>
<p><strong>LowerDir</strong>: these are the read-only layers of an overlay filesystem. For docker, these are the image layers assembled in order.</p>
<p><strong>UpperDir</strong>: this is the read-write layer of an overlay filesystem. For docker, that is the equivalent of the container specific layer that contains changes made by that container.</p>
<p><strong>WorkDir</strong>: this is a required directory for overlay, it needs an empty directory for internal use.</p>
<p><strong>MergedDir</strong>: this is the result of the overlay filesystem. Docker effectively chrootâ€™s into this directory when running the container.</p>
</blockquote>
<p>å¦‚æœæƒ³å¯¹ overlayfs æ–‡ä»¶ç³»ç»Ÿæœ‰è¯¦ç»†çš„äº†è§£ï¼Œå¯ä»¥å‚è€ƒ Linux å†…æ ¸å®˜ç½‘ä¸Šçš„è¿™ç¯‡æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt">overlayfs.txt</a> ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><h3 id="å®˜æ–¹æ–‡æ¡£"><a href="#å®˜æ–¹æ–‡æ¡£" class="headerlink" title="å®˜æ–¹æ–‡æ¡£"></a>å®˜æ–¹æ–‡æ¡£</h3><ul>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/develop/develop-images/baseimages/">Create a base image</a></li>
<li><a target="_blank" rel="noopener" href="https://hub.docker.com/_/scratch">FROM scratch</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/registry/">Docker Registry</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/docker/distribution/blob/master/docs/spec/manifest-v2-2.md">Image Manifest Version 2, Schema 2</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/registry/spec/api/">Docker Registry HTTP API V2</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/containers/image">image</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec">OCI Image Manifest Specification</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/opencontainers/distribution-spec">distribution-spec</a></li>
<li><a target="_blank" rel="noopener" href="https://doi-janky.infosiftr.net/job/tianon/job/debuerreotype/">debuerreotype&#x2F;</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt">overlayfs.txt</a></li>
</ul>
<h3 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h3><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/docker-library/oi-janky-groovy">oi-janky-groovy</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/debuerreotype/docker-debian-artifacts">docker-debian-artifacts</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/NotGlop/docker-drag">docker-drag</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/deislabs/oras">oras</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/containers/skopeo">skopeo</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/vbatts/tar-split">tar-split</a></li>
</ul>
<h3 id="åšå®¢"><a href="#åšå®¢" class="headerlink" title="åšå®¢"></a>åšå®¢</h3><ul>
<li><a target="_blank" rel="noopener" href="https://supereagle.github.io/2018/04/24/docker-registry/">é•œåƒä»“åº“ä¸­é•œåƒå­˜å‚¨çš„åŸç†è§£æ</a></li>
<li><a target="_blank" rel="noopener" href="https://fuckcloudnative.io/posts/how-manage-image/">docker åœ¨æœ¬åœ°å¦‚ä½•ç®¡ç† imageï¼ˆé•œåƒï¼‰?</a></li>
<li><a target="_blank" rel="noopener" href="http://gaocegege.com/Blog/ormb">ormbï¼šåƒç®¡ç† Docker å®¹å™¨é•œåƒä¸€æ ·ç®¡ç†æœºå™¨å­¦ä¹ æ¨¡å‹</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.fleeto.us/post/how-are-docker-images-built/">é•œåƒæ˜¯æ€æ ·ç‚¼æˆçš„</a></li>
<li><a target="_blank" rel="noopener" href="https://duyanghao.github.io/docker-registry-pull-manifest-v2/">docker pull åˆ†æ</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/helios741/myblog/blob/new/learn_go/src/2019/20191206_docker_disk_storage/README.md">æµ…è°ˆ docker ä¸­é•œåƒå’Œå®¹å™¨åœ¨æœ¬åœ°çš„å­˜å‚¨</a></li>
<li><a target="_blank" rel="noopener" href="https://www.qedev.com/cloud/103860.html">å®¹å™¨ OCI è§„èŒƒ é•œåƒè§„èŒƒ</a></li>
<li><a target="_blank" rel="noopener" href="https://xuanwo.io/2019/08/06/oci-intro/">å¼€æ”¾å®¹å™¨æ ‡å‡†(OCI) å†…éƒ¨åˆ†äº«</a></li>
<li><a target="_blank" rel="noopener" href="https://wilhelmguo.cn/blog/post/william/%E5%AE%B9%E5%99%A8%E5%BC%80%E6%94%BE%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83%EF%BC%88CRI-OCI%EF%BC%89-2">å®¹å™¨å¼€æ”¾æ¥å£è§„èŒƒï¼ˆCRI OCIï¼‰</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000014284289">Docker é•œåƒçš„å­˜å‚¨æœºåˆ¶</a></li>
<li><a target="_blank" rel="noopener" href="http://open.daocloud.io/docker-source-code-analysis-part10/">Docker æºç åˆ†æï¼ˆåï¼‰ï¼šDocker é•œåƒä¸‹è½½</a></li>
<li><a target="_blank" rel="noopener" href="http://open.daocloud.io/docker-source-code-analysis-part9/">Docker æºç åˆ†æï¼ˆä¹ï¼‰ï¼šDocker é•œåƒ</a></li>
<li><a target="_blank" rel="noopener" href="https://www.twblogs.net/a/5b8aab392b71775d1ce86eca">docker push éç¨‹ distribution æºç¢¼ åˆ†æ</a></li>
<li><a target="_blank" rel="noopener" href="http://open.daocloud.io/tag/allen-tan-docker/">Allen è°ˆ Docker</a></li>
<li><a target="_blank" rel="noopener" href="http://open.daocloud.io/shen-ru-li-jie-dockerjing-xiang-jsonwen-jian-2/">æ·±å…¥ç†è§£ Docker é•œåƒ json æ–‡ä»¶</a></li>
<li><a target="_blank" rel="noopener" href="http://open.daocloud.io/docker-jing-xiang-nei-you-sha-cun-na-ntitled/">Docker é•œåƒå†…æœ‰å•¥ï¼Œå­˜å“ªï¼Ÿ</a></li>
<li><a target="_blank" rel="noopener" href="http://open.daocloud.io/allen-tan-docker-xi-lie-zhi-shen-ke-li-jie-docker-jing-xiang-da-xiao/">ç†è§£ Docker é•œåƒå¤§å°</a></li>
<li><a target="_blank" rel="noopener" href="http://open.daocloud.io/allen-tan-docker-xi-lie-zhi-tu-kan-jin-docker-rong-qi-wen-jian-xi-tong/">çœ‹å°½ docker å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ</a></li>
<li><a target="_blank" rel="noopener" href="https://qhh.me/2019/02/17/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Docker-%E6%9E%84%E5%BB%BA%E4%B8%8A%E4%B8%8B%E6%96%87/">æ·±å…¥ç†è§£ Docker æ„å»ºä¸Šä¸‹æ–‡</a></li>
<li><a target="_blank" rel="noopener" href="https://cizixs.com/2017/11/05/oci-and-runc/">OCI å’Œ runcï¼šå®¹å™¨æ ‡å‡†åŒ–å’Œ docker</a></li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/docker/" rel="tag"># docker</a>
              <a href="/tags/image/" rel="tag"># image</a>
              <a href="/tags/registry/" rel="tag"># registry</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/mount-bind.html" rel="prev" title="mount å‘½ä»¤ä¹‹ --bind æŒ‚è½½å‚æ•°">
                  <i class="fa fa-chevron-left"></i> mount å‘½ä»¤ä¹‹ --bind æŒ‚è½½å‚æ•°
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/Q2-reading.html" rel="next" title="2020 é˜…è¯»è®°å½•ï¼ˆäºŒï¼‰">
                  2020 é˜…è¯»è®°å½•ï¼ˆäºŒï¼‰ <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">26:14</span>
  </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
