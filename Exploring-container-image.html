<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.k8s.li').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>
  <meta name="description" content="ä¸Šå‘¨åœ¨å†™ã€Šé•œåƒæ¬è¿å·¥ skopeo ã€‹ çš„æ—¶å€™çœ‹äº†å¾ˆå¤šå…³äºå®¹å™¨é•œåƒç›¸å…³çš„åšå®¢ï¼Œä»å¤§ä½¬ä»¬é‚£é‡Œå·å·å­¦äº†ä¸å°‘çŸ¥è¯†ï¼Œå¯¹å®¹å™¨é•œåƒæœ‰äº†ä¸€ç‚¹ç‚¹æ·±å…¥çš„äº†è§£ã€‚è¿™å‘¨æœ«ä¸€ä¸ªäººé—²ç€å®…åœ¨å®¶é‡Œæ²¡äº‹å°±æŠŠæœ€è¿‘æ‰€å­¦çš„çŸ¥è¯†æ•´ç†ä¸€ä¸‹åˆ†äº«å‡ºæ¥ï¼Œä¾›å¤§å®¶ä¸€èµ·æ¥é£Ÿç”¨ã€‚å†…å®¹æ¯”è¾ƒå¤šï¼Œè€å¿ƒçœ‹å®Œçš„è¯ï¼Œè¿˜æ˜¯èƒ½æ”¶è·ä¸€äº›æ²¡ç”¨çš„çŸ¥è¯†æ»´ğŸ˜‚ã€‚ æ›´æ–°è®°å½• 2020-06-13ï¼šè¿˜æœ‰ä¸€äº›æ²¡æœ‰å†™å®Œï¼Œåç»­è¡¥å…… 2020-06-06ï¼š åˆç¨¿ 2020-09-02ï¼šè¡¥å……">
<meta property="og:type" content="article">
<meta property="og:title" content="æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”ŸğŸ¤”">
<meta property="og:url" content="https://blog.k8s.li/Exploring-container-image.html">
<meta property="og:site_name" content="æœ¨å­">
<meta property="og:description" content="ä¸Šå‘¨åœ¨å†™ã€Šé•œåƒæ¬è¿å·¥ skopeo ã€‹ çš„æ—¶å€™çœ‹äº†å¾ˆå¤šå…³äºå®¹å™¨é•œåƒç›¸å…³çš„åšå®¢ï¼Œä»å¤§ä½¬ä»¬é‚£é‡Œå·å·å­¦äº†ä¸å°‘çŸ¥è¯†ï¼Œå¯¹å®¹å™¨é•œåƒæœ‰äº†ä¸€ç‚¹ç‚¹æ·±å…¥çš„äº†è§£ã€‚è¿™å‘¨æœ«ä¸€ä¸ªäººé—²ç€å®…åœ¨å®¶é‡Œæ²¡äº‹å°±æŠŠæœ€è¿‘æ‰€å­¦çš„çŸ¥è¯†æ•´ç†ä¸€ä¸‹åˆ†äº«å‡ºæ¥ï¼Œä¾›å¤§å®¶ä¸€èµ·æ¥é£Ÿç”¨ã€‚å†…å®¹æ¯”è¾ƒå¤šï¼Œè€å¿ƒçœ‹å®Œçš„è¯ï¼Œè¿˜æ˜¯èƒ½æ”¶è·ä¸€äº›æ²¡ç”¨çš„çŸ¥è¯†æ»´ğŸ˜‚ã€‚ æ›´æ–°è®°å½• 2020-06-13ï¼šè¿˜æœ‰ä¸€äº›æ²¡æœ‰å†™å®Œï¼Œåç»­è¡¥å…… 2020-06-06ï¼š åˆç¨¿ 2020-09-02ï¼šè¡¥å……">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/docker-architecture.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/12036324/70367494-646d2380-18db-11ea-992a-d2bca4cbfeb0.png">
<meta property="og:image" content="https://p.k8s.li/registry-storage.jpeg">
<meta property="og:image" content="https://p.k8s.li/20200609_oci-04.jpg">
<meta property="og:image" content="https://p.k8s.li/overlay_constructs.jpg">
<meta property="article:published_time" content="2020-06-13T16:00:00.000Z">
<meta property="article:modified_time" content="2020-06-13T16:00:00.000Z">
<meta property="article:author" content="æœ¨å­">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="registry">
<meta property="article:tag" content="image">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/docker-architecture.png">
<link rel="canonical" href="https://blog.k8s.li/Exploring-container-image.html">
<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>
  <title>æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”ŸğŸ¤” | æœ¨å­</title>
  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }
  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>
<link rel="alternate" href="/atom.xml" title="æœ¨å­" type="application/atom+xml">
</head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">
    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æœ¨å­</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>
<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">
    <a href="/" rel="section"><i class="fa fa-fw fa-desktop"></i>Home</a>
  </li>
        <li class="menu-item menu-item-books">
    <a href="/booklist.html" rel="section"><i class="fa fa-fw fa-book"></i>Books</a>
  </li>
        <li class="menu-item menu-item-kindle">
    <a href="https://kindle.502.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
  </li>
        <li class="menu-item menu-item-friend">
    <a href="/link/" rel="section"><i class="fa fa-fw fa-link"></i>Friend</a>
  </li>
        <li class="menu-item menu-item-about">
    <a href="/about.html" rel="section"><i class="fa fa-fw fa-user-circle-o"></i>About</a>
  </li>
  </ul>
</nav>
</div>
    </header>
  <div class="reading-progress-bar"></div>
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
  <div class="posts-expand">
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/Exploring-container-image.html">
    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog.k8s.li/avatar.png">
      <meta itemprop="name" content="æœ¨å­">
      <meta itemprop="description" content="">
    </span>
    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æœ¨å­">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”ŸğŸ¤”
        </h2>
        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              <time title="åˆ›å»ºæ—¶é—´ï¼š2020-06-14 2020-06-14T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2020-06-14T00:00:00+08:00">2020-06-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>
            </span>
  <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    <a title="disqus" href="/Exploring-container-image.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="Exploring-container-image.html" itemprop="commentCount"></span>
    </a>
  </span>
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>47k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>1:18</span>
            </span>
        </div>
      </header>
    <div class="post-body" itemprop="articleBody">
        <p>ä¸Šå‘¨åœ¨å†™<a href="https://blog.k8s.li/skopeo.html">ã€Šé•œåƒæ¬è¿å·¥ skopeo ã€‹</a> çš„æ—¶å€™çœ‹äº†å¾ˆå¤šå…³äºå®¹å™¨é•œåƒç›¸å…³çš„åšå®¢ï¼Œä»å¤§ä½¬ä»¬é‚£é‡Œå·å·å­¦äº†ä¸å°‘çŸ¥è¯†ï¼Œå¯¹å®¹å™¨é•œåƒæœ‰äº†ä¸€ç‚¹ç‚¹æ·±å…¥çš„äº†è§£ã€‚è¿™å‘¨æœ«ä¸€ä¸ªäººé—²ç€å®…åœ¨å®¶é‡Œæ²¡äº‹å°±æŠŠæœ€è¿‘æ‰€å­¦çš„çŸ¥è¯†æ•´ç†ä¸€ä¸‹åˆ†äº«å‡ºæ¥ï¼Œä¾›å¤§å®¶ä¸€èµ·æ¥é£Ÿç”¨ã€‚å†…å®¹æ¯”è¾ƒå¤šï¼Œè€å¿ƒçœ‹å®Œçš„è¯ï¼Œè¿˜æ˜¯èƒ½æ”¶è·ä¸€äº›<del>æ²¡ç”¨çš„</del>çŸ¥è¯†æ»´ğŸ˜‚ã€‚</p>
<h2 id="æ›´æ–°è®°å½•"><a href="#æ›´æ–°è®°å½•" class="headerlink" title="æ›´æ–°è®°å½•"></a>æ›´æ–°è®°å½•</h2><ul>
<li>2020-06-13ï¼šè¿˜æœ‰ä¸€äº›æ²¡æœ‰å†™å®Œï¼Œåç»­è¡¥å……</li>
<li>2020-06-06ï¼š åˆç¨¿</li>
<li>2020-09-02ï¼šè¡¥å……</li>
</ul>
<h2 id="é•œåƒæ˜¯æ€æ ·ç‚¼æˆçš„ğŸ¤”"><a href="#é•œåƒæ˜¯æ€æ ·ç‚¼æˆçš„ğŸ¤”" class="headerlink" title="é•œåƒæ˜¯æ€æ ·ç‚¼æˆçš„ğŸ¤”"></a>é•œåƒæ˜¯æ€æ ·ç‚¼æˆçš„ğŸ¤”</h2><p>æ‰€è°“ç‚¼æˆåƒå°±æ˜¯æ„å»ºé•œåƒå•¦ï¼Œä¸‹é¢ç”¨åˆ°çš„<strong>æ“</strong>å’Œ<strong>ç‚¼åˆ¶</strong>éƒ½æ˜¯æŒ‡çš„æ„å»ºé•œåƒå•¦ï¼Œåªæ˜¯ä¸ªäººä¹ æƒ¯ç”¨è¯­è€Œå·²ğŸ˜‚ã€‚</p>
<p>æåˆ°å®¹å™¨é•œåƒå°±ä¸å¾—ä¸æä¸€ä¸‹ OCI ï¼Œå³ Open Container Initiative æ—¨åœ¨å›´ç»•å®¹å™¨æ ¼å¼å’Œè¿è¡Œæ—¶åˆ¶å®šä¸€ä¸ªå¼€æ”¾çš„å·¥ä¸šåŒ–æ ‡å‡†ã€‚ç›®å‰ OCI ä¸»è¦æœ‰ä¸‰ä¸ªè§„èŒƒï¼šè¿è¡Œæ—¶è§„èŒƒ <a href="https://github.com/opencontainers/runtime-spec" target="_blank" rel="noopener">runtime-spec</a> ï¼Œé•œåƒè§„èŒƒ <a href="http://www.github.com/opencontainers/image-spec" target="_blank" rel="noopener">image-spec</a> ä»¥åŠä¸å¸¸è§çš„é•œåƒä»“åº“è§„èŒƒ <a href="https://github.com/opencontainers/distribution-spec" target="_blank" rel="noopener">distribution-spec</a> ã€‚å…³äº OCI è¿™äº›è§„èŒƒçš„ä½œç”¨çš„ä½œç”¨ï¼Œå°±å¼•ç”¨ä¸€ä¸‹ <a href="https://wilhelmguo.cn/blog/post/william/%E5%AE%B9%E5%99%A8%E5%BC%80%E6%94%BE%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83%EF%BC%88CRI-OCI%EF%BC%89-2" target="_blank" rel="noopener">å®¹å™¨å¼€æ”¾æ¥å£è§„èŒƒï¼ˆCRI OCIï¼‰</a> ä¸­çš„å†…å®¹ï¼Œæˆ‘ä¹Ÿå°±æ‡’å¾—è‡ªå·±ç»„ç»‡è¯­è¨€çŒæ°´äº†ğŸ˜‚ï¼ˆå‡‘å­—æ•°</p>
<blockquote>
<p>åˆ¶å®šå®¹å™¨æ ¼å¼æ ‡å‡†çš„å®—æ—¨æ¦‚æ‹¬æ¥è¯´å°±æ˜¯ä¸å—ä¸Šå±‚ç»“æ„çš„ç»‘å®šï¼Œå¦‚ç‰¹å®šçš„å®¢æˆ·ç«¯ã€ç¼–æ’æ ˆç­‰ï¼ŒåŒæ—¶ä¹Ÿä¸å—ç‰¹å®šçš„ä¾›åº”å•†æˆ–é¡¹ç›®çš„ç»‘å®šï¼Œå³ä¸é™äºæŸç§ç‰¹å®šæ“ä½œç³»ç»Ÿã€ç¡¬ä»¶ã€CPUæ¶æ„ã€å…¬æœ‰äº‘ç­‰ã€‚</p>
<p>è¿™ä¸¤ä¸ªåè®®é€šè¿‡ OCI runtime filesytem bundle çš„æ ‡å‡†æ ¼å¼è¿æ¥åœ¨ä¸€èµ·ï¼ŒOCI é•œåƒå¯ä»¥é€šè¿‡å·¥å…·è½¬æ¢æˆ bundleï¼Œç„¶å OCI å®¹å™¨å¼•æ“èƒ½å¤Ÿè¯†åˆ«è¿™ä¸ª bundle æ¥è¿è¡Œå®¹å™¨</p>
<ul>
<li>æ“ä½œæ ‡å‡†åŒ–ï¼šå®¹å™¨çš„æ ‡å‡†åŒ–æ“ä½œåŒ…æ‹¬ä½¿ç”¨æ ‡å‡†å®¹å™¨åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢å®¹å™¨ï¼Œä½¿ç”¨æ ‡å‡†æ–‡ä»¶ç³»ç»Ÿå·¥å…·å¤åˆ¶å’Œåˆ›å»ºå®¹å™¨å¿«ç…§ï¼Œä½¿ç”¨æ ‡å‡†åŒ–ç½‘ç»œå·¥å…·è¿›è¡Œä¸‹è½½å’Œä¸Šä¼ ã€‚</li>
<li>å†…å®¹æ— å…³ï¼šå†…å®¹æ— å…³æŒ‡ä¸ç®¡é’ˆå¯¹çš„å…·ä½“å®¹å™¨å†…å®¹æ˜¯ä»€ä¹ˆï¼Œå®¹å™¨æ ‡å‡†æ“ä½œæ‰§è¡Œåéƒ½èƒ½äº§ç”ŸåŒæ ·çš„æ•ˆæœã€‚å¦‚å®¹å™¨å¯ä»¥ç”¨åŒæ ·çš„æ–¹å¼ä¸Šä¼ ã€å¯åŠ¨ï¼Œä¸ç®¡æ˜¯PHPåº”ç”¨è¿˜æ˜¯MySQLæ•°æ®åº“æœåŠ¡ã€‚</li>
<li>åŸºç¡€è®¾æ–½æ— å…³ï¼šæ— è®ºæ˜¯ä¸ªäººçš„ç¬”è®°æœ¬ç”µè„‘è¿˜æ˜¯AWS S3ï¼Œäº¦æˆ–æ˜¯OpenStackï¼Œæˆ–è€…å…¶å®ƒåŸºç¡€è®¾æ–½ï¼Œéƒ½åº”è¯¥å¯¹æ”¯æŒå®¹å™¨çš„å„é¡¹æ“ä½œã€‚</li>
<li>ä¸ºè‡ªåŠ¨åŒ–é‡èº«å®šåˆ¶ï¼šåˆ¶å®šå®¹å™¨ç»Ÿä¸€æ ‡å‡†ï¼Œæ˜¯çš„æ“ä½œå†…å®¹æ— å…³åŒ–ã€å¹³å°æ— å…³åŒ–çš„æ ¹æœ¬ç›®çš„ä¹‹ä¸€ï¼Œå°±æ˜¯ä¸ºäº†å¯ä»¥ä½¿å®¹å™¨æ“ä½œå…¨å¹³å°è‡ªåŠ¨åŒ–ã€‚</li>
<li>å·¥ä¸šçº§äº¤ä»˜ï¼šåˆ¶å®šå®¹å™¨æ ‡å‡†ä¸€å¤§ç›®æ ‡ï¼Œå°±æ˜¯ä½¿è½¯ä»¶åˆ†å‘å¯ä»¥è¾¾åˆ°å·¥ä¸šçº§äº¤ä»˜æˆä¸ºç°å®</li>
</ul>
</blockquote>
<p>å…¶å® OCI è§„èŒƒå°±æ˜¯ä¸€å † markdown æ–‡ä»¶å•¦ï¼Œå†…å®¹ä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼Œä¸åƒ RFC å’Œ ISO é‚£ä¹ˆé«˜æ·±è«æµ‹ï¼Œæ‰€ä»¥æ±æƒ³å¯¹å®¹å™¨é•œåƒæœ‰ä¸ªæ·±å…¥çš„äº†è§£è¿˜æ˜¯æ¨èå¤§å®¶å»è¯»ä¸€ä¸‹è¿™äº› markdown æ–‡ä»¶ğŸ˜‚ã€‚OCI è§„èŒƒæ˜¯å…è´¹çš„å“¦ï¼Œä¸åƒå¤§å¤šæ•° ISO è§„èŒƒè¿˜è¦äº¤é’±æ‰èƒ½çœ‹ï¼ˆï¸¶^ï¸¶ï¼‰å“¼ã€‚</p>
<h3 id="OCI-image-spec"><a href="#OCI-image-spec" class="headerlink" title="OCI image-spec"></a>OCI image-spec</h3><p>OCI è§„èŒƒä¸­çš„é•œåƒè§„èŒƒ <a href="http://www.github.com/opencontainers/image-spec" target="_blank" rel="noopener">image-spec</a> å†³å®šäº†æˆ‘ä»¬çš„é•œåƒæŒ‰ç…§ä»€ä¹ˆæ ‡å‡†æ¥æ„å»ºï¼Œä»¥åŠæ„å»ºå®Œé•œåƒä¹‹åå¦‚ä½•å­˜æ”¾ï¼Œæ¥ç€ä¸‹æ–‡æåˆ°çš„ Dockerfile åˆ™å†³å®šäº†é•œåƒçš„ layer å†…å®¹ä»¥åŠé•œåƒçš„ä¸€äº›å…ƒæ•°æ®ä¿¡æ¯ã€‚ä¸€ä¸ªé•œåƒè§„èŒƒ image-spec å’Œä¸€ä¸ª Dockerfile å°±æŒ‡å¯¼ç€æˆ‘ä»¬æ„å»ºä¸€ä¸ªé•œåƒï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±ç®€å•äº†è§£ä¸€ä¸‹è¿™ä¸ªé•œåƒè§„èŒƒï¼Œçœ‹çœ‹é•œåƒæ˜¯é•¿ä»€ä¹ˆæ ·å­çš„ï¼Œå¯¹é•œåƒæœ‰ä¸ªå¤§ä½“çš„ä¸»è§‚è®¤è¯†ã€‚</p>
<p>æ ¹æ®å®˜æ–¹æ–‡æ¡£çš„æè¿°ï¼ŒOCI é•œåƒè§„èŒƒçš„ä¸»è¦ç”±ä»¥ä¸‹å‡ ä¸ª markdown æ–‡ä»¶ç»„æˆï¼š</p>
<blockquote>
<ul>
<li><a href="https://github.com/opencontainers/image-spec/blob/master/manifest.md" target="_blank" rel="noopener">Image Manifest</a> - a document describing the components that make up a container image</li>
<li><a href="https://github.com/opencontainers/image-spec/blob/master/image-index.md" target="_blank" rel="noopener">Image Index</a> - an annotated index of image manifests</li>
<li><a href="https://github.com/opencontainers/image-spec/blob/master/image-layout.md" target="_blank" rel="noopener">Image Layout</a> - a filesystem layout representing the contents of an image</li>
<li><a href="https://github.com/opencontainers/image-spec/blob/master/layer.md" target="_blank" rel="noopener">Filesystem Layer</a> - a changeset that describes a containerâ€™s filesystem</li>
<li><a href="https://github.com/opencontainers/image-spec/blob/master/config.md" target="_blank" rel="noopener">Image Configuration</a> - a document determining layer ordering and configuration of the image suitable for translation into a <a href="https://github.com/opencontainers/runtime-spec" target="_blank" rel="noopener">runtime bundle</a></li>
<li><a href="https://github.com/opencontainers/image-spec/blob/master/conversion.md" target="_blank" rel="noopener">Conversion</a> - a document describing how this translation should occur</li>
<li><a href="https://github.com/opencontainers/image-spec/blob/master/descriptor.md" target="_blank" rel="noopener">Descriptor</a> - a reference that describes the type, metadata and content address of referenced content</li>
</ul>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ annotations.md         # æ³¨è§£è§„èŒƒ</span><br><span class="line">â”œâ”€â”€ config.md              # image config æ–‡ä»¶è§„èŒƒ</span><br><span class="line">â”œâ”€â”€ considerations.md      # æ³¨æ„äº‹é¡¹</span><br><span class="line">â”œâ”€â”€ conversion.md          # è½¬æ¢ä¸º OCI è¿è¡Œæ—¶</span><br><span class="line">â”œâ”€â”€ descriptor.md          # OCI Content Descriptors å†…å®¹æè¿°</span><br><span class="line">â”œâ”€â”€ image-index.md         # manifest list æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ image-layout.md        # é•œåƒçš„å¸ƒå±€</span><br><span class="line">â”œâ”€â”€ implementations.md     # ä½¿ç”¨ OCI è§„èŒƒçš„é¡¹ç›®</span><br><span class="line">â”œâ”€â”€ layer.md               # é•œåƒå±‚ layer è§„èŒƒ</span><br><span class="line">â”œâ”€â”€ manifest.md            # manifest è§„èŒƒ</span><br><span class="line">â”œâ”€â”€ media-types.md         # æ–‡ä»¶ç±»å‹</span><br><span class="line">â”œâ”€â”€ README.md              # README æ–‡æ¡£</span><br><span class="line">â”œâ”€â”€ spec.md                # OCI é•œåƒè§„èŒƒçš„æ¦‚è§ˆ</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ä»¥ä¸Šå‡ ä¸ª markdown æ–‡ä»¶ï¼Œ OCI å®¹å™¨é•œåƒè§„èŒƒä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ å—å†…å®¹ï¼š</p>
<h4 id="layer"><a href="#layer" class="headerlink" title="layer"></a>layer</h4><p><a href="https://github.com/opencontainers/image-spec/blob/master/layer.md" target="_blank" rel="noopener">æ–‡ä»¶ç³»ç»Ÿ</a>ï¼šä»¥ layer ï¼ˆé•œåƒå±‚ï¼‰ä¿å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ¯ä¸ª layer ä¿å­˜äº†å’Œä¸Šå±‚ä¹‹é—´å˜åŒ–çš„éƒ¨åˆ†ï¼Œlayer åº”è¯¥ä¿å­˜å“ªäº›æ–‡ä»¶ï¼Œæ€ä¹ˆè¡¨ç¤ºå¢åŠ ã€ä¿®æ”¹å’Œåˆ é™¤çš„æ–‡ä»¶ç­‰ã€‚</p>
<h4 id="image-config"><a href="#image-config" class="headerlink" title="image config"></a>image config</h4><p><a href="https://github.com/opencontainers/image-spec/blob/master/config.md" target="_blank" rel="noopener">image config æ–‡ä»¶</a>ï¼šä¿å­˜äº†æ–‡ä»¶ç³»ç»Ÿçš„å±‚çº§ä¿¡æ¯ï¼ˆæ¯ä¸ªå±‚çº§çš„ hash å€¼ï¼Œä»¥åŠå†å²ä¿¡æ¯ï¼‰ï¼Œä»¥åŠå®¹å™¨è¿è¡Œæ—¶éœ€è¦çš„ä¸€äº›ä¿¡æ¯ï¼ˆæ¯”å¦‚ç¯å¢ƒå˜é‡ã€å·¥ä½œç›®å½•ã€å‘½ä»¤å‚æ•°ã€mount åˆ—è¡¨ï¼‰ï¼ŒæŒ‡å®šäº†é•œåƒåœ¨æŸä¸ªç‰¹å®šå¹³å°å’Œç³»ç»Ÿçš„é…ç½®ï¼Œæ¯”è¾ƒæ¥è¿‘æˆ‘ä»¬ä½¿ç”¨ <code>docker inspect &lt;image_id&gt;</code> çœ‹åˆ°çš„å†…å®¹ã€‚</p>
<ul>
<li>example</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">  <span class="attr">"config"</span>: &#123;</span><br><span class="line">    <span class="attr">"Hostname"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"Domainname"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"User"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"AttachStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStdout"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStderr"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Tty"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"OpenStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"StdinOnce"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Env"</span>: [</span><br><span class="line">      <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Cmd"</span>: [</span><br><span class="line">      <span class="string">"bash"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Image"</span>: <span class="string">"sha256:ba8f577813c7bdf6b737f638dffbc688aa1df2ff28a826a6c46bae722977b549"</span>,</span><br><span class="line">    <span class="attr">"Volumes"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"WorkingDir"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"Entrypoint"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"OnBuild"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"Labels"</span>: <span class="literal">null</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"container"</span>: <span class="string">"38501d5aa48c080884f4dc6fd4b1b6590ff1607d9e7a12e1cef1d86a3fdc32df"</span>,</span><br><span class="line">  <span class="attr">"container_config"</span>: &#123;</span><br><span class="line">    <span class="attr">"Hostname"</span>: <span class="string">"38501d5aa48c"</span>,</span><br><span class="line">    <span class="attr">"Domainname"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"User"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"AttachStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStdout"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStderr"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Tty"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"OpenStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"StdinOnce"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Env"</span>: [</span><br><span class="line">      <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Cmd"</span>: [</span><br><span class="line">      <span class="string">"/bin/sh"</span>,</span><br><span class="line">      <span class="string">"-c"</span>,</span><br><span class="line">      <span class="string">"#(nop) "</span>,</span><br><span class="line">      <span class="string">"CMD [\"bash\"]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Image"</span>: <span class="string">"sha256:ba8f577813c7bdf6b737f638dffbc688aa1df2ff28a826a6c46bae722977b549"</span>,</span><br><span class="line">    <span class="attr">"Volumes"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"WorkingDir"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"Entrypoint"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"OnBuild"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"Labels"</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"created"</span>: <span class="string">"2020-06-07T01:59:47.348924716Z"</span>,</span><br><span class="line">  <span class="attr">"docker_version"</span>: <span class="string">"19.03.5"</span>,</span><br><span class="line">  <span class="attr">"history"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"created"</span>: <span class="string">"2020-06-07T01:59:46.877600299Z"</span>,</span><br><span class="line">      <span class="attr">"created_by"</span>: <span class="string">"/bin/sh -c #(nop) ADD file:a82014afc29e7b364ac95223b22ebafad46cc9318951a85027a49f9ce1a99461 in / "</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"created"</span>: <span class="string">"2020-06-07T01:59:47.348924716Z"</span>,</span><br><span class="line">      <span class="attr">"created_by"</span>: <span class="string">"/bin/sh -c #(nop)  CMD [\"bash\"]"</span>,</span><br><span class="line">      <span class="attr">"empty_layer"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">  <span class="attr">"rootfs"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"layers"</span>,</span><br><span class="line">    <span class="attr">"diff_ids"</span>: [</span><br><span class="line">      <span class="string">"sha256:d1b85e6186f67d9925c622a7a6e66faa447e767f90f65ae47cdc817c629fa956"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="manifest"><a href="#manifest" class="headerlink" title="manifest"></a>manifest</h4><p><a href="https://github.com/opencontainers/image-spec/blob/master/manifest.md" target="_blank" rel="noopener">manifest æ–‡ä»¶</a> ï¼šé•œåƒçš„ config æ–‡ä»¶ç´¢å¼•ï¼Œæœ‰å“ªäº› layerï¼Œé¢å¤–çš„ annotation ä¿¡æ¯ï¼Œmanifest æ–‡ä»¶ä¸­ä¿å­˜äº†å¾ˆå¤šå’Œå½“å‰å¹³å°æœ‰å…³çš„ä¿¡æ¯ã€‚å¦å¤– manifest ä¸­çš„ layer å’Œ config ä¸­çš„ layer è¡¨è¾¾çš„è™½ç„¶éƒ½æ˜¯é•œåƒçš„ layer ï¼Œä½†äºŒè€…ä»£è¡¨çš„æ„ä¹‰ä¸å¤ªä¸€æ ·ï¼Œç¨åä¼šè®²åˆ°ã€‚manifest æ–‡ä»¶æ˜¯å­˜æ”¾åœ¨ registry ä¸­ï¼Œå½“æˆ‘ä»¬æ‹‰å–é•œåƒçš„æ—¶å€™ï¼Œä¼šæ ¹æ®è¯¥æ–‡ä»¶æ‹‰å–ç›¸åº”çš„ layer ã€‚æ ¹æ® OCI image-spec è§„èŒƒä¸­ <a href="https://github.com/opencontainers/image-spec/blob/master/manifest.md" target="_blank" rel="noopener">OCI Image Manifest Specification</a> çš„å®šä¹‰å¯ä»¥å¾—çŸ¥ï¼Œé•œåƒçš„ manifest æ–‡ä»¶ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ä¸ªç›®æ ‡ï¼šï¼ˆè‹±è¯­ä¸å¥½å°±ä¸ç¿»è¯‘äº†ğŸ˜¥</p>
<blockquote>
<p>There are three main goals of the Image Manifest Specification.</p>
<ul>
<li>The first goal is content-addressable images, by supporting an image model where the imageâ€™s configuration can be hashed to generate a unique ID for the image and its components.</li>
<li>The second goal is to allow multi-architecture images, through a â€œfat manifestâ€ which references image manifests for platform-specific versions of an image. In OCI, this is codified in an <a href="https://github.com/opencontainers/image-spec/blob/master/image-index.md" target="_blank" rel="noopener">image index</a>.</li>
<li>The third goal is to be <a href="https://github.com/opencontainers/image-spec/blob/master/conversion.md" target="_blank" rel="noopener">translatable</a> to the <a href="https://github.com/opencontainers/runtime-spec" target="_blank" rel="noopener">OCI Runtime Specification</a>.</li>
</ul>
</blockquote>
<p>å¦å¤– manifest ä¹Ÿåˆ†å¥½å‡ ä¸ªç‰ˆæœ¬ï¼Œç›®å‰ä¸»æµçš„ç‰ˆæœ¬æ˜¯  <code>Manifest Version 2, Schema 2</code> ï¼Œå¯ä»¥å‚è€ƒ docker çš„å®˜æ–¹æ–‡æ¡£ <a href="https://github.com/docker/distribution/blob/master/docs/spec/manifest-v2-2.md" target="_blank" rel="noopener">Image Manifest Version 2, Schema 2</a> ã€‚registry ä¸­ä¼šæœ‰ä¸ª <code>Manifest List</code> æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æ˜¯ä¸ºä¸åŒå¤„ç†å™¨ä½“ç³»æ¶æ„è€Œè®¾è®¡çš„ï¼Œé€šè¿‡è¯¥æ–‡ä»¶æŒ‡å‘ä¸è¯¥å¤„ç†å™¨ä½“ç³»æ¶æ„ç›¸å¯¹åº”çš„ Image Manifest ï¼Œè¿™ä¸€ç‚¹ä¸è¦ææ··ã€‚</p>
<ul>
<li>Example Manifest List</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"schemaVersion"</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.list.v2+json"</span>,</span><br><span class="line">  <span class="attr">"manifests"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">7143</span>,</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"ppc64le"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">7682</span>,</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:5b0bcabd1ed22e9fb1310cf6c2dec7cdef19f0ad69efa1f392e94a4333501270"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">        <span class="attr">"features"</span>: [</span><br><span class="line">          <span class="string">"sse4"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Image Manifest</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "schemaVersion": 2,</span><br><span class="line">  "mediaType": "application/vnd.docker.distribution.manifest.v2+json",</span><br><span class="line">  "config": &#123;</span><br><span class="line">    "mediaType": "application/vnd.docker.container.image.v1+json",</span><br><span class="line">    "size": 1509,</span><br><span class="line">    "digest": "sha256:a24bb4013296f61e89ba57005a7b3e52274d8edd3ae2077d04395f806b63d83e"</span><br><span class="line">  &#125;,</span><br><span class="line">  "layers": [</span><br><span class="line">    &#123;</span><br><span class="line">      "mediaType": "application/vnd.docker.image.rootfs.diff.tar.gzip",</span><br><span class="line">      "size": 5844992,</span><br><span class="line">      "digest": "sha256:50644c29ef5a27c9a40c393a73ece2479de78325cae7d762ef3cdc19bf42dd0a"</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åå†è¡¥å……ä¸€æ®µé«˜ç­–å¤§ä½¬çš„ <a href="http://gaocegege.com/Blog/ormb" target="_blank" rel="noopener">è§£é‡Š</a> ï¼š</p>
<blockquote>
<p>Manifest æ˜¯ä¸€ä¸ª JSON æ–‡ä»¶ï¼Œå…¶å®šä¹‰åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ <a href="https://github.com/opencontainers/image-spec/blob/master/config.md" target="_blank" rel="noopener">Config</a> å’Œ <a href="https://github.com/opencontainers/image-spec/blob/master/layer.md" target="_blank" rel="noopener">Layers</a>ã€‚Config æ˜¯ä¸€ä¸ª JSON å¯¹è±¡ï¼ŒLayers æ˜¯ä¸€ä¸ªç”± JSON å¯¹è±¡ç»„æˆçš„æ•°ç»„ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒConfig ä¸ Layers ä¸­çš„æ¯ä¸€ä¸ªå¯¹è±¡çš„ç»“æ„ç›¸åŒï¼Œéƒ½åŒ…æ‹¬ä¸‰ä¸ªå­—æ®µï¼Œåˆ†åˆ«æ˜¯ digestã€mediaType å’Œ sizeã€‚å…¶ä¸­ digest å¯ä»¥ç†è§£ä¸ºæ˜¯è¿™ä¸€å¯¹è±¡çš„ IDã€‚mediaType è¡¨æ˜äº†è¿™ä¸€å†…å®¹çš„ç±»å‹ã€‚size æ˜¯è¿™ä¸€å†…å®¹çš„å¤§å°ã€‚</p>
<p>å®¹å™¨é•œåƒçš„ Config æœ‰ç€å›ºå®šçš„ mediaType <code>application/vnd.oci.image.config.v1+json</code>ã€‚ä¸€ä¸ª Config çš„ç¤ºä¾‹é…ç½®å¦‚ä¸‹ï¼Œå®ƒè®°å½•äº†å…³äºå®¹å™¨é•œåƒçš„é…ç½®ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯é•œåƒçš„å…ƒæ•°æ®ã€‚é€šå¸¸å®ƒä¼šè¢«é•œåƒä»“åº“ç”¨æ¥åœ¨ UI ä¸­å±•ç¤ºä¿¡æ¯ï¼Œä»¥åŠåŒºåˆ†ä¸åŒæ“ä½œç³»ç»Ÿçš„æ„å»ºç­‰ã€‚</p>
<p>è€Œå®¹å™¨é•œåƒçš„ Layers æ˜¯ç”±å¤šå±‚ mediaType ä¸º <code>application/vnd.oci.image.layer.v1.*</code>ï¼ˆå…¶ä¸­æœ€å¸¸è§çš„æ˜¯ <code>application/vnd.oci.image.layer.v1.tar+gzip</code>) çš„å†…å®¹ç»„æˆçš„ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œå®¹å™¨é•œåƒæ˜¯åˆ†å±‚æ„å»ºçš„ï¼Œæ¯ä¸€å±‚å°±å¯¹åº”ç€ Layers ä¸­çš„ä¸€ä¸ªå¯¹è±¡ã€‚</p>
<p>å®¹å™¨é•œåƒçš„ Configï¼Œå’Œ Layers ä¸­çš„æ¯ä¸€å±‚ï¼Œéƒ½æ˜¯ä»¥ Blob çš„æ–¹å¼å­˜å‚¨åœ¨é•œåƒä»“åº“ä¸­çš„ï¼Œå®ƒä»¬çš„ digest ä½œä¸º Key å­˜åœ¨ã€‚å› æ­¤ï¼Œåœ¨è¯·æ±‚åˆ°é•œåƒçš„ Manifest åï¼ŒDocker ä¼šåˆ©ç”¨ digest å¹¶è¡Œä¸‹è½½æ‰€æœ‰çš„ Blobsï¼Œå…¶ä¸­å°±åŒ…æ‹¬ Config å’Œæ‰€æœ‰çš„ Layersã€‚</p>
</blockquote>
<h4 id="image-manifest-index"><a href="#image-manifest-index" class="headerlink" title="image manifest index"></a>image manifest index</h4><p><a href="https://github.com/opencontainers/image-spec/blob/master/image-index.md" target="_blank" rel="noopener">index æ–‡ä»¶</a> ï¼šå…¶å®å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„ Manifest List å•¦ã€‚åœ¨ docker çš„ <a href="https://github.com/docker/distribution" target="_blank" rel="noopener">distribution</a> ä¸­ç§°ä¹‹ä¸º <code>Manifest List</code> åœ¨ OCI ä¸­å°±å« <a href="https://github.com/opencontainers/image-spec/blob/master/image-index.md" target="_blank" rel="noopener">OCI Image Index Specification</a> ã€‚å…¶å®ä¸¤è€…æ˜¯æŒ‡çš„åŒä¸€ä¸ªæ–‡ä»¶ï¼Œç”šè‡³ä¸¤è€… GitHub ä¸Šæ–‡æ¡£ç»™çš„ example éƒ½ä¸€ä¸€æ¨¡æ ·ğŸ¤£ï¼Œåº”è¯¥æ˜¯ OCI å¤åˆ¶ç²˜è´´ Docker çš„æ–‡æ¡£ğŸ˜‚ã€‚index æ–‡ä»¶æ˜¯ä¸ªå¯é€‰çš„æ–‡ä»¶ï¼ŒåŒ…å«ç€ä¸€ä¸ªåˆ—è¡¨ä¸ºåŒä¸€ä¸ªé•œåƒä¸åŒçš„å¤„ç†å™¨ arch æŒ‡å‘ä¸åŒå¹³å°çš„ manifest æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶èƒ½ä¿è¯ä¸€ä¸ªé•œåƒå¯ä»¥è·¨å¹³å°ä½¿ç”¨ï¼Œæ¯ä¸ªå¤„ç†å™¨ arch å¹³å°æ‹¥æœ‰ä¸åŒçš„ manifest æ–‡ä»¶ï¼Œä½¿ç”¨ index ä½œä¸ºç´¢å¼•ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ arm æ¶æ„çš„å¤„ç†å™¨æ—¶è¦é¢å¤–æ³¨æ„ï¼Œåœ¨æ‹‰å–é•œåƒçš„æ—¶å€™è¦æ‹‰å– arm æ¶æ„çš„é•œåƒï¼Œä¸€èˆ¬å¤„ç†å™¨çš„æ¶æ„éƒ½æ¥åœ¨é•œåƒçš„ tag åé¢ï¼Œé»˜è®¤ latest tag çš„é•œåƒæ˜¯ x86 çš„ï¼Œåœ¨ arm å¤„ç†å™¨çš„æœºå™¨è¿™äº›é•œåƒä¸Šæ˜¯è·‘ä¸èµ·æ¥çš„ã€‚</p>
<h3 id="å„ç§-id-åˆ†ä¸æ¸…ï¼Ÿ"><a href="#å„ç§-id-åˆ†ä¸æ¸…ï¼Ÿ" class="headerlink" title="å„ç§ id åˆ†ä¸æ¸…ï¼Ÿ"></a>å„ç§ id åˆ†ä¸æ¸…ï¼Ÿ</h3><p>çœ‹å®Œ  <a href="http://www.github.com/opencontainers/image-spec" target="_blank" rel="noopener">image-spec</a> é‡Œé¢æåˆ°çš„å„ç§ id ç›¸ä¿¡ä½ åˆå¾ˆå¤šç–‘æƒ‘ï¼Œåœ¨æ­¤æ€»ç»“ä¸€ä¸‹è¿™äº› id çš„ä½œç”¨ï¼š</p>
<table>
<thead>
<tr>
<th align="center">image-id</th>
<th>image config çš„ sha256 å“ˆå¸Œå€¼ï¼Œåœ¨æœ¬åœ°é•œåƒå­˜å‚¨ä¸­ç”±å®ƒå”¯ä¸€æ ‡è¯†ä¸€ä¸ªé•œåƒ</th>
</tr>
</thead>
<tbody><tr>
<td align="center">image digest</td>
<td>åœ¨ registry ä¸­çš„ image manifest çš„ sha256 å“ˆå¸Œå€¼ï¼Œåœ¨ registry ä¸­ç”±å®ƒå”¯ä¸€æ ‡è¯†ä¸€ä¸ªé•œåƒ</td>
</tr>
<tr>
<td align="center">diff_ids</td>
<td>é•œåƒæ¯ä¸€å±‚çš„ id ï¼Œæ˜¯å¯¹ layer çš„æœªå‹ç¼©çš„ tar åŒ…çš„ sha256 å“ˆå¸Œå€¼</td>
</tr>
<tr>
<td align="center">layer digest</td>
<td>é•œåƒåœ¨ registry å­˜å‚¨ä¸­çš„ id ï¼Œæ˜¯å¯¹ layerå‹ç¼©åçš„ tar åŒ…çš„ sha256 å“ˆå¸Œå€¼</td>
</tr>
</tbody></table>
<p>é•œåƒçš„ image config ä¸­çš„ <code>rootfs</code> å­—æ®µè®°å½•äº†æ¯ä¸€å±‚ layer çš„ idï¼Œè€Œé•œåƒçš„ layer id åˆ™æ˜¯ layer tar åŒ…çš„ sha256 å€¼ï¼Œå¦‚æœé•œåƒçš„ layer æ”¹å˜ï¼Œåˆ™è¿™ä¸ª layer id ä¼šæ”¹å˜ï¼Œè€Œè®°å½•å®ƒçš„ image config å†…å®¹ä¹Ÿä¼šæ”¹å˜ï¼Œimage config å†…å®¹å˜äº†ï¼Œimage config æ–‡ä»¶çš„ sha256 å€¼ä¹Ÿå°±ä¼šæ”¹å˜ï¼Œè¿™æ ·å°±å¯ä»¥ç”± image id å’Œ image digest å”¯ä¸€æ ‡è¯†ä¸€ä¸ªé•œåƒï¼Œè¾¾åˆ°é˜²æ²»ç¯¡æ”¹çš„å®‰å…¨ç›®çš„ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">"rootfs": &#123;</span><br><span class="line">    "type": "layers",</span><br><span class="line">    "diff_ids": [</span><br><span class="line">      <span class="string">"sha256:d1b85e6186f67d9925c622a7a6e66faa447e767f90f65ae47cdc817c629fa956"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>ä¼—æ‰€å‘¨çŸ¥ docker é•œåƒéœ€è¦ä¸€ä¸ª Dockerfile æ¥æ„å»ºè€Œæˆï¼Œå½“æˆ‘ä»¬å¯¹ OCI é•œåƒè§„èŒƒæœ‰äº†ä¸ªå¤§è‡´çš„äº†è§£ä¹‹åï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±æ‹¿ç€ Dockerfile è¿™ä¸ª â€å›¾çº¸â€œ å»ä¸€æ­¥æ­¥æ„å»ºé•œåƒã€‚æœ¬æ–‡ä¸å†ç»†è®² Dockerfile çš„è¯¦ç»†ä¹¦å†™å’ŒæŠ€å·§ï¼Œç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šä¼—æ‰€å‘¨çŸ¥çš„å…³äºå†™å¥½ Dockerfile çš„æŠ€å·§ï¼Œæ¯”å¦‚æˆ‘ä¹‹å‰æ°´è¿‡çš„ä¸€ç¯‡ <a href="https://blog.k8s.li/dockerfile-tips.html">Dockerfile æ“é•œåƒçš„å°æŠ€å·§</a> ã€‚</p>
<p>ä¸‹é¢å°±æ˜¯ <a href="https://webp.sh" target="_blank" rel="noopener">webp server go</a> Dockerfile çš„ä¾‹å­ï¼š</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:alpine as builder</span><br><span class="line"><span class="keyword">ARG</span> IMG_PATH=/opt/pics</span><br><span class="line"><span class="keyword">ARG</span> EXHAUST_PATH=/opt/exhaust</span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk update ;\</span></span><br><span class="line"><span class="bash">    apk add alpine-sdk ;\</span></span><br><span class="line"><span class="bash">    git <span class="built_in">clone</span> https://github.com/webp-sh/webp_server_go /build ;\</span></span><br><span class="line"><span class="bash">    <span class="built_in">cd</span> /build ;\</span></span><br><span class="line"><span class="bash">    sed -i <span class="string">"s|.\/pics|<span class="variable">$&#123;IMG_PATH&#125;</span>|g"</span> config.json ;\</span></span><br><span class="line"><span class="bash">    sed -i <span class="string">"s|\"\"|\"<span class="variable">$&#123;EXHAUST_PATH&#125;</span>\"|g"</span> config.json ;\</span></span><br><span class="line"><span class="bash">    sed -i <span class="string">'s/127.0.0.1/0.0.0.0/g'</span> config.json</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /build</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> go build -o webp-server .</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /build/webp-server  /usr/bin/webp-server</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=builder /build/config.json /etc/config.json</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /opt</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> /opt/exhaust</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"/usr/bin/webp-server"</span>, <span class="string">"--config"</span>, <span class="string">"/etc/config.json"</span>]</span></span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ RUN æŒ‡ä»¤çš„æ¯è¡Œç»“å°¾æˆ‘ä½¿ç”¨çš„æ˜¯ <code>;\</code> æ¥æ¥ä¸‹ä¸€è¡Œ shell ï¼Œå¦ä¸€ç§å†™æ³•æ˜¯ <code>&amp;&amp;</code> ã€‚äºŒè€…æœ‰æœ¬è´¨çš„åŒºåˆ«ï¼Œæ¯”å¦‚ COMMAND 1;COMMAND 2 ï¼Œå½“ COMMAND 1 è¿è¡Œå¤±è´¥æ—¶ä¼šç»§ç»­è¿è¡Œ COMMAND2 ï¼Œå¹¶ä¸ä¼šé€€å‡ºã€‚è€Œ COMMAND 1&amp;&amp; COMMAND 2ï¼Œæ—¶ COMMAND 1 è¿è¡ŒæˆåŠŸæ—¶æ‰æ¥ç€è¿è¡Œ COMMAND 2 ï¼ŒCOMMAND 1 è¿è¡Œå¤±è´¥ä¼šé€€å‡ºã€‚å¦‚æœæ²¡æœ‰åè¶³çš„æŠŠæ¡ä¿è¯æ¯ä¸€è¡Œ shell éƒ½èƒ½æ¯æ¬¡è¿è¡ŒæˆåŠŸå»ºè®®ç”¨ <code>&amp;&amp;</code> ï¼Œè¿™æ ·å¤±è´¥äº†å°±é€€å‡ºæ„å»ºé•œåƒï¼Œä¸ç„¶æ„å»ºå‡ºæ¥çš„é•œåƒä¼šæœ‰é—®é¢˜ã€‚å¦‚æœæ˜¯è€å¸æœºğŸš— çš„è¯å»ºè®®ç”¨ <code>;</code> ï¼Œé€›äº†ä¸€åœˆ docker hub å®˜æ–¹é•œåƒä¸­ç”¨ <code>;</code> è¾ƒå¤šä¸€äº›ï¼Œå› ä¸º <code>;</code> æ¯” <code>&amp;&amp;</code> è¦ç¾è§‚ä¸€äº›ï¼ˆå¤§é›¾ğŸ˜‚ã€‚</p>
<ul>
<li>é£æ ¼ä¸€ï¼šæ¯”å¦‚ <a href="https://github.com/nginxinc/docker-nginx/blob/master/stable/buster/Dockerfile" target="_blank" rel="noopener">nginx</a> å®˜æ–¹é•œåƒæ˜¯ç”¨çš„ <code>&amp;&amp;</code>ï¼Œè²Œä¼¼ä¹Ÿæ··å…¥äº† <code>;</code>ğŸ¤£</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">RUN set -x \</span><br><span class="line"><span class="meta">#</span><span class="bash"> create nginx user/group first, to be consistent throughout docker variants</span></span><br><span class="line">    &amp;&amp; addgroup --system --gid 101 nginx \</span><br><span class="line">    &amp;&amp; adduser --system --disabled-login --ingroup nginx --no-create-home --home /nonexistent --gecos "nginx user" --shell /bin/false --uid 101 nginx \</span><br><span class="line">    &amp;&amp; apt-get update \</span><br><span class="line">    &amp;&amp; apt-get install --no-install-recommends --no-install-suggests -y gnupg1 ca-certificates \</span><br><span class="line">    &amp;&amp; \</span><br><span class="line">    NGINX_GPGKEY=573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62; \</span><br><span class="line">    found=''; \</span><br><span class="line">    for server in \</span><br><span class="line">        ha.pool.sks-keyservers.net \</span><br><span class="line">        hkp://keyserver.ubuntu.com:80 \</span><br><span class="line">        hkp://p80.pool.sks-keyservers.net:80 \</span><br><span class="line">        pgp.mit.edu \</span><br><span class="line">    ; do \</span><br></pre></td></tr></table></figure>
<ul>
<li>é£æ ¼äºŒï¼šæ¯”å¦‚ <a href="https://github.com/docker-library/redis/blob/23af5b6adb271bcebbcebc93308884438512a4af/6.0/Dockerfile" target="_blank" rel="noopener">redis</a> å®˜æ–¹é•œåƒå°±æ¸…ä¸€è‰²ä½¿ç”¨çš„ <code>;</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">RUN set -eux; \</span><br><span class="line">	savedAptMark="$(apt-mark showmanual)"; \</span><br><span class="line">	apt-get update; \</span><br><span class="line">	apt-get install -y --no-install-recommends ca-certificates dirmngr gnupg wget; \</span><br><span class="line">	rm -rf /var/lib/apt/lists/*; \</span><br><span class="line">	dpkgArch="$(dpkg --print-architecture | awk -F- '&#123; print $NF &#125;')"; \</span><br><span class="line">	wget -O /usr/local/bin/gosu "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch"; \</span><br><span class="line">	wget -O /usr/local/bin/gosu.asc "https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$dpkgArch.asc"; \</span><br><span class="line">	export GNUPGHOME="$(mktemp -d)"; \</span><br><span class="line">	gpg --batch --keyserver hkps://keys.openpgp.org --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4; \</span><br><span class="line">	gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu; \</span><br><span class="line">	gpgconf --kill all; \</span><br><span class="line">	rm -rf "$GNUPGHOME" /usr/local/bin/gosu.asc; \</span><br><span class="line">	apt-mark auto '.*' &gt; /dev/null; \</span><br><span class="line">	[ -z "$savedAptMark" ] || apt-mark manual $savedAptMark &gt; /dev/null; \</span><br><span class="line">	apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false; \</span><br><span class="line">	chmod +x /usr/local/bin/gosu; \</span><br><span class="line">	gosu --version; \</span><br><span class="line">	gosu nobody true</span><br></pre></td></tr></table></figure>
<p>æ±å–œæ¬¢å“ªç§é£æ ¼å‘¢ï¼Ÿå¿«åœ¨è¯„è®ºåŒºç•™è¨€å§ğŸ˜‹</p>
<h4 id="é•œåƒå·¥å‚ğŸ› "><a href="#é•œåƒå·¥å‚ğŸ› " class="headerlink" title="é•œåƒå·¥å‚ğŸ› "></a>é•œåƒå·¥å‚ğŸ› </h4><blockquote>
<p>Docker æ˜¯ä¸€ä¸ªå…¸å‹çš„ C/S æ¶æ„çš„åº”ç”¨ï¼Œåˆ†ä¸º Docker å®¢æˆ·ç«¯ï¼ˆå³å¹³æ—¶æ•²çš„ docker å‘½ä»¤ï¼‰ Docker æœåŠ¡ç«¯ï¼ˆdockerd å®ˆæŠ¤è¿›ç¨‹ï¼‰ã€‚</p>
<p>Docker å®¢æˆ·ç«¯é€šè¿‡ REST API å’ŒæœåŠ¡ç«¯è¿›è¡Œäº¤äº’ï¼Œdocker å®¢æˆ·ç«¯æ¯å‘é€ä¸€æ¡æŒ‡ä»¤ï¼Œåº•å±‚éƒ½ä¼šè½¬åŒ–æˆ REST API è°ƒç”¨çš„å½¢å¼å‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚å¹¶ç»™å‡ºå“åº”ã€‚</p>
<p>Docker é•œåƒçš„æ„å»ºã€å®¹å™¨åˆ›å»ºã€å®¹å™¨è¿è¡Œç­‰å·¥ä½œéƒ½æ˜¯ Docker æœåŠ¡ç«¯æ¥å®Œæˆçš„ï¼ŒDocker å®¢æˆ·ç«¯åªæ˜¯æ‰¿æ‹…å‘é€æŒ‡ä»¤çš„è§’è‰²ã€‚</p>
<p>Docker å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å¯ä»¥åœ¨åŒä¸€ä¸ªå®¿ä¸»æœºï¼Œä¹Ÿå¯ä»¥åœ¨ä¸åŒçš„å®¿ä¸»æœºï¼Œå¦‚æœåœ¨åŒä¸€ä¸ªå®¿ä¸»æœºçš„è¯ï¼ŒDocker å®¢æˆ·ç«¯é»˜è®¤é€šè¿‡ UNIX å¥—æ¥å­—(<code>/var/run/docker.sock</code>)å’ŒæœåŠ¡ç«¯é€šä¿¡ã€‚</p>
</blockquote>
<p>ç±»æ¯”äºé’¢é“æ˜¯æ€æ ·ç‚¼æˆçš„ï¼Œå¦‚æœè¯´ç‚¼åˆ¶é•œåƒä¹Ÿéœ€è¦ä¸ªå·¥å‚çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ dockerd è¿™ä¸ªå®ˆæŠ¤è¿›ç¨‹å°±æ˜¯ä¸ªç”Ÿäº§é•œåƒçš„å·¥å‚ã€‚èƒ½ç”Ÿäº§é•œåƒçš„ä¸æ­¢ docker ä¸€å®¶ï¼Œçº¢å¸½å­å®¶çš„ <a href="https://buildah.io/" target="_blank" rel="noopener">buildah</a> ä¹Ÿèƒ½ç”Ÿäº§é•œåƒï¼Œä¸è¿‡ç”¨çš„äººå¹¶ä¸å¤šã€‚äºŒè€…çš„æœ€å¤§åŒºåˆ«åœ¨äº buildah å¯ä»¥ä¸ç”¨ root æƒé™æ¥æ„å»ºé•œåƒï¼Œè€Œä½¿ç”¨ docker æ„å»ºé•œåƒæ—¶éœ€è¦ç”¨åˆ° root æƒé™ï¼Œæ²¡æœ‰ root æƒé™çš„ç”¨æˆ·æ„å»ºé•œåƒä¼šå½“åœºç¿»è½¦ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock:</span><br></pre></td></tr></table></figure>
<p>ä¸è¿‡ buildah æ„å»ºå‡ºæ¥çš„é•œåƒæœ‰ä¸€å †å †çš„å…¼å®¹æ€§é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ docker æ¥æ„å»ºé•œåƒå§ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ docker build å‘½ä»¤æ„å»ºä¸€ä¸ªé•œåƒçš„æ—¶å€™ç¬¬ä¸€è¡Œæ—¥å¿—å°±æ˜¯ <code>Sending build context to Docker daemon xx MB</code>ã€‚è¿™ä¸€æ­¥æ˜¯ docker cli è¿™ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯å°†æˆ‘ä»¬å½“å‰ç›®å½•ï¼ˆå³æ„å»ºä¸Šä¸‹æ–‡ï¼‰ <code>build context</code> æ‰“åŒ…å‘é€ <code>Docker daemon</code> å®ˆæŠ¤è¿›ç¨‹ ï¼ˆå³ dockerdï¼‰çš„è¿‡ç¨‹ã€‚</p>
<p><img src="https://p.k8s.li/docker-architecture.png" alt=""></p>
<p>docker build æ„å»ºé•œåƒçš„æµç¨‹å¤§æ¦‚å°±æ˜¯ï¼š</p>
<ul>
<li>æ‰§è¡Œ <code>docker build -t &lt;imageName:Tag&gt; .</code>ï¼Œå¯ä»¥ä½¿ç”¨ <code>-f</code>å‚æ•°æ¥æŒ‡å®š Dockerfile æ–‡ä»¶ï¼›</li>
<li>docker å®¢æˆ·ç«¯ä¼šå°†æ„å»ºå‘½ä»¤åé¢æŒ‡å®šçš„è·¯å¾„(<code>.</code>)ä¸‹çš„æ‰€æœ‰æ–‡ä»¶æ‰“åŒ…æˆä¸€ä¸ª tar åŒ…ï¼Œå‘é€ç»™ Docker æœåŠ¡ç«¯;</li>
<li>docker æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„ tar åŒ…ï¼Œç„¶åè§£å‹ï¼Œæ¥ä¸‹æ¥æ ¹æ® Dockerfile é‡Œé¢çš„æŒ‡ä»¤è¿›è¡Œé•œåƒçš„åˆ†å±‚æ„å»ºï¼›</li>
<li>docker ä¸‹è½½ FROM è¯­å¥ä¸­æŒ‡å®šçš„åŸºç¡€é•œåƒï¼Œç„¶åå°†åŸºç¡€é•œåƒçš„ layer è”åˆæŒ‚è½½ä¸ºä¸€å±‚ï¼Œå¹¶åœ¨ä¸Šé¢åˆ›å»ºä¸€ä¸ªç©ºç›®å½•ï¼›</li>
<li>æ¥ç€å¯åŠ¨ä¸€ä¸ªä¸´æ—¶çš„å®¹å™¨å¹¶åœ¨ chroot ä¸­å¯åŠ¨ä¸€ä¸ª bashï¼Œè¿è¡Œ <code>RUN</code> è¯­å¥ä¸­çš„å‘½ä»¤ï¼š<code>RUN: chroot . /bin/bash -c &quot;apt get updateâ€¦â€¦&quot;</code>ï¼›</li>
<li>ä¸€æ¡ <code>RUN</code> å‘½ä»¤ç»“æŸåï¼Œä¼šæŠŠä¸Šå±‚ç›®å½•å‹ç¼©ï¼Œå½¢æˆæ–°é•œåƒä¸­çš„æ–°çš„ä¸€å±‚ï¼›</li>
<li>å¦‚æœ Dockerfile ä¸­åŒ…å«å…¶å®ƒå‘½ä»¤ï¼Œå°±ä»¥ä¹‹å‰æ„å»ºçš„å±‚æ¬¡ä¸ºåŸºç¡€ï¼Œä»ç¬¬äºŒæ­¥å¼€å§‹é‡å¤åˆ›å»ºæ–°å±‚ï¼Œç›´åˆ°å®Œæˆæ‰€æœ‰è¯­å¥åé€€å‡ºï¼›</li>
<li>æ„å»ºå®Œæˆä¹‹åä¸ºè¯¥é•œåƒæ‰“ä¸Š tagï¼›</li>
</ul>
<p>ä»¥ä¸Šå°±æ˜¯æ„å»ºé•œåƒçš„å¤§è‡´æµç¨‹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ <code>docker history &lt;imageName:Tag&gt;</code> å‘½ä»¤æ¥é€†å‘æ¨ç®—å‡º docker build çš„è¿‡ç¨‹ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 ~/buster/slim</span><br><span class="line">â•°â”€# docker history webpsh/webps</span><br><span class="line">IMAGE               CREATED             CREATED BY          SIZE                COMMENT</span><br><span class="line">30d9679b0b1c        2 weeks ago         /bin/sh -c #(nop)  CMD ["/usr/bin/webp-serveâ€¦   0B</span><br><span class="line">&lt;missing&gt;           2 weeks ago         /bin/sh -c #(nop)  VOLUME [/opt/exhaust]        0B</span><br><span class="line">&lt;missing&gt;           2 weeks ago         /bin/sh -c #(nop) WORKDIR /opt                  0B</span><br><span class="line">&lt;missing&gt;           2 weeks ago         /bin/sh -c #(nop) COPY file:1497d882aeef5f77â€¦   168B</span><br><span class="line">&lt;missing&gt;           2 weeks ago         /bin/sh -c #(nop) COPY file:327020918e4dc998â€¦   14.9MB</span><br><span class="line">&lt;missing&gt;           6 weeks ago         /bin/sh -c #(nop)  CMD ["/bin/sh"]              0B</span><br><span class="line">&lt;missing&gt;           6 weeks ago         /bin/sh -c #(nop) ADD file:b91adb67b670d3a6fâ€¦   5.61MB</span><br><span class="line"></span><br><span class="line">â•­â”€root@sg-02 ~/buster/slim</span><br><span class="line">â•°â”€# docker history debian:v2</span><br><span class="line">IMAGE               CREATED             CREATED BY           SIZE                COMMENT</span><br><span class="line">e6e782a57a51        38 hours ago        /bin/sh -c #(nop)  CMD ["bash"]                 0B</span><br><span class="line">ba8f577813c7        38 hours ago        /bin/sh -c #(nop) ADD file:a82014afc29e7b364â€¦   69.2MB</span><br></pre></td></tr></table></figure>
<h4 id="base-image"><a href="#base-image" class="headerlink" title="base image"></a>base image</h4><p>å½“æˆ‘ä»¬åœ¨å†™ Dockerfile çš„æ—¶å€™éƒ½éœ€è¦ç”¨ <code>FROM</code> è¯­å¥æ¥æŒ‡å®šä¸€ä¸ªåŸºç¡€é•œåƒï¼Œè¿™äº›åŸºç¡€é•œåƒå¹¶ä¸æ˜¯æ— ä¸­ç”Ÿæœ‰ï¼Œä¹Ÿéœ€è¦ä¸€ä¸ª Dockerfile æ¥æ„å»ºæˆé•œåƒã€‚ä¸‹é¢æˆ‘ä»¬æ‹¿æ¥ <a href="https://hub.docker.com/_/debian" target="_blank" rel="noopener">debian:buster</a> è¿™ä¸ªåŸºç¡€é•œåƒçš„ <a href="https://github.com/debuerreotype/docker-debian-artifacts/blob/18cb4d0418be1c80fb19141b69ac2e0600b2d601/buster/Dockerfile" target="_blank" rel="noopener">Dockerfile</a> æ¥çœ‹ä¸€ä¸‹åŸºç¡€é•œåƒæ˜¯å¦‚ä½•ç‚¼æˆçš„ã€‚</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> scratch</span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> rootfs.tar.xz /</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"bash"</span>]</span></span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªåŸºç¡€é•œåƒçš„ Dockerfile ä¸€èˆ¬ä»…æœ‰ä¸‰è¡Œã€‚ç¬¬ä¸€è¡Œ <code>FROM scratch</code> ä¸­çš„<code>scratch</code> è¿™ä¸ªé•œåƒå¹¶ä¸çœŸå®çš„å­˜åœ¨ã€‚å½“ä½ ä½¿ç”¨ <code>docker pull scratch</code> å‘½ä»¤æ¥æ‹‰å–è¿™ä¸ªé•œåƒçš„æ—¶å€™ä¼šç¿»è½¦å“¦ï¼Œæç¤º <code>Error response from daemon: &#39;scratch&#39; is a reserved name</code>ã€‚è¿™æ˜¯å› ä¸ºè‡ªä» docker 1.5 ç‰ˆæœ¬å¼€å§‹ï¼Œåœ¨ Dockerfile ä¸­ <code>FROM scratch</code> æŒ‡ä»¤å¹¶ä¸è¿›è¡Œä»»ä½•æ“ä½œï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šåˆ›å»ºä¸€ä¸ªé•œåƒå±‚ï¼›æ¥ç€ç¬¬äºŒè¡Œçš„ <code>ADD rootfs.tar.xz /</code> ä¼šè‡ªåŠ¨æŠŠ <code>rootfs.tar.xz</code>  è§£å‹åˆ° <code>/</code> ç›®å½•ä¸‹ï¼Œç”±æ­¤äº§ç”Ÿçš„ä¸€å±‚é•œåƒå°±æ˜¯æœ€ç»ˆæ„å»ºçš„é•œåƒçœŸå®çš„ layer å†…å®¹ï¼›ç¬¬ä¸‰è¡Œ <code>CMD [&quot;bash&quot;]</code> æŒ‡å®šè¿™é•œåƒåœ¨å¯åŠ¨å®¹å™¨çš„æ—¶å€™æ‰§è¡Œçš„åº”ç”¨ç¨‹åºï¼Œä¸€èˆ¬åŸºç¡€é•œåƒçš„ CMD é»˜è®¤ä¸º bash æˆ–è€… sh ã€‚</p>
<blockquote>
<p>As of Docker 1.5.0 (specifically, <a href="https://github.com/docker/docker/pull/8827" target="_blank" rel="noopener"><code>docker/docker#8827</code></a>), <code>FROM scratch</code> is a no-op in the Dockerfile , and will not create an extra layer in your image (so a previously 2-layer image will be a 1-layer image instead).</p>
</blockquote>
<p><code>ADD rootfs.tar.xz /</code> ä¸­ï¼Œè¿™ä¸ª <code>rootfs.tar.xz</code> å°±æ˜¯æˆ‘ä»¬ç»è¿‡ä¸€ç³»åˆ—éªšæ“ä½œï¼ˆä¸€èˆ¬æ˜¯å‘è¡Œç‰ˆæºç ç¼–è¯‘ï¼‰æ“å‡ºæ¥çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¸ªæ“ä½œæ¯”è¾ƒå¤æ‚ï¼Œæœ¨å­å¤ªèœäº†ğŸ¥¬å°±ä¸åœ¨è¿™é‡Œçæ°æ°äº†ğŸ™ƒï¼Œå¦‚æœæ±å¯¹æºç æ„å»º <code>rootfs.tar.xz</code> è¿™ä¸ªè¿‡ç¨‹æ„Ÿå…´è¶£å¯ä»¥å»çœ‹ä¸€ä¸‹æ„å»º debian åŸºç¡€é•œåƒçš„ Jenkins æµæ°´çº¿ä»»åŠ¡ <a href="https://doi-janky.infosiftr.net/job/tianon/job/debuerreotype/" target="_blank" rel="noopener">debuerreotype</a>ï¼Œä¸Šé¢æœ‰æ„å»ºè¿™ä¸ª <code>rootfs.tar.xz</code> å®Œæ•´è¿‡ç¨‹ï¼Œæˆ–è€…å‚è€ƒ Debian å®˜æ–¹çš„ <a href="https://github.com/debuerreotype/docker-debian-artifacts" target="_blank" rel="noopener">docker-debian-artifacts</a> è¿™ä¸ª repo é‡Œçš„ shell è„šæœ¬ã€‚</p>
<p>éœ€è¦é¢å¤–æ³¨æ„ä¸€ç‚¹ï¼Œåœ¨è¿™é‡Œå¾€é•œåƒé‡Œæ·»åŠ  <code>rootfs.tar.xz</code> æ—¶ä½¿ç”¨çš„æ˜¯ <code>ADD</code> è€Œä¸æ˜¯ <code>COPY</code> ï¼Œå› ä¸ºåœ¨ Dockerfile ä¸­çš„ ADD æŒ‡ä»¤ src æ–‡ä»¶å¦‚æœæ˜¯ä¸ª tar åŒ…ï¼Œåœ¨æ„å»ºçš„æ—¶å€™ docker ä¼šå¸®æˆ‘ä»¬æŠŠ tar åŒ…è§£å¼€åˆ°æŒ‡å®šç›®å½•ï¼Œä½¿ç”¨ copy æŒ‡ä»¤åˆ™ä¸ä¼šè§£å¼€ tar åŒ…ã€‚å¦å¤–ä¸€ç‚¹åŒºåˆ«å°±æ˜¯ ADD æŒ‡ä»¤æ˜¯æ·»åŠ ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å¯ä»¥æ˜¯æ„å»ºä¸Šä¸‹æ–‡ç¯å¢ƒä¸­çš„æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸ª URLï¼Œè€Œ COPY åˆ™åªèƒ½æ·»åŠ æ„å»ºä¸Šä¸‹æ–‡ä¸­çš„æ–‡ä»¶ï¼Œæ‰€è°“çš„æ„å»ºä¸Šä¸‹æ–‡å°±æ˜¯æˆ‘ä»¬æ„å»ºé•œåƒçš„æ—¶å€™æœ€åä¸€ä¸ªå‚æ•°å•¦ã€‚</p>
<blockquote>
<p>PSï¼šé¢è¯•çš„æ—¶å€™ç»å¸¸è¢«é—® ADD ä¸ COPY çš„åŒºåˆ«ï¼›CMD ä¸ ENTRYPOINT çš„åŒºåˆ«ğŸ˜‚ã€‚</p>
</blockquote>
<p>æ“è¿™ä¸ª <code>rootfs.tar.xz</code> ä¸åŒçš„å‘è¡Œç‰ˆæ–¹æ³•å¯èƒ½ä¸å¤ªä¸€æ ·ï¼ŒDebian å‘è¡Œç‰ˆçš„ <code>rootfs.tar.xz</code> å¯ä»¥åœ¨ <a href="https://github.com/debuerreotype/docker-debian-artifacts" target="_blank" rel="noopener">docker-debian-artifacts</a> è¿™ä¸ª repo ä¸Šæ‰¾åˆ°ï¼Œæ ¹æ®ä¸åŒå¤„ç†å™¨ arch é€‰æ‹©ç›¸åº”çš„ branch ï¼Œç„¶åè¿™ä¸ª branch ä¸‹çš„ç›®å½•å°±å¯¹åº”ç€è¯¥å‘è¡Œç‰ˆçš„ä¸åŒçš„ç‰ˆæœ¬çš„ä»£å·ã€‚æ„å¤–å‘ç° Debian å®˜æ–¹æ˜¯å°†æ‰€æœ‰ arch å’Œæ‰€æœ‰ç‰ˆæœ¬çš„ <code>rootfs.tar.xz</code> éƒ½æ”¾åœ¨è¿™ä¸ª repo é‡Œçš„ï¼Œä»¥è‡³äºè¿™ä¸ª repo çš„å¤§å°æ¥è¿‘ 2.88 GiB ğŸ˜¨ï¼Œå½“ç½‘ç›˜æ¥ç”¨çš„å˜›ğŸ¤£ï¼ˆï¼šæ‰‹åŠ¨æ»‘ç¨½</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 ~</span><br><span class="line">â•°â”€# git clone https://github.com/debuerreotype/docker-debian-artifacts</span><br><span class="line">Cloning into 'docker-debian-artifacts'...</span><br><span class="line">remote: Enumerating objects: 278, done.</span><br><span class="line">remote: Counting objects: 100% (278/278), done.</span><br><span class="line">Receiving objects:  67% (443/660), 1.60 GiB | 16.96 MiB/s</span><br><span class="line">remote: Total 660 (delta 130), reused 244 (delta 97), pack-reused 382</span><br><span class="line">Receiving objects: 100% (660/660), 2.88 GiB | 16.63 MiB/s, done.</span><br><span class="line">Resolving deltas: 100% (267/267), done.</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æŠŠè¿™ä¸ª <code>rootfs.tar.xz</code> è§£å¼€å°±å¯ä»¥çœ‹åˆ°ï¼Œè¿™å°±æ˜¯ä¸€ä¸ª Linux çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œä¸åŒäºæˆ‘ä»¬ä½¿ç”¨ ISO å®‰è£…ç³»ç»Ÿçš„é‚£ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œè¿™ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿæ˜¯ç»è¿‡ä¸€ç³»åˆ—çš„è£å‰ªï¼Œå»æ‰äº†ä¸€äº›åœ¨å®¹å™¨è¿è¡Œä¸­ä¸å¿…è¦çš„æ–‡ä»¶ï¼Œä½¿ä¹‹æ›´åŠ è½»é‡é€‚ç”¨äºå®¹å™¨è¿è¡Œçš„åœºæ™¯ï¼Œæ•´ä¸ªæ ¹æ–‡ä»¶ç³»ç»Ÿçš„å¤§å°ä¸º 125Mï¼Œå¦‚æœä½¿ç”¨ slim çš„<code>rootfs.tar.xz</code> ä¼šæ›´å°ä¸€äº›ï¼Œä»…ä»… 76Mã€‚å½“ç„¶ç›¸æ¯”äºä»…ä»…å‡  M çš„ <code>alpine</code> ï¼Œè¿™ç®—æ˜¯å¤Ÿå¤§çš„äº†ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º</span><br><span class="line">â•°â”€# git checkout dist-amd64</span><br><span class="line">â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º</span><br><span class="line">â•°â”€# cd buster</span><br><span class="line">â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º</span><br><span class="line">â•°â”€# mkdir rootfs</span><br><span class="line">â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º</span><br><span class="line">â•°â”€# tar -xvf rootfs.tar.xz -C !$</span><br><span class="line">â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º</span><br><span class="line">â•°â”€# ls rootfs/</span><br><span class="line">bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º</span><br><span class="line">â•°â”€# du -sh rootfs</span><br><span class="line">125M    rootfs</span><br><span class="line">â•­â”€root@sg-02 ~/docker-debian-artifacts/buster â€¹dist-amd64*â€º</span><br><span class="line">â•°â”€# du -sh slim/rootfs</span><br><span class="line">76M     slim/rootfs</span><br></pre></td></tr></table></figure>
<p>æƒ³è¦è‡ªå·±æ„å»ºä¸€ä¸ª <code>debian:buster</code> åŸºç¡€é•œåƒå…¶å®å¾ˆç®€å•ï¼Œå°±åƒä¸‹é¢è¿™æ ·ä¸€æŠŠæ¢­æ“ä½œä¸‹æ¥å°±è¡ŒğŸ˜‚ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/debuerreotype/docker-debian-artifacts debian</span><br><span class="line">cd !$</span><br><span class="line">git checkout dist-amd64</span><br><span class="line">cd buster</span><br><span class="line">docker build -t debian:buster .</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢å°±æ˜¯æ„å»º Debian åŸºç¡€é•œåƒçš„è¿‡ç¨‹ï¼Œæ­£å¦‚ Dockerfile ä¸­çš„é‚£æ ·ï¼Œæœ€ç»ˆåªäº§ç”Ÿäº†ä¸€å±‚é•œåƒã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">docker build -t debian:buster .</span><br><span class="line">Sending build context to Docker daemon  30.12MB</span><br><span class="line">Step 1/3 : FROM scratch</span><br><span class="line"><span class="meta"> ---&gt;</span></span><br><span class="line">Step 2/3 : ADD rootfs.tar.xz /</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 1756d6a585ae</span></span><br><span class="line">Step 3/3 : CMD ["bash"]</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> c86a8b6deb3d</span></span><br><span class="line">Removing intermediate container c86a8b6deb3d</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 04948daa3c2e</span></span><br><span class="line">Successfully built 04948daa3c2e</span><br><span class="line">Successfully tagged debian:buster</span><br></pre></td></tr></table></figure>
<h2 id="é•œåƒæ˜¯æ€æ ·å­˜æ”¾çš„-ï¼ˆä¸€ï¼‰æœ¬åœ°å­˜å‚¨-ğŸ™„"><a href="#é•œåƒæ˜¯æ€æ ·å­˜æ”¾çš„-ï¼ˆä¸€ï¼‰æœ¬åœ°å­˜å‚¨-ğŸ™„" class="headerlink" title="é•œåƒæ˜¯æ€æ ·å­˜æ”¾çš„ ï¼ˆä¸€ï¼‰æœ¬åœ°å­˜å‚¨ ğŸ™„"></a>é•œåƒæ˜¯æ€æ ·å­˜æ”¾çš„ ï¼ˆä¸€ï¼‰æœ¬åœ°å­˜å‚¨ ğŸ™„</h2><p>å½“æˆ‘ä»¬æ„å»ºå®Œä¸€ä¸ªé•œåƒä¹‹åï¼Œé•œåƒå°±å­˜å‚¨åœ¨äº†æˆ‘ä»¬ docker æœ¬åœ°å­˜å‚¨ç›®å½•ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸º <code>/var/lib/docker</code> ï¼Œä¸‹é¢å°±æ¢å¯»ä¸€ä¸‹é•œåƒæ˜¯ä»¥ä»€ä¹ˆæ ·çš„ç›®å½•ç»“æ„å­˜æ”¾çš„ã€‚åœ¨å¼€å§‹ hack ä¹‹å‰æˆ‘ä»¬å…ˆç»Ÿä¸€ä¸€ä¸‹ç¯å¢ƒä¿¡æ¯ï¼Œæˆ‘ä½¿ç”¨çš„æœºå™¨æ˜¯ Ubuntu 1804ï¼Œ<code>docker info</code> ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">â•­â”€root@sg-02</span> <span class="string">/var/lib/docker</span></span><br><span class="line"><span class="string">â•°â”€#</span> <span class="string">docker</span> <span class="string">info</span></span><br><span class="line"><span class="attr">Client:</span></span><br><span class="line"> <span class="attr">Debug Mode:</span> <span class="literal">false</span></span><br><span class="line"> <span class="attr">Plugins:</span></span><br><span class="line">  <span class="attr">buildx:</span> <span class="string">Build</span> <span class="string">with</span> <span class="string">BuildKit</span> <span class="string">(Docker</span> <span class="string">Inc.,</span> <span class="string">v0.3.1-tp-docker)</span></span><br><span class="line">  <span class="attr">app:</span> <span class="string">Docker</span> <span class="string">Application</span> <span class="string">(Docker</span> <span class="string">Inc.,</span> <span class="string">v0.8.0)</span></span><br><span class="line"><span class="attr">Server:</span></span><br><span class="line"> <span class="attr">Containers:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">Running:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">Paused:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">Stopped:</span> <span class="number">0</span></span><br><span class="line"> <span class="attr">Images:</span> <span class="number">2</span></span><br><span class="line"> <span class="attr">Server Version:</span> <span class="number">19.03</span><span class="number">.5</span></span><br><span class="line"> <span class="attr">Storage Driver:</span> <span class="string">overlay2</span></span><br><span class="line">  <span class="attr">Backing Filesystem:</span> <span class="string">extfs</span></span><br><span class="line">  <span class="attr">Supports d_type:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">Native Overlay Diff:</span> <span class="literal">true</span></span><br><span class="line"> <span class="attr">Logging Driver:</span> <span class="string">json-file</span></span><br><span class="line"> <span class="attr">Cgroup Driver:</span> <span class="string">cgroupfs</span></span><br><span class="line"> <span class="attr">Plugins:</span></span><br><span class="line">  <span class="attr">Volume:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">Network:</span> <span class="string">bridge</span> <span class="string">host</span> <span class="string">ipvlan</span> <span class="string">macvlan</span> <span class="literal">null</span> <span class="string">overlay</span></span><br><span class="line">  <span class="attr">Log:</span> <span class="string">awslogs</span> <span class="string">fluentd</span> <span class="string">gcplogs</span> <span class="string">gelf</span> <span class="string">journald</span> <span class="string">json-file</span> <span class="string">local</span> <span class="string">logentries</span> <span class="string">splunk</span> <span class="string">syslog</span></span><br><span class="line"> <span class="attr">Swarm:</span> <span class="string">inactive</span></span><br><span class="line"> <span class="attr">Runtimes:</span> <span class="string">runc</span></span><br><span class="line"> <span class="attr">Default Runtime:</span> <span class="string">runc</span></span><br><span class="line"> <span class="attr">Init Binary:</span> <span class="string">docker-init</span></span><br><span class="line"> <span class="attr">containerd version:</span> <span class="string">b34a5c8af56e510852c35414db4c1f4fa6172339</span></span><br><span class="line"> <span class="attr">runc version:</span> <span class="string">3e425f80a8c931f88e6d94a8c831b9d5aa481657</span></span><br><span class="line"> <span class="attr">init version:</span> <span class="string">fec3683</span></span><br><span class="line"> <span class="attr">Security Options:</span></span><br><span class="line">  <span class="string">apparmor</span></span><br><span class="line">  <span class="string">seccomp</span></span><br><span class="line">   <span class="attr">Profile:</span> <span class="string">default</span></span><br><span class="line"> <span class="attr">Kernel Version:</span> <span class="number">4.15</span><span class="number">.0</span><span class="number">-1052</span><span class="string">-aws</span></span><br><span class="line"> <span class="attr">Operating System:</span> <span class="string">Ubuntu</span> <span class="number">18.04</span><span class="number">.1</span> <span class="string">LTS</span></span><br><span class="line"> <span class="attr">OSType:</span> <span class="string">linux</span></span><br><span class="line"> <span class="attr">Architecture:</span> <span class="string">x86_64</span></span><br><span class="line"> <span class="attr">CPUs:</span> <span class="number">1</span></span><br><span class="line"> <span class="attr">Total Memory:</span> <span class="number">983.</span><span class="string">9MiB</span></span><br><span class="line"> <span class="attr">Name:</span> <span class="string">sg-02</span></span><br><span class="line"> <span class="attr">ID:</span> <span class="string">B7J5:Y7ZM:Y477:7AS6:WMYI:6NLV:YOMA:W32Y:H4NZ:UQVD:XHDX:Y5EF</span></span><br><span class="line"> <span class="attr">Docker Root Dir:</span> <span class="string">/opt/docker</span></span><br><span class="line"> <span class="attr">Debug Mode:</span> <span class="literal">false</span></span><br><span class="line"> <span class="attr">Username:</span> <span class="string">webpsh</span></span><br><span class="line"> <span class="attr">Registry:</span> <span class="string">https://index.docker.io/v1/</span></span><br><span class="line"> <span class="attr">Labels:</span></span><br><span class="line"> <span class="attr">Experimental:</span> <span class="literal">false</span></span><br><span class="line"> <span class="attr">Insecure Registries:</span></span><br><span class="line">  <span class="number">127.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/8</span></span><br><span class="line"> <span class="attr">Registry Mirrors:</span></span><br><span class="line">  <span class="string">https://registry.k8s.li/</span></span><br><span class="line"> <span class="attr">Live Restore Enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†æ–¹ä¾¿åˆ†æï¼Œæˆ‘å°†å…¶ä»–çš„ docker image å…¨éƒ¨æ¸…ç©ºæ‰ï¼Œåªä¿ç•™ <code>debian:v1</code> å’Œ <code>debian:v2</code> è¿™ä¸¤ä¸ªé•œåƒï¼Œè¿™ä¸¤ä¸ªé•œåƒè¶³å¤Ÿå¸®åŠ©æˆ‘ä»¬ç†è§£å®¹å™¨é•œåƒæ˜¯å¦‚ä½•å­˜æ”¾çš„ï¼Œé•œåƒå¤šäº†å¤šè¯åˆ†æä¸‹é¢å­˜å‚¨ç›®å½•çš„æ—¶å€™å¯èƒ½ä¸å¤ªæ–¹ä¾¿ï¼ˆï¼ï¹ï¼œï¼‰ï¼Œè¿™ä¸¤ä¸ªé•œåƒæ˜¯æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨ Debian çš„ <code>rootfs.tar.xz</code> æ„å»ºå‡ºæ¥çš„åŸºç¡€é•œåƒã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/docker</span><br><span class="line">â•°â”€# docker images</span><br><span class="line">REPOSITORY       TAG         IMAGE ID            CREATED             SIZE</span><br><span class="line">debian           v2          e6e782a57a51        22 hours ago        69.2MB</span><br><span class="line">debian           v1          cfba37fd24f8        22 hours ago        69.2MB</span><br></pre></td></tr></table></figure>
<h3 id="docker-var-lib-docker"><a href="#docker-var-lib-docker" class="headerlink" title="docker (/var/lib/docker)"></a>docker (/var/lib/docker)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/docker</span><br><span class="line">â•°â”€# tree -d -L 1</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ builder</span><br><span class="line">â”œâ”€â”€ buildkit</span><br><span class="line">â”œâ”€â”€ containers</span><br><span class="line">â”œâ”€â”€ image</span><br><span class="line">â”œâ”€â”€ network</span><br><span class="line">â”œâ”€â”€ overlay2</span><br><span class="line">â”œâ”€â”€ plugins</span><br><span class="line">â”œâ”€â”€ runtimes</span><br><span class="line">â”œâ”€â”€ swarm</span><br><span class="line">â”œâ”€â”€ tmp</span><br><span class="line">â”œâ”€â”€ trust</span><br><span class="line">â””â”€â”€ volumes</span><br><span class="line"></span><br><span class="line">12 directories</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®ç›®å½•çš„åå­—æˆ‘ä»¬å¯ä»¥å¤§è‡´æ¨æ–­å‡ºå…³äºå®¹å™¨é•œåƒçš„å­˜å‚¨ï¼Œæˆ‘ä»¬åªå…³å¿ƒ image å’Œ overlay2 è¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹å³å¯ï¼Œå®¹å™¨çš„å…ƒæ•°æ®å­˜æ”¾åœ¨ image ç›®å½•ä¸‹ï¼Œå®¹å™¨çš„ layer æ•°æ®åˆ™å­˜æ”¾åœ¨ overlay2 ç›®å½•ä¸‹ã€‚</p>
<h3 id="var-lib-docker-image"><a href="#var-lib-docker-image" class="headerlink" title="/var/lib/docker/image"></a>/var/lib/docker/image</h3><p>overlay2 ä»£è¡¨ç€æœ¬åœ° docker å­˜å‚¨ä½¿ç”¨çš„æ˜¯ overlay2 è¯¥å­˜å‚¨é©±åŠ¨ï¼Œç›®å‰æœ€æ–°ç‰ˆæœ¬çš„ docker é»˜è®¤ä¼˜å…ˆé‡‡ç”¨ <strong>overlay2</strong> ä½œä¸ºå­˜å‚¨é©±åŠ¨ï¼Œå¯¹äºå·²æ”¯æŒè¯¥é©±åŠ¨çš„ Linux å‘è¡Œç‰ˆï¼Œä¸éœ€è¦ä»»ä½•è¿›è¡Œä»»ä½•é¢å¤–çš„é…ç½®ï¼Œå¯ä½¿ç”¨ lsmod å‘½ä»¤æŸ¥çœ‹å½“å‰ç³»ç»Ÿå†…æ ¸æ˜¯å¦æ”¯æŒ overlay2 ã€‚</p>
<p>å¦å¤–å€¼å¾—ä¸€æçš„æ˜¯<code>devicemapper</code> å­˜å‚¨é©±åŠ¨å·²ç»åœ¨ docker 18.09 ç‰ˆæœ¬ä¸­è¢«åºŸå¼ƒï¼Œdocker å®˜æ–¹æ¨èä½¿ç”¨ <code>overlay2</code> æ›¿ä»£<code>devicemapper</code>ã€‚ï¼ˆä¹‹å‰æˆ‘è€ä¸œå®¶ç”¨çš„ docker 1.13 ç‰ˆæœ¬ï¼Œ<code>devicemapper</code>çš„å­˜å‚¨é©±åŠ¨åœ¨ç”Ÿäº§ç¯å¢ƒç¿»è¿‡è½¦ğŸ˜‚ã€‚æ‰€ä»¥å‘¢ï¼Œéƒ½ 2020 å¹´äº†ï¼Œå½“ä½ ä½¿ç”¨ baidu è¿™ç§åƒåœ¾æœç´ å¼•æ“å»æœç´¢ â€œCentOS å®‰è£… dockerâ€ æ—¶å®ƒä¼šç»™ä½ ä¸€å †åƒåœ¾çš„æ•™ç¨‹ï¼Œå«ä½ å»å®‰è£… <code>device-mapper-persistent-data lvm2</code>ï¼Œå¯¹äºè¿™ç§æŠ„æ¥æŠ„å»çš„åšå®¢å¹³å°ï¼Œç¦»å¾—è¶Šè¿œè¶Šå¥½ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">image</span><br><span class="line">â””â”€â”€ overlay2</span><br><span class="line">    â”œâ”€â”€ distribution</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ diffid-by-digest</span><br><span class="line">    â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">    â”‚Â Â  â”‚Â Â      â”œâ”€â”€ 039b991354af4dcbc534338f687e27643c717bb57e11b87c2e81d50bdd0b2376</span><br><span class="line">    â”‚Â Â  â”‚Â Â      â”œâ”€â”€ 09a4142c5c9dde2fbf35e7a6e6475eba75a8c28540c375c80be7eade4b7cb438</span><br><span class="line">    â”‚Â Â  â””â”€â”€ v2metadata-by-diffid</span><br><span class="line">    â”‚Â Â      â””â”€â”€ sha256</span><br><span class="line">    â”‚Â Â          â”œâ”€â”€ 0683de2821778aa9546bf3d3e6944df779daba1582631b7ea3517bb36f9e4007</span><br><span class="line">    â”‚Â Â          â”œâ”€â”€ 0f7493e3a35bab1679e587b41b353b041dca1e7043be230670969703f28a1d83</span><br><span class="line">    â”œâ”€â”€ imagedb</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ content</span><br><span class="line">    â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">    â”‚Â Â  â”‚Â Â      â”œâ”€â”€ 708bc6af7e5e539bdb59707bbf1053cc2166622f5e1b17666f0ba5829ca6aaea</span><br><span class="line">    â”‚Â Â  â”‚Â Â      â””â”€â”€ f70734b6a266dcb5f44c383274821207885b549b75c8e119404917a61335981a</span><br><span class="line">    â”‚Â Â  â””â”€â”€ metadata</span><br><span class="line">    â”‚Â Â      â””â”€â”€ sha256</span><br><span class="line">    â”œâ”€â”€ layerdb</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ mounts</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ sha256</span><br><span class="line">    â”‚Â Â  â”‚Â Â  â”œâ”€â”€ b9835d6a62886d4e85b65abb120c0ea44ff1b3d116d7a707620785d4664d8c1a</span><br><span class="line">    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cache-id</span><br><span class="line">    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ diff</span><br><span class="line">    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ parent</span><br><span class="line">    â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ size</span><br><span class="line">    â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ tar-split.json.gz</span><br><span class="line">    â”‚Â Â  â”‚Â Â  â””â”€â”€ d9b567b77bcdb9d8944d3654ea9bb5f6f4f7c4d07a264b2e40b1bb09af171dd3</span><br><span class="line">    â”‚Â Â  â”‚Â Â      â”œâ”€â”€ cache-id</span><br><span class="line">    â”‚Â Â  â”‚Â Â      â”œâ”€â”€ diff</span><br><span class="line">    â”‚Â Â  â”‚Â Â      â”œâ”€â”€ parent</span><br><span class="line">    â”‚Â Â  â”‚Â Â      â”œâ”€â”€ size</span><br><span class="line">    â”‚Â Â  â”‚Â Â      â””â”€â”€ tar-split.json.gz</span><br><span class="line">    â”‚Â Â  â””â”€â”€ tmp</span><br><span class="line">    â””â”€â”€ repositories.json</span><br><span class="line">21 directories, 119 files</span><br></pre></td></tr></table></figure>
<ul>
<li><code>repositories.json</code></li>
</ul>
<p>repositories.json å°±æ˜¯å­˜å‚¨é•œåƒå…ƒæ•°æ®ä¿¡æ¯ï¼Œä¸»è¦æ˜¯ image name å’Œ image id çš„å¯¹åº”ï¼Œdigest å’Œ image id çš„å¯¹åº”ã€‚å½“ pull å®Œä¸€ä¸ªé•œåƒçš„æ—¶å€™ docker ä¼šæ›´æ–°è¿™ä¸ªæ–‡ä»¶ã€‚å½“æˆ‘ä»¬ docker run ä¸€ä¸ªå®¹å™¨çš„æ—¶å€™ä¹Ÿç”¨åˆ°è¿™ä¸ªæ–‡ä»¶å»ç´¢å¼•æœ¬åœ°æ˜¯å¦å­˜åœ¨è¯¥é•œåƒï¼Œæ²¡æœ‰é•œåƒçš„è¯å°±è‡ªåŠ¨å» pull è¿™ä¸ªé•œåƒã€‚</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/docker/image/overlay2</span><br><span class="line">â•°â”€# jq "." repositories.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"Repositories"</span>: &#123;</span><br><span class="line">    <span class="attr">"debian"</span>: &#123;</span><br><span class="line">      <span class="attr">"debian:v1"</span>: <span class="string">"sha256:cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d"</span>,</span><br><span class="line">      <span class="attr">"debian:v2"</span>: <span class="string">"sha256:e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"localhost:5000/library/debian"</span>: &#123;</span><br><span class="line">      <span class="attr">"localhost:5000/library/debian:v1"</span>: <span class="string">"sha256:cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d"</span>,</span><br><span class="line">      <span class="attr">"localhost:5000/library/debian:v2"</span>: <span class="string">"sha256:e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df"</span>,</span><br><span class="line">      <span class="attr">"localhost:5000/library/debian@sha256:b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239"</span>: <span class="string">"sha256:cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d"</span>,</span><br><span class="line">      <span class="attr">"localhost:5000/library/debian@sha256:c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11"</span>: <span class="string">"sha256:e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"registry"</span>: &#123;</span><br><span class="line">      <span class="attr">"registry:latest"</span>: <span class="string">"sha256:708bc6af7e5e539bdb59707bbf1053cc2166622f5e1b17666f0ba5829ca6aaea"</span>,</span><br><span class="line">      <span class="attr">"registry@sha256:7d081088e4bfd632a88e3f3bcd9e007ef44a796fddfe3261407a3f9f04abe1e7"</span>: <span class="string">"sha256:708bc6af7e5e539bdb59707bbf1053cc2166622f5e1b17666f0ba5829ca6aaea"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>distribution ç›®å½•ä¸‹</li>
</ul>
<p>å­˜æ”¾ç€ layer çš„ diff_id å’Œ digest çš„å¯¹åº”å…³ç³»</p>
<p>diffid-by-digest :å­˜æ”¾ <code>digest</code> åˆ° <code>diffid</code> çš„å¯¹åº”å…³ç³»</p>
<p>v2metadata-by-diffid : å­˜æ”¾ <code>diffid</code> åˆ° <code>digest</code> çš„å¯¹åº”å…³ç³»</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ distribution</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ diffid-by-digest</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ 039b991354af4dcbc534338f687e27643c717bb57e11b87c2e81d50bdd0b2376</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ 09a4142c5c9dde2fbf35e7a6e6475eba75a8c28540c375c80be7eade4b7cb438</span><br><span class="line">â”‚Â Â  â””â”€â”€ v2metadata-by-diffid</span><br><span class="line">â”‚Â Â      â””â”€â”€ sha256</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ 0683de2821778aa9546bf3d3e6944df779daba1582631b7ea3517bb36f9e4007</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ 0f7493e3a35bab1679e587b41b353b041dca1e7043be230670969703f28a1d83</span><br></pre></td></tr></table></figure>
<ul>
<li>imagedb</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ imagedb</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ content</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ sha256</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ 708bc6af7e5e539bdb59707bbf1053cc2166622f5e1b17666f0ba5829ca6aaea</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ f70734b6a266dcb5f44c383274821207885b549b75c8e119404917a61335981a</span><br><span class="line">â”‚Â Â  â””â”€â”€ metadata</span><br><span class="line">â”‚Â Â      â””â”€â”€ sha256</span><br></pre></td></tr></table></figure>
<ul>
<li>layerdb</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ layerdb</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ mounts</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ sha256</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ b9835d6a62886d4e85b65abb120c0ea44ff1b3d116d7a707620785d4664d8c1a</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cache-id  # docker ä¸‹è½½é•œåƒæ—¶éšæœºç”Ÿæˆçš„ id</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ diff # å­˜æ”¾ layer çš„ diffid</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ parent # æ”¾å½“å‰ layer çš„çˆ¶ layer çš„ diffidï¼Œæœ€åº•å±‚çš„ layer æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ size # è¯¥ layer çš„å¤§å°</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ tar-split.json.gz</span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼štar-split.json.gz æ–‡ä»¶æ˜¯ layer tar åŒ…çš„ split æ–‡ä»¶ï¼Œè®°å½•äº† layer è§£å‹åçš„æ–‡ä»¶åœ¨ tar åŒ…ä¸­çš„ä½ç½®ï¼ˆåç§»é‡ï¼‰ï¼Œé€šè¿‡è¿™ä¸ªæ–‡ä»¶å¯ä»¥è¿˜åŸ layer çš„ tar åŒ…ï¼Œåœ¨ docker save å¯¼å‡º image çš„æ—¶å€™ä¼šç”¨åˆ°ï¼Œç”±æ ¹æ®å®ƒå¯ä»¥å¼€å€’è½¦æŠŠè§£å‹çš„ layer è¿˜åŸå› tar åŒ…ã€‚è¯¦æƒ…å¯å‚è€ƒ <a href="https://github.com/vbatts/tar-split" target="_blank" rel="noopener">tar-split</a></p>
<h3 id="var-lib-docker-overlay2"><a href="#var-lib-docker-overlay2" class="headerlink" title="/var/lib/docker/overlay2"></a>/var/lib/docker/overlay2</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">overlay2</span><br><span class="line">â”œâ”€â”€ 259cf6934509a674b1158f0a6c90c60c133fd11189f98945c7c3a524784509ff</span><br><span class="line">â”‚Â Â  â””â”€â”€ diff</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ dev</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ etc</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ home</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ lib</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ media</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ mnt</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ opt</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ proc</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ root</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ run</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ sbin</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ srv</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ sys</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ tmp</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ usr</span><br><span class="line">â”‚Â Â      â””â”€â”€ var</span><br><span class="line">â”œâ”€â”€ 27f9e9b74a88a269121b4e77330a665d6cca4719cb9a58bfc96a2b88a07af805</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ diff</span><br><span class="line">â”‚Â Â  â””â”€â”€ work</span><br><span class="line">â”œâ”€â”€ a0df3cc902cfbdee180e8bfa399d946f9022529d12dba3bc0b13fb7534120015</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ diff</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ bin</span><br><span class="line">â”‚Â Â  â””â”€â”€ work</span><br><span class="line">â”œâ”€â”€ b2fbebb39522cb6f1f5ecbc22b7bec5e9bc6ecc25ac942d9e26f8f94a028baec</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ diff</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ etc</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ lib</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ usr</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ var</span><br><span class="line">â”‚Â Â  â””â”€â”€ work</span><br><span class="line">â”œâ”€â”€ be8c12f63bebacb3d7d78a09990dce2a5837d86643f674a8fd80e187d8877db9</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ diff</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ etc</span><br><span class="line">â”‚Â Â  â””â”€â”€ work</span><br><span class="line">â”œâ”€â”€ e8f6e78aa1afeb96039c56f652bb6cd4bbd3daad172324c2172bad9b6c0a968d</span><br><span class="line">â”‚Â Â  â””â”€â”€ diff</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ dev</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ etc</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ home</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ lib</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ media</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ mnt</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ proc</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ root</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ run</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ sbin</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ srv</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ sys</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ tmp</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ usr</span><br><span class="line">â”‚Â Â      â””â”€â”€ var</span><br><span class="line">â””â”€â”€ l</span><br><span class="line">    â”œâ”€â”€ 526XCHXRJMZXRIHN4YWJH2QLPY -&gt; ../b2fbebb39522cb6f1f5ecbc22b7bec5e9bc6ecc25ac942d9e26f8f94a028baec/diff</span><br><span class="line">    â”œâ”€â”€ 5RZOXYR35NSGAWTI36CVUIRW7U -&gt; ../be8c12f63bebacb3d7d78a09990dce2a5837d86643f674a8fd80e187d8877db9/diff</span><br><span class="line">    â”œâ”€â”€ LBWRL4ZXGBWOTN5JDCDZVNOY7H -&gt; ../a0df3cc902cfbdee180e8bfa399d946f9022529d12dba3bc0b13fb7534120015/diff</span><br><span class="line">    â”œâ”€â”€ MYRYBGZRI4I76MJWQHN7VLZXLW -&gt; ../27f9e9b74a88a269121b4e77330a665d6cca4719cb9a58bfc96a2b88a07af805/diff</span><br><span class="line">    â”œâ”€â”€ PCIS4FYUJP4X2D4RWB7ETFL6K2 -&gt; ../259cf6934509a674b1158f0a6c90c60c133fd11189f98945c7c3a524784509ff/diff</span><br><span class="line">    â””â”€â”€ XK5IA4BWQ2CIS667J3SXPXGQK5 -&gt; ../e8f6e78aa1afeb96039c56f652bb6cd4bbd3daad172324c2172bad9b6c0a968d/diff</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>/var/lib/docker/overlay2</code> ç›®å½•ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé•œåƒ layer çš„å†…å®¹éƒ½å­˜æ”¾åœ¨ä¸€ä¸ª <code>diff</code> çš„æ–‡ä»¶å¤¹ä¸‹ï¼Œdiff çš„ä¸Šçº§ç›®å½•å°±æ˜¯ä»¥é•œåƒ layer çš„ digest ä¸ºåçš„ç›®å½•ã€‚å…¶ä¸­è¿˜æœ‰ä¸ª <code>l</code> æ–‡ä»¶å¤¹ï¼Œä¸‹é¢æœ‰ä¸€å¨å¨çš„ç¡¬é“¾æ¥æ–‡ä»¶æŒ‡å‘ä¸Šçº§ç›®å½•çš„ layer ç›®å½•ã€‚è¿™ä¸ª l å…¶å®å°±æ˜¯ link çš„ç¼©å†™ï¼Œl ä¸‹çš„æ–‡ä»¶éƒ½æ˜¯ä¸€äº›æ¯” digest æ–‡ä»¶å¤¹åçŸ­ä¸€äº›çš„ï¼Œæ–¹é¢ä¸è‡³äº mount çš„å‚æ•°è¿‡é•¿ã€‚</p>
<h2 id="é•œåƒæ˜¯æ€ä¹ˆæ¬è¿çš„ğŸ¤£"><a href="#é•œåƒæ˜¯æ€ä¹ˆæ¬è¿çš„ğŸ¤£" class="headerlink" title="é•œåƒæ˜¯æ€ä¹ˆæ¬è¿çš„ğŸ¤£"></a>é•œåƒæ˜¯æ€ä¹ˆæ¬è¿çš„ğŸ¤£</h2><p>å½“æˆ‘ä»¬åœ¨æœ¬åœ°æ„å»ºå®Œæˆä¸€ä¸ªé•œåƒä¹‹åï¼Œå¦‚ä½•ä¼ é€’ç»™ä»–äººå‘¢ï¼Ÿè¿™å°±æ¶‰åŠåˆ°é•œåƒæ˜¯æ€ä¹ˆæ¬è¿çš„ä¸€äº›çŸ¥è¯†ï¼Œæ¬è¿é•œåƒå°±åƒæˆ‘ä»¬åœ¨ GitHub ä¸Šæ¬è¿ä»£ç ä¸€æ ·ï¼Œdocker ä¹Ÿæœ‰ç±»ä¼¼äº git clone å’Œ git push çš„æ¬è¿æ–¹å¼ã€‚docker push å°±å’Œæˆ‘ä»¬ä½¿ç”¨ git push ä¸€æ ·ï¼Œå°†æœ¬åœ°çš„é•œåƒæ¨é€åˆ°ä¸€ä¸ªç§°ä¹‹ä¸º registry çš„é•œåƒä»“åº“ï¼Œè¿™ä¸ª registry é•œåƒä»“åº“å°±åƒ GitHub ç”¨æ¥å­˜æ”¾å…¬å…±/ç§æœ‰çš„é•œåƒï¼Œä¸€ä¸ªä¸­å¿ƒåŒ–çš„é•œåƒä»“åº“æ–¹ä¾¿å¤§å®¶æ¥è¿›è¡Œäº¤æµå’Œæ¬è¿é•œåƒã€‚docker pull å°±åƒæˆ‘ä»¬ä½¿ç”¨ git pull ä¸€æ ·ï¼Œå°†è¿œç¨‹çš„é•œåƒæ‹‰æ‹‰å–æœ¬åœ°ã€‚</p>
<h3 id="docker-pull"><a href="#docker-pull" class="headerlink" title="docker pull"></a>docker pull</h3><p>ç†è§£ docker pull ä¸€ä¸ªé•œåƒçš„æµç¨‹æœ€å¥½çš„åŠæ³•æ˜¯æŸ¥çœ‹ OCI registry è§„èŒƒä¸­çš„è¿™æ®µæ–‡æ¡£ <a href="https://github.com/opencontainers/distribution-spec/blob/master/spec.md#pulling-an-image" target="_blank" rel="noopener">pulling-an-image</a> ï¼Œåœ¨è¿™é‡Œæˆ‘ç»“åˆå¤§ä½¬çš„åšå®¢ç®€å•æ¢³ç†ä¸€ä¸‹ pull ä¸€ä¸ªé•œåƒçš„å¤§è‡´æµç¨‹ã€‚ä¸‹é¢è¿™å¼ å›¾æ˜¯ä» <a href="https://github.com/helios741/myblog/blob/new/learn_go/src/2019/20191206_docker_disk_storage/README.md" target="_blank" rel="noopener">æµ…è°ˆdockerä¸­é•œåƒå’Œå®¹å™¨åœ¨æœ¬åœ°çš„å­˜å‚¨)</a> å€Ÿæ¥çš„ğŸ˜‚</p>
<p><img src="https://user-images.githubusercontent.com/12036324/70367494-646d2380-18db-11ea-992a-d2bca4cbfeb0.png" alt=""></p>
<p>docker pull å°±å’Œæˆ‘ä»¬ä½¿ç”¨ git clone ä¸€æ ·æ•ˆæœï¼Œå°†è¿œç¨‹çš„é•œåƒä»“åº“æ‹‰å–åˆ°æœ¬åœ°æ¥ç»™å®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨ï¼Œç»“åˆä¸Šå›¾å¤§è‡´çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ­¥åº”è¯¥æ˜¯ä½¿ç”¨<code>~/.docker/config.json</code> ä¸­çš„ auth è®¤è¯ä¿¡æ¯åœ¨ registry é‚£é‡Œè¿›è¡Œé‰´æƒæˆæƒï¼Œæ‹¿åˆ°ä¸€ä¸ª tokenï¼Œåé¢çš„æ‰€æœ‰çš„ HTTP è¯·æ±‚ä¸­éƒ½è¦åŒ…å«ç€è¯¥ token æ‰èƒ½æœ‰æƒé™è¿›è¡Œæ“ä½œã€‚</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /home/ubuntu</span><br><span class="line">â•°â”€# cat ~/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">        <span class="attr">"auths"</span>: &#123;</span><br><span class="line">                <span class="attr">"https://registry.k8s.li/v2/"</span>: &#123;</span><br><span class="line">                        <span class="attr">"auth"</span>: <span class="string">"d2VicH855828WM7bSVsslJFpmQE43Sw=="</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"HttpHeaders"</span>: &#123;</span><br><span class="line">                <span class="attr">"User-Agent"</span>: <span class="string">"Docker-Client/19.03.5 (linux)"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"experimental"</span>: <span class="string">"enabled"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>dockerd å®ˆæŠ¤è¿›ç¨‹è§£æ docker å®¢æˆ·ç«¯å‚æ•°ï¼Œç”±é•œåƒå + tag å‘ registry è¯·æ±‚ Manifest æ–‡ä»¶ï¼ŒHTTP è¯·æ±‚ä¸º<code>GET /v2/&lt;name&gt;/manifests/&lt;reference&gt;</code>ã€‚registry ä¸­ä¸€ä¸ªé•œåƒæœ‰å¤šä¸ª tag æˆ–è€…å¤šä¸ªå¤„ç†å™¨ä½“ç³»æ¶æ„çš„é•œåƒï¼Œåˆ™æ ¹æ®è¿™ä¸ª tag æ¥è¿”å›ç»™å®¢æˆ·ç«¯ä¸ä¹‹å¯¹åº”çš„  manifest æ–‡ä»¶ï¼›</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET /v2/&lt;name&gt;/manifests/&lt;reference&gt;</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">"annotations"</span>: &#123;</span><br><span class="line">      <span class="attr">"com.example.key1"</span>: <span class="string">"value1"</span>,</span><br><span class="line">      <span class="attr">"com.example.key2"</span>: <span class="string">"value2"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"config"</span>: &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.oci.image.config.v1+json"</span>,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">452</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"layers"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"digest"</span>: <span class="string">"sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401"</span>,</span><br><span class="line">         <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.oci.image.layer.v1.tar+gzip"</span>,</span><br><span class="line">         <span class="attr">"size"</span>: <span class="number">78343</span></span><br><span class="line">      &#125;</span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"schemaVersion"</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>dockerd å¾—åˆ° <code>manifest</code> åï¼Œè¯»å–é‡Œé¢ image config æ–‡ä»¶çš„ <code>digest</code>ï¼Œè¿™ä¸ª sha256 å€¼å°±æ˜¯ image çš„ <code>ID</code></li>
<li>æ ¹æ® <code>ID</code> åœ¨æœ¬åœ°çš„ <code>repositories.json</code>ä¸­æŸ¥æ‰¾æ‰¾æœ‰æ²¡æœ‰å­˜åœ¨åŒæ · <code>ID</code> çš„ imageï¼Œæœ‰çš„è¯å°±ä¸ç”¨ä¸‹è½½äº†</li>
<li>å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆä¼šç»™ registry æœåŠ¡å™¨å‘è¯·æ±‚æ‹¿åˆ°  image config æ–‡ä»¶</li>
<li>æ ¹æ® image config æ–‡ä»¶ä¸­çš„ <code>diff_ids</code>åœ¨æœ¬åœ°æ‰¾å¯¹åº”çš„ layer æ˜¯å¦å­˜åœ¨</li>
<li>å¦‚æœ layer ä¸å­˜åœ¨ï¼Œåˆ™æ ¹æ® <code>manifest</code> é‡Œé¢ layer çš„ <code>sha256</code> å’Œ <code>media type</code> å»æœåŠ¡å™¨æ‹¿ç›¸åº”çš„ layerï¼ˆç›¸å½“å»æ‹¿å‹ç¼©æ ¼å¼çš„åŒ…ï¼‰</li>
<li>dockerd å®ˆæŠ¤è¿›ç¨‹å¹¶è¡Œä¸‹è½½å„ layer ï¼ŒHTTP è¯·æ±‚ä¸º<code>GET /v2/&lt;name&gt;/blobs/&lt;digest&gt;</code>ã€‚ </li>
<li>æ‹¿åˆ°åè¿›è¡Œè§£å‹ï¼Œå¹¶æ£€æŸ¥è§£å‹(gzip -d)å tar åŒ…çš„ sha256 æ˜¯å¦å’Œ image config ä¸­çš„ <code>diff_id</code> ç›¸åŒï¼Œä¸ç›¸åŒå°±ç¿»è½¦äº†</li>
<li>ç­‰æ‰€æœ‰çš„ layer éƒ½ä¸‹è½½å®Œæˆåï¼Œæ•´ä¸ª image çš„ layer å°±ä¸‹è½½å®Œæˆï¼Œæ¥ç€å¼€å§‹è¿›è¡Œè§£å‹(tar -xf) layer çš„ tar åŒ…ã€‚</li>
<li>dockerd èµ·ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ <code>docker-untar</code> æ¥ gzip è§£å‹ç¼©å·²ç»ä¸‹è½½å®Œæˆçš„ layer æ–‡ä»¶ï¼›å¯¹äºæœ‰äº›æ¯”è¾ƒå¤§çš„é•œåƒï¼ˆæ¯”å¦‚å‡ å GB çš„é•œåƒï¼‰ï¼Œå¾€å¾€é•œåƒçš„ layer å·²ç»ä¸‹è½½å®Œæˆäº†ï¼Œä½†è¿˜æ²¡æœ‰è§£å‹å®ŒğŸ˜‚ã€‚</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-untar /var/lib/docker/overlay2/a076db6567c7306f3cdab6040cd7d083ef6a39d125171353eedbb8bde7f203b4/diff</span><br></pre></td></tr></table></figure>
<ul>
<li>éªŒè¯ image config ä¸­çš„ RootFS.DiffIDs æ˜¯å¦ä¸ä¸‹è½½ï¼ˆè§£å‹åï¼‰hash ç›¸åŒï¼›</li>
</ul>
<h3 id="docker-push"><a href="#docker-push" class="headerlink" title="docker push"></a>docker push</h3><p>push æ¨é€ä¸€ä¸ªé•œåƒåˆ°è¿œç¨‹çš„ registry æµç¨‹æ°å¥½å’Œ pull æ‹‰å–é•œåƒåˆ°æœ¬åœ°çš„æµç¨‹ç›¸åã€‚æˆ‘ä»¬ pull ä¸€ä¸ªé•œåƒçš„æ—¶å€™å¾€å¾€éœ€è¦å…ˆè·å–åŒ…å«ç€é•œåƒ layer ä¿¡æ¯çš„ Manifest æ–‡ä»¶ï¼Œç„¶åæ ¹æ®è¿™ä¸ªæ–‡ä»¶ä¸­çš„ layer ä¿¡æ¯å– pull ç›¸åº”çš„ layerã€‚push ä¸€ä¸ªé•œåƒï¼Œéœ€è¦å…ˆå°†é•œåƒçš„å„ä¸ª layer æ¨é€åˆ° registry ï¼Œå½“æ‰€æœ‰çš„é•œåƒ layer ä¸Šä¼ å®Œæ¯•ä¹‹åæœ€åå† push Image Manifest åˆ° registryã€‚å¤§ä½“çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>  All layer uploads use two steps to manage the upload process. The first step starts the upload in the registry service, returning a url to carry out the second step. The second step uses the upload url to transfer the actual data. Uploads are started with a POST request which returns a url that can be used to push data and check upload status.</p>
</blockquote>
<ul>
<li><p>ç¬¬ä¸€æ­¥å’Œ pull ä¸€ä¸ªé•œåƒä¸€æ ·ä¹Ÿæ˜¯è¿›è¡Œé‰´æƒæˆæƒï¼Œæ‹¿åˆ°ä¸€ä¸ª tokenï¼›</p>
</li>
<li><p>å‘ registry å‘é€ <code>POST /v2/&lt;name&gt;/blobs/uploads/</code>è¯·æ±‚ï¼Œregistry è¿”å›ä¸€ä¸ªä¸Šä¼ é•œåƒ layer æ—¶è¦åº”åˆ°çš„ URLï¼›</p>
</li>
<li><p>å®¢æˆ·ç«¯é€šè¿‡ <code>HEAD /v2/&lt;name&gt;/blobs/&lt;digest&gt;</code> è¯·æ±‚æ£€æŸ¥ registry ä¸­æ˜¯å¦å·²ç»å­˜åœ¨é•œåƒçš„ layerã€‚</p>
</li>
<li><p>å®¢æˆ·ç«¯é€šè¿‡URL ä½¿ç”¨ POST æ–¹æ³•æ¥å®æ—¶ä¸Šä¼  layer æ•°æ®ï¼Œä¸Šä¼ é•œåƒ layer åˆ†ä¸º <code>Monolithic Upload</code> ï¼ˆæ•´ä½“ä¸Šä¼ ï¼‰å’Œ<code>Chunked Upload</code>ï¼ˆåˆ†å—ä¸Šä¼ ï¼‰ä¸¤ç§æ–¹å¼ã€‚</p>
<ul>
<li>Monolithic Upload </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT /v2/&lt;name&gt;/blobs/uploads/&lt;session_id&gt;?digest=&lt;digest&gt;</span><br><span class="line"><span class="attribute">Content-Length</span>: &lt;size of layer&gt;</span><br><span class="line"><span class="attribute">Content-Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;Layer Binary Data&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>Chunked Upload</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PATCH /v2/&lt;name&gt;/blobs/uploads/&lt;session_id&gt;</span><br><span class="line"><span class="attribute">Content-Length</span>: &lt;size of chunk&gt;</span><br><span class="line"><span class="attribute">Content-Range</span>: &lt;start of range&gt;-&lt;end of range&gt;</span><br><span class="line"><span class="attribute">Content-Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;Layer Chunk Binary Data&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>é•œåƒçš„ layer ä¸Šä¼ å®Œæˆä¹‹åï¼Œå®¢æˆ·ç«¯éœ€è¦å‘ registry å‘é€ä¸€ä¸ª PUT HTTP è¯·æ±‚å‘ŠçŸ¥è¯¥ layer å·²ç»ä¸Šä¼ å®Œæ¯•ã€‚</p>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /v2/&lt;name&gt;/blobs/uploads/&lt;session_id&gt;?digest=&lt;digest&gt;</span><br><span class="line"><span class="attribute">Content-Length</span>: &lt;size of chunk&gt;</span><br><span class="line"><span class="attribute">Content-Range</span>: &lt;start of range&gt;-&lt;end of range&gt;</span><br><span class="line"><span class="attribute">Content-Type</span>: application/octet-stream</span><br><span class="line"></span><br><span class="line">&lt;Last Layer Chunk Binary Data&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>æœ€åå½“æ‰€æœ‰çš„ layer ä¸Šä¼ å®Œä¹‹åï¼Œå®¢æˆ·ç«¯å†å°† manifest æ¨é€ä¸Šå»å°±å®Œäº‹å„¿äº†ã€‚</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PUT /v2/&lt;name&gt;/manifests/&lt;reference&gt;</span><br><span class="line">Content-Type: &lt;manifest media type&gt;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">"annotations"</span>: &#123;</span><br><span class="line">      <span class="attr">"com.example.key1"</span>: <span class="string">"value1"</span>,</span><br><span class="line">      <span class="attr">"com.example.key2"</span>: <span class="string">"value2"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"config"</span>: &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.oci.image.config.v1+json"</span>,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">452</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"layers"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"digest"</span>: <span class="string">"sha256:6f4e69a5ff18d92e7315e3ee31c62165ebf25bfa05cad05c0d09d8f412dae401"</span>,</span><br><span class="line">         <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.oci.image.layer.v1.tar+gzip"</span>,</span><br><span class="line">         <span class="attr">"size"</span>: <span class="number">78343</span></span><br><span class="line">      &#125;</span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"schemaVersion"</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Python-docker-drag"><a href="#Python-docker-drag" class="headerlink" title="Python docker-drag"></a>Python <a href="https://github.com/NotGlop/docker-drag" target="_blank" rel="noopener">docker-drag</a></h3><p>è¿™æ˜¯ä¸€ä¸ªå¾ˆç®€å•ç²—æš´çš„ Python è„šæœ¬ï¼Œä½¿ç”¨ request åº“è¯·æ±‚ registry API æ¥ä»é•œåƒä»“åº“ä¸­æ‹‰å–é•œåƒï¼Œå¹¶ä¿å­˜ä¸ºä¸€ä¸ª tar åŒ…ï¼Œæ‹‰å®Œä¹‹åä½¿ç”¨ docker load åŠ è½½ä¸€ä¸‹å°±èƒ½é£Ÿç”¨å•¦ã€‚è¯¥ python è„šæœ¬ç®€å•åˆ°å»æ‰ç©ºè¡Œå’Œæ³¨é‡Šä¸åˆ° 200 è¡Œï¼Œå¦‚æœæŠŠè¿™ä¸ªè„šæœ¬æºç è¯»ä¸€éçš„è¯å°±èƒ½å¤§æ¦‚çŸ¥é“ docker pull å’Œ skopeo copy çš„ä¸€äº›åŸç†ï¼Œä»–ä»¬éƒ½æ˜¯å»è°ƒç”¨ registry çš„ API ï¼Œæ‰€ä»¥è¿˜æ˜¯æ¨èå»è¯»ä¸€ä¸‹è¿™ä¸ªå®ƒçš„æºç ã€‚</p>
<p>é£Ÿç”¨èµ·æ¥ä¹Ÿå¾ˆç®€å•ç›´æ¥ <code>python3 docker_pull.py [image name]</code>ï¼Œè²Œä¼¼åªèƒ½æ‹‰å– docker.io ä¸Šçš„é•œåƒã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /home/ubuntu</span><br><span class="line">â•°â”€# wget https://raw.githubusercontent.com/NotGlop/docker-drag/master/docker_pull.py</span><br><span class="line">â•­â”€root@sg-02 /home/ubuntu</span><br><span class="line">â•°â”€# python3 docker_pull.py nginx</span><br><span class="line">Creating image structure in: tmp_nginx_latest</span><br><span class="line">afb6ec6fdc1c: Pull complete [27098756]</span><br><span class="line">dd3ac8106a0b: Pull complete [26210578]                                       ]</span><br><span class="line">8de28bdda69b: Pull complete [538]</span><br><span class="line">a2c431ac2669: Pull complete [900]</span><br><span class="line">e070d03fd1b5: Pull complete [669]</span><br><span class="line">Docker image pulled: library_nginx.tar</span><br><span class="line">â•­â”€root@sg-02 /home/ubuntu</span><br><span class="line">â•°â”€# docker load -i library_nginx.tar</span><br><span class="line">ffc9b21953f4: Loading layer [==================================================&gt;]  72.49MB/72.49MB</span><br><span class="line">d9c0b16c8d5b: Loading layer [==================================================&gt;]  63.81MB/63.81MB</span><br><span class="line">8c7fd6263c1f: Loading layer [==================================================&gt;]  3.072kB/3.072kB</span><br><span class="line">077ae58ac205: Loading layer [==================================================&gt;]  4.096kB/4.096kB</span><br><span class="line">787328500ad5: Loading layer [==================================================&gt;]  3.584kB/3.584kB</span><br><span class="line">Loaded image: nginx:latest</span><br></pre></td></tr></table></figure>
<h3 id="skopeo"><a href="#skopeo" class="headerlink" title="skopeo"></a>skopeo</h3><p>è¿™ä¸ªå·¥å…·æ˜¯çº¢å¸½å­å®¶çš„ï¼Œæ˜¯ Podmanã€Skopeo å’Œ Buildah ï¼ˆç®€ç§° PSB ï¼‰ä¸‹ä¸€ä»£å®¹å™¨æ–°æ¶æ„ä¸­çš„ä¸€å‘˜ï¼Œä¸è¿‡æœ¨å­è§‰ç€ Podman æƒ³è¦å–ä»£ docker å’Œ containerd å®¹å™¨è¿è¡Œæ—¶è¿˜æœ‰å¾ˆé•¿çš„è·¯è¦èµ°ï¼Œè™½ç„¶å®ƒç¬¦åˆ OCI è§„èŒƒï¼Œä½†å¯¹äºä¼ä¸šæ¥è®²ï¼Œæ›¿æ¢çš„æˆæœ¬å¹¶ä¸å€¼å¾—ä»–ä»¬å»æ¢åˆ° PSB ä¸Šå»ã€‚</p>
<p>å…¶ä¸­çš„ skopeo è¿™ä¸ªé•œåƒæ¬è¿å·¥å…·ç®€ç›´æ˜¯ä¸ªç¥å™¨ï¼Œå°¤å…¶æ˜¯åœ¨ CI/CD æµæ°´çº¿ä¸­æ¬è¿ä¸¤ä¸ªé•œåƒä»“åº“é‡Œçš„é•œåƒç®€ç›´çˆ½çš„ä¸å¾—äº†ã€‚æˆ‘å…¥èŒæ–°å…¬å¸ååšçš„ä¸€ä¸ªå·¥ä½œå°±æ˜¯ä¼˜åŒ–æˆ‘ä»¬çš„ Jenkins æµæ°´çº¿ä¸­åŒæ­¥ä¸¤ä¸ªé•œåƒä»“åº“çš„è¿‡ç¨‹ï¼Œä½¿ç”¨ äº†skopeo æ›¿ä»£ docker æ¥åŒæ­¥ä¸¤ä¸ªé•œåƒä»“åº“ä¸­çš„é•œåƒï¼Œå°†åŸæ¥éœ€è¦ 2h å°æ—¶ç¼©çŸ­åˆ°äº† 25min ğŸ˜€ã€‚</p>
<p>å…³äºè¿™ä¸ªå·¥å…·çš„è¯¦ç»†ä½¿ç”¨æ¨èå¤§å®¶å»è¯»ä¸€ä¸‹æˆ‘ä¹‹å‰å†™çš„ä¸€ç¯‡åšå®¢ <a href="https://blog.k8s.li/skopeo.html">é•œåƒæ¬è¿å·¥ skopeo åˆä½“éªŒ</a> ã€‚åœ¨è¿™é‡Œåªè®²ä¸¤ä¸ªæœ¨å­æœ€å¸¸ç”¨çš„åŠŸèƒ½ã€‚</p>
<h4 id="skopeo-copy"><a href="#skopeo-copy" class="headerlink" title="skopeo copy"></a>skopeo copy</h4><p>ä½¿ç”¨ skopeo copy ä¸¤ä¸ª registry ä¸­çš„é•œåƒæ—¶ï¼Œskopeo è¯·æ±‚ä¸¤ä¸ª registry API ç›´æ¥ copy <code>original blob</code> åˆ°å¦ä¸€ä¸ª registry ï¼Œè¿™æ ·å…å»äº†åƒ docker pull â€“&gt; docker tag â€“&gt; docker push é‚£æ · pull é•œåƒå¯¹é•œåƒè¿›è¡Œè§£å‹ç¼©ï¼Œpush é•œåƒè¿›è¡Œå‹ç¼©ã€‚å°¤å…¶æ˜¯åœ¨æ¬è¿ä¸€äº›è¾ƒå¤§çš„é•œåƒï¼ˆå‡ GB æˆ–è€…å‡ å GBçš„é•œåƒï¼Œæ¯”å¦‚ <code>nvidia/cuda</code> ï¼‰ï¼Œä½¿ç”¨ skopeo copy çš„åŠ é€Ÿæ•ˆæœååˆ†æ˜æ˜¾ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">DEBU[0000] Detected compression format gzip</span><br><span class="line">DEBU[0000] Using original blob without modification</span><br><span class="line"></span><br><span class="line">Getting image source signatures</span><br><span class="line">Copying blob 09a9f6a07669 done</span><br><span class="line">Copying blob f8cdeb3c6c18 done</span><br><span class="line">Copying blob 22c4d5853f25 done</span><br><span class="line">Copying blob 76abc3f50d9b done</span><br><span class="line">Copying blob 3386b7c9ccd4 done</span><br><span class="line">Copying blob b9207193f1af [==============================&gt;-------] 224.2MiB / 271.2MiB</span><br><span class="line">Copying blob 2f32d819e6ce done</span><br><span class="line">Copying blob 5dbc3047e646 done</span><br><span class="line">Copying blob f8dfcc3265c3 [==================&gt;-------------------] 437.1MiB / 864.3MiB</span><br><span class="line">Copying blob 13d3556105d1 done</span><br><span class="line">Copying blob f9b7fa6a027e [=========================&gt;------------] 84.0MiB / 124.3MiB</span><br><span class="line">Copying blob a1a0f6abe73b [====================&gt;-----------------] 417.9MiB / 749.1MiB</span><br><span class="line">Copying blob bcc9947fc8a4 done</span><br><span class="line">Copying blob 9563b2824fef done</span><br><span class="line">Copying blob a1b8faa0044b [===&gt;----------------------------------] 88.0MiB / 830.1MiB</span><br><span class="line">Copying blob 9917e218edfd [===============&gt;----------------------] 348.6MiB / 803.6MiB</span><br><span class="line">Copying blob 776b9ff2f788 done</span><br><span class="line">Copying config d0c3cfd730 done</span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br></pre></td></tr></table></figure>
<h4 id="skopeo-inspect"><a href="#skopeo-inspect" class="headerlink" title="skopeo inspect"></a>skopeo inspect</h4><p>ç”¨ skopeo inspect å‘½ä»¤å¯ä»¥å¾ˆæ–¹æ–¹ä¾¿åœ°é€šè¿‡ registry çš„ API æ¥æŸ¥çœ‹é•œåƒçš„ manifest æ–‡ä»¶ï¼Œä»¥å‰æˆ‘éƒ½æ˜¯ç”¨ curl å‘½ä»¤çš„ï¼Œè¦ token è¿˜è¦åŠ ä¸€å †å‚æ•°ï¼Œæ‰€ä»¥æ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥åæ¥å°±ç”¨ä¸Šäº†  skopeo inspectğŸ˜€ã€‚</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@deploy:/root # skopeo inspect docker://index.docker.io/webpsh/webps:latest --raw</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">"schemaVersion"</span>: <span class="number">2</span>,</span><br><span class="line">   <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">   <span class="attr">"config"</span>: &#123;</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.container.image.v1+json"</span>,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">2534</span>,</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:30d9679b0b1ca7e56096eca0cdb7a6eedc29b63968f25156ef60dec27bc7d206"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"layers"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span>,</span><br><span class="line">         <span class="attr">"size"</span>: <span class="number">2813316</span>,</span><br><span class="line">         <span class="attr">"digest"</span>: <span class="string">"sha256:cbdbe7a5bc2a134ca8ec91be58565ec07d037386d1f1d8385412d224deafca08"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span>,</span><br><span class="line">         <span class="attr">"size"</span>: <span class="number">8088920</span>,</span><br><span class="line">         <span class="attr">"digest"</span>: <span class="string">"sha256:54335262c2ed2d4155e62b45b187a1394fbb6f39e0a4a171ab8ce0c93789e6b0"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span>,</span><br><span class="line">         <span class="attr">"size"</span>: <span class="number">262</span>,</span><br><span class="line">         <span class="attr">"digest"</span>: <span class="string">"sha256:31555b34852eddc7c01f26fa9c0e5e577e36b4e7ccf1b10bec977eb4593a376b"</span></span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="é•œåƒæ˜¯æ€ä¹ˆå­˜æ”¾çš„-äºŒ-registry-å­˜å‚¨ğŸ™„"><a href="#é•œåƒæ˜¯æ€ä¹ˆå­˜æ”¾çš„-äºŒ-registry-å­˜å‚¨ğŸ™„" class="headerlink" title="é•œåƒæ˜¯æ€ä¹ˆå­˜æ”¾çš„ (äºŒ) registry å­˜å‚¨ğŸ™„"></a>é•œåƒæ˜¯æ€ä¹ˆå­˜æ”¾çš„ (äºŒ) registry å­˜å‚¨ğŸ™„</h2><p>æ–‡ç« çš„å¼€å¤´æˆ‘ä»¬æåˆ°è¿‡ OCI è§„èŒƒä¸­çš„é•œåƒä»“åº“è§„èŒƒ <a href="https://github.com/opencontainers/distribution-spec" target="_blank" rel="noopener">distribution-spec</a>ï¼Œè¯¥è§„èŒƒå°±å®šä¹‰ç€å®¹å™¨é•œåƒå¦‚ä½•å­˜å‚¨åœ¨è¿œç«¯ï¼ˆå³ registryï¼‰ä¸Šã€‚æˆ‘ä»¬å¯ä»¥æŠŠ registry çœ‹ä½œé•œåƒçš„ä»“åº“ï¼Œä½¿ç”¨è¯¥è§„èŒƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬æŠŠè¿™äº›é•œåƒæŒ‰ç…§çº¦å®šä¿—æˆçš„æ ¼å¼æ¥å­˜æ”¾ï¼Œç›®å‰å®ç°è¯¥è§„èŒƒçš„ registry å°± docker å®¶çš„ registry ä½¿ç”¨çš„å¤šä¸€äº›ã€‚å…¶ä»–çš„ registry æ¯”å¦‚ harbor ï¼Œquay.io ä½¿ç”¨çš„ä¹Ÿæ¯”è¾ƒå¤šã€‚</p>
<h3 id="registry-registry-docker-v2"><a href="#registry-registry-docker-v2" class="headerlink" title="registry (/registry/docker/v2)"></a>registry (/registry/docker/v2)</h3><p>æƒ³è¦åˆ†æä¸€ä¸‹é•œåƒæ˜¯å¦‚ä½•å­˜æ”¾åœ¨ registry ä¸Šçš„ï¼Œæˆ‘ä»¬åœ¨æœ¬åœ°ä½¿ç”¨ docker run æ¥èµ· registry çš„å®¹å™¨å³å¯ï¼Œæˆ‘ä»¬ä»…ä»…æ˜¯æ¥åˆ†æ registry ä¸­é•œåƒæ—¶å¦‚ä½•å­˜å‚¨çš„ï¼Œè¿™ç§åœºæ™¯ä¸‹ä¸å¤ªé€‚åˆç”¨ harbor è¿™ç§é‡é‡çº§çš„ registry ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /home/ubuntu</span><br><span class="line">â•°â”€# docker run -d --name registry -p 5000:5000 -v /var/lib/registry:/var/lib/registry registry</span><br><span class="line">335ea763a2fa4508ebf3ec6f8b11f3b620a11bdcaa0ab43176b781427e0beee6</span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨å®Œ registry å®¹å™¨ä¹‹åæˆ‘ä»¬ç»™ä¹‹å‰å·²ç»æ„å»ºå¥½çš„é•œåƒé‡æ–°æ‰“ä¸Šæ”¹ registry çš„ tag æ–¹ä¾¿åç»­ push åˆ° registry ä¸Šã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 ~/buster/slim</span><br><span class="line">â•°â”€# docker tag debian:v1  localhost:5000/library/debian:v1</span><br><span class="line">â•­â”€root@sg-02 ~/buster/slim</span><br><span class="line">â•°â”€# ^v1^v2</span><br><span class="line">â•­â”€root@sg-02 ~/buster/slim</span><br><span class="line">â•°â”€# docker tag debian:v2  localhost:5000/library/debian:v2</span><br><span class="line">â•­â”€root@sg-02 ~/buster/slim</span><br><span class="line">â•°â”€# docker images</span><br><span class="line">REPOSITORY                      TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">debian                          v2                  e6e782a57a51        5 minutes ago       69.2MB</span><br><span class="line">localhost:5000/library/debian   v2                  e6e782a57a51        5 minutes ago       69.2MB</span><br><span class="line">debian                          v1                  cfba37fd24f8        9 minutes ago       69.2MB</span><br><span class="line">localhost:5000/library/debian   v1                  cfba37fd24f8        9 minutes ago       69.2MB</span><br><span class="line">â•­â”€root@sg-02 ~/buster/slim</span><br><span class="line">â•°â”€# docker push localhost:5000/library/debian:v1</span><br><span class="line">The push refers to repository [localhost:5000/library/debian]</span><br><span class="line">d1b85e6186f6: Pushed</span><br><span class="line">v1: digest: sha256:b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239 size: 529</span><br><span class="line">â•­â”€root@sg-02 ~/buster/slim</span><br><span class="line">â•°â”€# docker push localhost:5000/library/debian:v2</span><br><span class="line">The push refers to repository [localhost:5000/library/debian]</span><br><span class="line">d1b85e6186f6: Layer already exists</span><br><span class="line">v2: digest: sha256:c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11 size: 529</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬åœ¨æœ¬åœ°å¯åŠ¨ä¸€ä¸ª registry å®¹å™¨ä¹‹åï¼Œå®¹å™¨å†…é»˜è®¤çš„å­˜å‚¨ä½ç½®ä¸º <code>/var/lib/registry</code> ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å¯åŠ¨çš„æ—¶å€™åŠ äº†å‚æ•° <code>-v /var/lib/registry:/var/lib/registry</code> å°†æœ¬æœºçš„è·¯å¾„æŒ‚è½½åˆ°å®¹å™¨å†…ã€‚è¿›å…¥è¿™é‡Œè·¯å¾„æˆ‘ä»¬ä½¿ç”¨ tree å‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç›®å½•çš„å­˜å‚¨ç»“æ„ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2</span><br><span class="line">â•°â”€# tree -h</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ [4.0K]  blobs</span><br><span class="line">â”‚Â Â  â””â”€â”€ [4.0K]  sha256</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ [4.0K]  aa</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ [4.0K]  aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ [ 26M]  data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ [4.0K]  b9</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ [4.0K]  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ [ 529]  data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ [4.0K]  c8</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ [4.0K]  c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ [ 529]  data</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ [4.0K]  cf</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ [4.0K]  cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ [1.4K]  data</span><br><span class="line">â”‚Â Â      â””â”€â”€ [4.0K]  e6</span><br><span class="line">â”‚Â Â          â””â”€â”€ [4.0K]  e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df</span><br><span class="line">â”‚Â Â              â””â”€â”€ [1.4K]  data</span><br><span class="line">â””â”€â”€ [4.0K]  repositories</span><br><span class="line">    â””â”€â”€ [4.0K]  library</span><br><span class="line">        â””â”€â”€ [4.0K]  debian</span><br><span class="line">            â”œâ”€â”€ [4.0K]  _layers</span><br><span class="line">            â”‚Â Â  â””â”€â”€ [4.0K]  sha256</span><br><span class="line">            â”‚Â Â      â”œâ”€â”€ [4.0K]  aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb</span><br><span class="line">            â”‚Â Â      â”‚Â Â  â””â”€â”€ [  71]  link</span><br><span class="line">            â”‚Â Â      â”œâ”€â”€ [4.0K]  cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d</span><br><span class="line">            â”‚Â Â      â”‚Â Â  â””â”€â”€ [  71]  link</span><br><span class="line">            â”‚Â Â      â””â”€â”€ [4.0K]  e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df</span><br><span class="line">            â”‚Â Â          â””â”€â”€ [  71]  link</span><br><span class="line">            â”œâ”€â”€ [4.0K]  _manifests</span><br><span class="line">            â”‚Â Â  â”œâ”€â”€ [4.0K]  revisions</span><br><span class="line">            â”‚Â Â  â”‚Â Â  â””â”€â”€ [4.0K]  sha256</span><br><span class="line">            â”‚Â Â  â”‚Â Â      â”œâ”€â”€ [4.0K]  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239</span><br><span class="line">            â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ [  71]  link</span><br><span class="line">            â”‚Â Â  â”‚Â Â      â””â”€â”€ [4.0K]  c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11</span><br><span class="line">            â”‚Â Â  â”‚Â Â          â””â”€â”€ [  71]  link</span><br><span class="line">            â”‚Â Â  â””â”€â”€ [4.0K]  tags</span><br><span class="line">            â”‚Â Â      â”œâ”€â”€ [4.0K]  v1</span><br><span class="line">            â”‚Â Â      â”‚Â Â  â”œâ”€â”€ [4.0K]  current</span><br><span class="line">            â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ [  71]  link</span><br><span class="line">            â”‚Â Â      â”‚Â Â  â””â”€â”€ [4.0K]  index</span><br><span class="line">            â”‚Â Â      â”‚Â Â      â””â”€â”€ [4.0K]  sha256</span><br><span class="line">            â”‚Â Â      â”‚Â Â          â””â”€â”€ [4.0K]  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239</span><br><span class="line">            â”‚Â Â      â”‚Â Â              â””â”€â”€ [  71]  link</span><br><span class="line">            â”‚Â Â      â””â”€â”€ [4.0K]  v2</span><br><span class="line">            â”‚Â Â          â”œâ”€â”€ [4.0K]  current</span><br><span class="line">            â”‚Â Â          â”‚Â Â  â””â”€â”€ [  71]  link</span><br><span class="line">            â”‚Â Â          â””â”€â”€ [4.0K]  index</span><br><span class="line">            â”‚Â Â              â””â”€â”€ [4.0K]  sha256</span><br><span class="line">            â”‚Â Â                  â””â”€â”€ [4.0K]  c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11</span><br><span class="line">            â”‚Â Â                      â””â”€â”€ [  71]  link</span><br><span class="line">            â””â”€â”€ [4.0K]  _uploads</span><br><span class="line"></span><br><span class="line">37 directories, 14 files</span><br></pre></td></tr></table></figure>
<p>æ ‘å½¢çš„ç»“æ„çœ‹ç€ä¸å¤ªç›´è§‚ï¼Œæœ¨å­å°±ç”»äº†ä¸€å¼ å±‚çº§ç»“æ„çš„å›¾ï¼š</p>
<p><img src="https://p.k8s.li/registry-storage.jpeg" alt=""></p>
<h3 id="blobs-ç›®å½•"><a href="#blobs-ç›®å½•" class="headerlink" title="blobs ç›®å½•"></a>blobs ç›®å½•</h3><p>ä¹‹å‰æˆ‘ä»¬å‘ registry ç§æ¨é€äº†ä¸¤ä¸ªé•œåƒï¼Œè¿™ä¸¤ä¸ªé•œåƒçš„ layer ç›¸åŒä½†ä¸æ˜¯ç”¨ä¸€ä¸ªé•œåƒï¼Œåœ¨æˆ‘ä»¬ä¹‹å‰ push image çš„æ—¶å€™ä¹Ÿçœ‹åˆ°äº† <code>d1b85e6186f6: Layer already exists</code>ã€‚ä¹Ÿå°±å¯ä»¥è¯æ˜äº†ï¼Œè™½ç„¶ä¸¤ä¸ªé•œåƒä¸åŒï¼Œä½†å®ƒä»¬çš„ layer åœ¨ registry ä¸­å­˜å‚¨çš„æ—¶å€™å¯èƒ½æ˜¯ç›¸åŒçš„ã€‚</p>
<p>åœ¨ <code>blobs/sha256</code> ç›®å½•ä¸‹ä¸€å…±æœ‰ 5 ä¸ªåä¸º data çš„æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ¨æµ‹ä¸€ä¸‹æœ€å¤§çš„é‚£ä¸ª <code>[ 26M]</code> åº”è¯¥æ˜¯é•œåƒçš„ layer ï¼Œæœ€å°çš„ <code>[ 529]</code> é‚£ä¸ªåº”è¯¥æ˜¯ manifestï¼Œå‰©ä¸‹çš„é‚£ä¸ª <code>[1.4K]</code> åº”è¯¥å°±æ˜¯ image config æ–‡ä»¶ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/blobs/sha256</span><br><span class="line">â•°â”€# tree -h</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ [4.0K]  aa</span><br><span class="line">â”‚Â Â  â””â”€â”€ [4.0K]  aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb</span><br><span class="line">â”‚Â Â      â””â”€â”€ [ 26M]  data</span><br><span class="line">â”œâ”€â”€ [4.0K]  b9</span><br><span class="line">â”‚Â Â  â””â”€â”€ [4.0K]  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239</span><br><span class="line">â”‚Â Â      â””â”€â”€ [ 529]  data</span><br><span class="line">â”œâ”€â”€ [4.0K]  c8</span><br><span class="line">â”‚Â Â  â””â”€â”€ [4.0K]  c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11</span><br><span class="line">â”‚Â Â      â””â”€â”€ [ 529]  data</span><br><span class="line">â”œâ”€â”€ [4.0K]  cf</span><br><span class="line">â”‚Â Â  â””â”€â”€ [4.0K]  cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d</span><br><span class="line">â”‚Â Â      â””â”€â”€ [1.4K]  data</span><br><span class="line">â””â”€â”€ [4.0K]  e6</span><br><span class="line">    â””â”€â”€ [4.0K]  e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df</span><br><span class="line">        â””â”€â”€ [1.4K]  data</span><br></pre></td></tr></table></figure>
<p>åœ¨ <code>registry</code> çš„å­˜å‚¨ç›®å½•ä¸‹ï¼Œ<code>blobs</code> ç›®å½•ç”¨æ¥å­˜æ”¾é•œåƒçš„ä¸‰ç§æ–‡ä»¶ï¼š layer çš„çœŸå®æ•°æ®ï¼Œé•œåƒçš„ manifest æ–‡ä»¶ï¼Œé•œåƒçš„ image config æ–‡ä»¶ã€‚è¿™äº›æ–‡ä»¶éƒ½æ˜¯ä»¥ <code>data</code> ä¸ºåçš„æ–‡ä»¶å­˜æ”¾åœ¨äºè¯¥æ–‡ä»¶ <code>sha256</code> ç›¸å¯¹åº”çš„ç›®å½•ä¸‹ã€‚ ä½¿ç”¨ä»¥å†…å®¹å¯»å€çš„ <code>sha256</code> æ•£åˆ—å­˜å‚¨æ–¹ä¾¿ç´¢å¼•æ–‡ä»¶ï¼Œåœ¨ <code>blob digest</code> ç›®å½•ä¸‹æœ‰ä¸€ä¸ªåä¸º <code>data</code>çš„æ–‡ä»¶ï¼Œå¯¹äº layer æ¥è®²ï¼Œè¿™æ˜¯ä¸ª <code>data</code> æ–‡ä»¶çš„æ ¼å¼æ˜¯ <code>vnd.docker.image.rootfs.diff.tar.gzip</code> ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>tar -xvf</code> å‘½ä»¤å°†è¿™ä¸ª layer è§£å¼€ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ docker pull å‘½ä»¤æ‹‰å–é•œåƒçš„æ—¶å€™ï¼Œä¹Ÿæ˜¯å»ä¸‹è½½è¿™ä¸ª <code>data</code>æ–‡ä»¶ï¼Œä¸‹è½½å®Œæˆä¹‹åä¼šæœ‰ä¸€ä¸ª <code>docker-untar</code>çš„è¿›ç¨‹å°†è¿™ä¸ª <code>data</code>æ–‡ä»¶è§£å¼€å­˜æ”¾åœ¨<code>/var/lib/docker/overlay2/${digest}/diff</code> ç›®å½•ä¸‹ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€â”€ [4.0K]  blobs</span><br><span class="line">â”‚Â Â  â””â”€â”€ [4.0K]  sha256</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ [4.0K]  aa</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ [4.0K]  aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ [ 26M]  data</span><br></pre></td></tr></table></figure>
<h4 id="manifest-æ–‡ä»¶"><a href="#manifest-æ–‡ä»¶" class="headerlink" title="manifest æ–‡ä»¶"></a>manifest æ–‡ä»¶</h4><p>å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„ json æ–‡ä»¶å•¦ï¼Œè®°å½•äº†ä¸€ä¸ªé•œåƒæ‰€åŒ…å«çš„ layer ä¿¡æ¯ï¼Œå½“æˆ‘ä»¬ pull é•œåƒçš„æ—¶å€™ä¼šä½¿ç”¨åˆ°è¿™ä¸ªæ–‡ä»¶ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/blobs/sha256/b9/b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239</span><br><span class="line">â•°â”€# cat data</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">"schemaVersion"</span>: <span class="number">2</span>,</span><br><span class="line">   <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">   <span class="attr">"config"</span>: &#123;</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.container.image.v1+json"</span>,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">1462</span>,</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"layers"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span>,</span><br><span class="line">         <span class="attr">"size"</span>: <span class="number">27097859</span>,</span><br><span class="line">         <span class="attr">"digest"</span>: <span class="string">"sha256:aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb"</span></span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;#</span><br></pre></td></tr></table></figure>
<h4 id="image-config-æ–‡ä»¶"><a href="#image-config-æ–‡ä»¶" class="headerlink" title="image config æ–‡ä»¶"></a>image config æ–‡ä»¶</h4><p>image config æ–‡ä»¶é‡Œå¹¶æ²¡æœ‰åŒ…å«é•œåƒçš„ tag ä¿¡æ¯ã€‚</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/blobs/sha256/e6/e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df</span><br><span class="line">â•°â”€# cat data | jq "."</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">  <span class="attr">"config"</span>: &#123;</span><br><span class="line">    <span class="attr">"Hostname"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"Domainname"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"User"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"AttachStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStdout"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStderr"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Tty"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"OpenStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"StdinOnce"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Env"</span>: [</span><br><span class="line">      <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Cmd"</span>: [</span><br><span class="line">      <span class="string">"bash"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Image"</span>: <span class="string">"sha256:ba8f577813c7bdf6b737f638dffbc688aa1df2ff28a826a6c46bae722977b549"</span>,</span><br><span class="line">    <span class="attr">"Volumes"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"WorkingDir"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"Entrypoint"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"OnBuild"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"Labels"</span>: <span class="literal">null</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"container"</span>: <span class="string">"38501d5aa48c080884f4dc6fd4b1b6590ff1607d9e7a12e1cef1d86a3fdc32df"</span>,</span><br><span class="line">  <span class="attr">"container_config"</span>: &#123;</span><br><span class="line">    <span class="attr">"Hostname"</span>: <span class="string">"38501d5aa48c"</span>,</span><br><span class="line">    <span class="attr">"Domainname"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"User"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"AttachStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStdout"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"AttachStderr"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Tty"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"OpenStdin"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"StdinOnce"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"Env"</span>: [</span><br><span class="line">      <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Cmd"</span>: [</span><br><span class="line">      <span class="string">"/bin/sh"</span>,</span><br><span class="line">      <span class="string">"-c"</span>,</span><br><span class="line">      <span class="string">"#(nop) "</span>,</span><br><span class="line">      <span class="string">"CMD [\"bash\"]"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Image"</span>: <span class="string">"sha256:ba8f577813c7bdf6b737f638dffbc688aa1df2ff28a826a6c46bae722977b549"</span>,</span><br><span class="line">    <span class="attr">"Volumes"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"WorkingDir"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="attr">"Entrypoint"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"OnBuild"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"Labels"</span>: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"created"</span>: <span class="string">"2020-06-07T01:59:47.348924716Z"</span>,</span><br><span class="line">  <span class="attr">"docker_version"</span>: <span class="string">"19.03.5"</span>,</span><br><span class="line">  <span class="attr">"history"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"created"</span>: <span class="string">"2020-06-07T01:59:46.877600299Z"</span>,</span><br><span class="line">      <span class="attr">"created_by"</span>: <span class="string">"/bin/sh -c #(nop) ADD file:a82014afc29e7b364ac95223b22ebafad46cc9318951a85027a49f9ce1a99461 in / "</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"created"</span>: <span class="string">"2020-06-07T01:59:47.348924716Z"</span>,</span><br><span class="line">      <span class="attr">"created_by"</span>: <span class="string">"/bin/sh -c #(nop)  CMD [\"bash\"]"</span>,</span><br><span class="line">      <span class="attr">"empty_layer"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">  <span class="attr">"rootfs"</span>: &#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"layers"</span>,</span><br><span class="line">    <span class="attr">"diff_ids"</span>: [</span><br><span class="line">      <span class="string">"sha256:d1b85e6186f67d9925c622a7a6e66faa447e767f90f65ae47cdc817c629fa956"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="uploads-æ–‡ä»¶å¤¹"><a href="#uploads-æ–‡ä»¶å¤¹" class="headerlink" title="_uploads æ–‡ä»¶å¤¹"></a>_uploads æ–‡ä»¶å¤¹</h4><p>_uploads æ–‡ä»¶å¤¹æ˜¯ä¸ªä¸´æ—¶çš„æ–‡ä»¶å¤¹ï¼Œä¸»è¦ç”¨æ¥å­˜æ”¾ push é•œåƒè¿‡ç¨‹ä¸­çš„æ–‡ä»¶æ•°æ®ï¼Œå½“é•œåƒ <code>layer</code> ä¸Šä¼ å®Œæˆä¹‹åä¼šæ¸…ç©ºè¯¥æ–‡ä»¶å¤¹ã€‚å…¶ä¸­çš„ <code>data</code> æ–‡ä»¶ä¸Šä¼ å®Œæ¯•åä¼šç§»åŠ¨åˆ° <code>blobs</code> ç›®å½•ä¸‹ï¼Œæ ¹æ®è¯¥æ–‡ä»¶çš„ <code>sha256</code> å€¼æ¥è¿›è¡Œæ•£åˆ—å­˜å‚¨åˆ°ç›¸åº”çš„ç›®å½•ä¸‹ã€‚</p>
<p>ä¸Šä¼ è¿‡ç¨‹ä¸­çš„ç›®å½•ç»“æ„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">_uploads</span><br><span class="line">â”œâ”€â”€ [  53]  0d6c996e-638f-4436-b2b6-54fa7ad430d2</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ [198M]  data</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ [  20]  hashstates</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ [  15]  sha256</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ [ 108]  0</span><br><span class="line">â”‚Â Â  â””â”€â”€ [  20]  startedat</span><br><span class="line">â””â”€â”€ [  53]  ba31818e-4217-47ef-ae46-2784c9222614</span><br><span class="line">    â”œâ”€â”€ [571M]  data</span><br><span class="line">    â”œâ”€â”€ [  20]  hashstates</span><br><span class="line">    â”‚Â Â  â””â”€â”€ [  15]  sha256</span><br><span class="line">    â”‚Â Â      â””â”€â”€ [ 108]  0</span><br><span class="line">    â””â”€â”€ [  20]  startedat</span><br><span class="line"></span><br><span class="line">6 directories, 6 files</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¸Šä¼ å®Œé•œåƒä¹‹åï¼Œ<code>_uploads</code> æ–‡ä»¶å¤¹å°±ä¼šè¢«æ¸…ç©ºï¼Œæ­£å¸¸æƒ…å†µä¸‹è¿™ä¸ªæ–‡ä»¶å¤¹æ˜¯ç©ºçš„ã€‚ä½†ä¹Ÿæœ‰å¼‚å¸¸çš„æ—¶å€™ğŸ˜‚ï¼Œæ¯”å¦‚ç½‘ç»œæŠ–åŠ¨å¯¼è‡´ä¸Šä¼ æ„å¤–ä¸­æ–­ï¼Œè¯¥æ–‡ä»¶å¤¹å°±å¯èƒ½ä¸ä¸ºç©ºã€‚</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_uploads</span><br><span class="line"></span><br><span class="line">0 directories, 0 files</span><br></pre></td></tr></table></figure>
<h4 id="manifests-æ–‡ä»¶å¤¹"><a href="#manifests-æ–‡ä»¶å¤¹" class="headerlink" title="_manifests æ–‡ä»¶å¤¹"></a>_manifests æ–‡ä»¶å¤¹</h4><p><code>_manifests</code> æ–‡ä»¶å¤¹æ˜¯é•œåƒä¸Šä¼ å®Œæˆä¹‹åç”± registry æ¥ç”Ÿæˆçš„ï¼Œå¹¶ä¸”è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªåä¸º <code>link</code>çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå®ƒçš„å€¼æŒ‡å‘ blobs ç›®å½•ä¸‹ä¸ä¹‹å¯¹åº”çš„ç›®å½•ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/repositories/library</span><br><span class="line">â•°â”€# find . -type f</span><br><span class="line">./debian/_layers/sha256/aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb/link</span><br><span class="line">./debian/_layers/sha256/e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df/link</span><br><span class="line">./debian/_layers/sha256/cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d/link</span><br><span class="line">./debian/_manifests/tags/v2/current/link</span><br><span class="line">./debian/_manifests/tags/v2/index/sha256/c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11/link</span><br><span class="line">./debian/_manifests/tags/v1/current/link</span><br><span class="line">./debian/_manifests/tags/v1/index/sha256/b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239/link</span><br><span class="line">./debian/_manifests/revisions/sha256/b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239/link</span><br><span class="line">./debian/_manifests/revisions/sha256/c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11/link</span><br></pre></td></tr></table></figure>
<p><code>_manifests</code> æ–‡ä»¶å¤¹ä¸‹åŒ…å«ç€é•œåƒçš„ <code>tags</code> å’Œ <code>revisions</code> ä¿¡æ¯ï¼Œæ¯ä¸€ä¸ªé•œåƒçš„æ¯ä¸€ä¸ª tag å¯¹åº”ç€äº tag åç›¸åŒçš„ç›®å½•ã€‚é•œåƒçš„ tag å¹¶ä¸å­˜å‚¨åœ¨ image config ä¸­ï¼Œè€Œæ˜¯ä»¥ç›®å½•çš„å½¢å¼æ¥å½¢æˆé•œåƒçš„ tagï¼Œè¿™ä¸€ç‚¹æ¯”è¾ƒå¥‡å¦™ï¼Œè¿™å’Œæˆ‘ä»¬ Dockerfile ä¸­å¹¶ä¸åŒ…å«é•œåƒåå’Œ tag ä¸€ä¸ªé“ç†ï¼Ÿ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ [4.0K]  _layers</span><br><span class="line">â”‚Â Â  â””â”€â”€ [4.0K]  sha256</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ [4.0K]  aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ [  71]  link</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ [4.0K]  cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ [  71]  link</span><br><span class="line">â”‚Â Â      â””â”€â”€ [4.0K]  e6e782a57a51d01168907938beb5cd5af24fcb7ebed8f0b32c203137ace6d3df</span><br><span class="line">â”‚Â Â          â””â”€â”€ [  71]  link</span><br><span class="line">â”œâ”€â”€ [4.0K]  _manifests</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ [4.0K]  revisions</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ [4.0K]  sha256</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”œâ”€â”€ [4.0K]  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239</span><br><span class="line">â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ [  71]  link</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ [4.0K]  c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ [  71]  link</span><br><span class="line">â”‚Â Â  â””â”€â”€ [4.0K]  tags</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ [4.0K]  v1</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”œâ”€â”€ [4.0K]  current</span><br><span class="line">â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ [  71]  link</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ [4.0K]  index</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ [4.0K]  sha256</span><br><span class="line">â”‚Â Â      â”‚Â Â          â””â”€â”€ [4.0K]  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239</span><br><span class="line">â”‚Â Â      â”‚Â Â              â””â”€â”€ [  71]  link</span><br><span class="line">â”‚Â Â      â””â”€â”€ [4.0K]  v2</span><br><span class="line">â”‚Â Â          â”œâ”€â”€ [4.0K]  current</span><br><span class="line">â”‚Â Â          â”‚Â Â  â””â”€â”€ [  71]  link</span><br><span class="line">â”‚Â Â          â””â”€â”€ [4.0K]  index</span><br><span class="line">â”‚Â Â              â””â”€â”€ [4.0K]  sha256</span><br><span class="line">â”‚Â Â                  â””â”€â”€ [4.0K]  c805f078bb47c575e9602b09af7568eb27fd1c92073199acba68c187bc5bcf11</span><br><span class="line">â”‚Â Â                      â””â”€â”€ [  71]  link</span><br><span class="line">â””â”€â”€ [4.0K]  _uploads</span><br><span class="line"></span><br><span class="line">22 directories, 9 files</span><br></pre></td></tr></table></figure>
<h4 id="é•œåƒçš„-tag"><a href="#é•œåƒçš„-tag" class="headerlink" title="é•œåƒçš„ tag"></a>é•œåƒçš„ tag</h4><p> æ¯ä¸ª <code>tag</code>åç›®å½•ä¸‹é¢æœ‰ <code>current</code> ç›®å½•å’Œ <code>index</code> ç›®å½•ï¼Œ <code>current</code> ç›®å½•ä¸‹çš„ link æ–‡ä»¶ä¿å­˜äº†è¯¥ tag ç›®å‰çš„ manifest æ–‡ä»¶çš„ sha256 ç¼–ç ï¼Œå¯¹åº”åœ¨ <code>blobs</code> ä¸­çš„ <code>sha256</code> ç›®å½•ä¸‹çš„ <code>data</code> æ–‡ä»¶ï¼Œè€Œ <code>index</code> ç›®å½•åˆ™åˆ—å‡ºäº†è¯¥ <code>tag</code> å†å²ä¸Šä¼ çš„æ‰€æœ‰ç‰ˆæœ¬çš„ <code>sha256</code> ç¼–ç ä¿¡æ¯ã€‚<code>_revisions</code> ç›®å½•é‡Œå­˜æ”¾äº†è¯¥ <code>repository</code> å†å²ä¸Šä¸Šä¼ ç‰ˆæœ¬çš„æ‰€æœ‰ sha256 ç¼–ç ä¿¡æ¯ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/repositories/library/debian/_manifests/tags/v1</span><br><span class="line">â•°â”€# cat current/link</span><br><span class="line">sha256:b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239</span><br><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/blobs/sha256</span><br><span class="line">â•°â”€# tree -h</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ [4.0K]  aa</span><br><span class="line">â”‚Â Â  â””â”€â”€ [4.0K]  aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb</span><br><span class="line">â”‚Â Â      â””â”€â”€ [ 26M]  data</span><br><span class="line">â”œâ”€â”€ [4.0K]  b9</span><br><span class="line">â”‚Â Â  â””â”€â”€ [4.0K]  b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239</span><br><span class="line">â”‚Â Â      â””â”€â”€ [ 529]  data</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬ <code>pull</code> é•œåƒçš„æ—¶å€™å¦‚æœä¸æŒ‡å®šé•œåƒçš„ <code>tag</code>åï¼Œé»˜è®¤å°±æ˜¯ latestï¼Œregistry ä¼šä» HTTP è¯·æ±‚ä¸­è§£æåˆ°è¿™ä¸ª tag åï¼Œç„¶åæ ¹æ® tag åç›®å½•ä¸‹çš„ link æ–‡ä»¶æ‰¾åˆ°è¯¥é•œåƒçš„ manifest çš„ä½ç½®è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ¥ç€å»è¯·æ±‚è¿™ä¸ª manifest æ–‡ä»¶ï¼Œå®¢æˆ·ç«¯æ ¹æ®è¿™ä¸ª manifest æ–‡ä»¶æ¥ pull ç›¸åº”çš„é•œåƒ layer ã€‚</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/registry/docker/registry/v2/repositories/library/debian/_manifests/tags/v1</span><br><span class="line">â•°â”€# cat  /var/lib/registry/docker/registry/v2/blobs/sha256/b9/b9caca385021f231e15aee34929eac332c49402372a79808d07ee66866792239/data</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">"schemaVersion"</span>: <span class="number">2</span>,</span><br><span class="line">   <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">   <span class="attr">"config"</span>: &#123;</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.container.image.v1+json"</span>,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">1462</span>,</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:cfba37fd24f80f59e5d7c1f7735cae7a383e887d8cff7e2762fdd78c0d73568d"</span></span><br><span class="line">   &#125;,</span><br><span class="line">   <span class="attr">"layers"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span>,</span><br><span class="line">         <span class="attr">"size"</span>: <span class="number">27097859</span>,</span><br><span class="line">         <span class="attr">"digest"</span>: <span class="string">"sha256:aaae33815489895f602207ac5a583422b8a8755b3f67fc6286ca9484ba685bdb"</span></span><br><span class="line">      &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€åå†è¡¥å……ä¸€ç‚¹å°±æ˜¯ï¼ŒåŒä¸€ä¸ªé•œåƒåœ¨ registry ä¸­å­˜å‚¨çš„ä½ç½®æ˜¯ç›¸åŒçš„ï¼Œå…·ä½“çš„åˆ†æå¯ä»¥å‚è€ƒ <a href="https://supereagle.github.io/2018/04/24/docker-registry/" target="_blank" rel="noopener">é•œåƒä»“åº“ä¸­é•œåƒå­˜å‚¨çš„åŸç†è§£æ</a> è¿™ç¯‡åšå®¢ã€‚</p>
<blockquote>
<ul>
<li>é€šè¿‡ Registry API è·å¾—çš„ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ manifest ä¿¡æ¯å®Œå…¨ç›¸åŒã€‚</li>
<li>ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ manifest ä¿¡æ¯çš„å­˜å‚¨è·¯å¾„å’Œå†…å®¹å®Œå…¨ç›¸åŒã€‚</li>
<li>ä¸¤ä¸ªé•œåƒä»“åº“ä¸­ç›¸åŒé•œåƒçš„ blob ä¿¡æ¯çš„å­˜å‚¨è·¯å¾„å’Œå†…å®¹å®Œå…¨ç›¸åŒã€‚</li>
</ul>
</blockquote>
<p>ä»ä¸Šé¢è¿™ä¸‰ä¸ªç»“è®ºä¸­æˆ‘ä»¬å¯ä»¥æ¨æ–­å‡º registry å­˜å‚¨ç›®å½•é‡Œå¹¶ä¸ä¼šå­˜å‚¨ä¸è¯¥ registry ç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”æˆ‘ä»¬ push é•œåƒçš„æ—¶å€™éœ€è¦ç»™é•œåƒåŠ ä¸Š <code>localhost:5000</code> è¿™ä¸ªå‰ç¼€ï¼Œè¿™ä¸ªå‰ç¼€å¹¶ä¸ä¼šå­˜å‚¨åœ¨ registry å­˜å‚¨ä¸­ã€‚åŠ å…¥æˆ‘è¦è¿ç§»ä¸€ä¸ªå¾ˆå¤§çš„ registry é•œåƒä»“åº“ï¼Œé•œåƒçš„æ•°é‡åœ¨ 5k ä»¥ä¸Šã€‚æœ€ä¾¿æ·çš„åŠæ³•å°±æ˜¯æ‰“åŒ…è¿™ä¸ª registry å­˜å‚¨ç›®å½•ï¼Œå°†è¿™ä¸ª tar åŒ… rsync åˆ°å¦ä¸€å°æœºå™¨å³å¯ã€‚éœ€è¦å¼ºè°ƒä¸€ç‚¹ï¼Œæ‰“åŒ… registry å­˜å‚¨ç›®å½•çš„æ—¶å€™ä¸éœ€è¦è¿›è¡Œå‹ç¼©ï¼Œç›´æ¥ <code>tar -cvf</code> å³å¯ã€‚å› ä¸º registry å­˜å‚¨çš„é•œåƒ layer å·²ç»æ˜¯ä¸ª <code>tar.gzip</code> æ ¼å¼çš„æ–‡ä»¶ï¼Œå†è¿›è¡Œå‹ç¼©çš„è¯æ•ˆæœç”šå¾®è€Œä¸”è¿˜æµªè´¹ CPU æ—¶é—´å¾—ä¸å¿å¤±ã€‚</p>
<h3 id="docker-archive"><a href="#docker-archive" class="headerlink" title="docker-archive"></a>docker-archive</h3><p>æœ¬æ¥æˆ‘æƒ³ç€ docker save å‡ºæ¥çš„å¹¶ä¸æ˜¯ä¸€ä¸ªé•œåƒï¼Œè€Œæ˜¯ä¸€ä¸ª <code>.tar</code> æ–‡ä»¶ï¼Œä½†æˆ‘æƒ³äº†åˆæƒ³ï¼Œè¿˜æ˜¯è§‰ç€å®ƒæ˜¯ä¸€ä¸ªé•œåƒï¼Œåªä¸è¿‡å­˜åœ¨çš„æ–¹å¼ä¸åŒè€Œå·²ã€‚äºåœ¨ docker å’Œ registry ä¸­å­˜æ”¾çš„æ–¹å¼ä¸åŒï¼Œä½¿ç”¨ docker save å‡ºæ¥çš„é•œåƒæ˜¯ä¸€ä¸ªå­¤ç«‹çš„å­˜åœ¨ã€‚å°±åƒæ˜¯ä»è›‹ç³•åº—é‡Œæ‹¿å‡ºæ¥çš„è›‹ç³•ï¼Œå¤–é¢è‚¯å®šè¦æœ‰ä¸ªç²¾ç¾çš„åŒ…è£…æ˜¯å§ï¼Œä½ æ€»æ²¡è§è¿‡ã€‚æ”¾åœ¨å“ªé‡Œéƒ½å¯ä»¥ï¼Œä½¿ç”¨çš„æ—¶å€™æˆ‘ä»¬ä½¿ç”¨ docker load æ‹†å¼€å¤–åŒ…è£…(<code>.tar</code>)å°±å¯ã€‚æ¯”å¦‚æˆ‘ä»¬ç¦»çº¿éƒ¨ç½² harbor çš„æ—¶å€™å°±æ˜¯ä½¿ç”¨å®˜æ–¹çš„é•œåƒ tar åŒ…æ¥è¿›è¡ŒåŠ è½½é•œåƒå¯åŠ¨å®¹å™¨çš„ã€‚</p>
<h2 id="é•œåƒæ˜¯æ€ä¹ˆé£Ÿç”¨çš„ğŸ˜‹"><a href="#é•œåƒæ˜¯æ€ä¹ˆé£Ÿç”¨çš„ğŸ˜‹" class="headerlink" title="é•œåƒæ˜¯æ€ä¹ˆé£Ÿç”¨çš„ğŸ˜‹"></a>é•œåƒæ˜¯æ€ä¹ˆé£Ÿç”¨çš„ğŸ˜‹</h2><p>å½“æˆ‘ä»¬æ‹¿åˆ°ä¸€ä¸ªé•œåƒä¹‹åï¼Œå¦‚æœç”¨å®ƒæ¥å¯åŠ¨ä¸€ä¸ªå®¹å™¨å‘¢ï¼Ÿè¿™é‡Œå°±æ¶‰åŠåˆ°äº† OCI è§„èŒƒä¸­çš„å¦ä¸€ä¸ªè§„èŒƒå³è¿è¡Œæ—¶è§„èŒƒ <a href="https://github.com/opencontainers/runtime-spec" target="_blank" rel="noopener">runtime-spec</a> ã€‚å®¹å™¨è¿è¡Œæ—¶é€šè¿‡ä¸€ä¸ªå« <a href="https://github.com/opencontainers/runtime-spec/blob/master/bundle.md" target="_blank" rel="noopener"> OCI runtime filesytem bundle</a> çš„æ ‡å‡†æ ¼å¼å°† OCI é•œåƒé€šè¿‡å·¥å…·è½¬æ¢ä¸º bundle ï¼Œç„¶å OCI å®¹å™¨å¼•æ“èƒ½å¤Ÿè¯†åˆ«è¿™ä¸ª bundle æ¥è¿è¡Œå®¹å™¨ã€‚</p>
<blockquote>
<p>filesystem bundle æ˜¯ä¸ªç›®å½•ï¼Œç”¨äºç»™ runtime æä¾›å¯åŠ¨å®¹å™¨å¿…å¤‡çš„é…ç½®æ–‡ä»¶å’Œæ–‡ä»¶ç³»ç»Ÿã€‚æ ‡å‡†çš„å®¹å™¨ bundle åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>
<ul>
<li>config.json: è¯¥æ–‡ä»¶åŒ…å«äº†å®¹å™¨è¿è¡Œçš„é…ç½®ä¿¡æ¯ï¼Œè¯¥æ–‡ä»¶å¿…é¡»å­˜åœ¨ bundle çš„æ ¹ç›®å½•ï¼Œä¸”åå­—å¿…é¡»ä¸º config.json</li>
<li>å®¹å™¨çš„æ ¹ç›®å½•ï¼Œå¯ä»¥ç”± config.json ä¸­çš„ root.path æŒ‡å®š</li>
</ul>
</blockquote>
<p><img src="https://p.k8s.li/20200609_oci-04.jpg" alt=""></p>
<h3 id="docker-run"><a href="#docker-run" class="headerlink" title="docker run"></a>docker run</h3><p>å½“æˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªå®¹å™¨ä¹‹åæˆ‘ä»¬ä½¿ç”¨ tree å‘½ä»¤æ¥åˆ†æä¸€ä¸‹ overlay2 å°±ä¼šå‘ç°ï¼Œè¾ƒä¹‹å‰çš„ç›®å½•ï¼Œå®¹å™¨å¯åŠ¨ä¹‹å overlay2 ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ª <code>merged</code> çš„æ–‡ä»¶å¤¹ï¼Œè¯¥æ–‡ä»¶å¤¹å°±æ˜¯å®¹å™¨å†…çœ‹åˆ°çš„ã€‚docker é€šè¿‡ overlayfs è”åˆæŒ‚è½½çš„æŠ€æœ¯å°†é•œåƒçš„å¤šå±‚ layer æŒ‚è½½ä¸ºä¸€å±‚ï¼Œè¿™å±‚çš„å†…å®¹å°±æ˜¯å®¹å™¨é‡Œæ‰€çœ‹åˆ°çš„ï¼Œä¹Ÿå°±æ˜¯ merged æ–‡ä»¶å¤¹ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">â•­â”€root@sg-02 /var/lib/docker</span><br><span class="line">â•°â”€# tree overlay2 -d -L 3</span><br><span class="line">overlay2</span><br><span class="line">â”œâ”€â”€ 259cf6934509a674b1158f0a6c90c60c133fd11189f98945c7c3a524784509ff</span><br><span class="line">â”‚Â Â  â””â”€â”€ diff</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ bin</span><br><span class="line">|</span><br><span class="line">â”‚Â Â      â””â”€â”€ var</span><br><span class="line">â”œâ”€â”€ 27f9e9b74a88a269121b4e77330a665d6cca4719cb9a58bfc96a2b88a07af805</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ diff</span><br><span class="line">â”‚Â Â  â””â”€â”€ work</span><br><span class="line">â”œâ”€â”€ 5f85c914c55220ec2635bce0080d2ad677f739dcfac4fd266b773625e3051844</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ diff</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ var</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ merged</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ bin</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ dev</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ etc</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ home</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ lib</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ media</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ mnt</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ proc</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ root</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ run</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ sbin</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ srv</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ sys</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ tmp</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ usr</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ var</span><br><span class="line">â”‚Â Â  â””â”€â”€ work</span><br><span class="line">â”‚Â Â      â””â”€â”€ work</span><br><span class="line">â”œâ”€â”€ 5f85c914c55220ec2635bce0080d2ad677f739dcfac4fd266b773625e3051844-init</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ diff</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ dev</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ etc</span><br><span class="line">â”‚Â Â  â””â”€â”€ work</span><br><span class="line">â”‚Â Â      â””â”€â”€ work</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">overlay on / type overlay (rw,relatime,lowerdir=/opt/docker/overlay2/l/4EPD2X5VF62FH5PZOZHZDKAKGL:/opt/docker/overlay2/l/MYRYBGZRI4I76MJWQHN7VLZXLW:/opt/docker/overlay2/l/5RZOXYR35NSGAWTI36CVUIRW7U:/opt/docker/overlay2/l/LBWRL4ZXGBWOTN5JDCDZVNOY7H:/opt/docker/overlay2/l/526XCHXRJMZXRIHN4YWJH2QLPY:/opt/docker/overlay2/l/XK5IA4BWQ2CIS667J3SXPXGQK5,upperdir=/opt/docker/overlay2/f913d81219134e23eb0827a1c27668494dfaea2f1b5d1d0c70382366eabed629/diff,workdir=/opt/docker/overlay2/f913d81219134e23eb0827a1c27668494dfaea2f1b5d1d0c70382366eabed629/work)</span><br></pre></td></tr></table></figure>
<p>ä» docker å®˜æ–¹æ–‡æ¡£ <a href="https://docs.docker.com/storage/storagedriver/overlayfs-driver/" target="_blank" rel="noopener">Use the OverlayFS storage driver</a> é‡Œå·æ¥çš„ä¸€å¼ å›¾ç‰‡</p>
<p><img src="https://p.k8s.li/overlay_constructs.jpg" alt=""></p>
<p>å…³äºä¸Šå›¾ä¸­è¿™äº› Dir çš„ä½œç”¨ï¼Œä¸‹é¢æ˜¯ä¸€æ®µä» <a href="https://stackoverflow.com/questions/56550890/docker-image-merged-diff-work-lowerdir-components-of-graphdriver" target="_blank" rel="noopener">StackOverflow</a> ä¸Šæ¬è¿è¿‡æ¥çš„è§£é‡Šã€‚</p>
<blockquote>
<p><strong>LowerDir</strong>: these are the read-only layers of an overlay filesystem. For docker, these are the image layers assembled in order.</p>
<p><strong>UpperDir</strong>: this is the read-write layer of an overlay filesystem. For docker, that is the equivalent of the container specific layer that contains changes made by that container.</p>
<p><strong>WorkDir</strong>: this is a required directory for overlay, it needs an empty directory for internal use.</p>
<p><strong>MergedDir</strong>: this is the result of the overlay filesystem. Docker effectively chrootâ€™s into this directory when running the container.</p>
</blockquote>
<p>å¦‚æœæƒ³å¯¹ overlayfs æ–‡ä»¶ç³»ç»Ÿæœ‰è¯¦ç»†çš„äº†è§£ï¼Œå¯ä»¥å‚è€ƒ Linux å†…æ ¸å®˜ç½‘ä¸Šçš„è¿™ç¯‡æ–‡æ¡£ <a href="https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt" target="_blank" rel="noopener">overlayfs.txt</a> ã€‚</p>
<h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><h3 id="å®˜æ–¹æ–‡æ¡£"><a href="#å®˜æ–¹æ–‡æ¡£" class="headerlink" title="å®˜æ–¹æ–‡æ¡£"></a>å®˜æ–¹æ–‡æ¡£</h3><ul>
<li><a href="https://docs.docker.com/develop/develop-images/baseimages/" target="_blank" rel="noopener">Create a base image</a></li>
<li><a href="https://hub.docker.com/_/scratch" target="_blank" rel="noopener">FROM scratch</a></li>
<li><a href="https://docs.docker.com/registry/" target="_blank" rel="noopener">Docker Registry</a></li>
<li><a href="https://github.com/docker/distribution/blob/master/docs/spec/manifest-v2-2.md" target="_blank" rel="noopener">Image Manifest Version 2, Schema 2</a></li>
<li><a href="https://docs.docker.com/registry/spec/api/" target="_blank" rel="noopener">Docker Registry HTTP API V2</a></li>
<li><a href="https://github.com/containers/image" target="_blank" rel="noopener">image</a></li>
<li><a href="https://github.com/opencontainers/image-spec" target="_blank" rel="noopener">OCI Image Manifest Specification</a></li>
<li><a href="https://github.com/opencontainers/distribution-spec" target="_blank" rel="noopener">distribution-spec</a></li>
<li><a href="https://doi-janky.infosiftr.net/job/tianon/job/debuerreotype/" target="_blank" rel="noopener">debuerreotype/</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt" target="_blank" rel="noopener">overlayfs.txt</a></li>
</ul>
<h3 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h3><ul>
<li><a href="https://github.com/docker-library/oi-janky-groovy" target="_blank" rel="noopener">oi-janky-groovy</a></li>
<li><a href="https://github.com/debuerreotype/docker-debian-artifacts" target="_blank" rel="noopener">docker-debian-artifacts</a></li>
<li><a href="https://github.com/NotGlop/docker-drag" target="_blank" rel="noopener">docker-drag</a></li>
<li><a href="https://github.com/deislabs/oras" target="_blank" rel="noopener">oras</a></li>
<li><a href="https://github.com/containers/skopeo" target="_blank" rel="noopener">skopeo</a></li>
<li><a href="https://github.com/vbatts/tar-split" target="_blank" rel="noopener">tar-split</a></li>
</ul>
<h3 id="åšå®¢"><a href="#åšå®¢" class="headerlink" title="åšå®¢"></a>åšå®¢</h3><ul>
<li><a href="https://supereagle.github.io/2018/04/24/docker-registry/" target="_blank" rel="noopener">é•œåƒä»“åº“ä¸­é•œåƒå­˜å‚¨çš„åŸç†è§£æ</a></li>
<li><a href="https://fuckcloudnative.io/posts/how-manage-image/" target="_blank" rel="noopener">docker åœ¨æœ¬åœ°å¦‚ä½•ç®¡ç† imageï¼ˆé•œåƒï¼‰?</a></li>
<li><a href="http://gaocegege.com/Blog/ormb" target="_blank" rel="noopener">ormbï¼šåƒç®¡ç† Docker å®¹å™¨é•œåƒä¸€æ ·ç®¡ç†æœºå™¨å­¦ä¹ æ¨¡å‹</a></li>
<li><a href="https://blog.fleeto.us/post/how-are-docker-images-built/" target="_blank" rel="noopener">é•œåƒæ˜¯æ€æ ·ç‚¼æˆçš„</a></li>
<li><a href="https://duyanghao.github.io/docker-registry-pull-manifest-v2/" target="_blank" rel="noopener">docker pullåˆ†æ</a></li>
<li><a href="https://github.com/helios741/myblog/blob/new/learn_go/src/2019/20191206_docker_disk_storage/README.md" target="_blank" rel="noopener">æµ…è°ˆdockerä¸­é•œåƒå’Œå®¹å™¨åœ¨æœ¬åœ°çš„å­˜å‚¨</a></li>
<li><a href="https://www.qedev.com/cloud/103860.html" target="_blank" rel="noopener">å®¹å™¨OCIè§„èŒƒ é•œåƒè§„èŒƒ</a></li>
<li><a href="https://xuanwo.io/2019/08/06/oci-intro/" target="_blank" rel="noopener">å¼€æ”¾å®¹å™¨æ ‡å‡†(OCI) å†…éƒ¨åˆ†äº«</a></li>
<li><a href="https://wilhelmguo.cn/blog/post/william/%E5%AE%B9%E5%99%A8%E5%BC%80%E6%94%BE%E6%8E%A5%E5%8F%A3%E8%A7%84%E8%8C%83%EF%BC%88CRI-OCI%EF%BC%89-2" target="_blank" rel="noopener">å®¹å™¨å¼€æ”¾æ¥å£è§„èŒƒï¼ˆCRI OCIï¼‰</a></li>
<li><a href="https://segmentfault.com/a/1190000014284289" target="_blank" rel="noopener">Dockeré•œåƒçš„å­˜å‚¨æœºåˆ¶</a></li>
<li><a href="http://open.daocloud.io/docker-source-code-analysis-part10/" target="_blank" rel="noopener">Dockeræºç åˆ†æï¼ˆåï¼‰ï¼šDockeré•œåƒä¸‹è½½</a></li>
<li><a href="http://open.daocloud.io/docker-source-code-analysis-part9/" target="_blank" rel="noopener">Dockeræºç åˆ†æï¼ˆä¹ï¼‰ï¼šDockeré•œåƒ</a></li>
<li><a href="https://www.twblogs.net/a/5b8aab392b71775d1ce86eca" target="_blank" rel="noopener">docker push éç¨‹ distributionæºç¢¼ åˆ†æ</a></li>
<li><a href="http://open.daocloud.io/tag/allen-tan-docker/" target="_blank" rel="noopener">Allen è°ˆ Docker</a></li>
<li><a href="http://open.daocloud.io/shen-ru-li-jie-dockerjing-xiang-jsonwen-jian-2/" target="_blank" rel="noopener">æ·±å…¥ç†è§£ Docker é•œåƒ json æ–‡ä»¶</a></li>
<li><a href="http://open.daocloud.io/docker-jing-xiang-nei-you-sha-cun-na-ntitled/" target="_blank" rel="noopener">Docker é•œåƒå†…æœ‰å•¥ï¼Œå­˜å“ªï¼Ÿ</a></li>
<li><a href="http://open.daocloud.io/allen-tan-docker-xi-lie-zhi-shen-ke-li-jie-docker-jing-xiang-da-xiao/" target="_blank" rel="noopener">ç†è§£ Docker é•œåƒå¤§å°</a></li>
<li><a href="http://open.daocloud.io/allen-tan-docker-xi-lie-zhi-tu-kan-jin-docker-rong-qi-wen-jian-xi-tong/" target="_blank" rel="noopener">çœ‹å°½ docker å®¹å™¨æ–‡ä»¶ç³»ç»Ÿ</a></li>
<li><a href="https://qhh.me/2019/02/17/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Docker-%E6%9E%84%E5%BB%BA%E4%B8%8A%E4%B8%8B%E6%96%87/" target="_blank" rel="noopener">æ·±å…¥ç†è§£ Docker æ„å»ºä¸Šä¸‹æ–‡</a></li>
<li><a href="https://cizixs.com/2017/11/05/oci-and-runc/" target="_blank" rel="noopener">OCI å’Œ runcï¼šå®¹å™¨æ ‡å‡†åŒ–å’Œ docker</a></li>
</ul>
    </div>
      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/docker/" rel="tag"><i class="fa fa-tag"></i> docker</a>
              <a href="/tags/registry/" rel="tag"><i class="fa fa-tag"></i> registry</a>
              <a href="/tags/image/" rel="tag"><i class="fa fa-tag"></i> image</a>
          </div>
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/mount-bind.html" rel="prev" title="mount å‘½ä»¤ä¹‹ --bind æŒ‚è½½å‚æ•°">
      <i class="fa fa-chevron-left"></i> mount å‘½ä»¤ä¹‹ --bind æŒ‚è½½å‚æ•°
    </a></div>
      <div class="post-nav-item">
    <a href="/Q2-reading.html" rel="next" title="2020 é˜…è¯»è®°å½•ï¼ˆäºŒï¼‰">
      2020 é˜…è¯»è®°å½•ï¼ˆäºŒï¼‰ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
  </article>
  </div>
          </div>
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
        </div>
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>
  <aside class="sidebar">
    <div class="sidebar-inner">
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>
      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#æ›´æ–°è®°å½•"><span class="nav-number">1.</span> <span class="nav-text">æ›´æ–°è®°å½•</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é•œåƒæ˜¯æ€æ ·ç‚¼æˆçš„ğŸ¤”"><span class="nav-number">2.</span> <span class="nav-text">é•œåƒæ˜¯æ€æ ·ç‚¼æˆçš„ğŸ¤”</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OCI-image-spec"><span class="nav-number">2.1.</span> <span class="nav-text">OCI image-spec</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#å„ç§-id-åˆ†ä¸æ¸…ï¼Ÿ"><span class="nav-number">2.2.</span> <span class="nav-text">å„ç§ id åˆ†ä¸æ¸…ï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile"><span class="nav-number">2.3.</span> <span class="nav-text">Dockerfile</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é•œåƒæ˜¯æ€æ ·å­˜æ”¾çš„-ï¼ˆä¸€ï¼‰æœ¬åœ°å­˜å‚¨-ğŸ™„"><span class="nav-number">3.</span> <span class="nav-text">é•œåƒæ˜¯æ€æ ·å­˜æ”¾çš„ ï¼ˆä¸€ï¼‰æœ¬åœ°å­˜å‚¨ ğŸ™„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-var-lib-docker"><span class="nav-number">3.1.</span> <span class="nav-text">docker (&#x2F;var&#x2F;lib&#x2F;docker)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#var-lib-docker-image"><span class="nav-number">3.2.</span> <span class="nav-text">&#x2F;var&#x2F;lib&#x2F;docker&#x2F;image</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#var-lib-docker-overlay2"><span class="nav-number">3.3.</span> <span class="nav-text">&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é•œåƒæ˜¯æ€ä¹ˆæ¬è¿çš„ğŸ¤£"><span class="nav-number">4.</span> <span class="nav-text">é•œåƒæ˜¯æ€ä¹ˆæ¬è¿çš„ğŸ¤£</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-pull"><span class="nav-number">4.1.</span> <span class="nav-text">docker pull</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-push"><span class="nav-number">4.2.</span> <span class="nav-text">docker push</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Python-docker-drag"><span class="nav-number">4.3.</span> <span class="nav-text">Python docker-drag</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo"><span class="nav-number">4.4.</span> <span class="nav-text">skopeo</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é•œåƒæ˜¯æ€ä¹ˆå­˜æ”¾çš„-äºŒ-registry-å­˜å‚¨ğŸ™„"><span class="nav-number">5.</span> <span class="nav-text">é•œåƒæ˜¯æ€ä¹ˆå­˜æ”¾çš„ (äºŒ) registry å­˜å‚¨ğŸ™„</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#registry-registry-docker-v2"><span class="nav-number">5.1.</span> <span class="nav-text">registry (&#x2F;registry&#x2F;docker&#x2F;v2)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#blobs-ç›®å½•"><span class="nav-number">5.2.</span> <span class="nav-text">blobs ç›®å½•</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-archive"><span class="nav-number">5.3.</span> <span class="nav-text">docker-archive</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é•œåƒæ˜¯æ€ä¹ˆé£Ÿç”¨çš„ğŸ˜‹"><span class="nav-number">6.</span> <span class="nav-text">é•œåƒæ˜¯æ€ä¹ˆé£Ÿç”¨çš„ğŸ˜‹</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#docker-run"><span class="nav-number">6.1.</span> <span class="nav-text">docker run</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å‚è€ƒ"><span class="nav-number">7.</span> <span class="nav-text">å‚è€ƒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#å®˜æ–¹æ–‡æ¡£"><span class="nav-number">7.1.</span> <span class="nav-text">å®˜æ–¹æ–‡æ¡£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#æºç "><span class="nav-number">7.2.</span> <span class="nav-text">æºç </span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åšå®¢"><span class="nav-number">7.3.</span> <span class="nav-text">åšå®¢</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->
      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="æœ¨å­"
      src="https://blog.k8s.li/avatar.png">
  <p class="site-author-name" itemprop="name">æœ¨å­</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">98</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:blog@502.li" title="E-Mail â†’ mailto:blog@502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://kindle.502.li/" title="Kindle â†’ https:&#x2F;&#x2F;kindle.502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tg.k8s.li/" title="Channel â†’ https:&#x2F;&#x2F;tg.k8s.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Channel</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>
      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>
      </div>
    </main>
    <footer class="footer">
      <div class="footer-inner">
<div class="copyright">
  &copy; 2018 â€“ 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">æœ¨å­</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">39:50</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>
      </div>
    </footer>
  </div>
  <script src="/lib/anime.min.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>
<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://muzi.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://blog.k8s.li/Exploring-container-image.html",
            identifier: "Exploring-container-image.html",
            title: "æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”ŸğŸ¤”"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://muzi.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>
</body>
</html>
