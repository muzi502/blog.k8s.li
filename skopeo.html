<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.k8s.li').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="搬砖工具作为公司内部 PaaS toB 产品的打包发布人员，容器镜像对我们打工人而言就像是工地上的砖头 🧱，而我的一部分工作就是将这些砖头在各个仓库之间搬来搬去，最终将这些砖头打包放在产品的安装包中，形成一个完整的 PaaS 产品安装包。 而选择一个好的搬砖工具能节省我们大量的人力和 CPU 算力，在日常开发工作中我们也常常会使用 docker push 和 docker pull 来推拉镜像，">
<meta property="og:type" content="article">
<meta property="og:title" content="镜像搬运工 skopeo">
<meta property="og:url" content="https://blog.k8s.li/skopeo.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="搬砖工具作为公司内部 PaaS toB 产品的打包发布人员，容器镜像对我们打工人而言就像是工地上的砖头 🧱，而我的一部分工作就是将这些砖头在各个仓库之间搬来搬去，最终将这些砖头打包放在产品的安装包中，形成一个完整的 PaaS 产品安装包。 而选择一个好的搬砖工具能节省我们大量的人力和 CPU 算力，在日常开发工作中我们也常常会使用 docker push 和 docker pull 来推拉镜像，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/skopeo-github-action-build.png">
<meta property="article:published_time" content="2021-07-10T16:00:00.000Z">
<meta property="article:modified_time" content="2021-07-10T16:00:00.000Z">
<meta property="article:author" content="木子">
<meta property="article:tag" content="registry">
<meta property="article:tag" content="镜像">
<meta property="article:tag" content="skopeo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/skopeo-github-action-build.png">

<link rel="canonical" href="https://blog.k8s.li/skopeo.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>镜像搬运工 skopeo | Reimu's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Reimu's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-desktop"></i>Home</a>

  </li>
        <li class="menu-item menu-item-books">

    <a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Books</a>

  </li>
        <li class="menu-item menu-item-kindle">

    <a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>

  </li>
        <li class="menu-item menu-item-friends">

    <a href="/friends.html" rel="section"><i class="fa fa-fw fa-link"></i>Friends</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about.html" rel="section"><i class="fa fa-fw fa-user-circle-o"></i>About</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/skopeo.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog.k8s.li/avatar.png">
      <meta itemprop="name" content="木子">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          镜像搬运工 skopeo
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-11 2021-07-11T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2021-07-11T00:00:00+08:00">2021-07-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/skopeo.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="skopeo.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>35k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>58 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="搬砖工具"><a href="#搬砖工具" class="headerlink" title="搬砖工具"></a>搬砖工具</h2><p>作为公司内部 PaaS toB 产品的打包发布人员，容器镜像对我们打工人而言就像是工地上的砖头 🧱，而我的一部分工作就是将这些砖头在各个仓库之间搬来搬去，最终将这些砖头打包放在产品的安装包中，形成一个完整的 PaaS 产品安装包。</p>
<p>而选择一个好的搬砖工具能节省我们大量的人力和 CPU 算力，在日常开发工作中我们也常常会使用 docker push 和 docker pull 来推拉镜像，虽然本地 push &amp;&amp; pull 一个镜像并不是什么难事儿，但对于一些特定的场景如产品打包发布流水线中，还继续再使用 docker 这个笨重的工具来推拉镜像的话，是十分费时费力的，具体的原理可以参考我之前写的博客《<a href="https://blog.k8s.li/Exploring-container-image.html">深入浅出容器镜像的一生🤔</a>》。</p>
<p>自从 Kubernetes 1.20 之后，K8s 社区也弃用了 Docker 作为容器运行时，docker-shim 相关的代码将在 kubelet 中不再维护，随后掀起了一波去 docker 的浪潮。那么现在有没有一种能够替代 docker-cli 的工具来传输镜像呢？今天给大家介绍一个能够完全替代 docker-cli 来搬运镜像的工具：skopeo。这玩意儿比 docker-cli 高到不知道哪里去了！</p>
<h2 id="安装方式"><a href="#安装方式" class="headerlink" title="安装方式"></a>安装方式</h2><p>官方的安装方式参考安装文档即可 <a href="https://github.com/containers/skopeo/blob/main/install.md" target="_blank" rel="noopener">https://github.com/containers/skopeo/blob/main/install.md</a></p>
<p>由于我的 VPS 机器是 Ubuntu 1804 的 OS ，配置 apt 源并没成功，当场翻车。在官方的 Makefile 里只提供了在 nixos 下构建静态连接的方式，其他 Linux 发相版只能使用动态链接的方式来编译。但动态链接的方式通用性太差，比如在 ubuntu 18.04 上使用动态链接编译的 skopeo 只能在 ubuntu 上使用，无法在 centos 上使用。因为动态链接编译的二进制文件在不同的 OS 上所依赖的库文件是不一样的。所以还是另辟蹊径，亲自编译一个。</p>
<ul>
<li>Clone repo</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ SKOPEO_VERSION=v1.3.0</span><br><span class="line">$ git <span class="built_in">clone</span> --branch <span class="variable">$&#123;SKOPEO_VERSION&#125;</span> https://github.com/containers/skopeo</span><br><span class="line">$ <span class="built_in">cd</span> skopeo</span><br></pre></td></tr></table></figure>

<ul>
<li>docker  build</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ BUILD_IMAGE=nixos/nix:2.3.12</span><br><span class="line">$ docker run --rm -t -v <span class="variable">$PWD</span>:/build <span class="variable">$&#123;BUILD_IMAGE&#125;</span> \</span><br><span class="line">sh -c <span class="string">"cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo"</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用 <code>nixos/nix:2.3.12</code> 来构建静态链接的 skopeo 二进制文件需要完整构建 skopeo 所有的依赖，比如 glibc、systemd、golang 等，所以构建十分耗时。在一台 4c8G 的机器上构建用了将近半个小时，在 GitHub Action 的 runner 机器上构建需要将近<a href="https://github.com/k8sli/skopeo/actions/runs/1010266302" target="_blank" rel="noopener">一个小时</a>。</li>
</ul>
<p><img src="https://p.k8s.li/skopeo-github-action-build.png" alt="img"></p>
<ul>
<li>使用 GitHub Action 构建</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">build</span> <span class="string">static</span> <span class="string">binary</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">push</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">BUILD_IMAGE:</span> <span class="string">"nixos/nix:2.3.12"</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">static</span> <span class="string">binary</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">docker</span> <span class="string">run</span> <span class="string">--rm</span> <span class="string">-t</span> <span class="string">-v</span> <span class="string">$PWD:/build</span> <span class="string">--name</span> <span class="string">builder</span> <span class="string">$&#123;BUILD_IMAGE&#125;</span> <span class="string">\</span></span><br><span class="line">          <span class="string">sh</span> <span class="string">-c</span> <span class="string">"cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo-linux-amd64"</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">softprops/action-gh-release@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">files:</span> <span class="string">skopeo-linux-amd64</span></span><br></pre></td></tr></table></figure>

<p>不过也可以使用 go build 的方式构建出静态链接的二进制文件，如下 <code>Dockerfile</code></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.14</span>-buster as skopeo-builder</span><br><span class="line"><span class="keyword">ARG</span> SKOPEO_VERSION=v1.<span class="number">2.0</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update \</span></span><br><span class="line"><span class="bash">    &amp;&amp; apt-get install -y -qq libdevmapper-dev libgpgme11-dev</span></span><br><span class="line"><span class="keyword">ENV</span> GOPATH=/</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /src/github.com/containers/skopeo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> git <span class="built_in">clone</span> --branch <span class="variable">$&#123;SKOPEO_VERSION&#125;</span> https://github.com/containers/skopeo . \</span></span><br><span class="line"><span class="bash"> &amp;&amp; CGO_ENABLE=0 GO111MODULE=on go build -mod=vendor <span class="string">"-buildmode=pie"</span> -ldflags <span class="string">'-extldflags "-static"'</span> -gcflags <span class="string">""</span> \</span></span><br><span class="line"><span class="bash"> -tags <span class="string">"exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp"</span> -o /usr/bin/skopeo ./cmd/skopeo</span></span><br><span class="line"><span class="keyword">FROM</span> alpine:<span class="number">3.12</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=skopeo-builder /usr/bin/skopeo /usr/bin/skopeo</span></span><br><span class="line"><span class="comment"># FROM scratch</span></span><br><span class="line"><span class="comment"># COPY --from=skopeo-builder /usr/bin/skopeo /skopeo</span></span><br><span class="line"><span class="comment"># DOCKER_BUILDKIT=1 docker build -o type=local,dest=$PWD -f Dockerfile .</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://github.com/k8sli/skopeo/blob/main/.github/workflows/build-static-binary.yaml" target="_blank" rel="noopener">通过 GitHub Action 来编译</a></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">build</span> <span class="string">static</span> <span class="string">binary</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'v*'</span></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">BUILDER_IMAGE:</span> <span class="string">ghcr.io/k8sli/nixos-nix:v2.3.12</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build-linux-amd64:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">ARCH:</span> <span class="string">"amd64"</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">QEMU</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/setup-qemu-action@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Docker</span> <span class="string">Buildx</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/setup-buildx-action@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">skopeo</span> <span class="string">binary</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">DIGEST=$(skopeo</span> <span class="string">--insecure-policy</span> <span class="string">--override-arch</span> <span class="string">$&#123;ARCH&#125;</span> <span class="string">inspect</span> <span class="string">docker://$&#123;BUILDER_IMAGE&#125;</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">'.Digest'</span><span class="string">)</span></span><br><span class="line">          <span class="string">docker</span> <span class="string">run</span> <span class="string">--rm</span> <span class="string">-t</span> <span class="string">-v</span> <span class="string">$PWD:/build</span> <span class="string">$&#123;BUILDER_IMAGE&#125;@$&#123;DIGEST&#125;</span> <span class="string">\</span></span><br><span class="line">          <span class="string">sh</span> <span class="string">-c</span> <span class="string">"cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo-linux-$<span class="template-variable">&#123;&#123; env.ARCH &#125;&#125;</span>"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">binary</span> <span class="string">artifact</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/upload-artifact@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">skopeo-linux-$&#123;&#123;</span> <span class="string">env.ARCH</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">skopeo-binary-$&#123;&#123;</span> <span class="string">github.run_number</span> <span class="string">&#125;&#125;-$&#123;&#123;</span> <span class="string">env.ARCH</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">build-linux-arm64:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">ARCH:</span> <span class="string">"arm64"</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">QEMU</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/setup-qemu-action@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">up</span> <span class="string">Docker</span> <span class="string">Buildx</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker/setup-buildx-action@v1</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">skopeo</span> <span class="string">binary</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">DIGEST=$(skopeo</span> <span class="string">--insecure-policy</span> <span class="string">--override-arch</span> <span class="string">$&#123;ARCH&#125;</span> <span class="string">inspect</span> <span class="string">docker://$&#123;BUILDER_IMAGE&#125;</span> <span class="string">|</span> <span class="string">jq</span> <span class="string">-r</span> <span class="string">'.Digest'</span><span class="string">)</span></span><br><span class="line">          <span class="string">docker</span> <span class="string">run</span> <span class="string">--rm</span> <span class="string">-t</span> <span class="string">-v</span> <span class="string">$PWD:/build</span> <span class="string">$&#123;BUILDER_IMAGE&#125;@$&#123;DIGEST&#125;</span> <span class="string">\</span></span><br><span class="line">          <span class="string">sh</span> <span class="string">-c</span> <span class="string">"cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo-linux-$<span class="template-variable">&#123;&#123; env.ARCH &#125;&#125;</span>"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">binary</span> <span class="string">artifact</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/upload-artifact@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">skopeo-linux-$&#123;&#123;</span> <span class="string">env.ARCH</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">skopeo-binary-$&#123;&#123;</span> <span class="string">github.run_number</span> <span class="string">&#125;&#125;-$&#123;&#123;</span> <span class="string">env.ARCH</span> <span class="string">&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">release:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">[build-linux-amd64,build-linux-arm64]</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Download</span> <span class="string">artifact</span> <span class="string">from</span> <span class="string">build-linux-amd64</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/download-artifact@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">skopeo-binary-$&#123;&#123;</span> <span class="string">github.run_number</span> <span class="string">&#125;&#125;-amd64</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Download</span> <span class="string">artifact</span> <span class="string">from</span> <span class="string">build-linux-arm64</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/download-artifact@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">skopeo-binary-$&#123;&#123;</span> <span class="string">github.run_number</span> <span class="string">&#125;&#125;-arm64</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Release</span> <span class="string">and</span> <span class="string">upload</span> <span class="string">binary</span> <span class="string">files</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">softprops/action-gh-release@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">files:</span> <span class="string">|</span></span><br><span class="line">            <span class="string">skopeo-linux-amd64</span></span><br><span class="line">            <span class="string">skopeo-linux-arm64</span></span><br></pre></td></tr></table></figure>



<h2 id="上手体验"><a href="#上手体验" class="headerlink" title="上手体验"></a>上手体验</h2><ul>
<li>copy：复制一个镜像从 A 到 B，这里的 A 和 B 可以为本地 docker 镜像或者 registry 上的镜像；</li>
<li>inspect：查看一个镜像的 manifest 或者 image config 详细信息；</li>
<li>delete：删除一个镜像 tag，可以是本地 docker 镜像或者 registry 上的镜像；</li>
<li>list-tags：列出一个 registry 上某个镜像的所有 tag；</li>
<li>login：登录到某个 registry，和 docker login 类似；</li>
<li>logout： 退出已经登录到某个 registry 的 auth 信息，和 docker logout 类似；</li>
<li>manifest-digest：几圈一个文件的 sha256sum 值；</li>
<li>standalone-sign、standalone-verify 这两个是和镜像加密相关的，使用的不是很多；</li>
<li>sync：同步一个镜像从 A 到 B，感觉和 copy 一样，但 sync 支持的参数更多，功能更强大；</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">completion             generate the autocompletion script <span class="keyword">for</span> the specified shell</span><br><span class="line">copy                   Copy an IMAGE-NAME from one location to another</span><br><span class="line">delete                 Delete image IMAGE-NAME</span><br><span class="line"><span class="built_in">help</span>                   Help about any <span class="built_in">command</span></span><br><span class="line">inspect                Inspect image IMAGE-NAME</span><br><span class="line">list-tags              List tags <span class="keyword">in</span> the transport/repository specified by the REPOSITORY-NAME</span><br><span class="line">login                  Login to a container registry</span><br><span class="line"><span class="built_in">logout</span>                 Logout of a container registry</span><br><span class="line">manifest-digest        Compute a manifest digest of a file</span><br><span class="line">standalone-sign        Create a signature using <span class="built_in">local</span> files</span><br><span class="line">standalone-verify      Verify a signature using <span class="built_in">local</span> files</span><br><span class="line">sync                   Synchronize one or more images</span><br></pre></td></tr></table></figure>

<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><ul>
<li>command-timeout：命令超时时间</li>
<li>debug：开启 debug 模式，输出详细的日志</li>
<li>insecure-policy： 使用非安全的 policy，如果没有配置 policy 的话，需要加上该参数</li>
<li>override-arch：处理镜像时覆盖客户端 CPU 体系架构，如在 amd64 的机器上用 skopeo 处理 arm64 的镜像</li>
<li>override-os： 处理镜像时覆盖客户端 OS</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Flags:</span><br><span class="line">      --<span class="built_in">command</span>-timeout duration   timeout <span class="keyword">for</span> the <span class="built_in">command</span> execution</span><br><span class="line">      --debug                      <span class="built_in">enable</span> debug output</span><br><span class="line">  -h, --<span class="built_in">help</span>                       <span class="built_in">help</span> <span class="keyword">for</span> skopeo</span><br><span class="line">      --insecure-policy            run the tool without any policy check</span><br><span class="line">      --override-arch ARCH         use ARCH instead of the architecture of the machine <span class="keyword">for</span> choosing images</span><br><span class="line">      --override-os OS             use OS instead of the running OS <span class="keyword">for</span> choosing images</span><br><span class="line">      --override-variant VARIANT   use VARIANT instead of the running architecture variant <span class="keyword">for</span> choosing images</span><br><span class="line">      --policy string              Path to a trust policy file</span><br><span class="line">      --registries.d DIR           use registry configuration files <span class="keyword">in</span> DIR (e.g. <span class="keyword">for</span> container signature storage)</span><br><span class="line">      --tmpdir string              directory used to store temporary files</span><br><span class="line">  -v, --version                    Version <span class="keyword">for</span> Skopeo</span><br></pre></td></tr></table></figure>

<p>一下是我在使用 skopeo 命令时候的一些参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--insecure-policy --src-tls-verify=<span class="literal">false</span> --dest-tls-verify=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="IMAGE-NAMES-镜像格式🤔️"><a href="#IMAGE-NAMES-镜像格式🤔️" class="headerlink" title="IMAGE NAMES 镜像格式🤔️"></a>IMAGE NAMES 镜像格式🤔️</h3><p>在使用 skopeo 之前，我们首先要知道在命令行中镜像的格式，下面是官方详细的文档格式。无论我们的 src 镜像还是 dest 镜像都要满足以下格式才可以。</p>
<blockquote>
<p>Most commands refer to container images, using a <em>transport<em><code>:</code></em>details</em> format. The following formats are supported:</p>
</blockquote>
<blockquote>
<p><strong>containers-storage:*</strong>docker-reference* An image located in a local containers/storage image store. Both the location and image store are specified in /etc/containers/storage.conf. (Backend for Podman, CRI-O, Buildah and friends)</p>
</blockquote>
<blockquote>
<p><strong>dir:*</strong>path* An existing local directory <em>path</em> storing the manifest, layer tarballs and signatures as individual files. This is a non-standardized format, primarily useful for debugging or noninvasive container inspection.</p>
</blockquote>
<blockquote>
<p><strong>docker://*</strong>docker-reference* An image in a registry implementing the “Docker Registry HTTP API V2”. By default, uses the authorization state in either <code>$XDG_RUNTIME_DIR/containers/auth.json</code>, which is set using <code>(skopeo login)</code>. If the authorization state is not found there, <code>$HOME/.docker/config.json</code> is checked, which is set using <code>(docker login)</code>.</p>
</blockquote>
<blockquote>
<p><strong>docker-archive:*</strong>path<strong>***[</strong>:<em>*<em>docker-reference</em>] An image is stored in the <code>docker save</code> formatted file. *docker-reference</em> is only used when creating such a file, and it must not contain a digest.</p>
</blockquote>
<blockquote>
<p><strong>docker-daemon:*</strong>docker-reference* An image <em>docker-reference</em> stored in the docker daemon internal storage. <em>docker-reference</em> must contain either a tag or a digest. Alternatively, when reading images, the format can be docker-daemon:algo:digest (an image ID).</p>
</blockquote>
<blockquote>
<p><strong>oci:*</strong>path<strong><em>:</em></strong>tag* An image <em>tag</em> in a directory compliant with “Open Container Image Layout Specification” at <em>path</em>.</p>
</blockquote>
<p>需要注意的是，这几种镜像的名字，对应着镜像存在的方式，不同存在的方式对镜像的 layer 处理的方式也不一样，比如 <code>docker://</code> 这种方式是存在 registry 上的，<code>docker-daemon:</code> 是存在本地 docker pull 下来的，再比如 <code>docker-archive</code> 是通过 docker save 出来的镜像。同一个镜像有这几种存在的方式就像水分子有气体、液体、固体一样。可以这样去理解，他们表述的都是同一个镜像，只不过是存在的方式不一样而已。</p>
<p>IMAGE NAMES（镜像格式）examplecontainers-storage:containers-storage:dir:dir:/PATHdocker://docker://k8s.gcr.io/kube-apiserver:v1.17.5docker-daemon:docker-daemon:alpine:latestdocker-archive:docker-archive:alpine.tar (docker save)oci:oci:alpine:latest</p>
<h3 id="skopeo-login"><a href="#skopeo-login" class="headerlink" title="skopeo login"></a>skopeo login</h3><p>在使用 skopeo 前如果 src 或 dest 镜像是在 registry 中的，如果非 public 的镜像需要相应的 auth 认证，可以使用 docker login 或者 skopeo login 的方式登录到 registry，生成如下格式的 registry 登录配置文件。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ jq "." ~/.docker/config.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"auths"</span>: &#123;</span><br><span class="line">    <span class="attr">"https://index.docker.io/v1/"</span>: &#123;</span><br><span class="line">      <span class="attr">"auth"</span>: <span class="string">"d2sdwdaqWMasss7bSVlJFpmQE43Sw=="</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"HttpHeaders"</span>: &#123;</span><br><span class="line">    <span class="attr">"User-Agent"</span>: <span class="string">"Docker-Client/19.03.5 (linux)"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"experimental"</span>: <span class="string">"enabled"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="skopeo-copy"><a href="#skopeo-copy" class="headerlink" title="skopeo copy"></a>skopeo copy</h3><blockquote>
<p>Copy an IMAGE-NAME from one location to another</p>
</blockquote>
<blockquote>
<p>将一个镜像从 A 复制到 B</p>
</blockquote>
<p>注意一下，这里的 location 就是指的上面提到的 <code>IMAGE NAMES</code> ，也就是说 <code>skopeo copy src dest</code> 可以有6*6=36 种组合！比如我可以将一个镜像从一个 registry 复制到另一个 registry：<code>skopeo copy docker://IMAGE_NAME docker://IMAGE_NAME</code>；或者将一个镜像从 registry 中复制到一个本地目录 <code>skopeo copy docker://k8s.gcr.io/pause:3.3 dir:pause:3.3</code></p>
<ul>
<li>从 regsitry A 到 registry B 复制镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy docker://k8s.gcr.io/kube-apiserver:v1.17.5 docker://hub.k8s.li/kube-apiserver:v1.17.5 --dest-authfile /root/.docker/config.json</span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob 597de8ba0c30 <span class="keyword">done</span></span><br><span class="line">Copying blob e13a88fa950c <span class="keyword">done</span></span><br><span class="line">Copying config f640481f6d <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br></pre></td></tr></table></figure>

<blockquote>
<p>skopeo 输出的日志显示是 Copying blob 597de8ba0c30 done.可以看到 skopeo 是直接从 registry 中 copy 镜像 layer 的 blob 文件，传输是镜像在 registry 中存储的原始格式。</p>
</blockquote>
<ul>
<li>将镜像从 registry 复制到本地目录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy docker://k8s.gcr.io/pause:3.3 dir:pause:3.3</span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob aeab776c4837 <span class="keyword">done</span></span><br><span class="line">Copying config 0184c1613d <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line">$ tree pause:3.3</span><br><span class="line">pause:3.3</span><br><span class="line">├── 0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da</span><br><span class="line">├── aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b</span><br><span class="line">├── manifest.json</span><br><span class="line">└── version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看镜像的 manifest 文件</span></span><br><span class="line"></span><br><span class="line">$ jq <span class="string">'.'</span> pause:3.3/manifest.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"schemaVersion"</span>: 2,</span><br><span class="line">  <span class="string">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">  <span class="string">"config"</span>: &#123;</span><br><span class="line">    <span class="string">"mediaType"</span>: <span class="string">"application/vnd.docker.container.image.v1+json"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 743,</span><br><span class="line">    <span class="string">"digest"</span>: <span class="string">"sha256:0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"layers"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"mediaType"</span>: <span class="string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span>,</span><br><span class="line">      <span class="string">"size"</span>: 296517,</span><br><span class="line">      <span class="string">"digest"</span>: <span class="string">"sha256:aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据 manifest 文件查看镜像的 image config 文件</span></span><br><span class="line"></span><br><span class="line">$ jq <span class="string">'.'</span> pause:3.3/0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">  <span class="string">"config"</span>: &#123;</span><br><span class="line">    <span class="string">"Env"</span>: [</span><br><span class="line">      <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"Entrypoint"</span>: [</span><br><span class="line">      <span class="string">"/pause"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"WorkingDir"</span>: <span class="string">"/"</span>,</span><br><span class="line">    <span class="string">"OnBuild"</span>: null</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"created"</span>: <span class="string">"2020-05-02T09:46:29.068489061Z"</span>,</span><br><span class="line">  <span class="string">"history"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"created"</span>: <span class="string">"2020-05-02T09:46:29.068489061Z"</span>,</span><br><span class="line">      <span class="string">"created_by"</span>: <span class="string">"ARG ARCH"</span>,</span><br><span class="line">      <span class="string">"comment"</span>: <span class="string">"buildkit.dockerfile.v0"</span>,</span><br><span class="line">      <span class="string">"empty_layer"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"created"</span>: <span class="string">"2020-05-02T09:46:29.068489061Z"</span>,</span><br><span class="line">      <span class="string">"created_by"</span>: <span class="string">"ADD bin/pause-amd64 /pause # buildkit"</span>,</span><br><span class="line">      <span class="string">"comment"</span>: <span class="string">"buildkit.dockerfile.v0"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"created"</span>: <span class="string">"2020-05-02T09:46:29.068489061Z"</span>,</span><br><span class="line">      <span class="string">"created_by"</span>: <span class="string">"ENTRYPOINT [\"/pause\"]"</span>,</span><br><span class="line">      <span class="string">"comment"</span>: <span class="string">"buildkit.dockerfile.v0"</span>,</span><br><span class="line">      <span class="string">"empty_layer"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">  <span class="string">"rootfs"</span>: &#123;</span><br><span class="line">    <span class="string">"type"</span>: <span class="string">"layers"</span>,</span><br><span class="line">    <span class="string">"diff_ids"</span>: [</span><br><span class="line">      <span class="string">"sha256:48a5e87615149095fad57d5db80f2cd9728b5562900eccb32842a45e8e8a61ae"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将镜像从 registry 复制到本地目录，以 OCI 格式保存</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy docker://k8s.gcr.io/pause:3.3 oci:images</span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob aeab776c4837 <span class="keyword">done</span></span><br><span class="line">Copying config fa5df7713f <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line">$ tree images</span><br><span class="line">images</span><br><span class="line">├── blobs</span><br><span class="line">│   └── sha256</span><br><span class="line">│       ├── 3450ba84b8fbfd12cbf58710c0b5678f4311a888d4d5c42b053faefa1af4f8be</span><br><span class="line">│       ├── aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b</span><br><span class="line">│       └── fa5df7713fc78f96e377d236b353d33815073105bbacd381e50705e576ce4da5</span><br><span class="line">├── index.json</span><br><span class="line">└── oci-layout</span><br></pre></td></tr></table></figure>

<ul>
<li>替代 docker push 功能，将镜像从 docker 本地存储 push 到 registry 中</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo copy docker-daemon:alpine:3.12 docker://hub.k8s.li/library/alpine:3.12</span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob 32f366d666a5 <span class="keyword">done</span></span><br><span class="line">Copying config 13621d1b12 <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br></pre></td></tr></table></figure>

<h3 id="skopeo-sync"><a href="#skopeo-sync" class="headerlink" title="skopeo sync"></a>skopeo sync</h3><p>Skopeo sync 的功能基本上等同于阿里云的 <a href="https://github.com/AliyunContainerService/image-syncer" target="_blank" rel="noopener">image-syncer</a> 工具，不过个人觉着 skopeo 要比 image-syncer 更强大，灵活性更强一些，汝还在使用 image-syncer 的话，强烈建议你使用 skopeo sync 替代它😂。</p>
<ul>
<li>skopeo sync 镜像同步文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">registry.example.com:</span></span><br><span class="line">    <span class="attr">images:</span></span><br><span class="line">        <span class="attr">busybox:</span> <span class="string">[]</span></span><br><span class="line">        <span class="attr">redis:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"1.0"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"2.0"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"sha256:111111"</span></span><br><span class="line">    <span class="attr">images-by-tag-regex:</span></span><br><span class="line">        <span class="attr">nginx:</span> <span class="string">^1\.13\.[12]-alpine-perl$</span></span><br><span class="line">    <span class="attr">credentials:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">john</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">this</span> <span class="string">is</span> <span class="string">a</span> <span class="string">secret</span></span><br><span class="line">    <span class="attr">tls-verify:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cert-dir:</span> <span class="string">/home/john/certs</span></span><br><span class="line"><span class="attr">quay.io:</span></span><br><span class="line">    <span class="attr">tls-verify:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">images:</span></span><br><span class="line">        <span class="attr">coreos/etcd:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">latest</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Image-syncer 镜像同步配置文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># registry 登录配置</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line">    <span class="attr">"quay.io":</span> <span class="string">&#123;</span>        <span class="string">//</span> <span class="string">This</span> <span class="string">"registry"</span> <span class="string">or</span> <span class="string">"registry/namespace"</span> <span class="string">string</span> <span class="string">should</span> <span class="string">be</span> <span class="string">the</span> <span class="string">same</span> <span class="string">as</span> <span class="string">registry</span> <span class="string">or</span> <span class="string">registry/namespace</span> <span class="string">used</span> <span class="string">below</span> <span class="string">in</span> <span class="string">"images"</span> <span class="string">field.</span></span><br><span class="line">                            <span class="string">//</span> <span class="string">The</span> <span class="string">format</span> <span class="string">of</span> <span class="string">"registry/namespace"</span> <span class="string">will</span> <span class="string">be</span> <span class="string">more</span> <span class="string">prior</span> <span class="string">matched</span> <span class="string">than</span> <span class="string">"registry"</span></span><br><span class="line">        <span class="attr">"username":</span> <span class="string">"xxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"password":</span> <span class="string">"xxxxxxxxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"insecure":</span> <span class="literal">true</span>         <span class="string">//</span> <span class="string">"insecure"</span> <span class="string">field</span> <span class="string">needs</span> <span class="string">to</span> <span class="string">be</span> <span class="literal">true</span> <span class="string">if</span> <span class="string">this</span> <span class="string">registry</span> <span class="string">is</span> <span class="string">a</span> <span class="string">http</span> <span class="string">service,</span> <span class="string">default</span> <span class="string">value</span> <span class="string">is</span> <span class="literal">false</span><span class="string">,</span> <span class="string">version</span> <span class="string">of</span> <span class="string">image-syncer</span> <span class="string">need</span> <span class="string">to</span> <span class="string">be</span> <span class="string">later</span> <span class="string">than</span> <span class="string">v1.0.1</span> <span class="string">to</span> <span class="string">support</span> <span class="string">this</span> <span class="string">field</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="attr">"registry.cn-beijing.aliyuncs.com":</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">"username":</span> <span class="string">"xxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"password":</span> <span class="string">"xxxxxxxxx"</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="attr">"registry.hub.docker.com":</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">"username":</span> <span class="string">"xxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"password":</span> <span class="string">"xxxxxxxxxx"</span></span><br><span class="line">    <span class="string">&#125;,</span></span><br><span class="line">    <span class="attr">"quay.io/coreos":</span> <span class="string">&#123;</span>     <span class="string">//</span> <span class="string">"registry/namespace"</span> <span class="string">format</span> <span class="string">is</span> <span class="string">supported</span> <span class="string">after</span> <span class="string">v1.0.3</span> <span class="string">of</span> <span class="string">image-syncer</span></span><br><span class="line">        <span class="attr">"username":</span> <span class="string">"abc"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"password":</span> <span class="string">"xxxxxxxxx"</span><span class="string">,</span></span><br><span class="line">        <span class="attr">"insecure":</span> <span class="literal">true</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="comment"># 镜像配置</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line">    <span class="attr">"quay.io/coreos/kube-rbac-proxy":</span> <span class="string">"quay.io/ruohe/kube-rbac-proxy"</span><span class="string">,</span></span><br><span class="line">    <span class="string">"xxxx"</span><span class="string">:"xxxxx",</span></span><br><span class="line">    <span class="string">"xxx/xxx/xx:tag1,tag2,tag3"</span><span class="string">:"xxx/xxx/xx"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>将镜从 registry A 同步到 registry B</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --src docker --dest docker k8s.gcr.io/pause:3.3 hub.k8s.li</span><br><span class="line">INFO[0000] Tag presence check                            imagename=<span class="string">"k8s.gcr.io/pause:3.3"</span> tagged=<span class="literal">true</span></span><br><span class="line">INFO[0000] Copying image tag 1/1                         from=<span class="string">"docker://k8s.gcr.io/pause:3.3"</span> to=<span class="string">"docker://hub.k8s.li/pause:3.3"</span></span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob aeab776c4837 <span class="keyword">done</span></span><br><span class="line">Copying config 0184c1613d <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line">INFO[0000] Synced 1 images from 1 sources</span><br></pre></td></tr></table></figure>

<ul>
<li>将一个镜像从 registry 中同步到本地目录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --src docker --dest dir k8s.gcr.io/pause:3.3 images</span><br><span class="line">images</span><br><span class="line">└── pause:3.3</span><br><span class="line">    ├── 0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da</span><br><span class="line">    ├── aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b</span><br><span class="line">    ├── manifest.json</span><br><span class="line">    └── version</span><br></pre></td></tr></table></figure>

<ul>
<li>将镜像从本地目录同步到 registry 中</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo sync --src dir --dest docker images hub.k8s.li</span><br><span class="line">INFO[0000] Copying image ref 1/1                         from=<span class="string">"dir:images/pause:3.3"</span> to=<span class="string">"docker://hub.k8s.li/pause:3.3"</span></span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob aeab776c4837 [--------------------------------------] 0.0b / 0.0b</span><br><span class="line">Copying config 0184c1613d <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line">INFO[0002] Synced 1 images from 1 sources</span><br></pre></td></tr></table></figure>

<h3 id="skopeo-inspect"><a href="#skopeo-inspect" class="headerlink" title="skopeo inspect"></a>skopeo inspect</h3><p>这个命令可以查看一个镜像的 image config 或者 manifests 文件，和 docker inspect 命令差不多。不加 –raw 参数默认是查看镜像的 image config 文件，加上 –raw 参数就是查看镜像的 manifest 文件。</p>
<ul>
<li>查看 docker 本地存储中的一个镜像的 image config 文件</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo inspect docker-daemon:alpine:latest</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Name"</span>: <span class="string">"docker.io/library/alpine"</span>,</span><br><span class="line">    <span class="attr">"Digest"</span>: <span class="string">"sha256:ab84514e85b179ff569fd0042969b04f68812f23e187a927cb84664b417e0d3e"</span>,</span><br><span class="line">    <span class="attr">"RepoTags"</span>: [],</span><br><span class="line">    <span class="attr">"Created"</span>: <span class="string">"2021-04-14T19:19:49.594730611Z"</span>,</span><br><span class="line">    <span class="attr">"DockerVersion"</span>: <span class="string">"19.03.12"</span>,</span><br><span class="line">    <span class="attr">"Labels"</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">"Architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">    <span class="attr">"Os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">    <span class="attr">"Layers"</span>: [</span><br><span class="line">        <span class="string">"sha256:32f366d666a541852cad754ee1cdb53a736110b550f0c2d5a46bc5ba519896b6"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"Env"</span>: [</span><br><span class="line">        <span class="string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看 registry 中一个镜像的 manifests 文件，可以通过这种方式来判断镜像是否存在</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">skopeo inspect docker://alpine:latest --raw | jq '.'</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"manifests"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:1775bebec23e1f3ce486989bfc9ff3c4e951690df84aa9f926497d82f2ffca9d"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"amd64"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:1f66b8f3041ef8575260056dedd437ed94e7bfeea142ee39ff0d795f94ff2287"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"arm"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">        <span class="attr">"variant"</span>: <span class="string">"v6"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:8d99168167baa6a6a0d7851b9684625df9c1455116a9601835c2127df2aaa2f5"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"arm"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">        <span class="attr">"variant"</span>: <span class="string">"v7"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:53b74ddfc6225e3c8cc84d7985d0f34666e4e8b0b6892a9b2ad1f7516bc21b54"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"arm64"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span>,</span><br><span class="line">        <span class="attr">"variant"</span>: <span class="string">"v8"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:52a197664c8ed0b4be6d3b8372f1d21f3204822ba432583644c9ce07f7d6448f"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"386"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:b421672fe4e74a3c7eff2775736e854d69e8d38b2c337063f8699de9c408ddd3"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"ppc64le"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"digest"</span>: <span class="string">"sha256:8a22269106a31264874cc3a719c1e280e76d42dff1fa57bd9c7fe68dab574023"</span>,</span><br><span class="line">      <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.v2+json"</span>,</span><br><span class="line">      <span class="attr">"platform"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"s390x"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: <span class="string">"linux"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"size"</span>: <span class="number">528</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"mediaType"</span>: <span class="string">"application/vnd.docker.distribution.manifest.list.v2+json"</span>,</span><br><span class="line">  <span class="attr">"schemaVersion"</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="skopeo-delete"><a href="#skopeo-delete" class="headerlink" title="skopeo delete"></a>skopeo delete</h3><p>使用这个命令可以删除镜像 tag。需要注意的是，通过  registry API 来删除镜像的 tag 仅仅是删除了 tag 对 manifests 文件的引用，并非真正将镜像删除掉。如果想要删除镜像的 layer 还是需要通过 registry GC 的方式，可参考之前写过的一篇博客《<a href="https://blog.k8s.li/registry-gc.html">docker registry GC 原理分析</a>》</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo delete docker:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;pause:3.2 --debug</span><br><span class="line">DEBU[0000] Returning credentials from &#x2F;home&#x2F;release&#x2F;.docker&#x2F;config.json</span><br><span class="line">DEBU[0000] Using registries.d directory &#x2F;etc&#x2F;containers&#x2F;registries.d for sigstore configuration</span><br><span class="line">DEBU[0000]  No signature storage configuration found for hub.k8s.li&#x2F;library&#x2F;pause:3.2</span><br><span class="line">DEBU[0000] Looking for TLS certificates and private keys in &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;hub.k8s.li&#x2F;library</span><br><span class="line">DEBU[0000] Loading registries configuration &quot;&#x2F;etc&#x2F;containers&#x2F;registries.conf&quot;</span><br><span class="line">DEBU[0000] GET https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;</span><br><span class="line">DEBU[0000] Ping https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F; status 401</span><br><span class="line">DEBU[0000] GET https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;library&#x2F;pause&#x2F;manifests&#x2F;3.2</span><br><span class="line">DEBU[0000] DELETE https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;library&#x2F;pause&#x2F;manifests&#x2F;sha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108</span><br></pre></td></tr></table></figure>

<h3 id="skopeo-list-tags"><a href="#skopeo-list-tags" class="headerlink" title="skopeo list-tags"></a>skopeo list-tags</h3><p>这个命令可用于列出 registry 上的某个镜像的所有 tag ，使用标准的 registry API 来获取镜像 tag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ skopeo list-tags docker:&#x2F;&#x2F;k8s.gcr.io&#x2F;pause</span><br><span class="line">&#123;</span><br><span class="line">    &quot;Repository&quot;: &quot;k8s.gcr.io&#x2F;pause&quot;,</span><br><span class="line">    &quot;Tags&quot;: [</span><br><span class="line">        &quot;0.8.0&quot;,</span><br><span class="line">        &quot;1.0&quot;,</span><br><span class="line">        &quot;2.0&quot;,</span><br><span class="line">        &quot;3.0&quot;,</span><br><span class="line">        &quot;3.1&quot;,</span><br><span class="line">        &quot;3.2&quot;,</span><br><span class="line">        &quot;3.3&quot;,</span><br><span class="line">        &quot;3.4.1&quot;,</span><br><span class="line">        &quot;3.5&quot;,</span><br><span class="line">        &quot;go&quot;,</span><br><span class="line">        &quot;latest&quot;,</span><br><span class="line">        &quot;test&quot;,</span><br><span class="line">        &quot;test2&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><p>一下给出几个 skopeo 工具的最佳实践 😊</p>
<h3 id="镜像同步"><a href="#镜像同步" class="headerlink" title="镜像同步"></a>镜像同步</h3><p>假如给你一个镜像列表，如 <a href="https://github.com/kubesphere/ks-installer/blob/master/scripts/images-list.txt。如何将它快速地从一个" target="_blank" rel="noopener">https://github.com/kubesphere/ks-installer/blob/master/scripts/images-list.txt。如何将它快速地从一个</a> registry 同步到另一个 registry 中呢？还是 skopeo copy 走起！</p>
<ul>
<li>images-list.txt</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line">##k8s-images</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.20.6</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.19.8</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.19.8</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.19.8</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.19.8</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.19.9</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.19.9</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.19.9</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.19.9</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.18.8</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.18.8</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.18.8</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.18.8</span><br><span class="line">kubesphere&#x2F;kube-apiserver:v1.17.9</span><br><span class="line">kubesphere&#x2F;kube-scheduler:v1.17.9</span><br><span class="line">kubesphere&#x2F;kube-proxy:v1.17.9</span><br><span class="line">kubesphere&#x2F;kube-controller-manager:v1.17.9</span><br><span class="line">kubesphere&#x2F;pause:3.1</span><br><span class="line">kubesphere&#x2F;pause:3.2</span><br><span class="line">kubesphere&#x2F;etcd:v3.4.13</span><br><span class="line">calico&#x2F;cni:v3.16.3</span><br><span class="line">calico&#x2F;kube-controllers:v3.16.3</span><br><span class="line">calico&#x2F;node:v3.16.3</span><br><span class="line">calico&#x2F;pod2daemon-flexvol:v3.16.3</span><br><span class="line">calico&#x2F;typha:v3.16.3</span><br><span class="line">kubesphere&#x2F;flannel:v0.12.0</span><br><span class="line">coredns&#x2F;coredns:1.6.9</span><br><span class="line">kubesphere&#x2F;k8s-dns-node-cache:1.15.12</span><br><span class="line">openebs&#x2F;provisioner-localpv:2.10.1</span><br><span class="line">openebs&#x2F;linux-utils:2.10.0</span><br><span class="line">kubesphere&#x2F;nfs-client-provisioner:v3.1.0-k8s1.11</span><br><span class="line">##csi-images</span><br><span class="line">csiplugin&#x2F;csi-neonsan:v1.2.0</span><br><span class="line">csiplugin&#x2F;csi-neonsan-ubuntu:v1.2.0</span><br><span class="line">csiplugin&#x2F;csi-neonsan-centos:v1.2.0</span><br><span class="line">csiplugin&#x2F;csi-provisioner:v1.5.0</span><br><span class="line">csiplugin&#x2F;csi-attacher:v2.1.1</span><br><span class="line">csiplugin&#x2F;csi-resizer:v0.4.0</span><br><span class="line">csiplugin&#x2F;csi-snapshotter:v2.0.1</span><br><span class="line">csiplugin&#x2F;csi-node-driver-registrar:v1.2.0</span><br><span class="line">csiplugin&#x2F;csi-qingcloud:v1.2.0</span><br><span class="line">##kubesphere-images</span><br><span class="line">kubesphere&#x2F;ks-apiserver:v3.1.1</span><br><span class="line">kubesphere&#x2F;ks-console:v3.1.1</span><br><span class="line">kubesphere&#x2F;ks-controller-manager:v3.1.1</span><br><span class="line">kubesphere&#x2F;ks-installer:v3.1.1</span><br><span class="line">kubesphere&#x2F;kubectl:v1.20.0</span><br><span class="line">kubesphere&#x2F;kubectl:v1.19.0</span><br><span class="line">redis:5.0.12-alpine</span><br><span class="line">alpine:3.14</span><br><span class="line">haproxy:2.0.22-alpine</span><br><span class="line">nginx:1.14-alpine</span><br><span class="line">minio&#x2F;minio:RELEASE.2019-08-07T01-59-21Z</span><br><span class="line">minio&#x2F;mc:RELEASE.2019-08-07T23-14-43Z</span><br><span class="line">mirrorgooglecontainers&#x2F;defaultbackend-amd64:1.4</span><br><span class="line">kubesphere&#x2F;nginx-ingress-controller:v0.35.0</span><br><span class="line">osixia&#x2F;openldap:1.3.0</span><br><span class="line">csiplugin&#x2F;snapshot-controller:v3.0.3</span><br><span class="line">kubesphere&#x2F;kubefed:v0.7.0</span><br><span class="line">kubesphere&#x2F;tower:v0.2.0</span><br><span class="line">kubesphere&#x2F;prometheus-config-reloader:v0.42.1</span><br><span class="line">kubesphere&#x2F;prometheus-operator:v0.42.1</span><br><span class="line">prom&#x2F;alertmanager:v0.21.0</span><br><span class="line">prom&#x2F;prometheus:v2.26.0</span><br><span class="line">prom&#x2F;node-exporter:v0.18.1</span><br><span class="line">kubesphere&#x2F;ks-alerting-migration:v3.1.0</span><br><span class="line">jimmidyson&#x2F;configmap-reload:v0.3.0</span><br><span class="line">kubesphere&#x2F;notification-manager-operator:v1.0.0</span><br><span class="line">kubesphere&#x2F;notification-manager:v1.0.0</span><br><span class="line">kubesphere&#x2F;metrics-server:v0.4.2</span><br><span class="line">kubesphere&#x2F;kube-rbac-proxy:v0.8.0</span><br><span class="line">kubesphere&#x2F;kube-state-metrics:v1.9.7</span><br><span class="line">openebs&#x2F;provisioner-localpv:2.3.0</span><br><span class="line">thanosio&#x2F;thanos:v0.18.0</span><br><span class="line">grafana&#x2F;grafana:7.4.3</span><br><span class="line">##kubesphere-logging-images</span><br><span class="line">kubesphere&#x2F;elasticsearch-oss:6.7.0-1</span><br><span class="line">kubesphere&#x2F;elasticsearch-curator:v5.7.6</span><br><span class="line">kubesphere&#x2F;fluentbit-operator:v0.5.0</span><br><span class="line">kubesphere&#x2F;fluentbit-operator:migrator</span><br><span class="line">kubesphere&#x2F;fluent-bit:v1.6.9</span><br><span class="line">elastic&#x2F;filebeat:6.7.0</span><br><span class="line">kubesphere&#x2F;kube-auditing-operator:v0.1.2</span><br><span class="line">kubesphere&#x2F;kube-auditing-webhook:v0.1.2</span><br><span class="line">kubesphere&#x2F;kube-events-exporter:v0.1.0</span><br><span class="line">kubesphere&#x2F;kube-events-operator:v0.1.0</span><br><span class="line">kubesphere&#x2F;kube-events-ruler:v0.2.0</span><br><span class="line">kubesphere&#x2F;log-sidecar-injector:1.1</span><br><span class="line">docker:19.03</span><br><span class="line">##istio-images</span><br><span class="line">istio&#x2F;pilot:1.6.10</span><br><span class="line">istio&#x2F;proxyv2:1.6.10</span><br><span class="line">jaegertracing&#x2F;jaeger-agent:1.17</span><br><span class="line">jaegertracing&#x2F;jaeger-collector:1.17</span><br><span class="line">jaegertracing&#x2F;jaeger-es-index-cleaner:1.17</span><br><span class="line">jaegertracing&#x2F;jaeger-operator:1.17.1</span><br><span class="line">jaegertracing&#x2F;jaeger-query:1.17</span><br><span class="line">kubesphere&#x2F;kiali:v1.26.1</span><br><span class="line">kubesphere&#x2F;kiali-operator:v1.26.1</span><br><span class="line">##kubesphere-devops-images</span><br><span class="line">kubesphere&#x2F;ks-jenkins:2.249.1</span><br><span class="line">jenkins&#x2F;jnlp-slave:3.27-1</span><br><span class="line">kubesphere&#x2F;s2ioperator:v3.1.0</span><br><span class="line">kubesphere&#x2F;s2irun:v2.1.1</span><br><span class="line">kubesphere&#x2F;builder-base:v3.1.0</span><br><span class="line">kubesphere&#x2F;builder-nodejs:v3.1.0</span><br><span class="line">kubesphere&#x2F;builder-maven:v3.1.0</span><br><span class="line">kubesphere&#x2F;builder-go:v3.1.0</span><br><span class="line">kubesphere&#x2F;s2i-binary:v2.1.0</span><br><span class="line">kubesphere&#x2F;tomcat85-java11-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;tomcat85-java11-runtime:v2.1.0</span><br><span class="line">kubesphere&#x2F;tomcat85-java8-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;tomcat85-java8-runtime:v2.1.0</span><br><span class="line">kubesphere&#x2F;java-11-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;java-8-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;java-8-runtime:v2.1.0</span><br><span class="line">kubesphere&#x2F;java-11-runtime:v2.1.0</span><br><span class="line">kubesphere&#x2F;nodejs-8-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;nodejs-6-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;nodejs-4-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;python-36-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;python-35-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;python-34-centos7:v2.1.0</span><br><span class="line">kubesphere&#x2F;python-27-centos7:v2.1.0</span><br><span class="line">##openpitrix-images</span><br><span class="line">kubespheredev&#x2F;openpitrix-jobs:v3.1.1</span><br><span class="line">##weave-scope-images</span><br><span class="line">weaveworks&#x2F;scope:1.13.0</span><br><span class="line">##kubeedge-images</span><br><span class="line">kubeedge&#x2F;cloudcore:v1.6.2</span><br><span class="line">kubesphere&#x2F;edge-watcher:v0.1.0</span><br><span class="line">kubesphere&#x2F;kube-rbac-proxy:v0.5.0</span><br><span class="line">kubesphere&#x2F;edge-watcher-agent:v0.1.0</span><br><span class="line">##example-images-images</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-productpage-v1:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-reviews-v1:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-reviews-v2:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-reviews-v3:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-details-v1:1.16.2</span><br><span class="line">kubesphere&#x2F;examples-bookinfo-ratings-v1:1.16.3</span><br><span class="line">busybox:1.31.1</span><br><span class="line">joosthofman&#x2F;wget:1.0</span><br><span class="line">kubesphere&#x2F;netshoot:v1.0</span><br><span class="line">nginxdemos&#x2F;hello:plain-text</span><br><span class="line">wordpress:4.8-apache</span><br><span class="line">mirrorgooglecontainers&#x2F;hpa-example:latest</span><br><span class="line">java:openjdk-8-jre-alpine</span><br><span class="line">fluent&#x2F;fluentd:v1.4.2-2.0</span><br><span class="line">perl:latest</span><br></pre></td></tr></table></figure>

<ul>
<li>sync.sh</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">GREEN_COL=<span class="string">"\\033[32;1m"</span></span><br><span class="line">RED_COL=<span class="string">"\\033[1;31m"</span></span><br><span class="line">NORMAL_COL=<span class="string">"\\033[0;39m"</span></span><br><span class="line">SOURCE_REGISTRY=<span class="variable">$1</span></span><br><span class="line">TARGET_REGISTRY=<span class="variable">$2</span></span><br><span class="line">: <span class="variable">$&#123;IMAGES_LIST_FILE:="images-list.txt"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;TARGET_REGISTRY:="hub.k8s.li"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;SOURCE_REGISTRY:="docker.io"&#125;</span></span><br><span class="line"></span><br><span class="line">BLOBS_PATH=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">REPO_PATH=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line"></span><br><span class="line">CURRENT_NUM=0</span><br><span class="line">ALL_IMAGES=<span class="string">"<span class="variable">$(sed -n '/#/d;s/:/:/p' $&#123;IMAGES_LIST_FILE&#125; | sort -u)</span>"</span></span><br><span class="line">TOTAL_NUMS=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;ALL_IMAGES&#125;</span>"</span> | wc -l)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">skopeo_copy</span></span>() &#123;</span><br><span class="line"> <span class="keyword">if</span> skopeo copy --insecure-policy --src-tls-verify=<span class="literal">false</span> --dest-tls-verify=<span class="literal">false</span> \</span><br><span class="line"> --override-arch amd64 --override-os linux -q docker://<span class="variable">$1</span> docker://<span class="variable">$2</span>; <span class="keyword">then</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$GREEN_COL</span> Progress: <span class="variable">$&#123;CURRENT_NUM&#125;</span>/<span class="variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="variable">$1</span> to <span class="variable">$2</span> successful <span class="variable">$NORMAL_COL</span>"</span></span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$RED_COL</span> Progress: <span class="variable">$&#123;CURRENT_NUM&#125;</span>/<span class="variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="variable">$1</span> to <span class="variable">$2</span> failed <span class="variable">$NORMAL_COL</span>"</span></span><br><span class="line"> <span class="built_in">exit</span> 2</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> <span class="variable">$&#123;ALL_IMAGES&#125;</span>; <span class="keyword">do</span></span><br><span class="line"> <span class="built_in">let</span> CURRENT_NUM=<span class="variable">$&#123;CURRENT_NUM&#125;</span>+1</span><br><span class="line"> skopeo_copy <span class="variable">$&#123;SOURCE_REGISTRY&#125;</span>/<span class="variable">$&#123;image&#125;</span> <span class="variable">$&#123;TARGET_REGISTRY&#125;</span>/<span class="variable">$&#123;image&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>bash sync.sh docker.io ``localhost:5000</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ bash sync.sh docker.io localhost:5000</span><br><span class="line">Progress: 1/143 sync docker.io/alpine:3.14 to localhost:5000/alpine:3.14 successful</span><br><span class="line">Progress: 2/143 sync docker.io/busybox:1.31.1 to localhost:5000/busybox:1.31.1 successful</span><br><span class="line">Progress: 3/143 sync docker.io/calico/cni:v3.16.3 to localhost:5000/calico/cni:v3.16.3 successful</span><br><span class="line">Progress: 4/143 sync docker.io/calico/kube-controllers:v3.16.3 to localhost:5000/calico/kube-controllers:v3.16.3 successful</span><br><span class="line">Progress: 141/143 sync docker.io/thanosio/thanos:v0.18.0 to localhost:5000/thanosio/thanos:v0.18.0 successful</span><br><span class="line">Progress: 142/143 sync docker.io/weaveworks/scope:1.13.0 to localhost:5000/weaveworks/scope:1.13.0 successful</span><br><span class="line">Progress: 143/143 sync docker.io/wordpress:4.8-apache to localhost:5000/wordpress:4.8-apache successful</span><br></pre></td></tr></table></figure>

<h3 id="使用-registry-存储特性"><a href="#使用-registry-存储特性" class="headerlink" title="使用 registry 存储特性"></a>使用 registry 存储特性</h3><p>将镜像从 registry 中同步到本地目录，使用 registry 存储的特性，将本地目录中的镜像转换成 registry 存储的格式。这样子的好处就是可以去除一些 skopeo dir 中重复的 layers，减少镜像的总大小。具体的原理可以参考我之前写过的 《<a href="https://blog.k8s.li/skopeo-to-registry.html">如何使用 registry 存储的特性</a>》</p>
<ul>
<li>sync.sh</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">GREEN_COL=<span class="string">"\\033[32;1m"</span></span><br><span class="line">RED_COL=<span class="string">"\\033[1;31m"</span></span><br><span class="line">NORMAL_COL=<span class="string">"\\033[0;39m"</span></span><br><span class="line">SOURCE_REGISTRY=<span class="variable">$1</span></span><br><span class="line">TARGET_REGISTRY=<span class="variable">$2</span></span><br><span class="line">IMAGES_DIR=<span class="variable">$2</span></span><br><span class="line">: <span class="variable">$&#123;IMAGES_DIR:="images"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;IMAGES_LIST_FILE:="images-list.txt"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;TARGET_REGISTRY:="hub.k8s.li"&#125;</span></span><br><span class="line">: <span class="variable">$&#123;SOURCE_REGISTRY:="docker.io"&#125;</span></span><br><span class="line">BLOBS_PATH=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">REPO_PATH=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line">CURRENT_NUM=0</span><br><span class="line">ALL_IMAGES=<span class="string">"<span class="variable">$(sed -n '/#/d;s/:/:/p' $&#123;IMAGES_LIST_FILE&#125; | sort -u)</span>"</span></span><br><span class="line">TOTAL_NUMS=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;ALL_IMAGES&#125;</span>"</span> | wc -l)</span><br><span class="line"><span class="function"><span class="title">skopeo_sync</span></span>() &#123;</span><br><span class="line"> <span class="keyword">if</span> skopeo sync --insecure-policy --src-tls-verify=<span class="literal">false</span> --dest-tls-verify=<span class="literal">false</span> \</span><br><span class="line"> --override-arch amd64 --override-os linux --src docker --dest dir <span class="variable">$1</span> <span class="variable">$2</span> &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$GREEN_COL</span> Progress: <span class="variable">$&#123;CURRENT_NUM&#125;</span>/<span class="variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="variable">$1</span> to <span class="variable">$2</span> successful <span class="variable">$NORMAL_COL</span>"</span></span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> <span class="built_in">echo</span> -e <span class="string">"<span class="variable">$RED_COL</span> Progress: <span class="variable">$&#123;CURRENT_NUM&#125;</span>/<span class="variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="variable">$1</span> to <span class="variable">$2</span> failed <span class="variable">$NORMAL_COL</span>"</span></span><br><span class="line"> <span class="built_in">exit</span> 2</span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">convert_images</span></span>() &#123;</span><br><span class="line"> rm -rf <span class="variable">$&#123;IMAGES_DIR&#125;</span>; mkdir -p <span class="variable">$&#123;IMAGES_DIR&#125;</span></span><br><span class="line"> <span class="keyword">for</span> image <span class="keyword">in</span> <span class="variable">$&#123;ALL_IMAGES&#125;</span>; <span class="keyword">do</span></span><br><span class="line"> <span class="built_in">let</span> CURRENT_NUM=<span class="variable">$&#123;CURRENT_NUM&#125;</span>+1</span><br><span class="line"> image_name=<span class="variable">$&#123;image%%:*&#125;</span></span><br><span class="line"> image_tag=<span class="variable">$&#123;image##*:&#125;</span></span><br><span class="line"> image_repo=<span class="variable">$&#123;image%%/*&#125;</span></span><br><span class="line"> skopeo_sync <span class="variable">$&#123;SOURCE_REGISTRY&#125;</span>/<span class="variable">$&#123;image&#125;</span> <span class="variable">$&#123;IMAGES_DIR&#125;</span>/<span class="variable">$&#123;image_repo&#125;</span></span><br><span class="line"> manifest=<span class="string">"<span class="variable">$&#123;IMAGES_DIR&#125;</span>/<span class="variable">$&#123;image&#125;</span>/manifest.json"</span></span><br><span class="line"> manifest_sha256=$(sha256sum <span class="variable">$&#123;manifest&#125;</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line"> mkdir -p <span class="variable">$&#123;BLOBS_PATH&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line"> ln -f <span class="variable">$&#123;manifest&#125;</span> <span class="variable">$&#123;BLOBS_PATH&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span>/data</span><br><span class="line"> <span class="comment"># make image repositories dir</span></span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/&#123;_uploads,_layers,_manifests&#125;</span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/&#123;current,index/sha256&#125;</span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line"> <span class="comment"># create image tag manifest link file</span></span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/current/link</span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br><span class="line"> <span class="comment"># link image layers file to registry blobs dir</span></span><br><span class="line"> <span class="keyword">for</span> layer <span class="keyword">in</span> $(sed <span class="string">'/v1Compatibility/d'</span> <span class="variable">$&#123;manifest&#125;</span> | grep -Eo <span class="string">"\b[a-f0-9]&#123;64&#125;\b"</span>); <span class="keyword">do</span></span><br><span class="line"> mkdir -p <span class="variable">$&#123;BLOBS_PATH&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line"> mkdir -p <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line"> <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;layer&#125;</span>"</span> &gt; <span class="variable">$&#123;REPO_PATH&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span>/link</span><br><span class="line"> ln -f <span class="variable">$&#123;IMAGES_DIR&#125;</span>/<span class="variable">$&#123;image&#125;</span>/<span class="variable">$&#123;layer&#125;</span> <span class="variable">$&#123;BLOBS_PATH&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data</span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line"> <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">convert_images</span><br></pre></td></tr></table></figure>

<ul>
<li>install.sh</li>
</ul>
<p>使用这个脚本将 registry 存储中的镜像转换成 skopeo dir 的方式，然后再将镜像同步到 registry 中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">REGISTRY_DOMAIN=<span class="string">"harbor.k8s.li"</span></span><br><span class="line">REGISTRY_PATH=<span class="string">"/var/lib/registry"</span></span><br><span class="line"><span class="comment"># 切换到 registry 存储主目录下</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;REGISTRY_PATH&#125;</span></span><br><span class="line"><span class="function"><span class="title">gen_skopeo_dir</span></span>() &#123;</span><br><span class="line">   <span class="comment"># 定义 registry 存储的 blob 目录 和 repositories 目录，方便后面使用</span></span><br><span class="line">    BLOB_DIR=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">    REPO_DIR=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line">    <span class="comment"># 定义生成 skopeo 目录</span></span><br><span class="line">    SKOPEO_DIR=<span class="string">"docker/skopeo"</span></span><br><span class="line">    <span class="comment"># 通过 find 出 current 文件夹可以得到所有带 tag 的镜像，因为一个 tag 对应一个 current 目录</span></span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> $(find <span class="variable">$&#123;REPO_DIR&#125;</span> -<span class="built_in">type</span> d -name <span class="string">"current"</span>); <span class="keyword">do</span></span><br><span class="line">        <span class="comment"># 根据镜像的 tag 提取镜像的名字</span></span><br><span class="line">        name=$(<span class="built_in">echo</span> <span class="variable">$&#123;image&#125;</span> | awk -F <span class="string">'/'</span> <span class="string">'&#123;print $5"/"$6":"$9&#125;'</span>)</span><br><span class="line">        link=$(cat <span class="variable">$&#123;image&#125;</span>/link | sed <span class="string">'s/sha256://'</span>)</span><br><span class="line">        mfs=<span class="string">"<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;link:0:2&#125;</span>/<span class="variable">$&#123;link&#125;</span>/data"</span></span><br><span class="line">        <span class="comment"># 创建镜像的硬链接需要的目录</span></span><br><span class="line">        mkdir -p <span class="string">"<span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>"</span></span><br><span class="line">        <span class="comment"># 硬链接镜像的 manifests 文件到目录的 manifest 文件</span></span><br><span class="line">        ln <span class="variable">$&#123;mfs&#125;</span> <span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>/manifest.json</span><br><span class="line">        <span class="comment"># 使用正则匹配出所有的 sha256 值，然后排序去重</span></span><br><span class="line">        layers=$(grep -Eo <span class="string">"\b[a-f0-9]&#123;64&#125;\b"</span> <span class="variable">$&#123;mfs&#125;</span> | sort -n | uniq)</span><br><span class="line">        <span class="keyword">for</span> layer <span class="keyword">in</span> <span class="variable">$&#123;layers&#125;</span>; <span class="keyword">do</span></span><br><span class="line">          <span class="comment"># 硬链接 registry 存储目录里的镜像 layer 和 images config 到镜像的 dir 目录</span></span><br><span class="line">            ln <span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data <span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;name&#125;</span>/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">sync_image</span></span>() &#123;</span><br><span class="line">    <span class="comment"># 使用 skopeo sync 将 dir 格式的镜像同步到 harbor</span></span><br><span class="line">    <span class="keyword">for</span> project <span class="keyword">in</span> $(ls <span class="variable">$&#123;SKOPEO_DIR&#125;</span>); <span class="keyword">do</span></span><br><span class="line">        skopeo sync --insecure-policy --src-tls-verify=<span class="literal">false</span> --dest-tls-verify=<span class="literal">false</span> \</span><br><span class="line">        --src dir --dest docker <span class="variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="variable">$&#123;project&#125;</span> <span class="variable">$&#123;REGISTRY_DOMAIN&#125;</span>/<span class="variable">$&#123;project&#125;</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line">gen_skopeo_dir</span><br></pre></td></tr></table></figure>

<h3 id="从-registry-存储中-select-出镜像"><a href="#从-registry-存储中-select-出镜像" class="headerlink" title="从 registry 存储中 select 出镜像"></a>从 registry 存储中 select 出镜像</h3><p>先将镜像同步到一个 registry 中，再将镜像从 registry 存储中捞出来。这个 registry 可以当作一个镜像存储的池子，我们使用 Linux 中硬链接的特性将镜像<code>&quot;复制&quot;</code>一份出来，然后再打一个 tar 包。这样做的好处就是每次打包镜像的时候都能复用历史的镜像数据，而且性能极快。具体的原理可以参考我之前的博客《<a href="https://blog.k8s.li/select-registry-images.html">什么？发布流水线中镜像“同步”速度又提升了 15 倍 ！</a>》</p>
<ul>
<li>先将镜像同步到一个固定的 registry 中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bash sync.sh docker.io localhost:5000</span><br></pre></td></tr></table></figure>

<ul>
<li>再使用该脚本将镜像从 registry 存储中捞出来</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">set</span> -eo pipefail</span><br><span class="line">IMAGES_LIST=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">REGISTRY_PATH=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">OUTPUT_DIR=<span class="string">"<span class="variable">$3</span>"</span></span><br><span class="line">BLOB_DIR=<span class="string">"docker/registry/v2/blobs/sha256"</span></span><br><span class="line">REPO_DIR=<span class="string">"docker/registry/v2/repositories"</span></span><br><span class="line">rm -rf <span class="variable">$&#123;OUTPUT_DIR&#125;</span>; mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span></span><br><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> $(find <span class="variable">$&#123;IMAGES_LIST&#125;</span> -<span class="built_in">type</span> f -name <span class="string">"*.list"</span> | xargs grep -Ev <span class="string">'^#|^/'</span> | grep <span class="string">':'</span>); <span class="keyword">do</span></span><br><span class="line">    image_tag=<span class="variable">$&#123;image##*:&#125;</span></span><br><span class="line">    image_name=<span class="variable">$&#123;image%%:*&#125;</span></span><br><span class="line">    tag_link=<span class="variable">$&#123;REGISTRY_PATH&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/current/link</span><br><span class="line">    manifest_sha256=$(sed <span class="string">'s/sha256://'</span> <span class="variable">$&#123;tag_link&#125;</span>)</span><br><span class="line">    manifest=<span class="variable">$&#123;REGISTRY_PATH&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span>/data</span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line">    ln -f <span class="variable">$&#123;manifest&#125;</span> <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;manifest_sha256:0:2&#125;</span>/<span class="variable">$&#123;manifest_sha256&#125;</span>/data</span><br><span class="line">    <span class="comment"># make image repositories dir</span></span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/&#123;_uploads,_layers,_manifests&#125;</span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/&#123;current,index/sha256&#125;</span><br><span class="line">    mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span></span><br><span class="line">    <span class="comment"># create image tag manifest link file</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/current/link</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;manifest_sha256&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="variable">$&#123;manifest_sha256&#125;</span>/link</span><br><span class="line">    <span class="keyword">for</span> layer <span class="keyword">in</span> $(sed <span class="string">'/v1Compatibility/d'</span> <span class="variable">$&#123;manifest&#125;</span> | grep -Eo <span class="string">'\b[a-f0-9]&#123;64&#125;\b'</span> | sort -u); <span class="keyword">do</span></span><br><span class="line">        mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">        mkdir -p <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span></span><br><span class="line">        ln -f <span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;BLOB_DIR&#125;</span>/<span class="variable">$&#123;layer:0:2&#125;</span>/<span class="variable">$&#123;layer&#125;</span>/data</span><br><span class="line">        <span class="built_in">echo</span> -n <span class="string">"sha256:<span class="variable">$&#123;layer&#125;</span>"</span> &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;REPO_DIR&#125;</span>/<span class="variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="variable">$&#123;layer&#125;</span>/link</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h2 id="延伸阅读"><a href="#延伸阅读" class="headerlink" title="延伸阅读"></a>延伸阅读</h2><ul>
<li><a href="https://blog.k8s.li/Exploring-container-image.html">深入浅出容器镜像的一生🤔</a></li>
<li><a href="https://blog.k8s.li/registry-gc.html">docker registry GC 原理分析</a></li>
<li><a href="https://blog.k8s.li/docker-registry-to-harbor.html">docker registry 迁移至 harbor</a></li>
<li><a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 在打包发布流水线中的应用</a></li>
<li><a href="https://blog.k8s.li/skopeo-to-registry.html">如何使用 registry 存储的特性</a></li>
<li><a href="https://blog.k8s.li/select-registry-images.html">什么？发布流水线中镜像“同步”速度又提升了 15 倍 ！</a></li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/registry/" rel="tag"><i class="fa fa-tag"></i> registry</a>
              <a href="/tags/%E9%95%9C%E5%83%8F/" rel="tag"><i class="fa fa-tag"></i> 镜像</a>
              <a href="/tags/skopeo/" rel="tag"><i class="fa fa-tag"></i> skopeo</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/pass-platform-release.html" rel="prev" title="云原生 PaaS 产品发布&部署方案">
      <i class="fa fa-chevron-left"></i> 云原生 PaaS 产品发布&部署方案
    </a></div>
      <div class="post-nav-item">
    <a href="/shell-snippet.html" rel="next" title="搬砖常用的 shell 片段记录">
      搬砖常用的 shell 片段记录 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#搬砖工具"><span class="nav-number">1.</span> <span class="nav-text">搬砖工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装方式"><span class="nav-number">2.</span> <span class="nav-text">安装方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#上手体验"><span class="nav-number">3.</span> <span class="nav-text">上手体验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#参数"><span class="nav-number">3.1.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IMAGE-NAMES-镜像格式🤔️"><span class="nav-number">3.2.</span> <span class="nav-text">IMAGE NAMES 镜像格式🤔️</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-login"><span class="nav-number">3.3.</span> <span class="nav-text">skopeo login</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-copy"><span class="nav-number">3.4.</span> <span class="nav-text">skopeo copy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-sync"><span class="nav-number">3.5.</span> <span class="nav-text">skopeo sync</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-inspect"><span class="nav-number">3.6.</span> <span class="nav-text">skopeo inspect</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-delete"><span class="nav-number">3.7.</span> <span class="nav-text">skopeo delete</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-list-tags"><span class="nav-number">3.8.</span> <span class="nav-text">skopeo list-tags</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最佳实践"><span class="nav-number">4.</span> <span class="nav-text">最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#镜像同步"><span class="nav-number">4.1.</span> <span class="nav-text">镜像同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-registry-存储特性"><span class="nav-number">4.2.</span> <span class="nav-text">使用 registry 存储特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从-registry-存储中-select-出镜像"><span class="nav-number">4.3.</span> <span class="nav-text">从 registry 存储中 select 出镜像</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#延伸阅读"><span class="nav-number">5.</span> <span class="nav-text">延伸阅读</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="木子"
      src="https://blog.k8s.li/avatar.png">
  <p class="site-author-name" itemprop="name">木子</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">104</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">127</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail → mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tg.k8s.li/" title="Channel → https:&#x2F;&#x2F;tg.k8s.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Channel</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">木子</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">1.6m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">43:34</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://muzi.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://blog.k8s.li/skopeo.html",
            identifier: "skopeo.html",
            title: "镜像搬运工 skopeo"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://muzi.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
