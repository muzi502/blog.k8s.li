<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="搬砖工具作为公司内部 PaaS toB 产品的打包发布人员，容器镜像对我们打工人而言就像是工地上的砖头 🧱，而我的一部分工作就是将这些砖头在各个仓库之间搬来搬去，最终将这些砖头打包放在产品的安装包中，形成一个完整的 PaaS 产品安装包。 而选择一个好的搬砖工具能节省我们大量的人力和 CPU 算力，在日常开发工作中我们也常常会使用 docker push 和 docker pull 来推拉镜像，">
<meta property="og:type" content="blog">
<meta property="og:title" content="镜像搬运工 skopeo">
<meta property="og:url" content="https://blog.k8s.li/skopeo.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="搬砖工具作为公司内部 PaaS toB 产品的打包发布人员，容器镜像对我们打工人而言就像是工地上的砖头 🧱，而我的一部分工作就是将这些砖头在各个仓库之间搬来搬去，最终将这些砖头打包放在产品的安装包中，形成一个完整的 PaaS 产品安装包。 而选择一个好的搬砖工具能节省我们大量的人力和 CPU 算力，在日常开发工作中我们也常常会使用 docker push 和 docker pull 来推拉镜像，">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/skopeo-github-action-build.png">
<meta property="article:published_time" content="2021-07-10T16:00:00.000Z">
<meta property="article:modified_time" content="2021-07-10T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="registry">
<meta property="article:tag" content="镜像">
<meta property="article:tag" content="skopeo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/skopeo-github-action-build.png">


<link rel="canonical" href="https://blog.k8s.li/skopeo.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/skopeo.html","path":"skopeo.html","title":"镜像搬运工 skopeo"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>镜像搬运工 skopeo | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.502.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AC%E7%A0%96%E5%B7%A5%E5%85%B7"><span class="nav-number">1.</span> <span class="nav-text">搬砖工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F"><span class="nav-number">2.</span> <span class="nav-text">安装方式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8A%E6%89%8B%E4%BD%93%E9%AA%8C"><span class="nav-number">3.</span> <span class="nav-text">上手体验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0"><span class="nav-number">3.1.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IMAGE-NAMES-%E9%95%9C%E5%83%8F%E6%A0%BC%E5%BC%8F-%F0%9F%A4%94%EF%B8%8F"><span class="nav-number">3.2.</span> <span class="nav-text">IMAGE NAMES 镜像格式 🤔️</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-login"><span class="nav-number">3.3.</span> <span class="nav-text">skopeo login</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-copy"><span class="nav-number">3.4.</span> <span class="nav-text">skopeo copy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-sync"><span class="nav-number">3.5.</span> <span class="nav-text">skopeo sync</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-inspect"><span class="nav-number">3.6.</span> <span class="nav-text">skopeo inspect</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-delete"><span class="nav-number">3.7.</span> <span class="nav-text">skopeo delete</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-list-tags"><span class="nav-number">3.8.</span> <span class="nav-text">skopeo list-tags</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">4.</span> <span class="nav-text">最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E5%90%8C%E6%AD%A5"><span class="nav-number">4.1.</span> <span class="nav-text">镜像同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-registry-%E5%AD%98%E5%82%A8%E7%89%B9%E6%80%A7"><span class="nav-number">4.2.</span> <span class="nav-text">使用 registry 存储特性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E-registry-%E5%AD%98%E5%82%A8%E4%B8%AD-select-%E5%87%BA%E9%95%9C%E5%83%8F"><span class="nav-number">4.3.</span> <span class="nav-text">从 registry 存储中 select 出镜像</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%B6%E4%BC%B8%E9%98%85%E8%AF%BB"><span class="nav-number">5.</span> <span class="nav-text">延伸阅读</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">115</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">147</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:blog@502.li" title="E-Mail → mailto:blog@502.li" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/skopeo.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="镜像搬运工 skopeo | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          镜像搬运工 skopeo
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-11 2021-07-11T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2021-07-11T00:00:00+08:00">2021-07-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/skopeo.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="skopeo.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>34k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>31 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="搬砖工具"><a href="#搬砖工具" class="headerlink" title="搬砖工具"></a>搬砖工具</h2><p>作为公司内部 PaaS toB 产品的打包发布人员，容器镜像对我们打工人而言就像是工地上的砖头 🧱，而我的一部分工作就是将这些砖头在各个仓库之间搬来搬去，最终将这些砖头打包放在产品的安装包中，形成一个完整的 PaaS 产品安装包。</p>
<p>而选择一个好的搬砖工具能节省我们大量的人力和 CPU 算力，在日常开发工作中我们也常常会使用 docker push 和 docker pull 来推拉镜像，虽然本地 push &amp;&amp; pull 一个镜像并不是什么难事儿，但对于一些特定的场景如产品打包发布流水线中，还继续再使用 docker 这个笨重的工具来推拉镜像的话，是十分费时费力的，具体的原理可以参考我之前写的博客《<a href="https://blog.k8s.li/Exploring-container-image.html">深入浅出容器镜像的一生 🤔</a>》。</p>
<p>自从 Kubernetes 1.20 之后，K8s 社区也弃用了 Docker 作为容器运行时，docker-shim 相关的代码将在 kubelet 中不再维护，随后掀起了一波去 docker 的浪潮。那么现在有没有一种能够替代 docker-cli 的工具来传输镜像呢？今天给大家介绍一个能够完全替代 docker-cli 来搬运镜像的工具：skopeo。这玩意儿比 docker-cli 高到不知道哪里去了！</p>
<h2 id="安装方式"><a href="#安装方式" class="headerlink" title="安装方式"></a>安装方式</h2><p>官方的安装方式参考安装文档即可 <a target="_blank" rel="noopener" href="https://github.com/containers/skopeo/blob/main/install.md">https://github.com/containers/skopeo/blob/main/install.md</a></p>
<p>由于我的 VPS 机器是 Ubuntu 1804 的 OS ，配置 apt 源并没成功，当场翻车。在官方的 Makefile 里只提供了在 nixos 下构建静态连接的方式，其他 Linux 发相版只能使用动态链接的方式来编译。但动态链接的方式通用性太差，比如在 ubuntu 18.04 上使用动态链接编译的 skopeo 只能在 ubuntu 上使用，无法在 centos 上使用。因为动态链接编译的二进制文件在不同的 OS 上所依赖的库文件是不一样的。所以还是另辟蹊径，亲自编译一个。</p>
<ul>
<li>Clone repo</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token assign-left variable">SKOPEO_VERSION</span><span class="token operator">=</span>v1.3.0
$ <span class="token function">git</span> clone --branch <span class="token variable">$&#123;SKOPEO_VERSION&#125;</span> https://github.com/containers/skopeo
$ <span class="token builtin class-name">cd</span> skopeo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>docker  build</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token assign-left variable">BUILD_IMAGE</span><span class="token operator">=</span>nixos/nix:2.3.12
$ <span class="token function">docker</span> run --rm -t -v <span class="token environment constant">$PWD</span>:/build <span class="token variable">$&#123;BUILD_IMAGE&#125;</span> <span class="token punctuation">\</span>
<span class="token function">sh</span> -c <span class="token string">"cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>使用 <code>nixos/nix:2.3.12</code> 来构建静态链接的 skopeo 二进制文件需要完整构建 skopeo 所有的依赖，比如 glibc、systemd、golang 等，所以构建十分耗时。在一台 4c8G 的机器上构建用了将近半个小时，在 GitHub Action 的 runner 机器上构建需要将近<a target="_blank" rel="noopener" href="https://github.com/k8sli/skopeo/actions/runs/1010266302">一个小时</a>。</li>
</ul>
<p><img data-src="https://p.k8s.li/skopeo-github-action-build.png" alt="img"></p>
<ul>
<li>使用 GitHub Action 构建</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> build static binary
<span class="token key atrule">on</span><span class="token punctuation">:</span> push
<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token key atrule">BUILD_IMAGE</span><span class="token punctuation">:</span> <span class="token string">"nixos/nix:2.3.12"</span>
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build static binary
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          docker run --rm -t -v $PWD:/build --name builder $&#123;BUILD_IMAGE&#125; \
          sh -c "cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo-linux-amd64"</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Release
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> softprops/action<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>release@v1
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.GITHUB_TOKEN <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">files</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>amd64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>不过也可以使用 go build 的方式构建出静态链接的二进制文件，如下 <code>Dockerfile</code></p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">FROM golang:1.14-buster as skopeo-builder
ARG SKOPEO_VERSION&#x3D;v1.2.0
RUN apt-get update \
    &amp;&amp; apt-get install -y -qq libdevmapper-dev libgpgme11-dev
ENV GOPATH&#x3D;&#x2F;
WORKDIR &#x2F;src&#x2F;github.com&#x2F;containers&#x2F;skopeo
RUN git clone --branch $&#123;SKOPEO_VERSION&#125; https:&#x2F;&#x2F;github.com&#x2F;containers&#x2F;skopeo . \
 &amp;&amp; CGO_ENABLE&#x3D;0 GO111MODULE&#x3D;on go build -mod&#x3D;vendor &quot;-buildmode&#x3D;pie&quot; -ldflags &#39;-extldflags &quot;-static&quot;&#39; -gcflags &quot;&quot; \
 -tags &quot;exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp&quot; -o &#x2F;usr&#x2F;bin&#x2F;skopeo .&#x2F;cmd&#x2F;skopeo
FROM alpine:3.12
COPY --from&#x3D;skopeo-builder &#x2F;usr&#x2F;bin&#x2F;skopeo &#x2F;usr&#x2F;bin&#x2F;skopeo
# FROM scratch
# COPY --from&#x3D;skopeo-builder &#x2F;usr&#x2F;bin&#x2F;skopeo &#x2F;skopeo
# DOCKER_BUILDKIT&#x3D;1 docker build -o type&#x3D;local,dest&#x3D;$PWD -f Dockerfile .<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/k8sli/skopeo/blob/main/.github/workflows/build-static-binary.yaml">通过 GitHub Action 来编译</a></li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> build static binary
<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'v*'</span>
<span class="token key atrule">env</span><span class="token punctuation">:</span>
  <span class="token key atrule">BUILDER_IMAGE</span><span class="token punctuation">:</span> ghcr.io/k8sli/nixos<span class="token punctuation">-</span>nix<span class="token punctuation">:</span>v2.3.12

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build-linux-amd64</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token key atrule">ARCH</span><span class="token punctuation">:</span> <span class="token string">"amd64"</span>
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up QEMU
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>qemu<span class="token punctuation">-</span>action@v1

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Docker Buildx
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v1

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build skopeo binary file
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          DIGEST=$(skopeo --insecure-policy --override-arch $&#123;ARCH&#125; inspect docker://$&#123;BUILDER_IMAGE&#125; | jq -r '.Digest')
          docker run --rm -t -v $PWD:/build $&#123;BUILDER_IMAGE&#125;@$&#123;DIGEST&#125; \
          sh -c "cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo-linux-$&#123;&#123; env.ARCH &#125;&#125;"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Upload binary artifact
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/upload<span class="token punctuation">-</span>artifact@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.ARCH <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>binary<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> github.run_number <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.ARCH <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>

  <span class="token key atrule">build-linux-arm64</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token key atrule">ARCH</span><span class="token punctuation">:</span> <span class="token string">"arm64"</span>
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up QEMU
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>qemu<span class="token punctuation">-</span>action@v1

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Docker Buildx
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v1

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build skopeo binary file
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          DIGEST=$(skopeo --insecure-policy --override-arch $&#123;ARCH&#125; inspect docker://$&#123;BUILDER_IMAGE&#125; | jq -r '.Digest')
          docker run --rm -t -v $PWD:/build $&#123;BUILDER_IMAGE&#125;@$&#123;DIGEST&#125; \
          sh -c "cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo-linux-$&#123;&#123; env.ARCH &#125;&#125;"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Upload binary artifact
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/upload<span class="token punctuation">-</span>artifact@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.ARCH <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>binary<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> github.run_number <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.ARCH <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>

  <span class="token key atrule">release</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">needs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>build<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>amd64<span class="token punctuation">,</span>build<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>arm64<span class="token punctuation">]</span>
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Download artifact from build<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>amd64
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/download<span class="token punctuation">-</span>artifact@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>binary<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> github.run_number <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">-</span>amd64

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Download artifact from build<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>arm64
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/download<span class="token punctuation">-</span>artifact@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>binary<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> github.run_number <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">-</span>arm64

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Release and upload binary files
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> softprops/action<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>release@v1
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.GITHUB_TOKEN <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">files</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            skopeo-linux-amd64
            skopeo-linux-arm64</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="上手体验"><a href="#上手体验" class="headerlink" title="上手体验"></a>上手体验</h2><ul>
<li>copy：复制一个镜像从 A 到 B，这里的 A 和 B 可以为本地 docker 镜像或者 registry 上的镜像；</li>
<li>inspect：查看一个镜像的 manifest 或者 image config 详细信息；</li>
<li>delete：删除一个镜像 tag，可以是本地 docker 镜像或者 registry 上的镜像；</li>
<li>list-tags：列出一个 registry 上某个镜像的所有 tag；</li>
<li>login：登录到某个 registry，和 docker login 类似；</li>
<li>logout： 退出已经登录到某个 registry 的 auth 信息，和 docker logout 类似；</li>
<li>manifest-digest：几圈一个文件的 sha256sum 值；</li>
<li>standalone-sign、standalone-verify 这两个是和镜像加密相关的，使用的不是很多；</li>
<li>sync：同步一个镜像从 A 到 B，感觉和 copy 一样，但 sync 支持的参数更多，功能更强大；</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">completion             generate the autocompletion script <span class="token keyword">for</span> the specified shell
copy                   Copy an IMAGE-NAME from one location to another
delete                 Delete image IMAGE-NAME
<span class="token builtin class-name">help</span>                   Help about any <span class="token builtin class-name">command</span>
inspect                Inspect image IMAGE-NAME
list-tags              List tags <span class="token keyword">in</span> the transport/repository specified by the REPOSITORY-NAME
login                  Login to a container registry
<span class="token builtin class-name">logout</span>                 Logout of a container registry
manifest-digest        Compute a manifest digest of a <span class="token function">file</span>
standalone-sign        Create a signature using <span class="token builtin class-name">local</span> files
standalone-verify      Verify a signature using <span class="token builtin class-name">local</span> files
<span class="token function">sync</span>                   Synchronize one or <span class="token function">more</span> images<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><ul>
<li>command-timeout：命令超时时间</li>
<li>debug：开启 debug 模式，输出详细的日志</li>
<li>insecure-policy： 使用非安全的 policy，如果没有配置 policy 的话，需要加上该参数</li>
<li>override-arch：处理镜像时覆盖客户端 CPU 体系架构，如在 amd64 的机器上用 skopeo 处理 arm64 的镜像</li>
<li>override-os： 处理镜像时覆盖客户端 OS</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Flags:
      --command-timeout duration   <span class="token function">timeout</span> <span class="token keyword">for</span> the <span class="token builtin class-name">command</span> execution
      --debug                      <span class="token builtin class-name">enable</span> debug output
  -h, --help                       <span class="token builtin class-name">help</span> <span class="token keyword">for</span> skopeo
      --insecure-policy            run the tool without any policy check
      --override-arch ARCH         use ARCH instead of the architecture of the machine <span class="token keyword">for</span> choosing images
      --override-os OS             use OS instead of the running OS <span class="token keyword">for</span> choosing images
      --override-variant VARIANT   use VARIANT instead of the running architecture variant <span class="token keyword">for</span> choosing images
      --policy string              Path to a trust policy <span class="token function">file</span>
      --registries.d DIR           use registry configuration files <span class="token keyword">in</span> DIR <span class="token punctuation">(</span>e.g. <span class="token keyword">for</span> container signature storage<span class="token punctuation">)</span>
      --tmpdir string              directory used to store temporary files
  -v, --version                    Version <span class="token keyword">for</span> Skopeo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一下是我在使用 skopeo 命令时候的一些参数</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">--insecure-policy --src-tls-verify<span class="token operator">=</span>false --dest-tls-verify<span class="token operator">=</span>false<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="IMAGE-NAMES-镜像格式-🤔️"><a href="#IMAGE-NAMES-镜像格式-🤔️" class="headerlink" title="IMAGE NAMES 镜像格式 🤔️"></a>IMAGE NAMES 镜像格式 🤔️</h3><p>在使用 skopeo 之前，我们首先要知道在命令行中镜像的格式，下面是官方详细的文档格式。无论我们的 src 镜像还是 dest 镜像都要满足以下格式才可以。</p>
<blockquote>
<p>Most commands refer to container images, using a <em>transport</em> <code>:</code> <em>details</em> format. The following formats are supported:</p>
</blockquote>
<blockquote>
<p>**containers-storage:**<em>docker-reference</em> An image located in a local containers&#x2F;storage image store. Both the location and image store are specified in &#x2F;etc&#x2F;containers&#x2F;storage.conf. (Backend for Podman, CRI-O, Buildah and friends)</p>
</blockquote>
<blockquote>
<p>**dir:**<em>path</em> An existing local directory <em>path</em> storing the manifest, layer tarballs and signatures as individual files. This is a non-standardized format, primarily useful for debugging or noninvasive container inspection.</p>
</blockquote>
<blockquote>
<p>**docker:&#x2F;&#x2F;**<em>docker-reference</em> An image in a registry implementing the “Docker Registry HTTP API V2”. By default, uses the authorization state in either <code>$XDG_RUNTIME_DIR/containers/auth.json</code>, which is set using <code>(skopeo login)</code>. If the authorization state is not found there, <code>$HOME/.docker/config.json</code> is checked, which is set using <code>(docker login)</code>.</p>
</blockquote>
<blockquote>
<p><strong>docker-archive:<em><strong>path</strong></em></strong>[**:**<em>docker-reference</em>] An image is stored in the <code>docker save</code> formatted file. <em>docker-reference</em> is only used when creating such a file, and it must not contain a digest.</p>
</blockquote>
<blockquote>
<p>**docker-daemon:**<em>docker-reference</em> An image <em>docker-reference</em> stored in the docker daemon internal storage. <em>docker-reference</em> must contain either a tag or a digest. Alternatively, when reading images, the format can be docker-daemon:algo:digest (an image ID).</p>
</blockquote>
<blockquote>
<p>**oci:<em><strong>path</strong></em>:**<em>tag</em> An image <em>tag</em> in a directory compliant with “Open Container Image Layout Specification” at <em>path</em>.</p>
</blockquote>
<p>需要注意的是，这几种镜像的名字，对应着镜像存在的方式，不同存在的方式对镜像的 layer 处理的方式也不一样，比如 <code>docker://</code> 这种方式是存在 registry 上的，<code>docker-daemon:</code> 是存在本地 docker pull 下来的，再比如 <code>docker-archive</code> 是通过 docker save 出来的镜像。同一个镜像有这几种存在的方式就像水分子有气体、液体、固体一样。可以这样去理解，他们表述的都是同一个镜像，只不过是存在的方式不一样而已。</p>
<p>IMAGE NAMES（镜像格式）examplecontainers-storage:containers-storage:dir:dir:&#x2F;PATHdocker:&#x2F;&#x2F;docker:&#x2F;&#x2F;k8s.gcr.io&#x2F;kube-apiserver:v1.17.5docker-daemon:docker-daemon:alpine:latestdocker-archive:docker-archive:alpine.tar (docker save)oci:oci:alpine:latest</p>
<h3 id="skopeo-login"><a href="#skopeo-login" class="headerlink" title="skopeo login"></a>skopeo login</h3><p>在使用 skopeo 前如果 src 或 dest 镜像是在 registry 中的，如果非 public 的镜像需要相应的 auth 认证，可以使用 docker login 或者 skopeo login 的方式登录到 registry，生成如下格式的 registry 登录配置文件。</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">$ jq <span class="token string">"."</span> ~/.docker/config.json
<span class="token punctuation">&#123;</span>
  <span class="token property">"auths"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"https://index.docker.io/v1/"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"auth"</span><span class="token operator">:</span> <span class="token string">"d2sdwdaqWMasss7bSVlJFpmQE43Sw=="</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"HttpHeaders"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"User-Agent"</span><span class="token operator">:</span> <span class="token string">"Docker-Client/19.03.5 (linux)"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"experimental"</span><span class="token operator">:</span> <span class="token string">"enabled"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="skopeo-copy"><a href="#skopeo-copy" class="headerlink" title="skopeo copy"></a>skopeo copy</h3><blockquote>
<p>Copy an IMAGE-NAME from one location to another</p>
</blockquote>
<blockquote>
<p>将一个镜像从 A 复制到 B</p>
</blockquote>
<p>注意一下，这里的 location 就是指的上面提到的 <code>IMAGE NAMES</code> ，也就是说 <code>skopeo copy src dest</code> 可以有 6*6&#x3D;36 种组合！比如我可以将一个镜像从一个 registry 复制到另一个 registry：<code>skopeo copy docker://IMAGE_NAME docker://IMAGE_NAME</code>；或者将一个镜像从 registry 中复制到一个本地目录 <code>skopeo copy docker://k8s.gcr.io/pause:3.3 dir:pause:3.3</code></p>
<ul>
<li>从 regsitry A 到 registry B 复制镜像</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo copy docker://k8s.gcr.io/kube-apiserver:v1.17.5 docker://hub.k8s.li/kube-apiserver:v1.17.5 --dest-authfile /root/.docker/config.json
Getting image <span class="token builtin class-name">source</span> signatures
Copying blob 597de8ba0c30 <span class="token keyword">done</span>
Copying blob e13a88fa950c <span class="token keyword">done</span>
Copying config f640481f6d <span class="token keyword">done</span>
Writing manifest to image destination
Storing signatures<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>skopeo 输出的日志显示是 Copying blob 597de8ba0c30 done.可以看到 skopeo 是直接从 registry 中 copy 镜像 layer 的 blob 文件，传输是镜像在 registry 中存储的原始格式。</p>
</blockquote>
<ul>
<li>将镜像从 registry 复制到本地目录</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo copy docker://k8s.gcr.io/pause:3.3 dir:pause:3.3
Getting image <span class="token builtin class-name">source</span> signatures
Copying blob aeab776c4837 <span class="token keyword">done</span>
Copying config 0184c1613d <span class="token keyword">done</span>
Writing manifest to image destination
Storing signatures
$ tree pause:3.3
pause:3.3
├── 0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da
├── aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b
├── manifest.json
└── version

<span class="token comment"># 查看镜像的 manifest 文件</span>

$ jq <span class="token string">'.'</span> pause:3.3/manifest.json
<span class="token punctuation">&#123;</span>
  <span class="token string">"schemaVersion"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
  <span class="token string">"mediaType"</span><span class="token builtin class-name">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span>,
  <span class="token string">"config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"mediaType"</span><span class="token builtin class-name">:</span> <span class="token string">"application/vnd.docker.container.image.v1+json"</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">743</span>,
    <span class="token string">"digest"</span><span class="token builtin class-name">:</span> <span class="token string">"sha256:0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"layers"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token string">"mediaType"</span><span class="token builtin class-name">:</span> <span class="token string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span>,
      <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">296517</span>,
      <span class="token string">"digest"</span><span class="token builtin class-name">:</span> <span class="token string">"sha256:aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># 根据 manifest 文件查看镜像的 image config 文件</span>

$ jq <span class="token string">'.'</span> pause:3.3/0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da

<span class="token punctuation">&#123;</span>
  <span class="token string">"architecture"</span><span class="token builtin class-name">:</span> <span class="token string">"amd64"</span>,
  <span class="token string">"config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"Env"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
    <span class="token punctuation">]</span>,
    <span class="token string">"Entrypoint"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"/pause"</span>
    <span class="token punctuation">]</span>,
    <span class="token string">"WorkingDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/"</span>,
    <span class="token string">"OnBuild"</span><span class="token builtin class-name">:</span> null
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"created"</span><span class="token builtin class-name">:</span> <span class="token string">"2020-05-02T09:46:29.068489061Z"</span>,
  <span class="token string">"history"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token string">"created"</span><span class="token builtin class-name">:</span> <span class="token string">"2020-05-02T09:46:29.068489061Z"</span>,
      <span class="token string">"created_by"</span><span class="token builtin class-name">:</span> <span class="token string">"ARG ARCH"</span>,
      <span class="token string">"comment"</span><span class="token builtin class-name">:</span> <span class="token string">"buildkit.dockerfile.v0"</span>,
      <span class="token string">"empty_layer"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token punctuation">&#123;</span>
      <span class="token string">"created"</span><span class="token builtin class-name">:</span> <span class="token string">"2020-05-02T09:46:29.068489061Z"</span>,
      <span class="token string">"created_by"</span><span class="token builtin class-name">:</span> <span class="token string">"ADD bin/pause-amd64 /pause # buildkit"</span>,
      <span class="token string">"comment"</span><span class="token builtin class-name">:</span> <span class="token string">"buildkit.dockerfile.v0"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token punctuation">&#123;</span>
      <span class="token string">"created"</span><span class="token builtin class-name">:</span> <span class="token string">"2020-05-02T09:46:29.068489061Z"</span>,
      <span class="token string">"created_by"</span><span class="token builtin class-name">:</span> <span class="token string">"ENTRYPOINT [<span class="token entity" title="\&quot;">\"</span>/pause<span class="token entity" title="\&quot;">\"</span>]"</span>,
      <span class="token string">"comment"</span><span class="token builtin class-name">:</span> <span class="token string">"buildkit.dockerfile.v0"</span>,
      <span class="token string">"empty_layer"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>,
  <span class="token string">"os"</span><span class="token builtin class-name">:</span> <span class="token string">"linux"</span>,
  <span class="token string">"rootfs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"layers"</span>,
    <span class="token string">"diff_ids"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"sha256:48a5e87615149095fad57d5db80f2cd9728b5562900eccb32842a45e8e8a61ae"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>将镜像从 registry 复制到本地目录，以 OCI 格式保存</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo copy docker://k8s.gcr.io/pause:3.3 oci:images
Getting image <span class="token builtin class-name">source</span> signatures
Copying blob aeab776c4837 <span class="token keyword">done</span>
Copying config fa5df7713f <span class="token keyword">done</span>
Writing manifest to image destination
Storing signatures
$ tree images
images
├── blobs
│   └── sha256
│       ├── 3450ba84b8fbfd12cbf58710c0b5678f4311a888d4d5c42b053faefa1af4f8be
│       ├── aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b
│       └── fa5df7713fc78f96e377d236b353d33815073105bbacd381e50705e576ce4da5
├── index.json
└── oci-layout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>替代 docker push 功能，将镜像从 docker 本地存储 push 到 registry 中</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo copy docker-daemon:alpine:3.12 docker://hub.k8s.li/library/alpine:3.12
Getting image <span class="token builtin class-name">source</span> signatures
Copying blob 32f366d666a5 <span class="token keyword">done</span>
Copying config 13621d1b12 <span class="token keyword">done</span>
Writing manifest to image destination
Storing signatures<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="skopeo-sync"><a href="#skopeo-sync" class="headerlink" title="skopeo sync"></a>skopeo sync</h3><p>Skopeo sync 的功能基本上等同于阿里云的 <a target="_blank" rel="noopener" href="https://github.com/AliyunContainerService/image-syncer">image-syncer</a> 工具，不过个人觉着 skopeo 要比 image-syncer 更强大，灵活性更强一些，汝还在使用 image-syncer 的话，强烈建议你使用 skopeo sync 替代它 😂。</p>
<ul>
<li>skopeo sync 镜像同步文件</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">registry.example.com</span><span class="token punctuation">:</span>
    <span class="token key atrule">images</span><span class="token punctuation">:</span>
        <span class="token key atrule">busybox</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token key atrule">redis</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token string">"1.0"</span>
            <span class="token punctuation">-</span> <span class="token string">"2.0"</span>
            <span class="token punctuation">-</span> <span class="token string">"sha256:111111"</span>
    <span class="token key atrule">images-by-tag-regex</span><span class="token punctuation">:</span>
        <span class="token key atrule">nginx</span><span class="token punctuation">:</span> ^1\.13\.<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">-</span>alpine<span class="token punctuation">-</span>perl$
    <span class="token key atrule">credentials</span><span class="token punctuation">:</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> john
        <span class="token key atrule">password</span><span class="token punctuation">:</span> this is a secret
    <span class="token key atrule">tls-verify</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">cert-dir</span><span class="token punctuation">:</span> /home/john/certs
<span class="token key atrule">quay.io</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls-verify</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">images</span><span class="token punctuation">:</span>
        <span class="token key atrule">coreos/etcd</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Image-syncer 镜像同步配置文件</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># registry 登录配置</span>

<span class="token punctuation">&#123;</span>
    <span class="token key atrule">"quay.io"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        // This "registry" or "registry/namespace" string should be the same as registry or registry/namespace used below in "images" field.
                            // The format of "registry/namespace" will be more prior matched than "registry"
        <span class="token key atrule">"username"</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"password"</span><span class="token punctuation">:</span> <span class="token string">"xxxxxxxxx"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"insecure"</span><span class="token punctuation">:</span> true         // "insecure" field needs to be true if this registry is a http service<span class="token punctuation">,</span> default value is false<span class="token punctuation">,</span> version of image<span class="token punctuation">-</span>syncer need to be later than v1.0.1 to support this field
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token key atrule">"registry.cn-beijing.aliyuncs.com"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token key atrule">"username"</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"password"</span><span class="token punctuation">:</span> <span class="token string">"xxxxxxxxx"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token key atrule">"registry.hub.docker.com"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token key atrule">"username"</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"password"</span><span class="token punctuation">:</span> <span class="token string">"xxxxxxxxxx"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token key atrule">"quay.io/coreos"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>     // "registry/namespace" format is supported after v1.0.3 of image<span class="token punctuation">-</span>syncer
        <span class="token key atrule">"username"</span><span class="token punctuation">:</span> <span class="token string">"abc"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"password"</span><span class="token punctuation">:</span> <span class="token string">"xxxxxxxxx"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"insecure"</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment"># 镜像配置</span>
<span class="token punctuation">&#123;</span>
    <span class="token key atrule">"quay.io/coreos/kube-rbac-proxy"</span><span class="token punctuation">:</span> <span class="token string">"quay.io/ruohe/kube-rbac-proxy"</span><span class="token punctuation">,</span>
    "xxxx"<span class="token punctuation">:</span><span class="token string">"xxxxx"</span><span class="token punctuation">,</span>
    "xxx/xxx/xx<span class="token punctuation">:</span>tag1<span class="token punctuation">,</span>tag2<span class="token punctuation">,</span>tag3"<span class="token punctuation">:</span><span class="token string">"xxx/xxx/xx"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>将镜从 registry A 同步到 registry B</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo <span class="token function">sync</span> --src <span class="token function">docker</span> --dest <span class="token function">docker</span> k8s.gcr.io/pause:3.3 hub.k8s.li
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Tag presence check                            <span class="token assign-left variable">imagename</span><span class="token operator">=</span><span class="token string">"k8s.gcr.io/pause:3.3"</span> <span class="token assign-left variable">tagged</span><span class="token operator">=</span>true
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Copying image tag <span class="token number">1</span>/1                         <span class="token assign-left variable">from</span><span class="token operator">=</span><span class="token string">"docker://k8s.gcr.io/pause:3.3"</span> <span class="token assign-left variable">to</span><span class="token operator">=</span><span class="token string">"docker://hub.k8s.li/pause:3.3"</span>
Getting image <span class="token builtin class-name">source</span> signatures
Copying blob aeab776c4837 <span class="token keyword">done</span>
Copying config 0184c1613d <span class="token keyword">done</span>
Writing manifest to image destination
Storing signatures
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Synced <span class="token number">1</span> images from <span class="token number">1</span> sources<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>将一个镜像从 registry 中同步到本地目录</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo <span class="token function">sync</span> --src <span class="token function">docker</span> --dest <span class="token function">dir</span> k8s.gcr.io/pause:3.3 images
images
└── pause:3.3
    ├── 0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da
    ├── aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b
    ├── manifest.json
    └── version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>将镜像从本地目录同步到 registry 中</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo <span class="token function">sync</span> --src <span class="token function">dir</span> --dest <span class="token function">docker</span> images hub.k8s.li
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Copying image ref <span class="token number">1</span>/1                         <span class="token assign-left variable">from</span><span class="token operator">=</span><span class="token string">"dir:images/pause:3.3"</span> <span class="token assign-left variable">to</span><span class="token operator">=</span><span class="token string">"docker://hub.k8s.li/pause:3.3"</span>
Getting image <span class="token builtin class-name">source</span> signatures
Copying blob aeab776c4837 <span class="token punctuation">[</span>--------------------------------------<span class="token punctuation">]</span> <span class="token number">0</span>.0b / <span class="token number">0</span>.0b
Copying config 0184c1613d <span class="token keyword">done</span>
Writing manifest to image destination
Storing signatures
INFO<span class="token punctuation">[</span>0002<span class="token punctuation">]</span> Synced <span class="token number">1</span> images from <span class="token number">1</span> sources<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="skopeo-inspect"><a href="#skopeo-inspect" class="headerlink" title="skopeo inspect"></a>skopeo inspect</h3><p>这个命令可以查看一个镜像的 image config 或者 manifests 文件，和 docker inspect 命令差不多。不加 –raw 参数默认是查看镜像的 image config 文件，加上 –raw 参数就是查看镜像的 manifest 文件。</p>
<ul>
<li>查看 docker 本地存储中的一个镜像的 image config 文件</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">$ skopeo inspect docker-daemon<span class="token operator">:</span>alpine<span class="token operator">:</span>latest
<span class="token punctuation">&#123;</span>
    <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"docker.io/library/alpine"</span><span class="token punctuation">,</span>
    <span class="token property">"Digest"</span><span class="token operator">:</span> <span class="token string">"sha256:ab84514e85b179ff569fd0042969b04f68812f23e187a927cb84664b417e0d3e"</span><span class="token punctuation">,</span>
    <span class="token property">"RepoTags"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"Created"</span><span class="token operator">:</span> <span class="token string">"2021-04-14T19:19:49.594730611Z"</span><span class="token punctuation">,</span>
    <span class="token property">"DockerVersion"</span><span class="token operator">:</span> <span class="token string">"19.03.12"</span><span class="token punctuation">,</span>
    <span class="token property">"Labels"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"Architecture"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>
    <span class="token property">"Os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>
    <span class="token property">"Layers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"sha256:32f366d666a541852cad754ee1cdb53a736110b550f0c2d5a46bc5ba519896b6"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"Env"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>查看 registry 中一个镜像的 manifests 文件，可以通过这种方式来判断镜像是否存在</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">skopeo inspect docker<span class="token operator">:</span><span class="token comment">//alpine:latest --raw | jq '.'</span>

<span class="token punctuation">&#123;</span>
  <span class="token property">"manifests"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:1775bebec23e1f3ce486989bfc9ff3c4e951690df84aa9f926497d82f2ffca9d"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:1f66b8f3041ef8575260056dedd437ed94e7bfeea142ee39ff0d795f94ff2287"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"arm"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>
        <span class="token property">"variant"</span><span class="token operator">:</span> <span class="token string">"v6"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:8d99168167baa6a6a0d7851b9684625df9c1455116a9601835c2127df2aaa2f5"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"arm"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>
        <span class="token property">"variant"</span><span class="token operator">:</span> <span class="token string">"v7"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:53b74ddfc6225e3c8cc84d7985d0f34666e4e8b0b6892a9b2ad1f7516bc21b54"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"arm64"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>
        <span class="token property">"variant"</span><span class="token operator">:</span> <span class="token string">"v8"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:52a197664c8ed0b4be6d3b8372f1d21f3204822ba432583644c9ce07f7d6448f"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"386"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:b421672fe4e74a3c7eff2775736e854d69e8d38b2c337063f8699de9c408ddd3"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"ppc64le"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:8a22269106a31264874cc3a719c1e280e76d42dff1fa57bd9c7fe68dab574023"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"s390x"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.list.v2+json"</span><span class="token punctuation">,</span>
  <span class="token property">"schemaVersion"</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="skopeo-delete"><a href="#skopeo-delete" class="headerlink" title="skopeo delete"></a>skopeo delete</h3><p>使用这个命令可以删除镜像 tag。需要注意的是，通过  registry API 来删除镜像的 tag 仅仅是删除了 tag 对 manifests 文件的引用，并非真正将镜像删除掉。如果想要删除镜像的 layer 还是需要通过 registry GC 的方式，可参考之前写过的一篇博客《<a href="https://blog.k8s.li/registry-gc.html">docker registry GC 原理分析</a>》</p>
<pre class="line-numbers language-none"><code class="language-none">$ skopeo delete docker:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;pause:3.2 --debug
DEBU[0000] Returning credentials from &#x2F;home&#x2F;release&#x2F;.docker&#x2F;config.json
DEBU[0000] Using registries.d directory &#x2F;etc&#x2F;containers&#x2F;registries.d for sigstore configuration
DEBU[0000]  No signature storage configuration found for hub.k8s.li&#x2F;library&#x2F;pause:3.2
DEBU[0000] Looking for TLS certificates and private keys in &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;hub.k8s.li&#x2F;library
DEBU[0000] Loading registries configuration &quot;&#x2F;etc&#x2F;containers&#x2F;registries.conf&quot;
DEBU[0000] GET https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;
DEBU[0000] Ping https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F; status 401
DEBU[0000] GET https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;library&#x2F;pause&#x2F;manifests&#x2F;3.2
DEBU[0000] DELETE https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;library&#x2F;pause&#x2F;manifests&#x2F;sha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="skopeo-list-tags"><a href="#skopeo-list-tags" class="headerlink" title="skopeo list-tags"></a>skopeo list-tags</h3><p>这个命令可用于列出 registry 上的某个镜像的所有 tag ，使用标准的 registry API 来获取镜像 tag</p>
<pre class="line-numbers language-none"><code class="language-none">$ skopeo list-tags docker:&#x2F;&#x2F;k8s.gcr.io&#x2F;pause
&#123;
    &quot;Repository&quot;: &quot;k8s.gcr.io&#x2F;pause&quot;,
    &quot;Tags&quot;: [
        &quot;0.8.0&quot;,
        &quot;1.0&quot;,
        &quot;2.0&quot;,
        &quot;3.0&quot;,
        &quot;3.1&quot;,
        &quot;3.2&quot;,
        &quot;3.3&quot;,
        &quot;3.4.1&quot;,
        &quot;3.5&quot;,
        &quot;go&quot;,
        &quot;latest&quot;,
        &quot;test&quot;,
        &quot;test2&quot;
    ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><p>一下给出几个 skopeo 工具的最佳实践 😊</p>
<h3 id="镜像同步"><a href="#镜像同步" class="headerlink" title="镜像同步"></a>镜像同步</h3><p>假如给你一个镜像列表，如 <a target="_blank" rel="noopener" href="https://github.com/kubesphere/ks-installer/blob/master/scripts/images-list.txt">https://github.com/kubesphere/ks-installer/blob/master/scripts/images-list.txt</a>。如何将它快速地从一个 registry 同步到另一个 registry 中呢？还是 skopeo copy 走起！</p>
<ul>
<li>images-list.txt</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">##k8s-images
kubesphere&#x2F;kube-apiserver:v1.20.6
kubesphere&#x2F;kube-scheduler:v1.20.6
kubesphere&#x2F;kube-proxy:v1.20.6
kubesphere&#x2F;kube-controller-manager:v1.20.6
kubesphere&#x2F;kube-apiserver:v1.19.8
kubesphere&#x2F;kube-scheduler:v1.19.8
kubesphere&#x2F;kube-proxy:v1.19.8
kubesphere&#x2F;kube-controller-manager:v1.19.8
kubesphere&#x2F;kube-apiserver:v1.19.9
kubesphere&#x2F;kube-scheduler:v1.19.9
kubesphere&#x2F;kube-proxy:v1.19.9
kubesphere&#x2F;kube-controller-manager:v1.19.9
kubesphere&#x2F;kube-apiserver:v1.18.8
kubesphere&#x2F;kube-scheduler:v1.18.8
kubesphere&#x2F;kube-proxy:v1.18.8
kubesphere&#x2F;kube-controller-manager:v1.18.8
kubesphere&#x2F;kube-apiserver:v1.17.9
kubesphere&#x2F;kube-scheduler:v1.17.9
kubesphere&#x2F;kube-proxy:v1.17.9
kubesphere&#x2F;kube-controller-manager:v1.17.9
kubesphere&#x2F;pause:3.1
kubesphere&#x2F;pause:3.2
kubesphere&#x2F;etcd:v3.4.13
calico&#x2F;cni:v3.16.3
calico&#x2F;kube-controllers:v3.16.3
calico&#x2F;node:v3.16.3
calico&#x2F;pod2daemon-flexvol:v3.16.3
calico&#x2F;typha:v3.16.3
kubesphere&#x2F;flannel:v0.12.0
coredns&#x2F;coredns:1.6.9
kubesphere&#x2F;k8s-dns-node-cache:1.15.12
openebs&#x2F;provisioner-localpv:2.10.1
openebs&#x2F;linux-utils:2.10.0
kubesphere&#x2F;nfs-client-provisioner:v3.1.0-k8s1.11
##csi-images
csiplugin&#x2F;csi-neonsan:v1.2.0
csiplugin&#x2F;csi-neonsan-ubuntu:v1.2.0
csiplugin&#x2F;csi-neonsan-centos:v1.2.0
csiplugin&#x2F;csi-provisioner:v1.5.0
csiplugin&#x2F;csi-attacher:v2.1.1
csiplugin&#x2F;csi-resizer:v0.4.0
csiplugin&#x2F;csi-snapshotter:v2.0.1
csiplugin&#x2F;csi-node-driver-registrar:v1.2.0
csiplugin&#x2F;csi-qingcloud:v1.2.0
##kubesphere-images
kubesphere&#x2F;ks-apiserver:v3.1.1
kubesphere&#x2F;ks-console:v3.1.1
kubesphere&#x2F;ks-controller-manager:v3.1.1
kubesphere&#x2F;ks-installer:v3.1.1
kubesphere&#x2F;kubectl:v1.20.0
kubesphere&#x2F;kubectl:v1.19.0
redis:5.0.12-alpine
alpine:3.14
haproxy:2.0.22-alpine
nginx:1.14-alpine
minio&#x2F;minio:RELEASE.2019-08-07T01-59-21Z
minio&#x2F;mc:RELEASE.2019-08-07T23-14-43Z
mirrorgooglecontainers&#x2F;defaultbackend-amd64:1.4
kubesphere&#x2F;nginx-ingress-controller:v0.35.0
osixia&#x2F;openldap:1.3.0
csiplugin&#x2F;snapshot-controller:v3.0.3
kubesphere&#x2F;kubefed:v0.7.0
kubesphere&#x2F;tower:v0.2.0
kubesphere&#x2F;prometheus-config-reloader:v0.42.1
kubesphere&#x2F;prometheus-operator:v0.42.1
prom&#x2F;alertmanager:v0.21.0
prom&#x2F;prometheus:v2.26.0
prom&#x2F;node-exporter:v0.18.1
kubesphere&#x2F;ks-alerting-migration:v3.1.0
jimmidyson&#x2F;configmap-reload:v0.3.0
kubesphere&#x2F;notification-manager-operator:v1.0.0
kubesphere&#x2F;notification-manager:v1.0.0
kubesphere&#x2F;metrics-server:v0.4.2
kubesphere&#x2F;kube-rbac-proxy:v0.8.0
kubesphere&#x2F;kube-state-metrics:v1.9.7
openebs&#x2F;provisioner-localpv:2.3.0
thanosio&#x2F;thanos:v0.18.0
grafana&#x2F;grafana:7.4.3
##kubesphere-logging-images
kubesphere&#x2F;elasticsearch-oss:6.7.0-1
kubesphere&#x2F;elasticsearch-curator:v5.7.6
kubesphere&#x2F;fluentbit-operator:v0.5.0
kubesphere&#x2F;fluentbit-operator:migrator
kubesphere&#x2F;fluent-bit:v1.6.9
elastic&#x2F;filebeat:6.7.0
kubesphere&#x2F;kube-auditing-operator:v0.1.2
kubesphere&#x2F;kube-auditing-webhook:v0.1.2
kubesphere&#x2F;kube-events-exporter:v0.1.0
kubesphere&#x2F;kube-events-operator:v0.1.0
kubesphere&#x2F;kube-events-ruler:v0.2.0
kubesphere&#x2F;log-sidecar-injector:1.1
docker:19.03
##istio-images
istio&#x2F;pilot:1.6.10
istio&#x2F;proxyv2:1.6.10
jaegertracing&#x2F;jaeger-agent:1.17
jaegertracing&#x2F;jaeger-collector:1.17
jaegertracing&#x2F;jaeger-es-index-cleaner:1.17
jaegertracing&#x2F;jaeger-operator:1.17.1
jaegertracing&#x2F;jaeger-query:1.17
kubesphere&#x2F;kiali:v1.26.1
kubesphere&#x2F;kiali-operator:v1.26.1
##kubesphere-devops-images
kubesphere&#x2F;ks-jenkins:2.249.1
jenkins&#x2F;jnlp-slave:3.27-1
kubesphere&#x2F;s2ioperator:v3.1.0
kubesphere&#x2F;s2irun:v2.1.1
kubesphere&#x2F;builder-base:v3.1.0
kubesphere&#x2F;builder-nodejs:v3.1.0
kubesphere&#x2F;builder-maven:v3.1.0
kubesphere&#x2F;builder-go:v3.1.0
kubesphere&#x2F;s2i-binary:v2.1.0
kubesphere&#x2F;tomcat85-java11-centos7:v2.1.0
kubesphere&#x2F;tomcat85-java11-runtime:v2.1.0
kubesphere&#x2F;tomcat85-java8-centos7:v2.1.0
kubesphere&#x2F;tomcat85-java8-runtime:v2.1.0
kubesphere&#x2F;java-11-centos7:v2.1.0
kubesphere&#x2F;java-8-centos7:v2.1.0
kubesphere&#x2F;java-8-runtime:v2.1.0
kubesphere&#x2F;java-11-runtime:v2.1.0
kubesphere&#x2F;nodejs-8-centos7:v2.1.0
kubesphere&#x2F;nodejs-6-centos7:v2.1.0
kubesphere&#x2F;nodejs-4-centos7:v2.1.0
kubesphere&#x2F;python-36-centos7:v2.1.0
kubesphere&#x2F;python-35-centos7:v2.1.0
kubesphere&#x2F;python-34-centos7:v2.1.0
kubesphere&#x2F;python-27-centos7:v2.1.0
##openpitrix-images
kubespheredev&#x2F;openpitrix-jobs:v3.1.1
##weave-scope-images
weaveworks&#x2F;scope:1.13.0
##kubeedge-images
kubeedge&#x2F;cloudcore:v1.6.2
kubesphere&#x2F;edge-watcher:v0.1.0
kubesphere&#x2F;kube-rbac-proxy:v0.5.0
kubesphere&#x2F;edge-watcher-agent:v0.1.0
##example-images-images
kubesphere&#x2F;examples-bookinfo-productpage-v1:1.16.2
kubesphere&#x2F;examples-bookinfo-reviews-v1:1.16.2
kubesphere&#x2F;examples-bookinfo-reviews-v2:1.16.2
kubesphere&#x2F;examples-bookinfo-reviews-v3:1.16.2
kubesphere&#x2F;examples-bookinfo-details-v1:1.16.2
kubesphere&#x2F;examples-bookinfo-ratings-v1:1.16.3
busybox:1.31.1
joosthofman&#x2F;wget:1.0
kubesphere&#x2F;netshoot:v1.0
nginxdemos&#x2F;hello:plain-text
wordpress:4.8-apache
mirrorgooglecontainers&#x2F;hpa-example:latest
java:openjdk-8-jre-alpine
fluent&#x2F;fluentd:v1.4.2-2.0
perl:latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>sync.sh</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">GREEN_COL</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\\">\\</span>033[32;1m"</span>
<span class="token assign-left variable">RED_COL</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\\">\\</span>033[1;31m"</span>
<span class="token assign-left variable">NORMAL_COL</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\\">\\</span>033[0;39m"</span>
<span class="token assign-left variable">SOURCE_REGISTRY</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">TARGET_REGISTRY</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;IMAGES_LIST_FILE<span class="token operator">:=</span>"images-list.txt"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;TARGET_REGISTRY<span class="token operator">:=</span>"hub.k8s.li"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;SOURCE_REGISTRY<span class="token operator">:=</span>"docker.io"&#125;</span>

<span class="token assign-left variable">BLOBS_PATH</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/blobs/sha256"</span>
<span class="token assign-left variable">REPO_PATH</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/repositories"</span>
<span class="token builtin class-name">set</span> -eo pipefail

<span class="token assign-left variable">CURRENT_NUM</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">ALL_IMAGES</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">sed</span> -n <span class="token string">'/#/d;s/:/:/p'</span> $<span class="token punctuation">&#123;</span>IMAGES_LIST_FILE<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">sort</span> -u<span class="token variable">)</span></span>"</span>
<span class="token assign-left variable">TOTAL_NUMS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$&#123;ALL_IMAGES&#125;</span>"</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">)</span></span>

<span class="token function-name function">skopeo_copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">if</span> skopeo copy --insecure-policy --src-tls-verify<span class="token operator">=</span>false --dest-tls-verify<span class="token operator">=</span>false <span class="token punctuation">\</span>
 --override-arch amd64 --override-os linux -q docker://<span class="token variable">$1</span> docker://<span class="token variable">$2</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
 <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$GREEN_COL</span> Progress: <span class="token variable">$&#123;CURRENT_NUM&#125;</span>/<span class="token variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="token variable">$1</span> to <span class="token variable">$2</span> successful <span class="token variable">$NORMAL_COL</span>"</span>
 <span class="token keyword">else</span>
 <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$RED_COL</span> Progress: <span class="token variable">$&#123;CURRENT_NUM&#125;</span>/<span class="token variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="token variable">$1</span> to <span class="token variable">$2</span> failed <span class="token variable">$NORMAL_COL</span>"</span>
 <span class="token builtin class-name">exit</span> <span class="token number">2</span>
 <span class="token keyword">fi</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">image</span> <span class="token keyword">in</span> <span class="token variable">$&#123;ALL_IMAGES&#125;</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
 <span class="token builtin class-name">let</span> <span class="token assign-left variable">CURRENT_NUM</span><span class="token operator">=</span><span class="token variable">$&#123;CURRENT_NUM&#125;</span>+1
 skopeo_copy <span class="token variable">$&#123;SOURCE_REGISTRY&#125;</span>/<span class="token variable">$&#123;image&#125;</span> <span class="token variable">$&#123;TARGET_REGISTRY&#125;</span>/<span class="token variable">$&#123;image&#125;</span>
<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>bash sync.sh docker.io ``localhost:5000</code></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">bash</span> sync.sh docker.io localhost:5000
Progress: <span class="token number">1</span>/143 <span class="token function">sync</span> docker.io/alpine:3.14 to localhost:5000/alpine:3.14 successful
Progress: <span class="token number">2</span>/143 <span class="token function">sync</span> docker.io/busybox:1.31.1 to localhost:5000/busybox:1.31.1 successful
Progress: <span class="token number">3</span>/143 <span class="token function">sync</span> docker.io/calico/cni:v3.16.3 to localhost:5000/calico/cni:v3.16.3 successful
Progress: <span class="token number">4</span>/143 <span class="token function">sync</span> docker.io/calico/kube-controllers:v3.16.3 to localhost:5000/calico/kube-controllers:v3.16.3 successful
Progress: <span class="token number">141</span>/143 <span class="token function">sync</span> docker.io/thanosio/thanos:v0.18.0 to localhost:5000/thanosio/thanos:v0.18.0 successful
Progress: <span class="token number">142</span>/143 <span class="token function">sync</span> docker.io/weaveworks/scope:1.13.0 to localhost:5000/weaveworks/scope:1.13.0 successful
Progress: <span class="token number">143</span>/143 <span class="token function">sync</span> docker.io/wordpress:4.8-apache to localhost:5000/wordpress:4.8-apache successful<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="使用-registry-存储特性"><a href="#使用-registry-存储特性" class="headerlink" title="使用 registry 存储特性"></a>使用 registry 存储特性</h3><p>将镜像从 registry 中同步到本地目录，使用 registry 存储的特性，将本地目录中的镜像转换成 registry 存储的格式。这样子的好处就是可以去除一些 skopeo dir 中重复的 layers，减少镜像的总大小。具体的原理可以参考我之前写过的 《<a href="https://blog.k8s.li/skopeo-to-registry.html">如何使用 registry 存储的特性</a>》</p>
<ul>
<li>sync.sh</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">GREEN_COL</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\\">\\</span>033[32;1m"</span>
<span class="token assign-left variable">RED_COL</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\\">\\</span>033[1;31m"</span>
<span class="token assign-left variable">NORMAL_COL</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\\">\\</span>033[0;39m"</span>
<span class="token assign-left variable">SOURCE_REGISTRY</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">TARGET_REGISTRY</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token assign-left variable">IMAGES_DIR</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;IMAGES_DIR<span class="token operator">:=</span>"images"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;IMAGES_LIST_FILE<span class="token operator">:=</span>"images-list.txt"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;TARGET_REGISTRY<span class="token operator">:=</span>"hub.k8s.li"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;SOURCE_REGISTRY<span class="token operator">:=</span>"docker.io"&#125;</span>
<span class="token assign-left variable">BLOBS_PATH</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/blobs/sha256"</span>
<span class="token assign-left variable">REPO_PATH</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/repositories"</span>
<span class="token builtin class-name">set</span> -eo pipefail
<span class="token assign-left variable">CURRENT_NUM</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">ALL_IMAGES</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">sed</span> -n <span class="token string">'/#/d;s/:/:/p'</span> $<span class="token punctuation">&#123;</span>IMAGES_LIST_FILE<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">sort</span> -u<span class="token variable">)</span></span>"</span>
<span class="token assign-left variable">TOTAL_NUMS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$&#123;ALL_IMAGES&#125;</span>"</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">)</span></span>
<span class="token function-name function">skopeo_sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">if</span> skopeo <span class="token function">sync</span> --insecure-policy --src-tls-verify<span class="token operator">=</span>false --dest-tls-verify<span class="token operator">=</span>false <span class="token punctuation">\</span>
 --override-arch amd64 --override-os linux --src <span class="token function">docker</span> --dest <span class="token function">dir</span> <span class="token variable">$1</span> <span class="token variable">$2</span> <span class="token operator">></span> /dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
 <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$GREEN_COL</span> Progress: <span class="token variable">$&#123;CURRENT_NUM&#125;</span>/<span class="token variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="token variable">$1</span> to <span class="token variable">$2</span> successful <span class="token variable">$NORMAL_COL</span>"</span>
 <span class="token keyword">else</span>
 <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$RED_COL</span> Progress: <span class="token variable">$&#123;CURRENT_NUM&#125;</span>/<span class="token variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="token variable">$1</span> to <span class="token variable">$2</span> failed <span class="token variable">$NORMAL_COL</span>"</span>
 <span class="token builtin class-name">exit</span> <span class="token number">2</span>
 <span class="token keyword">fi</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">convert_images</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token function">rm</span> -rf <span class="token variable">$&#123;IMAGES_DIR&#125;</span><span class="token punctuation">;</span> <span class="token function">mkdir</span> -p <span class="token variable">$&#123;IMAGES_DIR&#125;</span>
 <span class="token keyword">for</span> <span class="token for-or-select variable">image</span> <span class="token keyword">in</span> <span class="token variable">$&#123;ALL_IMAGES&#125;</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
 <span class="token builtin class-name">let</span> <span class="token assign-left variable">CURRENT_NUM</span><span class="token operator">=</span><span class="token variable">$&#123;CURRENT_NUM&#125;</span>+1
 <span class="token assign-left variable">image_name</span><span class="token operator">=</span><span class="token variable">$&#123;image<span class="token operator">%%</span><span class="token operator">:</span>*&#125;</span>
 <span class="token assign-left variable">image_tag</span><span class="token operator">=</span><span class="token variable">$&#123;image<span class="token operator">##</span>*<span class="token operator">:</span>&#125;</span>
 <span class="token assign-left variable">image_repo</span><span class="token operator">=</span><span class="token variable">$&#123;image<span class="token operator">%%</span><span class="token operator">/</span>*&#125;</span>
 skopeo_sync <span class="token variable">$&#123;SOURCE_REGISTRY&#125;</span>/<span class="token variable">$&#123;image&#125;</span> <span class="token variable">$&#123;IMAGES_DIR&#125;</span>/<span class="token variable">$&#123;image_repo&#125;</span>
 <span class="token assign-left variable">manifest</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;IMAGES_DIR&#125;</span>/<span class="token variable">$&#123;image&#125;</span>/manifest.json"</span>
 <span class="token assign-left variable">manifest_sha256</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>sha256sum $<span class="token punctuation">&#123;</span>manifest<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span><span class="token variable">)</span></span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;BLOBS_PATH&#125;</span>/<span class="token variable">$&#123;manifest_sha256<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;manifest_sha256&#125;</span>
 <span class="token function">ln</span> -f <span class="token variable">$&#123;manifest&#125;</span> <span class="token variable">$&#123;BLOBS_PATH&#125;</span>/<span class="token variable">$&#123;manifest_sha256<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;manifest_sha256&#125;</span>/data
 <span class="token comment"># make image repositories dir</span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/<span class="token punctuation">&#123;</span>_uploads,_layers,_manifests<span class="token punctuation">&#125;</span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/<span class="token punctuation">&#123;</span>current,index/sha256<span class="token punctuation">&#125;</span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>
 <span class="token comment"># create image tag manifest link file</span>
 <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;manifest_sha256&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/current/link
 <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;manifest_sha256&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>/link
 <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;manifest_sha256&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>/link
 <span class="token comment"># link image layers file to registry blobs dir</span>
 <span class="token keyword">for</span> <span class="token for-or-select variable">layer</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">sed</span> <span class="token string">'/v1Compatibility/d'</span> $<span class="token punctuation">&#123;</span>manifest<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">grep</span> -Eo <span class="token string">"<span class="token entity" title="\b">\b</span>[a-f0-9]&#123;64&#125;<span class="token entity" title="\b">\b</span>"</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;BLOBS_PATH&#125;</span>/<span class="token variable">$&#123;layer<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="token variable">$&#123;layer&#125;</span>
 <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;layer&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="token variable">$&#123;layer&#125;</span>/link
 <span class="token function">ln</span> -f <span class="token variable">$&#123;IMAGES_DIR&#125;</span>/<span class="token variable">$&#123;image&#125;</span>/<span class="token variable">$&#123;layer&#125;</span> <span class="token variable">$&#123;BLOBS_PATH&#125;</span>/<span class="token variable">$&#123;layer<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>/data
 <span class="token keyword">done</span>
 <span class="token keyword">done</span>
<span class="token punctuation">&#125;</span>

convert_images<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>install.sh</li>
</ul>
<p>使用这个脚本将 registry 存储中的镜像转换成 skopeo dir 的方式，然后再将镜像同步到 registry 中。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">REGISTRY_DOMAIN</span><span class="token operator">=</span><span class="token string">"harbor.k8s.li"</span>
<span class="token assign-left variable">REGISTRY_PATH</span><span class="token operator">=</span><span class="token string">"/var/lib/registry"</span>
<span class="token comment"># 切换到 registry 存储主目录下</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$&#123;REGISTRY_PATH&#125;</span>
<span class="token function-name function">gen_skopeo_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment"># 定义 registry 存储的 blob 目录 和 repositories 目录，方便后面使用</span>
    <span class="token assign-left variable">BLOB_DIR</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/blobs/sha256"</span>
    <span class="token assign-left variable">REPO_DIR</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/repositories"</span>
    <span class="token comment"># 定义生成 skopeo 目录</span>
    <span class="token assign-left variable">SKOPEO_DIR</span><span class="token operator">=</span><span class="token string">"docker/skopeo"</span>
    <span class="token comment"># 通过 find 出 current 文件夹可以得到所有带 tag 的镜像，因为一个 tag 对应一个 current 目录</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">image</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">find</span> $<span class="token punctuation">&#123;</span>REPO_DIR<span class="token punctuation">&#125;</span> -type d -name <span class="token string">"current"</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
        <span class="token comment"># 根据镜像的 tag 提取镜像的名字</span>
        <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $<span class="token punctuation">&#123;</span>image<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">awk</span> -F <span class="token string">'/'</span> <span class="token string">'&#123;print $5"/"$6":"$9&#125;'</span><span class="token variable">)</span></span>
        <span class="token assign-left variable">link</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $<span class="token punctuation">&#123;</span>image<span class="token punctuation">&#125;</span>/link <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/sha256://'</span><span class="token variable">)</span></span>
        <span class="token assign-left variable">mfs</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;link<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;link&#125;</span>/data"</span>
        <span class="token comment"># 创建镜像的硬链接需要的目录</span>
        <span class="token function">mkdir</span> -p <span class="token string">"<span class="token variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="token variable">$&#123;name&#125;</span>"</span>
        <span class="token comment"># 硬链接镜像的 manifests 文件到目录的 manifest 文件</span>
        <span class="token function">ln</span> <span class="token variable">$&#123;mfs&#125;</span> <span class="token variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="token variable">$&#123;name&#125;</span>/manifest.json
        <span class="token comment"># 使用正则匹配出所有的 sha256 值，然后排序去重</span>
        <span class="token assign-left variable">layers</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> -Eo <span class="token string">"<span class="token entity" title="\b">\b</span>[a-f0-9]&#123;64&#125;<span class="token entity" title="\b">\b</span>"</span> $<span class="token punctuation">&#123;</span>mfs<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">sort</span> -n <span class="token operator">|</span> <span class="token function">uniq</span><span class="token variable">)</span></span>
        <span class="token keyword">for</span> <span class="token for-or-select variable">layer</span> <span class="token keyword">in</span> <span class="token variable">$&#123;layers&#125;</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
          <span class="token comment"># 硬链接 registry 存储目录里的镜像 layer 和 images config 到镜像的 dir 目录</span>
            <span class="token function">ln</span> <span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;layer<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>/data <span class="token variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="token variable">$&#123;name&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>
        <span class="token keyword">done</span>
    <span class="token keyword">done</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">sync_image</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment"># 使用 skopeo sync 将 dir 格式的镜像同步到 harbor</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">project</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> $<span class="token punctuation">&#123;</span>SKOPEO_DIR<span class="token punctuation">&#125;</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
        skopeo <span class="token function">sync</span> --insecure-policy --src-tls-verify<span class="token operator">=</span>false --dest-tls-verify<span class="token operator">=</span>false <span class="token punctuation">\</span>
        --src <span class="token function">dir</span> --dest <span class="token function">docker</span> <span class="token variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="token variable">$&#123;project&#125;</span> <span class="token variable">$&#123;REGISTRY_DOMAIN&#125;</span>/<span class="token variable">$&#123;project&#125;</span>
    <span class="token keyword">done</span>
<span class="token punctuation">&#125;</span>
gen_skopeo_dir<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="从-registry-存储中-select-出镜像"><a href="#从-registry-存储中-select-出镜像" class="headerlink" title="从 registry 存储中 select 出镜像"></a>从 registry 存储中 select 出镜像</h3><p>先将镜像同步到一个 registry 中，再将镜像从 registry 存储中捞出来。这个 registry 可以当作一个镜像存储的池子，我们使用 Linux 中硬链接的特性将镜像 <code>&quot;复制&quot;</code> 一份出来，然后再打一个 tar 包。这样做的好处就是每次打包镜像的时候都能复用历史的镜像数据，而且性能极快。具体的原理可以参考我之前的博客《<a href="https://blog.k8s.li/select-registry-images.html">什么？发布流水线中镜像“同步”速度又提升了 15 倍 ！</a>》</p>
<ul>
<li>先将镜像同步到一个固定的 registry 中</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">$ bash sync.sh docker.io localhost:5000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>再使用该脚本将镜像从 registry 存储中捞出来</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">set</span> -eo pipefail
<span class="token assign-left variable">IMAGES_LIST</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$1</span>"</span>
<span class="token assign-left variable">REGISTRY_PATH</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$2</span>"</span>
<span class="token assign-left variable">OUTPUT_DIR</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$3</span>"</span>
<span class="token assign-left variable">BLOB_DIR</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/blobs/sha256"</span>
<span class="token assign-left variable">REPO_DIR</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/repositories"</span>
<span class="token function">rm</span> -rf <span class="token variable">$&#123;OUTPUT_DIR&#125;</span><span class="token punctuation">;</span> <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">image</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">find</span> $<span class="token punctuation">&#123;</span>IMAGES_LIST<span class="token punctuation">&#125;</span> -type f -name <span class="token string">"*.list"</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token function">grep</span> -Ev <span class="token string">'^#|^/'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">':'</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token assign-left variable">image_tag</span><span class="token operator">=</span><span class="token variable">$&#123;image<span class="token operator">##</span>*<span class="token operator">:</span>&#125;</span>
    <span class="token assign-left variable">image_name</span><span class="token operator">=</span><span class="token variable">$&#123;image<span class="token operator">%%</span><span class="token operator">:</span>*&#125;</span>
    <span class="token assign-left variable">tag_link</span><span class="token operator">=</span><span class="token variable">$&#123;REGISTRY_PATH&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/current/link
    <span class="token assign-left variable">manifest_sha256</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">sed</span> <span class="token string">'s/sha256://'</span> $<span class="token punctuation">&#123;</span>tag_link<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">manifest</span><span class="token operator">=</span><span class="token variable">$&#123;REGISTRY_PATH&#125;</span>/<span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;manifest_sha256<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;manifest_sha256&#125;</span>/data
    <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;manifest_sha256<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;manifest_sha256&#125;</span>
    <span class="token function">ln</span> -f <span class="token variable">$&#123;manifest&#125;</span> <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;manifest_sha256<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;manifest_sha256&#125;</span>/data
    <span class="token comment"># make image repositories dir</span>
    <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/<span class="token punctuation">&#123;</span>_uploads,_layers,_manifests<span class="token punctuation">&#125;</span>
    <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>
    <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/<span class="token punctuation">&#123;</span>current,index/sha256<span class="token punctuation">&#125;</span>
    <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>
    <span class="token comment"># create image tag manifest link file</span>
    <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;manifest_sha256&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/current/link
    <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;manifest_sha256&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>/link
    <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;manifest_sha256&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>/link
    <span class="token keyword">for</span> <span class="token for-or-select variable">layer</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">sed</span> <span class="token string">'/v1Compatibility/d'</span> $<span class="token punctuation">&#123;</span>manifest<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">grep</span> -Eo <span class="token string">'\b[a-f0-9]&#123;64&#125;\b'</span> <span class="token operator">|</span> <span class="token function">sort</span> -u<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
        <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;layer<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>
        <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="token variable">$&#123;layer&#125;</span>
        <span class="token function">ln</span> -f <span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;layer<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>/data <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;layer<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>/data
        <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;layer&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="token variable">$&#123;layer&#125;</span>/link
    <span class="token keyword">done</span>
<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="延伸阅读"><a href="#延伸阅读" class="headerlink" title="延伸阅读"></a>延伸阅读</h2><ul>
<li><a href="https://blog.k8s.li/Exploring-container-image.html">深入浅出容器镜像的一生 🤔</a></li>
<li><a href="https://blog.k8s.li/registry-gc.html">docker registry GC 原理分析</a></li>
<li><a href="https://blog.k8s.li/docker-registry-to-harbor.html">docker registry 迁移至 harbor</a></li>
<li><a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 在打包发布流水线中的应用</a></li>
<li><a href="https://blog.k8s.li/skopeo-to-registry.html">如何使用 registry 存储的特性</a></li>
<li><a href="https://blog.k8s.li/select-registry-images.html">什么？发布流水线中镜像“同步”速度又提升了 15 倍 ！</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/registry/" rel="tag"># registry</a>
              <a href="/tags/%E9%95%9C%E5%83%8F/" rel="tag"># 镜像</a>
              <a href="/tags/skopeo/" rel="tag"># skopeo</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/pass-platform-release.html" rel="prev" title="云原生 PaaS 产品发布&部署方案">
                  <i class="fa fa-chevron-left"></i> 云原生 PaaS 产品发布&部署方案
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/shell-snippet.html" rel="next" title="搬砖常用的 shell 片段记录">
                  搬砖常用的 shell 片段记录 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">25:36</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>


  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
