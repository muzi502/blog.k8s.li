<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="æ¬ç –å·¥å…·ä½œä¸ºå…¬å¸å†…éƒ¨ PaaS toB äº§å“çš„æ‰“åŒ…å‘å¸ƒäººå‘˜ï¼Œå®¹å™¨é•œåƒå¯¹æˆ‘ä»¬æ‰“å·¥äººè€Œè¨€å°±åƒæ˜¯å·¥åœ°ä¸Šçš„ç –å¤´ ğŸ§±ï¼Œè€Œæˆ‘çš„ä¸€éƒ¨åˆ†å·¥ä½œå°±æ˜¯å°†è¿™äº›ç –å¤´åœ¨å„ä¸ªä»“åº“ä¹‹é—´æ¬æ¥æ¬å»ï¼Œæœ€ç»ˆå°†è¿™äº›ç –å¤´æ‰“åŒ…æ”¾åœ¨äº§å“çš„å®‰è£…åŒ…ä¸­ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„ PaaS äº§å“å®‰è£…åŒ…ã€‚ è€Œé€‰æ‹©ä¸€ä¸ªå¥½çš„æ¬ç –å·¥å…·èƒ½èŠ‚çœæˆ‘ä»¬å¤§é‡çš„äººåŠ›å’Œ CPU ç®—åŠ›ï¼Œåœ¨æ—¥å¸¸å¼€å‘å·¥ä½œä¸­æˆ‘ä»¬ä¹Ÿå¸¸å¸¸ä¼šä½¿ç”¨ docker push å’Œ docker pull æ¥æ¨æ‹‰é•œåƒï¼Œ">
<meta property="og:type" content="blog">
<meta property="og:title" content="é•œåƒæ¬è¿å·¥ skopeo">
<meta property="og:url" content="https://blog.k8s.li/skopeo.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="æ¬ç –å·¥å…·ä½œä¸ºå…¬å¸å†…éƒ¨ PaaS toB äº§å“çš„æ‰“åŒ…å‘å¸ƒäººå‘˜ï¼Œå®¹å™¨é•œåƒå¯¹æˆ‘ä»¬æ‰“å·¥äººè€Œè¨€å°±åƒæ˜¯å·¥åœ°ä¸Šçš„ç –å¤´ ğŸ§±ï¼Œè€Œæˆ‘çš„ä¸€éƒ¨åˆ†å·¥ä½œå°±æ˜¯å°†è¿™äº›ç –å¤´åœ¨å„ä¸ªä»“åº“ä¹‹é—´æ¬æ¥æ¬å»ï¼Œæœ€ç»ˆå°†è¿™äº›ç –å¤´æ‰“åŒ…æ”¾åœ¨äº§å“çš„å®‰è£…åŒ…ä¸­ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„ PaaS äº§å“å®‰è£…åŒ…ã€‚ è€Œé€‰æ‹©ä¸€ä¸ªå¥½çš„æ¬ç –å·¥å…·èƒ½èŠ‚çœæˆ‘ä»¬å¤§é‡çš„äººåŠ›å’Œ CPU ç®—åŠ›ï¼Œåœ¨æ—¥å¸¸å¼€å‘å·¥ä½œä¸­æˆ‘ä»¬ä¹Ÿå¸¸å¸¸ä¼šä½¿ç”¨ docker push å’Œ docker pull æ¥æ¨æ‹‰é•œåƒï¼Œ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p.k8s.li/skopeo-github-action-build.png">
<meta property="article:published_time" content="2021-07-10T16:00:00.000Z">
<meta property="article:modified_time" content="2021-07-10T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="registry">
<meta property="article:tag" content="é•œåƒ">
<meta property="article:tag" content="skopeo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p.k8s.li/skopeo-github-action-build.png">


<link rel="canonical" href="https://blog.k8s.li/skopeo.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/skopeo.html","path":"skopeo.html","title":"é•œåƒæ¬è¿å·¥ skopeo"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>é•œåƒæ¬è¿å·¥ skopeo | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.502.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%90%AC%E7%A0%96%E5%B7%A5%E5%85%B7"><span class="nav-number">1.</span> <span class="nav-text">æ¬ç –å·¥å…·</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F"><span class="nav-number">2.</span> <span class="nav-text">å®‰è£…æ–¹å¼</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8A%E6%89%8B%E4%BD%93%E9%AA%8C"><span class="nav-number">3.</span> <span class="nav-text">ä¸Šæ‰‹ä½“éªŒ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E6%95%B0"><span class="nav-number">3.1.</span> <span class="nav-text">å‚æ•°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IMAGE-NAMES-%E9%95%9C%E5%83%8F%E6%A0%BC%E5%BC%8F-%F0%9F%A4%94%EF%B8%8F"><span class="nav-number">3.2.</span> <span class="nav-text">IMAGE NAMES é•œåƒæ ¼å¼ ğŸ¤”ï¸</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-login"><span class="nav-number">3.3.</span> <span class="nav-text">skopeo login</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-copy"><span class="nav-number">3.4.</span> <span class="nav-text">skopeo copy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-sync"><span class="nav-number">3.5.</span> <span class="nav-text">skopeo sync</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-inspect"><span class="nav-number">3.6.</span> <span class="nav-text">skopeo inspect</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-delete"><span class="nav-number">3.7.</span> <span class="nav-text">skopeo delete</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#skopeo-list-tags"><span class="nav-number">3.8.</span> <span class="nav-text">skopeo list-tags</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="nav-number">4.</span> <span class="nav-text">æœ€ä½³å®è·µ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E5%90%8C%E6%AD%A5"><span class="nav-number">4.1.</span> <span class="nav-text">é•œåƒåŒæ­¥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-registry-%E5%AD%98%E5%82%A8%E7%89%B9%E6%80%A7"><span class="nav-number">4.2.</span> <span class="nav-text">ä½¿ç”¨ registry å­˜å‚¨ç‰¹æ€§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8E-registry-%E5%AD%98%E5%82%A8%E4%B8%AD-select-%E5%87%BA%E9%95%9C%E5%83%8F"><span class="nav-number">4.3.</span> <span class="nav-text">ä» registry å­˜å‚¨ä¸­ select å‡ºé•œåƒ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%B6%E4%BC%B8%E9%98%85%E8%AF%BB"><span class="nav-number">5.</span> <span class="nav-text">å»¶ä¼¸é˜…è¯»</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">115</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">147</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:blog@502.li" title="E-Mail â†’ mailto:blog@502.li" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/skopeo.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="é•œåƒæ¬è¿å·¥ skopeo | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          é•œåƒæ¬è¿å·¥ skopeo
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2021-07-11 2021-07-11T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2021-07-11T00:00:00+08:00">2021-07-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/skopeo.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="skopeo.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>34k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>31 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="æ¬ç –å·¥å…·"><a href="#æ¬ç –å·¥å…·" class="headerlink" title="æ¬ç –å·¥å…·"></a>æ¬ç –å·¥å…·</h2><p>ä½œä¸ºå…¬å¸å†…éƒ¨ PaaS toB äº§å“çš„æ‰“åŒ…å‘å¸ƒäººå‘˜ï¼Œå®¹å™¨é•œåƒå¯¹æˆ‘ä»¬æ‰“å·¥äººè€Œè¨€å°±åƒæ˜¯å·¥åœ°ä¸Šçš„ç –å¤´ ğŸ§±ï¼Œè€Œæˆ‘çš„ä¸€éƒ¨åˆ†å·¥ä½œå°±æ˜¯å°†è¿™äº›ç –å¤´åœ¨å„ä¸ªä»“åº“ä¹‹é—´æ¬æ¥æ¬å»ï¼Œæœ€ç»ˆå°†è¿™äº›ç –å¤´æ‰“åŒ…æ”¾åœ¨äº§å“çš„å®‰è£…åŒ…ä¸­ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„ PaaS äº§å“å®‰è£…åŒ…ã€‚</p>
<p>è€Œé€‰æ‹©ä¸€ä¸ªå¥½çš„æ¬ç –å·¥å…·èƒ½èŠ‚çœæˆ‘ä»¬å¤§é‡çš„äººåŠ›å’Œ CPU ç®—åŠ›ï¼Œåœ¨æ—¥å¸¸å¼€å‘å·¥ä½œä¸­æˆ‘ä»¬ä¹Ÿå¸¸å¸¸ä¼šä½¿ç”¨ docker push å’Œ docker pull æ¥æ¨æ‹‰é•œåƒï¼Œè™½ç„¶æœ¬åœ° push &amp;&amp; pull ä¸€ä¸ªé•œåƒå¹¶ä¸æ˜¯ä»€ä¹ˆéš¾äº‹å„¿ï¼Œä½†å¯¹äºä¸€äº›ç‰¹å®šçš„åœºæ™¯å¦‚äº§å“æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­ï¼Œè¿˜ç»§ç»­å†ä½¿ç”¨ docker è¿™ä¸ªç¬¨é‡çš„å·¥å…·æ¥æ¨æ‹‰é•œåƒçš„è¯ï¼Œæ˜¯ååˆ†è´¹æ—¶è´¹åŠ›çš„ï¼Œå…·ä½“çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„åšå®¢ã€Š<a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿ ğŸ¤”</a>ã€‹ã€‚</p>
<p>è‡ªä» Kubernetes 1.20 ä¹‹åï¼ŒK8s ç¤¾åŒºä¹Ÿå¼ƒç”¨äº† Docker ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œdocker-shim ç›¸å…³çš„ä»£ç å°†åœ¨ kubelet ä¸­ä¸å†ç»´æŠ¤ï¼Œéšåæ€èµ·äº†ä¸€æ³¢å» docker çš„æµªæ½®ã€‚é‚£ä¹ˆç°åœ¨æœ‰æ²¡æœ‰ä¸€ç§èƒ½å¤Ÿæ›¿ä»£ docker-cli çš„å·¥å…·æ¥ä¼ è¾“é•œåƒå‘¢ï¼Ÿä»Šå¤©ç»™å¤§å®¶ä»‹ç»ä¸€ä¸ªèƒ½å¤Ÿå®Œå…¨æ›¿ä»£ docker-cli æ¥æ¬è¿é•œåƒçš„å·¥å…·ï¼šskopeoã€‚è¿™ç©æ„å„¿æ¯” docker-cli é«˜åˆ°ä¸çŸ¥é“å“ªé‡Œå»äº†ï¼</p>
<h2 id="å®‰è£…æ–¹å¼"><a href="#å®‰è£…æ–¹å¼" class="headerlink" title="å®‰è£…æ–¹å¼"></a>å®‰è£…æ–¹å¼</h2><p>å®˜æ–¹çš„å®‰è£…æ–¹å¼å‚è€ƒå®‰è£…æ–‡æ¡£å³å¯ <a target="_blank" rel="noopener" href="https://github.com/containers/skopeo/blob/main/install.md">https://github.com/containers/skopeo/blob/main/install.md</a></p>
<p>ç”±äºæˆ‘çš„ VPS æœºå™¨æ˜¯ Ubuntu 1804 çš„ OS ï¼Œé…ç½® apt æºå¹¶æ²¡æˆåŠŸï¼Œå½“åœºç¿»è½¦ã€‚åœ¨å®˜æ–¹çš„ Makefile é‡Œåªæä¾›äº†åœ¨ nixos ä¸‹æ„å»ºé™æ€è¿æ¥çš„æ–¹å¼ï¼Œå…¶ä»– Linux å‘ç›¸ç‰ˆåªèƒ½ä½¿ç”¨åŠ¨æ€é“¾æ¥çš„æ–¹å¼æ¥ç¼–è¯‘ã€‚ä½†åŠ¨æ€é“¾æ¥çš„æ–¹å¼é€šç”¨æ€§å¤ªå·®ï¼Œæ¯”å¦‚åœ¨ ubuntu 18.04 ä¸Šä½¿ç”¨åŠ¨æ€é“¾æ¥ç¼–è¯‘çš„ skopeo åªèƒ½åœ¨ ubuntu ä¸Šä½¿ç”¨ï¼Œæ— æ³•åœ¨ centos ä¸Šä½¿ç”¨ã€‚å› ä¸ºåŠ¨æ€é“¾æ¥ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶åœ¨ä¸åŒçš„ OS ä¸Šæ‰€ä¾èµ–çš„åº“æ–‡ä»¶æ˜¯ä¸ä¸€æ ·çš„ã€‚æ‰€ä»¥è¿˜æ˜¯å¦è¾Ÿè¹Šå¾„ï¼Œäº²è‡ªç¼–è¯‘ä¸€ä¸ªã€‚</p>
<ul>
<li>Clone repo</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token assign-left variable">SKOPEO_VERSION</span><span class="token operator">=</span>v1.3.0
$ <span class="token function">git</span> clone --branch <span class="token variable">$&#123;SKOPEO_VERSION&#125;</span> https://github.com/containers/skopeo
$ <span class="token builtin class-name">cd</span> skopeo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>docker  build</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token assign-left variable">BUILD_IMAGE</span><span class="token operator">=</span>nixos/nix:2.3.12
$ <span class="token function">docker</span> run --rm -t -v <span class="token environment constant">$PWD</span>:/build <span class="token variable">$&#123;BUILD_IMAGE&#125;</span> <span class="token punctuation">\</span>
<span class="token function">sh</span> -c <span class="token string">"cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>ä½¿ç”¨ <code>nixos/nix:2.3.12</code> æ¥æ„å»ºé™æ€é“¾æ¥çš„ skopeo äºŒè¿›åˆ¶æ–‡ä»¶éœ€è¦å®Œæ•´æ„å»º skopeo æ‰€æœ‰çš„ä¾èµ–ï¼Œæ¯”å¦‚ glibcã€systemdã€golang ç­‰ï¼Œæ‰€ä»¥æ„å»ºååˆ†è€—æ—¶ã€‚åœ¨ä¸€å° 4c8G çš„æœºå™¨ä¸Šæ„å»ºç”¨äº†å°†è¿‘åŠä¸ªå°æ—¶ï¼Œåœ¨ GitHub Action çš„ runner æœºå™¨ä¸Šæ„å»ºéœ€è¦å°†è¿‘<a target="_blank" rel="noopener" href="https://github.com/k8sli/skopeo/actions/runs/1010266302">ä¸€ä¸ªå°æ—¶</a>ã€‚</li>
</ul>
<p><img data-src="https://p.k8s.li/skopeo-github-action-build.png" alt="img"></p>
<ul>
<li>ä½¿ç”¨ GitHub Action æ„å»º</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> build static binary
<span class="token key atrule">on</span><span class="token punctuation">:</span> push
<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token key atrule">BUILD_IMAGE</span><span class="token punctuation">:</span> <span class="token string">"nixos/nix:2.3.12"</span>
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build static binary
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          docker run --rm -t -v $PWD:/build --name builder $&#123;BUILD_IMAGE&#125; \
          sh -c "cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo-linux-amd64"</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Release
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> softprops/action<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>release@v1
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.GITHUB_TOKEN <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">files</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>amd64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸è¿‡ä¹Ÿå¯ä»¥ä½¿ç”¨ go build çš„æ–¹å¼æ„å»ºå‡ºé™æ€é“¾æ¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¦‚ä¸‹ <code>Dockerfile</code></p>
<pre class="line-numbers language-dockerfile" data-language="dockerfile"><code class="language-dockerfile">FROM golang:1.14-buster as skopeo-builder
ARG SKOPEO_VERSION&#x3D;v1.2.0
RUN apt-get update \
    &amp;&amp; apt-get install -y -qq libdevmapper-dev libgpgme11-dev
ENV GOPATH&#x3D;&#x2F;
WORKDIR &#x2F;src&#x2F;github.com&#x2F;containers&#x2F;skopeo
RUN git clone --branch $&#123;SKOPEO_VERSION&#125; https:&#x2F;&#x2F;github.com&#x2F;containers&#x2F;skopeo . \
 &amp;&amp; CGO_ENABLE&#x3D;0 GO111MODULE&#x3D;on go build -mod&#x3D;vendor &quot;-buildmode&#x3D;pie&quot; -ldflags &#39;-extldflags &quot;-static&quot;&#39; -gcflags &quot;&quot; \
 -tags &quot;exclude_graphdriver_devicemapper exclude_graphdriver_btrfs containers_image_openpgp&quot; -o &#x2F;usr&#x2F;bin&#x2F;skopeo .&#x2F;cmd&#x2F;skopeo
FROM alpine:3.12
COPY --from&#x3D;skopeo-builder &#x2F;usr&#x2F;bin&#x2F;skopeo &#x2F;usr&#x2F;bin&#x2F;skopeo
# FROM scratch
# COPY --from&#x3D;skopeo-builder &#x2F;usr&#x2F;bin&#x2F;skopeo &#x2F;skopeo
# DOCKER_BUILDKIT&#x3D;1 docker build -o type&#x3D;local,dest&#x3D;$PWD -f Dockerfile .<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/k8sli/skopeo/blob/main/.github/workflows/build-static-binary.yaml">é€šè¿‡ GitHub Action æ¥ç¼–è¯‘</a></li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> build static binary
<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">tags</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'v*'</span>
<span class="token key atrule">env</span><span class="token punctuation">:</span>
  <span class="token key atrule">BUILDER_IMAGE</span><span class="token punctuation">:</span> ghcr.io/k8sli/nixos<span class="token punctuation">-</span>nix<span class="token punctuation">:</span>v2.3.12

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build-linux-amd64</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token key atrule">ARCH</span><span class="token punctuation">:</span> <span class="token string">"amd64"</span>
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up QEMU
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>qemu<span class="token punctuation">-</span>action@v1

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Docker Buildx
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v1

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build skopeo binary file
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          DIGEST=$(skopeo --insecure-policy --override-arch $&#123;ARCH&#125; inspect docker://$&#123;BUILDER_IMAGE&#125; | jq -r '.Digest')
          docker run --rm -t -v $PWD:/build $&#123;BUILDER_IMAGE&#125;@$&#123;DIGEST&#125; \
          sh -c "cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo-linux-$&#123;&#123; env.ARCH &#125;&#125;"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Upload binary artifact
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/upload<span class="token punctuation">-</span>artifact@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.ARCH <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>binary<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> github.run_number <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.ARCH <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>

  <span class="token key atrule">build-linux-arm64</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token key atrule">ARCH</span><span class="token punctuation">:</span> <span class="token string">"arm64"</span>
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up QEMU
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>qemu<span class="token punctuation">-</span>action@v1

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Docker Buildx
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v1

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build skopeo binary file
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          DIGEST=$(skopeo --insecure-policy --override-arch $&#123;ARCH&#125; inspect docker://$&#123;BUILDER_IMAGE&#125; | jq -r '.Digest')
          docker run --rm -t -v $PWD:/build $&#123;BUILDER_IMAGE&#125;@$&#123;DIGEST&#125; \
          sh -c "cd /build &amp;&amp; nix build -f nix &amp;&amp; cp ./result/bin/skopeo skopeo-linux-$&#123;&#123; env.ARCH &#125;&#125;"</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Upload binary artifact
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/upload<span class="token punctuation">-</span>artifact@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.ARCH <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>binary<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> github.run_number <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.ARCH <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>

  <span class="token key atrule">release</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">needs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>build<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>amd64<span class="token punctuation">,</span>build<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>arm64<span class="token punctuation">]</span>
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Download artifact from build<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>amd64
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/download<span class="token punctuation">-</span>artifact@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>binary<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> github.run_number <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">-</span>amd64

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Download artifact from build<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>arm64
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/download<span class="token punctuation">-</span>artifact@v2
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> skopeo<span class="token punctuation">-</span>binary<span class="token punctuation">-</span>$<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> github.run_number <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">-</span>arm64

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Release and upload binary files
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> softprops/action<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>release@v1
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.GITHUB_TOKEN <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">files</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            skopeo-linux-amd64
            skopeo-linux-arm64</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="ä¸Šæ‰‹ä½“éªŒ"><a href="#ä¸Šæ‰‹ä½“éªŒ" class="headerlink" title="ä¸Šæ‰‹ä½“éªŒ"></a>ä¸Šæ‰‹ä½“éªŒ</h2><ul>
<li>copyï¼šå¤åˆ¶ä¸€ä¸ªé•œåƒä» A åˆ° Bï¼Œè¿™é‡Œçš„ A å’Œ B å¯ä»¥ä¸ºæœ¬åœ° docker é•œåƒæˆ–è€… registry ä¸Šçš„é•œåƒï¼›</li>
<li>inspectï¼šæŸ¥çœ‹ä¸€ä¸ªé•œåƒçš„ manifest æˆ–è€… image config è¯¦ç»†ä¿¡æ¯ï¼›</li>
<li>deleteï¼šåˆ é™¤ä¸€ä¸ªé•œåƒ tagï¼Œå¯ä»¥æ˜¯æœ¬åœ° docker é•œåƒæˆ–è€… registry ä¸Šçš„é•œåƒï¼›</li>
<li>list-tagsï¼šåˆ—å‡ºä¸€ä¸ª registry ä¸ŠæŸä¸ªé•œåƒçš„æ‰€æœ‰ tagï¼›</li>
<li>loginï¼šç™»å½•åˆ°æŸä¸ª registryï¼Œå’Œ docker login ç±»ä¼¼ï¼›</li>
<li>logoutï¼š é€€å‡ºå·²ç»ç™»å½•åˆ°æŸä¸ª registry çš„ auth ä¿¡æ¯ï¼Œå’Œ docker logout ç±»ä¼¼ï¼›</li>
<li>manifest-digestï¼šå‡ åœˆä¸€ä¸ªæ–‡ä»¶çš„ sha256sum å€¼ï¼›</li>
<li>standalone-signã€standalone-verify è¿™ä¸¤ä¸ªæ˜¯å’Œé•œåƒåŠ å¯†ç›¸å…³çš„ï¼Œä½¿ç”¨çš„ä¸æ˜¯å¾ˆå¤šï¼›</li>
<li>syncï¼šåŒæ­¥ä¸€ä¸ªé•œåƒä» A åˆ° Bï¼Œæ„Ÿè§‰å’Œ copy ä¸€æ ·ï¼Œä½† sync æ”¯æŒçš„å‚æ•°æ›´å¤šï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ï¼›</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">completion             generate the autocompletion script <span class="token keyword">for</span> the specified shell
copy                   Copy an IMAGE-NAME from one location to another
delete                 Delete image IMAGE-NAME
<span class="token builtin class-name">help</span>                   Help about any <span class="token builtin class-name">command</span>
inspect                Inspect image IMAGE-NAME
list-tags              List tags <span class="token keyword">in</span> the transport/repository specified by the REPOSITORY-NAME
login                  Login to a container registry
<span class="token builtin class-name">logout</span>                 Logout of a container registry
manifest-digest        Compute a manifest digest of a <span class="token function">file</span>
standalone-sign        Create a signature using <span class="token builtin class-name">local</span> files
standalone-verify      Verify a signature using <span class="token builtin class-name">local</span> files
<span class="token function">sync</span>                   Synchronize one or <span class="token function">more</span> images<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h3><ul>
<li>command-timeoutï¼šå‘½ä»¤è¶…æ—¶æ—¶é—´</li>
<li>debugï¼šå¼€å¯ debug æ¨¡å¼ï¼Œè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—</li>
<li>insecure-policyï¼š ä½¿ç”¨éå®‰å…¨çš„ policyï¼Œå¦‚æœæ²¡æœ‰é…ç½® policy çš„è¯ï¼Œéœ€è¦åŠ ä¸Šè¯¥å‚æ•°</li>
<li>override-archï¼šå¤„ç†é•œåƒæ—¶è¦†ç›–å®¢æˆ·ç«¯ CPU ä½“ç³»æ¶æ„ï¼Œå¦‚åœ¨ amd64 çš„æœºå™¨ä¸Šç”¨ skopeo å¤„ç† arm64 çš„é•œåƒ</li>
<li>override-osï¼š å¤„ç†é•œåƒæ—¶è¦†ç›–å®¢æˆ·ç«¯ OS</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Flags:
      --command-timeout duration   <span class="token function">timeout</span> <span class="token keyword">for</span> the <span class="token builtin class-name">command</span> execution
      --debug                      <span class="token builtin class-name">enable</span> debug output
  -h, --help                       <span class="token builtin class-name">help</span> <span class="token keyword">for</span> skopeo
      --insecure-policy            run the tool without any policy check
      --override-arch ARCH         use ARCH instead of the architecture of the machine <span class="token keyword">for</span> choosing images
      --override-os OS             use OS instead of the running OS <span class="token keyword">for</span> choosing images
      --override-variant VARIANT   use VARIANT instead of the running architecture variant <span class="token keyword">for</span> choosing images
      --policy string              Path to a trust policy <span class="token function">file</span>
      --registries.d DIR           use registry configuration files <span class="token keyword">in</span> DIR <span class="token punctuation">(</span>e.g. <span class="token keyword">for</span> container signature storage<span class="token punctuation">)</span>
      --tmpdir string              directory used to store temporary files
  -v, --version                    Version <span class="token keyword">for</span> Skopeo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¸€ä¸‹æ˜¯æˆ‘åœ¨ä½¿ç”¨ skopeo å‘½ä»¤æ—¶å€™çš„ä¸€äº›å‚æ•°</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">--insecure-policy --src-tls-verify<span class="token operator">=</span>false --dest-tls-verify<span class="token operator">=</span>false<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="IMAGE-NAMES-é•œåƒæ ¼å¼-ğŸ¤”ï¸"><a href="#IMAGE-NAMES-é•œåƒæ ¼å¼-ğŸ¤”ï¸" class="headerlink" title="IMAGE NAMES é•œåƒæ ¼å¼ ğŸ¤”ï¸"></a>IMAGE NAMES é•œåƒæ ¼å¼ ğŸ¤”ï¸</h3><p>åœ¨ä½¿ç”¨ skopeo ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“åœ¨å‘½ä»¤è¡Œä¸­é•œåƒçš„æ ¼å¼ï¼Œä¸‹é¢æ˜¯å®˜æ–¹è¯¦ç»†çš„æ–‡æ¡£æ ¼å¼ã€‚æ— è®ºæˆ‘ä»¬çš„ src é•œåƒè¿˜æ˜¯ dest é•œåƒéƒ½è¦æ»¡è¶³ä»¥ä¸‹æ ¼å¼æ‰å¯ä»¥ã€‚</p>
<blockquote>
<p>Most commands refer to container images, using a <em>transport</em> <code>:</code> <em>details</em> format. The following formats are supported:</p>
</blockquote>
<blockquote>
<p>**containers-storage:**<em>docker-reference</em> An image located in a local containers&#x2F;storage image store. Both the location and image store are specified in &#x2F;etc&#x2F;containers&#x2F;storage.conf. (Backend for Podman, CRI-O, Buildah and friends)</p>
</blockquote>
<blockquote>
<p>**dir:**<em>path</em> An existing local directory <em>path</em> storing the manifest, layer tarballs and signatures as individual files. This is a non-standardized format, primarily useful for debugging or noninvasive container inspection.</p>
</blockquote>
<blockquote>
<p>**docker:&#x2F;&#x2F;**<em>docker-reference</em> An image in a registry implementing the â€œDocker Registry HTTP API V2â€. By default, uses the authorization state in either <code>$XDG_RUNTIME_DIR/containers/auth.json</code>, which is set using <code>(skopeo login)</code>. If the authorization state is not found there, <code>$HOME/.docker/config.json</code> is checked, which is set using <code>(docker login)</code>.</p>
</blockquote>
<blockquote>
<p><strong>docker-archive:<em><strong>path</strong></em></strong>[**:**<em>docker-reference</em>] An image is stored in the <code>docker save</code> formatted file. <em>docker-reference</em> is only used when creating such a file, and it must not contain a digest.</p>
</blockquote>
<blockquote>
<p>**docker-daemon:**<em>docker-reference</em> An image <em>docker-reference</em> stored in the docker daemon internal storage. <em>docker-reference</em> must contain either a tag or a digest. Alternatively, when reading images, the format can be docker-daemon:algo:digest (an image ID).</p>
</blockquote>
<blockquote>
<p>**oci:<em><strong>path</strong></em>:**<em>tag</em> An image <em>tag</em> in a directory compliant with â€œOpen Container Image Layout Specificationâ€ at <em>path</em>.</p>
</blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™å‡ ç§é•œåƒçš„åå­—ï¼Œå¯¹åº”ç€é•œåƒå­˜åœ¨çš„æ–¹å¼ï¼Œä¸åŒå­˜åœ¨çš„æ–¹å¼å¯¹é•œåƒçš„ layer å¤„ç†çš„æ–¹å¼ä¹Ÿä¸ä¸€æ ·ï¼Œæ¯”å¦‚ <code>docker://</code> è¿™ç§æ–¹å¼æ˜¯å­˜åœ¨ registry ä¸Šçš„ï¼Œ<code>docker-daemon:</code> æ˜¯å­˜åœ¨æœ¬åœ° docker pull ä¸‹æ¥çš„ï¼Œå†æ¯”å¦‚ <code>docker-archive</code> æ˜¯é€šè¿‡ docker save å‡ºæ¥çš„é•œåƒã€‚åŒä¸€ä¸ªé•œåƒæœ‰è¿™å‡ ç§å­˜åœ¨çš„æ–¹å¼å°±åƒæ°´åˆ†å­æœ‰æ°”ä½“ã€æ¶²ä½“ã€å›ºä½“ä¸€æ ·ã€‚å¯ä»¥è¿™æ ·å»ç†è§£ï¼Œä»–ä»¬è¡¨è¿°çš„éƒ½æ˜¯åŒä¸€ä¸ªé•œåƒï¼Œåªä¸è¿‡æ˜¯å­˜åœ¨çš„æ–¹å¼ä¸ä¸€æ ·è€Œå·²ã€‚</p>
<p>IMAGE NAMESï¼ˆé•œåƒæ ¼å¼ï¼‰examplecontainers-storage:containers-storage:dir:dir:&#x2F;PATHdocker:&#x2F;&#x2F;docker:&#x2F;&#x2F;k8s.gcr.io&#x2F;kube-apiserver:v1.17.5docker-daemon:docker-daemon:alpine:latestdocker-archive:docker-archive:alpine.tar (docker save)oci:oci:alpine:latest</p>
<h3 id="skopeo-login"><a href="#skopeo-login" class="headerlink" title="skopeo login"></a>skopeo login</h3><p>åœ¨ä½¿ç”¨ skopeo å‰å¦‚æœ src æˆ– dest é•œåƒæ˜¯åœ¨ registry ä¸­çš„ï¼Œå¦‚æœé public çš„é•œåƒéœ€è¦ç›¸åº”çš„ auth è®¤è¯ï¼Œå¯ä»¥ä½¿ç”¨ docker login æˆ–è€… skopeo login çš„æ–¹å¼ç™»å½•åˆ° registryï¼Œç”Ÿæˆå¦‚ä¸‹æ ¼å¼çš„ registry ç™»å½•é…ç½®æ–‡ä»¶ã€‚</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">$ jq <span class="token string">"."</span> ~/.docker/config.json
<span class="token punctuation">&#123;</span>
  <span class="token property">"auths"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"https://index.docker.io/v1/"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token property">"auth"</span><span class="token operator">:</span> <span class="token string">"d2sdwdaqWMasss7bSVlJFpmQE43Sw=="</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"HttpHeaders"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"User-Agent"</span><span class="token operator">:</span> <span class="token string">"Docker-Client/19.03.5 (linux)"</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"experimental"</span><span class="token operator">:</span> <span class="token string">"enabled"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="skopeo-copy"><a href="#skopeo-copy" class="headerlink" title="skopeo copy"></a>skopeo copy</h3><blockquote>
<p>Copy an IMAGE-NAME from one location to another</p>
</blockquote>
<blockquote>
<p>å°†ä¸€ä¸ªé•œåƒä» A å¤åˆ¶åˆ° B</p>
</blockquote>
<p>æ³¨æ„ä¸€ä¸‹ï¼Œè¿™é‡Œçš„ location å°±æ˜¯æŒ‡çš„ä¸Šé¢æåˆ°çš„ <code>IMAGE NAMES</code> ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>skopeo copy src dest</code> å¯ä»¥æœ‰ 6*6&#x3D;36 ç§ç»„åˆï¼æ¯”å¦‚æˆ‘å¯ä»¥å°†ä¸€ä¸ªé•œåƒä»ä¸€ä¸ª registry å¤åˆ¶åˆ°å¦ä¸€ä¸ª registryï¼š<code>skopeo copy docker://IMAGE_NAME docker://IMAGE_NAME</code>ï¼›æˆ–è€…å°†ä¸€ä¸ªé•œåƒä» registry ä¸­å¤åˆ¶åˆ°ä¸€ä¸ªæœ¬åœ°ç›®å½• <code>skopeo copy docker://k8s.gcr.io/pause:3.3 dir:pause:3.3</code></p>
<ul>
<li>ä» regsitry A åˆ° registry B å¤åˆ¶é•œåƒ</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo copy docker://k8s.gcr.io/kube-apiserver:v1.17.5 docker://hub.k8s.li/kube-apiserver:v1.17.5 --dest-authfile /root/.docker/config.json
Getting image <span class="token builtin class-name">source</span> signatures
Copying blob 597de8ba0c30 <span class="token keyword">done</span>
Copying blob e13a88fa950c <span class="token keyword">done</span>
Copying config f640481f6d <span class="token keyword">done</span>
Writing manifest to image destination
Storing signatures<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>skopeo è¾“å‡ºçš„æ—¥å¿—æ˜¾ç¤ºæ˜¯ Copying blob 597de8ba0c30 done.å¯ä»¥çœ‹åˆ° skopeo æ˜¯ç›´æ¥ä» registry ä¸­ copy é•œåƒ layer çš„ blob æ–‡ä»¶ï¼Œä¼ è¾“æ˜¯é•œåƒåœ¨ registry ä¸­å­˜å‚¨çš„åŸå§‹æ ¼å¼ã€‚</p>
</blockquote>
<ul>
<li>å°†é•œåƒä» registry å¤åˆ¶åˆ°æœ¬åœ°ç›®å½•</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo copy docker://k8s.gcr.io/pause:3.3 dir:pause:3.3
Getting image <span class="token builtin class-name">source</span> signatures
Copying blob aeab776c4837 <span class="token keyword">done</span>
Copying config 0184c1613d <span class="token keyword">done</span>
Writing manifest to image destination
Storing signatures
$ tree pause:3.3
pause:3.3
â”œâ”€â”€ 0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da
â”œâ”€â”€ aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b
â”œâ”€â”€ manifest.json
â””â”€â”€ version

<span class="token comment"># æŸ¥çœ‹é•œåƒçš„ manifest æ–‡ä»¶</span>

$ jq <span class="token string">'.'</span> pause:3.3/manifest.json
<span class="token punctuation">&#123;</span>
  <span class="token string">"schemaVersion"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
  <span class="token string">"mediaType"</span><span class="token builtin class-name">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span>,
  <span class="token string">"config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"mediaType"</span><span class="token builtin class-name">:</span> <span class="token string">"application/vnd.docker.container.image.v1+json"</span>,
    <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">743</span>,
    <span class="token string">"digest"</span><span class="token builtin class-name">:</span> <span class="token string">"sha256:0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da"</span>
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"layers"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token string">"mediaType"</span><span class="token builtin class-name">:</span> <span class="token string">"application/vnd.docker.image.rootfs.diff.tar.gzip"</span>,
      <span class="token string">"size"</span><span class="token builtin class-name">:</span> <span class="token number">296517</span>,
      <span class="token string">"digest"</span><span class="token builtin class-name">:</span> <span class="token string">"sha256:aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b"</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span>

<span class="token comment"># æ ¹æ® manifest æ–‡ä»¶æŸ¥çœ‹é•œåƒçš„ image config æ–‡ä»¶</span>

$ jq <span class="token string">'.'</span> pause:3.3/0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da

<span class="token punctuation">&#123;</span>
  <span class="token string">"architecture"</span><span class="token builtin class-name">:</span> <span class="token string">"amd64"</span>,
  <span class="token string">"config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"Env"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
    <span class="token punctuation">]</span>,
    <span class="token string">"Entrypoint"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"/pause"</span>
    <span class="token punctuation">]</span>,
    <span class="token string">"WorkingDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/"</span>,
    <span class="token string">"OnBuild"</span><span class="token builtin class-name">:</span> null
  <span class="token punctuation">&#125;</span>,
  <span class="token string">"created"</span><span class="token builtin class-name">:</span> <span class="token string">"2020-05-02T09:46:29.068489061Z"</span>,
  <span class="token string">"history"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token string">"created"</span><span class="token builtin class-name">:</span> <span class="token string">"2020-05-02T09:46:29.068489061Z"</span>,
      <span class="token string">"created_by"</span><span class="token builtin class-name">:</span> <span class="token string">"ARG ARCH"</span>,
      <span class="token string">"comment"</span><span class="token builtin class-name">:</span> <span class="token string">"buildkit.dockerfile.v0"</span>,
      <span class="token string">"empty_layer"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token punctuation">&#123;</span>
      <span class="token string">"created"</span><span class="token builtin class-name">:</span> <span class="token string">"2020-05-02T09:46:29.068489061Z"</span>,
      <span class="token string">"created_by"</span><span class="token builtin class-name">:</span> <span class="token string">"ADD bin/pause-amd64 /pause # buildkit"</span>,
      <span class="token string">"comment"</span><span class="token builtin class-name">:</span> <span class="token string">"buildkit.dockerfile.v0"</span>
    <span class="token punctuation">&#125;</span>,
    <span class="token punctuation">&#123;</span>
      <span class="token string">"created"</span><span class="token builtin class-name">:</span> <span class="token string">"2020-05-02T09:46:29.068489061Z"</span>,
      <span class="token string">"created_by"</span><span class="token builtin class-name">:</span> <span class="token string">"ENTRYPOINT [<span class="token entity" title="\&quot;">\"</span>/pause<span class="token entity" title="\&quot;">\"</span>]"</span>,
      <span class="token string">"comment"</span><span class="token builtin class-name">:</span> <span class="token string">"buildkit.dockerfile.v0"</span>,
      <span class="token string">"empty_layer"</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>,
  <span class="token string">"os"</span><span class="token builtin class-name">:</span> <span class="token string">"linux"</span>,
  <span class="token string">"rootfs"</span><span class="token builtin class-name">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"layers"</span>,
    <span class="token string">"diff_ids"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token string">"sha256:48a5e87615149095fad57d5db80f2cd9728b5562900eccb32842a45e8e8a61ae"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>å°†é•œåƒä» registry å¤åˆ¶åˆ°æœ¬åœ°ç›®å½•ï¼Œä»¥ OCI æ ¼å¼ä¿å­˜</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo copy docker://k8s.gcr.io/pause:3.3 oci:images
Getting image <span class="token builtin class-name">source</span> signatures
Copying blob aeab776c4837 <span class="token keyword">done</span>
Copying config fa5df7713f <span class="token keyword">done</span>
Writing manifest to image destination
Storing signatures
$ tree images
images
â”œâ”€â”€ blobs
â”‚   â””â”€â”€ sha256
â”‚       â”œâ”€â”€ 3450ba84b8fbfd12cbf58710c0b5678f4311a888d4d5c42b053faefa1af4f8be
â”‚       â”œâ”€â”€ aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b
â”‚       â””â”€â”€ fa5df7713fc78f96e377d236b353d33815073105bbacd381e50705e576ce4da5
â”œâ”€â”€ index.json
â””â”€â”€ oci-layout<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>æ›¿ä»£ docker push åŠŸèƒ½ï¼Œå°†é•œåƒä» docker æœ¬åœ°å­˜å‚¨ push åˆ° registry ä¸­</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo copy docker-daemon:alpine:3.12 docker://hub.k8s.li/library/alpine:3.12
Getting image <span class="token builtin class-name">source</span> signatures
Copying blob 32f366d666a5 <span class="token keyword">done</span>
Copying config 13621d1b12 <span class="token keyword">done</span>
Writing manifest to image destination
Storing signatures<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="skopeo-sync"><a href="#skopeo-sync" class="headerlink" title="skopeo sync"></a>skopeo sync</h3><p>Skopeo sync çš„åŠŸèƒ½åŸºæœ¬ä¸Šç­‰åŒäºé˜¿é‡Œäº‘çš„ <a target="_blank" rel="noopener" href="https://github.com/AliyunContainerService/image-syncer">image-syncer</a> å·¥å…·ï¼Œä¸è¿‡ä¸ªäººè§‰ç€ skopeo è¦æ¯” image-syncer æ›´å¼ºå¤§ï¼Œçµæ´»æ€§æ›´å¼ºä¸€äº›ï¼Œæ±è¿˜åœ¨ä½¿ç”¨ image-syncer çš„è¯ï¼Œå¼ºçƒˆå»ºè®®ä½ ä½¿ç”¨ skopeo sync æ›¿ä»£å®ƒ ğŸ˜‚ã€‚</p>
<ul>
<li>skopeo sync é•œåƒåŒæ­¥æ–‡ä»¶</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">registry.example.com</span><span class="token punctuation">:</span>
    <span class="token key atrule">images</span><span class="token punctuation">:</span>
        <span class="token key atrule">busybox</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token key atrule">redis</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token string">"1.0"</span>
            <span class="token punctuation">-</span> <span class="token string">"2.0"</span>
            <span class="token punctuation">-</span> <span class="token string">"sha256:111111"</span>
    <span class="token key atrule">images-by-tag-regex</span><span class="token punctuation">:</span>
        <span class="token key atrule">nginx</span><span class="token punctuation">:</span> ^1\.13\.<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">-</span>alpine<span class="token punctuation">-</span>perl$
    <span class="token key atrule">credentials</span><span class="token punctuation">:</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> john
        <span class="token key atrule">password</span><span class="token punctuation">:</span> this is a secret
    <span class="token key atrule">tls-verify</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">cert-dir</span><span class="token punctuation">:</span> /home/john/certs
<span class="token key atrule">quay.io</span><span class="token punctuation">:</span>
    <span class="token key atrule">tls-verify</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">images</span><span class="token punctuation">:</span>
        <span class="token key atrule">coreos/etcd</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Image-syncer é•œåƒåŒæ­¥é…ç½®æ–‡ä»¶</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># registry ç™»å½•é…ç½®</span>

<span class="token punctuation">&#123;</span>
    <span class="token key atrule">"quay.io"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>        // This "registry" or "registry/namespace" string should be the same as registry or registry/namespace used below in "images" field.
                            // The format of "registry/namespace" will be more prior matched than "registry"
        <span class="token key atrule">"username"</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"password"</span><span class="token punctuation">:</span> <span class="token string">"xxxxxxxxx"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"insecure"</span><span class="token punctuation">:</span> true         // "insecure" field needs to be true if this registry is a http service<span class="token punctuation">,</span> default value is false<span class="token punctuation">,</span> version of image<span class="token punctuation">-</span>syncer need to be later than v1.0.1 to support this field
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token key atrule">"registry.cn-beijing.aliyuncs.com"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token key atrule">"username"</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"password"</span><span class="token punctuation">:</span> <span class="token string">"xxxxxxxxx"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token key atrule">"registry.hub.docker.com"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>
        <span class="token key atrule">"username"</span><span class="token punctuation">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"password"</span><span class="token punctuation">:</span> <span class="token string">"xxxxxxxxxx"</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token key atrule">"quay.io/coreos"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>     // "registry/namespace" format is supported after v1.0.3 of image<span class="token punctuation">-</span>syncer
        <span class="token key atrule">"username"</span><span class="token punctuation">:</span> <span class="token string">"abc"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"password"</span><span class="token punctuation">:</span> <span class="token string">"xxxxxxxxx"</span><span class="token punctuation">,</span>
        <span class="token key atrule">"insecure"</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment"># é•œåƒé…ç½®</span>
<span class="token punctuation">&#123;</span>
    <span class="token key atrule">"quay.io/coreos/kube-rbac-proxy"</span><span class="token punctuation">:</span> <span class="token string">"quay.io/ruohe/kube-rbac-proxy"</span><span class="token punctuation">,</span>
    "xxxx"<span class="token punctuation">:</span><span class="token string">"xxxxx"</span><span class="token punctuation">,</span>
    "xxx/xxx/xx<span class="token punctuation">:</span>tag1<span class="token punctuation">,</span>tag2<span class="token punctuation">,</span>tag3"<span class="token punctuation">:</span><span class="token string">"xxx/xxx/xx"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>å°†é•œä» registry A åŒæ­¥åˆ° registry B</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo <span class="token function">sync</span> --src <span class="token function">docker</span> --dest <span class="token function">docker</span> k8s.gcr.io/pause:3.3 hub.k8s.li
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Tag presence check                            <span class="token assign-left variable">imagename</span><span class="token operator">=</span><span class="token string">"k8s.gcr.io/pause:3.3"</span> <span class="token assign-left variable">tagged</span><span class="token operator">=</span>true
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Copying image tag <span class="token number">1</span>/1                         <span class="token assign-left variable">from</span><span class="token operator">=</span><span class="token string">"docker://k8s.gcr.io/pause:3.3"</span> <span class="token assign-left variable">to</span><span class="token operator">=</span><span class="token string">"docker://hub.k8s.li/pause:3.3"</span>
Getting image <span class="token builtin class-name">source</span> signatures
Copying blob aeab776c4837 <span class="token keyword">done</span>
Copying config 0184c1613d <span class="token keyword">done</span>
Writing manifest to image destination
Storing signatures
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Synced <span class="token number">1</span> images from <span class="token number">1</span> sources<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>å°†ä¸€ä¸ªé•œåƒä» registry ä¸­åŒæ­¥åˆ°æœ¬åœ°ç›®å½•</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo <span class="token function">sync</span> --src <span class="token function">docker</span> --dest <span class="token function">dir</span> k8s.gcr.io/pause:3.3 images
images
â””â”€â”€ pause:3.3
    â”œâ”€â”€ 0184c1613d92931126feb4c548e5da11015513b9e4c104e7305ee8b53b50a9da
    â”œâ”€â”€ aeab776c48375e1a61810a0a5f59e982e34425ff505a01c2b57dcedc6799c17b
    â”œâ”€â”€ manifest.json
    â””â”€â”€ version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>å°†é•œåƒä»æœ¬åœ°ç›®å½•åŒæ­¥åˆ° registry ä¸­</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ skopeo <span class="token function">sync</span> --src <span class="token function">dir</span> --dest <span class="token function">docker</span> images hub.k8s.li
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Copying image ref <span class="token number">1</span>/1                         <span class="token assign-left variable">from</span><span class="token operator">=</span><span class="token string">"dir:images/pause:3.3"</span> <span class="token assign-left variable">to</span><span class="token operator">=</span><span class="token string">"docker://hub.k8s.li/pause:3.3"</span>
Getting image <span class="token builtin class-name">source</span> signatures
Copying blob aeab776c4837 <span class="token punctuation">[</span>--------------------------------------<span class="token punctuation">]</span> <span class="token number">0</span>.0b / <span class="token number">0</span>.0b
Copying config 0184c1613d <span class="token keyword">done</span>
Writing manifest to image destination
Storing signatures
INFO<span class="token punctuation">[</span>0002<span class="token punctuation">]</span> Synced <span class="token number">1</span> images from <span class="token number">1</span> sources<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="skopeo-inspect"><a href="#skopeo-inspect" class="headerlink" title="skopeo inspect"></a>skopeo inspect</h3><p>è¿™ä¸ªå‘½ä»¤å¯ä»¥æŸ¥çœ‹ä¸€ä¸ªé•œåƒçš„ image config æˆ–è€… manifests æ–‡ä»¶ï¼Œå’Œ docker inspect å‘½ä»¤å·®ä¸å¤šã€‚ä¸åŠ  â€“raw å‚æ•°é»˜è®¤æ˜¯æŸ¥çœ‹é•œåƒçš„ image config æ–‡ä»¶ï¼ŒåŠ ä¸Š â€“raw å‚æ•°å°±æ˜¯æŸ¥çœ‹é•œåƒçš„ manifest æ–‡ä»¶ã€‚</p>
<ul>
<li>æŸ¥çœ‹ docker æœ¬åœ°å­˜å‚¨ä¸­çš„ä¸€ä¸ªé•œåƒçš„ image config æ–‡ä»¶</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">$ skopeo inspect docker-daemon<span class="token operator">:</span>alpine<span class="token operator">:</span>latest
<span class="token punctuation">&#123;</span>
    <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"docker.io/library/alpine"</span><span class="token punctuation">,</span>
    <span class="token property">"Digest"</span><span class="token operator">:</span> <span class="token string">"sha256:ab84514e85b179ff569fd0042969b04f68812f23e187a927cb84664b417e0d3e"</span><span class="token punctuation">,</span>
    <span class="token property">"RepoTags"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"Created"</span><span class="token operator">:</span> <span class="token string">"2021-04-14T19:19:49.594730611Z"</span><span class="token punctuation">,</span>
    <span class="token property">"DockerVersion"</span><span class="token operator">:</span> <span class="token string">"19.03.12"</span><span class="token punctuation">,</span>
    <span class="token property">"Labels"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"Architecture"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>
    <span class="token property">"Os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>
    <span class="token property">"Layers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"sha256:32f366d666a541852cad754ee1cdb53a736110b550f0c2d5a46bc5ba519896b6"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"Env"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>æŸ¥çœ‹ registry ä¸­ä¸€ä¸ªé•œåƒçš„ manifests æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥åˆ¤æ–­é•œåƒæ˜¯å¦å­˜åœ¨</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json">skopeo inspect docker<span class="token operator">:</span><span class="token comment">//alpine:latest --raw | jq '.'</span>

<span class="token punctuation">&#123;</span>
  <span class="token property">"manifests"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:1775bebec23e1f3ce486989bfc9ff3c4e951690df84aa9f926497d82f2ffca9d"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"amd64"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:1f66b8f3041ef8575260056dedd437ed94e7bfeea142ee39ff0d795f94ff2287"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"arm"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>
        <span class="token property">"variant"</span><span class="token operator">:</span> <span class="token string">"v6"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:8d99168167baa6a6a0d7851b9684625df9c1455116a9601835c2127df2aaa2f5"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"arm"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>
        <span class="token property">"variant"</span><span class="token operator">:</span> <span class="token string">"v7"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:53b74ddfc6225e3c8cc84d7985d0f34666e4e8b0b6892a9b2ad1f7516bc21b54"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"arm64"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span><span class="token punctuation">,</span>
        <span class="token property">"variant"</span><span class="token operator">:</span> <span class="token string">"v8"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:52a197664c8ed0b4be6d3b8372f1d21f3204822ba432583644c9ce07f7d6448f"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"386"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:b421672fe4e74a3c7eff2775736e854d69e8d38b2c337063f8699de9c408ddd3"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"ppc64le"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span>
      <span class="token property">"digest"</span><span class="token operator">:</span> <span class="token string">"sha256:8a22269106a31264874cc3a719c1e280e76d42dff1fa57bd9c7fe68dab574023"</span><span class="token punctuation">,</span>
      <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.v2+json"</span><span class="token punctuation">,</span>
      <span class="token property">"platform"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token property">"architecture"</span><span class="token operator">:</span> <span class="token string">"s390x"</span><span class="token punctuation">,</span>
        <span class="token property">"os"</span><span class="token operator">:</span> <span class="token string">"linux"</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">528</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"mediaType"</span><span class="token operator">:</span> <span class="token string">"application/vnd.docker.distribution.manifest.list.v2+json"</span><span class="token punctuation">,</span>
  <span class="token property">"schemaVersion"</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="skopeo-delete"><a href="#skopeo-delete" class="headerlink" title="skopeo delete"></a>skopeo delete</h3><p>ä½¿ç”¨è¿™ä¸ªå‘½ä»¤å¯ä»¥åˆ é™¤é•œåƒ tagã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé€šè¿‡  registry API æ¥åˆ é™¤é•œåƒçš„ tag ä»…ä»…æ˜¯åˆ é™¤äº† tag å¯¹ manifests æ–‡ä»¶çš„å¼•ç”¨ï¼Œå¹¶éçœŸæ­£å°†é•œåƒåˆ é™¤æ‰ã€‚å¦‚æœæƒ³è¦åˆ é™¤é•œåƒçš„ layer è¿˜æ˜¯éœ€è¦é€šè¿‡ registry GC çš„æ–¹å¼ï¼Œå¯å‚è€ƒä¹‹å‰å†™è¿‡çš„ä¸€ç¯‡åšå®¢ã€Š<a href="https://blog.k8s.li/registry-gc.html">docker registry GC åŸç†åˆ†æ</a>ã€‹</p>
<pre class="line-numbers language-none"><code class="language-none">$ skopeo delete docker:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;pause:3.2 --debug
DEBU[0000] Returning credentials from &#x2F;home&#x2F;release&#x2F;.docker&#x2F;config.json
DEBU[0000] Using registries.d directory &#x2F;etc&#x2F;containers&#x2F;registries.d for sigstore configuration
DEBU[0000]  No signature storage configuration found for hub.k8s.li&#x2F;library&#x2F;pause:3.2
DEBU[0000] Looking for TLS certificates and private keys in &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;hub.k8s.li&#x2F;library
DEBU[0000] Loading registries configuration &quot;&#x2F;etc&#x2F;containers&#x2F;registries.conf&quot;
DEBU[0000] GET https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;
DEBU[0000] Ping https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F; status 401
DEBU[0000] GET https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;library&#x2F;pause&#x2F;manifests&#x2F;3.2
DEBU[0000] DELETE https:&#x2F;&#x2F;hub.k8s.li&#x2F;library&#x2F;v2&#x2F;library&#x2F;pause&#x2F;manifests&#x2F;sha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="skopeo-list-tags"><a href="#skopeo-list-tags" class="headerlink" title="skopeo list-tags"></a>skopeo list-tags</h3><p>è¿™ä¸ªå‘½ä»¤å¯ç”¨äºåˆ—å‡º registry ä¸Šçš„æŸä¸ªé•œåƒçš„æ‰€æœ‰ tag ï¼Œä½¿ç”¨æ ‡å‡†çš„ registry API æ¥è·å–é•œåƒ tag</p>
<pre class="line-numbers language-none"><code class="language-none">$ skopeo list-tags docker:&#x2F;&#x2F;k8s.gcr.io&#x2F;pause
&#123;
    &quot;Repository&quot;: &quot;k8s.gcr.io&#x2F;pause&quot;,
    &quot;Tags&quot;: [
        &quot;0.8.0&quot;,
        &quot;1.0&quot;,
        &quot;2.0&quot;,
        &quot;3.0&quot;,
        &quot;3.1&quot;,
        &quot;3.2&quot;,
        &quot;3.3&quot;,
        &quot;3.4.1&quot;,
        &quot;3.5&quot;,
        &quot;go&quot;,
        &quot;latest&quot;,
        &quot;test&quot;,
        &quot;test2&quot;
    ]
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h2><p>ä¸€ä¸‹ç»™å‡ºå‡ ä¸ª skopeo å·¥å…·çš„æœ€ä½³å®è·µ ğŸ˜Š</p>
<h3 id="é•œåƒåŒæ­¥"><a href="#é•œåƒåŒæ­¥" class="headerlink" title="é•œåƒåŒæ­¥"></a>é•œåƒåŒæ­¥</h3><p>å‡å¦‚ç»™ä½ ä¸€ä¸ªé•œåƒåˆ—è¡¨ï¼Œå¦‚ <a target="_blank" rel="noopener" href="https://github.com/kubesphere/ks-installer/blob/master/scripts/images-list.txt">https://github.com/kubesphere/ks-installer/blob/master/scripts/images-list.txt</a>ã€‚å¦‚ä½•å°†å®ƒå¿«é€Ÿåœ°ä»ä¸€ä¸ª registry åŒæ­¥åˆ°å¦ä¸€ä¸ª registry ä¸­å‘¢ï¼Ÿè¿˜æ˜¯ skopeo copy èµ°èµ·ï¼</p>
<ul>
<li>images-list.txt</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">##k8s-images
kubesphere&#x2F;kube-apiserver:v1.20.6
kubesphere&#x2F;kube-scheduler:v1.20.6
kubesphere&#x2F;kube-proxy:v1.20.6
kubesphere&#x2F;kube-controller-manager:v1.20.6
kubesphere&#x2F;kube-apiserver:v1.19.8
kubesphere&#x2F;kube-scheduler:v1.19.8
kubesphere&#x2F;kube-proxy:v1.19.8
kubesphere&#x2F;kube-controller-manager:v1.19.8
kubesphere&#x2F;kube-apiserver:v1.19.9
kubesphere&#x2F;kube-scheduler:v1.19.9
kubesphere&#x2F;kube-proxy:v1.19.9
kubesphere&#x2F;kube-controller-manager:v1.19.9
kubesphere&#x2F;kube-apiserver:v1.18.8
kubesphere&#x2F;kube-scheduler:v1.18.8
kubesphere&#x2F;kube-proxy:v1.18.8
kubesphere&#x2F;kube-controller-manager:v1.18.8
kubesphere&#x2F;kube-apiserver:v1.17.9
kubesphere&#x2F;kube-scheduler:v1.17.9
kubesphere&#x2F;kube-proxy:v1.17.9
kubesphere&#x2F;kube-controller-manager:v1.17.9
kubesphere&#x2F;pause:3.1
kubesphere&#x2F;pause:3.2
kubesphere&#x2F;etcd:v3.4.13
calico&#x2F;cni:v3.16.3
calico&#x2F;kube-controllers:v3.16.3
calico&#x2F;node:v3.16.3
calico&#x2F;pod2daemon-flexvol:v3.16.3
calico&#x2F;typha:v3.16.3
kubesphere&#x2F;flannel:v0.12.0
coredns&#x2F;coredns:1.6.9
kubesphere&#x2F;k8s-dns-node-cache:1.15.12
openebs&#x2F;provisioner-localpv:2.10.1
openebs&#x2F;linux-utils:2.10.0
kubesphere&#x2F;nfs-client-provisioner:v3.1.0-k8s1.11
##csi-images
csiplugin&#x2F;csi-neonsan:v1.2.0
csiplugin&#x2F;csi-neonsan-ubuntu:v1.2.0
csiplugin&#x2F;csi-neonsan-centos:v1.2.0
csiplugin&#x2F;csi-provisioner:v1.5.0
csiplugin&#x2F;csi-attacher:v2.1.1
csiplugin&#x2F;csi-resizer:v0.4.0
csiplugin&#x2F;csi-snapshotter:v2.0.1
csiplugin&#x2F;csi-node-driver-registrar:v1.2.0
csiplugin&#x2F;csi-qingcloud:v1.2.0
##kubesphere-images
kubesphere&#x2F;ks-apiserver:v3.1.1
kubesphere&#x2F;ks-console:v3.1.1
kubesphere&#x2F;ks-controller-manager:v3.1.1
kubesphere&#x2F;ks-installer:v3.1.1
kubesphere&#x2F;kubectl:v1.20.0
kubesphere&#x2F;kubectl:v1.19.0
redis:5.0.12-alpine
alpine:3.14
haproxy:2.0.22-alpine
nginx:1.14-alpine
minio&#x2F;minio:RELEASE.2019-08-07T01-59-21Z
minio&#x2F;mc:RELEASE.2019-08-07T23-14-43Z
mirrorgooglecontainers&#x2F;defaultbackend-amd64:1.4
kubesphere&#x2F;nginx-ingress-controller:v0.35.0
osixia&#x2F;openldap:1.3.0
csiplugin&#x2F;snapshot-controller:v3.0.3
kubesphere&#x2F;kubefed:v0.7.0
kubesphere&#x2F;tower:v0.2.0
kubesphere&#x2F;prometheus-config-reloader:v0.42.1
kubesphere&#x2F;prometheus-operator:v0.42.1
prom&#x2F;alertmanager:v0.21.0
prom&#x2F;prometheus:v2.26.0
prom&#x2F;node-exporter:v0.18.1
kubesphere&#x2F;ks-alerting-migration:v3.1.0
jimmidyson&#x2F;configmap-reload:v0.3.0
kubesphere&#x2F;notification-manager-operator:v1.0.0
kubesphere&#x2F;notification-manager:v1.0.0
kubesphere&#x2F;metrics-server:v0.4.2
kubesphere&#x2F;kube-rbac-proxy:v0.8.0
kubesphere&#x2F;kube-state-metrics:v1.9.7
openebs&#x2F;provisioner-localpv:2.3.0
thanosio&#x2F;thanos:v0.18.0
grafana&#x2F;grafana:7.4.3
##kubesphere-logging-images
kubesphere&#x2F;elasticsearch-oss:6.7.0-1
kubesphere&#x2F;elasticsearch-curator:v5.7.6
kubesphere&#x2F;fluentbit-operator:v0.5.0
kubesphere&#x2F;fluentbit-operator:migrator
kubesphere&#x2F;fluent-bit:v1.6.9
elastic&#x2F;filebeat:6.7.0
kubesphere&#x2F;kube-auditing-operator:v0.1.2
kubesphere&#x2F;kube-auditing-webhook:v0.1.2
kubesphere&#x2F;kube-events-exporter:v0.1.0
kubesphere&#x2F;kube-events-operator:v0.1.0
kubesphere&#x2F;kube-events-ruler:v0.2.0
kubesphere&#x2F;log-sidecar-injector:1.1
docker:19.03
##istio-images
istio&#x2F;pilot:1.6.10
istio&#x2F;proxyv2:1.6.10
jaegertracing&#x2F;jaeger-agent:1.17
jaegertracing&#x2F;jaeger-collector:1.17
jaegertracing&#x2F;jaeger-es-index-cleaner:1.17
jaegertracing&#x2F;jaeger-operator:1.17.1
jaegertracing&#x2F;jaeger-query:1.17
kubesphere&#x2F;kiali:v1.26.1
kubesphere&#x2F;kiali-operator:v1.26.1
##kubesphere-devops-images
kubesphere&#x2F;ks-jenkins:2.249.1
jenkins&#x2F;jnlp-slave:3.27-1
kubesphere&#x2F;s2ioperator:v3.1.0
kubesphere&#x2F;s2irun:v2.1.1
kubesphere&#x2F;builder-base:v3.1.0
kubesphere&#x2F;builder-nodejs:v3.1.0
kubesphere&#x2F;builder-maven:v3.1.0
kubesphere&#x2F;builder-go:v3.1.0
kubesphere&#x2F;s2i-binary:v2.1.0
kubesphere&#x2F;tomcat85-java11-centos7:v2.1.0
kubesphere&#x2F;tomcat85-java11-runtime:v2.1.0
kubesphere&#x2F;tomcat85-java8-centos7:v2.1.0
kubesphere&#x2F;tomcat85-java8-runtime:v2.1.0
kubesphere&#x2F;java-11-centos7:v2.1.0
kubesphere&#x2F;java-8-centos7:v2.1.0
kubesphere&#x2F;java-8-runtime:v2.1.0
kubesphere&#x2F;java-11-runtime:v2.1.0
kubesphere&#x2F;nodejs-8-centos7:v2.1.0
kubesphere&#x2F;nodejs-6-centos7:v2.1.0
kubesphere&#x2F;nodejs-4-centos7:v2.1.0
kubesphere&#x2F;python-36-centos7:v2.1.0
kubesphere&#x2F;python-35-centos7:v2.1.0
kubesphere&#x2F;python-34-centos7:v2.1.0
kubesphere&#x2F;python-27-centos7:v2.1.0
##openpitrix-images
kubespheredev&#x2F;openpitrix-jobs:v3.1.1
##weave-scope-images
weaveworks&#x2F;scope:1.13.0
##kubeedge-images
kubeedge&#x2F;cloudcore:v1.6.2
kubesphere&#x2F;edge-watcher:v0.1.0
kubesphere&#x2F;kube-rbac-proxy:v0.5.0
kubesphere&#x2F;edge-watcher-agent:v0.1.0
##example-images-images
kubesphere&#x2F;examples-bookinfo-productpage-v1:1.16.2
kubesphere&#x2F;examples-bookinfo-reviews-v1:1.16.2
kubesphere&#x2F;examples-bookinfo-reviews-v2:1.16.2
kubesphere&#x2F;examples-bookinfo-reviews-v3:1.16.2
kubesphere&#x2F;examples-bookinfo-details-v1:1.16.2
kubesphere&#x2F;examples-bookinfo-ratings-v1:1.16.3
busybox:1.31.1
joosthofman&#x2F;wget:1.0
kubesphere&#x2F;netshoot:v1.0
nginxdemos&#x2F;hello:plain-text
wordpress:4.8-apache
mirrorgooglecontainers&#x2F;hpa-example:latest
java:openjdk-8-jre-alpine
fluent&#x2F;fluentd:v1.4.2-2.0
perl:latest<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>sync.sh</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">GREEN_COL</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\\">\\</span>033[32;1m"</span>
<span class="token assign-left variable">RED_COL</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\\">\\</span>033[1;31m"</span>
<span class="token assign-left variable">NORMAL_COL</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\\">\\</span>033[0;39m"</span>
<span class="token assign-left variable">SOURCE_REGISTRY</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">TARGET_REGISTRY</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;IMAGES_LIST_FILE<span class="token operator">:=</span>"images-list.txt"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;TARGET_REGISTRY<span class="token operator">:=</span>"hub.k8s.li"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;SOURCE_REGISTRY<span class="token operator">:=</span>"docker.io"&#125;</span>

<span class="token assign-left variable">BLOBS_PATH</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/blobs/sha256"</span>
<span class="token assign-left variable">REPO_PATH</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/repositories"</span>
<span class="token builtin class-name">set</span> -eo pipefail

<span class="token assign-left variable">CURRENT_NUM</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">ALL_IMAGES</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">sed</span> -n <span class="token string">'/#/d;s/:/:/p'</span> $<span class="token punctuation">&#123;</span>IMAGES_LIST_FILE<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">sort</span> -u<span class="token variable">)</span></span>"</span>
<span class="token assign-left variable">TOTAL_NUMS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$&#123;ALL_IMAGES&#125;</span>"</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">)</span></span>

<span class="token function-name function">skopeo_copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">if</span> skopeo copy --insecure-policy --src-tls-verify<span class="token operator">=</span>false --dest-tls-verify<span class="token operator">=</span>false <span class="token punctuation">\</span>
 --override-arch amd64 --override-os linux -q docker://<span class="token variable">$1</span> docker://<span class="token variable">$2</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
 <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$GREEN_COL</span> Progress: <span class="token variable">$&#123;CURRENT_NUM&#125;</span>/<span class="token variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="token variable">$1</span> to <span class="token variable">$2</span> successful <span class="token variable">$NORMAL_COL</span>"</span>
 <span class="token keyword">else</span>
 <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$RED_COL</span> Progress: <span class="token variable">$&#123;CURRENT_NUM&#125;</span>/<span class="token variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="token variable">$1</span> to <span class="token variable">$2</span> failed <span class="token variable">$NORMAL_COL</span>"</span>
 <span class="token builtin class-name">exit</span> <span class="token number">2</span>
 <span class="token keyword">fi</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">image</span> <span class="token keyword">in</span> <span class="token variable">$&#123;ALL_IMAGES&#125;</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
 <span class="token builtin class-name">let</span> <span class="token assign-left variable">CURRENT_NUM</span><span class="token operator">=</span><span class="token variable">$&#123;CURRENT_NUM&#125;</span>+1
 skopeo_copy <span class="token variable">$&#123;SOURCE_REGISTRY&#125;</span>/<span class="token variable">$&#123;image&#125;</span> <span class="token variable">$&#123;TARGET_REGISTRY&#125;</span>/<span class="token variable">$&#123;image&#125;</span>
<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><code>bash sync.sh docker.io ``localhost:5000</code></li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">bash</span> sync.sh docker.io localhost:5000
Progress: <span class="token number">1</span>/143 <span class="token function">sync</span> docker.io/alpine:3.14 to localhost:5000/alpine:3.14 successful
Progress: <span class="token number">2</span>/143 <span class="token function">sync</span> docker.io/busybox:1.31.1 to localhost:5000/busybox:1.31.1 successful
Progress: <span class="token number">3</span>/143 <span class="token function">sync</span> docker.io/calico/cni:v3.16.3 to localhost:5000/calico/cni:v3.16.3 successful
Progress: <span class="token number">4</span>/143 <span class="token function">sync</span> docker.io/calico/kube-controllers:v3.16.3 to localhost:5000/calico/kube-controllers:v3.16.3 successful
Progress: <span class="token number">141</span>/143 <span class="token function">sync</span> docker.io/thanosio/thanos:v0.18.0 to localhost:5000/thanosio/thanos:v0.18.0 successful
Progress: <span class="token number">142</span>/143 <span class="token function">sync</span> docker.io/weaveworks/scope:1.13.0 to localhost:5000/weaveworks/scope:1.13.0 successful
Progress: <span class="token number">143</span>/143 <span class="token function">sync</span> docker.io/wordpress:4.8-apache to localhost:5000/wordpress:4.8-apache successful<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ä½¿ç”¨-registry-å­˜å‚¨ç‰¹æ€§"><a href="#ä½¿ç”¨-registry-å­˜å‚¨ç‰¹æ€§" class="headerlink" title="ä½¿ç”¨ registry å­˜å‚¨ç‰¹æ€§"></a>ä½¿ç”¨ registry å­˜å‚¨ç‰¹æ€§</h3><p>å°†é•œåƒä» registry ä¸­åŒæ­¥åˆ°æœ¬åœ°ç›®å½•ï¼Œä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§ï¼Œå°†æœ¬åœ°ç›®å½•ä¸­çš„é•œåƒè½¬æ¢æˆ registry å­˜å‚¨çš„æ ¼å¼ã€‚è¿™æ ·å­çš„å¥½å¤„å°±æ˜¯å¯ä»¥å»é™¤ä¸€äº› skopeo dir ä¸­é‡å¤çš„ layersï¼Œå‡å°‘é•œåƒçš„æ€»å¤§å°ã€‚å…·ä½“çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™è¿‡çš„ ã€Š<a href="https://blog.k8s.li/skopeo-to-registry.html">å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</a>ã€‹</p>
<ul>
<li>sync.sh</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">GREEN_COL</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\\">\\</span>033[32;1m"</span>
<span class="token assign-left variable">RED_COL</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\\">\\</span>033[1;31m"</span>
<span class="token assign-left variable">NORMAL_COL</span><span class="token operator">=</span><span class="token string">"<span class="token entity" title="\\">\\</span>033[0;39m"</span>
<span class="token assign-left variable">SOURCE_REGISTRY</span><span class="token operator">=</span><span class="token variable">$1</span>
<span class="token assign-left variable">TARGET_REGISTRY</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token assign-left variable">IMAGES_DIR</span><span class="token operator">=</span><span class="token variable">$2</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;IMAGES_DIR<span class="token operator">:=</span>"images"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;IMAGES_LIST_FILE<span class="token operator">:=</span>"images-list.txt"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;TARGET_REGISTRY<span class="token operator">:=</span>"hub.k8s.li"&#125;</span>
<span class="token builtin class-name">:</span> <span class="token variable">$&#123;SOURCE_REGISTRY<span class="token operator">:=</span>"docker.io"&#125;</span>
<span class="token assign-left variable">BLOBS_PATH</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/blobs/sha256"</span>
<span class="token assign-left variable">REPO_PATH</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/repositories"</span>
<span class="token builtin class-name">set</span> -eo pipefail
<span class="token assign-left variable">CURRENT_NUM</span><span class="token operator">=</span><span class="token number">0</span>
<span class="token assign-left variable">ALL_IMAGES</span><span class="token operator">=</span><span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">sed</span> -n <span class="token string">'/#/d;s/:/:/p'</span> $<span class="token punctuation">&#123;</span>IMAGES_LIST_FILE<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">sort</span> -u<span class="token variable">)</span></span>"</span>
<span class="token assign-left variable">TOTAL_NUMS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$&#123;ALL_IMAGES&#125;</span>"</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">)</span></span>
<span class="token function-name function">skopeo_sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">if</span> skopeo <span class="token function">sync</span> --insecure-policy --src-tls-verify<span class="token operator">=</span>false --dest-tls-verify<span class="token operator">=</span>false <span class="token punctuation">\</span>
 --override-arch amd64 --override-os linux --src <span class="token function">docker</span> --dest <span class="token function">dir</span> <span class="token variable">$1</span> <span class="token variable">$2</span> <span class="token operator">></span> /dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
 <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$GREEN_COL</span> Progress: <span class="token variable">$&#123;CURRENT_NUM&#125;</span>/<span class="token variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="token variable">$1</span> to <span class="token variable">$2</span> successful <span class="token variable">$NORMAL_COL</span>"</span>
 <span class="token keyword">else</span>
 <span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token variable">$RED_COL</span> Progress: <span class="token variable">$&#123;CURRENT_NUM&#125;</span>/<span class="token variable">$&#123;TOTAL_NUMS&#125;</span> sync <span class="token variable">$1</span> to <span class="token variable">$2</span> failed <span class="token variable">$NORMAL_COL</span>"</span>
 <span class="token builtin class-name">exit</span> <span class="token number">2</span>
 <span class="token keyword">fi</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">convert_images</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 <span class="token function">rm</span> -rf <span class="token variable">$&#123;IMAGES_DIR&#125;</span><span class="token punctuation">;</span> <span class="token function">mkdir</span> -p <span class="token variable">$&#123;IMAGES_DIR&#125;</span>
 <span class="token keyword">for</span> <span class="token for-or-select variable">image</span> <span class="token keyword">in</span> <span class="token variable">$&#123;ALL_IMAGES&#125;</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
 <span class="token builtin class-name">let</span> <span class="token assign-left variable">CURRENT_NUM</span><span class="token operator">=</span><span class="token variable">$&#123;CURRENT_NUM&#125;</span>+1
 <span class="token assign-left variable">image_name</span><span class="token operator">=</span><span class="token variable">$&#123;image<span class="token operator">%%</span><span class="token operator">:</span>*&#125;</span>
 <span class="token assign-left variable">image_tag</span><span class="token operator">=</span><span class="token variable">$&#123;image<span class="token operator">##</span>*<span class="token operator">:</span>&#125;</span>
 <span class="token assign-left variable">image_repo</span><span class="token operator">=</span><span class="token variable">$&#123;image<span class="token operator">%%</span><span class="token operator">/</span>*&#125;</span>
 skopeo_sync <span class="token variable">$&#123;SOURCE_REGISTRY&#125;</span>/<span class="token variable">$&#123;image&#125;</span> <span class="token variable">$&#123;IMAGES_DIR&#125;</span>/<span class="token variable">$&#123;image_repo&#125;</span>
 <span class="token assign-left variable">manifest</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;IMAGES_DIR&#125;</span>/<span class="token variable">$&#123;image&#125;</span>/manifest.json"</span>
 <span class="token assign-left variable">manifest_sha256</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>sha256sum $<span class="token punctuation">&#123;</span>manifest<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&#123;print $1&#125;'</span><span class="token variable">)</span></span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;BLOBS_PATH&#125;</span>/<span class="token variable">$&#123;manifest_sha256<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;manifest_sha256&#125;</span>
 <span class="token function">ln</span> -f <span class="token variable">$&#123;manifest&#125;</span> <span class="token variable">$&#123;BLOBS_PATH&#125;</span>/<span class="token variable">$&#123;manifest_sha256<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;manifest_sha256&#125;</span>/data
 <span class="token comment"># make image repositories dir</span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/<span class="token punctuation">&#123;</span>_uploads,_layers,_manifests<span class="token punctuation">&#125;</span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/<span class="token punctuation">&#123;</span>current,index/sha256<span class="token punctuation">&#125;</span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>
 <span class="token comment"># create image tag manifest link file</span>
 <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;manifest_sha256&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/current/link
 <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;manifest_sha256&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>/link
 <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;manifest_sha256&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>/link
 <span class="token comment"># link image layers file to registry blobs dir</span>
 <span class="token keyword">for</span> <span class="token for-or-select variable">layer</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">sed</span> <span class="token string">'/v1Compatibility/d'</span> $<span class="token punctuation">&#123;</span>manifest<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">grep</span> -Eo <span class="token string">"<span class="token entity" title="\b">\b</span>[a-f0-9]&#123;64&#125;<span class="token entity" title="\b">\b</span>"</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;BLOBS_PATH&#125;</span>/<span class="token variable">$&#123;layer<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>
 <span class="token function">mkdir</span> -p <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="token variable">$&#123;layer&#125;</span>
 <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;layer&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;REPO_PATH&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="token variable">$&#123;layer&#125;</span>/link
 <span class="token function">ln</span> -f <span class="token variable">$&#123;IMAGES_DIR&#125;</span>/<span class="token variable">$&#123;image&#125;</span>/<span class="token variable">$&#123;layer&#125;</span> <span class="token variable">$&#123;BLOBS_PATH&#125;</span>/<span class="token variable">$&#123;layer<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>/data
 <span class="token keyword">done</span>
 <span class="token keyword">done</span>
<span class="token punctuation">&#125;</span>

convert_images<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>install.sh</li>
</ul>
<p>ä½¿ç”¨è¿™ä¸ªè„šæœ¬å°† registry å­˜å‚¨ä¸­çš„é•œåƒè½¬æ¢æˆ skopeo dir çš„æ–¹å¼ï¼Œç„¶åå†å°†é•œåƒåŒæ­¥åˆ° registry ä¸­ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token assign-left variable">REGISTRY_DOMAIN</span><span class="token operator">=</span><span class="token string">"harbor.k8s.li"</span>
<span class="token assign-left variable">REGISTRY_PATH</span><span class="token operator">=</span><span class="token string">"/var/lib/registry"</span>
<span class="token comment"># åˆ‡æ¢åˆ° registry å­˜å‚¨ä¸»ç›®å½•ä¸‹</span>
<span class="token builtin class-name">cd</span> <span class="token variable">$&#123;REGISTRY_PATH&#125;</span>
<span class="token function-name function">gen_skopeo_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment"># å®šä¹‰ registry å­˜å‚¨çš„ blob ç›®å½• å’Œ repositories ç›®å½•ï¼Œæ–¹ä¾¿åé¢ä½¿ç”¨</span>
    <span class="token assign-left variable">BLOB_DIR</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/blobs/sha256"</span>
    <span class="token assign-left variable">REPO_DIR</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/repositories"</span>
    <span class="token comment"># å®šä¹‰ç”Ÿæˆ skopeo ç›®å½•</span>
    <span class="token assign-left variable">SKOPEO_DIR</span><span class="token operator">=</span><span class="token string">"docker/skopeo"</span>
    <span class="token comment"># é€šè¿‡ find å‡º current æ–‡ä»¶å¤¹å¯ä»¥å¾—åˆ°æ‰€æœ‰å¸¦ tag çš„é•œåƒï¼Œå› ä¸ºä¸€ä¸ª tag å¯¹åº”ä¸€ä¸ª current ç›®å½•</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">image</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">find</span> $<span class="token punctuation">&#123;</span>REPO_DIR<span class="token punctuation">&#125;</span> -type d -name <span class="token string">"current"</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
        <span class="token comment"># æ ¹æ®é•œåƒçš„ tag æå–é•œåƒçš„åå­—</span>
        <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> $<span class="token punctuation">&#123;</span>image<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">awk</span> -F <span class="token string">'/'</span> <span class="token string">'&#123;print $5"/"$6":"$9&#125;'</span><span class="token variable">)</span></span>
        <span class="token assign-left variable">link</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $<span class="token punctuation">&#123;</span>image<span class="token punctuation">&#125;</span>/link <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'s/sha256://'</span><span class="token variable">)</span></span>
        <span class="token assign-left variable">mfs</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;link<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;link&#125;</span>/data"</span>
        <span class="token comment"># åˆ›å»ºé•œåƒçš„ç¡¬é“¾æ¥éœ€è¦çš„ç›®å½•</span>
        <span class="token function">mkdir</span> -p <span class="token string">"<span class="token variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="token variable">$&#123;name&#125;</span>"</span>
        <span class="token comment"># ç¡¬é“¾æ¥é•œåƒçš„ manifests æ–‡ä»¶åˆ°ç›®å½•çš„ manifest æ–‡ä»¶</span>
        <span class="token function">ln</span> <span class="token variable">$&#123;mfs&#125;</span> <span class="token variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="token variable">$&#123;name&#125;</span>/manifest.json
        <span class="token comment"># ä½¿ç”¨æ­£åˆ™åŒ¹é…å‡ºæ‰€æœ‰çš„ sha256 å€¼ï¼Œç„¶åæ’åºå»é‡</span>
        <span class="token assign-left variable">layers</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">grep</span> -Eo <span class="token string">"<span class="token entity" title="\b">\b</span>[a-f0-9]&#123;64&#125;<span class="token entity" title="\b">\b</span>"</span> $<span class="token punctuation">&#123;</span>mfs<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">sort</span> -n <span class="token operator">|</span> <span class="token function">uniq</span><span class="token variable">)</span></span>
        <span class="token keyword">for</span> <span class="token for-or-select variable">layer</span> <span class="token keyword">in</span> <span class="token variable">$&#123;layers&#125;</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
          <span class="token comment"># ç¡¬é“¾æ¥ registry å­˜å‚¨ç›®å½•é‡Œçš„é•œåƒ layer å’Œ images config åˆ°é•œåƒçš„ dir ç›®å½•</span>
            <span class="token function">ln</span> <span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;layer<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>/data <span class="token variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="token variable">$&#123;name&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>
        <span class="token keyword">done</span>
    <span class="token keyword">done</span>
<span class="token punctuation">&#125;</span>
<span class="token function-name function">sync_image</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment"># ä½¿ç”¨ skopeo sync å°† dir æ ¼å¼çš„é•œåƒåŒæ­¥åˆ° harbor</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">project</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> $<span class="token punctuation">&#123;</span>SKOPEO_DIR<span class="token punctuation">&#125;</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
        skopeo <span class="token function">sync</span> --insecure-policy --src-tls-verify<span class="token operator">=</span>false --dest-tls-verify<span class="token operator">=</span>false <span class="token punctuation">\</span>
        --src <span class="token function">dir</span> --dest <span class="token function">docker</span> <span class="token variable">$&#123;SKOPEO_DIR&#125;</span>/<span class="token variable">$&#123;project&#125;</span> <span class="token variable">$&#123;REGISTRY_DOMAIN&#125;</span>/<span class="token variable">$&#123;project&#125;</span>
    <span class="token keyword">done</span>
<span class="token punctuation">&#125;</span>
gen_skopeo_dir<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ä»-registry-å­˜å‚¨ä¸­-select-å‡ºé•œåƒ"><a href="#ä»-registry-å­˜å‚¨ä¸­-select-å‡ºé•œåƒ" class="headerlink" title="ä» registry å­˜å‚¨ä¸­ select å‡ºé•œåƒ"></a>ä» registry å­˜å‚¨ä¸­ select å‡ºé•œåƒ</h3><p>å…ˆå°†é•œåƒåŒæ­¥åˆ°ä¸€ä¸ª registry ä¸­ï¼Œå†å°†é•œåƒä» registry å­˜å‚¨ä¸­æå‡ºæ¥ã€‚è¿™ä¸ª registry å¯ä»¥å½“ä½œä¸€ä¸ªé•œåƒå­˜å‚¨çš„æ± å­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Linux ä¸­ç¡¬é“¾æ¥çš„ç‰¹æ€§å°†é•œåƒ <code>&quot;å¤åˆ¶&quot;</code> ä¸€ä»½å‡ºæ¥ï¼Œç„¶åå†æ‰“ä¸€ä¸ª tar åŒ…ã€‚è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯æ¯æ¬¡æ‰“åŒ…é•œåƒçš„æ—¶å€™éƒ½èƒ½å¤ç”¨å†å²çš„é•œåƒæ•°æ®ï¼Œè€Œä¸”æ€§èƒ½æå¿«ã€‚å…·ä½“çš„åŸç†å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„åšå®¢ã€Š<a href="https://blog.k8s.li/select-registry-images.html">ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼</a>ã€‹</p>
<ul>
<li>å…ˆå°†é•œåƒåŒæ­¥åˆ°ä¸€ä¸ªå›ºå®šçš„ registry ä¸­</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">$ bash sync.sh docker.io localhost:5000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>å†ä½¿ç”¨è¯¥è„šæœ¬å°†é•œåƒä» registry å­˜å‚¨ä¸­æå‡ºæ¥</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token builtin class-name">set</span> -eo pipefail
<span class="token assign-left variable">IMAGES_LIST</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$1</span>"</span>
<span class="token assign-left variable">REGISTRY_PATH</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$2</span>"</span>
<span class="token assign-left variable">OUTPUT_DIR</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$3</span>"</span>
<span class="token assign-left variable">BLOB_DIR</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/blobs/sha256"</span>
<span class="token assign-left variable">REPO_DIR</span><span class="token operator">=</span><span class="token string">"docker/registry/v2/repositories"</span>
<span class="token function">rm</span> -rf <span class="token variable">$&#123;OUTPUT_DIR&#125;</span><span class="token punctuation">;</span> <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">image</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">find</span> $<span class="token punctuation">&#123;</span>IMAGES_LIST<span class="token punctuation">&#125;</span> -type f -name <span class="token string">"*.list"</span> <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token function">grep</span> -Ev <span class="token string">'^#|^/'</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">':'</span><span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
    <span class="token assign-left variable">image_tag</span><span class="token operator">=</span><span class="token variable">$&#123;image<span class="token operator">##</span>*<span class="token operator">:</span>&#125;</span>
    <span class="token assign-left variable">image_name</span><span class="token operator">=</span><span class="token variable">$&#123;image<span class="token operator">%%</span><span class="token operator">:</span>*&#125;</span>
    <span class="token assign-left variable">tag_link</span><span class="token operator">=</span><span class="token variable">$&#123;REGISTRY_PATH&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/current/link
    <span class="token assign-left variable">manifest_sha256</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">sed</span> <span class="token string">'s/sha256://'</span> $<span class="token punctuation">&#123;</span>tag_link<span class="token punctuation">&#125;</span><span class="token variable">)</span></span>
    <span class="token assign-left variable">manifest</span><span class="token operator">=</span><span class="token variable">$&#123;REGISTRY_PATH&#125;</span>/<span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;manifest_sha256<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;manifest_sha256&#125;</span>/data
    <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;manifest_sha256<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;manifest_sha256&#125;</span>
    <span class="token function">ln</span> -f <span class="token variable">$&#123;manifest&#125;</span> <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;manifest_sha256<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;manifest_sha256&#125;</span>/data
    <span class="token comment"># make image repositories dir</span>
    <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/<span class="token punctuation">&#123;</span>_uploads,_layers,_manifests<span class="token punctuation">&#125;</span>
    <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>
    <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/<span class="token punctuation">&#123;</span>current,index/sha256<span class="token punctuation">&#125;</span>
    <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>
    <span class="token comment"># create image tag manifest link file</span>
    <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;manifest_sha256&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/current/link
    <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;manifest_sha256&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/revisions/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>/link
    <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;manifest_sha256&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_manifests/tags/<span class="token variable">$&#123;image_tag&#125;</span>/index/sha256/<span class="token variable">$&#123;manifest_sha256&#125;</span>/link
    <span class="token keyword">for</span> <span class="token for-or-select variable">layer</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">sed</span> <span class="token string">'/v1Compatibility/d'</span> $<span class="token punctuation">&#123;</span>manifest<span class="token punctuation">&#125;</span> <span class="token operator">|</span> <span class="token function">grep</span> -Eo <span class="token string">'\b[a-f0-9]&#123;64&#125;\b'</span> <span class="token operator">|</span> <span class="token function">sort</span> -u<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
        <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;layer<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>
        <span class="token function">mkdir</span> -p <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="token variable">$&#123;layer&#125;</span>
        <span class="token function">ln</span> -f <span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;layer<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>/data <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;BLOB_DIR&#125;</span>/<span class="token variable">$&#123;layer<span class="token operator">:</span>0<span class="token operator">:</span>2&#125;</span>/<span class="token variable">$&#123;layer&#125;</span>/data
        <span class="token builtin class-name">echo</span> -n <span class="token string">"sha256:<span class="token variable">$&#123;layer&#125;</span>"</span> <span class="token operator">></span> <span class="token variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="token variable">$&#123;REPO_DIR&#125;</span>/<span class="token variable">$&#123;image_name&#125;</span>/_layers/sha256/<span class="token variable">$&#123;layer&#125;</span>/link
    <span class="token keyword">done</span>
<span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="å»¶ä¼¸é˜…è¯»"><a href="#å»¶ä¼¸é˜…è¯»" class="headerlink" title="å»¶ä¼¸é˜…è¯»"></a>å»¶ä¼¸é˜…è¯»</h2><ul>
<li><a href="https://blog.k8s.li/Exploring-container-image.html">æ·±å…¥æµ…å‡ºå®¹å™¨é•œåƒçš„ä¸€ç”Ÿ ğŸ¤”</a></li>
<li><a href="https://blog.k8s.li/registry-gc.html">docker registry GC åŸç†åˆ†æ</a></li>
<li><a href="https://blog.k8s.li/docker-registry-to-harbor.html">docker registry è¿ç§»è‡³ harbor</a></li>
<li><a href="https://blog.k8s.li/overlay2-on-package-pipline.html">overlay2 åœ¨æ‰“åŒ…å‘å¸ƒæµæ°´çº¿ä¸­çš„åº”ç”¨</a></li>
<li><a href="https://blog.k8s.li/skopeo-to-registry.html">å¦‚ä½•ä½¿ç”¨ registry å­˜å‚¨çš„ç‰¹æ€§</a></li>
<li><a href="https://blog.k8s.li/select-registry-images.html">ä»€ä¹ˆï¼Ÿå‘å¸ƒæµæ°´çº¿ä¸­é•œåƒâ€œåŒæ­¥â€é€Ÿåº¦åˆæå‡äº† 15 å€ ï¼</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/registry/" rel="tag"># registry</a>
              <a href="/tags/%E9%95%9C%E5%83%8F/" rel="tag"># é•œåƒ</a>
              <a href="/tags/skopeo/" rel="tag"># skopeo</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/pass-platform-release.html" rel="prev" title="äº‘åŸç”Ÿ PaaS äº§å“å‘å¸ƒ&éƒ¨ç½²æ–¹æ¡ˆ">
                  <i class="fa fa-chevron-left"></i> äº‘åŸç”Ÿ PaaS äº§å“å‘å¸ƒ&éƒ¨ç½²æ–¹æ¡ˆ
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/shell-snippet.html" rel="next" title="æ¬ç –å¸¸ç”¨çš„ shell ç‰‡æ®µè®°å½•">
                  æ¬ç –å¸¸ç”¨çš„ shell ç‰‡æ®µè®°å½• <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">25:36</span>
  </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  



  <script src="/js/third-party/fancybox.js"></script>


  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
