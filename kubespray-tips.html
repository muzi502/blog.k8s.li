<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.2.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="kubespray v2.16 版本即将发布，整理一下自己在使用 kubespray 过程中遇到的问题和一些优化建议。 二进制文件在 kubespray 上游的 #7561  PR 中实现了根据 kubespray 的源码生成需要的文件列表和镜像列表。只需要在 repo 的 contrib&#x2F;offline 目录下执行  bash generate_list.sh 就可以生成一个 files.lis">
<meta property="og:type" content="blog">
<meta property="og:title" content="kubespray 部署常见问题和优化汇总">
<meta property="og:url" content="https://blog.k8s.li/kubespray-tips.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="kubespray v2.16 版本即将发布，整理一下自己在使用 kubespray 过程中遇到的问题和一些优化建议。 二进制文件在 kubespray 上游的 #7561  PR 中实现了根据 kubespray 的源码生成需要的文件列表和镜像列表。只需要在 repo 的 contrib&#x2F;offline 目录下执行  bash generate_list.sh 就可以生成一个 files.lis">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-05-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-05-12T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="kubespray">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.k8s.li/kubespray-tips.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/kubespray-tips.html","path":"kubespray-tips.html","title":"kubespray 部署常见问题和优化汇总"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>kubespray 部署常见问题和优化汇总 | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6"><span class="nav-number">1.</span> <span class="nav-text">二进制文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93"><span class="nav-number">2.</span> <span class="nav-text">镜像仓库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96-kubespray-%E9%95%9C%E5%83%8F%E5%A4%A7%E5%B0%8F"><span class="nav-number">3.</span> <span class="nav-text">优化 kubespray 镜像大小</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-registry-%E7%A6%81%E6%AD%A2-push-%E9%95%9C%E5%83%8F"><span class="nav-number">4.</span> <span class="nav-text">docker registry 禁止 push 镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E8%87%AA%E7%AD%BE%E8%AF%81%E4%B9%A6"><span class="nav-number">5.</span> <span class="nav-text">镜像仓库自签证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#containerd-%E6%97%A0%E6%B3%95%E5%8A%A0%E8%BD%BD-CNI-%E9%85%8D%E7%BD%AE%E5%AF%BC%E8%87%B4%E8%8A%82%E7%82%B9-NotReady"><span class="nav-number">6.</span> <span class="nav-text">containerd 无法加载 CNI 配置导致节点 NotReady</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E9%83%A8%E7%BD%B2%E9%80%9F%E5%BA%A6"><span class="nav-number">7.</span> <span class="nav-text">优化部署速度</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E7%94%A8%E6%8F%92%E4%BB%B6"><span class="nav-number">8.</span> <span class="nav-text">启用插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B1%82%E9%83%A8%E7%BD%B2"><span class="nav-number">9.</span> <span class="nav-text">分层部署</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">115</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">147</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail → mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/kubespray-tips.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="kubespray 部署常见问题和优化汇总 | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          kubespray 部署常见问题和优化汇总
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-13 2021-05-13T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2021-05-13T00:00:00+08:00">2021-05-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/kubespray-tips.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="kubespray-tips.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>26k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>24 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>kubespray v2.16 版本即将发布，整理一下自己在使用 kubespray 过程中遇到的问题和一些优化建议。</p>
<h2 id="二进制文件"><a href="#二进制文件" class="headerlink" title="二进制文件"></a>二进制文件</h2><p>在 kubespray 上游的 <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kubespray/pull/7561">#7561</a>  PR 中实现了根据 kubespray 的源码生成需要的文件列表和镜像列表。只需要在 repo 的 <code>contrib/offline</code> 目录下执行 <code> bash generate_list.sh</code> 就可以生成一个 files.list 和一个 images.list  文件。然后就可以根据这个文件来下载依赖的文件和镜像。如下</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">cd</span> contrib/offline
$ <span class="token function">bash</span> generate_list.sh
$ tree temp
temp
├── files.list
├── generate.sh
└── images.list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>files.list 内容如下</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> temp/files.list
https://get.helm.sh/helm-v3.5.4-linux-amd64.tar.gz
https://github.com/containerd/nerdctl/releases/download/v0.8.0/nerdctl-0.8.0-linux-amd64.tar.gz
https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz
https://github.com/containers/crun/releases/download/0.19/crun-0.19-linux-amd64
https://github.com/coreos/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz
https://github.com/kata-containers/runtime/releases/download/1.12.1/kata-static-1.12.1-x86_64.tar.xz
https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.20.0/crictl-v1.20.0-linux-amd64.tar.gz
https://github.com/kubernetes-sigs/krew/releases/download/v0.4.1/krew.tar.gz
https://github.com/projectcalico/calico/archive/v3.17.4.tar.gz
https://github.com/projectcalico/calicoctl/releases/download/v3.17.4/calicoctl-linux-amd64
https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubeadm
https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubectl
https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后通过 wget 进行下载</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">wget</span> -x -P temp/files -i temp/files.list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>下载后的文件如下</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"> tree temp/files
temp/files
├── get.helm.sh
│   └── helm-v3.5.4-linux-amd64.tar.gz
├── github.com
│   ├── containerd
│   │   └── nerdctl
│   │       └── releases
│   │           └── download
│   │               └── v0.8.0
│   │                   └── nerdctl-0.8.0-linux-amd64.tar.gz
│   ├── containernetworking
│   │   └── plugins
│   │       └── releases
│   │           └── download
│   │               └── v0.9.1
│   │                   └── cni-plugins-linux-amd64-v0.9.1.tgz
│   ├── containers
│   │   └── crun
│   │       └── releases
│   │           └── download
│   │               └── <span class="token number">0.19</span>
│   │                   └── crun-0.19-linux-amd64
│   ├── coreos
│   │   └── etcd
│   │       └── releases
│   │           └── download
│   │               └── v3.4.13
│   │                   └── etcd-v3.4.13-linux-amd64.tar.gz
│   ├── kata-containers
│   │   └── runtime
│   │       └── releases
│   │           └── download
│   │               └── <span class="token number">1.12</span>.1
│   │                   └── kata-static-1.12.1-x86_64.tar.xz
│   ├── kubernetes-sigs
│   │   ├── cri-tools
│   │   │   └── releases
│   │   │       └── download
│   │   │           └── v1.20.0
│   │   │               └── crictl-v1.20.0-linux-amd64.tar.gz
│   │   └── krew
│   │       └── releases
│   │           └── download
│   │               └── v0.4.1
│   │                   └── krew.tar.gz
│   └── projectcalico
│       ├── calico
│       │   └── archive
│       │       └── v3.17.4.tar.gz
│       └── calicoctl
│           └── releases
│               └── download
│                   └── v3.17.4
│                       └── calicoctl-linux-amd64
└── storage.googleapis.com
    └── kubernetes-release
        └── release
            └── v1.20.6
                └── bin
                    └── linux
                        └── amd64
                            ├── kubeadm
                            ├── kubectl
                            └── kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>保持这个目录结构不变，把它们上传到自己的文件服务器上，然后再修改这个文件的下载参数，只需要在前面加上文件服务器的 URL 即可，比如我的配置：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Download URLs</span>
<span class="token key atrule">download_url</span><span class="token punctuation">:</span> <span class="token string">"https://dl.k8s.li"</span>
<span class="token key atrule">kubelet_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kube_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubelet"</span>
<span class="token key atrule">kubectl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kube_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubectl"</span>
<span class="token key atrule">kubeadm_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kubeadm_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubeadm"</span>
<span class="token key atrule">etcd_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/coreos/etcd/releases/download/&#123;&#123; etcd_version &#125;&#125;/etcd-&#123;&#123; etcd_version &#125;&#125;-linux-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token key atrule">cni_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/containernetworking/plugins/releases/download/&#123;&#123; cni_version &#125;&#125;/cni-plugins-linux-&#123;&#123; image_arch &#125;&#125;-&#123;&#123; cni_version &#125;&#125;.tgz"</span>
<span class="token key atrule">calicoctl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/projectcalico/calicoctl/releases/download/&#123;&#123; calico_ctl_version &#125;&#125;/calicoctl-linux-&#123;&#123; image_arch &#125;&#125;"</span>
<span class="token key atrule">calico_crds_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/projectcalico/calico/archive/&#123;&#123; calico_version &#125;&#125;.tar.gz"</span>
<span class="token key atrule">crictl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/kubernetes-sigs/cri-tools/releases/download/&#123;&#123; crictl_version &#125;&#125;/crictl-&#123;&#123; crictl_version &#125;&#125;-&#123;&#123; ansible_system | lower &#125;&#125;-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token key atrule">helm_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/get.helm.sh/helm-&#123;&#123; helm_version &#125;&#125;-linux-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token key atrule">crun_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/containers/crun/releases/download/&#123;&#123; crun_version &#125;&#125;/crun-&#123;&#123; crun_version &#125;&#125;-linux-&#123;&#123; image_arch &#125;&#125;"</span>
<span class="token key atrule">kata_containers_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/kata-containers/runtime/releases/download/&#123;&#123; kata_containers_version &#125;&#125;/kata-static-&#123;&#123; kata_containers_version &#125;&#125;-&#123;&#123; ansible_architecture &#125;&#125;.tar.xz"</span>
<span class="token key atrule">nerdctl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/containerd/nerdctl/releases/download/v&#123;&#123; nerdctl_version &#125;&#125;/nerdctl-&#123;&#123; nerdctl_version &#125;&#125;-&#123;&#123; ansible_system | lower &#125;&#125;-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>images.list 是 kubespray 所有可能会用到的镜像，如下：</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># cat temp/images.list</span>
docker.io/amazon/aws-alb-ingress-controller:v1.1.9
docker.io/amazon/aws-ebs-csi-driver:v0.5.0
docker.io/cloudnativelabs/kube-router:v1.2.2
docker.io/integratedcloudnative/ovn4nfv-k8s-plugin:v1.1.0
docker.io/k8scloudprovider/cinder-csi-plugin:v1.20.0
docker.io/kubeovn/kube-ovn:v1.6.2
docker.io/kubernetesui/dashboard-amd64:v2.2.0
docker.io/kubernetesui/metrics-scraper:v1.0.6
docker.io/library/haproxy:2.3
docker.io/library/nginx:1.19
docker.io/library/registry:2.7.1
docker.io/nfvpe/multus:v3.7
docker.io/rancher/local-path-provisioner:v0.0.19
docker.io/weaveworks/weave-kube:2.8.1
docker.io/weaveworks/weave-npc:2.8.1
docker.io/xueshanf/install-socat:latest
k8s.gcr.io/addon-resizer:1.8.11
k8s.gcr.io/coredns:1.7.0
k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64:1.8.3
k8s.gcr.io/dns/k8s-dns-node-cache:1.17.1
k8s.gcr.io/ingress-nginx/controller:v0.43.0
k8s.gcr.io/kube-apiserver:v1.20.6
k8s.gcr.io/kube-controller-manager:v1.20.6
k8s.gcr.io/kube-proxy:v1.20.6
k8s.gcr.io/kube-registry-proxy:0.4
k8s.gcr.io/kube-scheduler:v1.20.6
k8s.gcr.io/metrics-server/metrics-server:v0.4.2
k8s.gcr.io/pause:3.3
quay.io/calico/cni:v3.17.4
quay.io/calico/kube-controllers:v3.17.4
quay.io/calico/node:v3.17.4
quay.io/calico/typha:v3.17.4
quay.io/cilium/cilium-init:2019-04-05
quay.io/cilium/cilium:v1.8.9
quay.io/cilium/operator:v1.8.9
quay.io/coreos/etcd:v3.4.13
quay.io/coreos/flannel:v0.13.0-amd64
quay.io/datawire/ambassador-operator:v1.2.9
quay.io/external_storage/cephfs-provisioner:v2.1.0-k8s1.11
quay.io/external_storage/local-volume-provisioner:v2.3.4
quay.io/external_storage/rbd-provisioner:v2.1.1-k8s1.11
quay.io/jetstack/cert-manager-cainjector:v1.0.4
quay.io/jetstack/cert-manager-controller:v1.0.4
quay.io/jetstack/cert-manager-webhook:v1.0.4
quay.io/k8scsi/csi-attacher:v2.2.0
quay.io/k8scsi/csi-node-driver-registrar:v1.3.0
quay.io/k8scsi/csi-provisioner:v1.6.0
quay.io/k8scsi/csi-resizer:v0.5.0
quay.io/k8scsi/csi-snapshotter:v2.1.1
quay.io/k8scsi/snapshot-controller:v2.0.1
quay.io/l23network/k8s-netchecker-agent:v1.0
quay.io/l23network/k8s-netchecker-server:v1.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可使用 skopeo 将镜像同步到自己的 registry 中，如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">image</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> temp/images.list<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> skopeo copy docker://<span class="token variable">$&#123;image&#125;</span> docker://hub.k8s.li/<span class="token variable">$&#123;image<span class="token operator">#</span>*<span class="token operator">/</span>&#125;</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>当时写这个脚本的时候一堆蛇皮 sed 替换操作写得想 🤮，比如有些变量会有 ansible 的 if else 判断，这就意味着也要用 shell 去实现它的判断逻辑。比如使用 shell 处理的时候需要将这下面坨转换成 shell 的 if else，而且还不能换行：</p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">coredns_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; kube_image_repo &#125;&#125;&#123;&#123;'/coredns/coredns' if (coredns_image_is_namespaced | bool) else '/coredns' &#125;&#125;"</span>
<span class="token key atrule">coredns_image_tag</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; coredns_version if (coredns_image_is_namespaced | bool) else (coredns_version | regex_replace('^v', '')) &#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># special handling for https://github.com/kubernetes-sigs/kubespray/pull/7570</span>
<span class="token function">sed</span> -i <span class="token string">'s#^coredns_image_repo=.*#coredns_image_repo=$&#123;kube_image_repo&#125;$(if printf "%s\\n%s\\n" v1.21 $&#123;kube_version%.*&#125; | sort --check=quiet --version-sort; then echo -n /coredns/coredns;else echo -n /coredns; fi)#'</span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/generate.sh

<span class="token function">sed</span> -i <span class="token string">'s#^coredns_image_tag=.*#coredns_image_tag=$(if printf "%s\\n%s\\n" v1.21 $&#123;kube_version%.*&#125; | sort --check=quiet --version-sort; then echo -n $&#123;coredns_version&#125;;else echo -n $&#123;coredns_version/v/&#125;; fi)#'</span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/generate.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>当时还学会了一手，在 shell 中使用 <code>printf &quot;%s\\n%s\\n&quot; $v1 $v2 | sort --check=quiet --version-sort</code> 这种方式可以判断两个版本号的大小，而且是最简单便捷的。</p>
<h2 id="镜像仓库"><a href="#镜像仓库" class="headerlink" title="镜像仓库"></a>镜像仓库</h2><p>之前提到的是根据镜像列表将需要的镜像同步到自己的 registry 中，但对于本地开发测试来讲，这种手动导入比较费事费力。在看了大佬写的 <a target="_blank" rel="noopener" href="https://fuckcloudnative.io/posts/docker-registry-proxy/">Docker 镜像加速教程</a> 和 <a target="_blank" rel="noopener" href="https://www.chenshaowen.com/blog/how-to-run-a-private-registry-mirror.html">如何搭建一个私有的镜像仓库 mirror</a>  就想到了可以使用 docker registry 的 proxy 特性来部署几个 kubespray 需要的镜像仓库。如下</p>
<table>
<thead>
<tr>
<th>origin</th>
<th>mirror</th>
</tr>
</thead>
<tbody><tr>
<td>docker.io</td>
<td>hub.k8s.li</td>
</tr>
<tr>
<td>k8s.gcr.io</td>
<td>gcr.k8s.li</td>
</tr>
<tr>
<td>quay.io</td>
<td>quay.k8s.li</td>
</tr>
</tbody></table>
<ul>
<li>config.yml</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">0.1</span>
<span class="token key atrule">log</span><span class="token punctuation">:</span>
  <span class="token key atrule">fields</span><span class="token punctuation">:</span>
    <span class="token key atrule">service</span><span class="token punctuation">:</span> registry
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">blobdescriptor</span><span class="token punctuation">:</span> inmemory
  <span class="token key atrule">oss</span><span class="token punctuation">:</span>
    <span class="token key atrule">accesskeyid</span><span class="token punctuation">:</span> xxxx <span class="token comment"># 这里配置阿里云 OSS 的 accesskeyid</span>
    <span class="token key atrule">accesskeysecret</span><span class="token punctuation">:</span> xxxx <span class="token comment"># 这里配置阿里云 OSS 的 accesskeysecret</span>
    <span class="token key atrule">region</span><span class="token punctuation">:</span> oss<span class="token punctuation">-</span>cn<span class="token punctuation">-</span>beijing <span class="token comment"># 配置 OSS bucket 的区域，比如 oss-cn-beijing</span>
    <span class="token key atrule">internal</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">bucket</span><span class="token punctuation">:</span> fileserver <span class="token comment"># 配置存储 bucket 的名称</span>
    <span class="token key atrule">rootdirectory</span><span class="token punctuation">:</span> /kubespray/registry <span class="token comment"># 配置路径</span>
  <span class="token key atrule">delete</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token key atrule">headers</span><span class="token punctuation">:</span>
    <span class="token key atrule">X-Content-Type-Options</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nosniff<span class="token punctuation">]</span>
<span class="token key atrule">health</span><span class="token punctuation">:</span>
  <span class="token key atrule">storagedriver</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s
    <span class="token key atrule">threshold</span><span class="token punctuation">:</span> <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>docker-compose.yml</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">gcr-registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry<span class="token punctuation">:</span><span class="token number">2</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> gcr<span class="token punctuation">-</span>registry
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./config.yml<span class="token punctuation">:</span>/etc/docker/registry/config.yml
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span>5001<span class="token punctuation">:</span><span class="token number">5001</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> REGISTRY_HTTP_ADDR=0.0.0.0<span class="token punctuation">:</span><span class="token number">5001</span>
      <span class="token punctuation">-</span> REGISTRY_PROXY_REMOTEURL=https<span class="token punctuation">:</span>//k8s.gcr.io

  <span class="token key atrule">hub-registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry<span class="token punctuation">:</span><span class="token number">2</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> hub<span class="token punctuation">-</span>registry
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./config.yml<span class="token punctuation">:</span>/etc/docker/registry/config.yml
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span>5002<span class="token punctuation">:</span><span class="token number">5002</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> REGISTRY_HTTP_ADDR=0.0.0.0<span class="token punctuation">:</span><span class="token number">5002</span>
      <span class="token punctuation">-</span> REGISTRY_PROXY_REMOTEURL=https<span class="token punctuation">:</span>//docker.io

  <span class="token key atrule">quay-registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry<span class="token punctuation">:</span><span class="token number">2</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> quay<span class="token punctuation">-</span>registry
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./config.yml<span class="token punctuation">:</span>/etc/docker/registry/config.yml
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span>5003<span class="token punctuation">:</span><span class="token number">5003</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> REGISTRY_HTTP_ADDR=0.0.0.0<span class="token punctuation">:</span><span class="token number">5003</span>
      <span class="token punctuation">-</span> REGISTRY_PROXY_REMOTEURL=https<span class="token punctuation">:</span>//quay.io<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>nginx.conf</li>
</ul>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span>       [::]:443</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  gcr.k8s.li</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate</span> domain.crt</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> domain.key</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_static</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">100000m</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_method</span> !~* GET|HEAD)</span> <span class="token punctuation">&#123;</span>
         <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span>   http://localhost:5001</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span>       [::]:443</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  hub.k8s.li</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate</span> domain.crt</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> domain.key</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_static</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">100000m</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_method</span> !~* GET|HEAD)</span> <span class="token punctuation">&#123;</span>
         <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span>   http://localhost:5002</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span>       [::]:443</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  quay.k8s.li</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate</span> domain.crt</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> domain.key</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_static</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">100000m</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_method</span> !~* GET|HEAD)</span> <span class="token punctuation">&#123;</span>
         <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span>   http://localhost:5003</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>相关配置文件在 <a target="_blank" rel="noopener" href="https://github.com/muzi502/registry-mirrors">registry-mirrors</a> 这个 repo 中。</p>
<h2 id="优化-kubespray-镜像大小"><a href="#优化-kubespray-镜像大小" class="headerlink" title="优化 kubespray 镜像大小"></a>优化 kubespray 镜像大小</h2><p>kubespray v1.25.1 版本官方构建的镜像大小为 <code>1.41GB</code>，对于一些场景下希望镜像小一些，可以通过如下方法构建一个体积较小的镜像。</p>
<ul>
<li>首先构建一个 base 镜像，对于不经常变动的我们把它封装在一个 base 镜像里，只有当相关依赖更新了才需要重新构建这个 base 镜像，<code>Dockerfile.base</code> 如下：</li>
</ul>
<pre class="line-numbers language-Dockerfile" data-language="Dockerfile"><code class="language-Dockerfile">FROM python:3.6-slim
ENV KUBE_VERSION v1.20.6

RUN apt update -y \
 &amp;&amp; apt install -y \
 libssl-dev sshpass apt-transport-https jq moreutils vim moreutils iputils-ping \
 ca-certificates curl gnupg2 software-properties-common rsync wget tcpdump \
 &amp;&amp; rm -rf &#x2F;var&#x2F;lib&#x2F;apt&#x2F;lists&#x2F;* \
 &amp;&amp; wget -q https:&#x2F;&#x2F;dl.k8s.io&#x2F;$KUBE_VERSION&#x2F;bin&#x2F;linux&#x2F;amd64&#x2F;kubectl -O &#x2F;usr&#x2F;local&#x2F;bin&#x2F;kubectl \
 &amp;&amp; chmod a+x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;kubectl

WORKDIR &#x2F;kubespray
COPY . .
RUN python3 -m pip install -r requirements.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>构建 kubespray 镜像：FROM 的 base 镜像就使用我们刚刚构建好的镜像，对于 kubespray 来讲，相关依赖已经在 base 镜像中安装好了，这里构建的时候只需要把 repo 复制到 &#x2F;kubespray 目录下即可，如下：</p>
<pre class="line-numbers language-Dockerfile" data-language="Dockerfile"><code class="language-Dockerfile">FROM kubespray:v2.16.0-base-kube-v1.20.6
COPY . &#x2F;kubespray<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>这样构建出来的镜像大小不到 600MB，比之前小了很多，而且每次构建镜像的时候也比较快。只不过当 <code>requirements.txt</code>  文件更新后需要重新构建 base 镜像，并修改 kubespray 的 FROM 镜像为新的 base 镜像。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubespray     v2.15.1                  73294562105a    <span class="token number">1</span>.41GB
kubespray     v2.16-kube-v1.20.6-1.0   80b735995e48    579MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>kubespray 默认没有加如 <code>.dockerignore</code>，这就意味着构建镜像的时候会把当前目录下的所有内容复制到镜像里，会导致镜像工作目录下可能很混乱，在容器里 debug 的时候不太美观，强迫症患者可以在 repo 中加入如下的 <code>.dockerignore</code> 文件。</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">.ansible-lint
.editorconfig
.git
.github
.gitignore
.gitlab-ci
.gitlab-ci.yml
.gitmodules
.markdownlint.yaml
.nojekyll
CNAME
CONTRIBUTING.md
Dockerfile
Makefile
OWNERS
README.md
RELEASE.md
SECURITY_CONTACTS
build
code-of-conduct.md
docs
index.html
logo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="docker-registry-禁止-push-镜像"><a href="#docker-registry-禁止-push-镜像" class="headerlink" title="docker registry 禁止 push 镜像"></a>docker registry 禁止 push 镜像</h2><p>默认直接使用 docker registry 来部署镜像仓库的话，比如我的 hub.k8s.li ，因为没有权限限制会导致任何可访问该镜像仓库的客户端可以 push 镜像，这有点不安全，需要安全加固一下。因为 pull 镜像的时候客户端走的都是 HTTP GET 请求，可以通过 nginx 禁止 POST、PUT 这种请求方法，这样就可以禁止 push 镜像。在 nginx 的 server 字段中添加如下内容：</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_method</span> !~* GET)</span> <span class="token punctuation">&#123;</span>
         <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样在 push 镜像的时候会返回 403 的错误</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/root <span class="token comment"># docker pull hub.k8s.li/calico/node:v3.17.3</span>
v3.17.3: Pulling from calico/node
282bf12aa8be: Pull complete
4ac1bb9354ad: Pull complete
Digest: sha256:3595a9a945a7ba346a12ee523fc7ae15ed35f1e6282b76bce7fec474d28d68bb
Status: Downloaded newer image <span class="token keyword">for</span> hub.k8s.li/calico/node:v3.17.3
root@debian:/root <span class="token comment"># docker push !$</span>
root@debian:/root <span class="token comment"># docker push hub.k8s.li/calico/node:v3.17.3</span>
The push refers to repository <span class="token punctuation">[</span>hub.k8s.li/calico/node<span class="token punctuation">]</span>
bc19ae092bb4: Preparing
94333d52d45d: Preparing
error parsing HTTP <span class="token number">403</span> response body: invalid character <span class="token string">'&lt;'</span> looking <span class="token keyword">for</span> beginning of value: <span class="token string">"&lt;html><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>&lt;head>&lt;title>403 Forbidden&lt;/title>&lt;/head><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>&lt;body bgcolor=<span class="token entity" title="\&quot;">\"</span>white<span class="token entity" title="\&quot;">\"</span>><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>&lt;center>&lt;h1>403 Forbidden&lt;/h1>&lt;/center><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>&lt;hr>&lt;center>nginx&lt;/center><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>&lt;/body><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>&lt;/html><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>那么需要 push 镜像的时候怎么办？</p>
<p>docker registry 启动的时候 bind 在 127.0.0.1 上，而不是 0.0.0.0，通过 localhost:5000 来 push 镜像。</p>
<h2 id="镜像仓库自签证书"><a href="#镜像仓库自签证书" class="headerlink" title="镜像仓库自签证书"></a>镜像仓库自签证书</h2><p>如果镜像仓库使用的是自签证书，可以跑下面这个 playbook 将自签证书添加到所有节点的 trusted CA dir 中，这样无需配置 <code>insecure-registries</code> 也能拉取镜像。</p>
<p><code>add-registry-ca.yml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gen_certs <span class="token punctuation">|</span> target ca<span class="token punctuation">-</span>certificate store file
      <span class="token key atrule">set_fact</span><span class="token punctuation">:</span>
        <span class="token key atrule">ca_cert_path</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
          <span class="token punctuation">&#123;</span>% if ansible_os_family == "Debian" <span class="token punctuation">-</span>%<span class="token punctuation">&#125;</span>
          /usr/local/share/ca<span class="token punctuation">-</span>certificates/registry<span class="token punctuation">-</span>ca.crt
          <span class="token punctuation">&#123;</span>%<span class="token punctuation">-</span> elif ansible_os_family == "RedHat" <span class="token punctuation">-</span>%<span class="token punctuation">&#125;</span>
          /etc/pki/ca<span class="token punctuation">-</span>trust/source/anchors/registry<span class="token punctuation">-</span>ca.crt
          <span class="token punctuation">&#123;</span>%<span class="token punctuation">-</span> elif ansible_os_family in <span class="token punctuation">[</span><span class="token string">"Flatcar Container Linux by Kinvolk"</span><span class="token punctuation">]</span> <span class="token punctuation">-</span>%<span class="token punctuation">&#125;</span>
          /etc/ssl/certs/registry<span class="token punctuation">-</span>ca.pem
          <span class="token punctuation">&#123;</span>%<span class="token punctuation">-</span> elif ansible_os_family == "Suse" <span class="token punctuation">-</span>%<span class="token punctuation">&#125;</span>
          /etc/pki/trust/anchors/registry<span class="token punctuation">-</span>ca.pem
          <span class="token punctuation">&#123;</span>%<span class="token punctuation">-</span> elif ansible_os_family == "ClearLinux" <span class="token punctuation">-</span>%<span class="token punctuation">&#125;</span>
          /usr/share/ca<span class="token punctuation">-</span>certs/registry<span class="token punctuation">-</span>ca.pem
          <span class="token punctuation">&#123;</span>%<span class="token punctuation">-</span> endif %<span class="token punctuation">&#125;</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> facts

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gen_certs <span class="token punctuation">|</span> add CA to trusted CA dir
      <span class="token key atrule">copy</span><span class="token punctuation">:</span>
        <span class="token key atrule">src</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; registry_cert_path &#125;&#125;"</span>
        <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; ca_cert_path &#125;&#125;"</span>
      <span class="token key atrule">register</span><span class="token punctuation">:</span> registry_ca_cert

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gen_certs <span class="token punctuation">|</span> update ca<span class="token punctuation">-</span>certificates (Debian/Ubuntu/SUSE/Flatcar)  <span class="token comment"># noqa 503</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> update<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>certificates
      <span class="token key atrule">when</span><span class="token punctuation">:</span> registry_ca_cert.changed and ansible_os_family in <span class="token punctuation">[</span><span class="token string">"Debian"</span><span class="token punctuation">,</span> <span class="token string">"Flatcar Container Linux by Kinvolk"</span><span class="token punctuation">,</span> <span class="token string">"Suse"</span><span class="token punctuation">]</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gen_certs <span class="token punctuation">|</span> update ca<span class="token punctuation">-</span>certificates (RedHat)  <span class="token comment"># noqa 503</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> update<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>trust extract
      <span class="token key atrule">when</span><span class="token punctuation">:</span> registry_ca_cert.changed and ansible_os_family == "RedHat"

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gen_certs <span class="token punctuation">|</span> update ca<span class="token punctuation">-</span>certificates (ClearLinux)  <span class="token comment"># noqa 503</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> clrtrust add "<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ca_cert_path <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>"
      <span class="token key atrule">when</span><span class="token punctuation">:</span> registry_ca_cert.changed and ansible_os_family == "ClearLinux"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>将自签的 registry 证书放到本地，执行 playbook 并指定 <code>registry_cert_path</code> 为正确的路径</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/kubespray<span class="token comment"># ansible-playbook -i deploy/inventory -e registry_cert_path=/kubespray/registry_ca.pem add-registry-ca.yml</span>

PLAY <span class="token punctuation">[</span>all<span class="token punctuation">]</span> **********************************************************************************
Thursday <span class="token number">29</span> April <span class="token number">2021</span>  08:18:25 +0000 <span class="token punctuation">(</span><span class="token number">0</span>:00:00.077<span class="token punctuation">)</span>       <span class="token number">0</span>:00:00.077 ********

TASK <span class="token punctuation">[</span>Gen_certs <span class="token operator">|</span> target ca-certificate store file<span class="token punctuation">]</span> *****************************************
ok: <span class="token punctuation">[</span>kube-control-2<span class="token punctuation">]</span>
ok: <span class="token punctuation">[</span>kube-control-3<span class="token punctuation">]</span>
ok: <span class="token punctuation">[</span>kube-control-1<span class="token punctuation">]</span>
ok: <span class="token punctuation">[</span>kube-node-1<span class="token punctuation">]</span>
Thursday <span class="token number">29</span> April <span class="token number">2021</span>  08:18:25 +0000 <span class="token punctuation">(</span><span class="token number">0</span>:00:00.389<span class="token punctuation">)</span>       <span class="token number">0</span>:00:00.467 ********

TASK <span class="token punctuation">[</span>Gen_certs <span class="token operator">|</span> <span class="token function">add</span> CA to trusted CA dir<span class="token punctuation">]</span> *************************************************
changed: <span class="token punctuation">[</span>kube-control-2<span class="token punctuation">]</span>
changed: <span class="token punctuation">[</span>kube-control-3<span class="token punctuation">]</span>
changed: <span class="token punctuation">[</span>kube-control-1<span class="token punctuation">]</span>
changed: <span class="token punctuation">[</span>kube-node-1<span class="token punctuation">]</span>
Thursday <span class="token number">29</span> April <span class="token number">2021</span>  08:18:29 +0000 <span class="token punctuation">(</span><span class="token number">0</span>:00:04.433<span class="token punctuation">)</span>       <span class="token number">0</span>:00:04.901 ********
Thursday <span class="token number">29</span> April <span class="token number">2021</span>  08:18:30 +0000 <span class="token punctuation">(</span><span class="token number">0</span>:00:00.358<span class="token punctuation">)</span>       <span class="token number">0</span>:00:05.259 ********

TASK <span class="token punctuation">[</span>Gen_certs <span class="token operator">|</span> update ca-certificates <span class="token punctuation">(</span>RedHat<span class="token punctuation">)</span><span class="token punctuation">]</span> ******************************************
changed: <span class="token punctuation">[</span>kube-control-1<span class="token punctuation">]</span>
changed: <span class="token punctuation">[</span>kube-control-3<span class="token punctuation">]</span>
changed: <span class="token punctuation">[</span>kube-control-2<span class="token punctuation">]</span>
changed: <span class="token punctuation">[</span>kube-node-1<span class="token punctuation">]</span>
Thursday <span class="token number">29</span> April <span class="token number">2021</span>  08:18:33 +0000 <span class="token punctuation">(</span><span class="token number">0</span>:00:02.938<span class="token punctuation">)</span>       <span class="token number">0</span>:00:08.197 ********

PLAY RECAP **********************************************************************************
kube-control-1             <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">3</span>    <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span>
kube-control-2             <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">3</span>    <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span>
kube-control-3             <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">3</span>    <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span>
kube-node-1                <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">3</span>    <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span>

Thursday <span class="token number">29</span> April <span class="token number">2021</span>  08:18:33 +0000 <span class="token punctuation">(</span><span class="token number">0</span>:00:00.355<span class="token punctuation">)</span>  <span class="token number">0</span>:00:08.553 ********
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Gen_certs <span class="token operator">|</span> <span class="token function">add</span> CA to trusted CA <span class="token function">dir</span> ------------------------------------------------------------- <span class="token number">4</span>.43s
Gen_certs <span class="token operator">|</span> update ca-certificates <span class="token punctuation">(</span>RedHat<span class="token punctuation">)</span> ------------------------------------------------------------- <span class="token number">2</span>.94s
Gen_certs <span class="token operator">|</span> target ca-certificate store <span class="token function">file</span> ------------------------------------------------------------- <span class="token number">0</span>.39s
Gen_certs <span class="token operator">|</span> update ca-certificates <span class="token punctuation">(</span>Debian/Ubuntu/SUSE/Flatcar<span class="token punctuation">)</span> ------------------------------------------------------------- <span class="token number">0</span>.36s
Gen_certs <span class="token operator">|</span> update ca-certificates <span class="token punctuation">(</span>ClearLinux<span class="token punctuation">)</span> -------------------------------------------------------------- <span class="token number">0</span>.36s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="containerd-无法加载-CNI-配置导致节点-NotReady"><a href="#containerd-无法加载-CNI-配置导致节点-NotReady" class="headerlink" title="containerd 无法加载 CNI 配置导致节点 NotReady"></a>containerd 无法加载 CNI 配置导致节点 NotReady</h2><p>偶现问题，重启一下 containerd 就可以了，具体原因还没排查出来</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/kubespray<span class="token comment"># ansible all -i deploy/inventory -m service -a "name=containerd state=restarted"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="优化部署速度"><a href="#优化部署速度" class="headerlink" title="优化部署速度"></a>优化部署速度</h2><p>Kubespray 部署的时候有个 task 专门用来下载部署需要的镜像，由于是操作的所有节点，会将一些不需要的镜像拉取到该节点上。比如 kube-apiserver、kube-controller-manager、kube-scheduler 这些在 node 节点上不会用到的镜像也会在 node 节点上拉取，这样会导致 download 的 task 比较耗时。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TASK <span class="token punctuation">[</span>download <span class="token builtin class-name">:</span> set_container_facts <span class="token operator">|</span> Display the name of the image being processed<span class="token punctuation">]</span> ********************************************************************************************
ok: <span class="token punctuation">[</span>kube-control-3<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-controller-manager"</span>
<span class="token punctuation">&#125;</span>
ok: <span class="token punctuation">[</span>kube-control-2<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-controller-manager"</span>
<span class="token punctuation">&#125;</span>
ok: <span class="token punctuation">[</span>kube-control-1<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-controller-manager"</span>
<span class="token punctuation">&#125;</span>
ok: <span class="token punctuation">[</span>kube-node-1<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-controller-manager"</span>
<span class="token punctuation">&#125;</span>

ok: <span class="token punctuation">[</span>kube-control-3<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-scheduler"</span>
<span class="token punctuation">&#125;</span>
ok: <span class="token punctuation">[</span>kube-control-2<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-scheduler"</span>
<span class="token punctuation">&#125;</span>
ok: <span class="token punctuation">[</span>kube-control-1<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-scheduler"</span>
<span class="token punctuation">&#125;</span>
ok: <span class="token punctuation">[</span>kube-node-1<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-scheduler"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可用通过 <code>download_container: false</code> 这个参数来禁用 download container 这个 task，这样在 pod 启动的时候只拉取需要的镜像，可以节省一些部署耗时。</p>
<h2 id="启用插件"><a href="#启用插件" class="headerlink" title="启用插件"></a>启用插件</h2><p>Kubespray 官方支持的插件列表如下，默认是 false 禁用了插件。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Kubernetes dashboard</span>
<span class="token comment"># RBAC required. see docs/getting-started.md for access details.</span>
<span class="token key atrule">dashboard_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># Addons which can be enabled</span>
<span class="token key atrule">helm_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">krew_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">registry_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">metrics_server_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">enable_network_policy</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">local_path_provisioner_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">local_volume_provisioner_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">local_volume_provisioner_directory_mode</span><span class="token punctuation">:</span> <span class="token number">0700</span>
<span class="token key atrule">cinder_csi_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">aws_ebs_csi_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">azure_csi_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">gcp_pd_csi_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">vsphere_csi_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">persistent_volumes_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">cephfs_provisioner_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">rbd_provisioner_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">ingress_nginx_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">ingress_ambassador_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">ingress_alb_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">cert_manager_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">expand_persistent_volumes</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">metallb_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># containerd official CLI tool</span>
<span class="token key atrule">nerdctl_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在部署的时候如果想启动某些插件可以在自己本地对应的 inventory 目录下的 <code>group_vars/k8s_cluster/addons.yml</code> 文件中选择开启相应的插件，比如 <code>inventory/sample/group_vars/k8s_cluster/addons.yml</code>。</p>
<h2 id="分层部署"><a href="#分层部署" class="headerlink" title="分层部署"></a>分层部署</h2><p>这个是我们对 kubespray 二开的一个优化项。kubespray 在部署集群的时候运行的 playbook 是 <code>cluster.yml</code>，在集群部署的过程中可能会因为你一些不稳定因素导致集群部署失败，失败后再次尝试部署的话，kubespray 会从头开始再跑一遍已经成功运行的 task，这样的效率会比较低。因此需要使用某种方法记录一下已经成功执行的 task 或 roles，失败后重新部署的时候就跳过这些已经成功运行的 task，然后从上次失败的地方开始运行。</p>
<p>大体的思路是根据 <code>cluster.yml</code> 中的 roles 拆分为不同的层即 layer，如 bootstrap-os、download、kubernetes、network、apps ，在部署的过程中每运行完一个 layer 就将它记录在一个文件中，部署的时候会根据这个文件来判断是否需要部署，如果文件中记录存在的话就说明已经成功部署完成了，就跳过它，继续执行未执行的 layer。</p>
<p>至于拆分的方式大概有两种，一种是根据 tag 、一种是将 <code>cluster.yml</code> 文件拆分成若干个 playbook 文件。通过 tag 的方式可能会比较复杂一些，在这里还是选择拆分的方式。拆分的粒度有大有小，以下是我认为比较合理的拆封方式：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">playbooks
├── 00-default-ssh-config.yml <span class="token comment"># 默认需要运行的 playbook，用于配置堡垒机和配置 ssh 认证</span>
├── 01-cluster-bootstrap-os.yml <span class="token comment"># 初始化集群节点 OS，安装容器运行时，下载部署依赖的文件</span>
├── 02-cluster-etcd.yml <span class="token comment"># 部署 etcd 集群</span>
├── 03-cluster-kubernetes.yml <span class="token comment"># 部署 kubernetes 集群</span>
├── 04-cluster-network.yml <span class="token comment"># 部署网络插件</span>
├── 05-cluster-apps.yml <span class="token comment"># 部署一些 addons 组件，如 coredns 等</span>
├── 06-cluster-self-host.yml <span class="token comment"># 平台 self-host 自托管的部分</span>
└── <span class="token number">11</span>-reset-reset.yml <span class="token comment"># 移除集群</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>00-default-ssh-config.yml</li>
</ul>
<p>该 playbook 用于配置堡垒机和 ssh 认证，kubespray 需要使用  public key 的方式 ssh 连接到部署节点，如果部署节点没有配置 ssh public key 的方式，可以指定 <code>ssh_cert_path</code> 这个变量的路径，将公钥添加到主机的 authorized_key 中。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> bastion<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> bastion<span class="token punctuation">-</span>ssh<span class="token punctuation">-</span>config<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token string">"bastion"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster<span class="token punctuation">:</span>etcd
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Setting up ssh public key authentication
      <span class="token key atrule">authorized_key</span><span class="token punctuation">:</span> <span class="token string">"user=&#123;&#123; ansible_user &#125;&#125; key=&#123;&#123; lookup('file', '&#123;&#123; ssh_cert_path &#125;&#125;') &#125;&#125;"</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span> ssh_cert_path is defined
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> ssh<span class="token punctuation">-</span>config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>01-cluster-bootstrap-os.yml</li>
</ul>
<p>这个 playbook 用于初始化部署节点 OS、安装一些依赖的 rpm&#x2F;deb 包、安装容器运行时、下载二进制文件等</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gather facts
  <span class="token key atrule">import_playbook</span><span class="token punctuation">:</span> ../facts.yml

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster<span class="token punctuation">:</span>etcd
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> linear
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> bootstrap<span class="token punctuation">-</span>os<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> bootstrap<span class="token punctuation">-</span>os<span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster<span class="token punctuation">:</span>etcd
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/preinstall<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> preinstall <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> <span class="token string">"container-engine"</span><span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"container-engine"</span><span class="token punctuation">,</span> <span class="token key atrule">when</span><span class="token punctuation">:</span> deploy_container_engine<span class="token punctuation">|</span>default(true) <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> download<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> download<span class="token punctuation">,</span> <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token string">"not skip_downloads"</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>02-cluster-etcd.yml</li>
</ul>
<p>这个主要是部署 etcd 集群和分发 etcd 集群的证书到集群节点。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gather facts
  <span class="token key atrule">import_playbook</span><span class="token punctuation">:</span> ../facts.yml

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> etcd
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> etcd
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> etcd
      <span class="token key atrule">vars</span><span class="token punctuation">:</span>
        <span class="token key atrule">etcd_cluster_setup</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">etcd_events_cluster_setup</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; etcd_events_cluster_enabled &#125;&#125;"</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span> not etcd_kubeadm_enabled<span class="token punctuation">|</span> default(false)

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> etcd
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> etcd
      <span class="token key atrule">vars</span><span class="token punctuation">:</span>
        <span class="token key atrule">etcd_cluster_setup</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">etcd_events_cluster_setup</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span> not etcd_kubeadm_enabled<span class="token punctuation">|</span> default(false)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>03-cluster-kubernetes.yml</li>
</ul>
<p>这个主要是部署 kubernetes 集群，虽然这里的 roles 很多，但并没有做过多的拆分，个人还是觉着这部分可以作为一个整体。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gather facts
  <span class="token key atrule">import_playbook</span><span class="token punctuation">:</span> ../facts.yml

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/node<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> node <span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube_control_plane
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/control<span class="token punctuation">-</span>plane<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> master <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/client<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> client <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/cluster_roles<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>roles <span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/kubeadm<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> kubeadm<span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/node<span class="token punctuation">-</span>label<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>label <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>04-cluster-network.yml</li>
</ul>
<p>这个主要是部署网络插件</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gather facts
  <span class="token key atrule">import_playbook</span><span class="token punctuation">:</span> ../facts.yml

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> network_plugin<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> network <span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube_control_plane
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/network_plugin<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> network <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/policy_controller<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> policy<span class="token punctuation">-</span>controller <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>05-cluster-apps.yml</li>
</ul>
<p>这个主要是部署一些 addons 插件，必须 coredns, ingress-controller，以及一些外置的 provisioner 等。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gather facts
  <span class="token key atrule">import_playbook</span><span class="token punctuation">:</span> ../facts.yml

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube_control_plane
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/external_cloud_controller<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>cloud<span class="token punctuation">-</span>controller <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/ingress_controller<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>controller <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/external_provisioner<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>provisioner <span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube_control_plane
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> apps <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>拆分的时候可以根据自己的实际情况去除一些不必要的 roles，比如 <code>calico_rr</code> , <code>win_nodes</code> ，我们的产品本身就不支持 calico 路由反射器、也不支持 windows 节点，因此直接将这两部分给去除了，这样也能避免去执行这些 task 的判断，能节省一定的时间。</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> calico_rr
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> network_plugin/calico/rr<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'network'</span><span class="token punctuation">,</span> <span class="token string">'calico_rr'</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube_control_plane<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> win_nodes/kubernetes_patch<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"master"</span><span class="token punctuation">,</span> <span class="token string">"win_nodes"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
              <a href="/tags/kubespray/" rel="tag"># kubespray</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/deploy-k8s-by-kubespray.html" rel="prev" title="使用 Kubespray 本地开发测试部署 kubernetes 集群">
                  <i class="fa fa-chevron-left"></i> 使用 Kubespray 本地开发测试部署 kubernetes 集群
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/make-offline-mirrors.html" rel="next" title="使用 GitHub Actions 自动化构建 yum/apt 离线源">
                  使用 GitHub Actions 自动化构建 yum/apt 离线源 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">25:30</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
