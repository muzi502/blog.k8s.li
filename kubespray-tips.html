<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.2.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="kubespray v2.16 ç‰ˆæœ¬å³å°†å‘å¸ƒï¼Œæ•´ç†ä¸€ä¸‹è‡ªå·±åœ¨ä½¿ç”¨ kubespray è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œä¸€äº›ä¼˜åŒ–å»ºè®®ã€‚ äºŒè¿›åˆ¶æ–‡ä»¶åœ¨ kubespray ä¸Šæ¸¸çš„ #7561  PR ä¸­å®ç°äº†æ ¹æ® kubespray çš„æºç ç”Ÿæˆéœ€è¦çš„æ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ã€‚åªéœ€è¦åœ¨ repo çš„ contrib&#x2F;offline ç›®å½•ä¸‹æ‰§è¡Œ  bash generate_list.sh å°±å¯ä»¥ç”Ÿæˆä¸€ä¸ª files.lis">
<meta property="og:type" content="blog">
<meta property="og:title" content="kubespray éƒ¨ç½²å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æ±‡æ€»">
<meta property="og:url" content="https://blog.k8s.li/kubespray-tips.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="kubespray v2.16 ç‰ˆæœ¬å³å°†å‘å¸ƒï¼Œæ•´ç†ä¸€ä¸‹è‡ªå·±åœ¨ä½¿ç”¨ kubespray è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œä¸€äº›ä¼˜åŒ–å»ºè®®ã€‚ äºŒè¿›åˆ¶æ–‡ä»¶åœ¨ kubespray ä¸Šæ¸¸çš„ #7561  PR ä¸­å®ç°äº†æ ¹æ® kubespray çš„æºç ç”Ÿæˆéœ€è¦çš„æ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ã€‚åªéœ€è¦åœ¨ repo çš„ contrib&#x2F;offline ç›®å½•ä¸‹æ‰§è¡Œ  bash generate_list.sh å°±å¯ä»¥ç”Ÿæˆä¸€ä¸ª files.lis">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-05-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-05-12T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="kubespray">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.k8s.li/kubespray-tips.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/kubespray-tips.html","path":"kubespray-tips.html","title":"kubespray éƒ¨ç½²å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æ±‡æ€»"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>kubespray éƒ¨ç½²å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æ±‡æ€» | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6"><span class="nav-number">1.</span> <span class="nav-text">äºŒè¿›åˆ¶æ–‡ä»¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93"><span class="nav-number">2.</span> <span class="nav-text">é•œåƒä»“åº“</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96-kubespray-%E9%95%9C%E5%83%8F%E5%A4%A7%E5%B0%8F"><span class="nav-number">3.</span> <span class="nav-text">ä¼˜åŒ– kubespray é•œåƒå¤§å°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-registry-%E7%A6%81%E6%AD%A2-push-%E9%95%9C%E5%83%8F"><span class="nav-number">4.</span> <span class="nav-text">docker registry ç¦æ­¢ push é•œåƒ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%E8%87%AA%E7%AD%BE%E8%AF%81%E4%B9%A6"><span class="nav-number">5.</span> <span class="nav-text">é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#containerd-%E6%97%A0%E6%B3%95%E5%8A%A0%E8%BD%BD-CNI-%E9%85%8D%E7%BD%AE%E5%AF%BC%E8%87%B4%E8%8A%82%E7%82%B9-NotReady"><span class="nav-number">6.</span> <span class="nav-text">containerd æ— æ³•åŠ è½½ CNI é…ç½®å¯¼è‡´èŠ‚ç‚¹ NotReady</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96%E9%83%A8%E7%BD%B2%E9%80%9F%E5%BA%A6"><span class="nav-number">7.</span> <span class="nav-text">ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E7%94%A8%E6%8F%92%E4%BB%B6"><span class="nav-number">8.</span> <span class="nav-text">å¯ç”¨æ’ä»¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B1%82%E9%83%A8%E7%BD%B2"><span class="nav-number">9.</span> <span class="nav-text">åˆ†å±‚éƒ¨ç½²</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">115</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">147</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail â†’ mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="è¿”å›é¡¶éƒ¨">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/kubespray-tips.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="kubespray éƒ¨ç½²å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æ±‡æ€» | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          kubespray éƒ¨ç½²å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æ±‡æ€»
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-13 2021-05-13T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2021-05-13T00:00:00+08:00">2021-05-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">æŠ€æœ¯</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/kubespray-tips.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="kubespray-tips.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>26k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>24 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>kubespray v2.16 ç‰ˆæœ¬å³å°†å‘å¸ƒï¼Œæ•´ç†ä¸€ä¸‹è‡ªå·±åœ¨ä½¿ç”¨ kubespray è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œä¸€äº›ä¼˜åŒ–å»ºè®®ã€‚</p>
<h2 id="äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="äºŒè¿›åˆ¶æ–‡ä»¶"></a>äºŒè¿›åˆ¶æ–‡ä»¶</h2><p>åœ¨ kubespray ä¸Šæ¸¸çš„ <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kubespray/pull/7561">#7561</a>  PR ä¸­å®ç°äº†æ ¹æ® kubespray çš„æºç ç”Ÿæˆéœ€è¦çš„æ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ã€‚åªéœ€è¦åœ¨ repo çš„ <code>contrib/offline</code> ç›®å½•ä¸‹æ‰§è¡Œ <code> bash generate_list.sh</code> å°±å¯ä»¥ç”Ÿæˆä¸€ä¸ª files.list å’Œä¸€ä¸ª images.list  æ–‡ä»¶ã€‚ç„¶åå°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ–‡ä»¶æ¥ä¸‹è½½ä¾èµ–çš„æ–‡ä»¶å’Œé•œåƒã€‚å¦‚ä¸‹</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token builtin class-name">cd</span> contrib/offline
$ <span class="token function">bash</span> generate_list.sh
$ tree temp
temp
â”œâ”€â”€ files.list
â”œâ”€â”€ generate.sh
â””â”€â”€ images.list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>files.list å†…å®¹å¦‚ä¸‹</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">cat</span> temp/files.list
https://get.helm.sh/helm-v3.5.4-linux-amd64.tar.gz
https://github.com/containerd/nerdctl/releases/download/v0.8.0/nerdctl-0.8.0-linux-amd64.tar.gz
https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz
https://github.com/containers/crun/releases/download/0.19/crun-0.19-linux-amd64
https://github.com/coreos/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz
https://github.com/kata-containers/runtime/releases/download/1.12.1/kata-static-1.12.1-x86_64.tar.xz
https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.20.0/crictl-v1.20.0-linux-amd64.tar.gz
https://github.com/kubernetes-sigs/krew/releases/download/v0.4.1/krew.tar.gz
https://github.com/projectcalico/calico/archive/v3.17.4.tar.gz
https://github.com/projectcalico/calicoctl/releases/download/v3.17.4/calicoctl-linux-amd64
https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubeadm
https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubectl
https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç„¶åé€šè¿‡ wget è¿›è¡Œä¸‹è½½</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">wget</span> -x -P temp/files -i temp/files.list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>ä¸‹è½½åçš„æ–‡ä»¶å¦‚ä¸‹</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"> tree temp/files
temp/files
â”œâ”€â”€ get.helm.sh
â”‚   â””â”€â”€ helm-v3.5.4-linux-amd64.tar.gz
â”œâ”€â”€ github.com
â”‚   â”œâ”€â”€ containerd
â”‚   â”‚   â””â”€â”€ nerdctl
â”‚   â”‚       â””â”€â”€ releases
â”‚   â”‚           â””â”€â”€ download
â”‚   â”‚               â””â”€â”€ v0.8.0
â”‚   â”‚                   â””â”€â”€ nerdctl-0.8.0-linux-amd64.tar.gz
â”‚   â”œâ”€â”€ containernetworking
â”‚   â”‚   â””â”€â”€ plugins
â”‚   â”‚       â””â”€â”€ releases
â”‚   â”‚           â””â”€â”€ download
â”‚   â”‚               â””â”€â”€ v0.9.1
â”‚   â”‚                   â””â”€â”€ cni-plugins-linux-amd64-v0.9.1.tgz
â”‚   â”œâ”€â”€ containers
â”‚   â”‚   â””â”€â”€ crun
â”‚   â”‚       â””â”€â”€ releases
â”‚   â”‚           â””â”€â”€ download
â”‚   â”‚               â””â”€â”€ <span class="token number">0.19</span>
â”‚   â”‚                   â””â”€â”€ crun-0.19-linux-amd64
â”‚   â”œâ”€â”€ coreos
â”‚   â”‚   â””â”€â”€ etcd
â”‚   â”‚       â””â”€â”€ releases
â”‚   â”‚           â””â”€â”€ download
â”‚   â”‚               â””â”€â”€ v3.4.13
â”‚   â”‚                   â””â”€â”€ etcd-v3.4.13-linux-amd64.tar.gz
â”‚   â”œâ”€â”€ kata-containers
â”‚   â”‚   â””â”€â”€ runtime
â”‚   â”‚       â””â”€â”€ releases
â”‚   â”‚           â””â”€â”€ download
â”‚   â”‚               â””â”€â”€ <span class="token number">1.12</span>.1
â”‚   â”‚                   â””â”€â”€ kata-static-1.12.1-x86_64.tar.xz
â”‚   â”œâ”€â”€ kubernetes-sigs
â”‚   â”‚   â”œâ”€â”€ cri-tools
â”‚   â”‚   â”‚   â””â”€â”€ releases
â”‚   â”‚   â”‚       â””â”€â”€ download
â”‚   â”‚   â”‚           â””â”€â”€ v1.20.0
â”‚   â”‚   â”‚               â””â”€â”€ crictl-v1.20.0-linux-amd64.tar.gz
â”‚   â”‚   â””â”€â”€ krew
â”‚   â”‚       â””â”€â”€ releases
â”‚   â”‚           â””â”€â”€ download
â”‚   â”‚               â””â”€â”€ v0.4.1
â”‚   â”‚                   â””â”€â”€ krew.tar.gz
â”‚   â””â”€â”€ projectcalico
â”‚       â”œâ”€â”€ calico
â”‚       â”‚   â””â”€â”€ archive
â”‚       â”‚       â””â”€â”€ v3.17.4.tar.gz
â”‚       â””â”€â”€ calicoctl
â”‚           â””â”€â”€ releases
â”‚               â””â”€â”€ download
â”‚                   â””â”€â”€ v3.17.4
â”‚                       â””â”€â”€ calicoctl-linux-amd64
â””â”€â”€ storage.googleapis.com
    â””â”€â”€ kubernetes-release
        â””â”€â”€ release
            â””â”€â”€ v1.20.6
                â””â”€â”€ bin
                    â””â”€â”€ linux
                        â””â”€â”€ amd64
                            â”œâ”€â”€ kubeadm
                            â”œâ”€â”€ kubectl
                            â””â”€â”€ kubelet<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ä¿æŒè¿™ä¸ªç›®å½•ç»“æ„ä¸å˜ï¼ŒæŠŠå®ƒä»¬ä¸Šä¼ åˆ°è‡ªå·±çš„æ–‡ä»¶æœåŠ¡å™¨ä¸Šï¼Œç„¶åå†ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶çš„ä¸‹è½½å‚æ•°ï¼Œåªéœ€è¦åœ¨å‰é¢åŠ ä¸Šæ–‡ä»¶æœåŠ¡å™¨çš„ URL å³å¯ï¼Œæ¯”å¦‚æˆ‘çš„é…ç½®ï¼š</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Download URLs</span>
<span class="token key atrule">download_url</span><span class="token punctuation">:</span> <span class="token string">"https://dl.k8s.li"</span>
<span class="token key atrule">kubelet_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kube_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubelet"</span>
<span class="token key atrule">kubectl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kube_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubectl"</span>
<span class="token key atrule">kubeadm_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/storage.googleapis.com/kubernetes-release/release/&#123;&#123; kubeadm_version &#125;&#125;/bin/linux/&#123;&#123; image_arch &#125;&#125;/kubeadm"</span>
<span class="token key atrule">etcd_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/coreos/etcd/releases/download/&#123;&#123; etcd_version &#125;&#125;/etcd-&#123;&#123; etcd_version &#125;&#125;-linux-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token key atrule">cni_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/containernetworking/plugins/releases/download/&#123;&#123; cni_version &#125;&#125;/cni-plugins-linux-&#123;&#123; image_arch &#125;&#125;-&#123;&#123; cni_version &#125;&#125;.tgz"</span>
<span class="token key atrule">calicoctl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/projectcalico/calicoctl/releases/download/&#123;&#123; calico_ctl_version &#125;&#125;/calicoctl-linux-&#123;&#123; image_arch &#125;&#125;"</span>
<span class="token key atrule">calico_crds_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/projectcalico/calico/archive/&#123;&#123; calico_version &#125;&#125;.tar.gz"</span>
<span class="token key atrule">crictl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/kubernetes-sigs/cri-tools/releases/download/&#123;&#123; crictl_version &#125;&#125;/crictl-&#123;&#123; crictl_version &#125;&#125;-&#123;&#123; ansible_system | lower &#125;&#125;-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token key atrule">helm_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/get.helm.sh/helm-&#123;&#123; helm_version &#125;&#125;-linux-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span>
<span class="token key atrule">crun_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/containers/crun/releases/download/&#123;&#123; crun_version &#125;&#125;/crun-&#123;&#123; crun_version &#125;&#125;-linux-&#123;&#123; image_arch &#125;&#125;"</span>
<span class="token key atrule">kata_containers_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/kata-containers/runtime/releases/download/&#123;&#123; kata_containers_version &#125;&#125;/kata-static-&#123;&#123; kata_containers_version &#125;&#125;-&#123;&#123; ansible_architecture &#125;&#125;.tar.xz"</span>
<span class="token key atrule">nerdctl_download_url</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; download_url &#125;&#125;/github.com/containerd/nerdctl/releases/download/v&#123;&#123; nerdctl_version &#125;&#125;/nerdctl-&#123;&#123; nerdctl_version &#125;&#125;-&#123;&#123; ansible_system | lower &#125;&#125;-&#123;&#123; image_arch &#125;&#125;.tar.gz"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>images.list æ˜¯ kubespray æ‰€æœ‰å¯èƒ½ä¼šç”¨åˆ°çš„é•œåƒï¼Œå¦‚ä¸‹ï¼š</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># cat temp/images.list</span>
docker.io/amazon/aws-alb-ingress-controller:v1.1.9
docker.io/amazon/aws-ebs-csi-driver:v0.5.0
docker.io/cloudnativelabs/kube-router:v1.2.2
docker.io/integratedcloudnative/ovn4nfv-k8s-plugin:v1.1.0
docker.io/k8scloudprovider/cinder-csi-plugin:v1.20.0
docker.io/kubeovn/kube-ovn:v1.6.2
docker.io/kubernetesui/dashboard-amd64:v2.2.0
docker.io/kubernetesui/metrics-scraper:v1.0.6
docker.io/library/haproxy:2.3
docker.io/library/nginx:1.19
docker.io/library/registry:2.7.1
docker.io/nfvpe/multus:v3.7
docker.io/rancher/local-path-provisioner:v0.0.19
docker.io/weaveworks/weave-kube:2.8.1
docker.io/weaveworks/weave-npc:2.8.1
docker.io/xueshanf/install-socat:latest
k8s.gcr.io/addon-resizer:1.8.11
k8s.gcr.io/coredns:1.7.0
k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64:1.8.3
k8s.gcr.io/dns/k8s-dns-node-cache:1.17.1
k8s.gcr.io/ingress-nginx/controller:v0.43.0
k8s.gcr.io/kube-apiserver:v1.20.6
k8s.gcr.io/kube-controller-manager:v1.20.6
k8s.gcr.io/kube-proxy:v1.20.6
k8s.gcr.io/kube-registry-proxy:0.4
k8s.gcr.io/kube-scheduler:v1.20.6
k8s.gcr.io/metrics-server/metrics-server:v0.4.2
k8s.gcr.io/pause:3.3
quay.io/calico/cni:v3.17.4
quay.io/calico/kube-controllers:v3.17.4
quay.io/calico/node:v3.17.4
quay.io/calico/typha:v3.17.4
quay.io/cilium/cilium-init:2019-04-05
quay.io/cilium/cilium:v1.8.9
quay.io/cilium/operator:v1.8.9
quay.io/coreos/etcd:v3.4.13
quay.io/coreos/flannel:v0.13.0-amd64
quay.io/datawire/ambassador-operator:v1.2.9
quay.io/external_storage/cephfs-provisioner:v2.1.0-k8s1.11
quay.io/external_storage/local-volume-provisioner:v2.3.4
quay.io/external_storage/rbd-provisioner:v2.1.1-k8s1.11
quay.io/jetstack/cert-manager-cainjector:v1.0.4
quay.io/jetstack/cert-manager-controller:v1.0.4
quay.io/jetstack/cert-manager-webhook:v1.0.4
quay.io/k8scsi/csi-attacher:v2.2.0
quay.io/k8scsi/csi-node-driver-registrar:v1.3.0
quay.io/k8scsi/csi-provisioner:v1.6.0
quay.io/k8scsi/csi-resizer:v0.5.0
quay.io/k8scsi/csi-snapshotter:v2.1.1
quay.io/k8scsi/snapshot-controller:v2.0.1
quay.io/l23network/k8s-netchecker-agent:v1.0
quay.io/l23network/k8s-netchecker-server:v1.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯ä½¿ç”¨ skopeo å°†é•œåƒåŒæ­¥åˆ°è‡ªå·±çš„ registry ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token keyword">for</span> <span class="token for-or-select variable">image</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> temp/images.list<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span> skopeo copy docker://<span class="token variable">$&#123;image&#125;</span> docker://hub.k8s.li/<span class="token variable">$&#123;image<span class="token operator">#</span>*<span class="token operator">/</span>&#125;</span><span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>å½“æ—¶å†™è¿™ä¸ªè„šæœ¬çš„æ—¶å€™ä¸€å †è›‡çš® sed æ›¿æ¢æ“ä½œå†™å¾—æƒ³ ğŸ¤®ï¼Œæ¯”å¦‚æœ‰äº›å˜é‡ä¼šæœ‰ ansible çš„ if else åˆ¤æ–­ï¼Œè¿™å°±æ„å‘³ç€ä¹Ÿè¦ç”¨ shell å»å®ç°å®ƒçš„åˆ¤æ–­é€»è¾‘ã€‚æ¯”å¦‚ä½¿ç”¨ shell å¤„ç†çš„æ—¶å€™éœ€è¦å°†è¿™ä¸‹é¢å¨è½¬æ¢æˆ shell çš„ if elseï¼Œè€Œä¸”è¿˜ä¸èƒ½æ¢è¡Œï¼š</p>
</blockquote>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">coredns_image_repo</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; kube_image_repo &#125;&#125;&#123;&#123;'/coredns/coredns' if (coredns_image_is_namespaced | bool) else '/coredns' &#125;&#125;"</span>
<span class="token key atrule">coredns_image_tag</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; coredns_version if (coredns_image_is_namespaced | bool) else (coredns_version | regex_replace('^v', '')) &#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># special handling for https://github.com/kubernetes-sigs/kubespray/pull/7570</span>
<span class="token function">sed</span> -i <span class="token string">'s#^coredns_image_repo=.*#coredns_image_repo=$&#123;kube_image_repo&#125;$(if printf "%s\\n%s\\n" v1.21 $&#123;kube_version%.*&#125; | sort --check=quiet --version-sort; then echo -n /coredns/coredns;else echo -n /coredns; fi)#'</span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/generate.sh

<span class="token function">sed</span> -i <span class="token string">'s#^coredns_image_tag=.*#coredns_image_tag=$(if printf "%s\\n%s\\n" v1.21 $&#123;kube_version%.*&#125; | sort --check=quiet --version-sort; then echo -n $&#123;coredns_version&#125;;else echo -n $&#123;coredns_version/v/&#125;; fi)#'</span> <span class="token variable">$&#123;TEMP_DIR&#125;</span>/generate.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>å½“æ—¶è¿˜å­¦ä¼šäº†ä¸€æ‰‹ï¼Œåœ¨ shell ä¸­ä½¿ç”¨ <code>printf &quot;%s\\n%s\\n&quot; $v1 $v2 | sort --check=quiet --version-sort</code> è¿™ç§æ–¹å¼å¯ä»¥åˆ¤æ–­ä¸¤ä¸ªç‰ˆæœ¬å·çš„å¤§å°ï¼Œè€Œä¸”æ˜¯æœ€ç®€å•ä¾¿æ·çš„ã€‚</p>
<h2 id="é•œåƒä»“åº“"><a href="#é•œåƒä»“åº“" class="headerlink" title="é•œåƒä»“åº“"></a>é•œåƒä»“åº“</h2><p>ä¹‹å‰æåˆ°çš„æ˜¯æ ¹æ®é•œåƒåˆ—è¡¨å°†éœ€è¦çš„é•œåƒåŒæ­¥åˆ°è‡ªå·±çš„ registry ä¸­ï¼Œä½†å¯¹äºæœ¬åœ°å¼€å‘æµ‹è¯•æ¥è®²ï¼Œè¿™ç§æ‰‹åŠ¨å¯¼å…¥æ¯”è¾ƒè´¹äº‹è´¹åŠ›ã€‚åœ¨çœ‹äº†å¤§ä½¬å†™çš„ <a target="_blank" rel="noopener" href="https://fuckcloudnative.io/posts/docker-registry-proxy/">Docker é•œåƒåŠ é€Ÿæ•™ç¨‹</a> å’Œ <a target="_blank" rel="noopener" href="https://www.chenshaowen.com/blog/how-to-run-a-private-registry-mirror.html">å¦‚ä½•æ­å»ºä¸€ä¸ªç§æœ‰çš„é•œåƒä»“åº“ mirror</a>  å°±æƒ³åˆ°äº†å¯ä»¥ä½¿ç”¨ docker registry çš„ proxy ç‰¹æ€§æ¥éƒ¨ç½²å‡ ä¸ª kubespray éœ€è¦çš„é•œåƒä»“åº“ã€‚å¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th>origin</th>
<th>mirror</th>
</tr>
</thead>
<tbody><tr>
<td>docker.io</td>
<td>hub.k8s.li</td>
</tr>
<tr>
<td>k8s.gcr.io</td>
<td>gcr.k8s.li</td>
</tr>
<tr>
<td>quay.io</td>
<td>quay.k8s.li</td>
</tr>
</tbody></table>
<ul>
<li>config.yml</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token number">0.1</span>
<span class="token key atrule">log</span><span class="token punctuation">:</span>
  <span class="token key atrule">fields</span><span class="token punctuation">:</span>
    <span class="token key atrule">service</span><span class="token punctuation">:</span> registry
<span class="token key atrule">storage</span><span class="token punctuation">:</span>
  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">blobdescriptor</span><span class="token punctuation">:</span> inmemory
  <span class="token key atrule">oss</span><span class="token punctuation">:</span>
    <span class="token key atrule">accesskeyid</span><span class="token punctuation">:</span> xxxx <span class="token comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeyid</span>
    <span class="token key atrule">accesskeysecret</span><span class="token punctuation">:</span> xxxx <span class="token comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeysecret</span>
    <span class="token key atrule">region</span><span class="token punctuation">:</span> oss<span class="token punctuation">-</span>cn<span class="token punctuation">-</span>beijing <span class="token comment"># é…ç½® OSS bucket çš„åŒºåŸŸï¼Œæ¯”å¦‚ oss-cn-beijing</span>
    <span class="token key atrule">internal</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">bucket</span><span class="token punctuation">:</span> fileserver <span class="token comment"># é…ç½®å­˜å‚¨ bucket çš„åç§°</span>
    <span class="token key atrule">rootdirectory</span><span class="token punctuation">:</span> /kubespray/registry <span class="token comment"># é…ç½®è·¯å¾„</span>
  <span class="token key atrule">delete</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token key atrule">headers</span><span class="token punctuation">:</span>
    <span class="token key atrule">X-Content-Type-Options</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>nosniff<span class="token punctuation">]</span>
<span class="token key atrule">health</span><span class="token punctuation">:</span>
  <span class="token key atrule">storagedriver</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s
    <span class="token key atrule">threshold</span><span class="token punctuation">:</span> <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>docker-compose.yml</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">gcr-registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry<span class="token punctuation">:</span><span class="token number">2</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> gcr<span class="token punctuation">-</span>registry
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./config.yml<span class="token punctuation">:</span>/etc/docker/registry/config.yml
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span>5001<span class="token punctuation">:</span><span class="token number">5001</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> REGISTRY_HTTP_ADDR=0.0.0.0<span class="token punctuation">:</span><span class="token number">5001</span>
      <span class="token punctuation">-</span> REGISTRY_PROXY_REMOTEURL=https<span class="token punctuation">:</span>//k8s.gcr.io

  <span class="token key atrule">hub-registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry<span class="token punctuation">:</span><span class="token number">2</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> hub<span class="token punctuation">-</span>registry
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./config.yml<span class="token punctuation">:</span>/etc/docker/registry/config.yml
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span>5002<span class="token punctuation">:</span><span class="token number">5002</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> REGISTRY_HTTP_ADDR=0.0.0.0<span class="token punctuation">:</span><span class="token number">5002</span>
      <span class="token punctuation">-</span> REGISTRY_PROXY_REMOTEURL=https<span class="token punctuation">:</span>//docker.io

  <span class="token key atrule">quay-registry</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry<span class="token punctuation">:</span><span class="token number">2</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> quay<span class="token punctuation">-</span>registry
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./config.yml<span class="token punctuation">:</span>/etc/docker/registry/config.yml
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 127.0.0.1<span class="token punctuation">:</span>5003<span class="token punctuation">:</span><span class="token number">5003</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> REGISTRY_HTTP_ADDR=0.0.0.0<span class="token punctuation">:</span><span class="token number">5003</span>
      <span class="token punctuation">-</span> REGISTRY_PROXY_REMOTEURL=https<span class="token punctuation">:</span>//quay.io<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>nginx.conf</li>
</ul>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span>       [::]:443</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  gcr.k8s.li</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate</span> domain.crt</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> domain.key</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_static</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">100000m</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_method</span> !~* GET|HEAD)</span> <span class="token punctuation">&#123;</span>
         <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span>   http://localhost:5001</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span>       [::]:443</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  hub.k8s.li</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate</span> domain.crt</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> domain.key</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_static</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">100000m</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_method</span> !~* GET|HEAD)</span> <span class="token punctuation">&#123;</span>
         <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span>   http://localhost:5002</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">listen</span>       <span class="token number">443</span> ssl</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">listen</span>       [::]:443</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">server_name</span>  quay.k8s.li</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate</span> domain.crt</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">ssl_certificate_key</span> domain.key</span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">gzip_static</span> <span class="token boolean">on</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">client_max_body_size</span> <span class="token number">100000m</span></span><span class="token punctuation">;</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_method</span> !~* GET|HEAD)</span> <span class="token punctuation">&#123;</span>
         <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span>
        <span class="token directive"><span class="token keyword">proxy_redirect</span> <span class="token boolean">off</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span>
        <span class="token directive"><span class="token keyword">proxy_pass</span>   http://localhost:5003</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ç›¸å…³é…ç½®æ–‡ä»¶åœ¨ <a target="_blank" rel="noopener" href="https://github.com/muzi502/registry-mirrors">registry-mirrors</a> è¿™ä¸ª repo ä¸­ã€‚</p>
<h2 id="ä¼˜åŒ–-kubespray-é•œåƒå¤§å°"><a href="#ä¼˜åŒ–-kubespray-é•œåƒå¤§å°" class="headerlink" title="ä¼˜åŒ– kubespray é•œåƒå¤§å°"></a>ä¼˜åŒ– kubespray é•œåƒå¤§å°</h2><p>kubespray v1.25.1 ç‰ˆæœ¬å®˜æ–¹æ„å»ºçš„é•œåƒå¤§å°ä¸º <code>1.41GB</code>ï¼Œå¯¹äºä¸€äº›åœºæ™¯ä¸‹å¸Œæœ›é•œåƒå°ä¸€äº›ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•æ„å»ºä¸€ä¸ªä½“ç§¯è¾ƒå°çš„é•œåƒã€‚</p>
<ul>
<li>é¦–å…ˆæ„å»ºä¸€ä¸ª base é•œåƒï¼Œå¯¹äºä¸ç»å¸¸å˜åŠ¨çš„æˆ‘ä»¬æŠŠå®ƒå°è£…åœ¨ä¸€ä¸ª base é•œåƒé‡Œï¼Œåªæœ‰å½“ç›¸å…³ä¾èµ–æ›´æ–°äº†æ‰éœ€è¦é‡æ–°æ„å»ºè¿™ä¸ª base é•œåƒï¼Œ<code>Dockerfile.base</code> å¦‚ä¸‹ï¼š</li>
</ul>
<pre class="line-numbers language-Dockerfile" data-language="Dockerfile"><code class="language-Dockerfile">FROM python:3.6-slim
ENV KUBE_VERSION v1.20.6

RUN apt update -y \
 &amp;&amp; apt install -y \
 libssl-dev sshpass apt-transport-https jq moreutils vim moreutils iputils-ping \
 ca-certificates curl gnupg2 software-properties-common rsync wget tcpdump \
 &amp;&amp; rm -rf &#x2F;var&#x2F;lib&#x2F;apt&#x2F;lists&#x2F;* \
 &amp;&amp; wget -q https:&#x2F;&#x2F;dl.k8s.io&#x2F;$KUBE_VERSION&#x2F;bin&#x2F;linux&#x2F;amd64&#x2F;kubectl -O &#x2F;usr&#x2F;local&#x2F;bin&#x2F;kubectl \
 &amp;&amp; chmod a+x &#x2F;usr&#x2F;local&#x2F;bin&#x2F;kubectl

WORKDIR &#x2F;kubespray
COPY . .
RUN python3 -m pip install -r requirements.txt<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ„å»º kubespray é•œåƒï¼šFROM çš„ base é•œåƒå°±ä½¿ç”¨æˆ‘ä»¬åˆšåˆšæ„å»ºå¥½çš„é•œåƒï¼Œå¯¹äº kubespray æ¥è®²ï¼Œç›¸å…³ä¾èµ–å·²ç»åœ¨ base é•œåƒä¸­å®‰è£…å¥½äº†ï¼Œè¿™é‡Œæ„å»ºçš„æ—¶å€™åªéœ€è¦æŠŠ repo å¤åˆ¶åˆ° &#x2F;kubespray ç›®å½•ä¸‹å³å¯ï¼Œå¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-Dockerfile" data-language="Dockerfile"><code class="language-Dockerfile">FROM kubespray:v2.16.0-base-kube-v1.20.6
COPY . &#x2F;kubespray<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>è¿™æ ·æ„å»ºå‡ºæ¥çš„é•œåƒå¤§å°ä¸åˆ° 600MBï¼Œæ¯”ä¹‹å‰å°äº†å¾ˆå¤šï¼Œè€Œä¸”æ¯æ¬¡æ„å»ºé•œåƒçš„æ—¶å€™ä¹Ÿæ¯”è¾ƒå¿«ã€‚åªä¸è¿‡å½“ <code>requirements.txt</code>  æ–‡ä»¶æ›´æ–°åéœ€è¦é‡æ–°æ„å»º base é•œåƒï¼Œå¹¶ä¿®æ”¹ kubespray çš„ FROM é•œåƒä¸ºæ–°çš„ base é•œåƒã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubespray     v2.15.1                  73294562105a    <span class="token number">1</span>.41GB
kubespray     v2.16-kube-v1.20.6-1.0   80b735995e48    579MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>kubespray é»˜è®¤æ²¡æœ‰åŠ å¦‚ <code>.dockerignore</code>ï¼Œè¿™å°±æ„å‘³ç€æ„å»ºé•œåƒçš„æ—¶å€™ä¼šæŠŠå½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹å¤åˆ¶åˆ°é•œåƒé‡Œï¼Œä¼šå¯¼è‡´é•œåƒå·¥ä½œç›®å½•ä¸‹å¯èƒ½å¾ˆæ··ä¹±ï¼Œåœ¨å®¹å™¨é‡Œ debug çš„æ—¶å€™ä¸å¤ªç¾è§‚ï¼Œå¼ºè¿«ç—‡æ‚£è€…å¯ä»¥åœ¨ repo ä¸­åŠ å…¥å¦‚ä¸‹çš„ <code>.dockerignore</code> æ–‡ä»¶ã€‚</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">.ansible-lint
.editorconfig
.git
.github
.gitignore
.gitlab-ci
.gitlab-ci.yml
.gitmodules
.markdownlint.yaml
.nojekyll
CNAME
CONTRIBUTING.md
Dockerfile
Makefile
OWNERS
README.md
RELEASE.md
SECURITY_CONTACTS
build
code-of-conduct.md
docs
index.html
logo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="docker-registry-ç¦æ­¢-push-é•œåƒ"><a href="#docker-registry-ç¦æ­¢-push-é•œåƒ" class="headerlink" title="docker registry ç¦æ­¢ push é•œåƒ"></a>docker registry ç¦æ­¢ push é•œåƒ</h2><p>é»˜è®¤ç›´æ¥ä½¿ç”¨ docker registry æ¥éƒ¨ç½²é•œåƒä»“åº“çš„è¯ï¼Œæ¯”å¦‚æˆ‘çš„ hub.k8s.li ï¼Œå› ä¸ºæ²¡æœ‰æƒé™é™åˆ¶ä¼šå¯¼è‡´ä»»ä½•å¯è®¿é—®è¯¥é•œåƒä»“åº“çš„å®¢æˆ·ç«¯å¯ä»¥ push é•œåƒï¼Œè¿™æœ‰ç‚¹ä¸å®‰å…¨ï¼Œéœ€è¦å®‰å…¨åŠ å›ºä¸€ä¸‹ã€‚å› ä¸º pull é•œåƒçš„æ—¶å€™å®¢æˆ·ç«¯èµ°çš„éƒ½æ˜¯ HTTP GET è¯·æ±‚ï¼Œå¯ä»¥é€šè¿‡ nginx ç¦æ­¢ POSTã€PUT è¿™ç§è¯·æ±‚æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥ç¦æ­¢ push é•œåƒã€‚åœ¨ nginx çš„ server å­—æ®µä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span>
    <span class="token directive"><span class="token keyword">if</span> (<span class="token variable">$request_method</span> !~* GET)</span> <span class="token punctuation">&#123;</span>
         <span class="token directive"><span class="token keyword">return</span> <span class="token number">403</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™æ ·åœ¨ push é•œåƒçš„æ—¶å€™ä¼šè¿”å› 403 çš„é”™è¯¯</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/root <span class="token comment"># docker pull hub.k8s.li/calico/node:v3.17.3</span>
v3.17.3: Pulling from calico/node
282bf12aa8be: Pull complete
4ac1bb9354ad: Pull complete
Digest: sha256:3595a9a945a7ba346a12ee523fc7ae15ed35f1e6282b76bce7fec474d28d68bb
Status: Downloaded newer image <span class="token keyword">for</span> hub.k8s.li/calico/node:v3.17.3
root@debian:/root <span class="token comment"># docker push !$</span>
root@debian:/root <span class="token comment"># docker push hub.k8s.li/calico/node:v3.17.3</span>
The push refers to repository <span class="token punctuation">[</span>hub.k8s.li/calico/node<span class="token punctuation">]</span>
bc19ae092bb4: Preparing
94333d52d45d: Preparing
error parsing HTTP <span class="token number">403</span> response body: invalid character <span class="token string">'&lt;'</span> looking <span class="token keyword">for</span> beginning of value: <span class="token string">"&lt;html><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>&lt;head>&lt;title>403 Forbidden&lt;/title>&lt;/head><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>&lt;body bgcolor=<span class="token entity" title="\&quot;">\"</span>white<span class="token entity" title="\&quot;">\"</span>><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>&lt;center>&lt;h1>403 Forbidden&lt;/h1>&lt;/center><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>&lt;hr>&lt;center>nginx&lt;/center><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>&lt;/body><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>&lt;/html><span class="token entity" title="\r">\r</span><span class="token entity" title="\n">\n</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>é‚£ä¹ˆéœ€è¦ push é•œåƒçš„æ—¶å€™æ€ä¹ˆåŠï¼Ÿ</p>
<p>docker registry å¯åŠ¨çš„æ—¶å€™ bind åœ¨ 127.0.0.1 ä¸Šï¼Œè€Œä¸æ˜¯ 0.0.0.0ï¼Œé€šè¿‡ localhost:5000 æ¥ push é•œåƒã€‚</p>
<h2 id="é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦"><a href="#é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦" class="headerlink" title="é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦"></a>é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦</h2><p>å¦‚æœé•œåƒä»“åº“ä½¿ç”¨çš„æ˜¯è‡ªç­¾è¯ä¹¦ï¼Œå¯ä»¥è·‘ä¸‹é¢è¿™ä¸ª playbook å°†è‡ªç­¾è¯ä¹¦æ·»åŠ åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ trusted CA dir ä¸­ï¼Œè¿™æ ·æ— éœ€é…ç½® <code>insecure-registries</code> ä¹Ÿèƒ½æ‹‰å–é•œåƒã€‚</p>
<p><code>add-registry-ca.yml</code></p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> all
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gen_certs <span class="token punctuation">|</span> target ca<span class="token punctuation">-</span>certificate store file
      <span class="token key atrule">set_fact</span><span class="token punctuation">:</span>
        <span class="token key atrule">ca_cert_path</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
          <span class="token punctuation">&#123;</span>% if ansible_os_family == "Debian" <span class="token punctuation">-</span>%<span class="token punctuation">&#125;</span>
          /usr/local/share/ca<span class="token punctuation">-</span>certificates/registry<span class="token punctuation">-</span>ca.crt
          <span class="token punctuation">&#123;</span>%<span class="token punctuation">-</span> elif ansible_os_family == "RedHat" <span class="token punctuation">-</span>%<span class="token punctuation">&#125;</span>
          /etc/pki/ca<span class="token punctuation">-</span>trust/source/anchors/registry<span class="token punctuation">-</span>ca.crt
          <span class="token punctuation">&#123;</span>%<span class="token punctuation">-</span> elif ansible_os_family in <span class="token punctuation">[</span><span class="token string">"Flatcar Container Linux by Kinvolk"</span><span class="token punctuation">]</span> <span class="token punctuation">-</span>%<span class="token punctuation">&#125;</span>
          /etc/ssl/certs/registry<span class="token punctuation">-</span>ca.pem
          <span class="token punctuation">&#123;</span>%<span class="token punctuation">-</span> elif ansible_os_family == "Suse" <span class="token punctuation">-</span>%<span class="token punctuation">&#125;</span>
          /etc/pki/trust/anchors/registry<span class="token punctuation">-</span>ca.pem
          <span class="token punctuation">&#123;</span>%<span class="token punctuation">-</span> elif ansible_os_family == "ClearLinux" <span class="token punctuation">-</span>%<span class="token punctuation">&#125;</span>
          /usr/share/ca<span class="token punctuation">-</span>certs/registry<span class="token punctuation">-</span>ca.pem
          <span class="token punctuation">&#123;</span>%<span class="token punctuation">-</span> endif %<span class="token punctuation">&#125;</span>
      <span class="token key atrule">tags</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> facts

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gen_certs <span class="token punctuation">|</span> add CA to trusted CA dir
      <span class="token key atrule">copy</span><span class="token punctuation">:</span>
        <span class="token key atrule">src</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; registry_cert_path &#125;&#125;"</span>
        <span class="token key atrule">dest</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; ca_cert_path &#125;&#125;"</span>
      <span class="token key atrule">register</span><span class="token punctuation">:</span> registry_ca_cert

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gen_certs <span class="token punctuation">|</span> update ca<span class="token punctuation">-</span>certificates (Debian/Ubuntu/SUSE/Flatcar)  <span class="token comment"># noqa 503</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> update<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>certificates
      <span class="token key atrule">when</span><span class="token punctuation">:</span> registry_ca_cert.changed and ansible_os_family in <span class="token punctuation">[</span><span class="token string">"Debian"</span><span class="token punctuation">,</span> <span class="token string">"Flatcar Container Linux by Kinvolk"</span><span class="token punctuation">,</span> <span class="token string">"Suse"</span><span class="token punctuation">]</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gen_certs <span class="token punctuation">|</span> update ca<span class="token punctuation">-</span>certificates (RedHat)  <span class="token comment"># noqa 503</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> update<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>trust extract
      <span class="token key atrule">when</span><span class="token punctuation">:</span> registry_ca_cert.changed and ansible_os_family == "RedHat"

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gen_certs <span class="token punctuation">|</span> update ca<span class="token punctuation">-</span>certificates (ClearLinux)  <span class="token comment"># noqa 503</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> clrtrust add "<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ca_cert_path <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>"
      <span class="token key atrule">when</span><span class="token punctuation">:</span> registry_ca_cert.changed and ansible_os_family == "ClearLinux"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>å°†è‡ªç­¾çš„ registry è¯ä¹¦æ”¾åˆ°æœ¬åœ°ï¼Œæ‰§è¡Œ playbook å¹¶æŒ‡å®š <code>registry_cert_path</code> ä¸ºæ­£ç¡®çš„è·¯å¾„</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/kubespray<span class="token comment"># ansible-playbook -i deploy/inventory -e registry_cert_path=/kubespray/registry_ca.pem add-registry-ca.yml</span>

PLAY <span class="token punctuation">[</span>all<span class="token punctuation">]</span> **********************************************************************************
Thursday <span class="token number">29</span> April <span class="token number">2021</span>  08:18:25 +0000 <span class="token punctuation">(</span><span class="token number">0</span>:00:00.077<span class="token punctuation">)</span>       <span class="token number">0</span>:00:00.077 ********

TASK <span class="token punctuation">[</span>Gen_certs <span class="token operator">|</span> target ca-certificate store file<span class="token punctuation">]</span> *****************************************
ok: <span class="token punctuation">[</span>kube-control-2<span class="token punctuation">]</span>
ok: <span class="token punctuation">[</span>kube-control-3<span class="token punctuation">]</span>
ok: <span class="token punctuation">[</span>kube-control-1<span class="token punctuation">]</span>
ok: <span class="token punctuation">[</span>kube-node-1<span class="token punctuation">]</span>
Thursday <span class="token number">29</span> April <span class="token number">2021</span>  08:18:25 +0000 <span class="token punctuation">(</span><span class="token number">0</span>:00:00.389<span class="token punctuation">)</span>       <span class="token number">0</span>:00:00.467 ********

TASK <span class="token punctuation">[</span>Gen_certs <span class="token operator">|</span> <span class="token function">add</span> CA to trusted CA dir<span class="token punctuation">]</span> *************************************************
changed: <span class="token punctuation">[</span>kube-control-2<span class="token punctuation">]</span>
changed: <span class="token punctuation">[</span>kube-control-3<span class="token punctuation">]</span>
changed: <span class="token punctuation">[</span>kube-control-1<span class="token punctuation">]</span>
changed: <span class="token punctuation">[</span>kube-node-1<span class="token punctuation">]</span>
Thursday <span class="token number">29</span> April <span class="token number">2021</span>  08:18:29 +0000 <span class="token punctuation">(</span><span class="token number">0</span>:00:04.433<span class="token punctuation">)</span>       <span class="token number">0</span>:00:04.901 ********
Thursday <span class="token number">29</span> April <span class="token number">2021</span>  08:18:30 +0000 <span class="token punctuation">(</span><span class="token number">0</span>:00:00.358<span class="token punctuation">)</span>       <span class="token number">0</span>:00:05.259 ********

TASK <span class="token punctuation">[</span>Gen_certs <span class="token operator">|</span> update ca-certificates <span class="token punctuation">(</span>RedHat<span class="token punctuation">)</span><span class="token punctuation">]</span> ******************************************
changed: <span class="token punctuation">[</span>kube-control-1<span class="token punctuation">]</span>
changed: <span class="token punctuation">[</span>kube-control-3<span class="token punctuation">]</span>
changed: <span class="token punctuation">[</span>kube-control-2<span class="token punctuation">]</span>
changed: <span class="token punctuation">[</span>kube-node-1<span class="token punctuation">]</span>
Thursday <span class="token number">29</span> April <span class="token number">2021</span>  08:18:33 +0000 <span class="token punctuation">(</span><span class="token number">0</span>:00:02.938<span class="token punctuation">)</span>       <span class="token number">0</span>:00:08.197 ********

PLAY RECAP **********************************************************************************
kube-control-1             <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">3</span>    <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span>
kube-control-2             <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">3</span>    <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span>
kube-control-3             <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">3</span>    <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span>
kube-node-1                <span class="token builtin class-name">:</span> <span class="token assign-left variable">ok</span><span class="token operator">=</span><span class="token number">3</span>    <span class="token assign-left variable">changed</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">unreachable</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">failed</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">skipped</span><span class="token operator">=</span><span class="token number">2</span>    <span class="token assign-left variable">rescued</span><span class="token operator">=</span><span class="token number">0</span>    <span class="token assign-left variable">ignored</span><span class="token operator">=</span><span class="token number">0</span>

Thursday <span class="token number">29</span> April <span class="token number">2021</span>  08:18:33 +0000 <span class="token punctuation">(</span><span class="token number">0</span>:00:00.355<span class="token punctuation">)</span>  <span class="token number">0</span>:00:08.553 ********
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
Gen_certs <span class="token operator">|</span> <span class="token function">add</span> CA to trusted CA <span class="token function">dir</span> ------------------------------------------------------------- <span class="token number">4</span>.43s
Gen_certs <span class="token operator">|</span> update ca-certificates <span class="token punctuation">(</span>RedHat<span class="token punctuation">)</span> ------------------------------------------------------------- <span class="token number">2</span>.94s
Gen_certs <span class="token operator">|</span> target ca-certificate store <span class="token function">file</span> ------------------------------------------------------------- <span class="token number">0</span>.39s
Gen_certs <span class="token operator">|</span> update ca-certificates <span class="token punctuation">(</span>Debian/Ubuntu/SUSE/Flatcar<span class="token punctuation">)</span> ------------------------------------------------------------- <span class="token number">0</span>.36s
Gen_certs <span class="token operator">|</span> update ca-certificates <span class="token punctuation">(</span>ClearLinux<span class="token punctuation">)</span> -------------------------------------------------------------- <span class="token number">0</span>.36s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="containerd-æ— æ³•åŠ è½½-CNI-é…ç½®å¯¼è‡´èŠ‚ç‚¹-NotReady"><a href="#containerd-æ— æ³•åŠ è½½-CNI-é…ç½®å¯¼è‡´èŠ‚ç‚¹-NotReady" class="headerlink" title="containerd æ— æ³•åŠ è½½ CNI é…ç½®å¯¼è‡´èŠ‚ç‚¹ NotReady"></a>containerd æ— æ³•åŠ è½½ CNI é…ç½®å¯¼è‡´èŠ‚ç‚¹ NotReady</h2><p>å¶ç°é—®é¢˜ï¼Œé‡å¯ä¸€ä¸‹ containerd å°±å¯ä»¥äº†ï¼Œå…·ä½“åŸå› è¿˜æ²¡æ’æŸ¥å‡ºæ¥</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/kubespray<span class="token comment"># ansible all -i deploy/inventory -m service -a "name=containerd state=restarted"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦"><a href="#ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦" class="headerlink" title="ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦"></a>ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦</h2><p>Kubespray éƒ¨ç½²çš„æ—¶å€™æœ‰ä¸ª task ä¸“é—¨ç”¨æ¥ä¸‹è½½éƒ¨ç½²éœ€è¦çš„é•œåƒï¼Œç”±äºæ˜¯æ“ä½œçš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¼šå°†ä¸€äº›ä¸éœ€è¦çš„é•œåƒæ‹‰å–åˆ°è¯¥èŠ‚ç‚¹ä¸Šã€‚æ¯”å¦‚ kube-apiserverã€kube-controller-managerã€kube-scheduler è¿™äº›åœ¨ node èŠ‚ç‚¹ä¸Šä¸ä¼šç”¨åˆ°çš„é•œåƒä¹Ÿä¼šåœ¨ node èŠ‚ç‚¹ä¸Šæ‹‰å–ï¼Œè¿™æ ·ä¼šå¯¼è‡´ download çš„ task æ¯”è¾ƒè€—æ—¶ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">TASK <span class="token punctuation">[</span>download <span class="token builtin class-name">:</span> set_container_facts <span class="token operator">|</span> Display the name of the image being processed<span class="token punctuation">]</span> ********************************************************************************************
ok: <span class="token punctuation">[</span>kube-control-3<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-controller-manager"</span>
<span class="token punctuation">&#125;</span>
ok: <span class="token punctuation">[</span>kube-control-2<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-controller-manager"</span>
<span class="token punctuation">&#125;</span>
ok: <span class="token punctuation">[</span>kube-control-1<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-controller-manager"</span>
<span class="token punctuation">&#125;</span>
ok: <span class="token punctuation">[</span>kube-node-1<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-controller-manager"</span>
<span class="token punctuation">&#125;</span>

ok: <span class="token punctuation">[</span>kube-control-3<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-scheduler"</span>
<span class="token punctuation">&#125;</span>
ok: <span class="token punctuation">[</span>kube-control-2<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-scheduler"</span>
<span class="token punctuation">&#125;</span>
ok: <span class="token punctuation">[</span>kube-control-1<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-scheduler"</span>
<span class="token punctuation">&#125;</span>
ok: <span class="token punctuation">[</span>kube-node-1<span class="token punctuation">]</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token string">"msg"</span><span class="token builtin class-name">:</span> <span class="token string">"gcr.k8s.li/kube-scheduler"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>å¯ç”¨é€šè¿‡ <code>download_container: false</code> è¿™ä¸ªå‚æ•°æ¥ç¦ç”¨ download container è¿™ä¸ª taskï¼Œè¿™æ ·åœ¨ pod å¯åŠ¨çš„æ—¶å€™åªæ‹‰å–éœ€è¦çš„é•œåƒï¼Œå¯ä»¥èŠ‚çœä¸€äº›éƒ¨ç½²è€—æ—¶ã€‚</p>
<h2 id="å¯ç”¨æ’ä»¶"><a href="#å¯ç”¨æ’ä»¶" class="headerlink" title="å¯ç”¨æ’ä»¶"></a>å¯ç”¨æ’ä»¶</h2><p>Kubespray å®˜æ–¹æ”¯æŒçš„æ’ä»¶åˆ—è¡¨å¦‚ä¸‹ï¼Œé»˜è®¤æ˜¯ false ç¦ç”¨äº†æ’ä»¶ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># Kubernetes dashboard</span>
<span class="token comment"># RBAC required. see docs/getting-started.md for access details.</span>
<span class="token key atrule">dashboard_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># Addons which can be enabled</span>
<span class="token key atrule">helm_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">krew_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">registry_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">metrics_server_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">enable_network_policy</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">local_path_provisioner_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">local_volume_provisioner_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">local_volume_provisioner_directory_mode</span><span class="token punctuation">:</span> <span class="token number">0700</span>
<span class="token key atrule">cinder_csi_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">aws_ebs_csi_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">azure_csi_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">gcp_pd_csi_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">vsphere_csi_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">persistent_volumes_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">cephfs_provisioner_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">rbd_provisioner_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">ingress_nginx_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">ingress_ambassador_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">ingress_alb_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">cert_manager_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">expand_persistent_volumes</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token key atrule">metallb_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment"># containerd official CLI tool</span>
<span class="token key atrule">nerdctl_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>åœ¨éƒ¨ç½²çš„æ—¶å€™å¦‚æœæƒ³å¯åŠ¨æŸäº›æ’ä»¶å¯ä»¥åœ¨è‡ªå·±æœ¬åœ°å¯¹åº”çš„ inventory ç›®å½•ä¸‹çš„ <code>group_vars/k8s_cluster/addons.yml</code> æ–‡ä»¶ä¸­é€‰æ‹©å¼€å¯ç›¸åº”çš„æ’ä»¶ï¼Œæ¯”å¦‚ <code>inventory/sample/group_vars/k8s_cluster/addons.yml</code>ã€‚</p>
<h2 id="åˆ†å±‚éƒ¨ç½²"><a href="#åˆ†å±‚éƒ¨ç½²" class="headerlink" title="åˆ†å±‚éƒ¨ç½²"></a>åˆ†å±‚éƒ¨ç½²</h2><p>è¿™ä¸ªæ˜¯æˆ‘ä»¬å¯¹ kubespray äºŒå¼€çš„ä¸€ä¸ªä¼˜åŒ–é¡¹ã€‚kubespray åœ¨éƒ¨ç½²é›†ç¾¤çš„æ—¶å€™è¿è¡Œçš„ playbook æ˜¯ <code>cluster.yml</code>ï¼Œåœ¨é›†ç¾¤éƒ¨ç½²çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå› ä¸ºä½ ä¸€äº›ä¸ç¨³å®šå› ç´ å¯¼è‡´é›†ç¾¤éƒ¨ç½²å¤±è´¥ï¼Œå¤±è´¥åå†æ¬¡å°è¯•éƒ¨ç½²çš„è¯ï¼Œkubespray ä¼šä»å¤´å¼€å§‹å†è·‘ä¸€éå·²ç»æˆåŠŸè¿è¡Œçš„ taskï¼Œè¿™æ ·çš„æ•ˆç‡ä¼šæ¯”è¾ƒä½ã€‚å› æ­¤éœ€è¦ä½¿ç”¨æŸç§æ–¹æ³•è®°å½•ä¸€ä¸‹å·²ç»æˆåŠŸæ‰§è¡Œçš„ task æˆ– rolesï¼Œå¤±è´¥åé‡æ–°éƒ¨ç½²çš„æ—¶å€™å°±è·³è¿‡è¿™äº›å·²ç»æˆåŠŸè¿è¡Œçš„ taskï¼Œç„¶åä»ä¸Šæ¬¡å¤±è´¥çš„åœ°æ–¹å¼€å§‹è¿è¡Œã€‚</p>
<p>å¤§ä½“çš„æ€è·¯æ˜¯æ ¹æ® <code>cluster.yml</code> ä¸­çš„ roles æ‹†åˆ†ä¸ºä¸åŒçš„å±‚å³ layerï¼Œå¦‚ bootstrap-osã€downloadã€kubernetesã€networkã€apps ï¼Œåœ¨éƒ¨ç½²çš„è¿‡ç¨‹ä¸­æ¯è¿è¡Œå®Œä¸€ä¸ª layer å°±å°†å®ƒè®°å½•åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œéƒ¨ç½²çš„æ—¶å€™ä¼šæ ¹æ®è¿™ä¸ªæ–‡ä»¶æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦éƒ¨ç½²ï¼Œå¦‚æœæ–‡ä»¶ä¸­è®°å½•å­˜åœ¨çš„è¯å°±è¯´æ˜å·²ç»æˆåŠŸéƒ¨ç½²å®Œæˆäº†ï¼Œå°±è·³è¿‡å®ƒï¼Œç»§ç»­æ‰§è¡Œæœªæ‰§è¡Œçš„ layerã€‚</p>
<p>è‡³äºæ‹†åˆ†çš„æ–¹å¼å¤§æ¦‚æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ ¹æ® tag ã€ä¸€ç§æ˜¯å°† <code>cluster.yml</code> æ–‡ä»¶æ‹†åˆ†æˆè‹¥å¹²ä¸ª playbook æ–‡ä»¶ã€‚é€šè¿‡ tag çš„æ–¹å¼å¯èƒ½ä¼šæ¯”è¾ƒå¤æ‚ä¸€äº›ï¼Œåœ¨è¿™é‡Œè¿˜æ˜¯é€‰æ‹©æ‹†åˆ†çš„æ–¹å¼ã€‚æ‹†åˆ†çš„ç²’åº¦æœ‰å¤§æœ‰å°ï¼Œä»¥ä¸‹æ˜¯æˆ‘è®¤ä¸ºæ¯”è¾ƒåˆç†çš„æ‹†å°æ–¹å¼ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">playbooks
â”œâ”€â”€ 00-default-ssh-config.yml <span class="token comment"># é»˜è®¤éœ€è¦è¿è¡Œçš„ playbookï¼Œç”¨äºé…ç½®å ¡å’æœºå’Œé…ç½® ssh è®¤è¯</span>
â”œâ”€â”€ 01-cluster-bootstrap-os.yml <span class="token comment"># åˆå§‹åŒ–é›†ç¾¤èŠ‚ç‚¹ OSï¼Œå®‰è£…å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸‹è½½éƒ¨ç½²ä¾èµ–çš„æ–‡ä»¶</span>
â”œâ”€â”€ 02-cluster-etcd.yml <span class="token comment"># éƒ¨ç½² etcd é›†ç¾¤</span>
â”œâ”€â”€ 03-cluster-kubernetes.yml <span class="token comment"># éƒ¨ç½² kubernetes é›†ç¾¤</span>
â”œâ”€â”€ 04-cluster-network.yml <span class="token comment"># éƒ¨ç½²ç½‘ç»œæ’ä»¶</span>
â”œâ”€â”€ 05-cluster-apps.yml <span class="token comment"># éƒ¨ç½²ä¸€äº› addons ç»„ä»¶ï¼Œå¦‚ coredns ç­‰</span>
â”œâ”€â”€ 06-cluster-self-host.yml <span class="token comment"># å¹³å° self-host è‡ªæ‰˜ç®¡çš„éƒ¨åˆ†</span>
â””â”€â”€ <span class="token number">11</span>-reset-reset.yml <span class="token comment"># ç§»é™¤é›†ç¾¤</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>00-default-ssh-config.yml</li>
</ul>
<p>è¯¥ playbook ç”¨äºé…ç½®å ¡å’æœºå’Œ ssh è®¤è¯ï¼Œkubespray éœ€è¦ä½¿ç”¨  public key çš„æ–¹å¼ ssh è¿æ¥åˆ°éƒ¨ç½²èŠ‚ç‚¹ï¼Œå¦‚æœéƒ¨ç½²èŠ‚ç‚¹æ²¡æœ‰é…ç½® ssh public key çš„æ–¹å¼ï¼Œå¯ä»¥æŒ‡å®š <code>ssh_cert_path</code> è¿™ä¸ªå˜é‡çš„è·¯å¾„ï¼Œå°†å…¬é’¥æ·»åŠ åˆ°ä¸»æœºçš„ authorized_key ä¸­ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> bastion<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> bastion<span class="token punctuation">-</span>ssh<span class="token punctuation">-</span>config<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token string">"bastion"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster<span class="token punctuation">:</span>etcd
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Setting up ssh public key authentication
      <span class="token key atrule">authorized_key</span><span class="token punctuation">:</span> <span class="token string">"user=&#123;&#123; ansible_user &#125;&#125; key=&#123;&#123; lookup('file', '&#123;&#123; ssh_cert_path &#125;&#125;') &#125;&#125;"</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span> ssh_cert_path is defined
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> ssh<span class="token punctuation">-</span>config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>01-cluster-bootstrap-os.yml</li>
</ul>
<p>è¿™ä¸ª playbook ç”¨äºåˆå§‹åŒ–éƒ¨ç½²èŠ‚ç‚¹ OSã€å®‰è£…ä¸€äº›ä¾èµ–çš„ rpm&#x2F;deb åŒ…ã€å®‰è£…å®¹å™¨è¿è¡Œæ—¶ã€ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ç­‰</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gather facts
  <span class="token key atrule">import_playbook</span><span class="token punctuation">:</span> ../facts.yml

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster<span class="token punctuation">:</span>etcd
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> linear
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> bootstrap<span class="token punctuation">-</span>os<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> bootstrap<span class="token punctuation">-</span>os<span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster<span class="token punctuation">:</span>etcd
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/preinstall<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> preinstall <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> <span class="token string">"container-engine"</span><span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token string">"container-engine"</span><span class="token punctuation">,</span> <span class="token key atrule">when</span><span class="token punctuation">:</span> deploy_container_engine<span class="token punctuation">|</span>default(true) <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> download<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> download<span class="token punctuation">,</span> <span class="token key atrule">when</span><span class="token punctuation">:</span> <span class="token string">"not skip_downloads"</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>02-cluster-etcd.yml</li>
</ul>
<p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½² etcd é›†ç¾¤å’Œåˆ†å‘ etcd é›†ç¾¤çš„è¯ä¹¦åˆ°é›†ç¾¤èŠ‚ç‚¹ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gather facts
  <span class="token key atrule">import_playbook</span><span class="token punctuation">:</span> ../facts.yml

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> etcd
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> etcd
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> etcd
      <span class="token key atrule">vars</span><span class="token punctuation">:</span>
        <span class="token key atrule">etcd_cluster_setup</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token key atrule">etcd_events_cluster_setup</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; etcd_events_cluster_enabled &#125;&#125;"</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span> not etcd_kubeadm_enabled<span class="token punctuation">|</span> default(false)

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> etcd
      <span class="token key atrule">tags</span><span class="token punctuation">:</span> etcd
      <span class="token key atrule">vars</span><span class="token punctuation">:</span>
        <span class="token key atrule">etcd_cluster_setup</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">etcd_events_cluster_setup</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">when</span><span class="token punctuation">:</span> not etcd_kubeadm_enabled<span class="token punctuation">|</span> default(false)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>03-cluster-kubernetes.yml</li>
</ul>
<p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½² kubernetes é›†ç¾¤ï¼Œè™½ç„¶è¿™é‡Œçš„ roles å¾ˆå¤šï¼Œä½†å¹¶æ²¡æœ‰åšè¿‡å¤šçš„æ‹†åˆ†ï¼Œä¸ªäººè¿˜æ˜¯è§‰ç€è¿™éƒ¨åˆ†å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gather facts
  <span class="token key atrule">import_playbook</span><span class="token punctuation">:</span> ../facts.yml

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/node<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> node <span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube_control_plane
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/control<span class="token punctuation">-</span>plane<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> master <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/client<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> client <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/cluster_roles<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>roles <span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/kubeadm<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> kubeadm<span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes/node<span class="token punctuation">-</span>label<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>label <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>04-cluster-network.yml</li>
</ul>
<p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½²ç½‘ç»œæ’ä»¶</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gather facts
  <span class="token key atrule">import_playbook</span><span class="token punctuation">:</span> ../facts.yml

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> k8s_cluster
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> network_plugin<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> network <span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube_control_plane
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/network_plugin<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> network <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/policy_controller<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> policy<span class="token punctuation">-</span>controller <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>05-cluster-apps.yml</li>
</ul>
<p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½²ä¸€äº› addons æ’ä»¶ï¼Œå¿…é¡» coredns, ingress-controllerï¼Œä»¥åŠä¸€äº›å¤–ç½®çš„ provisioner ç­‰ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gather facts
  <span class="token key atrule">import_playbook</span><span class="token punctuation">:</span> ../facts.yml

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube_control_plane
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/external_cloud_controller<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>cloud<span class="token punctuation">-</span>controller <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/ingress_controller<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>controller <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps/external_provisioner<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> external<span class="token punctuation">-</span>provisioner <span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube_control_plane
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>apps<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> apps <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>æ‹†åˆ†çš„æ—¶å€™å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µå»é™¤ä¸€äº›ä¸å¿…è¦çš„ rolesï¼Œæ¯”å¦‚ <code>calico_rr</code> , <code>win_nodes</code> ï¼Œæˆ‘ä»¬çš„äº§å“æœ¬èº«å°±ä¸æ”¯æŒ calico è·¯ç”±åå°„å™¨ã€ä¹Ÿä¸æ”¯æŒ windows èŠ‚ç‚¹ï¼Œå› æ­¤ç›´æ¥å°†è¿™ä¸¤éƒ¨åˆ†ç»™å»é™¤äº†ï¼Œè¿™æ ·ä¹Ÿèƒ½é¿å…å»æ‰§è¡Œè¿™äº› task çš„åˆ¤æ–­ï¼Œèƒ½èŠ‚çœä¸€å®šçš„æ—¶é—´ã€‚</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> calico_rr
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> network_plugin/calico/rr<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'network'</span><span class="token punctuation">,</span> <span class="token string">'calico_rr'</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span>

<span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> kube_control_plane<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token key atrule">gather_facts</span><span class="token punctuation">:</span> <span class="token boolean important">False</span>
  <span class="token key atrule">any_errors_fatal</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; any_errors_fatal | default(true) &#125;&#125;"</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span> <span class="token string">"&#123;&#123; proxy_disable_env &#125;&#125;"</span>
  <span class="token key atrule">roles</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> kubespray<span class="token punctuation">-</span>defaults <span class="token punctuation">&#125;</span>
    <span class="token punctuation">-</span> <span class="token punctuation">&#123;</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> win_nodes/kubernetes_patch<span class="token punctuation">,</span> <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"master"</span><span class="token punctuation">,</span> <span class="token string">"win_nodes"</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
              <a href="/tags/kubespray/" rel="tag"># kubespray</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/deploy-k8s-by-kubespray.html" rel="prev" title="ä½¿ç”¨ Kubespray æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤">
                  <i class="fa fa-chevron-left"></i> ä½¿ç”¨ Kubespray æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/make-offline-mirrors.html" rel="next" title="ä½¿ç”¨ GitHub Actions è‡ªåŠ¨åŒ–æ„å»º yum/apt ç¦»çº¿æº">
                  ä½¿ç”¨ GitHub Actions è‡ªåŠ¨åŒ–æ„å»º yum/apt ç¦»çº¿æº <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.7m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">25:30</span>
  </span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
