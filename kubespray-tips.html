<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://blog.k8s.li').hostname,
    root: '/',
    scheme: 'Gemini',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":true,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"buttons","active":null,"storage":true,"lazyload":true,"nav":{"disqus":{"text":"Load Disqus","order":-1}}},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":false,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>
  <meta name="description" content="kubespray v2.16 ç‰ˆæœ¬å³å°†å‘å¸ƒï¼Œæ•´ç†ä¸€ä¸‹è‡ªå·±åœ¨ä½¿ç”¨ kubespray è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œä¸€äº›ä¼˜åŒ–å»ºè®®ã€‚ äºŒè¿›åˆ¶æ–‡ä»¶åœ¨ kubespray ä¸Šæ¸¸çš„ #7561  PR ä¸­å®ç°äº†æ ¹æ® kubespray çš„æºç ç”Ÿæˆéœ€è¦çš„æ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ã€‚åªéœ€è¦åœ¨ repo çš„ contrib&#x2F;offline ç›®å½•ä¸‹æ‰§è¡Œ bash generate_list.sh å°±å¯ä»¥ç”Ÿæˆä¸€ä¸ª files.list">
<meta property="og:type" content="article">
<meta property="og:title" content="kubespray éƒ¨ç½²å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æ±‡æ€»">
<meta property="og:url" content="https://blog.k8s.li/kubespray-tips.html">
<meta property="og:site_name" content="æœ¨å­">
<meta property="og:description" content="kubespray v2.16 ç‰ˆæœ¬å³å°†å‘å¸ƒï¼Œæ•´ç†ä¸€ä¸‹è‡ªå·±åœ¨ä½¿ç”¨ kubespray è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œä¸€äº›ä¼˜åŒ–å»ºè®®ã€‚ äºŒè¿›åˆ¶æ–‡ä»¶åœ¨ kubespray ä¸Šæ¸¸çš„ #7561  PR ä¸­å®ç°äº†æ ¹æ® kubespray çš„æºç ç”Ÿæˆéœ€è¦çš„æ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ã€‚åªéœ€è¦åœ¨ repo çš„ contrib&#x2F;offline ç›®å½•ä¸‹æ‰§è¡Œ bash generate_list.sh å°±å¯ä»¥ç”Ÿæˆä¸€ä¸ª files.list">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-05-12T16:00:00.000Z">
<meta property="article:modified_time" content="2021-05-12T16:00:00.000Z">
<meta property="article:author" content="æœ¨å­">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="kubespray">
<meta name="twitter:card" content="summary">
<link rel="canonical" href="https://blog.k8s.li/kubespray-tips.html">
<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>
  <title>kubespray éƒ¨ç½²å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æ±‡æ€» | æœ¨å­</title>
  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }
  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>
<link rel="alternate" href="/atom.xml" title="æœ¨å­" type="application/atom+xml">
</head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">
    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æœ¨å­</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>
<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">
    <a href="/" rel="section"><i class="fa fa-fw fa-desktop"></i>Home</a>
  </li>
        <li class="menu-item menu-item-books">
    <a href="/booklist.html" rel="section"><i class="fa fa-fw fa-book"></i>Books</a>
  </li>
        <li class="menu-item menu-item-kindle">
    <a href="https://kindle.502.li/" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
  </li>
        <li class="menu-item menu-item-friend">
    <a href="/link/" rel="section"><i class="fa fa-fw fa-link"></i>Friend</a>
  </li>
        <li class="menu-item menu-item-about">
    <a href="/about.html" rel="section"><i class="fa fa-fw fa-user-circle-o"></i>About</a>
  </li>
  </ul>
</nav>
</div>
    </header>
  <div class="reading-progress-bar"></div>
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
  <div class="posts-expand">
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/kubespray-tips.html">
    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://blog.k8s.li/avatar.png">
      <meta itemprop="name" content="æœ¨å­">
      <meta itemprop="description" content="">
    </span>
    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æœ¨å­">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          kubespray éƒ¨ç½²å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æ±‡æ€»
        </h2>
        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-13 2021-05-13T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2021-05-13T00:00:00+08:00">2021-05-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index">
                    <span itemprop="name">æŠ€æœ¯</span>
                  </a>
                </span>
            </span>
  <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    <a title="disqus" href="/kubespray-tips.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="kubespray-tips.html" itemprop="commentCount"></span>
    </a>
  </span>
  <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>27k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>45 åˆ†é’Ÿ</span>
            </span>
        </div>
      </header>
    <div class="post-body" itemprop="articleBody">
        <p>kubespray v2.16 ç‰ˆæœ¬å³å°†å‘å¸ƒï¼Œæ•´ç†ä¸€ä¸‹è‡ªå·±åœ¨ä½¿ç”¨ kubespray è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜å’Œä¸€äº›ä¼˜åŒ–å»ºè®®ã€‚</p>
<h2 id="äºŒè¿›åˆ¶æ–‡ä»¶"><a href="#äºŒè¿›åˆ¶æ–‡ä»¶" class="headerlink" title="äºŒè¿›åˆ¶æ–‡ä»¶"></a>äºŒè¿›åˆ¶æ–‡ä»¶</h2><p>åœ¨ kubespray ä¸Šæ¸¸çš„ <a href="https://github.com/kubernetes-sigs/kubespray/pull/7561" target="_blank" rel="noopener">#7561</a>  PR ä¸­å®ç°äº†æ ¹æ® kubespray çš„æºç ç”Ÿæˆéœ€è¦çš„æ–‡ä»¶åˆ—è¡¨å’Œé•œåƒåˆ—è¡¨ã€‚åªéœ€è¦åœ¨ repo çš„ <code>contrib/offline</code> ç›®å½•ä¸‹æ‰§è¡Œ <code>bash generate_list.sh</code> å°±å¯ä»¥ç”Ÿæˆä¸€ä¸ª files.list å’Œä¸€ä¸ª images.list  æ–‡ä»¶ã€‚ç„¶åå°±å¯ä»¥æ ¹æ®è¿™ä¸ªæ–‡ä»¶æ¥ä¸‹è½½ä¾èµ–çš„æ–‡ä»¶å’Œé•œåƒã€‚å¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> contrib/offline</span><br><span class="line">$ bash generate_list.sh</span><br><span class="line">$ tree temp</span><br><span class="line">temp</span><br><span class="line">â”œâ”€â”€ files.list</span><br><span class="line">â”œâ”€â”€ generate.sh</span><br><span class="line">â””â”€â”€ images.list</span><br></pre></td></tr></table></figure>
<ul>
<li>files.list å†…å®¹å¦‚ä¸‹</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cat temp/files.list</span><br><span class="line">https://get.helm.sh/helm-v3.5.4-linux-amd64.tar.gz</span><br><span class="line">https://github.com/containerd/nerdctl/releases/download/v0.8.0/nerdctl-0.8.0-linux-amd64.tar.gz</span><br><span class="line">https://github.com/containernetworking/plugins/releases/download/v0.9.1/cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">https://github.com/containers/crun/releases/download/0.19/crun-0.19-linux-amd64</span><br><span class="line">https://github.com/coreos/etcd/releases/download/v3.4.13/etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">https://github.com/kata-containers/runtime/releases/download/1.12.1/kata-static-1.12.1-x86_64.tar.xz</span><br><span class="line">https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.20.0/crictl-v1.20.0-linux-amd64.tar.gz</span><br><span class="line">https://github.com/kubernetes-sigs/krew/releases/download/v0.4.1/krew.tar.gz</span><br><span class="line">https://github.com/projectcalico/calico/archive/v3.17.4.tar.gz</span><br><span class="line">https://github.com/projectcalico/calicoctl/releases/download/v3.17.4/calicoctl-linux-amd64</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubeadm</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubectl</span><br><span class="line">https://storage.googleapis.com/kubernetes-release/release/v1.20.6/bin/linux/amd64/kubelet</span><br></pre></td></tr></table></figure>
<p>ç„¶åé€šè¿‡ wget è¿›è¡Œä¸‹è½½</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget -x -P temp/files -i temp/files.list</span><br></pre></td></tr></table></figure>
<ul>
<li>ä¸‹è½½åçš„æ–‡ä»¶å¦‚ä¸‹</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"> tree temp/files</span><br><span class="line">temp/files</span><br><span class="line">â”œâ”€â”€ get.helm.sh</span><br><span class="line">â”‚Â Â  â””â”€â”€ helm-v3.5.4-linux-amd64.tar.gz</span><br><span class="line">â”œâ”€â”€ github.com</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containerd</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ nerdctl</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.8.0</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ nerdctl-0.8.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containernetworking</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ plugins</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.9.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ cni-plugins-linux-amd64-v0.9.1.tgz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ containers</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ crun</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ 0.19</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ crun-0.19-linux-amd64</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ coreos</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ etcd</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v3.4.13</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ etcd-v3.4.13-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kata-containers</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ runtime</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ 1.12.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ kata-static-1.12.1-x86_64.tar.xz</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ kubernetes-sigs</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ cri-tools</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â          â””â”€â”€ v1.20.0</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”‚Â Â              â””â”€â”€ crictl-v1.20.0-linux-amd64.tar.gz</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ krew</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ releases</span><br><span class="line">â”‚Â Â  â”‚Â Â          â””â”€â”€ download</span><br><span class="line">â”‚Â Â  â”‚Â Â              â””â”€â”€ v0.4.1</span><br><span class="line">â”‚Â Â  â”‚Â Â                  â””â”€â”€ krew.tar.gz</span><br><span class="line">â”‚Â Â  â””â”€â”€ projectcalico</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ calico</span><br><span class="line">â”‚Â Â      â”‚Â Â  â””â”€â”€ archive</span><br><span class="line">â”‚Â Â      â”‚Â Â      â””â”€â”€ v3.17.4.tar.gz</span><br><span class="line">â”‚Â Â      â””â”€â”€ calicoctl</span><br><span class="line">â”‚Â Â          â””â”€â”€ releases</span><br><span class="line">â”‚Â Â              â””â”€â”€ download</span><br><span class="line">â”‚Â Â                  â””â”€â”€ v3.17.4</span><br><span class="line">â”‚Â Â                      â””â”€â”€ calicoctl-linux-amd64</span><br><span class="line">â””â”€â”€ storage.googleapis.com</span><br><span class="line">    â””â”€â”€ kubernetes-release</span><br><span class="line">        â””â”€â”€ release</span><br><span class="line">            â””â”€â”€ v1.20.6</span><br><span class="line">                â””â”€â”€ bin</span><br><span class="line">                    â””â”€â”€ linux</span><br><span class="line">                        â””â”€â”€ amd64</span><br><span class="line">                            â”œâ”€â”€ kubeadm</span><br><span class="line">                            â”œâ”€â”€ kubectl</span><br><span class="line">                            â””â”€â”€ kubelet</span><br></pre></td></tr></table></figure>
<p>ä¿æŒè¿™ä¸ªç›®å½•ç»“æ„ä¸å˜ï¼ŒæŠŠå®ƒä»¬ä¸Šä¼ åˆ°è‡ªå·±çš„æ–‡ä»¶æœåŠ¡å™¨ä¸Šï¼Œç„¶åå†ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶çš„ä¸‹è½½å‚æ•°ï¼Œåªéœ€è¦åœ¨å‰é¢åŠ ä¸Šæ–‡ä»¶æœåŠ¡å™¨çš„ URL å³å¯ï¼Œæ¯”å¦‚æˆ‘çš„é…ç½®ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Download URLs</span></span><br><span class="line"><span class="attr">download_url:</span> <span class="string">"https://dl.k8s.li"</span></span><br><span class="line"><span class="attr">kubelet_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubelet"</span></span><br><span class="line"><span class="attr">kubectl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kube_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubectl"</span></span><br><span class="line"><span class="attr">kubeadm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/storage.googleapis.com/kubernetes-release/release/<span class="template-variable">&#123;&#123; kubeadm_version &#125;&#125;</span>/bin/linux/<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>/kubeadm"</span></span><br><span class="line"><span class="attr">etcd_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/coreos/etcd/releases/download/<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>/etcd-<span class="template-variable">&#123;&#123; etcd_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">cni_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containernetworking/plugins/releases/download/<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>/cni-plugins-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>-<span class="template-variable">&#123;&#123; cni_version &#125;&#125;</span>.tgz"</span></span><br><span class="line"><span class="attr">calicoctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calicoctl/releases/download/<span class="template-variable">&#123;&#123; calico_ctl_version &#125;&#125;</span>/calicoctl-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">calico_crds_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/projectcalico/calico/archive/<span class="template-variable">&#123;&#123; calico_version &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crictl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kubernetes-sigs/cri-tools/releases/download/<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>/crictl-<span class="template-variable">&#123;&#123; crictl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">helm_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/get.helm.sh/helm-<span class="template-variable">&#123;&#123; helm_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br><span class="line"><span class="attr">crun_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containers/crun/releases/download/<span class="template-variable">&#123;&#123; crun_version &#125;&#125;</span>/crun-<span class="template-variable">&#123;&#123; crun_version &#125;&#125;</span>-linux-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">kata_containers_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/kata-containers/runtime/releases/download/<span class="template-variable">&#123;&#123; kata_containers_version &#125;&#125;</span>/kata-static-<span class="template-variable">&#123;&#123; kata_containers_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_architecture &#125;&#125;</span>.tar.xz"</span></span><br><span class="line"><span class="attr">nerdctl_download_url:</span> <span class="string">"<span class="template-variable">&#123;&#123; download_url &#125;&#125;</span>/github.com/containerd/nerdctl/releases/download/v<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>/nerdctl-<span class="template-variable">&#123;&#123; nerdctl_version &#125;&#125;</span>-<span class="template-variable">&#123;&#123; ansible_system | lower &#125;&#125;</span>-<span class="template-variable">&#123;&#123; image_arch &#125;&#125;</span>.tar.gz"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>images.list æ˜¯ kubespray æ‰€æœ‰å¯èƒ½ä¼šç”¨åˆ°çš„é•œåƒï¼Œå¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat temp/images.list</span></span><br><span class="line">docker.io/amazon/aws-alb-ingress-controller:v1.1.9</span><br><span class="line">docker.io/amazon/aws-ebs-csi-driver:v0.5.0</span><br><span class="line">docker.io/cloudnativelabs/kube-router:v1.2.2</span><br><span class="line">docker.io/integratedcloudnative/ovn4nfv-k8s-plugin:v1.1.0</span><br><span class="line">docker.io/k8scloudprovider/cinder-csi-plugin:v1.20.0</span><br><span class="line">docker.io/kubeovn/kube-ovn:v1.6.2</span><br><span class="line">docker.io/kubernetesui/dashboard-amd64:v2.2.0</span><br><span class="line">docker.io/kubernetesui/metrics-scraper:v1.0.6</span><br><span class="line">docker.io/library/haproxy:2.3</span><br><span class="line">docker.io/library/nginx:1.19</span><br><span class="line">docker.io/library/registry:2.7.1</span><br><span class="line">docker.io/nfvpe/multus:v3.7</span><br><span class="line">docker.io/rancher/<span class="built_in">local</span>-path-provisioner:v0.0.19</span><br><span class="line">docker.io/weaveworks/weave-kube:2.8.1</span><br><span class="line">docker.io/weaveworks/weave-npc:2.8.1</span><br><span class="line">docker.io/xueshanf/install-socat:latest</span><br><span class="line">k8s.gcr.io/addon-resizer:1.8.11</span><br><span class="line">k8s.gcr.io/coredns:1.7.0</span><br><span class="line">k8s.gcr.io/cpa/cluster-proportional-autoscaler-amd64:1.8.3</span><br><span class="line">k8s.gcr.io/dns/k8s-dns-node-cache:1.17.1</span><br><span class="line">k8s.gcr.io/ingress-nginx/controller:v0.43.0</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.20.6</span><br><span class="line">k8s.gcr.io/kube-registry-proxy:0.4</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.20.6</span><br><span class="line">k8s.gcr.io/metrics-server/metrics-server:v0.4.2</span><br><span class="line">k8s.gcr.io/pause:3.3</span><br><span class="line">quay.io/calico/cni:v3.17.4</span><br><span class="line">quay.io/calico/kube-controllers:v3.17.4</span><br><span class="line">quay.io/calico/node:v3.17.4</span><br><span class="line">quay.io/calico/typha:v3.17.4</span><br><span class="line">quay.io/cilium/cilium-init:2019-04-05</span><br><span class="line">quay.io/cilium/cilium:v1.8.9</span><br><span class="line">quay.io/cilium/operator:v1.8.9</span><br><span class="line">quay.io/coreos/etcd:v3.4.13</span><br><span class="line">quay.io/coreos/flannel:v0.13.0-amd64</span><br><span class="line">quay.io/datawire/ambassador-operator:v1.2.9</span><br><span class="line">quay.io/external_storage/cephfs-provisioner:v2.1.0-k8s1.11</span><br><span class="line">quay.io/external_storage/<span class="built_in">local</span>-volume-provisioner:v2.3.4</span><br><span class="line">quay.io/external_storage/rbd-provisioner:v2.1.1-k8s1.11</span><br><span class="line">quay.io/jetstack/cert-manager-cainjector:v1.0.4</span><br><span class="line">quay.io/jetstack/cert-manager-controller:v1.0.4</span><br><span class="line">quay.io/jetstack/cert-manager-webhook:v1.0.4</span><br><span class="line">quay.io/k8scsi/csi-attacher:v2.2.0</span><br><span class="line">quay.io/k8scsi/csi-node-driver-registrar:v1.3.0</span><br><span class="line">quay.io/k8scsi/csi-provisioner:v1.6.0</span><br><span class="line">quay.io/k8scsi/csi-resizer:v0.5.0</span><br><span class="line">quay.io/k8scsi/csi-snapshotter:v2.1.1</span><br><span class="line">quay.io/k8scsi/snapshot-controller:v2.0.1</span><br><span class="line">quay.io/l23network/k8s-netchecker-agent:v1.0</span><br><span class="line">quay.io/l23network/k8s-netchecker-server:v1.0</span><br></pre></td></tr></table></figure>
<p>å¯ä½¿ç”¨ skopeo å°†é•œåƒåŒæ­¥åˆ°è‡ªå·±çš„ registry ä¸­ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> image <span class="keyword">in</span> $(cat temp/images.list); <span class="keyword">do</span> skopeo copy docker://<span class="variable">$&#123;image&#125;</span> docker://hub.k8s.li/<span class="variable">$&#123;image#*/&#125;</span>; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>å½“æ—¶å†™è¿™ä¸ªè„šæœ¬çš„æ—¶å€™ä¸€å †è›‡çš® sed æ›¿æ¢æ“ä½œå†™å¾—æƒ³ ğŸ¤®ï¼Œæ¯”å¦‚æœ‰äº›å˜é‡ä¼šæœ‰ ansible çš„ if else åˆ¤æ–­ï¼Œè¿™å°±æ„å‘³ç€ä¹Ÿè¦ç”¨ shell å»å®ç°å®ƒçš„åˆ¤æ–­é€»è¾‘ã€‚æ¯”å¦‚ä½¿ç”¨ shell å¤„ç†çš„æ—¶å€™éœ€è¦å°†è¿™ä¸‹é¢å¨è½¬æ¢æˆ shell çš„ if elseï¼Œè€Œä¸”è¿˜ä¸èƒ½æ¢è¡Œï¼š</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">coredns_image_repo:</span> <span class="string">"<span class="template-variable">&#123;&#123; kube_image_repo &#125;&#125;</span><span class="template-variable">&#123;&#123;'/coredns/coredns' if (coredns_image_is_namespaced | bool) else '/coredns' &#125;&#125;</span>"</span></span><br><span class="line"><span class="attr">coredns_image_tag:</span> <span class="string">"<span class="template-variable">&#123;&#123; coredns_version if (coredns_image_is_namespaced | bool) else (coredns_version | regex_replace('^v', '')) &#125;&#125;</span>"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># special handling for https://github.com/kubernetes-sigs/kubespray/pull/7570</span></span><br><span class="line">sed -i <span class="string">'s#^coredns_image_repo=.*#coredns_image_repo=$&#123;kube_image_repo&#125;$(if printf "%s\\n%s\\n" v1.21 $&#123;kube_version%.*&#125; | sort --check=quiet --version-sort; then echo -n /coredns/coredns;else echo -n /coredns; fi)#'</span> <span class="variable">$&#123;TEMP_DIR&#125;</span>/generate.sh</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'s#^coredns_image_tag=.*#coredns_image_tag=$(if printf "%s\\n%s\\n" v1.21 $&#123;kube_version%.*&#125; | sort --check=quiet --version-sort; then echo -n $&#123;coredns_version&#125;;else echo -n $&#123;coredns_version/v/&#125;; fi)#'</span> <span class="variable">$&#123;TEMP_DIR&#125;</span>/generate.sh</span><br></pre></td></tr></table></figure>
<p>å½“æ—¶è¿˜å­¦ä¼šäº†ä¸€æ‰‹ï¼Œåœ¨ shell ä¸­ä½¿ç”¨ <code>printf &quot;%s\\n%s\\n&quot; $v1 $v2 | sort --check=quiet --version-sort</code> è¿™ç§æ–¹å¼å¯ä»¥åˆ¤æ–­ä¸¤ä¸ªç‰ˆæœ¬å·çš„å¤§å°ï¼Œè€Œä¸”æ˜¯æœ€ç®€å•ä¾¿æ·çš„ã€‚</p>
<h2 id="é•œåƒä»“åº“"><a href="#é•œåƒä»“åº“" class="headerlink" title="é•œåƒä»“åº“"></a>é•œåƒä»“åº“</h2><p>ä¹‹å‰æåˆ°çš„æ˜¯æ ¹æ®é•œåƒåˆ—è¡¨å°†éœ€è¦çš„é•œåƒåŒæ­¥åˆ°è‡ªå·±çš„ registry ä¸­ï¼Œä½†å¯¹äºæœ¬åœ°å¼€å‘æµ‹è¯•æ¥è®²ï¼Œè¿™ç§æ‰‹åŠ¨å¯¼å…¥æ¯”è¾ƒè´¹äº‹è´¹åŠ›ã€‚åœ¨çœ‹äº†å¤§ä½¬å†™çš„ <a href="https://fuckcloudnative.io/posts/docker-registry-proxy/" target="_blank" rel="noopener">Docker é•œåƒåŠ é€Ÿæ•™ç¨‹</a> å’Œ <a href="https://www.chenshaowen.com/blog/how-to-run-a-private-registry-mirror.html" target="_blank" rel="noopener">å¦‚ä½•æ­å»ºä¸€ä¸ªç§æœ‰çš„é•œåƒä»“åº“ mirror</a>  å°±æƒ³åˆ°äº†å¯ä»¥ä½¿ç”¨ docker registry çš„ proxy ç‰¹æ€§æ¥éƒ¨ç½²å‡ ä¸ª kubespray éœ€è¦çš„é•œåƒä»“åº“ã€‚å¦‚ä¸‹</p>
<table>
<thead>
<tr>
<th>origin</th>
<th>mirror</th>
</tr>
</thead>
<tbody><tr>
<td>docker.io</td>
<td>hub.k8s.li</td>
</tr>
<tr>
<td>k8s.gcr.io</td>
<td>gcr.k8s.li</td>
</tr>
<tr>
<td>quay.io</td>
<td>quay.k8s.li</td>
</tr>
</tbody></table>
<ul>
<li>config.yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="number">0.1</span></span><br><span class="line"><span class="attr">log:</span></span><br><span class="line">  <span class="attr">fields:</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">registry</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">blobdescriptor:</span> <span class="string">inmemory</span></span><br><span class="line">  <span class="attr">oss:</span></span><br><span class="line">    <span class="attr">accesskeyid:</span> <span class="string">xxxx</span> <span class="comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeyid</span></span><br><span class="line">    <span class="attr">accesskeysecret:</span> <span class="string">xxxx</span> <span class="comment"># è¿™é‡Œé…ç½®é˜¿é‡Œäº‘ OSS çš„ accesskeysecret</span></span><br><span class="line">    <span class="attr">region:</span> <span class="string">oss-cn-beijing</span> <span class="comment"># é…ç½® OSS bucket çš„åŒºåŸŸï¼Œæ¯”å¦‚ oss-cn-beijing</span></span><br><span class="line">    <span class="attr">internal:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">bucket:</span> <span class="string">fileserver</span> <span class="comment"># é…ç½®å­˜å‚¨ bucket çš„åç§°</span></span><br><span class="line">    <span class="attr">rootdirectory:</span> <span class="string">/kubespray/registry</span> <span class="comment"># é…ç½®è·¯å¾„</span></span><br><span class="line">  <span class="attr">delete:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="attr">headers:</span></span><br><span class="line">    <span class="attr">X-Content-Type-Options:</span> <span class="string">[nosniff]</span></span><br><span class="line"><span class="attr">health:</span></span><br><span class="line">  <span class="attr">storagedriver:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">threshold:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure>
<ul>
<li>docker-compose.yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">gcr-registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gcr-registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.yml:/etc/docker/registry/config.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5001:5001</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_HTTP_ADDR=0.0.0.0:5001</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_PROXY_REMOTEURL=https://k8s.gcr.io</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">hub-registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">hub-registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.yml:/etc/docker/registry/config.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5002:5002</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_HTTP_ADDR=0.0.0.0:5002</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_PROXY_REMOTEURL=https://docker.io</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">quay-registry:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry:2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">quay-registry</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config.yml:/etc/docker/registry/config.yml</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:5003:5003</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_HTTP_ADDR=0.0.0.0:5003</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REGISTRY_PROXY_REMOTEURL=https://quay.io</span></span><br></pre></td></tr></table></figure>
<ul>
<li>nginx.conf</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  gcr.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> domain.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> domain.key;</span><br><span class="line">    <span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">100000m</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET|HEAD)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   http://localhost:5001;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  hub.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> domain.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> domain.key;</span><br><span class="line">    <span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">100000m</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET|HEAD)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   http://localhost:5002;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span>       [::]:<span class="number">443</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  quay.k8s.li;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> domain.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> domain.key;</span><br><span class="line">    <span class="attribute">gzip_static</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">100000m</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET|HEAD)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   http://localhost:5003;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›¸å…³é…ç½®æ–‡ä»¶åœ¨ <a href="https://github.com/muzi502/registry-mirrors" target="_blank" rel="noopener">registry-mirrors</a> è¿™ä¸ª repo ä¸­ã€‚</p>
<h2 id="ä¼˜åŒ–-kubespray-é•œåƒå¤§å°"><a href="#ä¼˜åŒ–-kubespray-é•œåƒå¤§å°" class="headerlink" title="ä¼˜åŒ– kubespray é•œåƒå¤§å°"></a>ä¼˜åŒ– kubespray é•œåƒå¤§å°</h2><p>kubespray v1.25.1 ç‰ˆæœ¬å®˜æ–¹æ„å»ºçš„é•œåƒå¤§å°ä¸º <code>1.41GB</code>ï¼Œå¯¹äºä¸€äº›åœºæ™¯ä¸‹å¸Œæœ›é•œåƒå°ä¸€äº›ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•æ„å»ºä¸€ä¸ªä½“ç§¯è¾ƒå°çš„é•œåƒã€‚</p>
<ul>
<li>é¦–å…ˆæ„å»ºä¸€ä¸ª base é•œåƒï¼Œå¯¹äºä¸ç»å¸¸å˜åŠ¨çš„æˆ‘ä»¬æŠŠå®ƒå°è£…åœ¨ä¸€ä¸ª base é•œåƒé‡Œï¼Œåªæœ‰å½“ç›¸å…³ä¾èµ–æ›´æ–°äº†æ‰éœ€è¦é‡æ–°æ„å»ºè¿™ä¸ª base é•œåƒï¼Œ<code>Dockerfile.base</code> å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.6</span>-slim</span><br><span class="line"><span class="keyword">ENV</span> KUBE_VERSION v1.<span class="number">20.6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt update -y \</span></span><br><span class="line"><span class="bash"> &amp;&amp; apt install -y \</span></span><br><span class="line"><span class="bash"> libssl-dev sshpass apt-transport-https jq moreutils vim moreutils iputils-ping \</span></span><br><span class="line"><span class="bash"> ca-certificates curl gnupg2 software-properties-common rsync wget tcpdump \</span></span><br><span class="line"><span class="bash"> &amp;&amp; rm -rf /var/lib/apt/lists/* \</span></span><br><span class="line"><span class="bash"> &amp;&amp; wget -q https://dl.k8s.io/<span class="variable">$KUBE_VERSION</span>/bin/linux/amd64/kubectl -O /usr/<span class="built_in">local</span>/bin/kubectl \</span></span><br><span class="line"><span class="bash"> &amp;&amp; chmod a+x /usr/<span class="built_in">local</span>/bin/kubectl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /kubespray</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> python3 -m pip install -r requirements.txt</span></span><br></pre></td></tr></table></figure>
<p>æ„å»º kubespray é•œåƒï¼šFROM çš„ base é•œåƒå°±ä½¿ç”¨æˆ‘ä»¬åˆšåˆšæ„å»ºå¥½çš„é•œåƒï¼Œå¯¹äº kubespray æ¥è®²ï¼Œç›¸å…³ä¾èµ–å·²ç»åœ¨ base é•œåƒä¸­å®‰è£…å¥½äº†ï¼Œè¿™é‡Œæ„å»ºçš„æ—¶å€™åªéœ€è¦æŠŠ repo å¤åˆ¶åˆ° /kubespray ç›®å½•ä¸‹å³å¯ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> kubespray:v2.<span class="number">16.0</span>-base-kube-v1.<span class="number">20.6</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . /kubespray</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ ·æ„å»ºå‡ºæ¥çš„é•œåƒå¤§å°ä¸åˆ° 600MBï¼Œæ¯”ä¹‹å‰å°äº†å¾ˆå¤šï¼Œè€Œä¸”æ¯æ¬¡æ„å»ºé•œåƒçš„æ—¶å€™ä¹Ÿæ¯”è¾ƒå¿«ã€‚åªä¸è¿‡å½“ <code>requirements.txt</code>  æ–‡ä»¶æ›´æ–°åéœ€è¦é‡æ–°æ„å»º base é•œåƒï¼Œå¹¶ä¿®æ”¹ kubespray çš„ FROM é•œåƒä¸ºæ–°çš„ base é•œåƒã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubespray     v2.15.1                  73294562105a    1.41GB</span><br><span class="line">kubespray     v2.16-kube-v1.20.6-1.0   80b735995e48    579MB</span><br></pre></td></tr></table></figure>
<ul>
<li>kubespray é»˜è®¤æ²¡æœ‰åŠ å¦‚ <code>.dockerignore</code>ï¼Œè¿™å°±æ„å‘³ç€æ„å»ºé•œåƒçš„æ—¶å€™ä¼šæŠŠå½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹å¤åˆ¶åˆ°é•œåƒé‡Œï¼Œä¼šå¯¼è‡´é•œåƒå·¥ä½œç›®å½•ä¸‹å¯èƒ½å¾ˆæ··ä¹±ï¼Œåœ¨å®¹å™¨é‡Œ debug çš„æ—¶å€™ä¸å¤ªç¾è§‚ï¼Œå¼ºè¿«ç—‡æ‚£è€…å¯ä»¥åœ¨ repo ä¸­åŠ å…¥å¦‚ä¸‹çš„ <code>.dockerignore</code> æ–‡ä»¶ã€‚</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.ansible-lint</span><br><span class="line">.editorconfig</span><br><span class="line">.git</span><br><span class="line">.github</span><br><span class="line">.gitignore</span><br><span class="line">.gitlab-ci</span><br><span class="line">.gitlab-ci.yml</span><br><span class="line">.gitmodules</span><br><span class="line">.markdownlint.yaml</span><br><span class="line">.nojekyll</span><br><span class="line">CNAME</span><br><span class="line">CONTRIBUTING.md</span><br><span class="line">Dockerfile</span><br><span class="line">Makefile</span><br><span class="line">OWNERS</span><br><span class="line">README.md</span><br><span class="line">RELEASE.md</span><br><span class="line">SECURITY_CONTACTS</span><br><span class="line">build</span><br><span class="line">code-of-conduct.md</span><br><span class="line">docs</span><br><span class="line">index.html</span><br><span class="line">logo</span><br></pre></td></tr></table></figure>
<h2 id="docker-registry-ç¦æ­¢-push-é•œåƒ"><a href="#docker-registry-ç¦æ­¢-push-é•œåƒ" class="headerlink" title="docker registry ç¦æ­¢ push é•œåƒ"></a>docker registry ç¦æ­¢ push é•œåƒ</h2><p>é»˜è®¤ç›´æ¥ä½¿ç”¨ docker registry æ¥éƒ¨ç½²é•œåƒä»“åº“çš„è¯ï¼Œæ¯”å¦‚æˆ‘çš„ hub.k8s.li ï¼Œå› ä¸ºæ²¡æœ‰æƒé™é™åˆ¶ä¼šå¯¼è‡´ä»»ä½•å¯è®¿é—®è¯¥é•œåƒä»“åº“çš„å®¢æˆ·ç«¯å¯ä»¥ push é•œåƒï¼Œè¿™æœ‰ç‚¹ä¸å®‰å…¨ï¼Œéœ€è¦å®‰å…¨åŠ å›ºä¸€ä¸‹ã€‚å› ä¸º pull é•œåƒçš„æ—¶å€™å®¢æˆ·ç«¯èµ°çš„éƒ½æ˜¯ HTTP GET è¯·æ±‚ï¼Œå¯ä»¥é€šè¿‡ nginx ç¦æ­¢ POSTã€PUT è¿™ç§è¯·æ±‚æ–¹æ³•ï¼Œè¿™æ ·å°±å¯ä»¥ç¦æ­¢ push é•œåƒã€‚åœ¨ nginx çš„server å­—æ®µä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> !<span class="regexp">~* GET)</span> &#123;</span><br><span class="line">         <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·åœ¨ push é•œåƒçš„æ—¶å€™ä¼šè¿”å› 403 çš„é”™è¯¯</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/root # docker pull hub.k8s.li/calico/node:v3.17.3</span><br><span class="line">v3.17.3: Pulling from calico/node</span><br><span class="line">282bf12aa8be: Pull complete</span><br><span class="line">4ac1bb9354ad: Pull complete</span><br><span class="line">Digest: sha256:3595a9a945a7ba346a12ee523fc7ae15ed35f1e6282b76bce7fec474d28d68bb</span><br><span class="line">Status: Downloaded newer image for hub.k8s.li/calico/node:v3.17.3</span><br><span class="line">root@debian:/root # docker push !$</span><br><span class="line">root@debian:/root # docker push hub.k8s.li/calico/node:v3.17.3</span><br><span class="line">The push refers to repository [hub.k8s.li/calico/node]</span><br><span class="line">bc19ae092bb4: Preparing</span><br><span class="line">94333d52d45d: Preparing</span><br><span class="line">error parsing HTTP 403 response body: invalid character '&lt;' looking for beginning of value: "&lt;html&gt;\r\n&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;\r\n&lt;body bgcolor=\"white\"&gt;\r\n&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;\r\n&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n"</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆéœ€è¦ push é•œåƒçš„æ—¶å€™æ€ä¹ˆåŠï¼Ÿ</p>
<p>docker registry å¯åŠ¨çš„æ—¶å€™ bind åœ¨ 127.0.0.1 ä¸Šï¼Œè€Œä¸æ˜¯ 0.0.0.0ï¼Œé€šè¿‡ localhost:5000 æ¥ push é•œåƒã€‚</p>
<h2 id="é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦"><a href="#é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦" class="headerlink" title="é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦"></a>é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦</h2><p>å¦‚æœé•œåƒä»“åº“ä½¿ç”¨çš„æ˜¯è‡ªç­¾è¯ä¹¦ï¼Œå¯ä»¥è·‘ä¸‹é¢è¿™ä¸ª playbook å°†è‡ªç­¾è¯ä¹¦æ·»åŠ åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ trusted CA dir ä¸­ï¼Œè¿™æ ·æ— éœ€é…ç½® <code>insecure-registries</code> ä¹Ÿèƒ½æ‹‰å–é•œåƒã€‚</p>
<p><code>add-registry-ca.yml</code></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">target</span> <span class="string">ca-certificate</span> <span class="string">store</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">set_fact:</span></span><br><span class="line">        <span class="attr">ca_cert_path:</span> <span class="string">|-</span></span><br><span class="line">          <span class="string">&#123;%</span> <span class="string">if</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"Debian"</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/usr/local/share/ca-certificates/registry-ca.crt</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">elif</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"RedHat"</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/etc/pki/ca-trust/source/anchors/registry-ca.crt</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">elif</span> <span class="string">ansible_os_family</span> <span class="string">in</span> <span class="string">["Flatcar</span> <span class="string">Container</span> <span class="string">Linux</span> <span class="string">by</span> <span class="string">Kinvolk"]</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/etc/ssl/certs/registry-ca.pem</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">elif</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"Suse"</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/etc/pki/trust/anchors/registry-ca.pem</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">elif</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"ClearLinux"</span> <span class="string">-%&#125;</span></span><br><span class="line">          <span class="string">/usr/share/ca-certs/registry-ca.pem</span></span><br><span class="line">          <span class="string">&#123;%-</span> <span class="string">endif</span> <span class="string">%&#125;</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">facts</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">add</span> <span class="string">CA</span> <span class="string">to</span> <span class="string">trusted</span> <span class="string">CA</span> <span class="string">dir</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">"<span class="template-variable">&#123;&#123; registry_cert_path &#125;&#125;</span>"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">&#123;&#123; ca_cert_path &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">registry_ca_cert</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">update</span> <span class="string">ca-certificates</span> <span class="string">(Debian/Ubuntu/SUSE/Flatcar)</span>  <span class="comment"># noqa 503</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">update-ca-certificates</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">registry_ca_cert.changed</span> <span class="string">and</span> <span class="string">ansible_os_family</span> <span class="string">in</span> <span class="string">["Debian",</span> <span class="string">"Flatcar Container Linux by Kinvolk"</span><span class="string">,</span> <span class="string">"Suse"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">update</span> <span class="string">ca-certificates</span> <span class="string">(RedHat)</span>  <span class="comment"># noqa 503</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">update-ca-trust</span> <span class="string">extract</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">registry_ca_cert.changed</span> <span class="string">and</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"RedHat"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gen_certs</span> <span class="string">|</span> <span class="string">update</span> <span class="string">ca-certificates</span> <span class="string">(ClearLinux)</span>  <span class="comment"># noqa 503</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">clrtrust</span> <span class="string">add</span> <span class="string">"<span class="template-variable">&#123;&#123; ca_cert_path &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">registry_ca_cert.changed</span> <span class="string">and</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">"ClearLinux"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>å°†è‡ªç­¾çš„ registry è¯ä¹¦æ”¾åˆ°æœ¬åœ°ï¼Œæ‰§è¡Œ playbook å¹¶æŒ‡å®š <code>registry_cert_path</code> ä¸ºæ­£ç¡®çš„è·¯å¾„</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/kubespray# ansible-playbook -i deploy/inventory -e registry_cert_path=/kubespray/registry_ca.pem add-registry-ca.yml</span><br><span class="line"></span><br><span class="line">PLAY [all] **********************************************************************************</span><br><span class="line">Thursday 29 April 2021  08:18:25 +0000 (0:00:00.077)       0:00:00.077 ********</span><br><span class="line"></span><br><span class="line">TASK [Gen_certs | target ca-certificate store file] *****************************************</span><br><span class="line">ok: [kube-control-2]</span><br><span class="line">ok: [kube-control-3]</span><br><span class="line">ok: [kube-control-1]</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">Thursday 29 April 2021  08:18:25 +0000 (0:00:00.389)       0:00:00.467 ********</span><br><span class="line"></span><br><span class="line">TASK [Gen_certs | add CA to trusted CA dir] *************************************************</span><br><span class="line">changed: [kube-control-2]</span><br><span class="line">changed: [kube-control-3]</span><br><span class="line">changed: [kube-control-1]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">Thursday 29 April 2021  08:18:29 +0000 (0:00:04.433)       0:00:04.901 ********</span><br><span class="line">Thursday 29 April 2021  08:18:30 +0000 (0:00:00.358)       0:00:05.259 ********</span><br><span class="line"></span><br><span class="line">TASK [Gen_certs | update ca-certificates (RedHat)] ******************************************</span><br><span class="line">changed: [kube-control-1]</span><br><span class="line">changed: [kube-control-3]</span><br><span class="line">changed: [kube-control-2]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">Thursday 29 April 2021  08:18:33 +0000 (0:00:02.938)       0:00:08.197 ********</span><br><span class="line"></span><br><span class="line">PLAY RECAP **********************************************************************************</span><br><span class="line">kube-control-1             : ok=3    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0</span><br><span class="line">kube-control-2             : ok=3    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0</span><br><span class="line">kube-control-3             : ok=3    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0</span><br><span class="line">kube-node-1                : ok=3    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0</span><br><span class="line"></span><br><span class="line">Thursday 29 April 2021  08:18:33 +0000 (0:00:00.355)  0:00:08.553 ********</span><br><span class="line">================================================================</span><br><span class="line">Gen_certs | add CA to trusted CA dir ------------------------------------------------------------- 4.43s</span><br><span class="line">Gen_certs | update ca-certificates (RedHat) ------------------------------------------------------------- 2.94s</span><br><span class="line">Gen_certs | target ca-certificate store file ------------------------------------------------------------- 0.39s</span><br><span class="line">Gen_certs | update ca-certificates (Debian/Ubuntu/SUSE/Flatcar) ------------------------------------------------------------- 0.36s</span><br><span class="line">Gen_certs | update ca-certificates (ClearLinux) -------------------------------------------------------------- 0.36s</span><br></pre></td></tr></table></figure>
<h2 id="containerd-æ— æ³•åŠ è½½-CNI-é…ç½®å¯¼è‡´èŠ‚ç‚¹-NotReady"><a href="#containerd-æ— æ³•åŠ è½½-CNI-é…ç½®å¯¼è‡´èŠ‚ç‚¹-NotReady" class="headerlink" title="containerd æ— æ³•åŠ è½½ CNI é…ç½®å¯¼è‡´èŠ‚ç‚¹ NotReady"></a>containerd æ— æ³•åŠ è½½ CNI é…ç½®å¯¼è‡´èŠ‚ç‚¹ NotReady</h2><p>å¶ç°é—®é¢˜ï¼Œé‡å¯ä¸€ä¸‹ containerd å°±å¯ä»¥äº†ï¼Œå…·ä½“åŸå› è¿˜æ²¡æ’æŸ¥å‡ºæ¥</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/kubespray<span class="comment"># ansible all -i deploy/inventory -m service -a "name=containerd state=restarted"</span></span><br></pre></td></tr></table></figure>
<h2 id="ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦"><a href="#ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦" class="headerlink" title="ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦"></a>ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦</h2><p>Kubespray éƒ¨ç½²çš„æ—¶å€™æœ‰ä¸ª task ä¸“é—¨ç”¨æ¥ä¸‹è½½éƒ¨ç½²éœ€è¦çš„é•œåƒï¼Œç”±äºæ˜¯æ“ä½œçš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¼šå°†ä¸€äº›ä¸éœ€è¦çš„é•œåƒæ‹‰å–åˆ°è¯¥èŠ‚ç‚¹ä¸Šã€‚æ¯”å¦‚ kube-apiserverã€kube-controller-managerã€kube-scheduler è¿™äº›åœ¨ node èŠ‚ç‚¹ä¸Šä¸ä¼šç”¨åˆ°çš„é•œåƒä¹Ÿä¼šåœ¨ node èŠ‚ç‚¹ä¸Šæ‹‰å–ï¼Œè¿™æ ·ä¼šå¯¼è‡´ download çš„ task æ¯”è¾ƒè€—æ—¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">TASK [download : set_container_facts | Display the name of the image being processed] ********************************************************************************************</span><br><span class="line">ok: [kube-control-3] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-controller-manager"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-control-2] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-controller-manager"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-control-1] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-controller-manager"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-node-1] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-controller-manager"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ok: [kube-control-3] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-scheduler"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-control-2] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-scheduler"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-control-1] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-scheduler"</span></span><br><span class="line">&#125;</span><br><span class="line">ok: [kube-node-1] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"gcr.k8s.li/kube-scheduler"</span></span><br></pre></td></tr></table></figure>
<p>å¯ç”¨é€šè¿‡ <code>download_container: false</code> è¿™ä¸ªå‚æ•°æ¥ç¦ç”¨ download container è¿™ä¸ª taskï¼Œè¿™æ ·åœ¨ pod å¯åŠ¨çš„æ—¶å€™åªæ‹‰å–éœ€è¦çš„é•œåƒï¼Œå¯ä»¥èŠ‚çœä¸€äº›éƒ¨ç½²è€—æ—¶ã€‚</p>
<h2 id="å¯ç”¨æ’ä»¶"><a href="#å¯ç”¨æ’ä»¶" class="headerlink" title="å¯ç”¨æ’ä»¶"></a>å¯ç”¨æ’ä»¶</h2><p>Kubespray å®˜æ–¹æ”¯æŒçš„æ’ä»¶åˆ—è¡¨å¦‚ä¸‹ï¼Œé»˜è®¤æ˜¯ false ç¦ç”¨äº†æ’ä»¶ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Kubernetes dashboard</span></span><br><span class="line"><span class="comment"># RBAC required. see docs/getting-started.md for access details.</span></span><br><span class="line"><span class="attr">dashboard_enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Addons which can be enabled</span></span><br><span class="line"><span class="attr">helm_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">krew_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">registry_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">metrics_server_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">enable_network_policy:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">local_path_provisioner_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">local_volume_provisioner_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">local_volume_provisioner_directory_mode:</span> <span class="number">0700</span></span><br><span class="line"><span class="attr">cinder_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">aws_ebs_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">azure_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">gcp_pd_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">vsphere_csi_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">persistent_volumes_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">cephfs_provisioner_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">rbd_provisioner_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">ingress_nginx_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">ingress_ambassador_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">ingress_alb_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">cert_manager_enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">expand_persistent_volumes:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">metallb_enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># containerd official CLI tool</span></span><br><span class="line"><span class="attr">nerdctl_enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>åœ¨éƒ¨ç½²çš„æ—¶å€™å¦‚æœæƒ³å¯åŠ¨æŸäº›æ’ä»¶å¯ä»¥åœ¨è‡ªå·±æœ¬åœ°å¯¹åº”çš„ inventory ç›®å½•ä¸‹çš„ <code>group_vars/k8s_cluster/addons.yml</code> æ–‡ä»¶ä¸­é€‰æ‹©å¼€å¯ç›¸åº”çš„æ’ä»¶ï¼Œæ¯”å¦‚ <code>inventory/sample/group_vars/k8s_cluster/addons.yml</code>ã€‚</p>
<h2 id="åˆ†å±‚éƒ¨ç½²"><a href="#åˆ†å±‚éƒ¨ç½²" class="headerlink" title="åˆ†å±‚éƒ¨ç½²"></a>åˆ†å±‚éƒ¨ç½²</h2><p>è¿™ä¸ªæ˜¯æˆ‘ä»¬å¯¹ kubespray äºŒå¼€çš„ä¸€ä¸ªä¼˜åŒ–é¡¹ã€‚kubespray åœ¨éƒ¨ç½²é›†ç¾¤çš„æ—¶å€™è¿è¡Œçš„ playbook æ˜¯ <code>cluster.yml</code>ï¼Œåœ¨é›†ç¾¤éƒ¨ç½²çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå› ä¸ºä½ ä¸€äº›ä¸ç¨³å®šå› ç´ å¯¼è‡´é›†ç¾¤éƒ¨ç½²å¤±è´¥ï¼Œå¤±è´¥åå†æ¬¡å°è¯•éƒ¨ç½²çš„è¯ï¼Œkubespray ä¼šä»å¤´å¼€å§‹å†è·‘ä¸€éå·²ç»æˆåŠŸè¿è¡Œçš„ taskï¼Œè¿™æ ·çš„æ•ˆç‡ä¼šæ¯”è¾ƒä½ã€‚å› æ­¤éœ€è¦ä½¿ç”¨æŸç§æ–¹æ³•è®°å½•ä¸€ä¸‹å·²ç»æˆåŠŸæ‰§è¡Œçš„ task æˆ– rolesï¼Œå¤±è´¥åé‡æ–°éƒ¨ç½²çš„æ—¶å€™å°±è·³è¿‡è¿™äº›å·²ç»æˆåŠŸè¿è¡Œçš„ taskï¼Œç„¶åä»ä¸Šæ¬¡å¤±è´¥çš„åœ°æ–¹å¼€å§‹è¿è¡Œã€‚</p>
<p>å¤§ä½“çš„æ€è·¯æ˜¯æ ¹æ® <code>cluster.yml</code> ä¸­çš„ roles æ‹†åˆ†ä¸ºä¸åŒçš„å±‚å³ layerï¼Œå¦‚ bootstrap-osã€downloadã€kubernetesã€networkã€apps ï¼Œåœ¨éƒ¨ç½²çš„è¿‡ç¨‹ä¸­æ¯è¿è¡Œå®Œä¸€ä¸ª layer å°±å°†å®ƒè®°å½•åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œéƒ¨ç½²çš„æ—¶å€™ä¼šæ ¹æ®è¿™ä¸ªæ–‡ä»¶æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦éƒ¨ç½²ï¼Œå¦‚æœæ–‡ä»¶ä¸­è®°å½•å­˜åœ¨çš„è¯å°±è¯´æ˜å·²ç»æˆåŠŸéƒ¨ç½²å®Œæˆäº†ï¼Œå°±è·³è¿‡å®ƒï¼Œç»§ç»­æ‰§è¡Œæœªæ‰§è¡Œçš„ layerã€‚</p>
<p>è‡³äºæ‹†åˆ†çš„æ–¹å¼å¤§æ¦‚æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ ¹æ® tag ã€ä¸€ç§æ˜¯å°† <code>cluster.yml</code> æ–‡ä»¶æ‹†åˆ†æˆè‹¥å¹²ä¸ª playbook æ–‡ä»¶ã€‚é€šè¿‡ tag çš„æ–¹å¼å¯èƒ½ä¼šæ¯”è¾ƒå¤æ‚ä¸€äº›ï¼Œåœ¨è¿™é‡Œè¿˜æ˜¯é€‰æ‹©æ‹†åˆ†çš„æ–¹å¼ã€‚æ‹†åˆ†çš„ç²’åº¦æœ‰å¤§æœ‰å°ï¼Œä»¥ä¸‹æ˜¯æˆ‘è®¤ä¸ºæ¯”è¾ƒåˆç†çš„æ‹†å°æ–¹å¼ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">playbooks</span><br><span class="line">â”œâ”€â”€ 00-default-ssh-config.yml <span class="comment"># é»˜è®¤éœ€è¦è¿è¡Œçš„ playbookï¼Œç”¨äºé…ç½®å ¡å’æœºå’Œé…ç½® ssh è®¤è¯</span></span><br><span class="line">â”œâ”€â”€ 01-cluster-bootstrap-os.yml <span class="comment"># åˆå§‹åŒ–é›†ç¾¤èŠ‚ç‚¹ OSï¼Œå®‰è£…å®¹å™¨è¿è¡Œæ—¶ï¼Œä¸‹è½½éƒ¨ç½²ä¾èµ–çš„æ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ 02-cluster-etcd.yml <span class="comment"># éƒ¨ç½² etcd é›†ç¾¤</span></span><br><span class="line">â”œâ”€â”€ 03-cluster-kubernetes.yml <span class="comment"># éƒ¨ç½² kubernetes é›†ç¾¤</span></span><br><span class="line">â”œâ”€â”€ 04-cluster-network.yml <span class="comment"># éƒ¨ç½²ç½‘ç»œæ’ä»¶</span></span><br><span class="line">â”œâ”€â”€ 05-cluster-apps.yml <span class="comment"># éƒ¨ç½²ä¸€äº› addons ç»„ä»¶ï¼Œå¦‚ coredns ç­‰</span></span><br><span class="line">â”œâ”€â”€ 06-cluster-self-host.yml <span class="comment"># å¹³å° self-host è‡ªæ‰˜ç®¡çš„éƒ¨åˆ†</span></span><br><span class="line">â””â”€â”€ 11-reset-reset.yml <span class="comment"># ç§»é™¤é›†ç¾¤</span></span><br></pre></td></tr></table></figure>
<ul>
<li>00-default-ssh-config.yml</li>
</ul>
<p>è¯¥ playbook ç”¨äºé…ç½®å ¡å’æœºå’Œ ssh è®¤è¯ï¼Œkubespray éœ€è¦ä½¿ç”¨  public key çš„æ–¹å¼ ssh è¿æ¥åˆ°éƒ¨ç½²èŠ‚ç‚¹ï¼Œå¦‚æœéƒ¨ç½²èŠ‚ç‚¹æ²¡æœ‰é…ç½® ssh public key çš„æ–¹å¼ï¼Œå¯ä»¥æŒ‡å®š <code>ssh_cert_path</code> è¿™ä¸ªå˜é‡çš„è·¯å¾„ï¼Œå°†å…¬é’¥æ·»åŠ åˆ°ä¸»æœºçš„ authorized_key ä¸­ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">bastion[0]</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">bastion-ssh-config,</span> <span class="attr">tags:</span> <span class="string">["localhost",</span> <span class="string">"bastion"</span><span class="string">]</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster:etcd</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setting</span> <span class="string">up</span> <span class="string">ssh</span> <span class="string">public</span> <span class="string">key</span> <span class="string">authentication</span></span><br><span class="line">      <span class="attr">authorized_key:</span> <span class="string">"user=<span class="template-variable">&#123;&#123; ansible_user &#125;&#125;</span> key=<span class="template-variable">&#123;&#123; lookup('file', '&#123;&#123; ssh_cert_path &#125;&#125;</span>') &#125;&#125;"</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ssh_cert_path</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line">  <span class="attr">tags:</span> <span class="string">ssh-config</span></span><br></pre></td></tr></table></figure>
<ul>
<li>01-cluster-bootstrap-os.yml</li>
</ul>
<p>è¿™ä¸ª playbook ç”¨äºåˆå§‹åŒ–éƒ¨ç½²èŠ‚ç‚¹ OSã€å®‰è£…ä¸€äº›ä¾èµ–çš„ rpm/deb åŒ…ã€å®‰è£…å®¹å™¨è¿è¡Œæ—¶ã€ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶ç­‰</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster:etcd</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">linear</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">bootstrap-os,</span> <span class="attr">tags:</span> <span class="string">bootstrap-os&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster:etcd</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/preinstall,</span> <span class="attr">tags:</span> <span class="string">preinstall</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">"container-engine"</span><span class="string">,</span> <span class="attr">tags:</span> <span class="string">"container-engine"</span><span class="string">,</span> <span class="attr">when:</span> <span class="string">deploy_container_engine|default(true)</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">download,</span> <span class="attr">tags:</span> <span class="string">download,</span> <span class="attr">when:</span> <span class="string">"not skip_downloads"</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>02-cluster-etcd.yml</li>
</ul>
<p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½² etcd é›†ç¾¤å’Œåˆ†å‘ etcd é›†ç¾¤çš„è¯ä¹¦åˆ°é›†ç¾¤èŠ‚ç‚¹ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">etcd</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">etcd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">etcd</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">etcd_cluster_setup:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">etcd_events_cluster_setup:</span> <span class="string">"<span class="template-variable">&#123;&#123; etcd_events_cluster_enabled &#125;&#125;</span>"</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">not</span> <span class="string">etcd_kubeadm_enabled|</span> <span class="string">default(false)</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">etcd</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">etcd</span></span><br><span class="line">      <span class="attr">vars:</span></span><br><span class="line">        <span class="attr">etcd_cluster_setup:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">etcd_events_cluster_setup:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">not</span> <span class="string">etcd_kubeadm_enabled|</span> <span class="string">default(false)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>03-cluster-kubernetes.yml</li>
</ul>
<p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½² kubernetes é›†ç¾¤ï¼Œè™½ç„¶è¿™é‡Œçš„ roles å¾ˆå¤šï¼Œä½†å¹¶æ²¡æœ‰åšè¿‡å¤šçš„æ‹†åˆ†ï¼Œä¸ªäººè¿˜æ˜¯è§‰ç€è¿™éƒ¨åˆ†å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•´ä½“ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/node,</span> <span class="attr">tags:</span> <span class="string">node</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/control-plane,</span> <span class="attr">tags:</span> <span class="string">master</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/client,</span> <span class="attr">tags:</span> <span class="string">client</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/cluster_roles,</span> <span class="attr">tags:</span> <span class="string">cluster-roles</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/kubeadm,</span> <span class="attr">tags:</span> <span class="string">kubeadm&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes/node-label,</span> <span class="attr">tags:</span> <span class="string">node-label</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>04-cluster-network.yml</li>
</ul>
<p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½²ç½‘ç»œæ’ä»¶</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">k8s_cluster</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">network_plugin,</span> <span class="attr">tags:</span> <span class="string">network</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/network_plugin,</span> <span class="attr">tags:</span> <span class="string">network</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/policy_controller,</span> <span class="attr">tags:</span> <span class="string">policy-controller</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>05-cluster-apps.yml</li>
</ul>
<p>è¿™ä¸ªä¸»è¦æ˜¯éƒ¨ç½²ä¸€äº› addons æ’ä»¶ï¼Œå¿…é¡» coredns, ingress-controllerï¼Œä»¥åŠä¸€äº›å¤–ç½®çš„ provisioner ç­‰ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Gather</span> <span class="string">facts</span></span><br><span class="line">  <span class="attr">import_playbook:</span> <span class="string">../facts.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/external_cloud_controller,</span> <span class="attr">tags:</span> <span class="string">external-cloud-controller</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/ingress_controller,</span> <span class="attr">tags:</span> <span class="string">ingress-controller</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps/external_provisioner,</span> <span class="attr">tags:</span> <span class="string">external-provisioner</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubernetes-apps,</span> <span class="attr">tags:</span> <span class="string">apps</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æ‹†åˆ†çš„æ—¶å€™å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…æƒ…å†µå»é™¤ä¸€äº›ä¸å¿…è¦çš„ rolesï¼Œæ¯”å¦‚ <code>calico_rr</code> , <code>win_nodes</code> ï¼Œæˆ‘ä»¬çš„äº§å“æœ¬èº«å°±ä¸æ”¯æŒ calico è·¯ç”±åå°„å™¨ã€ä¹Ÿä¸æ”¯æŒ windows èŠ‚ç‚¹ï¼Œå› æ­¤ç›´æ¥å°†è¿™ä¸¤éƒ¨åˆ†ç»™å»é™¤äº†ï¼Œè¿™æ ·ä¹Ÿèƒ½é¿å…å»æ‰§è¡Œè¿™äº› task çš„åˆ¤æ–­ï¼Œèƒ½èŠ‚çœä¸€å®šçš„æ—¶é—´ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">calico_rr</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">network_plugin/calico/rr,</span> <span class="attr">tags:</span> <span class="string">['network',</span> <span class="string">'calico_rr'</span><span class="string">]</span> <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">kube_control_plane[0]</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">any_errors_fatal:</span> <span class="string">"<span class="template-variable">&#123;&#123; any_errors_fatal | default(true) &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">environment:</span> <span class="string">"<span class="template-variable">&#123;&#123; proxy_disable_env &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">kubespray-defaults</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">win_nodes/kubernetes_patch,</span> <span class="attr">tags:</span> <span class="string">["master",</span> <span class="string">"win_nodes"</span><span class="string">]</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
    </div>
      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/kubernetes/" rel="tag"><i class="fa fa-tag"></i> kubernetes</a>
              <a href="/tags/kubespray/" rel="tag"><i class="fa fa-tag"></i> kubespray</a>
          </div>
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/deploy-k8s-by-kubespray.html" rel="prev" title="ä½¿ç”¨ Kubespray æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤">
      <i class="fa fa-chevron-left"></i> ä½¿ç”¨ Kubespray æœ¬åœ°å¼€å‘æµ‹è¯•éƒ¨ç½² kubernetes é›†ç¾¤
    </a></div>
      <div class="post-nav-item">
    <a href="/make-offline-mirrors.html" rel="next" title="ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº">
      ä½¿ç”¨ docker build åˆ¶ä½œ yum/apt ç¦»çº¿æº <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
  </article>
  </div>
          </div>
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
        </div>
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>
  <aside class="sidebar">
    <div class="sidebar-inner">
      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>
      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#äºŒè¿›åˆ¶æ–‡ä»¶"><span class="nav-number">1.</span> <span class="nav-text">äºŒè¿›åˆ¶æ–‡ä»¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é•œåƒä»“åº“"><span class="nav-number">2.</span> <span class="nav-text">é•œåƒä»“åº“</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¼˜åŒ–-kubespray-é•œåƒå¤§å°"><span class="nav-number">3.</span> <span class="nav-text">ä¼˜åŒ– kubespray é•œåƒå¤§å°</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-registry-ç¦æ­¢-push-é•œåƒ"><span class="nav-number">4.</span> <span class="nav-text">docker registry ç¦æ­¢ push é•œåƒ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦"><span class="nav-number">5.</span> <span class="nav-text">é•œåƒä»“åº“è‡ªç­¾è¯ä¹¦</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#containerd-æ— æ³•åŠ è½½-CNI-é…ç½®å¯¼è‡´èŠ‚ç‚¹-NotReady"><span class="nav-number">6.</span> <span class="nav-text">containerd æ— æ³•åŠ è½½ CNI é…ç½®å¯¼è‡´èŠ‚ç‚¹ NotReady</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦"><span class="nav-number">7.</span> <span class="nav-text">ä¼˜åŒ–éƒ¨ç½²é€Ÿåº¦</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#å¯ç”¨æ’ä»¶"><span class="nav-number">8.</span> <span class="nav-text">å¯ç”¨æ’ä»¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#åˆ†å±‚éƒ¨ç½²"><span class="nav-number">9.</span> <span class="nav-text">åˆ†å±‚éƒ¨ç½²</span></a></li></ol></div>
      </div>
      <!--/noindex-->
      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="æœ¨å­"
      src="https://blog.k8s.li/avatar.png">
  <p class="site-author-name" itemprop="name">æœ¨å­</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">98</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:blog@502.li" title="E-Mail â†’ mailto:blog@502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter â†’ https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi_ii" title="Telegram â†’ https:&#x2F;&#x2F;t.me&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://kindle.502.li/" title="Kindle â†’ https:&#x2F;&#x2F;kindle.502.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>Kindle</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tg.k8s.li/" title="Channel â†’ https:&#x2F;&#x2F;tg.k8s.li" rel="noopener" target="_blank"><i class="fa fa-fw fa-telegram"></i>Channel</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS â†’ &#x2F;atom.xml"><i class="fa fa-fw fa-rss"></i>RSS</a>
      </span>
  </div>
      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>
      </div>
    </main>
    <footer class="footer">
      <div class="footer-inner">
<div class="copyright">
  &copy; 2018 â€“ 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">æœ¨å­</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹æ€»å­—æ•°ï¼š</span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">1.4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">ç«™ç‚¹é˜…è¯»æ—¶é•¿ &asymp;</span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">39:50</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>
      </div>
    </footer>
  </div>
  <script src="/lib/anime.min.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>
<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://muzi.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://blog.k8s.li/kubespray-tips.html",
            identifier: "kubespray-tips.html",
            title: "kubespray éƒ¨ç½²å¸¸è§é—®é¢˜å’Œä¼˜åŒ–æ±‡æ€»"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://muzi.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>
</body>
</html>
