<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="rgba(0,0,0,0)"><meta name="generator" content="Hexo 6.3.0">

<link rel="preconnect" href="//fonts.loli.net" crossorigin>
<link rel="preconnect" href="null//null" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="rgba(0,0,0,0)">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.loli.net/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/themes/blue/pace-theme-center-atom.css">
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"blog.k8s.li","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"buttons","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="离线部署对于 PaaS toB 产品来讲，客户往往会要求产品的部署方案必须做到离线安装，即在部署时不能依赖任何在线的资源，比如安装一些 OS 软件包时依赖的 yum&#x2F;apt 源；docker.io、k8s.gcr.io 、quay.io 上面的容器镜像；GitHub 上开源软件的二进制下载文件等。 作为平台部署工具的开发者，始终被离线部署这个难题困扰着。在线的容器镜像和二进制文件比较好解">
<meta property="og:type" content="blog">
<meta property="og:title" content="使用 GitHub Actions 自动化构建 yum&#x2F;apt 离线源">
<meta property="og:url" content="https://blog.k8s.li/make-offline-mirrors.html">
<meta property="og:site_name" content="Reimu&#39;s blog">
<meta property="og:description" content="离线部署对于 PaaS toB 产品来讲，客户往往会要求产品的部署方案必须做到离线安装，即在部署时不能依赖任何在线的资源，比如安装一些 OS 软件包时依赖的 yum&#x2F;apt 源；docker.io、k8s.gcr.io 、quay.io 上面的容器镜像；GitHub 上开源软件的二进制下载文件等。 作为平台部署工具的开发者，始终被离线部署这个难题困扰着。在线的容器镜像和二进制文件比较好解">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-05-22T16:00:00.000Z">
<meta property="article:modified_time" content="2021-09-02T16:00:00.000Z">
<meta property="article:author" content="Reimu">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="centos">
<meta property="article:tag" content="ubuntu">
<meta property="article:tag" content="rpm">
<meta property="article:tag" content="deb">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://blog.k8s.li/make-offline-mirrors.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://blog.k8s.li/make-offline-mirrors.html","path":"make-offline-mirrors.html","title":"使用 GitHub Actions 自动化构建 yum/apt 离线源"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>使用 GitHub Actions 自动化构建 yum/apt 离线源 | Reimu's blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Reimu's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Reimu's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-books"><a href="https://reading.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-book fa-fw"></i>Books</a></li><li class="menu-item menu-item-kindle"><a href="https://kindle.k8s.li/" rel="noopener" target="_blank"><i class="fa fa-swatchbook fa-fw"></i>Kindle</a></li><li class="menu-item menu-item-friend"><a href="/friends.html" rel="section"><i class="fa fa-link fa-fw"></i>Friend</a></li><li class="menu-item menu-item-about"><a href="/about.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B2"><span class="nav-number">1.</span> <span class="nav-text">离线部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-build"><span class="nav-number">2.</span> <span class="nav-text">Docker build</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%82%E9%85%8D-OS"><span class="nav-number">3.</span> <span class="nav-text">适配 OS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA"><span class="nav-number">4.</span> <span class="nav-text">构建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="nav-number">4.1.</span> <span class="nav-text">构建过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#packages-yaml"><span class="nav-number">4.2.</span> <span class="nav-text">packages.yaml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CentOS7"><span class="nav-number">4.3.</span> <span class="nav-text">CentOS7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Debian9"><span class="nav-number">4.4.</span> <span class="nav-text">Debian9</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ubuntu"><span class="nav-number">4.5.</span> <span class="nav-text">Ubuntu</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#All-in-Oone"><span class="nav-number">4.6.</span> <span class="nav-text">All-in-Oone</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">5.</span> <span class="nav-text">使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GitHub-Action-%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA"><span class="nav-number">6.</span> <span class="nav-text">GitHub Action 自动构建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84"><span class="nav-number">6.1.</span> <span class="nav-text">代码结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Workflow"><span class="nav-number">6.2.</span> <span class="nav-text">Workflow</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BC%98%E5%8C%96"><span class="nav-number">7.</span> <span class="nav-text">优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dockerfile"><span class="nav-number">7.1.</span> <span class="nav-text">Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Package-version"><span class="nav-number">7.2.</span> <span class="nav-text">Package version</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B8%A9%E5%9D%91"><span class="nav-number">8.</span> <span class="nav-text">踩坑</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">9.</span> <span class="nav-text">参考</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Reimu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Reimu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">119</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">153</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/muzi502" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muzi502" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:muzi502.li@gmail.com" title="E-Mail → mailto:muzi502.li@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/muzi_ii" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;muzi_ii" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://t.me/muzi502" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;muzi502" rel="noopener" target="_blank"><i class="fa-brands fa-telegram fa-fw"></i>Telegram</a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa-solid fa-square-rss fa-fw"></i>RSS</a>
      </span>
  </div>



        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://blog.k8s.li/make-offline-mirrors.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Reimu">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Reimu's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="使用 GitHub Actions 自动化构建 yum/apt 离线源 | Reimu's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          使用 GitHub Actions 自动化构建 yum/apt 离线源
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-23 2021-05-23T00:00:00+08:00" itemprop="dateCreated datePublished" datetime="2021-05-23T00:00:00+08:00">2021-05-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2021-09-03 2021-09-03T00:00:00+08:00" itemprop="dateModified" datetime="2021-09-03T00:00:00+08:00">2021-09-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E6%9C%AF/" itemprop="url" rel="index"><span itemprop="name">技术</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/make-offline-mirrors.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="make-offline-mirrors.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>26k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>24 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="离线部署"><a href="#离线部署" class="headerlink" title="离线部署"></a>离线部署</h2><p>对于 PaaS toB 产品来讲，客户往往会要求产品的部署方案必须做到离线安装，即在部署时不能依赖任何在线的资源，比如安装一些 OS 软件包时依赖的 yum&#x2F;apt 源；docker.io、k8s.gcr.io 、quay.io 上面的容器镜像；GitHub 上开源软件的二进制下载文件等。</p>
<p>作为平台部署工具的开发者，始终被离线部署这个难题困扰着。在线的容器镜像和二进制文件比较好解决，因为这些资源是与 OS 无关的，只要下载下来放到安装包里，部署的时候启动一个 HTTP 服务器和镜像仓库服务提供这些资源的下载即可。</p>
<p>但是对于 yum&#x2F;apt 之类的软件来讲并不那么简单：</p>
<ul>
<li>首先由于各个包之间的依赖关系比较复杂，并不能将它们直接下载下来；</li>
<li>其次即便下载下来之后也无法直接通过 yum&#x2F;apt 的方式安装指定的软件包，虽然也可以使用 scp 的方式将这些包复制到部署节点，通过 rpm 或 dpkg 的方式来安装上，但这样并不是很优雅，而且通用性能也不是很好；</li>
<li>最后需要适配的 Linux 发行版和包管理器种类也有多种，而且有些包的包名或者版本号在不同的包管理之间也相差甚大，无法做到统一管理。</li>
<li>要同时适配 arm64 和 amd64 的源及其困难</li>
</ul>
<p>综上，将平台部署依赖的在线 yum&#x2F;apt 之类的软件包资源制作成离线安装包是一件很棘手的事情。个人就这个问题折腾了一段时间，终于找到了一个比较合适的解决方案：即通过一个 YAML 配置文件来管理包，然后使用 Dockerfile 来构建成离线的 tar 包或者容器镜像。如果有类似需求的小伙伴，可以参考一下本方案。</p>
<h2 id="Docker-build"><a href="#Docker-build" class="headerlink" title="Docker build"></a>Docker build</h2><p>传统制作离线源的方式是找一台相应的 Linux 机器，在上面通过包管理器下载这些软件包，然后再创建这些软件包的 repo 索引文件。</p>
<p>可以看出这种方式十分不灵活，假如我想要制作 Debian 9 的 apt 离线源，我就需要一台 Debian 9 的机器。如果要适配多个 Linux 发行版就需要多个相应的 OS 机器。要管理和使用这么多种类的 OS 不是一件容易的事儿，而如今已经十分普遍使用的容器技术恰恰能帮助我们解决这类问题。比如我想运行一个 Debian9 的操作系统，我只需要运行一个 Debian 9 镜像的容器即可，而且不需要额外的管理成本，使用起来也十分地轻量。</p>
<p>日常工作中我们常使用容器来构建一些 Golang 写的后端组件，那么构建离线源是不是也可以这样做？实践证明确实可以，我们只需要为不同的 OS 和包管理器写一个相应的 Dockerfile 即可。使用 docker build 多阶段构建的特性，可以将多个 Dockerfile 合并成一个，然后最后使用 COPY –from 的方式将这个构建的产物复制到同一个镜像中，比如提供 HTTP 的 nginx 容器，或者使用 BuildKit 的特性将这些构建产物导出为 tar 包 或者为本地目录。</p>
<h2 id="适配-OS"><a href="#适配-OS" class="headerlink" title="适配 OS"></a>适配 OS</h2><p>根据自己的 PaaS toB 从业经验可知，目前国内的私有云客户生产环境中使用的 OS 中， CentOS 应该是最多的，其次是 Ubuntu 和 Debian。至于 RedHat 则需要付费订阅才能使用，DockerHub 上更是没有免费可使用的镜像，因此本方案无法确保适用于 RedHat。产品方面 CentOS 需要的版本只有 7.9；Ubuntu 需要支持 18.04 和 20.04；Debian 需要支持 9 和 10。因为时间和精力有限，本方案支持的 Linux 发行版和相应的版本只有 CentOS 7, Debian 9&#x2F;10, Ubuntu 18.04&#x2F;20.04 这五个。如果要支持其他 OS 的离线源比如 OpenSUSE，也可以参考本方案编写一个 Dockerfile 文件来实现适配。</p>
<h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><p>构建的过程十分简单，使用一个 YAML 格式的配置文件来管理不同的包管理器或 Linux 发行版安装不同的包，并在一个 Dockerfile 里完成所有的构建操作。实现源码在 <a target="_blank" rel="noopener" href="https://github.com/muzi502/scripts/tree/master/build-packages-repo">github.com&#x2F;muzi502&#x2F;scripts&#x2F;build-packages-repo</a>。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">build
├── Dockerfile
├── Dockerfile.centos
├── Dockerfile.debian
├── Dockerfile.ubuntu
└── packages.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="构建过程"><a href="#构建过程" class="headerlink" title="构建过程"></a>构建过程</h3><p>使用 docker build 的方式构建离线源大致可以分为如下几个步骤：</p>
<ul>
<li>在构建容器内配置 yum&#x2F;apt 源，安装构建时需要工具；</li>
<li>生成系统内的 rpm&#x2F;deb 包的列表和需要下载的包列表，解决一些软件包依赖的问题；</li>
<li>根据生成的包列表使用相应的包管理器工具下载需要的软件包；</li>
<li>生用相应的包管理器生成这些包的 index 文件，如 repodata 或 Packages.gz 文件；</li>
<li>将上述的构建产物 COPY 到同一个容器镜像里，比如 nginx ；也可以导出为 tar 包或目录；</li>
</ul>
<h3 id="packages-yaml"><a href="#packages-yaml" class="headerlink" title="packages.yaml"></a>packages.yaml</h3><p>这个文件用来管理不同的包管理器或者 Linux 发行版需要安装的软件包。根据不同的包管理器和发行版我们可以将这些包大致划分为 4 类。</p>
<ul>
<li>common：适用于一些所有包管理器中包名相同或者对版本无要求的包，比如 vim 、curl、wget 这类工具。一般情况下使用这些工具我们并不关心它的版本，并且这类包的包名在所有的包管理器中都是相同的，所以这类可以划分为公共包。</li>
<li>yum&#x2F;apt&#x2F;dnf：适用于不同的发行版使用相同的包管理器。比如 nfs 的包，在 yum 中包名为 nfs-utils 但在 apt 中为 nfs-common，这类软件包可以划分为一类。</li>
<li>OS：适用于一些该 OS 独有的包，比如安装一个 Ubuntu 中有但 Debian 中没有的包（比如 debian-builder 或 ubuntu-dev-tools）。</li>
<li>OS-发行版代号：这类包的版本和发行版代号绑定在一起，比如 <code>docker-ce=5:19.03.15~3-0~debian-stretch。</code></li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">common</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> vim
  <span class="token punctuation">-</span> curl
  <span class="token punctuation">-</span> wget
  <span class="token punctuation">-</span> tree
  <span class="token punctuation">-</span> lvm2

<span class="token key atrule">yum</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> nfs<span class="token punctuation">-</span>utils
  <span class="token punctuation">-</span> yum<span class="token punctuation">-</span>utils
  <span class="token punctuation">-</span> createrepo
  <span class="token punctuation">-</span> centos<span class="token punctuation">-</span>release<span class="token punctuation">-</span>gluster
  <span class="token punctuation">-</span> epel<span class="token punctuation">-</span>release

<span class="token key atrule">apt</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> nfs<span class="token punctuation">-</span>common
  <span class="token punctuation">-</span> apt<span class="token punctuation">-</span>transport<span class="token punctuation">-</span>https
  <span class="token punctuation">-</span> ca<span class="token punctuation">-</span>certificates
  <span class="token punctuation">-</span> lsb<span class="token punctuation">-</span>release
  <span class="token punctuation">-</span> software<span class="token punctuation">-</span>properties<span class="token punctuation">-</span>common
  <span class="token punctuation">-</span> aptitude
  <span class="token punctuation">-</span> dpkg<span class="token punctuation">-</span>dev

<span class="token key atrule">centos</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> centos<span class="token punctuation">-</span>release

<span class="token key atrule">debian</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> debian<span class="token punctuation">-</span>builder

<span class="token key atrule">debian-buster</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> docker<span class="token punctuation">-</span>ce=5<span class="token punctuation">:</span>19.03.15~3<span class="token punctuation">-</span>0~debian<span class="token punctuation">-</span>buster

<span class="token key atrule">ubuntu</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ubuntu<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>tools<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这里需要额外注意一下，在不同的包管理器之间指定包版本的方式也各不相同，比如在 yum 中如果要安装 19.03.15 版本的 docker-ce 包名为 <code>docker-ce-19.03.15</code>，而在 debian 中包名则为 <code>docker-ce=5:19.03.15~3-0~debian-stretch</code>。可以使用包管理器查看相同的一个包如 docker-ce 在不同的包管理器之前的差异，如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@centos:<span class="token punctuation">]</span><span class="token comment"># yum list docker-ce --showduplicates | grep 19.03.15</span>
docker-ce.x86_64            <span class="token number">3</span>:19.03.15-3.el7                    docker-ce-stable

root@debian:/<span class="token comment"># apt-cache policy docker-ce</span>
docker-ce:
  Installed: <span class="token punctuation">(</span>none<span class="token punctuation">)</span>
  Candidate: <span class="token number">5</span>:19.03.15~3-0~debian-stretch
  Version table:
     <span class="token number">5</span>:19.03.15~3-0~debian-stretch <span class="token number">500</span>
        <span class="token number">500</span> https://download.docker.com/linux/debian stretch/stable amd64 Packages<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这个版本号的问题在 kubespray 的源码中也是同样做了特殊处理，目前确实没有太好的方案来解决，只能手动维护这个版本号。</p>
<ul>
<li>roles&#x2F;container-engine&#x2F;docker&#x2F;vars&#x2F;redhat.yml</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token comment"># https://docs.docker.com/engine/installation/linux/centos/#install-from-a-package</span>
<span class="token comment"># https://download.docker.com/linux/centos/&lt;centos_version>>/x86_64/stable/Packages/</span>
<span class="token comment"># or do 'yum --showduplicates list docker-engine'</span>
<span class="token key atrule">docker_versioned_pkg</span><span class="token punctuation">:</span>
  <span class="token key atrule">'latest'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce
  <span class="token key atrule">'18.09'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce<span class="token punctuation">-</span>18.09.9<span class="token punctuation">-</span>3.el7
  <span class="token key atrule">'19.03'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce<span class="token punctuation">-</span>19.03.15<span class="token punctuation">-</span>3.el<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_major_version <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">'20.10'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce<span class="token punctuation">-</span>20.10.5<span class="token punctuation">-</span>3.el<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_major_version <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">'stable'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce<span class="token punctuation">-</span>19.03.15<span class="token punctuation">-</span>3.el<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_major_version <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">'edge'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce<span class="token punctuation">-</span>19.03.15<span class="token punctuation">-</span>3.el<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_major_version <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>

<span class="token key atrule">docker_cli_versioned_pkg</span><span class="token punctuation">:</span>
  <span class="token key atrule">'latest'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce<span class="token punctuation">-</span>cli
  <span class="token key atrule">'18.09'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce<span class="token punctuation">-</span>cli<span class="token punctuation">-</span>18.09.9<span class="token punctuation">-</span>3.el7
  <span class="token key atrule">'19.03'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce<span class="token punctuation">-</span>cli<span class="token punctuation">-</span>19.03.15<span class="token punctuation">-</span>3.el<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_major_version <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">'20.10'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce<span class="token punctuation">-</span>cli<span class="token punctuation">-</span>20.10.5<span class="token punctuation">-</span>3.el<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_major_version <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>

<span class="token key atrule">docker_package_info</span><span class="token punctuation">:</span>
  <span class="token key atrule">enablerepo</span><span class="token punctuation">:</span> <span class="token string">"docker-ce"</span>
  <span class="token key atrule">pkgs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"&#123;&#123; containerd_versioned_pkg[containerd_version | string] &#125;&#125;"</span>
    <span class="token punctuation">-</span> <span class="token string">"&#123;&#123; docker_cli_versioned_pkg[docker_cli_version | string] &#125;&#125;"</span>
    <span class="token punctuation">-</span> <span class="token string">"&#123;&#123; docker_versioned_pkg[docker_version | string] &#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>roles&#x2F;container-engine&#x2F;docker&#x2F;vars&#x2F;ubuntu.yml</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># https://download.docker.com/linux/ubuntu/</span>
<span class="token key atrule">docker_versioned_pkg</span><span class="token punctuation">:</span>
  <span class="token key atrule">'latest'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce
  <span class="token key atrule">'18.09'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce=5<span class="token punctuation">:</span>18.09.9~3<span class="token punctuation">-</span>0~ubuntu<span class="token punctuation">-</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_release<span class="token punctuation">|</span>lower <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">'19.03'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce=5<span class="token punctuation">:</span>19.03.15~3<span class="token punctuation">-</span>0~ubuntu<span class="token punctuation">-</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_release<span class="token punctuation">|</span>lower <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">'20.10'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce=5<span class="token punctuation">:</span>20.10.5~3<span class="token punctuation">-</span>0~ubuntu<span class="token punctuation">-</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_release<span class="token punctuation">|</span>lower <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">'stable'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce=5<span class="token punctuation">:</span>19.03.15~3<span class="token punctuation">-</span>0~ubuntu<span class="token punctuation">-</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_release<span class="token punctuation">|</span>lower <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">'edge'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce=5<span class="token punctuation">:</span>19.03.15~3<span class="token punctuation">-</span>0~ubuntu<span class="token punctuation">-</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_release<span class="token punctuation">|</span>lower <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>

<span class="token key atrule">docker_cli_versioned_pkg</span><span class="token punctuation">:</span>
  <span class="token key atrule">'latest'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce<span class="token punctuation">-</span>cli
  <span class="token key atrule">'18.09'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce<span class="token punctuation">-</span>cli=5<span class="token punctuation">:</span>18.09.9~3<span class="token punctuation">-</span>0~ubuntu<span class="token punctuation">-</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_release<span class="token punctuation">|</span>lower <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">'19.03'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce<span class="token punctuation">-</span>cli=5<span class="token punctuation">:</span>19.03.15~3<span class="token punctuation">-</span>0~ubuntu<span class="token punctuation">-</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_release<span class="token punctuation">|</span>lower <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">'20.10'</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>ce<span class="token punctuation">-</span>cli=5<span class="token punctuation">:</span>20.10.5~3<span class="token punctuation">-</span>0~ubuntu<span class="token punctuation">-</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> ansible_distribution_release<span class="token punctuation">|</span>lower <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>

<span class="token key atrule">docker_package_info</span><span class="token punctuation">:</span>
  <span class="token key atrule">pkgs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">"&#123;&#123; containerd_versioned_pkg[containerd_version | string] &#125;&#125;"</span>
    <span class="token punctuation">-</span> <span class="token string">"&#123;&#123; docker_cli_versioned_pkg[docker_cli_version | string] &#125;&#125;"</span>
    <span class="token punctuation">-</span> <span class="token string">"&#123;&#123; docker_versioned_pkg[docker_version | string] &#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="CentOS7"><a href="#CentOS7" class="headerlink" title="CentOS7"></a>CentOS7</h3><p>介绍完上述的包配置文件之后，接下来我们就根据这个 packages.yml 配置文件使用 Dockerfile 构建这些包的离线源。以下是构建 CentOS 7 离线源的 Dockerfile。</p>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token comment"># 使用 centos 7.9 作为 base 构建镜像</span>
<span class="token instruction"><span class="token keyword">FROM</span> centos:7.9.2009 <span class="token keyword">as</span> builder</span>

<span class="token comment"># 定义 centos 的版本和处理器体系架构</span>
<span class="token instruction"><span class="token keyword">ARG</span> OS_VERSION=7</span>
<span class="token instruction"><span class="token keyword">ARG</span> ARCH=x86_64</span>

<span class="token comment"># 在这里定义一些构建时需要的软件包</span>
<span class="token instruction"><span class="token keyword">ARG</span> BUILD_TOOLS=<span class="token string">"yum-utils createrepo centos-release-gluster epel-release curl"</span></span>

<span class="token comment"># 安装构建工具和配置一些软件源 repo</span>
<span class="token instruction"><span class="token keyword">RUN</span> yum install -q -y <span class="token variable">$BUILD_TOOLS</span> <span class="token operator">\</span>
    &amp;&amp; yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo <span class="token operator">\</span>
    &amp;&amp; yum makecache &amp;&amp; yum update -y -q</span>

<span class="token comment"># 需要安装 yq 个工具来处理 packages.yaml 配置文件</span>
<span class="token instruction"><span class="token keyword">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="token operator">\</span>
    &amp;&amp; chmod a+x /usr/local/bin/yq</span>

<span class="token comment"># 解析 packages.yml 配置文件，生成所需要的 packages.list 文件</span>
<span class="token instruction"><span class="token keyword">WORKDIR</span> /centos/<span class="token variable">$OS_VERSION</span>/os/<span class="token variable">$ARCH</span></span>
<span class="token instruction"><span class="token keyword">COPY</span> packages.yaml packages.yaml</span>

<span class="token comment"># 使用 yq 先将 YAML 文件转换成 json 格式的内容，再使用 jq 过滤出所需要的包，输出为一个列表</span>
<span class="token instruction"><span class="token keyword">RUN</span> yq eval <span class="token string">'.common[],.yum[],.centos[]'</span> packages.yaml | sort -u > packages.list <span class="token operator">\</span>
    &amp;&amp; rpm -qa >> packages.list</span>

<span class="token comment"># 下载 packages.list 中的软件包，并生成 repo 索引文件</span>
<span class="token instruction"><span class="token keyword">RUN</span> cat packages.list | xargs yumdownloader --resolve <span class="token operator">\</span>
    &amp;&amp; createrepo -d .</span>
<span class="token comment"># 将构建产物复制到一层空的镜像中，方便导出为 tar 包或目录的格式</span>
<span class="token instruction"><span class="token keyword">FROM</span> scratch</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">centos7</span></span> /centos /centos</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在最后的一个 FROM 镜像中，这里指定的是 <code>scratch</code>，这是一个特殊的镜像名，它代表的是一个空的镜像 layer。</p>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token comment"># 将构建产物复制到一层空的镜像中，方便导出为 tar 包或目录的格式</span>
<span class="token instruction"><span class="token keyword">FROM</span> scratch</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">centos7</span></span> /centos /centos</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>也可以直接将构建出来的产物放到 nginx 容器中，这样直接运行 nginx 容器就能提供 yum&#x2F;apt 源的服务</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">FROM nginx:1.19
COPY <span class="token parameter variable">--from</span><span class="token operator">=</span>centos7 /centos /usr/share/nginx/html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>如果要构建为 tar 包或者本地目录的方式，需要为 Docker 开启 <code>DOCKER_BUILDKIT=1</code> 这个特性</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 构建为本地目录</span>
root@debian: ~ <span class="token comment"># DOCKER_BUILDKIT=1 docker build -o type=local,dest=$PWD -f Dockerfile.centos .</span>
<span class="token comment"># 构建为 tar 包</span>
root@debian: ~ <span class="token comment"># DOCKER_BUILDKIT=1 docker build -o type=tar,dest=$PWD/centos7.tar -f Dockerfile.centos .</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>构建日志如下</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">
<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Building <span class="token number">30</span>.9s <span class="token punctuation">(</span><span class="token number">13</span>/13<span class="token punctuation">)</span> FINISHED
 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load .dockerignore                                                                                                                                            <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> transferring context: 109B                                                                                                                                            <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load build definition from Dockerfile.centos                                                                                                                  <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> transferring dockerfile: 979B                                                                                                                                         <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load metadata <span class="token keyword">for</span> docker.io/library/centos:7.9.2009                                                                                                           <span class="token number">2</span>.6s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>centos7 <span class="token number">1</span>/7<span class="token punctuation">]</span> FROM docker.io/library/centos:7.9.2009@sha256:0f4ec88e21daf75124b8a9e5ca03c37a5e937e0e108a255d890492430789b60e                                             <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load build context                                                                                                                                            <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> transferring context: 818B                                                                                                                                            <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">></span> CACHED <span class="token punctuation">[</span>centos7 <span class="token number">2</span>/7<span class="token punctuation">]</span> RUN yum <span class="token function">install</span> <span class="token parameter variable">-q</span> <span class="token parameter variable">-y</span> yum-utils createrepo centos-release-gluster epel-release <span class="token function">curl</span>     <span class="token operator">&amp;&amp;</span> yum-config-manager --add-repo https://download.docker.c  <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>centos7 <span class="token number">3</span>/7<span class="token punctuation">]</span> WORKDIR /centos/7/os/x86_64                                                                                                                                <span class="token number">0</span>.0s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>centos7 <span class="token number">4</span>/7<span class="token punctuation">]</span> RUN <span class="token function">curl</span> <span class="token parameter variable">-sL</span> <span class="token parameter variable">-o</span> /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64     <span class="token operator">&amp;&amp;</span> <span class="token function">chmod</span> a+x /usr/local/bin/yq     <span class="token operator">&amp;&amp;</span> <span class="token function">curl</span>   <span class="token number">3</span>.2s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>centos7 <span class="token number">5</span>/7<span class="token punctuation">]</span> COPY packages.yaml packages.yaml                                                                                                                           <span class="token number">0</span>.1s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>centos7 <span class="token number">6</span>/7<span class="token punctuation">]</span> RUN yq <span class="token builtin class-name">eval</span> packages.yaml <span class="token parameter variable">-j</span> <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">'.common[],.yum[],.centos[]'</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-u</span> <span class="token operator">></span> packages.list     <span class="token operator">&amp;&amp;</span> <span class="token function">rpm</span> <span class="token parameter variable">-qa</span> <span class="token operator">>></span> packages.list                                <span class="token number">1</span>.0s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>centos7 <span class="token number">7</span>/7<span class="token punctuation">]</span> RUN <span class="token function">cat</span> packages.list <span class="token operator">|</span> <span class="token function">xargs</span> yumdownloader <span class="token parameter variable">--resolve</span>     <span class="token operator">&amp;&amp;</span> createrepo <span class="token parameter variable">-d</span> <span class="token builtin class-name">.</span>                                                                              <span class="token number">21</span>.6s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>stage-1 <span class="token number">1</span>/1<span class="token punctuation">]</span> COPY <span class="token parameter variable">--from</span><span class="token operator">=</span>centos7 /centos /centos                                                                                                                        <span class="token number">0</span>.5s
 <span class="token operator">=</span><span class="token operator">></span> exporting to client                                                                                                                                                      <span class="token number">0</span>.7s
 <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> copying files <span class="token number">301</span>.37MB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>构建产物如下</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">root@debian:/build <span class="token comment"># tree centos</span>
centos
└── <span class="token number">7</span>
    └── os
        └── x86_64
            ├── acl-2.2.51-15.el7.x86_64.rpm
            ├── ansible-2.9.21-1.el7.noarch.rpm
            ├── at-3.1.13-24.el7.x86_64.rpm
            ├── attr-2.4.46-13.el7.x86_64.rpm
            ├── audit-libs-2.8.5-4.el7.x86_64.rpm
            ├── audit-libs-python-2.8.5-4.el7.x86_64.rpm
            ├── avahi-libs-0.6.31-20.el7.x86_64.rpm
            ├── basesystem-10.0-7.el7.centos.noarch.rpm
            ├── bash-4.2.46-34.el7.x86_64.rpm
            ……………………………………
            ├── redhat-lsb-submod-security-4.1-27.el7.centos.1.x86_64.rpm
            ├── repodata
            │   ├── 28d2fe2d1dbd9b76d3e5385d42cf628ac9fc34d69e151edfe8d134fe6ac6a6d9-primary.xml.gz
            │   ├── 5264ca1af13ec7c870f25b2a28edb3c2843556ca201d07ac681eb4af7a28b47c-primary.sqlite.bz2
            │   ├── 591d9c2d5be714356e8db39f006d07073f0e1e024a4a811d5960d8e200a874fb-other.xml.gz
            │   ├── c035d2112d55d23a72b6d006b9e86a2f67db78c0de45345e415884aa0782f40c-other.sqlite.bz2
            │   ├── cd756169c3718d77201d08590c0613ebed80053f84a2db7acc719b5b9bca866f-filelists.xml.gz
            │   ├── ed0c5a36b12cf1d4100f90b4825b93dac832e6e21f83b23ae9d9753842801cee-filelists.sqlite.bz2
            │   └── repomd.xml
            ├── yum-utils-1.1.31-54.el7_8.noarch.rpm
            └── zlib-1.2.7-19.el7_9.x86_64.rpm

<span class="token number">4</span> directories, <span class="token number">368</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Debian9"><a href="#Debian9" class="headerlink" title="Debian9"></a>Debian9</h3><p>下面是 Debian9 构建 Dockerfile，流程上和 CentOS 相差不多，只是包管理器的使用方式不太相同而已，这里就不再做详细的源码介绍。</p>
<ul>
<li>Dockerfile.debian</li>
</ul>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token instruction"><span class="token keyword">FROM</span> debian:stretch-slim <span class="token keyword">as</span> stretch</span>
<span class="token instruction"><span class="token keyword">ARG</span> OS_VERSION=stretch</span>
<span class="token instruction"><span class="token keyword">ARG</span> ARCH=amd64</span>

<span class="token instruction"><span class="token keyword">ARG</span> DEP_PACKAGES=<span class="token string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span>
<span class="token instruction"><span class="token keyword">RUN</span> apt update -y -q <span class="token operator">\</span>
    &amp;&amp; apt install -y --no-install-recommends <span class="token variable">$DEP_PACKAGES</span> <span class="token operator">\</span>
    &amp;&amp; curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg <span class="token operator">\</span>
    &amp;&amp; echo <span class="token string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $&#123;OS_VERSION&#125; stable"</span> <span class="token operator">\</span>
    | tee /etc/apt/sources.list.d/docker.list > /dev/null <span class="token operator">\</span>
    &amp;&amp; apt update -y -q</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /debian/<span class="token variable">$&#123;OS_VERSION&#125;</span></span>

<span class="token instruction"><span class="token keyword">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="token operator">\</span>
    &amp;&amp; chmod a+x /usr/local/bin/yq</span>

<span class="token instruction"><span class="token keyword">COPY</span> packages.yaml packages.yaml</span>

<span class="token instruction"><span class="token keyword">RUN</span> yq eval <span class="token string">'.common[],.apt[],.debian[]'</span> packages.yaml | sort -u > packages.list <span class="token operator">\</span>
    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 >> packages.list</span>

<span class="token instruction"><span class="token keyword">RUN</span> chown -R _apt /debian/<span class="token variable">$OS_VERSION</span> <span class="token operator">\</span>
    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests <span class="token operator">\</span>
    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="token string">'^\w'</span> | sort -u | xargs apt-get download</span>

<span class="token instruction"><span class="token keyword">RUN</span> cd ../ &amp;&amp; dpkg-scanpackages <span class="token variable">$OS_VERSION</span> | gzip -9c > <span class="token variable">$OS_VERSION</span>/Packages.gz</span>

<span class="token instruction"><span class="token keyword">FROM</span> scratch</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /debian /debian</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h3><p>Ubuntu 离线源的制作步骤和 Debian 差不太多，只需要简单修改一下 Debian 的 Dockerfile 应该就 OK ，比如 <code>&#39;s/debian/ubuntu/g&#39;</code> ，毕竟 Debian 是 Ubuntu 的爸爸嘛 ～～，所以 apt 使用的方式和包名几乎一模一样，这里就不再赘述了。</p>
<h3 id="All-in-Oone"><a href="#All-in-Oone" class="headerlink" title="All-in-Oone"></a>All-in-Oone</h3><p>将上述几个 Linux 发行版的 Dockerfile 整合成一个，这样只需要一个 docker build 命令就能构建出所需要的所有 OS 的离线源了。</p>
<ul>
<li>Dockerfile</li>
</ul>
<pre class="line-numbers language-docker" data-language="docker"><code class="language-docker"><span class="token comment"># CentOS 7.9 2009</span>
<span class="token instruction"><span class="token keyword">FROM</span> centos:7.9.2009 <span class="token keyword">as</span> centos7</span>
<span class="token instruction"><span class="token keyword">ARG</span> OS_VERSION=7</span>
<span class="token instruction"><span class="token keyword">ARG</span> ARCH=x86_64</span>
<span class="token instruction"><span class="token keyword">ARG</span> BUILD_TOOLS=<span class="token string">"yum-utils createrepo centos-release-gluster epel-release curl"</span></span>

<span class="token instruction"><span class="token keyword">RUN</span> yum install -q -y <span class="token variable">$BUILD_TOOLS</span> <span class="token operator">\</span>
    &amp;&amp; yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo <span class="token operator">\</span>
    &amp;&amp; yum makecache &amp;&amp; yum update -y -q</span>

<span class="token instruction"><span class="token keyword">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="token operator">\</span>
    &amp;&amp; chmod a+x /usr/local/bin/yq <span class="token operator">\</span>
    &amp;&amp; curl -sL -o /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 <span class="token operator">\</span>
    &amp;&amp; chmod a+x /usr/local/bin/jq</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /centos/<span class="token variable">$OS_VERSION</span>/os/<span class="token variable">$ARCH</span></span>
<span class="token instruction"><span class="token keyword">COPY</span> packages.yaml packages.yaml</span>
<span class="token instruction"><span class="token keyword">RUN</span> yq eval packages.yaml -j | jq -r <span class="token string">'.common[],.yum[],.centos[]'</span> | sort -u > packages.list <span class="token operator">\</span>
    &amp;&amp; rpm -qa >> packages.list</span>
<span class="token instruction"><span class="token keyword">RUN</span> cat packages.list | xargs yumdownloader --resolve <span class="token operator">\</span>
    &amp;&amp; createrepo -d .</span>

<span class="token comment"># Debian 9 stretch</span>
<span class="token instruction"><span class="token keyword">FROM</span> debian:stretch-slim <span class="token keyword">as</span> stretch</span>
<span class="token instruction"><span class="token keyword">ARG</span> OS_VERSION=stretch</span>
<span class="token instruction"><span class="token keyword">ARG</span> ARCH=amd64</span>

<span class="token instruction"><span class="token keyword">ARG</span> DEP_PACKAGES=<span class="token string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span>
<span class="token instruction"><span class="token keyword">RUN</span> apt update -y -q <span class="token operator">\</span>
    &amp;&amp; apt install -y --no-install-recommends <span class="token variable">$DEP_PACKAGES</span> <span class="token operator">\</span>
    &amp;&amp; curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg <span class="token operator">\</span>
    &amp;&amp; echo <span class="token string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $&#123;OS_VERSION&#125; stable"</span> <span class="token operator">\</span>
    | tee /etc/apt/sources.list.d/docker.list > /dev/null <span class="token operator">\</span>
    &amp;&amp; apt update -y -q</span>

<span class="token instruction"><span class="token keyword">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="token operator">\</span>
    &amp;&amp; chmod a+x /usr/local/bin/yq <span class="token operator">\</span>
    &amp;&amp; curl -sL -o /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 <span class="token operator">\</span>
    &amp;&amp; chmod a+x /usr/local/bin/jq</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /debian/<span class="token variable">$&#123;OS_VERSION&#125;</span></span>
<span class="token instruction"><span class="token keyword">COPY</span> packages.yaml packages.yaml</span>
<span class="token instruction"><span class="token keyword">RUN</span> yq eval packages.yaml -j | jq -r <span class="token string">'.common[],.apt[],.debian[]'</span> | sort -u > packages.list <span class="token operator">\</span>
    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 >> packages.list</span>

<span class="token instruction"><span class="token keyword">RUN</span> chown -R _apt /debian/<span class="token variable">$OS_VERSION</span> <span class="token operator">\</span>
    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests <span class="token operator">\</span>
    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="token string">'^\w'</span> | sort -u | xargs apt-get download</span>

<span class="token instruction"><span class="token keyword">RUN</span> cd ../ &amp;&amp; dpkg-scanpackages <span class="token variable">$OS_VERSION</span> | gzip -9c > <span class="token variable">$OS_VERSION</span>/Packages.gz</span>

<span class="token comment"># Debian 10 buster</span>
<span class="token instruction"><span class="token keyword">FROM</span> debian:buster-slim <span class="token keyword">as</span> buster</span>
<span class="token instruction"><span class="token keyword">ARG</span> OS_VERSION=buster</span>
<span class="token instruction"><span class="token keyword">ARG</span> ARCH=amd64</span>

<span class="token instruction"><span class="token keyword">ARG</span> DEP_PACKAGES=<span class="token string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span>
<span class="token instruction"><span class="token keyword">RUN</span> apt update -y -q <span class="token operator">\</span>
    &amp;&amp; apt install -y --no-install-recommends <span class="token variable">$DEP_PACKAGES</span> <span class="token operator">\</span>
    &amp;&amp; curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg <span class="token operator">\</span>
    &amp;&amp; echo <span class="token string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $&#123;OS_VERSION&#125; stable"</span> <span class="token operator">\</span>
    | tee /etc/apt/sources.list.d/docker.list > /dev/null <span class="token operator">\</span>
    &amp;&amp; apt update -y -q</span>

<span class="token instruction"><span class="token keyword">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="token operator">\</span>
    &amp;&amp; chmod a+x /usr/local/bin/yq <span class="token operator">\</span>
    &amp;&amp; curl -sL -o /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 <span class="token operator">\</span>
    &amp;&amp; chmod a+x /usr/local/bin/jq</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /debian/<span class="token variable">$&#123;OS_VERSION&#125;</span></span>
<span class="token instruction"><span class="token keyword">COPY</span> packages.yaml packages.yaml</span>
<span class="token instruction"><span class="token keyword">RUN</span> yq eval packages.yaml -j | jq -r <span class="token string">'.common[],.apt[],.debian[]'</span> | sort -u > packages.list <span class="token operator">\</span>
    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 >> packages.list</span>

<span class="token instruction"><span class="token keyword">RUN</span> chown -R _apt /debian/<span class="token variable">$OS_VERSION</span> <span class="token operator">\</span>
    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests <span class="token operator">\</span>
    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="token string">'^\w'</span> | sort -u | xargs apt-get download</span>

<span class="token instruction"><span class="token keyword">RUN</span> cd ../ &amp;&amp; dpkg-scanpackages <span class="token variable">$OS_VERSION</span> | gzip -9c > <span class="token variable">$OS_VERSION</span>/Packages.gz</span>

<span class="token comment"># Ubuntu 18.04 bionic</span>
<span class="token instruction"><span class="token keyword">FROM</span> ubuntu:bionic <span class="token keyword">as</span> bionic</span>
<span class="token instruction"><span class="token keyword">ARG</span> OS_VERSION=bionic</span>
<span class="token instruction"><span class="token keyword">ARG</span> ARCH=amd64</span>

<span class="token instruction"><span class="token keyword">ARG</span> DEP_PACKAGES=<span class="token string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span>
<span class="token instruction"><span class="token keyword">RUN</span> apt update -y -q <span class="token operator">\</span>
    &amp;&amp; apt install -y --no-install-recommends <span class="token variable">$DEP_PACKAGES</span> <span class="token operator">\</span>
    &amp;&amp; curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg <span class="token operator">\</span>
    &amp;&amp; echo <span class="token string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $&#123;OS_VERSION&#125; stable"</span> <span class="token operator">\</span>
    | tee /etc/apt/sources.list.d/docker.list > /dev/null <span class="token operator">\</span>
    &amp;&amp; apt update -y -q</span>

<span class="token instruction"><span class="token keyword">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="token operator">\</span>
    &amp;&amp; chmod a+x /usr/local/bin/yq <span class="token operator">\</span>
    &amp;&amp; curl -sL -o /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 <span class="token operator">\</span>
    &amp;&amp; chmod a+x /usr/local/bin/jq</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /ubuntu/<span class="token variable">$&#123;OS_VERSION&#125;</span></span>
<span class="token instruction"><span class="token keyword">COPY</span> packages.yaml packages.yaml</span>
<span class="token instruction"><span class="token keyword">RUN</span> yq eval packages.yaml -j | jq -r <span class="token string">'.common[],.apt[],.ubuntu[]'</span> | sort -u > packages.list <span class="token operator">\</span>
    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 >> packages.list</span>

<span class="token instruction"><span class="token keyword">RUN</span> chown -R _apt /ubuntu/<span class="token variable">$OS_VERSION</span> <span class="token operator">\</span>
    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests <span class="token operator">\</span>
    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="token string">'^\w'</span> | sort -u | xargs apt-get download</span>

<span class="token instruction"><span class="token keyword">RUN</span> cd ../ &amp;&amp; dpkg-scanpackages <span class="token variable">$OS_VERSION</span> | gzip -9c > <span class="token variable">$OS_VERSION</span>/Packages.gz</span>

<span class="token comment"># Ubuntu 20.04 focal</span>
<span class="token instruction"><span class="token keyword">FROM</span> ubuntu:focal <span class="token keyword">as</span> focal</span>
<span class="token instruction"><span class="token keyword">ARG</span> OS_VERSION=focal</span>
<span class="token instruction"><span class="token keyword">ARG</span> ARCH=amd64</span>

<span class="token instruction"><span class="token keyword">ARG</span> DEP_PACKAGES=<span class="token string">"apt-transport-https ca-certificates curl gnupg aptitude dpkg-dev"</span></span>
<span class="token instruction"><span class="token keyword">RUN</span> apt update -y -q <span class="token operator">\</span>
    &amp;&amp; apt install -y --no-install-recommends <span class="token variable">$DEP_PACKAGES</span> <span class="token operator">\</span>
    &amp;&amp; curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg <span class="token operator">\</span>
    &amp;&amp; echo <span class="token string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $&#123;OS_VERSION&#125; stable"</span> <span class="token operator">\</span>
    | tee /etc/apt/sources.list.d/docker.list > /dev/null <span class="token operator">\</span>
    &amp;&amp; apt update -y -q</span>

<span class="token instruction"><span class="token keyword">RUN</span> curl -sL -o /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.9.3/yq_linux_amd64 <span class="token operator">\</span>
    &amp;&amp; chmod a+x /usr/local/bin/yq <span class="token operator">\</span>
    &amp;&amp; curl -sL -o /usr/local/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.6/jq-linux64 <span class="token operator">\</span>
    &amp;&amp; chmod a+x /usr/local/bin/jq</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /ubuntu/<span class="token variable">$&#123;OS_VERSION&#125;</span></span>
<span class="token instruction"><span class="token keyword">COPY</span> packages.yaml packages.yaml</span>
<span class="token instruction"><span class="token keyword">RUN</span> yq eval packages.yaml -j | jq -r <span class="token string">'.common[],.apt[],.ubuntu[]'</span> | sort -u > packages.list <span class="token operator">\</span>
    &amp;&amp; dpkg --get-selections | grep -v deinstall | cut -f1 >> packages.list</span>

<span class="token instruction"><span class="token keyword">RUN</span> chown -R _apt /ubuntu/<span class="token variable">$OS_VERSION</span> <span class="token operator">\</span>
    &amp;&amp; cat packages.list | xargs -L1 -I &#123;&#125; apt-cache depends --recurse --no-recommends --no-suggests <span class="token operator">\</span>
    --no-conflicts --no-breaks --no-replaces --no-enhances &#123;&#125;  | grep <span class="token string">'^\w'</span> | sort -u | xargs apt-get download</span>

<span class="token instruction"><span class="token keyword">RUN</span> cd ../ &amp;&amp; dpkg-scanpackages <span class="token variable">$OS_VERSION</span> | gzip -9c > <span class="token variable">$OS_VERSION</span>/Packages.gz</span>

<span class="token instruction"><span class="token keyword">FROM</span> scratch</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">centos7</span></span> /centos /centos</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">stretch</span></span> /debian /debian</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">buster</span></span> /debian /debian</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">bionic</span></span> /ubuntu /ubuntu</span>
<span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">focal</span></span> /ubuntu /ubuntu</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>构建好了离线源之后，在部署的机器上运行一个 Nginx 服务，用于提供 HTTP 方式下载这些软件包，同时需要配置一下机器的包管理器 repo 配置文件。</p>
<ul>
<li>CentOS 7</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>Inra-Mirror<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>Infra Mirror Repository
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>http://172.20.0.10/centos/7/
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Debian 9 stretch</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">deb <span class="token punctuation">[</span>trusted<span class="token operator">=</span>yes<span class="token punctuation">]</span> http://172.20.0.10:8080/debian stretch/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>Debian 10 buster</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">deb [trusted&#x3D;yes] http:&#x2F;&#x2F;172.20.0.10:8080&#x2F;debian buster&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>Ubuntu 18.04 bionic</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">deb <span class="token punctuation">[</span>trusted<span class="token operator">=</span>yes<span class="token punctuation">]</span> http://172.20.0.10:8080/ubuntu bionic/<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>Ubuntu 20.04 focal</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">deb [trusted&#x3D;yes] http:&#x2F;&#x2F;172.20.0.10:8080&#x2F;debian focal&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="GitHub-Action-自动构建"><a href="#GitHub-Action-自动构建" class="headerlink" title="GitHub Action 自动构建"></a>GitHub Action 自动构建</h2><p>准备好上面这些 Dockerfile 之后，接下来就要考虑构建的问题了。对于一个 PaaS 或者 IaaS 产品需要适配主流的 Linux 发行版，有时还需要适配 arm64 架构的机器。如果本地手动 docker build 来构建的话，效率很低。因此我们需要使用 GitHub actions 自动构建这些 rpm&#x2F;deb 包的离线源，具体实现代码可参考 <a target="_blank" rel="noopener" href="https://github.com/k8sli/os-packages">k8sli&#x2F;os-packages</a></p>
<h3 id="代码结构"><a href="#代码结构" class="headerlink" title="代码结构"></a>代码结构</h3><p>在 build 目录里存放各种发行版的 Dockerfile。由于不同的发行版以及每个发行版的版本构建方法千差万别，因此每个发行版 OS 在一个单独的 Dockerfile 里构建。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">os-packages/
├── LICENSE
├── Makefile
├── README.md
├── build
│   ├── Dockerfile.os.centos7
│   ├── Dockerfile.os.centos8
│   ├── Dockerfile.os.debian10
│   ├── Dockerfile.os.debian9
│   ├── Dockerfile.os.fedora33
│   ├── Dockerfile.os.fedora34
│   ├── Dockerfile.os.ubuntu1804
│   └── Dockerfile.os.ubuntu2004
├── packages.yaml
└── repos
    ├── CentOS-All-in-One.repo
    ├── Debian-buster-All-in-One.list
    ├── Fedora-All-in-One.repo
    └── Ubuntu-focal-All-in-One.list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="Workflow"><a href="#Workflow" class="headerlink" title="Workflow"></a>Workflow</h3><ul>
<li>触发方式</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> Build os<span class="token punctuation">-</span>packages image
<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">tag</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'v*'</span>
    <span class="token key atrule">branch</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>main<span class="token punctuation">,</span> release<span class="token punctuation">-</span>*<span class="token punctuation">,</span> master<span class="token punctuation">]</span>
  workflow_dispatch<span class="token punctuation">:</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>全局变量</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">env</span><span class="token punctuation">:</span>
  <span class="token comment"># 镜像仓库域名</span>
  <span class="token key atrule">IMAGE_REGISTRY</span><span class="token punctuation">:</span> <span class="token string">"ghcr.io"</span>
  <span class="token comment"># 镜像仓库用户名</span>
  <span class="token key atrule">REGISTRY_USER</span><span class="token punctuation">:</span> <span class="token string">"$&#123;&#123; github.repository_owner &#125;&#125;"</span>
  <span class="token comment"># 镜像仓库登录凭据</span>
  <span class="token key atrule">REGISTRY_TOKEN</span><span class="token punctuation">:</span> <span class="token string">"$&#123;&#123; secrets.GITHUB_TOKEN &#125;&#125;"</span>
  <span class="token comment"># 镜像仓库推送 repo</span>
  <span class="token key atrule">IMAGE_REPO</span><span class="token punctuation">:</span> <span class="token string">"ghcr.io/$&#123;&#123; github.repository_owner &#125;&#125;"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>构建矩阵，这些 job 会各自运行一个 runner 来进行并行构建</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span><span class="token number">20.04</span>
    <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
      <span class="token key atrule">fail-fast</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">matrix</span><span class="token punctuation">:</span>
        <span class="token key atrule">include</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>bionic
            <span class="token key atrule">image_name</span><span class="token punctuation">:</span> os<span class="token punctuation">-</span>packages<span class="token punctuation">-</span>ubuntu1804
            <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> build/Dockerfile.os.ubuntu1804
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>focal
            <span class="token key atrule">image_name</span><span class="token punctuation">:</span> os<span class="token punctuation">-</span>packages<span class="token punctuation">-</span>ubuntu2004
            <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> build/Dockerfile.os.ubuntu2004
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> centos<span class="token punctuation">-</span><span class="token number">7</span>
            <span class="token key atrule">image_name</span><span class="token punctuation">:</span> os<span class="token punctuation">-</span>packages<span class="token punctuation">-</span>centos7
            <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> build/Dockerfile.os.centos7
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> centos<span class="token punctuation">-</span><span class="token number">8</span>
            <span class="token key atrule">image_name</span><span class="token punctuation">:</span> os<span class="token punctuation">-</span>packages<span class="token punctuation">-</span>centos8
            <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> build/Dockerfile.os.centos8
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> debian<span class="token punctuation">-</span>buster
            <span class="token key atrule">image_name</span><span class="token punctuation">:</span> os<span class="token punctuation">-</span>packages<span class="token punctuation">-</span>debian10
            <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> build/Dockerfile.os.debian10
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> debian<span class="token punctuation">-</span>stretch
            <span class="token key atrule">image_name</span><span class="token punctuation">:</span> os<span class="token punctuation">-</span>packages<span class="token punctuation">-</span>debian9
            <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> build/Dockerfile.os.debian9<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>checkout 代码，配置 buildx 构建环境</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">steps</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
    <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
    <span class="token key atrule">with</span><span class="token punctuation">:</span>
      <span class="token comment"># fetch all git repo tag for define image tag</span>
      <span class="token key atrule">fetch-depth</span><span class="token punctuation">:</span> <span class="token number">0</span>

  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up QEMU
    <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>qemu<span class="token punctuation">-</span>action@v1

  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Docker Buildx
    <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v1

  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Log in to GitHub Docker Registry
    <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/login<span class="token punctuation">-</span>action@v1
    <span class="token key atrule">with</span><span class="token punctuation">:</span>
      <span class="token key atrule">registry</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.IMAGE_REGISTRY <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
      <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.REGISTRY_USER <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
      <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.REGISTRY_TOKEN <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>通过 <code>git describe --tags</code> 方式生成一个唯一的镜像 tag</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Prepare for build images
  <span class="token key atrule">shell</span><span class="token punctuation">:</span> bash
  <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    git describe --tags --always | sed 's/^/IMAGE_TAG=/' >> $GITHUB_ENV</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>构建镜像并 push 到镜像仓库，后面打包一个 All-in-one 的包时候会用到</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build and push os<span class="token punctuation">-</span>package images
  <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v2
  <span class="token key atrule">with</span><span class="token punctuation">:</span>
    <span class="token key atrule">context</span><span class="token punctuation">:</span> .
    <span class="token key atrule">push</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> github.event_name <span class="token tag">!=</span> 'pull_request' <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">file</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> matrix.dockerfile <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">platforms</span><span class="token punctuation">:</span> linux/amd64<span class="token punctuation">,</span>linux/arm64
    <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      $&#123;&#123; env.IMAGE_REPO &#125;&#125;/$&#123;&#123; matrix.image_name &#125;&#125;:$&#123;&#123; env.IMAGE_TAG &#125;&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>生成新的 Dockerfile，导出镜像到本地目录</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Gen new Dockerfile
  <span class="token key atrule">shell</span><span class="token punctuation">:</span> bash
  <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    echo -e "FROM scratch\nCOPY --from=$&#123;&#123; env.IMAGE_REPO &#125;&#125;/$&#123;&#123; matrix.image_name &#125;&#125;:$&#123;&#123; env.IMAGE_TAG &#125;&#125; / /" > Dockerfile</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build kubeplay image to local
  <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v2
  <span class="token key atrule">with</span><span class="token punctuation">:</span>
    <span class="token key atrule">context</span><span class="token punctuation">:</span> .
    <span class="token key atrule">file</span><span class="token punctuation">:</span> Dockerfile
    <span class="token key atrule">platforms</span><span class="token punctuation">:</span> linux/amd64<span class="token punctuation">,</span>linux/arm64
    <span class="token key atrule">outputs</span><span class="token punctuation">:</span> type=local<span class="token punctuation">,</span>dest=./<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>将最终构建产物打包上传到 GitHub release</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Prepare for upload package
  <span class="token key atrule">shell</span><span class="token punctuation">:</span> bash
  <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    mv linux_amd64/resources resources
    tar -I pigz -cf resources-$&#123;&#123; matrix.image_name &#125;&#125;-$&#123;IMAGE_TAG&#125;-amd64.tar.gz resources --remove-files
    mv linux_arm64/resources resources
    tar -I pigz -cf resources-$&#123;&#123; matrix.image_name &#125;&#125;-$&#123;IMAGE_TAG&#125;-arm64.tar.gz resources --remove-files
    sha256sum resources-$&#123;&#123; matrix.image_name &#125;&#125;-$&#123;IMAGE_TAG&#125;-&#123;amd64,arm64&#125;.tar.gz > resources-$&#123;&#123; matrix.image_name &#125;&#125;-$&#123;IMAGE_TAG&#125;.sha256sum.txt</span>

<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Release and upload packages
  <span class="token key atrule">if</span><span class="token punctuation">:</span> startsWith(github.ref<span class="token punctuation">,</span> 'refs/tags/')
  <span class="token key atrule">uses</span><span class="token punctuation">:</span> softprops/action<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>release@v1
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.GITHUB_TOKEN <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
  <span class="token key atrule">with</span><span class="token punctuation">:</span>
    <span class="token key atrule">files</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
      resources-$&#123;&#123; matrix.image_name &#125;&#125;-$&#123;&#123; env.IMAGE_TAG &#125;&#125;.sha256sum.txt
      resources-$&#123;&#123; matrix.image_name &#125;&#125;-$&#123;&#123; env.IMAGE_TAG &#125;&#125;-amd64.tar.gz
      resources-$&#123;&#123; matrix.image_name &#125;&#125;-$&#123;&#123; env.IMAGE_TAG &#125;&#125;-arm64.tar.gz</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>All-in-one 合并所有构建的镜像</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">upload</span><span class="token punctuation">:</span>
  <span class="token key atrule">needs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>build<span class="token punctuation">]</span>
  <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span><span class="token number">20.04</span>
  <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token comment"># fetch all git repo tag for define image tag</span>
        <span class="token key atrule">fetch-depth</span><span class="token punctuation">:</span> <span class="token number">0</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up QEMU
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>qemu<span class="token punctuation">-</span>action@v1

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Docker Buildx
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v1

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Log in to GitHub Docker Registry
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/login<span class="token punctuation">-</span>action@v1
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">registry</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.IMAGE_REGISTRY <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.REGISTRY_USER <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
        <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> env.REGISTRY_TOKEN <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Prepare for build images
      <span class="token key atrule">shell</span><span class="token punctuation">:</span> bash
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        git describe --tags --always | sed 's/^/IMAGE_TAG=/' >> $GITHUB_ENV
        source $GITHUB_ENV
        echo "FROM scratch" > Dockerfile
        echo "COPY --from=$&#123;&#123; env.IMAGE_REPO &#125;&#125;/os-packages-ubuntu1804:$&#123;IMAGE_TAG&#125; / /" >> Dockerfile
        echo "COPY --from=$&#123;&#123; env.IMAGE_REPO &#125;&#125;/os-packages-ubuntu2004:$&#123;IMAGE_TAG&#125; / /" >> Dockerfile
        echo "COPY --from=$&#123;&#123; env.IMAGE_REPO &#125;&#125;/os-packages-centos7:$&#123;IMAGE_TAG&#125; / /" >> Dockerfile
        echo "COPY --from=$&#123;&#123; env.IMAGE_REPO &#125;&#125;/os-packages-centos8:$&#123;IMAGE_TAG&#125; / /" >> Dockerfile
        echo "COPY --from=$&#123;&#123; env.IMAGE_REPO &#125;&#125;/os-packages-debian9:$&#123;IMAGE_TAG&#125; / /" >> Dockerfile
        echo "COPY --from=$&#123;&#123; env.IMAGE_REPO &#125;&#125;/os-packages-debian10:$&#123;IMAGE_TAG&#125; / /" >> Dockerfile</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build os<span class="token punctuation">-</span>packages images to local
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v2
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">context</span><span class="token punctuation">:</span> .
        <span class="token key atrule">file</span><span class="token punctuation">:</span> Dockerfile
        <span class="token key atrule">platforms</span><span class="token punctuation">:</span> linux/amd64<span class="token punctuation">,</span>linux/arm64
        <span class="token key atrule">outputs</span><span class="token punctuation">:</span> type=local<span class="token punctuation">,</span>dest=./

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Prepare for upload package
      <span class="token key atrule">shell</span><span class="token punctuation">:</span> bash
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        mv linux_amd64/resources resources
        tar -I pigz -cf resources-os-packages-all-$&#123;IMAGE_TAG&#125;-amd64.tar.gz resources --remove-files
        mv linux_arm64/resources resources
        tar -I pigz -cf resources-os-packages-all-$&#123;IMAGE_TAG&#125;-arm64.tar.gz resources --remove-files
        sha256sum resources-os-packages-all-$&#123;IMAGE_TAG&#125;-&#123;amd64,arm64&#125;.tar.gz > resources-os-packages-all-$&#123;IMAGE_TAG&#125;.sha256sum.txt</span>

    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Release and upload packages
      <span class="token key atrule">if</span><span class="token punctuation">:</span> startsWith(github.ref<span class="token punctuation">,</span> 'refs/tags/')
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> softprops/action<span class="token punctuation">-</span>gh<span class="token punctuation">-</span>release@v1
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.GITHUB_TOKEN <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">files</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          resources-os-packages-all-$&#123;&#123; env.IMAGE_TAG &#125;&#125;.sha256sum.txt
          resources-os-packages-all-$&#123;&#123; env.IMAGE_TAG &#125;&#125;-amd64.tar.gz
          resources-os-packages-all-$&#123;&#123; env.IMAGE_TAG &#125;&#125;-arm64.tar.gz</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>可以考虑将 Dockerfile 中的构建过程合并成一个 shell 脚本，然后在 Dockerfile 中调用这个脚本即可，这样可优化 Dockerfile 代码的可维护性，同时后续适配多种 OS 的时候也可以复用部分相同的代码，但这样可能会导致 docker build 缓存的失效问题。</p>
<p>当然也可以使用脚本将多个 Dockerfile 合并成一个，如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Merge all Dockerfile.xx to an all-in-one file</span>
<span class="token function">ls</span> Dockerfile.* <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-L1</span> <span class="token function">grep</span> <span class="token parameter variable">-Ev</span> <span class="token string">'FROM scratch|COPY --from='</span> <span class="token operator">></span> Dockerfile
<span class="token builtin class-name">echo</span> <span class="token string">"FROM scratch"</span> <span class="token operator">>></span> Dockerfile
<span class="token function">ls</span> Dockerfile.* <span class="token operator">|</span> <span class="token function">xargs</span> <span class="token parameter variable">-L1</span> <span class="token function">grep</span> <span class="token string">'COPY --from='</span> <span class="token operator">>></span> Dockerfile<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>其实如果使用 GitHub actions 来构建的话，就不需要进行合并了，使用 actions 矩阵构建的特性可并行构建。</p>
<h3 id="Package-version"><a href="#Package-version" class="headerlink" title="Package version"></a>Package version</h3><p>对于一些版本中包含 Linux 发行版本代号的包来讲，手动维护这个代号不太方便，可以考虑将它魔改成占位变量的方式，在构建容器内生成 package.list 文件后统一使用 sed 把这些占位的变量给替换一下，如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">apt:
  - docker-ce<span class="token operator">=</span><span class="token number">5</span>:19.03.15~3-0~__ID__-__VERSION_CODENAME__<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>使用 sed 处理一下生成的 packages.list 中的这些占位符变量</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">"s|__ID__|<span class="token variable"><span class="token variable">$(</span><span class="token function">sed</span> <span class="token parameter variable">-n</span> <span class="token string">'s|^ID=||p'</span> /etc/os-release<span class="token variable">)</span></span>|;s|__VERSION_CODENAME__|<span class="token variable"><span class="token variable">$(</span><span class="token function">sed</span> <span class="token parameter variable">-n</span> <span class="token string">'s|^VERSION_CODENAME=||p'</span> /etc/os-release<span class="token variable">)</span></span>|"</span> packages.list<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>虽然这样做很不美观，但这种方式确实可行 😂，最终能够的到正确的版本号。总之我们尽量地少维护一些包的版本，比如使用这种方式就可以将某个版本的 docker-ce 包放在配置文件的 apt 中，而不是 debian&#x2F;ubuntu 中，通过一些环境变量或者 shell 脚本自动添加上这些特殊项，这样能减少一些维护成本。</p>
<h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h2><ul>
<li>Fedora 指定包的版本时，也需要加上 Fedora 的版本</li>
<li>CentOS 7 和 CentOS 8 有些包的包名不同，需要单独处理一下</li>
<li>CentOS 7 和 CentOS 8 构建方式不同，最后生成 repodata 的时候 CentOS 8 需要单独处理一下</li>
<li>Fedora 33 和 Fedora34 使用 GitHub action 构建的时候 arm64 架构的会一直卡住，是由于 buildx 的 bug 所致，因此只给出了 Dockerfile，并未放在 GitHub actions 构建流水线中。</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.aptly.info/tutorial/mirror/">aptly.info</a></li>
<li><a target="_blank" rel="noopener" href="https://mozillazg.com/2018/01/jq-use-examples-cookbook.html">jq 常用操作</a></li>
<li><a target="_blank" rel="noopener" href="https://lyyao09.github.io/2019/08/02/tools/The-usage-of-yq-read-write/">yq 之读写篇</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.docker.com/develop/develop-images/build_enhancements/">Build images with BuildKit</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/kubespray/pull/6766">kubernetes-sigs&#x2F;kubespray&#x2F;pull&#x2F;6766</a></li>
<li><a target="_blank" rel="noopener" href="https://moelove.info/2021/03/14/%E4%B8%87%E5%AD%97%E9%95%BF%E6%96%87%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E6%9E%84%E5%BB%BA/">万字长文：彻底搞懂容器镜像构建</a></li>
<li><a target="_blank" rel="noopener" href="https://www.xiaocoder.com/2017/09/12/offline-local-source/">为 CentOS 与 Ubuntu 制作离线本地源</a></li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/docker/" rel="tag"># docker</a>
              <a href="/tags/centos/" rel="tag"># centos</a>
              <a href="/tags/ubuntu/" rel="tag"># ubuntu</a>
              <a href="/tags/rpm/" rel="tag"># rpm</a>
              <a href="/tags/deb/" rel="tag"># deb</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/kubespray-tips.html" rel="prev" title="kubespray 部署常见问题和优化汇总">
                  <i class="fa fa-chevron-left"></i> kubespray 部署常见问题和优化汇总
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/taihu.html" rel="next" title="2021 五一假期环太湖骑行之旅">
                  2021 五一假期环太湖骑行之旅 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Reimu</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">1.8m</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">26:36</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lozad@1.16.0/dist/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"muzi","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
